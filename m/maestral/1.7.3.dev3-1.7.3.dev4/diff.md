# Comparing `tmp/maestral-1.7.3.dev3.tar.gz` & `tmp/maestral-1.7.3.dev4.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "maestral-1.7.3.dev3.tar", last modified: Sat May 27 20:59:37 2023, max compression
+gzip compressed data, was "maestral-1.7.3.dev4.tar", last modified: Mon May 29 15:14:21 2023, max compression
```

## Comparing `maestral-1.7.3.dev3.tar` & `maestral-1.7.3.dev4.tar`

### file list

```diff
@@ -1,66 +1,66 @@
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.980270 maestral-1.7.3.dev3/
--rw-r--r--   0 runner    (1001) docker     (123)     1076 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/LICENSE.txt
--rw-r--r--   0 runner    (1001) docker     (123)     8246 2023-05-27 20:59:37.980270 maestral-1.7.3.dev3/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     7271 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/README.md
--rw-r--r--   0 runner    (1001) docker     (123)     2545 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/pyproject.toml
--rw-r--r--   0 runner    (1001) docker     (123)       38 2023-05-27 20:59:37.980270 maestral-1.7.3.dev3/setup.cfg
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.964270 maestral-1.7.3.dev3/src/
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.972270 maestral-1.7.3.dev3/src/maestral/
--rw-r--r--   0 runner    (1001) docker     (123)      228 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)       82 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/__main__.py
--rw-r--r--   0 runner    (1001) docker     (123)    12986 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/autostart.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/cli/
--rw-r--r--   0 runner    (1001) docker     (123)      218 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)    14787 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_core.py
--rw-r--r--   0 runner    (1001) docker     (123)    10518 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_info.py
--rwxr-xr-x   0 runner    (1001) docker     (123)     1925 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_main.py
--rw-r--r--   0 runner    (1001) docker     (123)    15396 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_maintenance.py
--rw-r--r--   0 runner    (1001) docker     (123)     5730 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/cli_settings.py
--rw-r--r--   0 runner    (1001) docker     (123)     3222 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/common.py
--rw-r--r--   0 runner    (1001) docker     (123)     7959 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/core.py
--rw-r--r--   0 runner    (1001) docker     (123)     3387 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/dialogs.py
--rw-r--r--   0 runner    (1001) docker     (123)     3417 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/output.py
--rw-r--r--   0 runner    (1001) docker     (123)      477 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/cli/utils.py
--rw-r--r--   0 runner    (1001) docker     (123)    69578 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/client.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/config/
--rw-r--r--   0 runner    (1001) docker     (123)     1718 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/config/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5859 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/config/main.py
--rw-r--r--   0 runner    (1001) docker     (123)    17864 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/config/user.py
--rw-r--r--   0 runner    (1001) docker     (123)     2278 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/constants.py
--rw-r--r--   0 runner    (1001) docker     (123)     3102 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/core.py
--rw-r--r--   0 runner    (1001) docker     (123)    21989 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/daemon.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/database/
--rw-r--r--   0 runner    (1001) docker     (123)      170 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     1187 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/core.py
--rw-r--r--   0 runner    (1001) docker     (123)    17337 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/orm.py
--rw-r--r--   0 runner    (1001) docker     (123)     4696 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/query.py
--rw-r--r--   0 runner    (1001) docker     (123)     2485 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/database/types.py
--rw-r--r--   0 runner    (1001) docker     (123)    33650 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/errorhandling.py
--rw-r--r--   0 runner    (1001) docker     (123)     7096 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/exceptions.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/fsevents/
--rw-r--r--   0 runner    (1001) docker     (123)     1139 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/fsevents/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     5465 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/fsevents/polling.py
--rw-r--r--   0 runner    (1001) docker     (123)     9847 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/keyring.py
--rw-r--r--   0 runner    (1001) docker     (123)     9041 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/logging.py
--rw-r--r--   0 runner    (1001) docker     (123)    63332 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/main.py
--rw-r--r--   0 runner    (1001) docker     (123)    29677 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/manager.py
--rw-r--r--   0 runner    (1001) docker     (123)    17802 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/models.py
--rw-r--r--   0 runner    (1001) docker     (123)     4669 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/notify.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.976270 maestral-1.7.3.dev3/src/maestral/resources/
--rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/resources/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)   137001 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/resources/maestral.png
--rw-r--r--   0 runner    (1001) docker     (123)   150174 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/sync.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.980270 maestral-1.7.3.dev3/src/maestral/utils/
--rw-r--r--   0 runner    (1001) docker     (123)     4059 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/__init__.py
--rw-r--r--   0 runner    (1001) docker     (123)     6874 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/appdirs.py
--rw-r--r--   0 runner    (1001) docker     (123)     1445 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/caches.py
--rw-r--r--   0 runner    (1001) docker     (123)     4462 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/hashing.py
--rw-r--r--   0 runner    (1001) docker     (123)     7916 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/integration.py
--rw-r--r--   0 runner    (1001) docker     (123)    19290 2023-05-27 20:59:15.000000 maestral-1.7.3.dev3/src/maestral/utils/path.py
-drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-27 20:59:37.972270 maestral-1.7.3.dev3/src/maestral.egg-info/
--rw-r--r--   0 runner    (1001) docker     (123)     8246 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/PKG-INFO
--rw-r--r--   0 runner    (1001) docker     (123)     1520 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/SOURCES.txt
--rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/dependency_links.txt
--rw-r--r--   0 runner    (1001) docker     (123)       47 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/entry_points.txt
--rw-r--r--   0 runner    (1001) docker     (123)      754 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/requires.txt
--rw-r--r--   0 runner    (1001) docker     (123)        9 2023-05-27 20:59:37.000000 maestral-1.7.3.dev3/src/maestral.egg-info/top_level.txt
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.501922 maestral-1.7.3.dev4/
+-rw-r--r--   0 runner    (1001) docker     (123)     1076 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/LICENSE.txt
+-rw-r--r--   0 runner    (1001) docker     (123)     8246 2023-05-29 15:14:21.501922 maestral-1.7.3.dev4/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     7271 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/README.md
+-rw-r--r--   0 runner    (1001) docker     (123)     2545 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/pyproject.toml
+-rw-r--r--   0 runner    (1001) docker     (123)       38 2023-05-29 15:14:21.501922 maestral-1.7.3.dev4/setup.cfg
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.485922 maestral-1.7.3.dev4/src/
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.493922 maestral-1.7.3.dev4/src/maestral/
+-rw-r--r--   0 runner    (1001) docker     (123)      228 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)       82 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/__main__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    12986 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/autostart.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.497922 maestral-1.7.3.dev4/src/maestral/cli/
+-rw-r--r--   0 runner    (1001) docker     (123)      218 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)    14787 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/cli_core.py
+-rw-r--r--   0 runner    (1001) docker     (123)    10518 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/cli_info.py
+-rwxr-xr-x   0 runner    (1001) docker     (123)     1925 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/cli_main.py
+-rw-r--r--   0 runner    (1001) docker     (123)    15396 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/cli_maintenance.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5730 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/cli_settings.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3222 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/common.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7959 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/core.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3387 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/dialogs.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3417 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/output.py
+-rw-r--r--   0 runner    (1001) docker     (123)      477 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/cli/utils.py
+-rw-r--r--   0 runner    (1001) docker     (123)    69578 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/client.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.497922 maestral-1.7.3.dev4/src/maestral/config/
+-rw-r--r--   0 runner    (1001) docker     (123)     1718 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/config/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5784 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/config/main.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17864 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/config/user.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2278 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/constants.py
+-rw-r--r--   0 runner    (1001) docker     (123)     3102 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/core.py
+-rw-r--r--   0 runner    (1001) docker     (123)    21989 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/daemon.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.497922 maestral-1.7.3.dev4/src/maestral/database/
+-rw-r--r--   0 runner    (1001) docker     (123)      170 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/database/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1187 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/database/core.py
+-rw-r--r--   0 runner    (1001) docker     (123)    17337 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/database/orm.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4696 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/database/query.py
+-rw-r--r--   0 runner    (1001) docker     (123)     2485 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/database/types.py
+-rw-r--r--   0 runner    (1001) docker     (123)    33650 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/errorhandling.py
+-rw-r--r--   0 runner    (1001) docker     (123)     7096 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/exceptions.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.497922 maestral-1.7.3.dev4/src/maestral/fsevents/
+-rw-r--r--   0 runner    (1001) docker     (123)     1139 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/fsevents/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5465 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/fsevents/polling.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9847 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/keyring.py
+-rw-r--r--   0 runner    (1001) docker     (123)     9041 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/logging.py
+-rw-r--r--   0 runner    (1001) docker     (123)    63332 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/main.py
+-rw-r--r--   0 runner    (1001) docker     (123)    28502 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/manager.py
+-rw-r--r--   0 runner    (1001) docker     (123)    18270 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/models.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4669 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/notify.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.497922 maestral-1.7.3.dev4/src/maestral/resources/
+-rw-r--r--   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/resources/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)   137001 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/resources/maestral.png
+-rw-r--r--   0 runner    (1001) docker     (123)   150126 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/sync.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.501922 maestral-1.7.3.dev4/src/maestral/utils/
+-rw-r--r--   0 runner    (1001) docker     (123)     4059 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/utils/__init__.py
+-rw-r--r--   0 runner    (1001) docker     (123)     6874 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/utils/appdirs.py
+-rw-r--r--   0 runner    (1001) docker     (123)     1445 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/utils/caches.py
+-rw-r--r--   0 runner    (1001) docker     (123)     4462 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/utils/hashing.py
+-rw-r--r--   0 runner    (1001) docker     (123)     5557 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/utils/integration.py
+-rw-r--r--   0 runner    (1001) docker     (123)    19290 2023-05-29 15:14:02.000000 maestral-1.7.3.dev4/src/maestral/utils/path.py
+drwxr-xr-x   0 runner    (1001) docker     (123)        0 2023-05-29 15:14:21.493922 maestral-1.7.3.dev4/src/maestral.egg-info/
+-rw-r--r--   0 runner    (1001) docker     (123)     8246 2023-05-29 15:14:21.000000 maestral-1.7.3.dev4/src/maestral.egg-info/PKG-INFO
+-rw-r--r--   0 runner    (1001) docker     (123)     1520 2023-05-29 15:14:21.000000 maestral-1.7.3.dev4/src/maestral.egg-info/SOURCES.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        1 2023-05-29 15:14:21.000000 maestral-1.7.3.dev4/src/maestral.egg-info/dependency_links.txt
+-rw-r--r--   0 runner    (1001) docker     (123)       47 2023-05-29 15:14:21.000000 maestral-1.7.3.dev4/src/maestral.egg-info/entry_points.txt
+-rw-r--r--   0 runner    (1001) docker     (123)      754 2023-05-29 15:14:21.000000 maestral-1.7.3.dev4/src/maestral.egg-info/requires.txt
+-rw-r--r--   0 runner    (1001) docker     (123)        9 2023-05-29 15:14:21.000000 maestral-1.7.3.dev4/src/maestral.egg-info/top_level.txt
```

### Comparing `maestral-1.7.3.dev3/LICENSE.txt` & `maestral-1.7.3.dev4/LICENSE.txt`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/PKG-INFO` & `maestral-1.7.3.dev4/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: maestral
-Version: 1.7.3.dev3
+Version: 1.7.3.dev4
 Summary: Open-source Dropbox client for macOS and Linux.
 Author-email: Sam Schott <sam.schott@outlook.com>
 License: MIT
 Project-URL: Homepage, https://maestral.app
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Operating System :: Unix
 Classifier: Programming Language :: Python
```

### Comparing `maestral-1.7.3.dev3/README.md` & `maestral-1.7.3.dev4/README.md`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/pyproject.toml` & `maestral-1.7.3.dev4/pyproject.toml`

 * *Files 2% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 [build-system]
 requires = ["setuptools>=61.2", "build"]
 build-backend = "setuptools.build_meta"
 
 [project]
 name = "maestral"
-version = "1.7.3.dev3"
+version = "1.7.3.dev4"
 authors = [{name = "Sam Schott", email = "sam.schott@outlook.com"}]
 license = {text = "MIT"}
 description = "Open-source Dropbox client for macOS and Linux."
 classifiers = [
     "License :: OSI Approved :: MIT License",
     "Operating System :: Unix",
     "Programming Language :: Python",
@@ -45,16 +45,16 @@
 
 [project.readme]
 file = "README.md"
 content-type = "text/markdown"
 
 [project.optional-dependencies]
 gui = [
-    "maestral-qt>=1.7.3.dev3;sys_platform=='linux'",
-    "maestral-cocoa>=1.7.3.dev3;sys_platform=='darwin'",
+    "maestral-qt>=1.7.3.dev4;sys_platform=='linux'",
+    "maestral-cocoa>=1.7.3.dev4;sys_platform=='darwin'",
 ]
 syslog = ["systemd-python"]
 lint = [
     "black",
     "flake8",
     "flake8-pyproject",
     "mypy",
```

### Comparing `maestral-1.7.3.dev3/src/maestral/autostart.py` & `maestral-1.7.3.dev4/src/maestral/autostart.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/cli/cli_core.py` & `maestral-1.7.3.dev4/src/maestral/cli/cli_core.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/cli/cli_info.py` & `maestral-1.7.3.dev4/src/maestral/cli/cli_info.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/cli/cli_main.py` & `maestral-1.7.3.dev4/src/maestral/cli/cli_main.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/cli/cli_maintenance.py` & `maestral-1.7.3.dev4/src/maestral/cli/cli_maintenance.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/cli/cli_settings.py` & `maestral-1.7.3.dev4/src/maestral/cli/cli_settings.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/cli/common.py` & `maestral-1.7.3.dev4/src/maestral/cli/common.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/cli/core.py` & `maestral-1.7.3.dev4/src/maestral/cli/core.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/cli/dialogs.py` & `maestral-1.7.3.dev4/src/maestral/cli/dialogs.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/cli/output.py` & `maestral-1.7.3.dev4/src/maestral/cli/output.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/client.py` & `maestral-1.7.3.dev4/src/maestral/client.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/config/__init__.py` & `maestral-1.7.3.dev4/src/maestral/config/__init__.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/config/main.py` & `maestral-1.7.3.dev4/src/maestral/config/main.py`

 * *Files 2% similar despite different names*

```diff
@@ -35,15 +35,14 @@
         "bandwidth_limit_down": 0.0,  # download limit in bytes / sec (0 = unlimited)
         "max_parallel_uploads": 6,  # max number of parallel downloads
         "max_parallel_downloads": 6,  # max number of parallel downloads
     },
     "sync": {
         "path": "",  # dropbox folder location
         "excluded_items": [],  # files and folders excluded from sync
-        "reindex_interval": 60 * 60 * 24 * 14,  # default: every fortnight
         "max_cpu_percent": 20.0,  # max CPU usage target (100% = all cores busy)
         "keep_history": 60 * 60 * 24 * 7,  # default: one week
         "upload": True,  # if download sync is enabled
         "download": True,  # if upload sync is enabled
     },
 }
 
@@ -85,15 +84,15 @@
 # IMPORTANT NOTES:
 # 1. If you want to *change* the default value of a current option, you need to
 #    do a MINOR update in config version, e.g. from 3.0 to 3.1
 # 2. If you want to *remove* options that are no longer needed in our codebase,
 #    or if you want to *rename* options, then you need to do a MAJOR update in
 #    version, e.g. from 3.0 to 4.0
 # 3. You don't need to touch this value if you're just adding a new option
-CONF_VERSION = Version("19.0")
+CONF_VERSION = Version("20.0")
 
 
 # =============================================================================
 # Factories
 # =============================================================================
```

### Comparing `maestral-1.7.3.dev3/src/maestral/config/user.py` & `maestral-1.7.3.dev4/src/maestral/config/user.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/constants.py` & `maestral-1.7.3.dev4/src/maestral/constants.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/core.py` & `maestral-1.7.3.dev4/src/maestral/core.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/daemon.py` & `maestral-1.7.3.dev4/src/maestral/daemon.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/database/core.py` & `maestral-1.7.3.dev4/src/maestral/database/core.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/database/orm.py` & `maestral-1.7.3.dev4/src/maestral/database/orm.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/database/query.py` & `maestral-1.7.3.dev4/src/maestral/database/query.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/database/types.py` & `maestral-1.7.3.dev4/src/maestral/database/types.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/errorhandling.py` & `maestral-1.7.3.dev4/src/maestral/errorhandling.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/exceptions.py` & `maestral-1.7.3.dev4/src/maestral/exceptions.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/fsevents/__init__.py` & `maestral-1.7.3.dev4/src/maestral/fsevents/__init__.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/fsevents/polling.py` & `maestral-1.7.3.dev4/src/maestral/fsevents/polling.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/keyring.py` & `maestral-1.7.3.dev4/src/maestral/keyring.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/logging.py` & `maestral-1.7.3.dev4/src/maestral/logging.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/main.py` & `maestral-1.7.3.dev4/src/maestral/main.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/manager.py` & `maestral-1.7.3.dev4/src/maestral/manager.py`

 * *Files 6% similar despite different names*

```diff
@@ -43,15 +43,14 @@
 )
 from .sync import SyncEngine
 from .logging import scoped_logger
 from .notify import MaestralDesktopNotifier
 from .utils import removeprefix
 from .utils.integration import check_connection, get_inotify_limits
 from .utils.path import move, delete, is_equal_or_child, is_child, normalize
-from .utils.integration import get_ac_state, ACState
 
 
 __all__ = ["SyncManager"]
 
 DROPBOX_API_HOSTNAME = "https://" + API_HOST
 
 
@@ -163,26 +162,14 @@
                 return fn(__self, *args, **kwargs)
 
         return wrapper
 
     # ---- config and state ------------------------------------------------------------
 
     @property
-    def reindex_interval(self) -> float:
-        """
-        Interval in sec for period reindexing. Changes will be saved to state file.
-        """
-        return self._conf.get("sync", "reindex_interval")
-
-    @reindex_interval.setter
-    def reindex_interval(self, interval: float) -> None:
-        """Setter: reindex_interval"""
-        self._conf.set("sync", "reindex_interval", interval)
-
-    @property
     def idle_time(self) -> float:
         """
         Returns the idle time in seconds since the last file change or since startup if
         there haven't been any changes in our current session.
         """
         now = time.time()
         time_since_startup = now - self._startup_time
@@ -387,28 +374,14 @@
 
         self.stop()
         self.reset_sync_state()
 
         if was_running:
             self.start()
 
-    def _should_rebuild_index(self) -> bool:
-        """
-        Check if reindexing is due and can be performed now. This is determined by the
-        'reindex_interval' setting. Don't reindex if we are running on battery power.
-        """
-        elapsed = time.time() - self.sync.last_reindex
-        ac_state = get_ac_state()
-
-        reindexing_due = elapsed > self.reindex_interval
-        is_idle = self.idle_time > 20 * 60
-        has_ac_power = ac_state in (ACState.Connected, ACState.Undetermined)
-
-        return reindexing_due and is_idle and has_ac_power
-
     # ---- path root management --------------------------------------------------------
 
     def check_and_update_path_root(self) -> bool:
         """
         Checks if the user's root namespace corresponds to the currently configured
         path root. Updates the root namespace if required and migrates the local
         folder structure. Syncing will be paused during the migration.
@@ -642,18 +615,14 @@
                 has_changes = self.sync.wait_for_remote_changes(self.sync.remote_cursor)
 
                 # Check for root namespace updates. Don't apply any remote
                 # changes in case of a changed root path.
                 if self.check_and_update_path_root():
                     return
 
-                # Check for and perform reindexing.
-                if self._should_rebuild_index():
-                    self.rebuild_index()
-
                 if not running.is_set():
                     return
 
                 self.sync.ensure_dropbox_folder_present()
 
                 if has_changes:
                     self._logger.info(SYNCING)
```

### Comparing `maestral-1.7.3.dev3/src/maestral/models.py` & `maestral-1.7.3.dev4/src/maestral/models.py`

 * *Files 2% similar despite different names*

```diff
@@ -12,14 +12,16 @@
 import time
 import enum
 from typing import TYPE_CHECKING
 
 # external imports
 from watchdog.events import (
     FileSystemEvent,
+    FileMovedEvent,
+    DirMovedEvent,
     EVENT_TYPE_CREATED,
     EVENT_TYPE_DELETED,
     EVENT_TYPE_MOVED,
     EVENT_TYPE_MODIFIED,
 )
 
 # local imports
@@ -41,14 +43,27 @@
     "SyncEvent",
     "IndexEntry",
     "HashCacheEntry",
     "SyncErrorEntry",
 ]
 
 
+def get_dest_path(event: FileSystemEvent) -> str:
+    """
+    Returns the dest_path of a file system event if present (moved events only)
+    otherwise returns the src_path (which is also the "destination").
+
+    :param event: Watchdog file system event.
+    :returns: Destination path for moved event, source path otherwise.
+    """
+    if isinstance(event, (FileMovedEvent, DirMovedEvent)):
+        return event.dest_path
+    return event.src_path
+
+
 class SyncDirection(enum.Enum):
     """Enumeration of sync directions"""
 
     Up = "up"
     Down = "down"
 
 
@@ -362,15 +377,15 @@
         try:
             change_dbid = sync_engine.client.account_info.account_id
         except NotLinkedError:
             # Allow converting events when we are not linked.
             # This is useful for testing.
             change_dbid = ""
 
-        to_path = getattr(event, "dest_path", event.src_path)
+        to_path = get_dest_path(event)
         from_path = None
 
         if event.event_type == EVENT_TYPE_CREATED:
             change_type = ChangeType.Added
         elif event.event_type == EVENT_TYPE_DELETED:
             change_type = ChangeType.Removed
         elif event.event_type == EVENT_TYPE_MOVED:
```

### Comparing `maestral-1.7.3.dev3/src/maestral/notify.py` & `maestral-1.7.3.dev4/src/maestral/notify.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/resources/maestral.png` & `maestral-1.7.3.dev4/src/maestral/resources/maestral.png`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/sync.py` & `maestral-1.7.3.dev4/src/maestral/sync.py`

 * *Files 0% similar despite different names*

```diff
@@ -545,8842 +545,8839 @@
 00002200: 726e 733a 2057 6865 7468 6572 2074 6865  rns: Whether the
 00002210: 2065 7665 6e74 2073 686f 756c 6420 6265   event should be
 00002220: 2069 676e 6f72 6564 2e0a 2020 2020 2020   ignored..      
 00002230: 2020 2222 220a 2020 2020 2020 2020 666f    """.        fo
 00002240: 7220 6967 6e6f 7265 2069 6e20 7365 6c66  r ignore in self
 00002250: 2e5f 6967 6e6f 7265 645f 6576 656e 7473  ._ignored_events
 00002260: 2e63 6f70 7928 293a 0a20 2020 2020 2020  .copy():.       
-00002270: 2020 2020 2023 2043 6865 636b 2066 6f72       # Check for
-00002280: 2065 7870 6972 6564 2065 7665 6e74 732e   expired events.
-00002290: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000022a0: 6967 6e6f 7265 2e74 746c 2061 6e64 2069  ignore.ttl and i
-000022b0: 676e 6f72 652e 7474 6c20 3c20 7469 6d65  gnore.ttl < time
-000022c0: 2e74 696d 6528 293a 0a20 2020 2020 2020  .time():.       
-000022d0: 2020 2020 2020 2020 2073 656c 662e 5f69           self._i
-000022e0: 676e 6f72 6564 5f65 7665 6e74 732e 6469  gnored_events.di
-000022f0: 7363 6172 6428 6967 6e6f 7265 290a 2020  scard(ignore).  
-00002300: 2020 2020 2020 2020 2020 2020 2020 636f                co
-00002310: 6e74 696e 7565 0a0a 2020 2020 2020 2020  ntinue..        
-00002320: 2020 2020 6967 6e6f 7265 5f65 7665 6e74      ignore_event
-00002330: 203d 2069 676e 6f72 652e 6576 656e 740a   = ignore.event.
-00002340: 2020 2020 2020 2020 2020 2020 7265 6375              recu
-00002350: 7273 6976 6520 3d20 6967 6e6f 7265 2e72  rsive = ignore.r
-00002360: 6563 7572 7369 7665 0a0a 2020 2020 2020  ecursive..      
-00002370: 2020 2020 2020 6966 2065 7665 6e74 203d        if event =
-00002380: 3d20 6967 6e6f 7265 5f65 7665 6e74 3a0a  = ignore_event:.
-00002390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023a0: 6966 206e 6f74 2072 6563 7572 7369 7665  if not recursive
-000023b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000023c0: 2020 2020 2020 7365 6c66 2e5f 6967 6e6f        self._igno
-000023d0: 7265 645f 6576 656e 7473 2e64 6973 6361  red_events.disca
-000023e0: 7264 2869 676e 6f72 6529 0a20 2020 2020  rd(ignore).     
-000023f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00002400: 6e20 5472 7565 0a0a 2020 2020 2020 2020  n True..        
-00002410: 2020 2020 656c 6966 2072 6563 7572 7369      elif recursi
-00002420: 7665 3a0a 2020 2020 2020 2020 2020 2020  ve:.            
-00002430: 2020 2020 7479 7065 5f6d 6174 6368 203d      type_match =
-00002440: 2065 7665 6e74 2e65 7665 6e74 5f74 7970   event.event_typ
-00002450: 6520 3d3d 2069 676e 6f72 655f 6576 656e  e == ignore_even
-00002460: 742e 6576 656e 745f 7479 7065 0a20 2020  t.event_type.   
-00002470: 2020 2020 2020 2020 2020 2020 2073 7263               src
-00002480: 5f6d 6174 6368 203d 2069 735f 6571 7561  _match = is_equa
-00002490: 6c5f 6f72 5f63 6869 6c64 2865 7665 6e74  l_or_child(event
-000024a0: 2e73 7263 5f70 6174 682c 2069 676e 6f72  .src_path, ignor
-000024b0: 655f 6576 656e 742e 7372 635f 7061 7468  e_event.src_path
-000024c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000024d0: 2020 6465 7374 5f6d 6174 6368 203d 2069    dest_match = i
-000024e0: 735f 6571 7561 6c5f 6f72 5f63 6869 6c64  s_equal_or_child
-000024f0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00002500: 2020 2020 2020 6765 745f 6465 7374 5f70        get_dest_p
-00002510: 6174 6828 6576 656e 7429 2c20 6765 745f  ath(event), get_
-00002520: 6465 7374 5f70 6174 6828 6967 6e6f 7265  dest_path(ignore
-00002530: 5f65 7665 6e74 290a 2020 2020 2020 2020  _event).        
-00002540: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00002550: 2020 2020 2020 2020 2020 2069 6620 7479             if ty
-00002560: 7065 5f6d 6174 6368 2061 6e64 2073 7263  pe_match and src
-00002570: 5f6d 6174 6368 2061 6e64 2064 6573 745f  _match and dest_
-00002580: 6d61 7463 683a 0a20 2020 2020 2020 2020  match:.         
-00002590: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-000025a0: 6e20 5472 7565 0a0a 2020 2020 2020 2020  n True..        
-000025b0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
-000025c0: 2020 6465 6620 6f6e 5f61 6e79 5f65 7665    def on_any_eve
-000025d0: 6e74 2873 656c 662c 2065 7665 6e74 3a20  nt(self, event: 
-000025e0: 4669 6c65 5379 7374 656d 4576 656e 7429  FileSystemEvent)
-000025f0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00002600: 2020 2222 220a 2020 2020 2020 2020 4368    """.        Ch
-00002610: 6563 6b73 2069 6620 7468 6520 7379 7374  ecks if the syst
-00002620: 656d 2066 696c 6520 6576 656e 7420 7368  em file event sh
-00002630: 6f75 6c64 2062 6520 6967 6e6f 7265 642e  ould be ignored.
-00002640: 2049 6620 6e6f 742c 2061 6464 7320 6974   If not, adds it
-00002650: 2074 6f20 7468 6520 7175 6575 650a 2020   to the queue.  
-00002660: 2020 2020 2020 666f 7220 6576 656e 7473        for events
-00002670: 2074 6f20 7570 6c6f 6164 2e20 4966 2073   to upload. If s
-00002680: 796e 6369 6e67 2069 7320 7061 7573 6564  yncing is paused
-00002690: 206f 7220 7374 6f70 7065 642c 2061 6c6c   or stopped, all
-000026a0: 2065 7665 6e74 7320 7769 6c6c 2062 650a   events will be.
-000026b0: 2020 2020 2020 2020 6967 6e6f 7265 642e          ignored.
-000026c0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-000026d0: 2065 7665 6e74 3a20 5761 7463 6864 6f67   event: Watchdog
-000026e0: 2066 696c 6520 6576 656e 742e 0a20 2020   file event..   
-000026f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00002700: 2023 2049 676e 6f72 6520 6576 656e 7473   # Ignore events
-00002710: 2069 6620 6173 6b65 6420 746f 2064 6f20   if asked to do 
-00002720: 736f 2e0a 2020 2020 2020 2020 6966 206e  so..        if n
-00002730: 6f74 2073 656c 662e 5f65 6e61 626c 6564  ot self._enabled
-00002740: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00002750: 7475 726e 0a0a 2020 2020 2020 2020 2320  turn..        # 
-00002760: 4861 6e64 6c65 206f 6e6c 7920 7768 6974  Handle only whit
-00002770: 656c 6973 7465 6420 6469 7220 6576 656e  elisted dir even
-00002780: 7420 7479 7065 732e 0a20 2020 2020 2020  t types..       
-00002790: 2069 6620 6576 656e 742e 6973 5f64 6972   if event.is_dir
-000027a0: 6563 746f 7279 2061 6e64 2065 7665 6e74  ectory and event
-000027b0: 2e65 7665 6e74 5f74 7970 6520 6e6f 7420  .event_type not 
-000027c0: 696e 2073 656c 662e 6469 725f 6576 656e  in self.dir_even
-000027d0: 745f 7479 7065 733a 0a20 2020 2020 2020  t_types:.       
-000027e0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-000027f0: 2020 2020 2023 2048 616e 646c 6520 6f6e       # Handle on
-00002800: 6c79 2077 6869 7465 6c69 7374 6564 2066  ly whitelisted f
-00002810: 696c 6520 6576 656e 7420 7479 7065 732e  ile event types.
-00002820: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00002830: 6576 656e 742e 6973 5f64 6972 6563 746f  event.is_directo
-00002840: 7279 2061 6e64 2065 7665 6e74 2e65 7665  ry and event.eve
-00002850: 6e74 5f74 7970 6520 6e6f 7420 696e 2073  nt_type not in s
-00002860: 656c 662e 6669 6c65 5f65 7665 6e74 5f74  elf.file_event_t
-00002870: 7970 6573 3a0a 2020 2020 2020 2020 2020  ypes:.          
-00002880: 2020 7265 7475 726e 0a0a 2020 2020 2020    return..      
-00002890: 2020 2320 4967 6e6f 7265 206d 6f76 6573    # Ignore moves
-000028a0: 206f 6e74 6f20 6974 7365 6c66 2c20 7468   onto itself, th
-000028b0: 6579 206d 6179 2062 6520 6572 726f 6e65  ey may be errone
-000028c0: 6f75 736c 7920 656d 6974 7465 6420 6f6e  ously emitted on
-000028d0: 206f 6c64 6572 2076 6572 7369 6f6e 7320   older versions 
-000028e0: 6f66 0a20 2020 2020 2020 2023 206d 6163  of.        # mac
-000028f0: 4f53 2077 6865 6e20 6368 616e 6769 6e67  OS when changing
-00002900: 2074 6865 2075 6e69 636f 6465 206e 6f72   the unicode nor
-00002910: 6d61 6c69 7361 7469 6f6e 206f 6620 6120  malisation of a 
-00002920: 7061 7468 2077 6974 6820 6f73 2e72 656e  path with os.ren
-00002930: 616d 6528 292e 0a20 2020 2020 2020 2023  ame()..        #
-00002940: 2053 6565 2068 7474 7073 3a2f 2f67 6974   See https://git
-00002950: 6875 622e 636f 6d2f 7361 6d73 6368 6f74  hub.com/samschot
-00002960: 742f 6d61 6573 7472 616c 2f69 7373 7565  t/maestral/issue
-00002970: 732f 3637 312e 0a20 2020 2020 2020 2069  s/671..        i
-00002980: 6620 6973 5f6d 6f76 6564 2865 7665 6e74  f is_moved(event
-00002990: 2920 616e 6420 6576 656e 742e 7372 635f  ) and event.src_
-000029a0: 7061 7468 203d 3d20 6576 656e 742e 6465  path == event.de
-000029b0: 7374 5f70 6174 683a 0a20 2020 2020 2020  st_path:.       
-000029c0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-000029d0: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
-000029e0: 6576 656e 7420 7368 6f75 6c64 2062 6520  event should be 
-000029f0: 6967 6e6f 7265 642e 0a20 2020 2020 2020  ignored..       
-00002a00: 2069 6620 7365 6c66 2e5f 6973 5f69 676e   if self._is_ign
-00002a10: 6f72 6564 2865 7665 6e74 293a 0a20 2020  ored(event):.   
-00002a20: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
-00002a30: 0a20 2020 2020 2020 2073 656c 662e 7175  .        self.qu
-00002a40: 6575 655f 6576 656e 7428 6576 656e 7429  eue_event(event)
-00002a50: 0a0a 2020 2020 6465 6620 7175 6575 655f  ..    def queue_
-00002a60: 6576 656e 7428 7365 6c66 2c20 6576 656e  event(self, even
-00002a70: 743a 2046 696c 6553 7973 7465 6d45 7665  t: FileSystemEve
-00002a80: 6e74 2920 2d3e 204e 6f6e 653a 0a20 2020  nt) -> None:.   
-00002a90: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00002aa0: 2051 7565 7565 7320 616e 2069 6e64 6976   Queues an indiv
-00002ab0: 6964 7561 6c20 6669 6c65 2073 7973 7465  idual file syste
-00002ac0: 6d20 6576 656e 742e 204e 6f74 6966 6965  m event. Notifie
-00002ad0: 7320 2f20 7761 6b65 7320 7570 2061 6c6c  s / wakes up all
-00002ae0: 2074 6872 6561 6473 2074 6861 7420 6172   threads that ar
-00002af0: 650a 2020 2020 2020 2020 7761 6974 696e  e.        waitin
-00002b00: 6720 7769 7468 203a 6d65 7468 3a60 7761  g with :meth:`wa
-00002b10: 6974 5f66 6f72 5f65 7665 6e74 602e 0a0a  it_for_event`...
-00002b20: 2020 2020 2020 2020 3a70 6172 616d 2065          :param e
-00002b30: 7665 6e74 3a20 4669 6c65 2073 7973 7465  vent: File syste
-00002b40: 6d20 6576 656e 7420 746f 2071 7565 7565  m event to queue
-00002b50: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00002b60: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00002b70: 6861 735f 6576 656e 7473 3a0a 2020 2020  has_events:.    
-00002b80: 2020 2020 2020 2020 7365 6c66 2e6c 6f63          self.loc
-00002b90: 616c 5f66 696c 655f 6576 656e 745f 7175  al_file_event_qu
-00002ba0: 6575 652e 7075 7428 6576 656e 7429 0a20  eue.put(event). 
-00002bb0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00002bc0: 6861 735f 6576 656e 7473 2e6e 6f74 6966  has_events.notif
-00002bd0: 795f 616c 6c28 290a 0a20 2020 2064 6566  y_all()..    def
-00002be0: 2077 6169 745f 666f 725f 6576 656e 7428   wait_for_event(
-00002bf0: 7365 6c66 2c20 7469 6d65 6f75 743a 2066  self, timeout: f
-00002c00: 6c6f 6174 203d 2034 3029 202d 3e20 626f  loat = 40) -> bo
-00002c10: 6f6c 3a0a 2020 2020 2020 2020 2222 220a  ol:.        """.
-00002c20: 2020 2020 2020 2020 426c 6f63 6b73 2075          Blocks u
-00002c30: 6e74 696c 2061 6e20 6576 656e 7420 6973  ntil an event is
-00002c40: 2061 7661 696c 6162 6c65 2069 6e20 7468   available in th
-00002c50: 6520 7175 6575 6520 6f72 2061 2074 696d  e queue or a tim
-00002c60: 656f 7574 206f 6363 7572 732c 2077 6869  eout occurs, whi
-00002c70: 6368 6576 6572 0a20 2020 2020 2020 2063  chever.        c
-00002c80: 6f6d 6573 2066 6972 7374 2e20 596f 7520  omes first. You 
-00002c90: 6361 6e20 7573 6520 7769 7468 206d 6574  can use with met
-00002ca0: 686f 6420 746f 2077 6169 7420 666f 7220  hod to wait for 
-00002cb0: 6669 6c65 2073 7973 7465 6d20 6576 656e  file system even
-00002cc0: 7473 2069 6e20 616e 6f74 6865 720a 2020  ts in another.  
-00002cd0: 2020 2020 2020 7468 7265 6164 2e0a 0a20        thread... 
-00002ce0: 2020 2020 2020 202e 2e20 6e6f 7465 3a3a         .. note::
-00002cf0: 2049 6620 7468 6572 6520 6172 6520 6d75   If there are mu
-00002d00: 6c74 6970 6c65 2074 6872 6561 6473 2077  ltiple threads w
-00002d10: 6169 7469 6e67 2066 6f72 2065 7665 6e74  aiting for event
-00002d20: 732c 2061 6c6c 206f 6620 7468 656d 2077  s, all of them w
-00002d30: 696c 6c20 6265 0a20 2020 2020 2020 2020  ill be.         
-00002d40: 2020 206e 6f74 6966 6965 642e 2049 6620     notified. If 
-00002d50: 6f6e 6520 6f66 2074 686f 7365 2074 6872  one of those thr
-00002d60: 6561 6473 2073 7461 7274 7320 6765 7474  eads starts gett
-00002d70: 696e 6720 6576 656e 7473 2066 726f 6d0a  ing events from.
-00002d80: 2020 2020 2020 2020 2020 2020 3a61 7474              :att
-00002d90: 723a 606c 6f63 616c 5f66 696c 655f 6576  r:`local_file_ev
-00002da0: 656e 745f 7175 6575 6560 2c20 6f74 6865  ent_queue`, othe
-00002db0: 7220 7468 7265 6164 7320 6d61 7920 6669  r threads may fi
-00002dc0: 6e64 2074 6861 7420 7468 6520 7175 6575  nd that the queu
-00002dd0: 6520 6973 0a20 2020 2020 2020 2020 2020  e is.           
-00002de0: 2065 6d70 7479 2064 6573 7069 7465 2062   empty despite b
-00002df0: 6569 6e67 2077 6f6b 656e 2e20 596f 7520  eing woken. You 
-00002e00: 7368 6f75 6c64 2074 6865 7265 666f 7265  should therefore
-00002e10: 2062 6520 7072 6570 6172 6564 2074 6f20   be prepared to 
-00002e20: 6861 6e64 6c65 2061 6e0a 2020 2020 2020  handle an.      
-00002e30: 2020 2020 2020 656d 7074 7920 7175 6575        empty queu
-00002e40: 6520 6576 656e 2069 6620 7468 6973 206d  e even if this m
-00002e50: 6574 686f 6420 7265 7475 726e 7320 6060  ethod returns ``
-00002e60: 5472 7565 6060 2e0a 0a20 2020 2020 2020  True``...       
-00002e70: 203a 7061 7261 6d20 7469 6d65 6f75 743a   :param timeout:
-00002e80: 204d 6178 696d 756d 2074 696d 6520 746f   Maximum time to
-00002e90: 2062 6c6f 636b 2069 6e20 7365 636f 6e64   block in second
-00002ea0: 732e 0a20 2020 2020 2020 203a 7265 7475  s..        :retu
-00002eb0: 726e 733a 2060 6054 7275 6560 6020 6966  rns: ``True`` if
-00002ec0: 2061 6e20 6576 656e 7420 6973 2061 7661   an event is ava
-00002ed0: 696c 6162 6c65 2c20 6060 4661 6c73 6560  ilable, ``False`
-00002ee0: 6020 6966 2074 6865 2063 616c 6c20 7265  ` if the call re
-00002ef0: 7475 726e 7320 6475 650a 2020 2020 2020  turns due.      
-00002f00: 2020 2020 2020 746f 2061 2074 696d 656f        to a timeo
-00002f10: 7574 2e0a 2020 2020 2020 2020 2222 220a  ut..        """.
-00002f20: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00002f30: 662e 6861 735f 6576 656e 7473 3a0a 2020  f.has_events:.  
-00002f40: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00002f50: 662e 6c6f 6361 6c5f 6669 6c65 5f65 7665  f.local_file_eve
-00002f60: 6e74 5f71 7565 7565 2e71 7369 7a65 2829  nt_queue.qsize()
-00002f70: 203e 2030 3a0a 2020 2020 2020 2020 2020   > 0:.          
-00002f80: 2020 2020 2020 7265 7475 726e 2054 7275        return Tru
-00002f90: 650a 2020 2020 2020 2020 2020 2020 7365  e.            se
-00002fa0: 6c66 2e68 6173 5f65 7665 6e74 732e 7761  lf.has_events.wa
-00002fb0: 6974 2874 696d 656f 7574 290a 2020 2020  it(timeout).    
-00002fc0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00002fd0: 656c 662e 6c6f 6361 6c5f 6669 6c65 5f65  elf.local_file_e
-00002fe0: 7665 6e74 5f71 7565 7565 2e71 7369 7a65  vent_queue.qsize
-00002ff0: 2829 203e 2030 0a0a 0a63 6c61 7373 2041  () > 0...class A
-00003000: 6374 6976 6974 794e 6f64 653a 0a20 2020  ctivityNode:.   
-00003010: 2022 2222 4120 6e6f 6465 2069 6e20 6120   """A node in a 
-00003020: 7370 6172 7365 2074 7265 6520 746f 2072  sparse tree to r
-00003030: 6570 7265 7365 6e74 2073 796e 6369 6e67  epresent syncing
-00003040: 2061 6374 6976 6974 792e 0a0a 2020 2020   activity...    
-00003050: 4561 6368 206e 6f64 6520 7265 7072 6573  Each node repres
-00003060: 656e 7473 2061 6e20 6974 656d 2069 6e20  ents an item in 
-00003070: 7468 6520 6c6f 6361 6c20 4472 6f70 626f  the local Dropbo
-00003080: 7820 666f 6c64 6572 2e20 4170 6172 7420  x folder. Apart 
-00003090: 6672 6f6d 2074 6865 2072 6f6f 7420 6e6f  from the root no
-000030a0: 6465 2c0a 2020 2020 6974 656d 7320 7769  de,.    items wi
-000030b0: 6c6c 206f 6e6c 7920 6265 2070 7265 7365  ll only be prese
-000030c0: 6e74 2069 6620 7468 6579 206f 7220 616e  nt if they or an
-000030d0: 7920 6f66 2074 6865 6972 2063 6869 6c64  y of their child
-000030e0: 7265 6e20 6861 7665 2061 6e79 2073 796e  ren have any syn
-000030f0: 6320 6163 7469 7669 7479 2e0a 0a20 2020  c activity...   
-00003100: 203a 6174 7472 2063 6869 6c64 7265 6e3a   :attr children:
-00003110: 2041 6c6c 2063 6869 6c64 7265 6e20 7769   All children wi
-00003120: 7468 2073 796e 6320 6163 7469 7669 7479  th sync activity
-00003130: 2e20 4c65 6166 206e 6f64 6573 206d 7573  . Leaf nodes mus
-00003140: 7420 7265 7072 6573 656e 7420 6974 656d  t represent item
-00003150: 730a 2020 2020 2020 2020 7468 6174 2061  s.        that a
-00003160: 7265 2062 6569 6e67 2075 706c 6f61 6465  re being uploade
-00003170: 642c 2064 6f77 6e6c 6f61 6465 642c 206f  d, downloaded, o
-00003180: 7220 6861 7665 2061 2073 796e 6320 6572  r have a sync er
-00003190: 726f 722e 0a20 2020 203a 6174 7472 2073  ror..    :attr s
-000031a0: 796e 635f 6576 656e 7473 3a20 416c 6c20  ync_events: All 
-000031b0: 5379 6e63 4576 656e 7473 206f 6620 7468  SyncEvents of th
-000031c0: 6973 206e 6f64 6520 616e 6420 6974 7320  is node and its 
-000031d0: 6368 696c 6472 656e 2e0a 2020 2020 2222  children..    ""
-000031e0: 220a 0a20 2020 205f 5f73 6c6f 7473 5f5f  "..    __slots__
-000031f0: 203d 205b 226e 616d 6522 2c20 2270 6172   = ["name", "par
-00003200: 656e 7422 2c20 2263 6869 6c64 7265 6e22  ent", "children"
-00003210: 2c20 2273 796e 635f 6576 656e 7473 225d  , "sync_events"]
-00003220: 0a0a 2020 2020 6465 6620 5f5f 696e 6974  ..    def __init
-00003230: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
-00003240: 2c0a 2020 2020 2020 2020 6e61 6d65 3a20  ,.        name: 
-00003250: 7374 722c 0a20 2020 2020 2020 2073 796e  str,.        syn
-00003260: 635f 6576 656e 7473 3a20 4974 6572 6162  c_events: Iterab
-00003270: 6c65 5b53 796e 6345 7665 6e74 5d20 3d20  le[SyncEvent] = 
-00003280: 2829 2c0a 2020 2020 2020 2020 7061 7265  (),.        pare
-00003290: 6e74 3a20 4163 7469 7669 7479 4e6f 6465  nt: ActivityNode
-000032a0: 207c 204e 6f6e 6520 3d20 4e6f 6e65 2c0a   | None = None,.
-000032b0: 2020 2020 2920 2d3e 204e 6f6e 653a 0a20      ) -> None:. 
-000032c0: 2020 2020 2020 2073 656c 662e 6e61 6d65         self.name
-000032d0: 203d 206e 616d 650a 2020 2020 2020 2020   = name.        
-000032e0: 7365 6c66 2e70 6172 656e 7420 3d20 7061  self.parent = pa
-000032f0: 7265 6e74 0a20 2020 2020 2020 2073 656c  rent.        sel
-00003300: 662e 6368 696c 6472 656e 3a20 6469 6374  f.children: dict
-00003310: 5b73 7472 2c20 4163 7469 7669 7479 4e6f  [str, ActivityNo
-00003320: 6465 5d20 3d20 7b7d 0a20 2020 2020 2020  de] = {}.       
-00003330: 2073 656c 662e 7379 6e63 5f65 7665 6e74   self.sync_event
-00003340: 7320 3d20 7365 7428 7379 6e63 5f65 7665  s = set(sync_eve
-00003350: 6e74 7329 0a0a 2020 2020 6465 6620 5f5f  nts)..    def __
-00003360: 7265 7072 5f5f 2873 656c 6629 202d 3e20  repr__(self) -> 
-00003370: 7374 723a 0a20 2020 2020 2020 2072 6574  str:.        ret
-00003380: 7572 6e20 6622 3c7b 7365 6c66 2e5f 5f63  urn f"<{self.__c
-00003390: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f7d  lass__.__name__}
-000033a0: 286e 616d 653d 7b73 656c 662e 6e61 6d65  (name={self.name
-000033b0: 7d2c 2063 6869 6c64 7265 6e3d 7b73 656c  }, children={sel
-000033c0: 662e 6368 696c 6472 656e 7d2c 2073 796e  f.children}, syn
-000033d0: 635f 6576 656e 7473 3d7b 7365 6c66 2e73  c_events={self.s
-000033e0: 796e 635f 6576 656e 7473 7d29 3e22 0a0a  ync_events})>"..
-000033f0: 0a63 6c61 7373 2041 6374 6976 6974 7954  .class ActivityT
-00003400: 7265 6528 4163 7469 7669 7479 4e6f 6465  ree(ActivityNode
-00003410: 293a 0a20 2020 2022 2222 5468 6520 726f  ):.    """The ro
-00003420: 6f74 206e 6f64 6520 696e 2061 2073 796e  ot node in a syn
-00003430: 6320 6163 7469 7669 7479 2074 7265 652e  c activity tree.
-00003440: 2052 6570 7265 7365 6e74 7320 4472 6f70   Represents Drop
-00003450: 626f 7820 726f 6f74 2e22 2222 0a0a 2020  box root."""..  
-00003460: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-00003470: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
-00003480: 2020 2020 2020 7375 7065 7228 292e 5f5f        super().__
-00003490: 696e 6974 5f5f 286e 616d 653d 222f 2229  init__(name="/")
-000034a0: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
-000034b0: 6f63 6b20 3d20 524c 6f63 6b28 290a 0a20  ock = RLock().. 
-000034c0: 2020 2064 6566 2061 6464 2873 656c 662c     def add(self,
-000034d0: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
-000034e0: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-000034f0: 2020 2020 7769 7468 2073 656c 662e 5f6c      with self._l
-00003500: 6f63 6b3a 0a20 2020 2020 2020 2020 2020  ock:.           
-00003510: 2070 6172 7473 203d 2065 7665 6e74 2e64   parts = event.d
-00003520: 6278 5f70 6174 682e 6c73 7472 6970 2822  bx_path.lstrip("
-00003530: 2f22 292e 7370 6c69 7428 222f 2229 0a0a  /").split("/")..
-00003540: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
-00003550: 6d6f 7665 2061 6e79 2066 6169 6c75 7265  move any failure
-00003560: 7320 6174 2074 6869 7320 7061 7468 2e0a  s at this path..
-00003570: 2020 2020 2020 2020 2020 2020 6e6f 6465              node
-00003580: 203d 2073 656c 662e 6765 745f 6e6f 6465   = self.get_node
-00003590: 2865 7665 6e74 2e64 6278 5f70 6174 6829  (event.dbx_path)
-000035a0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-000035b0: 6e6f 6465 3a0a 2020 2020 2020 2020 2020  node:.          
-000035c0: 2020 2020 2020 6661 696c 6564 203d 205b        failed = [
-000035d0: 6520 666f 7220 6520 696e 206e 6f64 652e  e for e in node.
-000035e0: 7379 6e63 5f65 7665 6e74 7320 6966 2065  sync_events if e
-000035f0: 2e73 7461 7475 7320 6973 2053 796e 6353  .status is SyncS
-00003600: 7461 7475 732e 4661 696c 6564 5d0a 2020  tatus.Failed].  
-00003610: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00003620: 7220 6661 696c 2069 6e20 6661 696c 6564  r fail in failed
-00003630: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00003640: 2020 2020 2020 7365 6c66 2e72 656d 6f76        self.remov
-00003650: 6528 6661 696c 290a 0a20 2020 2020 2020  e(fail)..       
-00003660: 2020 2020 2023 2054 7261 7665 7273 6520       # Traverse 
-00003670: 7472 6565 2061 6e64 2063 7265 6174 6520  tree and create 
-00003680: 6368 696c 6472 656e 2061 7320 7265 7175  children as requ
-00003690: 6972 6564 2e0a 2020 2020 2020 2020 2020  ired..          
-000036a0: 2020 2320 496e 7365 7274 2053 796e 6345    # Insert SyncE
-000036b0: 7665 6e74 2066 6f72 2065 6163 6820 7061  vent for each pa
-000036c0: 7265 6e74 2061 7320 7765 206d 6f76 6520  rent as we move 
-000036d0: 646f 776e 2e0a 2020 2020 2020 2020 2020  down..          
-000036e0: 2020 6375 7272 656e 745f 6e6f 6465 3a20    current_node: 
-000036f0: 4163 7469 7669 7479 4e6f 6465 203d 2073  ActivityNode = s
-00003700: 656c 660a 2020 2020 2020 2020 2020 2020  elf.            
-00003710: 6375 7272 656e 745f 6e6f 6465 2e73 796e  current_node.syn
-00003720: 635f 6576 656e 7473 2e61 6464 2865 7665  c_events.add(eve
-00003730: 6e74 290a 0a20 2020 2020 2020 2020 2020  nt)..           
-00003740: 2066 6f72 2070 6172 7420 696e 2070 6172   for part in par
-00003750: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00003760: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00003770: 2020 2020 2020 2020 2020 2020 2063 6869               chi
-00003780: 6c64 5f6e 6f64 6520 3d20 6375 7272 656e  ld_node = curren
-00003790: 745f 6e6f 6465 2e63 6869 6c64 7265 6e5b  t_node.children[
-000037a0: 7061 7274 5d0a 2020 2020 2020 2020 2020  part].          
-000037b0: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
-000037c0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-000037d0: 2020 2020 2020 2020 2020 2063 6869 6c64             child
-000037e0: 5f6e 6f64 6520 3d20 4163 7469 7669 7479  _node = Activity
-000037f0: 4e6f 6465 2870 6172 742c 2070 6172 656e  Node(part, paren
-00003800: 743d 6375 7272 656e 745f 6e6f 6465 290a  t=current_node).
-00003810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003820: 2020 2020 6375 7272 656e 745f 6e6f 6465      current_node
-00003830: 2e63 6869 6c64 7265 6e5b 7061 7274 5d20  .children[part] 
-00003840: 3d20 6368 696c 645f 6e6f 6465 0a20 2020  = child_node.   
-00003850: 2020 2020 2020 2020 2020 2020 2063 6869               chi
-00003860: 6c64 5f6e 6f64 652e 7379 6e63 5f65 7665  ld_node.sync_eve
-00003870: 6e74 732e 6164 6428 6576 656e 7429 0a20  nts.add(event). 
-00003880: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00003890: 7572 7265 6e74 5f6e 6f64 6520 3d20 6368  urrent_node = ch
-000038a0: 696c 645f 6e6f 6465 0a0a 2020 2020 6465  ild_node..    de
-000038b0: 6620 7265 6d6f 7665 2873 656c 662c 2065  f remove(self, e
-000038c0: 7665 6e74 3a20 5379 6e63 4576 656e 7429  vent: SyncEvent)
-000038d0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000038e0: 2020 7769 7468 2073 656c 662e 5f6c 6f63    with self._loc
-000038f0: 6b3a 0a20 2020 2020 2020 2020 2020 206e  k:.            n
-00003900: 6f64 6520 3d20 7365 6c66 2e67 6574 5f6e  ode = self.get_n
-00003910: 6f64 6528 6576 656e 742e 6462 785f 7061  ode(event.dbx_pa
-00003920: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-00003930: 6966 206e 6f74 206e 6f64 653a 0a20 2020  if not node:.   
-00003940: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-00003950: 7365 204b 6579 4572 726f 7228 6622 4e6f  se KeyError(f"No
-00003960: 206e 6f64 6520 6174 2070 6174 6820 7b65   node at path {e
-00003970: 7665 6e74 2e64 6278 5f70 6174 687d 2229  vent.dbx_path}")
-00003980: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00003990: 6576 656e 7420 6e6f 7420 696e 206e 6f64  event not in nod
-000039a0: 652e 7379 6e63 5f65 7665 6e74 733a 0a20  e.sync_events:. 
-000039b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-000039c0: 6169 7365 204b 6579 4572 726f 7228 6622  aise KeyError(f"
-000039d0: 5379 6e63 4576 656e 7420 6e6f 7420 666f  SyncEvent not fo
-000039e0: 756e 6420 6174 2070 6174 6820 7b65 7665  und at path {eve
-000039f0: 6e74 2e64 6278 5f70 6174 687d 2229 0a0a  nt.dbx_path}")..
-00003a00: 2020 2020 2020 2020 2020 2020 2320 5761              # Wa
-00003a10: 6c6b 2074 7265 6520 7570 7761 7264 732e  lk tree upwards.
-00003a20: 2052 656d 6f76 6520 6e6f 6465 7320 6966   Remove nodes if
-00003a30: 206e 6f20 5379 6e63 4576 656e 7473 2072   no SyncEvents r
-00003a40: 656d 6169 6e2e 0a20 2020 2020 2020 2020  emain..         
-00003a50: 2020 206e 6f64 652e 7379 6e63 5f65 7665     node.sync_eve
-00003a60: 6e74 732e 7265 6d6f 7665 2865 7665 6e74  nts.remove(event
-00003a70: 290a 2020 2020 2020 2020 2020 2020 7061  ).            pa
-00003a80: 7265 6e74 203d 206e 6f64 652e 7061 7265  rent = node.pare
-00003a90: 6e74 0a0a 2020 2020 2020 2020 2020 2020  nt..            
-00003aa0: 7768 696c 6520 7061 7265 6e74 3a0a 2020  while parent:.  
-00003ab0: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00003ac0: 5265 6d6f 7665 2065 7665 6e74 2066 726f  Remove event fro
-00003ad0: 6d20 7061 7265 6e74 2e0a 2020 2020 2020  m parent..      
-00003ae0: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
-00003af0: 2e73 796e 635f 6576 656e 7473 2e72 656d  .sync_events.rem
-00003b00: 6f76 6528 6576 656e 7429 0a20 2020 2020  ove(event).     
-00003b10: 2020 2020 2020 2020 2020 2023 2052 656d             # Rem
-00003b20: 6f76 6520 6e6f 6465 2066 726f 6d20 7472  ove node from tr
-00003b30: 6565 2069 6620 6974 2069 7320 656d 7074  ee if it is empt
-00003b40: 792e 0a20 2020 2020 2020 2020 2020 2020  y..             
-00003b50: 2020 2069 6620 6c65 6e28 6e6f 6465 2e73     if len(node.s
-00003b60: 796e 635f 6576 656e 7473 2920 3d3d 2030  ync_events) == 0
-00003b70: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00003b80: 2020 2020 2020 7061 7265 6e74 2e63 6869        parent.chi
-00003b90: 6c64 7265 6e2e 706f 7028 6e6f 6465 2e6e  ldren.pop(node.n
-00003ba0: 616d 6529 0a20 2020 2020 2020 2020 2020  ame).           
-00003bb0: 2020 2020 2023 204d 6f76 6520 7570 2e0a       # Move up..
-00003bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003bd0: 6e6f 6465 203d 2070 6172 656e 740a 2020  node = parent.  
-00003be0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
-00003bf0: 7265 6e74 203d 206e 6f64 652e 7061 7265  rent = node.pare
-00003c00: 6e74 0a0a 2020 2020 6465 6620 6469 7363  nt..    def disc
-00003c10: 6172 6428 7365 6c66 2c20 6576 656e 743a  ard(self, event:
-00003c20: 2053 796e 6345 7665 6e74 2920 2d3e 204e   SyncEvent) -> N
-00003c30: 6f6e 653a 0a20 2020 2020 2020 2074 7279  one:.        try
-00003c40: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00003c50: 6c66 2e72 656d 6f76 6528 6576 656e 7429  lf.remove(event)
-00003c60: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-00003c70: 4b65 7945 7272 6f72 3a0a 2020 2020 2020  KeyError:.      
-00003c80: 2020 2020 2020 7061 7373 0a0a 2020 2020        pass..    
-00003c90: 6465 6620 6861 735f 7061 7468 2873 656c  def has_path(sel
-00003ca0: 662c 2064 6278 5f70 6174 683a 2073 7472  f, dbx_path: str
-00003cb0: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-00003cc0: 2020 2072 6574 7572 6e20 7365 6c66 2e67     return self.g
-00003cd0: 6574 5f6e 6f64 6528 6462 785f 7061 7468  et_node(dbx_path
-00003ce0: 2920 6973 206e 6f74 204e 6f6e 650a 0a20  ) is not None.. 
-00003cf0: 2020 2064 6566 2067 6574 5f6e 6f64 6528     def get_node(
-00003d00: 7365 6c66 2c20 6462 785f 7061 7468 3a20  self, dbx_path: 
-00003d10: 7374 7229 202d 3e20 4163 7469 7669 7479  str) -> Activity
-00003d20: 4e6f 6465 207c 204e 6f6e 653a 0a20 2020  Node | None:.   
-00003d30: 2020 2020 2069 6620 6462 785f 7061 7468       if dbx_path
-00003d40: 203d 3d20 222f 223a 0a20 2020 2020 2020   == "/":.       
-00003d50: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00003d60: 0a0a 2020 2020 2020 2020 7769 7468 2073  ..        with s
-00003d70: 656c 662e 5f6c 6f63 6b3a 0a20 2020 2020  elf._lock:.     
-00003d80: 2020 2020 2020 2070 6172 7473 203d 2064         parts = d
-00003d90: 6278 5f70 6174 682e 6c73 7472 6970 2822  bx_path.lstrip("
-00003da0: 2f22 292e 7370 6c69 7428 222f 2229 0a20  /").split("/"). 
-00003db0: 2020 2020 2020 2020 2020 206e 6f64 653a             node:
-00003dc0: 2041 6374 6976 6974 794e 6f64 6520 3d20   ActivityNode = 
-00003dd0: 7365 6c66 0a20 2020 2020 2020 2020 2020  self.           
-00003de0: 2066 6f72 2070 6172 7420 696e 2070 6172   for part in par
-00003df0: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-00003e00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00003e10: 2020 2020 2020 2020 2020 2020 206e 6f64               nod
-00003e20: 6520 3d20 6e6f 6465 2e63 6869 6c64 7265  e = node.childre
-00003e30: 6e5b 7061 7274 5d0a 2020 2020 2020 2020  n[part].        
-00003e40: 2020 2020 2020 2020 6578 6365 7074 204b          except K
-00003e50: 6579 4572 726f 723a 0a20 2020 2020 2020  eyError:.       
-00003e60: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-00003e70: 7572 6e20 4e6f 6e65 0a0a 2020 2020 2020  urn None..      
-00003e80: 2020 2020 2020 7265 7475 726e 206e 6f64        return nod
-00003e90: 650a 0a0a 636c 6173 7320 5379 6e63 456e  e...class SyncEn
-00003ea0: 6769 6e65 3a0a 2020 2020 2222 2243 6c61  gine:.    """Cla
-00003eb0: 7373 2074 6861 7420 6861 6e64 6c65 7320  ss that handles 
-00003ec0: 7379 6e63 696e 6720 7769 7468 2044 726f  syncing with Dro
-00003ed0: 7062 6f78 0a0a 2020 2020 5072 6f76 6964  pbox..    Provid
-00003ee0: 6573 206d 6574 686f 6473 2074 6f20 7761  es methods to wa
-00003ef0: 6974 2066 6f72 206c 6f63 616c 206f 7220  it for local or 
-00003f00: 7265 6d6f 7465 2063 6861 6e67 6573 2061  remote changes a
-00003f10: 6e64 2073 796e 6320 7468 656d 2c20 696e  nd sync them, in
-00003f20: 636c 7564 696e 670a 2020 2020 636f 6e66  cluding.    conf
-00003f30: 6c69 6374 2072 6573 6f6c 7574 696f 6e20  lict resolution 
-00003f40: 616e 6420 7570 6461 7465 7320 746f 206f  and updates to o
-00003f50: 7572 2069 6e64 6578 2e0a 0a20 2020 203a  ur index...    :
-00003f60: 7061 7261 6d20 636c 6965 6e74 3a20 4472  param client: Dr
-00003f70: 6f70 626f 7820 4150 4920 636c 6965 6e74  opbox API client
-00003f80: 2069 6e73 7461 6e63 652e 0a20 2020 203a   instance..    :
-00003f90: 7061 7261 6d20 6465 736b 746f 705f 6e6f  param desktop_no
-00003fa0: 7469 6669 6572 3a20 4465 736b 746f 7020  tifier: Desktop 
-00003fb0: 6e6f 7469 6669 6572 2069 6e73 7461 6e63  notifier instanc
-00003fc0: 6520 746f 2075 7365 2066 6f72 2075 7365  e to use for use
-00003fd0: 7220 6e6f 7469 6669 6361 7469 6f6e 732e  r notifications.
-00003fe0: 0a20 2020 2022 2222 0a0a 2020 2020 5f6d  .    """..    _m
-00003ff0: 6178 5f68 6973 746f 7279 203d 2031 3030  ax_history = 100
-00004000: 300a 0a20 2020 2064 6566 205f 5f69 6e69  0..    def __ini
-00004010: 745f 5f28 0a20 2020 2020 2020 2073 656c  t__(.        sel
-00004020: 662c 0a20 2020 2020 2020 2063 6c69 656e  f,.        clien
-00004030: 743a 2044 726f 7062 6f78 436c 6965 6e74  t: DropboxClient
-00004040: 2c0a 2020 2020 2020 2020 6465 736b 746f  ,.        deskto
-00004050: 705f 6e6f 7469 6669 6572 3a20 6e6f 7469  p_notifier: noti
-00004060: 6679 2e4d 6165 7374 7261 6c44 6573 6b74  fy.MaestralDeskt
-00004070: 6f70 4e6f 7469 6669 6572 207c 204e 6f6e  opNotifier | Non
-00004080: 6520 3d20 4e6f 6e65 2c0a 2020 2020 2920  e = None,.    ) 
-00004090: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-000040a0: 2073 656c 662e 636c 6965 6e74 203d 2063   self.client = c
-000040b0: 6c69 656e 740a 2020 2020 2020 2020 7365  lient.        se
-000040c0: 6c66 2e63 6f6e 6669 675f 6e61 6d65 203d  lf.config_name =
-000040d0: 2073 656c 662e 636c 6965 6e74 2e63 6f6e   self.client.con
-000040e0: 6669 675f 6e61 6d65 0a20 2020 2020 2020  fig_name.       
-000040f0: 2073 656c 662e 6673 5f65 7665 6e74 7320   self.fs_events 
-00004100: 3d20 4653 4576 656e 7448 616e 646c 6572  = FSEventHandler
-00004110: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
-00004120: 5f6c 6f67 6765 7220 3d20 7363 6f70 6564  _logger = scoped
-00004130: 5f6c 6f67 6765 7228 5f5f 6e61 6d65 5f5f  _logger(__name__
-00004140: 2c20 7365 6c66 2e63 6f6e 6669 675f 6e61  , self.config_na
-00004150: 6d65 290a 0a20 2020 2020 2020 2073 656c  me)..        sel
-00004160: 662e 5f63 6f6e 6620 3d20 4d61 6573 7472  f._conf = Maestr
-00004170: 616c 436f 6e66 6967 2873 656c 662e 636f  alConfig(self.co
-00004180: 6e66 6967 5f6e 616d 6529 0a20 2020 2020  nfig_name).     
-00004190: 2020 2073 656c 662e 5f73 7461 7465 203d     self._state =
-000041a0: 204d 6165 7374 7261 6c53 7461 7465 2873   MaestralState(s
-000041b0: 656c 662e 636f 6e66 6967 5f6e 616d 6529  elf.config_name)
-000041c0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
-000041d0: 6c6f 6164 5f63 6163 6865 645f 636f 6e66  load_cached_conf
-000041e0: 6967 2829 0a0a 2020 2020 2020 2020 7365  ig()..        se
-000041f0: 6c66 2e64 6573 6b74 6f70 5f6e 6f74 6966  lf.desktop_notif
-00004200: 6965 7220 3d20 6465 736b 746f 705f 6e6f  ier = desktop_no
-00004210: 7469 6669 6572 0a0a 2020 2020 2020 2020  tifier..        
-00004220: 2320 5379 6e63 6872 6f6e 697a 6174 696f  # Synchronizatio
-00004230: 6e0a 2020 2020 2020 2020 7365 6c66 2e73  n.        self.s
-00004240: 796e 635f 6c6f 636b 203d 2052 4c6f 636b  ync_lock = RLock
-00004250: 2829 2020 2320 5570 6c6f 6164 2061 6e64  ()  # Upload and
-00004260: 2064 6f77 6e6c 6f61 6420 6379 636c 6573   download cycles
-00004270: 2e0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-00004280: 6462 5f6c 6f63 6b20 3d20 524c 6f63 6b28  db_lock = RLock(
-00004290: 2920 2023 2044 4220 6163 6365 7373 2e0a  )  # DB access..
-000042a0: 2020 2020 2020 2020 7365 6c66 2e5f 7472          self._tr
-000042b0: 6565 5f74 7261 7665 7273 616c 203d 2052  ee_traversal = R
-000042c0: 4c6f 636b 2829 2020 2320 5379 6e63 2061  Lock()  # Sync a
-000042d0: 6374 6976 6974 7920 6163 726f 7373 206d  ctivity across m
-000042e0: 756c 7469 706c 6520 6c65 7665 6c73 2e0a  ultiple levels..
-000042f0: 2020 2020 2020 2020 6d61 785f 7061 7261          max_para
-00004300: 6c6c 656c 5f64 6f77 6e6c 6f61 6473 203d  llel_downloads =
-00004310: 2073 656c 662e 5f63 6f6e 662e 6765 7428   self._conf.get(
-00004320: 2261 7070 222c 2022 6d61 785f 7061 7261  "app", "max_para
-00004330: 6c6c 656c 5f75 706c 6f61 6473 2229 0a20  llel_uploads"). 
-00004340: 2020 2020 2020 2073 656c 662e 5f70 6172         self._par
-00004350: 616c 6c65 6c5f 646f 776e 5f73 656d 6170  allel_down_semap
-00004360: 686f 7265 203d 2074 6872 6561 6469 6e67  hore = threading
-00004370: 2e53 656d 6170 686f 7265 286d 6178 5f70  .Semaphore(max_p
-00004380: 6172 616c 6c65 6c5f 646f 776e 6c6f 6164  arallel_download
-00004390: 7329 0a20 2020 2020 2020 206d 6178 5f70  s).        max_p
-000043a0: 6172 616c 6c65 6c5f 7570 6c6f 6164 7320  arallel_uploads 
-000043b0: 3d20 7365 6c66 2e5f 636f 6e66 2e67 6574  = self._conf.get
-000043c0: 2822 6170 7022 2c20 226d 6178 5f70 6172  ("app", "max_par
-000043d0: 616c 6c65 6c5f 7570 6c6f 6164 7322 290a  allel_uploads").
-000043e0: 2020 2020 2020 2020 7365 6c66 2e5f 7061          self._pa
-000043f0: 7261 6c6c 656c 5f75 705f 7365 6d61 7068  rallel_up_semaph
-00004400: 6f72 6520 3d20 7468 7265 6164 696e 672e  ore = threading.
-00004410: 5365 6d61 7068 6f72 6528 6d61 785f 7061  Semaphore(max_pa
-00004420: 7261 6c6c 656c 5f75 706c 6f61 6473 290a  rallel_uploads).
-00004430: 0a20 2020 2020 2020 2023 2044 6174 6120  .        # Data 
-00004440: 7374 7275 6374 7572 6573 2066 6f72 2069  structures for i
-00004450: 6e74 6572 6e61 6c20 636f 6d6d 756e 6963  nternal communic
-00004460: 6174 696f 6e2e 0a20 2020 2020 2020 2073  ation..        s
-00004470: 656c 662e 5f63 616e 6365 6c5f 7265 7175  elf._cancel_requ
-00004480: 6573 7465 6420 3d20 4576 656e 7428 290a  ested = Event().
-00004490: 0a20 2020 2020 2020 2023 2044 6174 6120  .        # Data 
-000044a0: 7374 7275 6374 7572 6573 2066 6f72 2075  structures for u
-000044b0: 7365 7220 696e 666f 726d 6174 696f 6e2e  ser information.
-000044c0: 0a20 2020 2020 2020 2073 656c 662e 6163  .        self.ac
-000044d0: 7469 7669 7479 203d 2041 6374 6976 6974  tivity = Activit
-000044e0: 7954 7265 6528 290a 0a20 2020 2020 2020  yTree()..       
-000044f0: 2023 2049 6e69 7469 616c 697a 6520 5351   # Initialize SQ
-00004500: 4c69 7465 2064 6174 6162 6173 652e 0a20  Lite database.. 
-00004510: 2020 2020 2020 2073 656c 662e 5f64 625f         self._db_
-00004520: 7061 7468 203d 2067 6574 5f64 6174 615f  path = get_data_
-00004530: 7061 7468 2822 6d61 6573 7472 616c 222c  path("maestral",
-00004540: 2066 227b 7365 6c66 2e63 6f6e 6669 675f   f"{self.config_
-00004550: 6e61 6d65 7d2e 6462 2229 0a0a 2020 2020  name}.db")..    
-00004560: 2020 2020 6966 206e 6f74 2065 7869 7374      if not exist
-00004570: 7328 7365 6c66 2e5f 6462 5f70 6174 6829  s(self._db_path)
-00004580: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-00004590: 5265 7365 7420 7468 6520 7379 6e63 2073  Reset the sync s
-000045a0: 7461 7465 2069 6620 4442 2069 7320 6d69  tate if DB is mi
-000045b0: 7373 696e 672e 0a20 2020 2020 2020 2020  ssing..         
-000045c0: 2020 2073 656c 662e 7265 6d6f 7465 5f63     self.remote_c
-000045d0: 7572 736f 7220 3d20 2222 0a20 2020 2020  ursor = "".     
-000045e0: 2020 2020 2020 2073 656c 662e 6c6f 6361         self.loca
-000045f0: 6c5f 6375 7273 6f72 203d 2030 2e30 0a0a  l_cursor = 0.0..
-00004600: 2020 2020 2020 2020 7365 6c66 2e5f 636f          self._co
-00004610: 6e6e 6563 7469 6f6e 203d 2073 716c 6974  nnection = sqlit
-00004620: 6533 2e63 6f6e 6e65 6374 2873 656c 662e  e3.connect(self.
-00004630: 5f64 625f 7061 7468 2c20 6368 6563 6b5f  _db_path, check_
-00004640: 7361 6d65 5f74 6872 6561 643d 4661 6c73  same_thread=Fals
-00004650: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00004660: 5f64 6220 3d20 4461 7461 6261 7365 2873  _db = Database(s
-00004670: 656c 662e 5f63 6f6e 6e65 6374 696f 6e29  elf._connection)
-00004680: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
-00004690: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-000046a0: 5f63 7265 6174 655f 6f72 5f6c 6f61 645f  _create_or_load_
-000046b0: 6462 2829 0a20 2020 2020 2020 2065 7863  db().        exc
-000046c0: 6570 7420 4461 7461 6261 7365 4572 726f  ept DatabaseErro
-000046d0: 723a 0a20 2020 2020 2020 2020 2020 2023  r:.            #
-000046e0: 2052 6561 6469 6e67 2074 6162 6c65 7320   Reading tables 
-000046f0: 6d61 7920 6661 696c 2069 6620 7468 6520  may fail if the 
-00004700: 4442 2077 6173 2063 6f72 7275 7074 6564  DB was corrupted
-00004710: 2e20 5468 6973 2073 686f 756c 6420 6861  . This should ha
-00004720: 7070 656e 2076 6572 790a 2020 2020 2020  ppen very.      
-00004730: 2020 2020 2020 2320 7261 7265 6c79 2c20        # rarely, 
-00004740: 7365 6520 6874 7470 733a 2f2f 7371 6c69  see https://sqli
-00004750: 7465 2e6f 7267 2f68 6f77 746f 636f 7272  te.org/howtocorr
-00004760: 7570 742e 6874 6d6c 2e20 4174 7465 6d70  upt.html. Attemp
-00004770: 7420 746f 2072 6563 6f76 6572 2062 790a  t to recover by.
-00004780: 2020 2020 2020 2020 2020 2020 2320 6465              # de
-00004790: 6c65 7469 6e67 2044 4220 616e 6420 7265  leting DB and re
-000047a0: 7365 7474 696e 6720 7379 6e63 2073 7461  setting sync sta
-000047b0: 7465 2074 6f20 7472 6967 6765 7220 7265  te to trigger re
-000047c0: 696e 6465 7869 6e67 2e0a 0a20 2020 2020  indexing...     
-000047d0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-000047e0: 6765 722e 7761 726e 696e 6728 2244 6174  ger.warning("Dat
-000047f0: 6162 6173 6520 6572 726f 722c 2072 6573  abase error, res
-00004800: 6574 7469 6e67 2073 796e 6320 7374 6174  etting sync stat
-00004810: 6522 290a 0a20 2020 2020 2020 2020 2020  e")..           
-00004820: 2073 656c 662e 7265 7365 745f 7379 6e63   self.reset_sync
-00004830: 5f73 7461 7465 2829 0a20 2020 2020 2020  _state().       
-00004840: 2020 2020 2064 656c 6574 6528 7365 6c66       delete(self
-00004850: 2e5f 6462 5f70 6174 6829 0a0a 2020 2020  ._db_path)..    
-00004860: 2020 2020 2020 2020 7365 6c66 2e5f 6372          self._cr
-00004870: 6561 7465 5f6f 725f 6c6f 6164 5f64 6228  eate_or_load_db(
-00004880: 290a 0a20 2020 2020 2020 2023 2043 6163  )..        # Cac
-00004890: 6865 732e 0a20 2020 2020 2020 2073 656c  hes..        sel
-000048a0: 662e 5f63 6173 655f 636f 6e76 6572 7369  f._case_conversi
-000048b0: 6f6e 5f63 6163 6865 203d 204c 5255 4361  on_cache = LRUCa
-000048c0: 6368 6528 6361 7061 6369 7479 3d35 3030  che(capacity=500
-000048d0: 3029 0a20 2020 2020 2020 2073 656c 662e  0).        self.
-000048e0: 636c 6561 6e5f 6361 6368 655f 6469 7228  clean_cache_dir(
-000048f0: 7261 6973 655f 6572 726f 723d 4661 6c73  raise_error=Fals
-00004900: 6529 0a0a 2020 2020 6465 6620 5f63 7265  e)..    def _cre
-00004910: 6174 655f 6f72 5f6c 6f61 645f 6462 2873  ate_or_load_db(s
-00004920: 656c 6629 202d 3e20 4e6f 6e65 3a0a 2020  elf) -> None:.  
-00004930: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00004940: 5f64 6174 6162 6173 655f 6163 6365 7373  _database_access
-00004950: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00004960: 7365 6c66 2e5f 696e 6465 785f 7461 626c  self._index_tabl
-00004970: 6520 3d20 4d61 6e61 6765 7228 7365 6c66  e = Manager(self
-00004980: 2e5f 6462 2c20 496e 6465 7845 6e74 7279  ._db, IndexEntry
-00004990: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-000049a0: 6c66 2e5f 6869 7374 6f72 795f 7461 626c  lf._history_tabl
-000049b0: 6520 3d20 4d61 6e61 6765 7228 7365 6c66  e = Manager(self
-000049c0: 2e5f 6462 2c20 5379 6e63 4576 656e 7429  ._db, SyncEvent)
-000049d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000049e0: 662e 5f68 6173 685f 7461 626c 6520 3d20  f._hash_table = 
-000049f0: 4d61 6e61 6765 7228 7365 6c66 2e5f 6462  Manager(self._db
-00004a00: 2c20 4861 7368 4361 6368 6545 6e74 7279  , HashCacheEntry
-00004a10: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
-00004a20: 6c66 2e5f 7379 6e63 5f65 7272 6f72 735f  lf._sync_errors_
-00004a30: 7461 626c 6520 3d20 4d61 6e61 6765 7228  table = Manager(
-00004a40: 7365 6c66 2e5f 6462 2c20 5379 6e63 4572  self._db, SyncEr
-00004a50: 726f 7245 6e74 7279 290a 0a20 2020 2064  rorEntry)..    d
-00004a60: 6566 2072 656c 6f61 645f 6361 6368 6564  ef reload_cached
-00004a70: 5f63 6f6e 6669 6728 7365 6c66 2920 2d3e  _config(self) ->
-00004a80: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00004a90: 2222 0a20 2020 2020 2020 2052 656c 6f61  "".        Reloa
-00004aa0: 6473 2061 6c6c 2063 6f6e 6669 6720 616e  ds all config an
-00004ab0: 6420 7374 6174 6520 7661 6c75 6573 2074  d state values t
-00004ac0: 6861 7420 6172 6520 6f74 6865 7277 6973  hat are otherwis
-00004ad0: 6520 6361 6368 6564 2062 7920 7468 6973  e cached by this
-00004ae0: 2063 6c61 7373 2066 6f72 0a20 2020 2020   class for.     
-00004af0: 2020 2066 6173 7465 7220 6163 6365 7373     faster access
-00004b00: 2e20 4361 6c6c 2074 6869 7320 6d65 7468  . Call this meth
-00004b10: 6f64 2069 6620 636f 6e66 6967 206f 7220  od if config or 
-00004b20: 7374 6174 6520 7661 6c75 6573 2077 6865  state values whe
-00004b30: 7265 206d 6f64 6966 6965 640a 2020 2020  re modified.    
-00004b40: 2020 2020 6469 7265 6374 6c79 2069 6e73      directly ins
-00004b50: 7465 6164 206f 6620 7573 696e 6720 3a63  tead of using :c
-00004b60: 6c61 7373 3a60 5379 6e63 456e 6769 6e65  lass:`SyncEngine
-00004b70: 6020 4150 4973 2e0a 2020 2020 2020 2020  ` APIs..        
-00004b80: 2222 220a 2020 2020 2020 2020 7365 6c66  """.        self
-00004b90: 2e5f 6472 6f70 626f 785f 7061 7468 3a20  ._dropbox_path: 
-00004ba0: 7374 7220 3d20 7365 6c66 2e5f 636f 6e66  str = self._conf
-00004bb0: 2e67 6574 2822 7379 6e63 222c 2022 7061  .get("sync", "pa
-00004bc0: 7468 2229 0a20 2020 2020 2020 2073 656c  th").        sel
-00004bd0: 662e 5f6d 6967 6e6f 7265 5f70 6174 683a  f._mignore_path:
-00004be0: 2073 7472 203d 206f 7370 2e6a 6f69 6e28   str = osp.join(
-00004bf0: 7365 6c66 2e5f 6472 6f70 626f 785f 7061  self._dropbox_pa
-00004c00: 7468 2c20 4d49 474e 4f52 455f 4649 4c45  th, MIGNORE_FILE
-00004c10: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
-00004c20: 6669 6c65 5f63 6163 6865 5f70 6174 683a  file_cache_path:
-00004c30: 2073 7472 203d 206f 7370 2e6a 6f69 6e28   str = osp.join(
-00004c40: 7365 6c66 2e5f 6472 6f70 626f 785f 7061  self._dropbox_pa
-00004c50: 7468 2c20 4649 4c45 5f43 4143 4845 290a  th, FILE_CACHE).
-00004c60: 0a20 2020 2020 2020 2073 656c 662e 5f65  .        self._e
-00004c70: 7863 6c75 6465 645f 6974 656d 733a 206c  xcluded_items: l
-00004c80: 6973 745b 7374 725d 203d 2073 656c 662e  ist[str] = self.
-00004c90: 5f63 6f6e 662e 6765 7428 2273 796e 6322  _conf.get("sync"
-00004ca0: 2c20 2265 7863 6c75 6465 645f 6974 656d  , "excluded_item
-00004cb0: 7322 290a 2020 2020 2020 2020 7365 6c66  s").        self
-00004cc0: 2e5f 6d61 785f 6370 755f 7065 7263 656e  ._max_cpu_percen
-00004cd0: 743a 2066 6c6f 6174 203d 2028 0a20 2020  t: float = (.   
-00004ce0: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
-00004cf0: 6f6e 662e 6765 7428 2273 796e 6322 2c20  onf.get("sync", 
-00004d00: 226d 6178 5f63 7075 5f70 6572 6365 6e74  "max_cpu_percent
-00004d10: 2229 202a 2043 5055 5f43 4f52 455f 434f  ") * CPU_CORE_CO
-00004d20: 554e 540a 2020 2020 2020 2020 290a 2020  UNT.        ).  
-00004d30: 2020 2020 2020 7365 6c66 2e5f 6c6f 6361        self._loca
-00004d40: 6c5f 6375 7273 6f72 3a20 666c 6f61 7420  l_cursor: float 
-00004d50: 3d20 7365 6c66 2e5f 7374 6174 652e 6765  = self._state.ge
-00004d60: 7428 2273 796e 6322 2c20 226c 6173 7473  t("sync", "lasts
-00004d70: 796e 6322 290a 0a20 2020 2020 2020 2073  ync")..        s
-00004d80: 656c 662e 5f69 735f 6673 5f63 6173 655f  elf._is_fs_case_
-00004d90: 7365 6e73 6974 6976 6520 3d20 7365 6c66  sensitive = self
-00004da0: 2e5f 6368 6563 6b5f 6673 5f63 6173 655f  ._check_fs_case_
-00004db0: 7365 6e73 6974 6976 6528 290a 0a20 2020  sensitive()..   
-00004dc0: 2020 2020 2073 656c 662e 6c6f 6164 5f6d       self.load_m
-00004dd0: 6967 6e6f 7265 5f66 696c 6528 290a 0a20  ignore_file().. 
-00004de0: 2020 2064 6566 205f 6368 6563 6b5f 6673     def _check_fs
-00004df0: 5f63 6173 655f 7365 6e73 6974 6976 6528  _case_sensitive(
-00004e00: 7365 6c66 2920 2d3e 2062 6f6f 6c3a 0a20  self) -> bool:. 
-00004e10: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00004e20: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-00004e30: 735f 6673 5f63 6173 655f 7365 6e73 6974  s_fs_case_sensit
-00004e40: 6976 6528 7365 6c66 2e5f 6472 6f70 626f  ive(self._dropbo
-00004e50: 785f 7061 7468 290a 2020 2020 2020 2020  x_path).        
-00004e60: 6578 6365 7074 2028 4669 6c65 4e6f 7446  except (FileNotF
-00004e70: 6f75 6e64 4572 726f 722c 204e 6f74 4144  oundError, NotAD
-00004e80: 6972 6563 746f 7279 4572 726f 7229 3a0a  irectoryError):.
-00004e90: 2020 2020 2020 2020 2020 2020 2320 4661              # Fa
-00004ea0: 6c6c 2062 6163 6b20 746f 2074 6865 2061  ll back to the a
-00004eb0: 7373 756d 7074 696f 6e20 6f66 2061 2063  ssumption of a c
-00004ec0: 6173 652d 7365 6e73 6974 6976 6520 6669  ase-sensitive fi
-00004ed0: 6c65 2073 7973 7465 6d2e 0a20 2020 2020  le system..     
-00004ee0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-00004ef0: 7565 0a0a 2020 2020 2320 3d3d 3d3d 2043  ue..    # ==== C
-00004f00: 6f6e 6669 6720 6163 6365 7373 203d 3d3d  onfig access ===
-00004f10: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004f20: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004f30: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00004f40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2020  ============..  
-00004f50: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
-00004f60: 6465 6620 6472 6f70 626f 785f 7061 7468  def dropbox_path
-00004f70: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
-00004f80: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00004f90: 2020 2050 6174 6820 746f 206c 6f63 616c     Path to local
-00004fa0: 2044 726f 7062 6f78 2066 6f6c 6465 722c   Dropbox folder,
-00004fb0: 2061 7320 6c6f 6164 6564 2066 726f 6d20   as loaded from 
-00004fc0: 7468 6520 636f 6e66 6967 2066 696c 652e  the config file.
-00004fd0: 2042 6566 6f72 6520 6368 616e 6769 6e67   Before changing
-00004fe0: 0a20 2020 2020 2020 203a 6174 7472 3a60  .        :attr:`
-00004ff0: 6472 6f70 626f 785f 7061 7468 602c 206d  dropbox_path`, m
-00005000: 616b 6520 7375 7265 2074 6861 7420 7379  ake sure that sy
-00005010: 6e63 696e 6720 6973 2070 6175 7365 642e  ncing is paused.
-00005020: 204d 6f76 6520 7468 6520 6472 6f70 626f   Move the dropbo
-00005030: 7820 666f 6c64 6572 0a20 2020 2020 2020  x folder.       
-00005040: 2074 6f20 7468 6520 6e65 7720 6c6f 6361   to the new loca
-00005050: 7469 6f6e 2062 6566 6f72 6520 7265 7375  tion before resu
-00005060: 6d69 6e67 2074 6865 2073 796e 632e 2043  ming the sync. C
-00005070: 6861 6e67 6573 2061 7265 2073 6176 6564  hanges are saved
-00005080: 2074 6f20 7468 6520 636f 6e66 6967 0a20   to the config. 
-00005090: 2020 2020 2020 2066 696c 652e 0a20 2020         file..   
-000050a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000050b0: 2072 6574 7572 6e20 7365 6c66 2e5f 6472   return self._dr
-000050c0: 6f70 626f 785f 7061 7468 0a0a 2020 2020  opbox_path..    
-000050d0: 4064 726f 7062 6f78 5f70 6174 682e 7365  @dropbox_path.se
-000050e0: 7474 6572 0a20 2020 2064 6566 2064 726f  tter.    def dro
-000050f0: 7062 6f78 5f70 6174 6828 7365 6c66 2c20  pbox_path(self, 
-00005100: 7061 7468 3a20 7374 7229 202d 3e20 4e6f  path: str) -> No
-00005110: 6e65 3a0a 2020 2020 2020 2020 2222 2253  ne:.        """S
-00005120: 6574 7465 723a 2064 726f 7062 6f78 5f70  etter: dropbox_p
-00005130: 6174 6822 2222 0a0a 2020 2020 2020 2020  ath"""..        
-00005140: 7061 7468 203d 206f 7370 2e72 6561 6c70  path = osp.realp
-00005150: 6174 6828 7061 7468 290a 0a20 2020 2020  ath(path)..     
-00005160: 2020 2077 6974 6820 7365 6c66 2e73 796e     with self.syn
-00005170: 635f 6c6f 636b 3a0a 2020 2020 2020 2020  c_lock:.        
-00005180: 2020 2020 7365 6c66 2e5f 6472 6f70 626f      self._dropbo
-00005190: 785f 7061 7468 203d 2070 6174 680a 2020  x_path = path.  
-000051a0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000051b0: 6d69 676e 6f72 655f 7061 7468 203d 206f  mignore_path = o
-000051c0: 7370 2e6a 6f69 6e28 7365 6c66 2e5f 6472  sp.join(self._dr
-000051d0: 6f70 626f 785f 7061 7468 2c20 4d49 474e  opbox_path, MIGN
-000051e0: 4f52 455f 4649 4c45 290a 2020 2020 2020  ORE_FILE).      
-000051f0: 2020 2020 2020 7365 6c66 2e5f 6669 6c65        self._file
-00005200: 5f63 6163 6865 5f70 6174 6820 3d20 6f73  _cache_path = os
-00005210: 702e 6a6f 696e 2873 656c 662e 5f64 726f  p.join(self._dro
-00005220: 7062 6f78 5f70 6174 682c 2046 494c 455f  pbox_path, FILE_
-00005230: 4341 4348 4529 0a20 2020 2020 2020 2020  CACHE).         
-00005240: 2020 2073 656c 662e 5f63 6f6e 662e 7365     self._conf.se
-00005250: 7428 2273 796e 6322 2c20 2270 6174 6822  t("sync", "path"
-00005260: 2c20 7061 7468 290a 0a20 2020 2020 2020  , path)..       
-00005270: 2020 2020 2073 656c 662e 5f69 735f 6673       self._is_fs
-00005280: 5f63 6173 655f 7365 6e73 6974 6976 6520  _case_sensitive 
-00005290: 3d20 7365 6c66 2e5f 6368 6563 6b5f 6673  = self._check_fs
-000052a0: 5f63 6173 655f 7365 6e73 6974 6976 6528  _case_sensitive(
-000052b0: 290a 0a20 2020 2040 7072 6f70 6572 7479  )..    @property
-000052c0: 0a20 2020 2064 6566 2069 735f 6673 5f63  .    def is_fs_c
-000052d0: 6173 655f 7365 6e73 6974 6976 6528 7365  ase_sensitive(se
-000052e0: 6c66 2920 2d3e 2062 6f6f 6c3a 0a20 2020  lf) -> bool:.   
-000052f0: 2020 2020 2022 2222 5768 6574 6865 7220       """Whether 
-00005300: 7468 6520 6c6f 6361 6c20 4472 6f70 626f  the local Dropbo
-00005310: 7820 6469 7265 6374 6f72 7920 6c69 6573  x directory lies
-00005320: 206f 6e20 6120 6361 7365 2d73 656e 7369   on a case-sensi
-00005330: 7469 7665 2066 696c 6520 7379 7374 656d  tive file system
-00005340: 2e22 2222 0a20 2020 2020 2020 2072 6574  .""".        ret
-00005350: 7572 6e20 7365 6c66 2e5f 6973 5f66 735f  urn self._is_fs_
-00005360: 6361 7365 5f73 656e 7369 7469 7665 0a0a  case_sensitive..
-00005370: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-00005380: 2020 6465 6620 6461 7461 6261 7365 5f70    def database_p
-00005390: 6174 6828 7365 6c66 2920 2d3e 2073 7472  ath(self) -> str
-000053a0: 3a0a 2020 2020 2020 2020 2222 2250 6174  :.        """Pat
-000053b0: 6820 5351 4c69 7465 2064 6174 6162 6173  h SQLite databas
-000053c0: 652e 2222 220a 2020 2020 2020 2020 7265  e.""".        re
-000053d0: 7475 726e 2073 656c 662e 5f64 625f 7061  turn self._db_pa
-000053e0: 7468 0a0a 2020 2020 4070 726f 7065 7274  th..    @propert
-000053f0: 790a 2020 2020 6465 6620 6669 6c65 5f63  y.    def file_c
-00005400: 6163 6865 5f70 6174 6828 7365 6c66 2920  ache_path(self) 
-00005410: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-00005420: 2222 2250 6174 6820 746f 2063 6163 6865  """Path to cache
-00005430: 2066 6f6c 6465 7220 666f 7220 7465 6d70   folder for temp
-00005440: 6f72 6172 7920 6669 6c65 7320 2872 6561  orary files (rea
-00005450: 6420 6f6e 6c79 292e 2054 6865 2063 6163  d only). The cac
-00005460: 6865 2066 6f6c 6465 720a 2020 2020 2020  he folder.      
-00005470: 2020 272e 6d61 6573 7472 616c 2e63 6163    '.maestral.cac
-00005480: 6865 2720 6973 206c 6f63 6174 6564 2069  he' is located i
-00005490: 6e73 6964 6520 7468 6520 6c6f 6361 6c20  nside the local 
-000054a0: 4472 6f70 626f 7820 666f 6c64 6572 2074  Dropbox folder t
-000054b0: 6f20 7072 6576 656e 7420 6669 6c65 0a20  o prevent file. 
-000054c0: 2020 2020 2020 2074 7261 6e73 6665 7220         transfer 
-000054d0: 6265 7477 6565 6e20 6469 6666 6572 656e  between differen
-000054e0: 7420 7061 7274 6974 696f 6e73 206f 7220  t partitions or 
-000054f0: 6472 6976 6573 2064 7572 696e 6720 7379  drives during sy
-00005500: 6e63 2e22 2222 0a20 2020 2020 2020 2072  nc.""".        r
-00005510: 6574 7572 6e20 7365 6c66 2e5f 6669 6c65  eturn self._file
-00005520: 5f63 6163 6865 5f70 6174 680a 0a20 2020  _cache_path..   
-00005530: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00005540: 6566 2065 7863 6c75 6465 645f 6974 656d  ef excluded_item
-00005550: 7328 7365 6c66 2920 2d3e 206c 6973 745b  s(self) -> list[
-00005560: 7374 725d 3a0a 2020 2020 2020 2020 2222  str]:.        ""
-00005570: 224c 6973 7420 6f66 2061 6c6c 2066 696c  "List of all fil
-00005580: 6573 2061 6e64 2066 6f6c 6465 7273 2065  es and folders e
-00005590: 7863 6c75 6465 6420 6672 6f6d 2073 796e  xcluded from syn
-000055a0: 632e 2043 6861 6e67 6573 2061 7265 2073  c. Changes are s
-000055b0: 6176 6564 2074 6f20 7468 650a 2020 2020  aved to the.    
-000055c0: 2020 2020 636f 6e66 6967 2066 696c 652e      config file.
-000055d0: 2049 6620 6120 7061 7265 6e74 2066 6f6c   If a parent fol
-000055e0: 6465 7220 6973 2065 7863 6c75 6465 642c  der is excluded,
-000055f0: 2069 7473 2063 6869 6c64 7265 6e20 7769   its children wi
-00005600: 6c6c 2061 7574 6f6d 6174 6963 616c 6c79  ll automatically
-00005610: 2062 650a 2020 2020 2020 2020 7265 6d6f   be.        remo
-00005620: 7665 6420 6672 6f6d 2074 6865 206c 6973  ved from the lis
-00005630: 742e 2049 6620 6f6e 6c79 2063 6869 6c64  t. If only child
-00005640: 7265 6e20 6172 6520 6769 7665 6e20 6275  ren are given bu
-00005650: 7420 6e6f 7420 7468 6520 7061 7265 6e74  t not the parent
-00005660: 2066 6f6c 6465 722c 2061 6e79 0a20 2020   folder, any.   
-00005670: 2020 2020 206e 6577 2069 7465 6d73 2061       new items a
-00005680: 6464 6564 2074 6f20 7468 6520 7061 7265  dded to the pare
-00005690: 6e74 2077 696c 6c20 6265 2073 796e 6365  nt will be synce
-000056a0: 642e 2043 6861 6e67 6520 7468 6973 2070  d. Change this p
-000056b0: 726f 7065 7274 7920 2a62 6566 6f72 652a  roperty *before*
-000056c0: 0a20 2020 2020 2020 2064 6f77 6e6c 6f61  .        downloa
-000056d0: 6469 6e67 206e 6577 6c79 2069 6e63 6c75  ding newly inclu
-000056e0: 6465 6420 6974 656d 7320 6f72 2064 656c  ded items or del
-000056f0: 6574 696e 6720 6578 636c 7564 6564 2069  eting excluded i
-00005700: 7465 6d73 2e22 2222 0a20 2020 2020 2020  tems.""".       
-00005710: 2072 6574 7572 6e20 7365 6c66 2e5f 6578   return self._ex
-00005720: 636c 7564 6564 5f69 7465 6d73 0a0a 2020  cluded_items..  
-00005730: 2020 4065 7863 6c75 6465 645f 6974 656d    @excluded_item
-00005740: 732e 7365 7474 6572 0a20 2020 2064 6566  s.setter.    def
-00005750: 2065 7863 6c75 6465 645f 6974 656d 7328   excluded_items(
-00005760: 7365 6c66 2c20 666f 6c64 6572 5f6c 6973  self, folder_lis
-00005770: 743a 206c 6973 745b 7374 725d 2920 2d3e  t: list[str]) ->
-00005780: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00005790: 2222 5365 7474 6572 3a20 6578 636c 7564  ""Setter: exclud
-000057a0: 6564 5f69 7465 6d73 2222 220a 2020 2020  ed_items""".    
-000057b0: 2020 2020 7769 7468 2073 656c 662e 7379      with self.sy
-000057c0: 6e63 5f6c 6f63 6b3a 0a20 2020 2020 2020  nc_lock:.       
-000057d0: 2020 2020 2063 6c65 616e 5f6c 6973 7420       clean_list 
-000057e0: 3d20 7365 6c66 2e63 6c65 616e 5f65 7863  = self.clean_exc
-000057f0: 6c75 6465 645f 6974 656d 735f 6c69 7374  luded_items_list
-00005800: 2866 6f6c 6465 725f 6c69 7374 290a 2020  (folder_list).  
-00005810: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00005820: 6578 636c 7564 6564 5f69 7465 6d73 203d  excluded_items =
-00005830: 2063 6c65 616e 5f6c 6973 740a 2020 2020   clean_list.    
-00005840: 2020 2020 2020 2020 7365 6c66 2e5f 636f          self._co
-00005850: 6e66 2e73 6574 2822 7379 6e63 222c 2022  nf.set("sync", "
-00005860: 6578 636c 7564 6564 5f69 7465 6d73 222c  excluded_items",
-00005870: 2063 6c65 616e 5f6c 6973 7429 0a0a 2020   clean_list)..  
-00005880: 2020 4073 7461 7469 636d 6574 686f 640a    @staticmethod.
-00005890: 2020 2020 6465 6620 636c 6561 6e5f 6578      def clean_ex
-000058a0: 636c 7564 6564 5f69 7465 6d73 5f6c 6973  cluded_items_lis
-000058b0: 7428 666f 6c64 6572 5f6c 6973 743a 2043  t(folder_list: C
-000058c0: 6f6c 6c65 6374 696f 6e5b 7374 725d 2920  ollection[str]) 
-000058d0: 2d3e 206c 6973 745b 7374 725d 3a0a 2020  -> list[str]:.  
-000058e0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000058f0: 2020 5265 6d6f 7665 7320 616c 6c20 6475    Removes all du
-00005900: 706c 6963 6174 6573 2061 6e64 2063 6869  plicates and chi
-00005910: 6c64 7265 6e20 6f66 2065 7863 6c75 6465  ldren of exclude
-00005920: 6420 6974 656d 7320 6672 6f6d 2074 6865  d items from the
-00005930: 2065 7863 6c75 6465 6420 6974 656d 730a   excluded items.
-00005940: 2020 2020 2020 2020 6c69 7374 2e20 4e6f          list. No
-00005950: 726d 616c 6973 6573 2061 6c6c 2070 6174  rmalises all pat
-00005960: 6873 2074 6f20 6c6f 7765 7220 6361 7365  hs to lower case
-00005970: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-00005980: 6d20 666f 6c64 6572 5f6c 6973 743a 2044  m folder_list: D
-00005990: 726f 7062 6f78 2070 6174 6873 2074 6f20  ropbox paths to 
-000059a0: 6578 636c 7564 652e 0a20 2020 2020 2020  exclude..       
-000059b0: 203a 7265 7475 726e 733a 2043 6c65 616e   :returns: Clean
-000059c0: 6564 2075 7020 6974 656d 732e 0a20 2020  ed up items..   
-000059d0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-000059e0: 2023 2052 656d 6f76 6520 6475 706c 6963   # Remove duplic
-000059f0: 6174 6520 656e 7472 6965 7320 6279 2063  ate entries by c
-00005a00: 7265 6174 696e 6720 7365 742c 2073 7472  reating set, str
-00005a10: 6970 2074 7261 696c 696e 6720 272f 272e  ip trailing '/'.
-00005a20: 0a20 2020 2020 2020 2066 6f6c 6465 725f  .        folder_
-00005a30: 7365 7420 3d20 7b6e 6f72 6d61 6c69 7a65  set = {normalize
-00005a40: 2866 292e 7273 7472 6970 2822 2f22 2920  (f).rstrip("/") 
-00005a50: 666f 7220 6620 696e 2066 6f6c 6465 725f  for f in folder_
-00005a60: 6c69 7374 7d0a 0a20 2020 2020 2020 2023  list}..        #
-00005a70: 2052 656d 6f76 6520 616c 6c20 6368 696c   Remove all chil
-00005a80: 6472 656e 206f 6620 6578 636c 7564 6564  dren of excluded
-00005a90: 2066 6f6c 6465 7273 2e0a 2020 2020 2020   folders..      
-00005aa0: 2020 636c 6561 6e5f 6c69 7374 203d 206c    clean_list = l
-00005ab0: 6973 7428 666f 6c64 6572 5f73 6574 290a  ist(folder_set).
-00005ac0: 2020 2020 2020 2020 666f 7220 666f 6c64          for fold
-00005ad0: 6572 2069 6e20 666f 6c64 6572 5f73 6574  er in folder_set
-00005ae0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00005af0: 6561 6e5f 6c69 7374 203d 205b 6620 666f  ean_list = [f fo
-00005b00: 7220 6620 696e 2063 6c65 616e 5f6c 6973  r f in clean_lis
-00005b10: 7420 6966 206e 6f74 2069 735f 6368 696c  t if not is_chil
-00005b20: 6428 662c 2066 6f6c 6465 7229 5d0a 0a20  d(f, folder)].. 
-00005b30: 2020 2020 2020 2072 6574 7572 6e20 636c         return cl
-00005b40: 6561 6e5f 6c69 7374 0a0a 2020 2020 4070  ean_list..    @p
-00005b50: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
-00005b60: 6d61 785f 6370 755f 7065 7263 656e 7428  max_cpu_percent(
-00005b70: 7365 6c66 2920 2d3e 2066 6c6f 6174 3a0a  self) -> float:.
-00005b80: 2020 2020 2020 2020 2222 224d 6178 696d          """Maxim
-00005b90: 756d 2043 5055 2075 7361 6765 2066 6f72  um CPU usage for
-00005ba0: 2070 6172 616c 6c65 6c20 646f 776e 6c6f   parallel downlo
-00005bb0: 6164 7320 6f72 2075 706c 6f61 6473 2069  ads or uploads i
-00005bc0: 6e20 7065 7263 656e 7420 6f66 2074 6865  n percent of the
-00005bd0: 2074 6f74 616c 0a20 2020 2020 2020 2061   total.        a
-00005be0: 7661 696c 6162 6c65 2043 5055 2074 696d  vailable CPU tim
-00005bf0: 6520 7065 7220 636f 7265 2e20 496e 6469  e per core. Indi
-00005c00: 7669 6475 616c 2077 6f72 6b65 7273 2069  vidual workers i
-00005c10: 6e20 6120 7468 7265 6164 2070 6f6f 6c20  n a thread pool 
-00005c20: 7769 6c6c 2070 6175 7365 0a20 2020 2020  will pause.     
-00005c30: 2020 2075 6e74 696c 2074 6865 2075 7361     until the usa
-00005c40: 6765 2064 726f 7073 2062 656c 6f77 2074  ge drops below t
-00005c50: 6869 7320 7661 6c75 652e 2054 6173 6b73  his value. Tasks
-00005c60: 2069 6e20 7468 6520 6d61 696e 2074 6872   in the main thr
-00005c70: 6561 6420 7375 6368 2061 730a 2020 2020  ead such as.    
-00005c80: 2020 2020 696e 6465 7869 6e67 2066 696c      indexing fil
-00005c90: 6520 6368 616e 6765 7320 6d61 7920 7374  e changes may st
-00005ca0: 696c 6c20 7573 6520 6d6f 7265 2043 5055  ill use more CPU
-00005cb0: 2074 696d 652e 2053 6574 7469 6e67 2074   time. Setting t
-00005cc0: 6869 7320 746f 2032 3030 2520 6d65 616e  his to 200% mean
-00005cd0: 730a 2020 2020 2020 2020 7468 6174 2074  s.        that t
-00005ce0: 776f 2066 756c 6c20 6c6f 6769 6361 6c20  wo full logical 
-00005cf0: 4350 5520 636f 7265 2063 616e 2062 6520  CPU core can be 
-00005d00: 7573 6564 2e22 2222 0a20 2020 2020 2020  used.""".       
-00005d10: 2072 6574 7572 6e20 7365 6c66 2e5f 6d61   return self._ma
-00005d20: 785f 6370 755f 7065 7263 656e 740a 0a20  x_cpu_percent.. 
-00005d30: 2020 2040 6d61 785f 6370 755f 7065 7263     @max_cpu_perc
-00005d40: 656e 742e 7365 7474 6572 0a20 2020 2064  ent.setter.    d
-00005d50: 6566 206d 6178 5f63 7075 5f70 6572 6365  ef max_cpu_perce
-00005d60: 6e74 2873 656c 662c 2070 6572 6365 6e74  nt(self, percent
-00005d70: 3a20 666c 6f61 7429 202d 3e20 4e6f 6e65  : float) -> None
-00005d80: 3a0a 2020 2020 2020 2020 2222 2253 6574  :.        """Set
-00005d90: 7465 723a 206d 6178 5f63 7075 5f70 6572  ter: max_cpu_per
-00005da0: 6365 6e74 2e22 2222 0a20 2020 2020 2020  cent.""".       
-00005db0: 2073 656c 662e 5f6d 6178 5f63 7075 5f70   self._max_cpu_p
-00005dc0: 6572 6365 6e74 203d 2070 6572 6365 6e74  ercent = percent
-00005dd0: 0a20 2020 2020 2020 2073 656c 662e 5f63  .        self._c
-00005de0: 6f6e 662e 7365 7428 2273 796e 6322 2c20  onf.set("sync", 
-00005df0: 226d 6178 5f63 7075 5f70 6572 6365 6e74  "max_cpu_percent
-00005e00: 222c 2070 6572 6365 6e74 202f 2f20 4350  ", percent // CP
-00005e10: 555f 434f 5245 5f43 4f55 4e54 290a 0a20  U_CORE_COUNT).. 
-00005e20: 2020 2023 203d 3d3d 3d20 5379 6e63 2073     # ==== Sync s
-00005e30: 7461 7465 203d 3d3d 3d3d 3d3d 3d3d 3d3d  tate ===========
-00005e40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005e50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005e60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00005e70: 3d3d 3d3d 3d3d 3d0a 0a20 2020 2040 7072  =======..    @pr
-00005e80: 6f70 6572 7479 0a20 2020 2064 6566 2072  operty.    def r
-00005e90: 656d 6f74 655f 6375 7273 6f72 2873 656c  emote_cursor(sel
-00005ea0: 6629 202d 3e20 7374 723a 0a20 2020 2020  f) -> str:.     
-00005eb0: 2020 2022 2222 4375 7273 6f72 2066 726f     """Cursor fro
-00005ec0: 6d20 6c61 7374 2073 796e 6320 7769 7468  m last sync with
-00005ed0: 2072 656d 6f74 6520 4472 6f70 626f 782e   remote Dropbox.
-00005ee0: 2054 6865 2076 616c 7565 2069 7320 7570   The value is up
-00005ef0: 6461 7465 6420 616e 6420 7361 7665 6420  dated and saved 
-00005f00: 746f 0a20 2020 2020 2020 2074 6865 2063  to.        the c
-00005f10: 6f6e 6669 6720 6669 6c65 206f 6e20 6576  onfig file on ev
-00005f20: 6572 7920 7375 6363 6573 7366 756c 2064  ery successful d
-00005f30: 6f77 6e6c 6f61 6420 6f66 2072 656d 6f74  ownload of remot
-00005f40: 6520 6368 616e 6765 732e 2222 220a 2020  e changes.""".  
-00005f50: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-00005f60: 662e 5f73 7461 7465 2e67 6574 2822 7379  f._state.get("sy
-00005f70: 6e63 222c 2022 6375 7273 6f72 2229 0a0a  nc", "cursor")..
-00005f80: 2020 2020 4072 656d 6f74 655f 6375 7273      @remote_curs
-00005f90: 6f72 2e73 6574 7465 720a 2020 2020 6465  or.setter.    de
-00005fa0: 6620 7265 6d6f 7465 5f63 7572 736f 7228  f remote_cursor(
-00005fb0: 7365 6c66 2c20 6375 7273 6f72 3a20 7374  self, cursor: st
-00005fc0: 7229 202d 3e20 4e6f 6e65 3a0a 2020 2020  r) -> None:.    
-00005fd0: 2020 2020 2222 2253 6574 7465 723a 206c      """Setter: l
-00005fe0: 6173 745f 6375 7273 6f72 2222 220a 2020  ast_cursor""".  
-00005ff0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00006000: 7379 6e63 5f6c 6f63 6b3a 0a20 2020 2020  sync_lock:.     
-00006010: 2020 2020 2020 2073 656c 662e 5f73 7461         self._sta
-00006020: 7465 2e73 6574 2822 7379 6e63 222c 2022  te.set("sync", "
-00006030: 6375 7273 6f72 222c 2063 7572 736f 7229  cursor", cursor)
-00006040: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-00006050: 6c6f 6767 6572 2e64 6562 7567 2822 5265  logger.debug("Re
-00006060: 6d6f 7465 2063 7572 736f 7220 7361 7665  mote cursor save
-00006070: 643a 2025 7322 2c20 6375 7273 6f72 290a  d: %s", cursor).
-00006080: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
-00006090: 2020 2064 6566 206c 6f63 616c 5f63 7572     def local_cur
-000060a0: 736f 7228 7365 6c66 2920 2d3e 2066 6c6f  sor(self) -> flo
-000060b0: 6174 3a0a 2020 2020 2020 2020 2222 2254  at:.        """T
-000060c0: 696d 6520 7374 616d 7020 6672 6f6d 206c  ime stamp from l
-000060d0: 6173 7420 7379 6e63 2077 6974 6820 7265  ast sync with re
-000060e0: 6d6f 7465 2044 726f 7062 6f78 2e20 5468  mote Dropbox. Th
-000060f0: 6520 7661 6c75 6520 6973 2075 7064 6174  e value is updat
-00006100: 6564 2061 6e64 2073 6176 6564 0a20 2020  ed and saved.   
-00006110: 2020 2020 2074 6f20 7468 6520 636f 6e66       to the conf
-00006120: 6967 2066 696c 6520 6f6e 2065 7665 7279  ig file on every
-00006130: 2073 7563 6365 7373 6675 6c20 7570 6c6f   successful uplo
-00006140: 6164 206f 6620 6c6f 6361 6c20 6368 616e  ad of local chan
-00006150: 6765 732e 2222 220a 2020 2020 2020 2020  ges.""".        
-00006160: 7265 7475 726e 2073 656c 662e 5f6c 6f63  return self._loc
-00006170: 616c 5f63 7572 736f 720a 0a20 2020 2040  al_cursor..    @
-00006180: 6c6f 6361 6c5f 6375 7273 6f72 2e73 6574  local_cursor.set
-00006190: 7465 720a 2020 2020 6465 6620 6c6f 6361  ter.    def loca
-000061a0: 6c5f 6375 7273 6f72 2873 656c 662c 206c  l_cursor(self, l
-000061b0: 6173 745f 7379 6e63 3a20 666c 6f61 7429  ast_sync: float)
-000061c0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-000061d0: 2020 2222 2253 6574 7465 723a 206c 6f63    """Setter: loc
-000061e0: 616c 5f63 7572 736f 7222 2222 0a20 2020  al_cursor""".   
-000061f0: 2020 2020 2077 6974 6820 7365 6c66 2e73       with self.s
-00006200: 796e 635f 6c6f 636b 3a0a 2020 2020 2020  ync_lock:.      
-00006210: 2020 2020 2020 7365 6c66 2e5f 6c6f 6361        self._loca
-00006220: 6c5f 6375 7273 6f72 203d 206c 6173 745f  l_cursor = last_
-00006230: 7379 6e63 0a20 2020 2020 2020 2020 2020  sync.           
-00006240: 2073 656c 662e 5f73 7461 7465 2e73 6574   self._state.set
-00006250: 2822 7379 6e63 222c 2022 6c61 7374 7379  ("sync", "lastsy
-00006260: 6e63 222c 206c 6173 745f 7379 6e63 290a  nc", last_sync).
-00006270: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
-00006280: 6f67 6765 722e 6465 6275 6728 224c 6f63  ogger.debug("Loc
-00006290: 616c 2063 7572 736f 7220 7361 7665 643a  al cursor saved:
-000062a0: 2025 7322 2c20 6c61 7374 5f73 796e 6329   %s", last_sync)
-000062b0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
-000062c0: 2020 2020 6465 6620 6c61 7374 5f63 6861      def last_cha
-000062d0: 6e67 6528 7365 6c66 2920 2d3e 2066 6c6f  nge(self) -> flo
-000062e0: 6174 3a0a 2020 2020 2020 2020 2222 2254  at:.        """T
-000062f0: 6865 2074 696d 6520 7374 616d 7020 6f66  he time stamp of
-00006300: 2074 6865 206c 6173 7420 6669 6c65 2063   the last file c
-00006310: 6861 6e67 6520 6f72 2030 2e30 2069 6620  hange or 0.0 if 
-00006320: 7468 6572 6520 6172 6520 6e6f 2066 696c  there are no fil
-00006330: 6520 6368 616e 6765 7320 696e 0a20 2020  e changes in.   
-00006340: 2020 2020 206f 7572 2068 6973 746f 7279       our history
-00006350: 2e22 2222 0a20 2020 2020 2020 2077 6974  .""".        wit
-00006360: 6820 7365 6c66 2e5f 6461 7461 6261 7365  h self._database
-00006370: 5f61 6363 6573 7328 293a 0a20 2020 2020  _access():.     
-00006380: 2020 2020 2020 2072 6f77 203d 2073 656c         row = sel
-00006390: 662e 5f64 622e 6578 6563 7574 6528 2253  f._db.execute("S
-000063a0: 454c 4543 5420 4d41 5828 6c61 7374 5f73  ELECT MAX(last_s
-000063b0: 796e 6329 2046 524f 4d20 2769 6e64 6578  ync) FROM 'index
-000063c0: 2722 292e 6665 7463 686f 6e65 2829 0a20  '").fetchone(). 
-000063d0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-000063e0: 7420 726f 773a 0a20 2020 2020 2020 2020  t row:.         
-000063f0: 2020 2020 2020 2072 6574 7572 6e20 302e         return 0.
-00006400: 300a 2020 2020 2020 2020 2020 2020 7472  0.            tr
-00006410: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00006420: 2020 2072 6574 7572 6e20 726f 775b 305d     return row[0]
-00006430: 206f 7220 302e 300a 2020 2020 2020 2020   or 0.0.        
-00006440: 2020 2020 6578 6365 7074 2049 6e64 6578      except Index
-00006450: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-00006460: 2020 2020 2020 2072 6574 7572 6e20 302e         return 0.
-00006470: 300a 0a20 2020 2040 7072 6f70 6572 7479  0..    @property
-00006480: 0a20 2020 2064 6566 206c 6173 745f 7265  .    def last_re
-00006490: 696e 6465 7828 7365 6c66 2920 2d3e 2066  index(self) -> f
-000064a0: 6c6f 6174 3a0a 2020 2020 2020 2020 2222  loat:.        ""
-000064b0: 2254 696d 6520 7374 616d 7020 6f66 206c  "Time stamp of l
-000064c0: 6173 7420 6675 6c6c 2069 6e64 6578 696e  ast full indexin
-000064d0: 672e 2054 6869 7320 6973 2075 7365 6420  g. This is used 
-000064e0: 746f 2064 6574 6572 6d69 6e65 2077 6865  to determine whe
-000064f0: 6e20 7468 6520 6e65 7874 0a20 2020 2020  n the next.     
-00006500: 2020 2066 756c 6c20 696e 6465 7869 6e67     full indexing
-00006510: 2073 686f 756c 6420 7461 6b65 2070 6c61   should take pla
-00006520: 6365 2e22 2222 0a20 2020 2020 2020 2072  ce.""".        r
-00006530: 6574 7572 6e20 7365 6c66 2e5f 7374 6174  eturn self._stat
-00006540: 652e 6765 7428 2273 796e 6322 2c20 226c  e.get("sync", "l
-00006550: 6173 745f 7265 696e 6465 7822 290a 0a20  ast_reindex").. 
-00006560: 2020 2064 6566 2067 6574 5f68 6973 746f     def get_histo
-00006570: 7279 2873 656c 662c 2064 6278 5f70 6174  ry(self, dbx_pat
-00006580: 683a 2073 7472 207c 204e 6f6e 6520 3d20  h: str | None = 
-00006590: 4e6f 6e65 2920 2d3e 206c 6973 745b 5379  None) -> list[Sy
-000065a0: 6e63 4576 656e 745d 3a0a 2020 2020 2020  ncEvent]:.      
-000065b0: 2020 2222 2241 206c 6973 7420 6f66 2074    """A list of t
-000065c0: 6865 206c 6173 7420 5379 6e63 4576 656e  he last SyncEven
-000065d0: 7473 2069 6e20 6f75 7220 6869 7374 6f72  ts in our histor
-000065e0: 792e 2048 6973 746f 7279 2077 696c 6c20  y. History will 
-000065f0: 6265 206b 6570 7420 666f 7220 7468 650a  be kept for the.
-00006600: 2020 2020 2020 2020 696e 7465 7276 616c          interval
-00006610: 2073 7065 6369 6669 6564 2062 7920 7468   specified by th
-00006620: 6520 636f 6e66 6967 2076 616c 7565 2060  e config value `
-00006630: 606b 6565 705f 6869 7374 6f72 7960 6020  `keep_history`` 
-00006640: 2864 6566 6175 6c74 7320 746f 2074 776f  (defaults to two
-00006650: 2077 6565 6b73 290a 2020 2020 2020 2020   weeks).        
-00006660: 6275 7420 6174 206d 6f73 7420 312c 3030  but at most 1,00
-00006670: 3020 6576 656e 7473 2077 696c 6c20 6265  0 events will be
-00006680: 206b 6570 742e 2222 220a 2020 2020 2020   kept.""".      
-00006690: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
-000066a0: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
-000066b0: 2020 2020 2020 2020 2020 2020 7175 6572              quer
-000066c0: 793a 2051 7565 7279 0a20 2020 2020 2020  y: Query.       
-000066d0: 2020 2020 2069 6620 6462 785f 7061 7468       if dbx_path
-000066e0: 2069 7320 4e6f 6e65 3a0a 2020 2020 2020   is None:.      
-000066f0: 2020 2020 2020 2020 2020 7175 6572 7920            query 
-00006700: 3d20 416c 6c51 7565 7279 2829 0a20 2020  = AllQuery().   
-00006710: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00006720: 2020 2020 2020 2020 2020 2020 2020 2071                 q
-00006730: 7565 7279 203d 204d 6174 6368 5175 6572  uery = MatchQuer
-00006740: 7928 5379 6e63 4576 656e 742e 6462 785f  y(SyncEvent.dbx_
-00006750: 7061 7468 2c20 6462 785f 7061 7468 290a  path, dbx_path).
-00006760: 0a20 2020 2020 2020 2020 2020 206f 7264  .            ord
-00006770: 6572 5f65 7870 7220 3d20 2249 464e 554c  er_expr = "IFNUL
-00006780: 4c28 6368 616e 6765 5f74 696d 652c 2073  L(change_time, s
-00006790: 796e 635f 7469 6d65 2922 0a20 2020 2020  ync_time)".     
-000067a0: 2020 2020 2020 2073 796e 635f 6576 656e         sync_even
-000067b0: 7473 203d 2073 656c 662e 5f68 6973 746f  ts = self._histo
-000067c0: 7279 5f74 6162 6c65 2e73 656c 6563 7428  ry_table.select(
-000067d0: 7175 6572 792e 6f72 6465 725f 6279 286f  query.order_by(o
-000067e0: 7264 6572 5f65 7870 7229 290a 2020 2020  rder_expr)).    
-000067f0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00006800: 796e 635f 6576 656e 7473 0a0a 2020 2020  ync_events..    
-00006810: 6465 6620 7265 7365 745f 7379 6e63 5f73  def reset_sync_s
-00006820: 7461 7465 2873 656c 6629 202d 3e20 4e6f  tate(self) -> No
-00006830: 6e65 3a0a 2020 2020 2020 2020 2222 2252  ne:.        """R
-00006840: 6573 6574 7320 616c 6c20 7361 7665 6420  esets all saved 
-00006850: 7379 6e63 2073 7461 7465 2e20 5365 7474  sync state. Sett
-00006860: 696e 6773 2061 7265 206e 6f74 2061 6666  ings are not aff
-00006870: 6563 7465 642e 2222 220a 2020 2020 2020  ected.""".      
-00006880: 2020 6966 2073 656c 662e 6275 7379 2829    if self.busy()
-00006890: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-000068a0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-000068b0: 2822 4361 6e6e 6f74 2072 6573 6574 2073  ("Cannot reset s
-000068c0: 796e 6320 7374 6174 6520 7768 696c 6520  ync state while 
-000068d0: 7379 6e63 696e 672e 2229 0a0a 2020 2020  syncing.")..    
-000068e0: 2020 2020 7769 7468 2073 656c 662e 5f64      with self._d
-000068f0: 6174 6162 6173 655f 6163 6365 7373 2829  atabase_access()
-00006900: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-00006910: 6c66 2e5f 696e 6465 785f 7461 626c 652e  lf._index_table.
-00006920: 636c 6561 7228 290a 2020 2020 2020 2020  clear().        
-00006930: 2020 2020 7365 6c66 2e5f 6869 7374 6f72      self._histor
-00006940: 795f 7461 626c 652e 636c 6561 7228 290a  y_table.clear().
-00006950: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00006960: 2e5f 7379 6e63 5f65 7272 6f72 735f 7461  ._sync_errors_ta
-00006970: 626c 652e 636c 6561 7228 290a 2020 2020  ble.clear().    
-00006980: 2020 2020 2020 2020 7365 6c66 2e5f 6861          self._ha
-00006990: 7368 5f74 6162 6c65 2e63 6c65 6172 2829  sh_table.clear()
-000069a0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-000069b0: 7374 6174 652e 7265 7365 745f 746f 5f64  state.reset_to_d
-000069c0: 6566 6175 6c74 7328 2273 796e 6322 290a  efaults("sync").
-000069d0: 2020 2020 2020 2020 7365 6c66 2e72 656c          self.rel
-000069e0: 6f61 645f 6361 6368 6564 5f63 6f6e 6669  oad_cached_confi
-000069f0: 6728 290a 0a20 2020 2020 2020 2073 656c  g()..        sel
-00006a00: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
-00006a10: 2253 796e 6320 7374 6174 6520 7265 7365  "Sync state rese
-00006a20: 7422 290a 0a20 2020 2023 203d 3d3d 3d20  t")..    # ==== 
-00006a30: 5379 6e63 2065 7272 6f72 206d 616e 6167  Sync error manag
-00006a40: 656d 656e 7420 3d3d 3d3d 3d3d 3d3d 3d3d  ement ==========
-00006a50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00006a60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00006a70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a20  =============.. 
-00006a80: 2020 2040 7072 6f70 6572 7479 0a20 2020     @property.   
-00006a90: 2064 6566 2073 796e 635f 6572 726f 7273   def sync_errors
-00006aa0: 2873 656c 6629 202d 3e20 6c69 7374 5b53  (self) -> list[S
-00006ab0: 796e 6345 7272 6f72 456e 7472 795d 3a0a  yncErrorEntry]:.
-00006ac0: 2020 2020 2020 2020 2222 2252 6574 7572          """Retur
-00006ad0: 6e73 2061 206c 6973 7420 6f66 2061 6c6c  ns a list of all
-00006ae0: 2073 796e 6320 6572 726f 7273 2e22 2222   sync errors."""
-00006af0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00006b00: 6c66 2e5f 6461 7461 6261 7365 5f61 6363  lf._database_acc
-00006b10: 6573 7328 293a 0a20 2020 2020 2020 2020  ess():.         
-00006b20: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-00006b30: 7379 6e63 5f65 7272 6f72 735f 7461 626c  sync_errors_tabl
-00006b40: 652e 7365 6c65 6374 2841 6c6c 5175 6572  e.select(AllQuer
-00006b50: 7928 2929 0a0a 2020 2020 4070 726f 7065  y())..    @prope
-00006b60: 7274 790a 2020 2020 6465 6620 7570 6c6f  rty.    def uplo
-00006b70: 6164 5f65 7272 6f72 7328 7365 6c66 2920  ad_errors(self) 
-00006b80: 2d3e 206c 6973 745b 5379 6e63 4572 726f  -> list[SyncErro
-00006b90: 7245 6e74 7279 5d3a 0a20 2020 2020 2020  rEntry]:.       
-00006ba0: 2022 2222 5265 7475 726e 7320 6120 6c69   """Returns a li
-00006bb0: 7374 206f 6620 616c 6c20 7570 6c6f 6164  st of all upload
-00006bc0: 2065 7272 6f72 732e 2222 220a 2020 2020   errors.""".    
-00006bd0: 2020 2020 7769 7468 2073 656c 662e 5f64      with self._d
-00006be0: 6174 6162 6173 655f 6163 6365 7373 2829  atabase_access()
-00006bf0: 3a0a 2020 2020 2020 2020 2020 2020 7175  :.            qu
-00006c00: 6572 7920 3d20 4d61 7463 6851 7565 7279  ery = MatchQuery
-00006c10: 2853 796e 6345 7272 6f72 456e 7472 792e  (SyncErrorEntry.
-00006c20: 6469 7265 6374 696f 6e2c 2053 796e 6344  direction, SyncD
-00006c30: 6972 6563 7469 6f6e 2e55 7029 0a20 2020  irection.Up).   
-00006c40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00006c50: 7365 6c66 2e5f 7379 6e63 5f65 7272 6f72  self._sync_error
-00006c60: 735f 7461 626c 652e 7365 6c65 6374 2871  s_table.select(q
-00006c70: 7565 7279 290a 0a20 2020 2040 7072 6f70  uery)..    @prop
-00006c80: 6572 7479 0a20 2020 2064 6566 2064 6f77  erty.    def dow
-00006c90: 6e6c 6f61 645f 6572 726f 7273 2873 656c  nload_errors(sel
-00006ca0: 6629 202d 3e20 6c69 7374 5b53 796e 6345  f) -> list[SyncE
-00006cb0: 7272 6f72 456e 7472 795d 3a0a 2020 2020  rrorEntry]:.    
-00006cc0: 2020 2020 2222 2252 6574 7572 6e73 2061      """Returns a
-00006cd0: 206c 6973 7420 6f66 2061 6c6c 2064 6f77   list of all dow
-00006ce0: 6e6c 6f61 6420 6572 726f 7273 2e22 2222  nload errors."""
-00006cf0: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00006d00: 6c66 2e5f 6461 7461 6261 7365 5f61 6363  lf._database_acc
-00006d10: 6573 7328 293a 0a20 2020 2020 2020 2020  ess():.         
-00006d20: 2020 2071 7565 7279 203d 204d 6174 6368     query = Match
-00006d30: 5175 6572 7928 5379 6e63 4572 726f 7245  Query(SyncErrorE
-00006d40: 6e74 7279 2e64 6972 6563 7469 6f6e 2c20  ntry.direction, 
-00006d50: 5379 6e63 4469 7265 6374 696f 6e2e 446f  SyncDirection.Do
-00006d60: 776e 290a 2020 2020 2020 2020 2020 2020  wn).            
-00006d70: 7265 7475 726e 2073 656c 662e 5f73 796e  return self._syn
-00006d80: 635f 6572 726f 7273 5f74 6162 6c65 2e73  c_errors_table.s
-00006d90: 656c 6563 7428 7175 6572 7929 0a0a 2020  elect(query)..  
-00006da0: 2020 6465 6620 6861 735f 7379 6e63 5f65    def has_sync_e
-00006db0: 7272 6f72 7328 7365 6c66 2920 2d3e 2062  rrors(self) -> b
-00006dc0: 6f6f 6c3a 0a20 2020 2020 2020 2022 2222  ool:.        """
-00006dd0: 5265 7475 726e 7320 6060 5472 7565 6060  Returns ``True``
-00006de0: 2069 6e20 6361 7365 206f 6620 7379 6e63   in case of sync
-00006df0: 2065 7272 6f72 732c 2060 6046 616c 7365   errors, ``False
-00006e00: 6060 206f 7468 6572 7769 7365 2e22 2222  `` otherwise."""
-00006e10: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00006e20: 6c66 2e5f 6461 7461 6261 7365 5f61 6363  lf._database_acc
-00006e30: 6573 7328 293a 0a20 2020 2020 2020 2020  ess():.         
-00006e40: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
-00006e50: 7379 6e63 5f65 7272 6f72 735f 7461 626c  sync_errors_tabl
-00006e60: 652e 636f 756e 7428 2920 3e20 300a 0a20  e.count() > 0.. 
-00006e70: 2020 2064 6566 2073 796e 635f 6572 726f     def sync_erro
-00006e80: 7273 5f66 6f72 5f70 6174 6828 0a20 2020  rs_for_path(.   
-00006e90: 2020 2020 2073 656c 662c 2064 6278 5f70       self, dbx_p
-00006ea0: 6174 685f 6c6f 7765 723a 2073 7472 2c20  ath_lower: str, 
-00006eb0: 6469 7265 6374 696f 6e3a 2053 796e 6344  direction: SyncD
-00006ec0: 6972 6563 7469 6f6e 207c 204e 6f6e 6520  irection | None 
-00006ed0: 3d20 4e6f 6e65 0a20 2020 2029 202d 3e20  = None.    ) -> 
-00006ee0: 6c69 7374 5b53 796e 6345 7272 6f72 456e  list[SyncErrorEn
-00006ef0: 7472 795d 3a0a 2020 2020 2020 2020 2222  try]:.        ""
-00006f00: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
-00006f10: 7320 6120 6c69 7374 206f 6620 616c 6c20  s a list of all 
-00006f20: 7379 6e63 2065 7272 6f72 7320 666f 7220  sync errors for 
-00006f30: 7468 6520 6769 7665 6e20 7061 7468 2061  the given path a
-00006f40: 6e64 2069 7473 2063 6869 6c64 7265 6e2e  nd its children.
-00006f50: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00006f60: 2064 6278 5f70 6174 685f 6c6f 7765 723a   dbx_path_lower:
-00006f70: 204e 6f72 6d61 6c69 7365 6420 4472 6f70   Normalised Drop
-00006f80: 626f 7820 7061 7468 2e0a 2020 2020 2020  box path..      
-00006f90: 2020 3a70 6172 616d 2064 6972 6563 7469    :param directi
-00006fa0: 6f6e 3a20 4469 7265 6374 696f 6e20 746f  on: Direction to
-00006fb0: 2066 696c 7465 7220 7379 6e63 2065 7272   filter sync err
-00006fc0: 6f72 732e 2049 6620 6e6f 7420 6769 7665  ors. If not give
-00006fd0: 6e2c 2062 6f74 6820 7570 6c6f 6164 0a20  n, both upload. 
-00006fe0: 2020 2020 2020 2020 2020 2061 6e64 2064             and d
-00006ff0: 6f77 6e6c 6f61 6420 6572 726f 7273 2077  ownload errors w
-00007000: 696c 6c20 6265 2072 6574 7572 6e65 642e  ill be returned.
-00007010: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-00007020: 733a 204c 6973 7420 6f66 2073 796e 6320  s: List of sync 
-00007030: 6572 726f 7273 2e0a 2020 2020 2020 2020  errors..        
-00007040: 2222 220a 2020 2020 2020 2020 7769 7468  """.        with
-00007050: 2073 656c 662e 5f64 6174 6162 6173 655f   self._database_
-00007060: 6163 6365 7373 2829 3a0a 2020 2020 2020  access():.      
-00007070: 2020 2020 2020 7061 7468 5f74 7265 655f        path_tree_
-00007080: 7175 6572 7920 3d20 5061 7468 5472 6565  query = PathTree
-00007090: 5175 6572 7928 0a20 2020 2020 2020 2020  Query(.         
-000070a0: 2020 2020 2020 2053 796e 6345 7272 6f72         SyncError
-000070b0: 456e 7472 792e 6462 785f 7061 7468 5f6c  Entry.dbx_path_l
-000070c0: 6f77 6572 2c20 6462 785f 7061 7468 5f6c  ower, dbx_path_l
-000070d0: 6f77 6572 0a20 2020 2020 2020 2020 2020  ower.           
-000070e0: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-000070f0: 6966 2064 6972 6563 7469 6f6e 3a0a 2020  if direction:.  
-00007100: 2020 2020 2020 2020 2020 2020 2020 6469                di
-00007110: 7265 6374 696f 6e5f 7175 6572 7920 3d20  rection_query = 
-00007120: 4d61 7463 6851 7565 7279 2853 796e 6345  MatchQuery(SyncE
-00007130: 7272 6f72 456e 7472 792e 6469 7265 6374  rrorEntry.direct
-00007140: 696f 6e2c 2064 6972 6563 7469 6f6e 290a  ion, direction).
-00007150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007160: 6a6f 696e 745f 7175 6572 7920 3d20 416e  joint_query = An
-00007170: 6451 7565 7279 2870 6174 685f 7472 6565  dQuery(path_tree
-00007180: 5f71 7565 7279 2c20 6469 7265 6374 696f  _query, directio
-00007190: 6e5f 7175 6572 7929 0a20 2020 2020 2020  n_query).       
-000071a0: 2020 2020 2020 2020 2065 7272 6f72 7320           errors 
-000071b0: 3d20 7365 6c66 2e5f 7379 6e63 5f65 7272  = self._sync_err
-000071c0: 6f72 735f 7461 626c 652e 7365 6c65 6374  ors_table.select
-000071d0: 286a 6f69 6e74 5f71 7565 7279 290a 2020  (joint_query).  
-000071e0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000071f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007200: 6572 726f 7273 203d 2073 656c 662e 5f73  errors = self._s
-00007210: 796e 635f 6572 726f 7273 5f74 6162 6c65  ync_errors_table
-00007220: 2e73 656c 6563 7428 7061 7468 5f74 7265  .select(path_tre
-00007230: 655f 7175 6572 7929 0a0a 2020 2020 2020  e_query)..      
-00007240: 2020 2020 2020 7265 7475 726e 2065 7272        return err
-00007250: 6f72 730a 0a20 2020 2064 6566 2063 6c65  ors..    def cle
-00007260: 6172 5f73 796e 635f 6572 726f 7273 5f66  ar_sync_errors_f
-00007270: 6f72 5f70 6174 6828 0a20 2020 2020 2020  or_path(.       
-00007280: 2073 656c 662c 2064 6278 5f70 6174 685f   self, dbx_path_
-00007290: 6c6f 7765 723a 2073 7472 2c20 7265 6375  lower: str, recu
-000072a0: 7273 6976 653a 2062 6f6f 6c20 3d20 4661  rsive: bool = Fa
-000072b0: 6c73 650a 2020 2020 2920 2d3e 204e 6f6e  lse.    ) -> Non
-000072c0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
-000072d0: 2020 2020 2020 2043 6c65 6172 2061 6c6c         Clear all
-000072e0: 2073 796e 6320 6572 726f 7273 2066 6f72   sync errors for
-000072f0: 2061 2070 6174 6820 6166 7465 7220 6120   a path after a 
-00007300: 7375 6363 6573 7366 756c 2073 796e 6320  successful sync 
-00007310: 6576 656e 742e 0a0a 2020 2020 2020 2020  event...        
-00007320: 3a70 6172 616d 2064 6278 5f70 6174 685f  :param dbx_path_
-00007330: 6c6f 7765 723a 204e 6f72 6d61 6c69 7365  lower: Normalise
-00007340: 6420 4472 6f70 626f 7820 7061 7468 2074  d Dropbox path t
-00007350: 6f20 636c 6561 722e 0a20 2020 2020 2020  o clear..       
-00007360: 203a 7061 7261 6d20 7265 6375 7273 6976   :param recursiv
-00007370: 653a 2057 6865 7468 6572 2074 6f20 636c  e: Whether to cl
-00007380: 6561 7220 7379 6e63 2065 7272 6f72 7320  ear sync errors 
-00007390: 666f 7220 6368 696c 6472 656e 206f 6620  for children of 
-000073a0: 7468 6520 6769 7665 6e20 7061 7468 2e0a  the given path..
-000073b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000073c0: 2020 2020 7769 7468 2073 656c 662e 5f64      with self._d
-000073d0: 6174 6162 6173 655f 6163 6365 7373 2829  atabase_access()
-000073e0: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-000073f0: 6c66 2e5f 7379 6e63 5f65 7272 6f72 735f  lf._sync_errors_
-00007400: 7461 626c 652e 6465 6c65 7465 5f70 7269  table.delete_pri
-00007410: 6d61 7279 5f6b 6579 2864 6278 5f70 6174  mary_key(dbx_pat
-00007420: 685f 6c6f 7765 7229 0a0a 2020 2020 2020  h_lower)..      
-00007430: 2020 2020 2020 6966 2072 6563 7572 7369        if recursi
-00007440: 7665 3a0a 2020 2020 2020 2020 2020 2020  ve:.            
-00007450: 2020 2020 7175 6572 7920 3d20 5061 7468      query = Path
-00007460: 5472 6565 5175 6572 7928 5379 6e63 4572  TreeQuery(SyncEr
-00007470: 726f 7245 6e74 7279 2e64 6278 5f70 6174  rorEntry.dbx_pat
-00007480: 685f 6c6f 7765 722c 2064 6278 5f70 6174  h_lower, dbx_pat
-00007490: 685f 6c6f 7765 7229 0a20 2020 2020 2020  h_lower).       
-000074a0: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
-000074b0: 796e 635f 6572 726f 7273 5f74 6162 6c65  ync_errors_table
-000074c0: 2e64 656c 6574 6528 7175 6572 7929 0a0a  .delete(query)..
-000074d0: 2020 2020 6465 6620 636c 6561 725f 7379      def clear_sy
-000074e0: 6e63 5f65 7272 6f72 735f 6672 6f6d 5f65  nc_errors_from_e
-000074f0: 7665 6e74 2873 656c 662c 2065 7665 6e74  vent(self, event
-00007500: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
-00007510: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-00007520: 2243 6c65 6172 7320 7379 6e63 2065 7272  "Clears sync err
-00007530: 6f72 7320 636f 7272 6573 706f 6e64 696e  ors correspondin
-00007540: 6720 746f 2061 2073 796e 6320 6576 656e  g to a sync even
-00007550: 742e 2222 220a 2020 2020 2020 2020 7265  t.""".        re
-00007560: 6375 7273 6976 6520 3d20 6576 656e 742e  cursive = event.
-00007570: 6973 5f6d 6f76 6564 206f 7220 6576 656e  is_moved or even
-00007580: 742e 6973 5f64 656c 6574 6564 206f 7220  t.is_deleted or 
-00007590: 6576 656e 742e 6973 5f66 696c 650a 0a20  event.is_file.. 
-000075a0: 2020 2020 2020 2073 656c 662e 636c 6561         self.clea
-000075b0: 725f 7379 6e63 5f65 7272 6f72 735f 666f  r_sync_errors_fo
-000075c0: 725f 7061 7468 2865 7665 6e74 2e64 6278  r_path(event.dbx
-000075d0: 5f70 6174 685f 6c6f 7765 722c 2072 6563  _path_lower, rec
-000075e0: 7572 7369 7665 290a 2020 2020 2020 2020  ursive).        
-000075f0: 6966 2065 7665 6e74 2e64 6278 5f70 6174  if event.dbx_pat
-00007600: 685f 6672 6f6d 5f6c 6f77 6572 2069 7320  h_from_lower is 
-00007610: 6e6f 7420 4e6f 6e65 3a0a 2020 2020 2020  not None:.      
-00007620: 2020 2020 2020 7365 6c66 2e63 6c65 6172        self.clear
-00007630: 5f73 796e 635f 6572 726f 7273 5f66 6f72  _sync_errors_for
-00007640: 5f70 6174 6828 6576 656e 742e 6462 785f  _path(event.dbx_
-00007650: 7061 7468 5f66 726f 6d5f 6c6f 7765 722c  path_from_lower,
-00007660: 2072 6563 7572 7369 7665 290a 0a20 2020   recursive)..   
-00007670: 2023 203d 3d3d 3d20 496e 6465 7820 6163   # ==== Index ac
-00007680: 6365 7373 2061 6e64 206d 616e 6167 656d  cess and managem
-00007690: 656e 7420 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ent ============
-000076a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000076b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000076c0: 3d3d 3d3d 3d0a 0a20 2020 2064 6566 2067  =====..    def g
-000076d0: 6574 5f69 6e64 6578 2873 656c 6629 202d  et_index(self) -
-000076e0: 3e20 6c69 7374 5b49 6e64 6578 456e 7472  > list[IndexEntr
-000076f0: 795d 3a0a 2020 2020 2020 2020 2222 220a  y]:.        """.
-00007700: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
-00007710: 6120 636f 7079 206f 6620 7468 6520 6c6f  a copy of the lo
-00007720: 6361 6c20 696e 6465 7820 6f66 2073 796e  cal index of syn
-00007730: 6365 6420 6669 6c65 7320 616e 6420 666f  ced files and fo
-00007740: 6c64 6572 732e 0a0a 2020 2020 2020 2020  lders...        
-00007750: 3a72 6574 7572 6e73 3a20 4c69 7374 206f  :returns: List o
-00007760: 6620 696e 6465 7820 656e 7472 6965 732e  f index entries.
-00007770: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00007780: 2020 2020 2077 6974 6820 7365 6c66 2e5f       with self._
-00007790: 6461 7461 6261 7365 5f61 6363 6573 7328  database_access(
-000077a0: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000077b0: 6574 7572 6e20 7365 6c66 2e5f 696e 6465  eturn self._inde
-000077c0: 785f 7461 626c 652e 7365 6c65 6374 2841  x_table.select(A
-000077d0: 6c6c 5175 6572 7928 2929 0a0a 2020 2020  llQuery())..    
-000077e0: 6465 6620 6765 745f 696e 6465 785f 656e  def get_index_en
-000077f0: 7472 7928 7365 6c66 2c20 6462 785f 7061  try(self, dbx_pa
-00007800: 7468 5f6c 6f77 6572 3a20 7374 7229 202d  th_lower: str) -
-00007810: 3e20 496e 6465 7845 6e74 7279 207c 204e  > IndexEntry | N
-00007820: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
-00007830: 0a20 2020 2020 2020 2047 6574 7320 7468  .        Gets th
-00007840: 6520 696e 6465 7820 656e 7472 7920 666f  e index entry fo
-00007850: 7220 7468 6520 6769 7665 6e20 4472 6f70  r the given Drop
-00007860: 626f 7820 7061 7468 2e0a 0a20 2020 2020  box path...     
-00007870: 2020 203a 7061 7261 6d20 6462 785f 7061     :param dbx_pa
-00007880: 7468 5f6c 6f77 6572 3a20 4e6f 726d 616c  th_lower: Normal
-00007890: 697a 6564 206c 6f77 6572 2063 6173 6520  ized lower case 
-000078a0: 4472 6f70 626f 7820 7061 7468 2e0a 2020  Dropbox path..  
-000078b0: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-000078c0: 496e 6465 7820 656e 7472 7920 6f72 2060  Index entry or `
-000078d0: 604e 6f6e 6560 6020 6966 206e 6f20 656e  `None`` if no en
-000078e0: 7472 7920 6578 6973 7473 2066 6f72 2074  try exists for t
-000078f0: 6865 2067 6976 656e 2070 6174 682e 0a20  he given path.. 
-00007900: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00007910: 2020 2077 6974 6820 7365 6c66 2e5f 6461     with self._da
-00007920: 7461 6261 7365 5f61 6363 6573 7328 293a  tabase_access():
-00007930: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00007940: 7572 6e20 7365 6c66 2e5f 696e 6465 785f  urn self._index_
-00007950: 7461 626c 652e 6765 7428 6462 785f 7061  table.get(dbx_pa
-00007960: 7468 5f6c 6f77 6572 290a 0a20 2020 2064  th_lower)..    d
-00007970: 6566 2067 6574 5f69 6e64 6578 5f65 6e74  ef get_index_ent
-00007980: 7279 5f66 6f72 5f6c 6f63 616c 5f70 6174  ry_for_local_pat
-00007990: 6828 7365 6c66 2c20 6c6f 6361 6c5f 7061  h(self, local_pa
-000079a0: 7468 3a20 7374 7229 202d 3e20 496e 6465  th: str) -> Inde
-000079b0: 7845 6e74 7279 207c 204e 6f6e 653a 0a20  xEntry | None:. 
-000079c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000079d0: 2020 2047 6574 7320 7468 6520 696e 6465     Gets the inde
-000079e0: 7820 656e 7472 7920 666f 7220 7468 6520  x entry for the 
-000079f0: 6769 7665 6e20 6c6f 6361 6c20 7061 7468  given local path
-00007a00: 2e20 456e 7375 7265 7320 7468 6174 2074  . Ensures that t
-00007a10: 6865 2069 6e64 6578 2065 6e74 7279 2068  he index entry h
-00007a20: 6173 0a20 2020 2020 2020 2074 6865 2063  as.        the c
-00007a30: 6f72 7265 6374 2063 6173 696e 672e 0a0a  orrect casing...
-00007a40: 2020 2020 2020 2020 3a70 6172 616d 206c          :param l
-00007a50: 6f63 616c 5f70 6174 683a 204c 6f63 616c  ocal_path: Local
-00007a60: 2070 6174 6820 6173 2072 6574 7572 6e65   path as returne
-00007a70: 6420 6279 2066 696c 6520 7379 7374 656d  d by file system
-00007a80: 2041 5049 732e 0a20 2020 2020 2020 203a   APIs..        :
-00007a90: 7265 7475 726e 733a 2049 6e64 6578 2065  returns: Index e
-00007aa0: 6e74 7279 206f 7220 6060 4e6f 6e65 6060  ntry or ``None``
-00007ab0: 2069 6620 6e6f 2065 6e74 7279 2065 7869   if no entry exi
-00007ac0: 7374 7320 666f 7220 7468 6520 6769 7665  sts for the give
-00007ad0: 6e20 7061 7468 2e0a 2020 2020 2020 2020  n path..        
-00007ae0: 2222 220a 2020 2020 2020 2020 6462 785f  """.        dbx_
-00007af0: 7061 7468 5f63 6173 6564 203d 2073 656c  path_cased = sel
-00007b00: 662e 746f 5f64 6278 5f70 6174 6828 6c6f  f.to_dbx_path(lo
-00007b10: 6361 6c5f 7061 7468 290a 2020 2020 2020  cal_path).      
-00007b20: 2020 6462 785f 7061 7468 5f6c 6f77 6572    dbx_path_lower
-00007b30: 203d 2073 656c 662e 746f 5f64 6278 5f70   = self.to_dbx_p
-00007b40: 6174 685f 6c6f 7765 7228 6c6f 6361 6c5f  ath_lower(local_
-00007b50: 7061 7468 290a 0a20 2020 2020 2020 2069  path)..        i
-00007b60: 6e64 6578 5f65 6e74 7279 203d 2073 656c  ndex_entry = sel
-00007b70: 662e 6765 745f 696e 6465 785f 656e 7472  f.get_index_entr
-00007b80: 7928 6462 785f 7061 7468 5f6c 6f77 6572  y(dbx_path_lower
-00007b90: 290a 0a20 2020 2020 2020 2069 6620 6e6f  )..        if no
-00007ba0: 7420 696e 6465 785f 656e 7472 793a 0a20  t index_entry:. 
-00007bb0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00007bc0: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
-00007bd0: 6966 2069 6e64 6578 5f65 6e74 7279 2e64  if index_entry.d
-00007be0: 6278 5f70 6174 685f 6361 7365 6420 3d3d  bx_path_cased ==
-00007bf0: 2064 6278 5f70 6174 685f 6361 7365 643a   dbx_path_cased:
-00007c00: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00007c10: 7572 6e20 696e 6465 785f 656e 7472 790a  urn index_entry.
-00007c20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00007c30: 4e6f 6e65 0a0a 2020 2020 6465 6620 6974  None..    def it
-00007c40: 6572 5f69 6e64 6578 2873 656c 6629 202d  er_index(self) -
-00007c50: 3e20 4974 6572 6174 6f72 5b49 6e64 6578  > Iterator[Index
-00007c60: 456e 7472 795d 3a0a 2020 2020 2020 2020  Entry]:.        
-00007c70: 2222 220a 2020 2020 2020 2020 5265 7475  """.        Retu
-00007c80: 726e 7320 616e 2069 7465 7261 746f 7220  rns an iterator 
-00007c90: 6f76 6572 2074 6865 206c 6f63 616c 2069  over the local i
-00007ca0: 6e64 6578 206f 6620 7379 6e63 6564 2066  ndex of synced f
-00007cb0: 696c 6573 2061 6e64 2066 6f6c 6465 7273  iles and folders
-00007cc0: 2e0a 0a20 2020 2020 2020 203a 7265 7475  ...        :retu
-00007cd0: 726e 733a 2049 7465 7261 746f 7220 6f76  rns: Iterator ov
-00007ce0: 6572 2069 6e64 6578 2065 6e74 7269 6573  er index entries
-00007cf0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00007d00: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00007d10: 5f64 6174 6162 6173 655f 6163 6365 7373  _database_access
-00007d20: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00007d30: 666f 7220 656e 7472 6965 7320 696e 2073  for entries in s
-00007d40: 656c 662e 5f69 6e64 6578 5f74 6162 6c65  elf._index_table
-00007d50: 2e73 656c 6563 745f 6974 6572 2841 6c6c  .select_iter(All
-00007d60: 5175 6572 7928 2929 3a0a 2020 2020 2020  Query()):.      
-00007d70: 2020 2020 2020 2020 2020 7969 656c 6420            yield 
-00007d80: 6672 6f6d 2065 6e74 7269 6573 0a0a 2020  from entries..  
-00007d90: 2020 6465 6620 696e 6465 785f 636f 756e    def index_coun
-00007da0: 7428 7365 6c66 2920 2d3e 2069 6e74 3a0a  t(self) -> int:.
-00007db0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00007dc0: 2020 2020 5265 7475 726e 7320 7468 6520      Returns the 
-00007dd0: 6e75 6d62 6572 206f 6620 6974 656d 7320  number of items 
-00007de0: 696e 206f 7572 2069 6e64 6578 2077 6974  in our index wit
-00007df0: 686f 7574 206c 6f61 6469 6e67 2061 6e79  hout loading any
-00007e00: 2069 7465 6d73 2e0a 0a20 2020 2020 2020   items...       
-00007e10: 203a 7265 7475 726e 733a 204e 756d 6265   :returns: Numbe
-00007e20: 7220 6f66 2069 6e64 6578 2065 6e74 7269  r of index entri
-00007e30: 6573 2e0a 2020 2020 2020 2020 2222 220a  es..        """.
-00007e40: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00007e50: 662e 5f64 6174 6162 6173 655f 6163 6365  f._database_acce
-00007e60: 7373 2829 3a0a 2020 2020 2020 2020 2020  ss():.          
-00007e70: 2020 7265 7475 726e 2073 656c 662e 5f69    return self._i
-00007e80: 6e64 6578 5f74 6162 6c65 2e63 6f75 6e74  ndex_table.count
-00007e90: 2829 0a0a 2020 2020 6465 6620 6765 745f  ()..    def get_
-00007ea0: 6c6f 6361 6c5f 7265 7628 7365 6c66 2c20  local_rev(self, 
-00007eb0: 6462 785f 7061 7468 5f6c 6f77 6572 3a20  dbx_path_lower: 
-00007ec0: 7374 7229 202d 3e20 7374 7220 7c20 4e6f  str) -> str | No
-00007ed0: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
-00007ee0: 2020 2020 2020 2020 4765 7473 2072 6576          Gets rev
-00007ef0: 6973 696f 6e20 6e75 6d62 6572 206f 6620  ision number of 
-00007f00: 6c6f 6361 6c20 6669 6c65 2e0a 0a20 2020  local file...   
-00007f10: 2020 2020 203a 7061 7261 6d20 6462 785f       :param dbx_
-00007f20: 7061 7468 5f6c 6f77 6572 3a20 4e6f 726d  path_lower: Norm
-00007f30: 616c 697a 6564 206c 6f77 6572 2063 6173  alized lower cas
-00007f40: 6520 4472 6f70 626f 7820 7061 7468 2e0a  e Dropbox path..
-00007f50: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-00007f60: 3a20 5265 7669 7369 6f6e 206e 756d 6265  : Revision numbe
-00007f70: 7220 6173 2073 7472 206f 7220 6060 4e6f  r as str or ``No
-00007f80: 6e65 6060 2069 6620 6e6f 206c 6f63 616c  ne`` if no local
-00007f90: 2072 6576 6973 696f 6e20 6e75 6d62 6572   revision number
-00007fa0: 2068 6173 0a20 2020 2020 2020 2020 2020   has.           
-00007fb0: 2062 6565 6e20 7361 7665 642e 0a20 2020   been saved..   
-00007fc0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-00007fd0: 2065 6e74 7279 203d 2073 656c 662e 6765   entry = self.ge
-00007fe0: 745f 696e 6465 785f 656e 7472 7928 6462  t_index_entry(db
-00007ff0: 785f 7061 7468 5f6c 6f77 6572 290a 0a20  x_path_lower).. 
-00008000: 2020 2020 2020 2069 6620 656e 7472 793a         if entry:
-00008010: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00008020: 7572 6e20 656e 7472 792e 7265 760a 2020  urn entry.rev.  
-00008030: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00008040: 2020 2020 2020 2020 7265 7475 726e 204e          return N
-00008050: 6f6e 650a 0a20 2020 2064 6566 2067 6574  one..    def get
-00008060: 5f6c 6173 745f 7379 6e63 2873 656c 662c  _last_sync(self,
-00008070: 2064 6278 5f70 6174 685f 6c6f 7765 723a   dbx_path_lower:
-00008080: 2073 7472 2920 2d3e 2066 6c6f 6174 3a0a   str) -> float:.
-00008090: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000080a0: 2020 2020 5265 7475 726e 7320 7468 6520      Returns the 
-000080b0: 7469 6d65 7374 616d 7020 6f66 206c 6173  timestamp of las
-000080c0: 7420 7379 6e63 2066 6f72 2061 6e20 696e  t sync for an in
-000080d0: 6469 7669 6475 616c 2070 6174 682e 0a0a  dividual path...
-000080e0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
-000080f0: 6278 5f70 6174 685f 6c6f 7765 723a 204e  bx_path_lower: N
-00008100: 6f72 6d61 6c69 7a65 6420 6c6f 7765 7220  ormalized lower 
-00008110: 6361 7365 2044 726f 7062 6f78 2070 6174  case Dropbox pat
-00008120: 682e 0a20 2020 2020 2020 203a 7265 7475  h..        :retu
-00008130: 726e 733a 2054 696d 6520 6f66 206c 6173  rns: Time of las
-00008140: 7420 7379 6e63 2e0a 2020 2020 2020 2020  t sync..        
-00008150: 2222 220a 2020 2020 2020 2020 656e 7472  """.        entr
-00008160: 7920 3d20 7365 6c66 2e67 6574 5f69 6e64  y = self.get_ind
-00008170: 6578 5f65 6e74 7279 2864 6278 5f70 6174  ex_entry(dbx_pat
-00008180: 685f 6c6f 7765 7229 0a0a 2020 2020 2020  h_lower)..      
-00008190: 2020 6966 2065 6e74 7279 3a0a 2020 2020    if entry:.    
-000081a0: 2020 2020 2020 2020 6c61 7374 5f73 796e          last_syn
-000081b0: 6320 3d20 656e 7472 792e 6c61 7374 5f73  c = entry.last_s
-000081c0: 796e 6320 6f72 2030 2e30 0a20 2020 2020  ync or 0.0.     
-000081d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000081e0: 2020 2020 206c 6173 745f 7379 6e63 203d       last_sync =
-000081f0: 2030 2e30 0a0a 2020 2020 2020 2020 7265   0.0..        re
-00008200: 7475 726e 206d 6178 286c 6173 745f 7379  turn max(last_sy
-00008210: 6e63 2c20 7365 6c66 2e6c 6f63 616c 5f63  nc, self.local_c
-00008220: 7572 736f 7229 0a0a 2020 2020 6465 6620  ursor)..    def 
-00008230: 7570 6461 7465 5f69 6e64 6578 5f66 726f  update_index_fro
-00008240: 6d5f 7379 6e63 5f65 7665 6e74 2873 656c  m_sync_event(sel
-00008250: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
-00008260: 656e 7429 202d 3e20 4e6f 6e65 3a0a 2020  ent) -> None:.  
-00008270: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00008280: 2020 5570 6461 7465 7320 7468 6520 6c6f    Updates the lo
-00008290: 6361 6c20 696e 6465 7820 6672 6f6d 2061  cal index from a
-000082a0: 2053 796e 6345 7665 6e74 2e0a 0a20 2020   SyncEvent...   
-000082b0: 2020 2020 203a 7061 7261 6d20 6576 656e       :param even
-000082c0: 743a 2053 796e 6345 7665 6e74 2066 726f  t: SyncEvent fro
-000082d0: 6d20 646f 776e 6c6f 6164 2e0a 2020 2020  m download..    
+00002270: 2020 2020 2023 2052 656d 6f76 6520 6578       # Remove ex
+00002280: 7069 7265 6420 6967 6e6f 7265 732e 0a20  pired ignores.. 
+00002290: 2020 2020 2020 2020 2020 2069 6620 6967             if ig
+000022a0: 6e6f 7265 2e74 746c 2061 6e64 2069 676e  nore.ttl and ign
+000022b0: 6f72 652e 7474 6c20 3c20 7469 6d65 2e74  ore.ttl < time.t
+000022c0: 696d 6528 293a 0a20 2020 2020 2020 2020  ime():.         
+000022d0: 2020 2020 2020 2073 656c 662e 5f69 676e         self._ign
+000022e0: 6f72 6564 5f65 7665 6e74 732e 6469 7363  ored_events.disc
+000022f0: 6172 6428 6967 6e6f 7265 290a 2020 2020  ard(ignore).    
+00002300: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00002310: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
+00002320: 2020 6967 6e6f 7265 5f65 7665 6e74 203d    ignore_event =
+00002330: 2069 676e 6f72 652e 6576 656e 740a 2020   ignore.event.  
+00002340: 2020 2020 2020 2020 2020 7265 6375 7273            recurs
+00002350: 6976 6520 3d20 6967 6e6f 7265 2e72 6563  ive = ignore.rec
+00002360: 7572 7369 7665 0a0a 2020 2020 2020 2020  ursive..        
+00002370: 2020 2020 2320 4368 6563 6b20 6966 2065      # Check if e
+00002380: 7665 6e74 2069 7320 6469 7265 6374 6c79  vent is directly
+00002390: 206d 6172 6b65 6420 6173 2074 6f20 6967   marked as to ig
+000023a0: 6e6f 7265 2e0a 2020 2020 2020 2020 2020  nore..          
+000023b0: 2020 6966 2065 7665 6e74 203d 3d20 6967    if event == ig
+000023c0: 6e6f 7265 5f65 7665 6e74 3a0a 2020 2020  nore_event:.    
+000023d0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000023e0: 6f74 2072 6563 7572 7369 7665 3a0a 2020  ot recursive:.  
+000023f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002400: 2020 7365 6c66 2e5f 6967 6e6f 7265 645f    self._ignored_
+00002410: 6576 656e 7473 2e64 6973 6361 7264 2869  events.discard(i
+00002420: 676e 6f72 6529 0a20 2020 2020 2020 2020  gnore).         
+00002430: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00002440: 7565 0a0a 2020 2020 2020 2020 2020 2020  ue..            
+00002450: 2320 4368 6563 6b20 6966 2065 7665 6e74  # Check if event
+00002460: 2069 7320 6d61 726b 6564 2061 7320 746f   is marked as to
+00002470: 2069 676e 6f72 6520 6279 2061 2072 6563   ignore by a rec
+00002480: 7572 7369 7665 2070 6172 656e 742e 2046  ursive parent. F
+00002490: 6f72 206d 6f76 6564 0a20 2020 2020 2020  or moved.       
+000024a0: 2020 2020 2023 2065 7665 6e74 732c 2073       # events, s
+000024b0: 6f75 7263 6520 616e 6420 6465 7374 696e  ource and destin
+000024c0: 6174 696f 6e20 7061 7468 206d 6f73 7420  ation path most 
+000024d0: 626f 7468 2062 6520 6368 696c 6472 656e  both be children
+000024e0: 206f 6620 7468 650a 2020 2020 2020 2020   of the.        
+000024f0: 2020 2020 2320 7265 7370 6563 7469 7665      # respective
+00002500: 2070 6174 6873 206f 6620 7468 6520 6576   paths of the ev
+00002510: 656e 7420 746f 2069 676e 6f72 652e 0a20  ent to ignore.. 
+00002520: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00002530: 7265 6375 7273 6976 653a 0a20 2020 2020  recursive:.     
+00002540: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00002550: 7420 6576 656e 742e 6576 656e 745f 7479  t event.event_ty
+00002560: 7065 203d 3d20 6967 6e6f 7265 5f65 7665  pe == ignore_eve
+00002570: 6e74 2e65 7665 6e74 5f74 7970 653a 0a20  nt.event_type:. 
+00002580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002590: 2020 2063 6f6e 7469 6e75 650a 0a20 2020     continue..   
+000025a0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000025b0: 6e6f 7420 6973 5f65 7175 616c 5f6f 725f  not is_equal_or_
+000025c0: 6368 696c 6428 6576 656e 742e 7372 635f  child(event.src_
+000025d0: 7061 7468 2c20 6967 6e6f 7265 5f65 7665  path, ignore_eve
+000025e0: 6e74 2e73 7263 5f70 6174 6829 3a0a 2020  nt.src_path):.  
+000025f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002600: 2020 636f 6e74 696e 7565 0a0a 2020 2020    continue..    
+00002610: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+00002620: 7665 6e74 2e65 7665 6e74 5f74 7970 6520  vent.event_type 
+00002630: 3d3d 2045 5645 4e54 5f54 5950 455f 4d4f  == EVENT_TYPE_MO
+00002640: 5645 4420 616e 6420 6e6f 7420 6973 5f65  VED and not is_e
+00002650: 7175 616c 5f6f 725f 6368 696c 6428 0a20  qual_or_child(. 
+00002660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002670: 2020 2065 7665 6e74 2e64 6573 745f 7061     event.dest_pa
+00002680: 7468 2c20 6967 6e6f 7265 5f65 7665 6e74  th, ignore_event
+00002690: 2e64 6573 745f 7061 7468 2020 2320 7479  .dest_path  # ty
+000026a0: 7065 3a69 676e 6f72 655b 6174 7472 2d64  pe:ignore[attr-d
+000026b0: 6566 696e 6564 5d0a 2020 2020 2020 2020  efined].        
+000026c0: 2020 2020 2020 2020 293a 0a20 2020 2020          ):.     
+000026d0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+000026e0: 6f6e 7469 6e75 650a 0a20 2020 2020 2020  ontinue..       
+000026f0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00002700: 5472 7565 0a0a 2020 2020 2020 2020 7265  True..        re
+00002710: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+00002720: 6465 6620 6f6e 5f61 6e79 5f65 7665 6e74  def on_any_event
+00002730: 2873 656c 662c 2065 7665 6e74 3a20 4669  (self, event: Fi
+00002740: 6c65 5379 7374 656d 4576 656e 7429 202d  leSystemEvent) -
+00002750: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00002760: 2222 220a 2020 2020 2020 2020 4368 6563  """.        Chec
+00002770: 6b73 2069 6620 7468 6520 7379 7374 656d  ks if the system
+00002780: 2066 696c 6520 6576 656e 7420 7368 6f75   file event shou
+00002790: 6c64 2062 6520 6967 6e6f 7265 642e 2049  ld be ignored. I
+000027a0: 6620 6e6f 742c 2061 6464 7320 6974 2074  f not, adds it t
+000027b0: 6f20 7468 6520 7175 6575 650a 2020 2020  o the queue.    
+000027c0: 2020 2020 666f 7220 6576 656e 7473 2074      for events t
+000027d0: 6f20 7570 6c6f 6164 2e20 4966 2073 796e  o upload. If syn
+000027e0: 6369 6e67 2069 7320 7061 7573 6564 206f  cing is paused o
+000027f0: 7220 7374 6f70 7065 642c 2061 6c6c 2065  r stopped, all e
+00002800: 7665 6e74 7320 7769 6c6c 2062 650a 2020  vents will be.  
+00002810: 2020 2020 2020 6967 6e6f 7265 642e 0a0a        ignored...
+00002820: 2020 2020 2020 2020 3a70 6172 616d 2065          :param e
+00002830: 7665 6e74 3a20 5761 7463 6864 6f67 2066  vent: Watchdog f
+00002840: 696c 6520 6576 656e 742e 0a20 2020 2020  ile event..     
+00002850: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
+00002860: 2049 676e 6f72 6520 6576 656e 7473 2069   Ignore events i
+00002870: 6620 6173 6b65 6420 746f 2064 6f20 736f  f asked to do so
+00002880: 2e0a 2020 2020 2020 2020 6966 206e 6f74  ..        if not
+00002890: 2073 656c 662e 5f65 6e61 626c 6564 3a0a   self._enabled:.
+000028a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000028b0: 726e 0a0a 2020 2020 2020 2020 2320 4861  rn..        # Ha
+000028c0: 6e64 6c65 206f 6e6c 7920 7768 6974 656c  ndle only whitel
+000028d0: 6973 7465 6420 6469 7220 6576 656e 7420  isted dir event 
+000028e0: 7479 7065 732e 0a20 2020 2020 2020 2069  types..        i
+000028f0: 6620 6576 656e 742e 6973 5f64 6972 6563  f event.is_direc
+00002900: 746f 7279 2061 6e64 2065 7665 6e74 2e65  tory and event.e
+00002910: 7665 6e74 5f74 7970 6520 6e6f 7420 696e  vent_type not in
+00002920: 2073 656c 662e 6469 725f 6576 656e 745f   self.dir_event_
+00002930: 7479 7065 733a 0a20 2020 2020 2020 2020  types:.         
+00002940: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+00002950: 2020 2023 2048 616e 646c 6520 6f6e 6c79     # Handle only
+00002960: 2077 6869 7465 6c69 7374 6564 2066 696c   whitelisted fil
+00002970: 6520 6576 656e 7420 7479 7065 732e 0a20  e event types.. 
+00002980: 2020 2020 2020 2069 6620 6e6f 7420 6576         if not ev
+00002990: 656e 742e 6973 5f64 6972 6563 746f 7279  ent.is_directory
+000029a0: 2061 6e64 2065 7665 6e74 2e65 7665 6e74   and event.event
+000029b0: 5f74 7970 6520 6e6f 7420 696e 2073 656c  _type not in sel
+000029c0: 662e 6669 6c65 5f65 7665 6e74 5f74 7970  f.file_event_typ
+000029d0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+000029e0: 7265 7475 726e 0a0a 2020 2020 2020 2020  return..        
+000029f0: 2320 4967 6e6f 7265 206d 6f76 6573 206f  # Ignore moves o
+00002a00: 6e74 6f20 6974 7365 6c66 2c20 7468 6579  nto itself, they
+00002a10: 206d 6179 2062 6520 6572 726f 6e65 6f75   may be erroneou
+00002a20: 736c 7920 656d 6974 7465 6420 6f6e 206f  sly emitted on o
+00002a30: 6c64 6572 2076 6572 7369 6f6e 7320 6f66  lder versions of
+00002a40: 0a20 2020 2020 2020 2023 206d 6163 4f53  .        # macOS
+00002a50: 2077 6865 6e20 6368 616e 6769 6e67 2074   when changing t
+00002a60: 6865 2075 6e69 636f 6465 206e 6f72 6d61  he unicode norma
+00002a70: 6c69 7361 7469 6f6e 206f 6620 6120 7061  lisation of a pa
+00002a80: 7468 2077 6974 6820 6f73 2e72 656e 616d  th with os.renam
+00002a90: 6528 292e 0a20 2020 2020 2020 2023 2053  e()..        # S
+00002aa0: 6565 2068 7474 7073 3a2f 2f67 6974 6875  ee https://githu
+00002ab0: 622e 636f 6d2f 7361 6d73 6368 6f74 742f  b.com/samschott/
+00002ac0: 6d61 6573 7472 616c 2f69 7373 7565 732f  maestral/issues/
+00002ad0: 3637 312e 0a20 2020 2020 2020 2069 6620  671..        if 
+00002ae0: 6973 5f6d 6f76 6564 2865 7665 6e74 2920  is_moved(event) 
+00002af0: 616e 6420 6576 656e 742e 7372 635f 7061  and event.src_pa
+00002b00: 7468 203d 3d20 6576 656e 742e 6465 7374  th == event.dest
+00002b10: 5f70 6174 683a 0a20 2020 2020 2020 2020  _path:.         
+00002b20: 2020 2072 6574 7572 6e0a 0a20 2020 2020     return..     
+00002b30: 2020 2023 2043 6865 636b 2069 6620 6576     # Check if ev
+00002b40: 656e 7420 7368 6f75 6c64 2062 6520 6967  ent should be ig
+00002b50: 6e6f 7265 642e 0a20 2020 2020 2020 2069  nored..        i
+00002b60: 6620 7365 6c66 2e5f 6973 5f69 676e 6f72  f self._is_ignor
+00002b70: 6564 2865 7665 6e74 293a 0a20 2020 2020  ed(event):.     
+00002b80: 2020 2020 2020 2072 6574 7572 6e0a 0a20         return.. 
+00002b90: 2020 2020 2020 2073 656c 662e 7175 6575         self.queu
+00002ba0: 655f 6576 656e 7428 6576 656e 7429 0a0a  e_event(event)..
+00002bb0: 2020 2020 6465 6620 7175 6575 655f 6576      def queue_ev
+00002bc0: 656e 7428 7365 6c66 2c20 6576 656e 743a  ent(self, event:
+00002bd0: 2046 696c 6553 7973 7465 6d45 7665 6e74   FileSystemEvent
+00002be0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00002bf0: 2020 2022 2222 0a20 2020 2020 2020 2051     """.        Q
+00002c00: 7565 7565 7320 616e 2069 6e64 6976 6964  ueues an individ
+00002c10: 7561 6c20 6669 6c65 2073 7973 7465 6d20  ual file system 
+00002c20: 6576 656e 742e 204e 6f74 6966 6965 7320  event. Notifies 
+00002c30: 2f20 7761 6b65 7320 7570 2061 6c6c 2074  / wakes up all t
+00002c40: 6872 6561 6473 2074 6861 7420 6172 650a  hreads that are.
+00002c50: 2020 2020 2020 2020 7761 6974 696e 6720          waiting 
+00002c60: 7769 7468 203a 6d65 7468 3a60 7761 6974  with :meth:`wait
+00002c70: 5f66 6f72 5f65 7665 6e74 602e 0a0a 2020  _for_event`...  
+00002c80: 2020 2020 2020 3a70 6172 616d 2065 7665        :param eve
+00002c90: 6e74 3a20 4669 6c65 2073 7973 7465 6d20  nt: File system 
+00002ca0: 6576 656e 7420 746f 2071 7565 7565 2e0a  event to queue..
+00002cb0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00002cc0: 2020 2020 7769 7468 2073 656c 662e 6861      with self.ha
+00002cd0: 735f 6576 656e 7473 3a0a 2020 2020 2020  s_events:.      
+00002ce0: 2020 2020 2020 7365 6c66 2e6c 6f63 616c        self.local
+00002cf0: 5f66 696c 655f 6576 656e 745f 7175 6575  _file_event_queu
+00002d00: 652e 7075 7428 6576 656e 7429 0a20 2020  e.put(event).   
+00002d10: 2020 2020 2020 2020 2073 656c 662e 6861           self.ha
+00002d20: 735f 6576 656e 7473 2e6e 6f74 6966 795f  s_events.notify_
+00002d30: 616c 6c28 290a 0a20 2020 2064 6566 2077  all()..    def w
+00002d40: 6169 745f 666f 725f 6576 656e 7428 7365  ait_for_event(se
+00002d50: 6c66 2c20 7469 6d65 6f75 743a 2066 6c6f  lf, timeout: flo
+00002d60: 6174 203d 2034 3029 202d 3e20 626f 6f6c  at = 40) -> bool
+00002d70: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00002d80: 2020 2020 2020 426c 6f63 6b73 2075 6e74        Blocks unt
+00002d90: 696c 2061 6e20 6576 656e 7420 6973 2061  il an event is a
+00002da0: 7661 696c 6162 6c65 2069 6e20 7468 6520  vailable in the 
+00002db0: 7175 6575 6520 6f72 2061 2074 696d 656f  queue or a timeo
+00002dc0: 7574 206f 6363 7572 732c 2077 6869 6368  ut occurs, which
+00002dd0: 6576 6572 0a20 2020 2020 2020 2063 6f6d  ever.        com
+00002de0: 6573 2066 6972 7374 2e20 596f 7520 6361  es first. You ca
+00002df0: 6e20 7573 6520 7769 7468 206d 6574 686f  n use with metho
+00002e00: 6420 746f 2077 6169 7420 666f 7220 6669  d to wait for fi
+00002e10: 6c65 2073 7973 7465 6d20 6576 656e 7473  le system events
+00002e20: 2069 6e20 616e 6f74 6865 720a 2020 2020   in another.    
+00002e30: 2020 2020 7468 7265 6164 2e0a 0a20 2020      thread...   
+00002e40: 2020 2020 202e 2e20 6e6f 7465 3a3a 2049       .. note:: I
+00002e50: 6620 7468 6572 6520 6172 6520 6d75 6c74  f there are mult
+00002e60: 6970 6c65 2074 6872 6561 6473 2077 6169  iple threads wai
+00002e70: 7469 6e67 2066 6f72 2065 7665 6e74 732c  ting for events,
+00002e80: 2061 6c6c 206f 6620 7468 656d 2077 696c   all of them wil
+00002e90: 6c20 6265 0a20 2020 2020 2020 2020 2020  l be.           
+00002ea0: 206e 6f74 6966 6965 642e 2049 6620 6f6e   notified. If on
+00002eb0: 6520 6f66 2074 686f 7365 2074 6872 6561  e of those threa
+00002ec0: 6473 2073 7461 7274 7320 6765 7474 696e  ds starts gettin
+00002ed0: 6720 6576 656e 7473 2066 726f 6d0a 2020  g events from.  
+00002ee0: 2020 2020 2020 2020 2020 3a61 7474 723a            :attr:
+00002ef0: 606c 6f63 616c 5f66 696c 655f 6576 656e  `local_file_even
+00002f00: 745f 7175 6575 6560 2c20 6f74 6865 7220  t_queue`, other 
+00002f10: 7468 7265 6164 7320 6d61 7920 6669 6e64  threads may find
+00002f20: 2074 6861 7420 7468 6520 7175 6575 6520   that the queue 
+00002f30: 6973 0a20 2020 2020 2020 2020 2020 2065  is.            e
+00002f40: 6d70 7479 2064 6573 7069 7465 2062 6569  mpty despite bei
+00002f50: 6e67 2077 6f6b 656e 2e20 596f 7520 7368  ng woken. You sh
+00002f60: 6f75 6c64 2074 6865 7265 666f 7265 2062  ould therefore b
+00002f70: 6520 7072 6570 6172 6564 2074 6f20 6861  e prepared to ha
+00002f80: 6e64 6c65 2061 6e0a 2020 2020 2020 2020  ndle an.        
+00002f90: 2020 2020 656d 7074 7920 7175 6575 6520      empty queue 
+00002fa0: 6576 656e 2069 6620 7468 6973 206d 6574  even if this met
+00002fb0: 686f 6420 7265 7475 726e 7320 6060 5472  hod returns ``Tr
+00002fc0: 7565 6060 2e0a 0a20 2020 2020 2020 203a  ue``...        :
+00002fd0: 7061 7261 6d20 7469 6d65 6f75 743a 204d  param timeout: M
+00002fe0: 6178 696d 756d 2074 696d 6520 746f 2062  aximum time to b
+00002ff0: 6c6f 636b 2069 6e20 7365 636f 6e64 732e  lock in seconds.
+00003000: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+00003010: 733a 2060 6054 7275 6560 6020 6966 2061  s: ``True`` if a
+00003020: 6e20 6576 656e 7420 6973 2061 7661 696c  n event is avail
+00003030: 6162 6c65 2c20 6060 4661 6c73 6560 6020  able, ``False`` 
+00003040: 6966 2074 6865 2063 616c 6c20 7265 7475  if the call retu
+00003050: 726e 7320 6475 650a 2020 2020 2020 2020  rns due.        
+00003060: 2020 2020 746f 2061 2074 696d 656f 7574      to a timeout
+00003070: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00003080: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00003090: 6861 735f 6576 656e 7473 3a0a 2020 2020  has_events:.    
+000030a0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000030b0: 6c6f 6361 6c5f 6669 6c65 5f65 7665 6e74  local_file_event
+000030c0: 5f71 7565 7565 2e71 7369 7a65 2829 203e  _queue.qsize() >
+000030d0: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+000030e0: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+000030f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00003100: 2e68 6173 5f65 7665 6e74 732e 7761 6974  .has_events.wait
+00003110: 2874 696d 656f 7574 290a 2020 2020 2020  (timeout).      
+00003120: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00003130: 662e 6c6f 6361 6c5f 6669 6c65 5f65 7665  f.local_file_eve
+00003140: 6e74 5f71 7565 7565 2e71 7369 7a65 2829  nt_queue.qsize()
+00003150: 203e 2030 0a0a 0a63 6c61 7373 2041 6374   > 0...class Act
+00003160: 6976 6974 794e 6f64 653a 0a20 2020 2022  ivityNode:.    "
+00003170: 2222 4120 6e6f 6465 2069 6e20 6120 7370  ""A node in a sp
+00003180: 6172 7365 2074 7265 6520 746f 2072 6570  arse tree to rep
+00003190: 7265 7365 6e74 2073 796e 6369 6e67 2061  resent syncing a
+000031a0: 6374 6976 6974 792e 0a0a 2020 2020 4561  ctivity...    Ea
+000031b0: 6368 206e 6f64 6520 7265 7072 6573 656e  ch node represen
+000031c0: 7473 2061 6e20 6974 656d 2069 6e20 7468  ts an item in th
+000031d0: 6520 6c6f 6361 6c20 4472 6f70 626f 7820  e local Dropbox 
+000031e0: 666f 6c64 6572 2e20 4170 6172 7420 6672  folder. Apart fr
+000031f0: 6f6d 2074 6865 2072 6f6f 7420 6e6f 6465  om the root node
+00003200: 2c0a 2020 2020 6974 656d 7320 7769 6c6c  ,.    items will
+00003210: 206f 6e6c 7920 6265 2070 7265 7365 6e74   only be present
+00003220: 2069 6620 7468 6579 206f 7220 616e 7920   if they or any 
+00003230: 6f66 2074 6865 6972 2063 6869 6c64 7265  of their childre
+00003240: 6e20 6861 7665 2061 6e79 2073 796e 6320  n have any sync 
+00003250: 6163 7469 7669 7479 2e0a 0a20 2020 203a  activity...    :
+00003260: 6174 7472 2063 6869 6c64 7265 6e3a 2041  attr children: A
+00003270: 6c6c 2063 6869 6c64 7265 6e20 7769 7468  ll children with
+00003280: 2073 796e 6320 6163 7469 7669 7479 2e20   sync activity. 
+00003290: 4c65 6166 206e 6f64 6573 206d 7573 7420  Leaf nodes must 
+000032a0: 7265 7072 6573 656e 7420 6974 656d 730a  represent items.
+000032b0: 2020 2020 2020 2020 7468 6174 2061 7265          that are
+000032c0: 2062 6569 6e67 2075 706c 6f61 6465 642c   being uploaded,
+000032d0: 2064 6f77 6e6c 6f61 6465 642c 206f 7220   downloaded, or 
+000032e0: 6861 7665 2061 2073 796e 6320 6572 726f  have a sync erro
+000032f0: 722e 0a20 2020 203a 6174 7472 2073 796e  r..    :attr syn
+00003300: 635f 6576 656e 7473 3a20 416c 6c20 5379  c_events: All Sy
+00003310: 6e63 4576 656e 7473 206f 6620 7468 6973  ncEvents of this
+00003320: 206e 6f64 6520 616e 6420 6974 7320 6368   node and its ch
+00003330: 696c 6472 656e 2e0a 2020 2020 2222 220a  ildren..    """.
+00003340: 0a20 2020 205f 5f73 6c6f 7473 5f5f 203d  .    __slots__ =
+00003350: 205b 226e 616d 6522 2c20 2270 6172 656e   ["name", "paren
+00003360: 7422 2c20 2263 6869 6c64 7265 6e22 2c20  t", "children", 
+00003370: 2273 796e 635f 6576 656e 7473 225d 0a0a  "sync_events"]..
+00003380: 2020 2020 6465 6620 5f5f 696e 6974 5f5f      def __init__
+00003390: 280a 2020 2020 2020 2020 7365 6c66 2c0a  (.        self,.
+000033a0: 2020 2020 2020 2020 6e61 6d65 3a20 7374          name: st
+000033b0: 722c 0a20 2020 2020 2020 2073 796e 635f  r,.        sync_
+000033c0: 6576 656e 7473 3a20 4974 6572 6162 6c65  events: Iterable
+000033d0: 5b53 796e 6345 7665 6e74 5d20 3d20 2829  [SyncEvent] = ()
+000033e0: 2c0a 2020 2020 2020 2020 7061 7265 6e74  ,.        parent
+000033f0: 3a20 4163 7469 7669 7479 4e6f 6465 207c  : ActivityNode |
+00003400: 204e 6f6e 6520 3d20 4e6f 6e65 2c0a 2020   None = None,.  
+00003410: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+00003420: 2020 2020 2073 656c 662e 6e61 6d65 203d       self.name =
+00003430: 206e 616d 650a 2020 2020 2020 2020 7365   name.        se
+00003440: 6c66 2e70 6172 656e 7420 3d20 7061 7265  lf.parent = pare
+00003450: 6e74 0a20 2020 2020 2020 2073 656c 662e  nt.        self.
+00003460: 6368 696c 6472 656e 3a20 6469 6374 5b73  children: dict[s
+00003470: 7472 2c20 4163 7469 7669 7479 4e6f 6465  tr, ActivityNode
+00003480: 5d20 3d20 7b7d 0a20 2020 2020 2020 2073  ] = {}.        s
+00003490: 656c 662e 7379 6e63 5f65 7665 6e74 7320  elf.sync_events 
+000034a0: 3d20 7365 7428 7379 6e63 5f65 7665 6e74  = set(sync_event
+000034b0: 7329 0a0a 2020 2020 6465 6620 5f5f 7265  s)..    def __re
+000034c0: 7072 5f5f 2873 656c 6629 202d 3e20 7374  pr__(self) -> st
+000034d0: 723a 0a20 2020 2020 2020 2072 6574 7572  r:.        retur
+000034e0: 6e20 6622 3c7b 7365 6c66 2e5f 5f63 6c61  n f"<{self.__cla
+000034f0: 7373 5f5f 2e5f 5f6e 616d 655f 5f7d 286e  ss__.__name__}(n
+00003500: 616d 653d 7b73 656c 662e 6e61 6d65 7d2c  ame={self.name},
+00003510: 2063 6869 6c64 7265 6e3d 7b73 656c 662e   children={self.
+00003520: 6368 696c 6472 656e 7d2c 2073 796e 635f  children}, sync_
+00003530: 6576 656e 7473 3d7b 7365 6c66 2e73 796e  events={self.syn
+00003540: 635f 6576 656e 7473 7d29 3e22 0a0a 0a63  c_events})>"...c
+00003550: 6c61 7373 2041 6374 6976 6974 7954 7265  lass ActivityTre
+00003560: 6528 4163 7469 7669 7479 4e6f 6465 293a  e(ActivityNode):
+00003570: 0a20 2020 2022 2222 5468 6520 726f 6f74  .    """The root
+00003580: 206e 6f64 6520 696e 2061 2073 796e 6320   node in a sync 
+00003590: 6163 7469 7669 7479 2074 7265 652e 2052  activity tree. R
+000035a0: 6570 7265 7365 6e74 7320 4472 6f70 626f  epresents Dropbo
+000035b0: 7820 726f 6f74 2e22 2222 0a0a 2020 2020  x root."""..    
+000035c0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+000035d0: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
+000035e0: 2020 2020 7375 7065 7228 292e 5f5f 696e      super().__in
+000035f0: 6974 5f5f 286e 616d 653d 222f 2229 0a20  it__(name="/"). 
+00003600: 2020 2020 2020 2073 656c 662e 5f6c 6f63         self._loc
+00003610: 6b20 3d20 524c 6f63 6b28 290a 0a20 2020  k = RLock()..   
+00003620: 2064 6566 2061 6464 2873 656c 662c 2065   def add(self, e
+00003630: 7665 6e74 3a20 5379 6e63 4576 656e 7429  vent: SyncEvent)
+00003640: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00003650: 2020 7769 7468 2073 656c 662e 5f6c 6f63    with self._loc
+00003660: 6b3a 0a20 2020 2020 2020 2020 2020 2070  k:.            p
+00003670: 6172 7473 203d 2065 7665 6e74 2e64 6278  arts = event.dbx
+00003680: 5f70 6174 682e 6c73 7472 6970 2822 2f22  _path.lstrip("/"
+00003690: 292e 7370 6c69 7428 222f 2229 0a0a 2020  ).split("/")..  
+000036a0: 2020 2020 2020 2020 2020 2320 5265 6d6f            # Remo
+000036b0: 7665 2061 6e79 2066 6169 6c75 7265 7320  ve any failures 
+000036c0: 6174 2074 6869 7320 7061 7468 2e0a 2020  at this path..  
+000036d0: 2020 2020 2020 2020 2020 6e6f 6465 203d            node =
+000036e0: 2073 656c 662e 6765 745f 6e6f 6465 2865   self.get_node(e
+000036f0: 7665 6e74 2e64 6278 5f70 6174 6829 0a20  vent.dbx_path). 
+00003700: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00003710: 6465 3a0a 2020 2020 2020 2020 2020 2020  de:.            
+00003720: 2020 2020 6661 696c 6564 203d 205b 6520      failed = [e 
+00003730: 666f 7220 6520 696e 206e 6f64 652e 7379  for e in node.sy
+00003740: 6e63 5f65 7665 6e74 7320 6966 2065 2e73  nc_events if e.s
+00003750: 7461 7475 7320 6973 2053 796e 6353 7461  tatus is SyncSta
+00003760: 7475 732e 4661 696c 6564 5d0a 2020 2020  tus.Failed].    
+00003770: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00003780: 6661 696c 2069 6e20 6661 696c 6564 3a0a  fail in failed:.
+00003790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000037a0: 2020 2020 7365 6c66 2e72 656d 6f76 6528      self.remove(
+000037b0: 6661 696c 290a 0a20 2020 2020 2020 2020  fail)..         
+000037c0: 2020 2023 2054 7261 7665 7273 6520 7472     # Traverse tr
+000037d0: 6565 2061 6e64 2063 7265 6174 6520 6368  ee and create ch
+000037e0: 696c 6472 656e 2061 7320 7265 7175 6972  ildren as requir
+000037f0: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
+00003800: 2320 496e 7365 7274 2053 796e 6345 7665  # Insert SyncEve
+00003810: 6e74 2066 6f72 2065 6163 6820 7061 7265  nt for each pare
+00003820: 6e74 2061 7320 7765 206d 6f76 6520 646f  nt as we move do
+00003830: 776e 2e0a 2020 2020 2020 2020 2020 2020  wn..            
+00003840: 6375 7272 656e 745f 6e6f 6465 3a20 4163  current_node: Ac
+00003850: 7469 7669 7479 4e6f 6465 203d 2073 656c  tivityNode = sel
+00003860: 660a 2020 2020 2020 2020 2020 2020 6375  f.            cu
+00003870: 7272 656e 745f 6e6f 6465 2e73 796e 635f  rrent_node.sync_
+00003880: 6576 656e 7473 2e61 6464 2865 7665 6e74  events.add(event
+00003890: 290a 0a20 2020 2020 2020 2020 2020 2066  )..            f
+000038a0: 6f72 2070 6172 7420 696e 2070 6172 7473  or part in parts
+000038b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000038c0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000038d0: 2020 2020 2020 2020 2020 2063 6869 6c64             child
+000038e0: 5f6e 6f64 6520 3d20 6375 7272 656e 745f  _node = current_
+000038f0: 6e6f 6465 2e63 6869 6c64 7265 6e5b 7061  node.children[pa
+00003900: 7274 5d0a 2020 2020 2020 2020 2020 2020  rt].            
+00003910: 2020 2020 6578 6365 7074 204b 6579 4572      except KeyEr
+00003920: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+00003930: 2020 2020 2020 2020 2063 6869 6c64 5f6e           child_n
+00003940: 6f64 6520 3d20 4163 7469 7669 7479 4e6f  ode = ActivityNo
+00003950: 6465 2870 6172 742c 2070 6172 656e 743d  de(part, parent=
+00003960: 6375 7272 656e 745f 6e6f 6465 290a 2020  current_node).  
+00003970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003980: 2020 6375 7272 656e 745f 6e6f 6465 2e63    current_node.c
+00003990: 6869 6c64 7265 6e5b 7061 7274 5d20 3d20  hildren[part] = 
+000039a0: 6368 696c 645f 6e6f 6465 0a20 2020 2020  child_node.     
+000039b0: 2020 2020 2020 2020 2020 2063 6869 6c64             child
+000039c0: 5f6e 6f64 652e 7379 6e63 5f65 7665 6e74  _node.sync_event
+000039d0: 732e 6164 6428 6576 656e 7429 0a20 2020  s.add(event).   
+000039e0: 2020 2020 2020 2020 2020 2020 2063 7572               cur
+000039f0: 7265 6e74 5f6e 6f64 6520 3d20 6368 696c  rent_node = chil
+00003a00: 645f 6e6f 6465 0a0a 2020 2020 6465 6620  d_node..    def 
+00003a10: 7265 6d6f 7665 2873 656c 662c 2065 7665  remove(self, eve
+00003a20: 6e74 3a20 5379 6e63 4576 656e 7429 202d  nt: SyncEvent) -
+00003a30: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00003a40: 7769 7468 2073 656c 662e 5f6c 6f63 6b3a  with self._lock:
+00003a50: 0a20 2020 2020 2020 2020 2020 206e 6f64  .            nod
+00003a60: 6520 3d20 7365 6c66 2e67 6574 5f6e 6f64  e = self.get_nod
+00003a70: 6528 6576 656e 742e 6462 785f 7061 7468  e(event.dbx_path
+00003a80: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+00003a90: 206e 6f74 206e 6f64 653a 0a20 2020 2020   not node:.     
+00003aa0: 2020 2020 2020 2020 2020 2072 6169 7365             raise
+00003ab0: 204b 6579 4572 726f 7228 6622 4e6f 206e   KeyError(f"No n
+00003ac0: 6f64 6520 6174 2070 6174 6820 7b65 7665  ode at path {eve
+00003ad0: 6e74 2e64 6278 5f70 6174 687d 2229 0a20  nt.dbx_path}"). 
+00003ae0: 2020 2020 2020 2020 2020 2069 6620 6576             if ev
+00003af0: 656e 7420 6e6f 7420 696e 206e 6f64 652e  ent not in node.
+00003b00: 7379 6e63 5f65 7665 6e74 733a 0a20 2020  sync_events:.   
+00003b10: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00003b20: 7365 204b 6579 4572 726f 7228 6622 5379  se KeyError(f"Sy
+00003b30: 6e63 4576 656e 7420 6e6f 7420 666f 756e  ncEvent not foun
+00003b40: 6420 6174 2070 6174 6820 7b65 7665 6e74  d at path {event
+00003b50: 2e64 6278 5f70 6174 687d 2229 0a0a 2020  .dbx_path}")..  
+00003b60: 2020 2020 2020 2020 2020 2320 5761 6c6b            # Walk
+00003b70: 2074 7265 6520 7570 7761 7264 732e 2052   tree upwards. R
+00003b80: 656d 6f76 6520 6e6f 6465 7320 6966 206e  emove nodes if n
+00003b90: 6f20 5379 6e63 4576 656e 7473 2072 656d  o SyncEvents rem
+00003ba0: 6169 6e2e 0a20 2020 2020 2020 2020 2020  ain..           
+00003bb0: 206e 6f64 652e 7379 6e63 5f65 7665 6e74   node.sync_event
+00003bc0: 732e 7265 6d6f 7665 2865 7665 6e74 290a  s.remove(event).
+00003bd0: 2020 2020 2020 2020 2020 2020 7061 7265              pare
+00003be0: 6e74 203d 206e 6f64 652e 7061 7265 6e74  nt = node.parent
+00003bf0: 0a0a 2020 2020 2020 2020 2020 2020 7768  ..            wh
+00003c00: 696c 6520 7061 7265 6e74 3a0a 2020 2020  ile parent:.    
+00003c10: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+00003c20: 6d6f 7665 2065 7665 6e74 2066 726f 6d20  move event from 
+00003c30: 7061 7265 6e74 2e0a 2020 2020 2020 2020  parent..        
+00003c40: 2020 2020 2020 2020 7061 7265 6e74 2e73          parent.s
+00003c50: 796e 635f 6576 656e 7473 2e72 656d 6f76  ync_events.remov
+00003c60: 6528 6576 656e 7429 0a20 2020 2020 2020  e(event).       
+00003c70: 2020 2020 2020 2020 2023 2052 656d 6f76           # Remov
+00003c80: 6520 6e6f 6465 2066 726f 6d20 7472 6565  e node from tree
+00003c90: 2069 6620 6974 2069 7320 656d 7074 792e   if it is empty.
+00003ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00003cb0: 2069 6620 6c65 6e28 6e6f 6465 2e73 796e   if len(node.syn
+00003cc0: 635f 6576 656e 7473 2920 3d3d 2030 3a0a  c_events) == 0:.
+00003cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ce0: 2020 2020 7061 7265 6e74 2e63 6869 6c64      parent.child
+00003cf0: 7265 6e2e 706f 7028 6e6f 6465 2e6e 616d  ren.pop(node.nam
+00003d00: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+00003d10: 2020 2023 204d 6f76 6520 7570 2e0a 2020     # Move up..  
+00003d20: 2020 2020 2020 2020 2020 2020 2020 6e6f                no
+00003d30: 6465 203d 2070 6172 656e 740a 2020 2020  de = parent.    
+00003d40: 2020 2020 2020 2020 2020 2020 7061 7265              pare
+00003d50: 6e74 203d 206e 6f64 652e 7061 7265 6e74  nt = node.parent
+00003d60: 0a0a 2020 2020 6465 6620 6469 7363 6172  ..    def discar
+00003d70: 6428 7365 6c66 2c20 6576 656e 743a 2053  d(self, event: S
+00003d80: 796e 6345 7665 6e74 2920 2d3e 204e 6f6e  yncEvent) -> Non
+00003d90: 653a 0a20 2020 2020 2020 2074 7279 3a0a  e:.        try:.
+00003da0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00003db0: 2e72 656d 6f76 6528 6576 656e 7429 0a20  .remove(event). 
+00003dc0: 2020 2020 2020 2065 7863 6570 7420 4b65         except Ke
+00003dd0: 7945 7272 6f72 3a0a 2020 2020 2020 2020  yError:.        
+00003de0: 2020 2020 7061 7373 0a0a 2020 2020 6465      pass..    de
+00003df0: 6620 6861 735f 7061 7468 2873 656c 662c  f has_path(self,
+00003e00: 2064 6278 5f70 6174 683a 2073 7472 2920   dbx_path: str) 
+00003e10: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+00003e20: 2072 6574 7572 6e20 7365 6c66 2e67 6574   return self.get
+00003e30: 5f6e 6f64 6528 6462 785f 7061 7468 2920  _node(dbx_path) 
+00003e40: 6973 206e 6f74 204e 6f6e 650a 0a20 2020  is not None..   
+00003e50: 2064 6566 2067 6574 5f6e 6f64 6528 7365   def get_node(se
+00003e60: 6c66 2c20 6462 785f 7061 7468 3a20 7374  lf, dbx_path: st
+00003e70: 7229 202d 3e20 4163 7469 7669 7479 4e6f  r) -> ActivityNo
+00003e80: 6465 207c 204e 6f6e 653a 0a20 2020 2020  de | None:.     
+00003e90: 2020 2069 6620 6462 785f 7061 7468 203d     if dbx_path =
+00003ea0: 3d20 222f 223a 0a20 2020 2020 2020 2020  = "/":.         
+00003eb0: 2020 2072 6574 7572 6e20 7365 6c66 0a0a     return self..
+00003ec0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00003ed0: 662e 5f6c 6f63 6b3a 0a20 2020 2020 2020  f._lock:.       
+00003ee0: 2020 2020 2070 6172 7473 203d 2064 6278       parts = dbx
+00003ef0: 5f70 6174 682e 6c73 7472 6970 2822 2f22  _path.lstrip("/"
+00003f00: 292e 7370 6c69 7428 222f 2229 0a20 2020  ).split("/").   
+00003f10: 2020 2020 2020 2020 206e 6f64 653a 2041           node: A
+00003f20: 6374 6976 6974 794e 6f64 6520 3d20 7365  ctivityNode = se
+00003f30: 6c66 0a20 2020 2020 2020 2020 2020 2066  lf.            f
+00003f40: 6f72 2070 6172 7420 696e 2070 6172 7473  or part in parts
+00003f50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00003f60: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00003f70: 2020 2020 2020 2020 2020 206e 6f64 6520             node 
+00003f80: 3d20 6e6f 6465 2e63 6869 6c64 7265 6e5b  = node.children[
+00003f90: 7061 7274 5d0a 2020 2020 2020 2020 2020  part].          
+00003fa0: 2020 2020 2020 6578 6365 7074 204b 6579        except Key
+00003fb0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+00003fc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00003fd0: 6e20 4e6f 6e65 0a0a 2020 2020 2020 2020  n None..        
+00003fe0: 2020 2020 7265 7475 726e 206e 6f64 650a      return node.
+00003ff0: 0a0a 636c 6173 7320 5379 6e63 456e 6769  ..class SyncEngi
+00004000: 6e65 3a0a 2020 2020 2222 2243 6c61 7373  ne:.    """Class
+00004010: 2074 6861 7420 6861 6e64 6c65 7320 7379   that handles sy
+00004020: 6e63 696e 6720 7769 7468 2044 726f 7062  ncing with Dropb
+00004030: 6f78 0a0a 2020 2020 5072 6f76 6964 6573  ox..    Provides
+00004040: 206d 6574 686f 6473 2074 6f20 7761 6974   methods to wait
+00004050: 2066 6f72 206c 6f63 616c 206f 7220 7265   for local or re
+00004060: 6d6f 7465 2063 6861 6e67 6573 2061 6e64  mote changes and
+00004070: 2073 796e 6320 7468 656d 2c20 696e 636c   sync them, incl
+00004080: 7564 696e 670a 2020 2020 636f 6e66 6c69  uding.    confli
+00004090: 6374 2072 6573 6f6c 7574 696f 6e20 616e  ct resolution an
+000040a0: 6420 7570 6461 7465 7320 746f 206f 7572  d updates to our
+000040b0: 2069 6e64 6578 2e0a 0a20 2020 203a 7061   index...    :pa
+000040c0: 7261 6d20 636c 6965 6e74 3a20 4472 6f70  ram client: Drop
+000040d0: 626f 7820 4150 4920 636c 6965 6e74 2069  box API client i
+000040e0: 6e73 7461 6e63 652e 0a20 2020 203a 7061  nstance..    :pa
+000040f0: 7261 6d20 6465 736b 746f 705f 6e6f 7469  ram desktop_noti
+00004100: 6669 6572 3a20 4465 736b 746f 7020 6e6f  fier: Desktop no
+00004110: 7469 6669 6572 2069 6e73 7461 6e63 6520  tifier instance 
+00004120: 746f 2075 7365 2066 6f72 2075 7365 7220  to use for user 
+00004130: 6e6f 7469 6669 6361 7469 6f6e 732e 0a20  notifications.. 
+00004140: 2020 2022 2222 0a0a 2020 2020 5f6d 6178     """..    _max
+00004150: 5f68 6973 746f 7279 203d 2031 3030 300a  _history = 1000.
+00004160: 0a20 2020 2064 6566 205f 5f69 6e69 745f  .    def __init_
+00004170: 5f28 0a20 2020 2020 2020 2073 656c 662c  _(.        self,
+00004180: 0a20 2020 2020 2020 2063 6c69 656e 743a  .        client:
+00004190: 2044 726f 7062 6f78 436c 6965 6e74 2c0a   DropboxClient,.
+000041a0: 2020 2020 2020 2020 6465 736b 746f 705f          desktop_
+000041b0: 6e6f 7469 6669 6572 3a20 6e6f 7469 6679  notifier: notify
+000041c0: 2e4d 6165 7374 7261 6c44 6573 6b74 6f70  .MaestralDesktop
+000041d0: 4e6f 7469 6669 6572 207c 204e 6f6e 6520  Notifier | None 
+000041e0: 3d20 4e6f 6e65 2c0a 2020 2020 2920 2d3e  = None,.    ) ->
+000041f0: 204e 6f6e 653a 0a20 2020 2020 2020 2073   None:.        s
+00004200: 656c 662e 636c 6965 6e74 203d 2063 6c69  elf.client = cli
+00004210: 656e 740a 2020 2020 2020 2020 7365 6c66  ent.        self
+00004220: 2e63 6f6e 6669 675f 6e61 6d65 203d 2073  .config_name = s
+00004230: 656c 662e 636c 6965 6e74 2e63 6f6e 6669  elf.client.confi
+00004240: 675f 6e61 6d65 0a20 2020 2020 2020 2073  g_name.        s
+00004250: 656c 662e 6673 5f65 7665 6e74 7320 3d20  elf.fs_events = 
+00004260: 4653 4576 656e 7448 616e 646c 6572 2829  FSEventHandler()
+00004270: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+00004280: 6f67 6765 7220 3d20 7363 6f70 6564 5f6c  ogger = scoped_l
+00004290: 6f67 6765 7228 5f5f 6e61 6d65 5f5f 2c20  ogger(__name__, 
+000042a0: 7365 6c66 2e63 6f6e 6669 675f 6e61 6d65  self.config_name
+000042b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000042c0: 5f63 6f6e 6620 3d20 4d61 6573 7472 616c  _conf = Maestral
+000042d0: 436f 6e66 6967 2873 656c 662e 636f 6e66  Config(self.conf
+000042e0: 6967 5f6e 616d 6529 0a20 2020 2020 2020  ig_name).       
+000042f0: 2073 656c 662e 5f73 7461 7465 203d 204d   self._state = M
+00004300: 6165 7374 7261 6c53 7461 7465 2873 656c  aestralState(sel
+00004310: 662e 636f 6e66 6967 5f6e 616d 6529 0a20  f.config_name). 
+00004320: 2020 2020 2020 2073 656c 662e 7265 6c6f         self.relo
+00004330: 6164 5f63 6163 6865 645f 636f 6e66 6967  ad_cached_config
+00004340: 2829 0a0a 2020 2020 2020 2020 7365 6c66  ()..        self
+00004350: 2e64 6573 6b74 6f70 5f6e 6f74 6966 6965  .desktop_notifie
+00004360: 7220 3d20 6465 736b 746f 705f 6e6f 7469  r = desktop_noti
+00004370: 6669 6572 0a0a 2020 2020 2020 2020 2320  fier..        # 
+00004380: 5379 6e63 6872 6f6e 697a 6174 696f 6e0a  Synchronization.
+00004390: 2020 2020 2020 2020 7365 6c66 2e73 796e          self.syn
+000043a0: 635f 6c6f 636b 203d 2052 4c6f 636b 2829  c_lock = RLock()
+000043b0: 2020 2320 5570 6c6f 6164 2061 6e64 2064    # Upload and d
+000043c0: 6f77 6e6c 6f61 6420 6379 636c 6573 2e0a  ownload cycles..
+000043d0: 2020 2020 2020 2020 7365 6c66 2e5f 6462          self._db
+000043e0: 5f6c 6f63 6b20 3d20 524c 6f63 6b28 2920  _lock = RLock() 
+000043f0: 2023 2044 4220 6163 6365 7373 2e0a 2020   # DB access..  
+00004400: 2020 2020 2020 7365 6c66 2e5f 7472 6565        self._tree
+00004410: 5f74 7261 7665 7273 616c 203d 2052 4c6f  _traversal = RLo
+00004420: 636b 2829 2020 2320 5379 6e63 2061 6374  ck()  # Sync act
+00004430: 6976 6974 7920 6163 726f 7373 206d 756c  ivity across mul
+00004440: 7469 706c 6520 6c65 7665 6c73 2e0a 2020  tiple levels..  
+00004450: 2020 2020 2020 6d61 785f 7061 7261 6c6c        max_parall
+00004460: 656c 5f64 6f77 6e6c 6f61 6473 203d 2073  el_downloads = s
+00004470: 656c 662e 5f63 6f6e 662e 6765 7428 2261  elf._conf.get("a
+00004480: 7070 222c 2022 6d61 785f 7061 7261 6c6c  pp", "max_parall
+00004490: 656c 5f75 706c 6f61 6473 2229 0a20 2020  el_uploads").   
+000044a0: 2020 2020 2073 656c 662e 5f70 6172 616c       self._paral
+000044b0: 6c65 6c5f 646f 776e 5f73 656d 6170 686f  lel_down_semapho
+000044c0: 7265 203d 2074 6872 6561 6469 6e67 2e53  re = threading.S
+000044d0: 656d 6170 686f 7265 286d 6178 5f70 6172  emaphore(max_par
+000044e0: 616c 6c65 6c5f 646f 776e 6c6f 6164 7329  allel_downloads)
+000044f0: 0a20 2020 2020 2020 206d 6178 5f70 6172  .        max_par
+00004500: 616c 6c65 6c5f 7570 6c6f 6164 7320 3d20  allel_uploads = 
+00004510: 7365 6c66 2e5f 636f 6e66 2e67 6574 2822  self._conf.get("
+00004520: 6170 7022 2c20 226d 6178 5f70 6172 616c  app", "max_paral
+00004530: 6c65 6c5f 7570 6c6f 6164 7322 290a 2020  lel_uploads").  
+00004540: 2020 2020 2020 7365 6c66 2e5f 7061 7261        self._para
+00004550: 6c6c 656c 5f75 705f 7365 6d61 7068 6f72  llel_up_semaphor
+00004560: 6520 3d20 7468 7265 6164 696e 672e 5365  e = threading.Se
+00004570: 6d61 7068 6f72 6528 6d61 785f 7061 7261  maphore(max_para
+00004580: 6c6c 656c 5f75 706c 6f61 6473 290a 0a20  llel_uploads).. 
+00004590: 2020 2020 2020 2023 2044 6174 6120 7374         # Data st
+000045a0: 7275 6374 7572 6573 2066 6f72 2069 6e74  ructures for int
+000045b0: 6572 6e61 6c20 636f 6d6d 756e 6963 6174  ernal communicat
+000045c0: 696f 6e2e 0a20 2020 2020 2020 2073 656c  ion..        sel
+000045d0: 662e 5f63 616e 6365 6c5f 7265 7175 6573  f._cancel_reques
+000045e0: 7465 6420 3d20 4576 656e 7428 290a 0a20  ted = Event().. 
+000045f0: 2020 2020 2020 2023 2044 6174 6120 7374         # Data st
+00004600: 7275 6374 7572 6573 2066 6f72 2075 7365  ructures for use
+00004610: 7220 696e 666f 726d 6174 696f 6e2e 0a20  r information.. 
+00004620: 2020 2020 2020 2073 656c 662e 6163 7469         self.acti
+00004630: 7669 7479 203d 2041 6374 6976 6974 7954  vity = ActivityT
+00004640: 7265 6528 290a 0a20 2020 2020 2020 2023  ree()..        #
+00004650: 2049 6e69 7469 616c 697a 6520 5351 4c69   Initialize SQLi
+00004660: 7465 2064 6174 6162 6173 652e 0a20 2020  te database..   
+00004670: 2020 2020 2073 656c 662e 5f64 625f 7061       self._db_pa
+00004680: 7468 203d 2067 6574 5f64 6174 615f 7061  th = get_data_pa
+00004690: 7468 2822 6d61 6573 7472 616c 222c 2066  th("maestral", f
+000046a0: 227b 7365 6c66 2e63 6f6e 6669 675f 6e61  "{self.config_na
+000046b0: 6d65 7d2e 6462 2229 0a0a 2020 2020 2020  me}.db")..      
+000046c0: 2020 6966 206e 6f74 2065 7869 7374 7328    if not exists(
+000046d0: 7365 6c66 2e5f 6462 5f70 6174 6829 3a0a  self._db_path):.
+000046e0: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+000046f0: 7365 7420 7468 6520 7379 6e63 2073 7461  set the sync sta
+00004700: 7465 2069 6620 4442 2069 7320 6d69 7373  te if DB is miss
+00004710: 696e 672e 0a20 2020 2020 2020 2020 2020  ing..           
+00004720: 2073 656c 662e 7265 6d6f 7465 5f63 7572   self.remote_cur
+00004730: 736f 7220 3d20 2222 0a20 2020 2020 2020  sor = "".       
+00004740: 2020 2020 2073 656c 662e 6c6f 6361 6c5f       self.local_
+00004750: 6375 7273 6f72 203d 2030 2e30 0a0a 2020  cursor = 0.0..  
+00004760: 2020 2020 2020 7365 6c66 2e5f 636f 6e6e        self._conn
+00004770: 6563 7469 6f6e 203d 2073 716c 6974 6533  ection = sqlite3
+00004780: 2e63 6f6e 6e65 6374 2873 656c 662e 5f64  .connect(self._d
+00004790: 625f 7061 7468 2c20 6368 6563 6b5f 7361  b_path, check_sa
+000047a0: 6d65 5f74 6872 6561 643d 4661 6c73 6529  me_thread=False)
+000047b0: 0a20 2020 2020 2020 2073 656c 662e 5f64  .        self._d
+000047c0: 6220 3d20 4461 7461 6261 7365 2873 656c  b = Database(sel
+000047d0: 662e 5f63 6f6e 6e65 6374 696f 6e29 0a0a  f._connection)..
+000047e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+000047f0: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
+00004800: 7265 6174 655f 6f72 5f6c 6f61 645f 6462  reate_or_load_db
+00004810: 2829 0a20 2020 2020 2020 2065 7863 6570  ().        excep
+00004820: 7420 4461 7461 6261 7365 4572 726f 723a  t DatabaseError:
+00004830: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
+00004840: 6561 6469 6e67 2074 6162 6c65 7320 6d61  eading tables ma
+00004850: 7920 6661 696c 2069 6620 7468 6520 4442  y fail if the DB
+00004860: 2077 6173 2063 6f72 7275 7074 6564 2e20   was corrupted. 
+00004870: 5468 6973 2073 686f 756c 6420 6861 7070  This should happ
+00004880: 656e 2076 6572 790a 2020 2020 2020 2020  en very.        
+00004890: 2020 2020 2320 7261 7265 6c79 2c20 7365      # rarely, se
+000048a0: 6520 6874 7470 733a 2f2f 7371 6c69 7465  e https://sqlite
+000048b0: 2e6f 7267 2f68 6f77 746f 636f 7272 7570  .org/howtocorrup
+000048c0: 742e 6874 6d6c 2e20 4174 7465 6d70 7420  t.html. Attempt 
+000048d0: 746f 2072 6563 6f76 6572 2062 790a 2020  to recover by.  
+000048e0: 2020 2020 2020 2020 2020 2320 6465 6c65            # dele
+000048f0: 7469 6e67 2044 4220 616e 6420 7265 7365  ting DB and rese
+00004900: 7474 696e 6720 7379 6e63 2073 7461 7465  tting sync state
+00004910: 2074 6f20 7472 6967 6765 7220 7265 696e   to trigger rein
+00004920: 6465 7869 6e67 2e0a 0a20 2020 2020 2020  dexing...       
+00004930: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+00004940: 722e 7761 726e 696e 6728 2244 6174 6162  r.warning("Datab
+00004950: 6173 6520 6572 726f 722c 2072 6573 6574  ase error, reset
+00004960: 7469 6e67 2073 796e 6320 7374 6174 6522  ting sync state"
+00004970: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
+00004980: 656c 662e 5f73 7461 7465 2e72 6573 6574  elf._state.reset
+00004990: 5f74 6f5f 6465 6661 756c 7473 2822 7379  _to_defaults("sy
+000049a0: 6e63 2229 0a20 2020 2020 2020 2020 2020  nc").           
+000049b0: 2073 656c 662e 7265 6c6f 6164 5f63 6163   self.reload_cac
+000049c0: 6865 645f 636f 6e66 6967 2829 0a20 2020  hed_config().   
+000049d0: 2020 2020 2020 2020 2064 656c 6574 6528           delete(
+000049e0: 7365 6c66 2e5f 6462 5f70 6174 6829 0a0a  self._db_path)..
+000049f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00004a00: 2e5f 6372 6561 7465 5f6f 725f 6c6f 6164  ._create_or_load
+00004a10: 5f64 6228 290a 0a20 2020 2020 2020 2023  _db()..        #
+00004a20: 2043 6163 6865 732e 0a20 2020 2020 2020   Caches..       
+00004a30: 2073 656c 662e 5f63 6173 655f 636f 6e76   self._case_conv
+00004a40: 6572 7369 6f6e 5f63 6163 6865 203d 204c  ersion_cache = L
+00004a50: 5255 4361 6368 6528 6361 7061 6369 7479  RUCache(capacity
+00004a60: 3d35 3030 3029 0a20 2020 2020 2020 2073  =5000).        s
+00004a70: 656c 662e 636c 6561 6e5f 6361 6368 655f  elf.clean_cache_
+00004a80: 6469 7228 7261 6973 655f 6572 726f 723d  dir(raise_error=
+00004a90: 4661 6c73 6529 0a0a 2020 2020 6465 6620  False)..    def 
+00004aa0: 5f63 7265 6174 655f 6f72 5f6c 6f61 645f  _create_or_load_
+00004ab0: 6462 2873 656c 6629 202d 3e20 4e6f 6e65  db(self) -> None
+00004ac0: 3a0a 2020 2020 2020 2020 7769 7468 2073  :.        with s
+00004ad0: 656c 662e 5f64 6174 6162 6173 655f 6163  elf._database_ac
+00004ae0: 6365 7373 2829 3a0a 2020 2020 2020 2020  cess():.        
+00004af0: 2020 2020 7365 6c66 2e5f 696e 6465 785f      self._index_
+00004b00: 7461 626c 6520 3d20 4d61 6e61 6765 7228  table = Manager(
+00004b10: 7365 6c66 2e5f 6462 2c20 496e 6465 7845  self._db, IndexE
+00004b20: 6e74 7279 290a 2020 2020 2020 2020 2020  ntry).          
+00004b30: 2020 7365 6c66 2e5f 6869 7374 6f72 795f    self._history_
+00004b40: 7461 626c 6520 3d20 4d61 6e61 6765 7228  table = Manager(
+00004b50: 7365 6c66 2e5f 6462 2c20 5379 6e63 4576  self._db, SyncEv
+00004b60: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
+00004b70: 2073 656c 662e 5f68 6173 685f 7461 626c   self._hash_tabl
+00004b80: 6520 3d20 4d61 6e61 6765 7228 7365 6c66  e = Manager(self
+00004b90: 2e5f 6462 2c20 4861 7368 4361 6368 6545  ._db, HashCacheE
+00004ba0: 6e74 7279 290a 2020 2020 2020 2020 2020  ntry).          
+00004bb0: 2020 7365 6c66 2e5f 7379 6e63 5f65 7272    self._sync_err
+00004bc0: 6f72 735f 7461 626c 6520 3d20 4d61 6e61  ors_table = Mana
+00004bd0: 6765 7228 7365 6c66 2e5f 6462 2c20 5379  ger(self._db, Sy
+00004be0: 6e63 4572 726f 7245 6e74 7279 290a 0a20  ncErrorEntry).. 
+00004bf0: 2020 2064 6566 2072 656c 6f61 645f 6361     def reload_ca
+00004c00: 6368 6564 5f63 6f6e 6669 6728 7365 6c66  ched_config(self
+00004c10: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00004c20: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
+00004c30: 656c 6f61 6473 2061 6c6c 2063 6f6e 6669  eloads all confi
+00004c40: 6720 616e 6420 7374 6174 6520 7661 6c75  g and state valu
+00004c50: 6573 2074 6861 7420 6172 6520 6f74 6865  es that are othe
+00004c60: 7277 6973 6520 6361 6368 6564 2062 7920  rwise cached by 
+00004c70: 7468 6973 2063 6c61 7373 2066 6f72 0a20  this class for. 
+00004c80: 2020 2020 2020 2066 6173 7465 7220 6163         faster ac
+00004c90: 6365 7373 2e20 4361 6c6c 2074 6869 7320  cess. Call this 
+00004ca0: 6d65 7468 6f64 2069 6620 636f 6e66 6967  method if config
+00004cb0: 206f 7220 7374 6174 6520 7661 6c75 6573   or state values
+00004cc0: 2077 6865 7265 206d 6f64 6966 6965 640a   where modified.
+00004cd0: 2020 2020 2020 2020 6469 7265 6374 6c79          directly
+00004ce0: 2069 6e73 7465 6164 206f 6620 7573 696e   instead of usin
+00004cf0: 6720 3a63 6c61 7373 3a60 5379 6e63 456e  g :class:`SyncEn
+00004d00: 6769 6e65 6020 4150 4973 2e0a 2020 2020  gine` APIs..    
+00004d10: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00004d20: 7365 6c66 2e5f 6472 6f70 626f 785f 7061  self._dropbox_pa
+00004d30: 7468 3a20 7374 7220 3d20 7365 6c66 2e5f  th: str = self._
+00004d40: 636f 6e66 2e67 6574 2822 7379 6e63 222c  conf.get("sync",
+00004d50: 2022 7061 7468 2229 0a20 2020 2020 2020   "path").       
+00004d60: 2073 656c 662e 5f6d 6967 6e6f 7265 5f70   self._mignore_p
+00004d70: 6174 683a 2073 7472 203d 206f 7370 2e6a  ath: str = osp.j
+00004d80: 6f69 6e28 7365 6c66 2e5f 6472 6f70 626f  oin(self._dropbo
+00004d90: 785f 7061 7468 2c20 4d49 474e 4f52 455f  x_path, MIGNORE_
+00004da0: 4649 4c45 290a 2020 2020 2020 2020 7365  FILE).        se
+00004db0: 6c66 2e5f 6669 6c65 5f63 6163 6865 5f70  lf._file_cache_p
+00004dc0: 6174 683a 2073 7472 203d 206f 7370 2e6a  ath: str = osp.j
+00004dd0: 6f69 6e28 7365 6c66 2e5f 6472 6f70 626f  oin(self._dropbo
+00004de0: 785f 7061 7468 2c20 4649 4c45 5f43 4143  x_path, FILE_CAC
+00004df0: 4845 290a 0a20 2020 2020 2020 2073 656c  HE)..        sel
+00004e00: 662e 5f65 7863 6c75 6465 645f 6974 656d  f._excluded_item
+00004e10: 733a 206c 6973 745b 7374 725d 203d 2073  s: list[str] = s
+00004e20: 656c 662e 5f63 6f6e 662e 6765 7428 2273  elf._conf.get("s
+00004e30: 796e 6322 2c20 2265 7863 6c75 6465 645f  ync", "excluded_
+00004e40: 6974 656d 7322 290a 2020 2020 2020 2020  items").        
+00004e50: 7365 6c66 2e5f 6d61 785f 6370 755f 7065  self._max_cpu_pe
+00004e60: 7263 656e 743a 2066 6c6f 6174 203d 2028  rcent: float = (
+00004e70: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00004e80: 662e 5f63 6f6e 662e 6765 7428 2273 796e  f._conf.get("syn
+00004e90: 6322 2c20 226d 6178 5f63 7075 5f70 6572  c", "max_cpu_per
+00004ea0: 6365 6e74 2229 202a 2043 5055 5f43 4f52  cent") * CPU_COR
+00004eb0: 455f 434f 554e 540a 2020 2020 2020 2020  E_COUNT.        
+00004ec0: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+00004ed0: 6c6f 6361 6c5f 6375 7273 6f72 3a20 666c  local_cursor: fl
+00004ee0: 6f61 7420 3d20 7365 6c66 2e5f 7374 6174  oat = self._stat
+00004ef0: 652e 6765 7428 2273 796e 6322 2c20 226c  e.get("sync", "l
+00004f00: 6173 7473 796e 6322 290a 0a20 2020 2020  astsync")..     
+00004f10: 2020 2073 656c 662e 5f69 735f 6673 5f63     self._is_fs_c
+00004f20: 6173 655f 7365 6e73 6974 6976 6520 3d20  ase_sensitive = 
+00004f30: 7365 6c66 2e5f 6368 6563 6b5f 6673 5f63  self._check_fs_c
+00004f40: 6173 655f 7365 6e73 6974 6976 6528 290a  ase_sensitive().
+00004f50: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+00004f60: 6164 5f6d 6967 6e6f 7265 5f66 696c 6528  ad_mignore_file(
+00004f70: 290a 0a20 2020 2064 6566 205f 6368 6563  )..    def _chec
+00004f80: 6b5f 6673 5f63 6173 655f 7365 6e73 6974  k_fs_case_sensit
+00004f90: 6976 6528 7365 6c66 2920 2d3e 2062 6f6f  ive(self) -> boo
+00004fa0: 6c3a 0a20 2020 2020 2020 2074 7279 3a0a  l:.        try:.
+00004fb0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00004fc0: 726e 2069 735f 6673 5f63 6173 655f 7365  rn is_fs_case_se
+00004fd0: 6e73 6974 6976 6528 7365 6c66 2e5f 6472  nsitive(self._dr
+00004fe0: 6f70 626f 785f 7061 7468 290a 2020 2020  opbox_path).    
+00004ff0: 2020 2020 6578 6365 7074 2028 4669 6c65      except (File
+00005000: 4e6f 7446 6f75 6e64 4572 726f 722c 204e  NotFoundError, N
+00005010: 6f74 4144 6972 6563 746f 7279 4572 726f  otADirectoryErro
+00005020: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+00005030: 2320 4661 6c6c 2062 6163 6b20 746f 2074  # Fall back to t
+00005040: 6865 2061 7373 756d 7074 696f 6e20 6f66  he assumption of
+00005050: 2061 2063 6173 652d 7365 6e73 6974 6976   a case-sensitiv
+00005060: 6520 6669 6c65 2073 7973 7465 6d2e 0a20  e file system.. 
+00005070: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00005080: 6e20 5472 7565 0a0a 2020 2020 2320 3d3d  n True..    # ==
+00005090: 3d3d 2043 6f6e 6669 6720 6163 6365 7373  == Config access
+000050a0: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+000050b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000050c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000050d0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000050e0: 0a0a 2020 2020 4070 726f 7065 7274 790a  ..    @property.
+000050f0: 2020 2020 6465 6620 6472 6f70 626f 785f      def dropbox_
+00005100: 7061 7468 2873 656c 6629 202d 3e20 7374  path(self) -> st
+00005110: 723a 0a20 2020 2020 2020 2022 2222 0a20  r:.        """. 
+00005120: 2020 2020 2020 2050 6174 6820 746f 206c         Path to l
+00005130: 6f63 616c 2044 726f 7062 6f78 2066 6f6c  ocal Dropbox fol
+00005140: 6465 722c 2061 7320 6c6f 6164 6564 2066  der, as loaded f
+00005150: 726f 6d20 7468 6520 636f 6e66 6967 2066  rom the config f
+00005160: 696c 652e 2042 6566 6f72 6520 6368 616e  ile. Before chan
+00005170: 6769 6e67 0a20 2020 2020 2020 203a 6174  ging.        :at
+00005180: 7472 3a60 6472 6f70 626f 785f 7061 7468  tr:`dropbox_path
+00005190: 602c 206d 616b 6520 7375 7265 2074 6861  `, make sure tha
+000051a0: 7420 7379 6e63 696e 6720 6973 2070 6175  t syncing is pau
+000051b0: 7365 642e 204d 6f76 6520 7468 6520 6472  sed. Move the dr
+000051c0: 6f70 626f 7820 666f 6c64 6572 0a20 2020  opbox folder.   
+000051d0: 2020 2020 2074 6f20 7468 6520 6e65 7720       to the new 
+000051e0: 6c6f 6361 7469 6f6e 2062 6566 6f72 6520  location before 
+000051f0: 7265 7375 6d69 6e67 2074 6865 2073 796e  resuming the syn
+00005200: 632e 2043 6861 6e67 6573 2061 7265 2073  c. Changes are s
+00005210: 6176 6564 2074 6f20 7468 6520 636f 6e66  aved to the conf
+00005220: 6967 0a20 2020 2020 2020 2066 696c 652e  ig.        file.
+00005230: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00005240: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00005250: 2e5f 6472 6f70 626f 785f 7061 7468 0a0a  ._dropbox_path..
+00005260: 2020 2020 4064 726f 7062 6f78 5f70 6174      @dropbox_pat
+00005270: 682e 7365 7474 6572 0a20 2020 2064 6566  h.setter.    def
+00005280: 2064 726f 7062 6f78 5f70 6174 6828 7365   dropbox_path(se
+00005290: 6c66 2c20 7061 7468 3a20 7374 7229 202d  lf, path: str) -
+000052a0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000052b0: 2222 2253 6574 7465 723a 2064 726f 7062  """Setter: dropb
+000052c0: 6f78 5f70 6174 6822 2222 0a0a 2020 2020  ox_path"""..    
+000052d0: 2020 2020 7061 7468 203d 206f 7370 2e72      path = osp.r
+000052e0: 6561 6c70 6174 6828 7061 7468 290a 0a20  ealpath(path).. 
+000052f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00005300: 2e73 796e 635f 6c6f 636b 3a0a 2020 2020  .sync_lock:.    
+00005310: 2020 2020 2020 2020 7365 6c66 2e5f 6472          self._dr
+00005320: 6f70 626f 785f 7061 7468 203d 2070 6174  opbox_path = pat
+00005330: 680a 2020 2020 2020 2020 2020 2020 7365  h.            se
+00005340: 6c66 2e5f 6d69 676e 6f72 655f 7061 7468  lf._mignore_path
+00005350: 203d 206f 7370 2e6a 6f69 6e28 7365 6c66   = osp.join(self
+00005360: 2e5f 6472 6f70 626f 785f 7061 7468 2c20  ._dropbox_path, 
+00005370: 4d49 474e 4f52 455f 4649 4c45 290a 2020  MIGNORE_FILE).  
+00005380: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00005390: 6669 6c65 5f63 6163 6865 5f70 6174 6820  file_cache_path 
+000053a0: 3d20 6f73 702e 6a6f 696e 2873 656c 662e  = osp.join(self.
+000053b0: 5f64 726f 7062 6f78 5f70 6174 682c 2046  _dropbox_path, F
+000053c0: 494c 455f 4341 4348 4529 0a20 2020 2020  ILE_CACHE).     
+000053d0: 2020 2020 2020 2073 656c 662e 5f63 6f6e         self._con
+000053e0: 662e 7365 7428 2273 796e 6322 2c20 2270  f.set("sync", "p
+000053f0: 6174 6822 2c20 7061 7468 290a 0a20 2020  ath", path)..   
+00005400: 2020 2020 2020 2020 2073 656c 662e 5f69           self._i
+00005410: 735f 6673 5f63 6173 655f 7365 6e73 6974  s_fs_case_sensit
+00005420: 6976 6520 3d20 7365 6c66 2e5f 6368 6563  ive = self._chec
+00005430: 6b5f 6673 5f63 6173 655f 7365 6e73 6974  k_fs_case_sensit
+00005440: 6976 6528 290a 0a20 2020 2040 7072 6f70  ive()..    @prop
+00005450: 6572 7479 0a20 2020 2064 6566 2069 735f  erty.    def is_
+00005460: 6673 5f63 6173 655f 7365 6e73 6974 6976  fs_case_sensitiv
+00005470: 6528 7365 6c66 2920 2d3e 2062 6f6f 6c3a  e(self) -> bool:
+00005480: 0a20 2020 2020 2020 2022 2222 5768 6574  .        """Whet
+00005490: 6865 7220 7468 6520 6c6f 6361 6c20 4472  her the local Dr
+000054a0: 6f70 626f 7820 6469 7265 6374 6f72 7920  opbox directory 
+000054b0: 6c69 6573 206f 6e20 6120 6361 7365 2d73  lies on a case-s
+000054c0: 656e 7369 7469 7665 2066 696c 6520 7379  ensitive file sy
+000054d0: 7374 656d 2e22 2222 0a20 2020 2020 2020  stem.""".       
+000054e0: 2072 6574 7572 6e20 7365 6c66 2e5f 6973   return self._is
+000054f0: 5f66 735f 6361 7365 5f73 656e 7369 7469  _fs_case_sensiti
+00005500: 7665 0a0a 2020 2020 4070 726f 7065 7274  ve..    @propert
+00005510: 790a 2020 2020 6465 6620 6461 7461 6261  y.    def databa
+00005520: 7365 5f70 6174 6828 7365 6c66 2920 2d3e  se_path(self) ->
+00005530: 2073 7472 3a0a 2020 2020 2020 2020 2222   str:.        ""
+00005540: 2250 6174 6820 5351 4c69 7465 2064 6174  "Path SQLite dat
+00005550: 6162 6173 652e 2222 220a 2020 2020 2020  abase.""".      
+00005560: 2020 7265 7475 726e 2073 656c 662e 5f64    return self._d
+00005570: 625f 7061 7468 0a0a 2020 2020 4070 726f  b_path..    @pro
+00005580: 7065 7274 790a 2020 2020 6465 6620 6669  perty.    def fi
+00005590: 6c65 5f63 6163 6865 5f70 6174 6828 7365  le_cache_path(se
+000055a0: 6c66 2920 2d3e 2073 7472 3a0a 2020 2020  lf) -> str:.    
+000055b0: 2020 2020 2222 2250 6174 6820 746f 2063      """Path to c
+000055c0: 6163 6865 2066 6f6c 6465 7220 666f 7220  ache folder for 
+000055d0: 7465 6d70 6f72 6172 7920 6669 6c65 7320  temporary files 
+000055e0: 2872 6561 6420 6f6e 6c79 292e 2054 6865  (read only). The
+000055f0: 2063 6163 6865 2066 6f6c 6465 720a 2020   cache folder.  
+00005600: 2020 2020 2020 272e 6d61 6573 7472 616c        '.maestral
+00005610: 2e63 6163 6865 2720 6973 206c 6f63 6174  .cache' is locat
+00005620: 6564 2069 6e73 6964 6520 7468 6520 6c6f  ed inside the lo
+00005630: 6361 6c20 4472 6f70 626f 7820 666f 6c64  cal Dropbox fold
+00005640: 6572 2074 6f20 7072 6576 656e 7420 6669  er to prevent fi
+00005650: 6c65 0a20 2020 2020 2020 2074 7261 6e73  le.        trans
+00005660: 6665 7220 6265 7477 6565 6e20 6469 6666  fer between diff
+00005670: 6572 656e 7420 7061 7274 6974 696f 6e73  erent partitions
+00005680: 206f 7220 6472 6976 6573 2064 7572 696e   or drives durin
+00005690: 6720 7379 6e63 2e22 2222 0a20 2020 2020  g sync.""".     
+000056a0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+000056b0: 6669 6c65 5f63 6163 6865 5f70 6174 680a  file_cache_path.
+000056c0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+000056d0: 2020 2064 6566 2065 7863 6c75 6465 645f     def excluded_
+000056e0: 6974 656d 7328 7365 6c66 2920 2d3e 206c  items(self) -> l
+000056f0: 6973 745b 7374 725d 3a0a 2020 2020 2020  ist[str]:.      
+00005700: 2020 2222 224c 6973 7420 6f66 2061 6c6c    """List of all
+00005710: 2066 696c 6573 2061 6e64 2066 6f6c 6465   files and folde
+00005720: 7273 2065 7863 6c75 6465 6420 6672 6f6d  rs excluded from
+00005730: 2073 796e 632e 2043 6861 6e67 6573 2061   sync. Changes a
+00005740: 7265 2073 6176 6564 2074 6f20 7468 650a  re saved to the.
+00005750: 2020 2020 2020 2020 636f 6e66 6967 2066          config f
+00005760: 696c 652e 2049 6620 6120 7061 7265 6e74  ile. If a parent
+00005770: 2066 6f6c 6465 7220 6973 2065 7863 6c75   folder is exclu
+00005780: 6465 642c 2069 7473 2063 6869 6c64 7265  ded, its childre
+00005790: 6e20 7769 6c6c 2061 7574 6f6d 6174 6963  n will automatic
+000057a0: 616c 6c79 2062 650a 2020 2020 2020 2020  ally be.        
+000057b0: 7265 6d6f 7665 6420 6672 6f6d 2074 6865  removed from the
+000057c0: 206c 6973 742e 2049 6620 6f6e 6c79 2063   list. If only c
+000057d0: 6869 6c64 7265 6e20 6172 6520 6769 7665  hildren are give
+000057e0: 6e20 6275 7420 6e6f 7420 7468 6520 7061  n but not the pa
+000057f0: 7265 6e74 2066 6f6c 6465 722c 2061 6e79  rent folder, any
+00005800: 0a20 2020 2020 2020 206e 6577 2069 7465  .        new ite
+00005810: 6d73 2061 6464 6564 2074 6f20 7468 6520  ms added to the 
+00005820: 7061 7265 6e74 2077 696c 6c20 6265 2073  parent will be s
+00005830: 796e 6365 642e 2043 6861 6e67 6520 7468  ynced. Change th
+00005840: 6973 2070 726f 7065 7274 7920 2a62 6566  is property *bef
+00005850: 6f72 652a 0a20 2020 2020 2020 2064 6f77  ore*.        dow
+00005860: 6e6c 6f61 6469 6e67 206e 6577 6c79 2069  nloading newly i
+00005870: 6e63 6c75 6465 6420 6974 656d 7320 6f72  ncluded items or
+00005880: 2064 656c 6574 696e 6720 6578 636c 7564   deleting exclud
+00005890: 6564 2069 7465 6d73 2e22 2222 0a20 2020  ed items.""".   
+000058a0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+000058b0: 2e5f 6578 636c 7564 6564 5f69 7465 6d73  ._excluded_items
+000058c0: 0a0a 2020 2020 4065 7863 6c75 6465 645f  ..    @excluded_
+000058d0: 6974 656d 732e 7365 7474 6572 0a20 2020  items.setter.   
+000058e0: 2064 6566 2065 7863 6c75 6465 645f 6974   def excluded_it
+000058f0: 656d 7328 7365 6c66 2c20 666f 6c64 6572  ems(self, folder
+00005900: 5f6c 6973 743a 206c 6973 745b 7374 725d  _list: list[str]
+00005910: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00005920: 2020 2022 2222 5365 7474 6572 3a20 6578     """Setter: ex
+00005930: 636c 7564 6564 5f69 7465 6d73 2222 220a  cluded_items""".
+00005940: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00005950: 662e 7379 6e63 5f6c 6f63 6b3a 0a20 2020  f.sync_lock:.   
+00005960: 2020 2020 2020 2020 2063 6c65 616e 5f6c           clean_l
+00005970: 6973 7420 3d20 7365 6c66 2e63 6c65 616e  ist = self.clean
+00005980: 5f65 7863 6c75 6465 645f 6974 656d 735f  _excluded_items_
+00005990: 6c69 7374 2866 6f6c 6465 725f 6c69 7374  list(folder_list
+000059a0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+000059b0: 6c66 2e5f 6578 636c 7564 6564 5f69 7465  lf._excluded_ite
+000059c0: 6d73 203d 2063 6c65 616e 5f6c 6973 740a  ms = clean_list.
+000059d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000059e0: 2e5f 636f 6e66 2e73 6574 2822 7379 6e63  ._conf.set("sync
+000059f0: 222c 2022 6578 636c 7564 6564 5f69 7465  ", "excluded_ite
+00005a00: 6d73 222c 2063 6c65 616e 5f6c 6973 7429  ms", clean_list)
+00005a10: 0a0a 2020 2020 4073 7461 7469 636d 6574  ..    @staticmet
+00005a20: 686f 640a 2020 2020 6465 6620 636c 6561  hod.    def clea
+00005a30: 6e5f 6578 636c 7564 6564 5f69 7465 6d73  n_excluded_items
+00005a40: 5f6c 6973 7428 666f 6c64 6572 5f6c 6973  _list(folder_lis
+00005a50: 743a 2043 6f6c 6c65 6374 696f 6e5b 7374  t: Collection[st
+00005a60: 725d 2920 2d3e 206c 6973 745b 7374 725d  r]) -> list[str]
+00005a70: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00005a80: 2020 2020 2020 5265 6d6f 7665 7320 616c        Removes al
+00005a90: 6c20 6475 706c 6963 6174 6573 2061 6e64  l duplicates and
+00005aa0: 2063 6869 6c64 7265 6e20 6f66 2065 7863   children of exc
+00005ab0: 6c75 6465 6420 6974 656d 7320 6672 6f6d  luded items from
+00005ac0: 2074 6865 2065 7863 6c75 6465 6420 6974   the excluded it
+00005ad0: 656d 730a 2020 2020 2020 2020 6c69 7374  ems.        list
+00005ae0: 2e20 4e6f 726d 616c 6973 6573 2061 6c6c  . Normalises all
+00005af0: 2070 6174 6873 2074 6f20 6c6f 7765 7220   paths to lower 
+00005b00: 6361 7365 2e0a 0a20 2020 2020 2020 203a  case...        :
+00005b10: 7061 7261 6d20 666f 6c64 6572 5f6c 6973  param folder_lis
+00005b20: 743a 2044 726f 7062 6f78 2070 6174 6873  t: Dropbox paths
+00005b30: 2074 6f20 6578 636c 7564 652e 0a20 2020   to exclude..   
+00005b40: 2020 2020 203a 7265 7475 726e 733a 2043       :returns: C
+00005b50: 6c65 616e 6564 2075 7020 6974 656d 732e  leaned up items.
+00005b60: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00005b70: 2020 2020 2023 2052 656d 6f76 6520 6475       # Remove du
+00005b80: 706c 6963 6174 6520 656e 7472 6965 7320  plicate entries 
+00005b90: 6279 2063 7265 6174 696e 6720 7365 742c  by creating set,
+00005ba0: 2073 7472 6970 2074 7261 696c 696e 6720   strip trailing 
+00005bb0: 272f 272e 0a20 2020 2020 2020 2066 6f6c  '/'..        fol
+00005bc0: 6465 725f 7365 7420 3d20 7b6e 6f72 6d61  der_set = {norma
+00005bd0: 6c69 7a65 2866 292e 7273 7472 6970 2822  lize(f).rstrip("
+00005be0: 2f22 2920 666f 7220 6620 696e 2066 6f6c  /") for f in fol
+00005bf0: 6465 725f 6c69 7374 7d0a 0a20 2020 2020  der_list}..     
+00005c00: 2020 2023 2052 656d 6f76 6520 616c 6c20     # Remove all 
+00005c10: 6368 696c 6472 656e 206f 6620 6578 636c  children of excl
+00005c20: 7564 6564 2066 6f6c 6465 7273 2e0a 2020  uded folders..  
+00005c30: 2020 2020 2020 636c 6561 6e5f 6c69 7374        clean_list
+00005c40: 203d 206c 6973 7428 666f 6c64 6572 5f73   = list(folder_s
+00005c50: 6574 290a 2020 2020 2020 2020 666f 7220  et).        for 
+00005c60: 666f 6c64 6572 2069 6e20 666f 6c64 6572  folder in folder
+00005c70: 5f73 6574 3a0a 2020 2020 2020 2020 2020  _set:.          
+00005c80: 2020 636c 6561 6e5f 6c69 7374 203d 205b    clean_list = [
+00005c90: 6620 666f 7220 6620 696e 2063 6c65 616e  f for f in clean
+00005ca0: 5f6c 6973 7420 6966 206e 6f74 2069 735f  _list if not is_
+00005cb0: 6368 696c 6428 662c 2066 6f6c 6465 7229  child(f, folder)
+00005cc0: 5d0a 0a20 2020 2020 2020 2072 6574 7572  ]..        retur
+00005cd0: 6e20 636c 6561 6e5f 6c69 7374 0a0a 2020  n clean_list..  
+00005ce0: 2020 4070 726f 7065 7274 790a 2020 2020    @property.    
+00005cf0: 6465 6620 6d61 785f 6370 755f 7065 7263  def max_cpu_perc
+00005d00: 656e 7428 7365 6c66 2920 2d3e 2066 6c6f  ent(self) -> flo
+00005d10: 6174 3a0a 2020 2020 2020 2020 2222 224d  at:.        """M
+00005d20: 6178 696d 756d 2043 5055 2075 7361 6765  aximum CPU usage
+00005d30: 2066 6f72 2070 6172 616c 6c65 6c20 646f   for parallel do
+00005d40: 776e 6c6f 6164 7320 6f72 2075 706c 6f61  wnloads or uploa
+00005d50: 6473 2069 6e20 7065 7263 656e 7420 6f66  ds in percent of
+00005d60: 2074 6865 2074 6f74 616c 0a20 2020 2020   the total.     
+00005d70: 2020 2061 7661 696c 6162 6c65 2043 5055     available CPU
+00005d80: 2074 696d 6520 7065 7220 636f 7265 2e20   time per core. 
+00005d90: 496e 6469 7669 6475 616c 2077 6f72 6b65  Individual worke
+00005da0: 7273 2069 6e20 6120 7468 7265 6164 2070  rs in a thread p
+00005db0: 6f6f 6c20 7769 6c6c 2070 6175 7365 0a20  ool will pause. 
+00005dc0: 2020 2020 2020 2075 6e74 696c 2074 6865         until the
+00005dd0: 2075 7361 6765 2064 726f 7073 2062 656c   usage drops bel
+00005de0: 6f77 2074 6869 7320 7661 6c75 652e 2054  ow this value. T
+00005df0: 6173 6b73 2069 6e20 7468 6520 6d61 696e  asks in the main
+00005e00: 2074 6872 6561 6420 7375 6368 2061 730a   thread such as.
+00005e10: 2020 2020 2020 2020 696e 6465 7869 6e67          indexing
+00005e20: 2066 696c 6520 6368 616e 6765 7320 6d61   file changes ma
+00005e30: 7920 7374 696c 6c20 7573 6520 6d6f 7265  y still use more
+00005e40: 2043 5055 2074 696d 652e 2053 6574 7469   CPU time. Setti
+00005e50: 6e67 2074 6869 7320 746f 2032 3030 2520  ng this to 200% 
+00005e60: 6d65 616e 730a 2020 2020 2020 2020 7468  means.        th
+00005e70: 6174 2074 776f 2066 756c 6c20 6c6f 6769  at two full logi
+00005e80: 6361 6c20 4350 5520 636f 7265 2063 616e  cal CPU core can
+00005e90: 2062 6520 7573 6564 2e22 2222 0a20 2020   be used.""".   
+00005ea0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
+00005eb0: 2e5f 6d61 785f 6370 755f 7065 7263 656e  ._max_cpu_percen
+00005ec0: 740a 0a20 2020 2040 6d61 785f 6370 755f  t..    @max_cpu_
+00005ed0: 7065 7263 656e 742e 7365 7474 6572 0a20  percent.setter. 
+00005ee0: 2020 2064 6566 206d 6178 5f63 7075 5f70     def max_cpu_p
+00005ef0: 6572 6365 6e74 2873 656c 662c 2070 6572  ercent(self, per
+00005f00: 6365 6e74 3a20 666c 6f61 7429 202d 3e20  cent: float) -> 
+00005f10: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+00005f20: 2253 6574 7465 723a 206d 6178 5f63 7075  "Setter: max_cpu
+00005f30: 5f70 6572 6365 6e74 2e22 2222 0a20 2020  _percent.""".   
+00005f40: 2020 2020 2073 656c 662e 5f6d 6178 5f63       self._max_c
+00005f50: 7075 5f70 6572 6365 6e74 203d 2070 6572  pu_percent = per
+00005f60: 6365 6e74 0a20 2020 2020 2020 2073 656c  cent.        sel
+00005f70: 662e 5f63 6f6e 662e 7365 7428 2273 796e  f._conf.set("syn
+00005f80: 6322 2c20 226d 6178 5f63 7075 5f70 6572  c", "max_cpu_per
+00005f90: 6365 6e74 222c 2070 6572 6365 6e74 202f  cent", percent /
+00005fa0: 2f20 4350 555f 434f 5245 5f43 4f55 4e54  / CPU_CORE_COUNT
+00005fb0: 290a 0a20 2020 2023 203d 3d3d 3d20 5379  )..    # ==== Sy
+00005fc0: 6e63 2073 7461 7465 203d 3d3d 3d3d 3d3d  nc state =======
+00005fd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005fe0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00005ff0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00006000: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a20 2020  ===========..   
+00006010: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
+00006020: 6566 2072 656d 6f74 655f 6375 7273 6f72  ef remote_cursor
+00006030: 2873 656c 6629 202d 3e20 7374 723a 0a20  (self) -> str:. 
+00006040: 2020 2020 2020 2022 2222 4375 7273 6f72         """Cursor
+00006050: 2066 726f 6d20 6c61 7374 2073 796e 6320   from last sync 
+00006060: 7769 7468 2072 656d 6f74 6520 4472 6f70  with remote Drop
+00006070: 626f 782e 2054 6865 2076 616c 7565 2069  box. The value i
+00006080: 7320 7570 6461 7465 6420 616e 6420 7361  s updated and sa
+00006090: 7665 6420 746f 0a20 2020 2020 2020 2074  ved to.        t
+000060a0: 6865 2063 6f6e 6669 6720 6669 6c65 206f  he config file o
+000060b0: 6e20 6576 6572 7920 7375 6363 6573 7366  n every successf
+000060c0: 756c 2064 6f77 6e6c 6f61 6420 6f66 2072  ul download of r
+000060d0: 656d 6f74 6520 6368 616e 6765 732e 2222  emote changes.""
+000060e0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+000060f0: 2073 656c 662e 5f73 7461 7465 2e67 6574   self._state.get
+00006100: 2822 7379 6e63 222c 2022 6375 7273 6f72  ("sync", "cursor
+00006110: 2229 0a0a 2020 2020 4072 656d 6f74 655f  ")..    @remote_
+00006120: 6375 7273 6f72 2e73 6574 7465 720a 2020  cursor.setter.  
+00006130: 2020 6465 6620 7265 6d6f 7465 5f63 7572    def remote_cur
+00006140: 736f 7228 7365 6c66 2c20 6375 7273 6f72  sor(self, cursor
+00006150: 3a20 7374 7229 202d 3e20 4e6f 6e65 3a0a  : str) -> None:.
+00006160: 2020 2020 2020 2020 2222 2253 6574 7465          """Sette
+00006170: 723a 206c 6173 745f 6375 7273 6f72 2222  r: last_cursor""
+00006180: 220a 2020 2020 2020 2020 7769 7468 2073  ".        with s
+00006190: 656c 662e 7379 6e63 5f6c 6f63 6b3a 0a20  elf.sync_lock:. 
+000061a0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000061b0: 5f73 7461 7465 2e73 6574 2822 7379 6e63  _state.set("sync
+000061c0: 222c 2022 6375 7273 6f72 222c 2063 7572  ", "cursor", cur
+000061d0: 736f 7229 0a0a 2020 2020 2020 2020 7365  sor)..        se
+000061e0: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
+000061f0: 2822 5265 6d6f 7465 2063 7572 736f 7220  ("Remote cursor 
+00006200: 7361 7665 643a 2025 7322 2c20 6375 7273  saved: %s", curs
+00006210: 6f72 290a 0a20 2020 2040 7072 6f70 6572  or)..    @proper
+00006220: 7479 0a20 2020 2064 6566 206c 6f63 616c  ty.    def local
+00006230: 5f63 7572 736f 7228 7365 6c66 2920 2d3e  _cursor(self) ->
+00006240: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
+00006250: 2222 2254 696d 6520 7374 616d 7020 6672  """Time stamp fr
+00006260: 6f6d 206c 6173 7420 7379 6e63 2077 6974  om last sync wit
+00006270: 6820 7265 6d6f 7465 2044 726f 7062 6f78  h remote Dropbox
+00006280: 2e20 5468 6520 7661 6c75 6520 6973 2075  . The value is u
+00006290: 7064 6174 6564 2061 6e64 2073 6176 6564  pdated and saved
+000062a0: 0a20 2020 2020 2020 2074 6f20 7468 6520  .        to the 
+000062b0: 636f 6e66 6967 2066 696c 6520 6f6e 2065  config file on e
+000062c0: 7665 7279 2073 7563 6365 7373 6675 6c20  very successful 
+000062d0: 7570 6c6f 6164 206f 6620 6c6f 6361 6c20  upload of local 
+000062e0: 6368 616e 6765 732e 2222 220a 2020 2020  changes.""".    
+000062f0: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00006300: 5f6c 6f63 616c 5f63 7572 736f 720a 0a20  _local_cursor.. 
+00006310: 2020 2040 6c6f 6361 6c5f 6375 7273 6f72     @local_cursor
+00006320: 2e73 6574 7465 720a 2020 2020 6465 6620  .setter.    def 
+00006330: 6c6f 6361 6c5f 6375 7273 6f72 2873 656c  local_cursor(sel
+00006340: 662c 206c 6173 745f 7379 6e63 3a20 666c  f, last_sync: fl
+00006350: 6f61 7429 202d 3e20 4e6f 6e65 3a0a 2020  oat) -> None:.  
+00006360: 2020 2020 2020 2222 2253 6574 7465 723a        """Setter:
+00006370: 206c 6f63 616c 5f63 7572 736f 7222 2222   local_cursor"""
+00006380: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00006390: 6c66 2e73 796e 635f 6c6f 636b 3a0a 2020  lf.sync_lock:.  
+000063a0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000063b0: 6c6f 6361 6c5f 6375 7273 6f72 203d 206c  local_cursor = l
+000063c0: 6173 745f 7379 6e63 0a20 2020 2020 2020  ast_sync.       
+000063d0: 2020 2020 2073 656c 662e 5f73 7461 7465       self._state
+000063e0: 2e73 6574 2822 7379 6e63 222c 2022 6c61  .set("sync", "la
+000063f0: 7374 7379 6e63 222c 206c 6173 745f 7379  stsync", last_sy
+00006400: 6e63 290a 0a20 2020 2020 2020 2073 656c  nc)..        sel
+00006410: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
+00006420: 224c 6f63 616c 2063 7572 736f 7220 7361  "Local cursor sa
+00006430: 7665 643a 2025 7322 2c20 6c61 7374 5f73  ved: %s", last_s
+00006440: 796e 6329 0a0a 2020 2020 4070 726f 7065  ync)..    @prope
+00006450: 7274 790a 2020 2020 6465 6620 6c61 7374  rty.    def last
+00006460: 5f63 6861 6e67 6528 7365 6c66 2920 2d3e  _change(self) ->
+00006470: 2066 6c6f 6174 3a0a 2020 2020 2020 2020   float:.        
+00006480: 2222 2254 6865 2074 696d 6520 7374 616d  """The time stam
+00006490: 7020 6f66 2074 6865 206c 6173 7420 6669  p of the last fi
+000064a0: 6c65 2063 6861 6e67 6520 6f72 2030 2e30  le change or 0.0
+000064b0: 2069 6620 7468 6572 6520 6172 6520 6e6f   if there are no
+000064c0: 2066 696c 6520 6368 616e 6765 7320 696e   file changes in
+000064d0: 0a20 2020 2020 2020 206f 7572 2068 6973  .        our his
+000064e0: 746f 7279 2e22 2222 0a20 2020 2020 2020  tory.""".       
+000064f0: 2077 6974 6820 7365 6c66 2e5f 6461 7461   with self._data
+00006500: 6261 7365 5f61 6363 6573 7328 293a 0a20  base_access():. 
+00006510: 2020 2020 2020 2020 2020 2072 6f77 203d             row =
+00006520: 2073 656c 662e 5f64 622e 6578 6563 7574   self._db.execut
+00006530: 6528 2253 454c 4543 5420 4d41 5828 6c61  e("SELECT MAX(la
+00006540: 7374 5f73 796e 6329 2046 524f 4d20 2769  st_sync) FROM 'i
+00006550: 6e64 6578 2722 292e 6665 7463 686f 6e65  ndex'").fetchone
+00006560: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+00006570: 6620 6e6f 7420 726f 773a 0a20 2020 2020  f not row:.     
+00006580: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00006590: 6e20 302e 300a 2020 2020 2020 2020 2020  n 0.0.          
+000065a0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+000065b0: 2020 2020 2020 2072 6574 7572 6e20 726f         return ro
+000065c0: 775b 305d 206f 7220 302e 300a 2020 2020  w[0] or 0.0.    
+000065d0: 2020 2020 2020 2020 6578 6365 7074 2049          except I
+000065e0: 6e64 6578 4572 726f 723a 0a20 2020 2020  ndexError:.     
+000065f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00006600: 6e20 302e 300a 0a20 2020 2040 7072 6f70  n 0.0..    @prop
+00006610: 6572 7479 0a20 2020 2064 6566 206c 6173  erty.    def las
+00006620: 745f 7265 696e 6465 7828 7365 6c66 2920  t_reindex(self) 
+00006630: 2d3e 2066 6c6f 6174 3a0a 2020 2020 2020  -> float:.      
+00006640: 2020 2222 2254 696d 6520 7374 616d 7020    """Time stamp 
+00006650: 6f66 206c 6173 7420 6675 6c6c 2069 6e64  of last full ind
+00006660: 6578 696e 672e 2054 6869 7320 6973 2075  exing. This is u
+00006670: 7365 6420 746f 2064 6574 6572 6d69 6e65  sed to determine
+00006680: 2077 6865 6e20 7468 6520 6e65 7874 0a20   when the next. 
+00006690: 2020 2020 2020 2066 756c 6c20 696e 6465         full inde
+000066a0: 7869 6e67 2073 686f 756c 6420 7461 6b65  xing should take
+000066b0: 2070 6c61 6365 2e22 2222 0a20 2020 2020   place.""".     
+000066c0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+000066d0: 7374 6174 652e 6765 7428 2273 796e 6322  state.get("sync"
+000066e0: 2c20 226c 6173 745f 7265 696e 6465 7822  , "last_reindex"
+000066f0: 290a 0a20 2020 2064 6566 2067 6574 5f68  )..    def get_h
+00006700: 6973 746f 7279 2873 656c 662c 2064 6278  istory(self, dbx
+00006710: 5f70 6174 683a 2073 7472 207c 204e 6f6e  _path: str | Non
+00006720: 6520 3d20 4e6f 6e65 2920 2d3e 206c 6973  e = None) -> lis
+00006730: 745b 5379 6e63 4576 656e 745d 3a0a 2020  t[SyncEvent]:.  
+00006740: 2020 2020 2020 2222 2241 206c 6973 7420        """A list 
+00006750: 6f66 2074 6865 206c 6173 7420 5379 6e63  of the last Sync
+00006760: 4576 656e 7473 2069 6e20 6f75 7220 6869  Events in our hi
+00006770: 7374 6f72 792e 2048 6973 746f 7279 2077  story. History w
+00006780: 696c 6c20 6265 206b 6570 7420 666f 7220  ill be kept for 
+00006790: 7468 650a 2020 2020 2020 2020 696e 7465  the.        inte
+000067a0: 7276 616c 2073 7065 6369 6669 6564 2062  rval specified b
+000067b0: 7920 7468 6520 636f 6e66 6967 2076 616c  y the config val
+000067c0: 7565 2060 606b 6565 705f 6869 7374 6f72  ue ``keep_histor
+000067d0: 7960 6020 2864 6566 6175 6c74 7320 746f  y`` (defaults to
+000067e0: 2074 776f 2077 6565 6b73 290a 2020 2020   two weeks).    
+000067f0: 2020 2020 6275 7420 6174 206d 6f73 7420      but at most 
+00006800: 312c 3030 3020 6576 656e 7473 2077 696c  1,000 events wil
+00006810: 6c20 6265 206b 6570 742e 2222 220a 2020  l be kept.""".  
+00006820: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00006830: 5f64 6174 6162 6173 655f 6163 6365 7373  _database_access
+00006840: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00006850: 7175 6572 793a 2051 7565 7279 0a20 2020  query: Query.   
+00006860: 2020 2020 2020 2020 2069 6620 6462 785f           if dbx_
+00006870: 7061 7468 2069 7320 4e6f 6e65 3a0a 2020  path is None:.  
+00006880: 2020 2020 2020 2020 2020 2020 2020 7175                qu
+00006890: 6572 7920 3d20 416c 6c51 7565 7279 2829  ery = AllQuery()
+000068a0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+000068b0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+000068c0: 2020 2071 7565 7279 203d 204d 6174 6368     query = Match
+000068d0: 5175 6572 7928 5379 6e63 4576 656e 742e  Query(SyncEvent.
+000068e0: 6462 785f 7061 7468 2c20 6462 785f 7061  dbx_path, dbx_pa
+000068f0: 7468 290a 0a20 2020 2020 2020 2020 2020  th)..           
+00006900: 206f 7264 6572 5f65 7870 7220 3d20 2249   order_expr = "I
+00006910: 464e 554c 4c28 6368 616e 6765 5f74 696d  FNULL(change_tim
+00006920: 652c 2073 796e 635f 7469 6d65 2922 0a20  e, sync_time)". 
+00006930: 2020 2020 2020 2020 2020 2073 796e 635f             sync_
+00006940: 6576 656e 7473 203d 2073 656c 662e 5f68  events = self._h
+00006950: 6973 746f 7279 5f74 6162 6c65 2e73 656c  istory_table.sel
+00006960: 6563 7428 7175 6572 792e 6f72 6465 725f  ect(query.order_
+00006970: 6279 286f 7264 6572 5f65 7870 7229 290a  by(order_expr)).
+00006980: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00006990: 726e 2073 796e 635f 6576 656e 7473 0a0a  rn sync_events..
+000069a0: 2020 2020 6465 6620 7265 7365 745f 7379      def reset_sy
+000069b0: 6e63 5f73 7461 7465 2873 656c 6629 202d  nc_state(self) -
+000069c0: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+000069d0: 2222 2252 6573 6574 7320 616c 6c20 7361  """Resets all sa
+000069e0: 7665 6420 7379 6e63 2073 7461 7465 2e20  ved sync state. 
+000069f0: 5365 7474 696e 6773 2061 7265 206e 6f74  Settings are not
+00006a00: 2061 6666 6563 7465 642e 2222 220a 2020   affected.""".  
+00006a10: 2020 2020 2020 6966 2073 656c 662e 6275        if self.bu
+00006a20: 7379 2829 3a0a 2020 2020 2020 2020 2020  sy():.          
+00006a30: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+00006a40: 7272 6f72 2822 4361 6e6e 6f74 2072 6573  rror("Cannot res
+00006a50: 6574 2073 796e 6320 7374 6174 6520 7768  et sync state wh
+00006a60: 696c 6520 7379 6e63 696e 672e 2229 0a0a  ile syncing.")..
+00006a70: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00006a80: 662e 5f64 6174 6162 6173 655f 6163 6365  f._database_acce
+00006a90: 7373 2829 3a0a 2020 2020 2020 2020 2020  ss():.          
+00006aa0: 2020 7365 6c66 2e5f 696e 6465 785f 7461    self._index_ta
+00006ab0: 626c 652e 636c 6561 7228 290a 2020 2020  ble.clear().    
+00006ac0: 2020 2020 2020 2020 7365 6c66 2e5f 6869          self._hi
+00006ad0: 7374 6f72 795f 7461 626c 652e 636c 6561  story_table.clea
+00006ae0: 7228 290a 2020 2020 2020 2020 2020 2020  r().            
+00006af0: 7365 6c66 2e5f 7379 6e63 5f65 7272 6f72  self._sync_error
+00006b00: 735f 7461 626c 652e 636c 6561 7228 290a  s_table.clear().
+00006b10: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00006b20: 2e5f 6861 7368 5f74 6162 6c65 2e63 6c65  ._hash_table.cle
+00006b30: 6172 2829 0a0a 2020 2020 2020 2020 7365  ar()..        se
+00006b40: 6c66 2e5f 7374 6174 652e 7265 7365 745f  lf._state.reset_
+00006b50: 746f 5f64 6566 6175 6c74 7328 2273 796e  to_defaults("syn
+00006b60: 6322 290a 2020 2020 2020 2020 7365 6c66  c").        self
+00006b70: 2e72 656c 6f61 645f 6361 6368 6564 5f63  .reload_cached_c
+00006b80: 6f6e 6669 6728 290a 0a20 2020 2020 2020  onfig()..       
+00006b90: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
+00006ba0: 6275 6728 2253 796e 6320 7374 6174 6520  bug("Sync state 
+00006bb0: 7265 7365 7422 290a 0a20 2020 2023 203d  reset")..    # =
+00006bc0: 3d3d 3d20 5379 6e63 2065 7272 6f72 206d  === Sync error m
+00006bd0: 616e 6167 656d 656e 7420 3d3d 3d3d 3d3d  anagement ======
+00006be0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00006bf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00006c00: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00006c10: 3d0a 0a20 2020 2040 7072 6f70 6572 7479  =..    @property
+00006c20: 0a20 2020 2064 6566 2073 796e 635f 6572  .    def sync_er
+00006c30: 726f 7273 2873 656c 6629 202d 3e20 6c69  rors(self) -> li
+00006c40: 7374 5b53 796e 6345 7272 6f72 456e 7472  st[SyncErrorEntr
+00006c50: 795d 3a0a 2020 2020 2020 2020 2222 2252  y]:.        """R
+00006c60: 6574 7572 6e73 2061 206c 6973 7420 6f66  eturns a list of
+00006c70: 2061 6c6c 2073 796e 6320 6572 726f 7273   all sync errors
+00006c80: 2e22 2222 0a20 2020 2020 2020 2077 6974  .""".        wit
+00006c90: 6820 7365 6c66 2e5f 6461 7461 6261 7365  h self._database
+00006ca0: 5f61 6363 6573 7328 293a 0a20 2020 2020  _access():.     
+00006cb0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00006cc0: 6c66 2e5f 7379 6e63 5f65 7272 6f72 735f  lf._sync_errors_
+00006cd0: 7461 626c 652e 7365 6c65 6374 2841 6c6c  table.select(All
+00006ce0: 5175 6572 7928 2929 0a0a 2020 2020 4070  Query())..    @p
+00006cf0: 726f 7065 7274 790a 2020 2020 6465 6620  roperty.    def 
+00006d00: 7570 6c6f 6164 5f65 7272 6f72 7328 7365  upload_errors(se
+00006d10: 6c66 2920 2d3e 206c 6973 745b 5379 6e63  lf) -> list[Sync
+00006d20: 4572 726f 7245 6e74 7279 5d3a 0a20 2020  ErrorEntry]:.   
+00006d30: 2020 2020 2022 2222 5265 7475 726e 7320       """Returns 
+00006d40: 6120 6c69 7374 206f 6620 616c 6c20 7570  a list of all up
+00006d50: 6c6f 6164 2065 7272 6f72 732e 2222 220a  load errors.""".
+00006d60: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00006d70: 662e 5f64 6174 6162 6173 655f 6163 6365  f._database_acce
+00006d80: 7373 2829 3a0a 2020 2020 2020 2020 2020  ss():.          
+00006d90: 2020 7175 6572 7920 3d20 4d61 7463 6851    query = MatchQ
+00006da0: 7565 7279 2853 796e 6345 7272 6f72 456e  uery(SyncErrorEn
+00006db0: 7472 792e 6469 7265 6374 696f 6e2c 2053  try.direction, S
+00006dc0: 796e 6344 6972 6563 7469 6f6e 2e55 7029  yncDirection.Up)
+00006dd0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00006de0: 7572 6e20 7365 6c66 2e5f 7379 6e63 5f65  urn self._sync_e
+00006df0: 7272 6f72 735f 7461 626c 652e 7365 6c65  rrors_table.sele
+00006e00: 6374 2871 7565 7279 290a 0a20 2020 2040  ct(query)..    @
+00006e10: 7072 6f70 6572 7479 0a20 2020 2064 6566  property.    def
+00006e20: 2064 6f77 6e6c 6f61 645f 6572 726f 7273   download_errors
+00006e30: 2873 656c 6629 202d 3e20 6c69 7374 5b53  (self) -> list[S
+00006e40: 796e 6345 7272 6f72 456e 7472 795d 3a0a  yncErrorEntry]:.
+00006e50: 2020 2020 2020 2020 2222 2252 6574 7572          """Retur
+00006e60: 6e73 2061 206c 6973 7420 6f66 2061 6c6c  ns a list of all
+00006e70: 2064 6f77 6e6c 6f61 6420 6572 726f 7273   download errors
+00006e80: 2e22 2222 0a20 2020 2020 2020 2077 6974  .""".        wit
+00006e90: 6820 7365 6c66 2e5f 6461 7461 6261 7365  h self._database
+00006ea0: 5f61 6363 6573 7328 293a 0a20 2020 2020  _access():.     
+00006eb0: 2020 2020 2020 2071 7565 7279 203d 204d         query = M
+00006ec0: 6174 6368 5175 6572 7928 5379 6e63 4572  atchQuery(SyncEr
+00006ed0: 726f 7245 6e74 7279 2e64 6972 6563 7469  rorEntry.directi
+00006ee0: 6f6e 2c20 5379 6e63 4469 7265 6374 696f  on, SyncDirectio
+00006ef0: 6e2e 446f 776e 290a 2020 2020 2020 2020  n.Down).        
+00006f00: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+00006f10: 5f73 796e 635f 6572 726f 7273 5f74 6162  _sync_errors_tab
+00006f20: 6c65 2e73 656c 6563 7428 7175 6572 7929  le.select(query)
+00006f30: 0a0a 2020 2020 6465 6620 6861 735f 7379  ..    def has_sy
+00006f40: 6e63 5f65 7272 6f72 7328 7365 6c66 2920  nc_errors(self) 
+00006f50: 2d3e 2062 6f6f 6c3a 0a20 2020 2020 2020  -> bool:.       
+00006f60: 2022 2222 5265 7475 726e 7320 6060 5472   """Returns ``Tr
+00006f70: 7565 6060 2069 6e20 6361 7365 206f 6620  ue`` in case of 
+00006f80: 7379 6e63 2065 7272 6f72 732c 2060 6046  sync errors, ``F
+00006f90: 616c 7365 6060 206f 7468 6572 7769 7365  alse`` otherwise
+00006fa0: 2e22 2222 0a20 2020 2020 2020 2077 6974  .""".        wit
+00006fb0: 6820 7365 6c66 2e5f 6461 7461 6261 7365  h self._database
+00006fc0: 5f61 6363 6573 7328 293a 0a20 2020 2020  _access():.     
+00006fd0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
+00006fe0: 6c66 2e5f 7379 6e63 5f65 7272 6f72 735f  lf._sync_errors_
+00006ff0: 7461 626c 652e 636f 756e 7428 2920 3e20  table.count() > 
+00007000: 300a 0a20 2020 2064 6566 2073 796e 635f  0..    def sync_
+00007010: 6572 726f 7273 5f66 6f72 5f70 6174 6828  errors_for_path(
+00007020: 0a20 2020 2020 2020 2073 656c 662c 2064  .        self, d
+00007030: 6278 5f70 6174 685f 6c6f 7765 723a 2073  bx_path_lower: s
+00007040: 7472 2c20 6469 7265 6374 696f 6e3a 2053  tr, direction: S
+00007050: 796e 6344 6972 6563 7469 6f6e 207c 204e  yncDirection | N
+00007060: 6f6e 6520 3d20 4e6f 6e65 0a20 2020 2029  one = None.    )
+00007070: 202d 3e20 6c69 7374 5b53 796e 6345 7272   -> list[SyncErr
+00007080: 6f72 456e 7472 795d 3a0a 2020 2020 2020  orEntry]:.      
+00007090: 2020 2222 220a 2020 2020 2020 2020 5265    """.        Re
+000070a0: 7475 726e 7320 6120 6c69 7374 206f 6620  turns a list of 
+000070b0: 616c 6c20 7379 6e63 2065 7272 6f72 7320  all sync errors 
+000070c0: 666f 7220 7468 6520 6769 7665 6e20 7061  for the given pa
+000070d0: 7468 2061 6e64 2069 7473 2063 6869 6c64  th and its child
+000070e0: 7265 6e2e 0a0a 2020 2020 2020 2020 3a70  ren...        :p
+000070f0: 6172 616d 2064 6278 5f70 6174 685f 6c6f  aram dbx_path_lo
+00007100: 7765 723a 204e 6f72 6d61 6c69 7365 6420  wer: Normalised 
+00007110: 4472 6f70 626f 7820 7061 7468 2e0a 2020  Dropbox path..  
+00007120: 2020 2020 2020 3a70 6172 616d 2064 6972        :param dir
+00007130: 6563 7469 6f6e 3a20 4469 7265 6374 696f  ection: Directio
+00007140: 6e20 746f 2066 696c 7465 7220 7379 6e63  n to filter sync
+00007150: 2065 7272 6f72 732e 2049 6620 6e6f 7420   errors. If not 
+00007160: 6769 7665 6e2c 2062 6f74 6820 7570 6c6f  given, both uplo
+00007170: 6164 0a20 2020 2020 2020 2020 2020 2061  ad.            a
+00007180: 6e64 2064 6f77 6e6c 6f61 6420 6572 726f  nd download erro
+00007190: 7273 2077 696c 6c20 6265 2072 6574 7572  rs will be retur
+000071a0: 6e65 642e 0a20 2020 2020 2020 203a 7265  ned..        :re
+000071b0: 7475 726e 733a 204c 6973 7420 6f66 2073  turns: List of s
+000071c0: 796e 6320 6572 726f 7273 2e0a 2020 2020  ync errors..    
+000071d0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+000071e0: 7769 7468 2073 656c 662e 5f64 6174 6162  with self._datab
+000071f0: 6173 655f 6163 6365 7373 2829 3a0a 2020  ase_access():.  
+00007200: 2020 2020 2020 2020 2020 7061 7468 5f74            path_t
+00007210: 7265 655f 7175 6572 7920 3d20 5061 7468  ree_query = Path
+00007220: 5472 6565 5175 6572 7928 0a20 2020 2020  TreeQuery(.     
+00007230: 2020 2020 2020 2020 2020 2053 796e 6345             SyncE
+00007240: 7272 6f72 456e 7472 792e 6462 785f 7061  rrorEntry.dbx_pa
+00007250: 7468 5f6c 6f77 6572 2c20 6462 785f 7061  th_lower, dbx_pa
+00007260: 7468 5f6c 6f77 6572 0a20 2020 2020 2020  th_lower.       
+00007270: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00007280: 2020 2020 6966 2064 6972 6563 7469 6f6e      if direction
+00007290: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000072a0: 2020 6469 7265 6374 696f 6e5f 7175 6572    direction_quer
+000072b0: 7920 3d20 4d61 7463 6851 7565 7279 2853  y = MatchQuery(S
+000072c0: 796e 6345 7272 6f72 456e 7472 792e 6469  yncErrorEntry.di
+000072d0: 7265 6374 696f 6e2c 2064 6972 6563 7469  rection, directi
+000072e0: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+000072f0: 2020 2020 6a6f 696e 745f 7175 6572 7920      joint_query 
+00007300: 3d20 416e 6451 7565 7279 2870 6174 685f  = AndQuery(path_
+00007310: 7472 6565 5f71 7565 7279 2c20 6469 7265  tree_query, dire
+00007320: 6374 696f 6e5f 7175 6572 7929 0a20 2020  ction_query).   
+00007330: 2020 2020 2020 2020 2020 2020 2065 7272               err
+00007340: 6f72 7320 3d20 7365 6c66 2e5f 7379 6e63  ors = self._sync
+00007350: 5f65 7272 6f72 735f 7461 626c 652e 7365  _errors_table.se
+00007360: 6c65 6374 286a 6f69 6e74 5f71 7565 7279  lect(joint_query
+00007370: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00007380: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00007390: 2020 2020 6572 726f 7273 203d 2073 656c      errors = sel
+000073a0: 662e 5f73 796e 635f 6572 726f 7273 5f74  f._sync_errors_t
+000073b0: 6162 6c65 2e73 656c 6563 7428 7061 7468  able.select(path
+000073c0: 5f74 7265 655f 7175 6572 7929 0a0a 2020  _tree_query)..  
+000073d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
+000073e0: 2065 7272 6f72 730a 0a20 2020 2064 6566   errors..    def
+000073f0: 2063 6c65 6172 5f73 796e 635f 6572 726f   clear_sync_erro
+00007400: 7273 5f66 6f72 5f70 6174 6828 0a20 2020  rs_for_path(.   
+00007410: 2020 2020 2073 656c 662c 2064 6278 5f70       self, dbx_p
+00007420: 6174 685f 6c6f 7765 723a 2073 7472 2c20  ath_lower: str, 
+00007430: 7265 6375 7273 6976 653a 2062 6f6f 6c20  recursive: bool 
+00007440: 3d20 4661 6c73 650a 2020 2020 2920 2d3e  = False.    ) ->
+00007450: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+00007460: 2222 0a20 2020 2020 2020 2043 6c65 6172  "".        Clear
+00007470: 2061 6c6c 2073 796e 6320 6572 726f 7273   all sync errors
+00007480: 2066 6f72 2061 2070 6174 6820 6166 7465   for a path afte
+00007490: 7220 6120 7375 6363 6573 7366 756c 2073  r a successful s
+000074a0: 796e 6320 6576 656e 742e 0a0a 2020 2020  ync event...    
+000074b0: 2020 2020 3a70 6172 616d 2064 6278 5f70      :param dbx_p
+000074c0: 6174 685f 6c6f 7765 723a 204e 6f72 6d61  ath_lower: Norma
+000074d0: 6c69 7365 6420 4472 6f70 626f 7820 7061  lised Dropbox pa
+000074e0: 7468 2074 6f20 636c 6561 722e 0a20 2020  th to clear..   
+000074f0: 2020 2020 203a 7061 7261 6d20 7265 6375       :param recu
+00007500: 7273 6976 653a 2057 6865 7468 6572 2074  rsive: Whether t
+00007510: 6f20 636c 6561 7220 7379 6e63 2065 7272  o clear sync err
+00007520: 6f72 7320 666f 7220 6368 696c 6472 656e  ors for children
+00007530: 206f 6620 7468 6520 6769 7665 6e20 7061   of the given pa
+00007540: 7468 2e0a 2020 2020 2020 2020 2222 220a  th..        """.
+00007550: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00007560: 662e 5f64 6174 6162 6173 655f 6163 6365  f._database_acce
+00007570: 7373 2829 3a0a 2020 2020 2020 2020 2020  ss():.          
+00007580: 2020 7365 6c66 2e5f 7379 6e63 5f65 7272    self._sync_err
+00007590: 6f72 735f 7461 626c 652e 6465 6c65 7465  ors_table.delete
+000075a0: 5f70 7269 6d61 7279 5f6b 6579 2864 6278  _primary_key(dbx
+000075b0: 5f70 6174 685f 6c6f 7765 7229 0a0a 2020  _path_lower)..  
+000075c0: 2020 2020 2020 2020 2020 6966 2072 6563            if rec
+000075d0: 7572 7369 7665 3a0a 2020 2020 2020 2020  ursive:.        
+000075e0: 2020 2020 2020 2020 7175 6572 7920 3d20          query = 
+000075f0: 5061 7468 5472 6565 5175 6572 7928 5379  PathTreeQuery(Sy
+00007600: 6e63 4572 726f 7245 6e74 7279 2e64 6278  ncErrorEntry.dbx
+00007610: 5f70 6174 685f 6c6f 7765 722c 2064 6278  _path_lower, dbx
+00007620: 5f70 6174 685f 6c6f 7765 7229 0a20 2020  _path_lower).   
+00007630: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00007640: 662e 5f73 796e 635f 6572 726f 7273 5f74  f._sync_errors_t
+00007650: 6162 6c65 2e64 656c 6574 6528 7175 6572  able.delete(quer
+00007660: 7929 0a0a 2020 2020 6465 6620 636c 6561  y)..    def clea
+00007670: 725f 7379 6e63 5f65 7272 6f72 735f 6672  r_sync_errors_fr
+00007680: 6f6d 5f65 7665 6e74 2873 656c 662c 2065  om_event(self, e
+00007690: 7665 6e74 3a20 5379 6e63 4576 656e 7429  vent: SyncEvent)
+000076a0: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+000076b0: 2020 2222 2243 6c65 6172 7320 7379 6e63    """Clears sync
+000076c0: 2065 7272 6f72 7320 636f 7272 6573 706f   errors correspo
+000076d0: 6e64 696e 6720 746f 2061 2073 796e 6320  nding to a sync 
+000076e0: 6576 656e 742e 2222 220a 2020 2020 2020  event.""".      
+000076f0: 2020 7265 6375 7273 6976 6520 3d20 6576    recursive = ev
+00007700: 656e 742e 6973 5f6d 6f76 6564 206f 7220  ent.is_moved or 
+00007710: 6576 656e 742e 6973 5f64 656c 6574 6564  event.is_deleted
+00007720: 206f 7220 6576 656e 742e 6973 5f66 696c   or event.is_fil
+00007730: 650a 0a20 2020 2020 2020 2073 656c 662e  e..        self.
+00007740: 636c 6561 725f 7379 6e63 5f65 7272 6f72  clear_sync_error
+00007750: 735f 666f 725f 7061 7468 2865 7665 6e74  s_for_path(event
+00007760: 2e64 6278 5f70 6174 685f 6c6f 7765 722c  .dbx_path_lower,
+00007770: 2072 6563 7572 7369 7665 290a 2020 2020   recursive).    
+00007780: 2020 2020 6966 2065 7665 6e74 2e64 6278      if event.dbx
+00007790: 5f70 6174 685f 6672 6f6d 5f6c 6f77 6572  _path_from_lower
+000077a0: 2069 7320 6e6f 7420 4e6f 6e65 3a0a 2020   is not None:.  
+000077b0: 2020 2020 2020 2020 2020 7365 6c66 2e63            self.c
+000077c0: 6c65 6172 5f73 796e 635f 6572 726f 7273  lear_sync_errors
+000077d0: 5f66 6f72 5f70 6174 6828 6576 656e 742e  _for_path(event.
+000077e0: 6462 785f 7061 7468 5f66 726f 6d5f 6c6f  dbx_path_from_lo
+000077f0: 7765 722c 2072 6563 7572 7369 7665 290a  wer, recursive).
+00007800: 0a20 2020 2023 203d 3d3d 3d20 496e 6465  .    # ==== Inde
+00007810: 7820 6163 6365 7373 2061 6e64 206d 616e  x access and man
+00007820: 6167 656d 656e 7420 3d3d 3d3d 3d3d 3d3d  agement ========
+00007830: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00007840: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00007850: 3d3d 3d3d 3d3d 3d3d 3d0a 0a20 2020 2064  =========..    d
+00007860: 6566 2067 6574 5f69 6e64 6578 2873 656c  ef get_index(sel
+00007870: 6629 202d 3e20 6c69 7374 5b49 6e64 6578  f) -> list[Index
+00007880: 456e 7472 795d 3a0a 2020 2020 2020 2020  Entry]:.        
+00007890: 2222 220a 2020 2020 2020 2020 5265 7475  """.        Retu
+000078a0: 726e 7320 6120 636f 7079 206f 6620 7468  rns a copy of th
+000078b0: 6520 6c6f 6361 6c20 696e 6465 7820 6f66  e local index of
+000078c0: 2073 796e 6365 6420 6669 6c65 7320 616e   synced files an
+000078d0: 6420 666f 6c64 6572 732e 0a0a 2020 2020  d folders...    
+000078e0: 2020 2020 3a72 6574 7572 6e73 3a20 4c69      :returns: Li
+000078f0: 7374 206f 6620 696e 6465 7820 656e 7472  st of index entr
+00007900: 6965 732e 0a20 2020 2020 2020 2022 2222  ies..        """
+00007910: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00007920: 6c66 2e5f 6461 7461 6261 7365 5f61 6363  lf._database_acc
+00007930: 6573 7328 293a 0a20 2020 2020 2020 2020  ess():.         
+00007940: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00007950: 696e 6465 785f 7461 626c 652e 7365 6c65  index_table.sele
+00007960: 6374 2841 6c6c 5175 6572 7928 2929 0a0a  ct(AllQuery())..
+00007970: 2020 2020 6465 6620 6765 745f 696e 6465      def get_inde
+00007980: 785f 656e 7472 7928 7365 6c66 2c20 6462  x_entry(self, db
+00007990: 785f 7061 7468 5f6c 6f77 6572 3a20 7374  x_path_lower: st
+000079a0: 7229 202d 3e20 496e 6465 7845 6e74 7279  r) -> IndexEntry
+000079b0: 207c 204e 6f6e 653a 0a20 2020 2020 2020   | None:.       
+000079c0: 2022 2222 0a20 2020 2020 2020 2047 6574   """.        Get
+000079d0: 7320 7468 6520 696e 6465 7820 656e 7472  s the index entr
+000079e0: 7920 666f 7220 7468 6520 6769 7665 6e20  y for the given 
+000079f0: 4472 6f70 626f 7820 7061 7468 2e0a 0a20  Dropbox path... 
+00007a00: 2020 2020 2020 203a 7061 7261 6d20 6462         :param db
+00007a10: 785f 7061 7468 5f6c 6f77 6572 3a20 4e6f  x_path_lower: No
+00007a20: 726d 616c 697a 6564 206c 6f77 6572 2063  rmalized lower c
+00007a30: 6173 6520 4472 6f70 626f 7820 7061 7468  ase Dropbox path
+00007a40: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+00007a50: 6e73 3a20 496e 6465 7820 656e 7472 7920  ns: Index entry 
+00007a60: 6f72 2060 604e 6f6e 6560 6020 6966 206e  or ``None`` if n
+00007a70: 6f20 656e 7472 7920 6578 6973 7473 2066  o entry exists f
+00007a80: 6f72 2074 6865 2067 6976 656e 2070 6174  or the given pat
+00007a90: 682e 0a20 2020 2020 2020 2022 2222 0a20  h..        """. 
+00007aa0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00007ab0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
+00007ac0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00007ad0: 2072 6574 7572 6e20 7365 6c66 2e5f 696e   return self._in
+00007ae0: 6465 785f 7461 626c 652e 6765 7428 6462  dex_table.get(db
+00007af0: 785f 7061 7468 5f6c 6f77 6572 290a 0a20  x_path_lower).. 
+00007b00: 2020 2064 6566 2067 6574 5f69 6e64 6578     def get_index
+00007b10: 5f65 6e74 7279 5f66 6f72 5f6c 6f63 616c  _entry_for_local
+00007b20: 5f70 6174 6828 7365 6c66 2c20 6c6f 6361  _path(self, loca
+00007b30: 6c5f 7061 7468 3a20 7374 7229 202d 3e20  l_path: str) -> 
+00007b40: 496e 6465 7845 6e74 7279 207c 204e 6f6e  IndexEntry | Non
+00007b50: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+00007b60: 2020 2020 2020 2047 6574 7320 7468 6520         Gets the 
+00007b70: 696e 6465 7820 656e 7472 7920 666f 7220  index entry for 
+00007b80: 7468 6520 6769 7665 6e20 6c6f 6361 6c20  the given local 
+00007b90: 7061 7468 2e20 456e 7375 7265 7320 7468  path. Ensures th
+00007ba0: 6174 2074 6865 2069 6e64 6578 2065 6e74  at the index ent
+00007bb0: 7279 2068 6173 0a20 2020 2020 2020 2074  ry has.        t
+00007bc0: 6865 2063 6f72 7265 6374 2063 6173 696e  he correct casin
+00007bd0: 672e 0a0a 2020 2020 2020 2020 3a70 6172  g...        :par
+00007be0: 616d 206c 6f63 616c 5f70 6174 683a 204c  am local_path: L
+00007bf0: 6f63 616c 2070 6174 6820 6173 2072 6574  ocal path as ret
+00007c00: 7572 6e65 6420 6279 2066 696c 6520 7379  urned by file sy
+00007c10: 7374 656d 2041 5049 732e 0a20 2020 2020  stem APIs..     
+00007c20: 2020 203a 7265 7475 726e 733a 2049 6e64     :returns: Ind
+00007c30: 6578 2065 6e74 7279 206f 7220 6060 4e6f  ex entry or ``No
+00007c40: 6e65 6060 2069 6620 6e6f 2065 6e74 7279  ne`` if no entry
+00007c50: 2065 7869 7374 7320 666f 7220 7468 6520   exists for the 
+00007c60: 6769 7665 6e20 7061 7468 2e0a 2020 2020  given path..    
+00007c70: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00007c80: 6462 785f 7061 7468 5f63 6173 6564 203d  dbx_path_cased =
+00007c90: 2073 656c 662e 746f 5f64 6278 5f70 6174   self.to_dbx_pat
+00007ca0: 6828 6c6f 6361 6c5f 7061 7468 290a 2020  h(local_path).  
+00007cb0: 2020 2020 2020 6462 785f 7061 7468 5f6c        dbx_path_l
+00007cc0: 6f77 6572 203d 2073 656c 662e 746f 5f64  ower = self.to_d
+00007cd0: 6278 5f70 6174 685f 6c6f 7765 7228 6c6f  bx_path_lower(lo
+00007ce0: 6361 6c5f 7061 7468 290a 0a20 2020 2020  cal_path)..     
+00007cf0: 2020 2069 6e64 6578 5f65 6e74 7279 203d     index_entry =
+00007d00: 2073 656c 662e 6765 745f 696e 6465 785f   self.get_index_
+00007d10: 656e 7472 7928 6462 785f 7061 7468 5f6c  entry(dbx_path_l
+00007d20: 6f77 6572 290a 0a20 2020 2020 2020 2069  ower)..        i
+00007d30: 6620 6e6f 7420 696e 6465 785f 656e 7472  f not index_entr
+00007d40: 793a 0a20 2020 2020 2020 2020 2020 2072  y:.            r
+00007d50: 6574 7572 6e20 4e6f 6e65 0a0a 2020 2020  eturn None..    
+00007d60: 2020 2020 6966 2069 6e64 6578 5f65 6e74      if index_ent
+00007d70: 7279 2e64 6278 5f70 6174 685f 6361 7365  ry.dbx_path_case
+00007d80: 6420 3d3d 2064 6278 5f70 6174 685f 6361  d == dbx_path_ca
+00007d90: 7365 643a 0a20 2020 2020 2020 2020 2020  sed:.           
+00007da0: 2072 6574 7572 6e20 696e 6465 785f 656e   return index_en
+00007db0: 7472 790a 0a20 2020 2020 2020 2072 6574  try..        ret
+00007dc0: 7572 6e20 4e6f 6e65 0a0a 2020 2020 6465  urn None..    de
+00007dd0: 6620 6974 6572 5f69 6e64 6578 2873 656c  f iter_index(sel
+00007de0: 6629 202d 3e20 4974 6572 6174 6f72 5b49  f) -> Iterator[I
+00007df0: 6e64 6578 456e 7472 795d 3a0a 2020 2020  ndexEntry]:.    
+00007e00: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00007e10: 5265 7475 726e 7320 616e 2069 7465 7261  Returns an itera
+00007e20: 746f 7220 6f76 6572 2074 6865 206c 6f63  tor over the loc
+00007e30: 616c 2069 6e64 6578 206f 6620 7379 6e63  al index of sync
+00007e40: 6564 2066 696c 6573 2061 6e64 2066 6f6c  ed files and fol
+00007e50: 6465 7273 2e0a 0a20 2020 2020 2020 203a  ders...        :
+00007e60: 7265 7475 726e 733a 2049 7465 7261 746f  returns: Iterato
+00007e70: 7220 6f76 6572 2069 6e64 6578 2065 6e74  r over index ent
+00007e80: 7269 6573 2e0a 2020 2020 2020 2020 2222  ries..        ""
+00007e90: 220a 2020 2020 2020 2020 7769 7468 2073  ".        with s
+00007ea0: 656c 662e 5f64 6174 6162 6173 655f 6163  elf._database_ac
+00007eb0: 6365 7373 2829 3a0a 2020 2020 2020 2020  cess():.        
+00007ec0: 2020 2020 666f 7220 656e 7472 6965 7320      for entries 
+00007ed0: 696e 2073 656c 662e 5f69 6e64 6578 5f74  in self._index_t
+00007ee0: 6162 6c65 2e73 656c 6563 745f 6974 6572  able.select_iter
+00007ef0: 2841 6c6c 5175 6572 7928 2929 3a0a 2020  (AllQuery()):.  
+00007f00: 2020 2020 2020 2020 2020 2020 2020 7969                yi
+00007f10: 656c 6420 6672 6f6d 2065 6e74 7269 6573  eld from entries
+00007f20: 0a0a 2020 2020 6465 6620 696e 6465 785f  ..    def index_
+00007f30: 636f 756e 7428 7365 6c66 2920 2d3e 2069  count(self) -> i
+00007f40: 6e74 3a0a 2020 2020 2020 2020 2222 220a  nt:.        """.
+00007f50: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+00007f60: 7468 6520 6e75 6d62 6572 206f 6620 6974  the number of it
+00007f70: 656d 7320 696e 206f 7572 2069 6e64 6578  ems in our index
+00007f80: 2077 6974 686f 7574 206c 6f61 6469 6e67   without loading
+00007f90: 2061 6e79 2069 7465 6d73 2e0a 0a20 2020   any items...   
+00007fa0: 2020 2020 203a 7265 7475 726e 733a 204e       :returns: N
+00007fb0: 756d 6265 7220 6f66 2069 6e64 6578 2065  umber of index e
+00007fc0: 6e74 7269 6573 2e0a 2020 2020 2020 2020  ntries..        
+00007fd0: 2222 220a 2020 2020 2020 2020 7769 7468  """.        with
+00007fe0: 2073 656c 662e 5f64 6174 6162 6173 655f   self._database_
+00007ff0: 6163 6365 7373 2829 3a0a 2020 2020 2020  access():.      
+00008000: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+00008010: 662e 5f69 6e64 6578 5f74 6162 6c65 2e63  f._index_table.c
+00008020: 6f75 6e74 2829 0a0a 2020 2020 6465 6620  ount()..    def 
+00008030: 6765 745f 6c6f 6361 6c5f 7265 7628 7365  get_local_rev(se
+00008040: 6c66 2c20 6462 785f 7061 7468 5f6c 6f77  lf, dbx_path_low
+00008050: 6572 3a20 7374 7229 202d 3e20 7374 7220  er: str) -> str 
+00008060: 7c20 4e6f 6e65 3a0a 2020 2020 2020 2020  | None:.        
+00008070: 2222 220a 2020 2020 2020 2020 4765 7473  """.        Gets
+00008080: 2072 6576 6973 696f 6e20 6e75 6d62 6572   revision number
+00008090: 206f 6620 6c6f 6361 6c20 6669 6c65 2e0a   of local file..
+000080a0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000080b0: 6462 785f 7061 7468 5f6c 6f77 6572 3a20  dbx_path_lower: 
+000080c0: 4e6f 726d 616c 697a 6564 206c 6f77 6572  Normalized lower
+000080d0: 2063 6173 6520 4472 6f70 626f 7820 7061   case Dropbox pa
+000080e0: 7468 2e0a 2020 2020 2020 2020 3a72 6574  th..        :ret
+000080f0: 7572 6e73 3a20 5265 7669 7369 6f6e 206e  urns: Revision n
+00008100: 756d 6265 7220 6173 2073 7472 206f 7220  umber as str or 
+00008110: 6060 4e6f 6e65 6060 2069 6620 6e6f 206c  ``None`` if no l
+00008120: 6f63 616c 2072 6576 6973 696f 6e20 6e75  ocal revision nu
+00008130: 6d62 6572 2068 6173 0a20 2020 2020 2020  mber has.       
+00008140: 2020 2020 2062 6565 6e20 7361 7665 642e       been saved.
+00008150: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+00008160: 2020 2020 2065 6e74 7279 203d 2073 656c       entry = sel
+00008170: 662e 6765 745f 696e 6465 785f 656e 7472  f.get_index_entr
+00008180: 7928 6462 785f 7061 7468 5f6c 6f77 6572  y(dbx_path_lower
+00008190: 290a 0a20 2020 2020 2020 2069 6620 656e  )..        if en
+000081a0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+000081b0: 2072 6574 7572 6e20 656e 7472 792e 7265   return entry.re
+000081c0: 760a 2020 2020 2020 2020 656c 7365 3a0a  v.        else:.
+000081d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000081e0: 726e 204e 6f6e 650a 0a20 2020 2064 6566  rn None..    def
+000081f0: 2067 6574 5f6c 6173 745f 7379 6e63 2873   get_last_sync(s
+00008200: 656c 662c 2064 6278 5f70 6174 685f 6c6f  elf, dbx_path_lo
+00008210: 7765 723a 2073 7472 2920 2d3e 2066 6c6f  wer: str) -> flo
+00008220: 6174 3a0a 2020 2020 2020 2020 2222 220a  at:.        """.
+00008230: 2020 2020 2020 2020 5265 7475 726e 7320          Returns 
+00008240: 7468 6520 7469 6d65 7374 616d 7020 6f66  the timestamp of
+00008250: 206c 6173 7420 7379 6e63 2066 6f72 2061   last sync for a
+00008260: 6e20 696e 6469 7669 6475 616c 2070 6174  n individual pat
+00008270: 682e 0a0a 2020 2020 2020 2020 3a70 6172  h...        :par
+00008280: 616d 2064 6278 5f70 6174 685f 6c6f 7765  am dbx_path_lowe
+00008290: 723a 204e 6f72 6d61 6c69 7a65 6420 6c6f  r: Normalized lo
+000082a0: 7765 7220 6361 7365 2044 726f 7062 6f78  wer case Dropbox
+000082b0: 2070 6174 682e 0a20 2020 2020 2020 203a   path..        :
+000082c0: 7265 7475 726e 733a 2054 696d 6520 6f66  returns: Time of
+000082d0: 206c 6173 7420 7379 6e63 2e0a 2020 2020   last sync..    
 000082e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000082f0: 6966 2065 7665 6e74 2e63 6861 6e67 655f  if event.change_
-00008300: 7479 7065 2069 7320 6e6f 7420 4368 616e  type is not Chan
-00008310: 6765 5479 7065 2e52 656d 6f76 6564 2061  geType.Removed a
-00008320: 6e64 206e 6f74 2065 7665 6e74 2e72 6576  nd not event.rev
-00008330: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
-00008340: 6973 6520 5661 6c75 6545 7272 6f72 2822  ise ValueError("
-00008350: 5265 7620 7265 7175 6972 6564 2074 6f20  Rev required to 
-00008360: 7570 6461 7465 2069 6e64 6578 2229 0a0a  update index")..
-00008370: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
-00008380: 5f6c 6f77 6572 203d 2065 7665 6e74 2e64  _lower = event.d
-00008390: 6278 5f70 6174 685f 6c6f 7765 720a 0a20  bx_path_lower.. 
-000083a0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000083b0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
-000083c0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-000083d0: 2023 2052 656d 6f76 6520 616e 7920 656e   # Remove any en
-000083e0: 7472 6965 7320 666f 7220 6465 6c65 7465  tries for delete
-000083f0: 6420 6f72 206d 6f76 6564 2069 7465 6d73  d or moved items
-00008400: 2e0a 0a20 2020 2020 2020 2020 2020 2069  ...            i
-00008410: 6620 6576 656e 742e 6368 616e 6765 5f74  f event.change_t
-00008420: 7970 6520 6973 2043 6861 6e67 6554 7970  ype is ChangeTyp
-00008430: 652e 5265 6d6f 7665 643a 0a20 2020 2020  e.Removed:.     
-00008440: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00008450: 7265 6d6f 7665 5f6e 6f64 655f 6672 6f6d  remove_node_from
-00008460: 5f69 6e64 6578 2864 6278 5f70 6174 685f  _index(dbx_path_
-00008470: 6c6f 7765 7229 0a20 2020 2020 2020 2020  lower).         
-00008480: 2020 2065 6c69 6620 6576 656e 742e 6368     elif event.ch
-00008490: 616e 6765 5f74 7970 6520 6973 2043 6861  ange_type is Cha
-000084a0: 6e67 6554 7970 652e 4d6f 7665 643a 0a20  ngeType.Moved:. 
-000084b0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-000084c0: 7373 6572 7420 6576 656e 742e 6462 785f  ssert event.dbx_
-000084d0: 7061 7468 5f66 726f 6d5f 6c6f 7765 7220  path_from_lower 
-000084e0: 6973 206e 6f74 204e 6f6e 650a 2020 2020  is not None.    
-000084f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00008500: 2e72 656d 6f76 655f 6e6f 6465 5f66 726f  .remove_node_fro
-00008510: 6d5f 696e 6465 7828 6576 656e 742e 6462  m_index(event.db
-00008520: 785f 7061 7468 5f66 726f 6d5f 6c6f 7765  x_path_from_lowe
-00008530: 7229 0a0a 2020 2020 2020 2020 2020 2020  r)..            
-00008540: 2320 4164 6420 6f72 2075 7064 6174 6520  # Add or update 
-00008550: 656e 7472 6965 7320 666f 7220 6372 6561  entries for crea
-00008560: 7465 6420 6f72 206d 6f64 6966 6965 6420  ted or modified 
-00008570: 6974 656d 732e 0a0a 2020 2020 2020 2020  items...        
-00008580: 2020 2020 6966 2065 7665 6e74 2e63 6861      if event.cha
-00008590: 6e67 655f 7479 7065 2069 7320 6e6f 7420  nge_type is not 
-000085a0: 4368 616e 6765 5479 7065 2e52 656d 6f76  ChangeType.Remov
-000085b0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-000085c0: 2020 2020 2320 4372 6561 7465 206f 7220      # Create or 
-000085d0: 7570 6461 7465 2065 6e74 7279 2e0a 2020  update entry..  
-000085e0: 2020 2020 2020 2020 2020 2020 2020 656e                en
-000085f0: 7472 7920 3d20 496e 6465 7845 6e74 7279  try = IndexEntry
-00008600: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00008610: 2020 2020 2020 6462 785f 7061 7468 5f63        dbx_path_c
-00008620: 6173 6564 3d65 7665 6e74 2e64 6278 5f70  ased=event.dbx_p
-00008630: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00008640: 2020 2020 2020 2020 2064 6278 5f70 6174           dbx_pat
-00008650: 685f 6c6f 7765 723d 6462 785f 7061 7468  h_lower=dbx_path
-00008660: 5f6c 6f77 6572 2c0a 2020 2020 2020 2020  _lower,.        
-00008670: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
-00008680: 6964 3d65 7665 6e74 2e64 6278 5f69 642c  id=event.dbx_id,
-00008690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000086a0: 2020 2020 2069 7465 6d5f 7479 7065 3d65       item_type=e
-000086b0: 7665 6e74 2e69 7465 6d5f 7479 7065 2c0a  vent.item_type,.
-000086c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000086d0: 2020 2020 6c61 7374 5f73 796e 633d 7365      last_sync=se
-000086e0: 6c66 2e5f 6765 745f 6374 696d 6528 6576  lf._get_ctime(ev
-000086f0: 656e 742e 6c6f 6361 6c5f 7061 7468 292c  ent.local_path),
-00008700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008710: 2020 2020 2072 6576 3d65 7665 6e74 2e72       rev=event.r
-00008720: 6576 2c0a 2020 2020 2020 2020 2020 2020  ev,.            
-00008730: 2020 2020 2020 2020 636f 6e74 656e 745f          content_
-00008740: 6861 7368 3d65 7665 6e74 2e63 6f6e 7465  hash=event.conte
-00008750: 6e74 5f68 6173 682c 0a20 2020 2020 2020  nt_hash,.       
-00008760: 2020 2020 2020 2020 2020 2020 2073 796d               sym
-00008770: 6c69 6e6b 5f74 6172 6765 743d 6576 656e  link_target=even
-00008780: 742e 7379 6d6c 696e 6b5f 7461 7267 6574  t.symlink_target
-00008790: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000087a0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
-000087b0: 2020 2020 2073 656c 662e 5f69 6e64 6578       self._index
-000087c0: 5f74 6162 6c65 2e75 7064 6174 6528 656e  _table.update(en
-000087d0: 7472 7929 0a0a 2020 2020 6465 6620 7570  try)..    def up
-000087e0: 6461 7465 5f69 6e64 6578 5f66 726f 6d5f  date_index_from_
-000087f0: 6462 785f 6d65 7461 6461 7461 2873 656c  dbx_metadata(sel
-00008800: 662c 206d 643a 204d 6574 6164 6174 6129  f, md: Metadata)
-00008810: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
-00008820: 2020 2222 220a 2020 2020 2020 2020 5570    """.        Up
-00008830: 6461 7465 7320 7468 6520 6c6f 6361 6c20  dates the local 
-00008840: 696e 6465 7820 6672 6f6d 2044 726f 7062  index from Dropb
-00008850: 6f78 206d 6574 6164 6174 612e 0a0a 2020  ox metadata...  
-00008860: 2020 2020 2020 3a70 6172 616d 206d 643a        :param md:
-00008870: 2044 726f 7062 6f78 206d 6574 6164 6174   Dropbox metadat
-00008880: 612e 0a20 2020 2020 2020 2022 2222 0a20  a..        """. 
-00008890: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-000088a0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
-000088b0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-000088c0: 2069 6620 6973 696e 7374 616e 6365 286d   if isinstance(m
-000088d0: 642c 2044 656c 6574 6564 4d65 7461 6461  d, DeletedMetada
-000088e0: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
-000088f0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-00008900: 2e72 656d 6f76 655f 6e6f 6465 5f66 726f  .remove_node_fro
-00008910: 6d5f 696e 6465 7828 6d64 2e70 6174 685f  m_index(md.path_
-00008920: 6c6f 7765 7229 0a0a 2020 2020 2020 2020  lower)..        
-00008930: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
-00008940: 6528 6d64 2c20 4669 6c65 4d65 7461 6461  e(md, FileMetada
-00008950: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
-00008960: 2020 2020 2072 6576 203d 206d 642e 7265       rev = md.re
-00008970: 760a 2020 2020 2020 2020 2020 2020 2020  v.              
-00008980: 2020 6861 7368 5f73 7472 203d 206d 642e    hash_str = md.
-00008990: 636f 6e74 656e 745f 6861 7368 0a20 2020  content_hash.   
-000089a0: 2020 2020 2020 2020 2020 2020 2069 7465               ite
-000089b0: 6d5f 7479 7065 203d 2049 7465 6d54 7970  m_type = ItemTyp
-000089c0: 652e 4669 6c65 0a20 2020 2020 2020 2020  e.File.         
-000089d0: 2020 2020 2020 2073 796d 6c69 6e6b 5f74         symlink_t
-000089e0: 6172 6765 7420 3d20 6d64 2e73 796d 6c69  arget = md.symli
-000089f0: 6e6b 5f74 6172 6765 740a 2020 2020 2020  nk_target.      
-00008a00: 2020 2020 2020 2020 2020 6d64 5f69 6420            md_id 
-00008a10: 3d20 6d64 2e69 640a 2020 2020 2020 2020  = md.id.        
-00008a20: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00008a30: 6e63 6528 6d64 2c20 466f 6c64 6572 4d65  nce(md, FolderMe
-00008a40: 7461 6461 7461 293a 0a20 2020 2020 2020  tadata):.       
-00008a50: 2020 2020 2020 2020 2072 6576 203d 2022           rev = "
-00008a60: 666f 6c64 6572 220a 2020 2020 2020 2020  folder".        
-00008a70: 2020 2020 2020 2020 6861 7368 5f73 7472          hash_str
-00008a80: 203d 2022 666f 6c64 6572 220a 2020 2020   = "folder".    
-00008a90: 2020 2020 2020 2020 2020 2020 6974 656d              item
-00008aa0: 5f74 7970 6520 3d20 4974 656d 5479 7065  _type = ItemType
-00008ab0: 2e46 6f6c 6465 720a 2020 2020 2020 2020  .Folder.        
-00008ac0: 2020 2020 2020 2020 7379 6d6c 696e 6b5f          symlink_
-00008ad0: 7461 7267 6574 203d 204e 6f6e 650a 2020  target = None.  
-00008ae0: 2020 2020 2020 2020 2020 2020 2020 6d64                md
-00008af0: 5f69 6420 3d20 6d64 2e69 640a 2020 2020  _id = md.id.    
-00008b00: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00008b10: 2020 2020 2020 2020 2020 2020 2020 7261                ra
-00008b20: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
-00008b30: 2866 2255 6e6b 6e6f 776e 206d 6574 6164  (f"Unknown metad
-00008b40: 6174 6120 7479 7065 3a20 7b6d 647d 2229  ata type: {md}")
-00008b50: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00008b60: 436f 6e73 7472 7563 7420 636f 7272 6563  Construct correc
-00008b70: 7420 6469 7370 6c61 7920 7061 7468 2066  t display path f
-00008b80: 726f 6d20 616e 6365 7374 6f72 732e 0a20  rom ancestors.. 
-00008b90: 2020 2020 2020 2020 2020 2064 6278 5f70             dbx_p
-00008ba0: 6174 685f 6361 7365 6420 3d20 7365 6c66  ath_cased = self
-00008bb0: 2e63 6f72 7265 6374 5f63 6173 6528 6d64  .correct_case(md
-00008bc0: 2e70 6174 685f 6469 7370 6c61 7929 0a0a  .path_display)..
-00008bd0: 2020 2020 2020 2020 2020 2020 2320 5570              # Up
-00008be0: 6461 7465 2065 7869 7374 696e 6720 656e  date existing en
-00008bf0: 7472 7920 6f72 2063 7265 6174 6520 6e65  try or create ne
-00008c00: 7720 656e 7472 792e 0a20 2020 2020 2020  w entry..       
-00008c10: 2020 2020 2065 6e74 7279 203d 2049 6e64       entry = Ind
-00008c20: 6578 456e 7472 7928 0a20 2020 2020 2020  exEntry(.       
-00008c30: 2020 2020 2020 2020 2064 6278 5f70 6174           dbx_pat
-00008c40: 685f 6361 7365 643d 6462 785f 7061 7468  h_cased=dbx_path
-00008c50: 5f63 6173 6564 2c0a 2020 2020 2020 2020  _cased,.        
-00008c60: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
-00008c70: 5f6c 6f77 6572 3d6d 642e 7061 7468 5f6c  _lower=md.path_l
-00008c80: 6f77 6572 2c0a 2020 2020 2020 2020 2020  ower,.          
-00008c90: 2020 2020 2020 6462 785f 6964 3d6d 645f        dbx_id=md_
-00008ca0: 6964 2c0a 2020 2020 2020 2020 2020 2020  id,.            
-00008cb0: 2020 2020 6974 656d 5f74 7970 653d 6974      item_type=it
-00008cc0: 656d 5f74 7970 652c 0a20 2020 2020 2020  em_type,.       
-00008cd0: 2020 2020 2020 2020 206c 6173 745f 7379           last_sy
-00008ce0: 6e63 3d4e 6f6e 652c 0a20 2020 2020 2020  nc=None,.       
-00008cf0: 2020 2020 2020 2020 2072 6576 3d72 6576           rev=rev
-00008d00: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00008d10: 2020 636f 6e74 656e 745f 6861 7368 3d68    content_hash=h
-00008d20: 6173 685f 7374 722c 0a20 2020 2020 2020  ash_str,.       
-00008d30: 2020 2020 2020 2020 2073 796d 6c69 6e6b           symlink
-00008d40: 5f74 6172 6765 743d 7379 6d6c 696e 6b5f  _target=symlink_
-00008d50: 7461 7267 6574 2c0a 2020 2020 2020 2020  target,.        
-00008d60: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00008d70: 2020 2073 656c 662e 5f69 6e64 6578 5f74     self._index_t
-00008d80: 6162 6c65 2e75 7064 6174 6528 656e 7472  able.update(entr
-00008d90: 7929 0a0a 2020 2020 6465 6620 7265 6d6f  y)..    def remo
-00008da0: 7665 5f6e 6f64 655f 6672 6f6d 5f69 6e64  ve_node_from_ind
-00008db0: 6578 2873 656c 662c 2064 6278 5f70 6174  ex(self, dbx_pat
-00008dc0: 685f 6c6f 7765 723a 2073 7472 2920 2d3e  h_lower: str) ->
-00008dd0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
-00008de0: 2222 0a20 2020 2020 2020 2052 656d 6f76  "".        Remov
-00008df0: 6573 2061 6e79 206c 6f63 616c 2069 6e64  es any local ind
-00008e00: 6578 2065 6e74 7269 6573 2066 6f72 2074  ex entries for t
-00008e10: 6865 2067 6976 656e 2070 6174 6820 616e  he given path an
-00008e20: 6420 616c 6c20 6974 7320 6368 696c 6472  d all its childr
-00008e30: 656e 2e0a 0a20 2020 2020 2020 203a 7061  en...        :pa
-00008e40: 7261 6d20 6462 785f 7061 7468 5f6c 6f77  ram dbx_path_low
-00008e50: 6572 3a20 4e6f 726d 616c 697a 6564 206c  er: Normalized l
-00008e60: 6f77 6572 2063 6173 6520 4472 6f70 626f  ower case Dropbo
-00008e70: 7820 7061 7468 2e0a 2020 2020 2020 2020  x path..        
-00008e80: 2222 220a 2020 2020 2020 2020 7769 7468  """.        with
-00008e90: 2073 656c 662e 5f64 6174 6162 6173 655f   self._database_
-00008ea0: 6163 6365 7373 2829 3a0a 2020 2020 2020  access():.      
-00008eb0: 2020 2020 2020 7175 6572 7920 3d20 5061        query = Pa
-00008ec0: 7468 5472 6565 5175 6572 7928 496e 6465  thTreeQuery(Inde
-00008ed0: 7845 6e74 7279 2e64 6278 5f70 6174 685f  xEntry.dbx_path_
-00008ee0: 6c6f 7765 722c 2064 6278 5f70 6174 685f  lower, dbx_path_
-00008ef0: 6c6f 7765 7229 0a20 2020 2020 2020 2020  lower).         
-00008f00: 2020 2073 656c 662e 5f69 6e64 6578 5f74     self._index_t
-00008f10: 6162 6c65 2e64 656c 6574 6528 7175 6572  able.delete(quer
-00008f20: 7929 0a0a 2020 2020 2320 3d3d 3d3d 2043  y)..    # ==== C
-00008f30: 6f6e 7465 6e74 2068 6173 6869 6e67 203d  ontent hashing =
-00008f40: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00008f50: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00008f60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00008f70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2020  ============..  
-00008f80: 2020 6465 6620 6765 745f 6c6f 6361 6c5f    def get_local_
-00008f90: 6861 7368 2873 656c 662c 206c 6f63 616c  hash(self, local
-00008fa0: 5f70 6174 683a 2073 7472 2920 2d3e 2073  _path: str) -> s
-00008fb0: 7472 207c 204e 6f6e 653a 0a20 2020 2020  tr | None:.     
-00008fc0: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
-00008fd0: 6f6d 7075 7465 7320 636f 6e74 656e 7420  omputes content 
-00008fe0: 6861 7368 206f 6620 6120 6c6f 6361 6c20  hash of a local 
-00008ff0: 6669 6c65 2e0a 0a20 2020 2020 2020 203a  file...        :
-00009000: 7061 7261 6d20 6c6f 6361 6c5f 7061 7468  param local_path
-00009010: 3a20 4162 736f 6c75 7465 2070 6174 6820  : Absolute path 
-00009020: 6f6e 206c 6f63 616c 2064 7269 7665 2e0a  on local drive..
-00009030: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-00009040: 3a20 436f 6e74 656e 7420 6861 7368 2074  : Content hash t
-00009050: 6f20 636f 6d70 6172 6520 7769 7468 2044  o compare with D
-00009060: 726f 7062 6f78 2773 2063 6f6e 7465 6e74  ropbox's content
-00009070: 2068 6173 682c 206f 7220 2766 6f6c 6465   hash, or 'folde
-00009080: 7227 2069 660a 2020 2020 2020 2020 2020  r' if.          
-00009090: 2020 7468 6520 7061 7468 2070 6f69 6e74    the path point
-000090a0: 7320 746f 2061 2064 6972 6563 746f 7279  s to a directory
-000090b0: 2e20 6060 4e6f 6e65 6060 2069 6620 7468  . ``None`` if th
-000090c0: 6572 6520 6973 206e 6f74 6869 6e67 2061  ere is nothing a
-000090d0: 7420 7468 6520 7061 7468 2e0a 2020 2020  t the path..    
-000090e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-000090f0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00009100: 2073 7461 7420 3d20 6f73 2e6c 7374 6174   stat = os.lstat
-00009110: 286c 6f63 616c 5f70 6174 6829 0a20 2020  (local_path).   
-00009120: 2020 2020 2065 7863 6570 7420 2846 696c       except (Fil
-00009130: 654e 6f74 466f 756e 6445 7272 6f72 2c20  eNotFoundError, 
-00009140: 4e6f 7441 4469 7265 6374 6f72 7945 7272  NotADirectoryErr
-00009150: 6f72 293a 0a20 2020 2020 2020 2020 2020  or):.           
-00009160: 2023 2052 656d 6f76 6520 616c 6c20 6361   # Remove all ca
-00009170: 6368 6520 656e 7472 6965 7320 666f 7220  che entries for 
-00009180: 6c6f 6361 6c5f 7061 7468 2061 6e64 2072  local_path and r
-00009190: 6574 7572 6e20 4e6f 6e65 2e0a 2020 2020  eturn None..    
-000091a0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-000091b0: 662e 5f64 6174 6162 6173 655f 6163 6365  f._database_acce
-000091c0: 7373 2829 3a0a 2020 2020 2020 2020 2020  ss():.          
-000091d0: 2020 2020 2020 7175 6572 7920 3d20 4d61        query = Ma
-000091e0: 7463 6851 7565 7279 2848 6173 6843 6163  tchQuery(HashCac
-000091f0: 6865 456e 7472 792e 6c6f 6361 6c5f 7061  heEntry.local_pa
-00009200: 7468 2c20 6c6f 6361 6c5f 7061 7468 290a  th, local_path).
-00009210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009220: 7365 6c66 2e5f 6861 7368 5f74 6162 6c65  self._hash_table
-00009230: 2e64 656c 6574 6528 7175 6572 7929 0a20  .delete(query). 
-00009240: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00009250: 6e20 4e6f 6e65 0a20 2020 2020 2020 2065  n None.        e
-00009260: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
-00009270: 2065 7272 3a0a 2020 2020 2020 2020 2020   err:.          
-00009280: 2020 6966 2065 7272 2e65 7272 6e6f 203d    if err.errno =
-00009290: 3d20 6572 726e 6f2e 454e 414d 4554 4f4f  = errno.ENAMETOO
-000092a0: 4c4f 4e47 3a0a 2020 2020 2020 2020 2020  LONG:.          
-000092b0: 2020 2020 2020 7265 7475 726e 204e 6f6e        return Non
-000092c0: 650a 2020 2020 2020 2020 2020 2020 7261  e.            ra
-000092d0: 6973 6520 6f73 5f74 6f5f 6d61 6573 7472  ise os_to_maestr
-000092e0: 616c 5f65 7272 6f72 2865 7272 290a 0a20  al_error(err).. 
-000092f0: 2020 2020 2020 2069 6620 535f 4953 4449         if S_ISDI
-00009300: 5228 7374 6174 2e73 745f 6d6f 6465 293a  R(stat.st_mode):
-00009310: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00009320: 7572 6e20 2266 6f6c 6465 7222 0a0a 2020  urn "folder"..  
-00009330: 2020 2020 2020 6d74 696d 653a 2066 6c6f        mtime: flo
-00009340: 6174 207c 204e 6f6e 6520 3d20 7374 6174  at | None = stat
-00009350: 2e73 745f 6d74 696d 650a 0a20 2020 2020  .st_mtime..     
-00009360: 2020 2077 6974 6820 7365 6c66 2e5f 6461     with self._da
-00009370: 7461 6261 7365 5f61 6363 6573 7328 293a  tabase_access():
-00009380: 0a20 2020 2020 2020 2020 2020 2023 2043  .            # C
-00009390: 6865 636b 2063 6163 6865 2066 6f72 2061  heck cache for a
-000093a0: 6e20 7570 2d74 6f2d 6461 7465 2063 6f6e  n up-to-date con
-000093b0: 7465 6e74 2068 6173 6820 616e 6420 7265  tent hash and re
-000093c0: 7475 726e 2069 6620 6974 2065 7869 7374  turn if it exist
-000093d0: 732e 0a20 2020 2020 2020 2020 2020 2063  s..            c
-000093e0: 6163 6865 5f65 6e74 7279 203d 2073 656c  ache_entry = sel
-000093f0: 662e 5f68 6173 685f 7461 626c 652e 6765  f._hash_table.ge
-00009400: 7428 7374 6174 2e73 745f 696e 6f29 0a0a  t(stat.st_ino)..
-00009410: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00009420: 6163 6865 5f65 6e74 7279 2061 6e64 2063  ache_entry and c
-00009430: 6163 6865 5f65 6e74 7279 2e6d 7469 6d65  ache_entry.mtime
-00009440: 203d 3d20 6d74 696d 653a 0a20 2020 2020   == mtime:.     
-00009450: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00009460: 6e20 6361 6368 655f 656e 7472 792e 6861  n cache_entry.ha
-00009470: 7368 5f73 7472 0a0a 2020 2020 2020 2020  sh_str..        
-00009480: 7769 7468 2063 6f6e 7665 7274 5f61 7069  with convert_api
-00009490: 5f65 7272 6f72 7328 6c6f 6361 6c5f 7061  _errors(local_pa
-000094a0: 7468 3d6c 6f63 616c 5f70 6174 6829 3a0a  th=local_path):.
-000094b0: 2020 2020 2020 2020 2020 2020 6861 7368              hash
-000094c0: 5f73 7472 2c20 6d74 696d 6520 3d20 636f  _str, mtime = co
-000094d0: 6e74 656e 745f 6861 7368 286c 6f63 616c  ntent_hash(local
-000094e0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-000094f0: 7365 6c66 2e5f 7361 7665 5f6c 6f63 616c  self._save_local
-00009500: 5f68 6173 6828 7374 6174 2e73 745f 696e  _hash(stat.st_in
-00009510: 6f2c 206c 6f63 616c 5f70 6174 682c 2068  o, local_path, h
-00009520: 6173 685f 7374 722c 206d 7469 6d65 290a  ash_str, mtime).
-00009530: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00009540: 6861 7368 5f73 7472 0a0a 2020 2020 6465  hash_str..    de
-00009550: 6620 5f73 6176 655f 6c6f 6361 6c5f 6861  f _save_local_ha
-00009560: 7368 280a 2020 2020 2020 2020 7365 6c66  sh(.        self
-00009570: 2c0a 2020 2020 2020 2020 696e 6f64 653a  ,.        inode:
-00009580: 2069 6e74 2c0a 2020 2020 2020 2020 6c6f   int,.        lo
-00009590: 6361 6c5f 7061 7468 3a20 7374 722c 0a20  cal_path: str,. 
-000095a0: 2020 2020 2020 2068 6173 685f 7374 723a         hash_str:
-000095b0: 2073 7472 207c 204e 6f6e 652c 0a20 2020   str | None,.   
-000095c0: 2020 2020 206d 7469 6d65 3a20 666c 6f61       mtime: floa
-000095d0: 7420 7c20 4e6f 6e65 2c0a 2020 2020 2920  t | None,.    ) 
-000095e0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-000095f0: 2022 2222 0a20 2020 2020 2020 2053 6176   """.        Sav
-00009600: 6520 7468 6520 636f 6e74 656e 7420 6861  e the content ha
-00009610: 7368 2066 6f72 2061 2066 696c 6520 696e  sh for a file in
-00009620: 206f 7572 2063 6163 6865 2e0a 0a20 2020   our cache...   
-00009630: 2020 2020 203a 7061 7261 6d20 696e 6f64       :param inod
-00009640: 653a 2049 6e6f 6465 206f 6620 7468 6520  e: Inode of the 
-00009650: 6669 6c65 2e0a 2020 2020 2020 2020 3a70  file..        :p
-00009660: 6172 616d 206c 6f63 616c 5f70 6174 683a  aram local_path:
-00009670: 2041 6273 6f6c 7574 6520 7061 7468 206f   Absolute path o
-00009680: 6e20 6c6f 6361 6c20 6472 6976 652e 0a20  n local drive.. 
-00009690: 2020 2020 2020 203a 7061 7261 6d20 6861         :param ha
-000096a0: 7368 5f73 7472 3a20 4861 7368 2073 7472  sh_str: Hash str
-000096b0: 696e 6720 746f 2073 6176 652e 2049 6620  ing to save. If 
-000096c0: 4e6f 6e65 2c20 7468 6520 6578 6973 7469  None, the existi
-000096d0: 6e67 2063 6163 6865 2065 6e74 7279 2077  ng cache entry w
-000096e0: 696c 6c20 6265 0a20 2020 2020 2020 2020  ill be.         
-000096f0: 2020 2064 656c 6574 6564 2e0a 2020 2020     deleted..    
-00009700: 2020 2020 3a70 6172 616d 206d 7469 6d65      :param mtime
-00009710: 3a20 4d74 696d 6520 6f66 2074 6865 2066  : Mtime of the f
-00009720: 696c 6520 7768 656e 2074 6865 2068 6173  ile when the has
-00009730: 6820 7761 7320 636f 6d70 7574 6564 2e0a  h was computed..
-00009740: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00009750: 2020 2020 7769 7468 2073 656c 662e 5f64      with self._d
-00009760: 6174 6162 6173 655f 6163 6365 7373 2829  atabase_access()
-00009770: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-00009780: 2068 6173 685f 7374 723a 0a20 2020 2020   hash_str:.     
-00009790: 2020 2020 2020 2020 2020 2063 6163 6865             cache
-000097a0: 5f65 6e74 7279 203d 2048 6173 6843 6163  _entry = HashCac
-000097b0: 6865 456e 7472 7928 0a20 2020 2020 2020  heEntry(.       
-000097c0: 2020 2020 2020 2020 2020 2020 2069 6e6f               ino
-000097d0: 6465 3d69 6e6f 6465 2c0a 2020 2020 2020  de=inode,.      
-000097e0: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
-000097f0: 6361 6c5f 7061 7468 3d6c 6f63 616c 5f70  cal_path=local_p
-00009800: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00009810: 2020 2020 2020 2020 2068 6173 685f 7374           hash_st
-00009820: 723d 6861 7368 5f73 7472 2c0a 2020 2020  r=hash_str,.    
-00009830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00009840: 6d74 696d 653d 6d74 696d 652c 0a20 2020  mtime=mtime,.   
-00009850: 2020 2020 2020 2020 2020 2020 2029 0a20               ). 
-00009860: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00009870: 656c 662e 5f68 6173 685f 7461 626c 652e  elf._hash_table.
-00009880: 7570 6461 7465 2863 6163 6865 5f65 6e74  update(cache_ent
-00009890: 7279 290a 0a20 2020 2020 2020 2020 2020  ry)..           
-000098a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000098b0: 2020 2020 2020 2073 656c 662e 5f68 6173         self._has
-000098c0: 685f 7461 626c 652e 6465 6c65 7465 5f70  h_table.delete_p
-000098d0: 7269 6d61 7279 5f6b 6579 2869 6e6f 6465  rimary_key(inode
-000098e0: 290a 0a20 2020 2023 203d 3d3d 3d20 4d69  )..    # ==== Mi
-000098f0: 676e 6f72 6520 6d61 6e61 6765 6d65 6e74  gnore management
-00009900: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
-00009910: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00009920: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00009930: 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a20 2020  ===========..   
-00009940: 2040 7072 6f70 6572 7479 0a20 2020 2064   @property.    d
-00009950: 6566 206d 6967 6e6f 7265 5f70 6174 6828  ef mignore_path(
-00009960: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
-00009970: 2020 2020 2020 2222 2250 6174 6820 746f        """Path to
-00009980: 206d 6967 6e6f 7265 2066 696c 6520 6f6e   mignore file on
-00009990: 206c 6f63 616c 2064 7269 7665 2028 7265   local drive (re
-000099a0: 6164 206f 6e6c 7929 2e22 2222 0a20 2020  ad only).""".   
-000099b0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000099c0: 2e5f 6d69 676e 6f72 655f 7061 7468 0a0a  ._mignore_path..
-000099d0: 2020 2020 4070 726f 7065 7274 790a 2020      @property.  
-000099e0: 2020 6465 6620 6d69 676e 6f72 655f 7275    def mignore_ru
-000099f0: 6c65 7328 7365 6c66 2920 2d3e 2050 6174  les(self) -> Pat
-00009a00: 6853 7065 633a 0a20 2020 2020 2020 2022  hSpec:.        "
-00009a10: 2222 4c69 7374 206f 6620 6d69 676e 6f72  ""List of mignor
-00009a20: 6520 7275 6c65 7320 666f 6c6c 6f77 696e  e rules followin
-00009a30: 6720 6769 7420 7769 6c64 6d61 7463 6820  g git wildmatch 
-00009a40: 7379 6e74 6178 2028 7265 6164 206f 6e6c  syntax (read onl
-00009a50: 7929 2e22 2222 0a20 2020 2020 2020 2072  y).""".        r
-00009a60: 6574 7572 6e20 7365 6c66 2e5f 6d69 676e  eturn self._mign
-00009a70: 6f72 655f 7275 6c65 730a 0a20 2020 2064  ore_rules..    d
-00009a80: 6566 206c 6f61 645f 6d69 676e 6f72 655f  ef load_mignore_
-00009a90: 6669 6c65 2873 656c 6629 202d 3e20 4e6f  file(self) -> No
-00009aa0: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
-00009ab0: 2020 2020 2020 2020 4c6f 6164 7320 7275          Loads ru
-00009ac0: 6c65 7320 6672 6f6d 206d 6967 6e6f 7265  les from mignore
-00009ad0: 2066 696c 652e 204e 6f20 7275 6c65 7320   file. No rules 
-00009ae0: 6172 6520 6c6f 6164 6564 2069 6620 7468  are loaded if th
-00009af0: 6520 6669 6c65 2064 6f65 730a 2020 2020  e file does.    
-00009b00: 2020 2020 6e6f 7420 6578 6973 7420 6f72      not exist or
-00009b10: 2063 616e 6e6f 7420 6265 2072 6561 642e   cannot be read.
-00009b20: 0a0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-00009b30: 6e73 3a20 5061 7468 5370 6563 2069 6e73  ns: PathSpec ins
-00009b40: 7461 6e63 6520 7769 7468 2069 676e 6f72  tance with ignor
-00009b50: 6520 7061 7474 6572 6e73 2e0a 2020 2020  e patterns..    
-00009b60: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00009b70: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00009b80: 2077 6974 6820 6f70 656e 2873 656c 662e   with open(self.
-00009b90: 6d69 676e 6f72 655f 7061 7468 2920 6173  mignore_path) as
-00009ba0: 2066 3a0a 2020 2020 2020 2020 2020 2020   f:.            
-00009bb0: 2020 2020 7370 6563 203d 2066 2e72 6561      spec = f.rea
-00009bc0: 6428 290a 2020 2020 2020 2020 6578 6365  d().        exce
-00009bd0: 7074 204f 5345 7272 6f72 2061 7320 6572  pt OSError as er
-00009be0: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
-00009bf0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
-00009c00: 6728 2243 6f75 6c64 206e 6f74 206c 6f61  g("Could not loa
-00009c10: 6420 6d69 676e 6f72 6520 7275 6c65 733a  d mignore rules:
-00009c20: 2025 7322 2c20 6572 722e 7374 7265 7272   %s", err.strerr
-00009c30: 6f72 290a 2020 2020 2020 2020 2020 2020  or).            
-00009c40: 7370 6563 203d 2022 220a 0a20 2020 2020  spec = ""..     
-00009c50: 2020 2073 656c 662e 5f6d 6967 6e6f 7265     self._mignore
-00009c60: 5f72 756c 6573 203d 2050 6174 6853 7065  _rules = PathSpe
-00009c70: 632e 6672 6f6d 5f6c 696e 6573 2822 6769  c.from_lines("gi
-00009c80: 7477 696c 646d 6174 6368 222c 2073 7065  twildmatch", spe
-00009c90: 632e 7370 6c69 746c 696e 6573 2829 290a  c.splitlines()).
-00009ca0: 0a20 2020 2023 203d 3d3d 3d20 4865 6c70  .    # ==== Help
-00009cb0: 6572 2066 756e 6374 696f 6e73 203d 3d3d  er functions ===
-00009cc0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00009cd0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00009ce0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00009cf0: 3d3d 3d3d 3d3d 3d3d 3d0a 0a20 2020 2064  =========..    d
-00009d00: 6566 2065 6e73 7572 655f 6472 6f70 626f  ef ensure_dropbo
-00009d10: 785f 666f 6c64 6572 5f70 7265 7365 6e74  x_folder_present
-00009d20: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
-00009d30: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00009d40: 2020 2020 4368 6563 6b73 2069 6620 7468      Checks if th
-00009d50: 6520 4472 6f70 626f 7820 666f 6c64 6572  e Dropbox folder
-00009d60: 2073 7469 6c6c 2065 7869 7374 7320 7768   still exists wh
-00009d70: 6572 6520 7765 2065 7870 6563 7420 6974  ere we expect it
-00009d80: 2074 6f20 6265 2e0a 0a20 2020 2020 2020   to be...       
-00009d90: 203a 7261 6973 6573 204e 6f44 726f 7062   :raises NoDropb
-00009da0: 6f78 4469 7245 7272 6f72 3a20 5768 656e  oxDirError: When
-00009db0: 206c 6f63 616c 2044 726f 7062 6f78 2064   local Dropbox d
-00009dc0: 6972 6563 746f 7279 2064 6f65 7320 6e6f  irectory does no
-00009dd0: 7420 6578 6973 742e 0a20 2020 2020 2020  t exist..       
-00009de0: 2022 2222 0a20 2020 2020 2020 2065 7863   """.        exc
-00009df0: 6570 7469 6f6e 203d 204e 6f44 726f 7062  eption = NoDropb
-00009e00: 6f78 4469 7245 7272 6f72 280a 2020 2020  oxDirError(.    
-00009e10: 2020 2020 2020 2020 2244 726f 7062 6f78          "Dropbox
-00009e20: 2066 6f6c 6465 7220 6d69 7373 696e 6722   folder missing"
-00009e30: 2c0a 2020 2020 2020 2020 2020 2020 2250  ,.            "P
-00009e40: 6c65 6173 6520 6d6f 7665 2074 6865 2044  lease move the D
-00009e50: 726f 7062 6f78 2066 6f6c 6465 7220 6261  ropbox folder ba
-00009e60: 636b 2074 6f20 6974 7320 6f72 6967 696e  ck to its origin
-00009e70: 616c 206c 6f63 6174 696f 6e20 220a 2020  al location ".  
-00009e80: 2020 2020 2020 2020 2020 226f 7220 7265            "or re
-00009e90: 7374 6172 7420 4d61 6573 7472 616c 2074  start Maestral t
-00009ea0: 6f20 7365 7420 7570 2061 206e 6577 2066  o set up a new f
-00009eb0: 6f6c 6465 722e 222c 0a20 2020 2020 2020  older.",.       
-00009ec0: 2029 0a0a 2020 2020 2020 2020 6966 206e   )..        if n
-00009ed0: 6f74 2069 7364 6972 2873 656c 662e 6472  ot isdir(self.dr
-00009ee0: 6f70 626f 785f 7061 7468 293a 0a20 2020  opbox_path):.   
-00009ef0: 2020 2020 2020 2020 2072 6169 7365 2065           raise e
-00009f00: 7863 6570 7469 6f6e 0a0a 2020 2020 2020  xception..      
-00009f10: 2020 2320 4966 2074 6865 2066 696c 6520    # If the file 
-00009f20: 7379 7374 656d 2069 7320 6e6f 7420 6361  system is not ca
-00009f30: 7365 2d73 656e 7369 7469 7665 2062 7574  se-sensitive but
-00009f40: 2070 7265 7365 7276 696e 672c 2061 2070   preserving, a p
-00009f50: 6174 6820 7768 6963 6820 7761 730a 2020  ath which was.  
-00009f60: 2020 2020 2020 2320 7265 6e61 6d65 6420        # renamed 
-00009f70: 7769 7468 2061 2063 6173 6520 6368 616e  with a case chan
-00009f80: 6765 206f 6e6c 7920 7769 6c6c 2073 7469  ge only will sti
-00009f90: 6c6c 2065 7869 7374 2061 7420 7468 6520  ll exist at the 
-00009fa0: 6f6c 6420 6c6f 6361 7469 6f6e 2e20 5765  old location. We
-00009fb0: 0a20 2020 2020 2020 2023 2074 6865 7265  .        # there
-00009fc0: 666f 7265 2065 7870 6c69 6369 746c 7920  fore explicitly 
-00009fd0: 6368 6563 6b20 666f 7220 6361 7365 2063  check for case c
-00009fe0: 6861 6e67 6573 2068 6572 652e 0a20 2020  hanges here..   
-00009ff0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-0000a000: 2e69 735f 6673 5f63 6173 655f 7365 6e73  .is_fs_case_sens
-0000a010: 6974 6976 653a 0a20 2020 2020 2020 2020  itive:.         
-0000a020: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0000a030: 2020 2020 2020 2020 6361 7365 645f 7061          cased_pa
-0000a040: 7468 203d 2074 6f5f 6578 6973 7469 6e67  th = to_existing
-0000a050: 5f75 6e6e 6f72 6d61 6c69 7a65 645f 7061  _unnormalized_pa
-0000a060: 7468 2873 656c 662e 6472 6f70 626f 785f  th(self.dropbox_
-0000a070: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
-0000a080: 2020 6578 6365 7074 2028 4669 6c65 4e6f    except (FileNo
-0000a090: 7446 6f75 6e64 4572 726f 722c 204e 6f74  tFoundError, Not
-0000a0a0: 4144 6972 6563 746f 7279 4572 726f 7229  ADirectoryError)
-0000a0b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a0c0: 2020 7261 6973 6520 6578 6365 7074 696f    raise exceptio
-0000a0d0: 6e0a 0a20 2020 2020 2020 2020 2020 2069  n..            i
-0000a0e0: 6620 6361 7365 645f 7061 7468 2021 3d20  f cased_path != 
-0000a0f0: 7365 6c66 2e64 726f 7062 6f78 5f70 6174  self.dropbox_pat
-0000a100: 683a 0a20 2020 2020 2020 2020 2020 2020  h:.             
-0000a110: 2020 2074 6974 6c65 203d 2022 4472 6f70     title = "Drop
-0000a120: 626f 7820 666f 6c64 6572 2072 656e 616d  box folder renam
-0000a130: 6564 220a 2020 2020 2020 2020 2020 2020  ed".            
-0000a140: 2020 2020 6d73 6720 3d20 280a 2020 2020      msg = (.    
-0000a150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a160: 2250 6c65 6173 6520 6d6f 7665 2074 6865  "Please move the
-0000a170: 2044 726f 7062 6f78 2066 6f6c 6465 7220   Dropbox folder 
-0000a180: 6261 636b 2074 6f20 6974 7320 6f72 6967  back to its orig
-0000a190: 696e 616c 206c 6f63 6174 696f 6e20 220a  inal location ".
-0000a1a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a1b0: 2020 2020 226f 7220 7265 7374 6172 7420      "or restart 
-0000a1c0: 4d61 6573 7472 616c 2074 6f20 7365 7420  Maestral to set 
-0000a1d0: 7570 2061 206e 6577 2066 6f6c 6465 722e  up a new folder.
-0000a1e0: 220a 2020 2020 2020 2020 2020 2020 2020  ".              
-0000a1f0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-0000a200: 2020 2020 7261 6973 6520 4e6f 4472 6f70      raise NoDrop
-0000a210: 626f 7844 6972 4572 726f 7228 7469 746c  boxDirError(titl
-0000a220: 652c 206d 7367 290a 0a20 2020 2064 6566  e, msg)..    def
-0000a230: 2065 6e73 7572 655f 6361 6368 655f 6469   ensure_cache_di
-0000a240: 725f 7072 6573 656e 7428 7365 6c66 2920  r_present(self) 
-0000a250: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-0000a260: 2022 2222 0a20 2020 2020 2020 2043 6865   """.        Che
-0000a270: 636b 7320 666f 7220 6f72 2063 7265 6174  cks for or creat
-0000a280: 6573 2061 2064 6972 6563 746f 7279 2061  es a directory a
-0000a290: 7420 3a61 7474 723a 6066 696c 655f 6361  t :attr:`file_ca
-0000a2a0: 6368 655f 7061 7468 602e 0a0a 2020 2020  che_path`...    
-0000a2b0: 2020 2020 3a72 6169 7365 7320 4361 6368      :raises Cach
-0000a2c0: 6544 6972 4572 726f 723a 2057 6865 6e20  eDirError: When 
-0000a2d0: 6c6f 6361 6c20 6361 6368 6520 6469 7265  local cache dire
-0000a2e0: 6374 6f72 7920 6361 6e6e 6f74 2062 6520  ctory cannot be 
-0000a2f0: 6372 6561 7465 642e 0a20 2020 2020 2020  created..       
-0000a300: 2022 2222 0a20 2020 2020 2020 2072 6574   """.        ret
-0000a310: 7269 6573 203d 2030 0a20 2020 2020 2020  ries = 0.       
-0000a320: 206d 6178 5f72 6574 7269 6573 203d 2031   max_retries = 1
-0000a330: 300a 0a20 2020 2020 2020 2077 6869 6c65  0..        while
-0000a340: 206e 6f74 2069 7364 6972 2873 656c 662e   not isdir(self.
-0000a350: 6669 6c65 5f63 6163 6865 5f70 6174 6829  file_cache_path)
-0000a360: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-0000a370: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-0000a380: 2020 2023 2054 6869 7320 7769 6c6c 2072     # This will r
-0000a390: 6169 7365 2046 696c 6545 7869 7374 7345  aise FileExistsE
-0000a3a0: 7272 6f72 2069 6620 6669 6c65 5f63 6163  rror if file_cac
-0000a3b0: 6865 5f70 6174 680a 2020 2020 2020 2020  he_path.        
-0000a3c0: 2020 2020 2020 2020 2320 6578 6973 7473          # exists
-0000a3d0: 2062 7574 2069 7320 6120 6669 6c65 2069   but is a file i
-0000a3e0: 6e73 7465 6164 206f 6620 6120 6469 7265  nstead of a dire
-0000a3f0: 6374 6f72 792e 0a20 2020 2020 2020 2020  ctory..         
-0000a400: 2020 2020 2020 206f 732e 6d61 6b65 6469         os.makedi
-0000a410: 7273 2873 656c 662e 6669 6c65 5f63 6163  rs(self.file_cac
-0000a420: 6865 5f70 6174 682c 2065 7869 7374 5f6f  he_path, exist_o
-0000a430: 6b3d 5472 7565 290a 2020 2020 2020 2020  k=True).        
-0000a440: 2020 2020 2020 2020 7265 7475 726e 0a20          return. 
-0000a450: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000a460: 7420 4669 6c65 4578 6973 7473 4572 726f  t FileExistsErro
-0000a470: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000a480: 2020 2023 2052 656d 6f76 6520 7468 6520     # Remove the 
-0000a490: 6669 6c65 2074 6861 7427 7320 696e 206f  file that's in o
-0000a4a0: 7572 2077 6179 2c20 7265 7472 7920 6372  ur way, retry cr
-0000a4b0: 6561 7469 6f6e 2e0a 2020 2020 2020 2020  eation..        
-0000a4c0: 2020 2020 2020 2020 7365 6c66 2e63 6c65          self.cle
-0000a4d0: 616e 5f63 6163 6865 5f64 6972 2829 0a20  an_cache_dir(). 
-0000a4e0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000a4f0: 7420 4e6f 7441 4469 7265 6374 6f72 7945  t NotADirectoryE
-0000a500: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
-0000a510: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
-0000a520: 6861 7420 7061 7265 6e74 2064 6972 6563  hat parent direc
-0000a530: 746f 7269 6573 2065 7869 7374 2061 7320  tories exist as 
-0000a540: 6578 7065 6374 6564 2e0a 2020 2020 2020  expected..      
-0000a550: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
-0000a560: 6e73 7572 655f 6472 6f70 626f 785f 666f  nsure_dropbox_fo
-0000a570: 6c64 6572 5f70 7265 7365 6e74 2829 0a20  lder_present(). 
-0000a580: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000a590: 7420 4f53 4572 726f 7220 6173 2065 7272  t OSError as err
-0000a5a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000a5b0: 2020 7261 6973 6520 4361 6368 6544 6972    raise CacheDir
-0000a5c0: 4572 726f 7228 0a20 2020 2020 2020 2020  Error(.         
-0000a5d0: 2020 2020 2020 2020 2020 2066 2243 616e             f"Can
-0000a5e0: 6e6f 7420 6372 6561 7465 2063 6163 6865  not create cache
-0000a5f0: 2064 6972 6563 746f 7279 3a20 7b65 7272   directory: {err
-0000a600: 2e73 7472 6572 726f 727d 222c 0a20 2020  .strerror}",.   
-0000a610: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a620: 2022 506c 6561 7365 2063 6865 636b 2069   "Please check i
-0000a630: 6620 796f 7520 6861 7665 2077 7269 7465  f you have write
-0000a640: 2070 6572 6d69 7373 696f 6e73 2066 6f72   permissions for
-0000a650: 2022 0a20 2020 2020 2020 2020 2020 2020   ".             
-0000a660: 2020 2020 2020 2066 227b 7365 6c66 2e5f         f"{self._
-0000a670: 6669 6c65 5f63 6163 6865 5f70 6174 687d  file_cache_path}
-0000a680: 2e22 2c0a 2020 2020 2020 2020 2020 2020  .",.            
-0000a690: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-0000a6a0: 2020 2069 6620 7265 7472 6965 7320 3e20     if retries > 
-0000a6b0: 6d61 785f 7265 7472 6965 733a 0a20 2020  max_retries:.   
-0000a6c0: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000a6d0: 7365 2043 6163 6865 4469 7245 7272 6f72  se CacheDirError
-0000a6e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0000a6f0: 2020 2020 2020 2243 616e 6e6f 7420 6372        "Cannot cr
-0000a700: 6561 7465 2063 6163 6865 2064 6972 6563  eate cache direc
-0000a710: 746f 7279 222c 0a20 2020 2020 2020 2020  tory",.         
-0000a720: 2020 2020 2020 2020 2020 2022 4578 6365             "Exce
-0000a730: 6564 6564 206d 6178 696d 756d 206e 756d  eded maximum num
-0000a740: 6265 7220 6f66 2072 6574 7269 6573 222c  ber of retries",
-0000a750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a760: 2029 0a0a 2020 2020 2020 2020 2020 2020   )..            
-0000a770: 7469 6d65 2e73 6c65 6570 2830 2e30 3129  time.sleep(0.01)
-0000a780: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0000a790: 7269 6573 202b 3d20 310a 0a20 2020 2064  ries += 1..    d
-0000a7a0: 6566 2063 6c65 616e 5f63 6163 6865 5f64  ef clean_cache_d
-0000a7b0: 6972 2873 656c 662c 2072 6169 7365 5f65  ir(self, raise_e
-0000a7c0: 7272 6f72 3a20 626f 6f6c 203d 2054 7275  rror: bool = Tru
-0000a7d0: 6529 202d 3e20 4e6f 6e65 3a0a 2020 2020  e) -> None:.    
-0000a7e0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000a7f0: 5265 6d6f 7665 7320 616c 6c20 6974 656d  Removes all item
-0000a800: 7320 696e 2074 6865 2063 6163 6865 2064  s in the cache d
-0000a810: 6972 6563 746f 7279 2e0a 0a20 2020 2020  irectory...     
-0000a820: 2020 203a 7061 7261 6d20 7261 6973 655f     :param raise_
-0000a830: 6572 726f 723a 2057 6865 7468 6572 2065  error: Whether e
-0000a840: 7272 6f72 7320 7368 6f75 6c64 2062 6520  rrors should be 
-0000a850: 7261 6973 6564 206f 7220 6f6e 6c79 206c  raised or only l
-0000a860: 6f67 6765 642e 0a20 2020 2020 2020 2022  ogged..        "
-0000a870: 2222 0a20 2020 2020 2020 2077 6974 6820  "".        with 
-0000a880: 7365 6c66 2e73 796e 635f 6c6f 636b 3a0a  self.sync_lock:.
-0000a890: 2020 2020 2020 2020 2020 2020 7472 793a              try:
-0000a8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a8b0: 2064 656c 6574 6528 7365 6c66 2e5f 6669   delete(self._fi
-0000a8c0: 6c65 5f63 6163 6865 5f70 6174 682c 2072  le_cache_path, r
-0000a8d0: 6169 7365 5f65 7272 6f72 3d54 7275 6529  aise_error=True)
-0000a8e0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000a8f0: 6570 7420 2846 696c 654e 6f74 466f 756e  ept (FileNotFoun
-0000a900: 6445 7272 6f72 2c20 4973 4144 6972 6563  dError, IsADirec
-0000a910: 746f 7279 4572 726f 7229 3a0a 2020 2020  toryError):.    
-0000a920: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0000a930: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
-0000a940: 6570 7420 4f53 4572 726f 7220 6173 2065  ept OSError as e
-0000a950: 7272 3a0a 2020 2020 2020 2020 2020 2020  rr:.            
-0000a960: 2020 2020 6578 6320 3d20 4361 6368 6544      exc = CacheD
-0000a970: 6972 4572 726f 7228 0a20 2020 2020 2020  irError(.       
-0000a980: 2020 2020 2020 2020 2020 2020 2066 2243               f"C
-0000a990: 616e 6e6f 7420 6372 6561 7465 2063 6163  annot create cac
-0000a9a0: 6865 2064 6972 6563 746f 7279 3a20 7b65  he directory: {e
-0000a9b0: 7272 2e73 7472 6572 726f 727d 222c 0a20  rr.strerror}",. 
-0000a9c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000a9d0: 2020 2022 506c 6561 7365 2063 6865 636b     "Please check
-0000a9e0: 2069 6620 796f 7520 6861 7665 2077 7269   if you have wri
-0000a9f0: 7465 2070 6572 6d69 7373 696f 6e73 2066  te permissions f
-0000aa00: 6f72 2022 0a20 2020 2020 2020 2020 2020  or ".           
-0000aa10: 2020 2020 2020 2020 2066 227b 7365 6c66           f"{self
-0000aa20: 2e5f 6669 6c65 5f63 6163 6865 5f70 6174  ._file_cache_pat
-0000aa30: 687d 2e22 2c0a 2020 2020 2020 2020 2020  h}.",.          
-0000aa40: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
-0000aa50: 2020 2020 2020 2020 2069 6620 7261 6973           if rais
-0000aa60: 655f 6572 726f 723a 0a20 2020 2020 2020  e_error:.       
-0000aa70: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0000aa80: 7365 2065 7863 0a0a 2020 2020 2020 2020  se exc..        
-0000aa90: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-0000aaa0: 6767 6572 2e65 7272 6f72 2865 7863 2e74  gger.error(exc.t
-0000aab0: 6974 6c65 2c20 6578 635f 696e 666f 3d65  itle, exc_info=e
-0000aac0: 7863 5f69 6e66 6f5f 7475 706c 6528 6578  xc_info_tuple(ex
-0000aad0: 6329 290a 2020 2020 2020 2020 2020 2020  c)).            
-0000aae0: 2020 2020 6966 2073 656c 662e 6465 736b      if self.desk
-0000aaf0: 746f 705f 6e6f 7469 6669 6572 3a0a 2020  top_notifier:.  
-0000ab00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab10: 2020 7365 6c66 2e64 6573 6b74 6f70 5f6e    self.desktop_n
-0000ab20: 6f74 6966 6965 722e 6e6f 7469 6679 280a  otifier.notify(.
-0000ab30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ab40: 2020 2020 2020 2020 6578 632e 7469 746c          exc.titl
-0000ab50: 652c 2065 7863 2e6d 6573 7361 6765 2c20  e, exc.message, 
-0000ab60: 6c65 7665 6c3d 6e6f 7469 6679 2e45 5252  level=notify.ERR
-0000ab70: 4f52 0a20 2020 2020 2020 2020 2020 2020  OR.             
-0000ab80: 2020 2020 2020 2029 0a0a 2020 2020 6465         )..    de
-0000ab90: 6620 5f6e 6577 5f74 6d70 5f66 696c 6528  f _new_tmp_file(
-0000aba0: 7365 6c66 2920 2d3e 2073 7472 3a0a 2020  self) -> str:.  
-0000abb0: 2020 2020 2020 2222 2243 7265 6174 6573        """Creates
-0000abc0: 2061 206e 6577 2074 656d 706f 7261 7279   a new temporary
-0000abd0: 2066 696c 6520 696e 206f 7572 2063 6163   file in our cac
-0000abe0: 6865 2064 6972 6563 746f 7279 2061 6e64  he directory and
-0000abf0: 2072 6574 7572 6e73 2069 7473 2070 6174   returns its pat
-0000ac00: 682e 2222 220a 2020 2020 2020 2020 7365  h.""".        se
-0000ac10: 6c66 2e65 6e73 7572 655f 6361 6368 655f  lf.ensure_cache_
-0000ac20: 6469 725f 7072 6573 656e 7428 290a 2020  dir_present().  
-0000ac30: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-0000ac40: 2020 2020 2020 2077 6974 6820 4e61 6d65         with Name
-0000ac50: 6454 656d 706f 7261 7279 4669 6c65 2864  dTemporaryFile(d
-0000ac60: 6972 3d73 656c 662e 6669 6c65 5f63 6163  ir=self.file_cac
-0000ac70: 6865 5f70 6174 682c 2064 656c 6574 653d  he_path, delete=
-0000ac80: 4661 6c73 6529 2061 7320 663a 0a20 2020  False) as f:.   
-0000ac90: 2020 2020 2020 2020 2020 2020 2074 7279               try
-0000aca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000acb0: 2020 2020 2020 6f73 2e63 686d 6f64 2866        os.chmod(f
-0000acc0: 2e66 696c 656e 6f28 292c 2030 6f36 3636  .fileno(), 0o666
-0000acd0: 2026 207e 756d 6173 6b29 0a20 2020 2020   & ~umask).     
-0000ace0: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-0000acf0: 7420 4f53 4572 726f 7220 6173 2065 7272  t OSError as err
-0000ad00: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000ad10: 2020 2020 2020 2320 4361 6e20 6f63 6375        # Can occu
-0000ad20: 7220 6f6e 2066 696c 6520 7379 7374 656d  r on file system
-0000ad30: 2773 2074 6861 7420 646f 6e27 7420 7375  's that don't su
-0000ad40: 7070 6f72 7420 504f 5349 5820 7065 726d  pport POSIX perm
-0000ad50: 6973 7369 6f6e 730a 2020 2020 2020 2020  issions.        
-0000ad60: 2020 2020 2020 2020 2020 2020 2320 7375              # su
-0000ad70: 6368 2061 7320 4e54 4653 206d 6f75 6e74  ch as NTFS mount
-0000ad80: 6564 2077 6974 686f 7574 2074 6865 2070  ed without the p
-0000ad90: 6572 6d69 7373 696f 6e73 206f 7074 696f  ermissions optio
-0000ada0: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
-0000adb0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-0000adc0: 6765 722e 6465 6275 6728 2243 616e 6e6f  ger.debug("Canno
-0000add0: 7420 7365 7420 7065 726d 6973 7369 6f6e  t set permission
-0000ade0: 733a 2025 7322 2c20 6572 722e 7374 7265  s: %s", err.stre
-0000adf0: 7272 6f72 290a 2020 2020 2020 2020 2020  rror).          
-0000ae00: 2020 2020 2020 7265 7475 726e 2066 2e6e        return f.n
-0000ae10: 616d 650a 2020 2020 2020 2020 6578 6365  ame.        exce
-0000ae20: 7074 204f 5345 7272 6f72 2061 7320 6572  pt OSError as er
-0000ae30: 723a 0a20 2020 2020 2020 2020 2020 2072  r:.            r
-0000ae40: 6169 7365 2043 6163 6865 4469 7245 7272  aise CacheDirErr
-0000ae50: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
-0000ae60: 2020 2020 6622 4361 6e6e 6f74 2063 7265      f"Cannot cre
-0000ae70: 6174 6520 6361 6368 6520 6469 7265 6374  ate cache direct
-0000ae80: 6f72 793a 207b 6572 722e 7374 7265 7272  ory: {err.strerr
-0000ae90: 6f72 7d22 2c0a 2020 2020 2020 2020 2020  or}",.          
-0000aea0: 2020 2020 2020 2250 6c65 6173 6520 6368        "Please ch
-0000aeb0: 6563 6b20 6966 2079 6f75 2068 6176 6520  eck if you have 
-0000aec0: 7772 6974 6520 7065 726d 6973 7369 6f6e  write permission
-0000aed0: 7320 666f 7220 220a 2020 2020 2020 2020  s for ".        
-0000aee0: 2020 2020 2020 2020 6622 7b73 656c 662e          f"{self.
-0000aef0: 5f66 696c 655f 6361 6368 655f 7061 7468  _file_cache_path
-0000af00: 7d2e 222c 0a20 2020 2020 2020 2020 2020  }.",.           
-0000af10: 2029 0a0a 2020 2020 6465 6620 636f 7272   )..    def corr
-0000af20: 6563 745f 6361 7365 2873 656c 662c 2064  ect_case(self, d
-0000af30: 6278 5f70 6174 683a 2073 7472 2920 2d3e  bx_path: str) ->
-0000af40: 2073 7472 3a0a 2020 2020 2020 2020 2222   str:.        ""
-0000af50: 220a 2020 2020 2020 2020 436f 6e76 6572  ".        Conver
-0000af60: 7473 2061 2044 726f 7062 6f78 2070 6174  ts a Dropbox pat
-0000af70: 6820 7769 7468 2063 6f72 7265 6374 6c79  h with correctly
-0000af80: 2063 6173 6564 2062 6173 656e 616d 6520   cased basename 
-0000af90: 746f 2061 2066 756c 6c79 2063 6173 6564  to a fully cased
-0000afa0: 2070 6174 682e 0a20 2020 2020 2020 2054   path..        T
-0000afb0: 6869 7320 6973 2075 7365 6675 6c20 6265  his is useful be
-0000afc0: 6361 7573 6520 7468 6520 4472 6f70 626f  cause the Dropbo
-0000afd0: 7820 4150 4920 6775 6172 616e 7465 6573  x API guarantees
-0000afe0: 2074 6865 2063 6f72 7265 6374 2063 6173   the correct cas
-0000aff0: 696e 6720 666f 7220 7468 650a 2020 2020  ing for the.    
-0000b000: 2020 2020 6261 7365 6e61 6d65 206f 6e6c      basename onl
-0000b010: 792e 2049 6e20 7072 6163 7469 6365 2c20  y. In practice, 
-0000b020: 6361 7369 6e67 206f 6620 7061 7265 6e74  casing of parent
-0000b030: 2064 6972 6563 746f 7269 6573 2069 7320   directories is 
-0000b040: 6f66 7465 6e20 696e 636f 7272 6563 742e  often incorrect.
-0000b050: 0a20 2020 2020 2020 2054 6869 7320 6d65  .        This me
-0000b060: 7468 6f64 2072 6574 7269 6576 6573 2074  thod retrieves t
-0000b070: 6865 2063 6f72 7265 6374 2063 6173 696e  he correct casin
-0000b080: 6720 6f66 2061 6c6c 2061 6e63 6573 746f  g of all ancesto
-0000b090: 7273 2069 6e20 7468 6520 7061 7468 2c20  rs in the path, 
-0000b0a0: 6569 7468 6572 0a20 2020 2020 2020 2066  either.        f
-0000b0b0: 726f 6d20 6f75 7220 6361 6368 652c 206f  rom our cache, o
-0000b0c0: 7572 2064 6174 6162 6173 652c 206f 7220  ur database, or 
-0000b0d0: 6672 6f6d 2044 726f 7062 6f78 2073 6572  from Dropbox ser
-0000b0e0: 7665 7273 2e0a 0a20 2020 2020 2020 2050  vers...        P
-0000b0f0: 6572 666f 726d 616e 6365 206d 6179 2076  erformance may v
-0000b100: 6172 7920 7369 676e 6966 6963 616e 746c  ary significantl
-0000b110: 7920 7769 7468 2074 6865 206e 756d 6265  y with the numbe
-0000b120: 7220 6f66 2070 6172 656e 7420 666f 6c64  r of parent fold
-0000b130: 6572 7320 616e 6420 7468 650a 2020 2020  ers and the.    
-0000b140: 2020 2020 6d65 7468 6f64 2075 7365 6420      method used 
-0000b150: 746f 2072 6573 6f6c 7665 2074 6865 2063  to resolve the c
-0000b160: 6173 696e 6720 6f66 2061 6c6c 2070 6172  asing of all par
-0000b170: 656e 7420 6469 7265 6374 6f72 7920 6e61  ent directory na
-0000b180: 6d65 733a 0a0a 2020 2020 2020 2020 3129  mes:..        1)
-0000b190: 2049 6620 7468 6520 7061 7265 6e74 2064   If the parent d
-0000b1a0: 6972 6563 746f 7279 2069 7320 616c 7265  irectory is alre
-0000b1b0: 6164 7920 696e 206f 7572 2063 6163 6865  ady in our cache
-0000b1c0: 2c20 7065 7266 6f72 6d61 6e63 6520 6973  , performance is
-0000b1d0: 204f 2831 292e 0a20 2020 2020 2020 2032   O(1)..        2
-0000b1e0: 2920 4966 2074 6865 2070 6172 656e 7420  ) If the parent 
-0000b1f0: 6469 7265 6374 6f72 7920 6973 2061 6c72  directory is alr
-0000b200: 6561 6479 2069 6e20 6f75 7220 7379 6e63  eady in our sync
-0000b210: 2069 6e64 6578 2c20 7065 7266 6f72 6d61   index, performa
-0000b220: 6e63 6520 6973 2073 6c6f 7765 720a 2020  nce is slower.  
-0000b230: 2020 2020 2020 2020 2062 6563 6175 7365           because
-0000b240: 2069 7420 7265 7175 6972 6573 2061 2073   it requires a s
-0000b250: 716c 6974 6520 7175 6572 7920 6275 7420  qlite query but 
-0000b260: 7374 696c 6c20 4f28 3129 2e0a 2020 2020  still O(1)..    
-0000b270: 2020 2020 3329 2049 6620 7468 6520 7061      3) If the pa
-0000b280: 7265 6e74 2064 6972 6563 746f 7279 2069  rent directory i
-0000b290: 7320 756e 6b6e 6f77 6e20 746f 2075 732c  s unknown to us,
-0000b2a0: 2069 7473 206d 6574 6164 6174 6120 2869   its metadata (i
-0000b2b0: 6e63 6c75 6469 6e67 2074 6865 2063 6f72  ncluding the cor
-0000b2c0: 7265 6374 0a20 2020 2020 2020 2020 2020  rect.           
-0000b2d0: 6361 7369 6e67 206f 6620 6469 7265 6374  casing of direct
-0000b2e0: 6f72 7927 7320 6261 7365 6e61 6d65 2920  ory's basename) 
-0000b2f0: 6973 2071 7565 7269 6564 2066 726f 6d20  is queried from 
-0000b300: 4472 6f70 626f 782e 2054 6869 7320 6973  Dropbox. This is
-0000b310: 2075 7365 6420 746f 0a20 2020 2020 2020   used to.       
-0000b320: 2020 2020 636f 6e73 7472 7563 7420 6120      construct a 
-0000b330: 636f 7272 6563 746c 7920 6361 7365 6420  correctly cased 
-0000b340: 7061 7468 2062 7920 6361 6c6c 696e 6720  path by calling 
-0000b350: 3a6d 6574 683a 6063 6f72 7265 6374 5f63  :meth:`correct_c
-0000b360: 6173 6560 2061 6761 696e 2e20 4174 0a20  ase` again. At. 
-0000b370: 2020 2020 2020 2020 2020 6265 7374 2c20            best, 
-0000b380: 7065 7266 6f72 6d61 6e63 6520 7769 6c6c  performance will
-0000b390: 2062 6520 6f66 204f 2832 2920 6966 2074   be of O(2) if t
-0000b3a0: 6865 2070 6172 656e 7420 6469 7265 6374  he parent direct
-0000b3b0: 6f72 7920 6973 206b 6e6f 776e 2074 6f20  ory is known to 
-0000b3c0: 7573 2c20 6174 0a20 2020 2020 2020 2020  us, at.         
-0000b3d0: 2020 776f 7273 7420 6974 2077 696c 6c20    worst it will 
-0000b3e0: 6265 206f 6620 6f72 6465 7220 4f28 6e29  be of order O(n)
-0000b3f0: 2069 6e76 6f6c 7669 6e67 2071 7565 7269   involving queri
-0000b400: 6573 2074 6f20 4472 6f70 626f 7820 7365  es to Dropbox se
-0000b410: 7276 6572 7320 666f 7220 6561 6368 0a20  rvers for each. 
-0000b420: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
-0000b430: 2064 6972 6563 746f 7279 2e0a 0a20 2020   directory...   
-0000b440: 2020 2020 2057 6865 6e20 6361 6c6c 696e       When callin
-0000b450: 6720 3a6d 6574 683a 6063 6f72 7265 6374  g :meth:`correct
-0000b460: 5f63 6173 6560 2072 6570 6561 7465 646c  _case` repeatedl
-0000b470: 7920 666f 7220 7061 7468 7320 6672 6f6d  y for paths from
-0000b480: 2074 6865 2073 616d 6520 7472 6565 2c20   the same tree, 
-0000b490: 6974 2069 730a 2020 2020 2020 2020 7468  it is.        th
-0000b4a0: 6572 6566 6f72 6520 6265 7374 2074 6f20  erefore best to 
-0000b4b0: 646f 2073 6f20 696e 2068 6965 7261 7263  do so in hierarc
-0000b4c0: 6869 6361 6c20 6f72 6465 722e 0a0a 2020  hical order...  
-0000b4d0: 2020 2020 2020 3a70 6172 616d 2064 6278        :param dbx
-0000b4e0: 5f70 6174 683a 2044 726f 7062 6f78 2070  _path: Dropbox p
-0000b4f0: 6174 6820 7769 7468 2063 6f72 7265 6374  ath with correct
-0000b500: 6c79 2063 6173 6564 2062 6173 656e 616d  ly cased basenam
-0000b510: 652c 2061 7320 7072 6f76 6964 6564 2062  e, as provided b
-0000b520: 790a 2020 2020 2020 2020 2020 2020 3a61  y.            :a
-0000b530: 7474 723a 6064 726f 7062 6f78 2e66 696c  ttr:`dropbox.fil
-0000b540: 6573 2e4d 6574 6164 6174 612e 7061 7468  es.Metadata.path
-0000b550: 5f64 6973 706c 6179 6020 6f72 0a20 2020  _display` or.   
-0000b560: 2020 2020 2020 2020 203a 6174 7472 3a60           :attr:`
-0000b570: 6472 6f70 626f 782e 6669 6c65 732e 4d65  dropbox.files.Me
-0000b580: 7461 6461 7461 2e6e 616d 6560 2e0a 2020  tadata.name`..  
-0000b590: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000b5a0: 436f 7272 6563 746c 7920 6361 7365 6420  Correctly cased 
-0000b5b0: 4472 6f70 626f 7820 7061 7468 2e0a 2020  Dropbox path..  
-0000b5c0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000b5d0: 2020 6462 785f 7061 7468 5f6c 6f77 6572    dbx_path_lower
-0000b5e0: 203d 206e 6f72 6d61 6c69 7a65 2864 6278   = normalize(dbx
-0000b5f0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-0000b600: 6469 726e 616d 652c 2062 6173 656e 616d  dirname, basenam
-0000b610: 6520 3d20 6f73 702e 7370 6c69 7428 6462  e = osp.split(db
-0000b620: 785f 7061 7468 290a 2020 2020 2020 2020  x_path).        
-0000b630: 6469 726e 616d 655f 6c6f 7765 7220 3d20  dirname_lower = 
-0000b640: 6f73 702e 6469 726e 616d 6528 6462 785f  osp.dirname(dbx_
-0000b650: 7061 7468 5f6c 6f77 6572 290a 0a20 2020  path_lower)..   
-0000b660: 2020 2020 2064 6972 6e61 6d65 5f63 6173       dirname_cas
-0000b670: 6564 203d 2073 656c 662e 5f63 6f72 7265  ed = self._corre
-0000b680: 6374 5f63 6173 655f 6865 6c70 6572 2864  ct_case_helper(d
-0000b690: 6972 6e61 6d65 2c20 6469 726e 616d 655f  irname, dirname_
-0000b6a0: 6c6f 7765 7229 0a20 2020 2020 2020 2070  lower).        p
-0000b6b0: 6174 685f 6361 7365 6420 3d20 6f73 702e  ath_cased = osp.
-0000b6c0: 6a6f 696e 2864 6972 6e61 6d65 5f63 6173  join(dirname_cas
-0000b6d0: 6564 2c20 6261 7365 6e61 6d65 290a 0a20  ed, basename).. 
-0000b6e0: 2020 2020 2020 2023 2041 6464 206f 7572         # Add our
-0000b6f0: 2072 6573 756c 7420 746f 2074 6865 2063   result to the c
-0000b700: 6163 6865 2e0a 2020 2020 2020 2020 7365  ache..        se
-0000b710: 6c66 2e5f 6361 7365 5f63 6f6e 7665 7273  lf._case_convers
-0000b720: 696f 6e5f 6361 6368 652e 7075 7428 6462  ion_cache.put(db
-0000b730: 785f 7061 7468 5f6c 6f77 6572 2c20 7061  x_path_lower, pa
-0000b740: 7468 5f63 6173 6564 290a 0a20 2020 2020  th_cased)..     
-0000b750: 2020 2072 6574 7572 6e20 7061 7468 5f63     return path_c
-0000b760: 6173 6564 0a0a 2020 2020 6465 6620 5f63  ased..    def _c
-0000b770: 6f72 7265 6374 5f63 6173 655f 6865 6c70  orrect_case_help
-0000b780: 6572 2873 656c 662c 2064 6278 5f70 6174  er(self, dbx_pat
-0000b790: 683a 2073 7472 2c20 6462 785f 7061 7468  h: str, dbx_path
-0000b7a0: 5f6c 6f77 6572 3a20 7374 7229 202d 3e20  _lower: str) -> 
-0000b7b0: 7374 723a 0a20 2020 2020 2020 2022 2222  str:.        """
-0000b7c0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000b7d0: 6462 785f 7061 7468 3a20 556e 6361 7365  dbx_path: Uncase
-0000b7e0: 6420 6f72 2072 616e 646f 6d6c 7920 6361  d or randomly ca
-0000b7f0: 7365 6420 4472 6f70 626f 7820 7061 7468  sed Dropbox path
-0000b800: 2e0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-0000b810: 2064 6278 5f70 6174 685f 6c6f 7765 723a   dbx_path_lower:
-0000b820: 204e 6f72 6d61 6c69 7a65 6420 6675 6c6c   Normalized full
-0000b830: 7920 6c6f 7765 7220 6361 7365 6420 4472  y lower cased Dr
-0000b840: 6f70 626f 7820 7061 7468 2e0a 2020 2020  opbox path..    
-0000b850: 2020 2020 3a72 6574 7572 6e73 3a20 436f      :returns: Co
-0000b860: 7272 6563 746c 7920 6361 7365 6420 4472  rrectly cased Dr
-0000b870: 6f70 626f 7820 7061 7468 2e0a 2020 2020  opbox path..    
-0000b880: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000b890: 2320 4368 6563 6b20 666f 7220 726f 6f74  # Check for root
-0000b8a0: 2066 6f6c 6465 722e 0a20 2020 2020 2020   folder..       
-0000b8b0: 2069 6620 6462 785f 7061 7468 203d 3d20   if dbx_path == 
-0000b8c0: 222f 223a 0a20 2020 2020 2020 2020 2020  "/":.           
-0000b8d0: 2072 6574 7572 6e20 6462 785f 7061 7468   return dbx_path
-0000b8e0: 0a0a 2020 2020 2020 2020 2320 4368 6563  ..        # Chec
-0000b8f0: 6b20 696e 206f 7572 2063 6f6e 7665 7273  k in our convers
-0000b900: 696f 6e20 6361 6368 652e 0a20 2020 2020  ion cache..     
-0000b910: 2020 2064 6278 5f70 6174 685f 6361 7365     dbx_path_case
-0000b920: 6420 3d20 7365 6c66 2e5f 6361 7365 5f63  d = self._case_c
-0000b930: 6f6e 7665 7273 696f 6e5f 6361 6368 652e  onversion_cache.
-0000b940: 6765 7428 6462 785f 7061 7468 5f6c 6f77  get(dbx_path_low
-0000b950: 6572 290a 0a20 2020 2020 2020 2069 6620  er)..        if 
-0000b960: 6462 785f 7061 7468 5f63 6173 6564 3a0a  dbx_path_cased:.
-0000b970: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000b980: 726e 2064 6278 5f70 6174 685f 6361 7365  rn dbx_path_case
-0000b990: 640a 0a20 2020 2020 2020 2023 2054 7279  d..        # Try
-0000b9a0: 2074 6f20 6765 7420 6361 7369 6e67 2066   to get casing f
-0000b9b0: 726f 6d20 6f75 7220 696e 6465 782c 2074  rom our index, t
-0000b9c0: 6869 7320 6973 2073 6c6f 7765 722e 0a20  his is slower.. 
-0000b9d0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0000b9e0: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
-0000b9f0: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000ba00: 2065 6e74 7279 203d 2073 656c 662e 6765   entry = self.ge
-0000ba10: 745f 696e 6465 785f 656e 7472 7928 6462  t_index_entry(db
-0000ba20: 785f 7061 7468 5f6c 6f77 6572 290a 0a20  x_path_lower).. 
-0000ba30: 2020 2020 2020 2069 6620 656e 7472 793a         if entry:
-0000ba40: 0a20 2020 2020 2020 2020 2020 2064 6278  .            dbx
-0000ba50: 5f70 6174 685f 6361 7365 6420 3d20 656e  _path_cased = en
-0000ba60: 7472 792e 6462 785f 7061 7468 5f63 6173  try.dbx_path_cas
-0000ba70: 6564 0a20 2020 2020 2020 2065 6c73 653a  ed.        else:
-0000ba80: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
-0000ba90: 616c 6c20 6261 636b 2074 6f20 7175 6572  all back to quer
-0000baa0: 7969 6e67 2066 726f 6d20 7365 7276 6572  ying from server
-0000bab0: 2e0a 2020 2020 2020 2020 2020 2020 6d64  ..            md
-0000bac0: 203d 2073 656c 662e 636c 6965 6e74 2e67   = self.client.g
-0000bad0: 6574 5f6d 6574 6164 6174 6128 6462 785f  et_metadata(dbx_
-0000bae0: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
-0000baf0: 2020 6966 206d 643a 0a20 2020 2020 2020    if md:.       
-0000bb00: 2020 2020 2020 2020 2023 2052 6563 7572           # Recur
-0000bb10: 7365 206f 7665 7220 7061 7265 6e74 2064  se over parent d
-0000bb20: 6972 6563 746f 7269 6573 2e0a 2020 2020  irectories..    
-0000bb30: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
-0000bb40: 7061 7468 5f63 6173 6564 203d 2073 656c  path_cased = sel
-0000bb50: 662e 636f 7272 6563 745f 6361 7365 286d  f.correct_case(m
-0000bb60: 642e 7061 7468 5f64 6973 706c 6179 290a  d.path_display).
-0000bb70: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000bb80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000bb90: 2020 2320 4769 7665 2075 702e 0a20 2020    # Give up..   
-0000bba0: 2020 2020 2020 2020 2020 2020 2064 6278               dbx
-0000bbb0: 5f70 6174 685f 6361 7365 6420 3d20 6462  _path_cased = db
-0000bbc0: 785f 7061 7468 0a0a 2020 2020 2020 2020  x_path..        
-0000bbd0: 2320 4164 6420 6f75 7220 7265 7375 6c74  # Add our result
-0000bbe0: 2074 6f20 7468 6520 6361 6368 652e 0a20   to the cache.. 
-0000bbf0: 2020 2020 2020 2073 656c 662e 5f63 6173         self._cas
-0000bc00: 655f 636f 6e76 6572 7369 6f6e 5f63 6163  e_conversion_cac
-0000bc10: 6865 2e70 7574 2864 6278 5f70 6174 685f  he.put(dbx_path_
-0000bc20: 6c6f 7765 722c 2064 6278 5f70 6174 685f  lower, dbx_path_
-0000bc30: 6361 7365 6429 0a0a 2020 2020 2020 2020  cased)..        
-0000bc40: 7265 7475 726e 2064 6278 5f70 6174 685f  return dbx_path_
-0000bc50: 6361 7365 640a 0a20 2020 2064 6566 2074  cased..    def t
-0000bc60: 6f5f 6462 785f 7061 7468 2873 656c 662c  o_dbx_path(self,
-0000bc70: 206c 6f63 616c 5f70 6174 683a 2073 7472   local_path: str
-0000bc80: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
-0000bc90: 2020 2222 220a 2020 2020 2020 2020 436f    """.        Co
-0000bca0: 6e76 6572 7473 2061 206c 6f63 616c 2070  nverts a local p
-0000bcb0: 6174 6820 746f 2061 2070 6174 6820 7265  ath to a path re
-0000bcc0: 6c61 7469 7665 2074 6f20 7468 6520 4472  lative to the Dr
-0000bcd0: 6f70 626f 7820 666f 6c64 6572 2e20 4361  opbox folder. Ca
-0000bce0: 7369 6e67 206f 6620 7468 650a 2020 2020  sing of the.    
-0000bcf0: 2020 2020 6769 7665 6e20 6060 6c6f 6361      given ``loca
-0000bd00: 6c5f 7061 7468 6060 2077 696c 6c20 6265  l_path`` will be
-0000bd10: 2070 7265 7365 7276 6564 2e0a 0a20 2020   preserved...   
-0000bd20: 2020 2020 203a 7061 7261 6d20 6c6f 6361       :param loca
-0000bd30: 6c5f 7061 7468 3a20 4162 736f 6c75 7465  l_path: Absolute
-0000bd40: 2070 6174 6820 6f6e 206c 6f63 616c 2064   path on local d
-0000bd50: 7269 7665 2e0a 2020 2020 2020 2020 3a72  rive..        :r
-0000bd60: 6574 7572 6e73 3a20 5265 6c61 7469 7665  eturns: Relative
-0000bd70: 2070 6174 6820 7769 7468 2072 6573 7065   path with respe
-0000bd80: 6374 2074 6f20 4472 6f70 626f 7820 666f  ct to Dropbox fo
-0000bd90: 6c64 6572 2e0a 2020 2020 2020 2020 3a72  lder..        :r
-0000bda0: 6169 7365 7320 5661 6c75 6545 7272 6f72  aises ValueError
-0000bdb0: 3a20 5768 656e 2074 6865 2070 6174 6820  : When the path 
-0000bdc0: 6c69 6573 206f 7574 7369 6465 2074 6865  lies outside the
-0000bdd0: 206c 6f63 616c 2044 726f 7062 6f78 2066   local Dropbox f
-0000bde0: 6f6c 6465 722e 0a20 2020 2020 2020 2022  older..        "
-0000bdf0: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
-0000be00: 7420 6973 5f65 7175 616c 5f6f 725f 6368  t is_equal_or_ch
-0000be10: 696c 6428 0a20 2020 2020 2020 2020 2020  ild(.           
-0000be20: 206c 6f63 616c 5f70 6174 682c 2073 656c   local_path, sel
-0000be30: 662e 6472 6f70 626f 785f 7061 7468 2c20  f.dropbox_path, 
-0000be40: 7365 6c66 2e69 735f 6673 5f63 6173 655f  self.is_fs_case_
-0000be50: 7365 6e73 6974 6976 650a 2020 2020 2020  sensitive.      
-0000be60: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
-0000be70: 2072 6169 7365 2056 616c 7565 4572 726f   raise ValueErro
-0000be80: 7228 6627 227b 6c6f 6361 6c5f 7061 7468  r(f'"{local_path
-0000be90: 7d22 2069 7320 6e6f 7420 696e 2022 7b73  }" is not in "{s
-0000bea0: 656c 662e 6472 6f70 626f 785f 7061 7468  elf.dropbox_path
-0000beb0: 7d22 2729 0a20 2020 2020 2020 2072 6574  }"').        ret
-0000bec0: 7572 6e20 222f 2220 2b20 7265 6d6f 7665  urn "/" + remove
-0000bed0: 7072 6566 6978 280a 2020 2020 2020 2020  prefix(.        
-0000bee0: 2020 2020 6c6f 6361 6c5f 7061 7468 2c20      local_path, 
-0000bef0: 7365 6c66 2e64 726f 7062 6f78 5f70 6174  self.dropbox_pat
-0000bf00: 682c 2073 656c 662e 6973 5f66 735f 6361  h, self.is_fs_ca
-0000bf10: 7365 5f73 656e 7369 7469 7665 0a20 2020  se_sensitive.   
-0000bf20: 2020 2020 2029 2e6c 7374 7269 7028 222f       ).lstrip("/
-0000bf30: 2229 0a0a 2020 2020 6465 6620 746f 5f64  ")..    def to_d
-0000bf40: 6278 5f70 6174 685f 6c6f 7765 7228 7365  bx_path_lower(se
-0000bf50: 6c66 2c20 6c6f 6361 6c5f 7061 7468 3a20  lf, local_path: 
-0000bf60: 7374 7229 202d 3e20 7374 723a 0a20 2020  str) -> str:.   
-0000bf70: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000bf80: 2043 6f6e 7665 7274 7320 6120 6c6f 6361   Converts a loca
-0000bf90: 6c20 7061 7468 2074 6f20 6120 7061 7468  l path to a path
-0000bfa0: 2072 656c 6174 6976 6520 746f 2074 6865   relative to the
-0000bfb0: 2044 726f 7062 6f78 2066 6f6c 6465 722e   Dropbox folder.
-0000bfc0: 2054 6865 2070 6174 6820 7769 6c6c 2062   The path will b
-0000bfd0: 650a 2020 2020 2020 2020 6e6f 726d 616c  e.        normal
-0000bfe0: 697a 6564 2061 7320 6f6e 2044 726f 7062  ized as on Dropb
-0000bff0: 6f78 2073 6572 7665 7273 2028 6c6f 7765  ox servers (lowe
-0000c000: 7220 6361 7365 2061 6e64 2073 6f6d 6520  r case and some 
-0000c010: 6164 6469 7469 6f6e 616c 0a20 2020 2020  additional.     
-0000c020: 2020 206e 6f72 6d61 6c69 7361 7469 6f6e     normalisation
-0000c030: 7329 2e0a 0a20 2020 2020 2020 203a 7061  s)...        :pa
-0000c040: 7261 6d20 6c6f 6361 6c5f 7061 7468 3a20  ram local_path: 
-0000c050: 4162 736f 6c75 7465 2070 6174 6820 6f6e  Absolute path on
-0000c060: 206c 6f63 616c 2064 7269 7665 2e0a 2020   local drive..  
-0000c070: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-0000c080: 5265 6c61 7469 7665 2070 6174 6820 7769  Relative path wi
-0000c090: 7468 2072 6573 7065 6374 2074 6f20 4472  th respect to Dr
-0000c0a0: 6f70 626f 7820 666f 6c64 6572 2e0a 2020  opbox folder..  
-0000c0b0: 2020 2020 2020 3a72 6169 7365 7320 5661        :raises Va
-0000c0c0: 6c75 6545 7272 6f72 3a20 5768 656e 2074  lueError: When t
-0000c0d0: 6865 2070 6174 6820 6c69 6573 206f 7574  he path lies out
-0000c0e0: 7369 6465 2074 6865 206c 6f63 616c 2044  side the local D
-0000c0f0: 726f 7062 6f78 2066 6f6c 6465 722e 0a20  ropbox folder.. 
-0000c100: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0000c110: 2020 2072 6574 7572 6e20 6e6f 726d 616c     return normal
-0000c120: 697a 6528 7365 6c66 2e74 6f5f 6462 785f  ize(self.to_dbx_
-0000c130: 7061 7468 286c 6f63 616c 5f70 6174 6829  path(local_path)
-0000c140: 290a 0a20 2020 2064 6566 2074 6f5f 6c6f  )..    def to_lo
-0000c150: 6361 6c5f 7061 7468 5f66 726f 6d5f 6361  cal_path_from_ca
-0000c160: 7365 6428 7365 6c66 2c20 6462 785f 7061  sed(self, dbx_pa
-0000c170: 7468 5f63 6173 6564 3a20 7374 7229 202d  th_cased: str) -
-0000c180: 3e20 7374 723a 0a20 2020 2020 2020 2022  > str:.        "
-0000c190: 2222 0a20 2020 2020 2020 2043 6f6e 7665  "".        Conve
-0000c1a0: 7274 7320 6120 636f 7272 6563 746c 7920  rts a correctly 
-0000c1b0: 6361 7365 6420 4472 6f70 626f 7820 7061  cased Dropbox pa
-0000c1c0: 7468 2074 6f20 7468 6520 636f 7272 6573  th to the corres
-0000c1d0: 706f 6e64 696e 6720 6c6f 6361 6c20 7061  ponding local pa
-0000c1e0: 7468 2e20 5468 6973 2069 730a 2020 2020  th. This is.    
-0000c1f0: 2020 2020 6d6f 7265 2065 6666 6963 6965      more efficie
-0000c200: 6e74 2074 6861 6e20 3a6d 6574 683a 6074  nt than :meth:`t
-0000c210: 6f5f 6c6f 6361 6c5f 7061 7468 6020 7768  o_local_path` wh
-0000c220: 6963 6820 6163 6365 7074 7320 756e 6361  ich accepts unca
-0000c230: 7365 6420 7061 7468 732e 0a0a 2020 2020  sed paths...    
-0000c240: 2020 2020 3a70 6172 616d 2064 6278 5f70      :param dbx_p
-0000c250: 6174 685f 6361 7365 643a 2050 6174 6820  ath_cased: Path 
-0000c260: 7265 6c61 7469 7665 2074 6f20 4472 6f70  relative to Drop
-0000c270: 626f 7820 666f 6c64 6572 2c20 636f 7272  box folder, corr
-0000c280: 6563 746c 7920 6361 7365 642e 0a20 2020  ectly cased..   
-0000c290: 2020 2020 203a 7265 7475 726e 733a 2043       :returns: C
-0000c2a0: 6f72 7265 7370 6f6e 6469 6e67 206c 6f63  orresponding loc
-0000c2b0: 616c 2070 6174 6820 6f6e 2064 7269 7665  al path on drive
-0000c2c0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0000c2d0: 2020 2020 2020 7265 7475 726e 2066 227b        return f"{
-0000c2e0: 7365 6c66 2e64 726f 7062 6f78 5f70 6174  self.dropbox_pat
-0000c2f0: 687d 7b64 6278 5f70 6174 685f 6361 7365  h}{dbx_path_case
-0000c300: 647d 220a 0a20 2020 2064 6566 2074 6f5f  d}"..    def to_
-0000c310: 6c6f 6361 6c5f 7061 7468 2873 656c 662c  local_path(self,
-0000c320: 2064 6278 5f70 6174 683a 2073 7472 2920   dbx_path: str) 
-0000c330: 2d3e 2073 7472 3a0a 2020 2020 2020 2020  -> str:.        
-0000c340: 2222 220a 2020 2020 2020 2020 436f 6e76  """.        Conv
-0000c350: 6572 7473 2061 2044 726f 7062 6f78 2070  erts a Dropbox p
-0000c360: 6174 6820 746f 2074 6865 2063 6f72 7265  ath to the corre
-0000c370: 7370 6f6e 6469 6e67 206c 6f63 616c 2070  sponding local p
-0000c380: 6174 682e 204f 6e6c 7920 7468 6520 6261  ath. Only the ba
-0000c390: 7365 6e61 6d65 206d 7573 740a 2020 2020  sename must.    
-0000c3a0: 2020 2020 6265 2063 6f72 7265 6374 6c79      be correctly
-0000c3b0: 2063 6173 6564 2c20 6173 2067 7561 7261   cased, as guara
-0000c3c0: 6e74 6565 6420 6279 2074 6865 2044 726f  nteed by the Dro
-0000c3d0: 7062 6f78 2041 5049 2066 6f72 2074 6865  pbox API for the
-0000c3e0: 2060 6064 6973 706c 6179 5f70 6174 6860   ``display_path`
-0000c3f0: 600a 2020 2020 2020 2020 6174 7472 6962  `.        attrib
-0000c400: 7574 6520 6f66 2066 696c 6520 6f72 2066  ute of file or f
-0000c410: 6f6c 6465 7220 6d65 7461 6461 7461 2e0a  older metadata..
-0000c420: 0a20 2020 2020 2020 2054 6869 7320 6d65  .        This me
-0000c430: 7468 6f64 2073 6c6f 7765 7220 7468 616e  thod slower than
-0000c440: 203a 6d65 7468 3a60 746f 5f6c 6f63 616c   :meth:`to_local
-0000c450: 5f70 6174 685f 6672 6f6d 5f63 6173 6564  _path_from_cased
-0000c460: 602e 0a0a 2020 2020 2020 2020 3a70 6172  `...        :par
-0000c470: 616d 2064 6278 5f70 6174 683a 2050 6174  am dbx_path: Pat
-0000c480: 6820 7265 6c61 7469 7665 2074 6f20 4472  h relative to Dr
-0000c490: 6f70 626f 7820 666f 6c64 6572 2c20 6d75  opbox folder, mu
-0000c4a0: 7374 2062 6520 636f 7272 6563 746c 7920  st be correctly 
-0000c4b0: 6361 7365 6420 696e 2069 7473 0a20 2020  cased in its.   
-0000c4c0: 2020 2020 2020 2020 2062 6173 656e 616d           basenam
-0000c4d0: 652e 0a20 2020 2020 2020 203a 7265 7475  e..        :retu
-0000c4e0: 726e 733a 2043 6f72 7265 7370 6f6e 6469  rns: Correspondi
-0000c4f0: 6e67 206c 6f63 616c 2070 6174 6820 6f6e  ng local path on
-0000c500: 2064 7269 7665 2e0a 2020 2020 2020 2020   drive..        
-0000c510: 2222 220a 2020 2020 2020 2020 6462 785f  """.        dbx_
-0000c520: 7061 7468 5f63 6173 6564 203d 2073 656c  path_cased = sel
-0000c530: 662e 636f 7272 6563 745f 6361 7365 2864  f.correct_case(d
-0000c540: 6278 5f70 6174 6829 0a20 2020 2020 2020  bx_path).       
-0000c550: 2072 6574 7572 6e20 6622 7b73 656c 662e   return f"{self.
-0000c560: 6472 6f70 626f 785f 7061 7468 7d7b 6462  dropbox_path}{db
-0000c570: 785f 7061 7468 5f63 6173 6564 7d22 0a0a  x_path_cased}"..
-0000c580: 2020 2020 6465 6620 6973 5f65 7863 6c75      def is_exclu
-0000c590: 6465 6428 7365 6c66 2c20 7061 7468 3a20  ded(self, path: 
-0000c5a0: 7374 7229 202d 3e20 626f 6f6c 3a0a 2020  str) -> bool:.  
-0000c5b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000c5c0: 2020 4368 6563 6b73 2069 6620 6120 6669    Checks if a fi
-0000c5d0: 6c65 2069 7320 6578 636c 7564 6564 2066  le is excluded f
-0000c5e0: 726f 6d20 7379 6e63 2e20 4365 7274 6169  rom sync. Certai
-0000c5f0: 6e20 6669 6c65 206e 616d 6573 2061 7265  n file names are
-0000c600: 2061 6c77 6179 7320 6578 636c 7564 6564   always excluded
-0000c610: 0a20 2020 2020 2020 2066 726f 6d20 7379  .        from sy
-0000c620: 6e63 696e 672c 2066 6f6c 6c6f 7769 6e67  ncing, following
-0000c630: 2074 6865 2044 726f 7062 6f78 2073 7570   the Dropbox sup
-0000c640: 706f 7274 2061 7274 6963 6c65 3a0a 0a20  port article:.. 
-0000c650: 2020 2020 2020 2068 7474 7073 3a2f 2f68         https://h
-0000c660: 656c 702e 6472 6f70 626f 782e 636f 6d2f  elp.dropbox.com/
-0000c670: 696e 7374 616c 6c73 2d69 6e74 6567 7261  installs-integra
-0000c680: 7469 6f6e 732f 7379 6e63 2d75 706c 6f61  tions/sync-uploa
-0000c690: 6473 2f66 696c 6573 2d6e 6f74 2d73 796e  ds/files-not-syn
-0000c6a0: 6369 6e67 0a0a 2020 2020 2020 2020 5468  cing..        Th
-0000c6b0: 6973 2069 6e63 6c75 6465 7320 6669 6c65  is includes file
-0000c6c0: 2073 7973 7465 6d20 6669 6c65 7320 7375   system files su
-0000c6d0: 6368 2061 7320 2764 6573 6b74 6f70 2e69  ch as 'desktop.i
-0000c6e0: 6e69 2720 616e 6420 272e 4453 5f53 746f  ni' and '.DS_Sto
-0000c6f0: 7265 2720 616e 6420 736f 6d65 0a20 2020  re' and some.   
-0000c700: 2020 2020 2074 656d 706f 7261 7279 2066       temporary f
-0000c710: 696c 6573 2061 7320 7765 6c6c 2061 7320  iles as well as 
-0000c720: 6361 6368 6573 2075 7365 6420 6279 2044  caches used by D
-0000c730: 726f 7062 6f78 206f 7220 4d61 6573 7472  ropbox or Maestr
-0000c740: 616c 2e20 6069 735f 6578 636c 7564 6564  al. `is_excluded
-0000c750: 600a 2020 2020 2020 2020 6163 6365 7074  `.        accept
-0000c760: 7320 626f 7468 206c 6f63 616c 2061 6e64  s both local and
-0000c770: 2044 726f 7062 6f78 2070 6174 6873 2e0a   Dropbox paths..
-0000c780: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-0000c790: 7061 7468 3a20 4361 6e20 6265 2061 6e20  path: Can be an 
-0000c7a0: 6162 736f 6c75 7465 2070 6174 682c 2061  absolute path, a
-0000c7b0: 2070 6174 6820 7265 6c61 7469 7665 2074   path relative t
-0000c7c0: 6f20 7468 6520 4472 6f70 626f 7820 666f  o the Dropbox fo
-0000c7d0: 6c64 6572 206f 720a 2020 2020 2020 2020  lder or.        
-0000c7e0: 2020 2020 6a75 7374 2061 2066 696c 6520      just a file 
-0000c7f0: 6e61 6d65 2e20 446f 6573 206e 6f74 206e  name. Does not n
-0000c800: 6565 6420 746f 2062 6520 6e6f 726d 616c  eed to be normal
-0000c810: 697a 6564 2e0a 2020 2020 2020 2020 3a72  ized..        :r
-0000c820: 6574 7572 6e73 3a20 5768 6574 6865 7220  eturns: Whether 
-0000c830: 7468 6520 7061 7468 2069 7320 6578 636c  the path is excl
-0000c840: 7564 6564 2066 726f 6d20 7379 6e63 696e  uded from syncin
-0000c850: 672e 0a20 2020 2020 2020 2022 2222 0a20  g..        """. 
-0000c860: 2020 2020 2020 2064 6972 6e61 6d65 2c20         dirname, 
-0000c870: 6261 7365 6e61 6d65 203d 206f 7370 2e73  basename = osp.s
-0000c880: 706c 6974 2870 6174 6829 0a0a 2020 2020  plit(path)..    
-0000c890: 2020 2020 2320 4973 2069 6e20 6578 636c      # Is in excl
-0000c8a0: 7564 6564 2066 696c 6573 3f0a 2020 2020  uded files?.    
-0000c8b0: 2020 2020 6966 2062 6173 656e 616d 6520      if basename 
-0000c8c0: 696e 2045 5843 4c55 4445 445f 4649 4c45  in EXCLUDED_FILE
-0000c8d0: 5f4e 414d 4553 3a0a 2020 2020 2020 2020  _NAMES:.        
-0000c8e0: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
-0000c8f0: 0a20 2020 2020 2020 2023 2049 7320 696e  .        # Is in
-0000c900: 2065 7863 6c75 6465 6420 6469 7273 3f0a   excluded dirs?.
-0000c910: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-0000c920: 2020 2020 2020 2020 2064 6278 5f64 6972           dbx_dir
-0000c930: 6e61 6d65 203d 2073 656c 662e 746f 5f64  name = self.to_d
-0000c940: 6278 5f70 6174 6828 6469 726e 616d 6529  bx_path(dirname)
-0000c950: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0000c960: 5661 6c75 6545 7272 6f72 3a0a 2020 2020  ValueError:.    
-0000c970: 2020 2020 2020 2020 2320 5061 7468 2069          # Path i
-0000c980: 7320 616c 7265 6164 7920 7265 6c61 7469  s already relati
-0000c990: 7665 2074 6f20 4472 6f70 626f 782e 0a20  ve to Dropbox.. 
-0000c9a0: 2020 2020 2020 2020 2020 2064 6278 5f64             dbx_d
-0000c9b0: 6972 6e61 6d65 203d 2064 6972 6e61 6d65  irname = dirname
-0000c9c0: 0a0a 2020 2020 2020 2020 726f 6f74 5f64  ..        root_d
-0000c9d0: 6972 203d 206e 6578 7428 6974 6572 2870  ir = next(iter(p
-0000c9e0: 6172 7420 666f 7220 7061 7274 2069 6e20  art for part in 
-0000c9f0: 6462 785f 6469 726e 616d 652e 7370 6c69  dbx_dirname.spli
-0000ca00: 7428 222f 222c 2032 2920 6966 2070 6172  t("/", 2) if par
-0000ca10: 7429 2c20 2222 290a 0a20 2020 2020 2020  t), "")..       
-0000ca20: 2069 6620 726f 6f74 5f64 6972 2069 6e20   if root_dir in 
-0000ca30: 4558 434c 5544 4544 5f44 4952 5f4e 414d  EXCLUDED_DIR_NAM
-0000ca40: 4553 3a0a 2020 2020 2020 2020 2020 2020  ES:.            
-0000ca50: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
-0000ca60: 2020 2020 2023 2049 7320 7465 6d70 6f72       # Is tempor
-0000ca70: 6172 7920 6669 6c65 3f0a 2020 2020 2020  ary file?.      
-0000ca80: 2020 6966 2022 7e22 2069 6e20 6261 7365    if "~" in base
-0000ca90: 6e61 6d65 3a0a 2020 2020 2020 2020 2020  name:.          
-0000caa0: 2020 2320 3129 204f 6666 6963 6520 7465    # 1) Office te
-0000cab0: 6d70 6f72 6172 7920 6669 6c65 730a 2020  mporary files.  
-0000cac0: 2020 2020 2020 2020 2020 6966 2062 6173            if bas
-0000cad0: 656e 616d 652e 7374 6172 7473 7769 7468  ename.startswith
-0000cae0: 2822 7e24 2229 3a0a 2020 2020 2020 2020  ("~$"):.        
-0000caf0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-0000cb00: 7275 650a 2020 2020 2020 2020 2020 2020  rue.            
-0000cb10: 6966 2062 6173 656e 616d 652e 7374 6172  if basename.star
-0000cb20: 7473 7769 7468 2822 2e7e 2229 3a0a 2020  tswith(".~"):.  
-0000cb30: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0000cb40: 7475 726e 2054 7275 650a 2020 2020 2020  turn True.      
-0000cb50: 2020 2020 2020 2320 3229 204f 7468 6572        # 2) Other
-0000cb60: 2074 656d 706f 7261 7279 2066 696c 6573   temporary files
-0000cb70: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0000cb80: 6261 7365 6e61 6d65 2e73 7461 7274 7377  basename.startsw
-0000cb90: 6974 6828 227e 2229 2061 6e64 2062 6173  ith("~") and bas
-0000cba0: 656e 616d 652e 656e 6473 7769 7468 2822  ename.endswith("
-0000cbb0: 2e74 6d70 2229 3a0a 2020 2020 2020 2020  .tmp"):.        
-0000cbc0: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-0000cbd0: 7275 650a 0a20 2020 2020 2020 2072 6574  rue..        ret
-0000cbe0: 7572 6e20 4661 6c73 650a 0a20 2020 2064  urn False..    d
-0000cbf0: 6566 2069 735f 6578 636c 7564 6564 5f62  ef is_excluded_b
-0000cc00: 795f 7573 6572 2873 656c 662c 2064 6278  y_user(self, dbx
-0000cc10: 5f70 6174 685f 6c6f 7765 723a 2073 7472  _path_lower: str
-0000cc20: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-0000cc30: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
-0000cc40: 6865 636b 2069 6620 6669 6c65 2068 6173  heck if file has
-0000cc50: 2062 6565 6e20 6578 636c 7564 6564 2074   been excluded t
-0000cc60: 6872 6f75 6768 2022 7365 6c65 6374 6976  hrough "selectiv
-0000cc70: 6520 7379 6e63 2220 6279 2074 6865 2075  e sync" by the u
-0000cc80: 7365 722e 0a0a 2020 2020 2020 2020 3a70  ser...        :p
-0000cc90: 6172 616d 2064 6278 5f70 6174 685f 6c6f  aram dbx_path_lo
-0000cca0: 7765 723a 204e 6f72 6d61 6c69 7365 6420  wer: Normalised 
-0000ccb0: 6c6f 7765 7220 6361 7365 2044 726f 7062  lower case Dropb
-0000ccc0: 6f78 2070 6174 682e 0a20 2020 2020 2020  ox path..       
-0000ccd0: 203a 7265 7475 726e 733a 2057 6865 7468   :returns: Wheth
-0000cce0: 6572 2074 6865 2070 6174 6820 6973 2065  er the path is e
-0000ccf0: 7863 6c75 6465 6420 6672 6f6d 2064 6f77  xcluded from dow
-0000cd00: 6e6c 6f61 6420 7379 6e63 696e 6720 6279  nload syncing by
-0000cd10: 2074 6865 2075 7365 722e 0a20 2020 2020   the user..     
-0000cd20: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-0000cd30: 6574 7572 6e20 616e 7928 6973 5f65 7175  eturn any(is_equ
-0000cd40: 616c 5f6f 725f 6368 696c 6428 6462 785f  al_or_child(dbx_
-0000cd50: 7061 7468 5f6c 6f77 6572 2c20 7029 2066  path_lower, p) f
-0000cd60: 6f72 2070 2069 6e20 7365 6c66 2e65 7863  or p in self.exc
-0000cd70: 6c75 6465 645f 6974 656d 7329 0a0a 2020  luded_items)..  
-0000cd80: 2020 6465 6620 6973 5f6d 6967 6e6f 7265    def is_mignore
-0000cd90: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
-0000cda0: 6e63 4576 656e 7429 202d 3e20 626f 6f6c  ncEvent) -> bool
-0000cdb0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0000cdc0: 2020 2020 2020 4368 6563 6b20 6966 206c        Check if l
-0000cdd0: 6f63 616c 2066 696c 6520 6368 616e 6765  ocal file change
+000082f0: 656e 7472 7920 3d20 7365 6c66 2e67 6574  entry = self.get
+00008300: 5f69 6e64 6578 5f65 6e74 7279 2864 6278  _index_entry(dbx
+00008310: 5f70 6174 685f 6c6f 7765 7229 0a0a 2020  _path_lower)..  
+00008320: 2020 2020 2020 6966 2065 6e74 7279 3a0a        if entry:.
+00008330: 2020 2020 2020 2020 2020 2020 6c61 7374              last
+00008340: 5f73 796e 6320 3d20 656e 7472 792e 6c61  _sync = entry.la
+00008350: 7374 5f73 796e 6320 6f72 2030 2e30 0a20  st_sync or 0.0. 
+00008360: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00008370: 2020 2020 2020 2020 206c 6173 745f 7379           last_sy
+00008380: 6e63 203d 2030 2e30 0a0a 2020 2020 2020  nc = 0.0..      
+00008390: 2020 7265 7475 726e 206d 6178 286c 6173    return max(las
+000083a0: 745f 7379 6e63 2c20 7365 6c66 2e6c 6f63  t_sync, self.loc
+000083b0: 616c 5f63 7572 736f 7229 0a0a 2020 2020  al_cursor)..    
+000083c0: 6465 6620 7570 6461 7465 5f69 6e64 6578  def update_index
+000083d0: 5f66 726f 6d5f 7379 6e63 5f65 7665 6e74  _from_sync_event
+000083e0: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
+000083f0: 6e63 4576 656e 7429 202d 3e20 4e6f 6e65  ncEvent) -> None
+00008400: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00008410: 2020 2020 2020 5570 6461 7465 7320 7468        Updates th
+00008420: 6520 6c6f 6361 6c20 696e 6465 7820 6672  e local index fr
+00008430: 6f6d 2061 2053 796e 6345 7665 6e74 2e0a  om a SyncEvent..
+00008440: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+00008450: 6576 656e 743a 2053 796e 6345 7665 6e74  event: SyncEvent
+00008460: 2066 726f 6d20 646f 776e 6c6f 6164 2e0a   from download..
+00008470: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00008480: 2020 2020 6966 2065 7665 6e74 2e63 6861      if event.cha
+00008490: 6e67 655f 7479 7065 2069 7320 6e6f 7420  nge_type is not 
+000084a0: 4368 616e 6765 5479 7065 2e52 656d 6f76  ChangeType.Remov
+000084b0: 6564 2061 6e64 206e 6f74 2065 7665 6e74  ed and not event
+000084c0: 2e72 6576 3a0a 2020 2020 2020 2020 2020  .rev:.          
+000084d0: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
+000084e0: 6f72 2822 5265 7620 7265 7175 6972 6564  or("Rev required
+000084f0: 2074 6f20 7570 6461 7465 2069 6e64 6578   to update index
+00008500: 2229 0a0a 2020 2020 2020 2020 6462 785f  ")..        dbx_
+00008510: 7061 7468 5f6c 6f77 6572 203d 2065 7665  path_lower = eve
+00008520: 6e74 2e64 6278 5f70 6174 685f 6c6f 7765  nt.dbx_path_lowe
+00008530: 720a 0a20 2020 2020 2020 2077 6974 6820  r..        with 
+00008540: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
+00008550: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
+00008560: 2020 2020 2023 2052 656d 6f76 6520 616e       # Remove an
+00008570: 7920 656e 7472 6965 7320 666f 7220 6465  y entries for de
+00008580: 6c65 7465 6420 6f72 206d 6f76 6564 2069  leted or moved i
+00008590: 7465 6d73 2e0a 0a20 2020 2020 2020 2020  tems...         
+000085a0: 2020 2069 6620 6576 656e 742e 6368 616e     if event.chan
+000085b0: 6765 5f74 7970 6520 6973 2043 6861 6e67  ge_type is Chang
+000085c0: 6554 7970 652e 5265 6d6f 7665 643a 0a20  eType.Removed:. 
+000085d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000085e0: 656c 662e 7265 6d6f 7665 5f6e 6f64 655f  elf.remove_node_
+000085f0: 6672 6f6d 5f69 6e64 6578 2864 6278 5f70  from_index(dbx_p
+00008600: 6174 685f 6c6f 7765 7229 0a20 2020 2020  ath_lower).     
+00008610: 2020 2020 2020 2065 6c69 6620 6576 656e         elif even
+00008620: 742e 6368 616e 6765 5f74 7970 6520 6973  t.change_type is
+00008630: 2043 6861 6e67 6554 7970 652e 4d6f 7665   ChangeType.Move
+00008640: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00008650: 2020 2061 7373 6572 7420 6576 656e 742e     assert event.
+00008660: 6462 785f 7061 7468 5f66 726f 6d5f 6c6f  dbx_path_from_lo
+00008670: 7765 7220 6973 206e 6f74 204e 6f6e 650a  wer is not None.
+00008680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008690: 7365 6c66 2e72 656d 6f76 655f 6e6f 6465  self.remove_node
+000086a0: 5f66 726f 6d5f 696e 6465 7828 6576 656e  _from_index(even
+000086b0: 742e 6462 785f 7061 7468 5f66 726f 6d5f  t.dbx_path_from_
+000086c0: 6c6f 7765 7229 0a0a 2020 2020 2020 2020  lower)..        
+000086d0: 2020 2020 2320 4164 6420 6f72 2075 7064      # Add or upd
+000086e0: 6174 6520 656e 7472 6965 7320 666f 7220  ate entries for 
+000086f0: 6372 6561 7465 6420 6f72 206d 6f64 6966  created or modif
+00008700: 6965 6420 6974 656d 732e 0a0a 2020 2020  ied items...    
+00008710: 2020 2020 2020 2020 6966 2065 7665 6e74          if event
+00008720: 2e63 6861 6e67 655f 7479 7065 2069 7320  .change_type is 
+00008730: 6e6f 7420 4368 616e 6765 5479 7065 2e52  not ChangeType.R
+00008740: 656d 6f76 6564 3a0a 2020 2020 2020 2020  emoved:.        
+00008750: 2020 2020 2020 2020 2320 4372 6561 7465          # Create
+00008760: 206f 7220 7570 6461 7465 2065 6e74 7279   or update entry
+00008770: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00008780: 2020 656e 7472 7920 3d20 496e 6465 7845    entry = IndexE
+00008790: 6e74 7279 280a 2020 2020 2020 2020 2020  ntry(.          
+000087a0: 2020 2020 2020 2020 2020 6462 785f 7061            dbx_pa
+000087b0: 7468 5f63 6173 6564 3d65 7665 6e74 2e64  th_cased=event.d
+000087c0: 6278 5f70 6174 682c 0a20 2020 2020 2020  bx_path,.       
+000087d0: 2020 2020 2020 2020 2020 2020 2064 6278               dbx
+000087e0: 5f70 6174 685f 6c6f 7765 723d 6462 785f  _path_lower=dbx_
+000087f0: 7061 7468 5f6c 6f77 6572 2c0a 2020 2020  path_lower,.    
+00008800: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008810: 6462 785f 6964 3d65 7665 6e74 2e64 6278  dbx_id=event.dbx
+00008820: 5f69 642c 0a20 2020 2020 2020 2020 2020  _id,.           
+00008830: 2020 2020 2020 2020 2069 7465 6d5f 7479           item_ty
+00008840: 7065 3d65 7665 6e74 2e69 7465 6d5f 7479  pe=event.item_ty
+00008850: 7065 2c0a 2020 2020 2020 2020 2020 2020  pe,.            
+00008860: 2020 2020 2020 2020 6c61 7374 5f73 796e          last_syn
+00008870: 633d 7365 6c66 2e5f 6765 745f 6374 696d  c=self._get_ctim
+00008880: 6528 6576 656e 742e 6c6f 6361 6c5f 7061  e(event.local_pa
+00008890: 7468 292c 0a20 2020 2020 2020 2020 2020  th),.           
+000088a0: 2020 2020 2020 2020 2072 6576 3d65 7665           rev=eve
+000088b0: 6e74 2e72 6576 2c0a 2020 2020 2020 2020  nt.rev,.        
+000088c0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+000088d0: 656e 745f 6861 7368 3d65 7665 6e74 2e63  ent_hash=event.c
+000088e0: 6f6e 7465 6e74 5f68 6173 682c 0a20 2020  ontent_hash,.   
+000088f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008900: 2073 796d 6c69 6e6b 5f74 6172 6765 743d   symlink_target=
+00008910: 6576 656e 742e 7379 6d6c 696e 6b5f 7461  event.symlink_ta
+00008920: 7267 6574 2c0a 2020 2020 2020 2020 2020  rget,.          
+00008930: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00008940: 2020 2020 2020 2020 2073 656c 662e 5f69           self._i
+00008950: 6e64 6578 5f74 6162 6c65 2e75 7064 6174  ndex_table.updat
+00008960: 6528 656e 7472 7929 0a0a 2020 2020 6465  e(entry)..    de
+00008970: 6620 7570 6461 7465 5f69 6e64 6578 5f66  f update_index_f
+00008980: 726f 6d5f 6462 785f 6d65 7461 6461 7461  rom_dbx_metadata
+00008990: 2873 656c 662c 206d 643a 204d 6574 6164  (self, md: Metad
+000089a0: 6174 6129 202d 3e20 4e6f 6e65 3a0a 2020  ata) -> None:.  
+000089b0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000089c0: 2020 5570 6461 7465 7320 7468 6520 6c6f    Updates the lo
+000089d0: 6361 6c20 696e 6465 7820 6672 6f6d 2044  cal index from D
+000089e0: 726f 7062 6f78 206d 6574 6164 6174 612e  ropbox metadata.
+000089f0: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00008a00: 206d 643a 2044 726f 7062 6f78 206d 6574   md: Dropbox met
+00008a10: 6164 6174 612e 0a20 2020 2020 2020 2022  adata..        "
+00008a20: 2222 0a20 2020 2020 2020 2077 6974 6820  "".        with 
+00008a30: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
+00008a40: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
+00008a50: 2020 2020 2069 6620 6973 696e 7374 616e       if isinstan
+00008a60: 6365 286d 642c 2044 656c 6574 6564 4d65  ce(md, DeletedMe
+00008a70: 7461 6461 7461 293a 0a20 2020 2020 2020  tadata):.       
+00008a80: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+00008a90: 7365 6c66 2e72 656d 6f76 655f 6e6f 6465  self.remove_node
+00008aa0: 5f66 726f 6d5f 696e 6465 7828 6d64 2e70  _from_index(md.p
+00008ab0: 6174 685f 6c6f 7765 7229 0a0a 2020 2020  ath_lower)..    
+00008ac0: 2020 2020 2020 2020 6966 2069 7369 6e73          if isins
+00008ad0: 7461 6e63 6528 6d64 2c20 4669 6c65 4d65  tance(md, FileMe
+00008ae0: 7461 6461 7461 293a 0a20 2020 2020 2020  tadata):.       
+00008af0: 2020 2020 2020 2020 2072 6576 203d 206d           rev = m
+00008b00: 642e 7265 760a 2020 2020 2020 2020 2020  d.rev.          
+00008b10: 2020 2020 2020 6861 7368 5f73 7472 203d        hash_str =
+00008b20: 206d 642e 636f 6e74 656e 745f 6861 7368   md.content_hash
+00008b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008b40: 2069 7465 6d5f 7479 7065 203d 2049 7465   item_type = Ite
+00008b50: 6d54 7970 652e 4669 6c65 0a20 2020 2020  mType.File.     
+00008b60: 2020 2020 2020 2020 2020 2073 796d 6c69             symli
+00008b70: 6e6b 5f74 6172 6765 7420 3d20 6d64 2e73  nk_target = md.s
+00008b80: 796d 6c69 6e6b 5f74 6172 6765 740a 2020  ymlink_target.  
+00008b90: 2020 2020 2020 2020 2020 2020 2020 6d64                md
+00008ba0: 5f69 6420 3d20 6d64 2e69 640a 2020 2020  _id = md.id.    
+00008bb0: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+00008bc0: 6e73 7461 6e63 6528 6d64 2c20 466f 6c64  nstance(md, Fold
+00008bd0: 6572 4d65 7461 6461 7461 293a 0a20 2020  erMetadata):.   
+00008be0: 2020 2020 2020 2020 2020 2020 2072 6576               rev
+00008bf0: 203d 2022 666f 6c64 6572 220a 2020 2020   = "folder".    
+00008c00: 2020 2020 2020 2020 2020 2020 6861 7368              hash
+00008c10: 5f73 7472 203d 2022 666f 6c64 6572 220a  _str = "folder".
+00008c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c30: 6974 656d 5f74 7970 6520 3d20 4974 656d  item_type = Item
+00008c40: 5479 7065 2e46 6f6c 6465 720a 2020 2020  Type.Folder.    
+00008c50: 2020 2020 2020 2020 2020 2020 7379 6d6c              syml
+00008c60: 696e 6b5f 7461 7267 6574 203d 204e 6f6e  ink_target = Non
+00008c70: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00008c80: 2020 6d64 5f69 6420 3d20 6d64 2e69 640a    md_id = md.id.
+00008c90: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00008ca0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008cb0: 2020 7261 6973 6520 5275 6e74 696d 6545    raise RuntimeE
+00008cc0: 7272 6f72 2866 2255 6e6b 6e6f 776e 206d  rror(f"Unknown m
+00008cd0: 6574 6164 6174 6120 7479 7065 3a20 7b6d  etadata type: {m
+00008ce0: 647d 2229 0a0a 2020 2020 2020 2020 2020  d}")..          
+00008cf0: 2020 2320 436f 6e73 7472 7563 7420 636f    # Construct co
+00008d00: 7272 6563 7420 6469 7370 6c61 7920 7061  rrect display pa
+00008d10: 7468 2066 726f 6d20 616e 6365 7374 6f72  th from ancestor
+00008d20: 732e 0a20 2020 2020 2020 2020 2020 2064  s..            d
+00008d30: 6278 5f70 6174 685f 6361 7365 6420 3d20  bx_path_cased = 
+00008d40: 7365 6c66 2e63 6f72 7265 6374 5f63 6173  self.correct_cas
+00008d50: 6528 6d64 2e70 6174 685f 6469 7370 6c61  e(md.path_displa
+00008d60: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
+00008d70: 2320 5570 6461 7465 2065 7869 7374 696e  # Update existin
+00008d80: 6720 656e 7472 7920 6f72 2063 7265 6174  g entry or creat
+00008d90: 6520 6e65 7720 656e 7472 792e 0a20 2020  e new entry..   
+00008da0: 2020 2020 2020 2020 2065 6e74 7279 203d           entry =
+00008db0: 2049 6e64 6578 456e 7472 7928 0a20 2020   IndexEntry(.   
+00008dc0: 2020 2020 2020 2020 2020 2020 2064 6278               dbx
+00008dd0: 5f70 6174 685f 6361 7365 643d 6462 785f  _path_cased=dbx_
+00008de0: 7061 7468 5f63 6173 6564 2c0a 2020 2020  path_cased,.    
+00008df0: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
+00008e00: 7061 7468 5f6c 6f77 6572 3d6d 642e 7061  path_lower=md.pa
+00008e10: 7468 5f6c 6f77 6572 2c0a 2020 2020 2020  th_lower,.      
+00008e20: 2020 2020 2020 2020 2020 6462 785f 6964            dbx_id
+00008e30: 3d6d 645f 6964 2c0a 2020 2020 2020 2020  =md_id,.        
+00008e40: 2020 2020 2020 2020 6974 656d 5f74 7970          item_typ
+00008e50: 653d 6974 656d 5f74 7970 652c 0a20 2020  e=item_type,.   
+00008e60: 2020 2020 2020 2020 2020 2020 206c 6173               las
+00008e70: 745f 7379 6e63 3d4e 6f6e 652c 0a20 2020  t_sync=None,.   
+00008e80: 2020 2020 2020 2020 2020 2020 2072 6576               rev
+00008e90: 3d72 6576 2c0a 2020 2020 2020 2020 2020  =rev,.          
+00008ea0: 2020 2020 2020 636f 6e74 656e 745f 6861        content_ha
+00008eb0: 7368 3d68 6173 685f 7374 722c 0a20 2020  sh=hash_str,.   
+00008ec0: 2020 2020 2020 2020 2020 2020 2073 796d               sym
+00008ed0: 6c69 6e6b 5f74 6172 6765 743d 7379 6d6c  link_target=syml
+00008ee0: 696e 6b5f 7461 7267 6574 2c0a 2020 2020  ink_target,.    
+00008ef0: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00008f00: 2020 2020 2020 2073 656c 662e 5f69 6e64         self._ind
+00008f10: 6578 5f74 6162 6c65 2e75 7064 6174 6528  ex_table.update(
+00008f20: 656e 7472 7929 0a0a 2020 2020 6465 6620  entry)..    def 
+00008f30: 7265 6d6f 7665 5f6e 6f64 655f 6672 6f6d  remove_node_from
+00008f40: 5f69 6e64 6578 2873 656c 662c 2064 6278  _index(self, dbx
+00008f50: 5f70 6174 685f 6c6f 7765 723a 2073 7472  _path_lower: str
+00008f60: 2920 2d3e 204e 6f6e 653a 0a20 2020 2020  ) -> None:.     
+00008f70: 2020 2022 2222 0a20 2020 2020 2020 2052     """.        R
+00008f80: 656d 6f76 6573 2061 6e79 206c 6f63 616c  emoves any local
+00008f90: 2069 6e64 6578 2065 6e74 7269 6573 2066   index entries f
+00008fa0: 6f72 2074 6865 2067 6976 656e 2070 6174  or the given pat
+00008fb0: 6820 616e 6420 616c 6c20 6974 7320 6368  h and all its ch
+00008fc0: 696c 6472 656e 2e0a 0a20 2020 2020 2020  ildren...       
+00008fd0: 203a 7061 7261 6d20 6462 785f 7061 7468   :param dbx_path
+00008fe0: 5f6c 6f77 6572 3a20 4e6f 726d 616c 697a  _lower: Normaliz
+00008ff0: 6564 206c 6f77 6572 2063 6173 6520 4472  ed lower case Dr
+00009000: 6f70 626f 7820 7061 7468 2e0a 2020 2020  opbox path..    
+00009010: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00009020: 7769 7468 2073 656c 662e 5f64 6174 6162  with self._datab
+00009030: 6173 655f 6163 6365 7373 2829 3a0a 2020  ase_access():.  
+00009040: 2020 2020 2020 2020 2020 7175 6572 7920            query 
+00009050: 3d20 5061 7468 5472 6565 5175 6572 7928  = PathTreeQuery(
+00009060: 496e 6465 7845 6e74 7279 2e64 6278 5f70  IndexEntry.dbx_p
+00009070: 6174 685f 6c6f 7765 722c 2064 6278 5f70  ath_lower, dbx_p
+00009080: 6174 685f 6c6f 7765 7229 0a20 2020 2020  ath_lower).     
+00009090: 2020 2020 2020 2073 656c 662e 5f69 6e64         self._ind
+000090a0: 6578 5f74 6162 6c65 2e64 656c 6574 6528  ex_table.delete(
+000090b0: 7175 6572 7929 0a0a 2020 2020 2320 3d3d  query)..    # ==
+000090c0: 3d3d 2043 6f6e 7465 6e74 2068 6173 6869  == Content hashi
+000090d0: 6e67 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ng =============
+000090e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000090f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009100: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009110: 0a0a 2020 2020 6465 6620 6765 745f 6c6f  ..    def get_lo
+00009120: 6361 6c5f 6861 7368 2873 656c 662c 206c  cal_hash(self, l
+00009130: 6f63 616c 5f70 6174 683a 2073 7472 2920  ocal_path: str) 
+00009140: 2d3e 2073 7472 207c 204e 6f6e 653a 0a20  -> str | None:. 
+00009150: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00009160: 2020 2043 6f6d 7075 7465 7320 636f 6e74     Computes cont
+00009170: 656e 7420 6861 7368 206f 6620 6120 6c6f  ent hash of a lo
+00009180: 6361 6c20 6669 6c65 2e0a 0a20 2020 2020  cal file...     
+00009190: 2020 203a 7061 7261 6d20 6c6f 6361 6c5f     :param local_
+000091a0: 7061 7468 3a20 4162 736f 6c75 7465 2070  path: Absolute p
+000091b0: 6174 6820 6f6e 206c 6f63 616c 2064 7269  ath on local dri
+000091c0: 7665 2e0a 2020 2020 2020 2020 3a72 6574  ve..        :ret
+000091d0: 7572 6e73 3a20 436f 6e74 656e 7420 6861  urns: Content ha
+000091e0: 7368 2074 6f20 636f 6d70 6172 6520 7769  sh to compare wi
+000091f0: 7468 2044 726f 7062 6f78 2773 2063 6f6e  th Dropbox's con
+00009200: 7465 6e74 2068 6173 682c 206f 7220 2766  tent hash, or 'f
+00009210: 6f6c 6465 7227 2069 660a 2020 2020 2020  older' if.      
+00009220: 2020 2020 2020 7468 6520 7061 7468 2070        the path p
+00009230: 6f69 6e74 7320 746f 2061 2064 6972 6563  oints to a direc
+00009240: 746f 7279 2e20 6060 4e6f 6e65 6060 2069  tory. ``None`` i
+00009250: 6620 7468 6572 6520 6973 206e 6f74 6869  f there is nothi
+00009260: 6e67 2061 7420 7468 6520 7061 7468 2e0a  ng at the path..
+00009270: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00009280: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00009290: 2020 2020 2073 7461 7420 3d20 6f73 2e6c       stat = os.l
+000092a0: 7374 6174 286c 6f63 616c 5f70 6174 6829  stat(local_path)
+000092b0: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+000092c0: 2846 696c 654e 6f74 466f 756e 6445 7272  (FileNotFoundErr
+000092d0: 6f72 2c20 4e6f 7441 4469 7265 6374 6f72  or, NotADirector
+000092e0: 7945 7272 6f72 293a 0a20 2020 2020 2020  yError):.       
+000092f0: 2020 2020 2023 2052 656d 6f76 6520 616c       # Remove al
+00009300: 6c20 6361 6368 6520 656e 7472 6965 7320  l cache entries 
+00009310: 666f 7220 6c6f 6361 6c5f 7061 7468 2061  for local_path a
+00009320: 6e64 2072 6574 7572 6e20 4e6f 6e65 2e0a  nd return None..
+00009330: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00009340: 2073 656c 662e 5f64 6174 6162 6173 655f   self._database_
+00009350: 6163 6365 7373 2829 3a0a 2020 2020 2020  access():.      
+00009360: 2020 2020 2020 2020 2020 7175 6572 7920            query 
+00009370: 3d20 4d61 7463 6851 7565 7279 2848 6173  = MatchQuery(Has
+00009380: 6843 6163 6865 456e 7472 792e 6c6f 6361  hCacheEntry.loca
+00009390: 6c5f 7061 7468 2c20 6c6f 6361 6c5f 7061  l_path, local_pa
+000093a0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+000093b0: 2020 2020 7365 6c66 2e5f 6861 7368 5f74      self._hash_t
+000093c0: 6162 6c65 2e64 656c 6574 6528 7175 6572  able.delete(quer
+000093d0: 7929 0a20 2020 2020 2020 2020 2020 2072  y).            r
+000093e0: 6574 7572 6e20 4e6f 6e65 0a20 2020 2020  eturn None.     
+000093f0: 2020 2065 7863 6570 7420 4f53 4572 726f     except OSErro
+00009400: 7220 6173 2065 7272 3a0a 2020 2020 2020  r as err:.      
+00009410: 2020 2020 2020 6966 2065 7272 2e65 7272        if err.err
+00009420: 6e6f 203d 3d20 6572 726e 6f2e 454e 414d  no == errno.ENAM
+00009430: 4554 4f4f 4c4f 4e47 3a0a 2020 2020 2020  ETOOLONG:.      
+00009440: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00009450: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+00009460: 2020 7261 6973 6520 6f73 5f74 6f5f 6d61    raise os_to_ma
+00009470: 6573 7472 616c 5f65 7272 6f72 2865 7272  estral_error(err
+00009480: 290a 0a20 2020 2020 2020 2069 6620 535f  )..        if S_
+00009490: 4953 4449 5228 7374 6174 2e73 745f 6d6f  ISDIR(stat.st_mo
+000094a0: 6465 293a 0a20 2020 2020 2020 2020 2020  de):.           
+000094b0: 2072 6574 7572 6e20 2266 6f6c 6465 7222   return "folder"
+000094c0: 0a0a 2020 2020 2020 2020 6d74 696d 653a  ..        mtime:
+000094d0: 2066 6c6f 6174 207c 204e 6f6e 6520 3d20   float | None = 
+000094e0: 7374 6174 2e73 745f 6d74 696d 650a 0a20  stat.st_mtime.. 
+000094f0: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00009500: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
+00009510: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+00009520: 2023 2043 6865 636b 2063 6163 6865 2066   # Check cache f
+00009530: 6f72 2061 6e20 7570 2d74 6f2d 6461 7465  or an up-to-date
+00009540: 2063 6f6e 7465 6e74 2068 6173 6820 616e   content hash an
+00009550: 6420 7265 7475 726e 2069 6620 6974 2065  d return if it e
+00009560: 7869 7374 732e 0a20 2020 2020 2020 2020  xists..         
+00009570: 2020 2063 6163 6865 5f65 6e74 7279 203d     cache_entry =
+00009580: 2073 656c 662e 5f68 6173 685f 7461 626c   self._hash_tabl
+00009590: 652e 6765 7428 7374 6174 2e73 745f 696e  e.get(stat.st_in
+000095a0: 6f29 0a0a 2020 2020 2020 2020 2020 2020  o)..            
+000095b0: 6966 2063 6163 6865 5f65 6e74 7279 2061  if cache_entry a
+000095c0: 6e64 2063 6163 6865 5f65 6e74 7279 2e6d  nd cache_entry.m
+000095d0: 7469 6d65 203d 3d20 6d74 696d 653a 0a20  time == mtime:. 
+000095e0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+000095f0: 6574 7572 6e20 6361 6368 655f 656e 7472  eturn cache_entr
+00009600: 792e 6861 7368 5f73 7472 0a0a 2020 2020  y.hash_str..    
+00009610: 2020 2020 7769 7468 2063 6f6e 7665 7274      with convert
+00009620: 5f61 7069 5f65 7272 6f72 7328 6c6f 6361  _api_errors(loca
+00009630: 6c5f 7061 7468 3d6c 6f63 616c 5f70 6174  l_path=local_pat
+00009640: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
+00009650: 6861 7368 5f73 7472 2c20 6d74 696d 6520  hash_str, mtime 
+00009660: 3d20 636f 6e74 656e 745f 6861 7368 286c  = content_hash(l
+00009670: 6f63 616c 5f70 6174 6829 0a0a 2020 2020  ocal_path)..    
+00009680: 2020 2020 7365 6c66 2e5f 7361 7665 5f6c      self._save_l
+00009690: 6f63 616c 5f68 6173 6828 7374 6174 2e73  ocal_hash(stat.s
+000096a0: 745f 696e 6f2c 206c 6f63 616c 5f70 6174  t_ino, local_pat
+000096b0: 682c 2068 6173 685f 7374 722c 206d 7469  h, hash_str, mti
+000096c0: 6d65 290a 0a20 2020 2020 2020 2072 6574  me)..        ret
+000096d0: 7572 6e20 6861 7368 5f73 7472 0a0a 2020  urn hash_str..  
+000096e0: 2020 6465 6620 5f73 6176 655f 6c6f 6361    def _save_loca
+000096f0: 6c5f 6861 7368 280a 2020 2020 2020 2020  l_hash(.        
+00009700: 7365 6c66 2c0a 2020 2020 2020 2020 696e  self,.        in
+00009710: 6f64 653a 2069 6e74 2c0a 2020 2020 2020  ode: int,.      
+00009720: 2020 6c6f 6361 6c5f 7061 7468 3a20 7374    local_path: st
+00009730: 722c 0a20 2020 2020 2020 2068 6173 685f  r,.        hash_
+00009740: 7374 723a 2073 7472 207c 204e 6f6e 652c  str: str | None,
+00009750: 0a20 2020 2020 2020 206d 7469 6d65 3a20  .        mtime: 
+00009760: 666c 6f61 7420 7c20 4e6f 6e65 2c0a 2020  float | None,.  
+00009770: 2020 2920 2d3e 204e 6f6e 653a 0a20 2020    ) -> None:.   
+00009780: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00009790: 2053 6176 6520 7468 6520 636f 6e74 656e   Save the conten
+000097a0: 7420 6861 7368 2066 6f72 2061 2066 696c  t hash for a fil
+000097b0: 6520 696e 206f 7572 2063 6163 6865 2e0a  e in our cache..
+000097c0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000097d0: 696e 6f64 653a 2049 6e6f 6465 206f 6620  inode: Inode of 
+000097e0: 7468 6520 6669 6c65 2e0a 2020 2020 2020  the file..      
+000097f0: 2020 3a70 6172 616d 206c 6f63 616c 5f70    :param local_p
+00009800: 6174 683a 2041 6273 6f6c 7574 6520 7061  ath: Absolute pa
+00009810: 7468 206f 6e20 6c6f 6361 6c20 6472 6976  th on local driv
+00009820: 652e 0a20 2020 2020 2020 203a 7061 7261  e..        :para
+00009830: 6d20 6861 7368 5f73 7472 3a20 4861 7368  m hash_str: Hash
+00009840: 2073 7472 696e 6720 746f 2073 6176 652e   string to save.
+00009850: 2049 6620 4e6f 6e65 2c20 7468 6520 6578   If None, the ex
+00009860: 6973 7469 6e67 2063 6163 6865 2065 6e74  isting cache ent
+00009870: 7279 2077 696c 6c20 6265 0a20 2020 2020  ry will be.     
+00009880: 2020 2020 2020 2064 656c 6574 6564 2e0a         deleted..
+00009890: 2020 2020 2020 2020 3a70 6172 616d 206d          :param m
+000098a0: 7469 6d65 3a20 4d74 696d 6520 6f66 2074  time: Mtime of t
+000098b0: 6865 2066 696c 6520 7768 656e 2074 6865  he file when the
+000098c0: 2068 6173 6820 7761 7320 636f 6d70 7574   hash was comput
+000098d0: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
+000098e0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+000098f0: 662e 5f64 6174 6162 6173 655f 6163 6365  f._database_acce
+00009900: 7373 2829 3a0a 2020 2020 2020 2020 2020  ss():.          
+00009910: 2020 6966 2068 6173 685f 7374 723a 0a20    if hash_str:. 
+00009920: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00009930: 6163 6865 5f65 6e74 7279 203d 2048 6173  ache_entry = Has
+00009940: 6843 6163 6865 456e 7472 7928 0a20 2020  hCacheEntry(.   
+00009950: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009960: 2069 6e6f 6465 3d69 6e6f 6465 2c0a 2020   inode=inode,.  
+00009970: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009980: 2020 6c6f 6361 6c5f 7061 7468 3d6c 6f63    local_path=loc
+00009990: 616c 5f70 6174 682c 0a20 2020 2020 2020  al_path,.       
+000099a0: 2020 2020 2020 2020 2020 2020 2068 6173               has
+000099b0: 685f 7374 723d 6861 7368 5f73 7472 2c0a  h_str=hash_str,.
+000099c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099d0: 2020 2020 6d74 696d 653d 6d74 696d 652c      mtime=mtime,
+000099e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000099f0: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
+00009a00: 2020 2073 656c 662e 5f68 6173 685f 7461     self._hash_ta
+00009a10: 626c 652e 7570 6461 7465 2863 6163 6865  ble.update(cache
+00009a20: 5f65 6e74 7279 290a 0a20 2020 2020 2020  _entry)..       
+00009a30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00009a40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00009a50: 5f68 6173 685f 7461 626c 652e 6465 6c65  _hash_table.dele
+00009a60: 7465 5f70 7269 6d61 7279 5f6b 6579 2869  te_primary_key(i
+00009a70: 6e6f 6465 290a 0a20 2020 2023 203d 3d3d  node)..    # ===
+00009a80: 3d20 4d69 676e 6f72 6520 6d61 6e61 6765  = Mignore manage
+00009a90: 6d65 6e74 203d 3d3d 3d3d 3d3d 3d3d 3d3d  ment ===========
+00009aa0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009ab0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009ac0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a  ===============.
+00009ad0: 0a20 2020 2040 7072 6f70 6572 7479 0a20  .    @property. 
+00009ae0: 2020 2064 6566 206d 6967 6e6f 7265 5f70     def mignore_p
+00009af0: 6174 6828 7365 6c66 2920 2d3e 2073 7472  ath(self) -> str
+00009b00: 3a0a 2020 2020 2020 2020 2222 2250 6174  :.        """Pat
+00009b10: 6820 746f 206d 6967 6e6f 7265 2066 696c  h to mignore fil
+00009b20: 6520 6f6e 206c 6f63 616c 2064 7269 7665  e on local drive
+00009b30: 2028 7265 6164 206f 6e6c 7929 2e22 2222   (read only)."""
+00009b40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00009b50: 7365 6c66 2e5f 6d69 676e 6f72 655f 7061  self._mignore_pa
+00009b60: 7468 0a0a 2020 2020 4070 726f 7065 7274  th..    @propert
+00009b70: 790a 2020 2020 6465 6620 6d69 676e 6f72  y.    def mignor
+00009b80: 655f 7275 6c65 7328 7365 6c66 2920 2d3e  e_rules(self) ->
+00009b90: 2050 6174 6853 7065 633a 0a20 2020 2020   PathSpec:.     
+00009ba0: 2020 2022 2222 4c69 7374 206f 6620 6d69     """List of mi
+00009bb0: 676e 6f72 6520 7275 6c65 7320 666f 6c6c  gnore rules foll
+00009bc0: 6f77 696e 6720 6769 7420 7769 6c64 6d61  owing git wildma
+00009bd0: 7463 6820 7379 6e74 6178 2028 7265 6164  tch syntax (read
+00009be0: 206f 6e6c 7929 2e22 2222 0a20 2020 2020   only).""".     
+00009bf0: 2020 2072 6574 7572 6e20 7365 6c66 2e5f     return self._
+00009c00: 6d69 676e 6f72 655f 7275 6c65 730a 0a20  mignore_rules.. 
+00009c10: 2020 2064 6566 206c 6f61 645f 6d69 676e     def load_mign
+00009c20: 6f72 655f 6669 6c65 2873 656c 6629 202d  ore_file(self) -
+00009c30: 3e20 4e6f 6e65 3a0a 2020 2020 2020 2020  > None:.        
+00009c40: 2222 220a 2020 2020 2020 2020 4c6f 6164  """.        Load
+00009c50: 7320 7275 6c65 7320 6672 6f6d 206d 6967  s rules from mig
+00009c60: 6e6f 7265 2066 696c 652e 204e 6f20 7275  nore file. No ru
+00009c70: 6c65 7320 6172 6520 6c6f 6164 6564 2069  les are loaded i
+00009c80: 6620 7468 6520 6669 6c65 2064 6f65 730a  f the file does.
+00009c90: 2020 2020 2020 2020 6e6f 7420 6578 6973          not exis
+00009ca0: 7420 6f72 2063 616e 6e6f 7420 6265 2072  t or cannot be r
+00009cb0: 6561 642e 0a0a 2020 2020 2020 2020 3a72  ead...        :r
+00009cc0: 6574 7572 6e73 3a20 5061 7468 5370 6563  eturns: PathSpec
+00009cd0: 2069 6e73 7461 6e63 6520 7769 7468 2069   instance with i
+00009ce0: 676e 6f72 6520 7061 7474 6572 6e73 2e0a  gnore patterns..
+00009cf0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00009d00: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00009d10: 2020 2020 2077 6974 6820 6f70 656e 2873       with open(s
+00009d20: 656c 662e 6d69 676e 6f72 655f 7061 7468  elf.mignore_path
+00009d30: 2920 6173 2066 3a0a 2020 2020 2020 2020  ) as f:.        
+00009d40: 2020 2020 2020 2020 7370 6563 203d 2066          spec = f
+00009d50: 2e72 6561 6428 290a 2020 2020 2020 2020  .read().        
+00009d60: 6578 6365 7074 204f 5345 7272 6f72 2061  except OSError a
+00009d70: 7320 6572 723a 0a20 2020 2020 2020 2020  s err:.         
+00009d80: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
+00009d90: 6465 6275 6728 2243 6f75 6c64 206e 6f74  debug("Could not
+00009da0: 206c 6f61 6420 6d69 676e 6f72 6520 7275   load mignore ru
+00009db0: 6c65 733a 2025 7322 2c20 6572 722e 7374  les: %s", err.st
+00009dc0: 7265 7272 6f72 290a 2020 2020 2020 2020  rerror).        
+00009dd0: 2020 2020 7370 6563 203d 2022 220a 0a20      spec = "".. 
+00009de0: 2020 2020 2020 2073 656c 662e 5f6d 6967         self._mig
+00009df0: 6e6f 7265 5f72 756c 6573 203d 2050 6174  nore_rules = Pat
+00009e00: 6853 7065 632e 6672 6f6d 5f6c 696e 6573  hSpec.from_lines
+00009e10: 2822 6769 7477 696c 646d 6174 6368 222c  ("gitwildmatch",
+00009e20: 2073 7065 632e 7370 6c69 746c 696e 6573   spec.splitlines
+00009e30: 2829 290a 0a20 2020 2023 203d 3d3d 3d20  ())..    # ==== 
+00009e40: 4865 6c70 6572 2066 756e 6374 696f 6e73  Helper functions
+00009e50: 203d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d   ===============
+00009e60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009e70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00009e80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d0a 0a20  =============.. 
+00009e90: 2020 2064 6566 2065 6e73 7572 655f 6472     def ensure_dr
+00009ea0: 6f70 626f 785f 666f 6c64 6572 5f70 7265  opbox_folder_pre
+00009eb0: 7365 6e74 2873 656c 6629 202d 3e20 4e6f  sent(self) -> No
+00009ec0: 6e65 3a0a 2020 2020 2020 2020 2222 220a  ne:.        """.
+00009ed0: 2020 2020 2020 2020 4368 6563 6b73 2069          Checks i
+00009ee0: 6620 7468 6520 4472 6f70 626f 7820 666f  f the Dropbox fo
+00009ef0: 6c64 6572 2073 7469 6c6c 2065 7869 7374  lder still exist
+00009f00: 7320 7768 6572 6520 7765 2065 7870 6563  s where we expec
+00009f10: 7420 6974 2074 6f20 6265 2e0a 0a20 2020  t it to be...   
+00009f20: 2020 2020 203a 7261 6973 6573 204e 6f44       :raises NoD
+00009f30: 726f 7062 6f78 4469 7245 7272 6f72 3a20  ropboxDirError: 
+00009f40: 5768 656e 206c 6f63 616c 2044 726f 7062  When local Dropb
+00009f50: 6f78 2064 6972 6563 746f 7279 2064 6f65  ox directory doe
+00009f60: 7320 6e6f 7420 6578 6973 742e 0a20 2020  s not exist..   
+00009f70: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00009f80: 2065 7863 6570 7469 6f6e 203d 204e 6f44   exception = NoD
+00009f90: 726f 7062 6f78 4469 7245 7272 6f72 280a  ropboxDirError(.
+00009fa0: 2020 2020 2020 2020 2020 2020 2244 726f              "Dro
+00009fb0: 7062 6f78 2066 6f6c 6465 7220 6d69 7373  pbox folder miss
+00009fc0: 696e 6722 2c0a 2020 2020 2020 2020 2020  ing",.          
+00009fd0: 2020 2250 6c65 6173 6520 6d6f 7665 2074    "Please move t
+00009fe0: 6865 2044 726f 7062 6f78 2066 6f6c 6465  he Dropbox folde
+00009ff0: 7220 6261 636b 2074 6f20 6974 7320 6f72  r back to its or
+0000a000: 6967 696e 616c 206c 6f63 6174 696f 6e20  iginal location 
+0000a010: 220a 2020 2020 2020 2020 2020 2020 226f  ".            "o
+0000a020: 7220 7265 7374 6172 7420 4d61 6573 7472  r restart Maestr
+0000a030: 616c 2074 6f20 7365 7420 7570 2061 206e  al to set up a n
+0000a040: 6577 2066 6f6c 6465 722e 222c 0a20 2020  ew folder.",.   
+0000a050: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000a060: 6966 206e 6f74 2069 7364 6972 2873 656c  if not isdir(sel
+0000a070: 662e 6472 6f70 626f 785f 7061 7468 293a  f.dropbox_path):
+0000a080: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+0000a090: 7365 2065 7863 6570 7469 6f6e 0a0a 2020  se exception..  
+0000a0a0: 2020 2020 2020 2320 4966 2074 6865 2066        # If the f
+0000a0b0: 696c 6520 7379 7374 656d 2069 7320 6e6f  ile system is no
+0000a0c0: 7420 6361 7365 2d73 656e 7369 7469 7665  t case-sensitive
+0000a0d0: 2062 7574 2070 7265 7365 7276 696e 672c   but preserving,
+0000a0e0: 2061 2070 6174 6820 7768 6963 6820 7761   a path which wa
+0000a0f0: 730a 2020 2020 2020 2020 2320 7265 6e61  s.        # rena
+0000a100: 6d65 6420 7769 7468 2061 2063 6173 6520  med with a case 
+0000a110: 6368 616e 6765 206f 6e6c 7920 7769 6c6c  change only will
+0000a120: 2073 7469 6c6c 2065 7869 7374 2061 7420   still exist at 
+0000a130: 7468 6520 6f6c 6420 6c6f 6361 7469 6f6e  the old location
+0000a140: 2e20 5765 0a20 2020 2020 2020 2023 2074  . We.        # t
+0000a150: 6865 7265 666f 7265 2065 7870 6c69 6369  herefore explici
+0000a160: 746c 7920 6368 6563 6b20 666f 7220 6361  tly check for ca
+0000a170: 7365 2063 6861 6e67 6573 2068 6572 652e  se changes here.
+0000a180: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+0000a190: 7365 6c66 2e69 735f 6673 5f63 6173 655f  self.is_fs_case_
+0000a1a0: 7365 6e73 6974 6976 653a 0a20 2020 2020  sensitive:.     
+0000a1b0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0000a1c0: 2020 2020 2020 2020 2020 2020 6361 7365              case
+0000a1d0: 645f 7061 7468 203d 2074 6f5f 6578 6973  d_path = to_exis
+0000a1e0: 7469 6e67 5f75 6e6e 6f72 6d61 6c69 7a65  ting_unnormalize
+0000a1f0: 645f 7061 7468 2873 656c 662e 6472 6f70  d_path(self.drop
+0000a200: 626f 785f 7061 7468 290a 2020 2020 2020  box_path).      
+0000a210: 2020 2020 2020 6578 6365 7074 2028 4669        except (Fi
+0000a220: 6c65 4e6f 7446 6f75 6e64 4572 726f 722c  leNotFoundError,
+0000a230: 204e 6f74 4144 6972 6563 746f 7279 4572   NotADirectoryEr
+0000a240: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+0000a250: 2020 2020 2020 7261 6973 6520 6578 6365        raise exce
+0000a260: 7074 696f 6e0a 0a20 2020 2020 2020 2020  ption..         
+0000a270: 2020 2069 6620 6361 7365 645f 7061 7468     if cased_path
+0000a280: 2021 3d20 7365 6c66 2e64 726f 7062 6f78   != self.dropbox
+0000a290: 5f70 6174 683a 0a20 2020 2020 2020 2020  _path:.         
+0000a2a0: 2020 2020 2020 2074 6974 6c65 203d 2022         title = "
+0000a2b0: 4472 6f70 626f 7820 666f 6c64 6572 2072  Dropbox folder r
+0000a2c0: 656e 616d 6564 220a 2020 2020 2020 2020  enamed".        
+0000a2d0: 2020 2020 2020 2020 6d73 6720 3d20 280a          msg = (.
+0000a2e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2f0: 2020 2020 2250 6c65 6173 6520 6d6f 7665      "Please move
+0000a300: 2074 6865 2044 726f 7062 6f78 2066 6f6c   the Dropbox fol
+0000a310: 6465 7220 6261 636b 2074 6f20 6974 7320  der back to its 
+0000a320: 6f72 6967 696e 616c 206c 6f63 6174 696f  original locatio
+0000a330: 6e20 220a 2020 2020 2020 2020 2020 2020  n ".            
+0000a340: 2020 2020 2020 2020 226f 7220 7265 7374          "or rest
+0000a350: 6172 7420 4d61 6573 7472 616c 2074 6f20  art Maestral to 
+0000a360: 7365 7420 7570 2061 206e 6577 2066 6f6c  set up a new fol
+0000a370: 6465 722e 220a 2020 2020 2020 2020 2020  der.".          
+0000a380: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000a390: 2020 2020 2020 2020 7261 6973 6520 4e6f          raise No
+0000a3a0: 4472 6f70 626f 7844 6972 4572 726f 7228  DropboxDirError(
+0000a3b0: 7469 746c 652c 206d 7367 290a 0a20 2020  title, msg)..   
+0000a3c0: 2064 6566 2065 6e73 7572 655f 6361 6368   def ensure_cach
+0000a3d0: 655f 6469 725f 7072 6573 656e 7428 7365  e_dir_present(se
+0000a3e0: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
+0000a3f0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000a400: 2043 6865 636b 7320 666f 7220 6f72 2063   Checks for or c
+0000a410: 7265 6174 6573 2061 2064 6972 6563 746f  reates a directo
+0000a420: 7279 2061 7420 3a61 7474 723a 6066 696c  ry at :attr:`fil
+0000a430: 655f 6361 6368 655f 7061 7468 602e 0a0a  e_cache_path`...
+0000a440: 2020 2020 2020 2020 3a72 6169 7365 7320          :raises 
+0000a450: 4361 6368 6544 6972 4572 726f 723a 2057  CacheDirError: W
+0000a460: 6865 6e20 6c6f 6361 6c20 6361 6368 6520  hen local cache 
+0000a470: 6469 7265 6374 6f72 7920 6361 6e6e 6f74  directory cannot
+0000a480: 2062 6520 6372 6561 7465 642e 0a20 2020   be created..   
+0000a490: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000a4a0: 2072 6574 7269 6573 203d 2030 0a20 2020   retries = 0.   
+0000a4b0: 2020 2020 206d 6178 5f72 6574 7269 6573       max_retries
+0000a4c0: 203d 2031 300a 0a20 2020 2020 2020 2077   = 10..        w
+0000a4d0: 6869 6c65 206e 6f74 2069 7364 6972 2873  hile not isdir(s
+0000a4e0: 656c 662e 6669 6c65 5f63 6163 6865 5f70  elf.file_cache_p
+0000a4f0: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
+0000a500: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+0000a510: 2020 2020 2020 2023 2054 6869 7320 7769         # This wi
+0000a520: 6c6c 2072 6169 7365 2046 696c 6545 7869  ll raise FileExi
+0000a530: 7374 7345 7272 6f72 2069 6620 6669 6c65  stsError if file
+0000a540: 5f63 6163 6865 5f70 6174 680a 2020 2020  _cache_path.    
+0000a550: 2020 2020 2020 2020 2020 2020 2320 6578              # ex
+0000a560: 6973 7473 2062 7574 2069 7320 6120 6669  ists but is a fi
+0000a570: 6c65 2069 6e73 7465 6164 206f 6620 6120  le instead of a 
+0000a580: 6469 7265 6374 6f72 792e 0a20 2020 2020  directory..     
+0000a590: 2020 2020 2020 2020 2020 206f 732e 6d61             os.ma
+0000a5a0: 6b65 6469 7273 2873 656c 662e 6669 6c65  kedirs(self.file
+0000a5b0: 5f63 6163 6865 5f70 6174 682c 2065 7869  _cache_path, exi
+0000a5c0: 7374 5f6f 6b3d 5472 7565 290a 2020 2020  st_ok=True).    
+0000a5d0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000a5e0: 726e 0a20 2020 2020 2020 2020 2020 2065  rn.            e
+0000a5f0: 7863 6570 7420 4669 6c65 4578 6973 7473  xcept FileExists
+0000a600: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
+0000a610: 2020 2020 2020 2023 2052 656d 6f76 6520         # Remove 
+0000a620: 7468 6520 6669 6c65 2074 6861 7427 7320  the file that's 
+0000a630: 696e 206f 7572 2077 6179 2c20 7265 7472  in our way, retr
+0000a640: 7920 6372 6561 7469 6f6e 2e0a 2020 2020  y creation..    
+0000a650: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000a660: 2e63 6c65 616e 5f63 6163 6865 5f64 6972  .clean_cache_dir
+0000a670: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
+0000a680: 7863 6570 7420 4e6f 7441 4469 7265 6374  xcept NotADirect
+0000a690: 6f72 7945 7272 6f72 3a0a 2020 2020 2020  oryError:.      
+0000a6a0: 2020 2020 2020 2020 2020 2320 456e 7375            # Ensu
+0000a6b0: 7265 2074 6861 7420 7061 7265 6e74 2064  re that parent d
+0000a6c0: 6972 6563 746f 7269 6573 2065 7869 7374  irectories exist
+0000a6d0: 2061 7320 6578 7065 6374 6564 2e0a 2020   as expected..  
+0000a6e0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0000a6f0: 6c66 2e65 6e73 7572 655f 6472 6f70 626f  lf.ensure_dropbo
+0000a700: 785f 666f 6c64 6572 5f70 7265 7365 6e74  x_folder_present
+0000a710: 2829 0a20 2020 2020 2020 2020 2020 2065  ().            e
+0000a720: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
+0000a730: 2065 7272 3a0a 2020 2020 2020 2020 2020   err:.          
+0000a740: 2020 2020 2020 7261 6973 6520 4361 6368        raise Cach
+0000a750: 6544 6972 4572 726f 7228 0a20 2020 2020  eDirError(.     
+0000a760: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000a770: 2243 616e 6e6f 7420 6372 6561 7465 2063  "Cannot create c
+0000a780: 6163 6865 2064 6972 6563 746f 7279 3a20  ache directory: 
+0000a790: 7b65 7272 2e73 7472 6572 726f 727d 222c  {err.strerror}",
+0000a7a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a7b0: 2020 2020 2022 506c 6561 7365 2063 6865       "Please che
+0000a7c0: 636b 2069 6620 796f 7520 6861 7665 2077  ck if you have w
+0000a7d0: 7269 7465 2070 6572 6d69 7373 696f 6e73  rite permissions
+0000a7e0: 2066 6f72 2022 0a20 2020 2020 2020 2020   for ".         
+0000a7f0: 2020 2020 2020 2020 2020 2066 227b 7365             f"{se
+0000a800: 6c66 2e5f 6669 6c65 5f63 6163 6865 5f70  lf._file_cache_p
+0000a810: 6174 687d 2e22 2c0a 2020 2020 2020 2020  ath}.",.        
+0000a820: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+0000a830: 2020 2020 2020 2069 6620 7265 7472 6965         if retrie
+0000a840: 7320 3e20 6d61 785f 7265 7472 6965 733a  s > max_retries:
+0000a850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a860: 2072 6169 7365 2043 6163 6865 4469 7245   raise CacheDirE
+0000a870: 7272 6f72 280a 2020 2020 2020 2020 2020  rror(.          
+0000a880: 2020 2020 2020 2020 2020 2243 616e 6e6f            "Canno
+0000a890: 7420 6372 6561 7465 2063 6163 6865 2064  t create cache d
+0000a8a0: 6972 6563 746f 7279 222c 0a20 2020 2020  irectory",.     
+0000a8b0: 2020 2020 2020 2020 2020 2020 2020 2022                 "
+0000a8c0: 4578 6365 6564 6564 206d 6178 696d 756d  Exceeded maximum
+0000a8d0: 206e 756d 6265 7220 6f66 2072 6574 7269   number of retri
+0000a8e0: 6573 222c 0a20 2020 2020 2020 2020 2020  es",.           
+0000a8f0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+0000a900: 2020 2020 7469 6d65 2e73 6c65 6570 2830      time.sleep(0
+0000a910: 2e30 3129 0a20 2020 2020 2020 2020 2020  .01).           
+0000a920: 2072 6574 7269 6573 202b 3d20 310a 0a20   retries += 1.. 
+0000a930: 2020 2064 6566 2063 6c65 616e 5f63 6163     def clean_cac
+0000a940: 6865 5f64 6972 2873 656c 662c 2072 6169  he_dir(self, rai
+0000a950: 7365 5f65 7272 6f72 3a20 626f 6f6c 203d  se_error: bool =
+0000a960: 2054 7275 6529 202d 3e20 4e6f 6e65 3a0a   True) -> None:.
+0000a970: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000a980: 2020 2020 5265 6d6f 7665 7320 616c 6c20      Removes all 
+0000a990: 6974 656d 7320 696e 2074 6865 2063 6163  items in the cac
+0000a9a0: 6865 2064 6972 6563 746f 7279 2e0a 0a20  he directory... 
+0000a9b0: 2020 2020 2020 203a 7061 7261 6d20 7261         :param ra
+0000a9c0: 6973 655f 6572 726f 723a 2057 6865 7468  ise_error: Wheth
+0000a9d0: 6572 2065 7272 6f72 7320 7368 6f75 6c64  er errors should
+0000a9e0: 2062 6520 7261 6973 6564 206f 7220 6f6e   be raised or on
+0000a9f0: 6c79 206c 6f67 6765 642e 0a20 2020 2020  ly logged..     
+0000aa00: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
+0000aa10: 6974 6820 7365 6c66 2e73 796e 635f 6c6f  ith self.sync_lo
+0000aa20: 636b 3a0a 2020 2020 2020 2020 2020 2020  ck:.            
+0000aa30: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000aa40: 2020 2020 2064 656c 6574 6528 7365 6c66       delete(self
+0000aa50: 2e5f 6669 6c65 5f63 6163 6865 5f70 6174  ._file_cache_pat
+0000aa60: 682c 2072 6169 7365 5f65 7272 6f72 3d54  h, raise_error=T
+0000aa70: 7275 6529 0a20 2020 2020 2020 2020 2020  rue).           
+0000aa80: 2065 7863 6570 7420 2846 696c 654e 6f74   except (FileNot
+0000aa90: 466f 756e 6445 7272 6f72 2c20 4973 4144  FoundError, IsAD
+0000aaa0: 6972 6563 746f 7279 4572 726f 7229 3a0a  irectoryError):.
+0000aab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000aac0: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+0000aad0: 2065 7863 6570 7420 4f53 4572 726f 7220   except OSError 
+0000aae0: 6173 2065 7272 3a0a 2020 2020 2020 2020  as err:.        
+0000aaf0: 2020 2020 2020 2020 6578 6320 3d20 4361          exc = Ca
+0000ab00: 6368 6544 6972 4572 726f 7228 0a20 2020  cheDirError(.   
+0000ab10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ab20: 2066 2243 616e 6e6f 7420 6372 6561 7465   f"Cannot create
+0000ab30: 2063 6163 6865 2064 6972 6563 746f 7279   cache directory
+0000ab40: 3a20 7b65 7272 2e73 7472 6572 726f 727d  : {err.strerror}
+0000ab50: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000ab60: 2020 2020 2020 2022 506c 6561 7365 2063         "Please c
+0000ab70: 6865 636b 2069 6620 796f 7520 6861 7665  heck if you have
+0000ab80: 2077 7269 7465 2070 6572 6d69 7373 696f   write permissio
+0000ab90: 6e73 2066 6f72 2022 0a20 2020 2020 2020  ns for ".       
+0000aba0: 2020 2020 2020 2020 2020 2020 2066 227b               f"{
+0000abb0: 7365 6c66 2e5f 6669 6c65 5f63 6163 6865  self._file_cache
+0000abc0: 5f70 6174 687d 2e22 2c0a 2020 2020 2020  _path}.",.      
+0000abd0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000abe0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000abf0: 7261 6973 655f 6572 726f 723a 0a20 2020  raise_error:.   
+0000ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac10: 2072 6169 7365 2065 7863 0a0a 2020 2020   raise exc..    
+0000ac20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000ac30: 2e5f 6c6f 6767 6572 2e65 7272 6f72 2865  ._logger.error(e
+0000ac40: 7863 2e74 6974 6c65 2c20 6578 635f 696e  xc.title, exc_in
+0000ac50: 666f 3d65 7863 5f69 6e66 6f5f 7475 706c  fo=exc_info_tupl
+0000ac60: 6528 6578 6329 290a 2020 2020 2020 2020  e(exc)).        
+0000ac70: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0000ac80: 6465 736b 746f 705f 6e6f 7469 6669 6572  desktop_notifier
+0000ac90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000aca0: 2020 2020 2020 7365 6c66 2e64 6573 6b74        self.deskt
+0000acb0: 6f70 5f6e 6f74 6966 6965 722e 6e6f 7469  op_notifier.noti
+0000acc0: 6679 280a 2020 2020 2020 2020 2020 2020  fy(.            
+0000acd0: 2020 2020 2020 2020 2020 2020 6578 632e              exc.
+0000ace0: 7469 746c 652c 2065 7863 2e6d 6573 7361  title, exc.messa
+0000acf0: 6765 2c20 6c65 7665 6c3d 6e6f 7469 6679  ge, level=notify
+0000ad00: 2e45 5252 4f52 0a20 2020 2020 2020 2020  .ERROR.         
+0000ad10: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+0000ad20: 2020 6465 6620 5f6e 6577 5f74 6d70 5f66    def _new_tmp_f
+0000ad30: 696c 6528 7365 6c66 2920 2d3e 2073 7472  ile(self) -> str
+0000ad40: 3a0a 2020 2020 2020 2020 2222 2243 7265  :.        """Cre
+0000ad50: 6174 6573 2061 206e 6577 2074 656d 706f  ates a new tempo
+0000ad60: 7261 7279 2066 696c 6520 696e 206f 7572  rary file in our
+0000ad70: 2063 6163 6865 2064 6972 6563 746f 7279   cache directory
+0000ad80: 2061 6e64 2072 6574 7572 6e73 2069 7473   and returns its
+0000ad90: 2070 6174 682e 2222 220a 2020 2020 2020   path.""".      
+0000ada0: 2020 7365 6c66 2e65 6e73 7572 655f 6361    self.ensure_ca
+0000adb0: 6368 655f 6469 725f 7072 6573 656e 7428  che_dir_present(
+0000adc0: 290a 2020 2020 2020 2020 7472 793a 0a20  ).        try:. 
+0000add0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
+0000ade0: 4e61 6d65 6454 656d 706f 7261 7279 4669  NamedTemporaryFi
+0000adf0: 6c65 2864 6972 3d73 656c 662e 6669 6c65  le(dir=self.file
+0000ae00: 5f63 6163 6865 5f70 6174 682c 2064 656c  _cache_path, del
+0000ae10: 6574 653d 4661 6c73 6529 2061 7320 663a  ete=False) as f:
+0000ae20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ae30: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0000ae40: 2020 2020 2020 2020 2020 6f73 2e63 686d            os.chm
+0000ae50: 6f64 2866 2e66 696c 656e 6f28 292c 2030  od(f.fileno(), 0
+0000ae60: 6f36 3636 2026 207e 756d 6173 6b29 0a20  o666 & ~umask). 
+0000ae70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000ae80: 7863 6570 7420 4f53 4572 726f 7220 6173  xcept OSError as
+0000ae90: 2065 7272 3a0a 2020 2020 2020 2020 2020   err:.          
+0000aea0: 2020 2020 2020 2020 2020 2320 4361 6e20            # Can 
+0000aeb0: 6f63 6375 7220 6f6e 2066 696c 6520 7379  occur on file sy
+0000aec0: 7374 656d 2773 2074 6861 7420 646f 6e27  stem's that don'
+0000aed0: 7420 7375 7070 6f72 7420 504f 5349 5820  t support POSIX 
+0000aee0: 7065 726d 6973 7369 6f6e 730a 2020 2020  permissions.    
+0000aef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af00: 2320 7375 6368 2061 7320 4e54 4653 206d  # such as NTFS m
+0000af10: 6f75 6e74 6564 2077 6974 686f 7574 2074  ounted without t
+0000af20: 6865 2070 6572 6d69 7373 696f 6e73 206f  he permissions o
+0000af30: 7074 696f 6e2e 0a20 2020 2020 2020 2020  ption..         
+0000af40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000af50: 5f6c 6f67 6765 722e 6465 6275 6728 2243  _logger.debug("C
+0000af60: 616e 6e6f 7420 7365 7420 7065 726d 6973  annot set permis
+0000af70: 7369 6f6e 733a 2025 7322 2c20 6572 722e  sions: %s", err.
+0000af80: 7374 7265 7272 6f72 290a 2020 2020 2020  strerror).      
+0000af90: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0000afa0: 2066 2e6e 616d 650a 2020 2020 2020 2020   f.name.        
+0000afb0: 6578 6365 7074 204f 5345 7272 6f72 2061  except OSError a
+0000afc0: 7320 6572 723a 0a20 2020 2020 2020 2020  s err:.         
+0000afd0: 2020 2072 6169 7365 2043 6163 6865 4469     raise CacheDi
+0000afe0: 7245 7272 6f72 280a 2020 2020 2020 2020  rError(.        
+0000aff0: 2020 2020 2020 2020 6622 4361 6e6e 6f74          f"Cannot
+0000b000: 2063 7265 6174 6520 6361 6368 6520 6469   create cache di
+0000b010: 7265 6374 6f72 793a 207b 6572 722e 7374  rectory: {err.st
+0000b020: 7265 7272 6f72 7d22 2c0a 2020 2020 2020  rerror}",.      
+0000b030: 2020 2020 2020 2020 2020 2250 6c65 6173            "Pleas
+0000b040: 6520 6368 6563 6b20 6966 2079 6f75 2068  e check if you h
+0000b050: 6176 6520 7772 6974 6520 7065 726d 6973  ave write permis
+0000b060: 7369 6f6e 7320 666f 7220 220a 2020 2020  sions for ".    
+0000b070: 2020 2020 2020 2020 2020 2020 6622 7b73              f"{s
+0000b080: 656c 662e 5f66 696c 655f 6361 6368 655f  elf._file_cache_
+0000b090: 7061 7468 7d2e 222c 0a20 2020 2020 2020  path}.",.       
+0000b0a0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
+0000b0b0: 636f 7272 6563 745f 6361 7365 2873 656c  correct_case(sel
+0000b0c0: 662c 2064 6278 5f70 6174 683a 2073 7472  f, dbx_path: str
+0000b0d0: 2920 2d3e 2073 7472 3a0a 2020 2020 2020  ) -> str:.      
+0000b0e0: 2020 2222 220a 2020 2020 2020 2020 436f    """.        Co
+0000b0f0: 6e76 6572 7473 2061 2044 726f 7062 6f78  nverts a Dropbox
+0000b100: 2070 6174 6820 7769 7468 2063 6f72 7265   path with corre
+0000b110: 6374 6c79 2063 6173 6564 2062 6173 656e  ctly cased basen
+0000b120: 616d 6520 746f 2061 2066 756c 6c79 2063  ame to a fully c
+0000b130: 6173 6564 2070 6174 682e 0a20 2020 2020  ased path..     
+0000b140: 2020 2054 6869 7320 6973 2075 7365 6675     This is usefu
+0000b150: 6c20 6265 6361 7573 6520 7468 6520 4472  l because the Dr
+0000b160: 6f70 626f 7820 4150 4920 6775 6172 616e  opbox API guaran
+0000b170: 7465 6573 2074 6865 2063 6f72 7265 6374  tees the correct
+0000b180: 2063 6173 696e 6720 666f 7220 7468 650a   casing for the.
+0000b190: 2020 2020 2020 2020 6261 7365 6e61 6d65          basename
+0000b1a0: 206f 6e6c 792e 2049 6e20 7072 6163 7469   only. In practi
+0000b1b0: 6365 2c20 6361 7369 6e67 206f 6620 7061  ce, casing of pa
+0000b1c0: 7265 6e74 2064 6972 6563 746f 7269 6573  rent directories
+0000b1d0: 2069 7320 6f66 7465 6e20 696e 636f 7272   is often incorr
+0000b1e0: 6563 742e 0a20 2020 2020 2020 2054 6869  ect..        Thi
+0000b1f0: 7320 6d65 7468 6f64 2072 6574 7269 6576  s method retriev
+0000b200: 6573 2074 6865 2063 6f72 7265 6374 2063  es the correct c
+0000b210: 6173 696e 6720 6f66 2061 6c6c 2061 6e63  asing of all anc
+0000b220: 6573 746f 7273 2069 6e20 7468 6520 7061  estors in the pa
+0000b230: 7468 2c20 6569 7468 6572 0a20 2020 2020  th, either.     
+0000b240: 2020 2066 726f 6d20 6f75 7220 6361 6368     from our cach
+0000b250: 652c 206f 7572 2064 6174 6162 6173 652c  e, our database,
+0000b260: 206f 7220 6672 6f6d 2044 726f 7062 6f78   or from Dropbox
+0000b270: 2073 6572 7665 7273 2e0a 0a20 2020 2020   servers...     
+0000b280: 2020 2050 6572 666f 726d 616e 6365 206d     Performance m
+0000b290: 6179 2076 6172 7920 7369 676e 6966 6963  ay vary signific
+0000b2a0: 616e 746c 7920 7769 7468 2074 6865 206e  antly with the n
+0000b2b0: 756d 6265 7220 6f66 2070 6172 656e 7420  umber of parent 
+0000b2c0: 666f 6c64 6572 7320 616e 6420 7468 650a  folders and the.
+0000b2d0: 2020 2020 2020 2020 6d65 7468 6f64 2075          method u
+0000b2e0: 7365 6420 746f 2072 6573 6f6c 7665 2074  sed to resolve t
+0000b2f0: 6865 2063 6173 696e 6720 6f66 2061 6c6c  he casing of all
+0000b300: 2070 6172 656e 7420 6469 7265 6374 6f72   parent director
+0000b310: 7920 6e61 6d65 733a 0a0a 2020 2020 2020  y names:..      
+0000b320: 2020 3129 2049 6620 7468 6520 7061 7265    1) If the pare
+0000b330: 6e74 2064 6972 6563 746f 7279 2069 7320  nt directory is 
+0000b340: 616c 7265 6164 7920 696e 206f 7572 2063  already in our c
+0000b350: 6163 6865 2c20 7065 7266 6f72 6d61 6e63  ache, performanc
+0000b360: 6520 6973 204f 2831 292e 0a20 2020 2020  e is O(1)..     
+0000b370: 2020 2032 2920 4966 2074 6865 2070 6172     2) If the par
+0000b380: 656e 7420 6469 7265 6374 6f72 7920 6973  ent directory is
+0000b390: 2061 6c72 6561 6479 2069 6e20 6f75 7220   already in our 
+0000b3a0: 7379 6e63 2069 6e64 6578 2c20 7065 7266  sync index, perf
+0000b3b0: 6f72 6d61 6e63 6520 6973 2073 6c6f 7765  ormance is slowe
+0000b3c0: 720a 2020 2020 2020 2020 2020 2062 6563  r.           bec
+0000b3d0: 6175 7365 2069 7420 7265 7175 6972 6573  ause it requires
+0000b3e0: 2061 2073 716c 6974 6520 7175 6572 7920   a sqlite query 
+0000b3f0: 6275 7420 7374 696c 6c20 4f28 3129 2e0a  but still O(1)..
+0000b400: 2020 2020 2020 2020 3329 2049 6620 7468          3) If th
+0000b410: 6520 7061 7265 6e74 2064 6972 6563 746f  e parent directo
+0000b420: 7279 2069 7320 756e 6b6e 6f77 6e20 746f  ry is unknown to
+0000b430: 2075 732c 2069 7473 206d 6574 6164 6174   us, its metadat
+0000b440: 6120 2869 6e63 6c75 6469 6e67 2074 6865  a (including the
+0000b450: 2063 6f72 7265 6374 0a20 2020 2020 2020   correct.       
+0000b460: 2020 2020 6361 7369 6e67 206f 6620 6469      casing of di
+0000b470: 7265 6374 6f72 7927 7320 6261 7365 6e61  rectory's basena
+0000b480: 6d65 2920 6973 2071 7565 7269 6564 2066  me) is queried f
+0000b490: 726f 6d20 4472 6f70 626f 782e 2054 6869  rom Dropbox. Thi
+0000b4a0: 7320 6973 2075 7365 6420 746f 0a20 2020  s is used to.   
+0000b4b0: 2020 2020 2020 2020 636f 6e73 7472 7563          construc
+0000b4c0: 7420 6120 636f 7272 6563 746c 7920 6361  t a correctly ca
+0000b4d0: 7365 6420 7061 7468 2062 7920 6361 6c6c  sed path by call
+0000b4e0: 696e 6720 3a6d 6574 683a 6063 6f72 7265  ing :meth:`corre
+0000b4f0: 6374 5f63 6173 6560 2061 6761 696e 2e20  ct_case` again. 
+0000b500: 4174 0a20 2020 2020 2020 2020 2020 6265  At.           be
+0000b510: 7374 2c20 7065 7266 6f72 6d61 6e63 6520  st, performance 
+0000b520: 7769 6c6c 2062 6520 6f66 204f 2832 2920  will be of O(2) 
+0000b530: 6966 2074 6865 2070 6172 656e 7420 6469  if the parent di
+0000b540: 7265 6374 6f72 7920 6973 206b 6e6f 776e  rectory is known
+0000b550: 2074 6f20 7573 2c20 6174 0a20 2020 2020   to us, at.     
+0000b560: 2020 2020 2020 776f 7273 7420 6974 2077        worst it w
+0000b570: 696c 6c20 6265 206f 6620 6f72 6465 7220  ill be of order 
+0000b580: 4f28 6e29 2069 6e76 6f6c 7669 6e67 2071  O(n) involving q
+0000b590: 7565 7269 6573 2074 6f20 4472 6f70 626f  ueries to Dropbo
+0000b5a0: 7820 7365 7276 6572 7320 666f 7220 6561  x servers for ea
+0000b5b0: 6368 0a20 2020 2020 2020 2020 2020 7061  ch.           pa
+0000b5c0: 7265 6e74 2064 6972 6563 746f 7279 2e0a  rent directory..
+0000b5d0: 0a20 2020 2020 2020 2057 6865 6e20 6361  .        When ca
+0000b5e0: 6c6c 696e 6720 3a6d 6574 683a 6063 6f72  lling :meth:`cor
+0000b5f0: 7265 6374 5f63 6173 6560 2072 6570 6561  rect_case` repea
+0000b600: 7465 646c 7920 666f 7220 7061 7468 7320  tedly for paths 
+0000b610: 6672 6f6d 2074 6865 2073 616d 6520 7472  from the same tr
+0000b620: 6565 2c20 6974 2069 730a 2020 2020 2020  ee, it is.      
+0000b630: 2020 7468 6572 6566 6f72 6520 6265 7374    therefore best
+0000b640: 2074 6f20 646f 2073 6f20 696e 2068 6965   to do so in hie
+0000b650: 7261 7263 6869 6361 6c20 6f72 6465 722e  rarchical order.
+0000b660: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0000b670: 2064 6278 5f70 6174 683a 2044 726f 7062   dbx_path: Dropb
+0000b680: 6f78 2070 6174 6820 7769 7468 2063 6f72  ox path with cor
+0000b690: 7265 6374 6c79 2063 6173 6564 2062 6173  rectly cased bas
+0000b6a0: 656e 616d 652c 2061 7320 7072 6f76 6964  ename, as provid
+0000b6b0: 6564 2062 790a 2020 2020 2020 2020 2020  ed by.          
+0000b6c0: 2020 3a61 7474 723a 6064 726f 7062 6f78    :attr:`dropbox
+0000b6d0: 2e66 696c 6573 2e4d 6574 6164 6174 612e  .files.Metadata.
+0000b6e0: 7061 7468 5f64 6973 706c 6179 6020 6f72  path_display` or
+0000b6f0: 0a20 2020 2020 2020 2020 2020 203a 6174  .            :at
+0000b700: 7472 3a60 6472 6f70 626f 782e 6669 6c65  tr:`dropbox.file
+0000b710: 732e 4d65 7461 6461 7461 2e6e 616d 6560  s.Metadata.name`
+0000b720: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+0000b730: 6e73 3a20 436f 7272 6563 746c 7920 6361  ns: Correctly ca
+0000b740: 7365 6420 4472 6f70 626f 7820 7061 7468  sed Dropbox path
+0000b750: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0000b760: 2020 2020 2020 6462 785f 7061 7468 5f6c        dbx_path_l
+0000b770: 6f77 6572 203d 206e 6f72 6d61 6c69 7a65  ower = normalize
+0000b780: 2864 6278 5f70 6174 6829 0a0a 2020 2020  (dbx_path)..    
+0000b790: 2020 2020 6469 726e 616d 652c 2062 6173      dirname, bas
+0000b7a0: 656e 616d 6520 3d20 6f73 702e 7370 6c69  ename = osp.spli
+0000b7b0: 7428 6462 785f 7061 7468 290a 2020 2020  t(dbx_path).    
+0000b7c0: 2020 2020 6469 726e 616d 655f 6c6f 7765      dirname_lowe
+0000b7d0: 7220 3d20 6f73 702e 6469 726e 616d 6528  r = osp.dirname(
+0000b7e0: 6462 785f 7061 7468 5f6c 6f77 6572 290a  dbx_path_lower).
+0000b7f0: 0a20 2020 2020 2020 2064 6972 6e61 6d65  .        dirname
+0000b800: 5f63 6173 6564 203d 2073 656c 662e 5f63  _cased = self._c
+0000b810: 6f72 7265 6374 5f63 6173 655f 6865 6c70  orrect_case_help
+0000b820: 6572 2864 6972 6e61 6d65 2c20 6469 726e  er(dirname, dirn
+0000b830: 616d 655f 6c6f 7765 7229 0a20 2020 2020  ame_lower).     
+0000b840: 2020 2070 6174 685f 6361 7365 6420 3d20     path_cased = 
+0000b850: 6f73 702e 6a6f 696e 2864 6972 6e61 6d65  osp.join(dirname
+0000b860: 5f63 6173 6564 2c20 6261 7365 6e61 6d65  _cased, basename
+0000b870: 290a 0a20 2020 2020 2020 2023 2041 6464  )..        # Add
+0000b880: 206f 7572 2072 6573 756c 7420 746f 2074   our result to t
+0000b890: 6865 2063 6163 6865 2e0a 2020 2020 2020  he cache..      
+0000b8a0: 2020 7365 6c66 2e5f 6361 7365 5f63 6f6e    self._case_con
+0000b8b0: 7665 7273 696f 6e5f 6361 6368 652e 7075  version_cache.pu
+0000b8c0: 7428 6462 785f 7061 7468 5f6c 6f77 6572  t(dbx_path_lower
+0000b8d0: 2c20 7061 7468 5f63 6173 6564 290a 0a20  , path_cased).. 
+0000b8e0: 2020 2020 2020 2072 6574 7572 6e20 7061         return pa
+0000b8f0: 7468 5f63 6173 6564 0a0a 2020 2020 6465  th_cased..    de
+0000b900: 6620 5f63 6f72 7265 6374 5f63 6173 655f  f _correct_case_
+0000b910: 6865 6c70 6572 2873 656c 662c 2064 6278  helper(self, dbx
+0000b920: 5f70 6174 683a 2073 7472 2c20 6462 785f  _path: str, dbx_
+0000b930: 7061 7468 5f6c 6f77 6572 3a20 7374 7229  path_lower: str)
+0000b940: 202d 3e20 7374 723a 0a20 2020 2020 2020   -> str:.       
+0000b950: 2022 2222 0a20 2020 2020 2020 203a 7061   """.        :pa
+0000b960: 7261 6d20 6462 785f 7061 7468 3a20 556e  ram dbx_path: Un
+0000b970: 6361 7365 6420 6f72 2072 616e 646f 6d6c  cased or randoml
+0000b980: 7920 6361 7365 6420 4472 6f70 626f 7820  y cased Dropbox 
+0000b990: 7061 7468 2e0a 2020 2020 2020 2020 3a70  path..        :p
+0000b9a0: 6172 616d 2064 6278 5f70 6174 685f 6c6f  aram dbx_path_lo
+0000b9b0: 7765 723a 204e 6f72 6d61 6c69 7a65 6420  wer: Normalized 
+0000b9c0: 6675 6c6c 7920 6c6f 7765 7220 6361 7365  fully lower case
+0000b9d0: 6420 4472 6f70 626f 7820 7061 7468 2e0a  d Dropbox path..
+0000b9e0: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+0000b9f0: 3a20 436f 7272 6563 746c 7920 6361 7365  : Correctly case
+0000ba00: 6420 4472 6f70 626f 7820 7061 7468 2e0a  d Dropbox path..
+0000ba10: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000ba20: 2020 2020 2320 4368 6563 6b20 666f 7220      # Check for 
+0000ba30: 726f 6f74 2066 6f6c 6465 722e 0a20 2020  root folder..   
+0000ba40: 2020 2020 2069 6620 6462 785f 7061 7468       if dbx_path
+0000ba50: 203d 3d20 222f 223a 0a20 2020 2020 2020   == "/":.       
+0000ba60: 2020 2020 2072 6574 7572 6e20 6462 785f       return dbx_
+0000ba70: 7061 7468 0a0a 2020 2020 2020 2020 2320  path..        # 
+0000ba80: 4368 6563 6b20 696e 206f 7572 2063 6f6e  Check in our con
+0000ba90: 7665 7273 696f 6e20 6361 6368 652e 0a20  version cache.. 
+0000baa0: 2020 2020 2020 2064 6278 5f70 6174 685f         dbx_path_
+0000bab0: 6361 7365 6420 3d20 7365 6c66 2e5f 6361  cased = self._ca
+0000bac0: 7365 5f63 6f6e 7665 7273 696f 6e5f 6361  se_conversion_ca
+0000bad0: 6368 652e 6765 7428 6462 785f 7061 7468  che.get(dbx_path
+0000bae0: 5f6c 6f77 6572 290a 0a20 2020 2020 2020  _lower)..       
+0000baf0: 2069 6620 6462 785f 7061 7468 5f63 6173   if dbx_path_cas
+0000bb00: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+0000bb10: 7265 7475 726e 2064 6278 5f70 6174 685f  return dbx_path_
+0000bb20: 6361 7365 640a 0a20 2020 2020 2020 2023  cased..        #
+0000bb30: 2054 7279 2074 6f20 6765 7420 6361 7369   Try to get casi
+0000bb40: 6e67 2066 726f 6d20 6f75 7220 696e 6465  ng from our inde
+0000bb50: 782c 2074 6869 7320 6973 2073 6c6f 7765  x, this is slowe
+0000bb60: 722e 0a20 2020 2020 2020 2077 6974 6820  r..        with 
+0000bb70: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
+0000bb80: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
+0000bb90: 2020 2020 2065 6e74 7279 203d 2073 656c       entry = sel
+0000bba0: 662e 6765 745f 696e 6465 785f 656e 7472  f.get_index_entr
+0000bbb0: 7928 6462 785f 7061 7468 5f6c 6f77 6572  y(dbx_path_lower
+0000bbc0: 290a 0a20 2020 2020 2020 2069 6620 656e  )..        if en
+0000bbd0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
+0000bbe0: 2064 6278 5f70 6174 685f 6361 7365 6420   dbx_path_cased 
+0000bbf0: 3d20 656e 7472 792e 6462 785f 7061 7468  = entry.dbx_path
+0000bc00: 5f63 6173 6564 0a20 2020 2020 2020 2065  _cased.        e
+0000bc10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0000bc20: 2023 2046 616c 6c20 6261 636b 2074 6f20   # Fall back to 
+0000bc30: 7175 6572 7969 6e67 2066 726f 6d20 7365  querying from se
+0000bc40: 7276 6572 2e0a 2020 2020 2020 2020 2020  rver..          
+0000bc50: 2020 6d64 203d 2073 656c 662e 636c 6965    md = self.clie
+0000bc60: 6e74 2e67 6574 5f6d 6574 6164 6174 6128  nt.get_metadata(
+0000bc70: 6462 785f 7061 7468 290a 2020 2020 2020  dbx_path).      
+0000bc80: 2020 2020 2020 6966 206d 643a 0a20 2020        if md:.   
+0000bc90: 2020 2020 2020 2020 2020 2020 2023 2052               # R
+0000bca0: 6563 7572 7365 206f 7665 7220 7061 7265  ecurse over pare
+0000bcb0: 6e74 2064 6972 6563 746f 7269 6573 2e0a  nt directories..
+0000bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bcd0: 6462 785f 7061 7468 5f63 6173 6564 203d  dbx_path_cased =
+0000bce0: 2073 656c 662e 636f 7272 6563 745f 6361   self.correct_ca
+0000bcf0: 7365 286d 642e 7061 7468 5f64 6973 706c  se(md.path_displ
+0000bd00: 6179 290a 2020 2020 2020 2020 2020 2020  ay).            
+0000bd10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000bd20: 2020 2020 2020 2320 4769 7665 2075 702e        # Give up.
+0000bd30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000bd40: 2064 6278 5f70 6174 685f 6361 7365 6420   dbx_path_cased 
+0000bd50: 3d20 6462 785f 7061 7468 0a0a 2020 2020  = dbx_path..    
+0000bd60: 2020 2020 2320 4164 6420 6f75 7220 7265      # Add our re
+0000bd70: 7375 6c74 2074 6f20 7468 6520 6361 6368  sult to the cach
+0000bd80: 652e 0a20 2020 2020 2020 2073 656c 662e  e..        self.
+0000bd90: 5f63 6173 655f 636f 6e76 6572 7369 6f6e  _case_conversion
+0000bda0: 5f63 6163 6865 2e70 7574 2864 6278 5f70  _cache.put(dbx_p
+0000bdb0: 6174 685f 6c6f 7765 722c 2064 6278 5f70  ath_lower, dbx_p
+0000bdc0: 6174 685f 6361 7365 6429 0a0a 2020 2020  ath_cased)..    
+0000bdd0: 2020 2020 7265 7475 726e 2064 6278 5f70      return dbx_p
+0000bde0: 6174 685f 6361 7365 640a 0a20 2020 2064  ath_cased..    d
+0000bdf0: 6566 2074 6f5f 6462 785f 7061 7468 2873  ef to_dbx_path(s
+0000be00: 656c 662c 206c 6f63 616c 5f70 6174 683a  elf, local_path:
+0000be10: 2073 7472 2920 2d3e 2073 7472 3a0a 2020   str) -> str:.  
+0000be20: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+0000be30: 2020 436f 6e76 6572 7473 2061 206c 6f63    Converts a loc
+0000be40: 616c 2070 6174 6820 746f 2061 2070 6174  al path to a pat
+0000be50: 6820 7265 6c61 7469 7665 2074 6f20 7468  h relative to th
+0000be60: 6520 4472 6f70 626f 7820 666f 6c64 6572  e Dropbox folder
+0000be70: 2e20 4361 7369 6e67 206f 6620 7468 650a  . Casing of the.
+0000be80: 2020 2020 2020 2020 6769 7665 6e20 6060          given ``
+0000be90: 6c6f 6361 6c5f 7061 7468 6060 2077 696c  local_path`` wil
+0000bea0: 6c20 6265 2070 7265 7365 7276 6564 2e0a  l be preserved..
+0000beb0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0000bec0: 6c6f 6361 6c5f 7061 7468 3a20 4162 736f  local_path: Abso
+0000bed0: 6c75 7465 2070 6174 6820 6f6e 206c 6f63  lute path on loc
+0000bee0: 616c 2064 7269 7665 2e0a 2020 2020 2020  al drive..      
+0000bef0: 2020 3a72 6574 7572 6e73 3a20 5265 6c61    :returns: Rela
+0000bf00: 7469 7665 2070 6174 6820 7769 7468 2072  tive path with r
+0000bf10: 6573 7065 6374 2074 6f20 4472 6f70 626f  espect to Dropbo
+0000bf20: 7820 666f 6c64 6572 2e0a 2020 2020 2020  x folder..      
+0000bf30: 2020 3a72 6169 7365 7320 5661 6c75 6545    :raises ValueE
+0000bf40: 7272 6f72 3a20 5768 656e 2074 6865 2070  rror: When the p
+0000bf50: 6174 6820 6c69 6573 206f 7574 7369 6465  ath lies outside
+0000bf60: 2074 6865 206c 6f63 616c 2044 726f 7062   the local Dropb
+0000bf70: 6f78 2066 6f6c 6465 722e 0a20 2020 2020  ox folder..     
+0000bf80: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+0000bf90: 6620 6e6f 7420 6973 5f65 7175 616c 5f6f  f not is_equal_o
+0000bfa0: 725f 6368 696c 6428 0a20 2020 2020 2020  r_child(.       
+0000bfb0: 2020 2020 206c 6f63 616c 5f70 6174 682c       local_path,
+0000bfc0: 2073 656c 662e 6472 6f70 626f 785f 7061   self.dropbox_pa
+0000bfd0: 7468 2c20 7365 6c66 2e69 735f 6673 5f63  th, self.is_fs_c
+0000bfe0: 6173 655f 7365 6e73 6974 6976 650a 2020  ase_sensitive.  
+0000bff0: 2020 2020 2020 293a 0a20 2020 2020 2020        ):.       
+0000c000: 2020 2020 2072 6169 7365 2056 616c 7565       raise Value
+0000c010: 4572 726f 7228 6627 227b 6c6f 6361 6c5f  Error(f'"{local_
+0000c020: 7061 7468 7d22 2069 7320 6e6f 7420 696e  path}" is not in
+0000c030: 2022 7b73 656c 662e 6472 6f70 626f 785f   "{self.dropbox_
+0000c040: 7061 7468 7d22 2729 0a20 2020 2020 2020  path}"').       
+0000c050: 2072 6574 7572 6e20 222f 2220 2b20 7265   return "/" + re
+0000c060: 6d6f 7665 7072 6566 6978 280a 2020 2020  moveprefix(.    
+0000c070: 2020 2020 2020 2020 6c6f 6361 6c5f 7061          local_pa
+0000c080: 7468 2c20 7365 6c66 2e64 726f 7062 6f78  th, self.dropbox
+0000c090: 5f70 6174 682c 2073 656c 662e 6973 5f66  _path, self.is_f
+0000c0a0: 735f 6361 7365 5f73 656e 7369 7469 7665  s_case_sensitive
+0000c0b0: 0a20 2020 2020 2020 2029 2e6c 7374 7269  .        ).lstri
+0000c0c0: 7028 222f 2229 0a0a 2020 2020 6465 6620  p("/")..    def 
+0000c0d0: 746f 5f64 6278 5f70 6174 685f 6c6f 7765  to_dbx_path_lowe
+0000c0e0: 7228 7365 6c66 2c20 6c6f 6361 6c5f 7061  r(self, local_pa
+0000c0f0: 7468 3a20 7374 7229 202d 3e20 7374 723a  th: str) -> str:
+0000c100: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000c110: 2020 2020 2043 6f6e 7665 7274 7320 6120       Converts a 
+0000c120: 6c6f 6361 6c20 7061 7468 2074 6f20 6120  local path to a 
+0000c130: 7061 7468 2072 656c 6174 6976 6520 746f  path relative to
+0000c140: 2074 6865 2044 726f 7062 6f78 2066 6f6c   the Dropbox fol
+0000c150: 6465 722e 2054 6865 2070 6174 6820 7769  der. The path wi
+0000c160: 6c6c 2062 650a 2020 2020 2020 2020 6e6f  ll be.        no
+0000c170: 726d 616c 697a 6564 2061 7320 6f6e 2044  rmalized as on D
+0000c180: 726f 7062 6f78 2073 6572 7665 7273 2028  ropbox servers (
+0000c190: 6c6f 7765 7220 6361 7365 2061 6e64 2073  lower case and s
+0000c1a0: 6f6d 6520 6164 6469 7469 6f6e 616c 0a20  ome additional. 
+0000c1b0: 2020 2020 2020 206e 6f72 6d61 6c69 7361         normalisa
+0000c1c0: 7469 6f6e 7329 2e0a 0a20 2020 2020 2020  tions)...       
+0000c1d0: 203a 7061 7261 6d20 6c6f 6361 6c5f 7061   :param local_pa
+0000c1e0: 7468 3a20 4162 736f 6c75 7465 2070 6174  th: Absolute pat
+0000c1f0: 6820 6f6e 206c 6f63 616c 2064 7269 7665  h on local drive
+0000c200: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+0000c210: 6e73 3a20 5265 6c61 7469 7665 2070 6174  ns: Relative pat
+0000c220: 6820 7769 7468 2072 6573 7065 6374 2074  h with respect t
+0000c230: 6f20 4472 6f70 626f 7820 666f 6c64 6572  o Dropbox folder
+0000c240: 2e0a 2020 2020 2020 2020 3a72 6169 7365  ..        :raise
+0000c250: 7320 5661 6c75 6545 7272 6f72 3a20 5768  s ValueError: Wh
+0000c260: 656e 2074 6865 2070 6174 6820 6c69 6573  en the path lies
+0000c270: 206f 7574 7369 6465 2074 6865 206c 6f63   outside the loc
+0000c280: 616c 2044 726f 7062 6f78 2066 6f6c 6465  al Dropbox folde
+0000c290: 722e 0a20 2020 2020 2020 2022 2222 0a20  r..        """. 
+0000c2a0: 2020 2020 2020 2072 6574 7572 6e20 6e6f         return no
+0000c2b0: 726d 616c 697a 6528 7365 6c66 2e74 6f5f  rmalize(self.to_
+0000c2c0: 6462 785f 7061 7468 286c 6f63 616c 5f70  dbx_path(local_p
+0000c2d0: 6174 6829 290a 0a20 2020 2064 6566 2074  ath))..    def t
+0000c2e0: 6f5f 6c6f 6361 6c5f 7061 7468 5f66 726f  o_local_path_fro
+0000c2f0: 6d5f 6361 7365 6428 7365 6c66 2c20 6462  m_cased(self, db
+0000c300: 785f 7061 7468 5f63 6173 6564 3a20 7374  x_path_cased: st
+0000c310: 7229 202d 3e20 7374 723a 0a20 2020 2020  r) -> str:.     
+0000c320: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
+0000c330: 6f6e 7665 7274 7320 6120 636f 7272 6563  onverts a correc
+0000c340: 746c 7920 6361 7365 6420 4472 6f70 626f  tly cased Dropbo
+0000c350: 7820 7061 7468 2074 6f20 7468 6520 636f  x path to the co
+0000c360: 7272 6573 706f 6e64 696e 6720 6c6f 6361  rresponding loca
+0000c370: 6c20 7061 7468 2e20 5468 6973 2069 730a  l path. This is.
+0000c380: 2020 2020 2020 2020 6d6f 7265 2065 6666          more eff
+0000c390: 6963 6965 6e74 2074 6861 6e20 3a6d 6574  icient than :met
+0000c3a0: 683a 6074 6f5f 6c6f 6361 6c5f 7061 7468  h:`to_local_path
+0000c3b0: 6020 7768 6963 6820 6163 6365 7074 7320  ` which accepts 
+0000c3c0: 756e 6361 7365 6420 7061 7468 732e 0a0a  uncased paths...
+0000c3d0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
+0000c3e0: 6278 5f70 6174 685f 6361 7365 643a 2050  bx_path_cased: P
+0000c3f0: 6174 6820 7265 6c61 7469 7665 2074 6f20  ath relative to 
+0000c400: 4472 6f70 626f 7820 666f 6c64 6572 2c20  Dropbox folder, 
+0000c410: 636f 7272 6563 746c 7920 6361 7365 642e  correctly cased.
+0000c420: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+0000c430: 733a 2043 6f72 7265 7370 6f6e 6469 6e67  s: Corresponding
+0000c440: 206c 6f63 616c 2070 6174 6820 6f6e 2064   local path on d
+0000c450: 7269 7665 2e0a 2020 2020 2020 2020 2222  rive..        ""
+0000c460: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+0000c470: 2066 227b 7365 6c66 2e64 726f 7062 6f78   f"{self.dropbox
+0000c480: 5f70 6174 687d 7b64 6278 5f70 6174 685f  _path}{dbx_path_
+0000c490: 6361 7365 647d 220a 0a20 2020 2064 6566  cased}"..    def
+0000c4a0: 2074 6f5f 6c6f 6361 6c5f 7061 7468 2873   to_local_path(s
+0000c4b0: 656c 662c 2064 6278 5f70 6174 683a 2073  elf, dbx_path: s
+0000c4c0: 7472 2920 2d3e 2073 7472 3a0a 2020 2020  tr) -> str:.    
+0000c4d0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000c4e0: 436f 6e76 6572 7473 2061 2044 726f 7062  Converts a Dropb
+0000c4f0: 6f78 2070 6174 6820 746f 2074 6865 2063  ox path to the c
+0000c500: 6f72 7265 7370 6f6e 6469 6e67 206c 6f63  orresponding loc
+0000c510: 616c 2070 6174 682e 204f 6e6c 7920 7468  al path. Only th
+0000c520: 6520 6261 7365 6e61 6d65 206d 7573 740a  e basename must.
+0000c530: 2020 2020 2020 2020 6265 2063 6f72 7265          be corre
+0000c540: 6374 6c79 2063 6173 6564 2c20 6173 2067  ctly cased, as g
+0000c550: 7561 7261 6e74 6565 6420 6279 2074 6865  uaranteed by the
+0000c560: 2044 726f 7062 6f78 2041 5049 2066 6f72   Dropbox API for
+0000c570: 2074 6865 2060 6064 6973 706c 6179 5f70   the ``display_p
+0000c580: 6174 6860 600a 2020 2020 2020 2020 6174  ath``.        at
+0000c590: 7472 6962 7574 6520 6f66 2066 696c 6520  tribute of file 
+0000c5a0: 6f72 2066 6f6c 6465 7220 6d65 7461 6461  or folder metada
+0000c5b0: 7461 2e0a 0a20 2020 2020 2020 2054 6869  ta...        Thi
+0000c5c0: 7320 6d65 7468 6f64 2073 6c6f 7765 7220  s method slower 
+0000c5d0: 7468 616e 203a 6d65 7468 3a60 746f 5f6c  than :meth:`to_l
+0000c5e0: 6f63 616c 5f70 6174 685f 6672 6f6d 5f63  ocal_path_from_c
+0000c5f0: 6173 6564 602e 0a0a 2020 2020 2020 2020  ased`...        
+0000c600: 3a70 6172 616d 2064 6278 5f70 6174 683a  :param dbx_path:
+0000c610: 2050 6174 6820 7265 6c61 7469 7665 2074   Path relative t
+0000c620: 6f20 4472 6f70 626f 7820 666f 6c64 6572  o Dropbox folder
+0000c630: 2c20 6d75 7374 2062 6520 636f 7272 6563  , must be correc
+0000c640: 746c 7920 6361 7365 6420 696e 2069 7473  tly cased in its
+0000c650: 0a20 2020 2020 2020 2020 2020 2062 6173  .            bas
+0000c660: 656e 616d 652e 0a20 2020 2020 2020 203a  ename..        :
+0000c670: 7265 7475 726e 733a 2043 6f72 7265 7370  returns: Corresp
+0000c680: 6f6e 6469 6e67 206c 6f63 616c 2070 6174  onding local pat
+0000c690: 6820 6f6e 2064 7269 7665 2e0a 2020 2020  h on drive..    
+0000c6a0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000c6b0: 6462 785f 7061 7468 5f63 6173 6564 203d  dbx_path_cased =
+0000c6c0: 2073 656c 662e 636f 7272 6563 745f 6361   self.correct_ca
+0000c6d0: 7365 2864 6278 5f70 6174 6829 0a20 2020  se(dbx_path).   
+0000c6e0: 2020 2020 2072 6574 7572 6e20 6622 7b73       return f"{s
+0000c6f0: 656c 662e 6472 6f70 626f 785f 7061 7468  elf.dropbox_path
+0000c700: 7d7b 6462 785f 7061 7468 5f63 6173 6564  }{dbx_path_cased
+0000c710: 7d22 0a0a 2020 2020 6465 6620 6973 5f65  }"..    def is_e
+0000c720: 7863 6c75 6465 6428 7365 6c66 2c20 7061  xcluded(self, pa
+0000c730: 7468 3a20 7374 7229 202d 3e20 626f 6f6c  th: str) -> bool
+0000c740: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000c750: 2020 2020 2020 4368 6563 6b73 2069 6620        Checks if 
+0000c760: 6120 6669 6c65 2069 7320 6578 636c 7564  a file is exclud
+0000c770: 6564 2066 726f 6d20 7379 6e63 2e20 4365  ed from sync. Ce
+0000c780: 7274 6169 6e20 6669 6c65 206e 616d 6573  rtain file names
+0000c790: 2061 7265 2061 6c77 6179 7320 6578 636c   are always excl
+0000c7a0: 7564 6564 0a20 2020 2020 2020 2066 726f  uded.        fro
+0000c7b0: 6d20 7379 6e63 696e 672c 2066 6f6c 6c6f  m syncing, follo
+0000c7c0: 7769 6e67 2074 6865 2044 726f 7062 6f78  wing the Dropbox
+0000c7d0: 2073 7570 706f 7274 2061 7274 6963 6c65   support article
+0000c7e0: 3a0a 0a20 2020 2020 2020 2068 7474 7073  :..        https
+0000c7f0: 3a2f 2f68 656c 702e 6472 6f70 626f 782e  ://help.dropbox.
+0000c800: 636f 6d2f 696e 7374 616c 6c73 2d69 6e74  com/installs-int
+0000c810: 6567 7261 7469 6f6e 732f 7379 6e63 2d75  egrations/sync-u
+0000c820: 706c 6f61 6473 2f66 696c 6573 2d6e 6f74  ploads/files-not
+0000c830: 2d73 796e 6369 6e67 0a0a 2020 2020 2020  -syncing..      
+0000c840: 2020 5468 6973 2069 6e63 6c75 6465 7320    This includes 
+0000c850: 6669 6c65 2073 7973 7465 6d20 6669 6c65  file system file
+0000c860: 7320 7375 6368 2061 7320 2764 6573 6b74  s such as 'deskt
+0000c870: 6f70 2e69 6e69 2720 616e 6420 272e 4453  op.ini' and '.DS
+0000c880: 5f53 746f 7265 2720 616e 6420 736f 6d65  _Store' and some
+0000c890: 0a20 2020 2020 2020 2074 656d 706f 7261  .        tempora
+0000c8a0: 7279 2066 696c 6573 2061 7320 7765 6c6c  ry files as well
+0000c8b0: 2061 7320 6361 6368 6573 2075 7365 6420   as caches used 
+0000c8c0: 6279 2044 726f 7062 6f78 206f 7220 4d61  by Dropbox or Ma
+0000c8d0: 6573 7472 616c 2e20 6069 735f 6578 636c  estral. `is_excl
+0000c8e0: 7564 6564 600a 2020 2020 2020 2020 6163  uded`.        ac
+0000c8f0: 6365 7074 7320 626f 7468 206c 6f63 616c  cepts both local
+0000c900: 2061 6e64 2044 726f 7062 6f78 2070 6174   and Dropbox pat
+0000c910: 6873 2e0a 0a20 2020 2020 2020 203a 7061  hs...        :pa
+0000c920: 7261 6d20 7061 7468 3a20 4361 6e20 6265  ram path: Can be
+0000c930: 2061 6e20 6162 736f 6c75 7465 2070 6174   an absolute pat
+0000c940: 682c 2061 2070 6174 6820 7265 6c61 7469  h, a path relati
+0000c950: 7665 2074 6f20 7468 6520 4472 6f70 626f  ve to the Dropbo
+0000c960: 7820 666f 6c64 6572 206f 720a 2020 2020  x folder or.    
+0000c970: 2020 2020 2020 2020 6a75 7374 2061 2066          just a f
+0000c980: 696c 6520 6e61 6d65 2e20 446f 6573 206e  ile name. Does n
+0000c990: 6f74 206e 6565 6420 746f 2062 6520 6e6f  ot need to be no
+0000c9a0: 726d 616c 697a 6564 2e0a 2020 2020 2020  rmalized..      
+0000c9b0: 2020 3a72 6574 7572 6e73 3a20 5768 6574    :returns: Whet
+0000c9c0: 6865 7220 7468 6520 7061 7468 2069 7320  her the path is 
+0000c9d0: 6578 636c 7564 6564 2066 726f 6d20 7379  excluded from sy
+0000c9e0: 6e63 696e 672e 0a20 2020 2020 2020 2022  ncing..        "
+0000c9f0: 2222 0a20 2020 2020 2020 2064 6972 6e61  "".        dirna
+0000ca00: 6d65 2c20 6261 7365 6e61 6d65 203d 206f  me, basename = o
+0000ca10: 7370 2e73 706c 6974 2870 6174 6829 0a0a  sp.split(path)..
+0000ca20: 2020 2020 2020 2020 2320 4973 2069 6e20          # Is in 
+0000ca30: 6578 636c 7564 6564 2066 696c 6573 3f0a  excluded files?.
+0000ca40: 2020 2020 2020 2020 6966 2062 6173 656e          if basen
+0000ca50: 616d 6520 696e 2045 5843 4c55 4445 445f  ame in EXCLUDED_
+0000ca60: 4649 4c45 5f4e 414d 4553 3a0a 2020 2020  FILE_NAMES:.    
+0000ca70: 2020 2020 2020 2020 7265 7475 726e 2054          return T
+0000ca80: 7275 650a 0a20 2020 2020 2020 2023 2049  rue..        # I
+0000ca90: 7320 696e 2065 7863 6c75 6465 6420 6469  s in excluded di
+0000caa0: 7273 3f0a 2020 2020 2020 2020 7472 793a  rs?.        try:
+0000cab0: 0a20 2020 2020 2020 2020 2020 2064 6278  .            dbx
+0000cac0: 5f64 6972 6e61 6d65 203d 2073 656c 662e  _dirname = self.
+0000cad0: 746f 5f64 6278 5f70 6174 6828 6469 726e  to_dbx_path(dirn
+0000cae0: 616d 6529 0a20 2020 2020 2020 2065 7863  ame).        exc
+0000caf0: 6570 7420 5661 6c75 6545 7272 6f72 3a0a  ept ValueError:.
+0000cb00: 2020 2020 2020 2020 2020 2020 2320 5061              # Pa
+0000cb10: 7468 2069 7320 616c 7265 6164 7920 7265  th is already re
+0000cb20: 6c61 7469 7665 2074 6f20 4472 6f70 626f  lative to Dropbo
+0000cb30: 782e 0a20 2020 2020 2020 2020 2020 2064  x..            d
+0000cb40: 6278 5f64 6972 6e61 6d65 203d 2064 6972  bx_dirname = dir
+0000cb50: 6e61 6d65 0a0a 2020 2020 2020 2020 726f  name..        ro
+0000cb60: 6f74 5f64 6972 203d 206e 6578 7428 6974  ot_dir = next(it
+0000cb70: 6572 2870 6172 7420 666f 7220 7061 7274  er(part for part
+0000cb80: 2069 6e20 6462 785f 6469 726e 616d 652e   in dbx_dirname.
+0000cb90: 7370 6c69 7428 222f 222c 2032 2920 6966  split("/", 2) if
+0000cba0: 2070 6172 7429 2c20 2222 290a 0a20 2020   part), "")..   
+0000cbb0: 2020 2020 2069 6620 726f 6f74 5f64 6972       if root_dir
+0000cbc0: 2069 6e20 4558 434c 5544 4544 5f44 4952   in EXCLUDED_DIR
+0000cbd0: 5f4e 414d 4553 3a0a 2020 2020 2020 2020  _NAMES:.        
+0000cbe0: 2020 2020 7265 7475 726e 2054 7275 650a      return True.
+0000cbf0: 0a20 2020 2020 2020 2023 2049 7320 7465  .        # Is te
+0000cc00: 6d70 6f72 6172 7920 6669 6c65 3f0a 2020  mporary file?.  
+0000cc10: 2020 2020 2020 6966 2022 7e22 2069 6e20        if "~" in 
+0000cc20: 6261 7365 6e61 6d65 3a0a 2020 2020 2020  basename:.      
+0000cc30: 2020 2020 2020 2320 3129 204f 6666 6963        # 1) Offic
+0000cc40: 6520 7465 6d70 6f72 6172 7920 6669 6c65  e temporary file
+0000cc50: 730a 2020 2020 2020 2020 2020 2020 6966  s.            if
+0000cc60: 2062 6173 656e 616d 652e 7374 6172 7473   basename.starts
+0000cc70: 7769 7468 2822 7e24 2229 3a0a 2020 2020  with("~$"):.    
+0000cc80: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000cc90: 726e 2054 7275 650a 2020 2020 2020 2020  rn True.        
+0000cca0: 2020 2020 6966 2062 6173 656e 616d 652e      if basename.
+0000ccb0: 7374 6172 7473 7769 7468 2822 2e7e 2229  startswith(".~")
+0000ccc0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000ccd0: 2020 7265 7475 726e 2054 7275 650a 2020    return True.  
+0000cce0: 2020 2020 2020 2020 2020 2320 3229 204f            # 2) O
+0000ccf0: 7468 6572 2074 656d 706f 7261 7279 2066  ther temporary f
+0000cd00: 696c 6573 0a20 2020 2020 2020 2020 2020  iles.           
+0000cd10: 2069 6620 6261 7365 6e61 6d65 2e73 7461   if basename.sta
+0000cd20: 7274 7377 6974 6828 227e 2229 2061 6e64  rtswith("~") and
+0000cd30: 2062 6173 656e 616d 652e 656e 6473 7769   basename.endswi
+0000cd40: 7468 2822 2e74 6d70 2229 3a0a 2020 2020  th(".tmp"):.    
+0000cd50: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0000cd60: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+0000cd70: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
+0000cd80: 2020 2064 6566 2069 735f 6578 636c 7564     def is_exclud
+0000cd90: 6564 5f62 795f 7573 6572 2873 656c 662c  ed_by_user(self,
+0000cda0: 2064 6278 5f70 6174 685f 6c6f 7765 723a   dbx_path_lower:
+0000cdb0: 2073 7472 2920 2d3e 2062 6f6f 6c3a 0a20   str) -> bool:. 
+0000cdc0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000cdd0: 2020 2043 6865 636b 2069 6620 6669 6c65     Check if file
 0000cde0: 2068 6173 2062 6565 6e20 6578 636c 7564   has been exclud
-0000cdf0: 6564 2062 7920 6120 6d69 676e 6f72 6520  ed by a mignore 
-0000ce00: 7061 7474 6572 6e2e 0a0a 2020 2020 2020  pattern...      
-0000ce10: 2020 3a70 6172 616d 2065 7665 6e74 3a20    :param event: 
-0000ce20: 5379 6e63 4576 656e 7420 666f 7220 6c6f  SyncEvent for lo
-0000ce30: 6361 6c20 6669 6c65 2065 7665 6e74 2e0a  cal file event..
-0000ce40: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-0000ce50: 3a20 5768 6574 6865 7220 7468 6520 7061  : Whether the pa
-0000ce60: 7468 2069 7320 6578 636c 7564 6564 2066  th is excluded f
-0000ce70: 726f 6d20 7570 6c6f 6164 2073 796e 6369  rom upload synci
-0000ce80: 6e67 2062 7920 7468 6520 7573 6572 2e0a  ng by the user..
-0000ce90: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000cea0: 2020 2020 6966 206c 656e 2873 656c 662e      if len(self.
-0000ceb0: 6d69 676e 6f72 655f 7275 6c65 732e 7061  mignore_rules.pa
-0000cec0: 7474 6572 6e73 2920 3d3d 2030 3a0a 2020  tterns) == 0:.  
-0000ced0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0000cee0: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0000cef0: 7265 7475 726e 2073 656c 662e 5f69 735f  return self._is_
-0000cf00: 6d69 676e 6f72 655f 7061 7468 280a 2020  mignore_path(.  
-0000cf10: 2020 2020 2020 2020 2020 6576 656e 742e            event.
-0000cf20: 6462 785f 7061 7468 2c20 6973 5f64 6972  dbx_path, is_dir
-0000cf30: 3d65 7665 6e74 2e69 735f 6469 7265 6374  =event.is_direct
-0000cf40: 6f72 790a 2020 2020 2020 2020 2920 616e  ory.        ) an
-0000cf50: 6420 6e6f 7420 7365 6c66 2e67 6574 5f6c  d not self.get_l
-0000cf60: 6f63 616c 5f72 6576 2865 7665 6e74 2e64  ocal_rev(event.d
-0000cf70: 6278 5f70 6174 685f 6c6f 7765 7229 0a0a  bx_path_lower)..
-0000cf80: 2020 2020 6465 6620 5f69 735f 6d69 676e      def _is_mign
-0000cf90: 6f72 655f 7061 7468 2873 656c 662c 2064  ore_path(self, d
-0000cfa0: 6278 5f70 6174 683a 2073 7472 2c20 6973  bx_path: str, is
-0000cfb0: 5f64 6972 3a20 626f 6f6c 203d 2046 616c  _dir: bool = Fal
-0000cfc0: 7365 2920 2d3e 2062 6f6f 6c3a 0a20 2020  se) -> bool:.   
-0000cfd0: 2020 2020 2072 656c 6174 6976 655f 7061       relative_pa
-0000cfe0: 7468 203d 2064 6278 5f70 6174 682e 6c73  th = dbx_path.ls
-0000cff0: 7472 6970 2822 2f22 290a 0a20 2020 2020  trip("/")..     
-0000d000: 2020 2069 6620 6973 5f64 6972 3a0a 2020     if is_dir:.  
-0000d010: 2020 2020 2020 2020 2020 7265 6c61 7469            relati
-0000d020: 7665 5f70 6174 6820 3d20 6622 7b72 656c  ve_path = f"{rel
-0000d030: 6174 6976 655f 7061 7468 7d2f 220a 2020  ative_path}/".  
-0000d040: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
-0000d050: 662e 6d69 676e 6f72 655f 7275 6c65 732e  f.mignore_rules.
-0000d060: 6d61 7463 685f 6669 6c65 2872 656c 6174  match_file(relat
-0000d070: 6976 655f 7061 7468 290a 0a20 2020 2064  ive_path)..    d
-0000d080: 6566 205f 736c 6f77 5f64 6f77 6e28 7365  ef _slow_down(se
-0000d090: 6c66 2920 2d3e 204e 6f6e 653a 0a20 2020  lf) -> None:.   
-0000d0a0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0000d0b0: 2050 6175 7365 7320 6966 2043 5055 2075   Pauses if CPU u
-0000d0c0: 7361 6765 2069 7320 746f 6f20 6869 6768  sage is too high
-0000d0d0: 2069 6620 6361 6c6c 6564 2066 726f 6d20   if called from 
-0000d0e0: 6f6e 6520 6f66 206f 7572 2074 6872 6561  one of our threa
-0000d0f0: 6420 706f 6f6c 732e 0a20 2020 2020 2020  d pools..       
-0000d100: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
-0000d110: 7365 6c66 2e5f 6d61 785f 6370 755f 7065  self._max_cpu_pe
-0000d120: 7263 656e 7420 3d3d 2031 3030 202a 2043  rcent == 100 * C
-0000d130: 5055 5f43 4f52 455f 434f 554e 543a 0a20  PU_CORE_COUNT:. 
-0000d140: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-0000d150: 6e0a 0a20 2020 2020 2020 2063 7075 5f75  n..        cpu_u
-0000d160: 7361 6765 203d 2063 7075 5f75 7361 6765  sage = cpu_usage
-0000d170: 5f70 6572 6365 6e74 2829 0a0a 2020 2020  _percent()..    
-0000d180: 2020 2020 6966 2063 7075 5f75 7361 6765      if cpu_usage
-0000d190: 203e 2073 656c 662e 5f6d 6178 5f63 7075   > self._max_cpu
-0000d1a0: 5f70 6572 6365 6e74 3a0a 2020 2020 2020  _percent:.      
-0000d1b0: 2020 2020 2020 7468 7265 6164 5f6e 616d        thread_nam
-0000d1c0: 6520 3d20 6375 7272 656e 745f 7468 7265  e = current_thre
-0000d1d0: 6164 2829 2e6e 616d 650a 2020 2020 2020  ad().name.      
-0000d1e0: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-0000d1f0: 6572 2e64 6562 7567 2866 227b 7468 7265  er.debug(f"{thre
-0000d200: 6164 5f6e 616d 657d 3a20 7b63 7075 5f75  ad_name}: {cpu_u
-0000d210: 7361 6765 7d25 2043 5055 2075 7361 6765  sage}% CPU usage
-0000d220: 202d 2074 6872 6f74 746c 696e 6722 290a   - throttling").
-0000d230: 0a20 2020 2020 2020 2020 2020 2077 6869  .            whi
-0000d240: 6c65 2063 7075 5f75 7361 6765 203e 2073  le cpu_usage > s
-0000d250: 656c 662e 5f6d 6178 5f63 7075 5f70 6572  elf._max_cpu_per
-0000d260: 6365 6e74 3a0a 2020 2020 2020 2020 2020  cent:.          
-0000d270: 2020 2020 2020 6370 755f 7573 6167 6520        cpu_usage 
-0000d280: 3d20 6370 755f 7573 6167 655f 7065 7263  = cpu_usage_perc
-0000d290: 656e 7428 302e 3520 2b20 3220 2a20 7261  ent(0.5 + 2 * ra
-0000d2a0: 6e64 6f6d 2e72 616e 646f 6d28 2929 0a0a  ndom.random())..
-0000d2b0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000d2c0: 2e5f 6c6f 6767 6572 2e64 6562 7567 280a  ._logger.debug(.
-0000d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d2e0: 6622 7b74 6872 6561 645f 6e61 6d65 7d3a  f"{thread_name}:
-0000d2f0: 207b 6370 755f 7573 6167 657d 2520 4350   {cpu_usage}% CP
-0000d300: 5520 7573 6167 6520 2d20 656e 6420 7468  U usage - end th
-0000d310: 726f 7474 6c69 6e67 220a 2020 2020 2020  rottling".      
-0000d320: 2020 2020 2020 290a 0a20 2020 2064 6566        )..    def
-0000d330: 2063 616e 6365 6c5f 7379 6e63 2873 656c   cancel_sync(sel
-0000d340: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
-0000d350: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000d360: 5261 6973 6573 2061 203a 6578 633a 606d  Raises a :exc:`m
-0000d370: 6165 7374 7261 6c2e 6578 6365 7074 696f  aestral.exceptio
-0000d380: 6e73 2e43 616e 6365 6c6c 6564 4572 726f  ns.CancelledErro
-0000d390: 7260 2069 6e20 616c 6c20 7379 6e63 2074  r` in all sync t
-0000d3a0: 6872 6561 6473 2061 6e64 2077 6169 7473  hreads and waits
-0000d3b0: 0a20 2020 2020 2020 2066 6f72 2074 6865  .        for the
-0000d3c0: 6d20 746f 2073 6875 7420 646f 776e 2e0a  m to shut down..
-0000d3d0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000d3e0: 2020 2020 7365 6c66 2e5f 6361 6e63 656c      self._cancel
-0000d3f0: 5f72 6571 7565 7374 6564 2e73 6574 2829  _requested.set()
-0000d400: 0a0a 2020 2020 2020 2020 2320 5761 6974  ..        # Wait
-0000d410: 2075 6e74 696c 2077 6520 6361 6e20 6163   until we can ac
-0000d420: 7175 6972 6520 7468 6520 7379 6e63 206c  quire the sync l
-0000d430: 6f63 6b20 3d3e 2077 6520 6172 6520 6964  ock => we are id
-0000d440: 6c65 2e0a 2020 2020 2020 2020 7365 6c66  le..        self
-0000d450: 2e73 796e 635f 6c6f 636b 2e61 6371 7569  .sync_lock.acqui
-0000d460: 7265 2829 0a20 2020 2020 2020 2073 656c  re().        sel
-0000d470: 662e 7379 6e63 5f6c 6f63 6b2e 7265 6c65  f.sync_lock.rele
-0000d480: 6173 6528 290a 0a20 2020 2020 2020 2073  ase()..        s
-0000d490: 656c 662e 5f63 616e 6365 6c5f 7265 7175  elf._cancel_requ
-0000d4a0: 6573 7465 642e 636c 6561 7228 290a 0a20  ested.clear().. 
-0000d4b0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-0000d4c0: 6765 722e 696e 666f 2822 5379 6e63 2061  ger.info("Sync a
-0000d4d0: 626f 7274 6564 2229 0a0a 2020 2020 6465  borted")..    de
-0000d4e0: 6620 6275 7379 2873 656c 6629 202d 3e20  f busy(self) -> 
-0000d4f0: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
-0000d500: 220a 2020 2020 2020 2020 4368 6563 6b73  ".        Checks
-0000d510: 2069 6620 7765 2061 7265 2063 7572 7265   if we are curre
-0000d520: 6e74 6c79 2073 796e 6369 6e67 2e0a 0a20  ntly syncing... 
-0000d530: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0000d540: 2060 6054 7275 6560 6020 6966 203a 6174   ``True`` if :at
-0000d550: 7472 3a60 7379 6e63 5f6c 6f63 6b60 2063  tr:`sync_lock` c
-0000d560: 616e 6e6f 7420 6265 2061 6371 7569 7265  annot be acquire
-0000d570: 642c 2060 6046 616c 7365 6060 206f 7468  d, ``False`` oth
-0000d580: 6572 7769 7365 2e0a 2020 2020 2020 2020  erwise..        
-0000d590: 2222 220a 2020 2020 2020 2020 6964 6c65  """.        idle
-0000d5a0: 203d 2073 656c 662e 7379 6e63 5f6c 6f63   = self.sync_loc
-0000d5b0: 6b2e 6163 7175 6972 6528 626c 6f63 6b69  k.acquire(blocki
-0000d5c0: 6e67 3d46 616c 7365 290a 2020 2020 2020  ng=False).      
-0000d5d0: 2020 6966 2069 646c 653a 0a20 2020 2020    if idle:.     
-0000d5e0: 2020 2020 2020 2073 656c 662e 7379 6e63         self.sync
-0000d5f0: 5f6c 6f63 6b2e 7265 6c65 6173 6528 290a  _lock.release().
-0000d600: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-0000d610: 6e6f 7420 6964 6c65 0a0a 2020 2020 6465  not idle..    de
-0000d620: 6620 5f68 616e 646c 655f 7379 6e63 5f65  f _handle_sync_e
-0000d630: 7272 6f72 2873 656c 662c 2065 7272 3a20  rror(self, err: 
-0000d640: 5379 6e63 4572 726f 722c 2064 6972 6563  SyncError, direc
-0000d650: 7469 6f6e 3a20 5379 6e63 4469 7265 6374  tion: SyncDirect
-0000d660: 696f 6e29 202d 3e20 4e6f 6e65 3a0a 2020  ion) -> None:.  
-0000d670: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0000d680: 2020 4861 6e64 6c65 7320 6120 7379 6e63    Handles a sync
-0000d690: 2065 7272 6f72 2e20 4669 6c6c 7320 6f75   error. Fills ou
-0000d6a0: 7420 616e 7920 6d69 7373 696e 6720 7061  t any missing pa
-0000d6b0: 7468 2069 6e66 6f72 6d61 7469 6f6e 2061  th information a
-0000d6c0: 6e64 2061 6464 7320 7468 6520 6572 726f  nd adds the erro
-0000d6d0: 720a 2020 2020 2020 2020 746f 2074 6865  r.        to the
-0000d6e0: 2070 6572 7369 7374 656e 7420 7374 6174   persistent stat
-0000d6f0: 6520 666f 7220 6c61 7465 7220 7265 7379  e for later resy
-0000d700: 6e63 2e0a 0a20 2020 2020 2020 203a 7061  nc...        :pa
-0000d710: 7261 6d20 6572 723a 2054 6865 2073 796e  ram err: The syn
-0000d720: 6320 6572 726f 7220 746f 2068 616e 646c  c error to handl
-0000d730: 652e 0a20 2020 2020 2020 203a 7061 7261  e..        :para
-0000d740: 6d20 6469 7265 6374 696f 6e3a 2054 6865  m direction: The
-0000d750: 2073 796e 6320 6469 7265 6374 696f 6e20   sync direction 
-0000d760: 2875 7020 6f72 2064 6f77 6e29 2066 6f72  (up or down) for
-0000d770: 2077 6869 6368 2074 6865 2065 7272 6f72   which the error
-0000d780: 206f 6363 7572 7265 642e 0a20 2020 2020   occurred..     
-0000d790: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-0000d7a0: 2046 696c 6c20 696e 206d 6973 7369 6e67   Fill in missing
-0000d7b0: 2064 6278 5f70 6174 6820 6f72 206c 6f63   dbx_path or loc
-0000d7c0: 616c 5f70 6174 682e 0a20 2020 2020 2020  al_path..       
-0000d7d0: 2069 6620 6572 722e 6462 785f 7061 7468   if err.dbx_path
-0000d7e0: 2061 6e64 206e 6f74 2065 7272 2e6c 6f63   and not err.loc
-0000d7f0: 616c 5f70 6174 683a 0a20 2020 2020 2020  al_path:.       
-0000d800: 2020 2020 2065 7272 2e6c 6f63 616c 5f70       err.local_p
-0000d810: 6174 6820 3d20 7365 6c66 2e74 6f5f 6c6f  ath = self.to_lo
-0000d820: 6361 6c5f 7061 7468 5f66 726f 6d5f 6361  cal_path_from_ca
-0000d830: 7365 6428 6572 722e 6462 785f 7061 7468  sed(err.dbx_path
-0000d840: 290a 2020 2020 2020 2020 6966 2065 7272  ).        if err
-0000d850: 2e6c 6f63 616c 5f70 6174 6820 616e 6420  .local_path and 
-0000d860: 6e6f 7420 6572 722e 6462 785f 7061 7468  not err.dbx_path
-0000d870: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
-0000d880: 722e 6462 785f 7061 7468 203d 2073 656c  r.dbx_path = sel
-0000d890: 662e 746f 5f64 6278 5f70 6174 6828 6572  f.to_dbx_path(er
-0000d8a0: 722e 6c6f 6361 6c5f 7061 7468 290a 0a20  r.local_path).. 
-0000d8b0: 2020 2020 2020 2023 2046 696c 6c20 696e         # Fill in
-0000d8c0: 206d 6973 7369 6e67 2064 6278 5f70 6174   missing dbx_pat
-0000d8d0: 685f 6672 6f6d 206f 7220 6c6f 6361 6c5f  h_from or local_
-0000d8e0: 7061 7468 5f66 726f 6d2e 0a20 2020 2020  path_from..     
-0000d8f0: 2020 2069 6620 6572 722e 6462 785f 7061     if err.dbx_pa
-0000d900: 7468 5f66 726f 6d20 616e 6420 6e6f 7420  th_from and not 
-0000d910: 6572 722e 6c6f 6361 6c5f 7061 7468 5f66  err.local_path_f
-0000d920: 726f 6d3a 0a20 2020 2020 2020 2020 2020  rom:.           
-0000d930: 2065 7272 2e6c 6f63 616c 5f70 6174 685f   err.local_path_
-0000d940: 6672 6f6d 203d 2073 656c 662e 746f 5f6c  from = self.to_l
-0000d950: 6f63 616c 5f70 6174 685f 6672 6f6d 5f63  ocal_path_from_c
-0000d960: 6173 6564 2865 7272 2e64 6278 5f70 6174  ased(err.dbx_pat
-0000d970: 685f 6672 6f6d 290a 2020 2020 2020 2020  h_from).        
-0000d980: 6966 2065 7272 2e6c 6f63 616c 5f70 6174  if err.local_pat
-0000d990: 685f 6672 6f6d 2061 6e64 206e 6f74 2065  h_from and not e
-0000d9a0: 7272 2e64 6278 5f70 6174 685f 6672 6f6d  rr.dbx_path_from
-0000d9b0: 3a0a 2020 2020 2020 2020 2020 2020 6572  :.            er
-0000d9c0: 722e 6462 785f 7061 7468 5f66 726f 6d20  r.dbx_path_from 
-0000d9d0: 3d20 7365 6c66 2e74 6f5f 6462 785f 7061  = self.to_dbx_pa
-0000d9e0: 7468 2865 7272 2e6c 6f63 616c 5f70 6174  th(err.local_pat
-0000d9f0: 685f 6672 6f6d 290a 0a20 2020 2020 2020  h_from)..       
-0000da00: 2069 6620 6e6f 7420 6572 722e 6462 785f   if not err.dbx_
-0000da10: 7061 7468 3a0a 2020 2020 2020 2020 2020  path:.          
-0000da20: 2020 7261 6973 6520 5661 6c75 6545 7272    raise ValueErr
-0000da30: 6f72 2822 5379 6e63 2065 7272 6f72 2068  or("Sync error h
-0000da40: 6173 2061 6e20 756e 6b6e 6f77 6e20 7061  as an unknown pa
-0000da50: 7468 2229 0a0a 2020 2020 2020 2020 7072  th")..        pr
-0000da60: 696e 7461 626c 655f 6669 6c65 5f6e 616d  intable_file_nam
-0000da70: 6520 3d20 7361 6e69 7469 7a65 5f73 7472  e = sanitize_str
-0000da80: 696e 6728 6f73 702e 6261 7365 6e61 6d65  ing(osp.basename
-0000da90: 2865 7272 2e64 6278 5f70 6174 6829 290a  (err.dbx_path)).
-0000daa0: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
-0000dab0: 6f67 6765 722e 696e 666f 2822 436f 756c  ogger.info("Coul
-0000dac0: 6420 6e6f 7420 7379 6e63 2025 7322 2c20  d not sync %s", 
-0000dad0: 7072 696e 7461 626c 655f 6669 6c65 5f6e  printable_file_n
-0000dae0: 616d 652c 2065 7863 5f69 6e66 6f3d 5472  ame, exc_info=Tr
-0000daf0: 7565 290a 0a20 2020 2020 2020 2064 6566  ue)..        def
-0000db00: 2063 616c 6c62 6163 6b28 2920 2d3e 204e   callback() -> N
-0000db10: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0000db20: 2069 6620 6572 722e 6c6f 6361 6c5f 7061   if err.local_pa
-0000db30: 7468 3a0a 2020 2020 2020 2020 2020 2020  th:.            
-0000db40: 2020 2020 636c 6963 6b2e 6c61 756e 6368      click.launch
-0000db50: 2865 7272 2e6c 6f63 616c 5f70 6174 682c  (err.local_path,
-0000db60: 206c 6f63 6174 653d 5472 7565 290a 2020   locate=True).  
-0000db70: 2020 2020 2020 2020 2020 656c 6966 2065            elif e
-0000db80: 7272 2e64 6278 5f70 6174 683a 0a20 2020  rr.dbx_path:.   
-0000db90: 2020 2020 2020 2020 2020 2020 2075 726c               url
-0000dba0: 5f70 6174 6820 3d20 7572 6c6c 6962 2e70  _path = urllib.p
-0000dbb0: 6172 7365 2e71 756f 7465 2865 7272 2e64  arse.quote(err.d
-0000dbc0: 6278 5f70 6174 6829 0a20 2020 2020 2020  bx_path).       
-0000dbd0: 2020 2020 2020 2020 2063 6c69 636b 2e6c           click.l
-0000dbe0: 6175 6e63 6828 6622 6874 7470 733a 2f2f  aunch(f"https://
-0000dbf0: 7777 772e 6472 6f70 626f 782e 636f 6d2f  www.dropbox.com/
-0000dc00: 7072 6576 6965 777b 7572 6c5f 7061 7468  preview{url_path
-0000dc10: 7d22 290a 0a20 2020 2020 2020 2069 6620  }")..        if 
-0000dc20: 7365 6c66 2e64 6573 6b74 6f70 5f6e 6f74  self.desktop_not
-0000dc30: 6966 6965 723a 0a20 2020 2020 2020 2020  ifier:.         
-0000dc40: 2020 2073 656c 662e 6465 736b 746f 705f     self.desktop_
-0000dc50: 6e6f 7469 6669 6572 2e6e 6f74 6966 7928  notifier.notify(
-0000dc60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dc70: 2022 5379 6e63 2065 7272 6f72 222c 0a20   "Sync error",. 
-0000dc80: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-0000dc90: 2243 6f75 6c64 206e 6f74 207b 6469 7265  "Could not {dire
-0000dca0: 6374 696f 6e2e 7661 6c75 657d 6c6f 6164  ction.value}load
-0000dcb0: 207b 7072 696e 7461 626c 655f 6669 6c65   {printable_file
-0000dcc0: 5f6e 616d 657d 222c 0a20 2020 2020 2020  _name}",.       
-0000dcd0: 2020 2020 2020 2020 206c 6576 656c 3d6e           level=n
-0000dce0: 6f74 6966 792e 5359 4e43 4953 5355 452c  otify.SYNCISSUE,
-0000dcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dd00: 2061 6374 696f 6e73 3d7b 2253 686f 7722   actions={"Show"
-0000dd10: 3a20 6361 6c6c 6261 636b 7d2c 0a20 2020  : callback},.   
-0000dd20: 2020 2020 2020 2020 2020 2020 206f 6e5f               on_
-0000dd30: 636c 6963 6b3d 6361 6c6c 6261 636b 2c0a  click=callback,.
-0000dd40: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
-0000dd50: 2020 2020 2020 2023 2053 6176 6520 7379         # Save sy
-0000dd60: 6e63 2065 7272 6f72 7320 746f 2072 6574  nc errors to ret
-0000dd70: 7279 206c 6174 6572 2e0a 0a20 2020 2020  ry later...     
-0000dd80: 2020 2064 6278 5f70 6174 685f 6c6f 7765     dbx_path_lowe
-0000dd90: 7220 3d20 6e6f 726d 616c 697a 6528 6572  r = normalize(er
-0000dda0: 722e 6462 785f 7061 7468 290a 2020 2020  r.dbx_path).    
-0000ddb0: 2020 2020 6966 2065 7272 2e64 6278 5f70      if err.dbx_p
-0000ddc0: 6174 685f 6672 6f6d 3a0a 2020 2020 2020  ath_from:.      
-0000ddd0: 2020 2020 2020 6462 785f 7061 7468 5f66        dbx_path_f
-0000dde0: 726f 6d5f 6c6f 7765 7220 3d20 6e6f 726d  rom_lower = norm
-0000ddf0: 616c 697a 6528 6572 722e 6462 785f 7061  alize(err.dbx_pa
-0000de00: 7468 5f66 726f 6d29 0a20 2020 2020 2020  th_from).       
-0000de10: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000de20: 2020 2064 6278 5f70 6174 685f 6672 6f6d     dbx_path_from
-0000de30: 5f6c 6f77 6572 203d 204e 6f6e 650a 0a20  _lower = None.. 
-0000de40: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
-0000de50: 2e5f 6461 7461 6261 7365 5f61 6363 6573  ._database_acces
-0000de60: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-0000de70: 2073 656c 662e 5f73 796e 635f 6572 726f   self._sync_erro
-0000de80: 7273 5f74 6162 6c65 2e75 7064 6174 6528  rs_table.update(
-0000de90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dea0: 2053 796e 6345 7272 6f72 456e 7472 7928   SyncErrorEntry(
+0000cdf0: 6564 2074 6872 6f75 6768 2022 7365 6c65  ed through "sele
+0000ce00: 6374 6976 6520 7379 6e63 2220 6279 2074  ctive sync" by t
+0000ce10: 6865 2075 7365 722e 0a0a 2020 2020 2020  he user...      
+0000ce20: 2020 3a70 6172 616d 2064 6278 5f70 6174    :param dbx_pat
+0000ce30: 685f 6c6f 7765 723a 204e 6f72 6d61 6c69  h_lower: Normali
+0000ce40: 7365 6420 6c6f 7765 7220 6361 7365 2044  sed lower case D
+0000ce50: 726f 7062 6f78 2070 6174 682e 0a20 2020  ropbox path..   
+0000ce60: 2020 2020 203a 7265 7475 726e 733a 2057       :returns: W
+0000ce70: 6865 7468 6572 2074 6865 2070 6174 6820  hether the path 
+0000ce80: 6973 2065 7863 6c75 6465 6420 6672 6f6d  is excluded from
+0000ce90: 2064 6f77 6e6c 6f61 6420 7379 6e63 696e   download syncin
+0000cea0: 6720 6279 2074 6865 2075 7365 722e 0a20  g by the user.. 
+0000ceb0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000cec0: 2020 2072 6574 7572 6e20 616e 7928 6973     return any(is
+0000ced0: 5f65 7175 616c 5f6f 725f 6368 696c 6428  _equal_or_child(
+0000cee0: 6462 785f 7061 7468 5f6c 6f77 6572 2c20  dbx_path_lower, 
+0000cef0: 7029 2066 6f72 2070 2069 6e20 7365 6c66  p) for p in self
+0000cf00: 2e65 7863 6c75 6465 645f 6974 656d 7329  .excluded_items)
+0000cf10: 0a0a 2020 2020 6465 6620 6973 5f6d 6967  ..    def is_mig
+0000cf20: 6e6f 7265 2873 656c 662c 2065 7665 6e74  nore(self, event
+0000cf30: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
+0000cf40: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
+0000cf50: 220a 2020 2020 2020 2020 4368 6563 6b20  ".        Check 
+0000cf60: 6966 206c 6f63 616c 2066 696c 6520 6368  if local file ch
+0000cf70: 616e 6765 2068 6173 2062 6565 6e20 6578  ange has been ex
+0000cf80: 636c 7564 6564 2062 7920 6120 6d69 676e  cluded by a mign
+0000cf90: 6f72 6520 7061 7474 6572 6e2e 0a0a 2020  ore pattern...  
+0000cfa0: 2020 2020 2020 3a70 6172 616d 2065 7665        :param eve
+0000cfb0: 6e74 3a20 5379 6e63 4576 656e 7420 666f  nt: SyncEvent fo
+0000cfc0: 7220 6c6f 6361 6c20 6669 6c65 2065 7665  r local file eve
+0000cfd0: 6e74 2e0a 2020 2020 2020 2020 3a72 6574  nt..        :ret
+0000cfe0: 7572 6e73 3a20 5768 6574 6865 7220 7468  urns: Whether th
+0000cff0: 6520 7061 7468 2069 7320 6578 636c 7564  e path is exclud
+0000d000: 6564 2066 726f 6d20 7570 6c6f 6164 2073  ed from upload s
+0000d010: 796e 6369 6e67 2062 7920 7468 6520 7573  yncing by the us
+0000d020: 6572 2e0a 2020 2020 2020 2020 2222 220a  er..        """.
+0000d030: 2020 2020 2020 2020 6966 206c 656e 2873          if len(s
+0000d040: 656c 662e 6d69 676e 6f72 655f 7275 6c65  elf.mignore_rule
+0000d050: 732e 7061 7474 6572 6e73 2920 3d3d 2030  s.patterns) == 0
+0000d060: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000d070: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+0000d080: 2020 2020 7265 7475 726e 2073 656c 662e      return self.
+0000d090: 5f69 735f 6d69 676e 6f72 655f 7061 7468  _is_mignore_path
+0000d0a0: 280a 2020 2020 2020 2020 2020 2020 6576  (.            ev
+0000d0b0: 656e 742e 6462 785f 7061 7468 2c20 6973  ent.dbx_path, is
+0000d0c0: 5f64 6972 3d65 7665 6e74 2e69 735f 6469  _dir=event.is_di
+0000d0d0: 7265 6374 6f72 790a 2020 2020 2020 2020  rectory.        
+0000d0e0: 2920 616e 6420 6e6f 7420 7365 6c66 2e67  ) and not self.g
+0000d0f0: 6574 5f6c 6f63 616c 5f72 6576 2865 7665  et_local_rev(eve
+0000d100: 6e74 2e64 6278 5f70 6174 685f 6c6f 7765  nt.dbx_path_lowe
+0000d110: 7229 0a0a 2020 2020 6465 6620 5f69 735f  r)..    def _is_
+0000d120: 6d69 676e 6f72 655f 7061 7468 2873 656c  mignore_path(sel
+0000d130: 662c 2064 6278 5f70 6174 683a 2073 7472  f, dbx_path: str
+0000d140: 2c20 6973 5f64 6972 3a20 626f 6f6c 203d  , is_dir: bool =
+0000d150: 2046 616c 7365 2920 2d3e 2062 6f6f 6c3a   False) -> bool:
+0000d160: 0a20 2020 2020 2020 2072 656c 6174 6976  .        relativ
+0000d170: 655f 7061 7468 203d 2064 6278 5f70 6174  e_path = dbx_pat
+0000d180: 682e 6c73 7472 6970 2822 2f22 290a 0a20  h.lstrip("/").. 
+0000d190: 2020 2020 2020 2069 6620 6973 5f64 6972         if is_dir
+0000d1a0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+0000d1b0: 6c61 7469 7665 5f70 6174 6820 3d20 6622  lative_path = f"
+0000d1c0: 7b72 656c 6174 6976 655f 7061 7468 7d2f  {relative_path}/
+0000d1d0: 220a 2020 2020 2020 2020 7265 7475 726e  ".        return
+0000d1e0: 2073 656c 662e 6d69 676e 6f72 655f 7275   self.mignore_ru
+0000d1f0: 6c65 732e 6d61 7463 685f 6669 6c65 2872  les.match_file(r
+0000d200: 656c 6174 6976 655f 7061 7468 290a 0a20  elative_path).. 
+0000d210: 2020 2064 6566 205f 736c 6f77 5f64 6f77     def _slow_dow
+0000d220: 6e28 7365 6c66 2920 2d3e 204e 6f6e 653a  n(self) -> None:
+0000d230: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0000d240: 2020 2020 2050 6175 7365 7320 6966 2043       Pauses if C
+0000d250: 5055 2075 7361 6765 2069 7320 746f 6f20  PU usage is too 
+0000d260: 6869 6768 2069 6620 6361 6c6c 6564 2066  high if called f
+0000d270: 726f 6d20 6f6e 6520 6f66 206f 7572 2074  rom one of our t
+0000d280: 6872 6561 6420 706f 6f6c 732e 0a20 2020  hread pools..   
+0000d290: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+0000d2a0: 2069 6620 7365 6c66 2e5f 6d61 785f 6370   if self._max_cp
+0000d2b0: 755f 7065 7263 656e 7420 3d3d 2031 3030  u_percent == 100
+0000d2c0: 202a 2043 5055 5f43 4f52 455f 434f 554e   * CPU_CORE_COUN
+0000d2d0: 543a 0a20 2020 2020 2020 2020 2020 2072  T:.            r
+0000d2e0: 6574 7572 6e0a 0a20 2020 2020 2020 2063  eturn..        c
+0000d2f0: 7075 5f75 7361 6765 203d 2063 7075 5f75  pu_usage = cpu_u
+0000d300: 7361 6765 5f70 6572 6365 6e74 2829 0a0a  sage_percent()..
+0000d310: 2020 2020 2020 2020 6966 2063 7075 5f75          if cpu_u
+0000d320: 7361 6765 203e 2073 656c 662e 5f6d 6178  sage > self._max
+0000d330: 5f63 7075 5f70 6572 6365 6e74 3a0a 2020  _cpu_percent:.  
+0000d340: 2020 2020 2020 2020 2020 7468 7265 6164            thread
+0000d350: 5f6e 616d 6520 3d20 6375 7272 656e 745f  _name = current_
+0000d360: 7468 7265 6164 2829 2e6e 616d 650a 2020  thread().name.  
+0000d370: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0000d380: 6c6f 6767 6572 2e64 6562 7567 2866 227b  logger.debug(f"{
+0000d390: 7468 7265 6164 5f6e 616d 657d 3a20 7b63  thread_name}: {c
+0000d3a0: 7075 5f75 7361 6765 7d25 2043 5055 2075  pu_usage}% CPU u
+0000d3b0: 7361 6765 202d 2074 6872 6f74 746c 696e  sage - throttlin
+0000d3c0: 6722 290a 0a20 2020 2020 2020 2020 2020  g")..           
+0000d3d0: 2077 6869 6c65 2063 7075 5f75 7361 6765   while cpu_usage
+0000d3e0: 203e 2073 656c 662e 5f6d 6178 5f63 7075   > self._max_cpu
+0000d3f0: 5f70 6572 6365 6e74 3a0a 2020 2020 2020  _percent:.      
+0000d400: 2020 2020 2020 2020 2020 6370 755f 7573            cpu_us
+0000d410: 6167 6520 3d20 6370 755f 7573 6167 655f  age = cpu_usage_
+0000d420: 7065 7263 656e 7428 302e 3520 2b20 3220  percent(0.5 + 2 
+0000d430: 2a20 7261 6e64 6f6d 2e72 616e 646f 6d28  * random.random(
+0000d440: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
+0000d450: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+0000d460: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+0000d470: 2020 2020 6622 7b74 6872 6561 645f 6e61      f"{thread_na
+0000d480: 6d65 7d3a 207b 6370 755f 7573 6167 657d  me}: {cpu_usage}
+0000d490: 2520 4350 5520 7573 6167 6520 2d20 656e  % CPU usage - en
+0000d4a0: 6420 7468 726f 7474 6c69 6e67 220a 2020  d throttling".  
+0000d4b0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
+0000d4c0: 2064 6566 2063 616e 6365 6c5f 7379 6e63   def cancel_sync
+0000d4d0: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
+0000d4e0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000d4f0: 2020 2020 5261 6973 6573 2061 203a 6578      Raises a :ex
+0000d500: 633a 606d 6165 7374 7261 6c2e 6578 6365  c:`maestral.exce
+0000d510: 7074 696f 6e73 2e43 616e 6365 6c6c 6564  ptions.Cancelled
+0000d520: 4572 726f 7260 2069 6e20 616c 6c20 7379  Error` in all sy
+0000d530: 6e63 2074 6872 6561 6473 2061 6e64 2077  nc threads and w
+0000d540: 6169 7473 0a20 2020 2020 2020 2066 6f72  aits.        for
+0000d550: 2074 6865 6d20 746f 2073 6875 7420 646f   them to shut do
+0000d560: 776e 2e0a 2020 2020 2020 2020 2222 220a  wn..        """.
+0000d570: 2020 2020 2020 2020 7365 6c66 2e5f 6361          self._ca
+0000d580: 6e63 656c 5f72 6571 7565 7374 6564 2e73  ncel_requested.s
+0000d590: 6574 2829 0a0a 2020 2020 2020 2020 2320  et()..        # 
+0000d5a0: 5761 6974 2075 6e74 696c 2077 6520 6361  Wait until we ca
+0000d5b0: 6e20 6163 7175 6972 6520 7468 6520 7379  n acquire the sy
+0000d5c0: 6e63 206c 6f63 6b20 3d3e 2077 6520 6172  nc lock => we ar
+0000d5d0: 6520 6964 6c65 2e0a 2020 2020 2020 2020  e idle..        
+0000d5e0: 7365 6c66 2e73 796e 635f 6c6f 636b 2e61  self.sync_lock.a
+0000d5f0: 6371 7569 7265 2829 0a20 2020 2020 2020  cquire().       
+0000d600: 2073 656c 662e 7379 6e63 5f6c 6f63 6b2e   self.sync_lock.
+0000d610: 7265 6c65 6173 6528 290a 0a20 2020 2020  release()..     
+0000d620: 2020 2073 656c 662e 5f63 616e 6365 6c5f     self._cancel_
+0000d630: 7265 7175 6573 7465 642e 636c 6561 7228  requested.clear(
+0000d640: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+0000d650: 5f6c 6f67 6765 722e 696e 666f 2822 5379  _logger.info("Sy
+0000d660: 6e63 2061 626f 7274 6564 2229 0a0a 2020  nc aborted")..  
+0000d670: 2020 6465 6620 6275 7379 2873 656c 6629    def busy(self)
+0000d680: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+0000d690: 2020 2222 220a 2020 2020 2020 2020 4368    """.        Ch
+0000d6a0: 6563 6b73 2069 6620 7765 2061 7265 2063  ecks if we are c
+0000d6b0: 7572 7265 6e74 6c79 2073 796e 6369 6e67  urrently syncing
+0000d6c0: 2e0a 0a20 2020 2020 2020 203a 7265 7475  ...        :retu
+0000d6d0: 726e 733a 2060 6054 7275 6560 6020 6966  rns: ``True`` if
+0000d6e0: 203a 6174 7472 3a60 7379 6e63 5f6c 6f63   :attr:`sync_loc
+0000d6f0: 6b60 2063 616e 6e6f 7420 6265 2061 6371  k` cannot be acq
+0000d700: 7569 7265 642c 2060 6046 616c 7365 6060  uired, ``False``
+0000d710: 206f 7468 6572 7769 7365 2e0a 2020 2020   otherwise..    
+0000d720: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0000d730: 6964 6c65 203d 2073 656c 662e 7379 6e63  idle = self.sync
+0000d740: 5f6c 6f63 6b2e 6163 7175 6972 6528 626c  _lock.acquire(bl
+0000d750: 6f63 6b69 6e67 3d46 616c 7365 290a 2020  ocking=False).  
+0000d760: 2020 2020 2020 6966 2069 646c 653a 0a20        if idle:. 
+0000d770: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0000d780: 7379 6e63 5f6c 6f63 6b2e 7265 6c65 6173  sync_lock.releas
+0000d790: 6528 290a 0a20 2020 2020 2020 2072 6574  e()..        ret
+0000d7a0: 7572 6e20 6e6f 7420 6964 6c65 0a0a 2020  urn not idle..  
+0000d7b0: 2020 6465 6620 5f68 616e 646c 655f 7379    def _handle_sy
+0000d7c0: 6e63 5f65 7272 6f72 2873 656c 662c 2065  nc_error(self, e
+0000d7d0: 7272 3a20 5379 6e63 4572 726f 722c 2064  rr: SyncError, d
+0000d7e0: 6972 6563 7469 6f6e 3a20 5379 6e63 4469  irection: SyncDi
+0000d7f0: 7265 6374 696f 6e29 202d 3e20 4e6f 6e65  rection) -> None
+0000d800: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0000d810: 2020 2020 2020 4861 6e64 6c65 7320 6120        Handles a 
+0000d820: 7379 6e63 2065 7272 6f72 2e20 4669 6c6c  sync error. Fill
+0000d830: 7320 6f75 7420 616e 7920 6d69 7373 696e  s out any missin
+0000d840: 6720 7061 7468 2069 6e66 6f72 6d61 7469  g path informati
+0000d850: 6f6e 2061 6e64 2061 6464 7320 7468 6520  on and adds the 
+0000d860: 6572 726f 720a 2020 2020 2020 2020 746f  error.        to
+0000d870: 2074 6865 2070 6572 7369 7374 656e 7420   the persistent 
+0000d880: 7374 6174 6520 666f 7220 6c61 7465 7220  state for later 
+0000d890: 7265 7379 6e63 2e0a 0a20 2020 2020 2020  resync...       
+0000d8a0: 203a 7061 7261 6d20 6572 723a 2054 6865   :param err: The
+0000d8b0: 2073 796e 6320 6572 726f 7220 746f 2068   sync error to h
+0000d8c0: 616e 646c 652e 0a20 2020 2020 2020 203a  andle..        :
+0000d8d0: 7061 7261 6d20 6469 7265 6374 696f 6e3a  param direction:
+0000d8e0: 2054 6865 2073 796e 6320 6469 7265 6374   The sync direct
+0000d8f0: 696f 6e20 2875 7020 6f72 2064 6f77 6e29  ion (up or down)
+0000d900: 2066 6f72 2077 6869 6368 2074 6865 2065   for which the e
+0000d910: 7272 6f72 206f 6363 7572 7265 642e 0a20  rror occurred.. 
+0000d920: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000d930: 2020 2023 2046 696c 6c20 696e 206d 6973     # Fill in mis
+0000d940: 7369 6e67 2064 6278 5f70 6174 6820 6f72  sing dbx_path or
+0000d950: 206c 6f63 616c 5f70 6174 682e 0a20 2020   local_path..   
+0000d960: 2020 2020 2069 6620 6572 722e 6462 785f       if err.dbx_
+0000d970: 7061 7468 2061 6e64 206e 6f74 2065 7272  path and not err
+0000d980: 2e6c 6f63 616c 5f70 6174 683a 0a20 2020  .local_path:.   
+0000d990: 2020 2020 2020 2020 2065 7272 2e6c 6f63           err.loc
+0000d9a0: 616c 5f70 6174 6820 3d20 7365 6c66 2e74  al_path = self.t
+0000d9b0: 6f5f 6c6f 6361 6c5f 7061 7468 5f66 726f  o_local_path_fro
+0000d9c0: 6d5f 6361 7365 6428 6572 722e 6462 785f  m_cased(err.dbx_
+0000d9d0: 7061 7468 290a 2020 2020 2020 2020 6966  path).        if
+0000d9e0: 2065 7272 2e6c 6f63 616c 5f70 6174 6820   err.local_path 
+0000d9f0: 616e 6420 6e6f 7420 6572 722e 6462 785f  and not err.dbx_
+0000da00: 7061 7468 3a0a 2020 2020 2020 2020 2020  path:.          
+0000da10: 2020 6572 722e 6462 785f 7061 7468 203d    err.dbx_path =
+0000da20: 2073 656c 662e 746f 5f64 6278 5f70 6174   self.to_dbx_pat
+0000da30: 6828 6572 722e 6c6f 6361 6c5f 7061 7468  h(err.local_path
+0000da40: 290a 0a20 2020 2020 2020 2023 2046 696c  )..        # Fil
+0000da50: 6c20 696e 206d 6973 7369 6e67 2064 6278  l in missing dbx
+0000da60: 5f70 6174 685f 6672 6f6d 206f 7220 6c6f  _path_from or lo
+0000da70: 6361 6c5f 7061 7468 5f66 726f 6d2e 0a20  cal_path_from.. 
+0000da80: 2020 2020 2020 2069 6620 6572 722e 6462         if err.db
+0000da90: 785f 7061 7468 5f66 726f 6d20 616e 6420  x_path_from and 
+0000daa0: 6e6f 7420 6572 722e 6c6f 6361 6c5f 7061  not err.local_pa
+0000dab0: 7468 5f66 726f 6d3a 0a20 2020 2020 2020  th_from:.       
+0000dac0: 2020 2020 2065 7272 2e6c 6f63 616c 5f70       err.local_p
+0000dad0: 6174 685f 6672 6f6d 203d 2073 656c 662e  ath_from = self.
+0000dae0: 746f 5f6c 6f63 616c 5f70 6174 685f 6672  to_local_path_fr
+0000daf0: 6f6d 5f63 6173 6564 2865 7272 2e64 6278  om_cased(err.dbx
+0000db00: 5f70 6174 685f 6672 6f6d 290a 2020 2020  _path_from).    
+0000db10: 2020 2020 6966 2065 7272 2e6c 6f63 616c      if err.local
+0000db20: 5f70 6174 685f 6672 6f6d 2061 6e64 206e  _path_from and n
+0000db30: 6f74 2065 7272 2e64 6278 5f70 6174 685f  ot err.dbx_path_
+0000db40: 6672 6f6d 3a0a 2020 2020 2020 2020 2020  from:.          
+0000db50: 2020 6572 722e 6462 785f 7061 7468 5f66    err.dbx_path_f
+0000db60: 726f 6d20 3d20 7365 6c66 2e74 6f5f 6462  rom = self.to_db
+0000db70: 785f 7061 7468 2865 7272 2e6c 6f63 616c  x_path(err.local
+0000db80: 5f70 6174 685f 6672 6f6d 290a 0a20 2020  _path_from)..   
+0000db90: 2020 2020 2069 6620 6e6f 7420 6572 722e       if not err.
+0000dba0: 6462 785f 7061 7468 3a0a 2020 2020 2020  dbx_path:.      
+0000dbb0: 2020 2020 2020 7261 6973 6520 5661 6c75        raise Valu
+0000dbc0: 6545 7272 6f72 2822 5379 6e63 2065 7272  eError("Sync err
+0000dbd0: 6f72 2068 6173 2061 6e20 756e 6b6e 6f77  or has an unknow
+0000dbe0: 6e20 7061 7468 2229 0a0a 2020 2020 2020  n path")..      
+0000dbf0: 2020 7072 696e 7461 626c 655f 6669 6c65    printable_file
+0000dc00: 5f6e 616d 6520 3d20 7361 6e69 7469 7a65  _name = sanitize
+0000dc10: 5f73 7472 696e 6728 6f73 702e 6261 7365  _string(osp.base
+0000dc20: 6e61 6d65 2865 7272 2e64 6278 5f70 6174  name(err.dbx_pat
+0000dc30: 6829 290a 0a20 2020 2020 2020 2073 656c  h))..        sel
+0000dc40: 662e 5f6c 6f67 6765 722e 696e 666f 2822  f._logger.info("
+0000dc50: 436f 756c 6420 6e6f 7420 7379 6e63 2025  Could not sync %
+0000dc60: 7322 2c20 7072 696e 7461 626c 655f 6669  s", printable_fi
+0000dc70: 6c65 5f6e 616d 652c 2065 7863 5f69 6e66  le_name, exc_inf
+0000dc80: 6f3d 5472 7565 290a 0a20 2020 2020 2020  o=True)..       
+0000dc90: 2064 6566 2063 616c 6c62 6163 6b28 2920   def callback() 
+0000dca0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
+0000dcb0: 2020 2020 2069 6620 6572 722e 6c6f 6361       if err.loca
+0000dcc0: 6c5f 7061 7468 3a0a 2020 2020 2020 2020  l_path:.        
+0000dcd0: 2020 2020 2020 2020 636c 6963 6b2e 6c61          click.la
+0000dce0: 756e 6368 2865 7272 2e6c 6f63 616c 5f70  unch(err.local_p
+0000dcf0: 6174 682c 206c 6f63 6174 653d 5472 7565  ath, locate=True
+0000dd00: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0000dd10: 6966 2065 7272 2e64 6278 5f70 6174 683a  if err.dbx_path:
+0000dd20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000dd30: 2075 726c 5f70 6174 6820 3d20 7572 6c6c   url_path = urll
+0000dd40: 6962 2e70 6172 7365 2e71 756f 7465 2865  ib.parse.quote(e
+0000dd50: 7272 2e64 6278 5f70 6174 6829 0a20 2020  rr.dbx_path).   
+0000dd60: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
+0000dd70: 636b 2e6c 6175 6e63 6828 6622 6874 7470  ck.launch(f"http
+0000dd80: 733a 2f2f 7777 772e 6472 6f70 626f 782e  s://www.dropbox.
+0000dd90: 636f 6d2f 7072 6576 6965 777b 7572 6c5f  com/preview{url_
+0000dda0: 7061 7468 7d22 290a 0a20 2020 2020 2020  path}")..       
+0000ddb0: 2069 6620 7365 6c66 2e64 6573 6b74 6f70   if self.desktop
+0000ddc0: 5f6e 6f74 6966 6965 723a 0a20 2020 2020  _notifier:.     
+0000ddd0: 2020 2020 2020 2073 656c 662e 6465 736b         self.desk
+0000dde0: 746f 705f 6e6f 7469 6669 6572 2e6e 6f74  top_notifier.not
+0000ddf0: 6966 7928 0a20 2020 2020 2020 2020 2020  ify(.           
+0000de00: 2020 2020 2022 5379 6e63 2065 7272 6f72       "Sync error
+0000de10: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0000de20: 2020 2066 2243 6f75 6c64 206e 6f74 207b     f"Could not {
+0000de30: 6469 7265 6374 696f 6e2e 7661 6c75 657d  direction.value}
+0000de40: 6c6f 6164 207b 7072 696e 7461 626c 655f  load {printable_
+0000de50: 6669 6c65 5f6e 616d 657d 222c 0a20 2020  file_name}",.   
+0000de60: 2020 2020 2020 2020 2020 2020 206c 6576               lev
+0000de70: 656c 3d6e 6f74 6966 792e 5359 4e43 4953  el=notify.SYNCIS
+0000de80: 5355 452c 0a20 2020 2020 2020 2020 2020  SUE,.           
+0000de90: 2020 2020 2061 6374 696f 6e73 3d7b 2253       actions={"S
+0000dea0: 686f 7722 3a20 6361 6c6c 6261 636b 7d2c  how": callback},
 0000deb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000dec0: 2020 2020 2064 6278 5f70 6174 683d 6572       dbx_path=er
-0000ded0: 722e 6462 785f 7061 7468 2c0a 2020 2020  r.dbx_path,.    
-0000dee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000def0: 6462 785f 7061 7468 5f6c 6f77 6572 3d64  dbx_path_lower=d
-0000df00: 6278 5f70 6174 685f 6c6f 7765 722c 0a20  bx_path_lower,. 
-0000df10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000df20: 2020 2064 6278 5f70 6174 685f 6672 6f6d     dbx_path_from
-0000df30: 3d65 7272 2e64 6278 5f70 6174 685f 6672  =err.dbx_path_fr
-0000df40: 6f6d 2c0a 2020 2020 2020 2020 2020 2020  om,.            
-0000df50: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
-0000df60: 5f66 726f 6d5f 6c6f 7765 723d 6462 785f  _from_lower=dbx_
-0000df70: 7061 7468 5f66 726f 6d5f 6c6f 7765 722c  path_from_lower,
-0000df80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000df90: 2020 2020 206c 6f63 616c 5f70 6174 683d       local_path=
-0000dfa0: 6572 722e 6c6f 6361 6c5f 7061 7468 2c0a  err.local_path,.
-0000dfb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dfc0: 2020 2020 6c6f 6361 6c5f 7061 7468 5f66      local_path_f
-0000dfd0: 726f 6d3d 6572 722e 6c6f 6361 6c5f 7061  rom=err.local_pa
-0000dfe0: 7468 5f66 726f 6d2c 0a20 2020 2020 2020  th_from,.       
-0000dff0: 2020 2020 2020 2020 2020 2020 2064 6972               dir
-0000e000: 6563 7469 6f6e 3d64 6972 6563 7469 6f6e  ection=direction
-0000e010: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000e020: 2020 2020 2020 7469 746c 653d 6572 722e        title=err.
-0000e030: 7469 746c 652c 0a20 2020 2020 2020 2020  title,.         
-0000e040: 2020 2020 2020 2020 2020 206d 6573 7361             messa
-0000e050: 6765 3d65 7272 2e6d 6573 7361 6765 2c0a  ge=err.message,.
-0000e060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e070: 2020 2020 7479 7065 3d65 7272 2e5f 5f63      type=err.__c
-0000e080: 6c61 7373 5f5f 2e5f 5f6e 616d 655f 5f2c  lass__.__name__,
-0000e090: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000e0a0: 2029 0a20 2020 2020 2020 2020 2020 2029   ).            )
-0000e0b0: 0a0a 2020 2020 4063 6f6e 7465 7874 6d61  ..    @contextma
-0000e0c0: 6e61 6765 720a 2020 2020 6465 6620 5f64  nager.    def _d
-0000e0d0: 6174 6162 6173 655f 6163 6365 7373 2873  atabase_access(s
-0000e0e0: 656c 662c 2072 6169 7365 5f65 7272 6f72  elf, raise_error
-0000e0f0: 3a20 626f 6f6c 203d 2054 7275 6529 202d  : bool = True) -
-0000e100: 3e20 4974 6572 6174 6f72 5b4e 6f6e 655d  > Iterator[None]
-0000e110: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0000e120: 2020 2020 2020 4120 636f 6e74 6578 7420        A context 
-0000e130: 6d61 6e61 6765 7220 746f 2073 796e 6368  manager to synch
-0000e140: 726f 6e69 7365 7320 6163 6365 7373 2074  ronises access t
-0000e150: 6f20 7468 6520 5351 4c69 7465 2064 6174  o the SQLite dat
-0000e160: 6162 6173 652e 2043 6174 6368 6573 0a20  abase. Catches. 
-0000e170: 2020 2020 2020 2065 7863 6570 7469 6f6e         exception
-0000e180: 7320 7261 6973 6564 2062 7920 7371 6c69  s raised by sqli
-0000e190: 7465 3320 616e 6420 636f 6e76 6572 7473  te3 and converts
-0000e1a0: 2074 6865 6d20 746f 2061 204d 6165 7374   them to a Maest
-0000e1b0: 7261 6c41 7069 4572 726f 7220 6966 2077  ralApiError if w
-0000e1c0: 6520 6b6e 6f77 0a20 2020 2020 2020 2068  e know.        h
-0000e1d0: 6f77 2074 6f20 6861 6e64 6c65 2074 6865  ow to handle the
-0000e1e0: 6d2e 0a0a 2020 2020 2020 2020 3a70 6172  m...        :par
-0000e1f0: 616d 2072 6169 7365 5f65 7272 6f72 3a20  am raise_error: 
-0000e200: 5768 6574 6865 7220 6572 726f 7273 2073  Whether errors s
-0000e210: 686f 756c 6420 6265 2072 6169 7365 6420  hould be raised 
-0000e220: 6f72 206c 6f67 6765 642e 0a20 2020 2020  or logged..     
-0000e230: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
-0000e240: 6974 6c65 203d 2022 220a 2020 2020 2020  itle = "".      
-0000e250: 2020 6d73 6720 3d20 2222 0a20 2020 2020    msg = "".     
-0000e260: 2020 206e 6577 5f65 7863 203d 204e 6f6e     new_exc = Non
-0000e270: 650a 0a20 2020 2020 2020 2074 7279 3a0a  e..        try:.
-0000e280: 2020 2020 2020 2020 2020 2020 7769 7468              with
-0000e290: 2073 656c 662e 5f64 625f 6c6f 636b 3a0a   self._db_lock:.
-0000e2a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000e2b0: 7969 656c 640a 2020 2020 2020 2020 6578  yield.        ex
-0000e2c0: 6365 7074 2073 716c 6974 6533 2e4f 7065  cept sqlite3.Ope
-0000e2d0: 7261 7469 6f6e 616c 4572 726f 7220 6173  rationalError as
-0000e2e0: 2065 7863 3a0a 2020 2020 2020 2020 2020   exc:.          
-0000e2f0: 2020 7469 746c 6520 3d20 2244 6174 6162    title = "Datab
-0000e300: 6173 6520 7472 616e 7361 6374 696f 6e20  ase transaction 
-0000e310: 6572 726f 7222 0a20 2020 2020 2020 2020  error".         
-0000e320: 2020 206d 7367 203d 2028 0a20 2020 2020     msg = (.     
-0000e330: 2020 2020 2020 2020 2020 2066 2754 6865             f'The
-0000e340: 2069 6e64 6578 2066 696c 6520 6174 2022   index file at "
-0000e350: 7b73 656c 662e 5f64 625f 7061 7468 7d22  {self._db_path}"
-0000e360: 2063 616e 6e6f 7420 6265 2072 6561 642e   cannot be read.
-0000e370: 2027 0a20 2020 2020 2020 2020 2020 2020   '.             
-0000e380: 2020 2022 506c 6561 7365 2063 6865 636b     "Please check
-0000e390: 2074 6861 7420 796f 7520 6861 7665 2073   that you have s
-0000e3a0: 7566 6669 6369 656e 7420 7065 726d 6973  ufficient permis
-0000e3b0: 7369 6f6e 7320 616e 6420 220a 2020 2020  sions and ".    
-0000e3c0: 2020 2020 2020 2020 2020 2020 2272 6573              "res
-0000e3d0: 7461 7274 204d 6165 7374 7261 6c20 746f  tart Maestral to
-0000e3e0: 2063 6f6e 7469 6e75 6520 7379 6e63 696e   continue syncin
-0000e3f0: 672e 220a 2020 2020 2020 2020 2020 2020  g.".            
-0000e400: 290a 2020 2020 2020 2020 2020 2020 6e65  ).            ne
-0000e410: 775f 6578 6320 3d20 4461 7461 6261 7365  w_exc = Database
-0000e420: 4572 726f 7228 7469 746c 652c 206d 7367  Error(title, msg
-0000e430: 292e 7769 7468 5f74 7261 6365 6261 636b  ).with_traceback
-0000e440: 2865 7863 2e5f 5f74 7261 6365 6261 636b  (exc.__traceback
-0000e450: 5f5f 290a 2020 2020 2020 2020 6578 6365  __).        exce
-0000e460: 7074 2073 716c 6974 6533 2e49 6e74 6567  pt sqlite3.Integ
-0000e470: 7269 7479 4572 726f 7220 6173 2065 7863  rityError as exc
-0000e480: 3a0a 2020 2020 2020 2020 2020 2020 7469  :.            ti
-0000e490: 746c 6520 3d20 2244 6174 6162 6173 6520  tle = "Database 
-0000e4a0: 696e 7465 6772 6974 7920 6572 726f 7222  integrity error"
-0000e4b0: 0a20 2020 2020 2020 2020 2020 206d 7367  .            msg
-0000e4c0: 203d 2022 506c 6561 7365 2072 6573 7461   = "Please resta
-0000e4d0: 7274 204d 6165 7374 7261 6c20 746f 2063  rt Maestral to c
-0000e4e0: 6f6e 7469 6e75 6520 7379 6e63 696e 672e  ontinue syncing.
-0000e4f0: 220a 2020 2020 2020 2020 2020 2020 6e65  ".            ne
-0000e500: 775f 6578 6320 3d20 4461 7461 6261 7365  w_exc = Database
-0000e510: 4572 726f 7228 7469 746c 652c 206d 7367  Error(title, msg
-0000e520: 292e 7769 7468 5f74 7261 6365 6261 636b  ).with_traceback
-0000e530: 2865 7863 2e5f 5f74 7261 6365 6261 636b  (exc.__traceback
-0000e540: 5f5f 290a 2020 2020 2020 2020 6578 6365  __).        exce
-0000e550: 7074 2073 716c 6974 6533 2e44 6174 6162  pt sqlite3.Datab
-0000e560: 6173 6545 7272 6f72 2061 7320 6578 633a  aseError as exc:
-0000e570: 0a20 2020 2020 2020 2020 2020 2074 6974  .            tit
-0000e580: 6c65 203d 2022 4461 7461 6261 7365 2074  le = "Database t
-0000e590: 7261 6e73 6163 7469 6f6e 2065 7272 6f72  ransaction error
-0000e5a0: 220a 2020 2020 2020 2020 2020 2020 6d73  ".            ms
-0000e5b0: 6720 3d20 280a 2020 2020 2020 2020 2020  g = (.          
-0000e5c0: 2020 2020 2020 2250 6c65 6173 6520 7265        "Please re
-0000e5d0: 7374 6172 7420 4d61 6573 7472 616c 2074  start Maestral t
-0000e5e0: 6f20 636f 6e74 696e 7565 2073 796e 6369  o continue synci
-0000e5f0: 6e67 2e20 220a 2020 2020 2020 2020 2020  ng. ".          
-0000e600: 2020 2020 2020 2252 6562 7569 6c64 2074        "Rebuild t
-0000e610: 6865 2069 6e64 6578 2069 6620 7468 6973  he index if this
-0000e620: 2069 7373 7565 2070 6572 7369 7374 732e   issue persists.
-0000e630: 220a 2020 2020 2020 2020 2020 2020 290a  ".            ).
-0000e640: 2020 2020 2020 2020 2020 2020 6e65 775f              new_
-0000e650: 6578 6320 3d20 4461 7461 6261 7365 4572  exc = DatabaseEr
-0000e660: 726f 7228 7469 746c 652c 206d 7367 292e  ror(title, msg).
-0000e670: 7769 7468 5f74 7261 6365 6261 636b 2865  with_traceback(e
-0000e680: 7863 2e5f 5f74 7261 6365 6261 636b 5f5f  xc.__traceback__
-0000e690: 290a 0a20 2020 2020 2020 2069 6620 6e65  )..        if ne
-0000e6a0: 775f 6578 633a 0a20 2020 2020 2020 2020  w_exc:.         
-0000e6b0: 2020 2069 6620 7261 6973 655f 6572 726f     if raise_erro
-0000e6c0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000e6d0: 2020 2072 6169 7365 206e 6577 5f65 7863     raise new_exc
-0000e6e0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0000e6f0: 662e 5f6c 6f67 6765 722e 6572 726f 7228  f._logger.error(
-0000e700: 7469 746c 652c 2065 7863 5f69 6e66 6f3d  title, exc_info=
-0000e710: 6578 635f 696e 666f 5f74 7570 6c65 286e  exc_info_tuple(n
-0000e720: 6577 5f65 7863 2929 0a20 2020 2020 2020  ew_exc)).       
-0000e730: 2020 2020 2069 6620 7365 6c66 2e64 6573       if self.des
-0000e740: 6b74 6f70 5f6e 6f74 6966 6965 723a 0a20  ktop_notifier:. 
-0000e750: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000e760: 656c 662e 6465 736b 746f 705f 6e6f 7469  elf.desktop_noti
-0000e770: 6669 6572 2e6e 6f74 6966 7928 7469 746c  fier.notify(titl
-0000e780: 652c 206d 7367 2c20 6c65 7665 6c3d 6e6f  e, msg, level=no
-0000e790: 7469 6679 2e45 5252 4f52 290a 0a20 2020  tify.ERROR)..   
-0000e7a0: 2064 6566 205f 636c 6561 725f 6361 6368   def _clear_cach
-0000e7b0: 6573 2873 656c 6629 202d 3e20 4e6f 6e65  es(self) -> None
-0000e7c0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-0000e7d0: 2020 2020 2020 4672 6565 7320 6d65 6d6f        Frees memo
-0000e7e0: 7279 2062 7920 636c 6561 7269 6e67 2069  ry by clearing i
-0000e7f0: 6e74 6572 6e61 6c20 6361 6368 6573 2e0a  nternal caches..
-0000e800: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0000e810: 2020 2020 7365 6c66 2e5f 6361 7365 5f63      self._case_c
-0000e820: 6f6e 7665 7273 696f 6e5f 6361 6368 652e  onversion_cache.
-0000e830: 636c 6561 7228 290a 2020 2020 2020 2020  clear().        
-0000e840: 7365 6c66 2e66 735f 6576 656e 7473 2e65  self.fs_events.e
-0000e850: 7870 6972 655f 6967 6e6f 7265 645f 6576  xpire_ignored_ev
-0000e860: 656e 7473 2829 0a0a 2020 2020 6465 6620  ents()..    def 
-0000e870: 5f73 796e 635f 6576 656e 745f 6672 6f6d  _sync_event_from
-0000e880: 5f66 735f 6576 656e 7428 7365 6c66 2c20  _fs_event(self, 
-0000e890: 6673 5f65 7665 6e74 3a20 4669 6c65 5379  fs_event: FileSy
-0000e8a0: 7374 656d 4576 656e 7429 202d 3e20 5379  stemEvent) -> Sy
-0000e8b0: 6e63 4576 656e 743a 0a20 2020 2020 2020  ncEvent:.       
-0000e8c0: 2072 6574 7572 6e20 5379 6e63 4576 656e   return SyncEven
-0000e8d0: 742e 6672 6f6d 5f66 696c 655f 7379 7374  t.from_file_syst
-0000e8e0: 656d 5f65 7665 6e74 2866 735f 6576 656e  em_event(fs_even
-0000e8f0: 742c 2073 656c 6629 0a0a 2020 2020 6465  t, self)..    de
-0000e900: 6620 5f73 796e 635f 6576 656e 7473 5f66  f _sync_events_f
-0000e910: 726f 6d5f 6673 5f65 7665 6e74 7328 0a20  rom_fs_events(. 
-0000e920: 2020 2020 2020 2073 656c 662c 2066 735f         self, fs_
-0000e930: 6576 656e 7473 3a20 436f 6c6c 6563 7469  events: Collecti
-0000e940: 6f6e 5b46 696c 6553 7973 7465 6d45 7665  on[FileSystemEve
-0000e950: 6e74 5d0a 2020 2020 2920 2d3e 206c 6973  nt].    ) -> lis
-0000e960: 745b 5379 6e63 4576 656e 745d 3a0a 2020  t[SyncEvent]:.  
-0000e970: 2020 2020 2020 2222 2243 6f6e 7665 7274        """Convert
-0000e980: 206c 6f63 616c 2066 696c 6520 7379 7374   local file syst
-0000e990: 656d 2065 7665 6e74 7320 746f 2073 796e  em events to syn
-0000e9a0: 6320 6576 656e 7473 2e20 5468 6973 2069  c events. This i
-0000e9b0: 7320 646f 6e65 2069 6e20 6120 7468 7265  s done in a thre
-0000e9c0: 6164 0a20 2020 2020 2020 2070 6f6f 6c20  ad.        pool 
-0000e9d0: 746f 2070 6172 616c 6c65 6c69 7a65 2063  to parallelize c
-0000e9e0: 6f6e 7465 6e74 2068 6173 6869 6e67 2e22  ontent hashing."
-0000e9f0: 2222 0a20 2020 2020 2020 2072 6573 203d  "".        res =
-0000ea00: 2064 6f5f 7061 7261 6c6c 656c 280a 2020   do_parallel(.  
-0000ea10: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0000ea20: 7379 6e63 5f65 7665 6e74 5f66 726f 6d5f  sync_event_from_
-0000ea30: 6673 5f65 7665 6e74 2c0a 2020 2020 2020  fs_event,.      
-0000ea40: 2020 2020 2020 6673 5f65 7665 6e74 732c        fs_events,
-0000ea50: 0a20 2020 2020 2020 2020 2020 2074 6872  .            thr
-0000ea60: 6561 645f 6e61 6d65 5f70 7265 6669 783d  ead_name_prefix=
-0000ea70: 226d 6165 7374 7261 6c2d 6c6f 6361 6c2d  "maestral-local-
-0000ea80: 696e 6465 7865 7222 2c0a 2020 2020 2020  indexer",.      
-0000ea90: 2020 290a 2020 2020 2020 2020 7265 7475    ).        retu
-0000eaa0: 726e 206c 6973 7428 7265 7329 0a0a 2020  rn list(res)..  
-0000eab0: 2020 2320 3d3d 3d3d 2055 706c 6f61 6420    # ==== Upload 
-0000eac0: 7379 6e63 203d 3d3d 3d3d 3d3d 3d3d 3d3d  sync ===========
-0000ead0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000eae0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000eaf0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-0000eb00: 3d3d 3d3d 3d3d 0a0a 2020 2020 6465 6620  ======..    def 
-0000eb10: 7570 6c6f 6164 5f6c 6f63 616c 5f63 6861  upload_local_cha
-0000eb20: 6e67 6573 5f77 6869 6c65 5f69 6e61 6374  nges_while_inact
-0000eb30: 6976 6528 7365 6c66 2920 2d3e 204e 6f6e  ive(self) -> Non
-0000eb40: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
-0000eb50: 2020 2020 2020 2043 6f6c 6c65 6374 7320         Collects 
-0000eb60: 6368 616e 6765 7320 7768 696c 6520 7379  changes while sy
-0000eb70: 6e63 2068 6173 206e 6f74 2062 6565 6e20  nc has not been 
-0000eb80: 7275 6e6e 696e 6720 616e 6420 7570 6c6f  running and uplo
-0000eb90: 6164 7320 7468 656d 2074 6f20 4472 6f70  ads them to Drop
-0000eba0: 626f 782e 0a20 2020 2020 2020 2043 616c  box..        Cal
-0000ebb0: 6c20 7468 6973 206d 6574 686f 6420 7768  l this method wh
-0000ebc0: 656e 2072 6573 756d 696e 6720 7379 6e63  en resuming sync
-0000ebd0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-0000ebe0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-0000ebf0: 7379 6e63 5f6c 6f63 6b3a 0a20 2020 2020  sync_lock:.     
-0000ec00: 2020 2020 2020 2023 2044 656c 6574 6520         # Delete 
-0000ec10: 7570 6c6f 6164 2073 796e 6320 6572 726f  upload sync erro
-0000ec20: 7273 2062 6566 6f72 6520 7374 6172 7469  rs before starti
-0000ec30: 6e67 2069 6e64 6578 696e 672e 2054 6869  ng indexing. Thi
-0000ec40: 7320 7072 6576 656e 7473 2065 7272 6f72  s prevents error
-0000ec50: 730a 2020 2020 2020 2020 2020 2020 2320  s.            # 
-0000ec60: 6672 6f6d 206e 6f77 2064 656c 6574 6564  from now deleted
-0000ec70: 206f 7220 6967 6e6f 7265 6420 282e 6d69   or ignored (.mi
-0000ec80: 676e 6f72 6529 2069 7465 6d73 2066 726f  gnore) items fro
-0000ec90: 6d20 6c69 6e67 6572 696e 6720 6f6e 2e20  m lingering on. 
-0000eca0: 416c 6c20 6f74 6865 720a 2020 2020 2020  All other.      
-0000ecb0: 2020 2020 2020 2320 7379 6e63 2065 7272        # sync err
-0000ecc0: 6f72 7320 7769 6c6c 2062 6520 7265 7472  ors will be retr
-0000ecd0: 6965 6420 6175 746f 6d61 7469 6361 6c6c  ied automaticall
-0000ece0: 7920 6279 2063 6f6d 7061 7269 6e67 206c  y by comparing l
-0000ecf0: 6f63 616c 2069 7465 6d73 2061 6761 696e  ocal items again
-0000ed00: 7374 0a20 2020 2020 2020 2020 2020 2023  st.            #
-0000ed10: 206f 7572 2069 6e64 6578 2e0a 2020 2020   our index..    
-0000ed20: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-0000ed30: 6767 6572 2e64 6562 7567 2822 5072 756e  gger.debug("Prun
-0000ed40: 696e 6720 7379 6e63 2065 7272 6f72 7322  ing sync errors"
-0000ed50: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
-0000ed60: 6974 6820 7365 6c66 2e5f 6461 7461 6261  ith self._databa
-0000ed70: 7365 5f61 6363 6573 7328 293a 0a20 2020  se_access():.   
-0000ed80: 2020 2020 2020 2020 2020 2020 2071 7565               que
-0000ed90: 7279 203d 204d 6174 6368 5175 6572 7928  ry = MatchQuery(
-0000eda0: 5379 6e63 4572 726f 7245 6e74 7279 2e64  SyncErrorEntry.d
-0000edb0: 6972 6563 7469 6f6e 2c20 5379 6e63 4469  irection, SyncDi
-0000edc0: 7265 6374 696f 6e2e 5570 290a 2020 2020  rection.Up).    
-0000edd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000ede0: 2e5f 7379 6e63 5f65 7272 6f72 735f 7461  ._sync_errors_ta
-0000edf0: 626c 652e 6465 6c65 7465 2871 7565 7279  ble.delete(query
-0000ee00: 290a 0a20 2020 2020 2020 2020 2020 2073  )..            s
-0000ee10: 656c 662e 5f6c 6f67 6765 722e 696e 666f  elf._logger.info
-0000ee20: 2822 496e 6465 7869 6e67 206c 6f63 616c  ("Indexing local
-0000ee30: 2063 6861 6e67 6573 2e2e 2e22 290a 0a20   changes...").. 
-0000ee40: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0000ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ee60: 6576 656e 7473 2c20 6c6f 6361 6c5f 6375  events, local_cu
-0000ee70: 7273 6f72 203d 2073 656c 662e 5f67 6574  rsor = self._get
-0000ee80: 5f6c 6f63 616c 5f63 6861 6e67 6573 5f77  _local_changes_w
-0000ee90: 6869 6c65 5f69 6e61 6374 6976 6528 290a  hile_inactive().
-0000eea0: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-0000eeb0: 7074 204f 5345 7272 6f72 2061 7320 6572  pt OSError as er
-0000eec0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
-0000eed0: 2020 2069 6620 6572 722e 6669 6c65 6e61     if err.filena
-0000eee0: 6d65 203d 3d20 7365 6c66 2e64 726f 7062  me == self.dropb
-0000eef0: 6f78 5f70 6174 683a 0a20 2020 2020 2020  ox_path:.       
-0000ef00: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0000ef10: 662e 656e 7375 7265 5f64 726f 7062 6f78  f.ensure_dropbox
-0000ef20: 5f66 6f6c 6465 725f 7072 6573 656e 7428  _folder_present(
-0000ef30: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0000ef40: 2020 2072 6169 7365 206f 735f 746f 5f6d     raise os_to_m
-0000ef50: 6165 7374 7261 6c5f 6572 726f 7228 6572  aestral_error(er
-0000ef60: 7229 0a0a 2020 2020 2020 2020 2020 2020  r)..            
-0000ef70: 6576 656e 7473 203d 2073 656c 662e 5f63  events = self._c
-0000ef80: 6c65 616e 5f6c 6f63 616c 5f65 7665 6e74  lean_local_event
-0000ef90: 7328 6576 656e 7473 290a 0a20 2020 2020  s(events)..     
-0000efa0: 2020 2020 2020 2073 796e 635f 6576 656e         sync_even
-0000efb0: 7473 203d 2073 656c 662e 5f73 796e 635f  ts = self._sync_
-0000efc0: 6576 656e 7473 5f66 726f 6d5f 6673 5f65  events_from_fs_e
-0000efd0: 7665 6e74 7328 6576 656e 7473 290a 2020  vents(events).  
-0000efe0: 2020 2020 2020 2020 2020 6465 6c20 6576            del ev
-0000eff0: 656e 7473 0a0a 2020 2020 2020 2020 2020  ents..          
-0000f000: 2020 6966 206c 656e 2873 796e 635f 6576    if len(sync_ev
-0000f010: 656e 7473 2920 3e20 303a 0a20 2020 2020  ents) > 0:.     
-0000f020: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000f030: 6170 706c 795f 6c6f 6361 6c5f 6368 616e  apply_local_chan
-0000f040: 6765 7328 7379 6e63 5f65 7665 6e74 7329  ges(sync_events)
-0000f050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000f060: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
-0000f070: 6275 6728 2255 706c 6f61 6465 6420 6c6f  bug("Uploaded lo
-0000f080: 6361 6c20 6368 616e 6765 7320 7768 696c  cal changes whil
-0000f090: 6520 696e 6163 7469 7665 2229 0a20 2020  e inactive").   
-0000f0a0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0000f0b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000f0c0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
-0000f0d0: 6728 224e 6f20 6c6f 6361 6c20 6368 616e  g("No local chan
-0000f0e0: 6765 7320 7768 696c 6520 696e 6163 7469  ges while inacti
-0000f0f0: 7665 2229 0a0a 2020 2020 2020 2020 2020  ve")..          
-0000f100: 2020 6465 6c20 7379 6e63 5f65 7665 6e74    del sync_event
-0000f110: 730a 2020 2020 2020 2020 2020 2020 6763  s.            gc
-0000f120: 2e63 6f6c 6c65 6374 2829 0a0a 2020 2020  .collect()..    
-0000f130: 2020 2020 2020 2020 7365 6c66 2e6c 6f63          self.loc
-0000f140: 616c 5f63 7572 736f 7220 3d20 6c6f 6361  al_cursor = loca
-0000f150: 6c5f 6375 7273 6f72 0a0a 2020 2020 2020  l_cursor..      
-0000f160: 2020 2020 2020 7365 6c66 2e5f 636c 6561        self._clea
-0000f170: 725f 6361 6368 6573 2829 0a0a 2020 2020  r_caches()..    
-0000f180: 6465 6620 5f67 6574 5f6c 6f63 616c 5f63  def _get_local_c
-0000f190: 6861 6e67 6573 5f77 6869 6c65 5f69 6e61  hanges_while_ina
-0000f1a0: 6374 6976 6528 7365 6c66 2920 2d3e 2074  ctive(self) -> t
-0000f1b0: 7570 6c65 5b6c 6973 745b 4669 6c65 5379  uple[list[FileSy
-0000f1c0: 7374 656d 4576 656e 745d 2c20 666c 6f61  stemEvent], floa
-0000f1d0: 745d 3a0a 2020 2020 2020 2020 2222 220a  t]:.        """.
-0000f1e0: 2020 2020 2020 2020 5265 7472 6965 7665          Retrieve
-0000f1f0: 7320 616c 6c20 6c6f 6361 6c20 6368 616e  s all local chan
-0000f200: 6765 7320 7369 6e63 6520 7468 6520 6c61  ges since the la
-0000f210: 7374 2073 796e 6320 6279 2070 6572 666f  st sync by perfo
-0000f220: 726d 696e 6720 6120 6675 6c6c 2073 6361  rming a full sca
-0000f230: 6e20 6f66 2074 6865 0a20 2020 2020 2020  n of the.       
-0000f240: 206c 6f63 616c 2066 6f6c 6465 722e 2043   local folder. C
-0000f250: 6861 6e67 6573 2061 7265 2064 6574 6563  hanges are detec
-0000f260: 7465 6420 6279 2063 6f6d 7061 7269 6e67  ted by comparing
-0000f270: 2074 6865 206e 6577 2064 6972 6563 746f   the new directo
-0000f280: 7279 2073 6e61 7073 686f 7420 746f 0a20  ry snapshot to. 
-0000f290: 2020 2020 2020 206f 7572 2069 6e64 6578         our index
-0000f2a0: 2e0a 0a20 2020 2020 2020 2041 6464 6564  ...        Added
-0000f2b0: 2069 7465 6d73 3a20 4172 6520 7072 6573   items: Are pres
-0000f2c0: 656e 7420 696e 2074 6865 2073 6e61 7073  ent in the snaps
-0000f2d0: 686f 7420 6275 7420 6e6f 7420 696e 206f  hot but not in o
-0000f2e0: 7572 2069 6e64 6578 2e0a 2020 2020 2020  ur index..      
-0000f2f0: 2020 4465 6c65 7465 6420 6974 656d 733a    Deleted items:
-0000f300: 2041 7265 2070 7265 7365 6e74 2069 6e20   Are present in 
-0000f310: 6f75 7220 696e 6465 7820 6275 7420 6e6f  our index but no
-0000f320: 7420 696e 2074 6865 2073 6e61 7073 686f  t in the snapsho
-0000f330: 742e 0a20 2020 2020 2020 204d 6f64 6966  t..        Modif
-0000f340: 6965 6420 6974 656d 733a 2041 7265 2070  ied items: Are p
-0000f350: 7265 7365 6e74 2069 6e20 626f 7468 2062  resent in both b
-0000f360: 7574 2068 6176 6520 6120 6d74 696d 6520  ut have a mtime 
-0000f370: 6e65 7765 7220 7468 616e 2074 6865 206c  newer than the l
-0000f380: 6173 7420 7379 6e63 2e0a 0a20 2020 2020  ast sync...     
-0000f390: 2020 204e 6f74 6520 7468 6174 2074 6865     Note that the
-0000f3a0: 2063 6c69 656e 7420 7365 7473 206d 7469   client sets mti
-0000f3b0: 6d65 7320 666f 7220 6669 6c65 7320 6578  mes for files ex
-0000f3c0: 706c 6963 6974 6c79 2062 7574 206e 6576  plicitly but nev
-0000f3d0: 6572 2074 6f20 6120 7661 6c75 6520 696e  er to a value in
-0000f3e0: 0a20 2020 2020 2020 2074 6865 2066 7574  .        the fut
-0000f3f0: 7572 652e 206d 7469 6d65 203e 206c 6173  ure. mtime > las
-0000f400: 745f 7379 6e63 2074 6865 7265 666f 7265  t_sync therefore
-0000f410: 2069 6e64 6963 6174 6573 2061 2072 6563   indicates a rec
-0000f420: 656e 7420 636f 6e74 656e 7420 6368 616e  ent content chan
-0000f430: 6765 2e20 5765 2064 6f0a 2020 2020 2020  ge. We do.      
-0000f440: 2020 6e6f 7420 7573 6520 7468 6520 6374    not use the ct
-0000f450: 696d 6520 6865 7265 2074 6f20 6176 6f69  ime here to avoi
-0000f460: 6420 7265 7379 6e63 696e 6720 7468 6520  d resyncing the 
-0000f470: 656e 7469 7265 2066 6f6c 6465 7220 6166  entire folder af
-0000f480: 7465 7220 6974 2068 6173 2062 6565 6e0a  ter it has been.
-0000f490: 2020 2020 2020 2020 6d6f 7665 6420 286d          moved (m
-0000f4a0: 6f76 696e 6720 6265 7477 6565 6e20 7061  oving between pa
-0000f4b0: 7274 6974 696f 6e73 2061 6e64 206f 6e20  rtitions and on 
-0000f4c0: 736f 6d65 2066 696c 6520 7379 7374 656d  some file system
-0000f4d0: 7320 6361 6e20 6368 616e 6765 2074 6865  s can change the
-0000f4e0: 2063 7469 6d65 292e 0a0a 2020 2020 2020   ctime)...      
-0000f4f0: 2020 3a72 6574 7572 6e73 3a20 5475 706c    :returns: Tupl
-0000f500: 6520 636f 6e74 6169 6e69 6e67 206c 6f63  e containing loc
-0000f510: 616c 2066 696c 6520 7379 7374 656d 2065  al file system e
-0000f520: 7665 6e74 7320 616e 6420 6120 6375 7273  vents and a curs
-0000f530: 6f72 202f 2074 696d 6573 7461 6d70 0a20  or / timestamp. 
-0000f540: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-0000f550: 6865 2063 6861 6e67 6573 2e0a 2020 2020  he changes..    
-0000f560: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0000f570: 6368 616e 6765 7320 3d20 5b5d 0a20 2020  changes = [].   
-0000f580: 2020 2020 2073 6e61 7073 686f 745f 7469       snapshot_ti
-0000f590: 6d65 203d 2074 696d 652e 7469 6d65 2829  me = time.time()
-0000f5a0: 0a0a 2020 2020 2020 2020 2320 4765 7420  ..        # Get 
-0000f5b0: 6d6f 6469 6669 6564 206f 7220 6164 6465  modified or adde
-0000f5c0: 6420 6974 656d 732e 0a20 2020 2020 2020  d items..       
-0000f5d0: 2066 6f72 206c 6f63 616c 5f70 6174 682c   for local_path,
-0000f5e0: 2073 7461 7420 696e 2077 616c 6b28 7365   stat in walk(se
-0000f5f0: 6c66 2e64 726f 7062 6f78 5f70 6174 682c  lf.dropbox_path,
-0000f600: 2073 656c 662e 5f73 6361 6e64 6972 5f77   self._scandir_w
-0000f610: 6974 685f 6967 6e6f 7265 293a 0a20 2020  ith_ignore):.   
-0000f620: 2020 2020 2020 2020 2069 735f 6469 7220           is_dir 
-0000f630: 3d20 535f 4953 4449 5228 7374 6174 2e73  = S_ISDIR(stat.s
-0000f640: 745f 6d6f 6465 290a 2020 2020 2020 2020  t_mode).        
-0000f650: 2020 2020 696e 6465 785f 656e 7472 7920      index_entry 
-0000f660: 3d20 7365 6c66 2e67 6574 5f69 6e64 6578  = self.get_index
-0000f670: 5f65 6e74 7279 5f66 6f72 5f6c 6f63 616c  _entry_for_local
-0000f680: 5f70 6174 6828 6c6f 6361 6c5f 7061 7468  _path(local_path
-0000f690: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-0000f6a0: 6620 696e 6465 785f 656e 7472 793a 0a20  f index_entry:. 
-0000f6b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000f6c0: 735f 6e65 7720 3d20 4661 6c73 650a 2020  s_new = False.  
-0000f6d0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-0000f6e0: 7374 5f73 796e 6320 3d20 696e 6465 785f  st_sync = index_
-0000f6f0: 656e 7472 792e 6c61 7374 5f73 796e 6320  entry.last_sync 
-0000f700: 6f72 2030 2e30 0a20 2020 2020 2020 2020  or 0.0.         
-0000f710: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000f720: 2020 2020 2020 2020 2069 735f 6e65 7720           is_new 
-0000f730: 3d20 5472 7565 0a20 2020 2020 2020 2020  = True.         
-0000f740: 2020 2020 2020 206c 6173 745f 7379 6e63         last_sync
-0000f750: 203d 2030 2e30 0a0a 2020 2020 2020 2020   = 0.0..        
-0000f760: 2020 2020 6c61 7374 5f73 796e 6320 3d20      last_sync = 
-0000f770: 6d61 7828 6c61 7374 5f73 796e 632c 2073  max(last_sync, s
-0000f780: 656c 662e 6c6f 6361 6c5f 6375 7273 6f72  elf.local_cursor
-0000f790: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
-0000f7a0: 2043 6865 636b 2069 6620 6974 656d 2077   Check if item w
-0000f7b0: 6173 2063 7265 6174 6564 206f 7220 6d6f  as created or mo
-0000f7c0: 6469 6669 6564 2073 696e 6365 2074 6865  dified since the
-0000f7d0: 206c 6173 7420 7379 6e63 2c0a 2020 2020   last sync,.    
-0000f7e0: 2020 2020 2020 2020 2320 6275 7420 6265          # but be
-0000f7f0: 666f 7265 2077 6520 7374 6172 7465 6420  fore we started 
-0000f800: 7468 6520 4669 6c65 4576 656e 7448 616e  the FileEventHan
-0000f810: 646c 6572 2028 7e73 6e61 7073 686f 745f  dler (~snapshot_
-0000f820: 7469 6d65 292e 0a20 2020 2020 2020 2020  time)..         
-0000f830: 2020 206d 7469 6d65 5f63 6865 636b 203d     mtime_check =
-0000f840: 2073 6e61 7073 686f 745f 7469 6d65 203e   snapshot_time >
-0000f850: 2073 7461 742e 7374 5f6d 7469 6d65 203e   stat.st_mtime >
-0000f860: 206c 6173 745f 7379 6e63 0a0a 2020 2020   last_sync..    
-0000f870: 2020 2020 2020 2020 2320 416c 7761 7973          # Always
-0000f880: 2075 706c 6f61 6420 756e 7472 6163 6b65   upload untracke
-0000f890: 6420 6974 656d 732c 2063 6865 636b 206d  d items, check m
-0000f8a0: 7469 6d65 206f 6620 7472 6163 6b65 6420  time of tracked 
-0000f8b0: 6974 656d 732e 0a20 2020 2020 2020 2020  items..         
-0000f8c0: 2020 2069 735f 6d6f 6469 6669 6564 203d     is_modified =
-0000f8d0: 206d 7469 6d65 5f63 6865 636b 2061 6e64   mtime_check and
-0000f8e0: 206e 6f74 2069 735f 6e65 770a 0a20 2020   not is_new..   
-0000f8f0: 2020 2020 2020 2020 2065 7665 6e74 3a20           event: 
-0000f900: 4669 6c65 5379 7374 656d 4576 656e 740a  FileSystemEvent.
-0000f910: 2020 2020 2020 2020 2020 2020 6576 656e              even
-0000f920: 7430 3a20 4669 6c65 5379 7374 656d 4576  t0: FileSystemEv
-0000f930: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
-0000f940: 6576 656e 7431 3a20 4669 6c65 5379 7374  event1: FileSyst
-0000f950: 656d 4576 656e 740a 0a20 2020 2020 2020  emEvent..       
-0000f960: 2020 2020 2069 6620 6973 5f6e 6577 3a0a       if is_new:.
-0000f970: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f980: 6966 2069 735f 6469 723a 0a20 2020 2020  if is_dir:.     
-0000f990: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0000f9a0: 7665 6e74 203d 2044 6972 4372 6561 7465  vent = DirCreate
-0000f9b0: 6445 7665 6e74 286c 6f63 616c 5f70 6174  dEvent(local_pat
-0000f9c0: 6829 0a20 2020 2020 2020 2020 2020 2020  h).             
-0000f9d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000f9e0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-0000f9f0: 6e74 203d 2046 696c 6543 7265 6174 6564  nt = FileCreated
-0000fa00: 4576 656e 7428 6c6f 6361 6c5f 7061 7468  Event(local_path
-0000fa10: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000fa20: 2020 6368 616e 6765 732e 6170 7065 6e64    changes.append
-0000fa30: 2865 7665 6e74 290a 0a20 2020 2020 2020  (event)..       
-0000fa40: 2020 2020 2065 6c69 6620 6973 5f6d 6f64       elif is_mod
-0000fa50: 6966 6965 643a 0a20 2020 2020 2020 2020  ified:.         
-0000fa60: 2020 2020 2020 2069 6620 6973 5f64 6972         if is_dir
-0000fa70: 2061 6e64 2069 6e64 6578 5f65 6e74 7279   and index_entry
-0000fa80: 2e69 735f 6469 7265 6374 6f72 793a 2020  .is_directory:  
-0000fa90: 2320 7479 7065 3a20 6967 6e6f 7265 0a20  # type: ignore. 
-0000faa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fab0: 2020 2023 2057 6520 646f 6e27 7420 656d     # We don't em
-0000fac0: 6974 2060 4469 724d 6f64 6966 6965 6445  it `DirModifiedE
-0000fad0: 7665 6e74 6073 2e0a 2020 2020 2020 2020  vent`s..        
-0000fae0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-0000faf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fb00: 2065 6c69 6620 6e6f 7420 6973 5f64 6972   elif not is_dir
-0000fb10: 2061 6e64 206e 6f74 2069 6e64 6578 5f65   and not index_e
-0000fb20: 6e74 7279 2e69 735f 6469 7265 6374 6f72  ntry.is_director
-0000fb30: 793a 2020 2320 7479 7065 3a20 6967 6e6f  y:  # type: igno
-0000fb40: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
-0000fb50: 2020 2020 2020 2065 7665 6e74 203d 2046         event = F
-0000fb60: 696c 654d 6f64 6966 6965 6445 7665 6e74  ileModifiedEvent
-0000fb70: 286c 6f63 616c 5f70 6174 6829 0a20 2020  (local_path).   
-0000fb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fb90: 2063 6861 6e67 6573 2e61 7070 656e 6428   changes.append(
-0000fba0: 6576 656e 7429 0a20 2020 2020 2020 2020  event).         
-0000fbb0: 2020 2020 2020 2065 6c69 6620 6973 5f64         elif is_d
-0000fbc0: 6972 3a0a 2020 2020 2020 2020 2020 2020  ir:.            
-0000fbd0: 2020 2020 2020 2020 6576 656e 7430 203d          event0 =
-0000fbe0: 2046 696c 6544 656c 6574 6564 4576 656e   FileDeletedEven
-0000fbf0: 7428 6c6f 6361 6c5f 7061 7468 290a 2020  t(local_path).  
-0000fc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000fc10: 2020 6576 656e 7431 203d 2044 6972 4372    event1 = DirCr
-0000fc20: 6561 7465 6445 7665 6e74 286c 6f63 616c  eatedEvent(local
-0000fc30: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-0000fc40: 2020 2020 2020 2020 2020 2063 6861 6e67             chang
-0000fc50: 6573 202b 3d20 5b65 7665 6e74 302c 2065  es += [event0, e
-0000fc60: 7665 6e74 315d 0a20 2020 2020 2020 2020  vent1].         
-0000fc70: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
-0000fc80: 6973 5f64 6972 3a0a 2020 2020 2020 2020  is_dir:.        
-0000fc90: 2020 2020 2020 2020 2020 2020 6576 656e              even
-0000fca0: 7430 203d 2044 6972 4465 6c65 7465 6445  t0 = DirDeletedE
-0000fcb0: 7665 6e74 286c 6f63 616c 5f70 6174 6829  vent(local_path)
-0000fcc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000fcd0: 2020 2020 2065 7665 6e74 3120 3d20 4669       event1 = Fi
-0000fce0: 6c65 4372 6561 7465 6445 7665 6e74 286c  leCreatedEvent(l
-0000fcf0: 6f63 616c 5f70 6174 6829 0a20 2020 2020  ocal_path).     
-0000fd00: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0000fd10: 6861 6e67 6573 202b 3d20 5b65 7665 6e74  hanges += [event
-0000fd20: 302c 2065 7665 6e74 315d 0a0a 2020 2020  0, event1]..    
-0000fd30: 2020 2020 2320 4765 7420 6465 6c65 7465      # Get delete
-0000fd40: 6420 6974 656d 732e 0a20 2020 2020 2020  d items..       
-0000fd50: 2066 6f72 2065 6e74 7279 2069 6e20 7365   for entry in se
-0000fd60: 6c66 2e69 7465 725f 696e 6465 7828 293a  lf.iter_index():
-0000fd70: 0a20 2020 2020 2020 2020 2020 206c 6f63  .            loc
-0000fd80: 616c 5f70 6174 685f 696e 6465 7865 6420  al_path_indexed 
-0000fd90: 3d20 7365 6c66 2e74 6f5f 6c6f 6361 6c5f  = self.to_local_
-0000fda0: 7061 7468 5f66 726f 6d5f 6361 7365 6428  path_from_cased(
-0000fdb0: 656e 7472 792e 6462 785f 7061 7468 5f63  entry.dbx_path_c
-0000fdc0: 6173 6564 290a 2020 2020 2020 2020 2020  ased).          
-0000fdd0: 2020 6973 5f6d 6967 6e6f 7265 203d 2073    is_mignore = s
-0000fde0: 656c 662e 5f69 735f 6d69 676e 6f72 655f  elf._is_mignore_
-0000fdf0: 7061 7468 2865 6e74 7279 2e64 6278 5f70  path(entry.dbx_p
-0000fe00: 6174 685f 6361 7365 642c 2065 6e74 7279  ath_cased, entry
-0000fe10: 2e69 735f 6469 7265 6374 6f72 7929 0a0a  .is_directory)..
-0000fe20: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-0000fe30: 735f 6d69 676e 6f72 6520 6f72 206e 6f74  s_mignore or not
-0000fe40: 2073 656c 662e 5f65 7869 7374 735f 7769   self._exists_wi
-0000fe50: 7468 5f67 6976 656e 5f63 6173 696e 6728  th_given_casing(
-0000fe60: 6c6f 6361 6c5f 7061 7468 5f69 6e64 6578  local_path_index
-0000fe70: 6564 293a 0a20 2020 2020 2020 2020 2020  ed):.           
-0000fe80: 2020 2020 2069 6620 656e 7472 792e 6973       if entry.is
-0000fe90: 5f64 6972 6563 746f 7279 3a0a 2020 2020  _directory:.    
-0000fea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000feb0: 6576 656e 7420 3d20 4469 7244 656c 6574  event = DirDelet
-0000fec0: 6564 4576 656e 7428 6c6f 6361 6c5f 7061  edEvent(local_pa
-0000fed0: 7468 5f69 6e64 6578 6564 290a 2020 2020  th_indexed).    
-0000fee0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0000fef0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000ff00: 2020 2020 2020 6576 656e 7420 3d20 4669        event = Fi
-0000ff10: 6c65 4465 6c65 7465 6445 7665 6e74 286c  leDeletedEvent(l
-0000ff20: 6f63 616c 5f70 6174 685f 696e 6465 7865  ocal_path_indexe
-0000ff30: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-0000ff40: 2020 2063 6861 6e67 6573 2e61 7070 656e     changes.appen
-0000ff50: 6428 6576 656e 7429 0a0a 2020 2020 2020  d(event)..      
-0000ff60: 2020 2320 456e 7375 7265 2074 6861 7420    # Ensure that 
-0000ff70: 7468 6520 6c6f 6361 6c20 4472 6f70 626f  the local Dropbo
-0000ff80: 7820 666f 6c64 6572 2073 7469 6c6c 2065  x folder still e
-0000ff90: 7869 7374 7320 6265 666f 7265 2072 6574  xists before ret
-0000ffa0: 7572 6e69 6e67 2063 6861 6e67 6573 2e0a  urning changes..
-0000ffb0: 2020 2020 2020 2020 2320 5468 6973 2070          # This p
-0000ffc0: 7265 7665 6e74 7320 6120 6465 6c65 7469  revents a deleti
-0000ffd0: 6f6e 206f 6620 7468 6520 4472 6f70 626f  on of the Dropbo
-0000ffe0: 7820 666f 6c64 6572 2066 726f 6d20 6265  x folder from be
-0000fff0: 696e 6720 696e 636f 7272 6563 746c 790a  ing incorrectly.
-00010000: 2020 2020 2020 2020 2320 7072 6f63 6573          # proces
-00010010: 7365 6420 6173 2069 6e64 6976 6964 7561  sed as individua
-00010020: 6c20 6669 6c65 2064 656c 6574 696f 6e73  l file deletions
-00010030: 2e0a 2020 2020 2020 2020 7365 6c66 2e65  ..        self.e
-00010040: 6e73 7572 655f 6472 6f70 626f 785f 666f  nsure_dropbox_fo
-00010050: 6c64 6572 5f70 7265 7365 6e74 2829 0a0a  lder_present()..
-00010060: 2020 2020 2020 2020 6475 7261 7469 6f6e          duration
-00010070: 203d 2074 696d 652e 7469 6d65 2829 202d   = time.time() -
-00010080: 2073 6e61 7073 686f 745f 7469 6d65 0a20   snapshot_time. 
-00010090: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-000100a0: 6765 722e 6465 6275 6728 224c 6f63 616c  ger.debug("Local
-000100b0: 2069 6e64 6578 696e 6720 636f 6d70 6c65   indexing comple
-000100c0: 7465 6420 696e 2025 7320 7365 6322 2c20  ted in %s sec", 
-000100d0: 726f 756e 6428 6475 7261 7469 6f6e 2c20  round(duration, 
-000100e0: 3429 290a 2020 2020 2020 2020 7365 6c66  4)).        self
-000100f0: 2e5f 6c6f 6767 6572 2e64 6562 7567 2822  ._logger.debug("
-00010100: 5265 7472 6965 7665 6420 6c6f 6361 6c20  Retrieved local 
-00010110: 6368 616e 6765 733a 5c6e 2573 222c 2070  changes:\n%s", p
-00010120: 665f 7265 7072 2863 6861 6e67 6573 2929  f_repr(changes))
-00010130: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00010140: 2063 6861 6e67 6573 2c20 736e 6170 7368   changes, snapsh
-00010150: 6f74 5f74 696d 650a 0a20 2020 2064 6566  ot_time..    def
-00010160: 205f 6578 6973 7473 5f77 6974 685f 6769   _exists_with_gi
-00010170: 7665 6e5f 6361 7369 6e67 2873 656c 662c  ven_casing(self,
-00010180: 206c 6f63 616c 5f70 6174 683a 2073 7472   local_path: str
-00010190: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
-000101a0: 2020 2022 2222 0a20 2020 2020 2020 204f     """.        O
-000101b0: 6e20 6361 7365 2d69 6e73 656e 7369 7469  n case-insensiti
-000101c0: 7665 2062 7574 2063 6173 6520 7072 6573  ve but case pres
-000101d0: 6572 7669 6e67 2066 696c 6520 7379 7374  erving file syst
-000101e0: 656d 732c 2061 2060 6f73 2e70 6174 682e  ems, a `os.path.
-000101f0: 6578 6973 7473 600a 2020 2020 2020 2020  exists`.        
-00010200: 6361 6c6c 2077 696c 6c20 7265 7475 726e  call will return
-00010210: 2074 7275 6520 6576 656e 2069 6620 7468   true even if th
-00010220: 6520 6c6f 6361 6c20 6361 7369 6e67 2064  e local casing d
-00010230: 6966 6665 7273 2066 726f 6d20 7468 650a  iffers from the.
-00010240: 2020 2020 2020 2020 696e 6465 7865 6420          indexed 
-00010250: 6361 7369 6e67 2e20 5468 6973 206d 6574  casing. This met
-00010260: 686f 6420 7265 7475 726e 7320 4661 6c73  hod returns Fals
-00010270: 6520 6966 2074 6865 2064 6973 706c 6179  e if the display
-00010280: 2063 6173 696e 6720 6469 6666 6572 7320   casing differs 
-00010290: 6672 6f6d 2074 6865 0a20 2020 2020 2020  from the.       
-000102a0: 2067 6976 656e 2069 6e70 7574 2c20 6576   given input, ev
-000102b0: 656e 2069 6620 7061 7468 7320 7265 6665  en if paths refe
-000102c0: 7220 746f 2074 6865 2073 616d 6520 6669  r to the same fi
-000102d0: 6c65 2e0a 2020 2020 2020 2020 2222 220a  le..        """.
-000102e0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-000102f0: 6973 5f66 735f 6361 7365 5f73 656e 7369  is_fs_case_sensi
-00010300: 7469 7665 3a0a 2020 2020 2020 2020 2020  tive:.          
-00010310: 2020 7265 7475 726e 2065 7869 7374 7328    return exists(
-00010320: 6c6f 6361 6c5f 7061 7468 290a 0a20 2020  local_path)..   
-00010330: 2020 2020 2069 6620 6e6f 7420 6578 6973       if not exis
-00010340: 7473 286c 6f63 616c 5f70 6174 6829 3a0a  ts(local_path):.
-00010350: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00010360: 726e 2046 616c 7365 0a0a 2020 2020 2020  rn False..      
-00010370: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
-00010380: 2020 206c 6f63 616c 5f70 6174 685f 6469     local_path_di
-00010390: 7370 6c61 7965 6420 3d20 746f 5f65 7869  splayed = to_exi
-000103a0: 7374 696e 675f 756e 6e6f 726d 616c 697a  sting_unnormaliz
-000103b0: 6564 5f70 6174 6828 6c6f 6361 6c5f 7061  ed_path(local_pa
-000103c0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-000103d0: 7265 7475 726e 206c 6f63 616c 5f70 6174  return local_pat
-000103e0: 685f 6469 7370 6c61 7965 6420 3d3d 206c  h_displayed == l
-000103f0: 6f63 616c 5f70 6174 680a 2020 2020 2020  ocal_path.      
-00010400: 2020 6578 6365 7074 2028 4669 6c65 4e6f    except (FileNo
-00010410: 7446 6f75 6e64 4572 726f 722c 204e 6f74  tFoundError, Not
-00010420: 4144 6972 6563 746f 7279 4572 726f 7229  ADirectoryError)
-00010430: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00010440: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
-00010450: 6465 6620 7761 6974 5f66 6f72 5f6c 6f63  def wait_for_loc
-00010460: 616c 5f63 6861 6e67 6573 2873 656c 662c  al_changes(self,
-00010470: 2074 696d 656f 7574 3a20 666c 6f61 7420   timeout: float 
-00010480: 3d20 3430 2920 2d3e 2062 6f6f 6c3a 0a20  = 40) -> bool:. 
-00010490: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-000104a0: 2020 2042 6c6f 636b 7320 756e 7469 6c20     Blocks until 
-000104b0: 6c6f 6361 6c20 6368 616e 6765 7320 6172  local changes ar
-000104c0: 6520 6176 6169 6c61 626c 652e 0a0a 2020  e available...  
-000104d0: 2020 2020 2020 3a70 6172 616d 2074 696d        :param tim
-000104e0: 656f 7574 3a20 4d61 7869 6d75 6d20 7469  eout: Maximum ti
-000104f0: 6d65 2069 6e20 7365 636f 6e64 7320 746f  me in seconds to
-00010500: 2077 6169 742e 0a20 2020 2020 2020 203a   wait..        :
-00010510: 7265 7475 726e 733a 2060 6054 7275 6560  returns: ``True`
-00010520: 6020 6966 2063 6861 6e67 6573 2061 7265  ` if changes are
-00010530: 2061 7661 696c 6162 6c65 2c20 6060 4661   available, ``Fa
-00010540: 6c73 6560 6020 6f74 6865 7277 6973 652e  lse`` otherwise.
-00010550: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00010560: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-00010570: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
-00010580: 2020 2020 2022 5761 6974 696e 6720 666f       "Waiting fo
-00010590: 7220 6c6f 6361 6c20 6368 616e 6765 7320  r local changes 
-000105a0: 7369 6e63 6520 6375 7273 6f72 3a20 2573  since cursor: %s
-000105b0: 222c 2073 656c 662e 6c6f 6361 6c5f 6375  ", self.local_cu
-000105c0: 7273 6f72 0a20 2020 2020 2020 2029 0a20  rsor.        ). 
-000105d0: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-000105e0: 6c66 2e66 735f 6576 656e 7473 2e77 6169  lf.fs_events.wai
-000105f0: 745f 666f 725f 6576 656e 7428 7469 6d65  t_for_event(time
-00010600: 6f75 7429 0a0a 2020 2020 6465 6620 7570  out)..    def up
-00010610: 6c6f 6164 5f73 796e 635f 6379 636c 6528  load_sync_cycle(
-00010620: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
-00010630: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-00010640: 2020 2050 6572 666f 726d 7320 6120 6675     Performs a fu
-00010650: 6c6c 2075 706c 6f61 6420 7379 6e63 2063  ll upload sync c
-00010660: 7963 6c65 2062 7920 6361 6c6c 696e 6720  ycle by calling 
-00010670: 696e 206f 7264 6572 3a0a 0a20 2020 2020  in order:..     
-00010680: 2020 2020 2020 2031 2920 3a6d 6574 683a         1) :meth:
-00010690: 606c 6973 745f 6c6f 6361 6c5f 6368 616e  `list_local_chan
-000106a0: 6765 7360 0a20 2020 2020 2020 2020 2020  ges`.           
-000106b0: 2032 2920 3a6d 6574 683a 6061 7070 6c79   2) :meth:`apply
-000106c0: 5f6c 6f63 616c 5f63 6861 6e67 6573 600a  _local_changes`.
-000106d0: 0a20 2020 2020 2020 2048 616e 646c 6573  .        Handles
-000106e0: 2075 7064 6174 696e 6720 7468 6520 6c6f   updating the lo
-000106f0: 6361 6c20 6375 7273 6f72 2066 6f72 2079  cal cursor for y
-00010700: 6f75 2e20 4966 206d 6f6e 6974 6f72 696e  ou. If monitorin
-00010710: 6720 666f 7220 6c6f 6361 6c20 6669 6c65  g for local file
-00010720: 2065 7665 6e74 730a 2020 2020 2020 2020   events.        
-00010730: 7761 7320 696e 7465 7272 7570 7465 642c  was interrupted,
-00010740: 2063 616c 6c20 3a6d 6574 683a 6075 706c   call :meth:`upl
-00010750: 6f61 645f 6c6f 6361 6c5f 6368 616e 6765  oad_local_change
-00010760: 735f 7768 696c 655f 696e 6163 7469 7665  s_while_inactive
-00010770: 6020 696e 7374 6561 642e 0a20 2020 2020  ` instead..     
-00010780: 2020 2022 2222 0a20 2020 2020 2020 2077     """.        w
-00010790: 6974 6820 7365 6c66 2e73 796e 635f 6c6f  ith self.sync_lo
-000107a0: 636b 3a0a 2020 2020 2020 2020 2020 2020  ck:.            
-000107b0: 6368 616e 6765 732c 2063 7572 736f 7220  changes, cursor 
-000107c0: 3d20 7365 6c66 2e6c 6973 745f 6c6f 6361  = self.list_loca
-000107d0: 6c5f 6368 616e 6765 7328 290a 2020 2020  l_changes().    
-000107e0: 2020 2020 2020 2020 7365 6c66 2e61 7070          self.app
-000107f0: 6c79 5f6c 6f63 616c 5f63 6861 6e67 6573  ly_local_changes
-00010800: 2863 6861 6e67 6573 290a 0a20 2020 2020  (changes)..     
-00010810: 2020 2020 2020 2063 6f6e 666c 6963 7473         conflicts
-00010820: 203d 205b 6520 666f 7220 6520 696e 2063   = [e for e in c
-00010830: 6861 6e67 6573 2069 6620 652e 7374 6174  hanges if e.stat
-00010840: 7573 2069 7320 5379 6e63 5374 6174 7573  us is SyncStatus
-00010850: 2e43 6f6e 666c 6963 745d 0a20 2020 2020  .Conflict].     
-00010860: 2020 2020 2020 2073 656c 662e 6e6f 7469         self.noti
-00010870: 6679 5f75 7365 7228 636f 6e66 6c69 6374  fy_user(conflict
-00010880: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-00010890: 7365 6c66 2e6c 6f63 616c 5f63 7572 736f  self.local_curso
-000108a0: 7220 3d20 6375 7273 6f72 0a0a 2020 2020  r = cursor..    
-000108b0: 2020 2020 2020 2020 2320 4672 6565 206d          # Free m
-000108c0: 656d 6f72 7920 6561 726c 7920 746f 2070  emory early to p
-000108d0: 7265 7665 6e74 2066 7261 676d 656e 7461  revent fragmenta
-000108e0: 7469 6f6e 2e0a 2020 2020 2020 2020 2020  tion..          
-000108f0: 2020 6465 6c20 6368 616e 6765 730a 2020    del changes.  
-00010900: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00010910: 636c 6561 725f 6361 6368 6573 2829 0a20  clear_caches(). 
-00010920: 2020 2020 2020 2020 2020 2067 632e 636f             gc.co
-00010930: 6c6c 6563 7428 290a 0a20 2020 2020 2020  llect()..       
-00010940: 2020 2020 2069 6620 7365 6c66 2e5f 6361       if self._ca
-00010950: 6e63 656c 5f72 6571 7565 7374 6564 2e69  ncel_requested.i
-00010960: 735f 7365 7428 293a 0a20 2020 2020 2020  s_set():.       
-00010970: 2020 2020 2020 2020 2072 6169 7365 2043           raise C
-00010980: 616e 6365 6c6c 6564 4572 726f 7228 2253  ancelledError("S
-00010990: 796e 6320 6361 6e63 656c 6c65 6422 290a  ync cancelled").
-000109a0: 0a20 2020 2064 6566 206c 6973 745f 6c6f  .    def list_lo
-000109b0: 6361 6c5f 6368 616e 6765 7328 7365 6c66  cal_changes(self
-000109c0: 2c20 6465 6c61 793a 2066 6c6f 6174 203d  , delay: float =
-000109d0: 2031 2920 2d3e 2074 7570 6c65 5b6c 6973   1) -> tuple[lis
-000109e0: 745b 5379 6e63 4576 656e 745d 2c20 666c  t[SyncEvent], fl
-000109f0: 6f61 745d 3a0a 2020 2020 2020 2020 2222  oat]:.        ""
-00010a00: 220a 2020 2020 2020 2020 5265 7475 726e  ".        Return
-00010a10: 7320 6120 6c69 7374 206f 6620 6c6f 6361  s a list of loca
-00010a20: 6c20 6368 616e 6765 7320 7769 7468 2061  l changes with a
-00010a30: 7420 6d6f 7374 206f 6e65 2065 6e74 7279  t most one entry
-00010a40: 2070 6572 2070 6174 682e 0a0a 2020 2020   per path...    
-00010a50: 2020 2020 3a70 6172 616d 2064 656c 6179      :param delay
-00010a60: 3a20 4465 6c61 7920 696e 2073 6563 2074  : Delay in sec t
-00010a70: 6f20 7761 6974 2066 6f72 2073 7562 7365  o wait for subse
-00010a80: 7175 656e 7420 6368 616e 6765 7320 6265  quent changes be
-00010a90: 666f 7265 2072 6574 7572 6e69 6e67 2e0a  fore returning..
-00010aa0: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-00010ab0: 3a20 286c 6973 7420 6f66 2073 796e 6320  : (list of sync 
-00010ac0: 7469 6d65 7320 6576 656e 7473 2c20 7469  times events, ti
-00010ad0: 6d65 5f73 7461 6d70 290a 2020 2020 2020  me_stamp).      
-00010ae0: 2020 2222 220a 2020 2020 2020 2020 6576    """.        ev
-00010af0: 656e 7473 203d 205b 5d0a 2020 2020 2020  ents = [].      
-00010b00: 2020 6c6f 6361 6c5f 6375 7273 6f72 203d    local_cursor =
-00010b10: 2074 696d 652e 7469 6d65 2829 0a0a 2020   time.time()..  
-00010b20: 2020 2020 2020 2320 4b65 6570 2063 6f6c        # Keep col
-00010b30: 6c65 6374 696e 6720 6576 656e 7473 2075  lecting events u
-00010b40: 6e74 696c 2069 646c 6520 666f 7220 6064  ntil idle for `d
-00010b50: 656c 6179 602e 0a20 2020 2020 2020 2077  elay`..        w
-00010b60: 6869 6c65 2054 7275 653a 0a20 2020 2020  hile True:.     
-00010b70: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00010b80: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00010b90: 7420 3d20 7365 6c66 2e66 735f 6576 656e  t = self.fs_even
-00010ba0: 7473 2e6c 6f63 616c 5f66 696c 655f 6576  ts.local_file_ev
-00010bb0: 656e 745f 7175 6575 652e 6765 7428 7469  ent_queue.get(ti
-00010bc0: 6d65 6f75 743d 6465 6c61 7929 0a20 2020  meout=delay).   
-00010bd0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-00010be0: 6e74 732e 6170 7065 6e64 2865 7665 6e74  nts.append(event
-00010bf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00010c00: 2020 6c6f 6361 6c5f 6375 7273 6f72 203d    local_cursor =
-00010c10: 2074 696d 652e 7469 6d65 2829 0a20 2020   time.time().   
-00010c20: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-00010c30: 456d 7074 793a 0a20 2020 2020 2020 2020  Empty:.         
-00010c40: 2020 2020 2020 2062 7265 616b 0a0a 2020         break..  
-00010c50: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00010c60: 6572 2e64 6562 7567 2822 5265 7472 6965  er.debug("Retrie
-00010c70: 7665 6420 6c6f 6361 6c20 6669 6c65 2065  ved local file e
-00010c80: 7665 6e74 733a 5c6e 2573 222c 2070 665f  vents:\n%s", pf_
-00010c90: 7265 7072 2865 7665 6e74 7329 290a 0a20  repr(events)).. 
-00010ca0: 2020 2020 2020 2065 7665 6e74 7320 3d20         events = 
-00010cb0: 7365 6c66 2e5f 636c 6561 6e5f 6c6f 6361  self._clean_loca
-00010cc0: 6c5f 6576 656e 7473 2865 7665 6e74 7329  l_events(events)
-00010cd0: 0a20 2020 2020 2020 2073 796e 635f 6576  .        sync_ev
-00010ce0: 656e 7473 203d 2073 656c 662e 5f73 796e  ents = self._syn
-00010cf0: 635f 6576 656e 7473 5f66 726f 6d5f 6673  c_events_from_fs
-00010d00: 5f65 7665 6e74 7328 6576 656e 7473 290a  _events(events).
-00010d10: 0a20 2020 2020 2020 2023 2046 7265 6520  .        # Free 
-00010d20: 6d65 6d6f 7279 2065 6172 6c79 2074 6f20  memory early to 
-00010d30: 7072 6576 656e 7420 6672 6167 6d65 6e74  prevent fragment
-00010d40: 6174 696f 6e2e 0a20 2020 2020 2020 2064  ation..        d
-00010d50: 656c 2065 7665 6e74 730a 2020 2020 2020  el events.      
-00010d60: 2020 6763 2e63 6f6c 6c65 6374 2829 0a0a    gc.collect()..
-00010d70: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00010d80: 796e 635f 6576 656e 7473 2c20 6c6f 6361  ync_events, loca
-00010d90: 6c5f 6375 7273 6f72 0a0a 2020 2020 6465  l_cursor..    de
-00010da0: 6620 6170 706c 795f 6c6f 6361 6c5f 6368  f apply_local_ch
-00010db0: 616e 6765 7328 0a20 2020 2020 2020 2073  anges(.        s
-00010dc0: 656c 662c 2073 796e 635f 6576 656e 7473  elf, sync_events
-00010dd0: 3a20 436f 6c6c 6563 7469 6f6e 5b53 796e  : Collection[Syn
-00010de0: 6345 7665 6e74 5d0a 2020 2020 2920 2d3e  cEvent].    ) ->
-00010df0: 206c 6973 745b 5379 6e63 4576 656e 745d   list[SyncEvent]
-00010e00: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00010e10: 2020 2020 2020 4170 706c 6965 7320 6c6f        Applies lo
-00010e20: 6361 6c6c 7920 6465 7465 6374 6564 2063  cally detected c
-00010e30: 6861 6e67 6573 2074 6f20 7468 6520 7265  hanges to the re
-00010e40: 6d6f 7465 2044 726f 7062 6f78 2e20 4368  mote Dropbox. Ch
-00010e50: 616e 6765 7320 7768 6963 6820 7368 6f75  anges which shou
-00010e60: 6c64 2062 650a 2020 2020 2020 2020 6967  ld be.        ig
-00010e70: 6e6f 7265 6420 286d 6967 6e6f 7265 206f  nored (mignore o
-00010e80: 7220 616c 7761 7973 2069 676e 6f72 6564  r always ignored
-00010e90: 2066 696c 6573 2920 6172 6520 736b 6970   files) are skip
-00010ea0: 7065 642e 0a0a 2020 2020 2020 2020 3a70  ped...        :p
-00010eb0: 6172 616d 2073 796e 635f 6576 656e 7473  aram sync_events
-00010ec0: 3a20 4c69 7374 206f 6620 6c6f 6361 6c20  : List of local 
-00010ed0: 6669 6c65 2073 7973 7465 6d20 6576 656e  file system even
-00010ee0: 7473 2e0a 2020 2020 2020 2020 2222 220a  ts..        """.
-00010ef0: 2020 2020 2020 2020 7265 7375 6c74 733a          results:
-00010f00: 206c 6973 745b 5379 6e63 4576 656e 745d   list[SyncEvent]
-00010f10: 203d 205b 5d0a 0a20 2020 2020 2020 2069   = []..        i
-00010f20: 6620 6c65 6e28 7379 6e63 5f65 7665 6e74  f len(sync_event
-00010f30: 7329 203d 3d20 303a 0a20 2020 2020 2020  s) == 0:.       
-00010f40: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
-00010f50: 6c74 730a 0a20 2020 2020 2020 2023 2053  lts..        # S
-00010f60: 6f72 7420 616c 6c20 7379 6e63 2065 7665  ort all sync eve
-00010f70: 6e74 7320 696e 746f 2064 656c 6574 6564  nts into deleted
-00010f80: 2c20 6469 725f 6d6f 7665 6420 616e 6420  , dir_moved and 
-00010f90: 6f74 6865 722e 2044 6973 6361 7264 2069  other. Discard i
-00010fa0: 7465 6d73 0a20 2020 2020 2020 2023 2077  tems.        # w
-00010fb0: 6869 6368 2061 7265 2065 7863 6c75 6465  hich are exclude
-00010fc0: 6420 6279 206d 6967 6e6f 7265 206f 7220  d by mignore or 
-00010fd0: 7468 6520 696e 7465 726e 616c 2065 7863  the internal exc
-00010fe0: 6c75 7369 6f6e 206c 6973 742e 2044 656c  lusion list. Del
-00010ff0: 6574 6564 2061 6e64 0a20 2020 2020 2020  eted and.       
-00011000: 2023 2064 6972 5f6d 6f76 6564 2065 7665   # dir_moved eve
-00011010: 6e74 7320 7769 6c6c 206e 6576 6572 2062  nts will never b
-00011020: 6520 6e65 7374 6564 2028 7765 2068 6176  e nested (we hav
-00011030: 6520 616c 7265 6164 7920 636f 6d62 696e  e already combin
-00011040: 6564 2073 7563 6820 6e65 7374 6564 0a20  ed such nested. 
-00011050: 2020 2020 2020 2023 2065 7665 6e74 7329         # events)
-00011060: 2062 7574 2061 6c6c 206f 7468 6572 2065   but all other e
-00011070: 7665 6e74 7320 6d69 6768 7420 6265 2e20  vents might be. 
-00011080: 5765 206f 7264 6572 2061 6e64 2061 7070  We order and app
-00011090: 6c79 2074 6865 6d20 6869 6572 6172 6368  ly them hierarch
-000110a0: 6963 616c 6c79 2e0a 0a20 2020 2020 2020  ically...       
-000110b0: 2064 656c 6574 6564 3a20 6c69 7374 5b53   deleted: list[S
-000110c0: 796e 6345 7665 6e74 5d20 3d20 5b5d 0a20  yncEvent] = []. 
-000110d0: 2020 2020 2020 2064 6972 5f6d 6f76 6564         dir_moved
-000110e0: 3a20 6c69 7374 5b53 796e 6345 7665 6e74  : list[SyncEvent
-000110f0: 5d20 3d20 5b5d 0a20 2020 2020 2020 206f  ] = [].        o
-00011100: 7468 6572 3a20 6465 6661 756c 7464 6963  ther: defaultdic
-00011110: 745b 696e 742c 206c 6973 745b 5379 6e63  t[int, list[Sync
-00011120: 4576 656e 745d 5d20 3d20 6465 6661 756c  Event]] = defaul
-00011130: 7464 6963 7428 6c69 7374 290a 0a20 2020  tdict(list)..   
-00011140: 2020 2020 2066 6f72 2065 7665 6e74 2069       for event i
-00011150: 6e20 7379 6e63 5f65 7665 6e74 733a 0a20  n sync_events:. 
-00011160: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00011170: 6c66 2e69 735f 6578 636c 7564 6564 2865  lf.is_excluded(e
-00011180: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
-00011190: 206f 7220 7365 6c66 2e69 735f 6d69 676e   or self.is_mign
-000111a0: 6f72 6528 6576 656e 7429 3a0a 2020 2020  ore(event):.    
-000111b0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-000111c0: 696e 7565 0a0a 2020 2020 2020 2020 2020  inue..          
-000111d0: 2020 6966 2065 7665 6e74 2e69 735f 6465    if event.is_de
-000111e0: 6c65 7465 643a 0a20 2020 2020 2020 2020  leted:.         
-000111f0: 2020 2020 2020 2064 656c 6574 6564 2e61         deleted.a
-00011200: 7070 656e 6428 6576 656e 7429 0a20 2020  ppend(event).   
-00011210: 2020 2020 2020 2020 2065 6c69 6620 6576           elif ev
-00011220: 656e 742e 6973 5f64 6972 6563 746f 7279  ent.is_directory
-00011230: 2061 6e64 2065 7665 6e74 2e69 735f 6d6f   and event.is_mo
-00011240: 7665 643a 0a20 2020 2020 2020 2020 2020  ved:.           
-00011250: 2020 2020 2064 6972 5f6d 6f76 6564 2e61       dir_moved.a
-00011260: 7070 656e 6428 6576 656e 7429 0a20 2020  ppend(event).   
-00011270: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00011280: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00011290: 6576 656c 203d 2065 7665 6e74 2e64 6278  evel = event.dbx
-000112a0: 5f70 6174 682e 636f 756e 7428 222f 2229  _path.count("/")
-000112b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000112c0: 206f 7468 6572 5b6c 6576 656c 5d2e 6170   other[level].ap
-000112d0: 7065 6e64 2865 7665 6e74 290a 0a20 2020  pend(event)..   
-000112e0: 2020 2020 2020 2020 2023 2048 6f75 7365           # House
-000112f0: 6b65 6570 696e 672e 0a20 2020 2020 2020  keeping..       
-00011300: 2020 2020 2073 656c 662e 6163 7469 7669       self.activi
-00011310: 7479 2e61 6464 2865 7665 6e74 290a 0a20  ty.add(event).. 
-00011320: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-00011330: 6765 722e 6465 6275 6728 2246 696c 7465  ger.debug("Filte
-00011340: 7265 6420 6465 6c65 7465 6420 6576 656e  red deleted even
-00011350: 7473 3a5c 6e25 7322 2c20 7066 5f72 6570  ts:\n%s", pf_rep
-00011360: 7228 6465 6c65 7465 6429 290a 2020 2020  r(deleted)).    
-00011370: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-00011380: 2e64 6562 7567 2822 4669 6c74 6572 6564  .debug("Filtered
-00011390: 2064 6972 206d 6f76 6564 2065 7665 6e74   dir moved event
-000113a0: 733a 5c6e 2573 222c 2070 665f 7265 7072  s:\n%s", pf_repr
-000113b0: 2864 6972 5f6d 6f76 6564 2929 0a20 2020  (dir_moved)).   
-000113c0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-000113d0: 722e 6465 6275 6728 2246 696c 7465 7265  r.debug("Filtere
-000113e0: 6420 6f74 6865 7220 6576 656e 7473 3a5c  d other events:\
-000113f0: 6e25 7322 2c20 7066 5f72 6570 7228 6f74  n%s", pf_repr(ot
-00011400: 6865 7229 290a 0a20 2020 2020 2020 2023  her))..        #
-00011410: 2041 7070 6c79 2064 656c 6574 6564 2065   Apply deleted e
-00011420: 7665 6e74 7320 6669 7273 742c 2066 6f6c  vents first, fol
-00011430: 6465 7220 6d6f 7665 6420 6576 656e 7473  der moved events
-00011440: 2073 6563 6f6e 642e 0a20 2020 2020 2020   second..       
-00011450: 2023 204e 6569 7468 6572 2065 7665 6e74   # Neither event
-00011460: 2074 7970 6520 7265 7175 6972 6573 2061   type requires a
-00011470: 6e20 6163 7475 616c 2075 706c 6f61 642e  n actual upload.
-00011480: 0a20 2020 2020 2020 2069 6620 6465 6c65  .        if dele
-00011490: 7465 643a 0a20 2020 2020 2020 2020 2020  ted:.           
-000114a0: 2073 656c 662e 5f6c 6f67 6765 722e 696e   self._logger.in
-000114b0: 666f 2822 5570 6c6f 6164 696e 6720 6465  fo("Uploading de
-000114c0: 6c65 7469 6f6e 732e 2e2e 2229 0a0a 2020  letions...")..  
-000114d0: 2020 2020 2020 7265 7320 3d20 646f 5f70        res = do_p
-000114e0: 6172 616c 6c65 6c28 0a20 2020 2020 2020  arallel(.       
-000114f0: 2020 2020 2073 656c 662e 5f63 7265 6174       self._creat
-00011500: 655f 7265 6d6f 7465 5f65 6e74 7279 2c0a  e_remote_entry,.
-00011510: 2020 2020 2020 2020 2020 2020 6465 6c65              dele
-00011520: 7465 642c 0a20 2020 2020 2020 2020 2020  ted,.           
-00011530: 206f 6e5f 7072 6f67 7265 7373 3d6c 616d   on_progress=lam
-00011540: 6264 6120 782c 2079 3a20 7365 6c66 2e5f  bda x, y: self._
-00011550: 6c6f 6767 6572 2e69 6e66 6f28 6622 4465  logger.info(f"De
-00011560: 6c65 7469 6e67 207b 787d 2f7b 797d 2229  leting {x}/{y}")
-00011570: 2c0a 2020 2020 2020 2020 2020 2020 7468  ,.            th
-00011580: 7265 6164 5f6e 616d 655f 7072 6566 6978  read_name_prefix
-00011590: 3d22 6d61 6573 7472 616c 2d75 706c 6f61  ="maestral-uploa
-000115a0: 642d 706f 6f6c 222c 0a20 2020 2020 2020  d-pool",.       
-000115b0: 2029 0a20 2020 2020 2020 2072 6573 756c   ).        resul
-000115c0: 7473 2e65 7874 656e 6428 7265 7329 0a0a  ts.extend(res)..
-000115d0: 2020 2020 2020 2020 6966 2064 6972 5f6d          if dir_m
-000115e0: 6f76 6564 3a0a 2020 2020 2020 2020 2020  oved:.          
-000115f0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e69    self._logger.i
-00011600: 6e66 6f28 224d 6f76 696e 6720 666f 6c64  nfo("Moving fold
-00011610: 6572 732e 2e2e 2229 0a0a 2020 2020 2020  ers...")..      
-00011620: 2020 666f 7220 6576 656e 7420 696e 2064    for event in d
-00011630: 6972 5f6d 6f76 6564 3a0a 2020 2020 2020  ir_moved:.      
-00011640: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00011650: 6572 2e69 6e66 6f28 6622 4d6f 7669 6e67  er.info(f"Moving
-00011660: 207b 6576 656e 742e 6462 785f 7061 7468   {event.dbx_path
-00011670: 5f66 726f 6d7d 2229 0a20 2020 2020 2020  _from}").       
-00011680: 2020 2020 2072 203d 2073 656c 662e 5f63       r = self._c
+0000dec0: 206f 6e5f 636c 6963 6b3d 6361 6c6c 6261   on_click=callba
+0000ded0: 636b 2c0a 2020 2020 2020 2020 2020 2020  ck,.            
+0000dee0: 290a 0a20 2020 2020 2020 2023 2053 6176  )..        # Sav
+0000def0: 6520 7379 6e63 2065 7272 6f72 7320 746f  e sync errors to
+0000df00: 2072 6574 7279 206c 6174 6572 2e0a 0a20   retry later... 
+0000df10: 2020 2020 2020 2064 6278 5f70 6174 685f         dbx_path_
+0000df20: 6c6f 7765 7220 3d20 6e6f 726d 616c 697a  lower = normaliz
+0000df30: 6528 6572 722e 6462 785f 7061 7468 290a  e(err.dbx_path).
+0000df40: 2020 2020 2020 2020 6966 2065 7272 2e64          if err.d
+0000df50: 6278 5f70 6174 685f 6672 6f6d 3a0a 2020  bx_path_from:.  
+0000df60: 2020 2020 2020 2020 2020 6462 785f 7061            dbx_pa
+0000df70: 7468 5f66 726f 6d5f 6c6f 7765 7220 3d20  th_from_lower = 
+0000df80: 6e6f 726d 616c 697a 6528 6572 722e 6462  normalize(err.db
+0000df90: 785f 7061 7468 5f66 726f 6d29 0a20 2020  x_path_from).   
+0000dfa0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000dfb0: 2020 2020 2020 2064 6278 5f70 6174 685f         dbx_path_
+0000dfc0: 6672 6f6d 5f6c 6f77 6572 203d 204e 6f6e  from_lower = Non
+0000dfd0: 650a 0a20 2020 2020 2020 2077 6974 6820  e..        with 
+0000dfe0: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
+0000dff0: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
+0000e000: 2020 2020 2073 656c 662e 5f73 796e 635f       self._sync_
+0000e010: 6572 726f 7273 5f74 6162 6c65 2e75 7064  errors_table.upd
+0000e020: 6174 6528 0a20 2020 2020 2020 2020 2020  ate(.           
+0000e030: 2020 2020 2053 796e 6345 7272 6f72 456e       SyncErrorEn
+0000e040: 7472 7928 0a20 2020 2020 2020 2020 2020  try(.           
+0000e050: 2020 2020 2020 2020 2064 6278 5f70 6174           dbx_pat
+0000e060: 683d 6572 722e 6462 785f 7061 7468 2c0a  h=err.dbx_path,.
+0000e070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e080: 2020 2020 6462 785f 7061 7468 5f6c 6f77      dbx_path_low
+0000e090: 6572 3d64 6278 5f70 6174 685f 6c6f 7765  er=dbx_path_lowe
+0000e0a0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0000e0b0: 2020 2020 2020 2064 6278 5f70 6174 685f         dbx_path_
+0000e0c0: 6672 6f6d 3d65 7272 2e64 6278 5f70 6174  from=err.dbx_pat
+0000e0d0: 685f 6672 6f6d 2c0a 2020 2020 2020 2020  h_from,.        
+0000e0e0: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
+0000e0f0: 7061 7468 5f66 726f 6d5f 6c6f 7765 723d  path_from_lower=
+0000e100: 6462 785f 7061 7468 5f66 726f 6d5f 6c6f  dbx_path_from_lo
+0000e110: 7765 722c 0a20 2020 2020 2020 2020 2020  wer,.           
+0000e120: 2020 2020 2020 2020 206c 6f63 616c 5f70           local_p
+0000e130: 6174 683d 6572 722e 6c6f 6361 6c5f 7061  ath=err.local_pa
+0000e140: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+0000e150: 2020 2020 2020 2020 6c6f 6361 6c5f 7061          local_pa
+0000e160: 7468 5f66 726f 6d3d 6572 722e 6c6f 6361  th_from=err.loca
+0000e170: 6c5f 7061 7468 5f66 726f 6d2c 0a20 2020  l_path_from,.   
+0000e180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e190: 2064 6972 6563 7469 6f6e 3d64 6972 6563   direction=direc
+0000e1a0: 7469 6f6e 2c0a 2020 2020 2020 2020 2020  tion,.          
+0000e1b0: 2020 2020 2020 2020 2020 7469 746c 653d            title=
+0000e1c0: 6572 722e 7469 746c 652c 0a20 2020 2020  err.title,.     
+0000e1d0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+0000e1e0: 6573 7361 6765 3d65 7272 2e6d 6573 7361  essage=err.messa
+0000e1f0: 6765 2c0a 2020 2020 2020 2020 2020 2020  ge,.            
+0000e200: 2020 2020 2020 2020 7479 7065 3d65 7272          type=err
+0000e210: 2e5f 5f63 6c61 7373 5f5f 2e5f 5f6e 616d  .__class__.__nam
+0000e220: 655f 5f2c 0a20 2020 2020 2020 2020 2020  e__,.           
+0000e230: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0000e240: 2020 2029 0a0a 2020 2020 4063 6f6e 7465     )..    @conte
+0000e250: 7874 6d61 6e61 6765 720a 2020 2020 6465  xtmanager.    de
+0000e260: 6620 5f64 6174 6162 6173 655f 6163 6365  f _database_acce
+0000e270: 7373 2873 656c 662c 2072 6169 7365 5f65  ss(self, raise_e
+0000e280: 7272 6f72 3a20 626f 6f6c 203d 2054 7275  rror: bool = Tru
+0000e290: 6529 202d 3e20 4974 6572 6174 6f72 5b4e  e) -> Iterator[N
+0000e2a0: 6f6e 655d 3a0a 2020 2020 2020 2020 2222  one]:.        ""
+0000e2b0: 220a 2020 2020 2020 2020 4120 636f 6e74  ".        A cont
+0000e2c0: 6578 7420 6d61 6e61 6765 7220 746f 2073  ext manager to s
+0000e2d0: 796e 6368 726f 6e69 7365 7320 6163 6365  ynchronises acce
+0000e2e0: 7373 2074 6f20 7468 6520 5351 4c69 7465  ss to the SQLite
+0000e2f0: 2064 6174 6162 6173 652e 2043 6174 6368   database. Catch
+0000e300: 6573 0a20 2020 2020 2020 2065 7863 6570  es.        excep
+0000e310: 7469 6f6e 7320 7261 6973 6564 2062 7920  tions raised by 
+0000e320: 7371 6c69 7465 3320 616e 6420 636f 6e76  sqlite3 and conv
+0000e330: 6572 7473 2074 6865 6d20 746f 2061 204d  erts them to a M
+0000e340: 6165 7374 7261 6c41 7069 4572 726f 7220  aestralApiError 
+0000e350: 6966 2077 6520 6b6e 6f77 0a20 2020 2020  if we know.     
+0000e360: 2020 2068 6f77 2074 6f20 6861 6e64 6c65     how to handle
+0000e370: 2074 6865 6d2e 0a0a 2020 2020 2020 2020   them...        
+0000e380: 3a70 6172 616d 2072 6169 7365 5f65 7272  :param raise_err
+0000e390: 6f72 3a20 5768 6574 6865 7220 6572 726f  or: Whether erro
+0000e3a0: 7273 2073 686f 756c 6420 6265 2072 6169  rs should be rai
+0000e3b0: 7365 6420 6f72 206c 6f67 6765 642e 0a20  sed or logged.. 
+0000e3c0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0000e3d0: 2020 2074 6974 6c65 203d 2022 220a 2020     title = "".  
+0000e3e0: 2020 2020 2020 6d73 6720 3d20 2222 0a20        msg = "". 
+0000e3f0: 2020 2020 2020 206e 6577 5f65 7863 203d         new_exc =
+0000e400: 204e 6f6e 650a 0a20 2020 2020 2020 2074   None..        t
+0000e410: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000e420: 7769 7468 2073 656c 662e 5f64 625f 6c6f  with self._db_lo
+0000e430: 636b 3a0a 2020 2020 2020 2020 2020 2020  ck:.            
+0000e440: 2020 2020 7969 656c 640a 2020 2020 2020      yield.      
+0000e450: 2020 6578 6365 7074 2073 716c 6974 6533    except sqlite3
+0000e460: 2e4f 7065 7261 7469 6f6e 616c 4572 726f  .OperationalErro
+0000e470: 7220 6173 2065 7863 3a0a 2020 2020 2020  r as exc:.      
+0000e480: 2020 2020 2020 7469 746c 6520 3d20 2244        title = "D
+0000e490: 6174 6162 6173 6520 7472 616e 7361 6374  atabase transact
+0000e4a0: 696f 6e20 6572 726f 7222 0a20 2020 2020  ion error".     
+0000e4b0: 2020 2020 2020 206d 7367 203d 2028 0a20         msg = (. 
+0000e4c0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0000e4d0: 2754 6865 2069 6e64 6578 2066 696c 6520  'The index file 
+0000e4e0: 6174 2022 7b73 656c 662e 5f64 625f 7061  at "{self._db_pa
+0000e4f0: 7468 7d22 2063 616e 6e6f 7420 6265 2072  th}" cannot be r
+0000e500: 6561 642e 2027 0a20 2020 2020 2020 2020  ead. '.         
+0000e510: 2020 2020 2020 2022 506c 6561 7365 2063         "Please c
+0000e520: 6865 636b 2074 6861 7420 796f 7520 6861  heck that you ha
+0000e530: 7665 2073 7566 6669 6369 656e 7420 7065  ve sufficient pe
+0000e540: 726d 6973 7369 6f6e 7320 616e 6420 220a  rmissions and ".
+0000e550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000e560: 2272 6573 7461 7274 204d 6165 7374 7261  "restart Maestra
+0000e570: 6c20 746f 2063 6f6e 7469 6e75 6520 7379  l to continue sy
+0000e580: 6e63 696e 672e 220a 2020 2020 2020 2020  ncing.".        
+0000e590: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+0000e5a0: 2020 6e65 775f 6578 6320 3d20 4461 7461    new_exc = Data
+0000e5b0: 6261 7365 4572 726f 7228 7469 746c 652c  baseError(title,
+0000e5c0: 206d 7367 292e 7769 7468 5f74 7261 6365   msg).with_trace
+0000e5d0: 6261 636b 2865 7863 2e5f 5f74 7261 6365  back(exc.__trace
+0000e5e0: 6261 636b 5f5f 290a 2020 2020 2020 2020  back__).        
+0000e5f0: 6578 6365 7074 2073 716c 6974 6533 2e49  except sqlite3.I
+0000e600: 6e74 6567 7269 7479 4572 726f 7220 6173  ntegrityError as
+0000e610: 2065 7863 3a0a 2020 2020 2020 2020 2020   exc:.          
+0000e620: 2020 7469 746c 6520 3d20 2244 6174 6162    title = "Datab
+0000e630: 6173 6520 696e 7465 6772 6974 7920 6572  ase integrity er
+0000e640: 726f 7222 0a20 2020 2020 2020 2020 2020  ror".           
+0000e650: 206d 7367 203d 2022 506c 6561 7365 2072   msg = "Please r
+0000e660: 6573 7461 7274 204d 6165 7374 7261 6c20  estart Maestral 
+0000e670: 746f 2063 6f6e 7469 6e75 6520 7379 6e63  to continue sync
+0000e680: 696e 672e 220a 2020 2020 2020 2020 2020  ing.".          
+0000e690: 2020 6e65 775f 6578 6320 3d20 4461 7461    new_exc = Data
+0000e6a0: 6261 7365 4572 726f 7228 7469 746c 652c  baseError(title,
+0000e6b0: 206d 7367 292e 7769 7468 5f74 7261 6365   msg).with_trace
+0000e6c0: 6261 636b 2865 7863 2e5f 5f74 7261 6365  back(exc.__trace
+0000e6d0: 6261 636b 5f5f 290a 2020 2020 2020 2020  back__).        
+0000e6e0: 6578 6365 7074 2073 716c 6974 6533 2e44  except sqlite3.D
+0000e6f0: 6174 6162 6173 6545 7272 6f72 2061 7320  atabaseError as 
+0000e700: 6578 633a 0a20 2020 2020 2020 2020 2020  exc:.           
+0000e710: 2074 6974 6c65 203d 2022 4461 7461 6261   title = "Databa
+0000e720: 7365 2074 7261 6e73 6163 7469 6f6e 2065  se transaction e
+0000e730: 7272 6f72 220a 2020 2020 2020 2020 2020  rror".          
+0000e740: 2020 6d73 6720 3d20 280a 2020 2020 2020    msg = (.      
+0000e750: 2020 2020 2020 2020 2020 2250 6c65 6173            "Pleas
+0000e760: 6520 7265 7374 6172 7420 4d61 6573 7472  e restart Maestr
+0000e770: 616c 2074 6f20 636f 6e74 696e 7565 2073  al to continue s
+0000e780: 796e 6369 6e67 2e20 220a 2020 2020 2020  yncing. ".      
+0000e790: 2020 2020 2020 2020 2020 2252 6562 7569            "Rebui
+0000e7a0: 6c64 2074 6865 2069 6e64 6578 2069 6620  ld the index if 
+0000e7b0: 7468 6973 2069 7373 7565 2070 6572 7369  this issue persi
+0000e7c0: 7374 732e 220a 2020 2020 2020 2020 2020  sts.".          
+0000e7d0: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
+0000e7e0: 6e65 775f 6578 6320 3d20 4461 7461 6261  new_exc = Databa
+0000e7f0: 7365 4572 726f 7228 7469 746c 652c 206d  seError(title, m
+0000e800: 7367 292e 7769 7468 5f74 7261 6365 6261  sg).with_traceba
+0000e810: 636b 2865 7863 2e5f 5f74 7261 6365 6261  ck(exc.__traceba
+0000e820: 636b 5f5f 290a 0a20 2020 2020 2020 2069  ck__)..        i
+0000e830: 6620 6e65 775f 6578 633a 0a20 2020 2020  f new_exc:.     
+0000e840: 2020 2020 2020 2069 6620 7261 6973 655f         if raise_
+0000e850: 6572 726f 723a 0a20 2020 2020 2020 2020  error:.         
+0000e860: 2020 2020 2020 2072 6169 7365 206e 6577         raise new
+0000e870: 5f65 7863 0a20 2020 2020 2020 2020 2020  _exc.           
+0000e880: 2073 656c 662e 5f6c 6f67 6765 722e 6572   self._logger.er
+0000e890: 726f 7228 7469 746c 652c 2065 7863 5f69  ror(title, exc_i
+0000e8a0: 6e66 6f3d 6578 635f 696e 666f 5f74 7570  nfo=exc_info_tup
+0000e8b0: 6c65 286e 6577 5f65 7863 2929 0a20 2020  le(new_exc)).   
+0000e8c0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0000e8d0: 2e64 6573 6b74 6f70 5f6e 6f74 6966 6965  .desktop_notifie
+0000e8e0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+0000e8f0: 2020 2073 656c 662e 6465 736b 746f 705f     self.desktop_
+0000e900: 6e6f 7469 6669 6572 2e6e 6f74 6966 7928  notifier.notify(
+0000e910: 7469 746c 652c 206d 7367 2c20 6c65 7665  title, msg, leve
+0000e920: 6c3d 6e6f 7469 6679 2e45 5252 4f52 290a  l=notify.ERROR).
+0000e930: 0a20 2020 2064 6566 205f 636c 6561 725f  .    def _clear_
+0000e940: 6361 6368 6573 2873 656c 6629 202d 3e20  caches(self) -> 
+0000e950: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
+0000e960: 220a 2020 2020 2020 2020 4672 6565 7320  ".        Frees 
+0000e970: 6d65 6d6f 7279 2062 7920 636c 6561 7269  memory by cleari
+0000e980: 6e67 2069 6e74 6572 6e61 6c20 6361 6368  ng internal cach
+0000e990: 6573 2e0a 2020 2020 2020 2020 2222 220a  es..        """.
+0000e9a0: 2020 2020 2020 2020 7365 6c66 2e5f 6361          self._ca
+0000e9b0: 7365 5f63 6f6e 7665 7273 696f 6e5f 6361  se_conversion_ca
+0000e9c0: 6368 652e 636c 6561 7228 290a 2020 2020  che.clear().    
+0000e9d0: 2020 2020 7365 6c66 2e66 735f 6576 656e      self.fs_even
+0000e9e0: 7473 2e65 7870 6972 655f 6967 6e6f 7265  ts.expire_ignore
+0000e9f0: 645f 6576 656e 7473 2829 0a0a 2020 2020  d_events()..    
+0000ea00: 6465 6620 5f73 796e 635f 6576 656e 745f  def _sync_event_
+0000ea10: 6672 6f6d 5f66 735f 6576 656e 7428 7365  from_fs_event(se
+0000ea20: 6c66 2c20 6673 5f65 7665 6e74 3a20 4669  lf, fs_event: Fi
+0000ea30: 6c65 5379 7374 656d 4576 656e 7429 202d  leSystemEvent) -
+0000ea40: 3e20 5379 6e63 4576 656e 743a 0a20 2020  > SyncEvent:.   
+0000ea50: 2020 2020 2072 6574 7572 6e20 5379 6e63       return Sync
+0000ea60: 4576 656e 742e 6672 6f6d 5f66 696c 655f  Event.from_file_
+0000ea70: 7379 7374 656d 5f65 7665 6e74 2866 735f  system_event(fs_
+0000ea80: 6576 656e 742c 2073 656c 6629 0a0a 2020  event, self)..  
+0000ea90: 2020 6465 6620 5f73 796e 635f 6576 656e    def _sync_even
+0000eaa0: 7473 5f66 726f 6d5f 6673 5f65 7665 6e74  ts_from_fs_event
+0000eab0: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+0000eac0: 2066 735f 6576 656e 7473 3a20 436f 6c6c   fs_events: Coll
+0000ead0: 6563 7469 6f6e 5b46 696c 6553 7973 7465  ection[FileSyste
+0000eae0: 6d45 7665 6e74 5d0a 2020 2020 2920 2d3e  mEvent].    ) ->
+0000eaf0: 206c 6973 745b 5379 6e63 4576 656e 745d   list[SyncEvent]
+0000eb00: 3a0a 2020 2020 2020 2020 2222 2243 6f6e  :.        """Con
+0000eb10: 7665 7274 206c 6f63 616c 2066 696c 6520  vert local file 
+0000eb20: 7379 7374 656d 2065 7665 6e74 7320 746f  system events to
+0000eb30: 2073 796e 6320 6576 656e 7473 2e20 5468   sync events. Th
+0000eb40: 6973 2069 7320 646f 6e65 2069 6e20 6120  is is done in a 
+0000eb50: 7468 7265 6164 0a20 2020 2020 2020 2070  thread.        p
+0000eb60: 6f6f 6c20 746f 2070 6172 616c 6c65 6c69  ool to paralleli
+0000eb70: 7a65 2063 6f6e 7465 6e74 2068 6173 6869  ze content hashi
+0000eb80: 6e67 2e22 2222 0a20 2020 2020 2020 2072  ng.""".        r
+0000eb90: 6573 203d 2064 6f5f 7061 7261 6c6c 656c  es = do_parallel
+0000eba0: 280a 2020 2020 2020 2020 2020 2020 7365  (.            se
+0000ebb0: 6c66 2e5f 7379 6e63 5f65 7665 6e74 5f66  lf._sync_event_f
+0000ebc0: 726f 6d5f 6673 5f65 7665 6e74 2c0a 2020  rom_fs_event,.  
+0000ebd0: 2020 2020 2020 2020 2020 6673 5f65 7665            fs_eve
+0000ebe0: 6e74 732c 0a20 2020 2020 2020 2020 2020  nts,.           
+0000ebf0: 2074 6872 6561 645f 6e61 6d65 5f70 7265   thread_name_pre
+0000ec00: 6669 783d 226d 6165 7374 7261 6c2d 6c6f  fix="maestral-lo
+0000ec10: 6361 6c2d 696e 6465 7865 7222 2c0a 2020  cal-indexer",.  
+0000ec20: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+0000ec30: 7265 7475 726e 206c 6973 7428 7265 7329  return list(res)
+0000ec40: 0a0a 2020 2020 2320 3d3d 3d3d 2055 706c  ..    # ==== Upl
+0000ec50: 6f61 6420 7379 6e63 203d 3d3d 3d3d 3d3d  oad sync =======
+0000ec60: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ec70: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ec80: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+0000ec90: 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2020 2020  ==========..    
+0000eca0: 6465 6620 7570 6c6f 6164 5f6c 6f63 616c  def upload_local
+0000ecb0: 5f63 6861 6e67 6573 5f77 6869 6c65 5f69  _changes_while_i
+0000ecc0: 6e61 6374 6976 6528 7365 6c66 2920 2d3e  nactive(self) ->
+0000ecd0: 204e 6f6e 653a 0a20 2020 2020 2020 2022   None:.        "
+0000ece0: 2222 0a20 2020 2020 2020 2043 6f6c 6c65  "".        Colle
+0000ecf0: 6374 7320 6368 616e 6765 7320 7768 696c  cts changes whil
+0000ed00: 6520 7379 6e63 2068 6173 206e 6f74 2062  e sync has not b
+0000ed10: 6565 6e20 7275 6e6e 696e 6720 616e 6420  een running and 
+0000ed20: 7570 6c6f 6164 7320 7468 656d 2074 6f20  uploads them to 
+0000ed30: 4472 6f70 626f 782e 0a20 2020 2020 2020  Dropbox..       
+0000ed40: 2043 616c 6c20 7468 6973 206d 6574 686f   Call this metho
+0000ed50: 6420 7768 656e 2072 6573 756d 696e 6720  d when resuming 
+0000ed60: 7379 6e63 2e0a 2020 2020 2020 2020 2222  sync..        ""
+0000ed70: 220a 2020 2020 2020 2020 7769 7468 2073  ".        with s
+0000ed80: 656c 662e 7379 6e63 5f6c 6f63 6b3a 0a20  elf.sync_lock:. 
+0000ed90: 2020 2020 2020 2020 2020 2023 2044 656c             # Del
+0000eda0: 6574 6520 7570 6c6f 6164 2073 796e 6320  ete upload sync 
+0000edb0: 6572 726f 7273 2062 6566 6f72 6520 7374  errors before st
+0000edc0: 6172 7469 6e67 2069 6e64 6578 696e 672e  arting indexing.
+0000edd0: 2054 6869 7320 7072 6576 656e 7473 2065   This prevents e
+0000ede0: 7272 6f72 730a 2020 2020 2020 2020 2020  rrors.          
+0000edf0: 2020 2320 6672 6f6d 206e 6f77 2064 656c    # from now del
+0000ee00: 6574 6564 206f 7220 6967 6e6f 7265 6420  eted or ignored 
+0000ee10: 282e 6d69 676e 6f72 6529 2069 7465 6d73  (.mignore) items
+0000ee20: 2066 726f 6d20 6c69 6e67 6572 696e 6720   from lingering 
+0000ee30: 6f6e 2e20 416c 6c20 6f74 6865 720a 2020  on. All other.  
+0000ee40: 2020 2020 2020 2020 2020 2320 7379 6e63            # sync
+0000ee50: 2065 7272 6f72 7320 7769 6c6c 2062 6520   errors will be 
+0000ee60: 7265 7472 6965 6420 6175 746f 6d61 7469  retried automati
+0000ee70: 6361 6c6c 7920 6279 2063 6f6d 7061 7269  cally by compari
+0000ee80: 6e67 206c 6f63 616c 2069 7465 6d73 2061  ng local items a
+0000ee90: 6761 696e 7374 0a20 2020 2020 2020 2020  gainst.         
+0000eea0: 2020 2023 206f 7572 2069 6e64 6578 2e0a     # our index..
+0000eeb0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000eec0: 2e5f 6c6f 6767 6572 2e64 6562 7567 2822  ._logger.debug("
+0000eed0: 5072 756e 696e 6720 7379 6e63 2065 7272  Pruning sync err
+0000eee0: 6f72 7322 290a 0a20 2020 2020 2020 2020  ors")..         
+0000eef0: 2020 2077 6974 6820 7365 6c66 2e5f 6461     with self._da
+0000ef00: 7461 6261 7365 5f61 6363 6573 7328 293a  tabase_access():
+0000ef10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ef20: 2071 7565 7279 203d 204d 6174 6368 5175   query = MatchQu
+0000ef30: 6572 7928 5379 6e63 4572 726f 7245 6e74  ery(SyncErrorEnt
+0000ef40: 7279 2e64 6972 6563 7469 6f6e 2c20 5379  ry.direction, Sy
+0000ef50: 6e63 4469 7265 6374 696f 6e2e 5570 290a  ncDirection.Up).
+0000ef60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ef70: 7365 6c66 2e5f 7379 6e63 5f65 7272 6f72  self._sync_error
+0000ef80: 735f 7461 626c 652e 6465 6c65 7465 2871  s_table.delete(q
+0000ef90: 7565 7279 290a 0a20 2020 2020 2020 2020  uery)..         
+0000efa0: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
+0000efb0: 696e 666f 2822 496e 6465 7869 6e67 206c  info("Indexing l
+0000efc0: 6f63 616c 2063 6861 6e67 6573 2e2e 2e22  ocal changes..."
+0000efd0: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
+0000efe0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0000eff0: 2020 2020 6576 656e 7473 2c20 6c6f 6361      events, loca
+0000f000: 6c5f 6375 7273 6f72 203d 2073 656c 662e  l_cursor = self.
+0000f010: 5f67 6574 5f6c 6f63 616c 5f63 6861 6e67  _get_local_chang
+0000f020: 6573 5f77 6869 6c65 5f69 6e61 6374 6976  es_while_inactiv
+0000f030: 6528 290a 2020 2020 2020 2020 2020 2020  e().            
+0000f040: 6578 6365 7074 204f 5345 7272 6f72 2061  except OSError a
+0000f050: 7320 6572 723a 0a20 2020 2020 2020 2020  s err:.         
+0000f060: 2020 2020 2020 2069 6620 6572 722e 6669         if err.fi
+0000f070: 6c65 6e61 6d65 203d 3d20 7365 6c66 2e64  lename == self.d
+0000f080: 726f 7062 6f78 5f70 6174 683a 0a20 2020  ropbox_path:.   
+0000f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000f0a0: 2073 656c 662e 656e 7375 7265 5f64 726f   self.ensure_dro
+0000f0b0: 7062 6f78 5f66 6f6c 6465 725f 7072 6573  pbox_folder_pres
+0000f0c0: 656e 7428 290a 0a20 2020 2020 2020 2020  ent()..         
+0000f0d0: 2020 2020 2020 2072 6169 7365 206f 735f         raise os_
+0000f0e0: 746f 5f6d 6165 7374 7261 6c5f 6572 726f  to_maestral_erro
+0000f0f0: 7228 6572 7229 0a0a 2020 2020 2020 2020  r(err)..        
+0000f100: 2020 2020 6576 656e 7473 203d 2073 656c      events = sel
+0000f110: 662e 5f63 6c65 616e 5f6c 6f63 616c 5f65  f._clean_local_e
+0000f120: 7665 6e74 7328 6576 656e 7473 290a 0a20  vents(events).. 
+0000f130: 2020 2020 2020 2020 2020 2073 796e 635f             sync_
+0000f140: 6576 656e 7473 203d 2073 656c 662e 5f73  events = self._s
+0000f150: 796e 635f 6576 656e 7473 5f66 726f 6d5f  ync_events_from_
+0000f160: 6673 5f65 7665 6e74 7328 6576 656e 7473  fs_events(events
+0000f170: 290a 2020 2020 2020 2020 2020 2020 6465  ).            de
+0000f180: 6c20 6576 656e 7473 0a0a 2020 2020 2020  l events..      
+0000f190: 2020 2020 2020 6966 206c 656e 2873 796e        if len(syn
+0000f1a0: 635f 6576 656e 7473 2920 3e20 303a 0a20  c_events) > 0:. 
+0000f1b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000f1c0: 656c 662e 6170 706c 795f 6c6f 6361 6c5f  elf.apply_local_
+0000f1d0: 6368 616e 6765 7328 7379 6e63 5f65 7665  changes(sync_eve
+0000f1e0: 6e74 7329 0a20 2020 2020 2020 2020 2020  nts).           
+0000f1f0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+0000f200: 722e 6465 6275 6728 2255 706c 6f61 6465  r.debug("Uploade
+0000f210: 6420 6c6f 6361 6c20 6368 616e 6765 7320  d local changes 
+0000f220: 7768 696c 6520 696e 6163 7469 7665 2229  while inactive")
+0000f230: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0000f240: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000f250: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
+0000f260: 6465 6275 6728 224e 6f20 6c6f 6361 6c20  debug("No local 
+0000f270: 6368 616e 6765 7320 7768 696c 6520 696e  changes while in
+0000f280: 6163 7469 7665 2229 0a0a 2020 2020 2020  active")..      
+0000f290: 2020 2020 2020 6465 6c20 7379 6e63 5f65        del sync_e
+0000f2a0: 7665 6e74 730a 2020 2020 2020 2020 2020  vents.          
+0000f2b0: 2020 6763 2e63 6f6c 6c65 6374 2829 0a0a    gc.collect()..
+0000f2c0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000f2d0: 2e6c 6f63 616c 5f63 7572 736f 7220 3d20  .local_cursor = 
+0000f2e0: 6c6f 6361 6c5f 6375 7273 6f72 0a0a 2020  local_cursor..  
+0000f2f0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0000f300: 636c 6561 725f 6361 6368 6573 2829 0a0a  clear_caches()..
+0000f310: 2020 2020 6465 6620 5f67 6574 5f6c 6f63      def _get_loc
+0000f320: 616c 5f63 6861 6e67 6573 5f77 6869 6c65  al_changes_while
+0000f330: 5f69 6e61 6374 6976 6528 7365 6c66 2920  _inactive(self) 
+0000f340: 2d3e 2074 7570 6c65 5b6c 6973 745b 4669  -> tuple[list[Fi
+0000f350: 6c65 5379 7374 656d 4576 656e 745d 2c20  leSystemEvent], 
+0000f360: 666c 6f61 745d 3a0a 2020 2020 2020 2020  float]:.        
+0000f370: 2222 220a 2020 2020 2020 2020 5265 7472  """.        Retr
+0000f380: 6965 7665 7320 616c 6c20 6c6f 6361 6c20  ieves all local 
+0000f390: 6368 616e 6765 7320 7369 6e63 6520 7468  changes since th
+0000f3a0: 6520 6c61 7374 2073 796e 6320 6279 2070  e last sync by p
+0000f3b0: 6572 666f 726d 696e 6720 6120 6675 6c6c  erforming a full
+0000f3c0: 2073 6361 6e20 6f66 2074 6865 0a20 2020   scan of the.   
+0000f3d0: 2020 2020 206c 6f63 616c 2066 6f6c 6465       local folde
+0000f3e0: 722e 2043 6861 6e67 6573 2061 7265 2064  r. Changes are d
+0000f3f0: 6574 6563 7465 6420 6279 2063 6f6d 7061  etected by compa
+0000f400: 7269 6e67 2074 6865 206e 6577 2064 6972  ring the new dir
+0000f410: 6563 746f 7279 2073 6e61 7073 686f 7420  ectory snapshot 
+0000f420: 746f 0a20 2020 2020 2020 206f 7572 2069  to.        our i
+0000f430: 6e64 6578 2e0a 0a20 2020 2020 2020 2041  ndex...        A
+0000f440: 6464 6564 2069 7465 6d73 3a20 4172 6520  dded items: Are 
+0000f450: 7072 6573 656e 7420 696e 2074 6865 2073  present in the s
+0000f460: 6e61 7073 686f 7420 6275 7420 6e6f 7420  napshot but not 
+0000f470: 696e 206f 7572 2069 6e64 6578 2e0a 2020  in our index..  
+0000f480: 2020 2020 2020 4465 6c65 7465 6420 6974        Deleted it
+0000f490: 656d 733a 2041 7265 2070 7265 7365 6e74  ems: Are present
+0000f4a0: 2069 6e20 6f75 7220 696e 6465 7820 6275   in our index bu
+0000f4b0: 7420 6e6f 7420 696e 2074 6865 2073 6e61  t not in the sna
+0000f4c0: 7073 686f 742e 0a20 2020 2020 2020 204d  pshot..        M
+0000f4d0: 6f64 6966 6965 6420 6974 656d 733a 2041  odified items: A
+0000f4e0: 7265 2070 7265 7365 6e74 2069 6e20 626f  re present in bo
+0000f4f0: 7468 2062 7574 2068 6176 6520 6120 6d74  th but have a mt
+0000f500: 696d 6520 6e65 7765 7220 7468 616e 2074  ime newer than t
+0000f510: 6865 206c 6173 7420 7379 6e63 2e0a 0a20  he last sync... 
+0000f520: 2020 2020 2020 204e 6f74 6520 7468 6174         Note that
+0000f530: 2074 6865 2063 6c69 656e 7420 7365 7473   the client sets
+0000f540: 206d 7469 6d65 7320 666f 7220 6669 6c65   mtimes for file
+0000f550: 7320 6578 706c 6963 6974 6c79 2062 7574  s explicitly but
+0000f560: 206e 6576 6572 2074 6f20 6120 7661 6c75   never to a valu
+0000f570: 6520 696e 0a20 2020 2020 2020 2074 6865  e in.        the
+0000f580: 2066 7574 7572 652e 206d 7469 6d65 203e   future. mtime >
+0000f590: 206c 6173 745f 7379 6e63 2074 6865 7265   last_sync there
+0000f5a0: 666f 7265 2069 6e64 6963 6174 6573 2061  fore indicates a
+0000f5b0: 2072 6563 656e 7420 636f 6e74 656e 7420   recent content 
+0000f5c0: 6368 616e 6765 2e20 5765 2064 6f0a 2020  change. We do.  
+0000f5d0: 2020 2020 2020 6e6f 7420 7573 6520 7468        not use th
+0000f5e0: 6520 6374 696d 6520 6865 7265 2074 6f20  e ctime here to 
+0000f5f0: 6176 6f69 6420 7265 7379 6e63 696e 6720  avoid resyncing 
+0000f600: 7468 6520 656e 7469 7265 2066 6f6c 6465  the entire folde
+0000f610: 7220 6166 7465 7220 6974 2068 6173 2062  r after it has b
+0000f620: 6565 6e0a 2020 2020 2020 2020 6d6f 7665  een.        move
+0000f630: 6420 286d 6f76 696e 6720 6265 7477 6565  d (moving betwee
+0000f640: 6e20 7061 7274 6974 696f 6e73 2061 6e64  n partitions and
+0000f650: 206f 6e20 736f 6d65 2066 696c 6520 7379   on some file sy
+0000f660: 7374 656d 7320 6361 6e20 6368 616e 6765  stems can change
+0000f670: 2074 6865 2063 7469 6d65 292e 0a0a 2020   the ctime)...  
+0000f680: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
+0000f690: 5475 706c 6520 636f 6e74 6169 6e69 6e67  Tuple containing
+0000f6a0: 206c 6f63 616c 2066 696c 6520 7379 7374   local file syst
+0000f6b0: 656d 2065 7665 6e74 7320 616e 6420 6120  em events and a 
+0000f6c0: 6375 7273 6f72 202f 2074 696d 6573 7461  cursor / timesta
+0000f6d0: 6d70 0a20 2020 2020 2020 2020 2020 2066  mp.            f
+0000f6e0: 6f72 2074 6865 2063 6861 6e67 6573 2e0a  or the changes..
+0000f6f0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0000f700: 2020 2020 6368 616e 6765 7320 3d20 5b5d      changes = []
+0000f710: 0a20 2020 2020 2020 2073 6e61 7073 686f  .        snapsho
+0000f720: 745f 7469 6d65 203d 2074 696d 652e 7469  t_time = time.ti
+0000f730: 6d65 2829 0a0a 2020 2020 2020 2020 2320  me()..        # 
+0000f740: 4765 7420 6d6f 6469 6669 6564 206f 7220  Get modified or 
+0000f750: 6164 6465 6420 6974 656d 732e 0a20 2020  added items..   
+0000f760: 2020 2020 2066 6f72 206c 6f63 616c 5f70       for local_p
+0000f770: 6174 682c 2073 7461 7420 696e 2077 616c  ath, stat in wal
+0000f780: 6b28 7365 6c66 2e64 726f 7062 6f78 5f70  k(self.dropbox_p
+0000f790: 6174 682c 2073 656c 662e 5f73 6361 6e64  ath, self._scand
+0000f7a0: 6972 5f77 6974 685f 6967 6e6f 7265 293a  ir_with_ignore):
+0000f7b0: 0a20 2020 2020 2020 2020 2020 2069 735f  .            is_
+0000f7c0: 6469 7220 3d20 535f 4953 4449 5228 7374  dir = S_ISDIR(st
+0000f7d0: 6174 2e73 745f 6d6f 6465 290a 2020 2020  at.st_mode).    
+0000f7e0: 2020 2020 2020 2020 696e 6465 785f 656e          index_en
+0000f7f0: 7472 7920 3d20 7365 6c66 2e67 6574 5f69  try = self.get_i
+0000f800: 6e64 6578 5f65 6e74 7279 5f66 6f72 5f6c  ndex_entry_for_l
+0000f810: 6f63 616c 5f70 6174 6828 6c6f 6361 6c5f  ocal_path(local_
+0000f820: 7061 7468 290a 0a20 2020 2020 2020 2020  path)..         
+0000f830: 2020 2069 6620 696e 6465 785f 656e 7472     if index_entr
+0000f840: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+0000f850: 2020 2069 735f 6e65 7720 3d20 4661 6c73     is_new = Fals
+0000f860: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+0000f870: 2020 6c61 7374 5f73 796e 6320 3d20 696e    last_sync = in
+0000f880: 6465 785f 656e 7472 792e 6c61 7374 5f73  dex_entry.last_s
+0000f890: 796e 6320 6f72 2030 2e30 0a20 2020 2020  ync or 0.0.     
+0000f8a0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000f8b0: 2020 2020 2020 2020 2020 2020 2069 735f               is_
+0000f8c0: 6e65 7720 3d20 5472 7565 0a20 2020 2020  new = True.     
+0000f8d0: 2020 2020 2020 2020 2020 206c 6173 745f             last_
+0000f8e0: 7379 6e63 203d 2030 2e30 0a0a 2020 2020  sync = 0.0..    
+0000f8f0: 2020 2020 2020 2020 6c61 7374 5f73 796e          last_syn
+0000f900: 6320 3d20 6d61 7828 6c61 7374 5f73 796e  c = max(last_syn
+0000f910: 632c 2073 656c 662e 6c6f 6361 6c5f 6375  c, self.local_cu
+0000f920: 7273 6f72 290a 0a20 2020 2020 2020 2020  rsor)..         
+0000f930: 2020 2023 2043 6865 636b 2069 6620 6974     # Check if it
+0000f940: 656d 2077 6173 2063 7265 6174 6564 206f  em was created o
+0000f950: 7220 6d6f 6469 6669 6564 2073 696e 6365  r modified since
+0000f960: 2074 6865 206c 6173 7420 7379 6e63 2c0a   the last sync,.
+0000f970: 2020 2020 2020 2020 2020 2020 2320 6275              # bu
+0000f980: 7420 6265 666f 7265 2077 6520 7374 6172  t before we star
+0000f990: 7465 6420 7468 6520 4669 6c65 4576 656e  ted the FileEven
+0000f9a0: 7448 616e 646c 6572 2028 7e73 6e61 7073  tHandler (~snaps
+0000f9b0: 686f 745f 7469 6d65 292e 0a20 2020 2020  hot_time)..     
+0000f9c0: 2020 2020 2020 206d 7469 6d65 5f63 6865         mtime_che
+0000f9d0: 636b 203d 2073 6e61 7073 686f 745f 7469  ck = snapshot_ti
+0000f9e0: 6d65 203e 2073 7461 742e 7374 5f6d 7469  me > stat.st_mti
+0000f9f0: 6d65 203e 206c 6173 745f 7379 6e63 0a0a  me > last_sync..
+0000fa00: 2020 2020 2020 2020 2020 2020 2320 416c              # Al
+0000fa10: 7761 7973 2075 706c 6f61 6420 756e 7472  ways upload untr
+0000fa20: 6163 6b65 6420 6974 656d 732c 2063 6865  acked items, che
+0000fa30: 636b 206d 7469 6d65 206f 6620 7472 6163  ck mtime of trac
+0000fa40: 6b65 6420 6974 656d 732e 0a20 2020 2020  ked items..     
+0000fa50: 2020 2020 2020 2069 735f 6d6f 6469 6669         is_modifi
+0000fa60: 6564 203d 206d 7469 6d65 5f63 6865 636b  ed = mtime_check
+0000fa70: 2061 6e64 206e 6f74 2069 735f 6e65 770a   and not is_new.
+0000fa80: 0a20 2020 2020 2020 2020 2020 2065 7665  .            eve
+0000fa90: 6e74 3a20 4669 6c65 5379 7374 656d 4576  nt: FileSystemEv
+0000faa0: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+0000fab0: 6576 656e 7430 3a20 4669 6c65 5379 7374  event0: FileSyst
+0000fac0: 656d 4576 656e 740a 2020 2020 2020 2020  emEvent.        
+0000fad0: 2020 2020 6576 656e 7431 3a20 4669 6c65      event1: File
+0000fae0: 5379 7374 656d 4576 656e 740a 0a20 2020  SystemEvent..   
+0000faf0: 2020 2020 2020 2020 2069 6620 6973 5f6e           if is_n
+0000fb00: 6577 3a0a 2020 2020 2020 2020 2020 2020  ew:.            
+0000fb10: 2020 2020 6966 2069 735f 6469 723a 0a20      if is_dir:. 
+0000fb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb30: 2020 2065 7665 6e74 203d 2044 6972 4372     event = DirCr
+0000fb40: 6561 7465 6445 7665 6e74 286c 6f63 616c  eatedEvent(local
+0000fb50: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+0000fb60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000fb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fb80: 2065 7665 6e74 203d 2046 696c 6543 7265   event = FileCre
+0000fb90: 6174 6564 4576 656e 7428 6c6f 6361 6c5f  atedEvent(local_
+0000fba0: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
+0000fbb0: 2020 2020 2020 6368 616e 6765 732e 6170        changes.ap
+0000fbc0: 7065 6e64 2865 7665 6e74 290a 0a20 2020  pend(event)..   
+0000fbd0: 2020 2020 2020 2020 2065 6c69 6620 6973           elif is
+0000fbe0: 5f6d 6f64 6966 6965 643a 0a20 2020 2020  _modified:.     
+0000fbf0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+0000fc00: 5f64 6972 2061 6e64 2069 6e64 6578 5f65  _dir and index_e
+0000fc10: 6e74 7279 2e69 735f 6469 7265 6374 6f72  ntry.is_director
+0000fc20: 793a 2020 2320 7479 7065 3a20 6967 6e6f  y:  # type: igno
+0000fc30: 7265 0a20 2020 2020 2020 2020 2020 2020  re.             
+0000fc40: 2020 2020 2020 2023 2057 6520 646f 6e27         # We don'
+0000fc50: 7420 656d 6974 2060 4469 724d 6f64 6966  t emit `DirModif
+0000fc60: 6965 6445 7665 6e74 6073 2e0a 2020 2020  iedEvent`s..    
+0000fc70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fc80: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+0000fc90: 2020 2020 2065 6c69 6620 6e6f 7420 6973       elif not is
+0000fca0: 5f64 6972 2061 6e64 206e 6f74 2069 6e64  _dir and not ind
+0000fcb0: 6578 5f65 6e74 7279 2e69 735f 6469 7265  ex_entry.is_dire
+0000fcc0: 6374 6f72 793a 2020 2320 7479 7065 3a20  ctory:  # type: 
+0000fcd0: 6967 6e6f 7265 0a20 2020 2020 2020 2020  ignore.         
+0000fce0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+0000fcf0: 203d 2046 696c 654d 6f64 6966 6965 6445   = FileModifiedE
+0000fd00: 7665 6e74 286c 6f63 616c 5f70 6174 6829  vent(local_path)
+0000fd10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000fd20: 2020 2020 2063 6861 6e67 6573 2e61 7070       changes.app
+0000fd30: 656e 6428 6576 656e 7429 0a20 2020 2020  end(event).     
+0000fd40: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0000fd50: 6973 5f64 6972 3a0a 2020 2020 2020 2020  is_dir:.        
+0000fd60: 2020 2020 2020 2020 2020 2020 6576 656e              even
+0000fd70: 7430 203d 2046 696c 6544 656c 6574 6564  t0 = FileDeleted
+0000fd80: 4576 656e 7428 6c6f 6361 6c5f 7061 7468  Event(local_path
+0000fd90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000fda0: 2020 2020 2020 6576 656e 7431 203d 2044        event1 = D
+0000fdb0: 6972 4372 6561 7465 6445 7665 6e74 286c  irCreatedEvent(l
+0000fdc0: 6f63 616c 5f70 6174 6829 0a20 2020 2020  ocal_path).     
+0000fdd0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0000fde0: 6861 6e67 6573 202b 3d20 5b65 7665 6e74  hanges += [event
+0000fdf0: 302c 2065 7665 6e74 315d 0a20 2020 2020  0, event1].     
+0000fe00: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0000fe10: 6e6f 7420 6973 5f64 6972 3a0a 2020 2020  not is_dir:.    
+0000fe20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fe30: 6576 656e 7430 203d 2044 6972 4465 6c65  event0 = DirDele
+0000fe40: 7465 6445 7665 6e74 286c 6f63 616c 5f70  tedEvent(local_p
+0000fe50: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+0000fe60: 2020 2020 2020 2020 2065 7665 6e74 3120           event1 
+0000fe70: 3d20 4669 6c65 4372 6561 7465 6445 7665  = FileCreatedEve
+0000fe80: 6e74 286c 6f63 616c 5f70 6174 6829 0a20  nt(local_path). 
+0000fe90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fea0: 2020 2063 6861 6e67 6573 202b 3d20 5b65     changes += [e
+0000feb0: 7665 6e74 302c 2065 7665 6e74 315d 0a0a  vent0, event1]..
+0000fec0: 2020 2020 2020 2020 2320 4765 7420 6465          # Get de
+0000fed0: 6c65 7465 6420 6974 656d 732e 0a20 2020  leted items..   
+0000fee0: 2020 2020 2066 6f72 2065 6e74 7279 2069       for entry i
+0000fef0: 6e20 7365 6c66 2e69 7465 725f 696e 6465  n self.iter_inde
+0000ff00: 7828 293a 0a20 2020 2020 2020 2020 2020  x():.           
+0000ff10: 206c 6f63 616c 5f70 6174 685f 696e 6465   local_path_inde
+0000ff20: 7865 6420 3d20 7365 6c66 2e74 6f5f 6c6f  xed = self.to_lo
+0000ff30: 6361 6c5f 7061 7468 5f66 726f 6d5f 6361  cal_path_from_ca
+0000ff40: 7365 6428 656e 7472 792e 6462 785f 7061  sed(entry.dbx_pa
+0000ff50: 7468 5f63 6173 6564 290a 2020 2020 2020  th_cased).      
+0000ff60: 2020 2020 2020 6973 5f6d 6967 6e6f 7265        is_mignore
+0000ff70: 203d 2073 656c 662e 5f69 735f 6d69 676e   = self._is_mign
+0000ff80: 6f72 655f 7061 7468 2865 6e74 7279 2e64  ore_path(entry.d
+0000ff90: 6278 5f70 6174 685f 6361 7365 642c 2065  bx_path_cased, e
+0000ffa0: 6e74 7279 2e69 735f 6469 7265 6374 6f72  ntry.is_director
+0000ffb0: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
+0000ffc0: 6966 2069 735f 6d69 676e 6f72 6520 6f72  if is_mignore or
+0000ffd0: 206e 6f74 2073 656c 662e 5f65 7869 7374   not self._exist
+0000ffe0: 735f 7769 7468 5f67 6976 656e 5f63 6173  s_with_given_cas
+0000fff0: 696e 6728 6c6f 6361 6c5f 7061 7468 5f69  ing(local_path_i
+00010000: 6e64 6578 6564 293a 0a20 2020 2020 2020  ndexed):.       
+00010010: 2020 2020 2020 2020 2069 6620 656e 7472           if entr
+00010020: 792e 6973 5f64 6972 6563 746f 7279 3a0a  y.is_directory:.
+00010030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010040: 2020 2020 6576 656e 7420 3d20 4469 7244      event = DirD
+00010050: 656c 6574 6564 4576 656e 7428 6c6f 6361  eletedEvent(loca
+00010060: 6c5f 7061 7468 5f69 6e64 6578 6564 290a  l_path_indexed).
+00010070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010080: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00010090: 2020 2020 2020 2020 2020 6576 656e 7420            event 
+000100a0: 3d20 4669 6c65 4465 6c65 7465 6445 7665  = FileDeletedEve
+000100b0: 6e74 286c 6f63 616c 5f70 6174 685f 696e  nt(local_path_in
+000100c0: 6465 7865 6429 0a20 2020 2020 2020 2020  dexed).         
+000100d0: 2020 2020 2020 2063 6861 6e67 6573 2e61         changes.a
+000100e0: 7070 656e 6428 6576 656e 7429 0a0a 2020  ppend(event)..  
+000100f0: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
+00010100: 6861 7420 7468 6520 6c6f 6361 6c20 4472  hat the local Dr
+00010110: 6f70 626f 7820 666f 6c64 6572 2073 7469  opbox folder sti
+00010120: 6c6c 2065 7869 7374 7320 6265 666f 7265  ll exists before
+00010130: 2072 6574 7572 6e69 6e67 2063 6861 6e67   returning chang
+00010140: 6573 2e0a 2020 2020 2020 2020 2320 5468  es..        # Th
+00010150: 6973 2070 7265 7665 6e74 7320 6120 6465  is prevents a de
+00010160: 6c65 7469 6f6e 206f 6620 7468 6520 4472  letion of the Dr
+00010170: 6f70 626f 7820 666f 6c64 6572 2066 726f  opbox folder fro
+00010180: 6d20 6265 696e 6720 696e 636f 7272 6563  m being incorrec
+00010190: 746c 790a 2020 2020 2020 2020 2320 7072  tly.        # pr
+000101a0: 6f63 6573 7365 6420 6173 2069 6e64 6976  ocessed as indiv
+000101b0: 6964 7561 6c20 6669 6c65 2064 656c 6574  idual file delet
+000101c0: 696f 6e73 2e0a 2020 2020 2020 2020 7365  ions..        se
+000101d0: 6c66 2e65 6e73 7572 655f 6472 6f70 626f  lf.ensure_dropbo
+000101e0: 785f 666f 6c64 6572 5f70 7265 7365 6e74  x_folder_present
+000101f0: 2829 0a0a 2020 2020 2020 2020 6475 7261  ()..        dura
+00010200: 7469 6f6e 203d 2074 696d 652e 7469 6d65  tion = time.time
+00010210: 2829 202d 2073 6e61 7073 686f 745f 7469  () - snapshot_ti
+00010220: 6d65 0a20 2020 2020 2020 2073 656c 662e  me.        self.
+00010230: 5f6c 6f67 6765 722e 6465 6275 6728 224c  _logger.debug("L
+00010240: 6f63 616c 2069 6e64 6578 696e 6720 636f  ocal indexing co
+00010250: 6d70 6c65 7465 6420 696e 2025 7320 7365  mpleted in %s se
+00010260: 6322 2c20 726f 756e 6428 6475 7261 7469  c", round(durati
+00010270: 6f6e 2c20 3429 290a 2020 2020 2020 2020  on, 4)).        
+00010280: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+00010290: 7567 2822 5265 7472 6965 7665 6420 6c6f  ug("Retrieved lo
+000102a0: 6361 6c20 6368 616e 6765 733a 5c6e 2573  cal changes:\n%s
+000102b0: 222c 2070 665f 7265 7072 2863 6861 6e67  ", pf_repr(chang
+000102c0: 6573 2929 0a0a 2020 2020 2020 2020 7265  es))..        re
+000102d0: 7475 726e 2063 6861 6e67 6573 2c20 736e  turn changes, sn
+000102e0: 6170 7368 6f74 5f74 696d 650a 0a20 2020  apshot_time..   
+000102f0: 2064 6566 205f 6578 6973 7473 5f77 6974   def _exists_wit
+00010300: 685f 6769 7665 6e5f 6361 7369 6e67 2873  h_given_casing(s
+00010310: 656c 662c 206c 6f63 616c 5f70 6174 683a  elf, local_path:
+00010320: 2073 7472 2920 2d3e 2062 6f6f 6c3a 0a20   str) -> bool:. 
+00010330: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00010340: 2020 204f 6e20 6361 7365 2d69 6e73 656e     On case-insen
+00010350: 7369 7469 7665 2062 7574 2063 6173 6520  sitive but case 
+00010360: 7072 6573 6572 7669 6e67 2066 696c 6520  preserving file 
+00010370: 7379 7374 656d 732c 2061 2060 6f73 2e70  systems, a `os.p
+00010380: 6174 682e 6578 6973 7473 600a 2020 2020  ath.exists`.    
+00010390: 2020 2020 6361 6c6c 2077 696c 6c20 7265      call will re
+000103a0: 7475 726e 2074 7275 6520 6576 656e 2069  turn true even i
+000103b0: 6620 7468 6520 6c6f 6361 6c20 6361 7369  f the local casi
+000103c0: 6e67 2064 6966 6665 7273 2066 726f 6d20  ng differs from 
+000103d0: 7468 650a 2020 2020 2020 2020 696e 6465  the.        inde
+000103e0: 7865 6420 6361 7369 6e67 2e20 5468 6973  xed casing. This
+000103f0: 206d 6574 686f 6420 7265 7475 726e 7320   method returns 
+00010400: 4661 6c73 6520 6966 2074 6865 2064 6973  False if the dis
+00010410: 706c 6179 2063 6173 696e 6720 6469 6666  play casing diff
+00010420: 6572 7320 6672 6f6d 2074 6865 0a20 2020  ers from the.   
+00010430: 2020 2020 2067 6976 656e 2069 6e70 7574       given input
+00010440: 2c20 6576 656e 2069 6620 7061 7468 7320  , even if paths 
+00010450: 7265 6665 7220 746f 2074 6865 2073 616d  refer to the sam
+00010460: 6520 6669 6c65 2e0a 2020 2020 2020 2020  e file..        
+00010470: 2222 220a 2020 2020 2020 2020 6966 2073  """.        if s
+00010480: 656c 662e 6973 5f66 735f 6361 7365 5f73  elf.is_fs_case_s
+00010490: 656e 7369 7469 7665 3a0a 2020 2020 2020  ensitive:.      
+000104a0: 2020 2020 2020 7265 7475 726e 2065 7869        return exi
+000104b0: 7374 7328 6c6f 6361 6c5f 7061 7468 290a  sts(local_path).
+000104c0: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
+000104d0: 6578 6973 7473 286c 6f63 616c 5f70 6174  exists(local_pat
+000104e0: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
+000104f0: 7265 7475 726e 2046 616c 7365 0a0a 2020  return False..  
+00010500: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00010510: 2020 2020 2020 206c 6f63 616c 5f70 6174         local_pat
+00010520: 685f 6469 7370 6c61 7965 6420 3d20 746f  h_displayed = to
+00010530: 5f65 7869 7374 696e 675f 756e 6e6f 726d  _existing_unnorm
+00010540: 616c 697a 6564 5f70 6174 6828 6c6f 6361  alized_path(loca
+00010550: 6c5f 7061 7468 290a 2020 2020 2020 2020  l_path).        
+00010560: 2020 2020 7265 7475 726e 206c 6f63 616c      return local
+00010570: 5f70 6174 685f 6469 7370 6c61 7965 6420  _path_displayed 
+00010580: 3d3d 206c 6f63 616c 5f70 6174 680a 2020  == local_path.  
+00010590: 2020 2020 2020 6578 6365 7074 2028 4669        except (Fi
+000105a0: 6c65 4e6f 7446 6f75 6e64 4572 726f 722c  leNotFoundError,
+000105b0: 204e 6f74 4144 6972 6563 746f 7279 4572   NotADirectoryEr
+000105c0: 726f 7229 3a0a 2020 2020 2020 2020 2020  ror):.          
+000105d0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
+000105e0: 2020 2020 6465 6620 7761 6974 5f66 6f72      def wait_for
+000105f0: 5f6c 6f63 616c 5f63 6861 6e67 6573 2873  _local_changes(s
+00010600: 656c 662c 2074 696d 656f 7574 3a20 666c  elf, timeout: fl
+00010610: 6f61 7420 3d20 3430 2920 2d3e 2062 6f6f  oat = 40) -> boo
+00010620: 6c3a 0a20 2020 2020 2020 2022 2222 0a20  l:.        """. 
+00010630: 2020 2020 2020 2042 6c6f 636b 7320 756e         Blocks un
+00010640: 7469 6c20 6c6f 6361 6c20 6368 616e 6765  til local change
+00010650: 7320 6172 6520 6176 6169 6c61 626c 652e  s are available.
+00010660: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00010670: 2074 696d 656f 7574 3a20 4d61 7869 6d75   timeout: Maximu
+00010680: 6d20 7469 6d65 2069 6e20 7365 636f 6e64  m time in second
+00010690: 7320 746f 2077 6169 742e 0a20 2020 2020  s to wait..     
+000106a0: 2020 203a 7265 7475 726e 733a 2060 6054     :returns: ``T
+000106b0: 7275 6560 6020 6966 2063 6861 6e67 6573  rue`` if changes
+000106c0: 2061 7265 2061 7661 696c 6162 6c65 2c20   are available, 
+000106d0: 6060 4661 6c73 6560 6020 6f74 6865 7277  ``False`` otherw
+000106e0: 6973 652e 0a20 2020 2020 2020 2022 2222  ise..        """
+000106f0: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+00010700: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
+00010710: 2020 2020 2020 2020 2022 5761 6974 696e           "Waitin
+00010720: 6720 666f 7220 6c6f 6361 6c20 6368 616e  g for local chan
+00010730: 6765 7320 7369 6e63 6520 6375 7273 6f72  ges since cursor
+00010740: 3a20 2573 222c 2073 656c 662e 6c6f 6361  : %s", self.loca
+00010750: 6c5f 6375 7273 6f72 0a20 2020 2020 2020  l_cursor.       
+00010760: 2029 0a20 2020 2020 2020 2072 6574 7572   ).        retur
+00010770: 6e20 7365 6c66 2e66 735f 6576 656e 7473  n self.fs_events
+00010780: 2e77 6169 745f 666f 725f 6576 656e 7428  .wait_for_event(
+00010790: 7469 6d65 6f75 7429 0a0a 2020 2020 6465  timeout)..    de
+000107a0: 6620 7570 6c6f 6164 5f73 796e 635f 6379  f upload_sync_cy
+000107b0: 636c 6528 7365 6c66 2920 2d3e 204e 6f6e  cle(self) -> Non
+000107c0: 653a 0a20 2020 2020 2020 2022 2222 0a20  e:.        """. 
+000107d0: 2020 2020 2020 2050 6572 666f 726d 7320         Performs 
+000107e0: 6120 6675 6c6c 2075 706c 6f61 6420 7379  a full upload sy
+000107f0: 6e63 2063 7963 6c65 2062 7920 6361 6c6c  nc cycle by call
+00010800: 696e 6720 696e 206f 7264 6572 3a0a 0a20  ing in order:.. 
+00010810: 2020 2020 2020 2020 2020 2031 2920 3a6d             1) :m
+00010820: 6574 683a 606c 6973 745f 6c6f 6361 6c5f  eth:`list_local_
+00010830: 6368 616e 6765 7360 0a20 2020 2020 2020  changes`.       
+00010840: 2020 2020 2032 2920 3a6d 6574 683a 6061       2) :meth:`a
+00010850: 7070 6c79 5f6c 6f63 616c 5f63 6861 6e67  pply_local_chang
+00010860: 6573 600a 0a20 2020 2020 2020 2048 616e  es`..        Han
+00010870: 646c 6573 2075 7064 6174 696e 6720 7468  dles updating th
+00010880: 6520 6c6f 6361 6c20 6375 7273 6f72 2066  e local cursor f
+00010890: 6f72 2079 6f75 2e20 4966 206d 6f6e 6974  or you. If monit
+000108a0: 6f72 696e 6720 666f 7220 6c6f 6361 6c20  oring for local 
+000108b0: 6669 6c65 2065 7665 6e74 730a 2020 2020  file events.    
+000108c0: 2020 2020 7761 7320 696e 7465 7272 7570      was interrup
+000108d0: 7465 642c 2063 616c 6c20 3a6d 6574 683a  ted, call :meth:
+000108e0: 6075 706c 6f61 645f 6c6f 6361 6c5f 6368  `upload_local_ch
+000108f0: 616e 6765 735f 7768 696c 655f 696e 6163  anges_while_inac
+00010900: 7469 7665 6020 696e 7374 6561 642e 0a20  tive` instead.. 
+00010910: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+00010920: 2020 2077 6974 6820 7365 6c66 2e73 796e     with self.syn
+00010930: 635f 6c6f 636b 3a0a 2020 2020 2020 2020  c_lock:.        
+00010940: 2020 2020 6368 616e 6765 732c 2063 7572      changes, cur
+00010950: 736f 7220 3d20 7365 6c66 2e6c 6973 745f  sor = self.list_
+00010960: 6c6f 6361 6c5f 6368 616e 6765 7328 290a  local_changes().
+00010970: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00010980: 2e61 7070 6c79 5f6c 6f63 616c 5f63 6861  .apply_local_cha
+00010990: 6e67 6573 2863 6861 6e67 6573 290a 0a20  nges(changes).. 
+000109a0: 2020 2020 2020 2020 2020 2063 6f6e 666c             confl
+000109b0: 6963 7473 203d 205b 6520 666f 7220 6520  icts = [e for e 
+000109c0: 696e 2063 6861 6e67 6573 2069 6620 652e  in changes if e.
+000109d0: 7374 6174 7573 2069 7320 5379 6e63 5374  status is SyncSt
+000109e0: 6174 7573 2e43 6f6e 666c 6963 745d 0a20  atus.Conflict]. 
+000109f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00010a00: 6e6f 7469 6679 5f75 7365 7228 636f 6e66  notify_user(conf
+00010a10: 6c69 6374 7329 0a0a 2020 2020 2020 2020  licts)..        
+00010a20: 2020 2020 7365 6c66 2e6c 6f63 616c 5f63      self.local_c
+00010a30: 7572 736f 7220 3d20 6375 7273 6f72 0a0a  ursor = cursor..
+00010a40: 2020 2020 2020 2020 2020 2020 2320 4672              # Fr
+00010a50: 6565 206d 656d 6f72 7920 6561 726c 7920  ee memory early 
+00010a60: 746f 2070 7265 7665 6e74 2066 7261 676d  to prevent fragm
+00010a70: 656e 7461 7469 6f6e 2e0a 2020 2020 2020  entation..      
+00010a80: 2020 2020 2020 6465 6c20 6368 616e 6765        del change
+00010a90: 730a 2020 2020 2020 2020 2020 2020 7365  s.            se
+00010aa0: 6c66 2e5f 636c 6561 725f 6361 6368 6573  lf._clear_caches
+00010ab0: 2829 0a20 2020 2020 2020 2020 2020 2067  ().            g
+00010ac0: 632e 636f 6c6c 6563 7428 290a 0a20 2020  c.collect()..   
+00010ad0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00010ae0: 2e5f 6361 6e63 656c 5f72 6571 7565 7374  ._cancel_request
+00010af0: 6564 2e69 735f 7365 7428 293a 0a20 2020  ed.is_set():.   
+00010b00: 2020 2020 2020 2020 2020 2020 2072 6169               rai
+00010b10: 7365 2043 616e 6365 6c6c 6564 4572 726f  se CancelledErro
+00010b20: 7228 2253 796e 6320 6361 6e63 656c 6c65  r("Sync cancelle
+00010b30: 6422 290a 0a20 2020 2064 6566 206c 6973  d")..    def lis
+00010b40: 745f 6c6f 6361 6c5f 6368 616e 6765 7328  t_local_changes(
+00010b50: 7365 6c66 2c20 6465 6c61 793a 2066 6c6f  self, delay: flo
+00010b60: 6174 203d 2031 2920 2d3e 2074 7570 6c65  at = 1) -> tuple
+00010b70: 5b6c 6973 745b 5379 6e63 4576 656e 745d  [list[SyncEvent]
+00010b80: 2c20 666c 6f61 745d 3a0a 2020 2020 2020  , float]:.      
+00010b90: 2020 2222 220a 2020 2020 2020 2020 5265    """.        Re
+00010ba0: 7475 726e 7320 6120 6c69 7374 206f 6620  turns a list of 
+00010bb0: 6c6f 6361 6c20 6368 616e 6765 7320 7769  local changes wi
+00010bc0: 7468 2061 7420 6d6f 7374 206f 6e65 2065  th at most one e
+00010bd0: 6e74 7279 2070 6572 2070 6174 682e 0a0a  ntry per path...
+00010be0: 2020 2020 2020 2020 3a70 6172 616d 2064          :param d
+00010bf0: 656c 6179 3a20 4465 6c61 7920 696e 2073  elay: Delay in s
+00010c00: 6563 2074 6f20 7761 6974 2066 6f72 2073  ec to wait for s
+00010c10: 7562 7365 7175 656e 7420 6368 616e 6765  ubsequent change
+00010c20: 7320 6265 666f 7265 2072 6574 7572 6e69  s before returni
+00010c30: 6e67 2e0a 2020 2020 2020 2020 3a72 6574  ng..        :ret
+00010c40: 7572 6e73 3a20 286c 6973 7420 6f66 2073  urns: (list of s
+00010c50: 796e 6320 7469 6d65 7320 6576 656e 7473  ync times events
+00010c60: 2c20 7469 6d65 5f73 7461 6d70 290a 2020  , time_stamp).  
+00010c70: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00010c80: 2020 6576 656e 7473 203d 205b 5d0a 2020    events = [].  
+00010c90: 2020 2020 2020 6c6f 6361 6c5f 6375 7273        local_curs
+00010ca0: 6f72 203d 2074 696d 652e 7469 6d65 2829  or = time.time()
+00010cb0: 0a0a 2020 2020 2020 2020 2320 4b65 6570  ..        # Keep
+00010cc0: 2063 6f6c 6c65 6374 696e 6720 6576 656e   collecting even
+00010cd0: 7473 2075 6e74 696c 2069 646c 6520 666f  ts until idle fo
+00010ce0: 7220 6064 656c 6179 602e 0a20 2020 2020  r `delay`..     
+00010cf0: 2020 2077 6869 6c65 2054 7275 653a 0a20     while True:. 
+00010d00: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
+00010d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d20: 6576 656e 7420 3d20 7365 6c66 2e66 735f  event = self.fs_
+00010d30: 6576 656e 7473 2e6c 6f63 616c 5f66 696c  events.local_fil
+00010d40: 655f 6576 656e 745f 7175 6575 652e 6765  e_event_queue.ge
+00010d50: 7428 7469 6d65 6f75 743d 6465 6c61 7929  t(timeout=delay)
+00010d60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010d70: 2065 7665 6e74 732e 6170 7065 6e64 2865   events.append(e
+00010d80: 7665 6e74 290a 2020 2020 2020 2020 2020  vent).          
+00010d90: 2020 2020 2020 6c6f 6361 6c5f 6375 7273        local_curs
+00010da0: 6f72 203d 2074 696d 652e 7469 6d65 2829  or = time.time()
+00010db0: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00010dc0: 6570 7420 456d 7074 793a 0a20 2020 2020  ept Empty:.     
+00010dd0: 2020 2020 2020 2020 2020 2062 7265 616b             break
+00010de0: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+00010df0: 6c6f 6767 6572 2e64 6562 7567 2822 5265  logger.debug("Re
+00010e00: 7472 6965 7665 6420 6c6f 6361 6c20 6669  trieved local fi
+00010e10: 6c65 2065 7665 6e74 733a 5c6e 2573 222c  le events:\n%s",
+00010e20: 2070 665f 7265 7072 2865 7665 6e74 7329   pf_repr(events)
+00010e30: 290a 0a20 2020 2020 2020 2065 7665 6e74  )..        event
+00010e40: 7320 3d20 7365 6c66 2e5f 636c 6561 6e5f  s = self._clean_
+00010e50: 6c6f 6361 6c5f 6576 656e 7473 2865 7665  local_events(eve
+00010e60: 6e74 7329 0a20 2020 2020 2020 2073 796e  nts).        syn
+00010e70: 635f 6576 656e 7473 203d 2073 656c 662e  c_events = self.
+00010e80: 5f73 796e 635f 6576 656e 7473 5f66 726f  _sync_events_fro
+00010e90: 6d5f 6673 5f65 7665 6e74 7328 6576 656e  m_fs_events(even
+00010ea0: 7473 290a 0a20 2020 2020 2020 2023 2046  ts)..        # F
+00010eb0: 7265 6520 6d65 6d6f 7279 2065 6172 6c79  ree memory early
+00010ec0: 2074 6f20 7072 6576 656e 7420 6672 6167   to prevent frag
+00010ed0: 6d65 6e74 6174 696f 6e2e 0a20 2020 2020  mentation..     
+00010ee0: 2020 2064 656c 2065 7665 6e74 730a 2020     del events.  
+00010ef0: 2020 2020 2020 6763 2e63 6f6c 6c65 6374        gc.collect
+00010f00: 2829 0a0a 2020 2020 2020 2020 7265 7475  ()..        retu
+00010f10: 726e 2073 796e 635f 6576 656e 7473 2c20  rn sync_events, 
+00010f20: 6c6f 6361 6c5f 6375 7273 6f72 0a0a 2020  local_cursor..  
+00010f30: 2020 6465 6620 6170 706c 795f 6c6f 6361    def apply_loca
+00010f40: 6c5f 6368 616e 6765 7328 0a20 2020 2020  l_changes(.     
+00010f50: 2020 2073 656c 662c 2073 796e 635f 6576     self, sync_ev
+00010f60: 656e 7473 3a20 436f 6c6c 6563 7469 6f6e  ents: Collection
+00010f70: 5b53 796e 6345 7665 6e74 5d0a 2020 2020  [SyncEvent].    
+00010f80: 2920 2d3e 206c 6973 745b 5379 6e63 4576  ) -> list[SyncEv
+00010f90: 656e 745d 3a0a 2020 2020 2020 2020 2222  ent]:.        ""
+00010fa0: 220a 2020 2020 2020 2020 4170 706c 6965  ".        Applie
+00010fb0: 7320 6c6f 6361 6c6c 7920 6465 7465 6374  s locally detect
+00010fc0: 6564 2063 6861 6e67 6573 2074 6f20 7468  ed changes to th
+00010fd0: 6520 7265 6d6f 7465 2044 726f 7062 6f78  e remote Dropbox
+00010fe0: 2e20 4368 616e 6765 7320 7768 6963 6820  . Changes which 
+00010ff0: 7368 6f75 6c64 2062 650a 2020 2020 2020  should be.      
+00011000: 2020 6967 6e6f 7265 6420 286d 6967 6e6f    ignored (migno
+00011010: 7265 206f 7220 616c 7761 7973 2069 676e  re or always ign
+00011020: 6f72 6564 2066 696c 6573 2920 6172 6520  ored files) are 
+00011030: 736b 6970 7065 642e 0a0a 2020 2020 2020  skipped...      
+00011040: 2020 3a70 6172 616d 2073 796e 635f 6576    :param sync_ev
+00011050: 656e 7473 3a20 4c69 7374 206f 6620 6c6f  ents: List of lo
+00011060: 6361 6c20 6669 6c65 2073 7973 7465 6d20  cal file system 
+00011070: 6576 656e 7473 2e0a 2020 2020 2020 2020  events..        
+00011080: 2222 220a 2020 2020 2020 2020 7265 7375  """.        resu
+00011090: 6c74 733a 206c 6973 745b 5379 6e63 4576  lts: list[SyncEv
+000110a0: 656e 745d 203d 205b 5d0a 0a20 2020 2020  ent] = []..     
+000110b0: 2020 2069 6620 6c65 6e28 7379 6e63 5f65     if len(sync_e
+000110c0: 7665 6e74 7329 203d 3d20 303a 0a20 2020  vents) == 0:.   
+000110d0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+000110e0: 7265 7375 6c74 730a 0a20 2020 2020 2020  results..       
+000110f0: 2023 2053 6f72 7420 616c 6c20 7379 6e63   # Sort all sync
+00011100: 2065 7665 6e74 7320 696e 746f 2064 656c   events into del
+00011110: 6574 6564 2c20 6469 725f 6d6f 7665 6420  eted, dir_moved 
+00011120: 616e 6420 6f74 6865 722e 2044 6973 6361  and other. Disca
+00011130: 7264 2069 7465 6d73 0a20 2020 2020 2020  rd items.       
+00011140: 2023 2077 6869 6368 2061 7265 2065 7863   # which are exc
+00011150: 6c75 6465 6420 6279 206d 6967 6e6f 7265  luded by mignore
+00011160: 206f 7220 7468 6520 696e 7465 726e 616c   or the internal
+00011170: 2065 7863 6c75 7369 6f6e 206c 6973 742e   exclusion list.
+00011180: 2044 656c 6574 6564 2061 6e64 0a20 2020   Deleted and.   
+00011190: 2020 2020 2023 2064 6972 5f6d 6f76 6564       # dir_moved
+000111a0: 2065 7665 6e74 7320 7769 6c6c 206e 6576   events will nev
+000111b0: 6572 2062 6520 6e65 7374 6564 2028 7765  er be nested (we
+000111c0: 2068 6176 6520 616c 7265 6164 7920 636f   have already co
+000111d0: 6d62 696e 6564 2073 7563 6820 6e65 7374  mbined such nest
+000111e0: 6564 0a20 2020 2020 2020 2023 2065 7665  ed.        # eve
+000111f0: 6e74 7329 2062 7574 2061 6c6c 206f 7468  nts) but all oth
+00011200: 6572 2065 7665 6e74 7320 6d69 6768 7420  er events might 
+00011210: 6265 2e20 5765 206f 7264 6572 2061 6e64  be. We order and
+00011220: 2061 7070 6c79 2074 6865 6d20 6869 6572   apply them hier
+00011230: 6172 6368 6963 616c 6c79 2e0a 0a20 2020  archically...   
+00011240: 2020 2020 2064 656c 6574 6564 3a20 6c69       deleted: li
+00011250: 7374 5b53 796e 6345 7665 6e74 5d20 3d20  st[SyncEvent] = 
+00011260: 5b5d 0a20 2020 2020 2020 2064 6972 5f6d  [].        dir_m
+00011270: 6f76 6564 3a20 6c69 7374 5b53 796e 6345  oved: list[SyncE
+00011280: 7665 6e74 5d20 3d20 5b5d 0a20 2020 2020  vent] = [].     
+00011290: 2020 206f 7468 6572 3a20 6465 6661 756c     other: defaul
+000112a0: 7464 6963 745b 696e 742c 206c 6973 745b  tdict[int, list[
+000112b0: 5379 6e63 4576 656e 745d 5d20 3d20 6465  SyncEvent]] = de
+000112c0: 6661 756c 7464 6963 7428 6c69 7374 290a  faultdict(list).
+000112d0: 0a20 2020 2020 2020 2066 6f72 2065 7665  .        for eve
+000112e0: 6e74 2069 6e20 7379 6e63 5f65 7665 6e74  nt in sync_event
+000112f0: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
+00011300: 6620 7365 6c66 2e69 735f 6578 636c 7564  f self.is_exclud
+00011310: 6564 2865 7665 6e74 2e6c 6f63 616c 5f70  ed(event.local_p
+00011320: 6174 6829 206f 7220 7365 6c66 2e69 735f  ath) or self.is_
+00011330: 6d69 676e 6f72 6528 6576 656e 7429 3a0a  mignore(event):.
+00011340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011350: 636f 6e74 696e 7565 0a0a 2020 2020 2020  continue..      
+00011360: 2020 2020 2020 6966 2065 7665 6e74 2e69        if event.i
+00011370: 735f 6465 6c65 7465 643a 0a20 2020 2020  s_deleted:.     
+00011380: 2020 2020 2020 2020 2020 2064 656c 6574             delet
+00011390: 6564 2e61 7070 656e 6428 6576 656e 7429  ed.append(event)
+000113a0: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+000113b0: 6620 6576 656e 742e 6973 5f64 6972 6563  f event.is_direc
+000113c0: 746f 7279 2061 6e64 2065 7665 6e74 2e69  tory and event.i
+000113d0: 735f 6d6f 7665 643a 0a20 2020 2020 2020  s_moved:.       
+000113e0: 2020 2020 2020 2020 2064 6972 5f6d 6f76           dir_mov
+000113f0: 6564 2e61 7070 656e 6428 6576 656e 7429  ed.append(event)
+00011400: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00011410: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00011420: 2020 206c 6576 656c 203d 2065 7665 6e74     level = event
+00011430: 2e64 6278 5f70 6174 682e 636f 756e 7428  .dbx_path.count(
+00011440: 222f 2229 0a20 2020 2020 2020 2020 2020  "/").           
+00011450: 2020 2020 206f 7468 6572 5b6c 6576 656c       other[level
+00011460: 5d2e 6170 7065 6e64 2865 7665 6e74 290a  ].append(event).
+00011470: 0a20 2020 2020 2020 2020 2020 2023 2048  .            # H
+00011480: 6f75 7365 6b65 6570 696e 672e 0a20 2020  ousekeeping..   
+00011490: 2020 2020 2020 2020 2073 656c 662e 6163           self.ac
+000114a0: 7469 7669 7479 2e61 6464 2865 7665 6e74  tivity.add(event
+000114b0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
+000114c0: 5f6c 6f67 6765 722e 6465 6275 6728 2246  _logger.debug("F
+000114d0: 696c 7465 7265 6420 6465 6c65 7465 6420  iltered deleted 
+000114e0: 6576 656e 7473 3a5c 6e25 7322 2c20 7066  events:\n%s", pf
+000114f0: 5f72 6570 7228 6465 6c65 7465 6429 290a  _repr(deleted)).
+00011500: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00011510: 6767 6572 2e64 6562 7567 2822 4669 6c74  gger.debug("Filt
+00011520: 6572 6564 2064 6972 206d 6f76 6564 2065  ered dir moved e
+00011530: 7665 6e74 733a 5c6e 2573 222c 2070 665f  vents:\n%s", pf_
+00011540: 7265 7072 2864 6972 5f6d 6f76 6564 2929  repr(dir_moved))
+00011550: 0a20 2020 2020 2020 2073 656c 662e 5f6c  .        self._l
+00011560: 6f67 6765 722e 6465 6275 6728 2246 696c  ogger.debug("Fil
+00011570: 7465 7265 6420 6f74 6865 7220 6576 656e  tered other even
+00011580: 7473 3a5c 6e25 7322 2c20 7066 5f72 6570  ts:\n%s", pf_rep
+00011590: 7228 6f74 6865 7229 290a 0a20 2020 2020  r(other))..     
+000115a0: 2020 2023 2041 7070 6c79 2064 656c 6574     # Apply delet
+000115b0: 6564 2065 7665 6e74 7320 6669 7273 742c  ed events first,
+000115c0: 2066 6f6c 6465 7220 6d6f 7665 6420 6576   folder moved ev
+000115d0: 656e 7473 2073 6563 6f6e 642e 0a20 2020  ents second..   
+000115e0: 2020 2020 2023 204e 6569 7468 6572 2065       # Neither e
+000115f0: 7665 6e74 2074 7970 6520 7265 7175 6972  vent type requir
+00011600: 6573 2061 6e20 6163 7475 616c 2075 706c  es an actual upl
+00011610: 6f61 642e 0a20 2020 2020 2020 2069 6620  oad..        if 
+00011620: 6465 6c65 7465 643a 0a20 2020 2020 2020  deleted:.       
+00011630: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+00011640: 722e 696e 666f 2822 5570 6c6f 6164 696e  r.info("Uploadin
+00011650: 6720 6465 6c65 7469 6f6e 732e 2e2e 2229  g deletions...")
+00011660: 0a0a 2020 2020 2020 2020 7265 7320 3d20  ..        res = 
+00011670: 646f 5f70 6172 616c 6c65 6c28 0a20 2020  do_parallel(.   
+00011680: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
 00011690: 7265 6174 655f 7265 6d6f 7465 5f65 6e74  reate_remote_ent
-000116a0: 7279 2865 7665 6e74 290a 2020 2020 2020  ry(event).      
-000116b0: 2020 2020 2020 7265 7375 6c74 732e 6170        results.ap
-000116c0: 7065 6e64 2872 290a 0a20 2020 2020 2020  pend(r)..       
-000116d0: 2023 2041 7070 6c79 206f 7468 6572 2065   # Apply other e
-000116e0: 7665 6e74 7320 696e 2070 6172 616c 6c65  vents in paralle
-000116f0: 6c2c 2070 726f 6365 7373 696e 6720 6561  l, processing ea
-00011700: 6368 2068 6965 7261 7263 6879 206c 6576  ch hierarchy lev
-00011710: 656c 2073 7563 6365 7373 6976 656c 792e  el successively.
-00011720: 0a20 2020 2020 2020 2066 6f72 206c 6576  .        for lev
-00011730: 656c 2069 6e20 736f 7274 6564 286f 7468  el in sorted(oth
-00011740: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
-00011750: 2072 6573 203d 2064 6f5f 7061 7261 6c6c   res = do_parall
-00011760: 656c 280a 2020 2020 2020 2020 2020 2020  el(.            
-00011770: 2020 2020 7365 6c66 2e5f 6372 6561 7465      self._create
-00011780: 5f72 656d 6f74 655f 656e 7472 792c 0a20  _remote_entry,. 
-00011790: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000117a0: 7468 6572 5b6c 6576 656c 5d2c 0a20 2020  ther[level],.   
-000117b0: 2020 2020 2020 2020 2020 2020 206f 6e5f               on_
-000117c0: 7072 6f67 7265 7373 3d6c 616d 6264 6120  progress=lambda 
-000117d0: 782c 2079 3a20 7365 6c66 2e5f 6c6f 6767  x, y: self._logg
-000117e0: 6572 2e69 6e66 6f28 6622 5379 6e63 696e  er.info(f"Syncin
-000117f0: 6720 e286 9120 7b78 7d2f 7b79 7d22 292c  g ... {x}/{y}"),
-00011800: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00011810: 2074 6872 6561 645f 6e61 6d65 5f70 7265   thread_name_pre
-00011820: 6669 783d 226d 6165 7374 7261 6c2d 7570  fix="maestral-up
-00011830: 6c6f 6164 2d70 6f6f 6c22 2c0a 2020 2020  load-pool",.    
-00011840: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00011850: 2020 2020 2020 7265 7375 6c74 732e 6578        results.ex
-00011860: 7465 6e64 2872 6573 290a 0a20 2020 2020  tend(res)..     
-00011870: 2020 2073 656c 662e 5f63 6c65 616e 5f68     self._clean_h
-00011880: 6973 746f 7279 2829 0a0a 2020 2020 2020  istory()..      
-00011890: 2020 7265 7475 726e 2072 6573 756c 7473    return results
-000118a0: 0a0a 2020 2020 6465 6620 5f63 6c65 616e  ..    def _clean
-000118b0: 5f6c 6f63 616c 5f65 7665 6e74 7328 0a20  _local_events(. 
-000118c0: 2020 2020 2020 2073 656c 662c 2065 7665         self, eve
-000118d0: 6e74 733a 2043 6f6c 6c65 6374 696f 6e5b  nts: Collection[
-000118e0: 4669 6c65 5379 7374 656d 4576 656e 745d  FileSystemEvent]
-000118f0: 0a20 2020 2029 202d 3e20 6c69 7374 5b46  .    ) -> list[F
-00011900: 696c 6553 7973 7465 6d45 7665 6e74 5d3a  ileSystemEvent]:
-00011910: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00011920: 2020 2020 2054 616b 6573 206c 6f63 616c       Takes local
-00011930: 2066 696c 6520 6576 656e 7473 2061 6e64   file events and
-00011940: 2063 6c65 616e 7320 7468 656d 2075 7020   cleans them up 
-00011950: 6173 2066 6f6c 6c6f 7773 3a0a 0a20 2020  as follows:..   
-00011960: 2020 2020 2031 2920 4b65 6570 206f 6e6c       1) Keep onl
-00011970: 7920 6120 7369 6e67 6c65 2065 7665 6e74  y a single event
-00011980: 2070 6572 2070 6174 682c 2075 6e6c 6573   per path, unles
-00011990: 7320 7468 6520 6974 656d 2074 7970 6520  s the item type 
-000119a0: 6368 616e 6765 6420 2865 2e67 2e2c 2066  changed (e.g., f
-000119b0: 726f 6d0a 2020 2020 2020 2020 2020 2066  rom.           f
-000119c0: 696c 6520 746f 2066 6f6c 6465 7229 2e0a  ile to folder)..
-000119d0: 2020 2020 2020 2020 3229 2043 6f6c 6c61          2) Colla
-000119e0: 7073 6573 206d 6f76 6564 2061 6e64 2064  pses moved and d
-000119f0: 656c 6574 6564 2065 7665 6e74 7320 6f66  eleted events of
-00011a00: 2066 6f6c 6465 7273 2077 6974 6820 7468   folders with th
-00011a10: 6f73 6520 6f66 2074 6865 6972 2063 6869  ose of their chi
-00011a20: 6c64 7265 6e2e 0a0a 2020 2020 2020 2020  ldren...        
-00011a30: 5468 6520 6f72 6465 7220 6f66 2065 7665  The order of eve
-00011a40: 6e74 7320 7769 6c6c 2062 6520 7072 6573  nts will be pres
-00011a50: 6572 7665 6420 6163 636f 7264 696e 6720  erved according 
-00011a60: 746f 2074 6865 2066 6972 7374 2065 7665  to the first eve
-00011a70: 6e74 2072 6567 6973 7465 7265 640a 2020  nt registered.  
-00011a80: 2020 2020 2020 666f 7220 7468 6174 2070        for that p
-00011a90: 6174 682e 0a0a 2020 2020 2020 2020 3a70  ath...        :p
-00011aa0: 6172 616d 2065 7665 6e74 733a 2049 7465  aram events: Ite
-00011ab0: 7261 626c 6520 6f66 203a 636c 6173 733a  rable of :class:
-00011ac0: 6077 6174 6368 646f 672e 4669 6c65 5379  `watchdog.FileSy
-00011ad0: 7374 656d 4576 656e 7460 2e0a 2020 2020  stemEvent`..    
-00011ae0: 2020 2020 3a72 6574 7572 6e73 3a20 4c69      :returns: Li
-00011af0: 7374 206f 6620 3a63 6c61 7373 3a60 7761  st of :class:`wa
-00011b00: 7463 6864 6f67 2e46 696c 6553 7973 7465  tchdog.FileSyste
-00011b10: 6d45 7665 6e74 602e 0a20 2020 2020 2020  mEvent`..       
-00011b20: 2022 2222 0a20 2020 2020 2020 2023 2043   """.        # C
-00011b30: 4f4d 4249 4e45 2045 5645 4e54 5320 544f  OMBINE EVENTS TO
-00011b40: 204f 4e45 2045 5645 4e54 2050 4552 2050   ONE EVENT PER P
-00011b50: 4154 480a 0a20 2020 2020 2020 2023 204d  ATH..        # M
-00011b60: 6f76 6520 6576 656e 7473 2061 7265 2064  ove events are d
-00011b70: 6966 6669 6375 6c74 2074 6f20 636f 6d62  ifficult to comb
-00011b80: 696e 6520 7769 7468 206f 7468 6572 2065  ine with other e
-00011b90: 7665 6e74 2074 7970 6573 2c20 7765 2073  vent types, we s
-00011ba0: 706c 6974 2074 6865 6d0a 2020 2020 2020  plit them.      
-00011bb0: 2020 2320 696e 746f 2064 656c 6574 6564    # into deleted
-00011bc0: 2061 6e64 2063 7265 6174 6564 2065 7665   and created eve
-00011bd0: 6e74 7320 616e 6420 7265 636f 6d62 696e  nts and recombin
-00011be0: 6520 7468 656d 206c 6174 6572 2069 6620  e them later if 
-00011bf0: 6e65 6974 6865 7220 7468 6520 736f 7572  neither the sour
-00011c00: 6365 0a20 2020 2020 2020 2023 206f 6620  ce.        # of 
-00011c10: 7468 6520 6465 7374 696e 6174 696f 6e20  the destination 
-00011c20: 7061 7468 206f 6620 6861 7320 6f74 6865  path of has othe
-00011c30: 7220 6576 656e 7473 2061 7373 6f63 6961  r events associa
-00011c40: 7465 6420 7769 7468 2069 7420 6f72 2069  ted with it or i
-00011c50: 7320 6578 636c 7564 6564 0a20 2020 2020  s excluded.     
-00011c60: 2020 2023 2066 726f 6d20 7379 6e63 2e0a     # from sync..
-00011c70: 0a20 2020 2020 2020 2023 206d 6170 7069  .        # mappi
-00011c80: 6e67 206f 6620 7061 7468 202d 3e20 6576  ng of path -> ev
-00011c90: 656e 7420 6869 7374 6f72 790a 2020 2020  ent history.    
-00011ca0: 2020 2020 6576 656e 7473 5f66 6f72 5f70      events_for_p
-00011cb0: 6174 683a 2064 6566 6175 6c74 6469 6374  ath: defaultdict
-00011cc0: 5b73 7472 2c20 6c69 7374 5b46 696c 6553  [str, list[FileS
-00011cd0: 7973 7465 6d45 7665 6e74 5d5d 203d 2064  ystemEvent]] = d
-00011ce0: 6566 6175 6c74 6469 6374 286c 6973 7429  efaultdict(list)
-00011cf0: 0a0a 2020 2020 2020 2020 2320 6d61 7070  ..        # mapp
-00011d00: 696e 6720 6f66 2073 6f75 7263 6520 6465  ing of source de
-00011d10: 6c65 7469 6f6e 2065 7665 6e74 202d 3e20  letion event -> 
-00011d20: 6465 7374 696e 6174 696f 6e20 6372 6561  destination crea
-00011d30: 7469 6f6e 2065 7665 6e74 0a20 2020 2020  tion event.     
-00011d40: 2020 206d 6f76 6564 5f66 726f 6d5f 746f     moved_from_to
-00011d50: 3a20 6469 6374 5b46 696c 6553 7973 7465  : dict[FileSyste
-00011d60: 6d45 7665 6e74 2c20 4669 6c65 5379 7374  mEvent, FileSyst
-00011d70: 656d 4576 656e 745d 203d 207b 7d0a 2020  emEvent] = {}.  
-00011d80: 2020 2020 2020 6d6f 7665 645f 6576 656e        moved_even
-00011d90: 7473 5f74 6f5f 7265 636f 6d62 696e 653a  ts_to_recombine:
-00011da0: 206c 6973 745b 4669 6c65 5379 7374 656d   list[FileSystem
-00011db0: 4576 656e 745d 203d 205b 5d0a 0a20 2020  Event] = []..   
-00011dc0: 2020 2020 2066 6f72 2065 7665 6e74 2069       for event i
-00011dd0: 6e20 6576 656e 7473 3a0a 2020 2020 2020  n events:.      
-00011de0: 2020 2020 2020 6966 2069 735f 6d6f 7665        if is_move
-00011df0: 6428 6576 656e 7429 3a0a 2020 2020 2020  d(event):.      
-00011e00: 2020 2020 2020 2020 2020 6465 6c65 7465            delete
-00011e10: 642c 2063 7265 6174 6564 203d 2073 706c  d, created = spl
-00011e20: 6974 5f6d 6f76 6564 5f65 7665 6e74 2865  it_moved_event(e
-00011e30: 7665 6e74 290a 2020 2020 2020 2020 2020  vent).          
-00011e40: 2020 2020 2020 6d6f 7665 645f 6672 6f6d        moved_from
-00011e50: 5f74 6f5b 6465 6c65 7465 645d 203d 2063  _to[deleted] = c
-00011e60: 7265 6174 6564 0a0a 2020 2020 2020 2020  reated..        
-00011e70: 2020 2020 2020 2020 6576 656e 7473 5f66          events_f
-00011e80: 6f72 5f70 6174 685b 6465 6c65 7465 642e  or_path[deleted.
-00011e90: 7372 635f 7061 7468 5d2e 6170 7065 6e64  src_path].append
-00011ea0: 2864 656c 6574 6564 290a 2020 2020 2020  (deleted).      
-00011eb0: 2020 2020 2020 2020 2020 6576 656e 7473            events
-00011ec0: 5f66 6f72 5f70 6174 685b 6372 6561 7465  _for_path[create
-00011ed0: 642e 7372 635f 7061 7468 5d2e 6170 7065  d.src_path].appe
-00011ee0: 6e64 2863 7265 6174 6564 290a 2020 2020  nd(created).    
-00011ef0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00011f00: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-00011f10: 656e 7473 5f66 6f72 5f70 6174 685b 6576  ents_for_path[ev
-00011f20: 656e 742e 7372 635f 7061 7468 5d2e 6170  ent.src_path].ap
-00011f30: 7065 6e64 2865 7665 6e74 290a 0a20 2020  pend(event)..   
-00011f40: 2020 2020 2023 2046 6f72 2065 7665 7279       # For every
-00011f50: 2070 6174 682c 206b 6565 7020 6f6e 6c79   path, keep only
-00011f60: 2061 2073 696e 676c 6520 6576 656e 7420   a single event 
-00011f70: 7768 6963 6820 7265 7072 6573 656e 7473  which represents
-00011f80: 2061 6c6c 2063 6861 6e67 6573 2c0a 2020   all changes,.  
-00011f90: 2020 2020 2020 2320 756e 6c65 7373 2077        # unless w
-00011fa0: 6520 6465 616c 2077 6974 6820 6120 7479  e deal with a ty
-00011fb0: 7065 2063 6861 6e67 652e 0a20 2020 2020  pe change..     
-00011fc0: 2020 2066 6f72 2070 6174 6820 696e 206c     for path in l
-00011fd0: 6973 7428 6576 656e 7473 5f66 6f72 5f70  ist(events_for_p
-00011fe0: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
-00011ff0: 2020 6576 656e 7473 203d 2065 7665 6e74    events = event
-00012000: 735f 666f 725f 7061 7468 5b70 6174 685d  s_for_path[path]
-00012010: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00012020: 206c 656e 2865 7665 6e74 7329 203d 3d20   len(events) == 
-00012030: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00012040: 2020 2065 7665 6e74 203d 2065 7665 6e74     event = event
-00012050: 735b 305d 0a20 2020 2020 2020 2020 2020  s[0].           
-00012060: 2020 2020 2023 204d 6172 6b20 6d6f 7665       # Mark move
-00012070: 6420 6576 656e 7473 2069 6620 7468 6572  d events if ther
-00012080: 6520 6973 2061 2073 696e 676c 6520 6576  e is a single ev
-00012090: 656e 7420 6f6e 6c79 2061 7420 7468 6520  ent only at the 
-000120a0: 7372 630a 2020 2020 2020 2020 2020 2020  src.            
-000120b0: 2020 2020 2320 616e 6420 6465 7374 2070      # and dest p
-000120c0: 6174 6873 2c20 746f 2062 6520 7265 636f  aths, to be reco
-000120d0: 6d62 696e 6564 206c 6174 6572 2e0a 2020  mbined later..  
-000120e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000120f0: 2065 7665 6e74 2069 6e20 6d6f 7665 645f   event in moved_
-00012100: 6672 6f6d 5f74 6f3a 0a20 2020 2020 2020  from_to:.       
-00012110: 2020 2020 2020 2020 2020 2020 2064 6573               des
-00012120: 745f 7061 7468 203d 206d 6f76 6564 5f66  t_path = moved_f
-00012130: 726f 6d5f 746f 5b65 7665 6e74 5d2e 7372  rom_to[event].sr
-00012140: 635f 7061 7468 0a20 2020 2020 2020 2020  c_path.         
-00012150: 2020 2020 2020 2020 2020 2069 6620 6c65             if le
-00012160: 6e28 6576 656e 7473 5f66 6f72 5f70 6174  n(events_for_pat
-00012170: 685b 6465 7374 5f70 6174 685d 2920 3d3d  h[dest_path]) ==
-00012180: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
-00012190: 2020 2020 2020 2020 2020 2020 6d6f 7665              move
-000121a0: 645f 6576 656e 7473 5f74 6f5f 7265 636f  d_events_to_reco
-000121b0: 6d62 696e 652e 6170 7065 6e64 2865 7665  mbine.append(eve
-000121c0: 6e74 290a 0a20 2020 2020 2020 2020 2020  nt)..           
-000121d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000121e0: 2020 2020 2020 2023 2043 6f75 6e74 2068         # Count h
-000121f0: 6f77 206f 6674 656e 2074 6865 2066 696c  ow often the fil
-00012200: 6520 2f20 666f 6c64 6572 2077 6173 2063  e / folder was c
-00012210: 7265 6174 6564 2076 7320 6465 6c65 7465  reated vs delete
-00012220: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
-00012230: 2020 2023 2052 656d 656d 6265 7220 6966     # Remember if
-00012240: 2069 7420 7761 7320 6669 7273 7420 6372   it was first cr
-00012250: 6561 7465 6420 6f72 2064 656c 6574 6564  eated or deleted
-00012260: 2e0a 0a20 2020 2020 2020 2020 2020 2020  ...             
-00012270: 2020 206e 5f63 7265 6174 6564 203d 2030     n_created = 0
-00012280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012290: 206e 5f64 656c 6574 6564 203d 2030 0a0a   n_deleted = 0..
+000116a0: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
+000116b0: 6465 6c65 7465 642c 0a20 2020 2020 2020  deleted,.       
+000116c0: 2020 2020 206f 6e5f 7072 6f67 7265 7373       on_progress
+000116d0: 3d6c 616d 6264 6120 782c 2079 3a20 7365  =lambda x, y: se
+000116e0: 6c66 2e5f 6c6f 6767 6572 2e69 6e66 6f28  lf._logger.info(
+000116f0: 6622 4465 6c65 7469 6e67 207b 787d 2f7b  f"Deleting {x}/{
+00011700: 797d 2229 2c0a 2020 2020 2020 2020 2020  y}"),.          
+00011710: 2020 7468 7265 6164 5f6e 616d 655f 7072    thread_name_pr
+00011720: 6566 6978 3d22 6d61 6573 7472 616c 2d75  efix="maestral-u
+00011730: 706c 6f61 642d 706f 6f6c 222c 0a20 2020  pload-pool",.   
+00011740: 2020 2020 2029 0a20 2020 2020 2020 2072       ).        r
+00011750: 6573 756c 7473 2e65 7874 656e 6428 7265  esults.extend(re
+00011760: 7329 0a0a 2020 2020 2020 2020 6966 2064  s)..        if d
+00011770: 6972 5f6d 6f76 6564 3a0a 2020 2020 2020  ir_moved:.      
+00011780: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00011790: 6572 2e69 6e66 6f28 224d 6f76 696e 6720  er.info("Moving 
+000117a0: 666f 6c64 6572 732e 2e2e 2229 0a0a 2020  folders...")..  
+000117b0: 2020 2020 2020 666f 7220 6576 656e 7420        for event 
+000117c0: 696e 2064 6972 5f6d 6f76 6564 3a0a 2020  in dir_moved:.  
+000117d0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000117e0: 6c6f 6767 6572 2e69 6e66 6f28 6622 4d6f  logger.info(f"Mo
+000117f0: 7669 6e67 207b 6576 656e 742e 6462 785f  ving {event.dbx_
+00011800: 7061 7468 5f66 726f 6d7d 2229 0a20 2020  path_from}").   
+00011810: 2020 2020 2020 2020 2072 203d 2073 656c           r = sel
+00011820: 662e 5f63 7265 6174 655f 7265 6d6f 7465  f._create_remote
+00011830: 5f65 6e74 7279 2865 7665 6e74 290a 2020  _entry(event).  
+00011840: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+00011850: 732e 6170 7065 6e64 2872 290a 0a20 2020  s.append(r)..   
+00011860: 2020 2020 2023 2041 7070 6c79 206f 7468       # Apply oth
+00011870: 6572 2065 7665 6e74 7320 696e 2070 6172  er events in par
+00011880: 616c 6c65 6c2c 2070 726f 6365 7373 696e  allel, processin
+00011890: 6720 6561 6368 2068 6965 7261 7263 6879  g each hierarchy
+000118a0: 206c 6576 656c 2073 7563 6365 7373 6976   level successiv
+000118b0: 656c 792e 0a20 2020 2020 2020 2066 6f72  ely..        for
+000118c0: 206c 6576 656c 2069 6e20 736f 7274 6564   level in sorted
+000118d0: 286f 7468 6572 293a 0a20 2020 2020 2020  (other):.       
+000118e0: 2020 2020 2072 6573 203d 2064 6f5f 7061       res = do_pa
+000118f0: 7261 6c6c 656c 280a 2020 2020 2020 2020  rallel(.        
+00011900: 2020 2020 2020 2020 7365 6c66 2e5f 6372          self._cr
+00011910: 6561 7465 5f72 656d 6f74 655f 656e 7472  eate_remote_entr
+00011920: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
+00011930: 2020 206f 7468 6572 5b6c 6576 656c 5d2c     other[level],
+00011940: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00011950: 206f 6e5f 7072 6f67 7265 7373 3d6c 616d   on_progress=lam
+00011960: 6264 6120 782c 2079 3a20 7365 6c66 2e5f  bda x, y: self._
+00011970: 6c6f 6767 6572 2e69 6e66 6f28 6622 5379  logger.info(f"Sy
+00011980: 6e63 696e 6720 e286 9120 7b78 7d2f 7b79  ncing ... {x}/{y
+00011990: 7d22 292c 0a20 2020 2020 2020 2020 2020  }"),.           
+000119a0: 2020 2020 2074 6872 6561 645f 6e61 6d65       thread_name
+000119b0: 5f70 7265 6669 783d 226d 6165 7374 7261  _prefix="maestra
+000119c0: 6c2d 7570 6c6f 6164 2d70 6f6f 6c22 2c0a  l-upload-pool",.
+000119d0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+000119e0: 2020 2020 2020 2020 2020 7265 7375 6c74            result
+000119f0: 732e 6578 7465 6e64 2872 6573 290a 0a20  s.extend(res).. 
+00011a00: 2020 2020 2020 2073 656c 662e 5f63 6c65         self._cle
+00011a10: 616e 5f68 6973 746f 7279 2829 0a0a 2020  an_history()..  
+00011a20: 2020 2020 2020 7265 7475 726e 2072 6573        return res
+00011a30: 756c 7473 0a0a 2020 2020 6465 6620 5f63  ults..    def _c
+00011a40: 6c65 616e 5f6c 6f63 616c 5f65 7665 6e74  lean_local_event
+00011a50: 7328 0a20 2020 2020 2020 2073 656c 662c  s(.        self,
+00011a60: 2065 7665 6e74 733a 2043 6f6c 6c65 6374   events: Collect
+00011a70: 696f 6e5b 4669 6c65 5379 7374 656d 4576  ion[FileSystemEv
+00011a80: 656e 745d 0a20 2020 2029 202d 3e20 6c69  ent].    ) -> li
+00011a90: 7374 5b46 696c 6553 7973 7465 6d45 7665  st[FileSystemEve
+00011aa0: 6e74 5d3a 0a20 2020 2020 2020 2022 2222  nt]:.        """
+00011ab0: 0a20 2020 2020 2020 2054 616b 6573 206c  .        Takes l
+00011ac0: 6f63 616c 2066 696c 6520 6576 656e 7473  ocal file events
+00011ad0: 2061 6e64 2063 6c65 616e 7320 7468 656d   and cleans them
+00011ae0: 2075 7020 6173 2066 6f6c 6c6f 7773 3a0a   up as follows:.
+00011af0: 0a20 2020 2020 2020 2031 2920 4b65 6570  .        1) Keep
+00011b00: 206f 6e6c 7920 6120 7369 6e67 6c65 2065   only a single e
+00011b10: 7665 6e74 2070 6572 2070 6174 682c 2075  vent per path, u
+00011b20: 6e6c 6573 7320 7468 6520 6974 656d 2074  nless the item t
+00011b30: 7970 6520 6368 616e 6765 6420 2865 2e67  ype changed (e.g
+00011b40: 2e2c 2066 726f 6d0a 2020 2020 2020 2020  ., from.        
+00011b50: 2020 2066 696c 6520 746f 2066 6f6c 6465     file to folde
+00011b60: 7229 2e0a 2020 2020 2020 2020 3229 2043  r)..        2) C
+00011b70: 6f6c 6c61 7073 6573 206d 6f76 6564 2061  ollapses moved a
+00011b80: 6e64 2064 656c 6574 6564 2065 7665 6e74  nd deleted event
+00011b90: 7320 6f66 2066 6f6c 6465 7273 2077 6974  s of folders wit
+00011ba0: 6820 7468 6f73 6520 6f66 2074 6865 6972  h those of their
+00011bb0: 2063 6869 6c64 7265 6e2e 0a0a 2020 2020   children...    
+00011bc0: 2020 2020 5468 6520 6f72 6465 7220 6f66      The order of
+00011bd0: 2065 7665 6e74 7320 7769 6c6c 2062 6520   events will be 
+00011be0: 7072 6573 6572 7665 6420 6163 636f 7264  preserved accord
+00011bf0: 696e 6720 746f 2074 6865 2066 6972 7374  ing to the first
+00011c00: 2065 7665 6e74 2072 6567 6973 7465 7265   event registere
+00011c10: 640a 2020 2020 2020 2020 666f 7220 7468  d.        for th
+00011c20: 6174 2070 6174 682e 0a0a 2020 2020 2020  at path...      
+00011c30: 2020 3a70 6172 616d 2065 7665 6e74 733a    :param events:
+00011c40: 2049 7465 7261 626c 6520 6f66 203a 636c   Iterable of :cl
+00011c50: 6173 733a 6077 6174 6368 646f 672e 4669  ass:`watchdog.Fi
+00011c60: 6c65 5379 7374 656d 4576 656e 7460 2e0a  leSystemEvent`..
+00011c70: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+00011c80: 3a20 4c69 7374 206f 6620 3a63 6c61 7373  : List of :class
+00011c90: 3a60 7761 7463 6864 6f67 2e46 696c 6553  :`watchdog.FileS
+00011ca0: 7973 7465 6d45 7665 6e74 602e 0a20 2020  ystemEvent`..   
+00011cb0: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00011cc0: 2023 2043 4f4d 4249 4e45 2045 5645 4e54   # COMBINE EVENT
+00011cd0: 5320 544f 204f 4e45 2045 5645 4e54 2050  S TO ONE EVENT P
+00011ce0: 4552 2050 4154 480a 0a20 2020 2020 2020  ER PATH..       
+00011cf0: 2023 204d 6f76 6520 6576 656e 7473 2061   # Move events a
+00011d00: 7265 2064 6966 6669 6375 6c74 2074 6f20  re difficult to 
+00011d10: 636f 6d62 696e 6520 7769 7468 206f 7468  combine with oth
+00011d20: 6572 2065 7665 6e74 2074 7970 6573 2c20  er event types, 
+00011d30: 7765 2073 706c 6974 2074 6865 6d0a 2020  we split them.  
+00011d40: 2020 2020 2020 2320 696e 746f 2064 656c        # into del
+00011d50: 6574 6564 2061 6e64 2063 7265 6174 6564  eted and created
+00011d60: 2065 7665 6e74 7320 616e 6420 7265 636f   events and reco
+00011d70: 6d62 696e 6520 7468 656d 206c 6174 6572  mbine them later
+00011d80: 2069 6620 6e65 6974 6865 7220 7468 6520   if neither the 
+00011d90: 736f 7572 6365 0a20 2020 2020 2020 2023  source.        #
+00011da0: 206f 6620 7468 6520 6465 7374 696e 6174   of the destinat
+00011db0: 696f 6e20 7061 7468 206f 6620 6861 7320  ion path of has 
+00011dc0: 6f74 6865 7220 6576 656e 7473 2061 7373  other events ass
+00011dd0: 6f63 6961 7465 6420 7769 7468 2069 7420  ociated with it 
+00011de0: 6f72 2069 7320 6578 636c 7564 6564 0a20  or is excluded. 
+00011df0: 2020 2020 2020 2023 2066 726f 6d20 7379         # from sy
+00011e00: 6e63 2e0a 0a20 2020 2020 2020 2023 206d  nc...        # m
+00011e10: 6170 7069 6e67 206f 6620 7061 7468 202d  apping of path -
+00011e20: 3e20 6576 656e 7420 6869 7374 6f72 790a  > event history.
+00011e30: 2020 2020 2020 2020 6576 656e 7473 5f66          events_f
+00011e40: 6f72 5f70 6174 683a 2064 6566 6175 6c74  or_path: default
+00011e50: 6469 6374 5b73 7472 2c20 6c69 7374 5b46  dict[str, list[F
+00011e60: 696c 6553 7973 7465 6d45 7665 6e74 5d5d  ileSystemEvent]]
+00011e70: 203d 2064 6566 6175 6c74 6469 6374 286c   = defaultdict(l
+00011e80: 6973 7429 0a0a 2020 2020 2020 2020 2320  ist)..        # 
+00011e90: 6d61 7070 696e 6720 6f66 2073 6f75 7263  mapping of sourc
+00011ea0: 6520 6465 6c65 7469 6f6e 2065 7665 6e74  e deletion event
+00011eb0: 202d 3e20 6465 7374 696e 6174 696f 6e20   -> destination 
+00011ec0: 6372 6561 7469 6f6e 2065 7665 6e74 0a20  creation event. 
+00011ed0: 2020 2020 2020 206d 6f76 6564 5f66 726f         moved_fro
+00011ee0: 6d5f 746f 3a20 6469 6374 5b46 696c 6553  m_to: dict[FileS
+00011ef0: 7973 7465 6d45 7665 6e74 2c20 4669 6c65  ystemEvent, File
+00011f00: 5379 7374 656d 4576 656e 745d 203d 207b  SystemEvent] = {
+00011f10: 7d0a 2020 2020 2020 2020 6d6f 7665 645f  }.        moved_
+00011f20: 6576 656e 7473 5f74 6f5f 7265 636f 6d62  events_to_recomb
+00011f30: 696e 653a 206c 6973 745b 4669 6c65 5379  ine: list[FileSy
+00011f40: 7374 656d 4576 656e 745d 203d 205b 5d0a  stemEvent] = [].
+00011f50: 0a20 2020 2020 2020 2066 6f72 2065 7665  .        for eve
+00011f60: 6e74 2069 6e20 6576 656e 7473 3a0a 2020  nt in events:.  
+00011f70: 2020 2020 2020 2020 2020 6966 2069 735f            if is_
+00011f80: 6d6f 7665 6428 6576 656e 7429 3a0a 2020  moved(event):.  
+00011f90: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00011fa0: 6c65 7465 642c 2063 7265 6174 6564 203d  leted, created =
+00011fb0: 2073 706c 6974 5f6d 6f76 6564 5f65 7665   split_moved_eve
+00011fc0: 6e74 2865 7665 6e74 290a 2020 2020 2020  nt(event).      
+00011fd0: 2020 2020 2020 2020 2020 6d6f 7665 645f            moved_
+00011fe0: 6672 6f6d 5f74 6f5b 6465 6c65 7465 645d  from_to[deleted]
+00011ff0: 203d 2063 7265 6174 6564 0a0a 2020 2020   = created..    
+00012000: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00012010: 7473 5f66 6f72 5f70 6174 685b 6465 6c65  ts_for_path[dele
+00012020: 7465 642e 7372 635f 7061 7468 5d2e 6170  ted.src_path].ap
+00012030: 7065 6e64 2864 656c 6574 6564 290a 2020  pend(deleted).  
+00012040: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+00012050: 656e 7473 5f66 6f72 5f70 6174 685b 6372  ents_for_path[cr
+00012060: 6561 7465 642e 7372 635f 7061 7468 5d2e  eated.src_path].
+00012070: 6170 7065 6e64 2863 7265 6174 6564 290a  append(created).
+00012080: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00012090: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000120a0: 2020 6576 656e 7473 5f66 6f72 5f70 6174    events_for_pat
+000120b0: 685b 6576 656e 742e 7372 635f 7061 7468  h[event.src_path
+000120c0: 5d2e 6170 7065 6e64 2865 7665 6e74 290a  ].append(event).
+000120d0: 0a20 2020 2020 2020 2023 2046 6f72 2065  .        # For e
+000120e0: 7665 7279 2070 6174 682c 206b 6565 7020  very path, keep 
+000120f0: 6f6e 6c79 2061 2073 696e 676c 6520 6576  only a single ev
+00012100: 656e 7420 7768 6963 6820 7265 7072 6573  ent which repres
+00012110: 656e 7473 2061 6c6c 2063 6861 6e67 6573  ents all changes
+00012120: 2c0a 2020 2020 2020 2020 2320 756e 6c65  ,.        # unle
+00012130: 7373 2077 6520 6465 616c 2077 6974 6820  ss we deal with 
+00012140: 6120 7479 7065 2063 6861 6e67 652e 0a20  a type change.. 
+00012150: 2020 2020 2020 2066 6f72 2070 6174 6820         for path 
+00012160: 696e 206c 6973 7428 6576 656e 7473 5f66  in list(events_f
+00012170: 6f72 5f70 6174 6829 3a0a 2020 2020 2020  or_path):.      
+00012180: 2020 2020 2020 6576 656e 7473 203d 2065        events = e
+00012190: 7665 6e74 735f 666f 725f 7061 7468 5b70  vents_for_path[p
+000121a0: 6174 685d 0a0a 2020 2020 2020 2020 2020  ath]..          
+000121b0: 2020 6966 206c 656e 2865 7665 6e74 7329    if len(events)
+000121c0: 203d 3d20 313a 0a20 2020 2020 2020 2020   == 1:.         
+000121d0: 2020 2020 2020 2065 7665 6e74 203d 2065         event = e
+000121e0: 7665 6e74 735b 305d 0a20 2020 2020 2020  vents[0].       
+000121f0: 2020 2020 2020 2020 2023 204d 6172 6b20           # Mark 
+00012200: 6d6f 7665 6420 6576 656e 7473 2069 6620  moved events if 
+00012210: 7468 6572 6520 6973 2061 2073 696e 676c  there is a singl
+00012220: 6520 6576 656e 7420 6f6e 6c79 2061 7420  e event only at 
+00012230: 7468 6520 7372 630a 2020 2020 2020 2020  the src.        
+00012240: 2020 2020 2020 2020 2320 616e 6420 6465          # and de
+00012250: 7374 2070 6174 6873 2c20 746f 2062 6520  st paths, to be 
+00012260: 7265 636f 6d62 696e 6564 206c 6174 6572  recombined later
+00012270: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00012280: 2020 6966 2065 7665 6e74 2069 6e20 6d6f    if event in mo
+00012290: 7665 645f 6672 6f6d 5f74 6f3a 0a20 2020  ved_from_to:.   
 000122a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122b0: 6669 7273 745f 6372 6561 7465 645f 696e  first_created_in
-000122c0: 6465 7820 3d20 2d31 0a20 2020 2020 2020  dex = -1.       
-000122d0: 2020 2020 2020 2020 2066 6972 7374 5f64           first_d
-000122e0: 656c 6574 6564 5f69 6e64 6578 203d 202d  eleted_index = -
-000122f0: 310a 0a20 2020 2020 2020 2020 2020 2020  1..             
-00012300: 2020 2066 6f72 2069 2069 6e20 7265 7665     for i in reve
-00012310: 7273 6564 2872 616e 6765 286c 656e 2865  rsed(range(len(e
-00012320: 7665 6e74 7329 2929 3a0a 2020 2020 2020  vents))):.      
-00012330: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-00012340: 656e 7420 3d20 6576 656e 7473 5b69 5d0a  ent = events[i].
-00012350: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012360: 2020 2020 2069 6620 6973 5f63 7265 6174       if is_creat
-00012370: 6564 2865 7665 6e74 293a 0a20 2020 2020  ed(event):.     
-00012380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012390: 2020 206e 5f63 7265 6174 6564 202b 3d20     n_created += 
-000123a0: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
-000123b0: 2020 2020 2020 2020 2020 6669 7273 745f            first_
-000123c0: 6372 6561 7465 645f 696e 6465 7820 3d20  created_index = 
-000123d0: 690a 0a20 2020 2020 2020 2020 2020 2020  i..             
-000123e0: 2020 2020 2020 2069 6620 6973 5f64 656c         if is_del
-000123f0: 6574 6564 2865 7665 6e74 293a 0a20 2020  eted(event):.   
-00012400: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012410: 2020 2020 206e 5f64 656c 6574 6564 202b       n_deleted +
-00012420: 3d20 310a 2020 2020 2020 2020 2020 2020  = 1.            
-00012430: 2020 2020 2020 2020 2020 2020 6669 7273              firs
-00012440: 745f 6465 6c65 7465 645f 696e 6465 7820  t_deleted_index 
-00012450: 3d20 690a 0a20 2020 2020 2020 2020 2020  = i..           
-00012460: 2020 2020 2069 6620 6e5f 6372 6561 7465       if n_create
-00012470: 6420 3e20 6e5f 6465 6c65 7465 643a 2020  d > n_deleted:  
-00012480: 2320 4974 656d 2077 6173 2063 7265 6174  # Item was creat
-00012490: 6564 2e0a 2020 2020 2020 2020 2020 2020  ed..            
-000124a0: 2020 2020 2020 2020 6966 2065 7665 6e74          if event
-000124b0: 735b 2d31 5d2e 6973 5f64 6972 6563 746f  s[-1].is_directo
-000124c0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-000124d0: 2020 2020 2020 2020 2020 2020 6576 656e              even
-000124e0: 7473 5f66 6f72 5f70 6174 685b 7061 7468  ts_for_path[path
-000124f0: 5d20 3d20 5b44 6972 4372 6561 7465 6445  ] = [DirCreatedE
-00012500: 7665 6e74 2870 6174 6829 5d0a 2020 2020  vent(path)].    
+000122b0: 2064 6573 745f 7061 7468 203d 206d 6f76   dest_path = mov
+000122c0: 6564 5f66 726f 6d5f 746f 5b65 7665 6e74  ed_from_to[event
+000122d0: 5d2e 7372 635f 7061 7468 0a20 2020 2020  ].src_path.     
+000122e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000122f0: 6620 6c65 6e28 6576 656e 7473 5f66 6f72  f len(events_for
+00012300: 5f70 6174 685b 6465 7374 5f70 6174 685d  _path[dest_path]
+00012310: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
+00012320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012330: 6d6f 7665 645f 6576 656e 7473 5f74 6f5f  moved_events_to_
+00012340: 7265 636f 6d62 696e 652e 6170 7065 6e64  recombine.append
+00012350: 2865 7665 6e74 290a 0a20 2020 2020 2020  (event)..       
+00012360: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00012370: 2020 2020 2020 2020 2020 2023 2043 6f75             # Cou
+00012380: 6e74 2068 6f77 206f 6674 656e 2074 6865  nt how often the
+00012390: 2066 696c 6520 2f20 666f 6c64 6572 2077   file / folder w
+000123a0: 6173 2063 7265 6174 6564 2076 7320 6465  as created vs de
+000123b0: 6c65 7465 642e 0a20 2020 2020 2020 2020  leted..         
+000123c0: 2020 2020 2020 2023 2052 656d 656d 6265         # Remembe
+000123d0: 7220 6966 2069 7420 7761 7320 6669 7273  r if it was firs
+000123e0: 7420 6372 6561 7465 6420 6f72 2064 656c  t created or del
+000123f0: 6574 6564 2e0a 0a20 2020 2020 2020 2020  eted...         
+00012400: 2020 2020 2020 206e 5f63 7265 6174 6564         n_created
+00012410: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+00012420: 2020 2020 206e 5f64 656c 6574 6564 203d       n_deleted =
+00012430: 2030 0a0a 2020 2020 2020 2020 2020 2020   0..            
+00012440: 2020 2020 6669 7273 745f 6372 6561 7465      first_create
+00012450: 645f 696e 6465 7820 3d20 2d31 0a20 2020  d_index = -1.   
+00012460: 2020 2020 2020 2020 2020 2020 2066 6972               fir
+00012470: 7374 5f64 656c 6574 6564 5f69 6e64 6578  st_deleted_index
+00012480: 203d 202d 310a 0a20 2020 2020 2020 2020   = -1..         
+00012490: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+000124a0: 7265 7665 7273 6564 2872 616e 6765 286c  reversed(range(l
+000124b0: 656e 2865 7665 6e74 7329 2929 3a0a 2020  en(events))):.  
+000124c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000124d0: 2020 6576 656e 7420 3d20 6576 656e 7473    event = events
+000124e0: 5b69 5d0a 0a20 2020 2020 2020 2020 2020  [i]..           
+000124f0: 2020 2020 2020 2020 2069 6620 6973 5f63           if is_c
+00012500: 7265 6174 6564 2865 7665 6e74 293a 0a20  reated(event):. 
 00012510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012520: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00012530: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-00012540: 656e 7473 5f66 6f72 5f70 6174 685b 7061  ents_for_path[pa
-00012550: 7468 5d20 3d20 5b46 696c 6543 7265 6174  th] = [FileCreat
-00012560: 6564 4576 656e 7428 7061 7468 295d 0a0a  edEvent(path)]..
-00012570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012580: 656c 6966 206e 5f63 7265 6174 6564 203c  elif n_created <
-00012590: 206e 5f64 656c 6574 6564 3a20 2023 2049   n_deleted:  # I
-000125a0: 7465 6d20 7761 7320 6465 6c65 7465 642e  tem was deleted.
-000125b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000125c0: 2020 2020 2069 6620 6576 656e 7473 5b30       if events[0
-000125d0: 5d2e 6973 5f64 6972 6563 746f 7279 3a0a  ].is_directory:.
-000125e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000125f0: 2020 2020 2020 2020 6576 656e 7473 5f66          events_f
-00012600: 6f72 5f70 6174 685b 7061 7468 5d20 3d20  or_path[path] = 
-00012610: 5b44 6972 4465 6c65 7465 6445 7665 6e74  [DirDeletedEvent
-00012620: 2870 6174 6829 5d0a 2020 2020 2020 2020  (path)].        
-00012630: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00012640: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012650: 2020 2020 2020 2020 2020 6576 656e 7473            events
-00012660: 5f66 6f72 5f70 6174 685b 7061 7468 5d20  _for_path[path] 
-00012670: 3d20 5b46 696c 6544 656c 6574 6564 4576  = [FileDeletedEv
-00012680: 656e 7428 7061 7468 295d 0a0a 2020 2020  ent(path)]..    
-00012690: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000126a0: 3a20 2023 2053 616d 6520 6e75 6d62 6572  :  # Same number
-000126b0: 206f 6620 6465 6c65 7465 6420 616e 6420   of deleted and 
-000126c0: 6372 6561 7465 6420 6576 656e 7473 2e0a  created events..
-000126d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126e0: 2020 2020 6966 206e 5f63 7265 6174 6564      if n_created
-000126f0: 203d 3d20 3020 6f72 2066 6972 7374 5f64   == 0 or first_d
-00012700: 656c 6574 6564 5f69 6e64 6578 203c 2066  eleted_index < f
-00012710: 6972 7374 5f63 7265 6174 6564 5f69 6e64  irst_created_ind
-00012720: 6578 3a0a 2020 2020 2020 2020 2020 2020  ex:.            
-00012730: 2020 2020 2020 2020 2020 2020 2320 4974              # It
-00012740: 656d 2077 6173 206d 6f64 6966 6965 642e  em was modified.
-00012750: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012760: 2020 2020 2020 2020 2069 6620 6576 656e           if even
-00012770: 7473 5b30 5d2e 6973 5f64 6972 6563 746f  ts[0].is_directo
-00012780: 7279 2061 6e64 2065 7665 6e74 735b 2d31  ry and events[-1
-00012790: 5d2e 6973 5f64 6972 6563 746f 7279 3a0a  ].is_directory:.
-000127a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000127b0: 2020 2020 2020 2020 2020 2020 2320 426f              # Bo
-000127c0: 7468 2066 6972 7374 2061 6e64 206c 6173  th first and las
-000127d0: 7420 6576 656e 7473 2061 7265 2066 726f  t events are fro
-000127e0: 6d20 666f 6c64 6572 732e 0a20 2020 2020  m folders..     
-000127f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012800: 2020 2020 2020 2065 7665 6e74 735f 666f         events_fo
-00012810: 725f 7061 7468 5b70 6174 685d 203d 205b  r_path[path] = [
-00012820: 4469 724d 6f64 6966 6965 6445 7665 6e74  DirModifiedEvent
-00012830: 2870 6174 6829 5d0a 2020 2020 2020 2020  (path)].        
-00012840: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012850: 656c 6966 206e 6f74 2065 7665 6e74 735b  elif not events[
-00012860: 305d 2e69 735f 6469 7265 6374 6f72 7920  0].is_directory 
-00012870: 616e 6420 6e6f 7420 6576 656e 7473 5b2d  and not events[-
-00012880: 315d 2e69 735f 6469 7265 6374 6f72 793a  1].is_directory:
-00012890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000128a0: 2020 2020 2020 2020 2020 2020 2023 2042               # B
-000128b0: 6f74 6820 6669 7273 7420 616e 6420 6c61  oth first and la
-000128c0: 7374 2065 7665 6e74 7320 6172 6520 6672  st events are fr
-000128d0: 6f6d 2066 696c 6573 2e0a 2020 2020 2020  om files..      
-000128e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000128f0: 2020 2020 2020 6576 656e 7473 5f66 6f72        events_for
-00012900: 5f70 6174 685b 7061 7468 5d20 3d20 5b46  _path[path] = [F
-00012910: 696c 654d 6f64 6966 6965 6445 7665 6e74  ileModifiedEvent
-00012920: 2870 6174 6829 5d0a 2020 2020 2020 2020  (path)].        
-00012930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012940: 656c 6966 2065 7665 6e74 735b 305d 2e69  elif events[0].i
-00012950: 735f 6469 7265 6374 6f72 793a 0a20 2020  s_directory:.   
-00012960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012970: 2020 2020 2020 2020 2023 2054 7970 6520           # Type 
-00012980: 6368 616e 6765 2066 6f6c 6465 7220 2d3e  change folder ->
-00012990: 2066 696c 652e 0a20 2020 2020 2020 2020   file..         
-000129a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000129b0: 2020 2065 7665 6e74 735f 666f 725f 7061     events_for_pa
-000129c0: 7468 5b70 6174 685d 203d 205b 0a20 2020  th[path] = [.   
+00012520: 2020 2020 2020 206e 5f63 7265 6174 6564         n_created
+00012530: 202b 3d20 310a 2020 2020 2020 2020 2020   += 1.          
+00012540: 2020 2020 2020 2020 2020 2020 2020 6669                fi
+00012550: 7273 745f 6372 6561 7465 645f 696e 6465  rst_created_inde
+00012560: 7820 3d20 690a 0a20 2020 2020 2020 2020  x = i..         
+00012570: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+00012580: 5f64 656c 6574 6564 2865 7665 6e74 293a  _deleted(event):
+00012590: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000125a0: 2020 2020 2020 2020 206e 5f64 656c 6574           n_delet
+000125b0: 6564 202b 3d20 310a 2020 2020 2020 2020  ed += 1.        
+000125c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000125d0: 6669 7273 745f 6465 6c65 7465 645f 696e  first_deleted_in
+000125e0: 6465 7820 3d20 690a 0a20 2020 2020 2020  dex = i..       
+000125f0: 2020 2020 2020 2020 2069 6620 6e5f 6372           if n_cr
+00012600: 6561 7465 6420 3e20 6e5f 6465 6c65 7465  eated > n_delete
+00012610: 643a 2020 2320 4974 656d 2077 6173 2063  d:  # Item was c
+00012620: 7265 6174 6564 2e0a 2020 2020 2020 2020  reated..        
+00012630: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+00012640: 7665 6e74 735b 2d31 5d2e 6973 5f64 6972  vents[-1].is_dir
+00012650: 6563 746f 7279 3a0a 2020 2020 2020 2020  ectory:.        
+00012660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012670: 6576 656e 7473 5f66 6f72 5f70 6174 685b  events_for_path[
+00012680: 7061 7468 5d20 3d20 5b44 6972 4372 6561  path] = [DirCrea
+00012690: 7465 6445 7665 6e74 2870 6174 6829 5d0a  tedEvent(path)].
+000126a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126b0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000126c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000126d0: 2020 6576 656e 7473 5f66 6f72 5f70 6174    events_for_pat
+000126e0: 685b 7061 7468 5d20 3d20 5b46 696c 6543  h[path] = [FileC
+000126f0: 7265 6174 6564 4576 656e 7428 7061 7468  reatedEvent(path
+00012700: 295d 0a0a 2020 2020 2020 2020 2020 2020  )]..            
+00012710: 2020 2020 656c 6966 206e 5f63 7265 6174      elif n_creat
+00012720: 6564 203c 206e 5f64 656c 6574 6564 3a20  ed < n_deleted: 
+00012730: 2023 2049 7465 6d20 7761 7320 6465 6c65   # Item was dele
+00012740: 7465 642e 0a20 2020 2020 2020 2020 2020  ted..           
+00012750: 2020 2020 2020 2020 2069 6620 6576 656e           if even
+00012760: 7473 5b30 5d2e 6973 5f64 6972 6563 746f  ts[0].is_directo
+00012770: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00012780: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00012790: 7473 5f66 6f72 5f70 6174 685b 7061 7468  ts_for_path[path
+000127a0: 5d20 3d20 5b44 6972 4465 6c65 7465 6445  ] = [DirDeletedE
+000127b0: 7665 6e74 2870 6174 6829 5d0a 2020 2020  vent(path)].    
+000127c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000127d0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000127e0: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+000127f0: 656e 7473 5f66 6f72 5f70 6174 685b 7061  ents_for_path[pa
+00012800: 7468 5d20 3d20 5b46 696c 6544 656c 6574  th] = [FileDelet
+00012810: 6564 4576 656e 7428 7061 7468 295d 0a0a  edEvent(path)]..
+00012820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012830: 656c 7365 3a20 2023 2053 616d 6520 6e75  else:  # Same nu
+00012840: 6d62 6572 206f 6620 6465 6c65 7465 6420  mber of deleted 
+00012850: 616e 6420 6372 6561 7465 6420 6576 656e  and created even
+00012860: 7473 2e0a 2020 2020 2020 2020 2020 2020  ts..            
+00012870: 2020 2020 2020 2020 6966 206e 5f63 7265          if n_cre
+00012880: 6174 6564 203d 3d20 3020 6f72 2066 6972  ated == 0 or fir
+00012890: 7374 5f64 656c 6574 6564 5f69 6e64 6578  st_deleted_index
+000128a0: 203c 2066 6972 7374 5f63 7265 6174 6564   < first_created
+000128b0: 5f69 6e64 6578 3a0a 2020 2020 2020 2020  _index:.        
+000128c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128d0: 2320 4974 656d 2077 6173 206d 6f64 6966  # Item was modif
+000128e0: 6965 642e 0a20 2020 2020 2020 2020 2020  ied..           
+000128f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+00012900: 6576 656e 7473 5b30 5d2e 6973 5f64 6972  events[0].is_dir
+00012910: 6563 746f 7279 2061 6e64 2065 7665 6e74  ectory and event
+00012920: 735b 2d31 5d2e 6973 5f64 6972 6563 746f  s[-1].is_directo
+00012930: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00012940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012950: 2320 426f 7468 2066 6972 7374 2061 6e64  # Both first and
+00012960: 206c 6173 7420 6576 656e 7473 2061 7265   last events are
+00012970: 2066 726f 6d20 666f 6c64 6572 732e 0a20   from folders.. 
+00012980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012990: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+000129a0: 735f 666f 725f 7061 7468 5b70 6174 685d  s_for_path[path]
+000129b0: 203d 205b 4469 724d 6f64 6966 6965 6445   = [DirModifiedE
+000129c0: 7665 6e74 2870 6174 6829 5d0a 2020 2020  vent(path)].    
 000129d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000129e0: 2020 2020 2020 2020 2020 2020 2044 6972               Dir
-000129f0: 4465 6c65 7465 6445 7665 6e74 2870 6174  DeletedEvent(pat
-00012a00: 6829 2c0a 2020 2020 2020 2020 2020 2020  h),.            
-00012a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a20: 2020 2020 4669 6c65 4372 6561 7465 6445      FileCreatedE
-00012a30: 7665 6e74 2870 6174 6829 2c0a 2020 2020  vent(path),.    
-00012a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a50: 2020 2020 2020 2020 5d0a 2020 2020 2020          ].      
-00012a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012a70: 2020 656c 6966 2065 7665 6e74 735b 2d31    elif events[-1
-00012a80: 5d2e 6973 5f64 6972 6563 746f 7279 3a0a  ].is_directory:.
-00012a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012aa0: 2020 2020 2020 2020 2020 2020 2320 5479              # Ty
-00012ab0: 7065 2063 6861 6e67 6520 6669 6c65 202d  pe change file -
-00012ac0: 3e20 666f 6c64 6572 2e0a 2020 2020 2020  > folder..      
-00012ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ae0: 2020 2020 2020 6576 656e 7473 5f66 6f72        events_for
-00012af0: 5f70 6174 685b 7061 7468 5d20 3d20 5b0a  _path[path] = [.
-00012b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b20: 4669 6c65 4465 6c65 7465 6445 7665 6e74  FileDeletedEvent
-00012b30: 2870 6174 6829 2c0a 2020 2020 2020 2020  (path),.        
-00012b40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b50: 2020 2020 2020 2020 4469 7243 7265 6174          DirCreat
-00012b60: 6564 4576 656e 7428 7061 7468 292c 0a20  edEvent(path),. 
+000129e0: 2020 2020 656c 6966 206e 6f74 2065 7665      elif not eve
+000129f0: 6e74 735b 305d 2e69 735f 6469 7265 6374  nts[0].is_direct
+00012a00: 6f72 7920 616e 6420 6e6f 7420 6576 656e  ory and not even
+00012a10: 7473 5b2d 315d 2e69 735f 6469 7265 6374  ts[-1].is_direct
+00012a20: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
+00012a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a40: 2023 2042 6f74 6820 6669 7273 7420 616e   # Both first an
+00012a50: 6420 6c61 7374 2065 7665 6e74 7320 6172  d last events ar
+00012a60: 6520 6672 6f6d 2066 696c 6573 2e0a 2020  e from files..  
+00012a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a80: 2020 2020 2020 2020 2020 6576 656e 7473            events
+00012a90: 5f66 6f72 5f70 6174 685b 7061 7468 5d20  _for_path[path] 
+00012aa0: 3d20 5b46 696c 654d 6f64 6966 6965 6445  = [FileModifiedE
+00012ab0: 7665 6e74 2870 6174 6829 5d0a 2020 2020  vent(path)].    
+00012ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ad0: 2020 2020 656c 6966 2065 7665 6e74 735b      elif events[
+00012ae0: 305d 2e69 735f 6469 7265 6374 6f72 793a  0].is_directory:
+00012af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012b00: 2020 2020 2020 2020 2020 2020 2023 2054               # T
+00012b10: 7970 6520 6368 616e 6765 2066 6f6c 6465  ype change folde
+00012b20: 7220 2d3e 2066 696c 652e 0a20 2020 2020  r -> file..     
+00012b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012b40: 2020 2020 2020 2065 7665 6e74 735f 666f         events_fo
+00012b50: 725f 7061 7468 5b70 6174 685d 203d 205b  r_path[path] = [
+00012b60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
 00012b70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012b80: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
-00012b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012ba0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00012bb0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00012bc0: 2049 7465 6d20 7761 7320 6c69 6b65 6c79   Item was likely
-00012bd0: 206f 6e6c 7920 7465 6d70 6f72 6172 792e   only temporary.
-00012be0: 2057 6520 7374 696c 6c20 7472 6967 6765   We still trigge
-00012bf0: 7220 6120 7265 7363 616e 206f 660a 2020  r a rescan of.  
-00012c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012c10: 2020 2020 2020 2320 7468 6520 7061 7468        # the path
-00012c20: 2062 6563 6175 7365 2073 6f6d 6520 6174   because some at
-00012c30: 6f6d 6963 206d 6f64 6966 6963 6174 696f  omic modificatio
-00012c40: 6e73 206d 6179 2062 6520 7265 706f 7274  ns may be report
-00012c50: 6564 2061 730a 2020 2020 2020 2020 2020  ed as.          
-00012c60: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-00012c70: 6f75 742d 6f66 2d6f 7264 6572 2063 7265  out-of-order cre
-00012c80: 6174 6564 2061 6e64 2064 656c 6574 6564  ated and deleted
-00012c90: 2065 7665 6e74 7320 6f6e 206d 6163 4f53   events on macOS
-00012ca0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00012cb0: 2020 2020 2020 2020 2020 6465 6c20 6576            del ev
-00012cc0: 656e 7473 5f66 6f72 5f70 6174 685b 7061  ents_for_path[pa
-00012cd0: 7468 5d0a 2020 2020 2020 2020 2020 2020  th].            
-00012ce0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00012cf0: 2e72 6573 6361 6e28 7061 7468 290a 0a20  .rescan(path).. 
-00012d00: 2020 2020 2020 2023 2052 6563 6f6d 6269         # Recombi
-00012d10: 6e65 206d 6f76 6564 2065 7665 6e74 7320  ne moved events 
-00012d20: 6966 2077 6520 6861 7665 2072 6574 6169  if we have retai
-00012d30: 6e65 6420 626f 7468 2073 6964 6573 206f  ned both sides o
-00012d40: 6620 6576 656e 7420 6475 7269 6e67 2074  f event during t
-00012d50: 6865 0a20 2020 2020 2020 2023 2061 626f  he.        # abo
-00012d60: 7665 2063 6f6e 736f 6c69 6461 7469 6f6e  ve consolidation
-00012d70: 2e0a 2020 2020 2020 2020 666f 7220 7372  ..        for sr
-00012d80: 635f 6576 656e 7420 696e 206d 6f76 6564  c_event in moved
-00012d90: 5f65 7665 6e74 735f 746f 5f72 6563 6f6d  _events_to_recom
-00012da0: 6269 6e65 3a0a 2020 2020 2020 2020 2020  bine:.          
-00012db0: 2020 7372 635f 7061 7468 203d 2073 7263    src_path = src
-00012dc0: 5f65 7665 6e74 2e73 7263 5f70 6174 680a  _event.src_path.
-00012dd0: 2020 2020 2020 2020 2020 2020 6465 7374              dest
-00012de0: 5f70 6174 6820 3d20 6d6f 7665 645f 6672  _path = moved_fr
-00012df0: 6f6d 5f74 6f5b 7372 635f 6576 656e 745d  om_to[src_event]
-00012e00: 2e73 7263 5f70 6174 680a 0a20 2020 2020  .src_path..     
-00012e10: 2020 2020 2020 206e 6577 5f65 7665 6e74         new_event
-00012e20: 3a20 4469 724d 6f76 6564 4576 656e 7420  : DirMovedEvent 
-00012e30: 7c20 4669 6c65 4d6f 7665 6445 7665 6e74  | FileMovedEvent
-00012e40: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00012e50: 2073 7263 5f65 7665 6e74 2e69 735f 6469   src_event.is_di
-00012e60: 7265 6374 6f72 793a 0a20 2020 2020 2020  rectory:.       
-00012e70: 2020 2020 2020 2020 206e 6577 5f65 7665           new_eve
-00012e80: 6e74 203d 2044 6972 4d6f 7665 6445 7665  nt = DirMovedEve
-00012e90: 6e74 2873 7263 5f70 6174 682c 2064 6573  nt(src_path, des
-00012ea0: 745f 7061 7468 290a 2020 2020 2020 2020  t_path).        
-00012eb0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-00012ec0: 2020 2020 2020 2020 2020 6e65 775f 6576            new_ev
-00012ed0: 656e 7420 3d20 4669 6c65 4d6f 7665 6445  ent = FileMovedE
-00012ee0: 7665 6e74 2873 7263 5f70 6174 682c 2064  vent(src_path, d
-00012ef0: 6573 745f 7061 7468 290a 0a20 2020 2020  est_path)..     
-00012f00: 2020 2020 2020 2023 204f 6e6c 7920 7265         # Only re
-00012f10: 636f 6d62 696e 6520 6576 656e 7473 2069  combine events i
-00012f20: 6620 6e65 6974 6865 7220 6861 7320 616e  f neither has an
-00012f30: 2065 7863 6c75 6465 6420 7061 7468 3a20   excluded path: 
-00012f40: 5765 2077 616e 7420 746f 0a20 2020 2020  We want to.     
-00012f50: 2020 2020 2020 2023 2074 7265 6174 2072         # treat r
-00012f60: 656e 616d 696e 6720 6672 6f6d 202f 2074  enaming from / t
-00012f70: 6f20 616e 2065 7863 6c75 6465 6420 7061  o an excluded pa
-00012f80: 7468 2061 7320 6120 6372 6561 7469 6f6e  th as a creation
-00012f90: 202f 2064 656c 6574 696f 6e2c 0a20 2020   / deletion,.   
-00012fa0: 2020 2020 2020 2020 2023 2072 6573 7065           # respe
-00012fb0: 6374 6976 656c 792e 0a20 2020 2020 2020  ctively..       
-00012fc0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
-00012fd0: 2e5f 7368 6f75 6c64 5f73 706c 6974 5f65  ._should_split_e
-00012fe0: 7863 6c75 6465 6428 6e65 775f 6576 656e  xcluded(new_even
-00012ff0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-00013000: 2020 2020 6465 6c20 6576 656e 7473 5f66      del events_f
-00013010: 6f72 5f70 6174 685b 7372 635f 7061 7468  or_path[src_path
-00013020: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00013030: 2020 6576 656e 7473 5f66 6f72 5f70 6174    events_for_pat
-00013040: 685b 6465 7374 5f70 6174 685d 203d 205b  h[dest_path] = [
-00013050: 6e65 775f 6576 656e 745d 0a0a 2020 2020  new_event]..    
-00013060: 2020 2020 2320 4174 2074 6869 7320 706f      # At this po
-00013070: 696e 742c 2060 6576 656e 7473 5f66 6f72  int, `events_for
-00013080: 5f70 6174 6860 2077 696c 6c20 636f 6e74  _path` will cont
-00013090: 6169 6e20 6120 7369 6e67 6c65 2065 7665  ain a single eve
-000130a0: 6e74 2070 6572 2070 6174 6820 6f72 0a20  nt per path or. 
-000130b0: 2020 2020 2020 2023 2065 7861 6374 6c79         # exactly
-000130c0: 2074 776f 2065 7665 6e74 7320 2864 656c   two events (del
-000130d0: 6574 6564 2061 6e64 2063 7265 6174 6564  eted and created
-000130e0: 2920 696e 2063 6173 6520 6f66 2061 2074  ) in case of a t
-000130f0: 7970 6520 6368 616e 6765 2e0a 0a20 2020  ype change...   
-00013100: 2020 2020 2023 2043 4f4d 4249 4e45 204d       # COMBINE M
-00013110: 4f56 4544 2041 4e44 2044 454c 4554 4544  OVED AND DELETED
-00013120: 2045 5645 4e54 5320 4f46 2046 4f4c 4445   EVENTS OF FOLDE
-00013130: 5253 2041 4e44 2054 4845 4952 2043 4849  RS AND THEIR CHI
-00013140: 4c44 5245 4e20 494e 544f 204f 4e45 2045  LDREN INTO ONE E
-00013150: 5645 4e54 0a0a 2020 2020 2020 2020 2320  VENT..        # 
-00013160: 4176 6f69 6420 6e65 7374 6564 2069 7465  Avoid nested ite
-00013170: 7261 7469 6f6e 7320 6f76 6572 2061 6c6c  rations over all
-00013180: 2065 7665 6e74 7320 6865 7265 2c20 7468   events here, th
-00013190: 6579 2061 7265 206f 6e20 7468 6520 6f72  ey are on the or
-000131a0: 6465 7220 6f66 204f 286e 5e32 290a 2020  der of O(n^2).  
-000131b0: 2020 2020 2020 2320 7768 6963 6820 6265        # which be
-000131c0: 636f 6d65 7320 636f 7374 6c79 2077 6865  comes costly whe
-000131d0: 6e20 7468 6520 7573 6572 206d 6f76 6573  n the user moves
-000131e0: 206f 7220 6465 6c65 7465 7320 666f 6c64   or deletes fold
-000131f0: 6572 2077 6974 6820 6120 6c61 7267 6520  er with a large 
-00013200: 6e75 6d62 6572 0a20 2020 2020 2020 2023  number.        #
-00013210: 206f 6620 6368 696c 6472 656e 2e20 4265   of children. Be
-00013220: 6e63 686d 6172 6b3a 2061 696d 2074 6f20  nchmark: aim to 
-00013230: 7374 6179 2062 656c 6f77 2031 2073 6563  stay below 1 sec
-00013240: 2066 6f72 2032 302c 3030 3020 6e65 7374   for 20,000 nest
-00013250: 6564 2065 7665 6e74 7320 6f6e 0a20 2020  ed events on.   
-00013260: 2020 2020 2023 2072 6570 7265 7365 6e74       # represent
-00013270: 6174 6976 6520 6c61 7074 6f70 2050 4373  ative laptop PCs
-00013280: 2e0a 0a20 2020 2020 2020 2023 2030 2920  ...        # 0) 
-00013290: 436f 6c6c 6563 7420 616c 6c20 6d6f 7665  Collect all move
-000132a0: 6420 616e 6420 6465 6c65 7465 6420 6576  d and deleted ev
-000132b0: 656e 7473 2069 6e20 7365 7473 2e0a 0a20  ents in sets... 
-000132c0: 2020 2020 2020 2064 6972 5f6d 6f76 6564         dir_moved
-000132d0: 5f70 6174 6873 3a20 7365 745b 7475 706c  _paths: set[tupl
-000132e0: 655b 7374 722c 2073 7472 5d5d 203d 2073  e[str, str]] = s
-000132f0: 6574 2829 0a20 2020 2020 2020 2064 6972  et().        dir
-00013300: 5f64 656c 6574 6564 5f70 6174 6873 3a20  _deleted_paths: 
-00013310: 7365 745b 7374 725d 203d 2073 6574 2829  set[str] = set()
-00013320: 0a0a 2020 2020 2020 2020 666f 7220 6576  ..        for ev
-00013330: 656e 7473 2069 6e20 6576 656e 7473 5f66  ents in events_f
-00013340: 6f72 5f70 6174 682e 7661 6c75 6573 2829  or_path.values()
-00013350: 3a0a 2020 2020 2020 2020 2020 2020 6576  :.            ev
-00013360: 656e 7420 3d20 6576 656e 7473 5b30 5d0a  ent = events[0].
-00013370: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00013380: 7369 6e73 7461 6e63 6528 6576 656e 742c  sinstance(event,
-00013390: 2044 6972 4d6f 7665 6445 7665 6e74 293a   DirMovedEvent):
-000133a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000133b0: 2064 6972 5f6d 6f76 6564 5f70 6174 6873   dir_moved_paths
-000133c0: 2e61 6464 2828 6576 656e 742e 7372 635f  .add((event.src_
-000133d0: 7061 7468 2c20 6576 656e 742e 6465 7374  path, event.dest
-000133e0: 5f70 6174 6829 290a 2020 2020 2020 2020  _path)).        
-000133f0: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
-00013400: 6e63 6528 6576 656e 742c 2044 6972 4465  nce(event, DirDe
-00013410: 6c65 7465 6445 7665 6e74 293a 0a20 2020  letedEvent):.   
-00013420: 2020 2020 2020 2020 2020 2020 2064 6972               dir
-00013430: 5f64 656c 6574 6564 5f70 6174 6873 2e61  _deleted_paths.a
-00013440: 6464 2865 7665 6e74 2e73 7263 5f70 6174  dd(event.src_pat
-00013450: 6829 0a0a 2020 2020 2020 2020 2320 3129  h)..        # 1)
-00013460: 2043 6f6d 6269 6e65 206d 6f76 6564 2065   Combine moved e
-00013470: 7665 6e74 7320 6f66 2066 6f6c 6465 7273  vents of folders
-00013480: 2061 6e64 2074 6865 6972 2063 6869 6c64   and their child
-00013490: 7265 6e20 696e 746f 206f 6e65 2065 7665  ren into one eve
-000134a0: 6e74 2e0a 0a20 2020 2020 2020 2069 6620  nt...        if 
-000134b0: 6c65 6e28 6469 725f 6d6f 7665 645f 7061  len(dir_moved_pa
-000134c0: 7468 7329 203e 2030 3a0a 2020 2020 2020  ths) > 0:.      
-000134d0: 2020 2020 2020 6368 696c 645f 6d6f 7665        child_move
-000134e0: 645f 6473 745f 7061 7468 733a 2073 6574  d_dst_paths: set
-000134f0: 5b73 7472 5d20 3d20 7365 7428 290a 0a20  [str] = set().. 
-00013500: 2020 2020 2020 2020 2020 2023 2046 6f72             # For
-00013510: 2065 6163 6820 6576 656e 742c 2063 6865   each event, che
-00013520: 636b 2069 6620 6974 2069 7320 6120 6368  ck if it is a ch
-00013530: 696c 6420 6f66 2061 206d 6f76 6564 2065  ild of a moved e
-00013540: 7665 6e74 2064 6973 6361 7264 2069 7420  vent discard it 
-00013550: 6966 2079 6573 2e0a 2020 2020 2020 2020  if yes..        
-00013560: 2020 2020 666f 7220 6576 656e 7473 2069      for events i
-00013570: 6e20 6576 656e 7473 5f66 6f72 5f70 6174  n events_for_pat
-00013580: 682e 7661 6c75 6573 2829 3a0a 2020 2020  h.values():.    
-00013590: 2020 2020 2020 2020 2020 2020 6576 656e              even
-000135a0: 7420 3d20 6576 656e 7473 5b30 5d0a 2020  t = events[0].  
-000135b0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000135c0: 2069 735f 6d6f 7665 6428 6576 656e 7429   is_moved(event)
-000135d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000135e0: 2020 2020 2020 6469 726e 616d 6573 203d        dirnames =
-000135f0: 2028 0a20 2020 2020 2020 2020 2020 2020   (.             
-00013600: 2020 2020 2020 2020 2020 206f 7370 2e64             osp.d
-00013610: 6972 6e61 6d65 2865 7665 6e74 2e73 7263  irname(event.src
-00013620: 5f70 6174 6829 2c0a 2020 2020 2020 2020  _path),.        
-00013630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013640: 6f73 702e 6469 726e 616d 6528 6576 656e  osp.dirname(even
-00013650: 742e 6465 7374 5f70 6174 6829 2c0a 2020  t.dest_path),.  
-00013660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013670: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00013680: 2020 2020 2020 2020 6966 2064 6972 6e61          if dirna
-00013690: 6d65 7320 696e 2064 6972 5f6d 6f76 6564  mes in dir_moved
-000136a0: 5f70 6174 6873 3a0a 2020 2020 2020 2020  _paths:.        
-000136b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000136c0: 6368 696c 645f 6d6f 7665 645f 6473 745f  child_moved_dst_
-000136d0: 7061 7468 732e 6164 6428 6576 656e 742e  paths.add(event.
-000136e0: 6465 7374 5f70 6174 6829 0a0a 2020 2020  dest_path)..    
-000136f0: 2020 2020 2020 2020 666f 7220 7061 7468          for path
-00013700: 2069 6e20 6368 696c 645f 6d6f 7665 645f   in child_moved_
-00013710: 6473 745f 7061 7468 733a 0a20 2020 2020  dst_paths:.     
-00013720: 2020 2020 2020 2020 2020 2064 656c 2065             del e
-00013730: 7665 6e74 735f 666f 725f 7061 7468 5b70  vents_for_path[p
-00013740: 6174 685d 0a0a 2020 2020 2020 2020 2320  ath]..        # 
-00013750: 3229 2043 6f6d 6269 6e65 2064 656c 6574  2) Combine delet
-00013760: 6564 2065 7665 6e74 7320 6f66 2066 6f6c  ed events of fol
-00013770: 6465 7273 2061 6e64 2074 6865 6972 2063  ders and their c
-00013780: 6869 6c64 7265 6e20 746f 206f 6e65 2065  hildren to one e
-00013790: 7665 6e74 2e0a 0a20 2020 2020 2020 2069  vent...        i
-000137a0: 6620 6c65 6e28 6469 725f 6465 6c65 7465  f len(dir_delete
-000137b0: 645f 7061 7468 7329 203e 2030 3a0a 2020  d_paths) > 0:.  
-000137c0: 2020 2020 2020 2020 2020 6368 696c 645f            child_
-000137d0: 6465 6c65 7465 645f 7061 7468 733a 2073  deleted_paths: s
-000137e0: 6574 5b73 7472 5d20 3d20 7365 7428 290a  et[str] = set().
-000137f0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00013800: 2065 7665 6e74 7320 696e 2065 7665 6e74   events in event
-00013810: 735f 666f 725f 7061 7468 2e76 616c 7565  s_for_path.value
-00013820: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00013830: 2020 2020 2065 7665 6e74 203d 2065 7665       event = eve
-00013840: 6e74 735b 305d 0a20 2020 2020 2020 2020  nts[0].         
-00013850: 2020 2020 2020 2069 6620 6973 5f64 656c         if is_del
-00013860: 6574 6564 2865 7665 6e74 293a 0a20 2020  eted(event):.   
-00013870: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013880: 2064 6972 6e61 6d65 203d 206f 7370 2e64   dirname = osp.d
-00013890: 6972 6e61 6d65 2865 7665 6e74 2e73 7263  irname(event.src
-000138a0: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-000138b0: 2020 2020 2020 2020 2020 2069 6620 6469             if di
-000138c0: 726e 616d 6520 696e 2064 6972 5f64 656c  rname in dir_del
-000138d0: 6574 6564 5f70 6174 6873 3a0a 2020 2020  eted_paths:.    
-000138e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000138f0: 2020 2020 6368 696c 645f 6465 6c65 7465      child_delete
-00013900: 645f 7061 7468 732e 6164 6428 6576 656e  d_paths.add(even
-00013910: 742e 7372 635f 7061 7468 290a 0a20 2020  t.src_path)..   
-00013920: 2020 2020 2020 2020 2066 6f72 2070 6174           for pat
-00013930: 6820 696e 2063 6869 6c64 5f64 656c 6574  h in child_delet
-00013940: 6564 5f70 6174 6873 3a0a 2020 2020 2020  ed_paths:.      
-00013950: 2020 2020 2020 2020 2020 6465 6c20 6576            del ev
-00013960: 656e 7473 5f66 6f72 5f70 6174 685b 7061  ents_for_path[pa
-00013970: 7468 5d0a 0a20 2020 2020 2020 2023 2050  th]..        # P
-00013980: 5245 5041 5245 2052 4554 5552 4e20 5641  REPARE RETURN VA
-00013990: 4c55 4520 414e 4420 4652 4545 204d 454d  LUE AND FREE MEM
-000139a0: 4f52 590a 0a20 2020 2020 2020 2063 6c65  ORY..        cle
-000139b0: 616e 6564 5f65 7665 6e74 7320 3d20 5b5d  aned_events = []
-000139c0: 0a0a 2020 2020 2020 2020 666f 7220 6576  ..        for ev
-000139d0: 656e 7473 2069 6e20 6576 656e 7473 5f66  ents in events_f
-000139e0: 6f72 5f70 6174 682e 7661 6c75 6573 2829  or_path.values()
-000139f0: 3a0a 2020 2020 2020 2020 2020 2020 636c  :.            cl
-00013a00: 6561 6e65 645f 6576 656e 7473 2e65 7874  eaned_events.ext
-00013a10: 656e 6428 6576 656e 7473 290a 0a20 2020  end(events)..   
-00013a20: 2020 2020 2023 2046 7265 6520 6d65 6d6f       # Free memo
-00013a30: 7279 2065 6172 6c79 2074 6f20 7072 6576  ry early to prev
-00013a40: 656e 7420 6672 6167 6d65 6e74 6174 696f  ent fragmentatio
-00013a50: 6e2e 0a20 2020 2020 2020 2064 656c 2065  n..        del e
-00013a60: 7665 6e74 735f 666f 725f 7061 7468 0a20  vents_for_path. 
-00013a70: 2020 2020 2020 2064 656c 206d 6f76 6564         del moved
-00013a80: 5f66 726f 6d5f 746f 0a20 2020 2020 2020  _from_to.       
-00013a90: 2064 656c 206d 6f76 6564 5f65 7665 6e74   del moved_event
-00013aa0: 735f 746f 5f72 6563 6f6d 6269 6e65 0a20  s_to_recombine. 
-00013ab0: 2020 2020 2020 2064 656c 2064 6972 5f6d         del dir_m
-00013ac0: 6f76 6564 5f70 6174 6873 0a20 2020 2020  oved_paths.     
-00013ad0: 2020 2064 656c 2064 6972 5f64 656c 6574     del dir_delet
-00013ae0: 6564 5f70 6174 6873 0a20 2020 2020 2020  ed_paths.       
-00013af0: 2067 632e 636f 6c6c 6563 7428 290a 0a20   gc.collect().. 
-00013b00: 2020 2020 2020 2072 6574 7572 6e20 636c         return cl
-00013b10: 6561 6e65 645f 6576 656e 7473 0a0a 2020  eaned_events..  
-00013b20: 2020 6465 6620 5f73 686f 756c 645f 7370    def _should_sp
-00013b30: 6c69 745f 6578 636c 7564 6564 2873 656c  lit_excluded(sel
-00013b40: 662c 2065 7665 6e74 3a20 4669 6c65 4d6f  f, event: FileMo
-00013b50: 7665 6445 7665 6e74 207c 2044 6972 4d6f  vedEvent | DirMo
-00013b60: 7665 6445 7665 6e74 2920 2d3e 2062 6f6f  vedEvent) -> boo
-00013b70: 6c3a 0a20 2020 2020 2020 2064 6278 5f73  l:.        dbx_s
-00013b80: 7263 5f70 6174 6820 3d20 7365 6c66 2e74  rc_path = self.t
-00013b90: 6f5f 6462 785f 7061 7468 2865 7665 6e74  o_dbx_path(event
-00013ba0: 2e73 7263 5f70 6174 6829 0a20 2020 2020  .src_path).     
-00013bb0: 2020 2064 6278 5f64 6573 745f 7061 7468     dbx_dest_path
-00013bc0: 203d 2073 656c 662e 746f 5f64 6278 5f70   = self.to_dbx_p
-00013bd0: 6174 6828 6576 656e 742e 6465 7374 5f70  ath(event.dest_p
-00013be0: 6174 6829 0a0a 2020 2020 2020 2020 6966  ath)..        if
-00013bf0: 2028 0a20 2020 2020 2020 2020 2020 2073   (.            s
-00013c00: 656c 662e 6973 5f65 7863 6c75 6465 6428  elf.is_excluded(
-00013c10: 6576 656e 742e 7372 635f 7061 7468 290a  event.src_path).
-00013c20: 2020 2020 2020 2020 2020 2020 6f72 2073              or s
-00013c30: 656c 662e 6973 5f65 7863 6c75 6465 6428  elf.is_excluded(
-00013c40: 6576 656e 742e 6465 7374 5f70 6174 6829  event.dest_path)
-00013c50: 0a20 2020 2020 2020 2020 2020 206f 7220  .            or 
-00013c60: 7365 6c66 2e69 735f 6578 636c 7564 6564  self.is_excluded
-00013c70: 5f62 795f 7573 6572 286e 6f72 6d61 6c69  _by_user(normali
-00013c80: 7a65 2864 6278 5f73 7263 5f70 6174 6829  ze(dbx_src_path)
-00013c90: 290a 2020 2020 2020 2020 2020 2020 6f72  ).            or
-00013ca0: 2073 656c 662e 6973 5f65 7863 6c75 6465   self.is_exclude
-00013cb0: 645f 6279 5f75 7365 7228 6e6f 726d 616c  d_by_user(normal
-00013cc0: 697a 6528 6462 785f 6465 7374 5f70 6174  ize(dbx_dest_pat
-00013cd0: 6829 290a 2020 2020 2020 2020 293a 0a20  h)).        ):. 
-00013ce0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00013cf0: 6e20 5472 7565 0a0a 2020 2020 2020 2020  n True..        
-00013d00: 656c 6966 206c 656e 2873 656c 662e 6d69  elif len(self.mi
-00013d10: 676e 6f72 655f 7275 6c65 732e 7061 7474  gnore_rules.patt
-00013d20: 6572 6e73 2920 3d3d 2030 3a0a 2020 2020  erns) == 0:.    
-00013d30: 2020 2020 2020 2020 7265 7475 726e 2046          return F
-00013d40: 616c 7365 0a20 2020 2020 2020 2065 6c73  alse.        els
-00013d50: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
-00013d60: 7263 5f69 735f 6d69 676e 6f72 6520 3d20  rc_is_mignore = 
-00013d70: 7365 6c66 2e5f 6973 5f6d 6967 6e6f 7265  self._is_mignore
-00013d80: 5f70 6174 6828 6462 785f 7372 635f 7061  _path(dbx_src_pa
-00013d90: 7468 2c20 6576 656e 742e 6973 5f64 6972  th, event.is_dir
-00013da0: 6563 746f 7279 290a 2020 2020 2020 2020  ectory).        
-00013db0: 2020 2020 6465 7374 5f69 735f 6d69 676e      dest_is_mign
-00013dc0: 6f72 6520 3d20 7365 6c66 2e5f 6973 5f6d  ore = self._is_m
-00013dd0: 6967 6e6f 7265 5f70 6174 6828 6462 785f  ignore_path(dbx_
-00013de0: 6465 7374 5f70 6174 682c 2065 7665 6e74  dest_path, event
-00013df0: 2e69 735f 6469 7265 6374 6f72 7929 0a0a  .is_directory)..
-00013e00: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00013e10: 726e 2073 7263 5f69 735f 6d69 676e 6f72  rn src_is_mignor
-00013e20: 6520 6f72 2064 6573 745f 6973 5f6d 6967  e or dest_is_mig
-00013e30: 6e6f 7265 0a0a 2020 2020 6465 6620 5f68  nore..    def _h
-00013e40: 616e 646c 655f 6e6f 726d 616c 697a 6174  andle_normalizat
-00013e50: 696f 6e5f 636f 6e66 6c69 6374 2873 656c  ion_conflict(sel
-00013e60: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
-00013e70: 656e 7429 202d 3e20 626f 6f6c 3a0a 2020  ent) -> bool:.  
-00013e80: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00013e90: 2020 4368 6563 6b73 2066 6f72 206f 7468    Checks for oth
-00013ea0: 6572 2069 7465 6d73 2069 6e20 7468 6520  er items in the 
-00013eb0: 7361 6d65 2064 6972 6563 746f 7279 2077  same directory w
-00013ec0: 6974 6820 6120 6469 6666 6572 656e 7420  ith a different 
-00013ed0: 6e61 6d65 2062 7574 2074 6865 2073 616d  name but the sam
-00013ee0: 650a 2020 2020 2020 2020 6e6f 726d 616c  e.        normal
-00013ef0: 697a 6174 696f 6e2e 0a0a 2020 2020 2020  ization...      
-00013f00: 2020 3a70 6172 616d 2065 7665 6e74 3a20    :param event: 
-00013f10: 5379 6e63 4576 656e 7420 666f 7220 6c6f  SyncEvent for lo
-00013f20: 6361 6c20 6372 6561 7465 6420 6f72 206d  cal created or m
-00013f30: 6f76 6564 2065 7665 6e74 2e0a 2020 2020  oved event..    
-00013f40: 2020 2020 3a72 6574 7572 6e73 3a20 5768      :returns: Wh
-00013f50: 6574 6865 7220 6120 6361 7365 2063 6f6e  ether a case con
-00013f60: 666c 6963 7420 7761 7320 6465 7465 6374  flict was detect
-00013f70: 6564 2061 6e64 2068 616e 646c 6564 2e0a  ed and handled..
-00013f80: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00013f90: 2020 2020 6966 206e 6f74 2028 6576 656e      if not (even
-00013fa0: 742e 6973 5f61 6464 6564 206f 7220 6576  t.is_added or ev
-00013fb0: 656e 742e 6973 5f6d 6f76 6564 293a 0a20  ent.is_moved):. 
-00013fc0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00013fd0: 6e20 4661 6c73 650a 0a20 2020 2020 2020  n False..       
-00013fe0: 2064 6972 6e61 6d65 2c20 6261 7365 6e61   dirname, basena
-00013ff0: 6d65 203d 206f 7370 2e73 706c 6974 2865  me = osp.split(e
-00014000: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
-00014010: 0a20 2020 2020 2020 2065 7175 6976 616c  .        equival
-00014020: 656e 745f 7061 7468 7320 3d20 6765 745f  ent_paths = get_
-00014030: 6578 6973 7469 6e67 5f65 7175 6976 616c  existing_equival
-00014040: 656e 745f 7061 7468 7328 6261 7365 6e61  ent_paths(basena
-00014050: 6d65 2c20 726f 6f74 3d64 6972 6e61 6d65  me, root=dirname
-00014060: 290a 0a20 2020 2020 2020 2069 6620 6c65  )..        if le
-00014070: 6e28 6571 7569 7661 6c65 6e74 5f70 6174  n(equivalent_pat
-00014080: 6873 2920 3e20 313a 0a20 2020 2020 2020  hs) > 1:.       
-00014090: 2020 2020 2023 2057 6520 6861 7665 2064       # We have d
-000140a0: 6966 6665 7265 6e74 2066 696c 6520 6e61  ifferent file na
-000140b0: 6d65 7320 7468 6174 2077 6f75 6c64 206d  mes that would m
-000140c0: 6170 2074 6f20 7468 6520 7361 6d65 206e  ap to the same n
-000140d0: 6f72 6d61 6c69 7a65 6420 7061 7468 210a  ormalized path!.
-000140e0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-000140f0: 666c 6963 745f 7061 7468 203d 206e 6578  flict_path = nex
-00014100: 7428 7020 666f 7220 7020 696e 2065 7175  t(p for p in equ
-00014110: 6976 616c 656e 745f 7061 7468 7320 6966  ivalent_paths if
-00014120: 2070 2021 3d20 6576 656e 742e 6c6f 6361   p != event.loca
-00014130: 6c5f 7061 7468 290a 0a20 2020 2020 2020  l_path)..       
-00014140: 2020 2020 2023 2043 6865 636b 2069 6620       # Check if 
-00014150: 7765 2068 6176 6520 6120 6361 7365 2063  we have a case c
-00014160: 6f6e 666c 6963 7420 6f72 2061 2075 6e69  onflict or a uni
-00014170: 636f 6465 2063 6f6e 666c 6963 742e 0a0a  code conflict...
-00014180: 2020 2020 2020 2020 2020 2020 6966 206e              if n
-00014190: 6f72 6d61 6c69 7a65 5f63 6173 6528 6576  ormalize_case(ev
-000141a0: 656e 742e 6c6f 6361 6c5f 7061 7468 2920  ent.local_path) 
-000141b0: 3d3d 206e 6f72 6d61 6c69 7a65 5f63 6173  == normalize_cas
-000141c0: 6528 636f 6e66 6c69 6374 5f70 6174 6829  e(conflict_path)
-000141d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000141e0: 2020 7375 6666 6978 203d 2022 6361 7365    suffix = "case
-000141f0: 2063 6f6e 666c 6963 7422 0a20 2020 2020   conflict".     
-00014200: 2020 2020 2020 2065 6c69 6620 6e6f 726d         elif norm
-00014210: 616c 697a 655f 756e 6963 6f64 6528 6576  alize_unicode(ev
-00014220: 656e 742e 6c6f 6361 6c5f 7061 7468 2920  ent.local_path) 
-00014230: 3d3d 206e 6f72 6d61 6c69 7a65 5f63 6173  == normalize_cas
-00014240: 6528 636f 6e66 6c69 6374 5f70 6174 6829  e(conflict_path)
-00014250: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00014260: 2020 7375 6666 6978 203d 2022 756e 6963    suffix = "unic
-00014270: 6f64 6520 636f 6e66 6c69 6374 220a 2020  ode conflict".  
-00014280: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00014290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000142a0: 7375 6666 6978 203d 2022 6e6f 726d 616c  suffix = "normal
-000142b0: 697a 6174 696f 6e20 636f 6e66 6c69 6374  ization conflict
-000142c0: 220a 0a20 2020 2020 2020 2020 2020 206c  "..            l
-000142d0: 6f63 616c 5f70 6174 685f 6363 203d 2067  ocal_path_cc = g
-000142e0: 656e 6572 6174 655f 6363 5f6e 616d 6528  enerate_cc_name(
-000142f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014300: 2065 7665 6e74 2e6c 6f63 616c 5f70 6174   event.local_pat
-00014310: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
-00014320: 2020 2073 7566 6669 783d 7375 6666 6978     suffix=suffix
-00014330: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
-00014340: 0a20 2020 2020 2020 2020 2020 2065 7665  .            eve
-00014350: 6e74 5f63 6c73 203d 2044 6972 4d6f 7665  nt_cls = DirMove
-00014360: 6445 7665 6e74 2069 6620 6973 6469 7228  dEvent if isdir(
-00014370: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-00014380: 2920 656c 7365 2046 696c 654d 6f76 6564  ) else FileMoved
-00014390: 4576 656e 740a 2020 2020 2020 2020 2020  Event.          
-000143a0: 2020 7769 7468 2073 656c 662e 6673 5f65    with self.fs_e
-000143b0: 7665 6e74 732e 6967 6e6f 7265 2865 7665  vents.ignore(eve
-000143c0: 6e74 5f63 6c73 2865 7665 6e74 2e6c 6f63  nt_cls(event.loc
-000143d0: 616c 5f70 6174 682c 206c 6f63 616c 5f70  al_path, local_p
-000143e0: 6174 685f 6363 2929 3a0a 2020 2020 2020  ath_cc)):.      
-000143f0: 2020 2020 2020 2020 2020 7769 7468 2063            with c
-00014400: 6f6e 7665 7274 5f61 7069 5f65 7272 6f72  onvert_api_error
-00014410: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00014420: 2020 2020 2020 2020 206d 6f76 6528 6576           move(ev
-00014430: 656e 742e 6c6f 6361 6c5f 7061 7468 2c20  ent.local_path, 
-00014440: 6c6f 6361 6c5f 7061 7468 5f63 632c 2072  local_path_cc, r
-00014450: 6169 7365 5f65 7272 6f72 3d54 7275 6529  aise_error=True)
-00014460: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00014470: 2020 7365 6c66 2e72 6573 6361 6e28 6c6f    self.rescan(lo
-00014480: 6361 6c5f 7061 7468 5f63 6329 0a0a 2020  cal_path_cc)..  
-00014490: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-000144a0: 6c6f 6767 6572 2e69 6e66 6f28 0a20 2020  logger.info(.   
-000144b0: 2020 2020 2020 2020 2020 2020 2027 4e6f               'No
-000144c0: 726d 616c 697a 6174 696f 6e20 636f 6e66  rmalization conf
-000144d0: 6c69 6374 3a20 7265 6e61 6d65 6420 2225  lict: renamed "%
-000144e0: 7322 2074 6f20 2225 7322 272c 0a20 2020  s" to "%s"',.   
-000144f0: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-00014500: 6e74 2e6c 6f63 616c 5f70 6174 682c 0a20  nt.local_path,. 
-00014510: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00014520: 6f63 616c 5f70 6174 685f 6363 2c0a 2020  ocal_path_cc,.  
-00014530: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00014540: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00014550: 5472 7565 0a20 2020 2020 2020 2065 6c73  True.        els
-00014560: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-00014570: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
-00014580: 2064 6566 205f 6861 6e64 6c65 5f73 656c   def _handle_sel
-00014590: 6563 7469 7665 5f73 796e 635f 636f 6e66  ective_sync_conf
-000145a0: 6c69 6374 2873 656c 662c 2065 7665 6e74  lict(self, event
-000145b0: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
-000145c0: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
-000145d0: 220a 2020 2020 2020 2020 4368 6563 6b73  ".        Checks
-000145e0: 2066 6f72 2069 7465 6d73 2069 6e20 7468   for items in th
-000145f0: 6520 6c6f 6361 6c20 6469 7265 6374 6f72  e local director
-00014600: 7920 7769 7468 2073 616d 6520 7061 7468  y with same path
-00014610: 2061 7320 616e 2069 7465 6d20 7768 6963   as an item whic
-00014620: 6820 6973 0a20 2020 2020 2020 2065 7863  h is.        exc
-00014630: 6c75 6465 6420 6279 2073 656c 6563 7469  luded by selecti
-00014640: 7665 2073 796e 632e 2052 656e 616d 6573  ve sync. Renames
-00014650: 2069 7465 6d73 2069 6620 6e65 6365 7373   items if necess
-00014660: 6172 792e 0a0a 2020 2020 2020 2020 3a70  ary...        :p
-00014670: 6172 616d 2065 7665 6e74 3a20 5379 6e63  aram event: Sync
-00014680: 4576 656e 7420 666f 7220 6c6f 6361 6c20  Event for local 
-00014690: 6372 6561 7465 6420 6f72 206d 6f76 6564  created or moved
-000146a0: 2065 7665 6e74 2e0a 2020 2020 2020 2020   event..        
-000146b0: 3a72 6574 7572 6e73 3a20 5768 6574 6865  :returns: Whethe
-000146c0: 7220 6120 7365 6c65 6374 6976 6520 7379  r a selective sy
-000146d0: 6e63 2063 6f6e 666c 6963 7420 7761 7320  nc conflict was 
-000146e0: 6465 7465 6374 6564 2061 6e64 2068 616e  detected and han
-000146f0: 646c 6564 2e0a 2020 2020 2020 2020 2222  dled..        ""
-00014700: 220a 2020 2020 2020 2020 6966 206e 6f74  ".        if not
-00014710: 2028 6576 656e 742e 6973 5f61 6464 6564   (event.is_added
-00014720: 206f 7220 6576 656e 742e 6973 5f6d 6f76   or event.is_mov
-00014730: 6564 293a 0a20 2020 2020 2020 2020 2020  ed):.           
-00014740: 2072 6574 7572 6e20 4661 6c73 650a 0a20   return False.. 
-00014750: 2020 2020 2020 2069 6620 7365 6c66 2e69         if self.i
-00014760: 735f 6578 636c 7564 6564 5f62 795f 7573  s_excluded_by_us
-00014770: 6572 2865 7665 6e74 2e64 6278 5f70 6174  er(event.dbx_pat
-00014780: 685f 6c6f 7765 7229 3a0a 2020 2020 2020  h_lower):.      
-00014790: 2020 2020 2020 6c6f 6361 6c5f 7061 7468        local_path
-000147a0: 5f63 6320 3d20 6765 6e65 7261 7465 5f63  _cc = generate_c
-000147b0: 635f 6e61 6d65 280a 2020 2020 2020 2020  c_name(.        
-000147c0: 2020 2020 2020 2020 6576 656e 742e 6c6f          event.lo
-000147d0: 6361 6c5f 7061 7468 2c0a 2020 2020 2020  cal_path,.      
-000147e0: 2020 2020 2020 2020 2020 7375 6666 6978            suffix
-000147f0: 3d22 7365 6c65 6374 6976 6520 7379 6e63  ="selective sync
-00014800: 2063 6f6e 666c 6963 7422 2c0a 2020 2020   conflict",.    
-00014810: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
-00014820: 2020 2020 2020 2065 7665 6e74 5f63 6c73         event_cls
-00014830: 203d 2044 6972 4d6f 7665 6445 7665 6e74   = DirMovedEvent
-00014840: 2069 6620 6973 6469 7228 6576 656e 742e   if isdir(event.
-00014850: 6c6f 6361 6c5f 7061 7468 2920 656c 7365  local_path) else
-00014860: 2046 696c 654d 6f76 6564 4576 656e 740a   FileMovedEvent.
-00014870: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00014880: 2073 656c 662e 6673 5f65 7665 6e74 732e   self.fs_events.
-00014890: 6967 6e6f 7265 2865 7665 6e74 5f63 6c73  ignore(event_cls
-000148a0: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
-000148b0: 682c 206c 6f63 616c 5f70 6174 685f 6363  h, local_path_cc
-000148c0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-000148d0: 2020 2020 7769 7468 2063 6f6e 7665 7274      with convert
-000148e0: 5f61 7069 5f65 7272 6f72 7328 293a 0a20  _api_errors():. 
-000148f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014900: 2020 206d 6f76 6528 6576 656e 742e 6c6f     move(event.lo
-00014910: 6361 6c5f 7061 7468 2c20 6c6f 6361 6c5f  cal_path, local_
-00014920: 7061 7468 5f63 632c 2072 6169 7365 5f65  path_cc, raise_e
-00014930: 7272 6f72 3d54 7275 6529 0a0a 2020 2020  rror=True)..    
-00014940: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00014950: 2e72 6573 6361 6e28 6c6f 6361 6c5f 7061  .rescan(local_pa
-00014960: 7468 5f63 6329 0a0a 2020 2020 2020 2020  th_cc)..        
-00014970: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-00014980: 2e69 6e66 6f28 0a20 2020 2020 2020 2020  .info(.         
-00014990: 2020 2020 2020 2027 5365 6c65 6374 6976         'Selectiv
-000149a0: 6520 7379 6e63 2063 6f6e 666c 6963 743a  e sync conflict:
-000149b0: 2072 656e 616d 6564 2022 2573 2220 746f   renamed "%s" to
-000149c0: 2022 2573 2227 2c0a 2020 2020 2020 2020   "%s"',.        
-000149d0: 2020 2020 2020 2020 6576 656e 742e 6c6f          event.lo
-000149e0: 6361 6c5f 7061 7468 2c0a 2020 2020 2020  cal_path,.      
-000149f0: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
-00014a00: 7061 7468 5f63 632c 0a20 2020 2020 2020  path_cc,.       
-00014a10: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-00014a20: 2020 2072 6574 7572 6e20 5472 7565 0a20     return True. 
-00014a30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00014a40: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-00014a50: 4661 6c73 650a 0a20 2020 2064 6566 205f  False..    def _
-00014a60: 6372 6561 7465 5f72 656d 6f74 655f 656e  create_remote_en
-00014a70: 7472 7928 7365 6c66 2c20 6576 656e 743a  try(self, event:
-00014a80: 2053 796e 6345 7665 6e74 2920 2d3e 2053   SyncEvent) -> S
-00014a90: 796e 6345 7665 6e74 3a0a 2020 2020 2020  yncEvent:.      
-00014aa0: 2020 2222 220a 2020 2020 2020 2020 4170    """.        Ap
-00014ab0: 706c 6965 7320 6120 6c6f 6361 6c20 6669  plies a local fi
-00014ac0: 6c65 2073 7973 7465 6d20 6576 656e 7420  le system event 
-00014ad0: 746f 2074 6865 2072 656d 6f74 6520 4472  to the remote Dr
-00014ae0: 6f70 626f 7820 616e 6420 636c 6561 7273  opbox and clears
-00014af0: 2061 6e79 2065 7869 7374 696e 670a 2020   any existing.  
-00014b00: 2020 2020 2020 7379 6e63 2065 7272 6f72        sync error
-00014b10: 7320 6265 6c6f 6e67 696e 6720 746f 2074  s belonging to t
-00014b20: 6861 7420 7061 7468 2e20 416e 7920 3a65  hat path. Any :e
-00014b30: 7863 3a60 6d61 6573 7472 616c 2e65 7863  xc:`maestral.exc
-00014b40: 6570 7469 6f6e 2e53 796e 6345 7272 6f72  eption.SyncError
-00014b50: 6020 7769 6c6c 0a20 2020 2020 2020 2062  ` will.        b
-00014b60: 6520 6361 7567 6874 2061 6e64 206c 6f67  e caught and log
-00014b70: 6765 6420 6173 2061 7070 726f 7072 6961  ged as appropria
-00014b80: 7465 2e0a 0a20 2020 2020 2020 2054 6869  te...        Thi
-00014b90: 7320 6d65 7468 6f64 2061 6c77 6179 7320  s method always 
-00014ba0: 7573 6573 2061 206e 6577 2063 6f70 7920  uses a new copy 
-00014bb0: 6f66 2063 6c69 656e 7420 616e 6420 636c  of client and cl
-00014bc0: 6f73 6573 2074 6865 206e 6574 776f 726b  oses the network
-00014bd0: 2073 6573 7369 6f6e 0a20 2020 2020 2020   session.       
-00014be0: 2061 6674 6572 7761 7264 732e 0a0a 2020   afterwards...  
-00014bf0: 2020 2020 2020 3a70 6172 616d 2065 7665        :param eve
-00014c00: 6e74 3a20 5379 6e63 4576 656e 7420 666f  nt: SyncEvent fo
-00014c10: 7220 6c6f 6361 6c20 6669 6c65 2065 7665  r local file eve
-00014c20: 6e74 2e0a 2020 2020 2020 2020 3a72 6574  nt..        :ret
-00014c30: 7572 6e73 3a20 5379 6e63 4576 656e 7420  urns: SyncEvent 
-00014c40: 7769 7468 2075 7064 6174 6564 2073 7461  with updated sta
-00014c50: 7475 732e 0a20 2020 2020 2020 2022 2222  tus..        """
-00014c60: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00014c70: 2e5f 6361 6e63 656c 5f72 6571 7565 7374  ._cancel_request
-00014c80: 6564 2e69 735f 7365 7428 293a 0a20 2020  ed.is_set():.   
-00014c90: 2020 2020 2020 2020 2072 6169 7365 2043           raise C
-00014ca0: 616e 6365 6c6c 6564 4572 726f 7228 2253  ancelledError("S
-00014cb0: 796e 6320 6361 6e63 656c 6c65 6422 290a  ync cancelled").
-00014cc0: 0a20 2020 2020 2020 2073 656c 662e 5f73  .        self._s
-00014cd0: 6c6f 775f 646f 776e 2829 0a0a 2020 2020  low_down()..    
-00014ce0: 2020 2020 6576 656e 742e 7374 6174 7573      event.status
-00014cf0: 203d 2053 796e 6353 7461 7475 732e 5379   = SyncStatus.Sy
-00014d00: 6e63 696e 670a 0a20 2020 2020 2020 2074  ncing..        t
-00014d10: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00014d20: 6966 2065 7665 6e74 2e69 735f 6669 6c65  if event.is_file
-00014d30: 2061 6e64 2028 6576 656e 742e 6973 5f61   and (event.is_a
-00014d40: 6464 6564 206f 7220 6576 656e 742e 6973  dded or event.is
-00014d50: 5f63 6861 6e67 6564 293a 0a20 2020 2020  _changed):.     
-00014d60: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-00014d70: 7320 3d20 7365 6c66 2e5f 6f6e 5f6c 6f63  s = self._on_loc
-00014d80: 616c 5f66 696c 655f 6d6f 6469 6669 6564  al_file_modified
-00014d90: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
-00014da0: 2020 2020 656c 6966 2065 7665 6e74 2e69      elif event.i
-00014db0: 735f 6469 7265 6374 6f72 7920 616e 6420  s_directory and 
-00014dc0: 6576 656e 742e 6973 5f61 6464 6564 3a0a  event.is_added:.
-00014dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014de0: 7374 6174 7573 203d 2073 656c 662e 5f6f  status = self._o
-00014df0: 6e5f 6c6f 6361 6c5f 666f 6c64 6572 5f63  n_local_folder_c
-00014e00: 7265 6174 6564 2865 7665 6e74 290a 2020  reated(event).  
-00014e10: 2020 2020 2020 2020 2020 656c 6966 2065            elif e
-00014e20: 7665 6e74 2e69 735f 6d6f 7665 643a 0a20  vent.is_moved:. 
-00014e30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00014e40: 7461 7475 7320 3d20 7365 6c66 2e5f 6f6e  tatus = self._on
-00014e50: 5f6c 6f63 616c 5f6d 6f76 6564 2865 7665  _local_moved(eve
-00014e60: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-00014e70: 656c 6966 2065 7665 6e74 2e69 735f 6465  elif event.is_de
-00014e80: 6c65 7465 643a 0a20 2020 2020 2020 2020  leted:.         
-00014e90: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
-00014ea0: 7365 6c66 2e5f 6f6e 5f6c 6f63 616c 5f64  self._on_local_d
-00014eb0: 656c 6574 6564 2865 7665 6e74 290a 2020  eleted(event).  
-00014ec0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00014ed0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014ee0: 7374 6174 7573 203d 2053 796e 6353 7461  status = SyncSta
-00014ef0: 7475 732e 536b 6970 7065 640a 0a20 2020  tus.Skipped..   
-00014f00: 2020 2020 2020 2020 2065 7665 6e74 2e73           event.s
-00014f10: 7461 7475 7320 3d20 7374 6174 7573 0a0a  tatus = status..
-00014f20: 2020 2020 2020 2020 6578 6365 7074 2053          except S
-00014f30: 796e 6345 7272 6f72 2061 7320 6572 723a  yncError as err:
-00014f40: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00014f50: 662e 5f68 616e 646c 655f 7379 6e63 5f65  f._handle_sync_e
-00014f60: 7272 6f72 2865 7272 2c20 6469 7265 6374  rror(err, direct
-00014f70: 696f 6e3d 5379 6e63 4469 7265 6374 696f  ion=SyncDirectio
-00014f80: 6e2e 5570 290a 2020 2020 2020 2020 2020  n.Up).          
-00014f90: 2020 6576 656e 742e 7374 6174 7573 203d    event.status =
-00014fa0: 2053 796e 6353 7461 7475 732e 4661 696c   SyncStatus.Fail
-00014fb0: 6564 0a20 2020 2020 2020 2065 6c73 653a  ed.        else:
-00014fc0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00014fd0: 662e 636c 6561 725f 7379 6e63 5f65 7272  f.clear_sync_err
-00014fe0: 6f72 735f 6672 6f6d 5f65 7665 6e74 2865  ors_from_event(e
-00014ff0: 7665 6e74 290a 2020 2020 2020 2020 2020  vent).          
-00015000: 2020 7365 6c66 2e61 6374 6976 6974 792e    self.activity.
-00015010: 6469 7363 6172 6428 6576 656e 7429 0a0a  discard(event)..
-00015020: 2020 2020 2020 2020 2320 4164 6420 6576          # Add ev
-00015030: 656e 7473 2074 6f20 6869 7374 6f72 7920  ents to history 
-00015040: 6461 7461 6261 7365 2e0a 2020 2020 2020  database..      
-00015050: 2020 6966 2065 7665 6e74 2e73 7461 7475    if event.statu
-00015060: 7320 3d3d 2053 796e 6353 7461 7475 732e  s == SyncStatus.
-00015070: 446f 6e65 3a0a 2020 2020 2020 2020 2020  Done:.          
-00015080: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
-00015090: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
-000150a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000150b0: 7365 6c66 2e5f 6869 7374 6f72 795f 7461  self._history_ta
-000150c0: 626c 652e 7361 7665 2865 7665 6e74 290a  ble.save(event).
-000150d0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000150e0: 6576 656e 740a 0a20 2020 2040 7374 6174  event..    @stat
-000150f0: 6963 6d65 7468 6f64 0a20 2020 2064 6566  icmethod.    def
-00015100: 205f 7761 6974 5f66 6f72 5f63 7265 6174   _wait_for_creat
-00015110: 696f 6e28 6c6f 6361 6c5f 7061 7468 3a20  ion(local_path: 
-00015120: 7374 7229 202d 3e20 4e6f 6e65 3a0a 2020  str) -> None:.  
-00015130: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00015140: 2020 5761 6974 2066 6f72 2061 2066 696c    Wait for a fil
-00015150: 6520 6174 2061 2070 6174 6820 746f 2062  e at a path to b
-00015160: 6520 6372 6561 7465 6420 6f72 206d 6f64  e created or mod
-00015170: 6966 6965 642e 0a0a 2020 2020 2020 2020  ified...        
-00015180: 3a70 6172 616d 206c 6f63 616c 5f70 6174  :param local_pat
-00015190: 683a 2041 6273 6f6c 7574 6520 7061 7468  h: Absolute path
-000151a0: 2074 6f20 6669 6c65 206f 6e20 6472 6976   to file on driv
-000151b0: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-000151c0: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-000151d0: 2020 2020 2020 2020 7768 696c 6520 5472          while Tr
-000151e0: 7565 3a0a 2020 2020 2020 2020 2020 2020  ue:.            
-000151f0: 2020 2020 7369 7a65 3120 3d20 6765 7473      size1 = gets
-00015200: 697a 6528 6c6f 6361 6c5f 7061 7468 290a  ize(local_path).
-00015210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015220: 7469 6d65 2e73 6c65 6570 2830 2e32 290a  time.sleep(0.2).
-00015230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015240: 7369 7a65 3220 3d20 6765 7473 697a 6528  size2 = getsize(
-00015250: 6c6f 6361 6c5f 7061 7468 290a 2020 2020  local_path).    
-00015260: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00015270: 697a 6531 203d 3d20 7369 7a65 323a 0a20  ize1 == size2:. 
-00015280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015290: 2020 2072 6574 7572 6e0a 2020 2020 2020     return.      
-000152a0: 2020 6578 6365 7074 204f 5345 7272 6f72    except OSError
-000152b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-000152c0: 7475 726e 0a0a 2020 2020 6465 6620 5f6f  turn..    def _o
-000152d0: 6e5f 6c6f 6361 6c5f 6d6f 7665 6428 7365  n_local_moved(se
-000152e0: 6c66 2c20 6576 656e 743a 2053 796e 6345  lf, event: SyncE
-000152f0: 7665 6e74 2920 2d3e 2053 796e 6353 7461  vent) -> SyncSta
-00015300: 7475 733a 0a20 2020 2020 2020 2022 2222  tus:.        """
-00015310: 0a20 2020 2020 2020 2043 616c 6c20 7768  .        Call wh
-00015320: 656e 2061 206c 6f63 616c 2069 7465 6d20  en a local item 
-00015330: 6973 206d 6f76 6564 2e0a 0a20 2020 2020  is moved...     
-00015340: 2020 204b 6565 7020 696e 206d 696e 6420     Keep in mind 
-00015350: 7468 6174 2077 6520 6d61 7920 6265 206d  that we may be m
-00015360: 6f76 696e 6720 6120 7768 6f6c 6520 7472  oving a whole tr
-00015370: 6565 206f 6620 6974 656d 732e 2042 7574  ee of items. But
-00015380: 2069 7473 2062 6574 7465 7220 6465 616c   its better deal
-00015390: 0a20 2020 2020 2020 2077 6974 6820 7468  .        with th
-000153a0: 6520 636f 6d70 6c65 7869 7479 2074 6861  e complexity tha
-000153b0: 6e20 746f 2064 656c 6574 6520 616e 6420  n to delete and 
-000153c0: 7265 2d75 706c 6f61 6469 6e67 2065 7665  re-uploading eve
-000153d0: 7279 7468 696e 672e 2054 6861 6e6b 6675  rything. Thankfu
-000153e0: 6c6c 792c 2069 6e0a 2020 2020 2020 2020  lly, in.        
-000153f0: 6361 7365 206f 6620 6469 7265 6374 6f72  case of director
-00015400: 6965 732c 2077 6520 616c 7761 7973 2070  ies, we always p
-00015410: 726f 6365 7373 2074 6865 2074 6f70 2d6c  rocess the top-l
-00015420: 6576 656c 2066 6972 7374 2e20 5472 7969  evel first. Tryi
-00015430: 6e67 2074 6f20 6d6f 7665 2074 6865 0a20  ng to move the. 
-00015440: 2020 2020 2020 2063 6869 6c64 7265 6e20         children 
-00015450: 7769 6c6c 2074 6865 6e20 6265 2064 656c  will then be del
-00015460: 6567 6174 6564 2074 6f20 606f 6e5f 6372  egated to `on_cr
-00015470: 6561 7465 6020 2862 6563 6175 7365 2074  eate` (because t
-00015480: 6865 206f 6c64 2069 7465 6d20 6e6f 206c  he old item no l
-00015490: 6f6e 6765 720a 2020 2020 2020 2020 6c69  onger.        li
-000154a0: 7665 7320 6f6e 2044 726f 7062 6f78 2920  ves on Dropbox) 
-000154b0: 616e 6420 7468 6174 2077 6f6e 2774 2075  and that won't u
-000154c0: 706c 6f61 6420 616e 7974 6869 6e67 2062  pload anything b
-000154d0: 6563 6175 7365 2066 696c 6520 636f 6e74  ecause file cont
-000154e0: 656e 7473 2068 6176 650a 2020 2020 2020  ents have.      
-000154f0: 2020 7265 6d61 696e 6564 2074 6865 2073    remained the s
-00015500: 616d 652e 0a0a 2020 2020 2020 2020 3a70  ame...        :p
-00015510: 6172 616d 2065 7665 6e74 3a20 5379 6e63  aram event: Sync
-00015520: 4576 656e 7420 666f 7220 6c6f 6361 6c20  Event for local 
-00015530: 6d6f 7665 6420 6576 656e 742e 0a20 2020  moved event..   
-00015540: 2020 2020 203a 7265 7475 726e 733a 204d       :returns: M
-00015550: 6574 6164 6174 6120 666f 7220 6372 6561  etadata for crea
-00015560: 7465 6420 7265 6d6f 7465 2069 7465 6d20  ted remote item 
-00015570: 6174 2064 6573 7469 6e61 7469 6f6e 2e0a  at destination..
-00015580: 2020 2020 2020 2020 3a72 6169 7365 7320          :raises 
-00015590: 4d61 6573 7472 616c 4170 6945 7272 6f72  MaestralApiError
-000155a0: 3a20 466f 7220 616e 7920 6973 7375 6573  : For any issues
-000155b0: 2077 6865 6e20 7379 6e63 696e 6720 7468   when syncing th
-000155c0: 6520 6974 656d 2e0a 2020 2020 2020 2020  e item..        
-000155d0: 2222 220a 2020 2020 2020 2020 6368 6563  """.        chec
-000155e0: 6b5f 6368 616e 6765 5f74 7970 6528 6576  k_change_type(ev
-000155f0: 656e 742c 207b 4368 616e 6765 5479 7065  ent, {ChangeType
-00015600: 2e4d 6f76 6564 7d29 0a20 2020 2020 2020  .Moved}).       
-00015610: 2063 6865 636b 5f65 6e63 6f64 696e 6728   check_encoding(
-00015620: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-00015630: 290a 0a20 2020 2020 2020 2069 6620 6576  )..        if ev
-00015640: 656e 742e 6c6f 6361 6c5f 7061 7468 5f66  ent.local_path_f
-00015650: 726f 6d20 3d3d 2073 656c 662e 6472 6f70  rom == self.drop
-00015660: 626f 785f 7061 7468 3a0a 2020 2020 2020  box_path:.      
-00015670: 2020 2020 2020 7365 6c66 2e65 6e73 7572        self.ensur
-00015680: 655f 6472 6f70 626f 785f 666f 6c64 6572  e_dropbox_folder
-00015690: 5f70 7265 7365 6e74 2829 0a0a 2020 2020  _present()..    
-000156a0: 2020 2020 6966 2073 656c 662e 5f68 616e      if self._han
-000156b0: 646c 655f 7365 6c65 6374 6976 655f 7379  dle_selective_sy
-000156c0: 6e63 5f63 6f6e 666c 6963 7428 6576 656e  nc_conflict(even
-000156d0: 7429 3a0a 2020 2020 2020 2020 2020 2020  t):.            
-000156e0: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
-000156f0: 732e 536b 6970 7065 640a 2020 2020 2020  s.Skipped.      
-00015700: 2020 6966 2073 656c 662e 5f68 616e 646c    if self._handl
-00015710: 655f 6e6f 726d 616c 697a 6174 696f 6e5f  e_normalization_
-00015720: 636f 6e66 6c69 6374 2865 7665 6e74 293a  conflict(event):
-00015730: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00015740: 7572 6e20 5379 6e63 5374 6174 7573 2e53  urn SyncStatus.S
-00015750: 6b69 7070 6564 0a0a 2020 2020 2020 2020  kipped..        
-00015760: 6462 785f 7061 7468 5f66 726f 6d20 3d20  dbx_path_from = 
-00015770: 6361 7374 2873 7472 2c20 6576 656e 742e  cast(str, event.
-00015780: 6462 785f 7061 7468 5f66 726f 6d29 0a0a  dbx_path_from)..
-00015790: 2020 2020 2020 2020 2320 4966 2061 2066          # If a f
-000157a0: 696c 6520 6174 2074 6865 2064 6573 7469  ile at the desti
-000157b0: 6e61 7469 6f6e 2073 686f 756c 6420 6265  nation should be
-000157c0: 2072 6570 6c61 6365 642c 2072 656d 6f76   replaced, remov
-000157d0: 6520 6974 2066 6972 7374 2c20 6275 7420  e it first, but 
-000157e0: 6f6e 6c79 2069 660a 2020 2020 2020 2020  only if.        
-000157f0: 2320 6974 7320 7265 7620 6d61 7463 6865  # its rev matche
-00015800: 7320 7468 6520 7265 7620 6f66 2074 6865  s the rev of the
-00015810: 206c 6f63 616c 206f 7665 7277 7269 7474   local overwritt
-00015820: 656e 2066 696c 652e 0a20 2020 2020 2020  en file..       
-00015830: 2023 2054 6865 2044 726f 7062 6f78 2041   # The Dropbox A
-00015840: 5049 2064 6f65 7320 6e6f 7420 616c 6c6f  PI does not allo
-00015850: 7720 6f76 6572 7772 6974 696e 6720 6120  w overwriting a 
-00015860: 6465 7374 696e 6174 696f 6e20 6669 6c65  destination file
-00015870: 2064 7572 696e 6720 6120 6d6f 7665 2e0a   during a move..
-00015880: 2020 2020 2020 2020 6c6f 6361 6c5f 656e          local_en
-00015890: 7472 7920 3d20 7365 6c66 2e67 6574 5f69  try = self.get_i
-000158a0: 6e64 6578 5f65 6e74 7279 2865 7665 6e74  ndex_entry(event
-000158b0: 2e64 6278 5f70 6174 685f 6c6f 7765 7229  .dbx_path_lower)
-000158c0: 0a0a 2020 2020 2020 2020 6966 206c 6f63  ..        if loc
-000158d0: 616c 5f65 6e74 7279 2061 6e64 206c 6f63  al_entry and loc
-000158e0: 616c 5f65 6e74 7279 2e69 735f 6669 6c65  al_entry.is_file
-000158f0: 3a0a 2020 2020 2020 2020 2020 2020 7472  :.            tr
-00015900: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
-00015910: 2020 2073 656c 662e 636c 6965 6e74 2e72     self.client.r
-00015920: 656d 6f76 6528 0a20 2020 2020 2020 2020  emove(.         
-00015930: 2020 2020 2020 2020 2020 206c 6f63 616c             local
-00015940: 5f65 6e74 7279 2e64 6278 5f70 6174 685f  _entry.dbx_path_
-00015950: 6c6f 7765 722c 2070 6172 656e 745f 7265  lower, parent_re
-00015960: 763d 6c6f 6361 6c5f 656e 7472 792e 7265  v=local_entry.re
-00015970: 760a 2020 2020 2020 2020 2020 2020 2020  v.              
-00015980: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00015990: 6578 6365 7074 2028 4e6f 7446 6f75 6e64  except (NotFound
-000159a0: 4572 726f 722c 2046 696c 6543 6f6e 666c  Error, FileConfl
-000159b0: 6963 7445 7272 6f72 293a 0a20 2020 2020  ictError):.     
-000159c0: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
-000159d0: 2020 2020 2020 2020 2020 2020 656c 7365              else
-000159e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000159f0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
-00015a00: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-00015a10: 2020 2020 2020 2020 2020 2752 6570 6c61            'Repla
-00015a20: 6369 6e67 2065 7869 7374 696e 6720 6669  cing existing fi
-00015a30: 6c65 2022 2573 2220 6279 206d 6f76 6527  le "%s" by move'
-00015a40: 2c20 6c6f 6361 6c5f 656e 7472 792e 6462  , local_entry.db
-00015a50: 785f 7061 7468 5f6c 6f77 6572 0a20 2020  x_path_lower.   
-00015a60: 2020 2020 2020 2020 2020 2020 2029 0a0a               )..
-00015a70: 2020 2020 2020 2020 2320 5065 7266 6f72          # Perfor
-00015a80: 6d20 7468 6520 6d6f 7665 2e0a 2020 2020  m the move..    
-00015a90: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
-00015aa0: 2020 2020 206d 645f 746f 5f6e 6577 203d       md_to_new =
-00015ab0: 2073 656c 662e 636c 6965 6e74 2e6d 6f76   self.client.mov
-00015ac0: 6528 6462 785f 7061 7468 5f66 726f 6d2c  e(dbx_path_from,
-00015ad0: 2065 7665 6e74 2e64 6278 5f70 6174 682c   event.dbx_path,
-00015ae0: 2061 7574 6f72 656e 616d 653d 5472 7565   autorename=True
-00015af0: 290a 2020 2020 2020 2020 6578 6365 7074  ).        except
-00015b00: 204e 6f74 466f 756e 6445 7272 6f72 3a0a   NotFoundError:.
-00015b10: 2020 2020 2020 2020 2020 2020 2320 4966              # If
-00015b20: 206e 6f74 206f 6e20 4472 6f70 626f 782c   not on Dropbox,
-00015b30: 2065 2e67 2e2c 2062 6563 6175 7365 2069   e.g., because i
-00015b40: 7473 206f 6c64 206e 616d 6520 7761 7320  ts old name was 
-00015b50: 696e 7661 6c69 642c 0a20 2020 2020 2020  invalid,.       
-00015b60: 2020 2020 2023 2063 7265 6174 6520 6974       # create it
-00015b70: 2069 6e73 7465 6164 206f 6620 6d6f 7669   instead of movi
-00015b80: 6e67 2069 742e 0a20 2020 2020 2020 2020  ng it..         
-00015b90: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-00015ba0: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
-00015bb0: 2020 2020 2020 2027 436f 756c 6420 6e6f         'Could no
-00015bc0: 7420 6d6f 7665 2022 2573 2220 2d3e 2022  t move "%s" -> "
-00015bd0: 2573 2220 6f6e 2044 726f 7062 6f78 2c20  %s" on Dropbox, 
-00015be0: 736f 7572 6365 2064 6f65 7320 6e6f 7420  source does not 
-00015bf0: 6578 6973 7473 2e20 270a 2020 2020 2020  exists. '.      
-00015c00: 2020 2020 2020 2020 2020 2743 7265 6174            'Creat
-00015c10: 696e 6720 2225 7322 2069 6e73 7465 6164  ing "%s" instead
-00015c20: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-00015c30: 2020 2065 7665 6e74 2e64 6278 5f70 6174     event.dbx_pat
-00015c40: 685f 6672 6f6d 2c0a 2020 2020 2020 2020  h_from,.        
-00015c50: 2020 2020 2020 2020 6576 656e 742e 6462          event.db
-00015c60: 785f 7061 7468 2c0a 2020 2020 2020 2020  x_path,.        
-00015c70: 2020 2020 2020 2020 6576 656e 742e 6462          event.db
-00015c80: 785f 7061 7468 2c0a 2020 2020 2020 2020  x_path,.        
-00015c90: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-00015ca0: 2020 2073 656c 662e 7265 7363 616e 2865     self.rescan(e
-00015cb0: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
-00015cc0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-00015cd0: 7572 6e20 5379 6e63 5374 6174 7573 2e53  urn SyncStatus.S
-00015ce0: 6b69 7070 6564 0a0a 2020 2020 2020 2020  kipped..        
-00015cf0: 6173 7365 7274 2065 7665 6e74 2e64 6278  assert event.dbx
-00015d00: 5f70 6174 685f 6672 6f6d 5f6c 6f77 6572  _path_from_lower
-00015d10: 2069 7320 6e6f 7420 4e6f 6e65 0a20 2020   is not None.   
-00015d20: 2020 2020 2073 656c 662e 7265 6d6f 7665       self.remove
-00015d30: 5f6e 6f64 655f 6672 6f6d 5f69 6e64 6578  _node_from_index
-00015d40: 2865 7665 6e74 2e64 6278 5f70 6174 685f  (event.dbx_path_
-00015d50: 6672 6f6d 5f6c 6f77 6572 290a 0a20 2020  from_lower)..   
-00015d60: 2020 2020 2069 6620 7365 6c66 2e5f 6861       if self._ha
-00015d70: 6e64 6c65 5f75 706c 6f61 645f 636f 6e66  ndle_upload_conf
-00015d80: 6c69 6374 286d 645f 746f 5f6e 6577 2c20  lict(md_to_new, 
-00015d90: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
-00015da0: 2020 2020 7374 6174 7573 203d 2053 796e      status = Syn
-00015db0: 6353 7461 7475 732e 436f 6e66 6c69 6374  cStatus.Conflict
-00015dc0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-00015dd0: 2020 2020 2020 2020 2020 2073 7461 7475             statu
-00015de0: 7320 3d20 5379 6e63 5374 6174 7573 2e44  s = SyncStatus.D
-00015df0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00015e00: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
-00015e10: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-00015e20: 2020 2020 274d 6f76 6564 2022 2573 2220      'Moved "%s" 
-00015e30: 746f 2022 2573 2220 6f6e 2044 726f 7062  to "%s" on Dropb
-00015e40: 6f78 272c 2064 6278 5f70 6174 685f 6672  ox', dbx_path_fr
-00015e50: 6f6d 2c20 6576 656e 742e 6462 785f 7061  om, event.dbx_pa
-00015e60: 7468 0a20 2020 2020 2020 2020 2020 2029  th.            )
-00015e70: 0a20 2020 2020 2020 2073 656c 662e 5f75  .        self._u
-00015e80: 7064 6174 655f 696e 6465 785f 7265 6375  pdate_index_recu
-00015e90: 7273 6976 6528 6d64 5f74 6f5f 6e65 7729  rsive(md_to_new)
-00015ea0: 0a0a 2020 2020 2020 2020 7265 7475 726e  ..        return
-00015eb0: 2073 7461 7475 730a 0a20 2020 2064 6566   status..    def
-00015ec0: 205f 7570 6461 7465 5f69 6e64 6578 5f72   _update_index_r
-00015ed0: 6563 7572 7369 7665 2873 656c 662c 206d  ecursive(self, m
-00015ee0: 643a 204d 6574 6164 6174 6129 202d 3e20  d: Metadata) -> 
-00015ef0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
-00015f00: 6c66 2e75 7064 6174 655f 696e 6465 785f  lf.update_index_
-00015f10: 6672 6f6d 5f64 6278 5f6d 6574 6164 6174  from_dbx_metadat
-00015f20: 6128 6d64 290a 0a20 2020 2020 2020 2069  a(md)..        i
-00015f30: 6620 6973 696e 7374 616e 6365 286d 642c  f isinstance(md,
-00015f40: 2046 6f6c 6465 724d 6574 6164 6174 6129   FolderMetadata)
-00015f50: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00015f60: 7375 6c74 203d 2073 656c 662e 636c 6965  sult = self.clie
-00015f70: 6e74 2e6c 6973 745f 666f 6c64 6572 286d  nt.list_folder(m
-00015f80: 642e 7061 7468 5f6c 6f77 6572 2c20 7265  d.path_lower, re
-00015f90: 6375 7273 6976 653d 5472 7565 290a 2020  cursive=True).  
-00015fa0: 2020 2020 2020 2020 2020 666f 7220 6d64            for md
-00015fb0: 2069 6e20 7265 7375 6c74 2e65 6e74 7269   in result.entri
-00015fc0: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-00015fd0: 2020 2020 7365 6c66 2e75 7064 6174 655f      self.update_
-00015fe0: 696e 6465 785f 6672 6f6d 5f64 6278 5f6d  index_from_dbx_m
-00015ff0: 6574 6164 6174 6128 6d64 290a 0a20 2020  etadata(md)..   
-00016000: 2064 6566 205f 6f6e 5f6c 6f63 616c 5f66   def _on_local_f
-00016010: 696c 655f 6d6f 6469 6669 6564 2873 656c  ile_modified(sel
-00016020: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
-00016030: 656e 7429 202d 3e20 5379 6e63 5374 6174  ent) -> SyncStat
-00016040: 7573 3a0a 2020 2020 2020 2020 2222 220a  us:.        """.
-00016050: 2020 2020 2020 2020 4361 6c6c 2077 6865          Call whe
-00016060: 6e20 6120 6c6f 6361 6c20 6669 6c65 2069  n a local file i
-00016070: 7320 6372 6561 7465 6420 6f72 206d 6f64  s created or mod
-00016080: 6966 6965 642e 0a0a 2020 2020 2020 2020  ified...        
-00016090: 3a70 6172 616d 2065 7665 6e74 3a20 5379  :param event: Sy
-000160a0: 6e63 4576 656e 7420 636f 7272 6573 706f  ncEvent correspo
-000160b0: 6e64 696e 6720 746f 206c 6f63 616c 2063  nding to local c
-000160c0: 7265 6174 6564 2065 7665 6e74 2e0a 2020  reated event..  
-000160d0: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-000160e0: 4d65 7461 6461 7461 2066 6f72 2063 7265  Metadata for cre
-000160f0: 6174 6564 2069 7465 6d20 6f72 204e 6f6e  ated item or Non
-00016100: 6520 6966 206e 6f20 7265 6d6f 7465 2069  e if no remote i
-00016110: 7465 6d20 6973 2063 7265 6174 6564 2e0a  tem is created..
-00016120: 2020 2020 2020 2020 3a72 6169 7365 7320          :raises 
-00016130: 4d61 6573 7472 616c 4170 6945 7272 6f72  MaestralApiError
-00016140: 3a20 466f 7220 616e 7920 6973 7375 6573  : For any issues
-00016150: 2077 6865 6e20 7379 6e63 696e 6720 7468   when syncing th
-00016160: 6520 6974 656d 2e0a 2020 2020 2020 2020  e item..        
-00016170: 3a72 6169 7365 7320 5661 6c75 6545 7272  :raises ValueErr
-00016180: 6f72 3a20 4966 2074 6865 2043 6861 6e67  or: If the Chang
-00016190: 6554 7970 6520 6973 206e 6f74 2041 6464  eType is not Add
-000161a0: 6564 206f 7220 4d6f 6469 6669 6564 2e0a  ed or Modified..
-000161b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-000161c0: 2020 2020 6368 6563 6b5f 6368 616e 6765      check_change
-000161d0: 5f74 7970 6528 6576 656e 742c 207b 4368  _type(event, {Ch
-000161e0: 616e 6765 5479 7065 2e41 6464 6564 2c20  angeType.Added, 
-000161f0: 4368 616e 6765 5479 7065 2e4d 6f64 6966  ChangeType.Modif
-00016200: 6965 647d 290a 2020 2020 2020 2020 6368  ied}).        ch
-00016210: 6563 6b5f 656e 636f 6469 6e67 2865 7665  eck_encoding(eve
-00016220: 6e74 2e6c 6f63 616c 5f70 6174 6829 0a0a  nt.local_path)..
-00016230: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-00016240: 5f68 616e 646c 655f 7365 6c65 6374 6976  _handle_selectiv
-00016250: 655f 7379 6e63 5f63 6f6e 666c 6963 7428  e_sync_conflict(
-00016260: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
-00016270: 2020 2020 7265 7475 726e 2053 796e 6353      return SyncS
-00016280: 7461 7475 732e 436f 6e66 6c69 6374 0a20  tatus.Conflict. 
-00016290: 2020 2020 2020 2069 6620 7365 6c66 2e5f         if self._
-000162a0: 6861 6e64 6c65 5f6e 6f72 6d61 6c69 7a61  handle_normaliza
-000162b0: 7469 6f6e 5f63 6f6e 666c 6963 7428 6576  tion_conflict(ev
-000162c0: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
-000162d0: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
-000162e0: 7475 732e 436f 6e66 6c69 6374 0a0a 2020  tus.Conflict..  
-000162f0: 2020 2020 2020 7365 6c66 2e5f 7761 6974        self._wait
-00016300: 5f66 6f72 5f63 7265 6174 696f 6e28 6576  _for_creation(ev
-00016310: 656e 742e 6c6f 6361 6c5f 7061 7468 290a  ent.local_path).
-00016320: 0a20 2020 2020 2020 2023 2043 6865 636b  .        # Check
-00016330: 2069 6620 6974 656d 2061 6c72 6561 6479   if item already
-00016340: 2065 7869 7374 7320 7769 7468 2069 6465   exists with ide
-00016350: 6e74 6963 616c 2063 6f6e 7465 6e74 2e0a  ntical content..
-00016360: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-00016370: 656c 662e 5f63 6865 636b 5f72 6571 7569  elf._check_requi
-00016380: 7265 735f 7570 6c6f 6164 2865 7665 6e74  res_upload(event
-00016390: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-000163a0: 6574 7572 6e20 5379 6e63 5374 6174 7573  eturn SyncStatus
-000163b0: 2e53 6b69 7070 6564 0a0a 2020 2020 2020  .Skipped..      
-000163c0: 2020 6c6f 6361 6c5f 656e 7472 7920 3d20    local_entry = 
-000163d0: 7365 6c66 2e67 6574 5f69 6e64 6578 5f65  self.get_index_e
-000163e0: 6e74 7279 2865 7665 6e74 2e64 6278 5f70  ntry(event.dbx_p
-000163f0: 6174 685f 6c6f 7765 7229 0a20 2020 2020  ath_lower).     
-00016400: 2020 206c 6f63 616c 5f72 6576 3a20 7374     local_rev: st
-00016410: 7220 7c20 4e6f 6e65 203d 204e 6f6e 650a  r | None = None.
-00016420: 0a20 2020 2020 2020 2069 6620 6e6f 7420  .        if not 
-00016430: 6c6f 6361 6c5f 656e 7472 793a 0a20 2020  local_entry:.   
-00016440: 2020 2020 2020 2020 2023 2046 696c 6520           # File 
-00016450: 6973 206e 6577 2074 6f20 7573 2c20 6c65  is new to us, le
-00016460: 7420 4472 6f70 626f 7820 7265 6e61 6d65  t Dropbox rename
-00016470: 2069 7420 6966 2073 6f6d 6574 6869 6e67   it if something
-00016480: 2069 7320 696e 2074 6865 2077 6179 2e0a   is in the way..
-00016490: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
-000164a0: 203d 2057 7269 7465 4d6f 6465 2e41 6464   = WriteMode.Add
-000164b0: 0a20 2020 2020 2020 2020 2020 2065 7665  .            eve
-000164c0: 6e74 2e63 6861 6e67 655f 7479 7065 203d  nt.change_type =
-000164d0: 2043 6861 6e67 6554 7970 652e 4164 6465   ChangeType.Adde
-000164e0: 640a 2020 2020 2020 2020 656c 6966 206c  d.        elif l
-000164f0: 6f63 616c 5f65 6e74 7279 2e69 735f 6469  ocal_entry.is_di
-00016500: 7265 6374 6f72 793a 0a20 2020 2020 2020  rectory:.       
-00016510: 2020 2020 2023 2054 7279 2074 6f20 6f76       # Try to ov
-00016520: 6572 7772 6974 6520 7468 6520 6465 7374  erwrite the dest
-00016530: 696e 6174 696f 6e2c 2074 6869 7320 7769  ination, this wi
-00016540: 6c6c 2066 6169 6c2e 2e2e 0a20 2020 2020  ll fail....     
-00016550: 2020 2020 2020 206d 6f64 6520 3d20 5772         mode = Wr
-00016560: 6974 654d 6f64 652e 4f76 6572 7772 6974  iteMode.Overwrit
-00016570: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-00016580: 2020 2020 2020 2020 2020 2020 2320 4669              # Fi
-00016590: 6c65 2068 6173 2062 6565 6e20 6d6f 6469  le has been modi
-000165a0: 6669 6564 2c20 7570 6461 7465 2072 656d  fied, update rem
-000165b0: 6f74 6520 6966 206d 6174 6368 696e 6720  ote if matching 
-000165c0: 7265 762c 0a20 2020 2020 2020 2020 2020  rev,.           
-000165d0: 2023 2063 7265 6174 6520 636f 6e66 6c69   # create confli
-000165e0: 6374 206f 7468 6572 7769 7365 2e0a 2020  ct otherwise..  
-000165f0: 2020 2020 2020 2020 2020 6d6f 6465 203d            mode =
-00016600: 2057 7269 7465 4d6f 6465 2e55 7064 6174   WriteMode.Updat
-00016610: 650a 2020 2020 2020 2020 2020 2020 6576  e.            ev
-00016620: 656e 742e 6368 616e 6765 5f74 7970 6520  ent.change_type 
-00016630: 3d20 4368 616e 6765 5479 7065 2e4d 6f64  = ChangeType.Mod
-00016640: 6966 6965 640a 2020 2020 2020 2020 2020  ified.          
-00016650: 2020 6c6f 6361 6c5f 7265 7620 3d20 6c6f    local_rev = lo
-00016660: 6361 6c5f 656e 7472 792e 7265 760a 0a20  cal_entry.rev.. 
-00016670: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-00016680: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
-00016690: 662e 5f70 6172 616c 6c65 6c5f 7570 5f73  f._parallel_up_s
-000166a0: 656d 6170 686f 7265 3a0a 2020 2020 2020  emaphore:.      
-000166b0: 2020 2020 2020 2020 2020 6d64 5f6e 6577            md_new
-000166c0: 203d 2073 656c 662e 636c 6965 6e74 2e75   = self.client.u
-000166d0: 706c 6f61 6428 0a20 2020 2020 2020 2020  pload(.         
-000166e0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-000166f0: 2e6c 6f63 616c 5f70 6174 682c 0a20 2020  .local_path,.   
-00016700: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016710: 2065 7665 6e74 2e64 6278 5f70 6174 682c   event.dbx_path,
-00016720: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00016730: 2020 2020 2061 7574 6f72 656e 616d 653d       autorename=
-00016740: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-00016750: 2020 2020 2020 2020 2020 7772 6974 655f            write_
-00016760: 6d6f 6465 3d6d 6f64 652c 0a20 2020 2020  mode=mode,.     
-00016770: 2020 2020 2020 2020 2020 2020 2020 2075                 u
-00016780: 7064 6174 655f 7265 763d 6c6f 6361 6c5f  pdate_rev=local_
-00016790: 7265 762c 0a20 2020 2020 2020 2020 2020  rev,.           
-000167a0: 2020 2020 2020 2020 2073 796e 635f 6576           sync_ev
-000167b0: 656e 743d 6576 656e 742c 0a20 2020 2020  ent=event,.     
-000167c0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-000167d0: 2020 2020 2065 7863 6570 7420 284e 6f74       except (Not
-000167e0: 466f 756e 6445 7272 6f72 2c20 4e6f 7441  FoundError, NotA
-000167f0: 466f 6c64 6572 4572 726f 722c 2049 7341  FolderError, IsA
-00016800: 466f 6c64 6572 4572 726f 7229 3a0a 2020  FolderError):.  
-00016810: 2020 2020 2020 2020 2020 2320 4e6f 7465            # Note
-00016820: 3a20 4e6f 7441 466f 6c64 6572 4572 726f  : NotAFolderErro
-00016830: 7220 6361 6e20 6265 2072 6169 7365 6420  r can be raised 
-00016840: 7768 656e 2061 2070 6172 656e 7420 696e  when a parent in
-00016850: 2074 6865 206c 6f63 616c 2070 6174 680a   the local path.
-00016860: 2020 2020 2020 2020 2020 2020 2320 7265              # re
-00016870: 6665 7273 2074 6f20 6120 6669 6c65 2069  fers to a file i
-00016880: 6e73 7465 6164 206f 6620 6120 666f 6c64  nstead of a fold
-00016890: 6572 2e0a 2020 2020 2020 2020 2020 2020  er..            
-000168a0: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
-000168b0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-000168c0: 2020 2020 2743 6f75 6c64 206e 6f74 2075      'Could not u
-000168d0: 706c 6f61 6420 2225 7322 3a20 7468 6520  pload "%s": the 
-000168e0: 6669 6c65 2064 6f65 7320 6e6f 7420 6578  file does not ex
-000168f0: 6973 7427 2c20 6576 656e 742e 6c6f 6361  ist', event.loca
-00016900: 6c5f 7061 7468 0a20 2020 2020 2020 2020  l_path.         
-00016910: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00016920: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
-00016930: 7573 2e53 6b69 7070 6564 0a20 2020 2020  us.Skipped.     
-00016940: 2020 2065 7863 6570 7420 4461 7461 4368     except DataCh
-00016950: 616e 6765 6445 7272 6f72 3a0a 2020 2020  angedError:.    
-00016960: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-00016970: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-00016980: 2020 2020 2020 2020 2020 2020 2743 6f75              'Cou
-00016990: 6c64 206e 6f74 2075 706c 6f61 6420 2225  ld not upload "%
-000169a0: 7322 3a20 7468 6520 6669 6c65 2077 6173  s": the file was
-000169b0: 206d 6f64 6966 6965 6420 6475 7269 6e67   modified during
-000169c0: 2075 706c 6f61 6427 2c0a 2020 2020 2020   upload',.      
-000169d0: 2020 2020 2020 2020 2020 6576 656e 742e            event.
-000169e0: 6c6f 6361 6c5f 7061 7468 2c0a 2020 2020  local_path,.    
-000169f0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00016a00: 2020 2020 2020 7265 7475 726e 2053 796e        return Syn
-00016a10: 6353 7461 7475 732e 536b 6970 7065 640a  cStatus.Skipped.
-00016a20: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
-00016a30: 2e5f 6861 6e64 6c65 5f75 706c 6f61 645f  ._handle_upload_
-00016a40: 636f 6e66 6c69 6374 286d 645f 6e65 772c  conflict(md_new,
-00016a50: 2065 7665 6e74 293a 0a20 2020 2020 2020   event):.       
-00016a60: 2020 2020 2073 7461 7475 7320 3d20 5379       status = Sy
-00016a70: 6e63 5374 6174 7573 2e43 6f6e 666c 6963  ncStatus.Conflic
-00016a80: 740a 2020 2020 2020 2020 656c 7365 3a0a  t.        else:.
-00016a90: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-00016aa0: 7573 203d 2053 796e 6353 7461 7475 732e  us = SyncStatus.
-00016ab0: 446f 6e65 0a20 2020 2020 2020 2020 2020  Done.           
-00016ac0: 2069 6620 6576 656e 742e 6368 616e 6765   if event.change
-00016ad0: 5f74 7970 6520 6973 2043 6861 6e67 6554  _type is ChangeT
-00016ae0: 7970 652e 4164 6465 643a 0a20 2020 2020  ype.Added:.     
-00016af0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016b00: 5f6c 6f67 6765 722e 6465 6275 6728 2743  _logger.debug('C
-00016b10: 7265 6174 6564 2022 2573 2220 6f6e 2044  reated "%s" on D
-00016b20: 726f 7062 6f78 272c 2065 7665 6e74 2e64  ropbox', event.d
-00016b30: 6278 5f70 6174 6829 0a20 2020 2020 2020  bx_path).       
-00016b40: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00016b50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00016b60: 5f6c 6f67 6765 722e 6465 6275 6728 2755  _logger.debug('U
-00016b70: 706c 6f61 6465 6420 6d6f 6469 6669 6564  ploaded modified
-00016b80: 2022 2573 2220 746f 2044 726f 7062 6f78   "%s" to Dropbox
-00016b90: 272c 2065 7665 6e74 2e64 6278 5f70 6174  ', event.dbx_pat
-00016ba0: 6829 0a0a 2020 2020 2020 2020 7365 6c66  h)..        self
-00016bb0: 2e75 7064 6174 655f 696e 6465 785f 6672  .update_index_fr
-00016bc0: 6f6d 5f64 6278 5f6d 6574 6164 6174 6128  om_dbx_metadata(
-00016bd0: 6d64 5f6e 6577 290a 0a20 2020 2020 2020  md_new)..       
-00016be0: 2072 6574 7572 6e20 7374 6174 7573 0a0a   return status..
-00016bf0: 2020 2020 6465 6620 5f6f 6e5f 6c6f 6361      def _on_loca
-00016c00: 6c5f 666f 6c64 6572 5f63 7265 6174 6564  l_folder_created
-00016c10: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
-00016c20: 6e63 4576 656e 7429 202d 3e20 5379 6e63  ncEvent) -> Sync
-00016c30: 5374 6174 7573 3a0a 2020 2020 2020 2020  Status:.        
-00016c40: 2222 220a 2020 2020 2020 2020 4361 6c6c  """.        Call
-00016c50: 2077 6865 6e20 6120 6c6f 6361 6c20 666f   when a local fo
-00016c60: 6c64 6572 2069 7320 6372 6561 7465 642e  lder is created.
-00016c70: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00016c80: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
-00016c90: 7420 636f 7272 6573 706f 6e64 696e 6720  t corresponding 
-00016ca0: 746f 206c 6f63 616c 2063 7265 6174 6564  to local created
-00016cb0: 2065 7665 6e74 2e0a 2020 2020 2020 2020   event..        
-00016cc0: 3a72 6574 7572 6e73 3a20 4d65 7461 6461  :returns: Metada
-00016cd0: 7461 2066 6f72 2063 7265 6174 6564 2069  ta for created i
-00016ce0: 7465 6d20 6f72 204e 6f6e 6520 6966 206e  tem or None if n
-00016cf0: 6f20 7265 6d6f 7465 2069 7465 6d20 6973  o remote item is
-00016d00: 2063 7265 6174 6564 2e0a 2020 2020 2020   created..      
-00016d10: 2020 3a72 6169 7365 7320 4d61 6573 7472    :raises Maestr
-00016d20: 616c 4170 6945 7272 6f72 3a20 466f 7220  alApiError: For 
-00016d30: 616e 7920 6973 7375 6573 2077 6865 6e20  any issues when 
-00016d40: 7379 6e63 696e 6720 7468 6520 6974 656d  syncing the item
-00016d50: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00016d60: 2020 2020 2020 6368 6563 6b5f 6368 616e        check_chan
-00016d70: 6765 5f74 7970 6528 6576 656e 742c 207b  ge_type(event, {
-00016d80: 4368 616e 6765 5479 7065 2e41 6464 6564  ChangeType.Added
-00016d90: 7d29 0a20 2020 2020 2020 2063 6865 636b  }).        check
-00016da0: 5f65 6e63 6f64 696e 6728 6576 656e 742e  _encoding(event.
-00016db0: 6c6f 6361 6c5f 7061 7468 290a 0a20 2020  local_path)..   
-00016dc0: 2020 2020 2069 6620 7365 6c66 2e5f 6861       if self._ha
-00016dd0: 6e64 6c65 5f73 656c 6563 7469 7665 5f73  ndle_selective_s
-00016de0: 796e 635f 636f 6e66 6c69 6374 2865 7665  ync_conflict(eve
-00016df0: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
-00016e00: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
-00016e10: 7573 2e43 6f6e 666c 6963 740a 2020 2020  us.Conflict.    
-00016e20: 2020 2020 6966 2073 656c 662e 5f68 616e      if self._han
-00016e30: 646c 655f 6e6f 726d 616c 697a 6174 696f  dle_normalizatio
-00016e40: 6e5f 636f 6e66 6c69 6374 2865 7665 6e74  n_conflict(event
-00016e50: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
-00016e60: 6574 7572 6e20 5379 6e63 5374 6174 7573  eturn SyncStatus
-00016e70: 2e43 6f6e 666c 6963 740a 0a20 2020 2020  .Conflict..     
-00016e80: 2020 2073 656c 662e 5f77 6169 745f 666f     self._wait_fo
-00016e90: 725f 6372 6561 7469 6f6e 2865 7665 6e74  r_creation(event
-00016ea0: 2e6c 6f63 616c 5f70 6174 6829 0a0a 2020  .local_path)..  
-00016eb0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00016ec0: 2020 2020 2020 2069 6620 7365 6c66 2e63         if self.c
-00016ed0: 6c69 656e 742e 6973 5f74 6561 6d5f 7370  lient.is_team_sp
-00016ee0: 6163 6520 616e 6420 6576 656e 742e 6462  ace and event.db
-00016ef0: 785f 7061 7468 2e63 6f75 6e74 2822 2f22  x_path.count("/"
-00016f00: 2920 3d3d 2031 3a0a 2020 2020 2020 2020  ) == 1:.        
-00016f10: 2020 2020 2020 2020 6d64 5f6e 6577 203d          md_new =
-00016f20: 2073 656c 662e 636c 6965 6e74 2e73 6861   self.client.sha
-00016f30: 7265 5f64 6972 2865 7665 6e74 2e64 6278  re_dir(event.dbx
-00016f40: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-00016f50: 2020 2020 2020 2020 6966 206e 6f74 206d          if not m
-00016f60: 645f 6e65 773a 0a20 2020 2020 2020 2020  d_new:.         
-00016f70: 2020 2020 2020 2020 2020 2023 2052 656d             # Rem
-00016f80: 6f74 6520 666f 6c64 6572 2068 6173 2062  ote folder has b
-00016f90: 6565 6e20 6465 6c65 7465 6420 6166 7465  een deleted afte
-00016fa0: 7220 6372 6561 7469 6e67 2e20 5265 666c  r creating. Refl
-00016fb0: 6563 7420 6368 616e 6765 730a 2020 2020  ect changes.    
-00016fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016fd0: 2320 6c6f 6361 6c6c 7920 616e 6420 7265  # locally and re
-00016fe0: 7475 726e 2e0a 2020 2020 2020 2020 2020  turn..          
-00016ff0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-00017000: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
-00017010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017020: 2020 2020 2020 2722 2573 2220 6f6e 2044        '"%s" on D
-00017030: 726f 7062 6f78 2077 6173 2064 656c 6574  ropbox was delet
-00017040: 6564 2061 6674 6572 2063 7265 6174 696f  ed after creatio
-00017050: 6e2c 2027 0a20 2020 2020 2020 2020 2020  n, '.           
-00017060: 2020 2020 2020 2020 2020 2020 2022 6465               "de
-00017070: 6c65 7469 6e67 206c 6f63 616c 2063 6f70  leting local cop
-00017080: 7922 2c0a 2020 2020 2020 2020 2020 2020  y",.            
-00017090: 2020 2020 2020 2020 2020 2020 6576 656e              even
-000170a0: 742e 6462 785f 7061 7468 2c0a 2020 2020  t.dbx_path,.    
-000170b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000170c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-000170d0: 2020 2020 2020 6572 7220 3d20 6465 6c65        err = dele
-000170e0: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
-000170f0: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00017100: 742e 6c6f 6361 6c5f 7061 7468 2c0a 2020  t.local_path,.  
-00017110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017120: 2020 2020 2020 666f 7263 655f 6361 7365        force_case
-00017130: 5f73 656e 7369 7469 7665 3d6e 6f74 2073  _sensitive=not s
-00017140: 656c 662e 6973 5f66 735f 6361 7365 5f73  elf.is_fs_case_s
-00017150: 656e 7369 7469 7665 2c0a 2020 2020 2020  ensitive,.      
-00017160: 2020 2020 2020 2020 2020 2020 2020 290a                ).
-00017170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00017180: 2020 2020 2069 6620 6572 723a 0a20 2020       if err:.   
-00017190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000171a0: 2020 2020 2072 6169 7365 206f 735f 746f       raise os_to
-000171b0: 5f6d 6165 7374 7261 6c5f 6572 726f 7228  _maestral_error(
-000171c0: 6572 7229 0a0a 2020 2020 2020 2020 2020  err)..          
-000171d0: 2020 2020 2020 2020 2020 7265 7475 726e            return
-000171e0: 2053 796e 6353 7461 7475 732e 536b 6970   SyncStatus.Skip
-000171f0: 7065 640a 2020 2020 2020 2020 2020 2020  ped.            
-00017200: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00017210: 2020 2020 2020 6d64 5f6e 6577 203d 2073        md_new = s
-00017220: 656c 662e 636c 6965 6e74 2e6d 616b 655f  elf.client.make_
-00017230: 6469 7228 6576 656e 742e 6462 785f 7061  dir(event.dbx_pa
-00017240: 7468 2c20 6175 746f 7265 6e61 6d65 3d46  th, autorename=F
-00017250: 616c 7365 290a 2020 2020 2020 2020 6578  alse).        ex
-00017260: 6365 7074 2046 6f6c 6465 7243 6f6e 666c  cept FolderConfl
-00017270: 6963 7445 7272 6f72 3a0a 2020 2020 2020  ictError:.      
-00017280: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00017290: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
-000172a0: 2020 2020 2020 2020 2020 274e 6f20 636f            'No co
-000172b0: 6e66 6c69 6374 2066 6f72 2022 2573 223a  nflict for "%s":
-000172c0: 2074 6865 2066 6f6c 6465 7220 616c 7265   the folder alre
-000172d0: 6164 7920 6578 6973 7473 272c 2065 7665  ady exists', eve
-000172e0: 6e74 2e6c 6f63 616c 5f70 6174 680a 2020  nt.local_path.  
-000172f0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-00017300: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
-00017310: 2020 2020 2020 2020 2020 2020 206d 6420               md 
-00017320: 3d20 7365 6c66 2e63 6c69 656e 742e 6765  = self.client.ge
-00017330: 745f 6d65 7461 6461 7461 2865 7665 6e74  t_metadata(event
-00017340: 2e64 6278 5f70 6174 6829 0a20 2020 2020  .dbx_path).     
-00017350: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-00017360: 696e 7374 616e 6365 286d 642c 2046 6f6c  instance(md, Fol
-00017370: 6465 724d 6574 6164 6174 6129 3a0a 2020  derMetadata):.  
-00017380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017390: 2020 7365 6c66 2e75 7064 6174 655f 696e    self.update_in
-000173a0: 6465 785f 6672 6f6d 5f64 6278 5f6d 6574  dex_from_dbx_met
-000173b0: 6164 6174 6128 6d64 290a 2020 2020 2020  adata(md).      
-000173c0: 2020 2020 2020 6578 6365 7074 204e 6f74        except Not
-000173d0: 466f 756e 6445 7272 6f72 3a0a 2020 2020  FoundError:.    
-000173e0: 2020 2020 2020 2020 2020 2020 7061 7373              pass
-000173f0: 0a0a 2020 2020 2020 2020 2020 2020 7265  ..            re
-00017400: 7475 726e 2053 796e 6353 7461 7475 732e  turn SyncStatus.
-00017410: 536b 6970 7065 640a 2020 2020 2020 2020  Skipped.        
-00017420: 6578 6365 7074 2046 696c 6543 6f6e 666c  except FileConfl
-00017430: 6963 7445 7272 6f72 3a0a 2020 2020 2020  ictError:.      
-00017440: 2020 2020 2020 6d64 5f6e 6577 203d 2073        md_new = s
-00017450: 656c 662e 636c 6965 6e74 2e6d 616b 655f  elf.client.make_
-00017460: 6469 7228 6576 656e 742e 6462 785f 7061  dir(event.dbx_pa
-00017470: 7468 2c20 6175 746f 7265 6e61 6d65 3d54  th, autorename=T
-00017480: 7275 6529 0a0a 2020 2020 2020 2020 6966  rue)..        if
-00017490: 2073 656c 662e 5f68 616e 646c 655f 7570   self._handle_up
-000174a0: 6c6f 6164 5f63 6f6e 666c 6963 7428 6d64  load_conflict(md
-000174b0: 5f6e 6577 2c20 6576 656e 7429 3a0a 2020  _new, event):.  
-000174c0: 2020 2020 2020 2020 2020 7374 6174 7573            status
-000174d0: 203d 2053 796e 6353 7461 7475 732e 436f   = SyncStatus.Co
-000174e0: 6e66 6c69 6374 0a20 2020 2020 2020 2065  nflict.        e
-000174f0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00017500: 2073 7461 7475 7320 3d20 5379 6e63 5374   status = SyncSt
-00017510: 6174 7573 2e44 6f6e 650a 2020 2020 2020  atus.Done.      
-00017520: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00017530: 6572 2e64 6562 7567 2827 4372 6561 7465  er.debug('Create
-00017540: 6420 2225 7322 206f 6e20 4472 6f70 626f  d "%s" on Dropbo
-00017550: 7827 2c20 6576 656e 742e 6462 785f 7061  x', event.dbx_pa
-00017560: 7468 290a 0a20 2020 2020 2020 2073 656c  th)..        sel
-00017570: 662e 7570 6461 7465 5f69 6e64 6578 5f66  f.update_index_f
-00017580: 726f 6d5f 6462 785f 6d65 7461 6461 7461  rom_dbx_metadata
-00017590: 286d 645f 6e65 7729 0a0a 2020 2020 2020  (md_new)..      
-000175a0: 2020 7265 7475 726e 2073 7461 7475 730a    return status.
-000175b0: 0a20 2020 2064 6566 205f 6f6e 5f6c 6f63  .    def _on_loc
-000175c0: 616c 5f64 656c 6574 6564 2873 656c 662c  al_deleted(self,
-000175d0: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
-000175e0: 7429 202d 3e20 5379 6e63 5374 6174 7573  t) -> SyncStatus
-000175f0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
-00017600: 2020 2020 2020 4361 6c6c 2077 6865 6e20        Call when 
-00017610: 6120 6c6f 6361 6c20 6974 656d 2069 7320  a local item is 
-00017620: 6465 6c65 7465 642e 2057 6520 7472 7920  deleted. We try 
-00017630: 6e6f 7420 746f 2064 656c 6574 6520 7265  not to delete re
-00017640: 6d6f 7465 2069 7465 6d73 2077 6869 6368  mote items which
-00017650: 2068 6176 650a 2020 2020 2020 2020 6265   have.        be
-00017660: 656e 206d 6f64 6966 6965 6420 7369 6e63  en modified sinc
-00017670: 6520 7468 6520 6c61 7374 2073 796e 632e  e the last sync.
-00017680: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
-00017690: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
-000176a0: 7420 666f 7220 6c6f 6361 6c20 6465 6c65  t for local dele
-000176b0: 7469 6f6e 2e0a 2020 2020 2020 2020 3a72  tion..        :r
-000176c0: 6574 7572 6e73 3a20 4d65 7461 6461 7461  eturns: Metadata
-000176d0: 2066 6f72 2064 656c 6574 6564 2069 7465   for deleted ite
-000176e0: 6d20 6f72 204e 6f6e 6520 6966 206e 6f20  m or None if no 
-000176f0: 7265 6d6f 7465 2069 7465 6d20 6973 2064  remote item is d
-00017700: 656c 6574 6564 2e0a 2020 2020 2020 2020  eleted..        
-00017710: 3a72 6169 7365 7320 4d61 6573 7472 616c  :raises Maestral
-00017720: 4170 6945 7272 6f72 3a20 466f 7220 616e  ApiError: For an
-00017730: 7920 6973 7375 6573 2077 6865 6e20 7379  y issues when sy
-00017740: 6e63 696e 6720 7468 6520 6974 656d 2e0a  ncing the item..
-00017750: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00017760: 2020 2020 6368 6563 6b5f 6368 616e 6765      check_change
-00017770: 5f74 7970 6528 6576 656e 742c 207b 4368  _type(event, {Ch
-00017780: 616e 6765 5479 7065 2e52 656d 6f76 6564  angeType.Removed
-00017790: 7d29 0a20 2020 2020 2020 2074 7279 3a0a  }).        try:.
-000177a0: 2020 2020 2020 2020 2020 2020 6368 6563              chec
-000177b0: 6b5f 656e 636f 6469 6e67 2865 7665 6e74  k_encoding(event
-000177c0: 2e6c 6f63 616c 5f70 6174 6829 0a20 2020  .local_path).   
-000177d0: 2020 2020 2065 7863 6570 7420 5061 7468       except Path
-000177e0: 4572 726f 723a 0a20 2020 2020 2020 2020  Error:.         
-000177f0: 2020 2023 2044 6f6e 2774 2072 6169 7365     # Don't raise
-00017800: 2061 6e20 6572 726f 7220 6865 7265 2062   an error here b
-00017810: 6563 6175 7365 2074 6865 2066 696c 6520  ecause the file 
-00017820: 6361 6e6e 6f74 2065 7869 7374 206f 6e20  cannot exist on 
-00017830: 7468 6520 7365 7276 6572 2e0a 2020 2020  the server..    
-00017840: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-00017850: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-00017860: 2020 2020 2020 2020 2020 2020 2743 6f75              'Cou
-00017870: 6c64 206e 6f74 2064 656c 6574 6520 2225  ld not delete "%
-00017880: 7322 3a20 7468 6520 6974 656d 2064 6f65  s": the item doe
-00017890: 7320 6e6f 7420 6578 6973 7420 6f6e 2044  s not exist on D
-000178a0: 726f 7062 6f78 272c 0a20 2020 2020 2020  ropbox',.       
-000178b0: 2020 2020 2020 2020 2065 7665 6e74 2e64           event.d
-000178c0: 6278 5f70 6174 682c 0a20 2020 2020 2020  bx_path,.       
-000178d0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
-000178e0: 2020 2072 6574 7572 6e20 5379 6e63 5374     return SyncSt
-000178f0: 6174 7573 2e53 6b69 7070 6564 0a0a 2020  atus.Skipped..  
-00017900: 2020 2020 2020 2320 5765 2069 6e74 6572        # We inter
-00017910: 6365 7074 2061 6e79 2061 7474 656d 7074  cept any attempt
-00017920: 7320 746f 2064 656c 6574 6520 7468 6520  s to delete the 
-00017930: 686f 6d65 2066 6f6c 6465 7220 6865 7265  home folder here
-00017940: 2069 6e73 7465 6164 206f 6620 7761 6974   instead of wait
-00017950: 696e 670a 2020 2020 2020 2020 2320 666f  ing.        # fo
-00017960: 7220 616e 2065 7272 6f72 2066 726f 6d20  r an error from 
-00017970: 7468 6520 4472 6f70 626f 7820 4150 492e  the Dropbox API.
-00017980: 2054 6869 7320 616c 6c6f 7773 2075 7320   This allows us 
-00017990: 746f 2070 726f 7669 6465 2061 2062 6574  to provide a bet
-000179a0: 7465 7220 6572 726f 720a 2020 2020 2020  ter error.      
-000179b0: 2020 2320 6d65 7373 6167 652e 0a0a 2020    # message...  
-000179c0: 2020 2020 2020 686f 6d65 5f70 6174 6820        home_path 
-000179d0: 3d20 7365 6c66 2e5f 7374 6174 652e 6765  = self._state.ge
-000179e0: 7428 2261 6363 6f75 6e74 222c 2022 686f  t("account", "ho
-000179f0: 6d65 5f70 6174 6822 290a 0a20 2020 2020  me_path")..     
-00017a00: 2020 2069 6620 6576 656e 742e 6462 785f     if event.dbx_
-00017a10: 7061 7468 203d 3d20 686f 6d65 5f70 6174  path == home_pat
-00017a20: 683a 0a20 2020 2020 2020 2020 2020 2072  h:.            r
-00017a30: 6169 7365 2053 796e 6345 7272 6f72 280a  aise SyncError(.
-00017a40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017a50: 7469 746c 653d 2243 6f75 6c64 206e 6f74  title="Could not
-00017a60: 2064 656c 6574 6520 6974 656d 222c 0a20   delete item",. 
-00017a70: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00017a80: 6573 7361 6765 3d22 4361 6e6e 6f74 2064  essage="Cannot d
-00017a90: 656c 6574 6520 7468 6520 7573 6572 2773  elete the user's
-00017aa0: 2068 6f6d 6520 666f 6c64 6572 222c 0a20   home folder",. 
-00017ab0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-00017ac0: 6278 5f70 6174 683d 6576 656e 742e 6462  bx_path=event.db
-00017ad0: 785f 7061 7468 2c0a 2020 2020 2020 2020  x_path,.        
-00017ae0: 2020 2020 2020 2020 6c6f 6361 6c5f 7061          local_pa
-00017af0: 7468 3d65 7665 6e74 2e6c 6f63 616c 5f70  th=event.local_p
-00017b00: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
-00017b10: 2029 0a0a 2020 2020 2020 2020 6966 2065   )..        if e
-00017b20: 7665 6e74 2e6c 6f63 616c 5f70 6174 6820  vent.local_path 
-00017b30: 3d3d 2073 656c 662e 6472 6f70 626f 785f  == self.dropbox_
-00017b40: 7061 7468 3a0a 2020 2020 2020 2020 2020  path:.          
-00017b50: 2020 7365 6c66 2e65 6e73 7572 655f 6472    self.ensure_dr
-00017b60: 6f70 626f 785f 666f 6c64 6572 5f70 7265  opbox_folder_pre
-00017b70: 7365 6e74 2829 0a0a 2020 2020 2020 2020  sent()..        
-00017b80: 6966 2073 656c 662e 6973 5f65 7863 6c75  if self.is_exclu
-00017b90: 6465 645f 6279 5f75 7365 7228 6576 656e  ded_by_user(even
-00017ba0: 742e 6462 785f 7061 7468 5f6c 6f77 6572  t.dbx_path_lower
-00017bb0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00017bc0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
-00017bd0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
-00017be0: 2020 2027 4e6f 7420 6465 6c65 7469 6e67     'Not deleting
-00017bf0: 2022 2573 223a 2069 7320 6578 636c 7564   "%s": is exclud
-00017c00: 6564 2062 7920 7365 6c65 6374 6976 6520  ed by selective 
-00017c10: 7379 6e63 272c 2065 7665 6e74 2e64 6278  sync', event.dbx
-00017c20: 5f70 6174 680a 2020 2020 2020 2020 2020  _path.          
-00017c30: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00017c40: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
-00017c50: 732e 536b 6970 7065 640a 0a20 2020 2020  s.Skipped..     
-00017c60: 2020 206c 6f63 616c 5f72 6576 203d 2073     local_rev = s
-00017c70: 656c 662e 6765 745f 6c6f 6361 6c5f 7265  elf.get_local_re
-00017c80: 7628 6576 656e 742e 6462 785f 7061 7468  v(event.dbx_path
-00017c90: 5f6c 6f77 6572 290a 0a20 2020 2020 2020  _lower)..       
-00017ca0: 206d 6420 3d20 7365 6c66 2e63 6c69 656e   md = self.clien
-00017cb0: 742e 6765 745f 6d65 7461 6461 7461 2865  t.get_metadata(e
-00017cc0: 7665 6e74 2e64 6278 5f70 6174 682c 2069  vent.dbx_path, i
-00017cd0: 6e63 6c75 6465 5f64 656c 6574 6564 3d54  nclude_deleted=T
-00017ce0: 7275 6529 0a0a 2020 2020 2020 2020 6966  rue)..        if
-00017cf0: 206e 6f74 206d 643a 0a20 2020 2020 2020   not md:.       
-00017d00: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-00017d10: 722e 6465 6275 6728 0a20 2020 2020 2020  r.debug(.       
-00017d20: 2020 2020 2020 2020 2027 436f 756c 6420           'Could 
-00017d30: 6e6f 7420 6465 6c65 7465 2022 2573 223a  not delete "%s":
-00017d40: 2074 6865 2069 7465 6d20 646f 6573 206e   the item does n
-00017d50: 6f74 2065 7869 7374 206f 6e20 4472 6f70  ot exist on Drop
-00017d60: 626f 7827 2c0a 2020 2020 2020 2020 2020  box',.          
-00017d70: 2020 2020 2020 6576 656e 742e 6462 785f        event.dbx_
-00017d80: 7061 7468 2c0a 2020 2020 2020 2020 2020  path,.          
-00017d90: 2020 290a 2020 2020 2020 2020 2020 2020    ).            
-00017da0: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
-00017db0: 732e 536b 6970 7065 640a 0a20 2020 2020  s.Skipped..     
-00017dc0: 2020 2069 6620 6576 656e 742e 6973 5f64     if event.is_d
-00017dd0: 6972 6563 746f 7279 2061 6e64 2069 7369  irectory and isi
-00017de0: 6e73 7461 6e63 6528 6d64 2c20 4669 6c65  nstance(md, File
-00017df0: 4d65 7461 6461 7461 293a 0a20 2020 2020  Metadata):.     
-00017e00: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-00017e10: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
-00017e20: 2020 2020 2020 2020 2020 2027 4578 7065             'Expe
-00017e30: 6374 6564 2066 6f6c 6465 7220 6174 2022  cted folder at "
-00017e40: 2573 2220 6275 7420 666f 756e 6420 6120  %s" but found a 
-00017e50: 6669 6c65 2069 6e73 7465 6164 2c20 6368  file instead, ch
-00017e60: 6563 6b69 6e67 2027 0a20 2020 2020 2020  ecking '.       
-00017e70: 2020 2020 2020 2020 2022 7768 6963 6820           "which 
-00017e80: 6f6e 6520 6973 206e 6577 6572 222c 0a20  one is newer",. 
-00017e90: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00017ea0: 642e 7061 7468 5f64 6973 706c 6179 2c0a  d.path_display,.
-00017eb0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00017ec0: 2020 2020 2020 2020 2020 2320 446f 6e27            # Don'
-00017ed0: 7420 6465 6c65 7465 2061 2072 656d 6f74  t delete a remot
-00017ee0: 6520 6669 6c65 2069 6620 6974 2077 6173  e file if it was
-00017ef0: 206d 6f64 6966 6965 6420 7369 6e63 6520   modified since 
-00017f00: 6c61 7374 2073 796e 632e 0a20 2020 2020  last sync..     
-00017f10: 2020 2020 2020 2069 6620 6d64 2e73 6572         if md.ser
-00017f20: 7665 725f 6d6f 6469 6669 6564 2e74 696d  ver_modified.tim
-00017f30: 6573 7461 6d70 2829 203e 3d20 7365 6c66  estamp() >= self
-00017f40: 2e67 6574 5f6c 6173 745f 7379 6e63 280a  .get_last_sync(.
-00017f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00017f60: 6576 656e 742e 6462 785f 7061 7468 5f6c  event.dbx_path_l
-00017f70: 6f77 6572 0a20 2020 2020 2020 2020 2020  ower.           
-00017f80: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00017f90: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-00017fa0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00017fb0: 2020 2020 2020 2020 2020 2020 2753 6b69              'Ski
-00017fc0: 7070 696e 6720 6465 6c65 7469 6f6e 3a20  pping deletion: 
-00017fd0: 7265 6d6f 7465 2069 7465 6d20 2225 7322  remote item "%s"
-00017fe0: 2068 6173 2062 6565 6e20 6d6f 6469 6669   has been modifi
-00017ff0: 6564 2027 0a20 2020 2020 2020 2020 2020  ed '.           
-00018000: 2020 2020 2020 2020 2022 7369 6e63 6520           "since 
-00018010: 6c61 7374 2073 796e 6322 2c0a 2020 2020  last sync",.    
-00018020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018030: 6d64 2e70 6174 685f 6469 7370 6c61 792c  md.path_display,
-00018040: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00018050: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-00018060: 2020 2023 204d 6172 6b20 6c6f 6361 6c20     # Mark local 
-00018070: 666f 6c64 6572 2061 7320 756e 7472 6163  folder as untrac
-00018080: 6b65 642e 0a20 2020 2020 2020 2020 2020  ked..           
-00018090: 2020 2020 2073 656c 662e 7265 6d6f 7665       self.remove
-000180a0: 5f6e 6f64 655f 6672 6f6d 5f69 6e64 6578  _node_from_index
-000180b0: 2865 7665 6e74 2e64 6278 5f70 6174 685f  (event.dbx_path_
-000180c0: 6c6f 7765 7229 0a0a 2020 2020 2020 2020  lower)..        
-000180d0: 2020 2020 2020 2020 7265 7475 726e 2053          return S
-000180e0: 796e 6353 7461 7475 732e 536b 6970 7065  yncStatus.Skippe
-000180f0: 640a 0a20 2020 2020 2020 2069 6620 6576  d..        if ev
-00018100: 656e 742e 6973 5f66 696c 6520 616e 6420  ent.is_file and 
-00018110: 6973 696e 7374 616e 6365 286d 642c 2046  isinstance(md, F
-00018120: 6f6c 6465 724d 6574 6164 6174 6129 3a0a  olderMetadata):.
-00018130: 2020 2020 2020 2020 2020 2020 2320 446f              # Do
-00018140: 6e27 7420 6465 6c65 7465 2061 2072 656d  n't delete a rem
-00018150: 6f74 6520 666f 6c64 6572 2069 6620 7765  ote folder if we
-00018160: 2077 6572 6520 6578 7065 6374 696e 6720   were expecting 
-00018170: 6120 6669 6c65 2e0a 2020 2020 2020 2020  a file..        
-00018180: 2020 2020 2320 544f 444f 3a20 4465 6c65      # TODO: Dele
-00018190: 7465 2074 6865 2066 6f6c 6465 7220 6966  te the folder if
-000181a0: 2069 7473 2063 6869 6c64 7265 6e20 6469   its children di
-000181b0: 6420 6e6f 7420 6368 616e 6765 2073 696e  d not change sin
-000181c0: 6365 206c 6173 7420 7379 6e63 2e0a 2020  ce last sync..  
-000181d0: 2020 2020 2020 2020 2020 2320 2020 4973            #   Is
-000181e0: 2074 6865 7265 2061 2077 6179 206f 6620   there a way of 
-000181f0: 6163 6869 6576 696e 6720 7468 6973 2077  achieving this w
-00018200: 6974 686f 7574 206c 6973 7469 6e67 2074  ithout listing t
-00018210: 6865 2066 6f6c 6465 7220 6f72 206c 6973  he folder or lis
-00018220: 7469 6e67 0a20 2020 2020 2020 2020 2020  ting.           
-00018230: 2023 2020 2061 6c6c 2063 6861 6e67 6573   #   all changes
-00018240: 2061 6e64 2063 6865 636b 696e 6720 7768   and checking wh
-00018250: 656e 2074 6865 7920 6f63 6375 7272 6564  en they occurred
-00018260: 3f0a 2020 2020 2020 2020 2020 2020 7365  ?.            se
-00018270: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
-00018280: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00018290: 2020 2753 6b69 7070 696e 6720 6465 6c65    'Skipping dele
-000182a0: 7469 6f6e 3a20 6578 7065 6374 6564 2066  tion: expected f
-000182b0: 696c 6520 6174 2022 2573 2220 6275 7420  ile at "%s" but 
-000182c0: 666f 756e 6420 6120 270a 2020 2020 2020  found a '.      
-000182d0: 2020 2020 2020 2020 2020 2266 6f6c 6465            "folde
-000182e0: 7220 696e 7374 6561 6422 2c0a 2020 2020  r instead",.    
-000182f0: 2020 2020 2020 2020 2020 2020 6d64 2e70              md.p
-00018300: 6174 685f 6469 7370 6c61 792c 0a20 2020  ath_display,.   
-00018310: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-00018320: 2020 2020 2020 2023 204d 6172 6b20 6c6f         # Mark lo
-00018330: 6361 6c20 6669 6c65 2061 7320 756e 7472  cal file as untr
-00018340: 6163 6b65 642e 0a20 2020 2020 2020 2020  acked..         
-00018350: 2020 2073 656c 662e 7265 6d6f 7665 5f6e     self.remove_n
-00018360: 6f64 655f 6672 6f6d 5f69 6e64 6578 2865  ode_from_index(e
-00018370: 7665 6e74 2e64 6278 5f70 6174 685f 6c6f  vent.dbx_path_lo
-00018380: 7765 7229 0a0a 2020 2020 2020 2020 2020  wer)..          
-00018390: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
-000183a0: 7475 732e 536b 6970 7065 640a 0a20 2020  tus.Skipped..   
-000183b0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000183c0: 2020 2020 2020 2320 5769 6c6c 206f 6e6c        # Will onl
-000183d0: 7920 7065 7266 6f72 6d20 6465 6c65 7465  y perform delete
-000183e0: 2069 6620 4472 6f70 626f 7820 7265 6d6f   if Dropbox remo
-000183f0: 7465 2072 6576 206d 6174 6368 6573 2060  te rev matches `
-00018400: 6c6f 6361 6c5f 7265 7660 2e0a 2020 2020  local_rev`..    
-00018410: 2020 2020 2020 2020 7365 6c66 2e63 6c69          self.cli
-00018420: 656e 742e 7265 6d6f 7665 280a 2020 2020  ent.remove(.    
-00018430: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00018440: 742e 6462 785f 7061 7468 2c20 7061 7265  t.dbx_path, pare
-00018450: 6e74 5f72 6576 3d6c 6f63 616c 5f72 6576  nt_rev=local_rev
-00018460: 2069 6620 6576 656e 742e 6973 5f66 696c   if event.is_fil
-00018470: 6520 656c 7365 204e 6f6e 650a 2020 2020  e else None.    
-00018480: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00018490: 2020 2020 2020 7374 6174 7573 203d 2053        status = S
-000184a0: 796e 6353 7461 7475 732e 446f 6e65 0a20  yncStatus.Done. 
-000184b0: 2020 2020 2020 2065 7863 6570 7420 4e6f         except No
-000184c0: 7446 6f75 6e64 4572 726f 723a 0a20 2020  tFoundError:.   
-000184d0: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-000184e0: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
-000184f0: 2020 2020 2020 2020 2020 2020 2027 436f               'Co
-00018500: 756c 6420 6e6f 7420 6465 6c65 7465 2022  uld not delete "
-00018510: 2573 223a 2074 6865 2069 7465 6d20 6e6f  %s": the item no
-00018520: 206c 6f6e 6765 7220 6578 6973 7473 206f   longer exists o
-00018530: 6e20 4472 6f70 626f 7827 2c0a 2020 2020  n Dropbox',.    
-00018540: 2020 2020 2020 2020 2020 2020 6576 656e              even
-00018550: 742e 6462 785f 7061 7468 2c0a 2020 2020  t.dbx_path,.    
-00018560: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00018570: 2020 2020 2020 7374 6174 7573 203d 2053        status = S
-00018580: 796e 6353 7461 7475 732e 536b 6970 7065  yncStatus.Skippe
-00018590: 640a 2020 2020 2020 2020 6578 6365 7074  d.        except
-000185a0: 2050 6174 6845 7272 6f72 3a0a 2020 2020   PathError:.    
-000185b0: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-000185c0: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
-000185d0: 2020 2020 2020 2020 2020 2020 2743 6f75              'Cou
-000185e0: 6c64 206e 6f74 2064 656c 6574 6520 2225  ld not delete "%
-000185f0: 7322 3a20 7468 6520 6974 656d 2068 6173  s": the item has
-00018600: 2062 6565 6e20 6368 616e 6765 6420 7369   been changed si
-00018610: 6e63 6520 6c61 7374 2073 796e 6327 2c0a  nce last sync',.
-00018620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018630: 6576 656e 742e 6462 785f 7061 7468 2c0a  event.dbx_path,.
-00018640: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
-00018650: 2020 2020 2020 2020 2020 7374 6174 7573            status
-00018660: 203d 2053 796e 6353 7461 7475 732e 536b   = SyncStatus.Sk
-00018670: 6970 7065 640a 0a20 2020 2020 2020 2023  ipped..        #
-00018680: 2052 656d 6f76 6520 7265 7669 7369 6f6e   Remove revision
-00018690: 206d 6574 6164 6174 612e 0a20 2020 2020   metadata..     
-000186a0: 2020 2073 656c 662e 7265 6d6f 7665 5f6e     self.remove_n
-000186b0: 6f64 655f 6672 6f6d 5f69 6e64 6578 2865  ode_from_index(e
-000186c0: 7665 6e74 2e64 6278 5f70 6174 685f 6c6f  vent.dbx_path_lo
-000186d0: 7765 7229 0a0a 2020 2020 2020 2020 7265  wer)..        re
-000186e0: 7475 726e 2073 7461 7475 730a 0a20 2020  turn status..   
-000186f0: 2064 6566 205f 6861 6e64 6c65 5f75 706c   def _handle_upl
-00018700: 6f61 645f 636f 6e66 6c69 6374 2873 656c  oad_conflict(sel
-00018710: 662c 206d 645f 6e65 773a 204d 6574 6164  f, md_new: Metad
-00018720: 6174 612c 2065 7665 6e74 3a20 5379 6e63  ata, event: Sync
-00018730: 4576 656e 7429 202d 3e20 626f 6f6c 3a0a  Event) -> bool:.
-00018740: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00018750: 2020 2020 4966 2061 2063 6f6e 666c 6963      If a conflic
-00018760: 7469 6e67 2063 6f70 7920 7761 7320 6372  ting copy was cr
-00018770: 6561 7465 6420 6279 2044 726f 7062 6f78  eated by Dropbox
-00018780: 2064 7572 696e 6720 7468 6520 7570 6c6f   during the uplo
-00018790: 6164 2c20 7765 206d 6972 726f 7220 7468  ad, we mirror th
-000187a0: 650a 2020 2020 2020 2020 7265 6d6f 7465  e.        remote
-000187b0: 2063 6861 6e67 6573 206c 6f63 616c 6c79   changes locally
-000187c0: 2e20 5468 6973 206d 6574 686f 6420 6361  . This method ca
-000187d0: 6e20 6f6e 6c79 2062 6520 7573 6564 2066  n only be used f
-000187e0: 6f72 2061 6464 6564 2c20 6368 616e 6765  or added, change
-000187f0: 6420 616e 640a 2020 2020 2020 2020 6d6f  d and.        mo
-00018800: 7665 6420 6576 656e 7473 2e0a 0a20 2020  ved events...   
-00018810: 2020 2020 203a 7061 7261 6d20 6d64 5f6e       :param md_n
-00018820: 6577 3a20 4d65 7461 6461 7461 206f 6620  ew: Metadata of 
-00018830: 6974 656d 2061 6674 6572 2075 706c 6f61  item after uploa
-00018840: 642e 0a20 2020 2020 2020 203a 7061 7261  d..        :para
-00018850: 6d20 6576 656e 743a 204f 7269 6769 6e61  m event: Origina
-00018860: 6c20 7570 6c6f 6164 2073 796e 6320 6576  l upload sync ev
-00018870: 656e 7420 7768 6963 6820 7472 6967 6765  ent which trigge
-00018880: 7265 6420 7468 6520 7570 6c6f 6164 2e0a  red the upload..
-00018890: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
-000188a0: 3a20 5768 6574 6865 7220 6120 636f 6e66  : Whether a conf
-000188b0: 6c69 6374 696e 6720 636f 7079 2077 6173  licting copy was
-000188c0: 2063 7265 6174 6564 2e0a 2020 2020 2020   created..      
-000188d0: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
-000188e0: 2065 7665 6e74 2e69 735f 6465 6c65 7465   event.is_delete
-000188f0: 643a 0a20 2020 2020 2020 2020 2020 2072  d:.            r
-00018900: 6169 7365 2056 616c 7565 4572 726f 7228  aise ValueError(
-00018910: 2243 616e 6e6f 7420 7072 6f63 6573 7320  "Cannot process 
-00018920: 6465 6c65 7465 6420 6576 656e 742e 2229  deleted event.")
-00018930: 0a0a 2020 2020 2020 2020 6966 2073 656c  ..        if sel
-00018940: 662e 6973 5f66 735f 6361 7365 5f73 656e  f.is_fs_case_sen
-00018950: 7369 7469 7665 3a0a 2020 2020 2020 2020  sitive:.        
-00018960: 2020 2020 2320 436f 6d70 6172 6520 756e      # Compare un
-00018970: 2d6e 6f72 6d61 6c69 7a65 6420 6669 6c65  -normalized file
-00018980: 206e 616d 6573 2e20 5468 6973 2065 6e73   names. This ens
-00018990: 7572 6573 2074 6861 7420 7765 206d 6972  ures that we mir
-000189a0: 726f 7220 6c6f 6361 6c6c 7920 616e 790a  ror locally any.
-000189b0: 2020 2020 2020 2020 2020 2020 2320 756e              # un
-000189c0: 6963 6f64 6520 6f72 2063 6173 6520 6e6f  icode or case no
-000189d0: 726d 616c 697a 6174 696f 6e20 7065 7266  rmalization perf
-000189e0: 6f72 6d65 6420 6279 2044 726f 7062 6f78  ormed by Dropbox
-000189f0: 2073 6572 7665 7273 2e0a 2020 2020 2020   servers..      
-00018a00: 2020 2020 2020 6966 206d 645f 6e65 772e        if md_new.
-00018a10: 6e61 6d65 203d 3d20 6f73 702e 6261 7365  name == osp.base
-00018a20: 6e61 6d65 2865 7665 6e74 2e6c 6f63 616c  name(event.local
-00018a30: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
-00018a40: 2020 2020 2020 2020 2320 4e6f 2063 6f6e          # No con
-00018a50: 666c 6963 7469 6e67 2063 6f70 7920 7761  flicting copy wa
-00018a60: 7320 6372 6561 7465 642e 0a20 2020 2020  s created..     
-00018a70: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00018a80: 6e20 4661 6c73 650a 2020 2020 2020 2020  n False.        
-00018a90: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00018aa0: 2020 2320 436f 6d70 6172 6520 6e6f 726d    # Compare norm
-00018ab0: 616c 697a 6564 2070 6174 6873 2e20 4d69  alized paths. Mi
-00018ac0: 7272 6f72 696e 6720 616e 7920 6e6f 726d  rroring any norm
-00018ad0: 616c 697a 6174 696f 6e20 6368 616e 6765  alization change
-00018ae0: 7320 6c6f 6361 6c6c 7920 6973 0a20 2020  s locally is.   
-00018af0: 2020 2020 2020 2020 2023 206e 6f74 2072           # not r
-00018b00: 6571 7569 7265 6420 6f6e 206e 6f72 6d61  equired on norma
-00018b10: 6c69 7369 6e67 2066 696c 6520 7379 7374  lising file syst
-00018b20: 656d 732e 0a20 2020 2020 2020 2020 2020  ems..           
-00018b30: 2069 6620 6d64 5f6e 6577 2e70 6174 685f   if md_new.path_
-00018b40: 6c6f 7765 7220 3d3d 2065 7665 6e74 2e64  lower == event.d
-00018b50: 6278 5f70 6174 685f 6c6f 7765 723a 0a20  bx_path_lower:. 
-00018b60: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-00018b70: 204e 6f20 636f 6e66 6c69 6374 696e 6720   No conflicting 
-00018b80: 636f 7079 2077 6173 2063 7265 6174 6564  copy was created
-00018b90: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00018ba0: 2020 7265 7475 726e 2046 616c 7365 0a0a    return False..
-00018bb0: 2020 2020 2020 2020 2320 4765 7420 6e65          # Get ne
-00018bc0: 7720 6c6f 6361 6c20 7061 7468 2063 6f72  w local path cor
-00018bd0: 7265 7370 6f6e 6469 6e67 2074 6f20 6372  responding to cr
-00018be0: 6561 7465 6420 656e 7472 792e 0a20 2020  eated entry..   
-00018bf0: 2020 2020 206c 6f63 616c 5f70 6174 685f       local_path_
-00018c00: 6363 203d 2073 656c 662e 746f 5f6c 6f63  cc = self.to_loc
-00018c10: 616c 5f70 6174 6828 6d64 5f6e 6577 2e70  al_path(md_new.p
-00018c20: 6174 685f 6469 7370 6c61 7929 0a0a 2020  ath_display)..  
-00018c30: 2020 2020 2020 2320 4d6f 7665 2074 6865        # Move the
-00018c40: 206c 6f63 616c 2069 7465 6d2e 0a20 2020   local item..   
-00018c50: 2020 2020 2065 7665 6e74 5f63 6c73 203d       event_cls =
-00018c60: 2044 6972 4d6f 7665 6445 7665 6e74 2069   DirMovedEvent i
-00018c70: 6620 6973 6469 7228 6576 656e 742e 6c6f  f isdir(event.lo
-00018c80: 6361 6c5f 7061 7468 2920 656c 7365 2046  cal_path) else F
-00018c90: 696c 654d 6f76 6564 4576 656e 740a 2020  ileMovedEvent.  
-00018ca0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
-00018cb0: 6673 5f65 7665 6e74 732e 6967 6e6f 7265  fs_events.ignore
-00018cc0: 2865 7665 6e74 5f63 6c73 2865 7665 6e74  (event_cls(event
-00018cd0: 2e6c 6f63 616c 5f70 6174 682c 206c 6f63  .local_path, loc
-00018ce0: 616c 5f70 6174 685f 6363 2929 3a0a 2020  al_path_cc)):.  
-00018cf0: 2020 2020 2020 2020 2020 7769 7468 2063            with c
-00018d00: 6f6e 7665 7274 5f61 7069 5f65 7272 6f72  onvert_api_error
-00018d10: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
-00018d20: 2020 2020 206d 6f76 6528 6576 656e 742e       move(event.
-00018d30: 6c6f 6361 6c5f 7061 7468 2c20 6c6f 6361  local_path, loca
-00018d40: 6c5f 7061 7468 5f63 632c 2072 6169 7365  l_path_cc, raise
-00018d50: 5f65 7272 6f72 3d54 7275 6529 0a0a 2020  _error=True)..  
-00018d60: 2020 2020 2020 2320 4465 6c65 7465 2065        # Delete e
-00018d70: 6e74 7279 206f 6620 6f6c 6420 7061 7468  ntry of old path
-00018d80: 2e0a 2020 2020 2020 2020 7365 6c66 2e72  ..        self.r
-00018d90: 656d 6f76 655f 6e6f 6465 5f66 726f 6d5f  emove_node_from_
-00018da0: 696e 6465 7828 6576 656e 742e 6462 785f  index(event.dbx_
-00018db0: 7061 7468 5f6c 6f77 6572 290a 2020 2020  path_lower).    
-00018dc0: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
-00018dd0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
-00018de0: 2020 2020 2755 706c 6f61 6420 636f 6e66      'Upload conf
-00018df0: 6c69 6374 3a20 7265 6e61 6d65 6420 2225  lict: renamed "%
-00018e00: 7322 2074 6f20 2225 7322 272c 0a20 2020  s" to "%s"',.   
-00018e10: 2020 2020 2020 2020 2065 7665 6e74 2e64           event.d
-00018e20: 6278 5f70 6174 682c 0a20 2020 2020 2020  bx_path,.       
-00018e30: 2020 2020 206d 645f 6e65 772e 7061 7468       md_new.path
-00018e40: 5f64 6973 706c 6179 2c0a 2020 2020 2020  _display,.      
-00018e50: 2020 290a 0a20 2020 2020 2020 2072 6574    )..        ret
-00018e60: 7572 6e20 5472 7565 0a0a 2020 2020 6465  urn True..    de
-00018e70: 6620 5f63 6865 636b 5f72 6571 7569 7265  f _check_require
-00018e80: 735f 7570 6c6f 6164 2873 656c 662c 2065  s_upload(self, e
-00018e90: 7665 6e74 3a20 5379 6e63 4576 656e 7429  vent: SyncEvent)
-00018ea0: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
-00018eb0: 2020 2222 220a 2020 2020 2020 2020 4368    """.        Ch
-00018ec0: 6563 6b73 2069 6620 6120 6c6f 6361 6c20  ecks if a local 
-00018ed0: 6669 6c65 206e 6565 6473 2074 6f20 6265  file needs to be
-00018ee0: 2075 706c 6f61 6465 642e 2054 6869 7320   uploaded. This 
-00018ef0: 6973 2064 6574 6572 6d69 6e65 6420 6279  is determined by
-00018f00: 2063 6865 636b 696e 6720 666f 720a 2020   checking for.  
-00018f10: 2020 2020 2020 6571 7561 6c20 6669 6c65        equal file
-00018f20: 2063 6f6e 7465 6e74 732e 2049 6620 6e6f   contents. If no
-00018f30: 2075 706c 6f61 6420 6973 2072 6571 7569   upload is requi
-00018f40: 7265 642c 2074 6865 206c 6f63 616c 2069  red, the local i
-00018f50: 6e64 6578 2069 7320 7570 6461 7465 6420  ndex is updated 
-00018f60: 7769 7468 0a20 2020 2020 2020 2074 6865  with.        the
-00018f70: 2072 656d 6f74 6520 6d65 7461 6461 7461   remote metadata
-00018f80: 2e20 4e6f 7465 2074 6861 7420 636f 6e66  . Note that conf
-00018f90: 6c69 6374 2072 6573 6f6c 7574 696f 6e20  lict resolution 
-00018fa0: 696e 2063 6173 6520 6f66 2064 6966 6665  in case of diffe
-00018fb0: 7265 6e74 2063 6f6e 7465 6e74 0a20 2020  rent content.   
-00018fc0: 2020 2020 2077 696c 6c20 6265 2068 616e       will be han
-00018fd0: 646c 6564 2062 7920 7468 6520 7365 7276  dled by the serv
-00018fe0: 6572 2e0a 0a20 2020 2020 2020 203a 7061  er...        :pa
-00018ff0: 7261 6d20 6576 656e 743a 204c 6f63 616c  ram event: Local
-00019000: 2073 796e 6320 6576 656e 7420 6f66 2061   sync event of a
-00019010: 2066 696c 6520 6372 6561 7469 6f6e 206f   file creation o
-00019020: 7220 6d6f 6469 6669 6361 7469 6f6e 2e0a  r modification..
-00019030: 2020 2020 2020 2020 3a72 6574 7572 6e3a          :return:
-00019040: 2057 6865 7468 6572 2074 6865 2072 656d   Whether the rem
-00019050: 6f74 6520 6974 656d 2068 6173 2074 6865  ote item has the
-00019060: 2073 616d 6520 636f 6e74 656e 7420 6173   same content as
-00019070: 2074 6865 206c 6f63 616c 2073 796e 6320   the local sync 
-00019080: 6576 656e 742e 0a20 2020 2020 2020 2022  event..        "
-00019090: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
-000190a0: 7420 2865 7665 6e74 2e69 735f 6669 6c65  t (event.is_file
-000190b0: 2061 6e64 2028 6576 656e 742e 6973 5f63   and (event.is_c
-000190c0: 6861 6e67 6564 206f 7220 6576 656e 742e  hanged or event.
-000190d0: 6973 5f61 6464 6564 2929 3a0a 2020 2020  is_added)):.    
-000190e0: 2020 2020 2020 2020 7261 6973 6520 5661          raise Va
-000190f0: 6c75 6545 7272 6f72 2822 4361 6e20 6f6e  lueError("Can on
-00019100: 6c79 2062 6520 6361 6c6c 6564 2077 6974  ly be called wit
-00019110: 6820 6164 6465 6420 6f72 206d 6f64 6966  h added or modif
-00019120: 6965 6420 6669 6c65 7322 290a 0a20 2020  ied files")..   
-00019130: 2020 2020 206d 645f 6f6c 6420 3d20 7365       md_old = se
-00019140: 6c66 2e63 6c69 656e 742e 6765 745f 6d65  lf.client.get_me
-00019150: 7461 6461 7461 2865 7665 6e74 2e64 6278  tadata(event.dbx
-00019160: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-00019170: 6966 2069 7369 6e73 7461 6e63 6528 6d64  if isinstance(md
-00019180: 5f6f 6c64 2c20 4669 6c65 4d65 7461 6461  _old, FileMetada
-00019190: 7461 293a 0a20 2020 2020 2020 2020 2020  ta):.           
-000191a0: 2069 6620 280a 2020 2020 2020 2020 2020   if (.          
-000191b0: 2020 2020 2020 6576 656e 742e 636f 6e74        event.cont
-000191c0: 656e 745f 6861 7368 203d 3d20 6d64 5f6f  ent_hash == md_o
-000191d0: 6c64 2e63 6f6e 7465 6e74 5f68 6173 680a  ld.content_hash.
-000191e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000191f0: 616e 6420 6576 656e 742e 7379 6d6c 696e  and event.symlin
-00019200: 6b5f 7461 7267 6574 203d 3d20 6d64 5f6f  k_target == md_o
-00019210: 6c64 2e73 796d 6c69 6e6b 5f74 6172 6765  ld.symlink_targe
-00019220: 740a 2020 2020 2020 2020 2020 2020 293a  t.            ):
-00019230: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019240: 2023 2046 696c 6520 636f 6e74 656e 7473   # File contents
-00019250: 2061 7265 2069 6465 6e74 6963 616c 2c20   are identical, 
-00019260: 646f 206e 6f74 2075 706c 6f61 642e 0a20  do not upload.. 
-00019270: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00019280: 6861 6e67 655f 7479 7065 203d 2022 4d6f  hange_type = "Mo
-00019290: 6469 6669 6361 7469 6f6e 2220 6966 2065  dification" if e
-000192a0: 7665 6e74 2e69 735f 6368 616e 6765 6420  vent.is_changed 
-000192b0: 656c 7365 2022 4372 6561 7469 6f6e 220a  else "Creation".
-000192c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000192d0: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
-000192e0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-000192f0: 2020 2020 2020 2020 2725 7320 6f66 2022          '%s of "
-00019300: 2573 2220 6465 7465 6374 6564 2062 7574  %s" detected but
-00019310: 2066 696c 6520 636f 6e74 656e 7420 6973   file content is
-00019320: 2074 6865 2073 616d 6520 6173 206f 6e20   the same as on 
-00019330: 4472 6f70 626f 7827 2c0a 2020 2020 2020  Dropbox',.      
-00019340: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-00019350: 616e 6765 5f74 7970 652c 0a20 2020 2020  ange_type,.     
-00019360: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00019370: 7665 6e74 2e64 6278 5f70 6174 682c 0a20  vent.dbx_path,. 
-00019380: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-00019390: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000193a0: 2073 656c 662e 7570 6461 7465 5f69 6e64   self.update_ind
-000193b0: 6578 5f66 726f 6d5f 6462 785f 6d65 7461  ex_from_dbx_meta
-000193c0: 6461 7461 286d 645f 6f6c 6429 0a20 2020  data(md_old).   
-000193d0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-000193e0: 7572 6e20 4661 6c73 650a 2020 2020 2020  urn False.      
-000193f0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00019400: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00019410: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
-00019420: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
-00019430: 2020 2320 3d3d 3d3d 2044 6f77 6e6c 6f61    # ==== Downloa
-00019440: 6420 7379 6e63 203d 3d3d 3d3d 3d3d 3d3d  d sync =========
-00019450: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019460: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019470: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00019480: 3d3d 3d3d 3d3d 0a0a 2020 2020 6465 6620  ======..    def 
-00019490: 6765 745f 7265 6d6f 7465 5f69 7465 6d28  get_remote_item(
-000194a0: 7365 6c66 2c20 6462 785f 7061 7468 3a20  self, dbx_path: 
-000194b0: 7374 7229 202d 3e20 626f 6f6c 3a0a 2020  str) -> bool:.  
-000194c0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-000194d0: 2020 446f 776e 6c6f 6164 7320 6120 7265    Downloads a re
-000194e0: 6d6f 7465 2066 696c 6520 6f72 2066 6f6c  mote file or fol
-000194f0: 6465 7220 616e 6420 7570 6461 7465 7320  der and updates 
-00019500: 6974 7320 6c6f 6361 6c20 7265 762e 2049  its local rev. I
-00019510: 6620 7468 6520 7265 6d6f 7465 2069 7465  f the remote ite
-00019520: 6d0a 2020 2020 2020 2020 646f 6573 206e  m.        does n
-00019530: 6f74 2065 7869 7374 2c20 616e 7920 636f  ot exist, any co
-00019540: 7272 6573 706f 6e64 696e 6720 6c6f 6361  rresponding loca
-00019550: 6c20 6974 656d 7320 7769 6c6c 2062 6520  l items will be 
-00019560: 6465 6c65 7465 642e 2049 6620 6060 6462  deleted. If ``db
-00019570: 785f 7061 7468 6060 0a20 2020 2020 2020  x_path``.       
-00019580: 2072 6566 6572 7320 746f 2061 2066 6f6c   refers to a fol
-00019590: 6465 722c 2074 6865 2064 6f77 6e6c 6f61  der, the downloa
-000195a0: 6420 7769 6c6c 2062 6520 6861 6e64 6c65  d will be handle
-000195b0: 6420 6279 203a 6d65 7468 3a60 5f67 6574  d by :meth:`_get
-000195c0: 5f72 656d 6f74 655f 666f 6c64 6572 602e  _remote_folder`.
-000195d0: 0a20 2020 2020 2020 2049 6620 6974 2072  .        If it r
-000195e0: 6566 6572 7320 746f 2061 2073 696e 676c  efers to a singl
-000195f0: 6520 6669 6c65 2c20 7468 6520 646f 776e  e file, the down
-00019600: 6c6f 6164 2077 696c 6c20 6265 2070 6572  load will be per
-00019610: 666f 726d 6564 2062 790a 2020 2020 2020  formed by.      
-00019620: 2020 3a6d 6574 683a 605f 6372 6561 7465    :meth:`_create
-00019630: 5f6c 6f63 616c 5f65 6e74 7279 602e 0a0a  _local_entry`...
-00019640: 2020 2020 2020 2020 5468 6973 206d 6574          This met
-00019650: 686f 6420 6361 6e20 6265 2075 7365 6420  hod can be used 
-00019660: 746f 2066 6574 6368 2069 6e64 6976 6964  to fetch individ
-00019670: 7561 6c20 6974 656d 7320 6f75 7473 6964  ual items outsid
-00019680: 6520 7468 6520 7265 6775 6c61 7220 7379  e the regular sy
-00019690: 6e63 0a20 2020 2020 2020 2063 7963 6c65  nc.        cycle
-000196a0: 2c20 666f 7220 696e 7374 616e 6365 2077  , for instance w
-000196b0: 6865 6e20 696e 636c 7564 696e 6720 6120  hen including a 
-000196c0: 7072 6576 696f 7573 6c79 2065 7863 6c75  previously exclu
-000196d0: 6465 6420 6669 6c65 206f 7220 666f 6c64  ded file or fold
-000196e0: 6572 2e0a 0a20 2020 2020 2020 203a 7061  er...        :pa
-000196f0: 7261 6d20 6462 785f 7061 7468 3a20 5061  ram dbx_path: Pa
-00019700: 7468 2072 656c 6174 6976 6520 746f 2044  th relative to D
-00019710: 726f 7062 6f78 2066 6f6c 6465 722e 0a20  ropbox folder.. 
-00019720: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-00019730: 2057 6865 7468 6572 2064 6f77 6e6c 6f61   Whether downloa
-00019740: 6420 7761 7320 7375 6363 6573 7366 756c  d was successful
-00019750: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00019760: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-00019770: 6572 2e69 6e66 6f28 6622 5379 6e63 696e  er.info(f"Syncin
-00019780: 6720 e286 9320 7b64 6278 5f70 6174 687d  g ... {dbx_path}
-00019790: 2229 0a0a 2020 2020 2020 2020 7769 7468  ")..        with
-000197a0: 2073 656c 662e 7379 6e63 5f6c 6f63 6b3a   self.sync_lock:
-000197b0: 0a20 2020 2020 2020 2020 2020 206d 6420  .            md 
-000197c0: 3d20 7365 6c66 2e63 6c69 656e 742e 6765  = self.client.ge
-000197d0: 745f 6d65 7461 6461 7461 2864 6278 5f70  t_metadata(dbx_p
-000197e0: 6174 682c 2069 6e63 6c75 6465 5f64 656c  ath, include_del
-000197f0: 6574 6564 3d54 7275 6529 0a0a 2020 2020  eted=True)..    
-00019800: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
-00019810: 5f6c 6f77 6572 203d 206e 6f72 6d61 6c69  _lower = normali
-00019820: 7a65 2864 6278 5f70 6174 6829 0a0a 2020  ze(dbx_path)..  
-00019830: 2020 2020 2020 2020 2020 6966 206d 6420            if md 
-00019840: 6973 204e 6f6e 653a 0a20 2020 2020 2020  is None:.       
-00019850: 2020 2020 2020 2020 2023 2043 7265 6174           # Creat
-00019860: 6520 6120 6661 6b65 2064 656c 6574 6564  e a fake deleted
-00019870: 2065 7665 6e74 2e0a 2020 2020 2020 2020   event..        
-00019880: 2020 2020 2020 2020 696e 6465 785f 656e          index_en
-00019890: 7472 7920 3d20 7365 6c66 2e67 6574 5f69  try = self.get_i
-000198a0: 6e64 6578 5f65 6e74 7279 2864 6278 5f70  ndex_entry(dbx_p
-000198b0: 6174 685f 6c6f 7765 7229 0a20 2020 2020  ath_lower).     
-000198c0: 2020 2020 2020 2020 2020 2063 6173 6564             cased
-000198d0: 5f70 6174 6820 3d20 696e 6465 785f 656e  _path = index_en
-000198e0: 7472 792e 6462 785f 7061 7468 5f63 6173  try.dbx_path_cas
-000198f0: 6564 2069 6620 696e 6465 785f 656e 7472  ed if index_entr
-00019900: 7920 656c 7365 2064 6278 5f70 6174 680a  y else dbx_path.
-00019910: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019920: 206d 6420 3d20 4465 6c65 7465 644d 6574   md = DeletedMet
-00019930: 6164 6174 6128 0a20 2020 2020 2020 2020  adata(.         
-00019940: 2020 2020 2020 2020 2020 206e 616d 653d             name=
-00019950: 6f73 702e 6261 7365 6e61 6d65 2864 6278  osp.basename(dbx
-00019960: 5f70 6174 6829 2c0a 2020 2020 2020 2020  _path),.        
-00019970: 2020 2020 2020 2020 2020 2020 7061 7468              path
-00019980: 5f6c 6f77 6572 3d64 6278 5f70 6174 685f  _lower=dbx_path_
-00019990: 6c6f 7765 722c 0a20 2020 2020 2020 2020  lower,.         
-000199a0: 2020 2020 2020 2020 2020 2070 6174 685f             path_
-000199b0: 6469 7370 6c61 793d 6361 7365 645f 7061  display=cased_pa
-000199c0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-000199d0: 2020 2020 290a 0a20 2020 2020 2020 2020      )..         
-000199e0: 2020 2065 7665 6e74 203d 2053 796e 6345     event = SyncE
-000199f0: 7665 6e74 2e66 726f 6d5f 6d65 7461 6461  vent.from_metada
-00019a00: 7461 286d 642c 2073 656c 6629 0a0a 2020  ta(md, self)..  
-00019a10: 2020 2020 2020 2020 2020 6966 2065 7665            if eve
-00019a20: 6e74 2e69 735f 6469 7265 6374 6f72 793a  nt.is_directory:
-00019a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00019a40: 2073 7563 6365 7373 203d 2073 656c 662e   success = self.
-00019a50: 5f67 6574 5f72 656d 6f74 655f 666f 6c64  _get_remote_fold
-00019a60: 6572 2864 6278 5f70 6174 6829 0a20 2020  er(dbx_path).   
-00019a70: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00019a80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00019a90: 656c 662e 6163 7469 7669 7479 2e61 6464  elf.activity.add
-00019aa0: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
-00019ab0: 2020 2020 2020 2020 6520 3d20 7365 6c66          e = self
-00019ac0: 2e5f 6372 6561 7465 5f6c 6f63 616c 5f65  ._create_local_e
-00019ad0: 6e74 7279 2865 7665 6e74 290a 2020 2020  ntry(event).    
-00019ae0: 2020 2020 2020 2020 2020 2020 7375 6363              succ
-00019af0: 6573 7320 3d20 652e 7374 6174 7573 2069  ess = e.status i
-00019b00: 6e20 2853 796e 6353 7461 7475 732e 446f  n (SyncStatus.Do
-00019b10: 6e65 2c20 5379 6e63 5374 6174 7573 2e53  ne, SyncStatus.S
-00019b20: 6b69 7070 6564 290a 0a20 2020 2020 2020  kipped)..       
-00019b30: 2020 2020 2073 656c 662e 5f63 6c65 6172       self._clear
-00019b40: 5f63 6163 6865 7328 290a 0a20 2020 2020  _caches()..     
-00019b50: 2020 2020 2020 2072 6574 7572 6e20 7375         return su
-00019b60: 6363 6573 730a 0a20 2020 2064 6566 205f  ccess..    def _
-00019b70: 6765 745f 7265 6d6f 7465 5f66 6f6c 6465  get_remote_folde
-00019b80: 7228 7365 6c66 2c20 6462 785f 7061 7468  r(self, dbx_path
-00019b90: 3a20 7374 7229 202d 3e20 626f 6f6c 3a0a  : str) -> bool:.
-00019ba0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-00019bb0: 2020 2020 4765 7473 2061 6c6c 2066 696c      Gets all fil
-00019bc0: 6573 2f66 6f6c 6465 7273 2066 726f 6d20  es/folders from 
-00019bd0: 6120 4472 6f70 626f 7820 666f 6c64 6572  a Dropbox folder
-00019be0: 2061 6e64 2077 7269 7465 7320 7468 656d   and writes them
-00019bf0: 2074 6f20 7468 6520 6c6f 6361 6c20 666f   to the local fo
-00019c00: 6c64 6572 0a20 2020 2020 2020 203a 6174  lder.        :at
-00019c10: 7472 3a60 6472 6f70 626f 785f 7061 7468  tr:`dropbox_path
-00019c20: 602e 0a0a 2020 2020 2020 2020 3a70 6172  `...        :par
-00019c30: 616d 2064 6278 5f70 6174 683a 2050 6174  am dbx_path: Pat
-00019c40: 6820 7265 6c61 7469 7665 2074 6f20 4472  h relative to Dr
-00019c50: 6f70 626f 7820 666f 6c64 6572 2e0a 2020  opbox folder..  
-00019c60: 2020 2020 2020 3a72 6574 7572 6e73 3a20        :returns: 
-00019c70: 5768 6574 6865 7220 646f 776e 6c6f 6164  Whether download
-00019c80: 2077 6173 2073 7563 6365 7373 6675 6c2e   was successful.
-00019c90: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-00019ca0: 2020 2020 2077 6974 6820 7365 6c66 2e73       with self.s
-00019cb0: 796e 635f 6c6f 636b 3a0a 2020 2020 2020  ync_lock:.      
-00019cc0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-00019cd0: 2020 2020 2020 2020 2020 2069 6478 203d             idx =
-00019ce0: 2030 0a0a 2020 2020 2020 2020 2020 2020   0..            
-00019cf0: 2020 2020 2320 4974 6572 6174 6520 6f76      # Iterate ov
-00019d00: 6572 2069 6e64 6578 2061 6e64 2064 6f77  er index and dow
-00019d10: 6e6c 6f61 6420 7265 7375 6c74 732e 0a20  nload results.. 
-00019d20: 2020 2020 2020 2020 2020 2020 2020 206c                 l
-00019d30: 6973 745f 6974 6572 203d 2073 656c 662e  ist_iter = self.
-00019d40: 636c 6965 6e74 2e6c 6973 745f 666f 6c64  client.list_fold
-00019d50: 6572 5f69 7465 7261 746f 7228 6462 785f  er_iterator(dbx_
-00019d60: 7061 7468 2c20 7265 6375 7273 6976 653d  path, recursive=
-00019d70: 5472 7565 290a 0a20 2020 2020 2020 2020  True)..         
-00019d80: 2020 2020 2020 2066 6f72 2072 6573 2069         for res i
-00019d90: 6e20 6c69 7374 5f69 7465 723a 0a20 2020  n list_iter:.   
-00019da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019db0: 2069 6478 202b 3d20 6c65 6e28 7265 732e   idx += len(res.
-00019dc0: 656e 7472 6965 7329 0a0a 2020 2020 2020  entries)..      
-00019dd0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00019de0: 2069 6478 203e 2030 3a0a 2020 2020 2020   idx > 0:.      
-00019df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019e00: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e69    self._logger.i
-00019e10: 6e66 6f28 6622 496e 6465 7869 6e67 207b  nfo(f"Indexing {
-00019e20: 6964 787d 2e2e 2e22 290a 0a20 2020 2020  idx}...")..     
-00019e30: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00019e40: 6573 2e65 6e74 7269 6573 2e73 6f72 7428  es.entries.sort(
-00019e50: 6b65 793d 6c61 6d62 6461 2078 3a20 782e  key=lambda x: x.
-00019e60: 7061 7468 5f6c 6f77 6572 2e63 6f75 6e74  path_lower.count
-00019e70: 2822 2f22 2929 0a0a 2020 2020 2020 2020  ("/"))..        
-00019e80: 2020 2020 2020 2020 2020 2020 2320 436f              # Co
-00019e90: 6e76 6572 7420 6d65 7461 6461 7461 2074  nvert metadata t
-00019ea0: 6f20 7379 6e63 5f65 7665 6e74 732e 0a20  o sync_events.. 
-00019eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019ec0: 2020 2073 796e 635f 6576 656e 7473 203d     sync_events =
-00019ed0: 205b 0a20 2020 2020 2020 2020 2020 2020   [.             
-00019ee0: 2020 2020 2020 2020 2020 2053 796e 6345             SyncE
-00019ef0: 7665 6e74 2e66 726f 6d5f 6d65 7461 6461  vent.from_metada
-00019f00: 7461 286d 642c 2073 656c 6629 2066 6f72  ta(md, self) for
-00019f10: 206d 6420 696e 2072 6573 2e65 6e74 7269   md in res.entri
-00019f20: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
-00019f30: 2020 2020 2020 205d 0a20 2020 2020 2020         ].       
-00019f40: 2020 2020 2020 2020 2020 2020 2064 6f77               dow
-00019f50: 6e6c 6f61 645f 7265 7320 3d20 7365 6c66  nload_res = self
-00019f60: 2e61 7070 6c79 5f72 656d 6f74 655f 6368  .apply_remote_ch
-00019f70: 616e 6765 7328 7379 6e63 5f65 7665 6e74  anges(sync_event
-00019f80: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-00019f90: 2020 2020 2020 2020 7375 6363 6573 7320          success 
-00019fa0: 3d20 616c 6c28 0a20 2020 2020 2020 2020  = all(.         
-00019fb0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00019fc0: 2e73 7461 7475 7320 696e 2028 5379 6e63  .status in (Sync
-00019fd0: 5374 6174 7573 2e44 6f6e 652c 2053 796e  Status.Done, Syn
-00019fe0: 6353 7461 7475 732e 536b 6970 7065 6429  cStatus.Skipped)
-00019ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a000: 2020 2020 2020 2020 2066 6f72 2065 2069           for e i
-0001a010: 6e20 646f 776e 6c6f 6164 5f72 6573 0a20  n download_res. 
-0001a020: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a030: 2020 2029 0a0a 2020 2020 2020 2020 2020     )..          
-0001a040: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-0001a050: 662e 5f63 616e 6365 6c5f 7265 7175 6573  f._cancel_reques
-0001a060: 7465 642e 6973 5f73 6574 2829 3a0a 2020  ted.is_set():.  
-0001a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001a080: 2020 2020 2020 7261 6973 6520 4361 6e63        raise Canc
-0001a090: 656c 6c65 6445 7272 6f72 2822 5379 6e63  elledError("Sync
-0001a0a0: 2063 616e 6365 6c6c 6564 2229 0a0a 2020   cancelled")..  
-0001a0b0: 2020 2020 2020 2020 2020 6578 6365 7074            except
-0001a0c0: 2053 796e 6345 7272 6f72 2061 7320 653a   SyncError as e:
-0001a0d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a0e0: 2073 656c 662e 5f68 616e 646c 655f 7379   self._handle_sy
-0001a0f0: 6e63 5f65 7272 6f72 2865 2c20 6469 7265  nc_error(e, dire
-0001a100: 6374 696f 6e3d 5379 6e63 4469 7265 6374  ction=SyncDirect
-0001a110: 696f 6e2e 446f 776e 290a 2020 2020 2020  ion.Down).      
-0001a120: 2020 2020 2020 2020 2020 7265 7475 726e            return
-0001a130: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
-0001a140: 2020 2020 7265 7475 726e 2073 7563 6365      return succe
-0001a150: 7373 0a0a 2020 2020 6465 6620 7761 6974  ss..    def wait
-0001a160: 5f66 6f72 5f72 656d 6f74 655f 6368 616e  _for_remote_chan
-0001a170: 6765 7328 0a20 2020 2020 2020 2073 656c  ges(.        sel
-0001a180: 662c 0a20 2020 2020 2020 206c 6173 745f  f,.        last_
-0001a190: 6375 7273 6f72 3a20 7374 722c 0a20 2020  cursor: str,.   
-0001a1a0: 2020 2020 2074 696d 656f 7574 3a20 696e       timeout: in
-0001a1b0: 7420 3d20 3430 2c0a 2020 2020 2920 2d3e  t = 40,.    ) ->
-0001a1c0: 2062 6f6f 6c3a 0a20 2020 2020 2020 2022   bool:.        "
-0001a1d0: 2222 0a20 2020 2020 2020 2042 6c6f 636b  "".        Block
-0001a1e0: 7320 756e 7469 6c20 6368 616e 6765 7320  s until changes 
-0001a1f0: 746f 2074 6865 2072 656d 6f74 6520 4472  to the remote Dr
-0001a200: 6f70 626f 7820 6172 6520 6176 6169 6c61  opbox are availa
-0001a210: 626c 652e 0a0a 2020 2020 2020 2020 3a70  ble...        :p
-0001a220: 6172 616d 206c 6173 745f 6375 7273 6f72  aram last_cursor
-0001a230: 3a20 4375 7273 6f72 2066 6f72 6d20 6c61  : Cursor form la
-0001a240: 7374 2073 796e 632e 0a20 2020 2020 2020  st sync..       
-0001a250: 203a 7061 7261 6d20 7469 6d65 6f75 743a   :param timeout:
-0001a260: 2054 696d 656f 7574 2069 6e20 7365 636f   Timeout in seco
-0001a270: 6e64 7320 6265 666f 7265 2072 6574 7572  nds before retur
-0001a280: 6e69 6e67 2065 7665 6e20 6966 2074 6865  ning even if the
-0001a290: 7265 2061 7265 206e 6f0a 2020 2020 2020  re are no.      
-0001a2a0: 2020 2020 2020 6368 616e 6765 732e 2044        changes. D
-0001a2b0: 726f 7062 6f78 2061 6464 7320 7261 6e64  ropbox adds rand
-0001a2c0: 6f6d 206a 6974 7465 7220 6f66 2075 7020  om jitter of up 
-0001a2d0: 746f 2039 3020 7365 6320 746f 2074 6869  to 90 sec to thi
-0001a2e0: 7320 7661 6c75 652e 0a20 2020 2020 2020  s value..       
-0001a2f0: 203a 7265 7475 726e 733a 2060 6054 7275   :returns: ``Tru
-0001a300: 6560 6020 6966 2063 6861 6e67 6573 2061  e`` if changes a
-0001a310: 7265 2061 7661 696c 6162 6c65 2c20 6060  re available, ``
-0001a320: 4661 6c73 6560 6020 6f74 6865 7277 6973  False`` otherwis
-0001a330: 652e 0a20 2020 2020 2020 2022 2222 0a20  e..        """. 
-0001a340: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-0001a350: 6765 722e 6465 6275 6728 2257 6169 7469  ger.debug("Waiti
-0001a360: 6e67 2066 6f72 2072 656d 6f74 6520 6368  ng for remote ch
-0001a370: 616e 6765 7320 7369 6e63 6520 6375 7273  anges since curs
-0001a380: 6f72 3a5c 6e25 7322 2c20 6c61 7374 5f63  or:\n%s", last_c
-0001a390: 7572 736f 7229 0a20 2020 2020 2020 2068  ursor).        h
-0001a3a0: 6173 5f63 6861 6e67 6573 203d 2073 656c  as_changes = sel
-0001a3b0: 662e 636c 6965 6e74 2e77 6169 745f 666f  f.client.wait_fo
-0001a3c0: 725f 7265 6d6f 7465 5f63 6861 6e67 6573  r_remote_changes
-0001a3d0: 286c 6173 745f 6375 7273 6f72 2c20 7469  (last_cursor, ti
-0001a3e0: 6d65 6f75 743d 7469 6d65 6f75 7429 0a0a  meout=timeout)..
-0001a3f0: 2020 2020 2020 2020 2320 5761 6974 2066          # Wait f
-0001a400: 6f72 2032 2073 6563 2e20 5468 6973 2064  or 2 sec. This d
-0001a410: 656c 6179 2069 7320 7479 7069 6361 6c6c  elay is typicall
-0001a420: 7920 6f6e 6c79 206e 6563 6573 7361 7279  y only necessary
-0001a430: 2066 6f6c 6465 7273 2061 7265 2073 6861   folders are sha
-0001a440: 7265 6420 2f0a 2020 2020 2020 2020 2320  red /.        # 
-0001a450: 756e 2d73 6861 7265 6420 7769 7468 206f  un-shared with o
-0001a460: 7468 6572 2044 726f 7062 6f78 2061 6363  ther Dropbox acc
-0001a470: 6f75 6e74 732e 0a20 2020 2020 2020 2074  ounts..        t
-0001a480: 696d 652e 736c 6565 7028 3229 0a0a 2020  ime.sleep(2)..  
-0001a490: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
-0001a4a0: 6572 2e64 6562 7567 2822 4465 7465 6374  er.debug("Detect
-0001a4b0: 6564 2072 656d 6f74 6520 6368 616e 6765  ed remote change
-0001a4c0: 733a 2025 7322 2c20 6861 735f 6368 616e  s: %s", has_chan
-0001a4d0: 6765 7329 0a20 2020 2020 2020 2072 6574  ges).        ret
-0001a4e0: 7572 6e20 6861 735f 6368 616e 6765 730a  urn has_changes.
-0001a4f0: 0a20 2020 2064 6566 2064 6f77 6e6c 6f61  .    def downloa
-0001a500: 645f 7379 6e63 5f63 7963 6c65 2873 656c  d_sync_cycle(sel
-0001a510: 6629 202d 3e20 4e6f 6e65 3a0a 2020 2020  f) -> None:.    
-0001a520: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-0001a530: 5065 7266 6f72 6d73 2061 2066 756c 6c20  Performs a full 
-0001a540: 646f 776e 6c6f 6164 2073 796e 6320 6379  download sync cy
-0001a550: 636c 6520 6279 2063 616c 6c69 6e67 2069  cle by calling i
-0001a560: 6e20 6f72 6465 723a 0a0a 2020 2020 2020  n order:..      
-0001a570: 2020 2020 2020 3129 203a 6d65 7468 3a60        1) :meth:`
-0001a580: 6c69 7374 5f72 656d 6f74 655f 6368 616e  list_remote_chan
-0001a590: 6765 735f 6974 6572 6174 6f72 600a 2020  ges_iterator`.  
-0001a5a0: 2020 2020 2020 2020 2020 3229 203a 6d65            2) :me
-0001a5b0: 7468 3a60 6170 706c 795f 7265 6d6f 7465  th:`apply_remote
-0001a5c0: 5f63 6861 6e67 6573 600a 0a20 2020 2020  _changes`..     
-0001a5d0: 2020 2048 616e 646c 6573 2075 7064 6174     Handles updat
-0001a5e0: 696e 6720 7468 6520 7265 6d6f 7465 2063  ing the remote c
-0001a5f0: 7572 736f 7220 616e 6420 7265 7375 6d69  ursor and resumi
-0001a600: 6e67 2069 6e74 6572 7275 7074 6564 2073  ng interrupted s
-0001a610: 796e 6373 2066 6f72 2079 6f75 2e0a 2020  yncs for you..  
-0001a620: 2020 2020 2020 4361 6c6c 696e 6720 7468        Calling th
-0001a630: 6973 206d 6574 686f 6420 7769 6c6c 2070  is method will p
-0001a640: 6572 666f 726d 2061 2066 756c 6c20 696e  erform a full in
-0001a650: 6465 7869 6e67 2069 6620 7468 6973 2069  dexing if this i
-0001a660: 7320 7468 6520 6669 7273 7420 646f 776e  s the first down
-0001a670: 6c6f 6164 2e0a 2020 2020 2020 2020 2222  load..        ""
-0001a680: 220a 2020 2020 2020 2020 7769 7468 2073  ".        with s
-0001a690: 656c 662e 7379 6e63 5f6c 6f63 6b3a 0a20  elf.sync_lock:. 
-0001a6a0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-0001a6b0: 6c66 2e72 656d 6f74 655f 6375 7273 6f72  lf.remote_cursor
-0001a6c0: 203d 3d20 2222 3a0a 2020 2020 2020 2020   == "":.        
-0001a6d0: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
-0001a6e0: 6174 652e 7365 7428 2273 796e 6322 2c20  ate.set("sync", 
-0001a6f0: 226c 6173 745f 7265 696e 6465 7822 2c20  "last_reindex", 
-0001a700: 7469 6d65 2e74 696d 6528 2929 0a20 2020  time.time()).   
-0001a710: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001a720: 662e 5f73 7461 7465 2e73 6574 2822 7379  f._state.set("sy
-0001a730: 6e63 222c 2022 6469 645f 6669 6e69 7368  nc", "did_finish
-0001a740: 5f69 6e64 6578 696e 6722 2c20 4661 6c73  _indexing", Fals
-0001a750: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
-0001a760: 2020 2073 656c 662e 5f73 7461 7465 2e73     self._state.s
-0001a770: 6574 2822 7379 6e63 222c 2022 696e 6465  et("sync", "inde
-0001a780: 7869 6e67 5f63 6f75 6e74 6572 222c 2030  xing_counter", 0
-0001a790: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-0001a7a0: 6478 203d 2073 656c 662e 5f73 7461 7465  dx = self._state
-0001a7b0: 2e67 6574 2822 7379 6e63 222c 2022 696e  .get("sync", "in
-0001a7c0: 6465 7869 6e67 5f63 6f75 6e74 6572 2229  dexing_counter")
-0001a7d0: 0a20 2020 2020 2020 2020 2020 2069 735f  .            is_
-0001a7e0: 696e 6465 7869 6e67 203d 206e 6f74 2073  indexing = not s
-0001a7f0: 656c 662e 5f73 7461 7465 2e67 6574 2822  elf._state.get("
-0001a800: 7379 6e63 222c 2022 6469 645f 6669 6e69  sync", "did_fini
-0001a810: 7368 5f69 6e64 6578 696e 6722 290a 0a20  sh_indexing").. 
-0001a820: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-0001a830: 5f69 6e64 6578 696e 6720 616e 6420 6964  _indexing and id
-0001a840: 7820 3d3d 2030 3a0a 2020 2020 2020 2020  x == 0:.        
-0001a850: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
-0001a860: 6767 6572 2e69 6e66 6f28 2249 6e64 6578  gger.info("Index
-0001a870: 696e 6720 7265 6d6f 7465 2044 726f 7062  ing remote Dropb
-0001a880: 6f78 2229 0a20 2020 2020 2020 2020 2020  ox").           
-0001a890: 2065 6c69 6620 6973 5f69 6e64 6578 696e   elif is_indexin
-0001a8a0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-0001a8b0: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-0001a8c0: 696e 666f 2822 5265 7375 6d69 6e67 2069  info("Resuming i
-0001a8d0: 6e64 6578 696e 6722 290a 2020 2020 2020  ndexing").      
-0001a8e0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001a8f0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001a900: 2e5f 6c6f 6767 6572 2e69 6e66 6f28 2246  ._logger.info("F
-0001a910: 6574 6368 696e 6720 7265 6d6f 7465 2063  etching remote c
-0001a920: 6861 6e67 6573 2229 0a0a 2020 2020 2020  hanges")..      
-0001a930: 2020 2020 2020 6368 616e 6765 735f 6974        changes_it
-0001a940: 6572 203d 2073 656c 662e 6c69 7374 5f72  er = self.list_r
-0001a950: 656d 6f74 655f 6368 616e 6765 735f 6974  emote_changes_it
-0001a960: 6572 6174 6f72 2873 656c 662e 7265 6d6f  erator(self.remo
-0001a970: 7465 5f63 7572 736f 7229 0a0a 2020 2020  te_cursor)..    
-0001a980: 2020 2020 2020 2020 2320 446f 776e 6c6f          # Downlo
-0001a990: 6164 2063 6861 6e67 6573 2069 6e20 6368  ad changes in ch
-0001a9a0: 756e 6b73 2074 6f20 7265 6475 6365 206d  unks to reduce m
-0001a9b0: 656d 6f72 7920 7573 6167 652e 0a20 2020  emory usage..   
-0001a9c0: 2020 2020 2020 2020 2066 6f72 2063 6861           for cha
-0001a9d0: 6e67 6573 2c20 6375 7273 6f72 2069 6e20  nges, cursor in 
-0001a9e0: 6368 616e 6765 735f 6974 6572 3a0a 2020  changes_iter:.  
-0001a9f0: 2020 2020 2020 2020 2020 2020 2020 6964                id
-0001aa00: 7820 2b3d 206c 656e 2863 6861 6e67 6573  x += len(changes
-0001aa10: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-0001aa20: 2020 2069 6620 6964 7820 3e20 303a 0a20     if idx > 0:. 
-0001aa30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001aa40: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
-0001aa50: 696e 666f 2866 2249 6e64 6578 696e 6720  info(f"Indexing 
-0001aa60: 7b69 6478 7d2e 2e2e 2229 0a0a 2020 2020  {idx}...")..    
-0001aa70: 2020 2020 2020 2020 2020 2020 646f 776e              down
-0001aa80: 6c6f 6164 6564 203d 2073 656c 662e 6170  loaded = self.ap
-0001aa90: 706c 795f 7265 6d6f 7465 5f63 6861 6e67  ply_remote_chang
-0001aaa0: 6573 2863 6861 6e67 6573 290a 0a20 2020  es(changes)..   
-0001aab0: 2020 2020 2020 2020 2020 2020 2023 2053               # S
-0001aac0: 6176 6520 2869 6e63 7265 6d65 6e74 616c  ave (incremental
-0001aad0: 2920 7265 6d6f 7465 2063 7572 736f 722e  ) remote cursor.
-0001aae0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001aaf0: 2073 656c 662e 7265 6d6f 7465 5f63 7572   self.remote_cur
-0001ab00: 736f 7220 3d20 6375 7273 6f72 0a20 2020  sor = cursor.   
-0001ab10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-0001ab20: 662e 5f73 7461 7465 2e73 6574 2822 7379  f._state.set("sy
-0001ab30: 6e63 222c 2022 696e 6465 7869 6e67 5f63  nc", "indexing_c
-0001ab40: 6f75 6e74 6572 222c 2069 6478 290a 0a20  ounter", idx).. 
-0001ab50: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001ab60: 2053 656e 6420 6465 736b 746f 7020 6e6f   Send desktop no
-0001ab70: 7469 6669 6361 7469 6f6e 7320 7768 656e  tifications when
-0001ab80: 206e 6f74 2069 6e64 6578 696e 672e 0a20   not indexing.. 
-0001ab90: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001aba0: 6620 6e6f 7420 6973 5f69 6e64 6578 696e  f not is_indexin
-0001abb0: 673a 0a20 2020 2020 2020 2020 2020 2020  g:.             
-0001abc0: 2020 2020 2020 2073 656c 662e 6e6f 7469         self.noti
-0001abd0: 6679 5f75 7365 7228 646f 776e 6c6f 6164  fy_user(download
-0001abe0: 6564 290a 0a20 2020 2020 2020 2020 2020  ed)..           
-0001abf0: 2020 2020 2069 6620 7365 6c66 2e5f 6361       if self._ca
-0001ac00: 6e63 656c 5f72 6571 7565 7374 6564 2e69  ncel_requested.i
-0001ac10: 735f 7365 7428 293a 0a20 2020 2020 2020  s_set():.       
-0001ac20: 2020 2020 2020 2020 2020 2020 2072 6169               rai
-0001ac30: 7365 2043 616e 6365 6c6c 6564 4572 726f  se CancelledErro
-0001ac40: 7228 2253 796e 6320 6361 6e63 656c 6c65  r("Sync cancelle
-0001ac50: 6422 290a 0a20 2020 2020 2020 2020 2020  d")..           
-0001ac60: 2020 2020 2023 2046 7265 6520 6d65 6d6f       # Free memo
-0001ac70: 7279 2065 6172 6c79 2074 6f20 7072 6576  ry early to prev
-0001ac80: 656e 7420 6672 6167 6d65 6e74 6174 696f  ent fragmentatio
-0001ac90: 6e2e 0a20 2020 2020 2020 2020 2020 2020  n..             
-0001aca0: 2020 2064 656c 2063 6861 6e67 6573 0a20     del changes. 
-0001acb0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
-0001acc0: 656c 2064 6f77 6e6c 6f61 6465 640a 2020  el downloaded.  
-0001acd0: 2020 2020 2020 2020 2020 2020 2020 6763                gc
-0001ace0: 2e63 6f6c 6c65 6374 2829 0a0a 2020 2020  .collect()..    
-0001acf0: 2020 2020 2020 2020 7365 6c66 2e5f 7374          self._st
-0001ad00: 6174 652e 7365 7428 2273 796e 6322 2c20  ate.set("sync", 
-0001ad10: 2264 6964 5f66 696e 6973 685f 696e 6465  "did_finish_inde
-0001ad20: 7869 6e67 222c 2054 7275 6529 0a20 2020  xing", True).   
-0001ad30: 2020 2020 2020 2020 2073 656c 662e 5f73           self._s
-0001ad40: 7461 7465 2e73 6574 2822 7379 6e63 222c  tate.set("sync",
-0001ad50: 2022 696e 6465 7869 6e67 5f63 6f75 6e74   "indexing_count
-0001ad60: 6572 222c 2030 290a 0a20 2020 2020 2020  er", 0)..       
-0001ad70: 2020 2020 2069 6620 6964 7820 3e20 303a       if idx > 0:
-0001ad80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ad90: 2073 656c 662e 5f6c 6f67 6765 722e 696e   self._logger.in
-0001ada0: 666f 2849 444c 4529 0a0a 2020 2020 2020  fo(IDLE)..      
-0001adb0: 2020 2020 2020 7365 6c66 2e5f 636c 6561        self._clea
-0001adc0: 725f 6361 6368 6573 2829 0a0a 2020 2020  r_caches()..    
-0001add0: 6465 6620 6c69 7374 5f72 656d 6f74 655f  def list_remote_
-0001ade0: 6368 616e 6765 735f 6974 6572 6174 6f72  changes_iterator
-0001adf0: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0001ae00: 6c61 7374 5f63 7572 736f 723a 2073 7472  last_cursor: str
-0001ae10: 0a20 2020 2029 202d 3e20 4974 6572 6174  .    ) -> Iterat
-0001ae20: 6f72 5b74 7570 6c65 5b6c 6973 745b 5379  or[tuple[list[Sy
-0001ae30: 6e63 4576 656e 745d 2c20 7374 725d 5d3a  ncEvent], str]]:
-0001ae40: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001ae50: 2020 2020 2047 6574 2072 656d 6f74 6520       Get remote 
-0001ae60: 6368 616e 6765 7320 7369 6e63 6520 7468  changes since th
-0001ae70: 6520 6c61 7374 2064 6f77 6e6c 6f61 6420  e last download 
-0001ae80: 7379 6e63 2c20 6173 2073 7065 6369 6669  sync, as specifi
-0001ae90: 6564 2062 790a 2020 2020 2020 2020 6060  ed by.        ``
-0001aea0: 6c61 7374 5f63 7572 736f 7260 602e 2049  last_cursor``. I
-0001aeb0: 6620 7468 6520 6060 6c61 7374 5f63 7572  f the ``last_cur
-0001aec0: 736f 7260 6020 6973 2066 726f 6d20 7061  sor`` is from pa
-0001aed0: 6769 6e61 7469 6e67 2074 6872 6f75 6768  ginating through
-0001aee0: 2061 2070 7265 7669 6f75 730a 2020 2020   a previous.    
-0001aef0: 2020 2020 7365 7420 6f66 2063 6861 6e67      set of chang
-0001af00: 6573 2c20 636f 6e74 696e 7565 2077 6865  es, continue whe
-0001af10: 7265 2077 6520 6c65 6674 206f 6666 2e20  re we left off. 
-0001af20: 4966 2060 606c 6173 745f 6375 7273 6f72  If ``last_cursor
-0001af30: 6060 2069 7320 616e 2065 6d70 7479 0a20  `` is an empty. 
-0001af40: 2020 2020 2020 2073 7472 696e 672c 2070         string, p
-0001af50: 6572 666f 726d 2061 2066 756c 6c20 696e  erform a full in
-0001af60: 6465 7869 6e67 206f 6620 7468 6520 4472  dexing of the Dr
-0001af70: 6f70 626f 7820 666f 6c64 6572 2e0a 0a20  opbox folder... 
-0001af80: 2020 2020 2020 203a 7061 7261 6d20 6c61         :param la
-0001af90: 7374 5f63 7572 736f 723a 2043 7572 736f  st_cursor: Curso
-0001afa0: 7220 6672 6f6d 206c 6173 7420 646f 776e  r from last down
-0001afb0: 6c6f 6164 2073 796e 632e 0a20 2020 2020  load sync..     
-0001afc0: 2020 203a 7265 7475 726e 733a 2049 7465     :returns: Ite
-0001afd0: 7261 746f 7220 7969 656c 6469 6e67 2074  rator yielding t
-0001afe0: 7570 6c65 7320 7769 7468 2072 656d 6f74  uples with remot
-0001aff0: 6520 6368 616e 6765 7320 616e 6420 636f  e changes and co
-0001b000: 7272 6573 706f 6e64 696e 6720 6375 7273  rresponding curs
-0001b010: 6f72 2e0a 2020 2020 2020 2020 2222 220a  or..        """.
-0001b020: 2020 2020 2020 2020 6966 206c 6173 745f          if last_
-0001b030: 6375 7273 6f72 203d 3d20 2222 3a0a 2020  cursor == "":.  
-0001b040: 2020 2020 2020 2020 2020 2320 5765 2061            # We a
-0001b050: 7265 2073 7461 7274 696e 6720 6672 6f6d  re starting from
-0001b060: 2074 6865 2062 6567 696e 6e69 6e67 2c20   the beginning, 
-0001b070: 646f 2061 2066 756c 6c20 696e 6465 7869  do a full indexi
-0001b080: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
-0001b090: 6368 616e 6765 735f 6974 6572 203d 2073  changes_iter = s
-0001b0a0: 656c 662e 636c 6965 6e74 2e6c 6973 745f  elf.client.list_
-0001b0b0: 666f 6c64 6572 5f69 7465 7261 746f 7228  folder_iterator(
-0001b0c0: 222f 222c 2072 6563 7572 7369 7665 3d54  "/", recursive=T
-0001b0d0: 7275 6529 0a20 2020 2020 2020 2065 6c73  rue).        els
-0001b0e0: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0001b0f0: 2050 6963 6b20 7570 2077 6865 7265 2077   Pick up where w
-0001b100: 6520 6c65 6674 206f 6666 2e20 5468 6973  e left off. This
-0001b110: 206d 6179 2062 6520 616e 2069 6e74 6572   may be an inter
-0001b120: 7275 7074 6564 2069 6e64 6578 696e 6720  rupted indexing 
-0001b130: 2f0a 2020 2020 2020 2020 2020 2020 2320  /.            # 
-0001b140: 7061 6769 6e61 7469 6f6e 2074 6872 6f75  pagination throu
-0001b150: 6768 2063 6861 6e67 6573 206f 7220 6120  gh changes or a 
-0001b160: 636f 6d70 6c65 7465 6c79 206e 6577 2073  completely new s
-0001b170: 6574 206f 6620 6368 616e 6765 732e 0a20  et of changes.. 
-0001b180: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0001b190: 5f6c 6f67 6765 722e 6465 6275 6728 2246  _logger.debug("F
-0001b1a0: 6574 6368 696e 6720 7265 6d6f 7465 2063  etching remote c
-0001b1b0: 6861 6e67 6573 2073 696e 6365 2063 7572  hanges since cur
-0001b1c0: 736f 723a 2025 7322 2c20 6c61 7374 5f63  sor: %s", last_c
-0001b1d0: 7572 736f 7229 0a20 2020 2020 2020 2020  ursor).         
-0001b1e0: 2020 2063 6861 6e67 6573 5f69 7465 7220     changes_iter 
-0001b1f0: 3d20 7365 6c66 2e63 6c69 656e 742e 6c69  = self.client.li
-0001b200: 7374 5f72 656d 6f74 655f 6368 616e 6765  st_remote_change
-0001b210: 735f 6974 6572 6174 6f72 286c 6173 745f  s_iterator(last_
-0001b220: 6375 7273 6f72 290a 0a20 2020 2020 2020  cursor)..       
-0001b230: 2066 6f72 2063 6861 6e67 6573 2069 6e20   for changes in 
-0001b240: 6368 616e 6765 735f 6974 6572 3a0a 2020  changes_iter:.  
-0001b250: 2020 2020 2020 2020 2020 6368 616e 6765            change
-0001b260: 7320 3d20 7365 6c66 2e5f 636c 6561 6e5f  s = self._clean_
-0001b270: 7265 6d6f 7465 5f63 6861 6e67 6573 2863  remote_changes(c
-0001b280: 6861 6e67 6573 290a 2020 2020 2020 2020  hanges).        
-0001b290: 2020 2020 6368 616e 6765 732e 656e 7472      changes.entr
-0001b2a0: 6965 732e 736f 7274 286b 6579 3d6c 616d  ies.sort(key=lam
-0001b2b0: 6264 6120 783a 2078 2e70 6174 685f 6c6f  bda x: x.path_lo
-0001b2c0: 7765 722e 636f 756e 7428 222f 2229 290a  wer.count("/")).
-0001b2d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001b2e0: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
-0001b2f0: 2252 656d 6f74 6520 6368 616e 6765 733a  "Remote changes:
-0001b300: 5c6e 2573 222c 2070 665f 7265 7072 2863  \n%s", pf_repr(c
-0001b310: 6861 6e67 6573 2e65 6e74 7269 6573 2929  hanges.entries))
-0001b320: 0a0a 2020 2020 2020 2020 2020 2020 7379  ..            sy
-0001b330: 6e63 5f65 7665 6e74 7320 3d20 5b53 796e  nc_events = [Syn
-0001b340: 6345 7665 6e74 2e66 726f 6d5f 6d65 7461  cEvent.from_meta
-0001b350: 6461 7461 286d 642c 2073 656c 6629 2066  data(md, self) f
-0001b360: 6f72 206d 6420 696e 2063 6861 6e67 6573  or md in changes
-0001b370: 2e65 6e74 7269 6573 5d0a 0a20 2020 2020  .entries]..     
-0001b380: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
-0001b390: 6765 722e 6465 6275 6728 2243 6f6e 7665  ger.debug("Conve
-0001b3a0: 7274 6564 2072 656d 6f74 6520 6368 616e  rted remote chan
-0001b3b0: 6765 7320 746f 2053 796e 6345 7665 6e74  ges to SyncEvent
-0001b3c0: 7322 290a 0a20 2020 2020 2020 2020 2020  s")..           
-0001b3d0: 2079 6965 6c64 2073 796e 635f 6576 656e   yield sync_even
-0001b3e0: 7473 2c20 6368 616e 6765 732e 6375 7273  ts, changes.curs
-0001b3f0: 6f72 0a0a 2020 2020 6465 6620 6170 706c  or..    def appl
-0001b400: 795f 7265 6d6f 7465 5f63 6861 6e67 6573  y_remote_changes
-0001b410: 280a 2020 2020 2020 2020 7365 6c66 2c20  (.        self, 
-0001b420: 7379 6e63 5f65 7665 6e74 733a 2043 6f6c  sync_events: Col
-0001b430: 6c65 6374 696f 6e5b 5379 6e63 4576 656e  lection[SyncEven
-0001b440: 745d 0a20 2020 2029 202d 3e20 6c69 7374  t].    ) -> list
-0001b450: 5b53 796e 6345 7665 6e74 5d3a 0a20 2020  [SyncEvent]:.   
-0001b460: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0001b470: 2041 7070 6c69 6573 2072 656d 6f74 6520   Applies remote 
-0001b480: 6368 616e 6765 7320 746f 206c 6f63 616c  changes to local
-0001b490: 2066 6f6c 6465 722e 2043 616c 6c20 7468   folder. Call th
-0001b4a0: 6973 206f 6e20 7468 6520 7265 7375 6c74  is on the result
-0001b4b0: 206f 660a 2020 2020 2020 2020 3a6d 6574   of.        :met
-0001b4c0: 683a 606c 6973 745f 7265 6d6f 7465 5f63  h:`list_remote_c
-0001b4d0: 6861 6e67 6573 602e 2054 6865 2073 6176  hanges`. The sav
-0001b4e0: 6564 2063 7572 736f 7220 6973 2075 7064  ed cursor is upd
-0001b4f0: 6174 6564 2061 6674 6572 2061 2073 6574  ated after a set
-0001b500: 206f 6620 6368 616e 6765 730a 2020 2020   of changes.    
-0001b510: 2020 2020 6861 7320 6265 656e 2073 7563      has been suc
-0001b520: 6365 7373 6675 6c6c 7920 6170 706c 6965  cessfully applie
-0001b530: 642e 2045 6e74 7269 6573 2069 6e20 7468  d. Entries in th
-0001b540: 6520 6c6f 6361 6c20 696e 6465 7820 6172  e local index ar
-0001b550: 6520 6372 6561 7465 6420 6166 7465 720a  e created after.
-0001b560: 2020 2020 2020 2020 7375 6363 6573 7366          successf
-0001b570: 756c 2063 6f6d 706c 6574 696f 6e2e 0a0a  ul completion...
-0001b580: 2020 2020 2020 2020 3a70 6172 616d 2073          :param s
-0001b590: 796e 635f 6576 656e 7473 3a20 4c69 7374  ync_events: List
-0001b5a0: 206f 6620 7265 6d6f 7465 2063 6861 6e67   of remote chang
-0001b5b0: 6573 2e0a 2020 2020 2020 2020 3a72 6574  es..        :ret
-0001b5c0: 7572 6e73 3a20 4c69 7374 206f 6620 6368  urns: List of ch
-0001b5d0: 616e 6765 7320 7468 6174 2077 6572 6520  anges that were 
-0001b5e0: 6d61 6465 2074 6f20 6c6f 6361 6c20 6669  made to local fi
-0001b5f0: 6c65 7320 616e 6420 626f 6f6c 2069 6e64  les and bool ind
-0001b600: 6963 6174 696e 6720 6966 0a20 2020 2020  icating if.     
-0001b610: 2020 2020 2020 2061 6c6c 2064 6f77 6e6c         all downl
-0001b620: 6f61 6420 7379 6e63 7320 7765 7265 2073  oad syncs were s
-0001b630: 7563 6365 7373 6675 6c2e 0a20 2020 2020  uccessful..     
-0001b640: 2020 2022 2222 0a20 2020 2020 2020 2072     """.        r
-0001b650: 6573 756c 7473 3a20 6c69 7374 5b53 796e  esults: list[Syn
-0001b660: 6345 7665 6e74 5d20 3d20 5b5d 0a0a 2020  cEvent] = []..  
-0001b670: 2020 2020 2020 6966 206c 656e 2873 796e        if len(syn
-0001b680: 635f 6576 656e 7473 2920 3d3d 2030 3a0a  c_events) == 0:.
-0001b690: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001b6a0: 726e 2072 6573 756c 7473 0a0a 2020 2020  rn results..    
-0001b6b0: 2020 2020 2320 536f 7274 2063 6861 6e67      # Sort chang
-0001b6c0: 6573 2069 6e74 6f20 666f 6c64 6572 732c  es into folders,
-0001b6d0: 2066 696c 6573 2061 6e64 2064 656c 6574   files and delet
-0001b6e0: 6564 2069 7465 6d73 2e20 4469 7363 6172  ed items. Discar
-0001b6f0: 6420 6578 636c 7564 6564 2069 7465 6d73  d excluded items
-0001b700: 0a20 2020 2020 2020 2023 2061 6e64 2072  .        # and r
-0001b710: 656d 6f76 6520 616e 6420 6465 6c65 7465  emove and delete
-0001b720: 6420 6974 656d 7320 6672 6f6d 206f 7572  d items from our
-0001b730: 2065 7863 6c75 6465 6420 6c69 7374 2e0a   excluded list..
-0001b740: 2020 2020 2020 2020 2320 536f 7274 2061          # Sort a
-0001b750: 6363 6f72 6469 6e67 2074 6f20 7061 7468  ccording to path
-0001b760: 2068 6965 7261 7263 6879 3a0a 2020 2020   hierarchy:.    
-0001b770: 2020 2020 2320 2d20 446f 206e 6f74 2063      # - Do not c
-0001b780: 7265 6174 6520 7375 622d 666f 6c64 6572  reate sub-folder
-0001b790: 202f 2066 696c 6520 6265 666f 7265 2070   / file before p
-0001b7a0: 6172 656e 7420 6578 6973 7473 2e0a 2020  arent exists..  
-0001b7b0: 2020 2020 2020 2320 2d20 4465 6c65 7465        # - Delete
-0001b7c0: 2070 6172 656e 7473 2062 6566 6f72 6520   parents before 
-0001b7d0: 6465 6c65 7469 6e67 2063 6869 6c64 7265  deleting childre
-0001b7e0: 6e20 746f 2073 6176 6520 736f 6d65 2077  n to save some w
-0001b7f0: 6f72 6b2e 0a0a 2020 2020 2020 2020 6669  ork...        fi
-0001b800: 6c65 733a 206c 6973 745b 5379 6e63 4576  les: list[SyncEv
-0001b810: 656e 745d 203d 205b 5d0a 2020 2020 2020  ent] = [].      
-0001b820: 2020 666f 6c64 6572 733a 2064 6566 6175    folders: defau
-0001b830: 6c74 6469 6374 5b69 6e74 2c20 6c69 7374  ltdict[int, list
-0001b840: 5b53 796e 6345 7665 6e74 5d5d 203d 2064  [SyncEvent]] = d
-0001b850: 6566 6175 6c74 6469 6374 286c 6973 7429  efaultdict(list)
-0001b860: 0a20 2020 2020 2020 2064 656c 6574 6564  .        deleted
-0001b870: 3a20 6465 6661 756c 7464 6963 745b 696e  : defaultdict[in
-0001b880: 742c 206c 6973 745b 5379 6e63 4576 656e  t, list[SyncEven
-0001b890: 745d 5d20 3d20 6465 6661 756c 7464 6963  t]] = defaultdic
-0001b8a0: 7428 6c69 7374 290a 0a20 2020 2020 2020  t(list)..       
-0001b8b0: 206e 6577 5f65 7863 6c75 6465 6420 3d20   new_excluded = 
-0001b8c0: 7365 6c66 2e65 7863 6c75 6465 645f 6974  self.excluded_it
-0001b8d0: 656d 730a 0a20 2020 2020 2020 2066 6f72  ems..        for
-0001b8e0: 2065 7665 6e74 2069 6e20 7379 6e63 5f65   event in sync_e
-0001b8f0: 7665 6e74 733a 0a20 2020 2020 2020 2020  vents:.         
-0001b900: 2020 2069 735f 6578 636c 7564 6564 203d     is_excluded =
-0001b910: 2073 656c 662e 6973 5f65 7863 6c75 6465   self.is_exclude
-0001b920: 645f 6279 5f75 7365 7228 0a20 2020 2020  d_by_user(.     
-0001b930: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-0001b940: 2e64 6278 5f70 6174 685f 6c6f 7765 720a  .dbx_path_lower.
-0001b950: 2020 2020 2020 2020 2020 2020 2920 6f72              ) or
-0001b960: 2073 656c 662e 6973 5f65 7863 6c75 6465   self.is_exclude
-0001b970: 6428 6576 656e 742e 6462 785f 7061 7468  d(event.dbx_path
-0001b980: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-0001b990: 6620 6973 5f65 7863 6c75 6465 643a 0a20  f is_excluded:. 
-0001b9a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001b9b0: 6620 6576 656e 742e 6973 5f64 656c 6574  f event.is_delet
-0001b9c0: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
-0001b9d0: 2020 2020 2020 2020 2320 5265 6d6f 7665          # Remove
-0001b9e0: 2064 656c 6574 6564 2069 7465 6d20 616e   deleted item an
-0001b9f0: 6420 6974 7320 6368 696c 6472 656e 2066  d its children f
-0001ba00: 726f 6d20 7468 6520 6578 636c 7564 6564  rom the excluded
-0001ba10: 206c 6973 742e 0a20 2020 2020 2020 2020   list..         
-0001ba20: 2020 2020 2020 2020 2020 206e 6577 5f65             new_e
-0001ba30: 7863 6c75 6465 6420 3d20 5b0a 2020 2020  xcluded = [.    
-0001ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba50: 2020 2020 7061 7468 0a20 2020 2020 2020      path.       
-0001ba60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ba70: 2066 6f72 2070 6174 6820 696e 206e 6577   for path in new
-0001ba80: 5f65 7863 6c75 6465 640a 2020 2020 2020  _excluded.      
-0001ba90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001baa0: 2020 6966 206e 6f74 2069 735f 6571 7561    if not is_equa
-0001bab0: 6c5f 6f72 5f63 6869 6c64 2870 6174 682c  l_or_child(path,
-0001bac0: 2065 7665 6e74 2e64 6278 5f70 6174 685f   event.dbx_path_
-0001bad0: 6c6f 7765 7229 0a20 2020 2020 2020 2020  lower).         
-0001bae0: 2020 2020 2020 2020 2020 205d 0a0a 2020             ]..  
-0001baf0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001bb00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb10: 6c65 7665 6c20 3d20 6576 656e 742e 6462  level = event.db
-0001bb20: 785f 7061 7468 2e63 6f75 6e74 2822 2f22  x_path.count("/"
-0001bb30: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00012b80: 2044 6972 4465 6c65 7465 6445 7665 6e74   DirDeletedEvent
+00012b90: 2870 6174 6829 2c0a 2020 2020 2020 2020  (path),.        
+00012ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012bb0: 2020 2020 2020 2020 4669 6c65 4372 6561          FileCrea
+00012bc0: 7465 6445 7665 6e74 2870 6174 6829 2c0a  tedEvent(path),.
+00012bd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012be0: 2020 2020 2020 2020 2020 2020 5d0a 2020              ].  
+00012bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c00: 2020 2020 2020 656c 6966 2065 7665 6e74        elif event
+00012c10: 735b 2d31 5d2e 6973 5f64 6972 6563 746f  s[-1].is_directo
+00012c20: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00012c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c40: 2320 5479 7065 2063 6861 6e67 6520 6669  # Type change fi
+00012c50: 6c65 202d 3e20 666f 6c64 6572 2e0a 2020  le -> folder..  
+00012c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012c70: 2020 2020 2020 2020 2020 6576 656e 7473            events
+00012c80: 5f66 6f72 5f70 6174 685b 7061 7468 5d20  _for_path[path] 
+00012c90: 3d20 5b0a 2020 2020 2020 2020 2020 2020  = [.            
+00012ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012cb0: 2020 2020 4669 6c65 4465 6c65 7465 6445      FileDeletedE
+00012cc0: 7665 6e74 2870 6174 6829 2c0a 2020 2020  vent(path),.    
+00012cd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012ce0: 2020 2020 2020 2020 2020 2020 4469 7243              DirC
+00012cf0: 7265 6174 6564 4576 656e 7428 7061 7468  reatedEvent(path
+00012d00: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
+00012d10: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+00012d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012d30: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00012d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012d50: 2020 2023 2049 7465 6d20 7761 7320 6c69     # Item was li
+00012d60: 6b65 6c79 206f 6e6c 7920 7465 6d70 6f72  kely only tempor
+00012d70: 6172 792e 2057 6520 7374 696c 6c20 7472  ary. We still tr
+00012d80: 6967 6765 7220 6120 7265 7363 616e 206f  igger a rescan o
+00012d90: 660a 2020 2020 2020 2020 2020 2020 2020  f.              
+00012da0: 2020 2020 2020 2020 2020 2320 7468 6520            # the 
+00012db0: 7061 7468 2062 6563 6175 7365 2073 6f6d  path because som
+00012dc0: 6520 6174 6f6d 6963 206d 6f64 6966 6963  e atomic modific
+00012dd0: 6174 696f 6e73 206d 6179 2062 6520 7265  ations may be re
+00012de0: 706f 7274 6564 2061 730a 2020 2020 2020  ported as.      
+00012df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e00: 2020 2320 6f75 742d 6f66 2d6f 7264 6572    # out-of-order
+00012e10: 2063 7265 6174 6564 2061 6e64 2064 656c   created and del
+00012e20: 6574 6564 2065 7665 6e74 7320 6f6e 206d  eted events on m
+00012e30: 6163 4f53 2e0a 2020 2020 2020 2020 2020  acOS..          
+00012e40: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00012e50: 6c20 6576 656e 7473 5f66 6f72 5f70 6174  l events_for_pat
+00012e60: 685b 7061 7468 5d0a 2020 2020 2020 2020  h[path].        
+00012e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012e80: 7365 6c66 2e72 6573 6361 6e28 7061 7468  self.rescan(path
+00012e90: 290a 0a20 2020 2020 2020 2023 2052 6563  )..        # Rec
+00012ea0: 6f6d 6269 6e65 206d 6f76 6564 2065 7665  ombine moved eve
+00012eb0: 6e74 7320 6966 2077 6520 6861 7665 2072  nts if we have r
+00012ec0: 6574 6169 6e65 6420 626f 7468 2073 6964  etained both sid
+00012ed0: 6573 206f 6620 6576 656e 7420 6475 7269  es of event duri
+00012ee0: 6e67 2074 6865 0a20 2020 2020 2020 2023  ng the.        #
+00012ef0: 2061 626f 7665 2063 6f6e 736f 6c69 6461   above consolida
+00012f00: 7469 6f6e 2e0a 2020 2020 2020 2020 666f  tion..        fo
+00012f10: 7220 7372 635f 6576 656e 7420 696e 206d  r src_event in m
+00012f20: 6f76 6564 5f65 7665 6e74 735f 746f 5f72  oved_events_to_r
+00012f30: 6563 6f6d 6269 6e65 3a0a 2020 2020 2020  ecombine:.      
+00012f40: 2020 2020 2020 7372 635f 7061 7468 203d        src_path =
+00012f50: 2073 7263 5f65 7665 6e74 2e73 7263 5f70   src_event.src_p
+00012f60: 6174 680a 2020 2020 2020 2020 2020 2020  ath.            
+00012f70: 6465 7374 5f70 6174 6820 3d20 6d6f 7665  dest_path = move
+00012f80: 645f 6672 6f6d 5f74 6f5b 7372 635f 6576  d_from_to[src_ev
+00012f90: 656e 745d 2e73 7263 5f70 6174 680a 0a20  ent].src_path.. 
+00012fa0: 2020 2020 2020 2020 2020 206e 6577 5f65             new_e
+00012fb0: 7665 6e74 3a20 4469 724d 6f76 6564 4576  vent: DirMovedEv
+00012fc0: 656e 7420 7c20 4669 6c65 4d6f 7665 6445  ent | FileMovedE
+00012fd0: 7665 6e74 0a0a 2020 2020 2020 2020 2020  vent..          
+00012fe0: 2020 6966 2073 7263 5f65 7665 6e74 2e69    if src_event.i
+00012ff0: 735f 6469 7265 6374 6f72 793a 0a20 2020  s_directory:.   
+00013000: 2020 2020 2020 2020 2020 2020 206e 6577               new
+00013010: 5f65 7665 6e74 203d 2044 6972 4d6f 7665  _event = DirMove
+00013020: 6445 7665 6e74 2873 7263 5f70 6174 682c  dEvent(src_path,
+00013030: 2064 6573 745f 7061 7468 290a 2020 2020   dest_path).    
+00013040: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00013050: 2020 2020 2020 2020 2020 2020 2020 6e65                ne
+00013060: 775f 6576 656e 7420 3d20 4669 6c65 4d6f  w_event = FileMo
+00013070: 7665 6445 7665 6e74 2873 7263 5f70 6174  vedEvent(src_pat
+00013080: 682c 2064 6573 745f 7061 7468 290a 0a20  h, dest_path).. 
+00013090: 2020 2020 2020 2020 2020 2023 204f 6e6c             # Onl
+000130a0: 7920 7265 636f 6d62 696e 6520 6576 656e  y recombine even
+000130b0: 7473 2069 6620 6e65 6974 6865 7220 6861  ts if neither ha
+000130c0: 7320 616e 2065 7863 6c75 6465 6420 7061  s an excluded pa
+000130d0: 7468 3a20 5765 2077 616e 7420 746f 0a20  th: We want to. 
+000130e0: 2020 2020 2020 2020 2020 2023 2074 7265             # tre
+000130f0: 6174 2072 656e 616d 696e 6720 6672 6f6d  at renaming from
+00013100: 202f 2074 6f20 616e 2065 7863 6c75 6465   / to an exclude
+00013110: 6420 7061 7468 2061 7320 6120 6372 6561  d path as a crea
+00013120: 7469 6f6e 202f 2064 656c 6574 696f 6e2c  tion / deletion,
+00013130: 0a20 2020 2020 2020 2020 2020 2023 2072  .            # r
+00013140: 6573 7065 6374 6976 656c 792e 0a20 2020  espectively..   
+00013150: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
+00013160: 7365 6c66 2e5f 7368 6f75 6c64 5f73 706c  self._should_spl
+00013170: 6974 5f65 7863 6c75 6465 6428 6e65 775f  it_excluded(new_
+00013180: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
+00013190: 2020 2020 2020 2020 6465 6c20 6576 656e          del even
+000131a0: 7473 5f66 6f72 5f70 6174 685b 7372 635f  ts_for_path[src_
+000131b0: 7061 7468 5d0a 2020 2020 2020 2020 2020  path].          
+000131c0: 2020 2020 2020 6576 656e 7473 5f66 6f72        events_for
+000131d0: 5f70 6174 685b 6465 7374 5f70 6174 685d  _path[dest_path]
+000131e0: 203d 205b 6e65 775f 6576 656e 745d 0a0a   = [new_event]..
+000131f0: 2020 2020 2020 2020 2320 4174 2074 6869          # At thi
+00013200: 7320 706f 696e 742c 2060 6576 656e 7473  s point, `events
+00013210: 5f66 6f72 5f70 6174 6860 2077 696c 6c20  _for_path` will 
+00013220: 636f 6e74 6169 6e20 6120 7369 6e67 6c65  contain a single
+00013230: 2065 7665 6e74 2070 6572 2070 6174 6820   event per path 
+00013240: 6f72 0a20 2020 2020 2020 2023 2065 7861  or.        # exa
+00013250: 6374 6c79 2074 776f 2065 7665 6e74 7320  ctly two events 
+00013260: 2864 656c 6574 6564 2061 6e64 2063 7265  (deleted and cre
+00013270: 6174 6564 2920 696e 2063 6173 6520 6f66  ated) in case of
+00013280: 2061 2074 7970 6520 6368 616e 6765 2e0a   a type change..
+00013290: 0a20 2020 2020 2020 2023 2043 4f4d 4249  .        # COMBI
+000132a0: 4e45 204d 4f56 4544 2041 4e44 2044 454c  NE MOVED AND DEL
+000132b0: 4554 4544 2045 5645 4e54 5320 4f46 2046  ETED EVENTS OF F
+000132c0: 4f4c 4445 5253 2041 4e44 2054 4845 4952  OLDERS AND THEIR
+000132d0: 2043 4849 4c44 5245 4e20 494e 544f 204f   CHILDREN INTO O
+000132e0: 4e45 2045 5645 4e54 0a0a 2020 2020 2020  NE EVENT..      
+000132f0: 2020 2320 4176 6f69 6420 6e65 7374 6564    # Avoid nested
+00013300: 2069 7465 7261 7469 6f6e 7320 6f76 6572   iterations over
+00013310: 2061 6c6c 2065 7665 6e74 7320 6865 7265   all events here
+00013320: 2c20 7468 6579 2061 7265 206f 6e20 7468  , they are on th
+00013330: 6520 6f72 6465 7220 6f66 204f 286e 5e32  e order of O(n^2
+00013340: 290a 2020 2020 2020 2020 2320 7768 6963  ).        # whic
+00013350: 6820 6265 636f 6d65 7320 636f 7374 6c79  h becomes costly
+00013360: 2077 6865 6e20 7468 6520 7573 6572 206d   when the user m
+00013370: 6f76 6573 206f 7220 6465 6c65 7465 7320  oves or deletes 
+00013380: 666f 6c64 6572 2077 6974 6820 6120 6c61  folder with a la
+00013390: 7267 6520 6e75 6d62 6572 0a20 2020 2020  rge number.     
+000133a0: 2020 2023 206f 6620 6368 696c 6472 656e     # of children
+000133b0: 2e20 4265 6e63 686d 6172 6b3a 2061 696d  . Benchmark: aim
+000133c0: 2074 6f20 7374 6179 2062 656c 6f77 2031   to stay below 1
+000133d0: 2073 6563 2066 6f72 2032 302c 3030 3020   sec for 20,000 
+000133e0: 6e65 7374 6564 2065 7665 6e74 7320 6f6e  nested events on
+000133f0: 0a20 2020 2020 2020 2023 2072 6570 7265  .        # repre
+00013400: 7365 6e74 6174 6976 6520 6c61 7074 6f70  sentative laptop
+00013410: 2050 4373 2e0a 0a20 2020 2020 2020 2023   PCs...        #
+00013420: 2030 2920 436f 6c6c 6563 7420 616c 6c20   0) Collect all 
+00013430: 6d6f 7665 6420 616e 6420 6465 6c65 7465  moved and delete
+00013440: 6420 6576 656e 7473 2069 6e20 7365 7473  d events in sets
+00013450: 2e0a 0a20 2020 2020 2020 2064 6972 5f6d  ...        dir_m
+00013460: 6f76 6564 5f70 6174 6873 3a20 7365 745b  oved_paths: set[
+00013470: 7475 706c 655b 7374 722c 2073 7472 5d5d  tuple[str, str]]
+00013480: 203d 2073 6574 2829 0a20 2020 2020 2020   = set().       
+00013490: 2064 6972 5f64 656c 6574 6564 5f70 6174   dir_deleted_pat
+000134a0: 6873 3a20 7365 745b 7374 725d 203d 2073  hs: set[str] = s
+000134b0: 6574 2829 0a0a 2020 2020 2020 2020 666f  et()..        fo
+000134c0: 7220 6576 656e 7473 2069 6e20 6576 656e  r events in even
+000134d0: 7473 5f66 6f72 5f70 6174 682e 7661 6c75  ts_for_path.valu
+000134e0: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+000134f0: 2020 6576 656e 7420 3d20 6576 656e 7473    event = events
+00013500: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00013510: 6966 2069 7369 6e73 7461 6e63 6528 6576  if isinstance(ev
+00013520: 656e 742c 2044 6972 4d6f 7665 6445 7665  ent, DirMovedEve
+00013530: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
+00013540: 2020 2020 2064 6972 5f6d 6f76 6564 5f70       dir_moved_p
+00013550: 6174 6873 2e61 6464 2828 6576 656e 742e  aths.add((event.
+00013560: 7372 635f 7061 7468 2c20 6576 656e 742e  src_path, event.
+00013570: 6465 7374 5f70 6174 6829 290a 2020 2020  dest_path)).    
+00013580: 2020 2020 2020 2020 656c 6966 2069 7369          elif isi
+00013590: 6e73 7461 6e63 6528 6576 656e 742c 2044  nstance(event, D
+000135a0: 6972 4465 6c65 7465 6445 7665 6e74 293a  irDeletedEvent):
+000135b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000135c0: 2064 6972 5f64 656c 6574 6564 5f70 6174   dir_deleted_pat
+000135d0: 6873 2e61 6464 2865 7665 6e74 2e73 7263  hs.add(event.src
+000135e0: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+000135f0: 2320 3129 2043 6f6d 6269 6e65 206d 6f76  # 1) Combine mov
+00013600: 6564 2065 7665 6e74 7320 6f66 2066 6f6c  ed events of fol
+00013610: 6465 7273 2061 6e64 2074 6865 6972 2063  ders and their c
+00013620: 6869 6c64 7265 6e20 696e 746f 206f 6e65  hildren into one
+00013630: 2065 7665 6e74 2e0a 0a20 2020 2020 2020   event...       
+00013640: 2069 6620 6c65 6e28 6469 725f 6d6f 7665   if len(dir_move
+00013650: 645f 7061 7468 7329 203e 2030 3a0a 2020  d_paths) > 0:.  
+00013660: 2020 2020 2020 2020 2020 6368 696c 645f            child_
+00013670: 6d6f 7665 645f 6473 745f 7061 7468 733a  moved_dst_paths:
+00013680: 2073 6574 5b73 7472 5d20 3d20 7365 7428   set[str] = set(
+00013690: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+000136a0: 2046 6f72 2065 6163 6820 6576 656e 742c   For each event,
+000136b0: 2063 6865 636b 2069 6620 6974 2069 7320   check if it is 
+000136c0: 6120 6368 696c 6420 6f66 2061 206d 6f76  a child of a mov
+000136d0: 6564 2065 7665 6e74 2064 6973 6361 7264  ed event discard
+000136e0: 2069 7420 6966 2079 6573 2e0a 2020 2020   it if yes..    
+000136f0: 2020 2020 2020 2020 666f 7220 6576 656e          for even
+00013700: 7473 2069 6e20 6576 656e 7473 5f66 6f72  ts in events_for
+00013710: 5f70 6174 682e 7661 6c75 6573 2829 3a0a  _path.values():.
+00013720: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013730: 6576 656e 7420 3d20 6576 656e 7473 5b30  event = events[0
+00013740: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00013750: 2020 6966 2069 735f 6d6f 7665 6428 6576    if is_moved(ev
+00013760: 656e 7429 3a0a 2020 2020 2020 2020 2020  ent):.          
+00013770: 2020 2020 2020 2020 2020 6469 726e 616d            dirnam
+00013780: 6573 203d 2028 0a20 2020 2020 2020 2020  es = (.         
+00013790: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000137a0: 7370 2e64 6972 6e61 6d65 2865 7665 6e74  sp.dirname(event
+000137b0: 2e73 7263 5f70 6174 6829 2c0a 2020 2020  .src_path),.    
+000137c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000137d0: 2020 2020 6f73 702e 6469 726e 616d 6528      osp.dirname(
+000137e0: 6576 656e 742e 6465 7374 5f70 6174 6829  event.dest_path)
+000137f0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00013800: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00013810: 2020 2020 2020 2020 2020 2020 6966 2064              if d
+00013820: 6972 6e61 6d65 7320 696e 2064 6972 5f6d  irnames in dir_m
+00013830: 6f76 6564 5f70 6174 6873 3a0a 2020 2020  oved_paths:.    
+00013840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013850: 2020 2020 6368 696c 645f 6d6f 7665 645f      child_moved_
+00013860: 6473 745f 7061 7468 732e 6164 6428 6576  dst_paths.add(ev
+00013870: 656e 742e 6465 7374 5f70 6174 6829 0a0a  ent.dest_path)..
+00013880: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00013890: 7061 7468 2069 6e20 6368 696c 645f 6d6f  path in child_mo
+000138a0: 7665 645f 6473 745f 7061 7468 733a 0a20  ved_dst_paths:. 
+000138b0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+000138c0: 656c 2065 7665 6e74 735f 666f 725f 7061  el events_for_pa
+000138d0: 7468 5b70 6174 685d 0a0a 2020 2020 2020  th[path]..      
+000138e0: 2020 2320 3229 2043 6f6d 6269 6e65 2064    # 2) Combine d
+000138f0: 656c 6574 6564 2065 7665 6e74 7320 6f66  eleted events of
+00013900: 2066 6f6c 6465 7273 2061 6e64 2074 6865   folders and the
+00013910: 6972 2063 6869 6c64 7265 6e20 746f 206f  ir children to o
+00013920: 6e65 2065 7665 6e74 2e0a 0a20 2020 2020  ne event...     
+00013930: 2020 2069 6620 6c65 6e28 6469 725f 6465     if len(dir_de
+00013940: 6c65 7465 645f 7061 7468 7329 203e 2030  leted_paths) > 0
+00013950: 3a0a 2020 2020 2020 2020 2020 2020 6368  :.            ch
+00013960: 696c 645f 6465 6c65 7465 645f 7061 7468  ild_deleted_path
+00013970: 733a 2073 6574 5b73 7472 5d20 3d20 7365  s: set[str] = se
+00013980: 7428 290a 0a20 2020 2020 2020 2020 2020  t()..           
+00013990: 2066 6f72 2065 7665 6e74 7320 696e 2065   for events in e
+000139a0: 7665 6e74 735f 666f 725f 7061 7468 2e76  vents_for_path.v
+000139b0: 616c 7565 7328 293a 0a20 2020 2020 2020  alues():.       
+000139c0: 2020 2020 2020 2020 2065 7665 6e74 203d           event =
+000139d0: 2065 7665 6e74 735b 305d 0a20 2020 2020   events[0].     
+000139e0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
+000139f0: 5f64 656c 6574 6564 2865 7665 6e74 293a  _deleted(event):
+00013a00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013a10: 2020 2020 2064 6972 6e61 6d65 203d 206f       dirname = o
+00013a20: 7370 2e64 6972 6e61 6d65 2865 7665 6e74  sp.dirname(event
+00013a30: 2e73 7263 5f70 6174 6829 0a20 2020 2020  .src_path).     
+00013a40: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00013a50: 6620 6469 726e 616d 6520 696e 2064 6972  f dirname in dir
+00013a60: 5f64 656c 6574 6564 5f70 6174 6873 3a0a  _deleted_paths:.
+00013a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00013a80: 2020 2020 2020 2020 6368 696c 645f 6465          child_de
+00013a90: 6c65 7465 645f 7061 7468 732e 6164 6428  leted_paths.add(
+00013aa0: 6576 656e 742e 7372 635f 7061 7468 290a  event.src_path).
+00013ab0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00013ac0: 2070 6174 6820 696e 2063 6869 6c64 5f64   path in child_d
+00013ad0: 656c 6574 6564 5f70 6174 6873 3a0a 2020  eleted_paths:.  
+00013ae0: 2020 2020 2020 2020 2020 2020 2020 6465                de
+00013af0: 6c20 6576 656e 7473 5f66 6f72 5f70 6174  l events_for_pat
+00013b00: 685b 7061 7468 5d0a 0a20 2020 2020 2020  h[path]..       
+00013b10: 2023 2050 5245 5041 5245 2052 4554 5552   # PREPARE RETUR
+00013b20: 4e20 5641 4c55 4520 414e 4420 4652 4545  N VALUE AND FREE
+00013b30: 204d 454d 4f52 590a 0a20 2020 2020 2020   MEMORY..       
+00013b40: 2063 6c65 616e 6564 5f65 7665 6e74 7320   cleaned_events 
+00013b50: 3d20 5b5d 0a0a 2020 2020 2020 2020 666f  = []..        fo
+00013b60: 7220 6576 656e 7473 2069 6e20 6576 656e  r events in even
+00013b70: 7473 5f66 6f72 5f70 6174 682e 7661 6c75  ts_for_path.valu
+00013b80: 6573 2829 3a0a 2020 2020 2020 2020 2020  es():.          
+00013b90: 2020 636c 6561 6e65 645f 6576 656e 7473    cleaned_events
+00013ba0: 2e65 7874 656e 6428 6576 656e 7473 290a  .extend(events).
+00013bb0: 0a20 2020 2020 2020 2023 2046 7265 6520  .        # Free 
+00013bc0: 6d65 6d6f 7279 2065 6172 6c79 2074 6f20  memory early to 
+00013bd0: 7072 6576 656e 7420 6672 6167 6d65 6e74  prevent fragment
+00013be0: 6174 696f 6e2e 0a20 2020 2020 2020 2064  ation..        d
+00013bf0: 656c 2065 7665 6e74 735f 666f 725f 7061  el events_for_pa
+00013c00: 7468 0a20 2020 2020 2020 2064 656c 206d  th.        del m
+00013c10: 6f76 6564 5f66 726f 6d5f 746f 0a20 2020  oved_from_to.   
+00013c20: 2020 2020 2064 656c 206d 6f76 6564 5f65       del moved_e
+00013c30: 7665 6e74 735f 746f 5f72 6563 6f6d 6269  vents_to_recombi
+00013c40: 6e65 0a20 2020 2020 2020 2064 656c 2064  ne.        del d
+00013c50: 6972 5f6d 6f76 6564 5f70 6174 6873 0a20  ir_moved_paths. 
+00013c60: 2020 2020 2020 2064 656c 2064 6972 5f64         del dir_d
+00013c70: 656c 6574 6564 5f70 6174 6873 0a20 2020  eleted_paths.   
+00013c80: 2020 2020 2067 632e 636f 6c6c 6563 7428       gc.collect(
+00013c90: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
+00013ca0: 6e20 636c 6561 6e65 645f 6576 656e 7473  n cleaned_events
+00013cb0: 0a0a 2020 2020 6465 6620 5f73 686f 756c  ..    def _shoul
+00013cc0: 645f 7370 6c69 745f 6578 636c 7564 6564  d_split_excluded
+00013cd0: 2873 656c 662c 2065 7665 6e74 3a20 4669  (self, event: Fi
+00013ce0: 6c65 4d6f 7665 6445 7665 6e74 207c 2044  leMovedEvent | D
+00013cf0: 6972 4d6f 7665 6445 7665 6e74 2920 2d3e  irMovedEvent) ->
+00013d00: 2062 6f6f 6c3a 0a20 2020 2020 2020 2064   bool:.        d
+00013d10: 6278 5f73 7263 5f70 6174 6820 3d20 7365  bx_src_path = se
+00013d20: 6c66 2e74 6f5f 6462 785f 7061 7468 2865  lf.to_dbx_path(e
+00013d30: 7665 6e74 2e73 7263 5f70 6174 6829 0a20  vent.src_path). 
+00013d40: 2020 2020 2020 2064 6278 5f64 6573 745f         dbx_dest_
+00013d50: 7061 7468 203d 2073 656c 662e 746f 5f64  path = self.to_d
+00013d60: 6278 5f70 6174 6828 6576 656e 742e 6465  bx_path(event.de
+00013d70: 7374 5f70 6174 6829 0a0a 2020 2020 2020  st_path)..      
+00013d80: 2020 6966 2028 0a20 2020 2020 2020 2020    if (.         
+00013d90: 2020 2073 656c 662e 6973 5f65 7863 6c75     self.is_exclu
+00013da0: 6465 6428 6576 656e 742e 7372 635f 7061  ded(event.src_pa
+00013db0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+00013dc0: 6f72 2073 656c 662e 6973 5f65 7863 6c75  or self.is_exclu
+00013dd0: 6465 6428 6576 656e 742e 6465 7374 5f70  ded(event.dest_p
+00013de0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+00013df0: 206f 7220 7365 6c66 2e69 735f 6578 636c   or self.is_excl
+00013e00: 7564 6564 5f62 795f 7573 6572 286e 6f72  uded_by_user(nor
+00013e10: 6d61 6c69 7a65 2864 6278 5f73 7263 5f70  malize(dbx_src_p
+00013e20: 6174 6829 290a 2020 2020 2020 2020 2020  ath)).          
+00013e30: 2020 6f72 2073 656c 662e 6973 5f65 7863    or self.is_exc
+00013e40: 6c75 6465 645f 6279 5f75 7365 7228 6e6f  luded_by_user(no
+00013e50: 726d 616c 697a 6528 6462 785f 6465 7374  rmalize(dbx_dest
+00013e60: 5f70 6174 6829 290a 2020 2020 2020 2020  _path)).        
+00013e70: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00013e80: 6574 7572 6e20 5472 7565 0a0a 2020 2020  eturn True..    
+00013e90: 2020 2020 656c 6966 206c 656e 2873 656c      elif len(sel
+00013ea0: 662e 6d69 676e 6f72 655f 7275 6c65 732e  f.mignore_rules.
+00013eb0: 7061 7474 6572 6e73 2920 3d3d 2030 3a0a  patterns) == 0:.
+00013ec0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00013ed0: 726e 2046 616c 7365 0a20 2020 2020 2020  rn False.       
+00013ee0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00013ef0: 2020 2073 7263 5f69 735f 6d69 676e 6f72     src_is_mignor
+00013f00: 6520 3d20 7365 6c66 2e5f 6973 5f6d 6967  e = self._is_mig
+00013f10: 6e6f 7265 5f70 6174 6828 6462 785f 7372  nore_path(dbx_sr
+00013f20: 635f 7061 7468 2c20 6576 656e 742e 6973  c_path, event.is
+00013f30: 5f64 6972 6563 746f 7279 290a 2020 2020  _directory).    
+00013f40: 2020 2020 2020 2020 6465 7374 5f69 735f          dest_is_
+00013f50: 6d69 676e 6f72 6520 3d20 7365 6c66 2e5f  mignore = self._
+00013f60: 6973 5f6d 6967 6e6f 7265 5f70 6174 6828  is_mignore_path(
+00013f70: 6462 785f 6465 7374 5f70 6174 682c 2065  dbx_dest_path, e
+00013f80: 7665 6e74 2e69 735f 6469 7265 6374 6f72  vent.is_director
+00013f90: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
+00013fa0: 7265 7475 726e 2073 7263 5f69 735f 6d69  return src_is_mi
+00013fb0: 676e 6f72 6520 6f72 2064 6573 745f 6973  gnore or dest_is
+00013fc0: 5f6d 6967 6e6f 7265 0a0a 2020 2020 6465  _mignore..    de
+00013fd0: 6620 5f68 616e 646c 655f 6e6f 726d 616c  f _handle_normal
+00013fe0: 697a 6174 696f 6e5f 636f 6e66 6c69 6374  ization_conflict
+00013ff0: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
+00014000: 6e63 4576 656e 7429 202d 3e20 626f 6f6c  ncEvent) -> bool
+00014010: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00014020: 2020 2020 2020 4368 6563 6b73 2066 6f72        Checks for
+00014030: 206f 7468 6572 2069 7465 6d73 2069 6e20   other items in 
+00014040: 7468 6520 7361 6d65 2064 6972 6563 746f  the same directo
+00014050: 7279 2077 6974 6820 6120 6469 6666 6572  ry with a differ
+00014060: 656e 7420 6e61 6d65 2062 7574 2074 6865  ent name but the
+00014070: 2073 616d 650a 2020 2020 2020 2020 6e6f   same.        no
+00014080: 726d 616c 697a 6174 696f 6e2e 0a0a 2020  rmalization...  
+00014090: 2020 2020 2020 3a70 6172 616d 2065 7665        :param eve
+000140a0: 6e74 3a20 5379 6e63 4576 656e 7420 666f  nt: SyncEvent fo
+000140b0: 7220 6c6f 6361 6c20 6372 6561 7465 6420  r local created 
+000140c0: 6f72 206d 6f76 6564 2065 7665 6e74 2e0a  or moved event..
+000140d0: 2020 2020 2020 2020 3a72 6574 7572 6e73          :returns
+000140e0: 3a20 5768 6574 6865 7220 6120 6361 7365  : Whether a case
+000140f0: 2063 6f6e 666c 6963 7420 7761 7320 6465   conflict was de
+00014100: 7465 6374 6564 2061 6e64 2068 616e 646c  tected and handl
+00014110: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
+00014120: 2020 2020 2020 2020 6966 206e 6f74 2028          if not (
+00014130: 6576 656e 742e 6973 5f61 6464 6564 206f  event.is_added o
+00014140: 7220 6576 656e 742e 6973 5f6d 6f76 6564  r event.is_moved
+00014150: 293a 0a20 2020 2020 2020 2020 2020 2072  ):.            r
+00014160: 6574 7572 6e20 4661 6c73 650a 0a20 2020  eturn False..   
+00014170: 2020 2020 2064 6972 6e61 6d65 2c20 6261       dirname, ba
+00014180: 7365 6e61 6d65 203d 206f 7370 2e73 706c  sename = osp.spl
+00014190: 6974 2865 7665 6e74 2e6c 6f63 616c 5f70  it(event.local_p
+000141a0: 6174 6829 0a20 2020 2020 2020 2065 7175  ath).        equ
+000141b0: 6976 616c 656e 745f 7061 7468 7320 3d20  ivalent_paths = 
+000141c0: 6765 745f 6578 6973 7469 6e67 5f65 7175  get_existing_equ
+000141d0: 6976 616c 656e 745f 7061 7468 7328 6261  ivalent_paths(ba
+000141e0: 7365 6e61 6d65 2c20 726f 6f74 3d64 6972  sename, root=dir
+000141f0: 6e61 6d65 290a 0a20 2020 2020 2020 2069  name)..        i
+00014200: 6620 6c65 6e28 6571 7569 7661 6c65 6e74  f len(equivalent
+00014210: 5f70 6174 6873 2920 3e20 313a 0a20 2020  _paths) > 1:.   
+00014220: 2020 2020 2020 2020 2023 2057 6520 6861           # We ha
+00014230: 7665 2064 6966 6665 7265 6e74 2066 696c  ve different fil
+00014240: 6520 6e61 6d65 7320 7468 6174 2077 6f75  e names that wou
+00014250: 6c64 206d 6170 2074 6f20 7468 6520 7361  ld map to the sa
+00014260: 6d65 206e 6f72 6d61 6c69 7a65 6420 7061  me normalized pa
+00014270: 7468 210a 0a20 2020 2020 2020 2020 2020  th!..           
+00014280: 2063 6f6e 666c 6963 745f 7061 7468 203d   conflict_path =
+00014290: 206e 6578 7428 7020 666f 7220 7020 696e   next(p for p in
+000142a0: 2065 7175 6976 616c 656e 745f 7061 7468   equivalent_path
+000142b0: 7320 6966 2070 2021 3d20 6576 656e 742e  s if p != event.
+000142c0: 6c6f 6361 6c5f 7061 7468 290a 0a20 2020  local_path)..   
+000142d0: 2020 2020 2020 2020 2023 2043 6865 636b           # Check
+000142e0: 2069 6620 7765 2068 6176 6520 6120 6361   if we have a ca
+000142f0: 7365 2063 6f6e 666c 6963 7420 6f72 2061  se conflict or a
+00014300: 2075 6e69 636f 6465 2063 6f6e 666c 6963   unicode conflic
+00014310: 742e 0a0a 2020 2020 2020 2020 2020 2020  t...            
+00014320: 6966 206e 6f72 6d61 6c69 7a65 5f63 6173  if normalize_cas
+00014330: 6528 6576 656e 742e 6c6f 6361 6c5f 7061  e(event.local_pa
+00014340: 7468 2920 3d3d 206e 6f72 6d61 6c69 7a65  th) == normalize
+00014350: 5f63 6173 6528 636f 6e66 6c69 6374 5f70  _case(conflict_p
+00014360: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
+00014370: 2020 2020 2020 7375 6666 6978 203d 2022        suffix = "
+00014380: 6361 7365 2063 6f6e 666c 6963 7422 0a20  case conflict". 
+00014390: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+000143a0: 6e6f 726d 616c 697a 655f 756e 6963 6f64  normalize_unicod
+000143b0: 6528 6576 656e 742e 6c6f 6361 6c5f 7061  e(event.local_pa
+000143c0: 7468 2920 3d3d 206e 6f72 6d61 6c69 7a65  th) == normalize
+000143d0: 5f63 6173 6528 636f 6e66 6c69 6374 5f70  _case(conflict_p
+000143e0: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
+000143f0: 2020 2020 2020 7375 6666 6978 203d 2022        suffix = "
+00014400: 756e 6963 6f64 6520 636f 6e66 6c69 6374  unicode conflict
+00014410: 220a 2020 2020 2020 2020 2020 2020 656c  ".            el
+00014420: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00014430: 2020 2020 7375 6666 6978 203d 2022 6e6f      suffix = "no
+00014440: 726d 616c 697a 6174 696f 6e20 636f 6e66  rmalization conf
+00014450: 6c69 6374 220a 0a20 2020 2020 2020 2020  lict"..         
+00014460: 2020 206c 6f63 616c 5f70 6174 685f 6363     local_path_cc
+00014470: 203d 2067 656e 6572 6174 655f 6363 5f6e   = generate_cc_n
+00014480: 616d 6528 0a20 2020 2020 2020 2020 2020  ame(.           
+00014490: 2020 2020 2065 7665 6e74 2e6c 6f63 616c       event.local
+000144a0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
+000144b0: 2020 2020 2020 2073 7566 6669 783d 7375         suffix=su
+000144c0: 6666 6978 2c0a 2020 2020 2020 2020 2020  ffix,.          
+000144d0: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+000144e0: 2065 7665 6e74 5f63 6c73 203d 2044 6972   event_cls = Dir
+000144f0: 4d6f 7665 6445 7665 6e74 2069 6620 6973  MovedEvent if is
+00014500: 6469 7228 6576 656e 742e 6c6f 6361 6c5f  dir(event.local_
+00014510: 7061 7468 2920 656c 7365 2046 696c 654d  path) else FileM
+00014520: 6f76 6564 4576 656e 740a 2020 2020 2020  ovedEvent.      
+00014530: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00014540: 6673 5f65 7665 6e74 732e 6967 6e6f 7265  fs_events.ignore
+00014550: 2865 7665 6e74 5f63 6c73 2865 7665 6e74  (event_cls(event
+00014560: 2e6c 6f63 616c 5f70 6174 682c 206c 6f63  .local_path, loc
+00014570: 616c 5f70 6174 685f 6363 2929 3a0a 2020  al_path_cc)):.  
+00014580: 2020 2020 2020 2020 2020 2020 2020 7769                wi
+00014590: 7468 2063 6f6e 7665 7274 5f61 7069 5f65  th convert_api_e
+000145a0: 7272 6f72 7328 293a 0a20 2020 2020 2020  rrors():.       
+000145b0: 2020 2020 2020 2020 2020 2020 206d 6f76               mov
+000145c0: 6528 6576 656e 742e 6c6f 6361 6c5f 7061  e(event.local_pa
+000145d0: 7468 2c20 6c6f 6361 6c5f 7061 7468 5f63  th, local_path_c
+000145e0: 632c 2072 6169 7365 5f65 7272 6f72 3d54  c, raise_error=T
+000145f0: 7275 6529 0a0a 2020 2020 2020 2020 2020  rue)..          
+00014600: 2020 2020 2020 7365 6c66 2e72 6573 6361        self.resca
+00014610: 6e28 6c6f 6361 6c5f 7061 7468 5f63 6329  n(local_path_cc)
+00014620: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+00014630: 6c66 2e5f 6c6f 6767 6572 2e69 6e66 6f28  lf._logger.info(
+00014640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014650: 2027 4e6f 726d 616c 697a 6174 696f 6e20   'Normalization 
+00014660: 636f 6e66 6c69 6374 3a20 7265 6e61 6d65  conflict: rename
+00014670: 6420 2225 7322 2074 6f20 2225 7322 272c  d "%s" to "%s"',
+00014680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00014690: 2065 7665 6e74 2e6c 6f63 616c 5f70 6174   event.local_pat
+000146a0: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+000146b0: 2020 206c 6f63 616c 5f70 6174 685f 6363     local_path_cc
+000146c0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+000146d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000146e0: 7572 6e20 5472 7565 0a20 2020 2020 2020  urn True.       
+000146f0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014700: 2020 2072 6574 7572 6e20 4661 6c73 650a     return False.
+00014710: 0a20 2020 2064 6566 205f 6861 6e64 6c65  .    def _handle
+00014720: 5f73 656c 6563 7469 7665 5f73 796e 635f  _selective_sync_
+00014730: 636f 6e66 6c69 6374 2873 656c 662c 2065  conflict(self, e
+00014740: 7665 6e74 3a20 5379 6e63 4576 656e 7429  vent: SyncEvent)
+00014750: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+00014760: 2020 2222 220a 2020 2020 2020 2020 4368    """.        Ch
+00014770: 6563 6b73 2066 6f72 2069 7465 6d73 2069  ecks for items i
+00014780: 6e20 7468 6520 6c6f 6361 6c20 6469 7265  n the local dire
+00014790: 6374 6f72 7920 7769 7468 2073 616d 6520  ctory with same 
+000147a0: 7061 7468 2061 7320 616e 2069 7465 6d20  path as an item 
+000147b0: 7768 6963 6820 6973 0a20 2020 2020 2020  which is.       
+000147c0: 2065 7863 6c75 6465 6420 6279 2073 656c   excluded by sel
+000147d0: 6563 7469 7665 2073 796e 632e 2052 656e  ective sync. Ren
+000147e0: 616d 6573 2069 7465 6d73 2069 6620 6e65  ames items if ne
+000147f0: 6365 7373 6172 792e 0a0a 2020 2020 2020  cessary...      
+00014800: 2020 3a70 6172 616d 2065 7665 6e74 3a20    :param event: 
+00014810: 5379 6e63 4576 656e 7420 666f 7220 6c6f  SyncEvent for lo
+00014820: 6361 6c20 6372 6561 7465 6420 6f72 206d  cal created or m
+00014830: 6f76 6564 2065 7665 6e74 2e0a 2020 2020  oved event..    
+00014840: 2020 2020 3a72 6574 7572 6e73 3a20 5768      :returns: Wh
+00014850: 6574 6865 7220 6120 7365 6c65 6374 6976  ether a selectiv
+00014860: 6520 7379 6e63 2063 6f6e 666c 6963 7420  e sync conflict 
+00014870: 7761 7320 6465 7465 6374 6564 2061 6e64  was detected and
+00014880: 2068 616e 646c 6564 2e0a 2020 2020 2020   handled..      
+00014890: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+000148a0: 206e 6f74 2028 6576 656e 742e 6973 5f61   not (event.is_a
+000148b0: 6464 6564 206f 7220 6576 656e 742e 6973  dded or event.is
+000148c0: 5f6d 6f76 6564 293a 0a20 2020 2020 2020  _moved):.       
+000148d0: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
+000148e0: 650a 0a20 2020 2020 2020 2069 6620 7365  e..        if se
+000148f0: 6c66 2e69 735f 6578 636c 7564 6564 5f62  lf.is_excluded_b
+00014900: 795f 7573 6572 2865 7665 6e74 2e64 6278  y_user(event.dbx
+00014910: 5f70 6174 685f 6c6f 7765 7229 3a0a 2020  _path_lower):.  
+00014920: 2020 2020 2020 2020 2020 6c6f 6361 6c5f            local_
+00014930: 7061 7468 5f63 6320 3d20 6765 6e65 7261  path_cc = genera
+00014940: 7465 5f63 635f 6e61 6d65 280a 2020 2020  te_cc_name(.    
+00014950: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00014960: 742e 6c6f 6361 6c5f 7061 7468 2c0a 2020  t.local_path,.  
+00014970: 2020 2020 2020 2020 2020 2020 2020 7375                su
+00014980: 6666 6978 3d22 7365 6c65 6374 6976 6520  ffix="selective 
+00014990: 7379 6e63 2063 6f6e 666c 6963 7422 2c0a  sync conflict",.
+000149a0: 2020 2020 2020 2020 2020 2020 290a 0a20              ).. 
+000149b0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
+000149c0: 5f63 6c73 203d 2044 6972 4d6f 7665 6445  _cls = DirMovedE
+000149d0: 7665 6e74 2069 6620 6973 6469 7228 6576  vent if isdir(ev
+000149e0: 656e 742e 6c6f 6361 6c5f 7061 7468 2920  ent.local_path) 
+000149f0: 656c 7365 2046 696c 654d 6f76 6564 4576  else FileMovedEv
+00014a00: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
+00014a10: 7769 7468 2073 656c 662e 6673 5f65 7665  with self.fs_eve
+00014a20: 6e74 732e 6967 6e6f 7265 2865 7665 6e74  nts.ignore(event
+00014a30: 5f63 6c73 2865 7665 6e74 2e6c 6f63 616c  _cls(event.local
+00014a40: 5f70 6174 682c 206c 6f63 616c 5f70 6174  _path, local_pat
+00014a50: 685f 6363 2929 3a0a 2020 2020 2020 2020  h_cc)):.        
+00014a60: 2020 2020 2020 2020 7769 7468 2063 6f6e          with con
+00014a70: 7665 7274 5f61 7069 5f65 7272 6f72 7328  vert_api_errors(
+00014a80: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00014a90: 2020 2020 2020 206d 6f76 6528 6576 656e         move(even
+00014aa0: 742e 6c6f 6361 6c5f 7061 7468 2c20 6c6f  t.local_path, lo
+00014ab0: 6361 6c5f 7061 7468 5f63 632c 2072 6169  cal_path_cc, rai
+00014ac0: 7365 5f65 7272 6f72 3d54 7275 6529 0a0a  se_error=True)..
+00014ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00014ae0: 7365 6c66 2e72 6573 6361 6e28 6c6f 6361  self.rescan(loca
+00014af0: 6c5f 7061 7468 5f63 6329 0a0a 2020 2020  l_path_cc)..    
+00014b00: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00014b10: 6767 6572 2e69 6e66 6f28 0a20 2020 2020  gger.info(.     
+00014b20: 2020 2020 2020 2020 2020 2027 5365 6c65             'Sele
+00014b30: 6374 6976 6520 7379 6e63 2063 6f6e 666c  ctive sync confl
+00014b40: 6963 743a 2072 656e 616d 6564 2022 2573  ict: renamed "%s
+00014b50: 2220 746f 2022 2573 2227 2c0a 2020 2020  " to "%s"',.    
+00014b60: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00014b70: 742e 6c6f 6361 6c5f 7061 7468 2c0a 2020  t.local_path,.  
+00014b80: 2020 2020 2020 2020 2020 2020 2020 6c6f                lo
+00014b90: 6361 6c5f 7061 7468 5f63 632c 0a20 2020  cal_path_cc,.   
+00014ba0: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00014bb0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
+00014bc0: 7565 0a20 2020 2020 2020 2065 6c73 653a  ue.        else:
+00014bd0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+00014be0: 7572 6e20 4661 6c73 650a 0a20 2020 2064  urn False..    d
+00014bf0: 6566 205f 6372 6561 7465 5f72 656d 6f74  ef _create_remot
+00014c00: 655f 656e 7472 7928 7365 6c66 2c20 6576  e_entry(self, ev
+00014c10: 656e 743a 2053 796e 6345 7665 6e74 2920  ent: SyncEvent) 
+00014c20: 2d3e 2053 796e 6345 7665 6e74 3a0a 2020  -> SyncEvent:.  
+00014c30: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00014c40: 2020 4170 706c 6965 7320 6120 6c6f 6361    Applies a loca
+00014c50: 6c20 6669 6c65 2073 7973 7465 6d20 6576  l file system ev
+00014c60: 656e 7420 746f 2074 6865 2072 656d 6f74  ent to the remot
+00014c70: 6520 4472 6f70 626f 7820 616e 6420 636c  e Dropbox and cl
+00014c80: 6561 7273 2061 6e79 2065 7869 7374 696e  ears any existin
+00014c90: 670a 2020 2020 2020 2020 7379 6e63 2065  g.        sync e
+00014ca0: 7272 6f72 7320 6265 6c6f 6e67 696e 6720  rrors belonging 
+00014cb0: 746f 2074 6861 7420 7061 7468 2e20 416e  to that path. An
+00014cc0: 7920 3a65 7863 3a60 6d61 6573 7472 616c  y :exc:`maestral
+00014cd0: 2e65 7863 6570 7469 6f6e 2e53 796e 6345  .exception.SyncE
+00014ce0: 7272 6f72 6020 7769 6c6c 0a20 2020 2020  rror` will.     
+00014cf0: 2020 2062 6520 6361 7567 6874 2061 6e64     be caught and
+00014d00: 206c 6f67 6765 6420 6173 2061 7070 726f   logged as appro
+00014d10: 7072 6961 7465 2e0a 0a20 2020 2020 2020  priate...       
+00014d20: 2054 6869 7320 6d65 7468 6f64 2061 6c77   This method alw
+00014d30: 6179 7320 7573 6573 2061 206e 6577 2063  ays uses a new c
+00014d40: 6f70 7920 6f66 2063 6c69 656e 7420 616e  opy of client an
+00014d50: 6420 636c 6f73 6573 2074 6865 206e 6574  d closes the net
+00014d60: 776f 726b 2073 6573 7369 6f6e 0a20 2020  work session.   
+00014d70: 2020 2020 2061 6674 6572 7761 7264 732e       afterwards.
+00014d80: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+00014d90: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
+00014da0: 7420 666f 7220 6c6f 6361 6c20 6669 6c65  t for local file
+00014db0: 2065 7665 6e74 2e0a 2020 2020 2020 2020   event..        
+00014dc0: 3a72 6574 7572 6e73 3a20 5379 6e63 4576  :returns: SyncEv
+00014dd0: 656e 7420 7769 7468 2075 7064 6174 6564  ent with updated
+00014de0: 2073 7461 7475 732e 0a20 2020 2020 2020   status..       
+00014df0: 2022 2222 0a20 2020 2020 2020 2069 6620   """.        if 
+00014e00: 7365 6c66 2e5f 6361 6e63 656c 5f72 6571  self._cancel_req
+00014e10: 7565 7374 6564 2e69 735f 7365 7428 293a  uested.is_set():
+00014e20: 0a20 2020 2020 2020 2020 2020 2072 6169  .            rai
+00014e30: 7365 2043 616e 6365 6c6c 6564 4572 726f  se CancelledErro
+00014e40: 7228 2253 796e 6320 6361 6e63 656c 6c65  r("Sync cancelle
+00014e50: 6422 290a 0a20 2020 2020 2020 2073 656c  d")..        sel
+00014e60: 662e 5f73 6c6f 775f 646f 776e 2829 0a0a  f._slow_down()..
+00014e70: 2020 2020 2020 2020 6576 656e 742e 7374          event.st
+00014e80: 6174 7573 203d 2053 796e 6353 7461 7475  atus = SyncStatu
+00014e90: 732e 5379 6e63 696e 670a 0a20 2020 2020  s.Syncing..     
+00014ea0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00014eb0: 2020 2020 6966 2065 7665 6e74 2e69 735f      if event.is_
+00014ec0: 6669 6c65 2061 6e64 2028 6576 656e 742e  file and (event.
+00014ed0: 6973 5f61 6464 6564 206f 7220 6576 656e  is_added or even
+00014ee0: 742e 6973 5f63 6861 6e67 6564 293a 0a20  t.is_changed):. 
+00014ef0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00014f00: 7461 7475 7320 3d20 7365 6c66 2e5f 6f6e  tatus = self._on
+00014f10: 5f6c 6f63 616c 5f66 696c 655f 6d6f 6469  _local_file_modi
+00014f20: 6669 6564 2865 7665 6e74 290a 2020 2020  fied(event).    
+00014f30: 2020 2020 2020 2020 656c 6966 2065 7665          elif eve
+00014f40: 6e74 2e69 735f 6469 7265 6374 6f72 7920  nt.is_directory 
+00014f50: 616e 6420 6576 656e 742e 6973 5f61 6464  and event.is_add
+00014f60: 6564 3a0a 2020 2020 2020 2020 2020 2020  ed:.            
+00014f70: 2020 2020 7374 6174 7573 203d 2073 656c      status = sel
+00014f80: 662e 5f6f 6e5f 6c6f 6361 6c5f 666f 6c64  f._on_local_fold
+00014f90: 6572 5f63 7265 6174 6564 2865 7665 6e74  er_created(event
+00014fa0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00014fb0: 6966 2065 7665 6e74 2e69 735f 6d6f 7665  if event.is_move
+00014fc0: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
+00014fd0: 2020 2073 7461 7475 7320 3d20 7365 6c66     status = self
+00014fe0: 2e5f 6f6e 5f6c 6f63 616c 5f6d 6f76 6564  ._on_local_moved
+00014ff0: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
+00015000: 2020 2020 656c 6966 2065 7665 6e74 2e69      elif event.i
+00015010: 735f 6465 6c65 7465 643a 0a20 2020 2020  s_deleted:.     
+00015020: 2020 2020 2020 2020 2020 2073 7461 7475             statu
+00015030: 7320 3d20 7365 6c66 2e5f 6f6e 5f6c 6f63  s = self._on_loc
+00015040: 616c 5f64 656c 6574 6564 2865 7665 6e74  al_deleted(event
+00015050: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+00015060: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00015070: 2020 2020 7374 6174 7573 203d 2053 796e      status = Syn
+00015080: 6353 7461 7475 732e 536b 6970 7065 640a  cStatus.Skipped.
+00015090: 0a20 2020 2020 2020 2020 2020 2065 7665  .            eve
+000150a0: 6e74 2e73 7461 7475 7320 3d20 7374 6174  nt.status = stat
+000150b0: 7573 0a0a 2020 2020 2020 2020 6578 6365  us..        exce
+000150c0: 7074 2053 796e 6345 7272 6f72 2061 7320  pt SyncError as 
+000150d0: 6572 723a 0a20 2020 2020 2020 2020 2020  err:.           
+000150e0: 2073 656c 662e 5f68 616e 646c 655f 7379   self._handle_sy
+000150f0: 6e63 5f65 7272 6f72 2865 7272 2c20 6469  nc_error(err, di
+00015100: 7265 6374 696f 6e3d 5379 6e63 4469 7265  rection=SyncDire
+00015110: 6374 696f 6e2e 5570 290a 2020 2020 2020  ction.Up).      
+00015120: 2020 2020 2020 6576 656e 742e 7374 6174        event.stat
+00015130: 7573 203d 2053 796e 6353 7461 7475 732e  us = SyncStatus.
+00015140: 4661 696c 6564 0a20 2020 2020 2020 2065  Failed.        e
+00015150: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00015160: 2073 656c 662e 636c 6561 725f 7379 6e63   self.clear_sync
+00015170: 5f65 7272 6f72 735f 6672 6f6d 5f65 7665  _errors_from_eve
+00015180: 6e74 2865 7665 6e74 290a 2020 2020 2020  nt(event).      
+00015190: 2020 2020 2020 7365 6c66 2e61 6374 6976        self.activ
+000151a0: 6974 792e 6469 7363 6172 6428 6576 656e  ity.discard(even
+000151b0: 7429 0a0a 2020 2020 2020 2020 2320 4164  t)..        # Ad
+000151c0: 6420 6576 656e 7473 2074 6f20 6869 7374  d events to hist
+000151d0: 6f72 7920 6461 7461 6261 7365 2e0a 2020  ory database..  
+000151e0: 2020 2020 2020 6966 2065 7665 6e74 2e73        if event.s
+000151f0: 7461 7475 7320 3d3d 2053 796e 6353 7461  tatus == SyncSta
+00015200: 7475 732e 446f 6e65 3a0a 2020 2020 2020  tus.Done:.      
+00015210: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+00015220: 5f64 6174 6162 6173 655f 6163 6365 7373  _database_access
+00015230: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00015240: 2020 2020 7365 6c66 2e5f 6869 7374 6f72      self._histor
+00015250: 795f 7461 626c 652e 7361 7665 2865 7665  y_table.save(eve
+00015260: 6e74 290a 0a20 2020 2020 2020 2072 6574  nt)..        ret
+00015270: 7572 6e20 6576 656e 740a 0a20 2020 2040  urn event..    @
+00015280: 7374 6174 6963 6d65 7468 6f64 0a20 2020  staticmethod.   
+00015290: 2064 6566 205f 7761 6974 5f66 6f72 5f63   def _wait_for_c
+000152a0: 7265 6174 696f 6e28 6c6f 6361 6c5f 7061  reation(local_pa
+000152b0: 7468 3a20 7374 7229 202d 3e20 4e6f 6e65  th: str) -> None
+000152c0: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+000152d0: 2020 2020 2020 5761 6974 2066 6f72 2061        Wait for a
+000152e0: 2066 696c 6520 6174 2061 2070 6174 6820   file at a path 
+000152f0: 746f 2062 6520 6372 6561 7465 6420 6f72  to be created or
+00015300: 206d 6f64 6966 6965 642e 0a0a 2020 2020   modified...    
+00015310: 2020 2020 3a70 6172 616d 206c 6f63 616c      :param local
+00015320: 5f70 6174 683a 2041 6273 6f6c 7574 6520  _path: Absolute 
+00015330: 7061 7468 2074 6f20 6669 6c65 206f 6e20  path to file on 
+00015340: 6472 6976 652e 0a20 2020 2020 2020 2022  drive..        "
+00015350: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
+00015360: 2020 2020 2020 2020 2020 2020 7768 696c              whil
+00015370: 6520 5472 7565 3a0a 2020 2020 2020 2020  e True:.        
+00015380: 2020 2020 2020 2020 7369 7a65 3120 3d20          size1 = 
+00015390: 6765 7473 697a 6528 6c6f 6361 6c5f 7061  getsize(local_pa
+000153a0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+000153b0: 2020 2020 7469 6d65 2e73 6c65 6570 2830      time.sleep(0
+000153c0: 2e32 290a 2020 2020 2020 2020 2020 2020  .2).            
+000153d0: 2020 2020 7369 7a65 3220 3d20 6765 7473      size2 = gets
+000153e0: 697a 6528 6c6f 6361 6c5f 7061 7468 290a  ize(local_path).
+000153f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015400: 6966 2073 697a 6531 203d 3d20 7369 7a65  if size1 == size
+00015410: 323a 0a20 2020 2020 2020 2020 2020 2020  2:.             
+00015420: 2020 2020 2020 2072 6574 7572 6e0a 2020         return.  
+00015430: 2020 2020 2020 6578 6365 7074 204f 5345        except OSE
+00015440: 7272 6f72 3a0a 2020 2020 2020 2020 2020  rror:.          
+00015450: 2020 7265 7475 726e 0a0a 2020 2020 6465    return..    de
+00015460: 6620 5f6f 6e5f 6c6f 6361 6c5f 6d6f 7665  f _on_local_move
+00015470: 6428 7365 6c66 2c20 6576 656e 743a 2053  d(self, event: S
+00015480: 796e 6345 7665 6e74 2920 2d3e 2053 796e  yncEvent) -> Syn
+00015490: 6353 7461 7475 733a 0a20 2020 2020 2020  cStatus:.       
+000154a0: 2022 2222 0a20 2020 2020 2020 2043 616c   """.        Cal
+000154b0: 6c20 7768 656e 2061 206c 6f63 616c 2069  l when a local i
+000154c0: 7465 6d20 6973 206d 6f76 6564 2e0a 0a20  tem is moved... 
+000154d0: 2020 2020 2020 204b 6565 7020 696e 206d         Keep in m
+000154e0: 696e 6420 7468 6174 2077 6520 6d61 7920  ind that we may 
+000154f0: 6265 206d 6f76 696e 6720 6120 7768 6f6c  be moving a whol
+00015500: 6520 7472 6565 206f 6620 6974 656d 732e  e tree of items.
+00015510: 2042 7574 2069 7473 2062 6574 7465 7220   But its better 
+00015520: 6465 616c 0a20 2020 2020 2020 2077 6974  deal.        wit
+00015530: 6820 7468 6520 636f 6d70 6c65 7869 7479  h the complexity
+00015540: 2074 6861 6e20 746f 2064 656c 6574 6520   than to delete 
+00015550: 616e 6420 7265 2d75 706c 6f61 6469 6e67  and re-uploading
+00015560: 2065 7665 7279 7468 696e 672e 2054 6861   everything. Tha
+00015570: 6e6b 6675 6c6c 792c 2069 6e0a 2020 2020  nkfully, in.    
+00015580: 2020 2020 6361 7365 206f 6620 6469 7265      case of dire
+00015590: 6374 6f72 6965 732c 2077 6520 616c 7761  ctories, we alwa
+000155a0: 7973 2070 726f 6365 7373 2074 6865 2074  ys process the t
+000155b0: 6f70 2d6c 6576 656c 2066 6972 7374 2e20  op-level first. 
+000155c0: 5472 7969 6e67 2074 6f20 6d6f 7665 2074  Trying to move t
+000155d0: 6865 0a20 2020 2020 2020 2063 6869 6c64  he.        child
+000155e0: 7265 6e20 7769 6c6c 2074 6865 6e20 6265  ren will then be
+000155f0: 2064 656c 6567 6174 6564 2074 6f20 606f   delegated to `o
+00015600: 6e5f 6372 6561 7465 6020 2862 6563 6175  n_create` (becau
+00015610: 7365 2074 6865 206f 6c64 2069 7465 6d20  se the old item 
+00015620: 6e6f 206c 6f6e 6765 720a 2020 2020 2020  no longer.      
+00015630: 2020 6c69 7665 7320 6f6e 2044 726f 7062    lives on Dropb
+00015640: 6f78 2920 616e 6420 7468 6174 2077 6f6e  ox) and that won
+00015650: 2774 2075 706c 6f61 6420 616e 7974 6869  't upload anythi
+00015660: 6e67 2062 6563 6175 7365 2066 696c 6520  ng because file 
+00015670: 636f 6e74 656e 7473 2068 6176 650a 2020  contents have.  
+00015680: 2020 2020 2020 7265 6d61 696e 6564 2074        remained t
+00015690: 6865 2073 616d 652e 0a0a 2020 2020 2020  he same...      
+000156a0: 2020 3a70 6172 616d 2065 7665 6e74 3a20    :param event: 
+000156b0: 5379 6e63 4576 656e 7420 666f 7220 6c6f  SyncEvent for lo
+000156c0: 6361 6c20 6d6f 7665 6420 6576 656e 742e  cal moved event.
+000156d0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
+000156e0: 733a 204d 6574 6164 6174 6120 666f 7220  s: Metadata for 
+000156f0: 6372 6561 7465 6420 7265 6d6f 7465 2069  created remote i
+00015700: 7465 6d20 6174 2064 6573 7469 6e61 7469  tem at destinati
+00015710: 6f6e 2e0a 2020 2020 2020 2020 3a72 6169  on..        :rai
+00015720: 7365 7320 4d61 6573 7472 616c 4170 6945  ses MaestralApiE
+00015730: 7272 6f72 3a20 466f 7220 616e 7920 6973  rror: For any is
+00015740: 7375 6573 2077 6865 6e20 7379 6e63 696e  sues when syncin
+00015750: 6720 7468 6520 6974 656d 2e0a 2020 2020  g the item..    
+00015760: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00015770: 6368 6563 6b5f 6368 616e 6765 5f74 7970  check_change_typ
+00015780: 6528 6576 656e 742c 207b 4368 616e 6765  e(event, {Change
+00015790: 5479 7065 2e4d 6f76 6564 7d29 0a20 2020  Type.Moved}).   
+000157a0: 2020 2020 2063 6865 636b 5f65 6e63 6f64       check_encod
+000157b0: 696e 6728 6576 656e 742e 6c6f 6361 6c5f  ing(event.local_
+000157c0: 7061 7468 290a 0a20 2020 2020 2020 2069  path)..        i
+000157d0: 6620 6576 656e 742e 6c6f 6361 6c5f 7061  f event.local_pa
+000157e0: 7468 5f66 726f 6d20 3d3d 2073 656c 662e  th_from == self.
+000157f0: 6472 6f70 626f 785f 7061 7468 3a0a 2020  dropbox_path:.  
+00015800: 2020 2020 2020 2020 2020 7365 6c66 2e65            self.e
+00015810: 6e73 7572 655f 6472 6f70 626f 785f 666f  nsure_dropbox_fo
+00015820: 6c64 6572 5f70 7265 7365 6e74 2829 0a0a  lder_present()..
+00015830: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00015840: 5f68 616e 646c 655f 7365 6c65 6374 6976  _handle_selectiv
+00015850: 655f 7379 6e63 5f63 6f6e 666c 6963 7428  e_sync_conflict(
+00015860: 6576 656e 7429 3a0a 2020 2020 2020 2020  event):.        
+00015870: 2020 2020 7265 7475 726e 2053 796e 6353      return SyncS
+00015880: 7461 7475 732e 536b 6970 7065 640a 2020  tatus.Skipped.  
+00015890: 2020 2020 2020 6966 2073 656c 662e 5f68        if self._h
+000158a0: 616e 646c 655f 6e6f 726d 616c 697a 6174  andle_normalizat
+000158b0: 696f 6e5f 636f 6e66 6c69 6374 2865 7665  ion_conflict(eve
+000158c0: 6e74 293a 0a20 2020 2020 2020 2020 2020  nt):.           
+000158d0: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
+000158e0: 7573 2e53 6b69 7070 6564 0a0a 2020 2020  us.Skipped..    
+000158f0: 2020 2020 6462 785f 7061 7468 5f66 726f      dbx_path_fro
+00015900: 6d20 3d20 6361 7374 2873 7472 2c20 6576  m = cast(str, ev
+00015910: 656e 742e 6462 785f 7061 7468 5f66 726f  ent.dbx_path_fro
+00015920: 6d29 0a0a 2020 2020 2020 2020 2320 4966  m)..        # If
+00015930: 2061 2066 696c 6520 6174 2074 6865 2064   a file at the d
+00015940: 6573 7469 6e61 7469 6f6e 2073 686f 756c  estination shoul
+00015950: 6420 6265 2072 6570 6c61 6365 642c 2072  d be replaced, r
+00015960: 656d 6f76 6520 6974 2066 6972 7374 2c20  emove it first, 
+00015970: 6275 7420 6f6e 6c79 2069 660a 2020 2020  but only if.    
+00015980: 2020 2020 2320 6974 7320 7265 7620 6d61      # its rev ma
+00015990: 7463 6865 7320 7468 6520 7265 7620 6f66  tches the rev of
+000159a0: 2074 6865 206c 6f63 616c 206f 7665 7277   the local overw
+000159b0: 7269 7474 656e 2066 696c 652e 0a20 2020  ritten file..   
+000159c0: 2020 2020 2023 2054 6865 2044 726f 7062       # The Dropb
+000159d0: 6f78 2041 5049 2064 6f65 7320 6e6f 7420  ox API does not 
+000159e0: 616c 6c6f 7720 6f76 6572 7772 6974 696e  allow overwritin
+000159f0: 6720 6120 6465 7374 696e 6174 696f 6e20  g a destination 
+00015a00: 6669 6c65 2064 7572 696e 6720 6120 6d6f  file during a mo
+00015a10: 7665 2e0a 2020 2020 2020 2020 6c6f 6361  ve..        loca
+00015a20: 6c5f 656e 7472 7920 3d20 7365 6c66 2e67  l_entry = self.g
+00015a30: 6574 5f69 6e64 6578 5f65 6e74 7279 2865  et_index_entry(e
+00015a40: 7665 6e74 2e64 6278 5f70 6174 685f 6c6f  vent.dbx_path_lo
+00015a50: 7765 7229 0a0a 2020 2020 2020 2020 6966  wer)..        if
+00015a60: 206c 6f63 616c 5f65 6e74 7279 2061 6e64   local_entry and
+00015a70: 206c 6f63 616c 5f65 6e74 7279 2e69 735f   local_entry.is_
+00015a80: 6669 6c65 3a0a 2020 2020 2020 2020 2020  file:.          
+00015a90: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00015aa0: 2020 2020 2020 2073 656c 662e 636c 6965         self.clie
+00015ab0: 6e74 2e72 656d 6f76 6528 0a20 2020 2020  nt.remove(.     
+00015ac0: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00015ad0: 6f63 616c 5f65 6e74 7279 2e64 6278 5f70  ocal_entry.dbx_p
+00015ae0: 6174 685f 6c6f 7765 722c 2070 6172 656e  ath_lower, paren
+00015af0: 745f 7265 763d 6c6f 6361 6c5f 656e 7472  t_rev=local_entr
+00015b00: 792e 7265 760a 2020 2020 2020 2020 2020  y.rev.          
+00015b10: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00015b20: 2020 2020 6578 6365 7074 2028 4e6f 7446      except (NotF
+00015b30: 6f75 6e64 4572 726f 722c 2046 696c 6543  oundError, FileC
+00015b40: 6f6e 666c 6963 7445 7272 6f72 293a 0a20  onflictError):. 
+00015b50: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00015b60: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+00015b70: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00015b80: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00015b90: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
+00015ba0: 2020 2020 2020 2020 2020 2020 2020 2752                'R
+00015bb0: 6570 6c61 6369 6e67 2065 7869 7374 696e  eplacing existin
+00015bc0: 6720 6669 6c65 2022 2573 2220 6279 206d  g file "%s" by m
+00015bd0: 6f76 6527 2c20 6c6f 6361 6c5f 656e 7472  ove', local_entr
+00015be0: 792e 6462 785f 7061 7468 5f6c 6f77 6572  y.dbx_path_lower
+00015bf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015c00: 2029 0a0a 2020 2020 2020 2020 2320 5065   )..        # Pe
+00015c10: 7266 6f72 6d20 7468 6520 6d6f 7665 2e0a  rform the move..
+00015c20: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00015c30: 2020 2020 2020 2020 206d 645f 746f 5f6e           md_to_n
+00015c40: 6577 203d 2073 656c 662e 636c 6965 6e74  ew = self.client
+00015c50: 2e6d 6f76 6528 6462 785f 7061 7468 5f66  .move(dbx_path_f
+00015c60: 726f 6d2c 2065 7665 6e74 2e64 6278 5f70  rom, event.dbx_p
+00015c70: 6174 682c 2061 7574 6f72 656e 616d 653d  ath, autorename=
+00015c80: 5472 7565 290a 2020 2020 2020 2020 6578  True).        ex
+00015c90: 6365 7074 204e 6f74 466f 756e 6445 7272  cept NotFoundErr
+00015ca0: 6f72 3a0a 2020 2020 2020 2020 2020 2020  or:.            
+00015cb0: 2320 4966 206e 6f74 206f 6e20 4472 6f70  # If not on Drop
+00015cc0: 626f 782c 2065 2e67 2e2c 2062 6563 6175  box, e.g., becau
+00015cd0: 7365 2069 7473 206f 6c64 206e 616d 6520  se its old name 
+00015ce0: 7761 7320 696e 7661 6c69 642c 0a20 2020  was invalid,.   
+00015cf0: 2020 2020 2020 2020 2023 2063 7265 6174           # creat
+00015d00: 6520 6974 2069 6e73 7465 6164 206f 6620  e it instead of 
+00015d10: 6d6f 7669 6e67 2069 742e 0a20 2020 2020  moving it..     
+00015d20: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+00015d30: 6765 722e 6465 6275 6728 0a20 2020 2020  ger.debug(.     
+00015d40: 2020 2020 2020 2020 2020 2027 436f 756c             'Coul
+00015d50: 6420 6e6f 7420 6d6f 7665 2022 2573 2220  d not move "%s" 
+00015d60: 2d3e 2022 2573 2220 6f6e 2044 726f 7062  -> "%s" on Dropb
+00015d70: 6f78 2c20 736f 7572 6365 2064 6f65 7320  ox, source does 
+00015d80: 6e6f 7420 6578 6973 7473 2e20 270a 2020  not exists. '.  
+00015d90: 2020 2020 2020 2020 2020 2020 2020 2743                'C
+00015da0: 7265 6174 696e 6720 2225 7322 2069 6e73  reating "%s" ins
+00015db0: 7465 6164 272c 0a20 2020 2020 2020 2020  tead',.         
+00015dc0: 2020 2020 2020 2065 7665 6e74 2e64 6278         event.dbx
+00015dd0: 5f70 6174 685f 6672 6f6d 2c0a 2020 2020  _path_from,.    
+00015de0: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00015df0: 742e 6462 785f 7061 7468 2c0a 2020 2020  t.dbx_path,.    
+00015e00: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00015e10: 742e 6462 785f 7061 7468 2c0a 2020 2020  t.dbx_path,.    
+00015e20: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00015e30: 2020 2020 2020 2073 656c 662e 7265 7363         self.resc
+00015e40: 616e 2865 7665 6e74 2e6c 6f63 616c 5f70  an(event.local_p
+00015e50: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+00015e60: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
+00015e70: 7573 2e53 6b69 7070 6564 0a0a 2020 2020  us.Skipped..    
+00015e80: 2020 2020 6173 7365 7274 2065 7665 6e74      assert event
+00015e90: 2e64 6278 5f70 6174 685f 6672 6f6d 5f6c  .dbx_path_from_l
+00015ea0: 6f77 6572 2069 7320 6e6f 7420 4e6f 6e65  ower is not None
+00015eb0: 0a20 2020 2020 2020 2073 656c 662e 7265  .        self.re
+00015ec0: 6d6f 7665 5f6e 6f64 655f 6672 6f6d 5f69  move_node_from_i
+00015ed0: 6e64 6578 2865 7665 6e74 2e64 6278 5f70  ndex(event.dbx_p
+00015ee0: 6174 685f 6672 6f6d 5f6c 6f77 6572 290a  ath_from_lower).
+00015ef0: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00015f00: 2e5f 6861 6e64 6c65 5f75 706c 6f61 645f  ._handle_upload_
+00015f10: 636f 6e66 6c69 6374 286d 645f 746f 5f6e  conflict(md_to_n
+00015f20: 6577 2c20 6576 656e 7429 3a0a 2020 2020  ew, event):.    
+00015f30: 2020 2020 2020 2020 7374 6174 7573 203d          status =
+00015f40: 2053 796e 6353 7461 7475 732e 436f 6e66   SyncStatus.Conf
+00015f50: 6c69 6374 0a20 2020 2020 2020 2065 6c73  lict.        els
+00015f60: 653a 0a20 2020 2020 2020 2020 2020 2073  e:.            s
+00015f70: 7461 7475 7320 3d20 5379 6e63 5374 6174  tatus = SyncStat
+00015f80: 7573 2e44 6f6e 650a 2020 2020 2020 2020  us.Done.        
+00015f90: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00015fa0: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00015fb0: 2020 2020 2020 2020 274d 6f76 6564 2022          'Moved "
+00015fc0: 2573 2220 746f 2022 2573 2220 6f6e 2044  %s" to "%s" on D
+00015fd0: 726f 7062 6f78 272c 2064 6278 5f70 6174  ropbox', dbx_pat
+00015fe0: 685f 6672 6f6d 2c20 6576 656e 742e 6462  h_from, event.db
+00015ff0: 785f 7061 7468 0a20 2020 2020 2020 2020  x_path.         
+00016000: 2020 2029 0a20 2020 2020 2020 2073 656c     ).        sel
+00016010: 662e 5f75 7064 6174 655f 696e 6465 785f  f._update_index_
+00016020: 7265 6375 7273 6976 6528 6d64 5f74 6f5f  recursive(md_to_
+00016030: 6e65 7729 0a0a 2020 2020 2020 2020 7265  new)..        re
+00016040: 7475 726e 2073 7461 7475 730a 0a20 2020  turn status..   
+00016050: 2064 6566 205f 7570 6461 7465 5f69 6e64   def _update_ind
+00016060: 6578 5f72 6563 7572 7369 7665 2873 656c  ex_recursive(sel
+00016070: 662c 206d 643a 204d 6574 6164 6174 6129  f, md: Metadata)
+00016080: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+00016090: 2020 7365 6c66 2e75 7064 6174 655f 696e    self.update_in
+000160a0: 6465 785f 6672 6f6d 5f64 6278 5f6d 6574  dex_from_dbx_met
+000160b0: 6164 6174 6128 6d64 290a 0a20 2020 2020  adata(md)..     
+000160c0: 2020 2069 6620 6973 696e 7374 616e 6365     if isinstance
+000160d0: 286d 642c 2046 6f6c 6465 724d 6574 6164  (md, FolderMetad
+000160e0: 6174 6129 3a0a 2020 2020 2020 2020 2020  ata):.          
+000160f0: 2020 7265 7375 6c74 203d 2073 656c 662e    result = self.
+00016100: 636c 6965 6e74 2e6c 6973 745f 666f 6c64  client.list_fold
+00016110: 6572 286d 642e 7061 7468 5f6c 6f77 6572  er(md.path_lower
+00016120: 2c20 7265 6375 7273 6976 653d 5472 7565  , recursive=True
+00016130: 290a 2020 2020 2020 2020 2020 2020 666f  ).            fo
+00016140: 7220 6d64 2069 6e20 7265 7375 6c74 2e65  r md in result.e
+00016150: 6e74 7269 6573 3a0a 2020 2020 2020 2020  ntries:.        
+00016160: 2020 2020 2020 2020 7365 6c66 2e75 7064          self.upd
+00016170: 6174 655f 696e 6465 785f 6672 6f6d 5f64  ate_index_from_d
+00016180: 6278 5f6d 6574 6164 6174 6128 6d64 290a  bx_metadata(md).
+00016190: 0a20 2020 2064 6566 205f 6f6e 5f6c 6f63  .    def _on_loc
+000161a0: 616c 5f66 696c 655f 6d6f 6469 6669 6564  al_file_modified
+000161b0: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
+000161c0: 6e63 4576 656e 7429 202d 3e20 5379 6e63  ncEvent) -> Sync
+000161d0: 5374 6174 7573 3a0a 2020 2020 2020 2020  Status:.        
+000161e0: 2222 220a 2020 2020 2020 2020 4361 6c6c  """.        Call
+000161f0: 2077 6865 6e20 6120 6c6f 6361 6c20 6669   when a local fi
+00016200: 6c65 2069 7320 6372 6561 7465 6420 6f72  le is created or
+00016210: 206d 6f64 6966 6965 642e 0a0a 2020 2020   modified...    
+00016220: 2020 2020 3a70 6172 616d 2065 7665 6e74      :param event
+00016230: 3a20 5379 6e63 4576 656e 7420 636f 7272  : SyncEvent corr
+00016240: 6573 706f 6e64 696e 6720 746f 206c 6f63  esponding to loc
+00016250: 616c 2063 7265 6174 6564 2065 7665 6e74  al created event
+00016260: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+00016270: 6e73 3a20 4d65 7461 6461 7461 2066 6f72  ns: Metadata for
+00016280: 2063 7265 6174 6564 2069 7465 6d20 6f72   created item or
+00016290: 204e 6f6e 6520 6966 206e 6f20 7265 6d6f   None if no remo
+000162a0: 7465 2069 7465 6d20 6973 2063 7265 6174  te item is creat
+000162b0: 6564 2e0a 2020 2020 2020 2020 3a72 6169  ed..        :rai
+000162c0: 7365 7320 4d61 6573 7472 616c 4170 6945  ses MaestralApiE
+000162d0: 7272 6f72 3a20 466f 7220 616e 7920 6973  rror: For any is
+000162e0: 7375 6573 2077 6865 6e20 7379 6e63 696e  sues when syncin
+000162f0: 6720 7468 6520 6974 656d 2e0a 2020 2020  g the item..    
+00016300: 2020 2020 3a72 6169 7365 7320 5661 6c75      :raises Valu
+00016310: 6545 7272 6f72 3a20 4966 2074 6865 2043  eError: If the C
+00016320: 6861 6e67 6554 7970 6520 6973 206e 6f74  hangeType is not
+00016330: 2041 6464 6564 206f 7220 4d6f 6469 6669   Added or Modifi
+00016340: 6564 2e0a 2020 2020 2020 2020 2222 220a  ed..        """.
+00016350: 2020 2020 2020 2020 6368 6563 6b5f 6368          check_ch
+00016360: 616e 6765 5f74 7970 6528 6576 656e 742c  ange_type(event,
+00016370: 207b 4368 616e 6765 5479 7065 2e41 6464   {ChangeType.Add
+00016380: 6564 2c20 4368 616e 6765 5479 7065 2e4d  ed, ChangeType.M
+00016390: 6f64 6966 6965 647d 290a 2020 2020 2020  odified}).      
+000163a0: 2020 6368 6563 6b5f 656e 636f 6469 6e67    check_encoding
+000163b0: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
+000163c0: 6829 0a0a 2020 2020 2020 2020 6966 2073  h)..        if s
+000163d0: 656c 662e 5f68 616e 646c 655f 7365 6c65  elf._handle_sele
+000163e0: 6374 6976 655f 7379 6e63 5f63 6f6e 666c  ctive_sync_confl
+000163f0: 6963 7428 6576 656e 7429 3a0a 2020 2020  ict(event):.    
+00016400: 2020 2020 2020 2020 7265 7475 726e 2053          return S
+00016410: 796e 6353 7461 7475 732e 436f 6e66 6c69  yncStatus.Confli
+00016420: 6374 0a20 2020 2020 2020 2069 6620 7365  ct.        if se
+00016430: 6c66 2e5f 6861 6e64 6c65 5f6e 6f72 6d61  lf._handle_norma
+00016440: 6c69 7a61 7469 6f6e 5f63 6f6e 666c 6963  lization_conflic
+00016450: 7428 6576 656e 7429 3a0a 2020 2020 2020  t(event):.      
+00016460: 2020 2020 2020 7265 7475 726e 2053 796e        return Syn
+00016470: 6353 7461 7475 732e 436f 6e66 6c69 6374  cStatus.Conflict
+00016480: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+00016490: 7761 6974 5f66 6f72 5f63 7265 6174 696f  wait_for_creatio
+000164a0: 6e28 6576 656e 742e 6c6f 6361 6c5f 7061  n(event.local_pa
+000164b0: 7468 290a 0a20 2020 2020 2020 2023 2043  th)..        # C
+000164c0: 6865 636b 2069 6620 6974 656d 2061 6c72  heck if item alr
+000164d0: 6561 6479 2065 7869 7374 7320 7769 7468  eady exists with
+000164e0: 2069 6465 6e74 6963 616c 2063 6f6e 7465   identical conte
+000164f0: 6e74 2e0a 2020 2020 2020 2020 6966 206e  nt..        if n
+00016500: 6f74 2073 656c 662e 5f63 6865 636b 5f72  ot self._check_r
+00016510: 6571 7569 7265 735f 7570 6c6f 6164 2865  equires_upload(e
+00016520: 7665 6e74 293a 0a20 2020 2020 2020 2020  vent):.         
+00016530: 2020 2072 6574 7572 6e20 5379 6e63 5374     return SyncSt
+00016540: 6174 7573 2e53 6b69 7070 6564 0a0a 2020  atus.Skipped..  
+00016550: 2020 2020 2020 6c6f 6361 6c5f 656e 7472        local_entr
+00016560: 7920 3d20 7365 6c66 2e67 6574 5f69 6e64  y = self.get_ind
+00016570: 6578 5f65 6e74 7279 2865 7665 6e74 2e64  ex_entry(event.d
+00016580: 6278 5f70 6174 685f 6c6f 7765 7229 0a20  bx_path_lower). 
+00016590: 2020 2020 2020 206c 6f63 616c 5f72 6576         local_rev
+000165a0: 3a20 7374 7220 7c20 4e6f 6e65 203d 204e  : str | None = N
+000165b0: 6f6e 650a 0a20 2020 2020 2020 2069 6620  one..        if 
+000165c0: 6e6f 7420 6c6f 6361 6c5f 656e 7472 793a  not local_entry:
+000165d0: 0a20 2020 2020 2020 2020 2020 2023 2046  .            # F
+000165e0: 696c 6520 6973 206e 6577 2074 6f20 7573  ile is new to us
+000165f0: 2c20 6c65 7420 4472 6f70 626f 7820 7265  , let Dropbox re
+00016600: 6e61 6d65 2069 7420 6966 2073 6f6d 6574  name it if somet
+00016610: 6869 6e67 2069 7320 696e 2074 6865 2077  hing is in the w
+00016620: 6179 2e0a 2020 2020 2020 2020 2020 2020  ay..            
+00016630: 6d6f 6465 203d 2057 7269 7465 4d6f 6465  mode = WriteMode
+00016640: 2e41 6464 0a20 2020 2020 2020 2020 2020  .Add.           
+00016650: 2065 7665 6e74 2e63 6861 6e67 655f 7479   event.change_ty
+00016660: 7065 203d 2043 6861 6e67 6554 7970 652e  pe = ChangeType.
+00016670: 4164 6465 640a 2020 2020 2020 2020 656c  Added.        el
+00016680: 6966 206c 6f63 616c 5f65 6e74 7279 2e69  if local_entry.i
+00016690: 735f 6469 7265 6374 6f72 793a 0a20 2020  s_directory:.   
+000166a0: 2020 2020 2020 2020 2023 2054 7279 2074           # Try t
+000166b0: 6f20 6f76 6572 7772 6974 6520 7468 6520  o overwrite the 
+000166c0: 6465 7374 696e 6174 696f 6e2c 2074 6869  destination, thi
+000166d0: 7320 7769 6c6c 2066 6169 6c2e 2e2e 0a20  s will fail.... 
+000166e0: 2020 2020 2020 2020 2020 206d 6f64 6520             mode 
+000166f0: 3d20 5772 6974 654d 6f64 652e 4f76 6572  = WriteMode.Over
+00016700: 7772 6974 650a 2020 2020 2020 2020 656c  write.        el
+00016710: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00016720: 2320 4669 6c65 2068 6173 2062 6565 6e20  # File has been 
+00016730: 6d6f 6469 6669 6564 2c20 7570 6461 7465  modified, update
+00016740: 2072 656d 6f74 6520 6966 206d 6174 6368   remote if match
+00016750: 696e 6720 7265 762c 0a20 2020 2020 2020  ing rev,.       
+00016760: 2020 2020 2023 2063 7265 6174 6520 636f       # create co
+00016770: 6e66 6c69 6374 206f 7468 6572 7769 7365  nflict otherwise
+00016780: 2e0a 2020 2020 2020 2020 2020 2020 6d6f  ..            mo
+00016790: 6465 203d 2057 7269 7465 4d6f 6465 2e55  de = WriteMode.U
+000167a0: 7064 6174 650a 2020 2020 2020 2020 2020  pdate.          
+000167b0: 2020 6576 656e 742e 6368 616e 6765 5f74    event.change_t
+000167c0: 7970 6520 3d20 4368 616e 6765 5479 7065  ype = ChangeType
+000167d0: 2e4d 6f64 6966 6965 640a 2020 2020 2020  .Modified.      
+000167e0: 2020 2020 2020 6c6f 6361 6c5f 7265 7620        local_rev 
+000167f0: 3d20 6c6f 6361 6c5f 656e 7472 792e 7265  = local_entry.re
+00016800: 760a 0a20 2020 2020 2020 2074 7279 3a0a  v..        try:.
+00016810: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00016820: 2073 656c 662e 5f70 6172 616c 6c65 6c5f   self._parallel_
+00016830: 7570 5f73 656d 6170 686f 7265 3a0a 2020  up_semaphore:.  
+00016840: 2020 2020 2020 2020 2020 2020 2020 6d64                md
+00016850: 5f6e 6577 203d 2073 656c 662e 636c 6965  _new = self.clie
+00016860: 6e74 2e75 706c 6f61 6428 0a20 2020 2020  nt.upload(.     
+00016870: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00016880: 7665 6e74 2e6c 6f63 616c 5f70 6174 682c  vent.local_path,
+00016890: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000168a0: 2020 2020 2065 7665 6e74 2e64 6278 5f70       event.dbx_p
+000168b0: 6174 682c 0a20 2020 2020 2020 2020 2020  ath,.           
+000168c0: 2020 2020 2020 2020 2061 7574 6f72 656e           autoren
+000168d0: 616d 653d 5472 7565 2c0a 2020 2020 2020  ame=True,.      
+000168e0: 2020 2020 2020 2020 2020 2020 2020 7772                wr
+000168f0: 6974 655f 6d6f 6465 3d6d 6f64 652c 0a20  ite_mode=mode,. 
+00016900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016910: 2020 2075 7064 6174 655f 7265 763d 6c6f     update_rev=lo
+00016920: 6361 6c5f 7265 762c 0a20 2020 2020 2020  cal_rev,.       
+00016930: 2020 2020 2020 2020 2020 2020 2073 796e               syn
+00016940: 635f 6576 656e 743d 6576 656e 742c 0a20  c_event=event,. 
+00016950: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00016960: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00016970: 284e 6f74 466f 756e 6445 7272 6f72 2c20  (NotFoundError, 
+00016980: 4e6f 7441 466f 6c64 6572 4572 726f 722c  NotAFolderError,
+00016990: 2049 7341 466f 6c64 6572 4572 726f 7229   IsAFolderError)
+000169a0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+000169b0: 4e6f 7465 3a20 4e6f 7441 466f 6c64 6572  Note: NotAFolder
+000169c0: 4572 726f 7220 6361 6e20 6265 2072 6169  Error can be rai
+000169d0: 7365 6420 7768 656e 2061 2070 6172 656e  sed when a paren
+000169e0: 7420 696e 2074 6865 206c 6f63 616c 2070  t in the local p
+000169f0: 6174 680a 2020 2020 2020 2020 2020 2020  ath.            
+00016a00: 2320 7265 6665 7273 2074 6f20 6120 6669  # refers to a fi
+00016a10: 6c65 2069 6e73 7465 6164 206f 6620 6120  le instead of a 
+00016a20: 666f 6c64 6572 2e0a 2020 2020 2020 2020  folder..        
+00016a30: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00016a40: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00016a50: 2020 2020 2020 2020 2743 6f75 6c64 206e          'Could n
+00016a60: 6f74 2075 706c 6f61 6420 2225 7322 3a20  ot upload "%s": 
+00016a70: 7468 6520 6669 6c65 2064 6f65 7320 6e6f  the file does no
+00016a80: 7420 6578 6973 7427 2c20 6576 656e 742e  t exist', event.
+00016a90: 6c6f 6361 6c5f 7061 7468 0a20 2020 2020  local_path.     
+00016aa0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00016ab0: 2020 2020 2072 6574 7572 6e20 5379 6e63       return Sync
+00016ac0: 5374 6174 7573 2e53 6b69 7070 6564 0a20  Status.Skipped. 
+00016ad0: 2020 2020 2020 2065 7863 6570 7420 4461         except Da
+00016ae0: 7461 4368 616e 6765 6445 7272 6f72 3a0a  taChangedError:.
+00016af0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00016b00: 2e5f 6c6f 6767 6572 2e64 6562 7567 280a  ._logger.debug(.
+00016b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016b20: 2743 6f75 6c64 206e 6f74 2075 706c 6f61  'Could not uploa
+00016b30: 6420 2225 7322 3a20 7468 6520 6669 6c65  d "%s": the file
+00016b40: 2077 6173 206d 6f64 6966 6965 6420 6475   was modified du
+00016b50: 7269 6e67 2075 706c 6f61 6427 2c0a 2020  ring upload',.  
+00016b60: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+00016b70: 656e 742e 6c6f 6361 6c5f 7061 7468 2c0a  ent.local_path,.
+00016b80: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00016b90: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00016ba0: 2053 796e 6353 7461 7475 732e 536b 6970   SyncStatus.Skip
+00016bb0: 7065 640a 0a20 2020 2020 2020 2069 6620  ped..        if 
+00016bc0: 7365 6c66 2e5f 6861 6e64 6c65 5f75 706c  self._handle_upl
+00016bd0: 6f61 645f 636f 6e66 6c69 6374 286d 645f  oad_conflict(md_
+00016be0: 6e65 772c 2065 7665 6e74 293a 0a20 2020  new, event):.   
+00016bf0: 2020 2020 2020 2020 2073 7461 7475 7320           status 
+00016c00: 3d20 5379 6e63 5374 6174 7573 2e43 6f6e  = SyncStatus.Con
+00016c10: 666c 6963 740a 2020 2020 2020 2020 656c  flict.        el
+00016c20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00016c30: 7374 6174 7573 203d 2053 796e 6353 7461  status = SyncSta
+00016c40: 7475 732e 446f 6e65 0a20 2020 2020 2020  tus.Done.       
+00016c50: 2020 2020 2069 6620 6576 656e 742e 6368       if event.ch
+00016c60: 616e 6765 5f74 7970 6520 6973 2043 6861  ange_type is Cha
+00016c70: 6e67 6554 7970 652e 4164 6465 643a 0a20  ngeType.Added:. 
+00016c80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00016c90: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
+00016ca0: 6728 2743 7265 6174 6564 2022 2573 2220  g('Created "%s" 
+00016cb0: 6f6e 2044 726f 7062 6f78 272c 2065 7665  on Dropbox', eve
+00016cc0: 6e74 2e64 6278 5f70 6174 6829 0a20 2020  nt.dbx_path).   
+00016cd0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00016ce0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00016cf0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
+00016d00: 6728 2755 706c 6f61 6465 6420 6d6f 6469  g('Uploaded modi
+00016d10: 6669 6564 2022 2573 2220 746f 2044 726f  fied "%s" to Dro
+00016d20: 7062 6f78 272c 2065 7665 6e74 2e64 6278  pbox', event.dbx
+00016d30: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
+00016d40: 7365 6c66 2e75 7064 6174 655f 696e 6465  self.update_inde
+00016d50: 785f 6672 6f6d 5f64 6278 5f6d 6574 6164  x_from_dbx_metad
+00016d60: 6174 6128 6d64 5f6e 6577 290a 0a20 2020  ata(md_new)..   
+00016d70: 2020 2020 2072 6574 7572 6e20 7374 6174       return stat
+00016d80: 7573 0a0a 2020 2020 6465 6620 5f6f 6e5f  us..    def _on_
+00016d90: 6c6f 6361 6c5f 666f 6c64 6572 5f63 7265  local_folder_cre
+00016da0: 6174 6564 2873 656c 662c 2065 7665 6e74  ated(self, event
+00016db0: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
+00016dc0: 5379 6e63 5374 6174 7573 3a0a 2020 2020  SyncStatus:.    
+00016dd0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+00016de0: 4361 6c6c 2077 6865 6e20 6120 6c6f 6361  Call when a loca
+00016df0: 6c20 666f 6c64 6572 2069 7320 6372 6561  l folder is crea
+00016e00: 7465 642e 0a0a 2020 2020 2020 2020 3a70  ted...        :p
+00016e10: 6172 616d 2065 7665 6e74 3a20 5379 6e63  aram event: Sync
+00016e20: 4576 656e 7420 636f 7272 6573 706f 6e64  Event correspond
+00016e30: 696e 6720 746f 206c 6f63 616c 2063 7265  ing to local cre
+00016e40: 6174 6564 2065 7665 6e74 2e0a 2020 2020  ated event..    
+00016e50: 2020 2020 3a72 6574 7572 6e73 3a20 4d65      :returns: Me
+00016e60: 7461 6461 7461 2066 6f72 2063 7265 6174  tadata for creat
+00016e70: 6564 2069 7465 6d20 6f72 204e 6f6e 6520  ed item or None 
+00016e80: 6966 206e 6f20 7265 6d6f 7465 2069 7465  if no remote ite
+00016e90: 6d20 6973 2063 7265 6174 6564 2e0a 2020  m is created..  
+00016ea0: 2020 2020 2020 3a72 6169 7365 7320 4d61        :raises Ma
+00016eb0: 6573 7472 616c 4170 6945 7272 6f72 3a20  estralApiError: 
+00016ec0: 466f 7220 616e 7920 6973 7375 6573 2077  For any issues w
+00016ed0: 6865 6e20 7379 6e63 696e 6720 7468 6520  hen syncing the 
+00016ee0: 6974 656d 2e0a 2020 2020 2020 2020 2222  item..        ""
+00016ef0: 220a 2020 2020 2020 2020 6368 6563 6b5f  ".        check_
+00016f00: 6368 616e 6765 5f74 7970 6528 6576 656e  change_type(even
+00016f10: 742c 207b 4368 616e 6765 5479 7065 2e41  t, {ChangeType.A
+00016f20: 6464 6564 7d29 0a20 2020 2020 2020 2063  dded}).        c
+00016f30: 6865 636b 5f65 6e63 6f64 696e 6728 6576  heck_encoding(ev
+00016f40: 656e 742e 6c6f 6361 6c5f 7061 7468 290a  ent.local_path).
+00016f50: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00016f60: 2e5f 6861 6e64 6c65 5f73 656c 6563 7469  ._handle_selecti
+00016f70: 7665 5f73 796e 635f 636f 6e66 6c69 6374  ve_sync_conflict
+00016f80: 2865 7665 6e74 293a 0a20 2020 2020 2020  (event):.       
+00016f90: 2020 2020 2072 6574 7572 6e20 5379 6e63       return Sync
+00016fa0: 5374 6174 7573 2e43 6f6e 666c 6963 740a  Status.Conflict.
+00016fb0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00016fc0: 5f68 616e 646c 655f 6e6f 726d 616c 697a  _handle_normaliz
+00016fd0: 6174 696f 6e5f 636f 6e66 6c69 6374 2865  ation_conflict(e
+00016fe0: 7665 6e74 293a 0a20 2020 2020 2020 2020  vent):.         
+00016ff0: 2020 2072 6574 7572 6e20 5379 6e63 5374     return SyncSt
+00017000: 6174 7573 2e43 6f6e 666c 6963 740a 0a20  atus.Conflict.. 
+00017010: 2020 2020 2020 2073 656c 662e 5f77 6169         self._wai
+00017020: 745f 666f 725f 6372 6561 7469 6f6e 2865  t_for_creation(e
+00017030: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
+00017040: 0a0a 2020 2020 2020 2020 7472 793a 0a20  ..        try:. 
+00017050: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+00017060: 6c66 2e63 6c69 656e 742e 6973 5f74 6561  lf.client.is_tea
+00017070: 6d5f 7370 6163 6520 616e 6420 6576 656e  m_space and even
+00017080: 742e 6462 785f 7061 7468 2e63 6f75 6e74  t.dbx_path.count
+00017090: 2822 2f22 2920 3d3d 2031 3a0a 2020 2020  ("/") == 1:.    
+000170a0: 2020 2020 2020 2020 2020 2020 6d64 5f6e              md_n
+000170b0: 6577 203d 2073 656c 662e 636c 6965 6e74  ew = self.client
+000170c0: 2e73 6861 7265 5f64 6972 2865 7665 6e74  .share_dir(event
+000170d0: 2e64 6278 5f70 6174 6829 0a0a 2020 2020  .dbx_path)..    
+000170e0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+000170f0: 6f74 206d 645f 6e65 773a 0a20 2020 2020  ot md_new:.     
+00017100: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00017110: 2052 656d 6f74 6520 666f 6c64 6572 2068   Remote folder h
+00017120: 6173 2062 6565 6e20 6465 6c65 7465 6420  as been deleted 
+00017130: 6166 7465 7220 6372 6561 7469 6e67 2e20  after creating. 
+00017140: 5265 666c 6563 7420 6368 616e 6765 730a  Reflect changes.
+00017150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017160: 2020 2020 2320 6c6f 6361 6c6c 7920 616e      # locally an
+00017170: 6420 7265 7475 726e 2e0a 2020 2020 2020  d return..      
+00017180: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00017190: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
+000171a0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+000171b0: 2020 2020 2020 2020 2020 2722 2573 2220            '"%s" 
+000171c0: 6f6e 2044 726f 7062 6f78 2077 6173 2064  on Dropbox was d
+000171d0: 656c 6574 6564 2061 6674 6572 2063 7265  eleted after cre
+000171e0: 6174 696f 6e2c 2027 0a20 2020 2020 2020  ation, '.       
+000171f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017200: 2022 6465 6c65 7469 6e67 206c 6f63 616c   "deleting local
+00017210: 2063 6f70 7922 2c0a 2020 2020 2020 2020   copy",.        
+00017220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017230: 6576 656e 742e 6462 785f 7061 7468 2c0a  event.dbx_path,.
+00017240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017250: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
+00017260: 2020 2020 2020 2020 2020 6572 7220 3d20            err = 
+00017270: 6465 6c65 7465 280a 2020 2020 2020 2020  delete(.        
+00017280: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017290: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+000172a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+000172b0: 2020 2020 2020 2020 2020 666f 7263 655f            force_
+000172c0: 6361 7365 5f73 656e 7369 7469 7665 3d6e  case_sensitive=n
+000172d0: 6f74 2073 656c 662e 6973 5f66 735f 6361  ot self.is_fs_ca
+000172e0: 7365 5f73 656e 7369 7469 7665 2c0a 2020  se_sensitive,.  
+000172f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017300: 2020 290a 0a20 2020 2020 2020 2020 2020    )..           
+00017310: 2020 2020 2020 2020 2069 6620 6572 723a           if err:
+00017320: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00017330: 2020 2020 2020 2020 2072 6169 7365 206f           raise o
+00017340: 735f 746f 5f6d 6165 7374 7261 6c5f 6572  s_to_maestral_er
+00017350: 726f 7228 6572 7229 0a0a 2020 2020 2020  ror(err)..      
+00017360: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00017370: 7475 726e 2053 796e 6353 7461 7475 732e  turn SyncStatus.
+00017380: 536b 6970 7065 640a 2020 2020 2020 2020  Skipped.        
+00017390: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+000173a0: 2020 2020 2020 2020 2020 6d64 5f6e 6577            md_new
+000173b0: 203d 2073 656c 662e 636c 6965 6e74 2e6d   = self.client.m
+000173c0: 616b 655f 6469 7228 6576 656e 742e 6462  ake_dir(event.db
+000173d0: 785f 7061 7468 2c20 6175 746f 7265 6e61  x_path, autorena
+000173e0: 6d65 3d46 616c 7365 290a 2020 2020 2020  me=False).      
+000173f0: 2020 6578 6365 7074 2046 6f6c 6465 7243    except FolderC
+00017400: 6f6e 666c 6963 7445 7272 6f72 3a0a 2020  onflictError:.  
+00017410: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+00017420: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
+00017430: 2020 2020 2020 2020 2020 2020 2020 274e                'N
+00017440: 6f20 636f 6e66 6c69 6374 2066 6f72 2022  o conflict for "
+00017450: 2573 223a 2074 6865 2066 6f6c 6465 7220  %s": the folder 
+00017460: 616c 7265 6164 7920 6578 6973 7473 272c  already exists',
+00017470: 2065 7665 6e74 2e6c 6f63 616c 5f70 6174   event.local_pat
+00017480: 680a 2020 2020 2020 2020 2020 2020 290a  h.            ).
+00017490: 2020 2020 2020 2020 2020 2020 7472 793a              try:
+000174a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000174b0: 206d 6420 3d20 7365 6c66 2e63 6c69 656e   md = self.clien
+000174c0: 742e 6765 745f 6d65 7461 6461 7461 2865  t.get_metadata(e
+000174d0: 7665 6e74 2e64 6278 5f70 6174 6829 0a20  vent.dbx_path). 
+000174e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000174f0: 6620 6973 696e 7374 616e 6365 286d 642c  f isinstance(md,
+00017500: 2046 6f6c 6465 724d 6574 6164 6174 6129   FolderMetadata)
+00017510: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00017520: 2020 2020 2020 7365 6c66 2e75 7064 6174        self.updat
+00017530: 655f 696e 6465 785f 6672 6f6d 5f64 6278  e_index_from_dbx
+00017540: 5f6d 6574 6164 6174 6128 6d64 290a 2020  _metadata(md).  
+00017550: 2020 2020 2020 2020 2020 6578 6365 7074            except
+00017560: 204e 6f74 466f 756e 6445 7272 6f72 3a0a   NotFoundError:.
+00017570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017580: 7061 7373 0a0a 2020 2020 2020 2020 2020  pass..          
+00017590: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
+000175a0: 7475 732e 536b 6970 7065 640a 2020 2020  tus.Skipped.    
+000175b0: 2020 2020 6578 6365 7074 2046 696c 6543      except FileC
+000175c0: 6f6e 666c 6963 7445 7272 6f72 3a0a 2020  onflictError:.  
+000175d0: 2020 2020 2020 2020 2020 6d64 5f6e 6577            md_new
+000175e0: 203d 2073 656c 662e 636c 6965 6e74 2e6d   = self.client.m
+000175f0: 616b 655f 6469 7228 6576 656e 742e 6462  ake_dir(event.db
+00017600: 785f 7061 7468 2c20 6175 746f 7265 6e61  x_path, autorena
+00017610: 6d65 3d54 7275 6529 0a0a 2020 2020 2020  me=True)..      
+00017620: 2020 6966 2073 656c 662e 5f68 616e 646c    if self._handl
+00017630: 655f 7570 6c6f 6164 5f63 6f6e 666c 6963  e_upload_conflic
+00017640: 7428 6d64 5f6e 6577 2c20 6576 656e 7429  t(md_new, event)
+00017650: 3a0a 2020 2020 2020 2020 2020 2020 7374  :.            st
+00017660: 6174 7573 203d 2053 796e 6353 7461 7475  atus = SyncStatu
+00017670: 732e 436f 6e66 6c69 6374 0a20 2020 2020  s.Conflict.     
+00017680: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00017690: 2020 2020 2073 7461 7475 7320 3d20 5379       status = Sy
+000176a0: 6e63 5374 6174 7573 2e44 6f6e 650a 2020  ncStatus.Done.  
+000176b0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+000176c0: 6c6f 6767 6572 2e64 6562 7567 2827 4372  logger.debug('Cr
+000176d0: 6561 7465 6420 2225 7322 206f 6e20 4472  eated "%s" on Dr
+000176e0: 6f70 626f 7827 2c20 6576 656e 742e 6462  opbox', event.db
+000176f0: 785f 7061 7468 290a 0a20 2020 2020 2020  x_path)..       
+00017700: 2073 656c 662e 7570 6461 7465 5f69 6e64   self.update_ind
+00017710: 6578 5f66 726f 6d5f 6462 785f 6d65 7461  ex_from_dbx_meta
+00017720: 6461 7461 286d 645f 6e65 7729 0a0a 2020  data(md_new)..  
+00017730: 2020 2020 2020 7265 7475 726e 2073 7461        return sta
+00017740: 7475 730a 0a20 2020 2064 6566 205f 6f6e  tus..    def _on
+00017750: 5f6c 6f63 616c 5f64 656c 6574 6564 2873  _local_deleted(s
+00017760: 656c 662c 2065 7665 6e74 3a20 5379 6e63  elf, event: Sync
+00017770: 4576 656e 7429 202d 3e20 5379 6e63 5374  Event) -> SyncSt
+00017780: 6174 7573 3a0a 2020 2020 2020 2020 2222  atus:.        ""
+00017790: 220a 2020 2020 2020 2020 4361 6c6c 2077  ".        Call w
+000177a0: 6865 6e20 6120 6c6f 6361 6c20 6974 656d  hen a local item
+000177b0: 2069 7320 6465 6c65 7465 642e 2057 6520   is deleted. We 
+000177c0: 7472 7920 6e6f 7420 746f 2064 656c 6574  try not to delet
+000177d0: 6520 7265 6d6f 7465 2069 7465 6d73 2077  e remote items w
+000177e0: 6869 6368 2068 6176 650a 2020 2020 2020  hich have.      
+000177f0: 2020 6265 656e 206d 6f64 6966 6965 6420    been modified 
+00017800: 7369 6e63 6520 7468 6520 6c61 7374 2073  since the last s
+00017810: 796e 632e 0a0a 2020 2020 2020 2020 3a70  ync...        :p
+00017820: 6172 616d 2065 7665 6e74 3a20 5379 6e63  aram event: Sync
+00017830: 4576 656e 7420 666f 7220 6c6f 6361 6c20  Event for local 
+00017840: 6465 6c65 7469 6f6e 2e0a 2020 2020 2020  deletion..      
+00017850: 2020 3a72 6574 7572 6e73 3a20 4d65 7461    :returns: Meta
+00017860: 6461 7461 2066 6f72 2064 656c 6574 6564  data for deleted
+00017870: 2069 7465 6d20 6f72 204e 6f6e 6520 6966   item or None if
+00017880: 206e 6f20 7265 6d6f 7465 2069 7465 6d20   no remote item 
+00017890: 6973 2064 656c 6574 6564 2e0a 2020 2020  is deleted..    
+000178a0: 2020 2020 3a72 6169 7365 7320 4d61 6573      :raises Maes
+000178b0: 7472 616c 4170 6945 7272 6f72 3a20 466f  tralApiError: Fo
+000178c0: 7220 616e 7920 6973 7375 6573 2077 6865  r any issues whe
+000178d0: 6e20 7379 6e63 696e 6720 7468 6520 6974  n syncing the it
+000178e0: 656d 2e0a 2020 2020 2020 2020 2222 220a  em..        """.
+000178f0: 2020 2020 2020 2020 6368 6563 6b5f 6368          check_ch
+00017900: 616e 6765 5f74 7970 6528 6576 656e 742c  ange_type(event,
+00017910: 207b 4368 616e 6765 5479 7065 2e52 656d   {ChangeType.Rem
+00017920: 6f76 6564 7d29 0a20 2020 2020 2020 2074  oved}).        t
+00017930: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+00017940: 6368 6563 6b5f 656e 636f 6469 6e67 2865  check_encoding(e
+00017950: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
+00017960: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
+00017970: 5061 7468 4572 726f 723a 0a20 2020 2020  PathError:.     
+00017980: 2020 2020 2020 2023 2044 6f6e 2774 2072         # Don't r
+00017990: 6169 7365 2061 6e20 6572 726f 7220 6865  aise an error he
+000179a0: 7265 2062 6563 6175 7365 2074 6865 2066  re because the f
+000179b0: 696c 6520 6361 6e6e 6f74 2065 7869 7374  ile cannot exist
+000179c0: 206f 6e20 7468 6520 7365 7276 6572 2e0a   on the server..
+000179d0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000179e0: 2e5f 6c6f 6767 6572 2e64 6562 7567 280a  ._logger.debug(.
+000179f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a00: 2743 6f75 6c64 206e 6f74 2064 656c 6574  'Could not delet
+00017a10: 6520 2225 7322 3a20 7468 6520 6974 656d  e "%s": the item
+00017a20: 2064 6f65 7320 6e6f 7420 6578 6973 7420   does not exist 
+00017a30: 6f6e 2044 726f 7062 6f78 272c 0a20 2020  on Dropbox',.   
+00017a40: 2020 2020 2020 2020 2020 2020 2065 7665               eve
+00017a50: 6e74 2e64 6278 5f70 6174 682c 0a20 2020  nt.dbx_path,.   
+00017a60: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
+00017a70: 2020 2020 2020 2072 6574 7572 6e20 5379         return Sy
+00017a80: 6e63 5374 6174 7573 2e53 6b69 7070 6564  ncStatus.Skipped
+00017a90: 0a0a 2020 2020 2020 2020 2320 5765 2069  ..        # We i
+00017aa0: 6e74 6572 6365 7074 2061 6e79 2061 7474  ntercept any att
+00017ab0: 656d 7074 7320 746f 2064 656c 6574 6520  empts to delete 
+00017ac0: 7468 6520 686f 6d65 2066 6f6c 6465 7220  the home folder 
+00017ad0: 6865 7265 2069 6e73 7465 6164 206f 6620  here instead of 
+00017ae0: 7761 6974 696e 670a 2020 2020 2020 2020  waiting.        
+00017af0: 2320 666f 7220 616e 2065 7272 6f72 2066  # for an error f
+00017b00: 726f 6d20 7468 6520 4472 6f70 626f 7820  rom the Dropbox 
+00017b10: 4150 492e 2054 6869 7320 616c 6c6f 7773  API. This allows
+00017b20: 2075 7320 746f 2070 726f 7669 6465 2061   us to provide a
+00017b30: 2062 6574 7465 7220 6572 726f 720a 2020   better error.  
+00017b40: 2020 2020 2020 2320 6d65 7373 6167 652e        # message.
+00017b50: 0a0a 2020 2020 2020 2020 686f 6d65 5f70  ..        home_p
+00017b60: 6174 6820 3d20 7365 6c66 2e5f 7374 6174  ath = self._stat
+00017b70: 652e 6765 7428 2261 6363 6f75 6e74 222c  e.get("account",
+00017b80: 2022 686f 6d65 5f70 6174 6822 290a 0a20   "home_path").. 
+00017b90: 2020 2020 2020 2069 6620 6576 656e 742e         if event.
+00017ba0: 6462 785f 7061 7468 203d 3d20 686f 6d65  dbx_path == home
+00017bb0: 5f70 6174 683a 0a20 2020 2020 2020 2020  _path:.         
+00017bc0: 2020 2072 6169 7365 2053 796e 6345 7272     raise SyncErr
+00017bd0: 6f72 280a 2020 2020 2020 2020 2020 2020  or(.            
+00017be0: 2020 2020 7469 746c 653d 2243 6f75 6c64      title="Could
+00017bf0: 206e 6f74 2064 656c 6574 6520 6974 656d   not delete item
+00017c00: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00017c10: 2020 206d 6573 7361 6765 3d22 4361 6e6e     message="Cann
+00017c20: 6f74 2064 656c 6574 6520 7468 6520 7573  ot delete the us
+00017c30: 6572 2773 2068 6f6d 6520 666f 6c64 6572  er's home folder
+00017c40: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00017c50: 2020 2064 6278 5f70 6174 683d 6576 656e     dbx_path=even
+00017c60: 742e 6462 785f 7061 7468 2c0a 2020 2020  t.dbx_path,.    
+00017c70: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+00017c80: 6c5f 7061 7468 3d65 7665 6e74 2e6c 6f63  l_path=event.loc
+00017c90: 616c 5f70 6174 682c 0a20 2020 2020 2020  al_path,.       
+00017ca0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
+00017cb0: 6966 2065 7665 6e74 2e6c 6f63 616c 5f70  if event.local_p
+00017cc0: 6174 6820 3d3d 2073 656c 662e 6472 6f70  ath == self.drop
+00017cd0: 626f 785f 7061 7468 3a0a 2020 2020 2020  box_path:.      
+00017ce0: 2020 2020 2020 7365 6c66 2e65 6e73 7572        self.ensur
+00017cf0: 655f 6472 6f70 626f 785f 666f 6c64 6572  e_dropbox_folder
+00017d00: 5f70 7265 7365 6e74 2829 0a0a 2020 2020  _present()..    
+00017d10: 2020 2020 6966 2073 656c 662e 6973 5f65      if self.is_e
+00017d20: 7863 6c75 6465 645f 6279 5f75 7365 7228  xcluded_by_user(
+00017d30: 6576 656e 742e 6462 785f 7061 7468 5f6c  event.dbx_path_l
+00017d40: 6f77 6572 293a 0a20 2020 2020 2020 2020  ower):.         
+00017d50: 2020 2073 656c 662e 5f6c 6f67 6765 722e     self._logger.
+00017d60: 6465 6275 6728 0a20 2020 2020 2020 2020  debug(.         
+00017d70: 2020 2020 2020 2027 4e6f 7420 6465 6c65         'Not dele
+00017d80: 7469 6e67 2022 2573 223a 2069 7320 6578  ting "%s": is ex
+00017d90: 636c 7564 6564 2062 7920 7365 6c65 6374  cluded by select
+00017da0: 6976 6520 7379 6e63 272c 2065 7665 6e74  ive sync', event
+00017db0: 2e64 6278 5f70 6174 680a 2020 2020 2020  .dbx_path.      
+00017dc0: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00017dd0: 2020 2020 7265 7475 726e 2053 796e 6353      return SyncS
+00017de0: 7461 7475 732e 536b 6970 7065 640a 0a20  tatus.Skipped.. 
+00017df0: 2020 2020 2020 206c 6f63 616c 5f72 6576         local_rev
+00017e00: 203d 2073 656c 662e 6765 745f 6c6f 6361   = self.get_loca
+00017e10: 6c5f 7265 7628 6576 656e 742e 6462 785f  l_rev(event.dbx_
+00017e20: 7061 7468 5f6c 6f77 6572 290a 0a20 2020  path_lower)..   
+00017e30: 2020 2020 206d 6420 3d20 7365 6c66 2e63       md = self.c
+00017e40: 6c69 656e 742e 6765 745f 6d65 7461 6461  lient.get_metada
+00017e50: 7461 2865 7665 6e74 2e64 6278 5f70 6174  ta(event.dbx_pat
+00017e60: 682c 2069 6e63 6c75 6465 5f64 656c 6574  h, include_delet
+00017e70: 6564 3d54 7275 6529 0a0a 2020 2020 2020  ed=True)..      
+00017e80: 2020 6966 206e 6f74 206d 643a 0a20 2020    if not md:.   
+00017e90: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+00017ea0: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
+00017eb0: 2020 2020 2020 2020 2020 2020 2027 436f               'Co
+00017ec0: 756c 6420 6e6f 7420 6465 6c65 7465 2022  uld not delete "
+00017ed0: 2573 223a 2074 6865 2069 7465 6d20 646f  %s": the item do
+00017ee0: 6573 206e 6f74 2065 7869 7374 206f 6e20  es not exist on 
+00017ef0: 4472 6f70 626f 7827 2c0a 2020 2020 2020  Dropbox',.      
+00017f00: 2020 2020 2020 2020 2020 6576 656e 742e            event.
+00017f10: 6462 785f 7061 7468 2c0a 2020 2020 2020  dbx_path,.      
+00017f20: 2020 2020 2020 290a 2020 2020 2020 2020        ).        
+00017f30: 2020 2020 7265 7475 726e 2053 796e 6353      return SyncS
+00017f40: 7461 7475 732e 536b 6970 7065 640a 0a20  tatus.Skipped.. 
+00017f50: 2020 2020 2020 2069 6620 6576 656e 742e         if event.
+00017f60: 6973 5f64 6972 6563 746f 7279 2061 6e64  is_directory and
+00017f70: 2069 7369 6e73 7461 6e63 6528 6d64 2c20   isinstance(md, 
+00017f80: 4669 6c65 4d65 7461 6461 7461 293a 0a20  FileMetadata):. 
+00017f90: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00017fa0: 5f6c 6f67 6765 722e 6465 6275 6728 0a20  _logger.debug(. 
+00017fb0: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00017fc0: 4578 7065 6374 6564 2066 6f6c 6465 7220  Expected folder 
+00017fd0: 6174 2022 2573 2220 6275 7420 666f 756e  at "%s" but foun
+00017fe0: 6420 6120 6669 6c65 2069 6e73 7465 6164  d a file instead
+00017ff0: 2c20 6368 6563 6b69 6e67 2027 0a20 2020  , checking '.   
+00018000: 2020 2020 2020 2020 2020 2020 2022 7768               "wh
+00018010: 6963 6820 6f6e 6520 6973 206e 6577 6572  ich one is newer
+00018020: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+00018030: 2020 206d 642e 7061 7468 5f64 6973 706c     md.path_displ
+00018040: 6179 2c0a 2020 2020 2020 2020 2020 2020  ay,.            
+00018050: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
+00018060: 446f 6e27 7420 6465 6c65 7465 2061 2072  Don't delete a r
+00018070: 656d 6f74 6520 6669 6c65 2069 6620 6974  emote file if it
+00018080: 2077 6173 206d 6f64 6966 6965 6420 7369   was modified si
+00018090: 6e63 6520 6c61 7374 2073 796e 632e 0a20  nce last sync.. 
+000180a0: 2020 2020 2020 2020 2020 2069 6620 6d64             if md
+000180b0: 2e73 6572 7665 725f 6d6f 6469 6669 6564  .server_modified
+000180c0: 2e74 696d 6573 7461 6d70 2829 203e 3d20  .timestamp() >= 
+000180d0: 7365 6c66 2e67 6574 5f6c 6173 745f 7379  self.get_last_sy
+000180e0: 6e63 280a 2020 2020 2020 2020 2020 2020  nc(.            
+000180f0: 2020 2020 6576 656e 742e 6462 785f 7061      event.dbx_pa
+00018100: 7468 5f6c 6f77 6572 0a20 2020 2020 2020  th_lower.       
+00018110: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+00018120: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00018130: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
+00018140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018150: 2753 6b69 7070 696e 6720 6465 6c65 7469  'Skipping deleti
+00018160: 6f6e 3a20 7265 6d6f 7465 2069 7465 6d20  on: remote item 
+00018170: 2225 7322 2068 6173 2062 6565 6e20 6d6f  "%s" has been mo
+00018180: 6469 6669 6564 2027 0a20 2020 2020 2020  dified '.       
+00018190: 2020 2020 2020 2020 2020 2020 2022 7369               "si
+000181a0: 6e63 6520 6c61 7374 2073 796e 6322 2c0a  nce last sync",.
+000181b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000181c0: 2020 2020 6d64 2e70 6174 685f 6469 7370      md.path_disp
+000181d0: 6c61 792c 0a20 2020 2020 2020 2020 2020  lay,.           
+000181e0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+000181f0: 2020 2020 2020 2023 204d 6172 6b20 6c6f         # Mark lo
+00018200: 6361 6c20 666f 6c64 6572 2061 7320 756e  cal folder as un
+00018210: 7472 6163 6b65 642e 0a20 2020 2020 2020  tracked..       
+00018220: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
+00018230: 6d6f 7665 5f6e 6f64 655f 6672 6f6d 5f69  move_node_from_i
+00018240: 6e64 6578 2865 7665 6e74 2e64 6278 5f70  ndex(event.dbx_p
+00018250: 6174 685f 6c6f 7765 7229 0a0a 2020 2020  ath_lower)..    
+00018260: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+00018270: 726e 2053 796e 6353 7461 7475 732e 536b  rn SyncStatus.Sk
+00018280: 6970 7065 640a 0a20 2020 2020 2020 2069  ipped..        i
+00018290: 6620 6576 656e 742e 6973 5f66 696c 6520  f event.is_file 
+000182a0: 616e 6420 6973 696e 7374 616e 6365 286d  and isinstance(m
+000182b0: 642c 2046 6f6c 6465 724d 6574 6164 6174  d, FolderMetadat
+000182c0: 6129 3a0a 2020 2020 2020 2020 2020 2020  a):.            
+000182d0: 2320 446f 6e27 7420 6465 6c65 7465 2061  # Don't delete a
+000182e0: 2072 656d 6f74 6520 666f 6c64 6572 2069   remote folder i
+000182f0: 6620 7765 2077 6572 6520 6578 7065 6374  f we were expect
+00018300: 696e 6720 6120 6669 6c65 2e0a 2020 2020  ing a file..    
+00018310: 2020 2020 2020 2020 2320 544f 444f 3a20          # TODO: 
+00018320: 4465 6c65 7465 2074 6865 2066 6f6c 6465  Delete the folde
+00018330: 7220 6966 2069 7473 2063 6869 6c64 7265  r if its childre
+00018340: 6e20 6469 6420 6e6f 7420 6368 616e 6765  n did not change
+00018350: 2073 696e 6365 206c 6173 7420 7379 6e63   since last sync
+00018360: 2e0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
+00018370: 2020 4973 2074 6865 7265 2061 2077 6179    Is there a way
+00018380: 206f 6620 6163 6869 6576 696e 6720 7468   of achieving th
+00018390: 6973 2077 6974 686f 7574 206c 6973 7469  is without listi
+000183a0: 6e67 2074 6865 2066 6f6c 6465 7220 6f72  ng the folder or
+000183b0: 206c 6973 7469 6e67 0a20 2020 2020 2020   listing.       
+000183c0: 2020 2020 2023 2020 2061 6c6c 2063 6861       #   all cha
+000183d0: 6e67 6573 2061 6e64 2063 6865 636b 696e  nges and checkin
+000183e0: 6720 7768 656e 2074 6865 7920 6f63 6375  g when they occu
+000183f0: 7272 6564 3f0a 2020 2020 2020 2020 2020  rred?.          
+00018400: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
+00018410: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+00018420: 2020 2020 2020 2753 6b69 7070 696e 6720        'Skipping 
+00018430: 6465 6c65 7469 6f6e 3a20 6578 7065 6374  deletion: expect
+00018440: 6564 2066 696c 6520 6174 2022 2573 2220  ed file at "%s" 
+00018450: 6275 7420 666f 756e 6420 6120 270a 2020  but found a '.  
+00018460: 2020 2020 2020 2020 2020 2020 2020 2266                "f
+00018470: 6f6c 6465 7220 696e 7374 6561 6422 2c0a  older instead",.
+00018480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018490: 6d64 2e70 6174 685f 6469 7370 6c61 792c  md.path_display,
+000184a0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+000184b0: 2020 2020 2020 2020 2020 2023 204d 6172             # Mar
+000184c0: 6b20 6c6f 6361 6c20 6669 6c65 2061 7320  k local file as 
+000184d0: 756e 7472 6163 6b65 642e 0a20 2020 2020  untracked..     
+000184e0: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
+000184f0: 7665 5f6e 6f64 655f 6672 6f6d 5f69 6e64  ve_node_from_ind
+00018500: 6578 2865 7665 6e74 2e64 6278 5f70 6174  ex(event.dbx_pat
+00018510: 685f 6c6f 7765 7229 0a0a 2020 2020 2020  h_lower)..      
+00018520: 2020 2020 2020 7265 7475 726e 2053 796e        return Syn
+00018530: 6353 7461 7475 732e 536b 6970 7065 640a  cStatus.Skipped.
+00018540: 0a20 2020 2020 2020 2074 7279 3a0a 2020  .        try:.  
+00018550: 2020 2020 2020 2020 2020 2320 5769 6c6c            # Will
+00018560: 206f 6e6c 7920 7065 7266 6f72 6d20 6465   only perform de
+00018570: 6c65 7465 2069 6620 4472 6f70 626f 7820  lete if Dropbox 
+00018580: 7265 6d6f 7465 2072 6576 206d 6174 6368  remote rev match
+00018590: 6573 2060 6c6f 6361 6c5f 7265 7660 2e0a  es `local_rev`..
+000185a0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+000185b0: 2e63 6c69 656e 742e 7265 6d6f 7665 280a  .client.remove(.
+000185c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000185d0: 6576 656e 742e 6462 785f 7061 7468 2c20  event.dbx_path, 
+000185e0: 7061 7265 6e74 5f72 6576 3d6c 6f63 616c  parent_rev=local
+000185f0: 5f72 6576 2069 6620 6576 656e 742e 6973  _rev if event.is
+00018600: 5f66 696c 6520 656c 7365 204e 6f6e 650a  _file else None.
+00018610: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00018620: 2020 2020 2020 2020 2020 7374 6174 7573            status
+00018630: 203d 2053 796e 6353 7461 7475 732e 446f   = SyncStatus.Do
+00018640: 6e65 0a20 2020 2020 2020 2065 7863 6570  ne.        excep
+00018650: 7420 4e6f 7446 6f75 6e64 4572 726f 723a  t NotFoundError:
+00018660: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00018670: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
+00018680: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018690: 2027 436f 756c 6420 6e6f 7420 6465 6c65   'Could not dele
+000186a0: 7465 2022 2573 223a 2074 6865 2069 7465  te "%s": the ite
+000186b0: 6d20 6e6f 206c 6f6e 6765 7220 6578 6973  m no longer exis
+000186c0: 7473 206f 6e20 4472 6f70 626f 7827 2c0a  ts on Dropbox',.
+000186d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000186e0: 6576 656e 742e 6462 785f 7061 7468 2c0a  event.dbx_path,.
+000186f0: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00018700: 2020 2020 2020 2020 2020 7374 6174 7573            status
+00018710: 203d 2053 796e 6353 7461 7475 732e 536b   = SyncStatus.Sk
+00018720: 6970 7065 640a 2020 2020 2020 2020 6578  ipped.        ex
+00018730: 6365 7074 2050 6174 6845 7272 6f72 3a0a  cept PathError:.
+00018740: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00018750: 2e5f 6c6f 6767 6572 2e64 6562 7567 280a  ._logger.debug(.
+00018760: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018770: 2743 6f75 6c64 206e 6f74 2064 656c 6574  'Could not delet
+00018780: 6520 2225 7322 3a20 7468 6520 6974 656d  e "%s": the item
+00018790: 2068 6173 2062 6565 6e20 6368 616e 6765   has been change
+000187a0: 6420 7369 6e63 6520 6c61 7374 2073 796e  d since last syn
+000187b0: 6327 2c0a 2020 2020 2020 2020 2020 2020  c',.            
+000187c0: 2020 2020 6576 656e 742e 6462 785f 7061      event.dbx_pa
+000187d0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
+000187e0: 290a 2020 2020 2020 2020 2020 2020 7374  ).            st
+000187f0: 6174 7573 203d 2053 796e 6353 7461 7475  atus = SyncStatu
+00018800: 732e 536b 6970 7065 640a 0a20 2020 2020  s.Skipped..     
+00018810: 2020 2023 2052 656d 6f76 6520 7265 7669     # Remove revi
+00018820: 7369 6f6e 206d 6574 6164 6174 612e 0a20  sion metadata.. 
+00018830: 2020 2020 2020 2073 656c 662e 7265 6d6f         self.remo
+00018840: 7665 5f6e 6f64 655f 6672 6f6d 5f69 6e64  ve_node_from_ind
+00018850: 6578 2865 7665 6e74 2e64 6278 5f70 6174  ex(event.dbx_pat
+00018860: 685f 6c6f 7765 7229 0a0a 2020 2020 2020  h_lower)..      
+00018870: 2020 7265 7475 726e 2073 7461 7475 730a    return status.
+00018880: 0a20 2020 2064 6566 205f 6861 6e64 6c65  .    def _handle
+00018890: 5f75 706c 6f61 645f 636f 6e66 6c69 6374  _upload_conflict
+000188a0: 2873 656c 662c 206d 645f 6e65 773a 204d  (self, md_new: M
+000188b0: 6574 6164 6174 612c 2065 7665 6e74 3a20  etadata, event: 
+000188c0: 5379 6e63 4576 656e 7429 202d 3e20 626f  SyncEvent) -> bo
+000188d0: 6f6c 3a0a 2020 2020 2020 2020 2222 220a  ol:.        """.
+000188e0: 2020 2020 2020 2020 4966 2061 2063 6f6e          If a con
+000188f0: 666c 6963 7469 6e67 2063 6f70 7920 7761  flicting copy wa
+00018900: 7320 6372 6561 7465 6420 6279 2044 726f  s created by Dro
+00018910: 7062 6f78 2064 7572 696e 6720 7468 6520  pbox during the 
+00018920: 7570 6c6f 6164 2c20 7765 206d 6972 726f  upload, we mirro
+00018930: 7220 7468 650a 2020 2020 2020 2020 7265  r the.        re
+00018940: 6d6f 7465 2063 6861 6e67 6573 206c 6f63  mote changes loc
+00018950: 616c 6c79 2e20 5468 6973 206d 6574 686f  ally. This metho
+00018960: 6420 6361 6e20 6f6e 6c79 2062 6520 7573  d can only be us
+00018970: 6564 2066 6f72 2061 6464 6564 2c20 6368  ed for added, ch
+00018980: 616e 6765 6420 616e 640a 2020 2020 2020  anged and.      
+00018990: 2020 6d6f 7665 6420 6576 656e 7473 2e0a    moved events..
+000189a0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+000189b0: 6d64 5f6e 6577 3a20 4d65 7461 6461 7461  md_new: Metadata
+000189c0: 206f 6620 6974 656d 2061 6674 6572 2075   of item after u
+000189d0: 706c 6f61 642e 0a20 2020 2020 2020 203a  pload..        :
+000189e0: 7061 7261 6d20 6576 656e 743a 204f 7269  param event: Ori
+000189f0: 6769 6e61 6c20 7570 6c6f 6164 2073 796e  ginal upload syn
+00018a00: 6320 6576 656e 7420 7768 6963 6820 7472  c event which tr
+00018a10: 6967 6765 7265 6420 7468 6520 7570 6c6f  iggered the uplo
+00018a20: 6164 2e0a 2020 2020 2020 2020 3a72 6574  ad..        :ret
+00018a30: 7572 6e73 3a20 5768 6574 6865 7220 6120  urns: Whether a 
+00018a40: 636f 6e66 6c69 6374 696e 6720 636f 7079  conflicting copy
+00018a50: 2077 6173 2063 7265 6174 6564 2e0a 2020   was created..  
+00018a60: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00018a70: 2020 6966 2065 7665 6e74 2e69 735f 6465    if event.is_de
+00018a80: 6c65 7465 643a 0a20 2020 2020 2020 2020  leted:.         
+00018a90: 2020 2072 6169 7365 2056 616c 7565 4572     raise ValueEr
+00018aa0: 726f 7228 2243 616e 6e6f 7420 7072 6f63  ror("Cannot proc
+00018ab0: 6573 7320 6465 6c65 7465 6420 6576 656e  ess deleted even
+00018ac0: 742e 2229 0a0a 2020 2020 2020 2020 6966  t.")..        if
+00018ad0: 2073 656c 662e 6973 5f66 735f 6361 7365   self.is_fs_case
+00018ae0: 5f73 656e 7369 7469 7665 3a0a 2020 2020  _sensitive:.    
+00018af0: 2020 2020 2020 2020 2320 436f 6d70 6172          # Compar
+00018b00: 6520 756e 2d6e 6f72 6d61 6c69 7a65 6420  e un-normalized 
+00018b10: 6669 6c65 206e 616d 6573 2e20 5468 6973  file names. This
+00018b20: 2065 6e73 7572 6573 2074 6861 7420 7765   ensures that we
+00018b30: 206d 6972 726f 7220 6c6f 6361 6c6c 7920   mirror locally 
+00018b40: 616e 790a 2020 2020 2020 2020 2020 2020  any.            
+00018b50: 2320 756e 6963 6f64 6520 6f72 2063 6173  # unicode or cas
+00018b60: 6520 6e6f 726d 616c 697a 6174 696f 6e20  e normalization 
+00018b70: 7065 7266 6f72 6d65 6420 6279 2044 726f  performed by Dro
+00018b80: 7062 6f78 2073 6572 7665 7273 2e0a 2020  pbox servers..  
+00018b90: 2020 2020 2020 2020 2020 6966 206d 645f            if md_
+00018ba0: 6e65 772e 6e61 6d65 203d 3d20 6f73 702e  new.name == osp.
+00018bb0: 6261 7365 6e61 6d65 2865 7665 6e74 2e6c  basename(event.l
+00018bc0: 6f63 616c 5f70 6174 6829 3a0a 2020 2020  ocal_path):.    
+00018bd0: 2020 2020 2020 2020 2020 2020 2320 4e6f              # No
+00018be0: 2063 6f6e 666c 6963 7469 6e67 2063 6f70   conflicting cop
+00018bf0: 7920 7761 7320 6372 6561 7465 642e 0a20  y was created.. 
+00018c00: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+00018c10: 6574 7572 6e20 4661 6c73 650a 2020 2020  eturn False.    
+00018c20: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00018c30: 2020 2020 2020 2320 436f 6d70 6172 6520        # Compare 
+00018c40: 6e6f 726d 616c 697a 6564 2070 6174 6873  normalized paths
+00018c50: 2e20 4d69 7272 6f72 696e 6720 616e 7920  . Mirroring any 
+00018c60: 6e6f 726d 616c 697a 6174 696f 6e20 6368  normalization ch
+00018c70: 616e 6765 7320 6c6f 6361 6c6c 7920 6973  anges locally is
+00018c80: 0a20 2020 2020 2020 2020 2020 2023 206e  .            # n
+00018c90: 6f74 2072 6571 7569 7265 6420 6f6e 206e  ot required on n
+00018ca0: 6f72 6d61 6c69 7369 6e67 2066 696c 6520  ormalising file 
+00018cb0: 7379 7374 656d 732e 0a20 2020 2020 2020  systems..       
+00018cc0: 2020 2020 2069 6620 6d64 5f6e 6577 2e70       if md_new.p
+00018cd0: 6174 685f 6c6f 7765 7220 3d3d 2065 7665  ath_lower == eve
+00018ce0: 6e74 2e64 6278 5f70 6174 685f 6c6f 7765  nt.dbx_path_lowe
+00018cf0: 723a 0a20 2020 2020 2020 2020 2020 2020  r:.             
+00018d00: 2020 2023 204e 6f20 636f 6e66 6c69 6374     # No conflict
+00018d10: 696e 6720 636f 7079 2077 6173 2063 7265  ing copy was cre
+00018d20: 6174 6564 2e0a 2020 2020 2020 2020 2020  ated..          
+00018d30: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
+00018d40: 7365 0a0a 2020 2020 2020 2020 2320 4765  se..        # Ge
+00018d50: 7420 6e65 7720 6c6f 6361 6c20 7061 7468  t new local path
+00018d60: 2063 6f72 7265 7370 6f6e 6469 6e67 2074   corresponding t
+00018d70: 6f20 6372 6561 7465 6420 656e 7472 792e  o created entry.
+00018d80: 0a20 2020 2020 2020 206c 6f63 616c 5f70  .        local_p
+00018d90: 6174 685f 6363 203d 2073 656c 662e 746f  ath_cc = self.to
+00018da0: 5f6c 6f63 616c 5f70 6174 6828 6d64 5f6e  _local_path(md_n
+00018db0: 6577 2e70 6174 685f 6469 7370 6c61 7929  ew.path_display)
+00018dc0: 0a0a 2020 2020 2020 2020 2320 4d6f 7665  ..        # Move
+00018dd0: 2074 6865 206c 6f63 616c 2069 7465 6d2e   the local item.
+00018de0: 0a20 2020 2020 2020 2065 7665 6e74 5f63  .        event_c
+00018df0: 6c73 203d 2044 6972 4d6f 7665 6445 7665  ls = DirMovedEve
+00018e00: 6e74 2069 6620 6973 6469 7228 6576 656e  nt if isdir(even
+00018e10: 742e 6c6f 6361 6c5f 7061 7468 2920 656c  t.local_path) el
+00018e20: 7365 2046 696c 654d 6f76 6564 4576 656e  se FileMovedEven
+00018e30: 740a 2020 2020 2020 2020 7769 7468 2073  t.        with s
+00018e40: 656c 662e 6673 5f65 7665 6e74 732e 6967  elf.fs_events.ig
+00018e50: 6e6f 7265 2865 7665 6e74 5f63 6c73 2865  nore(event_cls(e
+00018e60: 7665 6e74 2e6c 6f63 616c 5f70 6174 682c  vent.local_path,
+00018e70: 206c 6f63 616c 5f70 6174 685f 6363 2929   local_path_cc))
+00018e80: 3a0a 2020 2020 2020 2020 2020 2020 7769  :.            wi
+00018e90: 7468 2063 6f6e 7665 7274 5f61 7069 5f65  th convert_api_e
+00018ea0: 7272 6f72 7328 293a 0a20 2020 2020 2020  rrors():.       
+00018eb0: 2020 2020 2020 2020 206d 6f76 6528 6576           move(ev
+00018ec0: 656e 742e 6c6f 6361 6c5f 7061 7468 2c20  ent.local_path, 
+00018ed0: 6c6f 6361 6c5f 7061 7468 5f63 632c 2072  local_path_cc, r
+00018ee0: 6169 7365 5f65 7272 6f72 3d54 7275 6529  aise_error=True)
+00018ef0: 0a0a 2020 2020 2020 2020 2320 4465 6c65  ..        # Dele
+00018f00: 7465 2065 6e74 7279 206f 6620 6f6c 6420  te entry of old 
+00018f10: 7061 7468 2e0a 2020 2020 2020 2020 7365  path..        se
+00018f20: 6c66 2e72 656d 6f76 655f 6e6f 6465 5f66  lf.remove_node_f
+00018f30: 726f 6d5f 696e 6465 7828 6576 656e 742e  rom_index(event.
+00018f40: 6462 785f 7061 7468 5f6c 6f77 6572 290a  dbx_path_lower).
+00018f50: 2020 2020 2020 2020 7365 6c66 2e5f 6c6f          self._lo
+00018f60: 6767 6572 2e64 6562 7567 280a 2020 2020  gger.debug(.    
+00018f70: 2020 2020 2020 2020 2755 706c 6f61 6420          'Upload 
+00018f80: 636f 6e66 6c69 6374 3a20 7265 6e61 6d65  conflict: rename
+00018f90: 6420 2225 7322 2074 6f20 2225 7322 272c  d "%s" to "%s"',
+00018fa0: 0a20 2020 2020 2020 2020 2020 2065 7665  .            eve
+00018fb0: 6e74 2e64 6278 5f70 6174 682c 0a20 2020  nt.dbx_path,.   
+00018fc0: 2020 2020 2020 2020 206d 645f 6e65 772e           md_new.
+00018fd0: 7061 7468 5f64 6973 706c 6179 2c0a 2020  path_display,.  
+00018fe0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00018ff0: 2072 6574 7572 6e20 5472 7565 0a0a 2020   return True..  
+00019000: 2020 6465 6620 5f63 6865 636b 5f72 6571    def _check_req
+00019010: 7569 7265 735f 7570 6c6f 6164 2873 656c  uires_upload(sel
+00019020: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
+00019030: 656e 7429 202d 3e20 626f 6f6c 3a0a 2020  ent) -> bool:.  
+00019040: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+00019050: 2020 4368 6563 6b73 2069 6620 6120 6c6f    Checks if a lo
+00019060: 6361 6c20 6669 6c65 206e 6565 6473 2074  cal file needs t
+00019070: 6f20 6265 2075 706c 6f61 6465 642e 2054  o be uploaded. T
+00019080: 6869 7320 6973 2064 6574 6572 6d69 6e65  his is determine
+00019090: 6420 6279 2063 6865 636b 696e 6720 666f  d by checking fo
+000190a0: 720a 2020 2020 2020 2020 6571 7561 6c20  r.        equal 
+000190b0: 6669 6c65 2063 6f6e 7465 6e74 732e 2049  file contents. I
+000190c0: 6620 6e6f 2075 706c 6f61 6420 6973 2072  f no upload is r
+000190d0: 6571 7569 7265 642c 2074 6865 206c 6f63  equired, the loc
+000190e0: 616c 2069 6e64 6578 2069 7320 7570 6461  al index is upda
+000190f0: 7465 6420 7769 7468 0a20 2020 2020 2020  ted with.       
+00019100: 2074 6865 2072 656d 6f74 6520 6d65 7461   the remote meta
+00019110: 6461 7461 2e20 4e6f 7465 2074 6861 7420  data. Note that 
+00019120: 636f 6e66 6c69 6374 2072 6573 6f6c 7574  conflict resolut
+00019130: 696f 6e20 696e 2063 6173 6520 6f66 2064  ion in case of d
+00019140: 6966 6665 7265 6e74 2063 6f6e 7465 6e74  ifferent content
+00019150: 0a20 2020 2020 2020 2077 696c 6c20 6265  .        will be
+00019160: 2068 616e 646c 6564 2062 7920 7468 6520   handled by the 
+00019170: 7365 7276 6572 2e0a 0a20 2020 2020 2020  server...       
+00019180: 203a 7061 7261 6d20 6576 656e 743a 204c   :param event: L
+00019190: 6f63 616c 2073 796e 6320 6576 656e 7420  ocal sync event 
+000191a0: 6f66 2061 2066 696c 6520 6372 6561 7469  of a file creati
+000191b0: 6f6e 206f 7220 6d6f 6469 6669 6361 7469  on or modificati
+000191c0: 6f6e 2e0a 2020 2020 2020 2020 3a72 6574  on..        :ret
+000191d0: 7572 6e3a 2057 6865 7468 6572 2074 6865  urn: Whether the
+000191e0: 2072 656d 6f74 6520 6974 656d 2068 6173   remote item has
+000191f0: 2074 6865 2073 616d 6520 636f 6e74 656e   the same conten
+00019200: 7420 6173 2074 6865 206c 6f63 616c 2073  t as the local s
+00019210: 796e 6320 6576 656e 742e 0a20 2020 2020  ync event..     
+00019220: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+00019230: 6620 6e6f 7420 2865 7665 6e74 2e69 735f  f not (event.is_
+00019240: 6669 6c65 2061 6e64 2028 6576 656e 742e  file and (event.
+00019250: 6973 5f63 6861 6e67 6564 206f 7220 6576  is_changed or ev
+00019260: 656e 742e 6973 5f61 6464 6564 2929 3a0a  ent.is_added)):.
+00019270: 2020 2020 2020 2020 2020 2020 7261 6973              rais
+00019280: 6520 5661 6c75 6545 7272 6f72 2822 4361  e ValueError("Ca
+00019290: 6e20 6f6e 6c79 2062 6520 6361 6c6c 6564  n only be called
+000192a0: 2077 6974 6820 6164 6465 6420 6f72 206d   with added or m
+000192b0: 6f64 6966 6965 6420 6669 6c65 7322 290a  odified files").
+000192c0: 0a20 2020 2020 2020 206d 645f 6f6c 6420  .        md_old 
+000192d0: 3d20 7365 6c66 2e63 6c69 656e 742e 6765  = self.client.ge
+000192e0: 745f 6d65 7461 6461 7461 2865 7665 6e74  t_metadata(event
+000192f0: 2e64 6278 5f70 6174 6829 0a0a 2020 2020  .dbx_path)..    
+00019300: 2020 2020 6966 2069 7369 6e73 7461 6e63      if isinstanc
+00019310: 6528 6d64 5f6f 6c64 2c20 4669 6c65 4d65  e(md_old, FileMe
+00019320: 7461 6461 7461 293a 0a20 2020 2020 2020  tadata):.       
+00019330: 2020 2020 2069 6620 280a 2020 2020 2020       if (.      
+00019340: 2020 2020 2020 2020 2020 6576 656e 742e            event.
+00019350: 636f 6e74 656e 745f 6861 7368 203d 3d20  content_hash == 
+00019360: 6d64 5f6f 6c64 2e63 6f6e 7465 6e74 5f68  md_old.content_h
+00019370: 6173 680a 2020 2020 2020 2020 2020 2020  ash.            
+00019380: 2020 2020 616e 6420 6576 656e 742e 7379      and event.sy
+00019390: 6d6c 696e 6b5f 7461 7267 6574 203d 3d20  mlink_target == 
+000193a0: 6d64 5f6f 6c64 2e73 796d 6c69 6e6b 5f74  md_old.symlink_t
+000193b0: 6172 6765 740a 2020 2020 2020 2020 2020  arget.          
+000193c0: 2020 293a 0a20 2020 2020 2020 2020 2020    ):.           
+000193d0: 2020 2020 2023 2046 696c 6520 636f 6e74       # File cont
+000193e0: 656e 7473 2061 7265 2069 6465 6e74 6963  ents are identic
+000193f0: 616c 2c20 646f 206e 6f74 2075 706c 6f61  al, do not uploa
+00019400: 642e 0a20 2020 2020 2020 2020 2020 2020  d..             
+00019410: 2020 2063 6861 6e67 655f 7479 7065 203d     change_type =
+00019420: 2022 4d6f 6469 6669 6361 7469 6f6e 2220   "Modification" 
+00019430: 6966 2065 7665 6e74 2e69 735f 6368 616e  if event.is_chan
+00019440: 6765 6420 656c 7365 2022 4372 6561 7469  ged else "Creati
+00019450: 6f6e 220a 2020 2020 2020 2020 2020 2020  on".            
+00019460: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00019470: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00019480: 2020 2020 2020 2020 2020 2020 2725 7320              '%s 
+00019490: 6f66 2022 2573 2220 6465 7465 6374 6564  of "%s" detected
+000194a0: 2062 7574 2066 696c 6520 636f 6e74 656e   but file conten
+000194b0: 7420 6973 2074 6865 2073 616d 6520 6173  t is the same as
+000194c0: 206f 6e20 4472 6f70 626f 7827 2c0a 2020   on Dropbox',.  
+000194d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194e0: 2020 6368 616e 6765 5f74 7970 652c 0a20    change_type,. 
+000194f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019500: 2020 2065 7665 6e74 2e64 6278 5f70 6174     event.dbx_pat
+00019510: 682c 0a20 2020 2020 2020 2020 2020 2020  h,.             
+00019520: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
+00019530: 2020 2020 2073 656c 662e 7570 6461 7465       self.update
+00019540: 5f69 6e64 6578 5f66 726f 6d5f 6462 785f  _index_from_dbx_
+00019550: 6d65 7461 6461 7461 286d 645f 6f6c 6429  metadata(md_old)
+00019560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019570: 2072 6574 7572 6e20 4661 6c73 650a 2020   return False.  
+00019580: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00019590: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000195a0: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+000195b0: 2020 2020 2072 6574 7572 6e20 5472 7565       return True
+000195c0: 0a0a 2020 2020 2320 3d3d 3d3d 2044 6f77  ..    # ==== Dow
+000195d0: 6e6c 6f61 6420 7379 6e63 203d 3d3d 3d3d  nload sync =====
+000195e0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000195f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019600: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00019610: 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a 2020 2020  ==========..    
+00019620: 6465 6620 6765 745f 7265 6d6f 7465 5f69  def get_remote_i
+00019630: 7465 6d28 7365 6c66 2c20 6462 785f 7061  tem(self, dbx_pa
+00019640: 7468 3a20 7374 7229 202d 3e20 626f 6f6c  th: str) -> bool
+00019650: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+00019660: 2020 2020 2020 446f 776e 6c6f 6164 7320        Downloads 
+00019670: 6120 7265 6d6f 7465 2066 696c 6520 6f72  a remote file or
+00019680: 2066 6f6c 6465 7220 616e 6420 7570 6461   folder and upda
+00019690: 7465 7320 6974 7320 6c6f 6361 6c20 7265  tes its local re
+000196a0: 762e 2049 6620 7468 6520 7265 6d6f 7465  v. If the remote
+000196b0: 2069 7465 6d0a 2020 2020 2020 2020 646f   item.        do
+000196c0: 6573 206e 6f74 2065 7869 7374 2c20 616e  es not exist, an
+000196d0: 7920 636f 7272 6573 706f 6e64 696e 6720  y corresponding 
+000196e0: 6c6f 6361 6c20 6974 656d 7320 7769 6c6c  local items will
+000196f0: 2062 6520 6465 6c65 7465 642e 2049 6620   be deleted. If 
+00019700: 6060 6462 785f 7061 7468 6060 0a20 2020  ``dbx_path``.   
+00019710: 2020 2020 2072 6566 6572 7320 746f 2061       refers to a
+00019720: 2066 6f6c 6465 722c 2074 6865 2064 6f77   folder, the dow
+00019730: 6e6c 6f61 6420 7769 6c6c 2062 6520 6861  nload will be ha
+00019740: 6e64 6c65 6420 6279 203a 6d65 7468 3a60  ndled by :meth:`
+00019750: 5f67 6574 5f72 656d 6f74 655f 666f 6c64  _get_remote_fold
+00019760: 6572 602e 0a20 2020 2020 2020 2049 6620  er`..        If 
+00019770: 6974 2072 6566 6572 7320 746f 2061 2073  it refers to a s
+00019780: 696e 676c 6520 6669 6c65 2c20 7468 6520  ingle file, the 
+00019790: 646f 776e 6c6f 6164 2077 696c 6c20 6265  download will be
+000197a0: 2070 6572 666f 726d 6564 2062 790a 2020   performed by.  
+000197b0: 2020 2020 2020 3a6d 6574 683a 605f 6372        :meth:`_cr
+000197c0: 6561 7465 5f6c 6f63 616c 5f65 6e74 7279  eate_local_entry
+000197d0: 602e 0a0a 2020 2020 2020 2020 5468 6973  `...        This
+000197e0: 206d 6574 686f 6420 6361 6e20 6265 2075   method can be u
+000197f0: 7365 6420 746f 2066 6574 6368 2069 6e64  sed to fetch ind
+00019800: 6976 6964 7561 6c20 6974 656d 7320 6f75  ividual items ou
+00019810: 7473 6964 6520 7468 6520 7265 6775 6c61  tside the regula
+00019820: 7220 7379 6e63 0a20 2020 2020 2020 2063  r sync.        c
+00019830: 7963 6c65 2c20 666f 7220 696e 7374 616e  ycle, for instan
+00019840: 6365 2077 6865 6e20 696e 636c 7564 696e  ce when includin
+00019850: 6720 6120 7072 6576 696f 7573 6c79 2065  g a previously e
+00019860: 7863 6c75 6465 6420 6669 6c65 206f 7220  xcluded file or 
+00019870: 666f 6c64 6572 2e0a 0a20 2020 2020 2020  folder...       
+00019880: 203a 7061 7261 6d20 6462 785f 7061 7468   :param dbx_path
+00019890: 3a20 5061 7468 2072 656c 6174 6976 6520  : Path relative 
+000198a0: 746f 2044 726f 7062 6f78 2066 6f6c 6465  to Dropbox folde
+000198b0: 722e 0a20 2020 2020 2020 203a 7265 7475  r..        :retu
+000198c0: 726e 733a 2057 6865 7468 6572 2064 6f77  rns: Whether dow
+000198d0: 6e6c 6f61 6420 7761 7320 7375 6363 6573  nload was succes
+000198e0: 7366 756c 2e0a 2020 2020 2020 2020 2222  sful..        ""
+000198f0: 220a 2020 2020 2020 2020 7365 6c66 2e5f  ".        self._
+00019900: 6c6f 6767 6572 2e69 6e66 6f28 6622 5379  logger.info(f"Sy
+00019910: 6e63 696e 6720 e286 9320 7b64 6278 5f70  ncing ... {dbx_p
+00019920: 6174 687d 2229 0a0a 2020 2020 2020 2020  ath}")..        
+00019930: 7769 7468 2073 656c 662e 7379 6e63 5f6c  with self.sync_l
+00019940: 6f63 6b3a 0a20 2020 2020 2020 2020 2020  ock:.           
+00019950: 206d 6420 3d20 7365 6c66 2e63 6c69 656e   md = self.clien
+00019960: 742e 6765 745f 6d65 7461 6461 7461 2864  t.get_metadata(d
+00019970: 6278 5f70 6174 682c 2069 6e63 6c75 6465  bx_path, include
+00019980: 5f64 656c 6574 6564 3d54 7275 6529 0a0a  _deleted=True)..
+00019990: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
+000199a0: 7061 7468 5f6c 6f77 6572 203d 206e 6f72  path_lower = nor
+000199b0: 6d61 6c69 7a65 2864 6278 5f70 6174 6829  malize(dbx_path)
+000199c0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+000199d0: 206d 6420 6973 204e 6f6e 653a 0a20 2020   md is None:.   
+000199e0: 2020 2020 2020 2020 2020 2020 2023 2043               # C
+000199f0: 7265 6174 6520 6120 6661 6b65 2064 656c  reate a fake del
+00019a00: 6574 6564 2065 7665 6e74 2e0a 2020 2020  eted event..    
+00019a10: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00019a20: 785f 656e 7472 7920 3d20 7365 6c66 2e67  x_entry = self.g
+00019a30: 6574 5f69 6e64 6578 5f65 6e74 7279 2864  et_index_entry(d
+00019a40: 6278 5f70 6174 685f 6c6f 7765 7229 0a20  bx_path_lower). 
+00019a50: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00019a60: 6173 6564 5f70 6174 6820 3d20 696e 6465  ased_path = inde
+00019a70: 785f 656e 7472 792e 6462 785f 7061 7468  x_entry.dbx_path
+00019a80: 5f63 6173 6564 2069 6620 696e 6465 785f  _cased if index_
+00019a90: 656e 7472 7920 656c 7365 2064 6278 5f70  entry else dbx_p
+00019aa0: 6174 680a 0a20 2020 2020 2020 2020 2020  ath..           
+00019ab0: 2020 2020 206d 6420 3d20 4465 6c65 7465       md = Delete
+00019ac0: 644d 6574 6164 6174 6128 0a20 2020 2020  dMetadata(.     
+00019ad0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00019ae0: 616d 653d 6f73 702e 6261 7365 6e61 6d65  ame=osp.basename
+00019af0: 2864 6278 5f70 6174 6829 2c0a 2020 2020  (dbx_path),.    
+00019b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b10: 7061 7468 5f6c 6f77 6572 3d64 6278 5f70  path_lower=dbx_p
+00019b20: 6174 685f 6c6f 7765 722c 0a20 2020 2020  ath_lower,.     
+00019b30: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00019b40: 6174 685f 6469 7370 6c61 793d 6361 7365  ath_display=case
+00019b50: 645f 7061 7468 2c0a 2020 2020 2020 2020  d_path,.        
+00019b60: 2020 2020 2020 2020 290a 0a20 2020 2020          )..     
+00019b70: 2020 2020 2020 2065 7665 6e74 203d 2053         event = S
+00019b80: 796e 6345 7665 6e74 2e66 726f 6d5f 6d65  yncEvent.from_me
+00019b90: 7461 6461 7461 286d 642c 2073 656c 6629  tadata(md, self)
+00019ba0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
+00019bb0: 2065 7665 6e74 2e69 735f 6469 7265 6374   event.is_direct
+00019bc0: 6f72 793a 0a20 2020 2020 2020 2020 2020  ory:.           
+00019bd0: 2020 2020 2073 7563 6365 7373 203d 2073       success = s
+00019be0: 656c 662e 5f67 6574 5f72 656d 6f74 655f  elf._get_remote_
+00019bf0: 666f 6c64 6572 2864 6278 5f70 6174 6829  folder(dbx_path)
+00019c00: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+00019c10: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+00019c20: 2020 2073 656c 662e 6163 7469 7669 7479     self.activity
+00019c30: 2e61 6464 2865 7665 6e74 290a 2020 2020  .add(event).    
+00019c40: 2020 2020 2020 2020 2020 2020 6520 3d20              e = 
+00019c50: 7365 6c66 2e5f 6372 6561 7465 5f6c 6f63  self._create_loc
+00019c60: 616c 5f65 6e74 7279 2865 7665 6e74 290a  al_entry(event).
+00019c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019c80: 7375 6363 6573 7320 3d20 652e 7374 6174  success = e.stat
+00019c90: 7573 2069 6e20 2853 796e 6353 7461 7475  us in (SyncStatu
+00019ca0: 732e 446f 6e65 2c20 5379 6e63 5374 6174  s.Done, SyncStat
+00019cb0: 7573 2e53 6b69 7070 6564 290a 0a20 2020  us.Skipped)..   
+00019cc0: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
+00019cd0: 6c65 6172 5f63 6163 6865 7328 290a 0a20  lear_caches().. 
+00019ce0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+00019cf0: 6e20 7375 6363 6573 730a 0a20 2020 2064  n success..    d
+00019d00: 6566 205f 6765 745f 7265 6d6f 7465 5f66  ef _get_remote_f
+00019d10: 6f6c 6465 7228 7365 6c66 2c20 6462 785f  older(self, dbx_
+00019d20: 7061 7468 3a20 7374 7229 202d 3e20 626f  path: str) -> bo
+00019d30: 6f6c 3a0a 2020 2020 2020 2020 2222 220a  ol:.        """.
+00019d40: 2020 2020 2020 2020 4765 7473 2061 6c6c          Gets all
+00019d50: 2066 696c 6573 2f66 6f6c 6465 7273 2066   files/folders f
+00019d60: 726f 6d20 6120 4472 6f70 626f 7820 666f  rom a Dropbox fo
+00019d70: 6c64 6572 2061 6e64 2077 7269 7465 7320  lder and writes 
+00019d80: 7468 656d 2074 6f20 7468 6520 6c6f 6361  them to the loca
+00019d90: 6c20 666f 6c64 6572 0a20 2020 2020 2020  l folder.       
+00019da0: 203a 6174 7472 3a60 6472 6f70 626f 785f   :attr:`dropbox_
+00019db0: 7061 7468 602e 0a0a 2020 2020 2020 2020  path`...        
+00019dc0: 3a70 6172 616d 2064 6278 5f70 6174 683a  :param dbx_path:
+00019dd0: 2050 6174 6820 7265 6c61 7469 7665 2074   Path relative t
+00019de0: 6f20 4472 6f70 626f 7820 666f 6c64 6572  o Dropbox folder
+00019df0: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
+00019e00: 6e73 3a20 5768 6574 6865 7220 646f 776e  ns: Whether down
+00019e10: 6c6f 6164 2077 6173 2073 7563 6365 7373  load was success
+00019e20: 6675 6c2e 0a20 2020 2020 2020 2022 2222  ful..        """
+00019e30: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
+00019e40: 6c66 2e73 796e 635f 6c6f 636b 3a0a 2020  lf.sync_lock:.  
+00019e50: 2020 2020 2020 2020 2020 7472 793a 0a20            try:. 
+00019e60: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00019e70: 6478 203d 2030 0a0a 2020 2020 2020 2020  dx = 0..        
+00019e80: 2020 2020 2020 2020 2320 4974 6572 6174          # Iterat
+00019e90: 6520 6f76 6572 2069 6e64 6578 2061 6e64  e over index and
+00019ea0: 2064 6f77 6e6c 6f61 6420 7265 7375 6c74   download result
+00019eb0: 732e 0a20 2020 2020 2020 2020 2020 2020  s..             
+00019ec0: 2020 206c 6973 745f 6974 6572 203d 2073     list_iter = s
+00019ed0: 656c 662e 636c 6965 6e74 2e6c 6973 745f  elf.client.list_
+00019ee0: 666f 6c64 6572 5f69 7465 7261 746f 7228  folder_iterator(
+00019ef0: 6462 785f 7061 7468 2c20 7265 6375 7273  dbx_path, recurs
+00019f00: 6976 653d 5472 7565 290a 0a20 2020 2020  ive=True)..     
+00019f10: 2020 2020 2020 2020 2020 2066 6f72 2072             for r
+00019f20: 6573 2069 6e20 6c69 7374 5f69 7465 723a  es in list_iter:
+00019f30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019f40: 2020 2020 2069 6478 202b 3d20 6c65 6e28       idx += len(
+00019f50: 7265 732e 656e 7472 6965 7329 0a0a 2020  res.entries)..  
+00019f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f70: 2020 6966 2069 6478 203e 2030 3a0a 2020    if idx > 0:.  
+00019f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f90: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00019fa0: 6572 2e69 6e66 6f28 6622 496e 6465 7869  er.info(f"Indexi
+00019fb0: 6e67 207b 6964 787d 2e2e 2e22 290a 0a20  ng {idx}...").. 
+00019fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019fd0: 2020 2072 6573 2e65 6e74 7269 6573 2e73     res.entries.s
+00019fe0: 6f72 7428 6b65 793d 6c61 6d62 6461 2078  ort(key=lambda x
+00019ff0: 3a20 782e 7061 7468 5f6c 6f77 6572 2e63  : x.path_lower.c
+0001a000: 6f75 6e74 2822 2f22 2929 0a0a 2020 2020  ount("/"))..    
+0001a010: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a020: 2320 436f 6e76 6572 7420 6d65 7461 6461  # Convert metada
+0001a030: 7461 2074 6f20 7379 6e63 5f65 7665 6e74  ta to sync_event
+0001a040: 732e 0a20 2020 2020 2020 2020 2020 2020  s..             
+0001a050: 2020 2020 2020 2073 796e 635f 6576 656e         sync_even
+0001a060: 7473 203d 205b 0a20 2020 2020 2020 2020  ts = [.         
+0001a070: 2020 2020 2020 2020 2020 2020 2020 2053                 S
+0001a080: 796e 6345 7665 6e74 2e66 726f 6d5f 6d65  yncEvent.from_me
+0001a090: 7461 6461 7461 286d 642c 2073 656c 6629  tadata(md, self)
+0001a0a0: 2066 6f72 206d 6420 696e 2072 6573 2e65   for md in res.e
+0001a0b0: 6e74 7269 6573 0a20 2020 2020 2020 2020  ntries.         
+0001a0c0: 2020 2020 2020 2020 2020 205d 0a20 2020             ].   
+0001a0d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a0e0: 2064 6f77 6e6c 6f61 645f 7265 7320 3d20   download_res = 
+0001a0f0: 7365 6c66 2e61 7070 6c79 5f72 656d 6f74  self.apply_remot
+0001a100: 655f 6368 616e 6765 7328 7379 6e63 5f65  e_changes(sync_e
+0001a110: 7665 6e74 7329 0a0a 2020 2020 2020 2020  vents)..        
+0001a120: 2020 2020 2020 2020 2020 2020 7375 6363              succ
+0001a130: 6573 7320 3d20 616c 6c28 0a20 2020 2020  ess = all(.     
+0001a140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a150: 2020 2065 2e73 7461 7475 7320 696e 2028     e.status in (
+0001a160: 5379 6e63 5374 6174 7573 2e44 6f6e 652c  SyncStatus.Done,
+0001a170: 2053 796e 6353 7461 7475 732e 536b 6970   SyncStatus.Skip
+0001a180: 7065 6429 0a20 2020 2020 2020 2020 2020  ped).           
+0001a190: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001a1a0: 2065 2069 6e20 646f 776e 6c6f 6164 5f72   e in download_r
+0001a1b0: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+0001a1c0: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
+0001a1d0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0001a1e0: 2073 656c 662e 5f63 616e 6365 6c5f 7265   self._cancel_re
+0001a1f0: 7175 6573 7465 642e 6973 5f73 6574 2829  quested.is_set()
+0001a200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001a210: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+0001a220: 4361 6e63 656c 6c65 6445 7272 6f72 2822  CancelledError("
+0001a230: 5379 6e63 2063 616e 6365 6c6c 6564 2229  Sync cancelled")
+0001a240: 0a0a 2020 2020 2020 2020 2020 2020 6578  ..            ex
+0001a250: 6365 7074 2053 796e 6345 7272 6f72 2061  cept SyncError a
+0001a260: 7320 653a 0a20 2020 2020 2020 2020 2020  s e:.           
+0001a270: 2020 2020 2073 656c 662e 5f68 616e 646c       self._handl
+0001a280: 655f 7379 6e63 5f65 7272 6f72 2865 2c20  e_sync_error(e, 
+0001a290: 6469 7265 6374 696f 6e3d 5379 6e63 4469  direction=SyncDi
+0001a2a0: 7265 6374 696f 6e2e 446f 776e 290a 2020  rection.Down).  
+0001a2b0: 2020 2020 2020 2020 2020 2020 2020 7265                re
+0001a2c0: 7475 726e 2046 616c 7365 0a0a 2020 2020  turn False..    
+0001a2d0: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+0001a2e0: 7563 6365 7373 0a0a 2020 2020 6465 6620  uccess..    def 
+0001a2f0: 7761 6974 5f66 6f72 5f72 656d 6f74 655f  wait_for_remote_
+0001a300: 6368 616e 6765 7328 0a20 2020 2020 2020  changes(.       
+0001a310: 2073 656c 662c 0a20 2020 2020 2020 206c   self,.        l
+0001a320: 6173 745f 6375 7273 6f72 3a20 7374 722c  ast_cursor: str,
+0001a330: 0a20 2020 2020 2020 2074 696d 656f 7574  .        timeout
+0001a340: 3a20 696e 7420 3d20 3430 2c0a 2020 2020  : int = 40,.    
+0001a350: 2920 2d3e 2062 6f6f 6c3a 0a20 2020 2020  ) -> bool:.     
+0001a360: 2020 2022 2222 0a20 2020 2020 2020 2042     """.        B
+0001a370: 6c6f 636b 7320 756e 7469 6c20 6368 616e  locks until chan
+0001a380: 6765 7320 746f 2074 6865 2072 656d 6f74  ges to the remot
+0001a390: 6520 4472 6f70 626f 7820 6172 6520 6176  e Dropbox are av
+0001a3a0: 6169 6c61 626c 652e 0a0a 2020 2020 2020  ailable...      
+0001a3b0: 2020 3a70 6172 616d 206c 6173 745f 6375    :param last_cu
+0001a3c0: 7273 6f72 3a20 4375 7273 6f72 2066 6f72  rsor: Cursor for
+0001a3d0: 6d20 6c61 7374 2073 796e 632e 0a20 2020  m last sync..   
+0001a3e0: 2020 2020 203a 7061 7261 6d20 7469 6d65       :param time
+0001a3f0: 6f75 743a 2054 696d 656f 7574 2069 6e20  out: Timeout in 
+0001a400: 7365 636f 6e64 7320 6265 666f 7265 2072  seconds before r
+0001a410: 6574 7572 6e69 6e67 2065 7665 6e20 6966  eturning even if
+0001a420: 2074 6865 7265 2061 7265 206e 6f0a 2020   there are no.  
+0001a430: 2020 2020 2020 2020 2020 6368 616e 6765            change
+0001a440: 732e 2044 726f 7062 6f78 2061 6464 7320  s. Dropbox adds 
+0001a450: 7261 6e64 6f6d 206a 6974 7465 7220 6f66  random jitter of
+0001a460: 2075 7020 746f 2039 3020 7365 6320 746f   up to 90 sec to
+0001a470: 2074 6869 7320 7661 6c75 652e 0a20 2020   this value..   
+0001a480: 2020 2020 203a 7265 7475 726e 733a 2060       :returns: `
+0001a490: 6054 7275 6560 6020 6966 2063 6861 6e67  `True`` if chang
+0001a4a0: 6573 2061 7265 2061 7661 696c 6162 6c65  es are available
+0001a4b0: 2c20 6060 4661 6c73 6560 6020 6f74 6865  , ``False`` othe
+0001a4c0: 7277 6973 652e 0a20 2020 2020 2020 2022  rwise..        "
+0001a4d0: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
+0001a4e0: 5f6c 6f67 6765 722e 6465 6275 6728 2257  _logger.debug("W
+0001a4f0: 6169 7469 6e67 2066 6f72 2072 656d 6f74  aiting for remot
+0001a500: 6520 6368 616e 6765 7320 7369 6e63 6520  e changes since 
+0001a510: 6375 7273 6f72 3a5c 6e25 7322 2c20 6c61  cursor:\n%s", la
+0001a520: 7374 5f63 7572 736f 7229 0a20 2020 2020  st_cursor).     
+0001a530: 2020 2068 6173 5f63 6861 6e67 6573 203d     has_changes =
+0001a540: 2073 656c 662e 636c 6965 6e74 2e77 6169   self.client.wai
+0001a550: 745f 666f 725f 7265 6d6f 7465 5f63 6861  t_for_remote_cha
+0001a560: 6e67 6573 286c 6173 745f 6375 7273 6f72  nges(last_cursor
+0001a570: 2c20 7469 6d65 6f75 743d 7469 6d65 6f75  , timeout=timeou
+0001a580: 7429 0a0a 2020 2020 2020 2020 2320 5761  t)..        # Wa
+0001a590: 6974 2066 6f72 2032 2073 6563 2e20 5468  it for 2 sec. Th
+0001a5a0: 6973 2064 656c 6179 2069 7320 7479 7069  is delay is typi
+0001a5b0: 6361 6c6c 7920 6f6e 6c79 206e 6563 6573  cally only neces
+0001a5c0: 7361 7279 2066 6f6c 6465 7273 2061 7265  sary folders are
+0001a5d0: 2073 6861 7265 6420 2f0a 2020 2020 2020   shared /.      
+0001a5e0: 2020 2320 756e 2d73 6861 7265 6420 7769    # un-shared wi
+0001a5f0: 7468 206f 7468 6572 2044 726f 7062 6f78  th other Dropbox
+0001a600: 2061 6363 6f75 6e74 732e 0a20 2020 2020   accounts..     
+0001a610: 2020 2074 696d 652e 736c 6565 7028 3229     time.sleep(2)
+0001a620: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
+0001a630: 6c6f 6767 6572 2e64 6562 7567 2822 4465  logger.debug("De
+0001a640: 7465 6374 6564 2072 656d 6f74 6520 6368  tected remote ch
+0001a650: 616e 6765 733a 2025 7322 2c20 6861 735f  anges: %s", has_
+0001a660: 6368 616e 6765 7329 0a20 2020 2020 2020  changes).       
+0001a670: 2072 6574 7572 6e20 6861 735f 6368 616e   return has_chan
+0001a680: 6765 730a 0a20 2020 2064 6566 2064 6f77  ges..    def dow
+0001a690: 6e6c 6f61 645f 7379 6e63 5f63 7963 6c65  nload_sync_cycle
+0001a6a0: 2873 656c 6629 202d 3e20 4e6f 6e65 3a0a  (self) -> None:.
+0001a6b0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+0001a6c0: 2020 2020 5065 7266 6f72 6d73 2061 2066      Performs a f
+0001a6d0: 756c 6c20 646f 776e 6c6f 6164 2073 796e  ull download syn
+0001a6e0: 6320 6379 636c 6520 6279 2063 616c 6c69  c cycle by calli
+0001a6f0: 6e67 2069 6e20 6f72 6465 723a 0a0a 2020  ng in order:..  
+0001a700: 2020 2020 2020 2020 2020 3129 203a 6d65            1) :me
+0001a710: 7468 3a60 6c69 7374 5f72 656d 6f74 655f  th:`list_remote_
+0001a720: 6368 616e 6765 735f 6974 6572 6174 6f72  changes_iterator
+0001a730: 600a 2020 2020 2020 2020 2020 2020 3229  `.            2)
+0001a740: 203a 6d65 7468 3a60 6170 706c 795f 7265   :meth:`apply_re
+0001a750: 6d6f 7465 5f63 6861 6e67 6573 600a 0a20  mote_changes`.. 
+0001a760: 2020 2020 2020 2048 616e 646c 6573 2075         Handles u
+0001a770: 7064 6174 696e 6720 7468 6520 7265 6d6f  pdating the remo
+0001a780: 7465 2063 7572 736f 7220 616e 6420 7265  te cursor and re
+0001a790: 7375 6d69 6e67 2069 6e74 6572 7275 7074  suming interrupt
+0001a7a0: 6564 2073 796e 6373 2066 6f72 2079 6f75  ed syncs for you
+0001a7b0: 2e0a 2020 2020 2020 2020 4361 6c6c 696e  ..        Callin
+0001a7c0: 6720 7468 6973 206d 6574 686f 6420 7769  g this method wi
+0001a7d0: 6c6c 2070 6572 666f 726d 2061 2066 756c  ll perform a ful
+0001a7e0: 6c20 696e 6465 7869 6e67 2069 6620 7468  l indexing if th
+0001a7f0: 6973 2069 7320 7468 6520 6669 7273 7420  is is the first 
+0001a800: 646f 776e 6c6f 6164 2e0a 2020 2020 2020  download..      
+0001a810: 2020 2222 220a 2020 2020 2020 2020 7769    """.        wi
+0001a820: 7468 2073 656c 662e 7379 6e63 5f6c 6f63  th self.sync_loc
+0001a830: 6b3a 0a20 2020 2020 2020 2020 2020 2069  k:.            i
+0001a840: 6620 7365 6c66 2e72 656d 6f74 655f 6375  f self.remote_cu
+0001a850: 7273 6f72 203d 3d20 2222 3a0a 2020 2020  rsor == "":.    
+0001a860: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001a870: 2e5f 7374 6174 652e 7365 7428 2273 796e  ._state.set("syn
+0001a880: 6322 2c20 226c 6173 745f 7265 696e 6465  c", "last_reinde
+0001a890: 7822 2c20 7469 6d65 2e74 696d 6528 2929  x", time.time())
+0001a8a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001a8b0: 2073 656c 662e 5f73 7461 7465 2e73 6574   self._state.set
+0001a8c0: 2822 7379 6e63 222c 2022 6469 645f 6669  ("sync", "did_fi
+0001a8d0: 6e69 7368 5f69 6e64 6578 696e 6722 2c20  nish_indexing", 
+0001a8e0: 4661 6c73 6529 0a20 2020 2020 2020 2020  False).         
+0001a8f0: 2020 2020 2020 2073 656c 662e 5f73 7461         self._sta
+0001a900: 7465 2e73 6574 2822 7379 6e63 222c 2022  te.set("sync", "
+0001a910: 696e 6465 7869 6e67 5f63 6f75 6e74 6572  indexing_counter
+0001a920: 222c 2030 290a 0a20 2020 2020 2020 2020  ", 0)..         
+0001a930: 2020 2069 6478 203d 2073 656c 662e 5f73     idx = self._s
+0001a940: 7461 7465 2e67 6574 2822 7379 6e63 222c  tate.get("sync",
+0001a950: 2022 696e 6465 7869 6e67 5f63 6f75 6e74   "indexing_count
+0001a960: 6572 2229 0a20 2020 2020 2020 2020 2020  er").           
+0001a970: 2069 735f 696e 6465 7869 6e67 203d 206e   is_indexing = n
+0001a980: 6f74 2073 656c 662e 5f73 7461 7465 2e67  ot self._state.g
+0001a990: 6574 2822 7379 6e63 222c 2022 6469 645f  et("sync", "did_
+0001a9a0: 6669 6e69 7368 5f69 6e64 6578 696e 6722  finish_indexing"
+0001a9b0: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0001a9c0: 6620 6973 5f69 6e64 6578 696e 6720 616e  f is_indexing an
+0001a9d0: 6420 6964 7820 3d3d 2030 3a0a 2020 2020  d idx == 0:.    
+0001a9e0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001a9f0: 2e5f 6c6f 6767 6572 2e69 6e66 6f28 2249  ._logger.info("I
+0001aa00: 6e64 6578 696e 6720 7265 6d6f 7465 2044  ndexing remote D
+0001aa10: 726f 7062 6f78 2229 0a20 2020 2020 2020  ropbox").       
+0001aa20: 2020 2020 2065 6c69 6620 6973 5f69 6e64       elif is_ind
+0001aa30: 6578 696e 673a 0a20 2020 2020 2020 2020  exing:.         
+0001aa40: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+0001aa50: 6765 722e 696e 666f 2822 5265 7375 6d69  ger.info("Resumi
+0001aa60: 6e67 2069 6e64 6578 696e 6722 290a 2020  ng indexing").  
+0001aa70: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001aa80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001aa90: 7365 6c66 2e5f 6c6f 6767 6572 2e69 6e66  self._logger.inf
+0001aaa0: 6f28 2246 6574 6368 696e 6720 7265 6d6f  o("Fetching remo
+0001aab0: 7465 2063 6861 6e67 6573 2229 0a0a 2020  te changes")..  
+0001aac0: 2020 2020 2020 2020 2020 6368 616e 6765            change
+0001aad0: 735f 6974 6572 203d 2073 656c 662e 6c69  s_iter = self.li
+0001aae0: 7374 5f72 656d 6f74 655f 6368 616e 6765  st_remote_change
+0001aaf0: 735f 6974 6572 6174 6f72 2873 656c 662e  s_iterator(self.
+0001ab00: 7265 6d6f 7465 5f63 7572 736f 7229 0a0a  remote_cursor)..
+0001ab10: 2020 2020 2020 2020 2020 2020 2320 446f              # Do
+0001ab20: 776e 6c6f 6164 2063 6861 6e67 6573 2069  wnload changes i
+0001ab30: 6e20 6368 756e 6b73 2074 6f20 7265 6475  n chunks to redu
+0001ab40: 6365 206d 656d 6f72 7920 7573 6167 652e  ce memory usage.
+0001ab50: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+0001ab60: 2063 6861 6e67 6573 2c20 6375 7273 6f72   changes, cursor
+0001ab70: 2069 6e20 6368 616e 6765 735f 6974 6572   in changes_iter
+0001ab80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ab90: 2020 6964 7820 2b3d 206c 656e 2863 6861    idx += len(cha
+0001aba0: 6e67 6573 290a 0a20 2020 2020 2020 2020  nges)..         
+0001abb0: 2020 2020 2020 2069 6620 6964 7820 3e20         if idx > 
+0001abc0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0001abd0: 2020 2020 2020 2073 656c 662e 5f6c 6f67         self._log
+0001abe0: 6765 722e 696e 666f 2866 2249 6e64 6578  ger.info(f"Index
+0001abf0: 696e 6720 7b69 6478 7d2e 2e2e 2229 0a0a  ing {idx}...")..
+0001ac00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ac10: 646f 776e 6c6f 6164 6564 203d 2073 656c  downloaded = sel
+0001ac20: 662e 6170 706c 795f 7265 6d6f 7465 5f63  f.apply_remote_c
+0001ac30: 6861 6e67 6573 2863 6861 6e67 6573 290a  hanges(changes).
+0001ac40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ac50: 2023 2053 6176 6520 2869 6e63 7265 6d65   # Save (increme
+0001ac60: 6e74 616c 2920 7265 6d6f 7465 2063 7572  ntal) remote cur
+0001ac70: 736f 722e 0a20 2020 2020 2020 2020 2020  sor..           
+0001ac80: 2020 2020 2073 656c 662e 7265 6d6f 7465       self.remote
+0001ac90: 5f63 7572 736f 7220 3d20 6375 7273 6f72  _cursor = cursor
+0001aca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001acb0: 2073 656c 662e 5f73 7461 7465 2e73 6574   self._state.set
+0001acc0: 2822 7379 6e63 222c 2022 696e 6465 7869  ("sync", "indexi
+0001acd0: 6e67 5f63 6f75 6e74 6572 222c 2069 6478  ng_counter", idx
+0001ace0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+0001acf0: 2020 2023 2053 656e 6420 6465 736b 746f     # Send deskto
+0001ad00: 7020 6e6f 7469 6669 6361 7469 6f6e 7320  p notifications 
+0001ad10: 7768 656e 206e 6f74 2069 6e64 6578 696e  when not indexin
+0001ad20: 672e 0a20 2020 2020 2020 2020 2020 2020  g..             
+0001ad30: 2020 2069 6620 6e6f 7420 6973 5f69 6e64     if not is_ind
+0001ad40: 6578 696e 673a 0a20 2020 2020 2020 2020  exing:.         
+0001ad50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001ad60: 6e6f 7469 6679 5f75 7365 7228 646f 776e  notify_user(down
+0001ad70: 6c6f 6164 6564 290a 0a20 2020 2020 2020  loaded)..       
+0001ad80: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+0001ad90: 2e5f 6361 6e63 656c 5f72 6571 7565 7374  ._cancel_request
+0001ada0: 6564 2e69 735f 7365 7428 293a 0a20 2020  ed.is_set():.   
+0001adb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001adc0: 2072 6169 7365 2043 616e 6365 6c6c 6564   raise Cancelled
+0001add0: 4572 726f 7228 2253 796e 6320 6361 6e63  Error("Sync canc
+0001ade0: 656c 6c65 6422 290a 0a20 2020 2020 2020  elled")..       
+0001adf0: 2020 2020 2020 2020 2023 2046 7265 6520           # Free 
+0001ae00: 6d65 6d6f 7279 2065 6172 6c79 2074 6f20  memory early to 
+0001ae10: 7072 6576 656e 7420 6672 6167 6d65 6e74  prevent fragment
+0001ae20: 6174 696f 6e2e 0a20 2020 2020 2020 2020  ation..         
+0001ae30: 2020 2020 2020 2064 656c 2063 6861 6e67         del chang
+0001ae40: 6573 0a20 2020 2020 2020 2020 2020 2020  es.             
+0001ae50: 2020 2064 656c 2064 6f77 6e6c 6f61 6465     del downloade
+0001ae60: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+0001ae70: 2020 6763 2e63 6f6c 6c65 6374 2829 0a0a    gc.collect()..
+0001ae80: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0001ae90: 2e5f 7374 6174 652e 7365 7428 2273 796e  ._state.set("syn
+0001aea0: 6322 2c20 2264 6964 5f66 696e 6973 685f  c", "did_finish_
+0001aeb0: 696e 6465 7869 6e67 222c 2054 7275 6529  indexing", True)
+0001aec0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001aed0: 662e 5f73 7461 7465 2e73 6574 2822 7379  f._state.set("sy
+0001aee0: 6e63 222c 2022 696e 6465 7869 6e67 5f63  nc", "indexing_c
+0001aef0: 6f75 6e74 6572 222c 2030 290a 0a20 2020  ounter", 0)..   
+0001af00: 2020 2020 2020 2020 2069 6620 6964 7820           if idx 
+0001af10: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
+0001af20: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
+0001af30: 722e 696e 666f 2849 444c 4529 0a0a 2020  r.info(IDLE)..  
+0001af40: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0001af50: 636c 6561 725f 6361 6368 6573 2829 0a0a  clear_caches()..
+0001af60: 2020 2020 6465 6620 6c69 7374 5f72 656d      def list_rem
+0001af70: 6f74 655f 6368 616e 6765 735f 6974 6572  ote_changes_iter
+0001af80: 6174 6f72 280a 2020 2020 2020 2020 7365  ator(.        se
+0001af90: 6c66 2c20 6c61 7374 5f63 7572 736f 723a  lf, last_cursor:
+0001afa0: 2073 7472 0a20 2020 2029 202d 3e20 4974   str.    ) -> It
+0001afb0: 6572 6174 6f72 5b74 7570 6c65 5b6c 6973  erator[tuple[lis
+0001afc0: 745b 5379 6e63 4576 656e 745d 2c20 7374  t[SyncEvent], st
+0001afd0: 725d 5d3a 0a20 2020 2020 2020 2022 2222  r]]:.        """
+0001afe0: 0a20 2020 2020 2020 2047 6574 2072 656d  .        Get rem
+0001aff0: 6f74 6520 6368 616e 6765 7320 7369 6e63  ote changes sinc
+0001b000: 6520 7468 6520 6c61 7374 2064 6f77 6e6c  e the last downl
+0001b010: 6f61 6420 7379 6e63 2c20 6173 2073 7065  oad sync, as spe
+0001b020: 6369 6669 6564 2062 790a 2020 2020 2020  cified by.      
+0001b030: 2020 6060 6c61 7374 5f63 7572 736f 7260    ``last_cursor`
+0001b040: 602e 2049 6620 7468 6520 6060 6c61 7374  `. If the ``last
+0001b050: 5f63 7572 736f 7260 6020 6973 2066 726f  _cursor`` is fro
+0001b060: 6d20 7061 6769 6e61 7469 6e67 2074 6872  m paginating thr
+0001b070: 6f75 6768 2061 2070 7265 7669 6f75 730a  ough a previous.
+0001b080: 2020 2020 2020 2020 7365 7420 6f66 2063          set of c
+0001b090: 6861 6e67 6573 2c20 636f 6e74 696e 7565  hanges, continue
+0001b0a0: 2077 6865 7265 2077 6520 6c65 6674 206f   where we left o
+0001b0b0: 6666 2e20 4966 2060 606c 6173 745f 6375  ff. If ``last_cu
+0001b0c0: 7273 6f72 6060 2069 7320 616e 2065 6d70  rsor`` is an emp
+0001b0d0: 7479 0a20 2020 2020 2020 2073 7472 696e  ty.        strin
+0001b0e0: 672c 2070 6572 666f 726d 2061 2066 756c  g, perform a ful
+0001b0f0: 6c20 696e 6465 7869 6e67 206f 6620 7468  l indexing of th
+0001b100: 6520 4472 6f70 626f 7820 666f 6c64 6572  e Dropbox folder
+0001b110: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
+0001b120: 6d20 6c61 7374 5f63 7572 736f 723a 2043  m last_cursor: C
+0001b130: 7572 736f 7220 6672 6f6d 206c 6173 7420  ursor from last 
+0001b140: 646f 776e 6c6f 6164 2073 796e 632e 0a20  download sync.. 
+0001b150: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
+0001b160: 2049 7465 7261 746f 7220 7969 656c 6469   Iterator yieldi
+0001b170: 6e67 2074 7570 6c65 7320 7769 7468 2072  ng tuples with r
+0001b180: 656d 6f74 6520 6368 616e 6765 7320 616e  emote changes an
+0001b190: 6420 636f 7272 6573 706f 6e64 696e 6720  d corresponding 
+0001b1a0: 6375 7273 6f72 2e0a 2020 2020 2020 2020  cursor..        
+0001b1b0: 2222 220a 2020 2020 2020 2020 6966 206c  """.        if l
+0001b1c0: 6173 745f 6375 7273 6f72 203d 3d20 2222  ast_cursor == ""
+0001b1d0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001b1e0: 5765 2061 7265 2073 7461 7274 696e 6720  We are starting 
+0001b1f0: 6672 6f6d 2074 6865 2062 6567 696e 6e69  from the beginni
+0001b200: 6e67 2c20 646f 2061 2066 756c 6c20 696e  ng, do a full in
+0001b210: 6465 7869 6e67 2e0a 2020 2020 2020 2020  dexing..        
+0001b220: 2020 2020 6368 616e 6765 735f 6974 6572      changes_iter
+0001b230: 203d 2073 656c 662e 636c 6965 6e74 2e6c   = self.client.l
+0001b240: 6973 745f 666f 6c64 6572 5f69 7465 7261  ist_folder_itera
+0001b250: 746f 7228 222f 222c 2072 6563 7572 7369  tor("/", recursi
+0001b260: 7665 3d54 7275 6529 0a20 2020 2020 2020  ve=True).       
+0001b270: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001b280: 2020 2023 2050 6963 6b20 7570 2077 6865     # Pick up whe
+0001b290: 7265 2077 6520 6c65 6674 206f 6666 2e20  re we left off. 
+0001b2a0: 5468 6973 206d 6179 2062 6520 616e 2069  This may be an i
+0001b2b0: 6e74 6572 7275 7074 6564 2069 6e64 6578  nterrupted index
+0001b2c0: 696e 6720 2f0a 2020 2020 2020 2020 2020  ing /.          
+0001b2d0: 2020 2320 7061 6769 6e61 7469 6f6e 2074    # pagination t
+0001b2e0: 6872 6f75 6768 2063 6861 6e67 6573 206f  hrough changes o
+0001b2f0: 7220 6120 636f 6d70 6c65 7465 6c79 206e  r a completely n
+0001b300: 6577 2073 6574 206f 6620 6368 616e 6765  ew set of change
+0001b310: 732e 0a20 2020 2020 2020 2020 2020 2073  s..            s
+0001b320: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
+0001b330: 6728 2246 6574 6368 696e 6720 7265 6d6f  g("Fetching remo
+0001b340: 7465 2063 6861 6e67 6573 2073 696e 6365  te changes since
+0001b350: 2063 7572 736f 723a 2025 7322 2c20 6c61   cursor: %s", la
+0001b360: 7374 5f63 7572 736f 7229 0a20 2020 2020  st_cursor).     
+0001b370: 2020 2020 2020 2063 6861 6e67 6573 5f69         changes_i
+0001b380: 7465 7220 3d20 7365 6c66 2e63 6c69 656e  ter = self.clien
+0001b390: 742e 6c69 7374 5f72 656d 6f74 655f 6368  t.list_remote_ch
+0001b3a0: 616e 6765 735f 6974 6572 6174 6f72 286c  anges_iterator(l
+0001b3b0: 6173 745f 6375 7273 6f72 290a 0a20 2020  ast_cursor)..   
+0001b3c0: 2020 2020 2066 6f72 2063 6861 6e67 6573       for changes
+0001b3d0: 2069 6e20 6368 616e 6765 735f 6974 6572   in changes_iter
+0001b3e0: 3a0a 2020 2020 2020 2020 2020 2020 6368  :.            ch
+0001b3f0: 616e 6765 7320 3d20 7365 6c66 2e5f 636c  anges = self._cl
+0001b400: 6561 6e5f 7265 6d6f 7465 5f63 6861 6e67  ean_remote_chang
+0001b410: 6573 2863 6861 6e67 6573 290a 2020 2020  es(changes).    
+0001b420: 2020 2020 2020 2020 6368 616e 6765 732e          changes.
+0001b430: 656e 7472 6965 732e 736f 7274 286b 6579  entries.sort(key
+0001b440: 3d6c 616d 6264 6120 783a 2078 2e70 6174  =lambda x: x.pat
+0001b450: 685f 6c6f 7765 722e 636f 756e 7428 222f  h_lower.count("/
+0001b460: 2229 290a 0a20 2020 2020 2020 2020 2020  "))..           
+0001b470: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
+0001b480: 6275 6728 2252 656d 6f74 6520 6368 616e  bug("Remote chan
+0001b490: 6765 733a 5c6e 2573 222c 2070 665f 7265  ges:\n%s", pf_re
+0001b4a0: 7072 2863 6861 6e67 6573 2e65 6e74 7269  pr(changes.entri
+0001b4b0: 6573 2929 0a0a 2020 2020 2020 2020 2020  es))..          
+0001b4c0: 2020 7379 6e63 5f65 7665 6e74 7320 3d20    sync_events = 
+0001b4d0: 5b53 796e 6345 7665 6e74 2e66 726f 6d5f  [SyncEvent.from_
+0001b4e0: 6d65 7461 6461 7461 286d 642c 2073 656c  metadata(md, sel
+0001b4f0: 6629 2066 6f72 206d 6420 696e 2063 6861  f) for md in cha
+0001b500: 6e67 6573 2e65 6e74 7269 6573 5d0a 0a20  nges.entries].. 
+0001b510: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0001b520: 5f6c 6f67 6765 722e 6465 6275 6728 2243  _logger.debug("C
+0001b530: 6f6e 7665 7274 6564 2072 656d 6f74 6520  onverted remote 
+0001b540: 6368 616e 6765 7320 746f 2053 796e 6345  changes to SyncE
+0001b550: 7665 6e74 7322 290a 0a20 2020 2020 2020  vents")..       
+0001b560: 2020 2020 2079 6965 6c64 2073 796e 635f       yield sync_
+0001b570: 6576 656e 7473 2c20 6368 616e 6765 732e  events, changes.
+0001b580: 6375 7273 6f72 0a0a 2020 2020 6465 6620  cursor..    def 
+0001b590: 6170 706c 795f 7265 6d6f 7465 5f63 6861  apply_remote_cha
+0001b5a0: 6e67 6573 280a 2020 2020 2020 2020 7365  nges(.        se
+0001b5b0: 6c66 2c20 7379 6e63 5f65 7665 6e74 733a  lf, sync_events:
+0001b5c0: 2043 6f6c 6c65 6374 696f 6e5b 5379 6e63   Collection[Sync
+0001b5d0: 4576 656e 745d 0a20 2020 2029 202d 3e20  Event].    ) -> 
+0001b5e0: 6c69 7374 5b53 796e 6345 7665 6e74 5d3a  list[SyncEvent]:
+0001b5f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001b600: 2020 2020 2041 7070 6c69 6573 2072 656d       Applies rem
+0001b610: 6f74 6520 6368 616e 6765 7320 746f 206c  ote changes to l
+0001b620: 6f63 616c 2066 6f6c 6465 722e 2043 616c  ocal folder. Cal
+0001b630: 6c20 7468 6973 206f 6e20 7468 6520 7265  l this on the re
+0001b640: 7375 6c74 206f 660a 2020 2020 2020 2020  sult of.        
+0001b650: 3a6d 6574 683a 606c 6973 745f 7265 6d6f  :meth:`list_remo
+0001b660: 7465 5f63 6861 6e67 6573 602e 2054 6865  te_changes`. The
+0001b670: 2073 6176 6564 2063 7572 736f 7220 6973   saved cursor is
+0001b680: 2075 7064 6174 6564 2061 6674 6572 2061   updated after a
+0001b690: 2073 6574 206f 6620 6368 616e 6765 730a   set of changes.
+0001b6a0: 2020 2020 2020 2020 6861 7320 6265 656e          has been
+0001b6b0: 2073 7563 6365 7373 6675 6c6c 7920 6170   successfully ap
+0001b6c0: 706c 6965 642e 2045 6e74 7269 6573 2069  plied. Entries i
+0001b6d0: 6e20 7468 6520 6c6f 6361 6c20 696e 6465  n the local inde
+0001b6e0: 7820 6172 6520 6372 6561 7465 6420 6166  x are created af
+0001b6f0: 7465 720a 2020 2020 2020 2020 7375 6363  ter.        succ
+0001b700: 6573 7366 756c 2063 6f6d 706c 6574 696f  essful completio
+0001b710: 6e2e 0a0a 2020 2020 2020 2020 3a70 6172  n...        :par
+0001b720: 616d 2073 796e 635f 6576 656e 7473 3a20  am sync_events: 
+0001b730: 4c69 7374 206f 6620 7265 6d6f 7465 2063  List of remote c
+0001b740: 6861 6e67 6573 2e0a 2020 2020 2020 2020  hanges..        
+0001b750: 3a72 6574 7572 6e73 3a20 4c69 7374 206f  :returns: List o
+0001b760: 6620 6368 616e 6765 7320 7468 6174 2077  f changes that w
+0001b770: 6572 6520 6d61 6465 2074 6f20 6c6f 6361  ere made to loca
+0001b780: 6c20 6669 6c65 7320 616e 6420 626f 6f6c  l files and bool
+0001b790: 2069 6e64 6963 6174 696e 6720 6966 0a20   indicating if. 
+0001b7a0: 2020 2020 2020 2020 2020 2061 6c6c 2064             all d
+0001b7b0: 6f77 6e6c 6f61 6420 7379 6e63 7320 7765  ownload syncs we
+0001b7c0: 7265 2073 7563 6365 7373 6675 6c2e 0a20  re successful.. 
+0001b7d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001b7e0: 2020 2072 6573 756c 7473 3a20 6c69 7374     results: list
+0001b7f0: 5b53 796e 6345 7665 6e74 5d20 3d20 5b5d  [SyncEvent] = []
+0001b800: 0a0a 2020 2020 2020 2020 6966 206c 656e  ..        if len
+0001b810: 2873 796e 635f 6576 656e 7473 2920 3d3d  (sync_events) ==
+0001b820: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+0001b830: 7265 7475 726e 2072 6573 756c 7473 0a0a  return results..
+0001b840: 2020 2020 2020 2020 2320 536f 7274 2063          # Sort c
+0001b850: 6861 6e67 6573 2069 6e74 6f20 666f 6c64  hanges into fold
+0001b860: 6572 732c 2066 696c 6573 2061 6e64 2064  ers, files and d
+0001b870: 656c 6574 6564 2069 7465 6d73 2e20 4469  eleted items. Di
+0001b880: 7363 6172 6420 6578 636c 7564 6564 2069  scard excluded i
+0001b890: 7465 6d73 0a20 2020 2020 2020 2023 2061  tems.        # a
+0001b8a0: 6e64 2072 656d 6f76 6520 616e 6420 6465  nd remove and de
+0001b8b0: 6c65 7465 6420 6974 656d 7320 6672 6f6d  leted items from
+0001b8c0: 206f 7572 2065 7863 6c75 6465 6420 6c69   our excluded li
+0001b8d0: 7374 2e0a 2020 2020 2020 2020 2320 536f  st..        # So
+0001b8e0: 7274 2061 6363 6f72 6469 6e67 2074 6f20  rt according to 
+0001b8f0: 7061 7468 2068 6965 7261 7263 6879 3a0a  path hierarchy:.
+0001b900: 2020 2020 2020 2020 2320 2d20 446f 206e          # - Do n
+0001b910: 6f74 2063 7265 6174 6520 7375 622d 666f  ot create sub-fo
+0001b920: 6c64 6572 202f 2066 696c 6520 6265 666f  lder / file befo
+0001b930: 7265 2070 6172 656e 7420 6578 6973 7473  re parent exists
+0001b940: 2e0a 2020 2020 2020 2020 2320 2d20 4465  ..        # - De
+0001b950: 6c65 7465 2070 6172 656e 7473 2062 6566  lete parents bef
+0001b960: 6f72 6520 6465 6c65 7469 6e67 2063 6869  ore deleting chi
+0001b970: 6c64 7265 6e20 746f 2073 6176 6520 736f  ldren to save so
+0001b980: 6d65 2077 6f72 6b2e 0a0a 2020 2020 2020  me work...      
+0001b990: 2020 6669 6c65 733a 206c 6973 745b 5379    files: list[Sy
+0001b9a0: 6e63 4576 656e 745d 203d 205b 5d0a 2020  ncEvent] = [].  
+0001b9b0: 2020 2020 2020 666f 6c64 6572 733a 2064        folders: d
+0001b9c0: 6566 6175 6c74 6469 6374 5b69 6e74 2c20  efaultdict[int, 
+0001b9d0: 6c69 7374 5b53 796e 6345 7665 6e74 5d5d  list[SyncEvent]]
+0001b9e0: 203d 2064 6566 6175 6c74 6469 6374 286c   = defaultdict(l
+0001b9f0: 6973 7429 0a20 2020 2020 2020 2064 656c  ist).        del
+0001ba00: 6574 6564 3a20 6465 6661 756c 7464 6963  eted: defaultdic
+0001ba10: 745b 696e 742c 206c 6973 745b 5379 6e63  t[int, list[Sync
+0001ba20: 4576 656e 745d 5d20 3d20 6465 6661 756c  Event]] = defaul
+0001ba30: 7464 6963 7428 6c69 7374 290a 0a20 2020  tdict(list)..   
+0001ba40: 2020 2020 206e 6577 5f65 7863 6c75 6465       new_exclude
+0001ba50: 6420 3d20 7365 6c66 2e65 7863 6c75 6465  d = self.exclude
+0001ba60: 645f 6974 656d 730a 0a20 2020 2020 2020  d_items..       
+0001ba70: 2066 6f72 2065 7665 6e74 2069 6e20 7379   for event in sy
+0001ba80: 6e63 5f65 7665 6e74 733a 0a20 2020 2020  nc_events:.     
+0001ba90: 2020 2020 2020 2069 735f 6578 636c 7564         is_exclud
+0001baa0: 6564 203d 2073 656c 662e 6973 5f65 7863  ed = self.is_exc
+0001bab0: 6c75 6465 645f 6279 5f75 7365 7228 0a20  luded_by_user(. 
+0001bac0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001bad0: 7665 6e74 2e64 6278 5f70 6174 685f 6c6f  vent.dbx_path_lo
+0001bae0: 7765 720a 2020 2020 2020 2020 2020 2020  wer.            
+0001baf0: 2920 6f72 2073 656c 662e 6973 5f65 7863  ) or self.is_exc
+0001bb00: 6c75 6465 6428 6576 656e 742e 6462 785f  luded(event.dbx_
+0001bb10: 7061 7468 290a 0a20 2020 2020 2020 2020  path)..         
+0001bb20: 2020 2069 6620 6973 5f65 7863 6c75 6465     if is_exclude
+0001bb30: 643a 0a20 2020 2020 2020 2020 2020 2020  d:.             
 0001bb40: 2020 2069 6620 6576 656e 742e 6973 5f64     if event.is_d
 0001bb50: 656c 6574 6564 3a0a 2020 2020 2020 2020  eleted:.        
-0001bb60: 2020 2020 2020 2020 2020 2020 6465 6c65              dele
-0001bb70: 7465 645b 6c65 7665 6c5d 2e61 7070 656e  ted[level].appen
-0001bb80: 6428 6576 656e 7429 0a20 2020 2020 2020  d(event).       
-0001bb90: 2020 2020 2020 2020 2065 6c69 6620 6576           elif ev
-0001bba0: 656e 742e 6973 5f66 696c 653a 0a20 2020  ent.is_file:.   
-0001bbb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bbc0: 2066 696c 6573 2e61 7070 656e 6428 6576   files.append(ev
-0001bbd0: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
-0001bbe0: 2020 2020 2065 6c69 6620 6576 656e 742e       elif event.
-0001bbf0: 6973 5f64 6972 6563 746f 7279 3a0a 2020  is_directory:.  
-0001bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc10: 2020 666f 6c64 6572 735b 6c65 7665 6c5d    folders[level]
-0001bc20: 2e61 7070 656e 6428 6576 656e 7429 0a0a  .append(event)..
-0001bc30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc40: 2320 486f 7573 656b 6565 7069 6e67 2e0a  # Housekeeping..
-0001bc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bc60: 7365 6c66 2e61 6374 6976 6974 792e 6164  self.activity.ad
-0001bc70: 6428 6576 656e 7429 0a0a 2020 2020 2020  d(event)..      
-0001bc80: 2020 7365 6c66 2e65 7863 6c75 6465 645f    self.excluded_
-0001bc90: 6974 656d 7320 3d20 6e65 775f 6578 636c  items = new_excl
-0001bca0: 7564 6564 0a0a 2020 2020 2020 2020 2320  uded..        # 
-0001bcb0: 4170 706c 7920 6465 6c65 7465 6420 6974  Apply deleted it
-0001bcc0: 656d 732e 0a20 2020 2020 2020 2069 6620  ems..        if 
-0001bcd0: 6465 6c65 7465 643a 0a20 2020 2020 2020  deleted:.       
-0001bce0: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-0001bcf0: 722e 696e 666f 2822 4170 706c 7969 6e67  r.info("Applying
-0001bd00: 2064 656c 6574 696f 6e73 2e2e 2e22 290a   deletions...").
-0001bd10: 0a20 2020 2020 2020 2066 6f72 206c 6576  .        for lev
-0001bd20: 656c 2069 6e20 736f 7274 6564 2864 656c  el in sorted(del
-0001bd30: 6574 6564 293a 0a20 2020 2020 2020 2020  eted):.         
-0001bd40: 2020 2072 6573 203d 2064 6f5f 7061 7261     res = do_para
-0001bd50: 6c6c 656c 280a 2020 2020 2020 2020 2020  llel(.          
-0001bd60: 2020 2020 2020 7365 6c66 2e5f 6372 6561        self._crea
-0001bd70: 7465 5f6c 6f63 616c 5f65 6e74 7279 2c0a  te_local_entry,.
-0001bd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bd90: 6465 6c65 7465 645b 6c65 7665 6c5d 2c0a  deleted[level],.
-0001bda0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bdb0: 6f6e 5f70 726f 6772 6573 733d 6c61 6d62  on_progress=lamb
-0001bdc0: 6461 2078 2c20 793a 2073 656c 662e 5f6c  da x, y: self._l
-0001bdd0: 6f67 6765 722e 696e 666f 2866 2244 656c  ogger.info(f"Del
-0001bde0: 6574 696e 6720 7b78 7d2f 7b79 7d22 292c  eting {x}/{y}"),
-0001bdf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001be00: 2074 6872 6561 645f 6e61 6d65 5f70 7265   thread_name_pre
-0001be10: 6669 783d 226d 6165 7374 7261 6c2d 646f  fix="maestral-do
-0001be20: 776e 6c6f 6164 2d70 6f6f 6c22 2c0a 2020  wnload-pool",.  
-0001be30: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001be40: 2020 2020 2020 2020 7265 7375 6c74 732e          results.
-0001be50: 6578 7465 6e64 2872 6573 290a 0a20 2020  extend(res)..   
-0001be60: 2020 2020 2023 2043 7265 6174 6520 6c6f       # Create lo
-0001be70: 6361 6c20 666f 6c64 6572 732c 2073 7461  cal folders, sta
-0001be80: 7274 2077 6974 6820 746f 702d 6c65 7665  rt with top-leve
-0001be90: 6c20 616e 6420 776f 726b 2079 6f75 7220  l and work your 
-0001bea0: 7761 7920 646f 776e 2e0a 2020 2020 2020  way down..      
-0001beb0: 2020 6966 2066 6f6c 6465 7273 3a0a 2020    if folders:.  
-0001bec0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0001bed0: 6c6f 6767 6572 2e69 6e66 6f28 2243 7265  logger.info("Cre
-0001bee0: 6174 696e 6720 666f 6c64 6572 732e 2e2e  ating folders...
-0001bef0: 2229 0a0a 2020 2020 2020 2020 666f 7220  ")..        for 
-0001bf00: 6c65 7665 6c20 696e 2073 6f72 7465 6428  level in sorted(
-0001bf10: 666f 6c64 6572 7329 3a0a 2020 2020 2020  folders):.      
-0001bf20: 2020 2020 2020 7265 7320 3d20 646f 5f70        res = do_p
-0001bf30: 6172 616c 6c65 6c28 0a20 2020 2020 2020  arallel(.       
-0001bf40: 2020 2020 2020 2020 2073 656c 662e 5f63           self._c
-0001bf50: 7265 6174 655f 6c6f 6361 6c5f 656e 7472  reate_local_entr
-0001bf60: 792c 0a20 2020 2020 2020 2020 2020 2020  y,.             
-0001bf70: 2020 2066 6f6c 6465 7273 5b6c 6576 656c     folders[level
-0001bf80: 5d2c 0a20 2020 2020 2020 2020 2020 2020  ],.             
-0001bf90: 2020 206f 6e5f 7072 6f67 7265 7373 3d6c     on_progress=l
-0001bfa0: 616d 6264 6120 782c 2079 3a20 7365 6c66  ambda x, y: self
-0001bfb0: 2e5f 6c6f 6767 6572 2e69 6e66 6f28 6622  ._logger.info(f"
-0001bfc0: 4372 6561 7469 6e67 2066 6f6c 6465 7220  Creating folder 
-0001bfd0: 7b78 7d2f 7b79 7d22 292c 0a20 2020 2020  {x}/{y}"),.     
-0001bfe0: 2020 2020 2020 2020 2020 2074 6872 6561             threa
-0001bff0: 645f 6e61 6d65 5f70 7265 6669 783d 226d  d_name_prefix="m
-0001c000: 6165 7374 7261 6c2d 646f 776e 6c6f 6164  aestral-download
-0001c010: 2d70 6f6f 6c22 2c0a 2020 2020 2020 2020  -pool",.        
-0001c020: 2020 2020 290a 2020 2020 2020 2020 2020      ).          
-0001c030: 2020 7265 7375 6c74 732e 6578 7465 6e64    results.extend
-0001c040: 2872 6573 290a 0a20 2020 2020 2020 2023  (res)..        #
-0001c050: 2041 7070 6c79 2063 7265 6174 6564 2066   Apply created f
-0001c060: 696c 6573 2e0a 2020 2020 2020 2020 7265  iles..        re
-0001c070: 7320 3d20 646f 5f70 6172 616c 6c65 6c28  s = do_parallel(
-0001c080: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-0001c090: 662e 5f63 7265 6174 655f 6c6f 6361 6c5f  f._create_local_
-0001c0a0: 656e 7472 792c 0a20 2020 2020 2020 2020  entry,.         
-0001c0b0: 2020 2066 696c 6573 2c0a 2020 2020 2020     files,.      
-0001c0c0: 2020 2020 2020 6f6e 5f70 726f 6772 6573        on_progres
-0001c0d0: 733d 6c61 6d62 6461 2078 2c20 793a 2073  s=lambda x, y: s
-0001c0e0: 656c 662e 5f6c 6f67 6765 722e 696e 666f  elf._logger.info
-0001c0f0: 2866 2253 796e 6369 6e67 20e2 8693 207b  (f"Syncing ... {
-0001c100: 787d 2f7b 797d 2229 2c0a 2020 2020 2020  x}/{y}"),.      
-0001c110: 2020 2020 2020 7468 7265 6164 5f6e 616d        thread_nam
-0001c120: 655f 7072 6566 6978 3d22 6d61 6573 7472  e_prefix="maestr
-0001c130: 616c 2d64 6f77 6e6c 6f61 642d 706f 6f6c  al-download-pool
-0001c140: 222c 0a20 2020 2020 2020 2029 0a20 2020  ",.        ).   
-0001c150: 2020 2020 2072 6573 756c 7473 2e65 7874       results.ext
-0001c160: 656e 6428 7265 7329 0a0a 2020 2020 2020  end(res)..      
-0001c170: 2020 7365 6c66 2e5f 636c 6561 6e5f 6869    self._clean_hi
-0001c180: 7374 6f72 7928 290a 0a20 2020 2020 2020  story()..       
-0001c190: 2072 6574 7572 6e20 7265 7375 6c74 730a   return results.
-0001c1a0: 0a20 2020 2064 6566 206e 6f74 6966 795f  .    def notify_
-0001c1b0: 7573 6572 2873 656c 662c 2073 796e 635f  user(self, sync_
-0001c1c0: 6576 656e 7473 3a20 5365 7175 656e 6365  events: Sequence
-0001c1d0: 5b53 796e 6345 7665 6e74 5d29 202d 3e20  [SyncEvent]) -> 
-0001c1e0: 4e6f 6e65 3a0a 2020 2020 2020 2020 2222  None:.        ""
-0001c1f0: 220a 2020 2020 2020 2020 5368 6f77 7320  ".        Shows 
-0001c200: 6120 6465 736b 746f 7020 6e6f 7469 6669  a desktop notifi
-0001c210: 6361 7469 6f6e 2066 6f72 2074 6865 2067  cation for the g
-0001c220: 6976 656e 2066 696c 6520 6368 616e 6765  iven file change
-0001c230: 732e 0a0a 2020 2020 2020 2020 3a70 6172  s...        :par
-0001c240: 616d 2073 796e 635f 6576 656e 7473 3a20  am sync_events: 
-0001c250: 4c69 7374 206f 6620 5379 6e63 4576 656e  List of SyncEven
-0001c260: 7473 2066 726f 6d20 646f 776e 6c6f 6164  ts from download
-0001c270: 2073 796e 632e 0a20 2020 2020 2020 2022   sync..        "
-0001c280: 2222 0a20 2020 2020 2020 2069 6620 6e6f  "".        if no
-0001c290: 7420 7365 6c66 2e64 6573 6b74 6f70 5f6e  t self.desktop_n
-0001c2a0: 6f74 6966 6965 723a 0a20 2020 2020 2020  otifier:.       
-0001c2b0: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0001c2c0: 2020 2020 2063 6861 6e67 6573 3a20 6c69       changes: li
-0001c2d0: 7374 5b53 796e 6345 7665 6e74 5d20 3d20  st[SyncEvent] = 
-0001c2e0: 5b5d 0a20 2020 2020 2020 2065 7665 6e74  [].        event
-0001c2f0: 735f 636f 6e66 6c69 6374 3a20 6c69 7374  s_conflict: list
-0001c300: 5b53 796e 6345 7665 6e74 5d20 3d20 5b5d  [SyncEvent] = []
-0001c310: 0a0a 2020 2020 2020 2020 666f 7220 6576  ..        for ev
-0001c320: 656e 7420 696e 2073 796e 635f 6576 656e  ent in sync_even
-0001c330: 7473 3a0a 2020 2020 2020 2020 2020 2020  ts:.            
-0001c340: 6966 2065 7665 6e74 2e73 7461 7475 7320  if event.status 
-0001c350: 6973 206e 6f74 2053 796e 6353 7461 7475  is not SyncStatu
-0001c360: 732e 536b 6970 7065 643a 0a20 2020 2020  s.Skipped:.     
-0001c370: 2020 2020 2020 2020 2020 2063 6861 6e67             chang
-0001c380: 6573 2e61 7070 656e 6428 6576 656e 7429  es.append(event)
-0001c390: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001c3a0: 6576 656e 742e 7374 6174 7573 2069 7320  event.status is 
-0001c3b0: 5379 6e63 5374 6174 7573 2e43 6f6e 666c  SyncStatus.Confl
-0001c3c0: 6963 743a 0a20 2020 2020 2020 2020 2020  ict:.           
-0001c3d0: 2020 2020 2065 7665 6e74 735f 636f 6e66       events_conf
-0001c3e0: 6c69 6374 2e61 7070 656e 6428 6576 656e  lict.append(even
-0001c3f0: 7429 0a0a 2020 2020 2020 2020 2320 4765  t)..        # Ge
-0001c400: 7420 6e75 6d62 6572 206f 6620 7265 6d6f  t number of remo
-0001c410: 7465 2063 6861 6e67 6573 2e0a 2020 2020  te changes..    
-0001c420: 2020 2020 6e5f 6368 616e 6765 6420 3d20      n_changed = 
-0001c430: 6c65 6e28 6368 616e 6765 7329 0a0a 2020  len(changes)..  
-0001c440: 2020 2020 2020 6966 206e 5f63 6861 6e67        if n_chang
-0001c450: 6564 203d 3d20 303a 0a20 2020 2020 2020  ed == 0:.       
-0001c460: 2020 2020 2072 6574 7572 6e0a 0a20 2020       return..   
-0001c470: 2020 2020 2023 2046 696e 6420 6f75 7420       # Find out 
-0001c480: 7768 6f20 6368 616e 6765 6420 7468 6520  who changed the 
-0001c490: 6974 656d 2873 292e 0a20 2020 2020 2020  item(s)..       
-0001c4a0: 2075 7365 725f 6e61 6d65 3a20 7374 7220   user_name: str 
-0001c4b0: 7c20 4e6f 6e65 0a20 2020 2020 2020 2064  | None.        d
-0001c4c0: 6269 645f 7365 7420 3d20 7b65 2e63 6861  bid_set = {e.cha
-0001c4d0: 6e67 655f 6462 6964 2066 6f72 2065 2069  nge_dbid for e i
-0001c4e0: 6e20 6368 616e 6765 737d 0a20 2020 2020  n changes}.     
-0001c4f0: 2020 2069 6620 6c65 6e28 6462 6964 5f73     if len(dbid_s
-0001c500: 6574 2920 3d3d 2031 3a0a 2020 2020 2020  et) == 1:.      
-0001c510: 2020 2020 2020 2320 416c 6c20 6669 6c65        # All file
-0001c520: 7320 6861 7665 2062 6565 6e20 6d6f 6469  s have been modi
-0001c530: 6669 6564 2062 7920 7468 6520 7361 6d65  fied by the same
-0001c540: 2075 7365 720a 2020 2020 2020 2020 2020   user.          
-0001c550: 2020 6462 6964 203d 2064 6269 645f 7365    dbid = dbid_se
-0001c560: 742e 706f 7028 290a 2020 2020 2020 2020  t.pop().        
-0001c570: 2020 2020 6966 2064 6269 6420 3d3d 2073      if dbid == s
-0001c580: 656c 662e 636c 6965 6e74 2e61 6363 6f75  elf.client.accou
-0001c590: 6e74 5f69 6e66 6f2e 6163 636f 756e 745f  nt_info.account_
-0001c5a0: 6964 3a0a 2020 2020 2020 2020 2020 2020  id:.            
-0001c5b0: 2020 2020 7573 6572 5f6e 616d 6520 3d20      user_name = 
-0001c5c0: 2259 6f75 220a 2020 2020 2020 2020 2020  "You".          
-0001c5d0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001c5e0: 2020 2020 2020 2020 7573 6572 5f6e 616d          user_nam
-0001c5f0: 6520 3d20 7365 6c66 2e5f 6469 7370 6c61  e = self._displa
-0001c600: 795f 6e61 6d65 5f66 6f72 5f61 6363 6f75  y_name_for_accou
-0001c610: 6e74 2864 6269 6429 0a20 2020 2020 2020  nt(dbid).       
-0001c620: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001c630: 2020 2023 2044 6f6e 2774 2064 6973 706c     # Don't displ
-0001c640: 6179 206d 756c 7469 706c 6520 7573 6572  ay multiple user
-0001c650: 6e61 6d65 7320 696e 206e 6f74 6966 6963  names in notific
-0001c660: 6174 696f 6e2e 0a20 2020 2020 2020 2020  ation..         
-0001c670: 2020 2075 7365 725f 6e61 6d65 203d 204e     user_name = N
-0001c680: 6f6e 650a 0a20 2020 2020 2020 2062 7574  one..        but
-0001c690: 746f 6e73 3a20 6469 6374 5b73 7472 2c20  tons: dict[str, 
-0001c6a0: 4361 6c6c 6162 6c65 5b5b 5d2c 204e 6f6e  Callable[[], Non
-0001c6b0: 655d 5d0a 0a20 2020 2020 2020 2069 6620  e]]..        if 
-0001c6c0: 6e5f 6368 616e 6765 6420 3d3d 2031 3a0a  n_changed == 1:.
-0001c6d0: 2020 2020 2020 2020 2020 2020 2320 4469              # Di
-0001c6e0: 7370 6c61 7920 7468 6520 7573 6572 6e61  splay the userna
-0001c6f0: 6d65 2c20 6669 6c65 206e 616d 652c 2061  me, file name, a
-0001c700: 6e64 2074 7970 6520 6f66 2063 6861 6e67  nd type of chang
-0001c710: 6520 696e 206e 6f74 6966 6963 6174 696f  e in notificatio
-0001c720: 6e2e 0a20 2020 2020 2020 2020 2020 2065  n..            e
-0001c730: 7665 6e74 203d 2063 6861 6e67 6573 5b30  vent = changes[0
-0001c740: 5d0a 2020 2020 2020 2020 2020 2020 6669  ].            fi
-0001c750: 6c65 5f6e 616d 6520 3d20 6f73 702e 6261  le_name = osp.ba
-0001c760: 7365 6e61 6d65 2865 7665 6e74 2e64 6278  sename(event.dbx
-0001c770: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-0001c780: 2020 2063 6861 6e67 655f 7479 7065 203d     change_type =
-0001c790: 2065 7665 6e74 2e63 6861 6e67 655f 7479   event.change_ty
-0001c7a0: 7065 2e76 616c 7565 0a0a 2020 2020 2020  pe.value..      
-0001c7b0: 2020 2020 2020 6465 6620 6361 6c6c 6261        def callba
-0001c7c0: 636b 2829 202d 3e20 4e6f 6e65 3a0a 2020  ck() -> None:.  
-0001c7d0: 2020 2020 2020 2020 2020 2020 2020 636c                cl
-0001c7e0: 6963 6b2e 6c61 756e 6368 2865 7665 6e74  ick.launch(event
-0001c7f0: 2e6c 6f63 616c 5f70 6174 682c 206c 6f63  .local_path, loc
-0001c800: 6174 653d 5472 7565 290a 0a20 2020 2020  ate=True)..     
-0001c810: 2020 2020 2020 2062 7574 746f 6e73 203d         buttons =
-0001c820: 207b 2253 686f 7722 3a20 6361 6c6c 6261   {"Show": callba
-0001c830: 636b 7d0a 0a20 2020 2020 2020 2065 6c73  ck}..        els
-0001c840: 653a 0a20 2020 2020 2020 2020 2020 2023  e:.            #
-0001c850: 2044 6973 706c 6179 2074 6865 206e 756d   Display the num
-0001c860: 6265 7220 6f66 2066 696c 6573 2063 6861  ber of files cha
-0001c870: 6e67 6564 2061 6e64 2070 6f74 656e 7469  nged and potenti
-0001c880: 616c 6c79 2074 6865 2074 7970 6520 6f66  ally the type of
-0001c890: 2063 6861 6e67 6520 696e 0a20 2020 2020   change in.     
-0001c8a0: 2020 2020 2020 2023 206e 6f74 6966 6963         # notific
-0001c8b0: 6174 696f 6e2e 0a0a 2020 2020 2020 2020  ation...        
-0001c8c0: 2020 2020 6966 2061 6c6c 2865 2e63 6861      if all(e.cha
-0001c8d0: 6e67 655f 7479 7065 203d 3d20 7379 6e63  nge_type == sync
-0001c8e0: 5f65 7665 6e74 735b 305d 2e63 6861 6e67  _events[0].chang
-0001c8f0: 655f 7479 7065 2066 6f72 2065 2069 6e20  e_type for e in 
-0001c900: 7379 6e63 5f65 7665 6e74 7329 3a0a 2020  sync_events):.  
-0001c910: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-0001c920: 616e 6765 5f74 7970 6520 3d20 7379 6e63  ange_type = sync
-0001c930: 5f65 7665 6e74 735b 305d 2e63 6861 6e67  _events[0].chang
-0001c940: 655f 7479 7065 2e76 616c 7565 0a20 2020  e_type.value.   
-0001c950: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-0001c960: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001c970: 6861 6e67 655f 7479 7065 203d 2022 6368  hange_type = "ch
-0001c980: 616e 6765 6422 0a0a 2020 2020 2020 2020  anged"..        
-0001c990: 2020 2020 6966 2061 6c6c 2865 2e69 735f      if all(e.is_
-0001c9a0: 6669 6c65 2066 6f72 2065 2069 6e20 7379  file for e in sy
-0001c9b0: 6e63 5f65 7665 6e74 7329 3a0a 2020 2020  nc_events):.    
-0001c9c0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
-0001c9d0: 5f6e 616d 6520 3d20 6622 7b6e 5f63 6861  _name = f"{n_cha
-0001c9e0: 6e67 6564 7d20 6669 6c65 7322 0a20 2020  nged} files".   
-0001c9f0: 2020 2020 2020 2020 2065 6c69 6620 616c           elif al
-0001ca00: 6c28 652e 6973 5f64 6972 6563 746f 7279  l(e.is_directory
-0001ca10: 2066 6f72 2065 2069 6e20 7379 6e63 5f65   for e in sync_e
-0001ca20: 7665 6e74 7329 3a0a 2020 2020 2020 2020  vents):.        
-0001ca30: 2020 2020 2020 2020 6669 6c65 5f6e 616d          file_nam
-0001ca40: 6520 3d20 6622 7b6e 5f63 6861 6e67 6564  e = f"{n_changed
-0001ca50: 7d20 666f 6c64 6572 7322 0a20 2020 2020  } folders".     
-0001ca60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001ca70: 2020 2020 2020 2020 2020 2020 2066 696c               fil
-0001ca80: 655f 6e61 6d65 203d 2066 227b 6e5f 6368  e_name = f"{n_ch
-0001ca90: 616e 6765 647d 2069 7465 6d73 220a 0a20  anged} items".. 
-0001caa0: 2020 2020 2020 2020 2020 2064 6566 2063             def c
-0001cab0: 616c 6c62 6163 6b28 2920 2d3e 204e 6f6e  allback() -> Non
-0001cac0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001cad0: 2020 2070 6173 730a 0a20 2020 2020 2020     pass..       
-0001cae0: 2020 2020 2062 7574 746f 6e73 203d 207b       buttons = {
-0001caf0: 7d0a 0a20 2020 2020 2020 2069 6620 6368  }..        if ch
-0001cb00: 616e 6765 5f74 7970 6520 3d3d 2043 6861  ange_type == Cha
-0001cb10: 6e67 6554 7970 652e 5265 6d6f 7665 642e  ngeType.Removed.
-0001cb20: 7661 6c75 653a 0a0a 2020 2020 2020 2020  value:..        
-0001cb30: 2020 2020 6465 6620 6361 6c6c 6261 636b      def callback
-0001cb40: 2829 202d 3e20 4e6f 6e65 3a0a 2020 2020  () -> None:.    
-0001cb50: 2020 2020 2020 2020 2020 2020 2320 5368              # Sh
-0001cb60: 6f77 2044 726f 7062 6f78 2077 6562 7369  ow Dropbox websi
-0001cb70: 7465 2077 6974 6820 6465 6c65 7465 6420  te with deleted 
-0001cb80: 6669 6c65 732e 0a20 2020 2020 2020 2020  files..         
-0001cb90: 2020 2020 2020 2063 6c69 636b 2e6c 6175         click.lau
-0001cba0: 6e63 6828 2268 7474 7073 3a2f 2f77 7777  nch("https://www
-0001cbb0: 2e64 726f 7062 6f78 2e63 6f6d 2f64 656c  .dropbox.com/del
-0001cbc0: 6574 6564 5f66 696c 6573 2229 0a0a 2020  eted_files")..  
-0001cbd0: 2020 2020 2020 2020 2020 6275 7474 6f6e            button
-0001cbe0: 7320 3d20 7b22 5368 6f77 223a 2063 616c  s = {"Show": cal
-0001cbf0: 6c62 6163 6b7d 0a0a 2020 2020 2020 2020  lback}..        
-0001cc00: 6966 2075 7365 725f 6e61 6d65 3a0a 2020  if user_name:.  
-0001cc10: 2020 2020 2020 2020 2020 6d73 6720 3d20            msg = 
-0001cc20: 6622 7b75 7365 725f 6e61 6d65 7d20 7b63  f"{user_name} {c
-0001cc30: 6861 6e67 655f 7479 7065 7d20 7b66 696c  hange_type} {fil
-0001cc40: 655f 6e61 6d65 7d22 0a20 2020 2020 2020  e_name}".       
-0001cc50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001cc60: 2020 206d 7367 203d 2066 227b 6669 6c65     msg = f"{file
-0001cc70: 5f6e 616d 657d 207b 6368 616e 6765 5f74  _name} {change_t
-0001cc80: 7970 657d 220a 0a20 2020 2020 2020 2023  ype}"..        #
-0001cc90: 204e 6f74 6966 7920 696e 2062 756c 6b20   Notify in bulk 
-0001cca0: 666f 7220 616c 6c20 6261 7463 6865 6420  for all batched 
-0001ccb0: 6368 616e 6765 732e 0a20 2020 2020 2020  changes..       
-0001ccc0: 2073 656c 662e 6465 736b 746f 705f 6e6f   self.desktop_no
-0001ccd0: 7469 6669 6572 2e6e 6f74 6966 7928 0a20  tifier.notify(. 
-0001cce0: 2020 2020 2020 2020 2020 2022 4974 656d             "Item
-0001ccf0: 7320 7379 6e63 6564 222c 206d 7367 2c20  s synced", msg, 
-0001cd00: 6163 7469 6f6e 733d 6275 7474 6f6e 732c  actions=buttons,
-0001cd10: 206f 6e5f 636c 6963 6b3d 6361 6c6c 6261   on_click=callba
-0001cd20: 636b 0a20 2020 2020 2020 2029 0a0a 2020  ck.        )..  
-0001cd30: 2020 2020 2020 2320 4e6f 7469 6679 2073        # Notify s
-0001cd40: 6570 6172 6174 656c 7920 666f 7220 6561  eparately for ea
-0001cd50: 6368 2073 796e 6320 636f 6e66 6c69 6374  ch sync conflict
-0001cd60: 2e0a 2020 2020 2020 2020 666f 7220 6576  ..        for ev
-0001cd70: 656e 7420 696e 2065 7665 6e74 735f 636f  ent in events_co
-0001cd80: 6e66 6c69 6374 3a0a 0a20 2020 2020 2020  nflict:..       
-0001cd90: 2020 2020 2064 6566 2063 616c 6c62 6163       def callbac
-0001cda0: 6b28 2920 2d3e 204e 6f6e 653a 0a20 2020  k() -> None:.   
-0001cdb0: 2020 2020 2020 2020 2020 2020 2063 6c69               cli
-0001cdc0: 636b 2e6c 6175 6e63 6828 6576 656e 742e  ck.launch(event.
-0001cdd0: 6c6f 6361 6c5f 7061 7468 2c20 6c6f 6361  local_path, loca
-0001cde0: 7465 3d54 7275 6529 0a0a 2020 2020 2020  te=True)..      
-0001cdf0: 2020 2020 2020 7365 6c66 2e64 6573 6b74        self.deskt
-0001ce00: 6f70 5f6e 6f74 6966 6965 722e 6e6f 7469  op_notifier.noti
-0001ce10: 6679 280a 2020 2020 2020 2020 2020 2020  fy(.            
-0001ce20: 2020 2020 2253 796e 6320 636f 6e66 6c69      "Sync confli
-0001ce30: 6374 222c 0a20 2020 2020 2020 2020 2020  ct",.           
-0001ce40: 2020 2020 2066 2243 6f6e 666c 6963 7469       f"Conflicti
-0001ce50: 6e67 2063 6f70 7920 666f 7220 7b66 696c  ng copy for {fil
-0001ce60: 655f 6e61 6d65 7d22 2c0a 2020 2020 2020  e_name}",.      
-0001ce70: 2020 2020 2020 2020 2020 6163 7469 6f6e            action
-0001ce80: 733d 7b22 5368 6f77 223a 2063 616c 6c62  s={"Show": callb
-0001ce90: 6163 6b7d 2c0a 2020 2020 2020 2020 2020  ack},.          
-0001cea0: 2020 2020 2020 6f6e 5f63 6c69 636b 3d63        on_click=c
-0001ceb0: 616c 6c62 6163 6b2c 0a20 2020 2020 2020  allback,.       
-0001cec0: 2020 2020 2029 0a0a 2020 2020 6465 6620       )..    def 
-0001ced0: 5f64 6973 706c 6179 5f6e 616d 655f 666f  _display_name_fo
-0001cee0: 725f 6163 636f 756e 7428 7365 6c66 2c20  r_account(self, 
-0001cef0: 6462 6964 3a20 7374 7220 7c20 4e6f 6e65  dbid: str | None
-0001cf00: 2920 2d3e 2073 7472 207c 204e 6f6e 653a  ) -> str | None:
-0001cf10: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
-0001cf20: 2020 2020 2052 6574 7572 6e73 2074 6865       Returns the
-0001cf30: 2064 6973 706c 6179 206e 616d 6520 636f   display name co
-0001cf40: 7272 6573 706f 6e64 696e 6720 746f 2061  rresponding to a
-0001cf50: 2044 726f 7062 6f78 2049 442e 0a20 2020   Dropbox ID..   
-0001cf60: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
-0001cf70: 2069 6620 6462 6964 2069 7320 4e6f 6e65   if dbid is None
-0001cf80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001cf90: 7475 726e 204e 6f6e 650a 2020 2020 2020  turn None.      
-0001cfa0: 2020 6966 2064 6269 6420 3d3d 2073 656c    if dbid == sel
-0001cfb0: 662e 636c 6965 6e74 2e61 6363 6f75 6e74  f.client.account
-0001cfc0: 5f69 6e66 6f2e 6163 636f 756e 745f 6964  _info.account_id
-0001cfd0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
-0001cfe0: 5265 7475 726e 2063 6163 6865 6420 6469  Return cached di
-0001cff0: 7370 6c61 7920 6e61 6d65 0a20 2020 2020  splay name.     
-0001d000: 2020 2020 2020 2072 6574 7572 6e20 7365         return se
-0001d010: 6c66 2e63 6c69 656e 742e 6163 636f 756e  lf.client.accoun
-0001d020: 745f 696e 666f 2e64 6973 706c 6179 5f6e  t_info.display_n
-0001d030: 616d 650a 0a20 2020 2020 2020 2074 7279  ame..        try
-0001d040: 3a0a 2020 2020 2020 2020 2020 2020 6163  :.            ac
-0001d050: 636f 756e 745f 696e 666f 203d 2073 656c  count_info = sel
-0001d060: 662e 636c 6965 6e74 2e67 6574 5f61 6363  f.client.get_acc
-0001d070: 6f75 6e74 5f69 6e66 6f28 6462 6964 290a  ount_info(dbid).
-0001d080: 2020 2020 2020 2020 6578 6365 7074 2049          except I
-0001d090: 6e76 616c 6964 4462 6964 4572 726f 723a  nvalidDbidError:
-0001d0a0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-0001d0b0: 7572 6e20 4e6f 6e65 0a20 2020 2020 2020  urn None.       
-0001d0c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001d0d0: 2020 2072 6574 7572 6e20 6163 636f 756e     return accoun
-0001d0e0: 745f 696e 666f 2e64 6973 706c 6179 5f6e  t_info.display_n
-0001d0f0: 616d 650a 0a20 2020 2064 6566 205f 6368  ame..    def _ch
-0001d100: 6563 6b5f 646f 776e 6c6f 6164 5f63 6f6e  eck_download_con
-0001d110: 666c 6963 7428 7365 6c66 2c20 6576 656e  flict(self, even
-0001d120: 743a 2053 796e 6345 7665 6e74 2920 2d3e  t: SyncEvent) ->
-0001d130: 2043 6f6e 666c 6963 743a 0a20 2020 2020   Conflict:.     
-0001d140: 2020 2022 2222 0a20 2020 2020 2020 2043     """.        C
-0001d150: 6865 636b 2069 6620 6120 6c6f 6361 6c20  heck if a local 
-0001d160: 6974 656d 2069 7320 636f 6e66 6c69 6374  item is conflict
-0001d170: 696e 6720 7769 7468 2072 656d 6f74 6520  ing with remote 
-0001d180: 6368 616e 6765 2e20 5468 6520 6571 7569  change. The equi
-0001d190: 7661 6c65 6e74 2063 6865 636b 0a20 2020  valent check.   
-0001d1a0: 2020 2020 2077 6865 6e20 7570 6c6f 6164       when upload
-0001d1b0: 696e 6720 616e 6420 6120 6368 616e 6765  ing and a change
-0001d1c0: 2077 696c 6c20 6265 2063 6172 7269 6564   will be carried
-0001d1d0: 206f 7574 2062 7920 4472 6f70 626f 7820   out by Dropbox 
-0001d1e0: 6974 7365 6c66 2e0a 0a20 2020 2020 2020  itself...       
-0001d1f0: 2043 6865 636b 7320 6172 6520 6361 7272   Checks are carr
-0001d200: 6965 6420 6f75 7420 6167 6169 6e73 7420  ied out against 
-0001d210: 6f75 7220 696e 6465 782c 2072 6566 6c65  our index, refle
-0001d220: 6374 696e 6720 7468 6520 6c61 7465 7374  cting the latest
-0001d230: 2073 796e 6320 7374 6174 652e 0a20 2020   sync state..   
-0001d240: 2020 2020 2057 6520 636f 6d70 6172 6520       We compare 
-0001d250: 7468 6520 666f 6c6c 6f77 696e 6720 7661  the following va
-0001d260: 6c75 6573 3a0a 0a20 2020 2020 2020 2031  lues:..        1
-0001d270: 2920 4c6f 6361 6c20 7673 2072 656d 6f74  ) Local vs remot
-0001d280: 6520 7265 763a 2027 666f 6c64 6572 2720  e rev: 'folder' 
-0001d290: 666f 7220 666f 6c64 6572 732c 2061 6374  for folders, act
-0001d2a0: 7561 6c20 7265 7669 7369 6f6e 2066 6f72  ual revision for
-0001d2b0: 2066 696c 6573 2061 6e64 204e 6f6e 650a   files and None.
-0001d2c0: 2020 2020 2020 2020 2020 2066 6f72 2064             for d
-0001d2d0: 656c 6574 6564 206f 7220 6e6f 7420 7072  eleted or not pr
-0001d2e0: 6573 656e 7420 6974 656d 732e 0a20 2020  esent items..   
-0001d2f0: 2020 2020 2032 2920 4c6f 6361 6c20 7673       2) Local vs
-0001d300: 2072 656d 6f74 6520 636f 6e74 656e 7420   remote content 
-0001d310: 6861 7368 3a20 2766 6f6c 6465 7227 2066  hash: 'folder' f
-0001d320: 6f72 2066 6f6c 6465 7273 2c20 6163 7475  or folders, actu
-0001d330: 616c 2068 6173 6820 666f 7220 6669 6c65  al hash for file
-0001d340: 7320 616e 640a 2020 2020 2020 2020 2020  s and.          
-0001d350: 204e 6f6e 6520 666f 7220 6465 6c65 7469   None for deleti
-0001d360: 6f6e 732e 0a20 2020 2020 2020 2033 2920  ons..        3) 
-0001d370: 4c6f 6361 6c20 6374 696d 6520 7673 206c  Local ctime vs l
-0001d380: 6173 7420 7379 6e63 2074 696d 653a 2054  ast sync time: T
-0001d390: 6869 7320 6973 2063 616c 6375 6c61 7465  his is calculate
-0001d3a0: 6420 7265 6375 7273 6976 656c 7920 666f  d recursively fo
-0001d3b0: 7220 666f 6c64 6572 732e 0a0a 2020 2020  r folders...    
-0001d3c0: 2020 2020 3a70 6172 616d 2065 7665 6e74      :param event
-0001d3d0: 3a20 446f 776e 6c6f 6164 2053 796e 6345  : Download SyncE
-0001d3e0: 7665 6e74 2e0a 2020 2020 2020 2020 3a72  vent..        :r
-0001d3f0: 6574 7572 6e73 3a20 436f 6e66 6c69 6374  eturns: Conflict
-0001d400: 2063 6865 636b 2072 6573 756c 742e 0a20   check result.. 
-0001d410: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
-0001d420: 2020 206c 6f63 616c 5f72 6576 203d 2073     local_rev = s
-0001d430: 656c 662e 6765 745f 6c6f 6361 6c5f 7265  elf.get_local_re
-0001d440: 7628 6576 656e 742e 6462 785f 7061 7468  v(event.dbx_path
-0001d450: 5f6c 6f77 6572 290a 0a20 2020 2020 2020  _lower)..       
-0001d460: 2077 6974 6820 636f 6e76 6572 745f 6170   with convert_ap
-0001d470: 695f 6572 726f 7273 2865 7665 6e74 2e64  i_errors(event.d
-0001d480: 6278 5f70 6174 682c 2065 7665 6e74 2e6c  bx_path, event.l
-0001d490: 6f63 616c 5f70 6174 6829 3a0a 2020 2020  ocal_path):.    
-0001d4a0: 2020 2020 2020 2020 6c6f 6361 6c5f 7379          local_sy
-0001d4b0: 6d6c 696e 6b5f 7461 7267 6574 203d 2067  mlink_target = g
-0001d4c0: 6574 5f73 796d 6c69 6e6b 5f74 6172 6765  et_symlink_targe
-0001d4d0: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
-0001d4e0: 7468 290a 0a20 2020 2020 2020 2069 6620  th)..        if 
-0001d4f0: 6576 656e 742e 7265 7620 3d3d 206c 6f63  event.rev == loc
-0001d500: 616c 5f72 6576 3a0a 2020 2020 2020 2020  al_rev:.        
-0001d510: 2020 2020 2320 4c6f 6361 6c20 6368 616e      # Local chan
-0001d520: 6765 2068 6173 2074 6865 2073 616d 6520  ge has the same 
-0001d530: 7265 762e 2054 6865 206c 6f63 616c 2069  rev. The local i
-0001d540: 7465 6d20 286f 7220 6465 6c65 7469 6f6e  tem (or deletion
-0001d550: 2920 6d75 7374 2062 6520 6e65 7765 720a  ) must be newer.
-0001d560: 2020 2020 2020 2020 2020 2020 2320 616e              # an
-0001d570: 6420 6e6f 7420 7965 7420 7379 6e63 6564  d not yet synced
-0001d580: 206f 7220 6964 656e 7469 6361 6c20 746f   or identical to
-0001d590: 2074 6865 2072 656d 6f74 6520 7374 6174   the remote stat
-0001d5a0: 652e 2044 6f6e 2774 206f 7665 7277 7269  e. Don't overwri
-0001d5b0: 7465 2e0a 2020 2020 2020 2020 2020 2020  te..            
-0001d5c0: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
-0001d5d0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0001d5e0: 2020 2020 2745 7175 616c 2072 6576 7320      'Equal revs 
-0001d5f0: 666f 7220 2225 7322 3a20 6c6f 6361 6c20  for "%s": local 
-0001d600: 6974 656d 2069 7320 7468 6520 7361 6d65  item is the same
-0001d610: 206f 7220 6e65 7765 7220 270a 2020 2020   or newer '.    
-0001d620: 2020 2020 2020 2020 2020 2020 2274 6861              "tha
-0001d630: 6e20 6f6e 2044 726f 7062 6f78 222c 0a20  n on Dropbox",. 
-0001d640: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-0001d650: 7665 6e74 2e64 6278 5f70 6174 682c 0a20  vent.dbx_path,. 
-0001d660: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001d670: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001d680: 436f 6e66 6c69 6374 2e4c 6f63 616c 4e65  Conflict.LocalNe
-0001d690: 7765 724f 7249 6465 6e74 6963 616c 0a0a  werOrIdentical..
-0001d6a0: 2020 2020 2020 2020 656c 6966 2028 0a20          elif (. 
-0001d6b0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-0001d6c0: 2e63 6f6e 7465 6e74 5f68 6173 6820 3d3d  .content_hash ==
-0001d6d0: 2073 656c 662e 6765 745f 6c6f 6361 6c5f   self.get_local_
-0001d6e0: 6861 7368 2865 7665 6e74 2e6c 6f63 616c  hash(event.local
-0001d6f0: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
-0001d700: 2020 2061 6e64 2065 7665 6e74 2e73 796d     and event.sym
-0001d710: 6c69 6e6b 5f74 6172 6765 7420 3d3d 206c  link_target == l
-0001d720: 6f63 616c 5f73 796d 6c69 6e6b 5f74 6172  ocal_symlink_tar
-0001d730: 6765 740a 2020 2020 2020 2020 293a 0a20  get.        ):. 
-0001d740: 2020 2020 2020 2020 2020 2023 2043 6f6e             # Con
-0001d750: 7465 6e74 2068 6173 6865 7320 6172 6520  tent hashes are 
-0001d760: 6571 7561 6c2c 2074 6865 7265 666f 7265  equal, therefore
-0001d770: 2069 7465 6d73 2061 7265 2069 6465 6e74   items are ident
-0001d780: 6963 616c 2e20 466f 6c64 6572 7320 7769  ical. Folders wi
-0001d790: 6c6c 0a20 2020 2020 2020 2020 2020 2023  ll.            #
-0001d7a0: 2068 6176 6520 6120 636f 6e74 656e 7420   have a content 
-0001d7b0: 6861 7368 206f 6620 2766 6f6c 6465 7227  hash of 'folder'
-0001d7c0: 2e0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-0001d7d0: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
-0001d7e0: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-0001d7f0: 2020 2745 7175 616c 2063 6f6e 7465 6e74    'Equal content
-0001d800: 2068 6173 6865 7320 666f 7220 2225 7322   hashes for "%s"
-0001d810: 3a20 6e6f 2063 6f6e 666c 6963 7427 2c20  : no conflict', 
-0001d820: 6576 656e 742e 6462 785f 7061 7468 0a20  event.dbx_path. 
-0001d830: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
-0001d840: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
-0001d850: 436f 6e66 6c69 6374 2e49 6465 6e74 6963  Conflict.Identic
-0001d860: 616c 0a20 2020 2020 2020 2065 6c69 6620  al.        elif 
-0001d870: 280a 2020 2020 2020 2020 2020 2020 6c65  (.            le
-0001d880: 6e28 0a20 2020 2020 2020 2020 2020 2020  n(.             
-0001d890: 2020 2073 656c 662e 7379 6e63 5f65 7272     self.sync_err
-0001d8a0: 6f72 735f 666f 725f 7061 7468 280a 2020  ors_for_path(.  
-0001d8b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001d8c0: 2020 6576 656e 742e 6462 785f 7061 7468    event.dbx_path
-0001d8d0: 5f6c 6f77 6572 2c20 6469 7265 6374 696f  _lower, directio
-0001d8e0: 6e3d 5379 6e63 4469 7265 6374 696f 6e2e  n=SyncDirection.
-0001d8f0: 5570 0a20 2020 2020 2020 2020 2020 2020  Up.             
-0001d900: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-0001d910: 2029 0a20 2020 2020 2020 2020 2020 203e   ).            >
-0001d920: 2030 0a20 2020 2020 2020 2029 3a0a 2020   0.        ):.  
-0001d930: 2020 2020 2020 2020 2020 2320 4c6f 6361            # Loca
-0001d940: 6c20 7665 7273 696f 6e20 636f 756c 6420  l version could 
-0001d950: 6e6f 7420 6265 2075 706c 6f61 6465 6420  not be uploaded 
-0001d960: 6475 6520 746f 2061 2073 796e 6320 6572  due to a sync er
-0001d970: 726f 722e 2044 6f20 6e6f 740a 2020 2020  ror. Do not.    
-0001d980: 2020 2020 2020 2020 2320 6f76 6572 2d77          # over-w
-0001d990: 7269 7465 2075 6e73 796e 6365 6420 6368  rite unsynced ch
-0001d9a0: 616e 6765 7320 6275 7420 6465 636c 6172  anges but declar
-0001d9b0: 6520 6120 636f 6e66 6c69 6374 2e0a 2020  e a conflict..  
-0001d9c0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
-0001d9d0: 6c6f 6767 6572 2e64 6562 7567 280a 2020  logger.debug(.  
-0001d9e0: 2020 2020 2020 2020 2020 2020 2020 2755                'U
-0001d9f0: 6e72 6573 6f6c 7665 6420 7570 6c6f 6164  nresolved upload
-0001da00: 2065 7272 6f72 2066 6f72 2022 2573 223a   error for "%s":
-0001da10: 2063 6f6e 666c 6963 7427 2c20 6576 656e   conflict', even
-0001da20: 742e 6462 785f 7061 7468 0a20 2020 2020  t.dbx_path.     
-0001da30: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-0001da40: 2020 2020 2072 6574 7572 6e20 436f 6e66       return Conf
-0001da50: 6c69 6374 2e43 6f6e 666c 6963 740a 2020  lict.Conflict.  
-0001da60: 2020 2020 2020 656c 6966 206e 6f74 2073        elif not s
-0001da70: 656c 662e 5f63 7469 6d65 5f6e 6577 6572  elf._ctime_newer
-0001da80: 5f74 6861 6e5f 6c61 7374 5f73 796e 6328  _than_last_sync(
-0001da90: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-0001daa0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
-0001dab0: 204c 6173 7420 6368 616e 6765 2074 696d   Last change tim
-0001dac0: 6520 6f66 206c 6f63 616c 2069 7465 6d20  e of local item 
-0001dad0: 2872 6563 7572 7369 7665 2066 6f72 2066  (recursive for f
-0001dae0: 6f6c 6465 7273 2920 6973 206f 6c64 6572  olders) is older
-0001daf0: 2074 6861 6e0a 2020 2020 2020 2020 2020   than.          
-0001db00: 2020 2320 7468 6520 6c61 7374 2074 696d    # the last tim
-0001db10: 6520 7468 6520 6974 656d 2077 6173 2073  e the item was s
-0001db20: 796e 6365 642e 2052 656d 6f74 6520 6d75  ynced. Remote mu
-0001db30: 7374 2062 6520 6e65 7765 722e 0a20 2020  st be newer..   
-0001db40: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
-0001db50: 6f67 6765 722e 6465 6275 6728 0a20 2020  ogger.debug(.   
-0001db60: 2020 2020 2020 2020 2020 2020 2027 4c6f               'Lo
-0001db70: 6361 6c20 6974 656d 2022 2573 2220 6861  cal item "%s" ha
-0001db80: 7320 6e6f 2075 6e73 796e 6365 6420 6368  s no unsynced ch
-0001db90: 616e 6765 733a 2072 656d 6f74 6520 6974  anges: remote it
-0001dba0: 656d 2069 7320 6e65 7765 7227 2c0a 2020  em is newer',.  
-0001dbb0: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-0001dbc0: 656e 742e 6462 785f 7061 7468 2c0a 2020  ent.dbx_path,.  
-0001dbd0: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001dbe0: 2020 2020 2020 2020 7265 7475 726e 2043          return C
-0001dbf0: 6f6e 666c 6963 742e 5265 6d6f 7465 4e65  onflict.RemoteNe
-0001dc00: 7765 720a 2020 2020 2020 2020 656c 6966  wer.        elif
-0001dc10: 2065 7665 6e74 2e69 735f 6465 6c65 7465   event.is_delete
-0001dc20: 643a 0a20 2020 2020 2020 2020 2020 2023  d:.            #
-0001dc30: 2052 656d 6f74 6520 6974 656d 2077 6173   Remote item was
-0001dc40: 2064 656c 6574 6564 2062 7574 206c 6f63   deleted but loc
-0001dc50: 616c 2069 7465 6d20 6861 7320 6265 656e  al item has been
-0001dc60: 206d 6f64 6966 6965 6420 7369 6e63 6520   modified since 
-0001dc70: 7468 656e 2e0a 2020 2020 2020 2020 2020  then..          
-0001dc80: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
-0001dc90: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-0001dca0: 2020 2020 2020 274c 6f63 616c 2069 7465        'Local ite
-0001dcb0: 6d20 2225 7322 2068 6173 2075 6e73 796e  m "%s" has unsyn
-0001dcc0: 6365 6420 6368 616e 6765 7320 616e 6420  ced changes and 
-0001dcd0: 7265 6d6f 7465 2077 6173 2027 0a20 2020  remote was '.   
-0001dce0: 2020 2020 2020 2020 2020 2020 2022 6465               "de
-0001dcf0: 6c65 7465 643a 206c 6f63 616c 2069 7465  leted: local ite
-0001dd00: 6d20 6973 206e 6577 6572 222c 0a20 2020  m is newer",.   
-0001dd10: 2020 2020 2020 2020 2020 2020 2065 7665               eve
-0001dd20: 6e74 2e64 6278 5f70 6174 682c 0a20 2020  nt.dbx_path,.   
-0001dd30: 2020 2020 2020 2020 2029 0a20 2020 2020           ).     
-0001dd40: 2020 2020 2020 2072 6574 7572 6e20 436f         return Co
-0001dd50: 6e66 6c69 6374 2e4c 6f63 616c 4e65 7765  nflict.LocalNewe
-0001dd60: 724f 7249 6465 6e74 6963 616c 0a20 2020  rOrIdentical.   
-0001dd70: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001dd80: 2020 2020 2020 2023 2042 6f74 6820 7265         # Both re
-0001dd90: 6d6f 7465 2061 6e64 206c 6f63 616c 2069  mote and local i
-0001dda0: 7465 6d73 2068 6176 6520 756e 7379 6e63  tems have unsync
-0001ddb0: 6564 2063 6861 6e67 6573 3a20 636f 6e66  ed changes: conf
-0001ddc0: 6c69 6374 2e0a 2020 2020 2020 2020 2020  lict..          
-0001ddd0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
-0001dde0: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
-0001ddf0: 2020 2020 2020 274c 6f63 616c 2069 7465        'Local ite
-0001de00: 6d20 2225 7322 2068 6173 2075 6e73 796e  m "%s" has unsyn
-0001de10: 6365 6420 6c6f 6361 6c20 6368 616e 6765  ced local change
-0001de20: 733a 2063 6f6e 666c 6963 7427 2c0a 2020  s: conflict',.  
-0001de30: 2020 2020 2020 2020 2020 2020 2020 6576                ev
-0001de40: 656e 742e 6462 785f 7061 7468 2c0a 2020  ent.dbx_path,.  
-0001de50: 2020 2020 2020 2020 2020 290a 2020 2020            ).    
-0001de60: 2020 2020 2020 2020 7265 7475 726e 2043          return C
-0001de70: 6f6e 666c 6963 742e 436f 6e66 6c69 6374  onflict.Conflict
-0001de80: 0a0a 2020 2020 6465 6620 5f63 7469 6d65  ..    def _ctime
-0001de90: 5f6e 6577 6572 5f74 6861 6e5f 6c61 7374  _newer_than_last
-0001dea0: 5f73 796e 6328 7365 6c66 2c20 6c6f 6361  _sync(self, loca
-0001deb0: 6c5f 7061 7468 3a20 7374 7229 202d 3e20  l_path: str) -> 
-0001dec0: 626f 6f6c 3a0a 2020 2020 2020 2020 2222  bool:.        ""
-0001ded0: 220a 2020 2020 2020 2020 4368 6563 6b73  ".        Checks
-0001dee0: 2069 6620 6120 6c6f 6361 6c20 6974 656d   if a local item
-0001def0: 2068 6173 2061 6e79 2075 6e73 796e 6365   has any unsynce
-0001df00: 6420 6368 616e 6765 732e 2054 6869 7320  d changes. This 
-0001df10: 6973 2062 7920 636f 6d70 6172 696e 6720  is by comparing 
-0001df20: 6974 7320 6374 696d 650a 2020 2020 2020  its ctime.      
-0001df30: 2020 746f 2074 6865 2060 606c 6173 745f    to the ``last_
-0001df40: 7379 6e63 6060 2074 696d 6520 7361 7665  sync`` time save
-0001df50: 6420 696e 206f 7572 2069 6e64 6578 2e20  d in our index. 
-0001df60: 496e 2063 6173 6520 6f66 2066 6f6c 6465  In case of folde
-0001df70: 7273 2c20 7765 2072 6563 7572 7369 7665  rs, we recursive
-0001df80: 6c79 0a20 2020 2020 2020 2063 6865 636b  ly.        check
-0001df90: 2074 6865 2063 7469 6d65 206f 6620 6368   the ctime of ch
-0001dfa0: 696c 6472 656e 2e0a 0a20 2020 2020 2020  ildren...       
-0001dfb0: 203a 7061 7261 6d20 6c6f 6361 6c5f 7061   :param local_pa
-0001dfc0: 7468 3a20 4c6f 6361 6c20 7061 7468 206f  th: Local path o
-0001dfd0: 6620 6974 656d 2074 6f20 6368 6563 6b2e  f item to check.
-0001dfe0: 0a20 2020 2020 2020 203a 7265 7475 726e  .        :return
-0001dff0: 733a 2057 6865 7468 6572 2074 6865 206c  s: Whether the l
-0001e000: 6f63 616c 2069 7465 6d20 6861 7320 756e  ocal item has un
-0001e010: 7379 6e63 6564 2063 6861 6e67 6573 2e0a  synced changes..
-0001e020: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
-0001e030: 2020 2020 6966 2073 656c 662e 6973 5f65      if self.is_e
-0001e040: 7863 6c75 6465 6428 6c6f 6361 6c5f 7061  xcluded(local_pa
-0001e050: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
-0001e060: 2023 2045 7863 6c75 6465 6420 6e61 6d65   # Excluded name
-0001e070: 7320 7375 6368 2061 7320 2e44 535f 5374  s such as .DS_St
-0001e080: 6f72 6520 6574 632e 206e 6576 6572 2063  ore etc. never c
-0001e090: 6f75 6e74 2061 7320 756e 7379 6e63 6564  ount as unsynced
-0001e0a0: 2063 6861 6e67 6573 2e0a 2020 2020 2020   changes..      
-0001e0b0: 2020 2020 2020 7265 7475 726e 2046 616c        return Fal
-0001e0c0: 7365 0a0a 2020 2020 2020 2020 6462 785f  se..        dbx_
-0001e0d0: 7061 7468 5f6c 6f77 6572 203d 2073 656c  path_lower = sel
-0001e0e0: 662e 746f 5f64 6278 5f70 6174 685f 6c6f  f.to_dbx_path_lo
-0001e0f0: 7765 7228 6c6f 6361 6c5f 7061 7468 290a  wer(local_path).
-0001e100: 2020 2020 2020 2020 696e 6465 785f 656e          index_en
-0001e110: 7472 7920 3d20 7365 6c66 2e67 6574 5f69  try = self.get_i
-0001e120: 6e64 6578 5f65 6e74 7279 2864 6278 5f70  ndex_entry(dbx_p
-0001e130: 6174 685f 6c6f 7765 7229 0a0a 2020 2020  ath_lower)..    
-0001e140: 2020 2020 7769 7468 2063 6f6e 7665 7274      with convert
-0001e150: 5f61 7069 5f65 7272 6f72 7328 6c6f 6361  _api_errors(loca
-0001e160: 6c5f 7061 7468 3d6c 6f63 616c 5f70 6174  l_path=local_pat
-0001e170: 6829 3a20 2023 2043 6174 6368 204f 5345  h):  # Catch OSE
-0001e180: 7272 6f72 732e 0a20 2020 2020 2020 2020  rrors..         
-0001e190: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
-0001e1a0: 2020 2020 2020 2020 7374 6174 203d 206f          stat = o
-0001e1b0: 732e 6c73 7461 7428 6c6f 6361 6c5f 7061  s.lstat(local_pa
-0001e1c0: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-0001e1d0: 6578 6365 7074 2028 4669 6c65 4e6f 7446  except (FileNotF
-0001e1e0: 6f75 6e64 4572 726f 722c 204e 6f74 4144  oundError, NotAD
-0001e1f0: 6972 6563 746f 7279 4572 726f 7229 3a0a  irectoryError):.
-0001e200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e210: 2320 446f 6e27 7420 6368 6563 6b20 6374  # Don't check ct
-0001e220: 696d 6520 666f 7220 6465 6c65 7465 6420  ime for deleted 
-0001e230: 6974 656d 7320 286f 7320 776f 6e27 7420  items (os won't 
-0001e240: 6769 7665 2073 7461 7420 696e 666f 290a  give stat info).
-0001e250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e260: 2320 6275 7420 636f 6e66 6972 6d20 6162  # but confirm ab
-0001e270: 7365 6e63 6520 6672 6f6d 2069 6e64 6578  sence from index
-0001e280: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001e290: 2020 7265 7475 726e 2069 6e64 6578 5f65    return index_e
-0001e2a0: 6e74 7279 2069 7320 6e6f 7420 4e6f 6e65  ntry is not None
-0001e2b0: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-0001e2c0: 2053 5f49 5344 4952 2873 7461 742e 7374   S_ISDIR(stat.st
-0001e2d0: 5f6d 6f64 6529 3a0a 2020 2020 2020 2020  _mode):.        
-0001e2e0: 2020 2020 2020 2020 2320 446f 6e27 7420          # Don't 
-0001e2f0: 6368 6563 6b20 6374 696d 6520 666f 7220  check ctime for 
-0001e300: 666f 6c64 6572 7320 6275 7420 636f 6d70  folders but comp
-0001e310: 6172 6520 746f 2069 6e64 6578 2065 6e74  are to index ent
-0001e320: 7279 2074 7970 652e 0a20 2020 2020 2020  ry type..       
-0001e330: 2020 2020 2020 2020 2069 6620 696e 6465           if inde
-0001e340: 785f 656e 7472 7920 6973 204e 6f6e 6520  x_entry is None 
-0001e350: 6f72 2069 6e64 6578 5f65 6e74 7279 2e69  or index_entry.i
-0001e360: 735f 6669 6c65 3a0a 2020 2020 2020 2020  s_file:.        
-0001e370: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001e380: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
-0001e390: 2020 2020 2020 2020 2023 2052 6563 7572           # Recur
-0001e3a0: 7365 206f 7665 7220 6368 696c 6472 656e  se over children
-0001e3b0: 2e0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001e3c0: 2020 7769 7468 206f 732e 7363 616e 6469    with os.scandi
-0001e3d0: 7228 6c6f 6361 6c5f 7061 7468 2920 6173  r(local_path) as
-0001e3e0: 2069 743a 0a20 2020 2020 2020 2020 2020   it:.           
-0001e3f0: 2020 2020 2020 2020 2066 6f72 2065 6e74           for ent
-0001e400: 7279 2069 6e20 6974 3a0a 2020 2020 2020  ry in it:.      
-0001e410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e420: 2020 6966 2065 6e74 7279 2e69 735f 6469    if entry.is_di
-0001e430: 7228 666f 6c6c 6f77 5f73 796d 6c69 6e6b  r(follow_symlink
-0001e440: 733d 4661 6c73 6529 3a0a 2020 2020 2020  s=False):.      
-0001e450: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e460: 2020 2020 2020 6966 2073 656c 662e 5f63        if self._c
-0001e470: 7469 6d65 5f6e 6577 6572 5f74 6861 6e5f  time_newer_than_
-0001e480: 6c61 7374 5f73 796e 6328 656e 7472 792e  last_sync(entry.
-0001e490: 7061 7468 293a 0a20 2020 2020 2020 2020  path):.         
-0001e4a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e4b0: 2020 2020 2020 2072 6574 7572 6e20 5472         return Tr
-0001e4c0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
-0001e4d0: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-0001e4e0: 6e6f 7420 7365 6c66 2e69 735f 6578 636c  not self.is_excl
-0001e4f0: 7564 6564 2865 6e74 7279 2e6e 616d 6529  uded(entry.name)
-0001e500: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001e510: 2020 2020 2020 2020 2020 2020 2020 6368                ch
-0001e520: 696c 645f 6462 785f 7061 7468 5f6c 6f77  ild_dbx_path_low
-0001e530: 6572 203d 2073 656c 662e 746f 5f64 6278  er = self.to_dbx
-0001e540: 5f70 6174 685f 6c6f 7765 7228 656e 7472  _path_lower(entr
-0001e550: 792e 7061 7468 290a 2020 2020 2020 2020  y.path).        
-0001e560: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e570: 2020 2020 6374 696d 6520 3d20 656e 7472      ctime = entr
-0001e580: 792e 7374 6174 2866 6f6c 6c6f 775f 7379  y.stat(follow_sy
-0001e590: 6d6c 696e 6b73 3d46 616c 7365 292e 7374  mlinks=False).st
-0001e5a0: 5f63 7469 6d65 0a20 2020 2020 2020 2020  _ctime.         
-0001e5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5c0: 2020 2069 6620 6374 696d 6520 3e20 7365     if ctime > se
-0001e5d0: 6c66 2e67 6574 5f6c 6173 745f 7379 6e63  lf.get_last_sync
-0001e5e0: 2863 6869 6c64 5f64 6278 5f70 6174 685f  (child_dbx_path_
-0001e5f0: 6c6f 7765 7229 3a0a 2020 2020 2020 2020  lower):.        
-0001e600: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e610: 2020 2020 2020 2020 7265 7475 726e 2054          return T
-0001e620: 7275 650a 0a20 2020 2020 2020 2020 2020  rue..           
-0001e630: 2020 2020 2072 6574 7572 6e20 4661 6c73       return Fals
-0001e640: 650a 0a20 2020 2020 2020 2020 2020 2065  e..            e
-0001e650: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001e660: 2020 2020 2023 2043 6865 636b 206f 7572       # Check our
-0001e670: 2063 7469 6d65 2061 6761 696e 7374 2069   ctime against i
-0001e680: 6e64 6578 2e0a 2020 2020 2020 2020 2020  ndex..          
-0001e690: 2020 2020 2020 7265 7475 726e 2073 7461        return sta
-0001e6a0: 742e 7374 5f63 7469 6d65 203e 2073 656c  t.st_ctime > sel
-0001e6b0: 662e 6765 745f 6c61 7374 5f73 796e 6328  f.get_last_sync(
-0001e6c0: 6462 785f 7061 7468 5f6c 6f77 6572 290a  dbx_path_lower).
-0001e6d0: 0a20 2020 2064 6566 205f 6765 745f 6374  .    def _get_ct
-0001e6e0: 696d 6528 7365 6c66 2c20 6c6f 6361 6c5f  ime(self, local_
-0001e6f0: 7061 7468 3a20 7374 7229 202d 3e20 666c  path: str) -> fl
-0001e700: 6f61 743a 0a20 2020 2020 2020 2022 2222  oat:.        """
-0001e710: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
-0001e720: 2074 6865 2063 7469 6d65 206f 6620 6120   the ctime of a 
-0001e730: 6c6f 6361 6c20 6974 656d 206f 7220 2d31  local item or -1
-0001e740: 2e30 2069 6620 7468 6572 6520 6973 206e  .0 if there is n
-0001e750: 6f74 6869 6e67 2061 7420 7468 6520 7061  othing at the pa
-0001e760: 7468 2e20 4966 0a20 2020 2020 2020 2074  th. If.        t
-0001e770: 6865 2069 7465 6d20 6973 2061 2064 6972  he item is a dir
-0001e780: 6563 746f 7279 2c20 7265 7475 726e 2074  ectory, return t
-0001e790: 6865 206c 6172 6765 7374 2063 7469 6d65  he largest ctime
-0001e7a0: 206f 6620 6974 2061 6e64 2069 7473 2063   of it and its c
-0001e7b0: 6869 6c64 7265 6e2e 2049 7465 6d73 0a20  hildren. Items. 
-0001e7c0: 2020 2020 2020 2077 6869 6368 2061 7265         which are
-0001e7d0: 2065 7863 6c75 6465 6420 6672 6f6d 2073   excluded from s
-0001e7e0: 796e 6369 6e67 2028 652e 672e 2c20 2e44  yncing (e.g., .D
-0001e7f0: 535f 5374 6f72 6520 6669 6c65 7329 2061  S_Store files) a
-0001e800: 7265 2069 676e 6f72 6564 2e0a 0a20 2020  re ignored...   
-0001e810: 2020 2020 203a 7061 7261 6d20 6c6f 6361       :param loca
-0001e820: 6c5f 7061 7468 3a20 4162 736f 6c75 7465  l_path: Absolute
-0001e830: 2070 6174 6820 6f6e 206c 6f63 616c 2064   path on local d
-0001e840: 7269 7665 2e0a 2020 2020 2020 2020 3a72  rive..        :r
-0001e850: 6574 7572 6e73 3a20 4374 696d 6520 6f72  eturns: Ctime or
-0001e860: 202d 312e 302e 0a20 2020 2020 2020 2022   -1.0..        "
-0001e870: 2222 0a20 2020 2020 2020 2074 7279 3a0a  "".        try:.
-0001e880: 2020 2020 2020 2020 2020 2020 7374 6174              stat
-0001e890: 203d 206f 732e 6c73 7461 7428 6c6f 6361   = os.lstat(loca
-0001e8a0: 6c5f 7061 7468 290a 2020 2020 2020 2020  l_path).        
-0001e8b0: 2020 2020 6966 2053 5f49 5344 4952 2873      if S_ISDIR(s
-0001e8c0: 7461 742e 7374 5f6d 6f64 6529 3a0a 2020  tat.st_mode):.  
-0001e8d0: 2020 2020 2020 2020 2020 2020 2020 6374                ct
-0001e8e0: 696d 6520 3d20 7374 6174 2e73 745f 6374  ime = stat.st_ct
-0001e8f0: 696d 650a 2020 2020 2020 2020 2020 2020  ime.            
-0001e900: 2020 2020 7769 7468 206f 732e 7363 616e      with os.scan
-0001e910: 6469 7228 6c6f 6361 6c5f 7061 7468 2920  dir(local_path) 
-0001e920: 6173 2069 743a 0a20 2020 2020 2020 2020  as it:.         
-0001e930: 2020 2020 2020 2020 2020 2066 6f72 2065             for e
-0001e940: 6e74 7279 2069 6e20 6974 3a0a 2020 2020  ntry in it:.    
-0001e950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e960: 2020 2020 6966 2065 6e74 7279 2e69 735f      if entry.is_
-0001e970: 6469 7228 666f 6c6c 6f77 5f73 796d 6c69  dir(follow_symli
-0001e980: 6e6b 733d 4661 6c73 6529 3a0a 2020 2020  nks=False):.    
-0001e990: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9a0: 2020 2020 2020 2020 6368 696c 645f 6374          child_ct
-0001e9b0: 696d 6520 3d20 7365 6c66 2e5f 6765 745f  ime = self._get_
-0001e9c0: 6374 696d 6528 656e 7472 792e 7061 7468  ctime(entry.path
-0001e9d0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001e9e0: 2020 2020 2020 2020 2020 656c 6966 206e            elif n
-0001e9f0: 6f74 2073 656c 662e 6973 5f65 7863 6c75  ot self.is_exclu
-0001ea00: 6465 6428 656e 7472 792e 6e61 6d65 293a  ded(entry.name):
-0001ea10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001ea20: 2020 2020 2020 2020 2020 2020 2063 6869               chi
-0001ea30: 6c64 5f63 7469 6d65 203d 2065 6e74 7279  ld_ctime = entry
-0001ea40: 2e73 7461 7428 666f 6c6c 6f77 5f73 796d  .stat(follow_sym
-0001ea50: 6c69 6e6b 733d 4661 6c73 6529 2e73 745f  links=False).st_
-0001ea60: 6374 696d 650a 2020 2020 2020 2020 2020  ctime.          
-0001ea70: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0001ea80: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0001ea90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eaa0: 6368 696c 645f 6374 696d 6520 3d20 2d31  child_ctime = -1
-0001eab0: 2e30 0a0a 2020 2020 2020 2020 2020 2020  .0..            
-0001eac0: 2020 2020 2020 2020 2020 2020 6374 696d              ctim
-0001ead0: 6520 3d20 6d61 7828 6374 696d 652c 2063  e = max(ctime, c
-0001eae0: 6869 6c64 5f63 7469 6d65 290a 0a20 2020  hild_ctime)..   
-0001eaf0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-0001eb00: 7572 6e20 6374 696d 650a 2020 2020 2020  urn ctime.      
-0001eb10: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-0001eb20: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001eb30: 726e 2073 7461 742e 7374 5f63 7469 6d65  rn stat.st_ctime
-0001eb40: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0001eb50: 2846 696c 654e 6f74 466f 756e 6445 7272  (FileNotFoundErr
-0001eb60: 6f72 2c20 4e6f 7441 4469 7265 6374 6f72  or, NotADirector
-0001eb70: 7945 7272 6f72 293a 0a20 2020 2020 2020  yError):.       
-0001eb80: 2020 2020 2072 6574 7572 6e20 2d31 2e30       return -1.0
-0001eb90: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0001eba0: 4f53 4572 726f 7220 6173 2065 7863 3a0a  OSError as exc:.
-0001ebb0: 2020 2020 2020 2020 2020 2020 7261 6973              rais
-0001ebc0: 6520 6f73 5f74 6f5f 6d61 6573 7472 616c  e os_to_maestral
-0001ebd0: 5f65 7272 6f72 2865 7863 2c20 6c6f 6361  _error(exc, loca
-0001ebe0: 6c5f 7061 7468 3d6c 6f63 616c 5f70 6174  l_path=local_pat
-0001ebf0: 6829 0a0a 2020 2020 6465 6620 5f63 6c65  h)..    def _cle
-0001ec00: 616e 5f72 656d 6f74 655f 6368 616e 6765  an_remote_change
-0001ec10: 7328 7365 6c66 2c20 6368 616e 6765 733a  s(self, changes:
-0001ec20: 204c 6973 7446 6f6c 6465 7252 6573 756c   ListFolderResul
-0001ec30: 7429 202d 3e20 4c69 7374 466f 6c64 6572  t) -> ListFolder
-0001ec40: 5265 7375 6c74 3a0a 2020 2020 2020 2020  Result:.        
-0001ec50: 2222 220a 2020 2020 2020 2020 5461 6b65  """.        Take
-0001ec60: 7320 7265 6d6f 7465 2066 696c 6520 6576  s remote file ev
-0001ec70: 656e 7473 2073 696e 6365 206c 6173 7420  ents since last 
-0001ec80: 7379 6e63 2061 6e64 2063 6c65 616e 7320  sync and cleans 
-0001ec90: 7468 656d 2075 7020 736f 2074 6861 7420  them up so that 
-0001eca0: 7468 6572 6520 6973 0a20 2020 2020 2020  there is.       
-0001ecb0: 206f 6e6c 7920 6120 7369 6e67 6c65 2065   only a single e
-0001ecc0: 7665 6e74 2070 6572 2070 6174 682e 0a0a  vent per path...
-0001ecd0: 2020 2020 2020 2020 4472 6f70 626f 7820          Dropbox 
-0001ece0: 7769 6c6c 2073 6f6d 6574 696d 6573 2072  will sometimes r
-0001ecf0: 6570 6f72 7420 6d75 6c74 6970 6c65 2063  eport multiple c
-0001ed00: 6861 6e67 6573 2070 6572 2070 6174 682e  hanges per path.
-0001ed10: 204f 6e63 6520 7375 6368 2069 6e73 7461   Once such insta
-0001ed20: 6e63 6520 6973 0a20 2020 2020 2020 2077  nce is.        w
-0001ed30: 6865 6e20 7368 6172 696e 6720 6120 666f  hen sharing a fo
-0001ed40: 6c64 6572 3a20 6060 6669 6c65 732f 6c69  lder: ``files/li
-0001ed50: 7374 5f66 6f6c 6465 722f 636f 6e74 696e  st_folder/contin
-0001ed60: 7565 6060 2077 696c 6c20 7265 706f 7274  ue`` will report
-0001ed70: 2074 6865 2073 6861 7265 640a 2020 2020   the shared.    
-0001ed80: 2020 2020 666f 6c64 6572 2061 6e64 2069      folder and i
-0001ed90: 7473 2063 6869 6c64 7265 6e20 6173 2064  ts children as d
-0001eda0: 656c 6574 6564 2061 6e64 2074 6865 6e20  eleted and then 
-0001edb0: 6372 6561 7465 6420 6265 6361 7573 6520  created because 
-0001edc0: 7468 6520 666f 6c64 6572 202a 6973 2a0a  the folder *is*.
-0001edd0: 2020 2020 2020 2020 6163 7475 616c 6c79          actually
-0001ede0: 2064 656c 6574 6564 2066 726f 6d20 7468   deleted from th
-0001edf0: 6520 7573 6572 2773 2044 726f 7062 6f78  e user's Dropbox
-0001ee00: 2061 6e64 2072 6563 7265 6174 6564 2061   and recreated a
-0001ee10: 7320 6120 7368 6172 6564 2066 6f6c 6465  s a shared folde
-0001ee20: 7220 7768 6963 680a 2020 2020 2020 2020  r which.        
-0001ee30: 7468 656e 2067 6574 7320 6d6f 756e 7465  then gets mounte
-0001ee40: 6420 746f 2074 6865 2075 7365 7227 7320  d to the user's 
-0001ee50: 4472 6f70 626f 782e 2049 6465 616c 6c79  Dropbox. Ideally
-0001ee60: 2c20 7765 2077 616e 7420 746f 2064 6561  , we want to dea
-0001ee70: 6c20 7769 7468 2074 6869 730a 2020 2020  l with this.    
-0001ee80: 2020 2020 7769 7468 6f75 7420 7265 2d64      without re-d
-0001ee90: 6f77 6e6c 6f61 6469 6e67 2061 6c6c 2069  ownloading all i
-0001eea0: 7473 2063 6f6e 7465 6e74 732e 0a0a 2020  ts contents...  
-0001eeb0: 2020 2020 2020 3a70 6172 616d 2063 6861        :param cha
-0001eec0: 6e67 6573 3a20 5265 7375 6c74 2066 726f  nges: Result fro
-0001eed0: 6d20 4472 6f70 626f 7820 4150 4920 6361  m Dropbox API ca
-0001eee0: 6c6c 2074 6f20 7265 7472 6965 7665 2072  ll to retrieve r
-0001eef0: 656d 6f74 6520 6368 616e 6765 732e 0a20  emote changes.. 
-0001ef00: 2020 2020 2020 203a 7265 7475 726e 733a         :returns:
-0001ef10: 2043 6c65 616e 6564 2075 7020 6368 616e   Cleaned up chan
-0001ef20: 6765 7320 7769 7468 2061 2073 696e 676c  ges with a singl
-0001ef30: 6520 4d65 7461 6461 7461 2065 6e74 7279  e Metadata entry
-0001ef40: 2070 6572 2070 6174 682e 0a20 2020 2020   per path..     
-0001ef50: 2020 2022 2222 0a20 2020 2020 2020 2023     """.        #
-0001ef60: 204e 6f74 653a 2077 6520 776f 6e27 7420   Note: we won't 
-0001ef70: 6861 7665 2074 6f20 6465 616c 2077 6974  have to deal wit
-0001ef80: 6820 6d6f 6469 6669 6564 206f 7220 6d6f  h modified or mo
-0001ef90: 7665 6420 6576 656e 7473 2c0a 2020 2020  ved events,.    
-0001efa0: 2020 2020 2320 4472 6f70 626f 7820 6f6e      # Dropbox on
-0001efb0: 6c79 2072 6570 6f72 7473 2044 656c 6574  ly reports Delet
-0001efc0: 6564 4d65 7461 6461 7461 206f 7220 4669  edMetadata or Fi
-0001efd0: 6c65 4d65 7461 6461 7461 202f 2046 6f6c  leMetadata / Fol
-0001efe0: 6465 724d 6574 6164 6174 610a 2020 2020  derMetadata.    
-0001eff0: 2020 2020 6869 7374 6f72 6965 733a 2064      histories: d
-0001f000: 6566 6175 6c74 6469 6374 5b73 7472 2c20  efaultdict[str, 
-0001f010: 6c69 7374 5b4d 6574 6164 6174 615d 5d20  list[Metadata]] 
-0001f020: 3d20 6465 6661 756c 7464 6963 7428 6c69  = defaultdict(li
-0001f030: 7374 290a 0a20 2020 2020 2020 2066 6f72  st)..        for
-0001f040: 2065 6e74 7279 2069 6e20 6368 616e 6765   entry in change
-0001f050: 732e 656e 7472 6965 733a 0a20 2020 2020  s.entries:.     
-0001f060: 2020 2020 2020 2068 6973 746f 7269 6573         histories
-0001f070: 5b65 6e74 7279 2e70 6174 685f 6c6f 7765  [entry.path_lowe
-0001f080: 725d 2e61 7070 656e 6428 656e 7472 7929  r].append(entry)
-0001f090: 0a0a 2020 2020 2020 2020 6e65 775f 656e  ..        new_en
-0001f0a0: 7472 6965 7320 3d20 5b5d 0a0a 2020 2020  tries = []..    
-0001f0b0: 2020 2020 666f 7220 6820 696e 2068 6973      for h in his
-0001f0c0: 746f 7269 6573 2e76 616c 7565 7328 293a  tories.values():
-0001f0d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001f0e0: 6c65 6e28 6829 203d 3d20 313a 0a20 2020  len(h) == 1:.   
-0001f0f0: 2020 2020 2020 2020 2020 2020 206e 6577               new
-0001f100: 5f65 6e74 7269 6573 2e65 7874 656e 6428  _entries.extend(
-0001f110: 6829 0a20 2020 2020 2020 2020 2020 2065  h).            e
-0001f120: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-0001f130: 2020 2020 206c 6173 745f 6576 656e 7420       last_event 
-0001f140: 3d20 685b 2d31 5d0a 2020 2020 2020 2020  = h[-1].        
-0001f150: 2020 2020 2020 2020 6c6f 6361 6c5f 656e          local_en
-0001f160: 7472 7920 3d20 7365 6c66 2e67 6574 5f69  try = self.get_i
-0001f170: 6e64 6578 5f65 6e74 7279 286c 6173 745f  ndex_entry(last_
-0001f180: 6576 656e 742e 7061 7468 5f6c 6f77 6572  event.path_lower
-0001f190: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001f1a0: 2020 7761 735f 6469 7220 3d20 6c6f 6361    was_dir = loca
-0001f1b0: 6c5f 656e 7472 7920 616e 6420 6c6f 6361  l_entry and loca
-0001f1c0: 6c5f 656e 7472 792e 6973 5f64 6972 6563  l_entry.is_direc
-0001f1d0: 746f 7279 0a0a 2020 2020 2020 2020 2020  tory..          
-0001f1e0: 2020 2020 2020 2320 4472 6f70 626f 7820        # Dropbox 
-0001f1f0: 6775 6172 616e 7465 6573 2074 6861 7420  guarantees that 
-0001f200: 6170 706c 7969 6e67 2065 7665 6e74 7320  applying events 
-0001f210: 696e 2074 6865 2070 726f 7669 6465 6420  in the provided 
-0001f220: 6f72 6465 7220 7769 6c6c 0a20 2020 2020  order will.     
-0001f230: 2020 2020 2020 2020 2020 2023 2072 6570             # rep
-0001f240: 726f 6475 6365 2074 6865 2073 7461 7465  roduce the state
-0001f250: 2069 6e20 7468 6520 636c 6f75 642e 2057   in the cloud. W
-0001f260: 6520 7468 6572 6566 6f72 6520 6b65 6570  e therefore keep
-0001f270: 206f 6e6c 7920 7468 6520 6c61 7374 0a20   only the last. 
-0001f280: 2020 2020 2020 2020 2020 2020 2020 2023                 #
-0001f290: 2065 7665 6e74 2c20 756e 6c65 7373 2074   event, unless t
-0001f2a0: 6865 7265 2069 7320 6120 6368 616e 6765  here is a change
-0001f2b0: 2069 6e20 6974 656d 2074 7970 652e 0a20   in item type.. 
-0001f2c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0001f2d0: 6620 280a 2020 2020 2020 2020 2020 2020  f (.            
-0001f2e0: 2020 2020 2020 2020 7761 735f 6469 720a          was_dir.
-0001f2f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f300: 2020 2020 616e 6420 6973 696e 7374 616e      and isinstan
-0001f310: 6365 286c 6173 745f 6576 656e 742c 2046  ce(last_event, F
-0001f320: 696c 654d 6574 6164 6174 6129 0a20 2020  ileMetadata).   
-0001f330: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f340: 206f 7220 6e6f 7420 7761 735f 6469 720a   or not was_dir.
-0001f350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f360: 2020 2020 616e 6420 6973 696e 7374 616e      and isinstan
-0001f370: 6365 286c 6173 745f 6576 656e 742c 2046  ce(last_event, F
-0001f380: 6f6c 6465 724d 6574 6164 6174 6129 0a20  olderMetadata). 
-0001f390: 2020 2020 2020 2020 2020 2020 2020 2029                 )
-0001f3a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f3b0: 2020 2020 2020 6465 6c65 7465 645f 6576        deleted_ev
-0001f3c0: 656e 7420 3d20 4465 6c65 7465 644d 6574  ent = DeletedMet
-0001f3d0: 6164 6174 6128 0a20 2020 2020 2020 2020  adata(.         
-0001f3e0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-0001f3f0: 616d 653d 6c61 7374 5f65 7665 6e74 2e6e  ame=last_event.n
-0001f400: 616d 652c 0a20 2020 2020 2020 2020 2020  ame,.           
-0001f410: 2020 2020 2020 2020 2020 2020 2070 6174               pat
-0001f420: 685f 6c6f 7765 723d 6c61 7374 5f65 7665  h_lower=last_eve
-0001f430: 6e74 2e70 6174 685f 6c6f 7765 722c 0a20  nt.path_lower,. 
-0001f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f450: 2020 2020 2020 2070 6174 685f 6469 7370         path_disp
-0001f460: 6c61 793d 6c61 7374 5f65 7665 6e74 2e70  lay=last_event.p
-0001f470: 6174 685f 6469 7370 6c61 792c 0a20 2020  ath_display,.   
-0001f480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f490: 2029 0a20 2020 2020 2020 2020 2020 2020   ).             
-0001f4a0: 2020 2020 2020 206e 6577 5f65 6e74 7269         new_entri
-0001f4b0: 6573 2e61 7070 656e 6428 6465 6c65 7465  es.append(delete
-0001f4c0: 645f 6576 656e 7429 0a20 2020 2020 2020  d_event).       
-0001f4d0: 2020 2020 2020 2020 2020 2020 206e 6577               new
-0001f4e0: 5f65 6e74 7269 6573 2e61 7070 656e 6428  _entries.append(
-0001f4f0: 6c61 7374 5f65 7665 6e74 290a 2020 2020  last_event).    
-0001f500: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001f510: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f520: 2020 2020 2020 6e65 775f 656e 7472 6965        new_entrie
-0001f530: 732e 6170 7065 6e64 286c 6173 745f 6576  s.append(last_ev
-0001f540: 656e 7429 0a0a 2020 2020 2020 2020 6368  ent)..        ch
-0001f550: 616e 6765 732e 656e 7472 6965 7320 3d20  anges.entries = 
-0001f560: 6e65 775f 656e 7472 6965 730a 0a20 2020  new_entries..   
-0001f570: 2020 2020 2072 6574 7572 6e20 6368 616e       return chan
-0001f580: 6765 730a 0a20 2020 2064 6566 205f 6372  ges..    def _cr
-0001f590: 6561 7465 5f6c 6f63 616c 5f65 6e74 7279  eate_local_entry
-0001f5a0: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
-0001f5b0: 6e63 4576 656e 7429 202d 3e20 5379 6e63  ncEvent) -> Sync
-0001f5c0: 4576 656e 743a 0a20 2020 2020 2020 2022  Event:.        "
-0001f5d0: 2222 0a20 2020 2020 2020 2041 7070 6c69  "".        Appli
-0001f5e0: 6573 2061 2066 696c 6520 2f20 666f 6c64  es a file / fold
-0001f5f0: 6572 2063 6861 6e67 6520 6672 6f6d 2044  er change from D
-0001f600: 726f 7062 6f78 2073 6572 7665 7273 2074  ropbox servers t
-0001f610: 6f20 7468 6520 6c6f 6361 6c20 4472 6f70  o the local Drop
-0001f620: 626f 7820 666f 6c64 6572 2e0a 2020 2020  box folder..    
-0001f630: 2020 2020 416e 7920 3a65 7863 3a60 6d61      Any :exc:`ma
-0001f640: 6573 7472 616c 2e65 7863 6570 7469 6f6e  estral.exception
-0001f650: 2e4d 6165 7374 7261 6c41 7069 4572 726f  .MaestralApiErro
-0001f660: 7260 2077 696c 6c20 6265 2063 6175 6768  r` will be caugh
-0001f670: 7420 616e 6420 6c6f 6767 6564 2061 730a  t and logged as.
-0001f680: 2020 2020 2020 2020 6170 7072 6f70 7269          appropri
-0001f690: 6174 652e 2045 6e74 7269 6573 2069 6e20  ate. Entries in 
-0001f6a0: 7468 6520 6c6f 6361 6c20 696e 6465 7820  the local index 
-0001f6b0: 6172 6520 6372 6561 7465 6420 6166 7465  are created afte
-0001f6c0: 7220 7375 6363 6573 7366 756c 2063 6f6d  r successful com
-0001f6d0: 706c 6574 696f 6e2e 0a0a 2020 2020 2020  pletion...      
-0001f6e0: 2020 3a70 6172 616d 2065 7665 6e74 3a20    :param event: 
-0001f6f0: 4472 6f70 626f 7820 6d65 7461 6461 7461  Dropbox metadata
-0001f700: 2e0a 2020 2020 2020 2020 3a72 6574 7572  ..        :retur
-0001f710: 6e73 3a20 436f 7079 206f 6620 7468 6520  ns: Copy of the 
-0001f720: 4472 6f70 626f 7820 6d65 7461 6461 7461  Dropbox metadata
-0001f730: 2069 6620 7468 6520 6368 616e 6765 2077   if the change w
-0001f740: 6173 2061 7070 6c69 6564 2073 7563 6365  as applied succe
-0001f750: 7373 6675 6c6c 792c 0a20 2020 2020 2020  ssfully,.       
-0001f760: 2020 2020 2060 6054 7275 6560 6020 6966       ``True`` if
-0001f770: 2074 6865 2063 6861 6e67 6520 616c 7265   the change alre
-0001f780: 6164 7920 6578 6973 7465 642c 2060 6046  ady existed, ``F
-0001f790: 616c 7365 6060 2069 6e20 6361 7365 206f  alse`` in case o
-0001f7a0: 6620 6120 7379 6e63 2065 7272 6f72 0a20  f a sync error. 
-0001f7b0: 2020 2020 2020 2020 2020 2061 6e64 2060             and `
-0001f7c0: 604e 6f6e 6560 6020 6966 2063 616e 6365  `None`` if cance
-0001f7d0: 6c6c 6564 2e0a 2020 2020 2020 2020 2222  lled..        ""
-0001f7e0: 220a 2020 2020 2020 2020 6966 2073 656c  ".        if sel
-0001f7f0: 662e 5f63 616e 6365 6c5f 7265 7175 6573  f._cancel_reques
-0001f800: 7465 642e 6973 5f73 6574 2829 3a0a 2020  ted.is_set():.  
-0001f810: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
-0001f820: 4361 6e63 656c 6c65 6445 7272 6f72 2822  CancelledError("
-0001f830: 5379 6e63 2063 616e 6365 6c6c 6564 2229  Sync cancelled")
-0001f840: 0a0a 2020 2020 2020 2020 7365 6c66 2e5f  ..        self._
-0001f850: 736c 6f77 5f64 6f77 6e28 290a 0a20 2020  slow_down()..   
-0001f860: 2020 2020 2065 7665 6e74 2e73 7461 7475       event.statu
-0001f870: 7320 3d20 5379 6e63 5374 6174 7573 2e53  s = SyncStatus.S
-0001f880: 796e 6369 6e67 0a0a 2020 2020 2020 2020  yncing..        
-0001f890: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0001f8a0: 2069 6620 6576 656e 742e 6973 5f64 656c   if event.is_del
-0001f8b0: 6574 6564 3a0a 2020 2020 2020 2020 2020  eted:.          
-0001f8c0: 2020 2020 2020 7374 6174 7573 203d 2073        status = s
-0001f8d0: 656c 662e 5f6f 6e5f 7265 6d6f 7465 5f64  elf._on_remote_d
-0001f8e0: 656c 6574 6564 2865 7665 6e74 290a 2020  eleted(event).  
-0001f8f0: 2020 2020 2020 2020 2020 656c 6966 2065            elif e
-0001f900: 7665 6e74 2e69 735f 6669 6c65 3a0a 2020  vent.is_file:.  
-0001f910: 2020 2020 2020 2020 2020 2020 2020 7374                st
-0001f920: 6174 7573 203d 2073 656c 662e 5f6f 6e5f  atus = self._on_
-0001f930: 7265 6d6f 7465 5f66 696c 6528 6576 656e  remote_file(even
-0001f940: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
-0001f950: 6c69 6620 6576 656e 742e 6973 5f64 6972  lif event.is_dir
-0001f960: 6563 746f 7279 3a0a 2020 2020 2020 2020  ectory:.        
-0001f970: 2020 2020 2020 2020 7374 6174 7573 203d          status =
-0001f980: 2073 656c 662e 5f6f 6e5f 7265 6d6f 7465   self._on_remote
-0001f990: 5f66 6f6c 6465 7228 6576 656e 7429 0a20  _folder(event). 
-0001f9a0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0001f9b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f9c0: 2073 7461 7475 7320 3d20 5379 6e63 5374   status = SyncSt
-0001f9d0: 6174 7573 2e53 6b69 7070 6564 0a0a 2020  atus.Skipped..  
-0001f9e0: 2020 2020 2020 2020 2020 6576 656e 742e            event.
-0001f9f0: 7374 6174 7573 203d 2073 7461 7475 730a  status = status.
-0001fa00: 0a20 2020 2020 2020 2065 7863 6570 7420  .        except 
-0001fa10: 5379 6e63 4572 726f 7220 6173 2065 3a0a  SyncError as e:.
-0001fa20: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001fa30: 2e5f 6861 6e64 6c65 5f73 796e 635f 6572  ._handle_sync_er
-0001fa40: 726f 7228 652c 2064 6972 6563 7469 6f6e  ror(e, direction
-0001fa50: 3d53 796e 6344 6972 6563 7469 6f6e 2e44  =SyncDirection.D
-0001fa60: 6f77 6e29 0a20 2020 2020 2020 2020 2020  own).           
-0001fa70: 2065 7665 6e74 2e73 7461 7475 7320 3d20   event.status = 
-0001fa80: 5379 6e63 5374 6174 7573 2e46 6169 6c65  SyncStatus.Faile
-0001fa90: 640a 2020 2020 2020 2020 656c 7365 3a0a  d.        else:.
-0001faa0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0001fab0: 2e63 6c65 6172 5f73 796e 635f 6572 726f  .clear_sync_erro
-0001fac0: 7273 5f66 726f 6d5f 6576 656e 7428 6576  rs_from_event(ev
-0001fad0: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
-0001fae0: 2073 656c 662e 6163 7469 7669 7479 2e64   self.activity.d
-0001faf0: 6973 6361 7264 2865 7665 6e74 290a 0a20  iscard(event).. 
-0001fb00: 2020 2020 2020 2023 2041 6464 2065 7665         # Add eve
-0001fb10: 6e74 7320 746f 2068 6973 746f 7279 2064  nts to history d
-0001fb20: 6174 6162 6173 652e 0a20 2020 2020 2020  atabase..       
-0001fb30: 2069 6620 6576 656e 742e 7374 6174 7573   if event.status
-0001fb40: 203d 3d20 5379 6e63 5374 6174 7573 2e44   == SyncStatus.D
-0001fb50: 6f6e 653a 0a20 2020 2020 2020 2020 2020  one:.           
-0001fb60: 2077 6974 6820 7365 6c66 2e5f 6461 7461   with self._data
-0001fb70: 6261 7365 5f61 6363 6573 7328 293a 0a20  base_access():. 
-0001fb80: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0001fb90: 656c 662e 5f68 6973 746f 7279 5f74 6162  elf._history_tab
-0001fba0: 6c65 2e73 6176 6528 6576 656e 7429 0a0a  le.save(event)..
-0001fbb0: 2020 2020 2020 2020 7265 7475 726e 2065          return e
-0001fbc0: 7665 6e74 0a0a 2020 2020 6465 6620 5f65  vent..    def _e
-0001fbd0: 6e73 7572 655f 7061 7265 6e74 2873 656c  nsure_parent(sel
-0001fbe0: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
-0001fbf0: 656e 7429 202d 3e20 4e6f 6e65 3a0a 2020  ent) -> None:.  
-0001fc00: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001fc10: 2020 456e 7375 7265 7320 7468 6174 2061    Ensures that a
-0001fc20: 6c6c 2070 6172 656e 7420 666f 6c64 6572  ll parent folder
-0001fc30: 7320 666f 7220 6120 7379 6e63 2065 7665  s for a sync eve
-0001fc40: 6e74 2065 7869 7374 206c 6f63 616c 6c79  nt exist locally
-0001fc50: 2e20 5468 6973 2069 7320 7573 6564 2074  . This is used t
-0001fc60: 6f0a 2020 2020 2020 2020 7072 6576 656e  o.        preven
-0001fc70: 7420 6368 696c 6472 656e 2066 726f 6d20  t children from 
-0001fc80: 6265 696e 6720 646f 776e 6c6f 6164 6564  being downloaded
-0001fc90: 2062 6566 6f72 6520 7468 6569 7220 7061   before their pa
-0001fca0: 7265 6e74 732e 2049 6e20 7468 6520 6d6f  rents. In the mo
-0001fcb0: 7374 2063 6173 6573 2c0a 2020 2020 2020  st cases,.      
-0001fcc0: 2020 7765 2077 696c 6c20 6175 746f 6d61    we will automa
-0001fcd0: 7469 6361 6c6c 7920 7379 6e63 2070 6172  tically sync par
-0001fce0: 656e 7473 2062 6566 6f72 6520 7468 6569  ents before thei
-0001fcf0: 7220 6368 696c 6472 656e 2062 7574 2074  r children but t
-0001fd00: 6869 7320 6973 206e 6f74 2061 6c77 6179  his is not alway
-0001fd10: 730a 2020 2020 2020 2020 6775 6172 616e  s.        guaran
-0001fd20: 7465 6564 2e20 5365 6520 6874 7470 733a  teed. See https:
-0001fd30: 2f2f 6769 7468 7562 2e63 6f6d 2f53 616d  //github.com/Sam
-0001fd40: 5363 686f 7474 2f6d 6165 7374 7261 6c2f  Schott/maestral/
-0001fd50: 6973 7375 6573 2f34 3532 2e0a 0a20 2020  issues/452...   
-0001fd60: 2020 2020 203a 7061 7261 6d20 6576 656e       :param even
-0001fd70: 743a 2053 796e 6345 7665 6e74 2066 6f72  t: SyncEvent for
-0001fd80: 2074 6172 6765 7420 6669 6c65 2e0a 2020   target file..  
-0001fd90: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-0001fda0: 2020 6462 785f 7061 7468 5f6c 6f77 6572    dbx_path_lower
-0001fdb0: 5f64 6972 6e61 6d65 203d 206f 7370 2e64  _dirname = osp.d
-0001fdc0: 6972 6e61 6d65 2865 7665 6e74 2e64 6278  irname(event.dbx
-0001fdd0: 5f70 6174 685f 6c6f 7765 7229 0a0a 2020  _path_lower)..  
-0001fde0: 2020 2020 2020 6966 2064 6278 5f70 6174        if dbx_pat
-0001fdf0: 685f 6c6f 7765 725f 6469 726e 616d 6520  h_lower_dirname 
-0001fe00: 3d3d 2022 2f22 3a0a 2020 2020 2020 2020  == "/":.        
-0001fe10: 2020 2020 7265 7475 726e 0a0a 2020 2020      return..    
-0001fe20: 2020 2020 7769 7468 2073 656c 662e 5f74      with self._t
-0001fe30: 7265 655f 7472 6176 6572 7361 6c3a 0a20  ree_traversal:. 
-0001fe40: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
-0001fe50: 7420 7365 6c66 2e67 6574 5f69 6e64 6578  t self.get_index
-0001fe60: 5f65 6e74 7279 2864 6278 5f70 6174 685f  _entry(dbx_path_
-0001fe70: 6c6f 7765 725f 6469 726e 616d 6529 3a0a  lower_dirname):.
-0001fe80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fe90: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
-0001fea0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
-0001feb0: 2020 2020 2020 2020 6622 5061 7265 6e74          f"Parent
-0001fec0: 2066 6f6c 6465 7220 7b64 6278 5f70 6174   folder {dbx_pat
-0001fed0: 685f 6c6f 7765 725f 6469 726e 616d 657d  h_lower_dirname}
-0001fee0: 2069 7320 6e6f 7420 696e 2069 6e64 6578   is not in index
-0001fef0: 2e20 220a 2020 2020 2020 2020 2020 2020  . ".            
-0001ff00: 2020 2020 2020 2020 6622 5379 6e63 696e          f"Syncin
-0001ff10: 6720 6974 206e 6f77 2062 6566 6f72 6520  g it now before 
-0001ff20: 7379 6e63 696e 6720 616e 7920 6368 696c  syncing any chil
-0001ff30: 6472 656e 2e22 0a20 2020 2020 2020 2020  dren.".         
-0001ff40: 2020 2020 2020 2029 0a0a 2020 2020 2020         )..      
-0001ff50: 2020 2020 2020 2020 2020 7061 7265 6e74            parent
-0001ff60: 5f6d 6420 3d20 7365 6c66 2e63 6c69 656e  _md = self.clien
-0001ff70: 742e 6765 745f 6d65 7461 6461 7461 2864  t.get_metadata(d
-0001ff80: 6278 5f70 6174 685f 6c6f 7765 725f 6469  bx_path_lower_di
-0001ff90: 726e 616d 6529 0a0a 2020 2020 2020 2020  rname)..        
-0001ffa0: 2020 2020 2020 2020 6966 2070 6172 656e          if paren
-0001ffb0: 745f 6d64 3a20 2023 2049 6620 7468 6520  t_md:  # If the 
-0001ffc0: 7061 7265 6e74 206e 6f20 6c6f 6e67 6572  parent no longer
-0001ffd0: 2065 7869 7374 732c 2077 6520 646f 6e27   exists, we don'
-0001ffe0: 7420 646f 2061 6e79 7468 696e 672e 0a20  t do anything.. 
-0001fff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020000: 2020 2070 6172 656e 745f 6576 656e 7420     parent_event 
-00020010: 3d20 5379 6e63 4576 656e 742e 6672 6f6d  = SyncEvent.from
-00020020: 5f6d 6574 6164 6174 6128 7061 7265 6e74  _metadata(parent
-00020030: 5f6d 642c 2073 656c 6629 0a20 2020 2020  _md, self).     
-00020040: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00020050: 656c 662e 5f6f 6e5f 7265 6d6f 7465 5f66  elf._on_remote_f
-00020060: 6f6c 6465 7228 7061 7265 6e74 5f65 7665  older(parent_eve
-00020070: 6e74 290a 0a20 2020 2064 6566 205f 6c6f  nt)..    def _lo
-00020080: 6361 6c5f 6363 5f66 696c 656e 616d 6528  cal_cc_filename(
-00020090: 7365 6c66 2c20 6c6f 6361 6c5f 7061 7468  self, local_path
-000200a0: 3a20 7374 722c 2064 6269 643a 2073 7472  : str, dbid: str
-000200b0: 207c 204e 6f6e 6529 202d 3e20 7374 723a   | None) -> str:
-000200c0: 0a20 2020 2020 2020 2063 6861 6e67 655f  .        change_
-000200d0: 6f77 6e65 7220 3d20 7365 6c66 2e5f 6469  owner = self._di
-000200e0: 7370 6c61 795f 6e61 6d65 5f66 6f72 5f61  splay_name_for_a
-000200f0: 6363 6f75 6e74 2864 6269 6429 0a20 2020  ccount(dbid).   
-00020100: 2020 2020 2064 6174 6520 3d20 6461 7465       date = date
-00020110: 7469 6d65 2e6e 6f77 2829 2e73 7472 6674  time.now().strft
-00020120: 696d 6528 2225 592d 256d 2d25 6422 290a  ime("%Y-%m-%d").
-00020130: 2020 2020 2020 2020 6966 2063 6861 6e67          if chang
-00020140: 655f 6f77 6e65 723a 0a20 2020 2020 2020  e_owner:.       
-00020150: 2020 2020 2073 7566 6669 7820 3d20 6622       suffix = f"
-00020160: 7b63 6861 6e67 655f 6f77 6e65 727d 2773  {change_owner}'s
-00020170: 2063 6f6e 666c 6963 7465 6420 636f 7079   conflicted copy
-00020180: 207b 6461 7465 7d22 0a20 2020 2020 2020   {date}".       
-00020190: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000201a0: 2020 2073 7566 6669 7820 3d20 6622 636f     suffix = f"co
-000201b0: 6e66 6c69 6374 6564 2063 6f70 7920 7b64  nflicted copy {d
-000201c0: 6174 657d 220a 2020 2020 2020 2020 7265  ate}".        re
-000201d0: 7475 726e 2067 656e 6572 6174 655f 6363  turn generate_cc
-000201e0: 5f6e 616d 6528 6c6f 6361 6c5f 7061 7468  _name(local_path
-000201f0: 2c20 7375 6666 6978 290a 0a20 2020 2064  , suffix)..    d
-00020200: 6566 205f 6f6e 5f72 656d 6f74 655f 6669  ef _on_remote_fi
-00020210: 6c65 2873 656c 662c 2065 7665 6e74 3a20  le(self, event: 
-00020220: 5379 6e63 4576 656e 7429 202d 3e20 5379  SyncEvent) -> Sy
-00020230: 6e63 5374 6174 7573 3a0a 2020 2020 2020  ncStatus:.      
-00020240: 2020 2222 220a 2020 2020 2020 2020 4170    """.        Ap
-00020250: 706c 6965 7320 6120 7265 6d6f 7465 2066  plies a remote f
-00020260: 696c 6520 6368 616e 6765 206f 7220 6372  ile change or cr
-00020270: 6561 7469 6f6e 206c 6f63 616c 6c79 2e0a  eation locally..
-00020280: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
-00020290: 6576 656e 743a 2053 796e 6345 7665 6e74  event: SyncEvent
-000202a0: 2066 6f72 2066 696c 6520 646f 776e 6c6f   for file downlo
-000202b0: 6164 2e0a 2020 2020 2020 2020 3a72 6574  ad..        :ret
-000202c0: 7572 6e73 3a20 5379 6e63 4576 656e 7420  urns: SyncEvent 
-000202d0: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
-000202e0: 206c 6f63 616c 2069 7465 6d20 6f72 204e   local item or N
-000202f0: 6f6e 6520 6966 206e 6f20 6c6f 6361 6c20  one if no local 
-00020300: 6368 616e 6765 730a 2020 2020 2020 2020  changes.        
-00020310: 2020 2020 6172 6520 6d61 6465 2e0a 2020      are made..  
-00020320: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00020330: 2020 7365 6c66 2e5f 6170 706c 795f 6361    self._apply_ca
-00020340: 7365 5f63 6861 6e67 6528 6576 656e 7429  se_change(event)
-00020350: 0a0a 2020 2020 2020 2020 2320 5374 6f72  ..        # Stor
-00020360: 6520 7468 6520 6e65 7720 656e 7472 7920  e the new entry 
-00020370: 6174 2074 6865 2067 6976 656e 2070 6174  at the given pat
-00020380: 6820 696e 2079 6f75 7220 6c6f 6361 6c20  h in your local 
-00020390: 7374 6174 652e 2049 6620 7468 6520 7265  state. If the re
-000203a0: 7175 6972 6564 0a20 2020 2020 2020 2023  quired.        #
-000203b0: 2070 6172 656e 7420 666f 6c64 6572 7320   parent folders 
-000203c0: 646f 6ee2 8099 7420 6578 6973 7420 7965  don...t exist ye
-000203d0: 742c 2063 7265 6174 6520 7468 656d 2e20  t, create them. 
-000203e0: 4966 2074 6865 7265 e280 9973 2061 6c72  If there...s alr
-000203f0: 6561 6479 2073 6f6d 6574 6869 6e67 2065  eady something e
-00020400: 6c73 650a 2020 2020 2020 2020 2320 6174  lse.        # at
-00020410: 2074 6865 2067 6976 656e 2070 6174 682c   the given path,
-00020420: 2072 6570 6c61 6365 2069 7420 616e 6420   replace it and 
-00020430: 7265 6d6f 7665 2061 6c6c 2069 7473 2063  remove all its c
-00020440: 6869 6c64 7265 6e2e 0a0a 2020 2020 2020  hildren...      
-00020450: 2020 636f 6e66 6c69 6374 5f63 6865 636b    conflict_check
-00020460: 203d 2073 656c 662e 5f63 6865 636b 5f64   = self._check_d
-00020470: 6f77 6e6c 6f61 645f 636f 6e66 6c69 6374  ownload_conflict
-00020480: 2865 7665 6e74 290a 0a20 2020 2020 2020  (event)..       
-00020490: 2069 6620 636f 6e66 6c69 6374 5f63 6865   if conflict_che
-000204a0: 636b 2069 7320 436f 6e66 6c69 6374 2e49  ck is Conflict.I
-000204b0: 6465 6e74 6963 616c 3a0a 2020 2020 2020  dentical:.      
-000204c0: 2020 2020 2020 7365 6c66 2e75 7064 6174        self.updat
-000204d0: 655f 696e 6465 785f 6672 6f6d 5f73 796e  e_index_from_syn
-000204e0: 635f 6576 656e 7428 6576 656e 7429 0a20  c_event(event). 
-000204f0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00020500: 6e20 5379 6e63 5374 6174 7573 2e53 6b69  n SyncStatus.Ski
-00020510: 7070 6564 0a20 2020 2020 2020 2065 6c69  pped.        eli
-00020520: 6620 636f 6e66 6c69 6374 5f63 6865 636b  f conflict_check
-00020530: 2069 7320 436f 6e66 6c69 6374 2e4c 6f63   is Conflict.Loc
-00020540: 616c 4e65 7765 724f 7249 6465 6e74 6963  alNewerOrIdentic
-00020550: 616c 3a0a 2020 2020 2020 2020 2020 2020  al:.            
-00020560: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
-00020570: 732e 536b 6970 7065 640a 0a20 2020 2020  s.Skipped..     
-00020580: 2020 2023 2045 6e73 7572 6520 7468 6174     # Ensure that
-00020590: 2070 6172 656e 7420 666f 6c64 6572 7320   parent folders 
-000205a0: 6172 6520 7379 6e63 6564 2e0a 2020 2020  are synced..    
-000205b0: 2020 2020 7365 6c66 2e5f 656e 7375 7265      self._ensure
-000205c0: 5f70 6172 656e 7428 6576 656e 7429 0a0a  _parent(event)..
-000205d0: 2020 2020 2020 2020 6966 2065 7665 6e74          if event
-000205e0: 2e73 796d 6c69 6e6b 5f74 6172 6765 7420  .symlink_target 
-000205f0: 6973 206e 6f74 204e 6f6e 653a 0a20 2020  is not None:.   
-00020600: 2020 2020 2020 2020 2023 2044 6f6e 2774           # Don't
-00020610: 2064 6f77 6e6c 6f61 6420 6275 7420 7265   download but re
-00020620: 7072 6f64 7563 6520 7379 6d6c 696e 6b20  produce symlink 
-00020630: 6c6f 6361 6c6c 792e 0a20 2020 2020 2020  locally..       
-00020640: 2020 2020 2077 6974 6820 7365 6c66 2e66       with self.f
-00020650: 735f 6576 656e 7473 2e69 676e 6f72 6528  s_events.ignore(
-00020660: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00020670: 2046 696c 6543 7265 6174 6564 4576 656e   FileCreatedEven
-00020680: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
-00020690: 7468 292c 2072 6563 7572 7369 7665 3d46  th), recursive=F
-000206a0: 616c 7365 0a20 2020 2020 2020 2020 2020  alse.           
-000206b0: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-000206c0: 2020 2020 7769 7468 2063 6f6e 7665 7274      with convert
-000206d0: 5f61 7069 5f65 7272 6f72 7328 6462 785f  _api_errors(dbx_
-000206e0: 7061 7468 3d65 7665 6e74 2e64 6278 5f70  path=event.dbx_p
-000206f0: 6174 6829 3a0a 2020 2020 2020 2020 2020  ath):.          
-00020700: 2020 2020 2020 2020 2020 6f73 2e73 796d            os.sym
-00020710: 6c69 6e6b 2865 7665 6e74 2e73 796d 6c69  link(event.symli
-00020720: 6e6b 5f74 6172 6765 742c 2065 7665 6e74  nk_target, event
-00020730: 2e6c 6f63 616c 5f70 6174 6829 0a20 2020  .local_path).   
-00020740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020750: 2073 7461 7420 3d20 6f73 2e6c 7374 6174   stat = os.lstat
-00020760: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
-00020770: 6829 0a20 2020 2020 2020 2020 2020 2073  h).            s
-00020780: 7461 7475 7320 3d20 5379 6e63 5374 6174  tatus = SyncStat
-00020790: 7573 2e44 6f6e 650a 2020 2020 2020 2020  us.Done.        
-000207a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000207b0: 2020 2320 5765 2064 6f77 6e6c 6f61 6420    # We download 
-000207c0: 746f 2061 2074 656d 706f 7261 7279 2066  to a temporary f
-000207d0: 696c 6520 6669 7273 7420 2874 6869 7320  ile first (this 
-000207e0: 6d61 7920 7461 6b65 2073 6f6d 6520 7469  may take some ti
-000207f0: 6d65 292e 0a20 2020 2020 2020 2020 2020  me)..           
-00020800: 2074 6d70 5f66 6e61 6d65 203d 2073 656c   tmp_fname = sel
-00020810: 662e 5f6e 6577 5f74 6d70 5f66 696c 6528  f._new_tmp_file(
-00020820: 290a 0a20 2020 2020 2020 2020 2020 2074  )..            t
-00020830: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00020840: 2020 2020 7769 7468 2073 656c 662e 5f70      with self._p
-00020850: 6172 616c 6c65 6c5f 646f 776e 5f73 656d  arallel_down_sem
-00020860: 6170 686f 7265 3a0a 2020 2020 2020 2020  aphore:.        
-00020870: 2020 2020 2020 2020 2020 2020 6d64 203d              md =
-00020880: 2073 656c 662e 636c 6965 6e74 2e64 6f77   self.client.dow
-00020890: 6e6c 6f61 6428 0a20 2020 2020 2020 2020  nload(.         
-000208a0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
-000208b0: 2272 6576 3a7b 6576 656e 742e 7265 767d  "rev:{event.rev}
-000208c0: 222c 2074 6d70 5f66 6e61 6d65 2c20 7379  ", tmp_fname, sy
-000208d0: 6e63 5f65 7665 6e74 3d65 7665 6e74 0a20  nc_event=event. 
-000208e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000208f0: 2020 2029 0a20 2020 2020 2020 2020 2020     ).           
-00020900: 2020 2020 2065 7665 6e74 203d 2053 796e       event = Syn
-00020910: 6345 7665 6e74 2e66 726f 6d5f 6d65 7461  cEvent.from_meta
-00020920: 6461 7461 286d 642c 2073 656c 6629 0a20  data(md, self). 
-00020930: 2020 2020 2020 2020 2020 2065 7863 6570             excep
-00020940: 7420 5379 6e63 4572 726f 7220 6173 2065  t SyncError as e
-00020950: 7272 3a0a 2020 2020 2020 2020 2020 2020  rr:.            
-00020960: 2020 2020 2320 5265 706c 6163 6520 7265      # Replace re
-00020970: 7620 6e75 6d62 6572 2077 6974 6820 7061  v number with pa
-00020980: 7468 2e0a 2020 2020 2020 2020 2020 2020  th..            
-00020990: 2020 2020 6572 722e 6462 785f 7061 7468      err.dbx_path
-000209a0: 203d 2065 7665 6e74 2e64 6278 5f70 6174   = event.dbx_pat
-000209b0: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-000209c0: 2020 7261 6973 6520 6572 720a 0a20 2020    raise err..   
-000209d0: 2020 2020 2020 2020 2023 2052 652d 6368           # Re-ch
-000209e0: 6563 6b20 666f 7220 636f 6e66 6c69 6374  eck for conflict
-000209f0: 2061 6e64 206d 6f76 6520 7468 6520 636f   and move the co
-00020a00: 6e66 6c69 6374 0a20 2020 2020 2020 2020  nflict.         
-00020a10: 2020 2023 206f 7574 206f 6620 7468 6520     # out of the 
-00020a20: 7761 7920 6966 2061 6e79 7468 696e 6720  way if anything 
-00020a30: 6861 7320 6368 616e 6765 642e 0a20 2020  has changed..   
-00020a40: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00020a50: 2e5f 6368 6563 6b5f 646f 776e 6c6f 6164  ._check_download
-00020a60: 5f63 6f6e 666c 6963 7428 6576 656e 7429  _conflict(event)
-00020a70: 203d 3d20 436f 6e66 6c69 6374 2e43 6f6e   == Conflict.Con
-00020a80: 666c 6963 743a 0a20 2020 2020 2020 2020  flict:.         
-00020a90: 2020 2020 2020 2063 635f 6c6f 6361 6c5f         cc_local_
-00020aa0: 7061 7468 203d 2073 656c 662e 5f6c 6f63  path = self._loc
-00020ab0: 616c 5f63 635f 6669 6c65 6e61 6d65 280a  al_cc_filename(.
-00020ac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020ad0: 2020 2020 6576 656e 742e 6c6f 6361 6c5f      event.local_
-00020ae0: 7061 7468 2c20 6576 656e 742e 6368 616e  path, event.chan
-00020af0: 6765 5f64 6269 640a 2020 2020 2020 2020  ge_dbid.        
-00020b00: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00020b10: 2020 2020 2020 2020 2020 6576 656e 745f            event_
-00020b20: 636c 7320 3d20 4469 724d 6f76 6564 4576  cls = DirMovedEv
-00020b30: 656e 7420 6966 2069 7364 6972 2865 7665  ent if isdir(eve
-00020b40: 6e74 2e6c 6f63 616c 5f70 6174 6829 2065  nt.local_path) e
-00020b50: 6c73 6520 4669 6c65 4d6f 7665 6445 7665  lse FileMovedEve
-00020b60: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
-00020b70: 2020 2077 6974 6820 7365 6c66 2e66 735f     with self.fs_
-00020b80: 6576 656e 7473 2e69 676e 6f72 6528 6576  events.ignore(ev
-00020b90: 656e 745f 636c 7328 6576 656e 742e 6c6f  ent_cls(event.lo
-00020ba0: 6361 6c5f 7061 7468 2c20 6363 5f6c 6f63  cal_path, cc_loc
-00020bb0: 616c 5f70 6174 6829 293a 0a20 2020 2020  al_path)):.     
-00020bc0: 2020 2020 2020 2020 2020 2020 2020 2077                 w
-00020bd0: 6974 6820 636f 6e76 6572 745f 6170 695f  ith convert_api_
-00020be0: 6572 726f 7273 2829 3a0a 2020 2020 2020  errors():.      
-00020bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c00: 2020 6d6f 7665 2865 7665 6e74 2e6c 6f63    move(event.loc
-00020c10: 616c 5f70 6174 682c 2063 635f 6c6f 6361  al_path, cc_loca
-00020c20: 6c5f 7061 7468 2c20 7261 6973 655f 6572  l_path, raise_er
-00020c30: 726f 723d 5472 7565 290a 0a20 2020 2020  ror=True)..     
-00020c40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00020c50: 5f6c 6f67 6765 722e 6465 6275 6728 0a20  _logger.debug(. 
-00020c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020c70: 2020 2027 446f 776e 6c6f 6164 2063 6f6e     'Download con
-00020c80: 666c 6963 743a 2072 656e 616d 6564 2022  flict: renamed "
-00020c90: 2573 2220 746f 2022 2573 2227 2c0a 2020  %s" to "%s"',.  
-00020ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020cb0: 2020 6576 656e 742e 6c6f 6361 6c5f 7061    event.local_pa
-00020cc0: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-00020cd0: 2020 2020 2020 2020 6363 5f6c 6f63 616c          cc_local
-00020ce0: 5f70 6174 682c 0a20 2020 2020 2020 2020  _path,.         
-00020cf0: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-00020d00: 2020 2020 2020 2020 2073 656c 662e 7265           self.re
-00020d10: 7363 616e 2863 635f 6c6f 6361 6c5f 7061  scan(cc_local_pa
-00020d20: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
-00020d30: 2020 2020 7374 6174 7573 203d 2053 796e      status = Syn
-00020d40: 6353 7461 7475 732e 436f 6e66 6c69 6374  cStatus.Conflict
-00020d50: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00020d60: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00020d70: 2020 2073 7461 7475 7320 3d20 5379 6e63     status = Sync
-00020d80: 5374 6174 7573 2e44 6f6e 650a 0a20 2020  Status.Done..   
-00020d90: 2020 2020 2020 2020 2069 6620 6973 6469           if isdi
-00020da0: 7228 6576 656e 742e 6c6f 6361 6c5f 7061  r(event.local_pa
-00020db0: 7468 293a 0a20 2020 2020 2020 2020 2020  th):.           
-00020dc0: 2020 2020 2077 6974 6820 7365 6c66 2e66       with self.f
-00020dd0: 735f 6576 656e 7473 2e69 676e 6f72 6528  s_events.ignore(
-00020de0: 4469 7244 656c 6574 6564 4576 656e 7428  DirDeletedEvent(
-00020df0: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-00020e00: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00020e10: 2020 2020 2020 2020 6465 6c65 7465 280a          delete(.
-00020e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e30: 2020 2020 2020 2020 6576 656e 742e 6c6f          event.lo
-00020e40: 6361 6c5f 7061 7468 2c0a 2020 2020 2020  cal_path,.      
-00020e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e60: 2020 666f 7263 655f 6361 7365 5f73 656e    force_case_sen
-00020e70: 7369 7469 7665 3d6e 6f74 2073 656c 662e  sitive=not self.
-00020e80: 6973 5f66 735f 6361 7365 5f73 656e 7369  is_fs_case_sensi
-00020e90: 7469 7665 2c0a 2020 2020 2020 2020 2020  tive,.          
-00020ea0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-00020eb0: 2020 2020 2020 2020 2069 676e 6f72 655f           ignore_
-00020ec0: 6576 656e 7473 3a20 6c69 7374 5b46 696c  events: list[Fil
-00020ed0: 6553 7973 7465 6d45 7665 6e74 5d20 3d20  eSystemEvent] = 
-00020ee0: 5b0a 2020 2020 2020 2020 2020 2020 2020  [.              
-00020ef0: 2020 4669 6c65 4d6f 7665 6445 7665 6e74    FileMovedEvent
-00020f00: 2874 6d70 5f66 6e61 6d65 2c20 6576 656e  (tmp_fname, even
-00020f10: 742e 6c6f 6361 6c5f 7061 7468 290a 2020  t.local_path).  
-00020f20: 2020 2020 2020 2020 2020 5d0a 0a20 2020            ]..   
-00020f30: 2020 2020 2020 2020 2023 2050 7265 7365           # Prese
-00020f40: 7276 6520 7065 726d 6973 7369 6f6e 7320  rve permissions 
-00020f50: 6f66 2074 6865 2064 6573 7469 6e61 7469  of the destinati
-00020f60: 6f6e 2066 696c 6520 6966 2077 6520 6172  on file if we ar
-00020f70: 6520 6f6e 6c79 2073 796e 6369 6e67 2061  e only syncing a
-00020f80: 6e0a 2020 2020 2020 2020 2020 2020 2320  n.            # 
-00020f90: 7570 6461 7465 2074 6f20 7468 6520 6669  update to the fi
-00020fa0: 6c65 2063 6f6e 7465 6e74 2028 4472 6f70  le content (Drop
-00020fb0: 626f 7820 4944 206f 6620 7468 6520 6669  box ID of the fi
-00020fc0: 6c65 2072 656d 6169 6e73 2074 6865 2073  le remains the s
-00020fd0: 616d 6529 2e0a 2020 2020 2020 2020 2020  ame)..          
-00020fe0: 2020 6f6c 645f 656e 7472 7920 3d20 7365    old_entry = se
-00020ff0: 6c66 2e67 6574 5f69 6e64 6578 5f65 6e74  lf.get_index_ent
-00021000: 7279 2865 7665 6e74 2e64 6278 5f70 6174  ry(event.dbx_pat
-00021010: 685f 6c6f 7765 7229 0a20 2020 2020 2020  h_lower).       
-00021020: 2020 2020 2070 7265 7365 7276 655f 7065       preserve_pe
-00021030: 726d 6973 7369 6f6e 7320 3d20 626f 6f6c  rmissions = bool
-00021040: 286f 6c64 5f65 6e74 7279 2061 6e64 2065  (old_entry and e
-00021050: 7665 6e74 2e64 6278 5f69 6420 3d3d 206f  vent.dbx_id == o
-00021060: 6c64 5f65 6e74 7279 2e64 6278 5f69 6429  ld_entry.dbx_id)
-00021070: 0a0a 2020 2020 2020 2020 2020 2020 6966  ..            if
-00021080: 2070 7265 7365 7276 655f 7065 726d 6973   preserve_permis
-00021090: 7369 6f6e 733a 0a20 2020 2020 2020 2020  sions:.         
-000210a0: 2020 2020 2020 2023 2049 676e 6f72 6520         # Ignore 
-000210b0: 4669 6c65 4d6f 6469 6669 6564 4576 656e  FileModifiedEven
-000210c0: 7420 7768 656e 2063 6861 6e67 696e 6720  t when changing 
-000210d0: 7065 726d 6973 7369 6f6e 732e 0a20 2020  permissions..   
-000210e0: 2020 2020 2020 2020 2020 2020 2023 204e               # N
-000210f0: 6f74 6520 7468 6174 2074 776f 2046 696c  ote that two Fil
-00021100: 654d 6f64 6966 6965 6445 7665 6e74 7320  eModifiedEvents 
-00021110: 6d61 7920 6265 2065 6d69 7474 6564 206f  may be emitted o
-00021120: 6e20 6d61 634f 532e 0a20 2020 2020 2020  n macOS..       
-00021130: 2020 2020 2020 2020 2069 676e 6f72 655f           ignore_
-00021140: 6576 656e 7473 2e61 7070 656e 6428 4669  events.append(Fi
-00021150: 6c65 4d6f 6469 6669 6564 4576 656e 7428  leModifiedEvent(
-00021160: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-00021170: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-00021180: 2020 2069 6620 4953 5f4d 4143 4f53 3a0a     if IS_MACOS:.
-00021190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000211a0: 2020 2020 6967 6e6f 7265 5f65 7665 6e74      ignore_event
-000211b0: 732e 6170 7065 6e64 2846 696c 654d 6f64  s.append(FileMod
-000211c0: 6966 6965 6445 7665 6e74 2865 7665 6e74  ifiedEvent(event
-000211d0: 2e6c 6f63 616c 5f70 6174 6829 290a 0a20  .local_path)).. 
-000211e0: 2020 2020 2020 2020 2020 2069 6620 6973             if is
-000211f0: 6669 6c65 2865 7665 6e74 2e6c 6f63 616c  file(event.local
-00021200: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
-00021210: 2020 2020 2020 2020 2320 4967 6e6f 7265          # Ignore
-00021220: 2046 696c 6544 656c 6574 6564 4576 656e   FileDeletedEven
-00021230: 7420 7768 656e 2072 6570 6c61 6369 6e67  t when replacing
-00021240: 206f 6c64 2066 696c 652e 0a20 2020 2020   old file..     
-00021250: 2020 2020 2020 2020 2020 2069 676e 6f72             ignor
-00021260: 655f 6576 656e 7473 2e61 7070 656e 6428  e_events.append(
-00021270: 4669 6c65 4465 6c65 7465 6445 7665 6e74  FileDeletedEvent
-00021280: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
-00021290: 6829 290a 0a20 2020 2020 2020 2020 2020  h))..           
-000212a0: 2023 204d 6f76 6520 7468 6520 646f 776e   # Move the down
-000212b0: 6c6f 6164 6564 2066 696c 6520 746f 2069  loaded file to i
-000212c0: 7473 2064 6573 7469 6e61 7469 6f6e 2e0a  ts destination..
-000212d0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-000212e0: 2073 656c 662e 6673 5f65 7665 6e74 732e   self.fs_events.
-000212f0: 6967 6e6f 7265 282a 6967 6e6f 7265 5f65  ignore(*ignore_e
-00021300: 7665 6e74 732c 2072 6563 7572 7369 7665  vents, recursive
-00021310: 3d46 616c 7365 293a 0a20 2020 2020 2020  =False):.       
-00021320: 2020 2020 2020 2020 2077 6974 6820 636f           with co
-00021330: 6e76 6572 745f 6170 695f 6572 726f 7273  nvert_api_errors
-00021340: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
-00021350: 2020 2020 2020 6462 785f 7061 7468 3d65        dbx_path=e
-00021360: 7665 6e74 2e64 6278 5f70 6174 682c 206c  vent.dbx_path, l
-00021370: 6f63 616c 5f70 6174 683d 6576 656e 742e  ocal_path=event.
-00021380: 6c6f 6361 6c5f 7061 7468 0a20 2020 2020  local_path.     
-00021390: 2020 2020 2020 2020 2020 2029 3a0a 2020             ):.  
-000213a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000213b0: 2020 7374 6174 203d 206f 732e 6c73 7461    stat = os.lsta
-000213c0: 7428 746d 705f 666e 616d 6529 0a20 2020  t(tmp_fname).   
-000213d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000213e0: 206d 6f76 6528 0a20 2020 2020 2020 2020   move(.         
-000213f0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00021400: 6d70 5f66 6e61 6d65 2c0a 2020 2020 2020  mp_fname,.      
-00021410: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021420: 2020 6576 656e 742e 6c6f 6361 6c5f 7061    event.local_pa
-00021430: 7468 2c0a 2020 2020 2020 2020 2020 2020  th,.            
-00021440: 2020 2020 2020 2020 2020 2020 7072 6573              pres
-00021450: 6572 7665 5f64 6573 745f 7065 726d 6973  erve_dest_permis
-00021460: 7369 6f6e 733d 7072 6573 6572 7665 5f70  sions=preserve_p
-00021470: 6572 6d69 7373 696f 6e73 2c0a 2020 2020  ermissions,.    
-00021480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021490: 2020 2020 7261 6973 655f 6572 726f 723d      raise_error=
-000214a0: 5472 7565 2c0a 2020 2020 2020 2020 2020  True,.          
-000214b0: 2020 2020 2020 2020 2020 290a 0a20 2020            )..   
-000214c0: 2020 2020 2073 656c 662e 7570 6461 7465       self.update
-000214d0: 5f69 6e64 6578 5f66 726f 6d5f 7379 6e63  _index_from_sync
-000214e0: 5f65 7665 6e74 2865 7665 6e74 290a 2020  _event(event).  
-000214f0: 2020 2020 2020 7365 6c66 2e5f 7361 7665        self._save
-00021500: 5f6c 6f63 616c 5f68 6173 6828 0a20 2020  _local_hash(.   
-00021510: 2020 2020 2020 2020 2073 7461 742e 7374           stat.st
-00021520: 5f69 6e6f 2c20 6576 656e 742e 6c6f 6361  _ino, event.loca
-00021530: 6c5f 7061 7468 2c20 6576 656e 742e 636f  l_path, event.co
-00021540: 6e74 656e 745f 6861 7368 2c20 7374 6174  ntent_hash, stat
-00021550: 2e73 745f 6d74 696d 650a 2020 2020 2020  .st_mtime.      
-00021560: 2020 290a 0a20 2020 2020 2020 2073 656c    )..        sel
-00021570: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
-00021580: 2743 7265 6174 6564 206c 6f63 616c 2066  'Created local f
-00021590: 696c 6520 2225 7322 272c 2065 7665 6e74  ile "%s"', event
-000215a0: 2e64 6278 5f70 6174 6829 0a0a 2020 2020  .dbx_path)..    
-000215b0: 2020 2020 7265 7475 726e 2073 7461 7475      return statu
-000215c0: 730a 0a20 2020 2064 6566 205f 6f6e 5f72  s..    def _on_r
-000215d0: 656d 6f74 655f 666f 6c64 6572 2873 656c  emote_folder(sel
-000215e0: 662c 2065 7665 6e74 3a20 5379 6e63 4576  f, event: SyncEv
-000215f0: 656e 7429 202d 3e20 5379 6e63 5374 6174  ent) -> SyncStat
-00021600: 7573 3a0a 2020 2020 2020 2020 2222 220a  us:.        """.
-00021610: 2020 2020 2020 2020 4170 706c 6965 7320          Applies 
-00021620: 6120 7265 6d6f 7465 2066 6f6c 6465 7220  a remote folder 
-00021630: 6372 6561 7469 6f6e 206c 6f63 616c 6c79  creation locally
-00021640: 2e0a 0a20 2020 2020 2020 203a 7061 7261  ...        :para
-00021650: 6d20 6576 656e 743a 2053 796e 6345 7665  m event: SyncEve
-00021660: 6e74 2066 6f72 2066 6f6c 6465 7220 646f  nt for folder do
-00021670: 776e 6c6f 6164 2e0a 2020 2020 2020 2020  wnload..        
-00021680: 3a72 6574 7572 6e73 3a20 5379 6e63 4576  :returns: SyncEv
-00021690: 656e 7420 636f 7272 6573 706f 6e64 696e  ent correspondin
-000216a0: 6720 746f 206c 6f63 616c 2069 7465 6d20  g to local item 
-000216b0: 6f72 204e 6f6e 6520 6966 206e 6f20 6c6f  or None if no lo
-000216c0: 6361 6c20 6368 616e 6765 730a 2020 2020  cal changes.    
-000216d0: 2020 2020 2020 2020 6172 6520 6d61 6465          are made
-000216e0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-000216f0: 2020 2020 2020 7365 6c66 2e5f 6170 706c        self._appl
-00021700: 795f 6361 7365 5f63 6861 6e67 6528 6576  y_case_change(ev
-00021710: 656e 7429 0a0a 2020 2020 2020 2020 2320  ent)..        # 
-00021720: 5374 6f72 6520 7468 6520 6e65 7720 656e  Store the new en
-00021730: 7472 7920 6174 2074 6865 2067 6976 656e  try at the given
-00021740: 2070 6174 6820 696e 2079 6f75 7220 6c6f   path in your lo
-00021750: 6361 6c20 7374 6174 652e 2049 6620 7468  cal state. If th
-00021760: 6520 7265 7175 6972 6564 0a20 2020 2020  e required.     
-00021770: 2020 2023 2070 6172 656e 7420 666f 6c64     # parent fold
-00021780: 6572 7320 646f 6ee2 8099 7420 6578 6973  ers don...t exis
-00021790: 7420 7965 742c 2063 7265 6174 6520 7468  t yet, create th
-000217a0: 656d 2e20 4966 2074 6865 7265 e280 9973  em. If there...s
-000217b0: 2061 6c72 6561 6479 2073 6f6d 6574 6869   already somethi
-000217c0: 6e67 2065 6c73 650a 2020 2020 2020 2020  ng else.        
-000217d0: 2320 6174 2074 6865 2067 6976 656e 2070  # at the given p
-000217e0: 6174 682c 2072 6570 6c61 6365 2069 7420  ath, replace it 
-000217f0: 6275 7420 6c65 6176 6520 7468 6520 6368  but leave the ch
-00021800: 696c 6472 656e 2061 7320 7468 6579 2061  ildren as they a
-00021810: 7265 2e0a 0a20 2020 2020 2020 2063 6f6e  re...        con
-00021820: 666c 6963 745f 6368 6563 6b20 3d20 7365  flict_check = se
-00021830: 6c66 2e5f 6368 6563 6b5f 646f 776e 6c6f  lf._check_downlo
-00021840: 6164 5f63 6f6e 666c 6963 7428 6576 656e  ad_conflict(even
-00021850: 7429 0a0a 2020 2020 2020 2020 6966 2063  t)..        if c
-00021860: 6f6e 666c 6963 745f 6368 6563 6b20 6973  onflict_check is
-00021870: 2043 6f6e 666c 6963 742e 4964 656e 7469   Conflict.Identi
-00021880: 6361 6c3a 0a20 2020 2020 2020 2020 2020  cal:.           
-00021890: 2073 656c 662e 7570 6461 7465 5f69 6e64   self.update_ind
-000218a0: 6578 5f66 726f 6d5f 7379 6e63 5f65 7665  ex_from_sync_eve
-000218b0: 6e74 2865 7665 6e74 290a 2020 2020 2020  nt(event).      
-000218c0: 2020 2020 2020 7265 7475 726e 2053 796e        return Syn
-000218d0: 6353 7461 7475 732e 536b 6970 7065 640a  cStatus.Skipped.
-000218e0: 2020 2020 2020 2020 656c 6966 2063 6f6e          elif con
-000218f0: 666c 6963 745f 6368 6563 6b20 6973 2043  flict_check is C
-00021900: 6f6e 666c 6963 742e 4c6f 6361 6c4e 6577  onflict.LocalNew
-00021910: 6572 4f72 4964 656e 7469 6361 6c3a 0a20  erOrIdentical:. 
-00021920: 2020 2020 2020 2020 2020 2072 6574 7572             retur
-00021930: 6e20 5379 6e63 5374 6174 7573 2e53 6b69  n SyncStatus.Ski
-00021940: 7070 6564 0a0a 2020 2020 2020 2020 6966  pped..        if
-00021950: 2063 6f6e 666c 6963 745f 6368 6563 6b20   conflict_check 
-00021960: 3d3d 2043 6f6e 666c 6963 742e 436f 6e66  == Conflict.Conf
-00021970: 6c69 6374 3a0a 2020 2020 2020 2020 2020  lict:.          
-00021980: 2020 6363 5f6c 6f63 616c 5f70 6174 6820    cc_local_path 
-00021990: 3d20 7365 6c66 2e5f 6c6f 6361 6c5f 6363  = self._local_cc
-000219a0: 5f66 696c 656e 616d 6528 6576 656e 742e  _filename(event.
-000219b0: 6c6f 6361 6c5f 7061 7468 2c20 6576 656e  local_path, even
-000219c0: 742e 6368 616e 6765 5f64 6269 6429 0a20  t.change_dbid). 
-000219d0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-000219e0: 5f63 6c73 203d 2044 6972 4d6f 7665 6445  _cls = DirMovedE
-000219f0: 7665 6e74 2069 6620 6973 6469 7228 6576  vent if isdir(ev
-00021a00: 656e 742e 6c6f 6361 6c5f 7061 7468 2920  ent.local_path) 
-00021a10: 656c 7365 2046 696c 654d 6f76 6564 4576  else FileMovedEv
-00021a20: 656e 740a 2020 2020 2020 2020 2020 2020  ent.            
-00021a30: 7769 7468 2073 656c 662e 6673 5f65 7665  with self.fs_eve
-00021a40: 6e74 732e 6967 6e6f 7265 2865 7665 6e74  nts.ignore(event
-00021a50: 5f63 6c73 2865 7665 6e74 2e6c 6f63 616c  _cls(event.local
-00021a60: 5f70 6174 682c 2063 635f 6c6f 6361 6c5f  _path, cc_local_
-00021a70: 7061 7468 2929 3a0a 2020 2020 2020 2020  path)):.        
-00021a80: 2020 2020 2020 2020 7769 7468 2063 6f6e          with con
-00021a90: 7665 7274 5f61 7069 5f65 7272 6f72 7328  vert_api_errors(
-00021aa0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00021ab0: 2020 2020 2020 206d 6f76 6528 6576 656e         move(even
-00021ac0: 742e 6c6f 6361 6c5f 7061 7468 2c20 6363  t.local_path, cc
-00021ad0: 5f6c 6f63 616c 5f70 6174 682c 2072 6169  _local_path, rai
-00021ae0: 7365 5f65 7272 6f72 3d54 7275 6529 0a0a  se_error=True)..
-00021af0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00021b00: 2e5f 6c6f 6767 6572 2e64 6562 7567 280a  ._logger.debug(.
-00021b10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b20: 2744 6f77 6e6c 6f61 6420 636f 6e66 6c69  'Download confli
-00021b30: 6374 3a20 7265 6e61 6d65 6420 2225 7322  ct: renamed "%s"
-00021b40: 2074 6f20 2225 7322 272c 0a20 2020 2020   to "%s"',.     
-00021b50: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-00021b60: 2e6c 6f63 616c 5f70 6174 682c 0a20 2020  .local_path,.   
-00021b70: 2020 2020 2020 2020 2020 2020 2063 635f               cc_
-00021b80: 6c6f 6361 6c5f 7061 7468 2c0a 2020 2020  local_path,.    
-00021b90: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
-00021ba0: 2020 2020 2020 7365 6c66 2e72 6573 6361        self.resca
-00021bb0: 6e28 6363 5f6c 6f63 616c 5f70 6174 6829  n(cc_local_path)
-00021bc0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
-00021bd0: 7475 7320 3d20 5379 6e63 5374 6174 7573  tus = SyncStatus
-00021be0: 2e43 6f6e 666c 6963 740a 2020 2020 2020  .Conflict.      
-00021bf0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00021c00: 2020 2020 7374 6174 7573 203d 2053 796e      status = Syn
-00021c10: 6353 7461 7475 732e 446f 6e65 0a0a 2020  cStatus.Done..  
-00021c20: 2020 2020 2020 2320 456e 7375 7265 2074        # Ensure t
-00021c30: 6861 7420 7061 7265 6e74 2066 6f6c 6465  hat parent folde
-00021c40: 7273 2061 7265 2073 796e 6365 642e 0a20  rs are synced.. 
-00021c50: 2020 2020 2020 2073 656c 662e 5f65 6e73         self._ens
-00021c60: 7572 655f 7061 7265 6e74 2865 7665 6e74  ure_parent(event
-00021c70: 290a 0a20 2020 2020 2020 2069 6620 6973  )..        if is
-00021c80: 6669 6c65 2865 7665 6e74 2e6c 6f63 616c  file(event.local
-00021c90: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
-00021ca0: 2020 2020 7769 7468 2073 656c 662e 6673      with self.fs
-00021cb0: 5f65 7665 6e74 732e 6967 6e6f 7265 280a  _events.ignore(.
-00021cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021cd0: 4669 6c65 4d6f 6469 6669 6564 4576 656e  FileModifiedEven
-00021ce0: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
-00021cf0: 7468 292c 2020 2320 4d61 7920 6265 2065  th),  # May be e
-00021d00: 6d69 7474 6564 206f 6e20 6d61 634f 532e  mitted on macOS.
-00021d10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021d20: 2046 696c 6544 656c 6574 6564 4576 656e   FileDeletedEven
-00021d30: 7428 6576 656e 742e 6c6f 6361 6c5f 7061  t(event.local_pa
-00021d40: 7468 292c 0a20 2020 2020 2020 2020 2020  th),.           
-00021d50: 2029 3a0a 2020 2020 2020 2020 2020 2020   ):.            
-00021d60: 2020 2020 6465 6c65 7465 280a 2020 2020      delete(.    
-00021d70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021d80: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
-00021d90: 2c20 666f 7263 655f 6361 7365 5f73 656e  , force_case_sen
-00021da0: 7369 7469 7665 3d6e 6f74 2073 656c 662e  sitive=not self.
-00021db0: 6973 5f66 735f 6361 7365 5f73 656e 7369  is_fs_case_sensi
-00021dc0: 7469 7665 0a20 2020 2020 2020 2020 2020  tive.           
-00021dd0: 2020 2020 2029 0a0a 2020 2020 2020 2020       )..        
-00021de0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00021df0: 2077 6974 6820 7365 6c66 2e66 735f 6576   with self.fs_ev
-00021e00: 656e 7473 2e69 676e 6f72 6528 0a20 2020  ents.ignore(.   
-00021e10: 2020 2020 2020 2020 2020 2020 2044 6972               Dir
-00021e20: 4372 6561 7465 6445 7665 6e74 2865 7665  CreatedEvent(eve
-00021e30: 6e74 2e6c 6f63 616c 5f70 6174 6829 2c20  nt.local_path), 
-00021e40: 7265 6375 7273 6976 653d 4661 6c73 650a  recursive=False.
-00021e50: 2020 2020 2020 2020 2020 2020 293a 0a20              ):. 
-00021e60: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00021e70: 732e 6d6b 6469 7228 6576 656e 742e 6c6f  s.mkdir(event.lo
-00021e80: 6361 6c5f 7061 7468 290a 2020 2020 2020  cal_path).      
-00021e90: 2020 6578 6365 7074 2046 696c 6545 7869    except FileExi
-00021ea0: 7374 7345 7272 6f72 3a0a 2020 2020 2020  stsError:.      
-00021eb0: 2020 2020 2020 7374 6174 7573 203d 2053        status = S
-00021ec0: 796e 6353 7461 7475 732e 536b 6970 7065  yncStatus.Skippe
-00021ed0: 640a 2020 2020 2020 2020 6578 6365 7074  d.        except
-00021ee0: 204f 5345 7272 6f72 2061 7320 6572 723a   OSError as err:
-00021ef0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00021f00: 662e 656e 7375 7265 5f64 726f 7062 6f78  f.ensure_dropbox
-00021f10: 5f66 6f6c 6465 725f 7072 6573 656e 7428  _folder_present(
-00021f20: 290a 2020 2020 2020 2020 2020 2020 7261  ).            ra
-00021f30: 6973 6520 6f73 5f74 6f5f 6d61 6573 7472  ise os_to_maestr
-00021f40: 616c 5f65 7272 6f72 2865 7272 2c20 6462  al_error(err, db
-00021f50: 785f 7061 7468 3d65 7665 6e74 2e64 6278  x_path=event.dbx
-00021f60: 5f70 6174 6829 0a0a 2020 2020 2020 2020  _path)..        
-00021f70: 7365 6c66 2e75 7064 6174 655f 696e 6465  self.update_inde
-00021f80: 785f 6672 6f6d 5f73 796e 635f 6576 656e  x_from_sync_even
-00021f90: 7428 6576 656e 7429 0a0a 2020 2020 2020  t(event)..      
-00021fa0: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
-00021fb0: 6562 7567 2827 4372 6561 7465 6420 6c6f  ebug('Created lo
-00021fc0: 6361 6c20 666f 6c64 6572 2022 2573 2227  cal folder "%s"'
-00021fd0: 2c20 6576 656e 742e 6462 785f 7061 7468  , event.dbx_path
-00021fe0: 290a 0a20 2020 2020 2020 2072 6574 7572  )..        retur
-00021ff0: 6e20 7374 6174 7573 0a0a 2020 2020 6465  n status..    de
-00022000: 6620 5f6f 6e5f 7265 6d6f 7465 5f64 656c  f _on_remote_del
-00022010: 6574 6564 2873 656c 662c 2065 7665 6e74  eted(self, event
-00022020: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
-00022030: 5379 6e63 5374 6174 7573 3a0a 2020 2020  SyncStatus:.    
-00022040: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00022050: 4170 706c 6965 7320 6120 7265 6d6f 7465  Applies a remote
-00022060: 2064 656c 6574 696f 6e20 6c6f 6361 6c6c   deletion locall
-00022070: 792e 0a0a 2020 2020 2020 2020 3a70 6172  y...        :par
-00022080: 616d 2065 7665 6e74 3a20 4472 6f70 626f  am event: Dropbo
-00022090: 7820 6465 6c65 7465 6420 6d65 7461 6461  x deleted metada
-000220a0: 7461 2e0a 2020 2020 2020 2020 3a72 6574  ta..        :ret
-000220b0: 7572 6e73 3a20 5379 6e63 4576 656e 7420  urns: SyncEvent 
-000220c0: 636f 7272 6573 706f 6e64 696e 6720 746f  corresponding to
-000220d0: 206c 6f63 616c 2064 656c 6574 696f 6e20   local deletion 
-000220e0: 6f72 204e 6f6e 6520 6966 206e 6f20 6c6f  or None if no lo
-000220f0: 6361 6c20 6368 616e 6765 730a 2020 2020  cal changes.    
-00022100: 2020 2020 2020 2020 6172 6520 6d61 6465          are made
-00022110: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
-00022120: 2020 2020 2020 7365 6c66 2e5f 6170 706c        self._appl
-00022130: 795f 6361 7365 5f63 6861 6e67 6528 6576  y_case_change(ev
-00022140: 656e 7429 0a0a 2020 2020 2020 2020 2320  ent)..        # 
-00022150: 4966 2079 6f75 7220 6c6f 6361 6c20 7374  If your local st
-00022160: 6174 6520 6861 7320 736f 6d65 7468 696e  ate has somethin
-00022170: 6720 6174 2074 6865 2067 6976 656e 2070  g at the given p
-00022180: 6174 682c 2072 656d 6f76 6520 6974 2061  ath, remove it a
-00022190: 6e64 2061 6c6c 2069 7473 0a20 2020 2020  nd all its.     
-000221a0: 2020 2023 2063 6869 6c64 7265 6e2e 2049     # children. I
-000221b0: 6620 7468 6572 65e2 8099 7320 6e6f 7468  f there...s noth
-000221c0: 696e 6720 6174 2074 6865 2067 6976 656e  ing at the given
-000221d0: 2070 6174 682c 2069 676e 6f72 6520 7468   path, ignore th
-000221e0: 6973 2065 6e74 7279 2e0a 0a20 2020 2020  is entry...     
-000221f0: 2020 2063 6f6e 666c 6963 745f 6368 6563     conflict_chec
-00022200: 6b20 3d20 7365 6c66 2e5f 6368 6563 6b5f  k = self._check_
-00022210: 646f 776e 6c6f 6164 5f63 6f6e 666c 6963  download_conflic
-00022220: 7428 6576 656e 7429 0a0a 2020 2020 2020  t(event)..      
-00022230: 2020 6966 2063 6f6e 666c 6963 745f 6368    if conflict_ch
-00022240: 6563 6b20 6973 2043 6f6e 666c 6963 742e  eck is Conflict.
-00022250: 4964 656e 7469 6361 6c3a 0a20 2020 2020  Identical:.     
-00022260: 2020 2020 2020 2073 656c 662e 7570 6461         self.upda
-00022270: 7465 5f69 6e64 6578 5f66 726f 6d5f 7379  te_index_from_sy
-00022280: 6e63 5f65 7665 6e74 2865 7665 6e74 290a  nc_event(event).
-00022290: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-000222a0: 726e 2053 796e 6353 7461 7475 732e 536b  rn SyncStatus.Sk
-000222b0: 6970 7065 640a 2020 2020 2020 2020 656c  ipped.        el
-000222c0: 6966 2063 6f6e 666c 6963 745f 6368 6563  if conflict_chec
-000222d0: 6b20 6973 2043 6f6e 666c 6963 742e 4c6f  k is Conflict.Lo
-000222e0: 6361 6c4e 6577 6572 4f72 4964 656e 7469  calNewerOrIdenti
-000222f0: 6361 6c3a 0a20 2020 2020 2020 2020 2020  cal:.           
-00022300: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
-00022310: 7573 2e53 6b69 7070 6564 0a0a 2020 2020  us.Skipped..    
-00022320: 2020 2020 6576 656e 745f 636c 7320 3d20      event_cls = 
-00022330: 4469 7244 656c 6574 6564 4576 656e 7420  DirDeletedEvent 
-00022340: 6966 2069 7364 6972 2865 7665 6e74 2e6c  if isdir(event.l
-00022350: 6f63 616c 5f70 6174 6829 2065 6c73 6520  ocal_path) else 
-00022360: 4669 6c65 4465 6c65 7465 6445 7665 6e74  FileDeletedEvent
-00022370: 0a20 2020 2020 2020 2077 6974 6820 7365  .        with se
-00022380: 6c66 2e66 735f 6576 656e 7473 2e69 676e  lf.fs_events.ign
-00022390: 6f72 6528 6576 656e 745f 636c 7328 6576  ore(event_cls(ev
-000223a0: 656e 742e 6c6f 6361 6c5f 7061 7468 2929  ent.local_path))
-000223b0: 3a0a 2020 2020 2020 2020 2020 2020 6578  :.            ex
-000223c0: 6320 3d20 6465 6c65 7465 280a 2020 2020  c = delete(.    
-000223d0: 2020 2020 2020 2020 2020 2020 6576 656e              even
-000223e0: 742e 6c6f 6361 6c5f 7061 7468 2c20 666f  t.local_path, fo
-000223f0: 7263 655f 6361 7365 5f73 656e 7369 7469  rce_case_sensiti
-00022400: 7665 3d6e 6f74 2073 656c 662e 6973 5f66  ve=not self.is_f
-00022410: 735f 6361 7365 5f73 656e 7369 7469 7665  s_case_sensitive
-00022420: 0a20 2020 2020 2020 2020 2020 2029 0a0a  .            )..
-00022430: 2020 2020 2020 2020 6966 206e 6f74 2065          if not e
-00022440: 7863 3a0a 2020 2020 2020 2020 2020 2020  xc:.            
-00022450: 7365 6c66 2e75 7064 6174 655f 696e 6465  self.update_inde
-00022460: 785f 6672 6f6d 5f73 796e 635f 6576 656e  x_from_sync_even
-00022470: 7428 6576 656e 7429 0a20 2020 2020 2020  t(event).       
-00022480: 2020 2020 2073 656c 662e 5f6c 6f67 6765       self._logge
-00022490: 722e 6465 6275 6728 2744 656c 6574 6564  r.debug('Deleted
-000224a0: 206c 6f63 616c 2069 7465 6d20 2225 7322   local item "%s"
-000224b0: 272c 2065 7665 6e74 2e6c 6f63 616c 5f70  ', event.local_p
-000224c0: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
-000224d0: 2072 6574 7572 6e20 5379 6e63 5374 6174   return SyncStat
-000224e0: 7573 2e44 6f6e 650a 2020 2020 2020 2020  us.Done.        
-000224f0: 656c 6966 2069 7369 6e73 7461 6e63 6528  elif isinstance(
-00022500: 6578 632c 2028 4669 6c65 4e6f 7446 6f75  exc, (FileNotFou
-00022510: 6e64 4572 726f 722c 204e 6f74 4144 6972  ndError, NotADir
-00022520: 6563 746f 7279 4572 726f 7229 293a 0a20  ectoryError)):. 
-00022530: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00022540: 7570 6461 7465 5f69 6e64 6578 5f66 726f  update_index_fro
-00022550: 6d5f 7379 6e63 5f65 7665 6e74 2865 7665  m_sync_event(eve
-00022560: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-00022570: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
-00022580: 7567 2827 4465 6c65 7469 6f6e 2066 6169  ug('Deletion fai
-00022590: 6c65 643a 2022 2573 2220 6e6f 7420 666f  led: "%s" not fo
-000225a0: 756e 6427 2c20 6576 656e 742e 6462 785f  und', event.dbx_
-000225b0: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
-000225c0: 2020 7265 7475 726e 2053 796e 6353 7461    return SyncSta
-000225d0: 7475 732e 536b 6970 7065 640a 2020 2020  tus.Skipped.    
-000225e0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000225f0: 2020 2020 2020 7261 6973 6520 6f73 5f74        raise os_t
-00022600: 6f5f 6d61 6573 7472 616c 5f65 7272 6f72  o_maestral_error
-00022610: 2865 7863 2c20 6462 785f 7061 7468 3d65  (exc, dbx_path=e
-00022620: 7665 6e74 2e64 6278 5f70 6174 6829 0a0a  vent.dbx_path)..
-00022630: 2020 2020 6465 6620 5f61 7070 6c79 5f63      def _apply_c
-00022640: 6173 655f 6368 616e 6765 2873 656c 662c  ase_change(self,
-00022650: 2065 7665 6e74 3a20 5379 6e63 4576 656e   event: SyncEven
-00022660: 7429 202d 3e20 4e6f 6e65 3a0a 2020 2020  t) -> None:.    
-00022670: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
-00022680: 4170 706c 6965 7320 616e 7920 6368 616e  Applies any chan
-00022690: 6765 7320 696e 2063 6173 696e 6720 6f66  ges in casing of
-000226a0: 2074 6865 2072 656d 6f74 6520 6974 656d   the remote item
-000226b0: 206c 6f63 616c 6c79 2e20 5468 6973 2073   locally. This s
-000226c0: 686f 756c 6420 6265 2063 616c 6c65 640a  hould be called.
-000226d0: 2020 2020 2020 2020 6265 666f 7265 2061          before a
-000226e0: 6e79 2073 7973 7465 6d20 6361 6c6c 7320  ny system calls 
-000226f0: 7573 696e 6720 6060 6c6f 6361 6c5f 7061  using ``local_pa
-00022700: 7468 6060 2062 6563 6175 7365 2074 6865  th`` because the
-00022710: 2061 6374 7561 6c20 7061 7468 206f 6e20   actual path on 
-00022720: 7468 6520 6669 6c65 0a20 2020 2020 2020  the file.       
-00022730: 2073 7973 7465 6d20 6d61 7920 6861 7665   system may have
-00022740: 2061 2064 6966 6665 7265 6e74 2063 6173   a different cas
-00022750: 696e 6720 6f6e 2063 6173 652d 7365 6e73  ing on case-sens
-00022760: 6974 6976 6520 6669 6c65 2073 7973 7465  itive file syste
-00022770: 6d73 2e20 4f6e 2063 6173 652d 0a20 2020  ms. On case-.   
-00022780: 2020 2020 2069 6e73 656e 7369 7469 7665       insensitive
-00022790: 2066 696c 6520 7379 7374 656d 732c 2074   file systems, t
-000227a0: 6869 7320 6361 7573 6573 206f 6e6c 7920  his causes only 
-000227b0: 6120 636f 736d 6574 6963 2063 6861 6e67  a cosmetic chang
-000227c0: 652e 0a0a 2020 2020 2020 2020 3a70 6172  e...        :par
-000227d0: 616d 2065 7665 6e74 3a20 446f 776e 6c6f  am event: Downlo
-000227e0: 6164 2053 796e 6345 7665 6e74 2e0a 2020  ad SyncEvent..  
-000227f0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
-00022800: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
-00022810: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
-00022820: 2020 2020 2020 2020 2020 2020 656e 7472              entr
-00022830: 7920 3d20 7365 6c66 2e67 6574 5f69 6e64  y = self.get_ind
-00022840: 6578 5f65 6e74 7279 2865 7665 6e74 2e64  ex_entry(event.d
-00022850: 6278 5f70 6174 685f 6c6f 7765 7229 0a0a  bx_path_lower)..
-00022860: 2020 2020 2020 2020 6966 2065 6e74 7279          if entry
-00022870: 2061 6e64 2065 6e74 7279 2e64 6278 5f70   and entry.dbx_p
-00022880: 6174 685f 6361 7365 6420 213d 2065 7665  ath_cased != eve
-00022890: 6e74 2e64 6278 5f70 6174 683a 0a20 2020  nt.dbx_path:.   
-000228a0: 2020 2020 2020 2020 206c 6f63 616c 5f70           local_p
-000228b0: 6174 685f 6f6c 6420 3d20 7365 6c66 2e74  ath_old = self.t
-000228c0: 6f5f 6c6f 6361 6c5f 7061 7468 5f66 726f  o_local_path_fro
-000228d0: 6d5f 6361 7365 6428 656e 7472 792e 6462  m_cased(entry.db
-000228e0: 785f 7061 7468 5f63 6173 6564 290a 0a20  x_path_cased).. 
-000228f0: 2020 2020 2020 2020 2020 2065 7665 6e74             event
-00022900: 5f63 6c73 203d 2044 6972 4d6f 7665 6445  _cls = DirMovedE
-00022910: 7665 6e74 2069 6620 6973 6469 7228 6c6f  vent if isdir(lo
-00022920: 6361 6c5f 7061 7468 5f6f 6c64 2920 656c  cal_path_old) el
-00022930: 7365 2046 696c 654d 6f76 6564 4576 656e  se FileMovedEven
-00022940: 740a 2020 2020 2020 2020 2020 2020 7769  t.            wi
-00022950: 7468 2073 656c 662e 6673 5f65 7665 6e74  th self.fs_event
-00022960: 732e 6967 6e6f 7265 2865 7665 6e74 5f63  s.ignore(event_c
-00022970: 6c73 286c 6f63 616c 5f70 6174 685f 6f6c  ls(local_path_ol
-00022980: 642c 2065 7665 6e74 2e6c 6f63 616c 5f70  d, event.local_p
-00022990: 6174 6829 293a 0a20 2020 2020 2020 2020  ath)):.         
-000229a0: 2020 2020 2020 206d 6f76 6528 6c6f 6361         move(loca
-000229b0: 6c5f 7061 7468 5f6f 6c64 2c20 6576 656e  l_path_old, even
-000229c0: 742e 6c6f 6361 6c5f 7061 7468 290a 0a20  t.local_path).. 
-000229d0: 2020 2020 2020 2020 2020 2077 6974 6820             with 
-000229e0: 7365 6c66 2e5f 6461 7461 6261 7365 5f61  self._database_a
-000229f0: 6363 6573 7328 293a 0a20 2020 2020 2020  ccess():.       
-00022a00: 2020 2020 2020 2020 2065 6e74 7279 2e64           entry.d
-00022a10: 6278 5f70 6174 685f 6361 7365 6420 3d20  bx_path_cased = 
-00022a20: 6576 656e 742e 6462 785f 7061 7468 0a20  event.dbx_path. 
-00022a30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00022a40: 656c 662e 5f69 6e64 6578 5f74 6162 6c65  elf._index_table
-00022a50: 2e75 7064 6174 6528 656e 7472 7929 0a0a  .update(entry)..
-00022a60: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00022a70: 2e5f 6c6f 6767 6572 2e64 6562 7567 2827  ._logger.debug('
-00022a80: 5265 6e61 6d65 6420 2225 7322 2074 6f20  Renamed "%s" to 
-00022a90: 2225 7322 272c 206c 6f63 616c 5f70 6174  "%s"', local_pat
-00022aa0: 685f 6f6c 642c 2065 7665 6e74 2e6c 6f63  h_old, event.loc
-00022ab0: 616c 5f70 6174 6829 0a0a 2020 2020 6465  al_path)..    de
-00022ac0: 6620 7265 7363 616e 2873 656c 662c 206c  f rescan(self, l
-00022ad0: 6f63 616c 5f70 6174 683a 2073 7472 2920  ocal_path: str) 
-00022ae0: 2d3e 204e 6f6e 653a 0a20 2020 2020 2020  -> None:.       
-00022af0: 2022 2222 0a20 2020 2020 2020 2046 6f72   """.        For
-00022b00: 6365 7320 6120 7265 7363 616e 206f 6620  ces a rescan of 
-00022b10: 6120 6c6f 6361 6c20 7061 7468 3a20 7363  a local path: sc
-00022b20: 6865 6475 6c65 7320 6372 6561 7465 6420  hedules created 
-00022b30: 6576 656e 7473 2066 6f72 2065 7665 7279  events for every
-00022b40: 2066 6f6c 6465 722c 0a20 2020 2020 2020   folder,.       
-00022b50: 206d 6f64 6966 6965 6420 6576 656e 7473   modified events
-00022b60: 2066 6f72 2065 7665 7279 2066 696c 6520   for every file 
-00022b70: 616e 6420 6465 6c65 7465 6420 6576 656e  and deleted even
-00022b80: 7473 2066 6f72 2065 7665 7279 2064 656c  ts for every del
-00022b90: 6574 6564 2069 7465 6d0a 2020 2020 2020  eted item.      
-00022ba0: 2020 2863 6f6d 7061 7265 6420 746f 206f    (compared to o
-00022bb0: 7572 2069 6e64 6578 292e 0a0a 2020 2020  ur index)...    
-00022bc0: 2020 2020 3a70 6172 616d 206c 6f63 616c      :param local
-00022bd0: 5f70 6174 683a 2050 6174 6820 746f 2072  _path: Path to r
-00022be0: 6573 6361 6e2e 0a20 2020 2020 2020 2022  escan..        "
-00022bf0: 2222 0a20 2020 2020 2020 2073 656c 662e  "".        self.
-00022c00: 5f6c 6f67 6765 722e 6465 6275 6728 2752  _logger.debug('R
-00022c10: 6573 6361 6e6e 696e 6720 2225 7322 272c  escanning "%s"',
-00022c20: 206c 6f63 616c 5f70 6174 6829 0a0a 2020   local_path)..  
-00022c30: 2020 2020 2020 6966 2069 7366 696c 6528        if isfile(
-00022c40: 6c6f 6361 6c5f 7061 7468 293a 0a20 2020  local_path):.   
-00022c50: 2020 2020 2020 2020 2073 656c 662e 6673           self.fs
-00022c60: 5f65 7665 6e74 732e 7175 6575 655f 6576  _events.queue_ev
-00022c70: 656e 7428 4669 6c65 4d6f 6469 6669 6564  ent(FileModified
-00022c80: 4576 656e 7428 6c6f 6361 6c5f 7061 7468  Event(local_path
-00022c90: 2929 0a0a 2020 2020 2020 2020 656c 6966  ))..        elif
-00022ca0: 2069 7364 6972 286c 6f63 616c 5f70 6174   isdir(local_pat
-00022cb0: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
-00022cc0: 7365 6c66 2e66 735f 6576 656e 7473 2e71  self.fs_events.q
-00022cd0: 7565 7565 5f65 7665 6e74 2844 6972 4372  ueue_event(DirCr
-00022ce0: 6561 7465 6445 7665 6e74 286c 6f63 616c  eatedEvent(local
-00022cf0: 5f70 6174 6829 290a 0a20 2020 2020 2020  _path))..       
-00022d00: 2020 2020 2023 2041 6464 2063 7265 6174       # Add creat
-00022d10: 6564 2061 6e64 206d 6f64 6966 6965 6420  ed and modified 
-00022d20: 6576 656e 7473 2066 6f72 2063 6869 6c64  events for child
-00022d30: 7265 6e20 6173 2061 7070 726f 7072 6961  ren as appropria
-00022d40: 7465 2e0a 0a20 2020 2020 2020 2020 2020  te...           
-00022d50: 2066 6f72 2070 6174 682c 2073 7461 7420   for path, stat 
-00022d60: 696e 2077 616c 6b28 6c6f 6361 6c5f 7061  in walk(local_pa
-00022d70: 7468 2c20 7365 6c66 2e5f 7363 616e 6469  th, self._scandi
-00022d80: 725f 7769 7468 5f69 676e 6f72 6529 3a0a  r_with_ignore):.
-00022d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022da0: 6966 2053 5f49 5344 4952 2873 7461 742e  if S_ISDIR(stat.
-00022db0: 7374 5f6d 6f64 6529 3a0a 2020 2020 2020  st_mode):.      
-00022dc0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00022dd0: 6c66 2e66 735f 6576 656e 7473 2e71 7565  lf.fs_events.que
-00022de0: 7565 5f65 7665 6e74 2844 6972 4372 6561  ue_event(DirCrea
-00022df0: 7465 6445 7665 6e74 2870 6174 6829 290a  tedEvent(path)).
-00022e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00022e10: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-00022e20: 2020 2020 2020 2020 2020 7365 6c66 2e66            self.f
-00022e30: 735f 6576 656e 7473 2e71 7565 7565 5f65  s_events.queue_e
-00022e40: 7665 6e74 2846 696c 654d 6f64 6966 6965  vent(FileModifie
-00022e50: 6445 7665 6e74 2870 6174 6829 290a 0a20  dEvent(path)).. 
-00022e60: 2020 2020 2020 2020 2020 2023 2041 6464             # Add
-00022e70: 2064 656c 6574 6564 2065 7665 6e74 7320   deleted events 
-00022e80: 666f 7220 6368 696c 6472 656e 2e0a 0a20  for children... 
-00022e90: 2020 2020 2020 2020 2020 2064 6278 5f70             dbx_p
-00022ea0: 6174 685f 6c6f 7765 7220 3d20 7365 6c66  ath_lower = self
-00022eb0: 2e74 6f5f 6462 785f 7061 7468 5f6c 6f77  .to_dbx_path_low
-00022ec0: 6572 286c 6f63 616c 5f70 6174 6829 0a0a  er(local_path)..
-00022ed0: 2020 2020 2020 2020 2020 2020 7769 7468              with
-00022ee0: 2073 656c 662e 5f64 6174 6162 6173 655f   self._database_
-00022ef0: 6163 6365 7373 2829 3a0a 2020 2020 2020  access():.      
-00022f00: 2020 2020 2020 2020 2020 7175 6572 7920            query 
-00022f10: 3d20 5061 7468 5472 6565 5175 6572 7928  = PathTreeQuery(
-00022f20: 496e 6465 7845 6e74 7279 2e64 6278 5f70  IndexEntry.dbx_p
-00022f30: 6174 685f 6c6f 7765 722c 2064 6278 5f70  ath_lower, dbx_p
-00022f40: 6174 685f 6c6f 7765 7229 0a20 2020 2020  ath_lower).     
-00022f50: 2020 2020 2020 2020 2020 2065 6e74 7269             entri
-00022f60: 6573 203d 2073 656c 662e 5f69 6e64 6578  es = self._index
-00022f70: 5f74 6162 6c65 2e73 656c 6563 7428 7175  _table.select(qu
-00022f80: 6572 7929 0a0a 2020 2020 2020 2020 2020  ery)..          
-00022f90: 2020 666f 7220 656e 7472 7920 696e 2065    for entry in e
-00022fa0: 6e74 7269 6573 3a0a 2020 2020 2020 2020  ntries:.        
-00022fb0: 2020 2020 2020 2020 6368 696c 645f 7061          child_pa
-00022fc0: 7468 203d 2073 656c 662e 746f 5f6c 6f63  th = self.to_loc
-00022fd0: 616c 5f70 6174 685f 6672 6f6d 5f63 6173  al_path_from_cas
-00022fe0: 6564 2865 6e74 7279 2e64 6278 5f70 6174  ed(entry.dbx_pat
-00022ff0: 685f 6361 7365 6429 0a20 2020 2020 2020  h_cased).       
-00023000: 2020 2020 2020 2020 2069 6620 6e6f 7420           if not 
-00023010: 6578 6973 7473 2863 6869 6c64 5f70 6174  exists(child_pat
-00023020: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
-00023030: 2020 2020 2020 2020 6966 2065 6e74 7279          if entry
-00023040: 2e69 735f 6469 7265 6374 6f72 793a 0a20  .is_directory:. 
-00023050: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00023060: 2020 2020 2020 2073 656c 662e 6673 5f65         self.fs_e
-00023070: 7665 6e74 732e 7175 6575 655f 6576 656e  vents.queue_even
-00023080: 7428 4469 7244 656c 6574 6564 4576 656e  t(DirDeletedEven
-00023090: 7428 6368 696c 645f 7061 7468 2929 0a20  t(child_path)). 
-000230a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000230b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000230c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000230d0: 2073 656c 662e 6673 5f65 7665 6e74 732e   self.fs_events.
-000230e0: 7175 6575 655f 6576 656e 7428 4669 6c65  queue_event(File
-000230f0: 4465 6c65 7465 6445 7665 6e74 2863 6869  DeletedEvent(chi
-00023100: 6c64 5f70 6174 6829 290a 0a20 2020 2020  ld_path))..     
-00023110: 2020 2065 6c69 6620 6e6f 7420 6578 6973     elif not exis
-00023120: 7473 286c 6f63 616c 5f70 6174 6829 3a0a  ts(local_path):.
-00023130: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
-00023140: 7061 7468 5f6c 6f77 6572 203d 2073 656c  path_lower = sel
-00023150: 662e 746f 5f64 6278 5f70 6174 685f 6c6f  f.to_dbx_path_lo
-00023160: 7765 7228 6c6f 6361 6c5f 7061 7468 290a  wer(local_path).
-00023170: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
-00023180: 6c5f 656e 7472 7920 3d20 7365 6c66 2e67  l_entry = self.g
-00023190: 6574 5f69 6e64 6578 5f65 6e74 7279 2864  et_index_entry(d
-000231a0: 6278 5f70 6174 685f 6c6f 7765 7229 0a0a  bx_path_lower)..
-000231b0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-000231c0: 6f63 616c 5f65 6e74 7279 3a0a 2020 2020  ocal_entry:.    
-000231d0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
-000231e0: 6f63 616c 5f65 6e74 7279 2e69 735f 6469  ocal_entry.is_di
-000231f0: 7265 6374 6f72 793a 0a20 2020 2020 2020  rectory:.       
-00023200: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00023210: 662e 6673 5f65 7665 6e74 732e 7175 6575  f.fs_events.queu
-00023220: 655f 6576 656e 7428 4469 7244 656c 6574  e_event(DirDelet
-00023230: 6564 4576 656e 7428 6c6f 6361 6c5f 7061  edEvent(local_pa
-00023240: 7468 2929 0a20 2020 2020 2020 2020 2020  th)).           
-00023250: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00023260: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-00023270: 656c 662e 6673 5f65 7665 6e74 732e 7175  elf.fs_events.qu
-00023280: 6575 655f 6576 656e 7428 4669 6c65 4465  eue_event(FileDe
-00023290: 6c65 7465 6445 7665 6e74 286c 6f63 616c  letedEvent(local
-000232a0: 5f70 6174 6829 290a 0a20 2020 2064 6566  _path))..    def
-000232b0: 205f 636c 6561 6e5f 6869 7374 6f72 7928   _clean_history(
-000232c0: 7365 6c66 2920 2d3e 204e 6f6e 653a 0a20  self) -> None:. 
-000232d0: 2020 2020 2020 2022 2222 436f 6d6d 6974         """Commit
-000232e0: 7320 6e65 7720 6576 656e 7473 2061 6e64  s new events and
-000232f0: 2072 656d 6f76 6573 2061 6c6c 2065 7665   removes all eve
-00023300: 6e74 7320 6f6c 6465 7220 7468 616e 2060  nts older than `
-00023310: 605f 6b65 6570 5f68 6973 746f 7279 6060  `_keep_history``
-00023320: 2066 726f 6d0a 2020 2020 2020 2020 6869   from.        hi
-00023330: 7374 6f72 792e 2222 220a 2020 2020 2020  story.""".      
-00023340: 2020 7769 7468 2073 656c 662e 5f64 6174    with self._dat
-00023350: 6162 6173 655f 6163 6365 7373 2829 3a0a  abase_access():.
-00023360: 2020 2020 2020 2020 2020 2020 2320 4472              # Dr
-00023370: 6f70 2061 6c6c 2065 6e74 7269 6573 206f  op all entries o
-00023380: 6c64 6572 2074 6861 6e20 6b65 6570 5f68  lder than keep_h
-00023390: 6973 746f 7279 2e0a 2020 2020 2020 2020  istory..        
-000233a0: 2020 2020 6e6f 7720 3d20 7469 6d65 2e74      now = time.t
-000233b0: 696d 6528 290a 2020 2020 2020 2020 2020  ime().          
-000233c0: 2020 6b65 6570 5f68 6973 746f 7279 203d    keep_history =
-000233d0: 2073 656c 662e 5f63 6f6e 662e 6765 7428   self._conf.get(
-000233e0: 2273 796e 6322 2c20 226b 6565 705f 6869  "sync", "keep_hi
-000233f0: 7374 6f72 7922 290a 0a20 2020 2020 2020  story")..       
-00023400: 2020 2020 2073 656c 662e 5f64 622e 6578       self._db.ex
-00023410: 6563 7574 6528 0a20 2020 2020 2020 2020  ecute(.         
-00023420: 2020 2020 2020 2022 4445 4c45 5445 2046         "DELETE F
-00023430: 524f 4d20 6869 7374 6f72 7920 5748 4552  ROM history WHER
-00023440: 4520 4946 4e55 4c4c 2863 6861 6e67 655f  E IFNULL(change_
-00023450: 7469 6d65 2c20 7379 6e63 5f74 696d 6529  time, sync_time)
-00023460: 203c 203f 222c 0a20 2020 2020 2020 2020   < ?",.         
-00023470: 2020 2020 2020 206e 6f77 202d 206b 6565         now - kee
-00023480: 705f 6869 7374 6f72 792c 0a20 2020 2020  p_history,.     
-00023490: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
-000234a0: 2020 2020 2073 656c 662e 5f68 6973 746f       self._histo
-000234b0: 7279 5f74 6162 6c65 2e63 6c65 6172 5f63  ry_table.clear_c
-000234c0: 6163 6865 2829 0a0a 2020 2020 6465 6620  ache()..    def 
-000234d0: 5f73 6361 6e64 6972 5f77 6974 685f 6967  _scandir_with_ig
-000234e0: 6e6f 7265 280a 2020 2020 2020 2020 7365  nore(.        se
-000234f0: 6c66 2c20 7061 7468 3a20 7374 7220 7c20  lf, path: str | 
-00023500: 6f73 2e50 6174 684c 696b 655b 7374 725d  os.PathLike[str]
-00023510: 0a20 2020 2029 202d 3e20 4974 6572 6174  .    ) -> Iterat
-00023520: 6f72 5b6f 732e 4469 7245 6e74 7279 5b73  or[os.DirEntry[s
-00023530: 7472 5d5d 3a0a 2020 2020 2020 2020 7769  tr]]:.        wi
-00023540: 7468 206f 732e 7363 616e 6469 7228 7061  th os.scandir(pa
-00023550: 7468 2920 6173 2069 743a 0a20 2020 2020  th) as it:.     
-00023560: 2020 2020 2020 2066 6f72 2065 6e74 7279         for entry
-00023570: 2069 6e20 6974 3a0a 2020 2020 2020 2020   in it:.        
-00023580: 2020 2020 2020 2020 6462 785f 7061 7468          dbx_path
-00023590: 203d 2073 656c 662e 746f 5f64 6278 5f70   = self.to_dbx_p
-000235a0: 6174 6828 656e 7472 792e 7061 7468 290a  ath(entry.path).
-000235b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000235c0: 6966 206e 6f74 2073 656c 662e 6973 5f65  if not self.is_e
-000235d0: 7863 6c75 6465 6428 656e 7472 792e 7061  xcluded(entry.pa
-000235e0: 7468 2920 616e 6420 6e6f 7420 7365 6c66  th) and not self
-000235f0: 2e5f 6973 5f6d 6967 6e6f 7265 5f70 6174  ._is_mignore_pat
-00023600: 6828 0a20 2020 2020 2020 2020 2020 2020  h(.             
-00023610: 2020 2020 2020 2064 6278 5f70 6174 682c         dbx_path,
-00023620: 2065 6e74 7279 2e69 735f 6469 7228 666f   entry.is_dir(fo
-00023630: 6c6c 6f77 5f73 796d 6c69 6e6b 733d 4661  llow_symlinks=Fa
-00023640: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
-00023650: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
-00023660: 2020 2020 2020 2020 2020 2020 7969 656c              yiel
-00023670: 6420 656e 7472 790a 0a0a 2320 3d3d 3d3d  d entry...# ====
-00023680: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023690: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000236a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000236b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000236c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-000236d0: 3d3d 0a23 2048 656c 7065 7220 6675 6e63  ==.# Helper func
-000236e0: 7469 6f6e 730a 2320 3d3d 3d3d 3d3d 3d3d  tions.# ========
-000236f0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023700: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023710: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023720: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
-00023730: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 0a0a  ==============..
-00023740: 0a64 6566 2064 6f5f 7061 7261 6c6c 656c  .def do_parallel
-00023750: 280a 2020 2020 6675 6e63 3a20 4361 6c6c  (.    func: Call
-00023760: 6162 6c65 5b50 2c20 545d 2c0a 2020 2020  able[P, T],.    
-00023770: 2a69 7465 7261 626c 653a 2043 6f6c 6c65  *iterable: Colle
-00023780: 6374 696f 6e5b 502e 6172 6773 5d2c 0a20  ction[P.args],. 
-00023790: 2020 2074 6872 6561 645f 6e61 6d65 5f70     thread_name_p
-000237a0: 7265 6669 783a 2073 7472 203d 2022 222c  refix: str = "",
-000237b0: 0a20 2020 206f 6e5f 7072 6f67 7265 7373  .    on_progress
-000237c0: 3a20 4361 6c6c 6162 6c65 5b5b 696e 742c  : Callable[[int,
-000237d0: 2069 6e74 5d2c 2041 6e79 5d20 7c20 4e6f   int], Any] | No
-000237e0: 6e65 203d 204e 6f6e 652c 0a29 202d 3e20  ne = None,.) -> 
-000237f0: 4974 6572 6162 6c65 5b54 5d3a 0a20 2020  Iterable[T]:.   
-00023800: 2022 2222 0a20 2020 2053 696d 696c 6172   """.    Similar
-00023810: 2074 6f20 6060 5468 7265 6164 506f 6f6c   to ``ThreadPool
-00023820: 4578 6563 7574 6f72 2e6d 6170 2829 6060  Executor.map()``
-00023830: 2062 7574 2079 6965 6c64 7320 7265 7375   but yields resu
-00023840: 6c74 7320 6173 2074 6865 7920 6265 636f  lts as they beco
-00023850: 6d65 2061 7661 696c 6162 6c65 2e0a 0a20  me available... 
-00023860: 2020 203a 7061 7261 6d20 6675 6e63 3a20     :param func: 
-00023870: 4170 706c 7920 7468 6973 2063 616c 6c61  Apply this calla
-00023880: 626c 6520 746f 2065 7665 7279 2069 7465  ble to every ite
-00023890: 6d20 6f66 2060 6069 7465 7261 626c 6560  m of ``iterable`
-000238a0: 602e 0a20 2020 203a 7061 7261 6d20 6974  `..    :param it
-000238b0: 6572 6162 6c65 3a20 4974 6572 6162 6c65  erable: Iterable
-000238c0: 2077 6974 6820 6172 6775 6d65 6e74 7320   with arguments 
-000238d0: 746f 2070 6173 7320 746f 2060 6066 756e  to pass to ``fun
-000238e0: 6360 602e 0a20 2020 203a 7061 7261 6d20  c``..    :param 
-000238f0: 7468 7265 6164 5f6e 616d 655f 7072 6566  thread_name_pref
-00023900: 6978 3a20 5573 6564 2066 6f72 2069 6e74  ix: Used for int
-00023910: 6572 6e61 6c20 5468 7265 6164 506f 6f6c  ernal ThreadPool
-00023920: 4578 6563 7574 6f72 2e0a 2020 2020 3a70  Executor..    :p
-00023930: 6172 616d 206f 6e5f 7072 6f67 7265 7373  aram on_progress
-00023940: 3a20 4361 6c6c 6261 636b 2077 6865 6e20  : Callback when 
-00023950: 6561 6368 2074 6173 6b20 6973 2063 6f6d  each task is com
-00023960: 706c 6574 6564 2e20 5461 6b65 7320 7468  pleted. Takes th
-00023970: 6520 6e75 6d62 6572 206f 660a 2020 2020  e number of.    
-00023980: 2020 2020 636f 6d70 6c65 7465 6420 6974      completed it
-00023990: 656d 7320 616e 6420 7468 6520 746f 7461  ems and the tota
-000239a0: 6c20 6e75 6d62 6572 206f 6620 6974 656d  l number of item
-000239b0: 7320 6173 2061 7267 756d 656e 7473 2e0a  s as arguments..
-000239c0: 2020 2020 2222 220a 2020 2020 7769 7468      """.    with
-000239d0: 2054 6872 6561 6450 6f6f 6c45 7865 6375   ThreadPoolExecu
-000239e0: 746f 7228 0a20 2020 2020 2020 206d 6178  tor(.        max
-000239f0: 5f77 6f72 6b65 7273 3d4e 554d 5f54 4852  _workers=NUM_THR
-00023a00: 4541 4453 2c20 7468 7265 6164 5f6e 616d  EADS, thread_nam
-00023a10: 655f 7072 6566 6978 3d74 6872 6561 645f  e_prefix=thread_
-00023a20: 6e61 6d65 5f70 7265 6669 780a 2020 2020  name_prefix.    
-00023a30: 2920 6173 2074 7065 3a0a 2020 2020 2020  ) as tpe:.      
-00023a40: 2020 6673 203d 205b 7470 652e 7375 626d    fs = [tpe.subm
-00023a50: 6974 2866 756e 632c 202a 6172 6773 2920  it(func, *args) 
-00023a60: 666f 7220 6172 6773 2069 6e20 7a69 7028  for args in zip(
-00023a70: 2a69 7465 7261 626c 6529 5d0a 0a20 2020  *iterable)]..   
-00023a80: 2020 2020 206e 5f64 6f6e 6520 3d20 300a       n_done = 0.
-00023a90: 2020 2020 2020 2020 666f 7220 6620 696e          for f in
-00023aa0: 2061 735f 636f 6d70 6c65 7465 6428 6673   as_completed(fs
-00023ab0: 293a 0a20 2020 2020 2020 2020 2020 206e  ):.            n
-00023ac0: 5f64 6f6e 6520 2b3d 2031 0a20 2020 2020  _done += 1.     
-00023ad0: 2020 2020 2020 2069 6620 6f6e 5f70 726f         if on_pro
-00023ae0: 6772 6573 733a 0a20 2020 2020 2020 2020  gress:.         
-00023af0: 2020 2020 2020 206f 6e5f 7072 6f67 7265         on_progre
-00023b00: 7373 286e 5f64 6f6e 652c 206c 656e 2869  ss(n_done, len(i
-00023b10: 7465 7261 626c 655b 305d 2929 0a20 2020  terable[0])).   
-00023b20: 2020 2020 2020 2020 2079 6965 6c64 2066           yield f
-00023b30: 2e72 6573 756c 7428 290a 0a0a 6465 6620  .result()...def 
-00023b40: 6973 5f6d 6f76 6564 2865 7665 6e74 3a20  is_moved(event: 
-00023b50: 4669 6c65 5379 7374 656d 4576 656e 7429  FileSystemEvent)
-00023b60: 202d 3e20 5479 7065 4775 6172 645b 4669   -> TypeGuard[Fi
-00023b70: 6c65 4d6f 7665 6445 7665 6e74 207c 2044  leMovedEvent | D
-00023b80: 6972 4d6f 7665 6445 7665 6e74 5d3a 0a20  irMovedEvent]:. 
-00023b90: 2020 2072 6574 7572 6e20 6576 656e 742e     return event.
-00023ba0: 6576 656e 745f 7479 7065 203d 3d20 4556  event_type == EV
-00023bb0: 454e 545f 5459 5045 5f4d 4f56 4544 0a0a  ENT_TYPE_MOVED..
-00023bc0: 0a64 6566 2069 735f 6465 6c65 7465 6428  .def is_deleted(
-00023bd0: 6576 656e 743a 2046 696c 6553 7973 7465  event: FileSyste
-00023be0: 6d45 7665 6e74 2920 2d3e 2054 7970 6547  mEvent) -> TypeG
-00023bf0: 7561 7264 5b46 696c 6544 656c 6574 6564  uard[FileDeleted
-00023c00: 4576 656e 7420 7c20 4469 7244 656c 6574  Event | DirDelet
-00023c10: 6564 4576 656e 745d 3a0a 2020 2020 7265  edEvent]:.    re
-00023c20: 7475 726e 2065 7665 6e74 2e65 7665 6e74  turn event.event
-00023c30: 5f74 7970 6520 3d3d 2045 5645 4e54 5f54  _type == EVENT_T
-00023c40: 5950 455f 4445 4c45 5445 440a 0a0a 6465  YPE_DELETED...de
-00023c50: 6620 6973 5f63 7265 6174 6564 2865 7665  f is_created(eve
-00023c60: 6e74 3a20 4669 6c65 5379 7374 656d 4576  nt: FileSystemEv
-00023c70: 656e 7429 202d 3e20 5479 7065 4775 6172  ent) -> TypeGuar
-00023c80: 645b 4669 6c65 4372 6561 7465 6445 7665  d[FileCreatedEve
-00023c90: 6e74 207c 2044 6972 4372 6561 7465 6445  nt | DirCreatedE
-00023ca0: 7665 6e74 5d3a 0a20 2020 2072 6574 7572  vent]:.    retur
-00023cb0: 6e20 6576 656e 742e 6576 656e 745f 7479  n event.event_ty
-00023cc0: 7065 203d 3d20 4556 454e 545f 5459 5045  pe == EVENT_TYPE
-00023cd0: 5f43 5245 4154 4544 0a0a 0a64 6566 2067  _CREATED...def g
-00023ce0: 6574 5f64 6573 745f 7061 7468 2865 7665  et_dest_path(eve
-00023cf0: 6e74 3a20 4669 6c65 5379 7374 656d 4576  nt: FileSystemEv
-00023d00: 656e 7429 202d 3e20 7374 723a 0a20 2020  ent) -> str:.   
-00023d10: 2022 2222 0a20 2020 2052 6574 7572 6e73   """.    Returns
-00023d20: 2074 6865 2064 6573 745f 7061 7468 206f   the dest_path o
-00023d30: 6620 6120 6669 6c65 2073 7973 7465 6d20  f a file system 
-00023d40: 6576 656e 7420 6966 2070 7265 7365 6e74  event if present
-00023d50: 2028 6d6f 7665 6420 6576 656e 7473 206f   (moved events o
-00023d60: 6e6c 7929 0a20 2020 206f 7468 6572 7769  nly).    otherwi
-00023d70: 7365 2072 6574 7572 6e73 2074 6865 2073  se returns the s
-00023d80: 7263 5f70 6174 6820 2877 6869 6368 2069  rc_path (which i
-00023d90: 7320 616c 736f 2074 6865 2022 6465 7374  s also the "dest
-00023da0: 696e 6174 696f 6e22 292e 0a0a 2020 2020  ination")...    
-00023db0: 3a70 6172 616d 2065 7665 6e74 3a20 5761  :param event: Wa
-00023dc0: 7463 6864 6f67 2066 696c 6520 7379 7374  tchdog file syst
-00023dd0: 656d 2065 7665 6e74 2e0a 2020 2020 3a72  em event..    :r
-00023de0: 6574 7572 6e73 3a20 4465 7374 696e 6174  eturns: Destinat
-00023df0: 696f 6e20 7061 7468 2066 6f72 206d 6f76  ion path for mov
-00023e00: 6564 2065 7665 6e74 2c20 736f 7572 6365  ed event, source
-00023e10: 2070 6174 6820 6f74 6865 7277 6973 652e   path otherwise.
-00023e20: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-00023e30: 6973 696e 7374 616e 6365 2865 7665 6e74  isinstance(event
-00023e40: 2c20 2846 696c 654d 6f76 6564 4576 656e  , (FileMovedEven
-00023e50: 742c 2044 6972 4d6f 7665 6445 7665 6e74  t, DirMovedEvent
-00023e60: 2929 3a0a 2020 2020 2020 2020 7265 7475  )):.        retu
-00023e70: 726e 2065 7665 6e74 2e64 6573 745f 7061  rn event.dest_pa
-00023e80: 7468 0a20 2020 2072 6574 7572 6e20 6576  th.    return ev
-00023e90: 656e 742e 7372 635f 7061 7468 0a0a 0a40  ent.src_path...@
-00023ea0: 6f76 6572 6c6f 6164 0a64 6566 2073 706c  overload.def spl
-00023eb0: 6974 5f6d 6f76 6564 5f65 7665 6e74 280a  it_moved_event(.
-00023ec0: 2020 2020 6576 656e 743a 2046 696c 654d      event: FileM
-00023ed0: 6f76 6564 4576 656e 742c 0a29 202d 3e20  ovedEvent,.) -> 
-00023ee0: 7475 706c 655b 4669 6c65 4465 6c65 7465  tuple[FileDelete
-00023ef0: 6445 7665 6e74 2c20 4669 6c65 4372 6561  dEvent, FileCrea
-00023f00: 7465 6445 7665 6e74 5d3a 0a20 2020 202e  tedEvent]:.    .
-00023f10: 2e2e 0a0a 0a40 6f76 6572 6c6f 6164 0a64  .....@overload.d
-00023f20: 6566 2073 706c 6974 5f6d 6f76 6564 5f65  ef split_moved_e
-00023f30: 7665 6e74 2865 7665 6e74 3a20 4469 724d  vent(event: DirM
-00023f40: 6f76 6564 4576 656e 7429 202d 3e20 7475  ovedEvent) -> tu
-00023f50: 706c 655b 4469 7244 656c 6574 6564 4576  ple[DirDeletedEv
-00023f60: 656e 742c 2044 6972 4372 6561 7465 6445  ent, DirCreatedE
-00023f70: 7665 6e74 5d3a 0a20 2020 202e 2e2e 0a0a  vent]:.    .....
-00023f80: 0a64 6566 2073 706c 6974 5f6d 6f76 6564  .def split_moved
-00023f90: 5f65 7665 6e74 280a 2020 2020 6576 656e  _event(.    even
-00023fa0: 743a 2046 696c 654d 6f76 6564 4576 656e  t: FileMovedEven
-00023fb0: 7420 7c20 4469 724d 6f76 6564 4576 656e  t | DirMovedEven
-00023fc0: 742c 0a29 202d 3e20 7475 706c 655b 4669  t,.) -> tuple[Fi
-00023fd0: 6c65 5379 7374 656d 4576 656e 742c 2046  leSystemEvent, F
-00023fe0: 696c 6553 7973 7465 6d45 7665 6e74 5d3a  ileSystemEvent]:
-00023ff0: 0a20 2020 2022 2222 0a20 2020 2053 706c  .    """.    Spl
-00024000: 6974 7320 6120 4669 6c65 4d6f 7665 6445  its a FileMovedE
-00024010: 7665 6e74 206f 7220 4469 724d 6f76 6564  vent or DirMoved
-00024020: 4576 656e 7420 696e 746f 2022 6465 6c65  Event into "dele
-00024030: 7465 6422 2061 6e64 2022 6372 6561 7465  ted" and "create
-00024040: 6422 2065 7665 6e74 7320 6f66 2074 6865  d" events of the
-00024050: 0a20 2020 2073 616d 6520 7479 7065 2e20  .    same type. 
-00024060: 4120 6e65 7720 6174 7472 6962 7574 6520  A new attribute 
-00024070: 6060 6d6f 7665 5f69 6460 6020 6973 2061  ``move_id`` is a
-00024080: 6464 6564 2074 6f20 626f 7468 2069 6e73  dded to both ins
-00024090: 7461 6e63 6573 2e0a 0a20 2020 203a 7061  tances...    :pa
-000240a0: 7261 6d20 6576 656e 743a 204f 7269 6769  ram event: Origi
-000240b0: 6e61 6c20 6576 656e 742e 0a20 2020 203a  nal event..    :
-000240c0: 7265 7475 726e 733a 2054 7570 6c65 206f  returns: Tuple o
-000240d0: 6620 6465 6c65 7465 6420 616e 6420 6372  f deleted and cr
-000240e0: 6561 7465 6420 6576 656e 7473 2e0a 2020  eated events..  
-000240f0: 2020 2222 220a 2020 2020 6372 6561 7465    """.    create
-00024100: 645f 6576 656e 745f 636c 733a 2054 7970  d_event_cls: Typ
-00024110: 655b 4669 6c65 5379 7374 656d 4576 656e  e[FileSystemEven
-00024120: 745d 0a20 2020 2064 656c 6574 6564 5f65  t].    deleted_e
-00024130: 7665 6e74 5f63 6c73 3a20 5479 7065 5b46  vent_cls: Type[F
-00024140: 696c 6553 7973 7465 6d45 7665 6e74 5d0a  ileSystemEvent].
-00024150: 2020 2020 6966 2065 7665 6e74 2e69 735f      if event.is_
-00024160: 6469 7265 6374 6f72 793a 0a20 2020 2020  directory:.     
-00024170: 2020 2063 7265 6174 6564 5f65 7665 6e74     created_event
-00024180: 5f63 6c73 203d 2044 6972 4372 6561 7465  _cls = DirCreate
-00024190: 6445 7665 6e74 0a20 2020 2020 2020 2064  dEvent.        d
-000241a0: 656c 6574 6564 5f65 7665 6e74 5f63 6c73  eleted_event_cls
-000241b0: 203d 2044 6972 4465 6c65 7465 6445 7665   = DirDeletedEve
-000241c0: 6e74 0a20 2020 2065 6c73 653a 0a20 2020  nt.    else:.   
-000241d0: 2020 2020 2063 7265 6174 6564 5f65 7665       created_eve
-000241e0: 6e74 5f63 6c73 203d 2046 696c 6543 7265  nt_cls = FileCre
-000241f0: 6174 6564 4576 656e 740a 2020 2020 2020  atedEvent.      
-00024200: 2020 6465 6c65 7465 645f 6576 656e 745f    deleted_event_
-00024210: 636c 7320 3d20 4669 6c65 4465 6c65 7465  cls = FileDelete
-00024220: 6445 7665 6e74 0a0a 2020 2020 6465 6c65  dEvent..    dele
-00024230: 7465 645f 6576 656e 7420 3d20 6465 6c65  ted_event = dele
-00024240: 7465 645f 6576 656e 745f 636c 7328 6576  ted_event_cls(ev
-00024250: 656e 742e 7372 635f 7061 7468 290a 2020  ent.src_path).  
-00024260: 2020 6372 6561 7465 645f 6576 656e 7420    created_event 
-00024270: 3d20 6372 6561 7465 645f 6576 656e 745f  = created_event_
-00024280: 636c 7328 6576 656e 742e 6465 7374 5f70  cls(event.dest_p
-00024290: 6174 6829 0a0a 2020 2020 7265 7475 726e  ath)..    return
-000242a0: 2064 656c 6574 6564 5f65 7665 6e74 2c20   deleted_event, 
-000242b0: 6372 6561 7465 645f 6576 656e 740a 0a0a  created_event...
-000242c0: 636c 6173 7320 7066 5f72 6570 723a 0a20  class pf_repr:. 
-000242d0: 2020 2022 2222 0a20 2020 2043 6c61 7373     """.    Class
-000242e0: 2074 6861 7420 7772 6170 7320 616e 206f   that wraps an o
-000242f0: 626a 6563 7420 616e 6420 6372 6561 7465  bject and create
-00024300: 7320 6120 7072 6574 7479 2066 6f72 6d61  s a pretty forma
-00024310: 7474 6564 2072 6570 7265 7365 6e74 6174  tted representat
-00024320: 696f 6e20 666f 7220 6974 2e0a 2020 2020  ion for it..    
-00024330: 5468 6973 2063 616e 2062 6520 7573 6564  This can be used
-00024340: 2074 6f20 6765 7420 7072 6574 7479 2066   to get pretty f
-00024350: 6f72 6d61 7474 696e 6720 696e 206c 6f67  ormatting in log
-00024360: 206d 6573 7361 6765 7320 7768 696c 6520   messages while 
-00024370: 6465 6665 7272 696e 6720 7468 6520 6163  deferring the ac
-00024380: 7475 616c 0a20 2020 2066 6f72 6d61 7474  tual.    formatt
-00024390: 696e 6720 756e 7469 6c20 7468 6520 6d65  ing until the me
-000243a0: 7373 6167 6520 6973 2063 7265 6174 6564  ssage is created
-000243b0: 2e0a 0a20 2020 203a 7061 7261 6d20 6f62  ...    :param ob
-000243c0: 6a3a 204f 626a 6563 7420 746f 2077 7261  j: Object to wra
-000243d0: 702e 0a20 2020 2022 2222 0a0a 2020 2020  p..    """..    
-000243e0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
-000243f0: 662c 206f 626a 3a20 416e 7929 202d 3e20  f, obj: Any) -> 
-00024400: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
-00024410: 6c66 2e6f 626a 203d 206f 626a 0a0a 2020  lf.obj = obj..  
-00024420: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
-00024430: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
-00024440: 2020 2020 2072 6574 7572 6e20 7066 6f72       return pfor
-00024450: 6d61 7428 7365 6c66 2e6f 626a 290a 0a0a  mat(self.obj)...
-00024460: 6465 6620 6368 6563 6b5f 656e 636f 6469  def check_encodi
-00024470: 6e67 286c 6f63 616c 5f70 6174 683a 2073  ng(local_path: s
-00024480: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
-00024490: 2022 2222 0a20 2020 2056 616c 6964 6174   """.    Validat
-000244a0: 6520 7468 6174 2074 6865 2070 6174 6820  e that the path 
-000244b0: 636f 6e74 6169 6e73 206f 6e6c 7920 6368  contains only ch
-000244c0: 6172 6163 7465 7273 2069 6e20 7468 6520  aracters in the 
-000244d0: 7265 706f 7274 6564 2066 696c 6520 7379  reported file sy
-000244e0: 7374 656d 0a20 2020 2065 6e63 6f64 696e  stem.    encodin
-000244f0: 672e 204f 6e20 556e 6978 2c20 7061 7468  g. On Unix, path
-00024500: 7320 6172 6520 6675 6e64 616d 656e 7461  s are fundamenta
-00024510: 6c6c 7920 6279 7465 7320 616e 6420 736f  lly bytes and so
-00024520: 6d65 2070 6c61 7466 6f72 6d73 2064 6f20  me platforms do 
-00024530: 6e6f 7420 656e 666f 7263 650a 2020 2020  not enforce.    
-00024540: 6120 756e 6966 6f72 6d20 656e 636f 6469  a uniform encodi
-00024550: 6e67 206f 6620 6669 6c65 206e 616d 6573  ng of file names
-00024560: 2064 6573 7069 7465 2072 6570 6f72 7469   despite reporti
-00024570: 6e67 2061 2066 696c 6520 7379 7374 656d  ng a file system
-00024580: 2065 6e63 6f64 696e 672e 2053 7563 680a   encoding. Such.
-00024590: 2020 2020 7061 7468 7320 7769 6c6c 2062      paths will b
-000245a0: 6520 6861 6e64 6564 2074 6f20 7573 2069  e handed to us i
-000245b0: 6e20 5079 7468 6f6e 2077 6974 6820 2273  n Python with "s
-000245c0: 7572 726f 6761 7465 2065 7363 6170 6573  urrogate escapes
-000245d0: 2220 696e 2070 6c61 6365 206f 6620 7468  " in place of th
-000245e0: 650a 2020 2020 756e 6b6e 6f77 6e20 6368  e.    unknown ch
-000245f0: 6172 6163 7465 7273 2e0a 0a20 2020 2053  aracters...    S
-00024600: 696e 6365 2074 6865 2044 726f 7062 6f78  ince the Dropbox
-00024610: 2041 5049 2061 6e64 206f 7572 2064 6174   API and our dat
-00024620: 6162 6173 6520 626f 7468 2072 6571 7569  abase both requi
-00024630: 7265 2075 7466 2d38 2065 6e63 6f64 6564  re utf-8 encoded
-00024640: 2070 6174 6873 2c20 7765 2075 7365 2074   paths, we use t
-00024650: 6869 730a 2020 2020 6d65 7468 6f64 2074  his.    method t
-00024660: 6f20 6368 6563 6b20 616e 6420 6661 696c  o check and fail
-00024670: 2065 6172 6c79 206f 6e20 756e 6b6e 6f77   early on unknow
-00024680: 6e20 6368 6172 6163 7465 7273 2e0a 0a20  n characters... 
-00024690: 2020 203a 7061 7261 6d20 6c6f 6361 6c5f     :param local_
-000246a0: 7061 7468 3a20 5061 7468 2074 6f20 6368  path: Path to ch
-000246b0: 6563 6b2e 0a20 2020 203a 7261 6973 6573  eck..    :raises
-000246c0: 2050 6174 6845 7272 6f72 3a20 6966 2074   PathError: if t
-000246d0: 6865 2070 6174 6820 636f 6e74 6169 6e73  he path contains
-000246e0: 2063 6861 7261 6374 6572 7320 7769 7468   characters with
-000246f0: 2061 6e20 756e 6b6e 6f77 6e20 656e 636f   an unknown enco
-00024700: 6469 6e67 2e0a 2020 2020 2222 220a 2020  ding..    """.  
-00024710: 2020 7472 793a 0a20 2020 2020 2020 206c    try:.        l
-00024720: 6f63 616c 5f70 6174 682e 656e 636f 6465  ocal_path.encode
-00024730: 2829 0a20 2020 2065 7863 6570 7420 556e  ().    except Un
-00024740: 6963 6f64 6545 6e63 6f64 6545 7272 6f72  icodeEncodeError
-00024750: 3a0a 2020 2020 2020 2020 6673 5f65 6e63  :.        fs_enc
-00024760: 6f64 696e 6720 3d20 7379 732e 6765 7466  oding = sys.getf
-00024770: 696c 6573 7973 7465 6d65 6e63 6f64 696e  ilesystemencodin
-00024780: 6728 290a 2020 2020 2020 2020 6572 726f  g().        erro
-00024790: 7220 3d20 5061 7468 4572 726f 7228 0a20  r = PathError(. 
-000247a0: 2020 2020 2020 2020 2020 2022 436f 756c             "Coul
-000247b0: 6420 6e6f 7420 7570 6c6f 6164 2069 7465  d not upload ite
-000247c0: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
-000247d0: 6622 5468 6520 6669 6c65 206e 616d 6520  f"The file name 
-000247e0: 636f 6e74 6169 6e73 2063 6861 7261 6374  contains charact
-000247f0: 6572 7320 6f75 7473 6964 6520 7468 6520  ers outside the 
-00024800: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
-00024810: 7b66 735f 656e 636f 6469 6e67 7d20 656e  {fs_encoding} en
-00024820: 636f 6469 6e67 206f 6620 796f 7572 2066  coding of your f
-00024830: 696c 6520 7379 7374 656d 222c 0a20 2020  ile system",.   
-00024840: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
-00024850: 7272 6f72 2e6c 6f63 616c 5f70 6174 6820  rror.local_path 
-00024860: 3d20 6c6f 6361 6c5f 7061 7468 0a20 2020  = local_path.   
-00024870: 2020 2020 2072 6169 7365 2065 7272 6f72       raise error
-00024880: 0a0a 0a64 6566 2063 6865 636b 5f63 6861  ...def check_cha
-00024890: 6e67 655f 7479 7065 2865 7665 6e74 3a20  nge_type(event: 
-000248a0: 5379 6e63 4576 656e 742c 2061 6c6c 6f77  SyncEvent, allow
-000248b0: 6564 5f63 6861 6e67 655f 7479 7065 733a  ed_change_types:
-000248c0: 2073 6574 5b43 6861 6e67 6554 7970 655d   set[ChangeType]
-000248d0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
-000248e0: 2222 0a20 2020 2043 6865 636b 2069 6620  "".    Check if 
-000248f0: 7468 6520 7379 6e63 2065 7665 6e74 2068  the sync event h
-00024900: 6173 206f 6e65 206f 6620 7061 7373 6564  as one of passed
-00024910: 2061 6c6c 6f77 6564 5f63 6861 6e67 655f   allowed_change_
-00024920: 7479 7065 732e 0a0a 2020 2020 3a70 6172  types...    :par
-00024930: 616d 2065 7665 6e74 3a20 5379 6e63 4576  am event: SyncEv
-00024940: 656e 7420 746f 2063 6865 636b 2e0a 2020  ent to check..  
-00024950: 2020 3a70 6172 616d 2061 6c6c 6f77 6564    :param allowed
-00024960: 5f63 6861 6e67 655f 7479 7065 733a 2053  _change_types: S
-00024970: 6574 206f 6620 616c 6c6f 7765 6420 6368  et of allowed ch
-00024980: 616e 6765 2074 7970 6573 2e0a 2020 2020  ange types..    
-00024990: 3a72 6169 7365 7320 5661 6c75 6545 7272  :raises ValueErr
-000249a0: 6f72 3a20 4966 2074 6865 2063 6861 6e67  or: If the chang
-000249b0: 6520 7479 7065 2069 7320 6e6f 7420 696e  e type is not in
-000249c0: 2074 6865 2061 6c6c 6f77 206c 6973 742e   the allow list.
-000249d0: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
-000249e0: 6576 656e 742e 6368 616e 6765 5f74 7970  event.change_typ
-000249f0: 6520 6e6f 7420 696e 2061 6c6c 6f77 6564  e not in allowed
-00024a00: 5f63 6861 6e67 655f 7479 7065 733a 0a20  _change_types:. 
-00024a10: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
-00024a20: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
-00024a30: 2020 2020 2066 2252 6571 7569 7265 2063       f"Require c
-00024a40: 6861 6e67 655f 7479 7065 2069 6e20 7b61  hange_type in {a
-00024a50: 6c6c 6f77 6564 5f63 6861 6e67 655f 7479  llowed_change_ty
-00024a60: 7065 737d 2062 7574 2022 0a20 2020 2020  pes} but ".     
-00024a70: 2020 2020 2020 2066 2266 6f75 6e64 207b         f"found {
-00024a80: 6576 656e 742e 6368 616e 6765 5f74 7970  event.change_typ
-00024a90: 657d 220a 2020 2020 2020 2020 290a       e}".        ).
+0001bb60: 2020 2020 2020 2020 2020 2020 2320 5265              # Re
+0001bb70: 6d6f 7665 2064 656c 6574 6564 2069 7465  move deleted ite
+0001bb80: 6d20 616e 6420 6974 7320 6368 696c 6472  m and its childr
+0001bb90: 656e 2066 726f 6d20 7468 6520 6578 636c  en from the excl
+0001bba0: 7564 6564 206c 6973 742e 0a20 2020 2020  uded list..     
+0001bbb0: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+0001bbc0: 6577 5f65 7863 6c75 6465 6420 3d20 5b0a  ew_excluded = [.
+0001bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbe0: 2020 2020 2020 2020 7061 7468 0a20 2020          path.   
+0001bbf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc00: 2020 2020 2066 6f72 2070 6174 6820 696e       for path in
+0001bc10: 206e 6577 5f65 7863 6c75 6465 640a 2020   new_excluded.  
+0001bc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bc30: 2020 2020 2020 6966 206e 6f74 2069 735f        if not is_
+0001bc40: 6571 7561 6c5f 6f72 5f63 6869 6c64 2870  equal_or_child(p
+0001bc50: 6174 682c 2065 7665 6e74 2e64 6278 5f70  ath, event.dbx_p
+0001bc60: 6174 685f 6c6f 7765 7229 0a20 2020 2020  ath_lower).     
+0001bc70: 2020 2020 2020 2020 2020 2020 2020 205d                 ]
+0001bc80: 0a0a 2020 2020 2020 2020 2020 2020 656c  ..            el
+0001bc90: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001bca0: 2020 2020 6c65 7665 6c20 3d20 6576 656e      level = even
+0001bcb0: 742e 6462 785f 7061 7468 2e63 6f75 6e74  t.dbx_path.count
+0001bcc0: 2822 2f22 290a 0a20 2020 2020 2020 2020  ("/")..         
+0001bcd0: 2020 2020 2020 2069 6620 6576 656e 742e         if event.
+0001bce0: 6973 5f64 656c 6574 6564 3a0a 2020 2020  is_deleted:.    
+0001bcf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd00: 6465 6c65 7465 645b 6c65 7665 6c5d 2e61  deleted[level].a
+0001bd10: 7070 656e 6428 6576 656e 7429 0a20 2020  ppend(event).   
+0001bd20: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+0001bd30: 6620 6576 656e 742e 6973 5f66 696c 653a  f event.is_file:
+0001bd40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001bd50: 2020 2020 2066 696c 6573 2e61 7070 656e       files.appen
+0001bd60: 6428 6576 656e 7429 0a20 2020 2020 2020  d(event).       
+0001bd70: 2020 2020 2020 2020 2065 6c69 6620 6576           elif ev
+0001bd80: 656e 742e 6973 5f64 6972 6563 746f 7279  ent.is_directory
+0001bd90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001bda0: 2020 2020 2020 666f 6c64 6572 735b 6c65        folders[le
+0001bdb0: 7665 6c5d 2e61 7070 656e 6428 6576 656e  vel].append(even
+0001bdc0: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
+0001bdd0: 2020 2020 2320 486f 7573 656b 6565 7069      # Housekeepi
+0001bde0: 6e67 2e0a 2020 2020 2020 2020 2020 2020  ng..            
+0001bdf0: 2020 2020 7365 6c66 2e61 6374 6976 6974      self.activit
+0001be00: 792e 6164 6428 6576 656e 7429 0a0a 2020  y.add(event)..  
+0001be10: 2020 2020 2020 7365 6c66 2e65 7863 6c75        self.exclu
+0001be20: 6465 645f 6974 656d 7320 3d20 6e65 775f  ded_items = new_
+0001be30: 6578 636c 7564 6564 0a0a 2020 2020 2020  excluded..      
+0001be40: 2020 2320 4170 706c 7920 6465 6c65 7465    # Apply delete
+0001be50: 6420 6974 656d 732e 0a20 2020 2020 2020  d items..       
+0001be60: 2069 6620 6465 6c65 7465 643a 0a20 2020   if deleted:.   
+0001be70: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+0001be80: 6f67 6765 722e 696e 666f 2822 4170 706c  ogger.info("Appl
+0001be90: 7969 6e67 2064 656c 6574 696f 6e73 2e2e  ying deletions..
+0001bea0: 2e22 290a 0a20 2020 2020 2020 2066 6f72  .")..        for
+0001beb0: 206c 6576 656c 2069 6e20 736f 7274 6564   level in sorted
+0001bec0: 2864 656c 6574 6564 293a 0a20 2020 2020  (deleted):.     
+0001bed0: 2020 2020 2020 2072 6573 203d 2064 6f5f         res = do_
+0001bee0: 7061 7261 6c6c 656c 280a 2020 2020 2020  parallel(.      
+0001bef0: 2020 2020 2020 2020 2020 7365 6c66 2e5f            self._
+0001bf00: 6372 6561 7465 5f6c 6f63 616c 5f65 6e74  create_local_ent
+0001bf10: 7279 2c0a 2020 2020 2020 2020 2020 2020  ry,.            
+0001bf20: 2020 2020 6465 6c65 7465 645b 6c65 7665      deleted[leve
+0001bf30: 6c5d 2c0a 2020 2020 2020 2020 2020 2020  l],.            
+0001bf40: 2020 2020 6f6e 5f70 726f 6772 6573 733d      on_progress=
+0001bf50: 6c61 6d62 6461 2078 2c20 793a 2073 656c  lambda x, y: sel
+0001bf60: 662e 5f6c 6f67 6765 722e 696e 666f 2866  f._logger.info(f
+0001bf70: 2244 656c 6574 696e 6720 7b78 7d2f 7b79  "Deleting {x}/{y
+0001bf80: 7d22 292c 0a20 2020 2020 2020 2020 2020  }"),.           
+0001bf90: 2020 2020 2074 6872 6561 645f 6e61 6d65       thread_name
+0001bfa0: 5f70 7265 6669 783d 226d 6165 7374 7261  _prefix="maestra
+0001bfb0: 6c2d 646f 776e 6c6f 6164 2d70 6f6f 6c22  l-download-pool"
+0001bfc0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0001bfd0: 2020 2020 2020 2020 2020 2020 7265 7375              resu
+0001bfe0: 6c74 732e 6578 7465 6e64 2872 6573 290a  lts.extend(res).
+0001bff0: 0a20 2020 2020 2020 2023 2043 7265 6174  .        # Creat
+0001c000: 6520 6c6f 6361 6c20 666f 6c64 6572 732c  e local folders,
+0001c010: 2073 7461 7274 2077 6974 6820 746f 702d   start with top-
+0001c020: 6c65 7665 6c20 616e 6420 776f 726b 2079  level and work y
+0001c030: 6f75 7220 7761 7920 646f 776e 2e0a 2020  our way down..  
+0001c040: 2020 2020 2020 6966 2066 6f6c 6465 7273        if folders
+0001c050: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
+0001c060: 6c66 2e5f 6c6f 6767 6572 2e69 6e66 6f28  lf._logger.info(
+0001c070: 2243 7265 6174 696e 6720 666f 6c64 6572  "Creating folder
+0001c080: 732e 2e2e 2229 0a0a 2020 2020 2020 2020  s...")..        
+0001c090: 666f 7220 6c65 7665 6c20 696e 2073 6f72  for level in sor
+0001c0a0: 7465 6428 666f 6c64 6572 7329 3a0a 2020  ted(folders):.  
+0001c0b0: 2020 2020 2020 2020 2020 7265 7320 3d20            res = 
+0001c0c0: 646f 5f70 6172 616c 6c65 6c28 0a20 2020  do_parallel(.   
+0001c0d0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+0001c0e0: 662e 5f63 7265 6174 655f 6c6f 6361 6c5f  f._create_local_
+0001c0f0: 656e 7472 792c 0a20 2020 2020 2020 2020  entry,.         
+0001c100: 2020 2020 2020 2066 6f6c 6465 7273 5b6c         folders[l
+0001c110: 6576 656c 5d2c 0a20 2020 2020 2020 2020  evel],.         
+0001c120: 2020 2020 2020 206f 6e5f 7072 6f67 7265         on_progre
+0001c130: 7373 3d6c 616d 6264 6120 782c 2079 3a20  ss=lambda x, y: 
+0001c140: 7365 6c66 2e5f 6c6f 6767 6572 2e69 6e66  self._logger.inf
+0001c150: 6f28 6622 4372 6561 7469 6e67 2066 6f6c  o(f"Creating fol
+0001c160: 6465 7220 7b78 7d2f 7b79 7d22 292c 0a20  der {x}/{y}"),. 
+0001c170: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+0001c180: 6872 6561 645f 6e61 6d65 5f70 7265 6669  hread_name_prefi
+0001c190: 783d 226d 6165 7374 7261 6c2d 646f 776e  x="maestral-down
+0001c1a0: 6c6f 6164 2d70 6f6f 6c22 2c0a 2020 2020  load-pool",.    
+0001c1b0: 2020 2020 2020 2020 290a 2020 2020 2020          ).      
+0001c1c0: 2020 2020 2020 7265 7375 6c74 732e 6578        results.ex
+0001c1d0: 7465 6e64 2872 6573 290a 0a20 2020 2020  tend(res)..     
+0001c1e0: 2020 2023 2041 7070 6c79 2063 7265 6174     # Apply creat
+0001c1f0: 6564 2066 696c 6573 2e0a 2020 2020 2020  ed files..      
+0001c200: 2020 7265 7320 3d20 646f 5f70 6172 616c    res = do_paral
+0001c210: 6c65 6c28 0a20 2020 2020 2020 2020 2020  lel(.           
+0001c220: 2073 656c 662e 5f63 7265 6174 655f 6c6f   self._create_lo
+0001c230: 6361 6c5f 656e 7472 792c 0a20 2020 2020  cal_entry,.     
+0001c240: 2020 2020 2020 2066 696c 6573 2c0a 2020         files,.  
+0001c250: 2020 2020 2020 2020 2020 6f6e 5f70 726f            on_pro
+0001c260: 6772 6573 733d 6c61 6d62 6461 2078 2c20  gress=lambda x, 
+0001c270: 793a 2073 656c 662e 5f6c 6f67 6765 722e  y: self._logger.
+0001c280: 696e 666f 2866 2253 796e 6369 6e67 20e2  info(f"Syncing .
+0001c290: 8693 207b 787d 2f7b 797d 2229 2c0a 2020  .. {x}/{y}"),.  
+0001c2a0: 2020 2020 2020 2020 2020 7468 7265 6164            thread
+0001c2b0: 5f6e 616d 655f 7072 6566 6978 3d22 6d61  _name_prefix="ma
+0001c2c0: 6573 7472 616c 2d64 6f77 6e6c 6f61 642d  estral-download-
+0001c2d0: 706f 6f6c 222c 0a20 2020 2020 2020 2029  pool",.        )
+0001c2e0: 0a20 2020 2020 2020 2072 6573 756c 7473  .        results
+0001c2f0: 2e65 7874 656e 6428 7265 7329 0a0a 2020  .extend(res)..  
+0001c300: 2020 2020 2020 7365 6c66 2e5f 636c 6561        self._clea
+0001c310: 6e5f 6869 7374 6f72 7928 290a 0a20 2020  n_history()..   
+0001c320: 2020 2020 2072 6574 7572 6e20 7265 7375       return resu
+0001c330: 6c74 730a 0a20 2020 2064 6566 206e 6f74  lts..    def not
+0001c340: 6966 795f 7573 6572 2873 656c 662c 2073  ify_user(self, s
+0001c350: 796e 635f 6576 656e 7473 3a20 5365 7175  ync_events: Sequ
+0001c360: 656e 6365 5b53 796e 6345 7665 6e74 5d29  ence[SyncEvent])
+0001c370: 202d 3e20 4e6f 6e65 3a0a 2020 2020 2020   -> None:.      
+0001c380: 2020 2222 220a 2020 2020 2020 2020 5368    """.        Sh
+0001c390: 6f77 7320 6120 6465 736b 746f 7020 6e6f  ows a desktop no
+0001c3a0: 7469 6669 6361 7469 6f6e 2066 6f72 2074  tification for t
+0001c3b0: 6865 2067 6976 656e 2066 696c 6520 6368  he given file ch
+0001c3c0: 616e 6765 732e 0a0a 2020 2020 2020 2020  anges...        
+0001c3d0: 3a70 6172 616d 2073 796e 635f 6576 656e  :param sync_even
+0001c3e0: 7473 3a20 4c69 7374 206f 6620 5379 6e63  ts: List of Sync
+0001c3f0: 4576 656e 7473 2066 726f 6d20 646f 776e  Events from down
+0001c400: 6c6f 6164 2073 796e 632e 0a20 2020 2020  load sync..     
+0001c410: 2020 2022 2222 0a20 2020 2020 2020 2069     """.        i
+0001c420: 6620 6e6f 7420 7365 6c66 2e64 6573 6b74  f not self.deskt
+0001c430: 6f70 5f6e 6f74 6966 6965 723a 0a20 2020  op_notifier:.   
+0001c440: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0001c450: 0a20 2020 2020 2020 2063 6861 6e67 6573  .        changes
+0001c460: 3a20 6c69 7374 5b53 796e 6345 7665 6e74  : list[SyncEvent
+0001c470: 5d20 3d20 5b5d 0a20 2020 2020 2020 2065  ] = [].        e
+0001c480: 7665 6e74 735f 636f 6e66 6c69 6374 3a20  vents_conflict: 
+0001c490: 6c69 7374 5b53 796e 6345 7665 6e74 5d20  list[SyncEvent] 
+0001c4a0: 3d20 5b5d 0a0a 2020 2020 2020 2020 666f  = []..        fo
+0001c4b0: 7220 6576 656e 7420 696e 2073 796e 635f  r event in sync_
+0001c4c0: 6576 656e 7473 3a0a 2020 2020 2020 2020  events:.        
+0001c4d0: 2020 2020 6966 2065 7665 6e74 2e73 7461      if event.sta
+0001c4e0: 7475 7320 6973 206e 6f74 2053 796e 6353  tus is not SyncS
+0001c4f0: 7461 7475 732e 536b 6970 7065 643a 0a20  tatus.Skipped:. 
+0001c500: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001c510: 6861 6e67 6573 2e61 7070 656e 6428 6576  hanges.append(ev
+0001c520: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
+0001c530: 2069 6620 6576 656e 742e 7374 6174 7573   if event.status
+0001c540: 2069 7320 5379 6e63 5374 6174 7573 2e43   is SyncStatus.C
+0001c550: 6f6e 666c 6963 743a 0a20 2020 2020 2020  onflict:.       
+0001c560: 2020 2020 2020 2020 2065 7665 6e74 735f           events_
+0001c570: 636f 6e66 6c69 6374 2e61 7070 656e 6428  conflict.append(
+0001c580: 6576 656e 7429 0a0a 2020 2020 2020 2020  event)..        
+0001c590: 2320 4765 7420 6e75 6d62 6572 206f 6620  # Get number of 
+0001c5a0: 7265 6d6f 7465 2063 6861 6e67 6573 2e0a  remote changes..
+0001c5b0: 2020 2020 2020 2020 6e5f 6368 616e 6765          n_change
+0001c5c0: 6420 3d20 6c65 6e28 6368 616e 6765 7329  d = len(changes)
+0001c5d0: 0a0a 2020 2020 2020 2020 6966 206e 5f63  ..        if n_c
+0001c5e0: 6861 6e67 6564 203d 3d20 303a 0a20 2020  hanged == 0:.   
+0001c5f0: 2020 2020 2020 2020 2072 6574 7572 6e0a           return.
+0001c600: 0a20 2020 2020 2020 2023 2046 696e 6420  .        # Find 
+0001c610: 6f75 7420 7768 6f20 6368 616e 6765 6420  out who changed 
+0001c620: 7468 6520 6974 656d 2873 292e 0a20 2020  the item(s)..   
+0001c630: 2020 2020 2075 7365 725f 6e61 6d65 3a20       user_name: 
+0001c640: 7374 7220 7c20 4e6f 6e65 0a20 2020 2020  str | None.     
+0001c650: 2020 2064 6269 645f 7365 7420 3d20 7b65     dbid_set = {e
+0001c660: 2e63 6861 6e67 655f 6462 6964 2066 6f72  .change_dbid for
+0001c670: 2065 2069 6e20 6368 616e 6765 737d 0a20   e in changes}. 
+0001c680: 2020 2020 2020 2069 6620 6c65 6e28 6462         if len(db
+0001c690: 6964 5f73 6574 2920 3d3d 2031 3a0a 2020  id_set) == 1:.  
+0001c6a0: 2020 2020 2020 2020 2020 2320 416c 6c20            # All 
+0001c6b0: 6669 6c65 7320 6861 7665 2062 6565 6e20  files have been 
+0001c6c0: 6d6f 6469 6669 6564 2062 7920 7468 6520  modified by the 
+0001c6d0: 7361 6d65 2075 7365 720a 2020 2020 2020  same user.      
+0001c6e0: 2020 2020 2020 6462 6964 203d 2064 6269        dbid = dbi
+0001c6f0: 645f 7365 742e 706f 7028 290a 2020 2020  d_set.pop().    
+0001c700: 2020 2020 2020 2020 6966 2064 6269 6420          if dbid 
+0001c710: 3d3d 2073 656c 662e 636c 6965 6e74 2e61  == self.client.a
+0001c720: 6363 6f75 6e74 5f69 6e66 6f2e 6163 636f  ccount_info.acco
+0001c730: 756e 745f 6964 3a0a 2020 2020 2020 2020  unt_id:.        
+0001c740: 2020 2020 2020 2020 7573 6572 5f6e 616d          user_nam
+0001c750: 6520 3d20 2259 6f75 220a 2020 2020 2020  e = "You".      
+0001c760: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001c770: 2020 2020 2020 2020 2020 2020 7573 6572              user
+0001c780: 5f6e 616d 6520 3d20 7365 6c66 2e5f 6469  _name = self._di
+0001c790: 7370 6c61 795f 6e61 6d65 5f66 6f72 5f61  splay_name_for_a
+0001c7a0: 6363 6f75 6e74 2864 6269 6429 0a20 2020  ccount(dbid).   
+0001c7b0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001c7c0: 2020 2020 2020 2023 2044 6f6e 2774 2064         # Don't d
+0001c7d0: 6973 706c 6179 206d 756c 7469 706c 6520  isplay multiple 
+0001c7e0: 7573 6572 6e61 6d65 7320 696e 206e 6f74  usernames in not
+0001c7f0: 6966 6963 6174 696f 6e2e 0a20 2020 2020  ification..     
+0001c800: 2020 2020 2020 2075 7365 725f 6e61 6d65         user_name
+0001c810: 203d 204e 6f6e 650a 0a20 2020 2020 2020   = None..       
+0001c820: 2062 7574 746f 6e73 3a20 6469 6374 5b73   buttons: dict[s
+0001c830: 7472 2c20 4361 6c6c 6162 6c65 5b5b 5d2c  tr, Callable[[],
+0001c840: 204e 6f6e 655d 5d0a 0a20 2020 2020 2020   None]]..       
+0001c850: 2069 6620 6e5f 6368 616e 6765 6420 3d3d   if n_changed ==
+0001c860: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+0001c870: 2320 4469 7370 6c61 7920 7468 6520 7573  # Display the us
+0001c880: 6572 6e61 6d65 2c20 6669 6c65 206e 616d  ername, file nam
+0001c890: 652c 2061 6e64 2074 7970 6520 6f66 2063  e, and type of c
+0001c8a0: 6861 6e67 6520 696e 206e 6f74 6966 6963  hange in notific
+0001c8b0: 6174 696f 6e2e 0a20 2020 2020 2020 2020  ation..         
+0001c8c0: 2020 2065 7665 6e74 203d 2063 6861 6e67     event = chang
+0001c8d0: 6573 5b30 5d0a 2020 2020 2020 2020 2020  es[0].          
+0001c8e0: 2020 6669 6c65 5f6e 616d 6520 3d20 6f73    file_name = os
+0001c8f0: 702e 6261 7365 6e61 6d65 2865 7665 6e74  p.basename(event
+0001c900: 2e64 6278 5f70 6174 6829 0a20 2020 2020  .dbx_path).     
+0001c910: 2020 2020 2020 2063 6861 6e67 655f 7479         change_ty
+0001c920: 7065 203d 2065 7665 6e74 2e63 6861 6e67  pe = event.chang
+0001c930: 655f 7479 7065 2e76 616c 7565 0a0a 2020  e_type.value..  
+0001c940: 2020 2020 2020 2020 2020 6465 6620 6361            def ca
+0001c950: 6c6c 6261 636b 2829 202d 3e20 4e6f 6e65  llback() -> None
+0001c960: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001c970: 2020 636c 6963 6b2e 6c61 756e 6368 2865    click.launch(e
+0001c980: 7665 6e74 2e6c 6f63 616c 5f70 6174 682c  vent.local_path,
+0001c990: 206c 6f63 6174 653d 5472 7565 290a 0a20   locate=True).. 
+0001c9a0: 2020 2020 2020 2020 2020 2062 7574 746f             butto
+0001c9b0: 6e73 203d 207b 2253 686f 7722 3a20 6361  ns = {"Show": ca
+0001c9c0: 6c6c 6261 636b 7d0a 0a20 2020 2020 2020  llback}..       
+0001c9d0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001c9e0: 2020 2023 2044 6973 706c 6179 2074 6865     # Display the
+0001c9f0: 206e 756d 6265 7220 6f66 2066 696c 6573   number of files
+0001ca00: 2063 6861 6e67 6564 2061 6e64 2070 6f74   changed and pot
+0001ca10: 656e 7469 616c 6c79 2074 6865 2074 7970  entially the typ
+0001ca20: 6520 6f66 2063 6861 6e67 6520 696e 0a20  e of change in. 
+0001ca30: 2020 2020 2020 2020 2020 2023 206e 6f74             # not
+0001ca40: 6966 6963 6174 696f 6e2e 0a0a 2020 2020  ification...    
+0001ca50: 2020 2020 2020 2020 6966 2061 6c6c 2865          if all(e
+0001ca60: 2e63 6861 6e67 655f 7479 7065 203d 3d20  .change_type == 
+0001ca70: 7379 6e63 5f65 7665 6e74 735b 305d 2e63  sync_events[0].c
+0001ca80: 6861 6e67 655f 7479 7065 2066 6f72 2065  hange_type for e
+0001ca90: 2069 6e20 7379 6e63 5f65 7665 6e74 7329   in sync_events)
+0001caa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001cab0: 2020 6368 616e 6765 5f74 7970 6520 3d20    change_type = 
+0001cac0: 7379 6e63 5f65 7665 6e74 735b 305d 2e63  sync_events[0].c
+0001cad0: 6861 6e67 655f 7479 7065 2e76 616c 7565  hange_type.value
+0001cae0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
+0001caf0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0001cb00: 2020 2063 6861 6e67 655f 7479 7065 203d     change_type =
+0001cb10: 2022 6368 616e 6765 6422 0a0a 2020 2020   "changed"..    
+0001cb20: 2020 2020 2020 2020 6966 2061 6c6c 2865          if all(e
+0001cb30: 2e69 735f 6669 6c65 2066 6f72 2065 2069  .is_file for e i
+0001cb40: 6e20 7379 6e63 5f65 7665 6e74 7329 3a0a  n sync_events):.
+0001cb50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001cb60: 6669 6c65 5f6e 616d 6520 3d20 6622 7b6e  file_name = f"{n
+0001cb70: 5f63 6861 6e67 6564 7d20 6669 6c65 7322  _changed} files"
+0001cb80: 0a20 2020 2020 2020 2020 2020 2065 6c69  .            eli
+0001cb90: 6620 616c 6c28 652e 6973 5f64 6972 6563  f all(e.is_direc
+0001cba0: 746f 7279 2066 6f72 2065 2069 6e20 7379  tory for e in sy
+0001cbb0: 6e63 5f65 7665 6e74 7329 3a0a 2020 2020  nc_events):.    
+0001cbc0: 2020 2020 2020 2020 2020 2020 6669 6c65              file
+0001cbd0: 5f6e 616d 6520 3d20 6622 7b6e 5f63 6861  _name = f"{n_cha
+0001cbe0: 6e67 6564 7d20 666f 6c64 6572 7322 0a20  nged} folders". 
+0001cbf0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0001cc00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cc10: 2066 696c 655f 6e61 6d65 203d 2066 227b   file_name = f"{
+0001cc20: 6e5f 6368 616e 6765 647d 2069 7465 6d73  n_changed} items
+0001cc30: 220a 0a20 2020 2020 2020 2020 2020 2064  "..            d
+0001cc40: 6566 2063 616c 6c62 6163 6b28 2920 2d3e  ef callback() ->
+0001cc50: 204e 6f6e 653a 0a20 2020 2020 2020 2020   None:.         
+0001cc60: 2020 2020 2020 2070 6173 730a 0a20 2020         pass..   
+0001cc70: 2020 2020 2020 2020 2062 7574 746f 6e73           buttons
+0001cc80: 203d 207b 7d0a 0a20 2020 2020 2020 2069   = {}..        i
+0001cc90: 6620 6368 616e 6765 5f74 7970 6520 3d3d  f change_type ==
+0001cca0: 2043 6861 6e67 6554 7970 652e 5265 6d6f   ChangeType.Remo
+0001ccb0: 7665 642e 7661 6c75 653a 0a0a 2020 2020  ved.value:..    
+0001ccc0: 2020 2020 2020 2020 6465 6620 6361 6c6c          def call
+0001ccd0: 6261 636b 2829 202d 3e20 4e6f 6e65 3a0a  back() -> None:.
+0001cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ccf0: 2320 5368 6f77 2044 726f 7062 6f78 2077  # Show Dropbox w
+0001cd00: 6562 7369 7465 2077 6974 6820 6465 6c65  ebsite with dele
+0001cd10: 7465 6420 6669 6c65 732e 0a20 2020 2020  ted files..     
+0001cd20: 2020 2020 2020 2020 2020 2063 6c69 636b             click
+0001cd30: 2e6c 6175 6e63 6828 2268 7474 7073 3a2f  .launch("https:/
+0001cd40: 2f77 7777 2e64 726f 7062 6f78 2e63 6f6d  /www.dropbox.com
+0001cd50: 2f64 656c 6574 6564 5f66 696c 6573 2229  /deleted_files")
+0001cd60: 0a0a 2020 2020 2020 2020 2020 2020 6275  ..            bu
+0001cd70: 7474 6f6e 7320 3d20 7b22 5368 6f77 223a  ttons = {"Show":
+0001cd80: 2063 616c 6c62 6163 6b7d 0a0a 2020 2020   callback}..    
+0001cd90: 2020 2020 6966 2075 7365 725f 6e61 6d65      if user_name
+0001cda0: 3a0a 2020 2020 2020 2020 2020 2020 6d73  :.            ms
+0001cdb0: 6720 3d20 6622 7b75 7365 725f 6e61 6d65  g = f"{user_name
+0001cdc0: 7d20 7b63 6861 6e67 655f 7479 7065 7d20  } {change_type} 
+0001cdd0: 7b66 696c 655f 6e61 6d65 7d22 0a20 2020  {file_name}".   
+0001cde0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001cdf0: 2020 2020 2020 206d 7367 203d 2066 227b         msg = f"{
+0001ce00: 6669 6c65 5f6e 616d 657d 207b 6368 616e  file_name} {chan
+0001ce10: 6765 5f74 7970 657d 220a 0a20 2020 2020  ge_type}"..     
+0001ce20: 2020 2023 204e 6f74 6966 7920 696e 2062     # Notify in b
+0001ce30: 756c 6b20 666f 7220 616c 6c20 6261 7463  ulk for all batc
+0001ce40: 6865 6420 6368 616e 6765 732e 0a20 2020  hed changes..   
+0001ce50: 2020 2020 2073 656c 662e 6465 736b 746f       self.deskto
+0001ce60: 705f 6e6f 7469 6669 6572 2e6e 6f74 6966  p_notifier.notif
+0001ce70: 7928 0a20 2020 2020 2020 2020 2020 2022  y(.            "
+0001ce80: 4974 656d 7320 7379 6e63 6564 222c 206d  Items synced", m
+0001ce90: 7367 2c20 6163 7469 6f6e 733d 6275 7474  sg, actions=butt
+0001cea0: 6f6e 732c 206f 6e5f 636c 6963 6b3d 6361  ons, on_click=ca
+0001ceb0: 6c6c 6261 636b 0a20 2020 2020 2020 2029  llback.        )
+0001cec0: 0a0a 2020 2020 2020 2020 2320 4e6f 7469  ..        # Noti
+0001ced0: 6679 2073 6570 6172 6174 656c 7920 666f  fy separately fo
+0001cee0: 7220 6561 6368 2073 796e 6320 636f 6e66  r each sync conf
+0001cef0: 6c69 6374 2e0a 2020 2020 2020 2020 666f  lict..        fo
+0001cf00: 7220 6576 656e 7420 696e 2065 7665 6e74  r event in event
+0001cf10: 735f 636f 6e66 6c69 6374 3a0a 0a20 2020  s_conflict:..   
+0001cf20: 2020 2020 2020 2020 2064 6566 2063 616c           def cal
+0001cf30: 6c62 6163 6b28 2920 2d3e 204e 6f6e 653a  lback() -> None:
+0001cf40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001cf50: 2063 6c69 636b 2e6c 6175 6e63 6828 6576   click.launch(ev
+0001cf60: 656e 742e 6c6f 6361 6c5f 7061 7468 2c20  ent.local_path, 
+0001cf70: 6c6f 6361 7465 3d54 7275 6529 0a0a 2020  locate=True)..  
+0001cf80: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
+0001cf90: 6573 6b74 6f70 5f6e 6f74 6966 6965 722e  esktop_notifier.
+0001cfa0: 6e6f 7469 6679 280a 2020 2020 2020 2020  notify(.        
+0001cfb0: 2020 2020 2020 2020 2253 796e 6320 636f          "Sync co
+0001cfc0: 6e66 6c69 6374 222c 0a20 2020 2020 2020  nflict",.       
+0001cfd0: 2020 2020 2020 2020 2066 2243 6f6e 666c           f"Confl
+0001cfe0: 6963 7469 6e67 2063 6f70 7920 666f 7220  icting copy for 
+0001cff0: 7b66 696c 655f 6e61 6d65 7d22 2c0a 2020  {file_name}",.  
+0001d000: 2020 2020 2020 2020 2020 2020 2020 6163                ac
+0001d010: 7469 6f6e 733d 7b22 5368 6f77 223a 2063  tions={"Show": c
+0001d020: 616c 6c62 6163 6b7d 2c0a 2020 2020 2020  allback},.      
+0001d030: 2020 2020 2020 2020 2020 6f6e 5f63 6c69            on_cli
+0001d040: 636b 3d63 616c 6c62 6163 6b2c 0a20 2020  ck=callback,.   
+0001d050: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+0001d060: 6465 6620 5f64 6973 706c 6179 5f6e 616d  def _display_nam
+0001d070: 655f 666f 725f 6163 636f 756e 7428 7365  e_for_account(se
+0001d080: 6c66 2c20 6462 6964 3a20 7374 7220 7c20  lf, dbid: str | 
+0001d090: 4e6f 6e65 2920 2d3e 2073 7472 207c 204e  None) -> str | N
+0001d0a0: 6f6e 653a 0a20 2020 2020 2020 2022 2222  one:.        """
+0001d0b0: 0a20 2020 2020 2020 2052 6574 7572 6e73  .        Returns
+0001d0c0: 2074 6865 2064 6973 706c 6179 206e 616d   the display nam
+0001d0d0: 6520 636f 7272 6573 706f 6e64 696e 6720  e corresponding 
+0001d0e0: 746f 2061 2044 726f 7062 6f78 2049 442e  to a Dropbox ID.
+0001d0f0: 0a20 2020 2020 2020 2022 2222 0a20 2020  .        """.   
+0001d100: 2020 2020 2069 6620 6462 6964 2069 7320       if dbid is 
+0001d110: 4e6f 6e65 3a0a 2020 2020 2020 2020 2020  None:.          
+0001d120: 2020 7265 7475 726e 204e 6f6e 650a 2020    return None.  
+0001d130: 2020 2020 2020 6966 2064 6269 6420 3d3d        if dbid ==
+0001d140: 2073 656c 662e 636c 6965 6e74 2e61 6363   self.client.acc
+0001d150: 6f75 6e74 5f69 6e66 6f2e 6163 636f 756e  ount_info.accoun
+0001d160: 745f 6964 3a0a 2020 2020 2020 2020 2020  t_id:.          
+0001d170: 2020 2320 5265 7475 726e 2063 6163 6865    # Return cache
+0001d180: 6420 6469 7370 6c61 7920 6e61 6d65 0a20  d display name. 
+0001d190: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001d1a0: 6e20 7365 6c66 2e63 6c69 656e 742e 6163  n self.client.ac
+0001d1b0: 636f 756e 745f 696e 666f 2e64 6973 706c  count_info.displ
+0001d1c0: 6179 5f6e 616d 650a 0a20 2020 2020 2020  ay_name..       
+0001d1d0: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+0001d1e0: 2020 6163 636f 756e 745f 696e 666f 203d    account_info =
+0001d1f0: 2073 656c 662e 636c 6965 6e74 2e67 6574   self.client.get
+0001d200: 5f61 6363 6f75 6e74 5f69 6e66 6f28 6462  _account_info(db
+0001d210: 6964 290a 2020 2020 2020 2020 6578 6365  id).        exce
+0001d220: 7074 2049 6e76 616c 6964 4462 6964 4572  pt InvalidDbidEr
+0001d230: 726f 723a 0a20 2020 2020 2020 2020 2020  ror:.           
+0001d240: 2072 6574 7572 6e20 4e6f 6e65 0a20 2020   return None.   
+0001d250: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001d260: 2020 2020 2020 2072 6574 7572 6e20 6163         return ac
+0001d270: 636f 756e 745f 696e 666f 2e64 6973 706c  count_info.displ
+0001d280: 6179 5f6e 616d 650a 0a20 2020 2064 6566  ay_name..    def
+0001d290: 205f 6368 6563 6b5f 646f 776e 6c6f 6164   _check_download
+0001d2a0: 5f63 6f6e 666c 6963 7428 7365 6c66 2c20  _conflict(self, 
+0001d2b0: 6576 656e 743a 2053 796e 6345 7665 6e74  event: SyncEvent
+0001d2c0: 2920 2d3e 2043 6f6e 666c 6963 743a 0a20  ) -> Conflict:. 
+0001d2d0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001d2e0: 2020 2043 6865 636b 2069 6620 6120 6c6f     Check if a lo
+0001d2f0: 6361 6c20 6974 656d 2069 7320 636f 6e66  cal item is conf
+0001d300: 6c69 6374 696e 6720 7769 7468 2072 656d  licting with rem
+0001d310: 6f74 6520 6368 616e 6765 2e20 5468 6520  ote change. The 
+0001d320: 6571 7569 7661 6c65 6e74 2063 6865 636b  equivalent check
+0001d330: 0a20 2020 2020 2020 2077 6865 6e20 7570  .        when up
+0001d340: 6c6f 6164 696e 6720 616e 6420 6120 6368  loading and a ch
+0001d350: 616e 6765 2077 696c 6c20 6265 2063 6172  ange will be car
+0001d360: 7269 6564 206f 7574 2062 7920 4472 6f70  ried out by Drop
+0001d370: 626f 7820 6974 7365 6c66 2e0a 0a20 2020  box itself...   
+0001d380: 2020 2020 2043 6865 636b 7320 6172 6520       Checks are 
+0001d390: 6361 7272 6965 6420 6f75 7420 6167 6169  carried out agai
+0001d3a0: 6e73 7420 6f75 7220 696e 6465 782c 2072  nst our index, r
+0001d3b0: 6566 6c65 6374 696e 6720 7468 6520 6c61  eflecting the la
+0001d3c0: 7465 7374 2073 796e 6320 7374 6174 652e  test sync state.
+0001d3d0: 0a20 2020 2020 2020 2057 6520 636f 6d70  .        We comp
+0001d3e0: 6172 6520 7468 6520 666f 6c6c 6f77 696e  are the followin
+0001d3f0: 6720 7661 6c75 6573 3a0a 0a20 2020 2020  g values:..     
+0001d400: 2020 2031 2920 4c6f 6361 6c20 7673 2072     1) Local vs r
+0001d410: 656d 6f74 6520 7265 763a 2027 666f 6c64  emote rev: 'fold
+0001d420: 6572 2720 666f 7220 666f 6c64 6572 732c  er' for folders,
+0001d430: 2061 6374 7561 6c20 7265 7669 7369 6f6e   actual revision
+0001d440: 2066 6f72 2066 696c 6573 2061 6e64 204e   for files and N
+0001d450: 6f6e 650a 2020 2020 2020 2020 2020 2066  one.           f
+0001d460: 6f72 2064 656c 6574 6564 206f 7220 6e6f  or deleted or no
+0001d470: 7420 7072 6573 656e 7420 6974 656d 732e  t present items.
+0001d480: 0a20 2020 2020 2020 2032 2920 4c6f 6361  .        2) Loca
+0001d490: 6c20 7673 2072 656d 6f74 6520 636f 6e74  l vs remote cont
+0001d4a0: 656e 7420 6861 7368 3a20 2766 6f6c 6465  ent hash: 'folde
+0001d4b0: 7227 2066 6f72 2066 6f6c 6465 7273 2c20  r' for folders, 
+0001d4c0: 6163 7475 616c 2068 6173 6820 666f 7220  actual hash for 
+0001d4d0: 6669 6c65 7320 616e 640a 2020 2020 2020  files and.      
+0001d4e0: 2020 2020 204e 6f6e 6520 666f 7220 6465       None for de
+0001d4f0: 6c65 7469 6f6e 732e 0a20 2020 2020 2020  letions..       
+0001d500: 2033 2920 4c6f 6361 6c20 6374 696d 6520   3) Local ctime 
+0001d510: 7673 206c 6173 7420 7379 6e63 2074 696d  vs last sync tim
+0001d520: 653a 2054 6869 7320 6973 2063 616c 6375  e: This is calcu
+0001d530: 6c61 7465 6420 7265 6375 7273 6976 656c  lated recursivel
+0001d540: 7920 666f 7220 666f 6c64 6572 732e 0a0a  y for folders...
+0001d550: 2020 2020 2020 2020 3a70 6172 616d 2065          :param e
+0001d560: 7665 6e74 3a20 446f 776e 6c6f 6164 2053  vent: Download S
+0001d570: 796e 6345 7665 6e74 2e0a 2020 2020 2020  yncEvent..      
+0001d580: 2020 3a72 6574 7572 6e73 3a20 436f 6e66    :returns: Conf
+0001d590: 6c69 6374 2063 6865 636b 2072 6573 756c  lict check resul
+0001d5a0: 742e 0a20 2020 2020 2020 2022 2222 0a20  t..        """. 
+0001d5b0: 2020 2020 2020 206c 6f63 616c 5f72 6576         local_rev
+0001d5c0: 203d 2073 656c 662e 6765 745f 6c6f 6361   = self.get_loca
+0001d5d0: 6c5f 7265 7628 6576 656e 742e 6462 785f  l_rev(event.dbx_
+0001d5e0: 7061 7468 5f6c 6f77 6572 290a 0a20 2020  path_lower)..   
+0001d5f0: 2020 2020 2077 6974 6820 636f 6e76 6572       with conver
+0001d600: 745f 6170 695f 6572 726f 7273 2865 7665  t_api_errors(eve
+0001d610: 6e74 2e64 6278 5f70 6174 682c 2065 7665  nt.dbx_path, eve
+0001d620: 6e74 2e6c 6f63 616c 5f70 6174 6829 3a0a  nt.local_path):.
+0001d630: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+0001d640: 6c5f 7379 6d6c 696e 6b5f 7461 7267 6574  l_symlink_target
+0001d650: 203d 2067 6574 5f73 796d 6c69 6e6b 5f74   = get_symlink_t
+0001d660: 6172 6765 7428 6576 656e 742e 6c6f 6361  arget(event.loca
+0001d670: 6c5f 7061 7468 290a 0a20 2020 2020 2020  l_path)..       
+0001d680: 2069 6620 6576 656e 742e 7265 7620 3d3d   if event.rev ==
+0001d690: 206c 6f63 616c 5f72 6576 3a0a 2020 2020   local_rev:.    
+0001d6a0: 2020 2020 2020 2020 2320 4c6f 6361 6c20          # Local 
+0001d6b0: 6368 616e 6765 2068 6173 2074 6865 2073  change has the s
+0001d6c0: 616d 6520 7265 762e 2054 6865 206c 6f63  ame rev. The loc
+0001d6d0: 616c 2069 7465 6d20 286f 7220 6465 6c65  al item (or dele
+0001d6e0: 7469 6f6e 2920 6d75 7374 2062 6520 6e65  tion) must be ne
+0001d6f0: 7765 720a 2020 2020 2020 2020 2020 2020  wer.            
+0001d700: 2320 616e 6420 6e6f 7420 7965 7420 7379  # and not yet sy
+0001d710: 6e63 6564 206f 7220 6964 656e 7469 6361  nced or identica
+0001d720: 6c20 746f 2074 6865 2072 656d 6f74 6520  l to the remote 
+0001d730: 7374 6174 652e 2044 6f6e 2774 206f 7665  state. Don't ove
+0001d740: 7277 7269 7465 2e0a 2020 2020 2020 2020  rwrite..        
+0001d750: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+0001d760: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+0001d770: 2020 2020 2020 2020 2745 7175 616c 2072          'Equal r
+0001d780: 6576 7320 666f 7220 2225 7322 3a20 6c6f  evs for "%s": lo
+0001d790: 6361 6c20 6974 656d 2069 7320 7468 6520  cal item is the 
+0001d7a0: 7361 6d65 206f 7220 6e65 7765 7220 270a  same or newer '.
+0001d7b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7c0: 2274 6861 6e20 6f6e 2044 726f 7062 6f78  "than on Dropbox
+0001d7d0: 222c 0a20 2020 2020 2020 2020 2020 2020  ",.             
+0001d7e0: 2020 2065 7665 6e74 2e64 6278 5f70 6174     event.dbx_pat
+0001d7f0: 682c 0a20 2020 2020 2020 2020 2020 2029  h,.            )
+0001d800: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001d810: 7572 6e20 436f 6e66 6c69 6374 2e4c 6f63  urn Conflict.Loc
+0001d820: 616c 4e65 7765 724f 7249 6465 6e74 6963  alNewerOrIdentic
+0001d830: 616c 0a0a 2020 2020 2020 2020 656c 6966  al..        elif
+0001d840: 2028 0a20 2020 2020 2020 2020 2020 2065   (.            e
+0001d850: 7665 6e74 2e63 6f6e 7465 6e74 5f68 6173  vent.content_has
+0001d860: 6820 3d3d 2073 656c 662e 6765 745f 6c6f  h == self.get_lo
+0001d870: 6361 6c5f 6861 7368 2865 7665 6e74 2e6c  cal_hash(event.l
+0001d880: 6f63 616c 5f70 6174 6829 0a20 2020 2020  ocal_path).     
+0001d890: 2020 2020 2020 2061 6e64 2065 7665 6e74         and event
+0001d8a0: 2e73 796d 6c69 6e6b 5f74 6172 6765 7420  .symlink_target 
+0001d8b0: 3d3d 206c 6f63 616c 5f73 796d 6c69 6e6b  == local_symlink
+0001d8c0: 5f74 6172 6765 740a 2020 2020 2020 2020  _target.        
+0001d8d0: 293a 0a20 2020 2020 2020 2020 2020 2023  ):.            #
+0001d8e0: 2043 6f6e 7465 6e74 2068 6173 6865 7320   Content hashes 
+0001d8f0: 6172 6520 6571 7561 6c2c 2074 6865 7265  are equal, there
+0001d900: 666f 7265 2069 7465 6d73 2061 7265 2069  fore items are i
+0001d910: 6465 6e74 6963 616c 2e20 466f 6c64 6572  dentical. Folder
+0001d920: 7320 7769 6c6c 0a20 2020 2020 2020 2020  s will.         
+0001d930: 2020 2023 2068 6176 6520 6120 636f 6e74     # have a cont
+0001d940: 656e 7420 6861 7368 206f 6620 2766 6f6c  ent hash of 'fol
+0001d950: 6465 7227 2e0a 2020 2020 2020 2020 2020  der'..          
+0001d960: 2020 7365 6c66 2e5f 6c6f 6767 6572 2e64    self._logger.d
+0001d970: 6562 7567 280a 2020 2020 2020 2020 2020  ebug(.          
+0001d980: 2020 2020 2020 2745 7175 616c 2063 6f6e        'Equal con
+0001d990: 7465 6e74 2068 6173 6865 7320 666f 7220  tent hashes for 
+0001d9a0: 2225 7322 3a20 6e6f 2063 6f6e 666c 6963  "%s": no conflic
+0001d9b0: 7427 2c20 6576 656e 742e 6462 785f 7061  t', event.dbx_pa
+0001d9c0: 7468 0a20 2020 2020 2020 2020 2020 2029  th.            )
+0001d9d0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+0001d9e0: 7572 6e20 436f 6e66 6c69 6374 2e49 6465  urn Conflict.Ide
+0001d9f0: 6e74 6963 616c 0a20 2020 2020 2020 2065  ntical.        e
+0001da00: 6c69 6620 280a 2020 2020 2020 2020 2020  lif (.          
+0001da10: 2020 6c65 6e28 0a20 2020 2020 2020 2020    len(.         
+0001da20: 2020 2020 2020 2073 656c 662e 7379 6e63         self.sync
+0001da30: 5f65 7272 6f72 735f 666f 725f 7061 7468  _errors_for_path
+0001da40: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001da50: 2020 2020 2020 6576 656e 742e 6462 785f        event.dbx_
+0001da60: 7061 7468 5f6c 6f77 6572 2c20 6469 7265  path_lower, dire
+0001da70: 6374 696f 6e3d 5379 6e63 4469 7265 6374  ction=SyncDirect
+0001da80: 696f 6e2e 5570 0a20 2020 2020 2020 2020  ion.Up.         
+0001da90: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+0001daa0: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001dab0: 2020 203e 2030 0a20 2020 2020 2020 2029     > 0.        )
+0001dac0: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+0001dad0: 4c6f 6361 6c20 7665 7273 696f 6e20 636f  Local version co
+0001dae0: 756c 6420 6e6f 7420 6265 2075 706c 6f61  uld not be uploa
+0001daf0: 6465 6420 6475 6520 746f 2061 2073 796e  ded due to a syn
+0001db00: 6320 6572 726f 722e 2044 6f20 6e6f 740a  c error. Do not.
+0001db10: 2020 2020 2020 2020 2020 2020 2320 6f76              # ov
+0001db20: 6572 2d77 7269 7465 2075 6e73 796e 6365  er-write unsynce
+0001db30: 6420 6368 616e 6765 7320 6275 7420 6465  d changes but de
+0001db40: 636c 6172 6520 6120 636f 6e66 6c69 6374  clare a conflict
+0001db50: 2e0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+0001db60: 6c66 2e5f 6c6f 6767 6572 2e64 6562 7567  lf._logger.debug
+0001db70: 280a 2020 2020 2020 2020 2020 2020 2020  (.              
+0001db80: 2020 2755 6e72 6573 6f6c 7665 6420 7570    'Unresolved up
+0001db90: 6c6f 6164 2065 7272 6f72 2066 6f72 2022  load error for "
+0001dba0: 2573 223a 2063 6f6e 666c 6963 7427 2c20  %s": conflict', 
+0001dbb0: 6576 656e 742e 6462 785f 7061 7468 0a20  event.dbx_path. 
+0001dbc0: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+0001dbd0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001dbe0: 436f 6e66 6c69 6374 2e43 6f6e 666c 6963  Conflict.Conflic
+0001dbf0: 740a 2020 2020 2020 2020 656c 6966 206e  t.        elif n
+0001dc00: 6f74 2073 656c 662e 5f63 7469 6d65 5f6e  ot self._ctime_n
+0001dc10: 6577 6572 5f74 6861 6e5f 6c61 7374 5f73  ewer_than_last_s
+0001dc20: 796e 6328 6576 656e 742e 6c6f 6361 6c5f  ync(event.local_
+0001dc30: 7061 7468 293a 0a20 2020 2020 2020 2020  path):.         
+0001dc40: 2020 2023 204c 6173 7420 6368 616e 6765     # Last change
+0001dc50: 2074 696d 6520 6f66 206c 6f63 616c 2069   time of local i
+0001dc60: 7465 6d20 2872 6563 7572 7369 7665 2066  tem (recursive f
+0001dc70: 6f72 2066 6f6c 6465 7273 2920 6973 206f  or folders) is o
+0001dc80: 6c64 6572 2074 6861 6e0a 2020 2020 2020  lder than.      
+0001dc90: 2020 2020 2020 2320 7468 6520 6c61 7374        # the last
+0001dca0: 2074 696d 6520 7468 6520 6974 656d 2077   time the item w
+0001dcb0: 6173 2073 796e 6365 642e 2052 656d 6f74  as synced. Remot
+0001dcc0: 6520 6d75 7374 2062 6520 6e65 7765 722e  e must be newer.
+0001dcd0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+0001dce0: 662e 5f6c 6f67 6765 722e 6465 6275 6728  f._logger.debug(
+0001dcf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dd00: 2027 4c6f 6361 6c20 6974 656d 2022 2573   'Local item "%s
+0001dd10: 2220 6861 7320 6e6f 2075 6e73 796e 6365  " has no unsynce
+0001dd20: 6420 6368 616e 6765 733a 2072 656d 6f74  d changes: remot
+0001dd30: 6520 6974 656d 2069 7320 6e65 7765 7227  e item is newer'
+0001dd40: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001dd50: 2020 6576 656e 742e 6462 785f 7061 7468    event.dbx_path
+0001dd60: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0001dd70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001dd80: 726e 2043 6f6e 666c 6963 742e 5265 6d6f  rn Conflict.Remo
+0001dd90: 7465 4e65 7765 720a 2020 2020 2020 2020  teNewer.        
+0001dda0: 656c 6966 2065 7665 6e74 2e69 735f 6465  elif event.is_de
+0001ddb0: 6c65 7465 643a 0a20 2020 2020 2020 2020  leted:.         
+0001ddc0: 2020 2023 2052 656d 6f74 6520 6974 656d     # Remote item
+0001ddd0: 2077 6173 2064 656c 6574 6564 2062 7574   was deleted but
+0001dde0: 206c 6f63 616c 2069 7465 6d20 6861 7320   local item has 
+0001ddf0: 6265 656e 206d 6f64 6966 6965 6420 7369  been modified si
+0001de00: 6e63 6520 7468 656e 2e0a 2020 2020 2020  nce then..      
+0001de10: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+0001de20: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
+0001de30: 2020 2020 2020 2020 2020 274c 6f63 616c            'Local
+0001de40: 2069 7465 6d20 2225 7322 2068 6173 2075   item "%s" has u
+0001de50: 6e73 796e 6365 6420 6368 616e 6765 7320  nsynced changes 
+0001de60: 616e 6420 7265 6d6f 7465 2077 6173 2027  and remote was '
+0001de70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001de80: 2022 6465 6c65 7465 643a 206c 6f63 616c   "deleted: local
+0001de90: 2069 7465 6d20 6973 206e 6577 6572 222c   item is newer",
+0001dea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001deb0: 2065 7665 6e74 2e64 6278 5f70 6174 682c   event.dbx_path,
+0001dec0: 0a20 2020 2020 2020 2020 2020 2029 0a20  .            ). 
+0001ded0: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001dee0: 6e20 436f 6e66 6c69 6374 2e4c 6f63 616c  n Conflict.Local
+0001def0: 4e65 7765 724f 7249 6465 6e74 6963 616c  NewerOrIdentical
+0001df00: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+0001df10: 2020 2020 2020 2020 2020 2023 2042 6f74             # Bot
+0001df20: 6820 7265 6d6f 7465 2061 6e64 206c 6f63  h remote and loc
+0001df30: 616c 2069 7465 6d73 2068 6176 6520 756e  al items have un
+0001df40: 7379 6e63 6564 2063 6861 6e67 6573 3a20  synced changes: 
+0001df50: 636f 6e66 6c69 6374 2e0a 2020 2020 2020  conflict..      
+0001df60: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+0001df70: 6572 2e64 6562 7567 280a 2020 2020 2020  er.debug(.      
+0001df80: 2020 2020 2020 2020 2020 274c 6f63 616c            'Local
+0001df90: 2069 7465 6d20 2225 7322 2068 6173 2075   item "%s" has u
+0001dfa0: 6e73 796e 6365 6420 6c6f 6361 6c20 6368  nsynced local ch
+0001dfb0: 616e 6765 733a 2063 6f6e 666c 6963 7427  anges: conflict'
+0001dfc0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0001dfd0: 2020 6576 656e 742e 6462 785f 7061 7468    event.dbx_path
+0001dfe0: 2c0a 2020 2020 2020 2020 2020 2020 290a  ,.            ).
+0001dff0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001e000: 726e 2043 6f6e 666c 6963 742e 436f 6e66  rn Conflict.Conf
+0001e010: 6c69 6374 0a0a 2020 2020 6465 6620 5f63  lict..    def _c
+0001e020: 7469 6d65 5f6e 6577 6572 5f74 6861 6e5f  time_newer_than_
+0001e030: 6c61 7374 5f73 796e 6328 7365 6c66 2c20  last_sync(self, 
+0001e040: 6c6f 6361 6c5f 7061 7468 3a20 7374 7229  local_path: str)
+0001e050: 202d 3e20 626f 6f6c 3a0a 2020 2020 2020   -> bool:.      
+0001e060: 2020 2222 220a 2020 2020 2020 2020 4368    """.        Ch
+0001e070: 6563 6b73 2069 6620 6120 6c6f 6361 6c20  ecks if a local 
+0001e080: 6974 656d 2068 6173 2061 6e79 2075 6e73  item has any uns
+0001e090: 796e 6365 6420 6368 616e 6765 732e 2054  ynced changes. T
+0001e0a0: 6869 7320 6973 2062 7920 636f 6d70 6172  his is by compar
+0001e0b0: 696e 6720 6974 7320 6374 696d 650a 2020  ing its ctime.  
+0001e0c0: 2020 2020 2020 746f 2074 6865 2060 606c        to the ``l
+0001e0d0: 6173 745f 7379 6e63 6060 2074 696d 6520  ast_sync`` time 
+0001e0e0: 7361 7665 6420 696e 206f 7572 2069 6e64  saved in our ind
+0001e0f0: 6578 2e20 496e 2063 6173 6520 6f66 2066  ex. In case of f
+0001e100: 6f6c 6465 7273 2c20 7765 2072 6563 7572  olders, we recur
+0001e110: 7369 7665 6c79 0a20 2020 2020 2020 2063  sively.        c
+0001e120: 6865 636b 2074 6865 2063 7469 6d65 206f  heck the ctime o
+0001e130: 6620 6368 696c 6472 656e 2e0a 0a20 2020  f children...   
+0001e140: 2020 2020 203a 7061 7261 6d20 6c6f 6361       :param loca
+0001e150: 6c5f 7061 7468 3a20 4c6f 6361 6c20 7061  l_path: Local pa
+0001e160: 7468 206f 6620 6974 656d 2074 6f20 6368  th of item to ch
+0001e170: 6563 6b2e 0a20 2020 2020 2020 203a 7265  eck..        :re
+0001e180: 7475 726e 733a 2057 6865 7468 6572 2074  turns: Whether t
+0001e190: 6865 206c 6f63 616c 2069 7465 6d20 6861  he local item ha
+0001e1a0: 7320 756e 7379 6e63 6564 2063 6861 6e67  s unsynced chang
+0001e1b0: 6573 2e0a 2020 2020 2020 2020 2222 220a  es..        """.
+0001e1c0: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+0001e1d0: 6973 5f65 7863 6c75 6465 6428 6c6f 6361  is_excluded(loca
+0001e1e0: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
+0001e1f0: 2020 2020 2023 2045 7863 6c75 6465 6420       # Excluded 
+0001e200: 6e61 6d65 7320 7375 6368 2061 7320 2e44  names such as .D
+0001e210: 535f 5374 6f72 6520 6574 632e 206e 6576  S_Store etc. nev
+0001e220: 6572 2063 6f75 6e74 2061 7320 756e 7379  er count as unsy
+0001e230: 6e63 6564 2063 6861 6e67 6573 2e0a 2020  nced changes..  
+0001e240: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001e250: 2046 616c 7365 0a0a 2020 2020 2020 2020   False..        
+0001e260: 6462 785f 7061 7468 5f6c 6f77 6572 203d  dbx_path_lower =
+0001e270: 2073 656c 662e 746f 5f64 6278 5f70 6174   self.to_dbx_pat
+0001e280: 685f 6c6f 7765 7228 6c6f 6361 6c5f 7061  h_lower(local_pa
+0001e290: 7468 290a 2020 2020 2020 2020 696e 6465  th).        inde
+0001e2a0: 785f 656e 7472 7920 3d20 7365 6c66 2e67  x_entry = self.g
+0001e2b0: 6574 5f69 6e64 6578 5f65 6e74 7279 2864  et_index_entry(d
+0001e2c0: 6278 5f70 6174 685f 6c6f 7765 7229 0a0a  bx_path_lower)..
+0001e2d0: 2020 2020 2020 2020 7769 7468 2063 6f6e          with con
+0001e2e0: 7665 7274 5f61 7069 5f65 7272 6f72 7328  vert_api_errors(
+0001e2f0: 6c6f 6361 6c5f 7061 7468 3d6c 6f63 616c  local_path=local
+0001e300: 5f70 6174 6829 3a20 2023 2043 6174 6368  _path):  # Catch
+0001e310: 204f 5345 7272 6f72 732e 0a20 2020 2020   OSErrors..     
+0001e320: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
+0001e330: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+0001e340: 203d 206f 732e 6c73 7461 7428 6c6f 6361   = os.lstat(loca
+0001e350: 6c5f 7061 7468 290a 2020 2020 2020 2020  l_path).        
+0001e360: 2020 2020 6578 6365 7074 2028 4669 6c65      except (File
+0001e370: 4e6f 7446 6f75 6e64 4572 726f 722c 204e  NotFoundError, N
+0001e380: 6f74 4144 6972 6563 746f 7279 4572 726f  otADirectoryErro
+0001e390: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
+0001e3a0: 2020 2020 2320 446f 6e27 7420 6368 6563      # Don't chec
+0001e3b0: 6b20 6374 696d 6520 666f 7220 6465 6c65  k ctime for dele
+0001e3c0: 7465 6420 6974 656d 7320 286f 7320 776f  ted items (os wo
+0001e3d0: 6e27 7420 6769 7665 2073 7461 7420 696e  n't give stat in
+0001e3e0: 666f 290a 2020 2020 2020 2020 2020 2020  fo).            
+0001e3f0: 2020 2020 2320 6275 7420 636f 6e66 6972      # but confir
+0001e400: 6d20 6162 7365 6e63 6520 6672 6f6d 2069  m absence from i
+0001e410: 6e64 6578 2e0a 2020 2020 2020 2020 2020  ndex..          
+0001e420: 2020 2020 2020 7265 7475 726e 2069 6e64        return ind
+0001e430: 6578 5f65 6e74 7279 2069 7320 6e6f 7420  ex_entry is not 
+0001e440: 4e6f 6e65 0a0a 2020 2020 2020 2020 2020  None..          
+0001e450: 2020 6966 2053 5f49 5344 4952 2873 7461    if S_ISDIR(sta
+0001e460: 742e 7374 5f6d 6f64 6529 3a0a 2020 2020  t.st_mode):.    
+0001e470: 2020 2020 2020 2020 2020 2020 2320 446f              # Do
+0001e480: 6e27 7420 6368 6563 6b20 6374 696d 6520  n't check ctime 
+0001e490: 666f 7220 666f 6c64 6572 7320 6275 7420  for folders but 
+0001e4a0: 636f 6d70 6172 6520 746f 2069 6e64 6578  compare to index
+0001e4b0: 2065 6e74 7279 2074 7970 652e 0a20 2020   entry type..   
+0001e4c0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001e4d0: 696e 6465 785f 656e 7472 7920 6973 204e  index_entry is N
+0001e4e0: 6f6e 6520 6f72 2069 6e64 6578 5f65 6e74  one or index_ent
+0001e4f0: 7279 2e69 735f 6669 6c65 3a0a 2020 2020  ry.is_file:.    
+0001e500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e510: 7265 7475 726e 2054 7275 650a 0a20 2020  return True..   
+0001e520: 2020 2020 2020 2020 2020 2020 2023 2052               # R
+0001e530: 6563 7572 7365 206f 7665 7220 6368 696c  ecurse over chil
+0001e540: 6472 656e 2e0a 2020 2020 2020 2020 2020  dren..          
+0001e550: 2020 2020 2020 7769 7468 206f 732e 7363        with os.sc
+0001e560: 616e 6469 7228 6c6f 6361 6c5f 7061 7468  andir(local_path
+0001e570: 2920 6173 2069 743a 0a20 2020 2020 2020  ) as it:.       
+0001e580: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001e590: 2065 6e74 7279 2069 6e20 6974 3a0a 2020   entry in it:.  
+0001e5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e5b0: 2020 2020 2020 6966 2065 6e74 7279 2e69        if entry.i
+0001e5c0: 735f 6469 7228 666f 6c6c 6f77 5f73 796d  s_dir(follow_sym
+0001e5d0: 6c69 6e6b 733d 4661 6c73 6529 3a0a 2020  links=False):.  
+0001e5e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e5f0: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
+0001e600: 662e 5f63 7469 6d65 5f6e 6577 6572 5f74  f._ctime_newer_t
+0001e610: 6861 6e5f 6c61 7374 5f73 796e 6328 656e  han_last_sync(en
+0001e620: 7472 792e 7061 7468 293a 0a20 2020 2020  try.path):.     
+0001e630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e640: 2020 2020 2020 2020 2020 2072 6574 7572             retur
+0001e650: 6e20 5472 7565 0a20 2020 2020 2020 2020  n True.         
+0001e660: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0001e670: 6c69 6620 6e6f 7420 7365 6c66 2e69 735f  lif not self.is_
+0001e680: 6578 636c 7564 6564 2865 6e74 7279 2e6e  excluded(entry.n
+0001e690: 616d 6529 3a0a 2020 2020 2020 2020 2020  ame):.          
+0001e6a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e6b0: 2020 6368 696c 645f 6462 785f 7061 7468    child_dbx_path
+0001e6c0: 5f6c 6f77 6572 203d 2073 656c 662e 746f  _lower = self.to
+0001e6d0: 5f64 6278 5f70 6174 685f 6c6f 7765 7228  _dbx_path_lower(
+0001e6e0: 656e 7472 792e 7061 7468 290a 2020 2020  entry.path).    
+0001e6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e700: 2020 2020 2020 2020 6374 696d 6520 3d20          ctime = 
+0001e710: 656e 7472 792e 7374 6174 2866 6f6c 6c6f  entry.stat(follo
+0001e720: 775f 7379 6d6c 696e 6b73 3d46 616c 7365  w_symlinks=False
+0001e730: 292e 7374 5f63 7469 6d65 0a20 2020 2020  ).st_ctime.     
+0001e740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e750: 2020 2020 2020 2069 6620 6374 696d 6520         if ctime 
+0001e760: 3e20 7365 6c66 2e67 6574 5f6c 6173 745f  > self.get_last_
+0001e770: 7379 6e63 2863 6869 6c64 5f64 6278 5f70  sync(child_dbx_p
+0001e780: 6174 685f 6c6f 7765 7229 3a0a 2020 2020  ath_lower):.    
+0001e790: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e7a0: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+0001e7b0: 726e 2054 7275 650a 0a20 2020 2020 2020  rn True..       
+0001e7c0: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001e7d0: 4661 6c73 650a 0a20 2020 2020 2020 2020  False..         
+0001e7e0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001e7f0: 2020 2020 2020 2020 2023 2043 6865 636b           # Check
+0001e800: 206f 7572 2063 7469 6d65 2061 6761 696e   our ctime again
+0001e810: 7374 2069 6e64 6578 2e0a 2020 2020 2020  st index..      
+0001e820: 2020 2020 2020 2020 2020 7265 7475 726e            return
+0001e830: 2073 7461 742e 7374 5f63 7469 6d65 203e   stat.st_ctime >
+0001e840: 2073 656c 662e 6765 745f 6c61 7374 5f73   self.get_last_s
+0001e850: 796e 6328 6462 785f 7061 7468 5f6c 6f77  ync(dbx_path_low
+0001e860: 6572 290a 0a20 2020 2064 6566 205f 6765  er)..    def _ge
+0001e870: 745f 6374 696d 6528 7365 6c66 2c20 6c6f  t_ctime(self, lo
+0001e880: 6361 6c5f 7061 7468 3a20 7374 7229 202d  cal_path: str) -
+0001e890: 3e20 666c 6f61 743a 0a20 2020 2020 2020  > float:.       
+0001e8a0: 2022 2222 0a20 2020 2020 2020 2052 6574   """.        Ret
+0001e8b0: 7572 6e73 2074 6865 2063 7469 6d65 206f  urns the ctime o
+0001e8c0: 6620 6120 6c6f 6361 6c20 6974 656d 206f  f a local item o
+0001e8d0: 7220 2d31 2e30 2069 6620 7468 6572 6520  r -1.0 if there 
+0001e8e0: 6973 206e 6f74 6869 6e67 2061 7420 7468  is nothing at th
+0001e8f0: 6520 7061 7468 2e20 4966 0a20 2020 2020  e path. If.     
+0001e900: 2020 2074 6865 2069 7465 6d20 6973 2061     the item is a
+0001e910: 2064 6972 6563 746f 7279 2c20 7265 7475   directory, retu
+0001e920: 726e 2074 6865 206c 6172 6765 7374 2063  rn the largest c
+0001e930: 7469 6d65 206f 6620 6974 2061 6e64 2069  time of it and i
+0001e940: 7473 2063 6869 6c64 7265 6e2e 2049 7465  ts children. Ite
+0001e950: 6d73 0a20 2020 2020 2020 2077 6869 6368  ms.        which
+0001e960: 2061 7265 2065 7863 6c75 6465 6420 6672   are excluded fr
+0001e970: 6f6d 2073 796e 6369 6e67 2028 652e 672e  om syncing (e.g.
+0001e980: 2c20 2e44 535f 5374 6f72 6520 6669 6c65  , .DS_Store file
+0001e990: 7329 2061 7265 2069 676e 6f72 6564 2e0a  s) are ignored..
+0001e9a0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0001e9b0: 6c6f 6361 6c5f 7061 7468 3a20 4162 736f  local_path: Abso
+0001e9c0: 6c75 7465 2070 6174 6820 6f6e 206c 6f63  lute path on loc
+0001e9d0: 616c 2064 7269 7665 2e0a 2020 2020 2020  al drive..      
+0001e9e0: 2020 3a72 6574 7572 6e73 3a20 4374 696d    :returns: Ctim
+0001e9f0: 6520 6f72 202d 312e 302e 0a20 2020 2020  e or -1.0..     
+0001ea00: 2020 2022 2222 0a20 2020 2020 2020 2074     """.        t
+0001ea10: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0001ea20: 7374 6174 203d 206f 732e 6c73 7461 7428  stat = os.lstat(
+0001ea30: 6c6f 6361 6c5f 7061 7468 290a 2020 2020  local_path).    
+0001ea40: 2020 2020 2020 2020 6966 2053 5f49 5344          if S_ISD
+0001ea50: 4952 2873 7461 742e 7374 5f6d 6f64 6529  IR(stat.st_mode)
+0001ea60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001ea70: 2020 6374 696d 6520 3d20 7374 6174 2e73    ctime = stat.s
+0001ea80: 745f 6374 696d 650a 2020 2020 2020 2020  t_ctime.        
+0001ea90: 2020 2020 2020 2020 7769 7468 206f 732e          with os.
+0001eaa0: 7363 616e 6469 7228 6c6f 6361 6c5f 7061  scandir(local_pa
+0001eab0: 7468 2920 6173 2069 743a 0a20 2020 2020  th) as it:.     
+0001eac0: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+0001ead0: 6f72 2065 6e74 7279 2069 6e20 6974 3a0a  or entry in it:.
+0001eae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eaf0: 2020 2020 2020 2020 6966 2065 6e74 7279          if entry
+0001eb00: 2e69 735f 6469 7228 666f 6c6c 6f77 5f73  .is_dir(follow_s
+0001eb10: 796d 6c69 6e6b 733d 4661 6c73 6529 3a0a  ymlinks=False):.
+0001eb20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001eb30: 2020 2020 2020 2020 2020 2020 6368 696c              chil
+0001eb40: 645f 6374 696d 6520 3d20 7365 6c66 2e5f  d_ctime = self._
+0001eb50: 6765 745f 6374 696d 6528 656e 7472 792e  get_ctime(entry.
+0001eb60: 7061 7468 290a 2020 2020 2020 2020 2020  path).          
+0001eb70: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001eb80: 6966 206e 6f74 2073 656c 662e 6973 5f65  if not self.is_e
+0001eb90: 7863 6c75 6465 6428 656e 7472 792e 6e61  xcluded(entry.na
+0001eba0: 6d65 293a 0a20 2020 2020 2020 2020 2020  me):.           
+0001ebb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ebc0: 2063 6869 6c64 5f63 7469 6d65 203d 2065   child_ctime = e
+0001ebd0: 6e74 7279 2e73 7461 7428 666f 6c6c 6f77  ntry.stat(follow
+0001ebe0: 5f73 796d 6c69 6e6b 733d 4661 6c73 6529  _symlinks=False)
+0001ebf0: 2e73 745f 6374 696d 650a 2020 2020 2020  .st_ctime.      
+0001ec00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec10: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001ec20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec30: 2020 2020 6368 696c 645f 6374 696d 6520      child_ctime 
+0001ec40: 3d20 2d31 2e30 0a0a 2020 2020 2020 2020  = -1.0..        
+0001ec50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ec60: 6374 696d 6520 3d20 6d61 7828 6374 696d  ctime = max(ctim
+0001ec70: 652c 2063 6869 6c64 5f63 7469 6d65 290a  e, child_ctime).
+0001ec80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ec90: 2072 6574 7572 6e20 6374 696d 650a 2020   return ctime.  
+0001eca0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0001ecb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ecc0: 7265 7475 726e 2073 7461 742e 7374 5f63  return stat.st_c
+0001ecd0: 7469 6d65 0a20 2020 2020 2020 2065 7863  time.        exc
+0001ece0: 6570 7420 2846 696c 654e 6f74 466f 756e  ept (FileNotFoun
+0001ecf0: 6445 7272 6f72 2c20 4e6f 7441 4469 7265  dError, NotADire
+0001ed00: 6374 6f72 7945 7272 6f72 293a 0a20 2020  ctoryError):.   
+0001ed10: 2020 2020 2020 2020 2072 6574 7572 6e20           return 
+0001ed20: 2d31 2e30 0a20 2020 2020 2020 2065 7863  -1.0.        exc
+0001ed30: 6570 7420 4f53 4572 726f 7220 6173 2065  ept OSError as e
+0001ed40: 7863 3a0a 2020 2020 2020 2020 2020 2020  xc:.            
+0001ed50: 7261 6973 6520 6f73 5f74 6f5f 6d61 6573  raise os_to_maes
+0001ed60: 7472 616c 5f65 7272 6f72 2865 7863 2c20  tral_error(exc, 
+0001ed70: 6c6f 6361 6c5f 7061 7468 3d6c 6f63 616c  local_path=local
+0001ed80: 5f70 6174 6829 0a0a 2020 2020 6465 6620  _path)..    def 
+0001ed90: 5f63 6c65 616e 5f72 656d 6f74 655f 6368  _clean_remote_ch
+0001eda0: 616e 6765 7328 7365 6c66 2c20 6368 616e  anges(self, chan
+0001edb0: 6765 733a 204c 6973 7446 6f6c 6465 7252  ges: ListFolderR
+0001edc0: 6573 756c 7429 202d 3e20 4c69 7374 466f  esult) -> ListFo
+0001edd0: 6c64 6572 5265 7375 6c74 3a0a 2020 2020  lderResult:.    
+0001ede0: 2020 2020 2222 220a 2020 2020 2020 2020      """.        
+0001edf0: 5461 6b65 7320 7265 6d6f 7465 2066 696c  Takes remote fil
+0001ee00: 6520 6576 656e 7473 2073 696e 6365 206c  e events since l
+0001ee10: 6173 7420 7379 6e63 2061 6e64 2063 6c65  ast sync and cle
+0001ee20: 616e 7320 7468 656d 2075 7020 736f 2074  ans them up so t
+0001ee30: 6861 7420 7468 6572 6520 6973 0a20 2020  hat there is.   
+0001ee40: 2020 2020 206f 6e6c 7920 6120 7369 6e67       only a sing
+0001ee50: 6c65 2065 7665 6e74 2070 6572 2070 6174  le event per pat
+0001ee60: 682e 0a0a 2020 2020 2020 2020 4472 6f70  h...        Drop
+0001ee70: 626f 7820 7769 6c6c 2073 6f6d 6574 696d  box will sometim
+0001ee80: 6573 2072 6570 6f72 7420 6d75 6c74 6970  es report multip
+0001ee90: 6c65 2063 6861 6e67 6573 2070 6572 2070  le changes per p
+0001eea0: 6174 682e 204f 6e63 6520 7375 6368 2069  ath. Once such i
+0001eeb0: 6e73 7461 6e63 6520 6973 0a20 2020 2020  nstance is.     
+0001eec0: 2020 2077 6865 6e20 7368 6172 696e 6720     when sharing 
+0001eed0: 6120 666f 6c64 6572 3a20 6060 6669 6c65  a folder: ``file
+0001eee0: 732f 6c69 7374 5f66 6f6c 6465 722f 636f  s/list_folder/co
+0001eef0: 6e74 696e 7565 6060 2077 696c 6c20 7265  ntinue`` will re
+0001ef00: 706f 7274 2074 6865 2073 6861 7265 640a  port the shared.
+0001ef10: 2020 2020 2020 2020 666f 6c64 6572 2061          folder a
+0001ef20: 6e64 2069 7473 2063 6869 6c64 7265 6e20  nd its children 
+0001ef30: 6173 2064 656c 6574 6564 2061 6e64 2074  as deleted and t
+0001ef40: 6865 6e20 6372 6561 7465 6420 6265 6361  hen created beca
+0001ef50: 7573 6520 7468 6520 666f 6c64 6572 202a  use the folder *
+0001ef60: 6973 2a0a 2020 2020 2020 2020 6163 7475  is*.        actu
+0001ef70: 616c 6c79 2064 656c 6574 6564 2066 726f  ally deleted fro
+0001ef80: 6d20 7468 6520 7573 6572 2773 2044 726f  m the user's Dro
+0001ef90: 7062 6f78 2061 6e64 2072 6563 7265 6174  pbox and recreat
+0001efa0: 6564 2061 7320 6120 7368 6172 6564 2066  ed as a shared f
+0001efb0: 6f6c 6465 7220 7768 6963 680a 2020 2020  older which.    
+0001efc0: 2020 2020 7468 656e 2067 6574 7320 6d6f      then gets mo
+0001efd0: 756e 7465 6420 746f 2074 6865 2075 7365  unted to the use
+0001efe0: 7227 7320 4472 6f70 626f 782e 2049 6465  r's Dropbox. Ide
+0001eff0: 616c 6c79 2c20 7765 2077 616e 7420 746f  ally, we want to
+0001f000: 2064 6561 6c20 7769 7468 2074 6869 730a   deal with this.
+0001f010: 2020 2020 2020 2020 7769 7468 6f75 7420          without 
+0001f020: 7265 2d64 6f77 6e6c 6f61 6469 6e67 2061  re-downloading a
+0001f030: 6c6c 2069 7473 2063 6f6e 7465 6e74 732e  ll its contents.
+0001f040: 0a0a 2020 2020 2020 2020 3a70 6172 616d  ..        :param
+0001f050: 2063 6861 6e67 6573 3a20 5265 7375 6c74   changes: Result
+0001f060: 2066 726f 6d20 4472 6f70 626f 7820 4150   from Dropbox AP
+0001f070: 4920 6361 6c6c 2074 6f20 7265 7472 6965  I call to retrie
+0001f080: 7665 2072 656d 6f74 6520 6368 616e 6765  ve remote change
+0001f090: 732e 0a20 2020 2020 2020 203a 7265 7475  s..        :retu
+0001f0a0: 726e 733a 2043 6c65 616e 6564 2075 7020  rns: Cleaned up 
+0001f0b0: 6368 616e 6765 7320 7769 7468 2061 2073  changes with a s
+0001f0c0: 696e 676c 6520 4d65 7461 6461 7461 2065  ingle Metadata e
+0001f0d0: 6e74 7279 2070 6572 2070 6174 682e 0a20  ntry per path.. 
+0001f0e0: 2020 2020 2020 2022 2222 0a20 2020 2020         """.     
+0001f0f0: 2020 2023 204e 6f74 653a 2077 6520 776f     # Note: we wo
+0001f100: 6e27 7420 6861 7665 2074 6f20 6465 616c  n't have to deal
+0001f110: 2077 6974 6820 6d6f 6469 6669 6564 206f   with modified o
+0001f120: 7220 6d6f 7665 6420 6576 656e 7473 2c0a  r moved events,.
+0001f130: 2020 2020 2020 2020 2320 4472 6f70 626f          # Dropbo
+0001f140: 7820 6f6e 6c79 2072 6570 6f72 7473 2044  x only reports D
+0001f150: 656c 6574 6564 4d65 7461 6461 7461 206f  eletedMetadata o
+0001f160: 7220 4669 6c65 4d65 7461 6461 7461 202f  r FileMetadata /
+0001f170: 2046 6f6c 6465 724d 6574 6164 6174 610a   FolderMetadata.
+0001f180: 2020 2020 2020 2020 6869 7374 6f72 6965          historie
+0001f190: 733a 2064 6566 6175 6c74 6469 6374 5b73  s: defaultdict[s
+0001f1a0: 7472 2c20 6c69 7374 5b4d 6574 6164 6174  tr, list[Metadat
+0001f1b0: 615d 5d20 3d20 6465 6661 756c 7464 6963  a]] = defaultdic
+0001f1c0: 7428 6c69 7374 290a 0a20 2020 2020 2020  t(list)..       
+0001f1d0: 2066 6f72 2065 6e74 7279 2069 6e20 6368   for entry in ch
+0001f1e0: 616e 6765 732e 656e 7472 6965 733a 0a20  anges.entries:. 
+0001f1f0: 2020 2020 2020 2020 2020 2068 6973 746f             histo
+0001f200: 7269 6573 5b65 6e74 7279 2e70 6174 685f  ries[entry.path_
+0001f210: 6c6f 7765 725d 2e61 7070 656e 6428 656e  lower].append(en
+0001f220: 7472 7929 0a0a 2020 2020 2020 2020 6e65  try)..        ne
+0001f230: 775f 656e 7472 6965 7320 3d20 5b5d 0a0a  w_entries = []..
+0001f240: 2020 2020 2020 2020 666f 7220 6820 696e          for h in
+0001f250: 2068 6973 746f 7269 6573 2e76 616c 7565   histories.value
+0001f260: 7328 293a 0a20 2020 2020 2020 2020 2020  s():.           
+0001f270: 2069 6620 6c65 6e28 6829 203d 3d20 313a   if len(h) == 1:
+0001f280: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f290: 206e 6577 5f65 6e74 7269 6573 2e65 7874   new_entries.ext
+0001f2a0: 656e 6428 6829 0a20 2020 2020 2020 2020  end(h).         
+0001f2b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001f2c0: 2020 2020 2020 2020 206c 6173 745f 6576           last_ev
+0001f2d0: 656e 7420 3d20 685b 2d31 5d0a 2020 2020  ent = h[-1].    
+0001f2e0: 2020 2020 2020 2020 2020 2020 6c6f 6361              loca
+0001f2f0: 6c5f 656e 7472 7920 3d20 7365 6c66 2e67  l_entry = self.g
+0001f300: 6574 5f69 6e64 6578 5f65 6e74 7279 286c  et_index_entry(l
+0001f310: 6173 745f 6576 656e 742e 7061 7468 5f6c  ast_event.path_l
+0001f320: 6f77 6572 290a 2020 2020 2020 2020 2020  ower).          
+0001f330: 2020 2020 2020 7761 735f 6469 7220 3d20        was_dir = 
+0001f340: 6c6f 6361 6c5f 656e 7472 7920 616e 6420  local_entry and 
+0001f350: 6c6f 6361 6c5f 656e 7472 792e 6973 5f64  local_entry.is_d
+0001f360: 6972 6563 746f 7279 0a0a 2020 2020 2020  irectory..      
+0001f370: 2020 2020 2020 2020 2020 2320 4472 6f70            # Drop
+0001f380: 626f 7820 6775 6172 616e 7465 6573 2074  box guarantees t
+0001f390: 6861 7420 6170 706c 7969 6e67 2065 7665  hat applying eve
+0001f3a0: 6e74 7320 696e 2074 6865 2070 726f 7669  nts in the provi
+0001f3b0: 6465 6420 6f72 6465 7220 7769 6c6c 0a20  ded order will. 
+0001f3c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001f3d0: 2072 6570 726f 6475 6365 2074 6865 2073   reproduce the s
+0001f3e0: 7461 7465 2069 6e20 7468 6520 636c 6f75  tate in the clou
+0001f3f0: 642e 2057 6520 7468 6572 6566 6f72 6520  d. We therefore 
+0001f400: 6b65 6570 206f 6e6c 7920 7468 6520 6c61  keep only the la
+0001f410: 7374 0a20 2020 2020 2020 2020 2020 2020  st.             
+0001f420: 2020 2023 2065 7665 6e74 2c20 756e 6c65     # event, unle
+0001f430: 7373 2074 6865 7265 2069 7320 6120 6368  ss there is a ch
+0001f440: 616e 6765 2069 6e20 6974 656d 2074 7970  ange in item typ
+0001f450: 652e 0a20 2020 2020 2020 2020 2020 2020  e..             
+0001f460: 2020 2069 6620 280a 2020 2020 2020 2020     if (.        
+0001f470: 2020 2020 2020 2020 2020 2020 7761 735f              was_
+0001f480: 6469 720a 2020 2020 2020 2020 2020 2020  dir.            
+0001f490: 2020 2020 2020 2020 616e 6420 6973 696e          and isin
+0001f4a0: 7374 616e 6365 286c 6173 745f 6576 656e  stance(last_even
+0001f4b0: 742c 2046 696c 654d 6574 6164 6174 6129  t, FileMetadata)
+0001f4c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f4d0: 2020 2020 206f 7220 6e6f 7420 7761 735f       or not was_
+0001f4e0: 6469 720a 2020 2020 2020 2020 2020 2020  dir.            
+0001f4f0: 2020 2020 2020 2020 616e 6420 6973 696e          and isin
+0001f500: 7374 616e 6365 286c 6173 745f 6576 656e  stance(last_even
+0001f510: 742c 2046 6f6c 6465 724d 6574 6164 6174  t, FolderMetadat
+0001f520: 6129 0a20 2020 2020 2020 2020 2020 2020  a).             
+0001f530: 2020 2029 3a0a 2020 2020 2020 2020 2020     ):.          
+0001f540: 2020 2020 2020 2020 2020 6465 6c65 7465            delete
+0001f550: 645f 6576 656e 7420 3d20 4465 6c65 7465  d_event = Delete
+0001f560: 644d 6574 6164 6174 6128 0a20 2020 2020  dMetadata(.     
+0001f570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f580: 2020 206e 616d 653d 6c61 7374 5f65 7665     name=last_eve
+0001f590: 6e74 2e6e 616d 652c 0a20 2020 2020 2020  nt.name,.       
+0001f5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f5b0: 2070 6174 685f 6c6f 7765 723d 6c61 7374   path_lower=last
+0001f5c0: 5f65 7665 6e74 2e70 6174 685f 6c6f 7765  _event.path_lowe
+0001f5d0: 722c 0a20 2020 2020 2020 2020 2020 2020  r,.             
+0001f5e0: 2020 2020 2020 2020 2020 2070 6174 685f             path_
+0001f5f0: 6469 7370 6c61 793d 6c61 7374 5f65 7665  display=last_eve
+0001f600: 6e74 2e70 6174 685f 6469 7370 6c61 792c  nt.path_display,
+0001f610: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001f620: 2020 2020 2029 0a20 2020 2020 2020 2020       ).         
+0001f630: 2020 2020 2020 2020 2020 206e 6577 5f65             new_e
+0001f640: 6e74 7269 6573 2e61 7070 656e 6428 6465  ntries.append(de
+0001f650: 6c65 7465 645f 6576 656e 7429 0a20 2020  leted_event).   
+0001f660: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f670: 206e 6577 5f65 6e74 7269 6573 2e61 7070   new_entries.app
+0001f680: 656e 6428 6c61 7374 5f65 7665 6e74 290a  end(last_event).
+0001f690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001f6a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0001f6b0: 2020 2020 2020 2020 2020 6e65 775f 656e            new_en
+0001f6c0: 7472 6965 732e 6170 7065 6e64 286c 6173  tries.append(las
+0001f6d0: 745f 6576 656e 7429 0a0a 2020 2020 2020  t_event)..      
+0001f6e0: 2020 6368 616e 6765 732e 656e 7472 6965    changes.entrie
+0001f6f0: 7320 3d20 6e65 775f 656e 7472 6965 730a  s = new_entries.
+0001f700: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0001f710: 6368 616e 6765 730a 0a20 2020 2064 6566  changes..    def
+0001f720: 205f 6372 6561 7465 5f6c 6f63 616c 5f65   _create_local_e
+0001f730: 6e74 7279 2873 656c 662c 2065 7665 6e74  ntry(self, event
+0001f740: 3a20 5379 6e63 4576 656e 7429 202d 3e20  : SyncEvent) -> 
+0001f750: 5379 6e63 4576 656e 743a 0a20 2020 2020  SyncEvent:.     
+0001f760: 2020 2022 2222 0a20 2020 2020 2020 2041     """.        A
+0001f770: 7070 6c69 6573 2061 2066 696c 6520 2f20  pplies a file / 
+0001f780: 666f 6c64 6572 2063 6861 6e67 6520 6672  folder change fr
+0001f790: 6f6d 2044 726f 7062 6f78 2073 6572 7665  om Dropbox serve
+0001f7a0: 7273 2074 6f20 7468 6520 6c6f 6361 6c20  rs to the local 
+0001f7b0: 4472 6f70 626f 7820 666f 6c64 6572 2e0a  Dropbox folder..
+0001f7c0: 2020 2020 2020 2020 416e 7920 3a65 7863          Any :exc
+0001f7d0: 3a60 6d61 6573 7472 616c 2e65 7863 6570  :`maestral.excep
+0001f7e0: 7469 6f6e 2e4d 6165 7374 7261 6c41 7069  tion.MaestralApi
+0001f7f0: 4572 726f 7260 2077 696c 6c20 6265 2063  Error` will be c
+0001f800: 6175 6768 7420 616e 6420 6c6f 6767 6564  aught and logged
+0001f810: 2061 730a 2020 2020 2020 2020 6170 7072   as.        appr
+0001f820: 6f70 7269 6174 652e 2045 6e74 7269 6573  opriate. Entries
+0001f830: 2069 6e20 7468 6520 6c6f 6361 6c20 696e   in the local in
+0001f840: 6465 7820 6172 6520 6372 6561 7465 6420  dex are created 
+0001f850: 6166 7465 7220 7375 6363 6573 7366 756c  after successful
+0001f860: 2063 6f6d 706c 6574 696f 6e2e 0a0a 2020   completion...  
+0001f870: 2020 2020 2020 3a70 6172 616d 2065 7665        :param eve
+0001f880: 6e74 3a20 4472 6f70 626f 7820 6d65 7461  nt: Dropbox meta
+0001f890: 6461 7461 2e0a 2020 2020 2020 2020 3a72  data..        :r
+0001f8a0: 6574 7572 6e73 3a20 436f 7079 206f 6620  eturns: Copy of 
+0001f8b0: 7468 6520 4472 6f70 626f 7820 6d65 7461  the Dropbox meta
+0001f8c0: 6461 7461 2069 6620 7468 6520 6368 616e  data if the chan
+0001f8d0: 6765 2077 6173 2061 7070 6c69 6564 2073  ge was applied s
+0001f8e0: 7563 6365 7373 6675 6c6c 792c 0a20 2020  uccessfully,.   
+0001f8f0: 2020 2020 2020 2020 2060 6054 7275 6560           ``True`
+0001f900: 6020 6966 2074 6865 2063 6861 6e67 6520  ` if the change 
+0001f910: 616c 7265 6164 7920 6578 6973 7465 642c  already existed,
+0001f920: 2060 6046 616c 7365 6060 2069 6e20 6361   ``False`` in ca
+0001f930: 7365 206f 6620 6120 7379 6e63 2065 7272  se of a sync err
+0001f940: 6f72 0a20 2020 2020 2020 2020 2020 2061  or.            a
+0001f950: 6e64 2060 604e 6f6e 6560 6020 6966 2063  nd ``None`` if c
+0001f960: 616e 6365 6c6c 6564 2e0a 2020 2020 2020  ancelled..      
+0001f970: 2020 2222 220a 2020 2020 2020 2020 6966    """.        if
+0001f980: 2073 656c 662e 5f63 616e 6365 6c5f 7265   self._cancel_re
+0001f990: 7175 6573 7465 642e 6973 5f73 6574 2829  quested.is_set()
+0001f9a0: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0001f9b0: 6973 6520 4361 6e63 656c 6c65 6445 7272  ise CancelledErr
+0001f9c0: 6f72 2822 5379 6e63 2063 616e 6365 6c6c  or("Sync cancell
+0001f9d0: 6564 2229 0a0a 2020 2020 2020 2020 7365  ed")..        se
+0001f9e0: 6c66 2e5f 736c 6f77 5f64 6f77 6e28 290a  lf._slow_down().
+0001f9f0: 0a20 2020 2020 2020 2065 7665 6e74 2e73  .        event.s
+0001fa00: 7461 7475 7320 3d20 5379 6e63 5374 6174  tatus = SyncStat
+0001fa10: 7573 2e53 796e 6369 6e67 0a0a 2020 2020  us.Syncing..    
+0001fa20: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+0001fa30: 2020 2020 2069 6620 6576 656e 742e 6973       if event.is
+0001fa40: 5f64 656c 6574 6564 3a0a 2020 2020 2020  _deleted:.      
+0001fa50: 2020 2020 2020 2020 2020 7374 6174 7573            status
+0001fa60: 203d 2073 656c 662e 5f6f 6e5f 7265 6d6f   = self._on_remo
+0001fa70: 7465 5f64 656c 6574 6564 2865 7665 6e74  te_deleted(event
+0001fa80: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+0001fa90: 6966 2065 7665 6e74 2e69 735f 6669 6c65  if event.is_file
+0001faa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001fab0: 2020 7374 6174 7573 203d 2073 656c 662e    status = self.
+0001fac0: 5f6f 6e5f 7265 6d6f 7465 5f66 696c 6528  _on_remote_file(
+0001fad0: 6576 656e 7429 0a20 2020 2020 2020 2020  event).         
+0001fae0: 2020 2065 6c69 6620 6576 656e 742e 6973     elif event.is
+0001faf0: 5f64 6972 6563 746f 7279 3a0a 2020 2020  _directory:.    
+0001fb00: 2020 2020 2020 2020 2020 2020 7374 6174              stat
+0001fb10: 7573 203d 2073 656c 662e 5f6f 6e5f 7265  us = self._on_re
+0001fb20: 6d6f 7465 5f66 6f6c 6465 7228 6576 656e  mote_folder(even
+0001fb30: 7429 0a20 2020 2020 2020 2020 2020 2065  t).            e
+0001fb40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001fb50: 2020 2020 2073 7461 7475 7320 3d20 5379       status = Sy
+0001fb60: 6e63 5374 6174 7573 2e53 6b69 7070 6564  ncStatus.Skipped
+0001fb70: 0a0a 2020 2020 2020 2020 2020 2020 6576  ..            ev
+0001fb80: 656e 742e 7374 6174 7573 203d 2073 7461  ent.status = sta
+0001fb90: 7475 730a 0a20 2020 2020 2020 2065 7863  tus..        exc
+0001fba0: 6570 7420 5379 6e63 4572 726f 7220 6173  ept SyncError as
+0001fbb0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+0001fbc0: 7365 6c66 2e5f 6861 6e64 6c65 5f73 796e  self._handle_syn
+0001fbd0: 635f 6572 726f 7228 652c 2064 6972 6563  c_error(e, direc
+0001fbe0: 7469 6f6e 3d53 796e 6344 6972 6563 7469  tion=SyncDirecti
+0001fbf0: 6f6e 2e44 6f77 6e29 0a20 2020 2020 2020  on.Down).       
+0001fc00: 2020 2020 2065 7665 6e74 2e73 7461 7475       event.statu
+0001fc10: 7320 3d20 5379 6e63 5374 6174 7573 2e46  s = SyncStatus.F
+0001fc20: 6169 6c65 640a 2020 2020 2020 2020 656c  ailed.        el
+0001fc30: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001fc40: 7365 6c66 2e63 6c65 6172 5f73 796e 635f  self.clear_sync_
+0001fc50: 6572 726f 7273 5f66 726f 6d5f 6576 656e  errors_from_even
+0001fc60: 7428 6576 656e 7429 0a20 2020 2020 2020  t(event).       
+0001fc70: 2020 2020 2073 656c 662e 6163 7469 7669       self.activi
+0001fc80: 7479 2e64 6973 6361 7264 2865 7665 6e74  ty.discard(event
+0001fc90: 290a 0a20 2020 2020 2020 2023 2041 6464  )..        # Add
+0001fca0: 2065 7665 6e74 7320 746f 2068 6973 746f   events to histo
+0001fcb0: 7279 2064 6174 6162 6173 652e 0a20 2020  ry database..   
+0001fcc0: 2020 2020 2069 6620 6576 656e 742e 7374       if event.st
+0001fcd0: 6174 7573 203d 3d20 5379 6e63 5374 6174  atus == SyncStat
+0001fce0: 7573 2e44 6f6e 653a 0a20 2020 2020 2020  us.Done:.       
+0001fcf0: 2020 2020 2077 6974 6820 7365 6c66 2e5f       with self._
+0001fd00: 6461 7461 6261 7365 5f61 6363 6573 7328  database_access(
+0001fd10: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001fd20: 2020 2073 656c 662e 5f68 6973 746f 7279     self._history
+0001fd30: 5f74 6162 6c65 2e73 6176 6528 6576 656e  _table.save(even
+0001fd40: 7429 0a0a 2020 2020 2020 2020 7265 7475  t)..        retu
+0001fd50: 726e 2065 7665 6e74 0a0a 2020 2020 6465  rn event..    de
+0001fd60: 6620 5f65 6e73 7572 655f 7061 7265 6e74  f _ensure_parent
+0001fd70: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
+0001fd80: 6e63 4576 656e 7429 202d 3e20 4e6f 6e65  ncEvent) -> None
+0001fd90: 3a0a 2020 2020 2020 2020 2222 220a 2020  :.        """.  
+0001fda0: 2020 2020 2020 456e 7375 7265 7320 7468        Ensures th
+0001fdb0: 6174 2061 6c6c 2070 6172 656e 7420 666f  at all parent fo
+0001fdc0: 6c64 6572 7320 666f 7220 6120 7379 6e63  lders for a sync
+0001fdd0: 2065 7665 6e74 2065 7869 7374 206c 6f63   event exist loc
+0001fde0: 616c 6c79 2e20 5468 6973 2069 7320 7573  ally. This is us
+0001fdf0: 6564 2074 6f0a 2020 2020 2020 2020 7072  ed to.        pr
+0001fe00: 6576 656e 7420 6368 696c 6472 656e 2066  event children f
+0001fe10: 726f 6d20 6265 696e 6720 646f 776e 6c6f  rom being downlo
+0001fe20: 6164 6564 2062 6566 6f72 6520 7468 6569  aded before thei
+0001fe30: 7220 7061 7265 6e74 732e 2049 6e20 7468  r parents. In th
+0001fe40: 6520 6d6f 7374 2063 6173 6573 2c0a 2020  e most cases,.  
+0001fe50: 2020 2020 2020 7765 2077 696c 6c20 6175        we will au
+0001fe60: 746f 6d61 7469 6361 6c6c 7920 7379 6e63  tomatically sync
+0001fe70: 2070 6172 656e 7473 2062 6566 6f72 6520   parents before 
+0001fe80: 7468 6569 7220 6368 696c 6472 656e 2062  their children b
+0001fe90: 7574 2074 6869 7320 6973 206e 6f74 2061  ut this is not a
+0001fea0: 6c77 6179 730a 2020 2020 2020 2020 6775  lways.        gu
+0001feb0: 6172 616e 7465 6564 2e20 5365 6520 6874  aranteed. See ht
+0001fec0: 7470 733a 2f2f 6769 7468 7562 2e63 6f6d  tps://github.com
+0001fed0: 2f53 616d 5363 686f 7474 2f6d 6165 7374  /SamSchott/maest
+0001fee0: 7261 6c2f 6973 7375 6573 2f34 3532 2e0a  ral/issues/452..
+0001fef0: 0a20 2020 2020 2020 203a 7061 7261 6d20  .        :param 
+0001ff00: 6576 656e 743a 2053 796e 6345 7665 6e74  event: SyncEvent
+0001ff10: 2066 6f72 2074 6172 6765 7420 6669 6c65   for target file
+0001ff20: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+0001ff30: 2020 2020 2020 6462 785f 7061 7468 5f6c        dbx_path_l
+0001ff40: 6f77 6572 5f64 6972 6e61 6d65 203d 206f  ower_dirname = o
+0001ff50: 7370 2e64 6972 6e61 6d65 2865 7665 6e74  sp.dirname(event
+0001ff60: 2e64 6278 5f70 6174 685f 6c6f 7765 7229  .dbx_path_lower)
+0001ff70: 0a0a 2020 2020 2020 2020 6966 2064 6278  ..        if dbx
+0001ff80: 5f70 6174 685f 6c6f 7765 725f 6469 726e  _path_lower_dirn
+0001ff90: 616d 6520 3d3d 2022 2f22 3a0a 2020 2020  ame == "/":.    
+0001ffa0: 2020 2020 2020 2020 7265 7475 726e 0a0a          return..
+0001ffb0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+0001ffc0: 662e 5f74 7265 655f 7472 6176 6572 7361  f._tree_traversa
+0001ffd0: 6c3a 0a20 2020 2020 2020 2020 2020 2069  l:.            i
+0001ffe0: 6620 6e6f 7420 7365 6c66 2e67 6574 5f69  f not self.get_i
+0001fff0: 6e64 6578 5f65 6e74 7279 2864 6278 5f70  ndex_entry(dbx_p
+00020000: 6174 685f 6c6f 7765 725f 6469 726e 616d  ath_lower_dirnam
+00020010: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00020020: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00020030: 2e64 6562 7567 280a 2020 2020 2020 2020  .debug(.        
+00020040: 2020 2020 2020 2020 2020 2020 6622 5061              f"Pa
+00020050: 7265 6e74 2066 6f6c 6465 7220 7b64 6278  rent folder {dbx
+00020060: 5f70 6174 685f 6c6f 7765 725f 6469 726e  _path_lower_dirn
+00020070: 616d 657d 2069 7320 6e6f 7420 696e 2069  ame} is not in i
+00020080: 6e64 6578 2e20 220a 2020 2020 2020 2020  ndex. ".        
+00020090: 2020 2020 2020 2020 2020 2020 6622 5379              f"Sy
+000200a0: 6e63 696e 6720 6974 206e 6f77 2062 6566  ncing it now bef
+000200b0: 6f72 6520 7379 6e63 696e 6720 616e 7920  ore syncing any 
+000200c0: 6368 696c 6472 656e 2e22 0a20 2020 2020  children.".     
+000200d0: 2020 2020 2020 2020 2020 2029 0a0a 2020             )..  
+000200e0: 2020 2020 2020 2020 2020 2020 2020 7061                pa
+000200f0: 7265 6e74 5f6d 6420 3d20 7365 6c66 2e63  rent_md = self.c
+00020100: 6c69 656e 742e 6765 745f 6d65 7461 6461  lient.get_metada
+00020110: 7461 2864 6278 5f70 6174 685f 6c6f 7765  ta(dbx_path_lowe
+00020120: 725f 6469 726e 616d 6529 0a0a 2020 2020  r_dirname)..    
+00020130: 2020 2020 2020 2020 2020 2020 6966 2070              if p
+00020140: 6172 656e 745f 6d64 3a20 2023 2049 6620  arent_md:  # If 
+00020150: 7468 6520 7061 7265 6e74 206e 6f20 6c6f  the parent no lo
+00020160: 6e67 6572 2065 7869 7374 732c 2077 6520  nger exists, we 
+00020170: 646f 6e27 7420 646f 2061 6e79 7468 696e  don't do anythin
+00020180: 672e 0a20 2020 2020 2020 2020 2020 2020  g..             
+00020190: 2020 2020 2020 2070 6172 656e 745f 6576         parent_ev
+000201a0: 656e 7420 3d20 5379 6e63 4576 656e 742e  ent = SyncEvent.
+000201b0: 6672 6f6d 5f6d 6574 6164 6174 6128 7061  from_metadata(pa
+000201c0: 7265 6e74 5f6d 642c 2073 656c 6629 0a20  rent_md, self). 
+000201d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000201e0: 2020 2073 656c 662e 5f6f 6e5f 7265 6d6f     self._on_remo
+000201f0: 7465 5f66 6f6c 6465 7228 7061 7265 6e74  te_folder(parent
+00020200: 5f65 7665 6e74 290a 0a20 2020 2064 6566  _event)..    def
+00020210: 205f 6c6f 6361 6c5f 6363 5f66 696c 656e   _local_cc_filen
+00020220: 616d 6528 7365 6c66 2c20 6c6f 6361 6c5f  ame(self, local_
+00020230: 7061 7468 3a20 7374 722c 2064 6269 643a  path: str, dbid:
+00020240: 2073 7472 207c 204e 6f6e 6529 202d 3e20   str | None) -> 
+00020250: 7374 723a 0a20 2020 2020 2020 2063 6861  str:.        cha
+00020260: 6e67 655f 6f77 6e65 7220 3d20 7365 6c66  nge_owner = self
+00020270: 2e5f 6469 7370 6c61 795f 6e61 6d65 5f66  ._display_name_f
+00020280: 6f72 5f61 6363 6f75 6e74 2864 6269 6429  or_account(dbid)
+00020290: 0a20 2020 2020 2020 2064 6174 6520 3d20  .        date = 
+000202a0: 6461 7465 7469 6d65 2e6e 6f77 2829 2e73  datetime.now().s
+000202b0: 7472 6674 696d 6528 2225 592d 256d 2d25  trftime("%Y-%m-%
+000202c0: 6422 290a 2020 2020 2020 2020 6966 2063  d").        if c
+000202d0: 6861 6e67 655f 6f77 6e65 723a 0a20 2020  hange_owner:.   
+000202e0: 2020 2020 2020 2020 2073 7566 6669 7820           suffix 
+000202f0: 3d20 6622 7b63 6861 6e67 655f 6f77 6e65  = f"{change_owne
+00020300: 727d 2773 2063 6f6e 666c 6963 7465 6420  r}'s conflicted 
+00020310: 636f 7079 207b 6461 7465 7d22 0a20 2020  copy {date}".   
+00020320: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00020330: 2020 2020 2020 2073 7566 6669 7820 3d20         suffix = 
+00020340: 6622 636f 6e66 6c69 6374 6564 2063 6f70  f"conflicted cop
+00020350: 7920 7b64 6174 657d 220a 2020 2020 2020  y {date}".      
+00020360: 2020 7265 7475 726e 2067 656e 6572 6174    return generat
+00020370: 655f 6363 5f6e 616d 6528 6c6f 6361 6c5f  e_cc_name(local_
+00020380: 7061 7468 2c20 7375 6666 6978 290a 0a20  path, suffix).. 
+00020390: 2020 2064 6566 205f 6f6e 5f72 656d 6f74     def _on_remot
+000203a0: 655f 6669 6c65 2873 656c 662c 2065 7665  e_file(self, eve
+000203b0: 6e74 3a20 5379 6e63 4576 656e 7429 202d  nt: SyncEvent) -
+000203c0: 3e20 5379 6e63 5374 6174 7573 3a0a 2020  > SyncStatus:.  
+000203d0: 2020 2020 2020 2222 220a 2020 2020 2020        """.      
+000203e0: 2020 4170 706c 6965 7320 6120 7265 6d6f    Applies a remo
+000203f0: 7465 2066 696c 6520 6368 616e 6765 206f  te file change o
+00020400: 7220 6372 6561 7469 6f6e 206c 6f63 616c  r creation local
+00020410: 6c79 2e0a 0a20 2020 2020 2020 203a 7061  ly...        :pa
+00020420: 7261 6d20 6576 656e 743a 2053 796e 6345  ram event: SyncE
+00020430: 7665 6e74 2066 6f72 2066 696c 6520 646f  vent for file do
+00020440: 776e 6c6f 6164 2e0a 2020 2020 2020 2020  wnload..        
+00020450: 3a72 6574 7572 6e73 3a20 5379 6e63 4576  :returns: SyncEv
+00020460: 656e 7420 636f 7272 6573 706f 6e64 696e  ent correspondin
+00020470: 6720 746f 206c 6f63 616c 2069 7465 6d20  g to local item 
+00020480: 6f72 204e 6f6e 6520 6966 206e 6f20 6c6f  or None if no lo
+00020490: 6361 6c20 6368 616e 6765 730a 2020 2020  cal changes.    
+000204a0: 2020 2020 2020 2020 6172 6520 6d61 6465          are made
+000204b0: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+000204c0: 2020 2020 2020 7365 6c66 2e5f 6170 706c        self._appl
+000204d0: 795f 6361 7365 5f63 6861 6e67 6528 6576  y_case_change(ev
+000204e0: 656e 7429 0a0a 2020 2020 2020 2020 2320  ent)..        # 
+000204f0: 5374 6f72 6520 7468 6520 6e65 7720 656e  Store the new en
+00020500: 7472 7920 6174 2074 6865 2067 6976 656e  try at the given
+00020510: 2070 6174 6820 696e 2079 6f75 7220 6c6f   path in your lo
+00020520: 6361 6c20 7374 6174 652e 2049 6620 7468  cal state. If th
+00020530: 6520 7265 7175 6972 6564 0a20 2020 2020  e required.     
+00020540: 2020 2023 2070 6172 656e 7420 666f 6c64     # parent fold
+00020550: 6572 7320 646f 6ee2 8099 7420 6578 6973  ers don...t exis
+00020560: 7420 7965 742c 2063 7265 6174 6520 7468  t yet, create th
+00020570: 656d 2e20 4966 2074 6865 7265 e280 9973  em. If there...s
+00020580: 2061 6c72 6561 6479 2073 6f6d 6574 6869   already somethi
+00020590: 6e67 2065 6c73 650a 2020 2020 2020 2020  ng else.        
+000205a0: 2320 6174 2074 6865 2067 6976 656e 2070  # at the given p
+000205b0: 6174 682c 2072 6570 6c61 6365 2069 7420  ath, replace it 
+000205c0: 616e 6420 7265 6d6f 7665 2061 6c6c 2069  and remove all i
+000205d0: 7473 2063 6869 6c64 7265 6e2e 0a0a 2020  ts children...  
+000205e0: 2020 2020 2020 636f 6e66 6c69 6374 5f63        conflict_c
+000205f0: 6865 636b 203d 2073 656c 662e 5f63 6865  heck = self._che
+00020600: 636b 5f64 6f77 6e6c 6f61 645f 636f 6e66  ck_download_conf
+00020610: 6c69 6374 2865 7665 6e74 290a 0a20 2020  lict(event)..   
+00020620: 2020 2020 2069 6620 636f 6e66 6c69 6374       if conflict
+00020630: 5f63 6865 636b 2069 7320 436f 6e66 6c69  _check is Confli
+00020640: 6374 2e49 6465 6e74 6963 616c 3a0a 2020  ct.Identical:.  
+00020650: 2020 2020 2020 2020 2020 7365 6c66 2e75            self.u
+00020660: 7064 6174 655f 696e 6465 785f 6672 6f6d  pdate_index_from
+00020670: 5f73 796e 635f 6576 656e 7428 6576 656e  _sync_event(even
+00020680: 7429 0a20 2020 2020 2020 2020 2020 2072  t).            r
+00020690: 6574 7572 6e20 5379 6e63 5374 6174 7573  eturn SyncStatus
+000206a0: 2e53 6b69 7070 6564 0a20 2020 2020 2020  .Skipped.       
+000206b0: 2065 6c69 6620 636f 6e66 6c69 6374 5f63   elif conflict_c
+000206c0: 6865 636b 2069 7320 436f 6e66 6c69 6374  heck is Conflict
+000206d0: 2e4c 6f63 616c 4e65 7765 724f 7249 6465  .LocalNewerOrIde
+000206e0: 6e74 6963 616c 3a0a 2020 2020 2020 2020  ntical:.        
+000206f0: 2020 2020 7265 7475 726e 2053 796e 6353      return SyncS
+00020700: 7461 7475 732e 536b 6970 7065 640a 0a20  tatus.Skipped.. 
+00020710: 2020 2020 2020 2023 2045 6e73 7572 6520         # Ensure 
+00020720: 7468 6174 2070 6172 656e 7420 666f 6c64  that parent fold
+00020730: 6572 7320 6172 6520 7379 6e63 6564 2e0a  ers are synced..
+00020740: 2020 2020 2020 2020 7365 6c66 2e5f 656e          self._en
+00020750: 7375 7265 5f70 6172 656e 7428 6576 656e  sure_parent(even
+00020760: 7429 0a0a 2020 2020 2020 2020 6966 2065  t)..        if e
+00020770: 7665 6e74 2e73 796d 6c69 6e6b 5f74 6172  vent.symlink_tar
+00020780: 6765 7420 6973 206e 6f74 204e 6f6e 653a  get is not None:
+00020790: 0a20 2020 2020 2020 2020 2020 2023 2044  .            # D
+000207a0: 6f6e 2774 2064 6f77 6e6c 6f61 6420 6275  on't download bu
+000207b0: 7420 7265 7072 6f64 7563 6520 7379 6d6c  t reproduce syml
+000207c0: 696e 6b20 6c6f 6361 6c6c 792e 0a20 2020  ink locally..   
+000207d0: 2020 2020 2020 2020 2077 6974 6820 7365           with se
+000207e0: 6c66 2e66 735f 6576 656e 7473 2e69 676e  lf.fs_events.ign
+000207f0: 6f72 6528 0a20 2020 2020 2020 2020 2020  ore(.           
+00020800: 2020 2020 2046 696c 6543 7265 6174 6564       FileCreated
+00020810: 4576 656e 7428 6576 656e 742e 6c6f 6361  Event(event.loca
+00020820: 6c5f 7061 7468 292c 2072 6563 7572 7369  l_path), recursi
+00020830: 7665 3d46 616c 7365 0a20 2020 2020 2020  ve=False.       
+00020840: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+00020850: 2020 2020 2020 2020 7769 7468 2063 6f6e          with con
+00020860: 7665 7274 5f61 7069 5f65 7272 6f72 7328  vert_api_errors(
+00020870: 6462 785f 7061 7468 3d65 7665 6e74 2e64  dbx_path=event.d
+00020880: 6278 5f70 6174 6829 3a0a 2020 2020 2020  bx_path):.      
+00020890: 2020 2020 2020 2020 2020 2020 2020 6f73                os
+000208a0: 2e73 796d 6c69 6e6b 2865 7665 6e74 2e73  .symlink(event.s
+000208b0: 796d 6c69 6e6b 5f74 6172 6765 742c 2065  ymlink_target, e
+000208c0: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
+000208d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000208e0: 2020 2020 2073 7461 7420 3d20 6f73 2e6c       stat = os.l
+000208f0: 7374 6174 2865 7665 6e74 2e6c 6f63 616c  stat(event.local
+00020900: 5f70 6174 6829 0a20 2020 2020 2020 2020  _path).         
+00020910: 2020 2073 7461 7475 7320 3d20 5379 6e63     status = Sync
+00020920: 5374 6174 7573 2e44 6f6e 650a 2020 2020  Status.Done.    
+00020930: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00020940: 2020 2020 2020 2320 5765 2064 6f77 6e6c        # We downl
+00020950: 6f61 6420 746f 2061 2074 656d 706f 7261  oad to a tempora
+00020960: 7279 2066 696c 6520 6669 7273 7420 2874  ry file first (t
+00020970: 6869 7320 6d61 7920 7461 6b65 2073 6f6d  his may take som
+00020980: 6520 7469 6d65 292e 0a20 2020 2020 2020  e time)..       
+00020990: 2020 2020 2074 6d70 5f66 6e61 6d65 203d       tmp_fname =
+000209a0: 2073 656c 662e 5f6e 6577 5f74 6d70 5f66   self._new_tmp_f
+000209b0: 696c 6528 290a 0a20 2020 2020 2020 2020  ile()..         
+000209c0: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+000209d0: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+000209e0: 662e 5f70 6172 616c 6c65 6c5f 646f 776e  f._parallel_down
+000209f0: 5f73 656d 6170 686f 7265 3a0a 2020 2020  _semaphore:.    
+00020a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a10: 6d64 203d 2073 656c 662e 636c 6965 6e74  md = self.client
+00020a20: 2e64 6f77 6e6c 6f61 6428 0a20 2020 2020  .download(.     
+00020a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a40: 2020 2066 2272 6576 3a7b 6576 656e 742e     f"rev:{event.
+00020a50: 7265 767d 222c 2074 6d70 5f66 6e61 6d65  rev}", tmp_fname
+00020a60: 2c20 7379 6e63 5f65 7665 6e74 3d65 7665  , sync_event=eve
+00020a70: 6e74 0a20 2020 2020 2020 2020 2020 2020  nt.             
+00020a80: 2020 2020 2020 2029 0a20 2020 2020 2020         ).       
+00020a90: 2020 2020 2020 2020 2065 7665 6e74 203d           event =
+00020aa0: 2053 796e 6345 7665 6e74 2e66 726f 6d5f   SyncEvent.from_
+00020ab0: 6d65 7461 6461 7461 286d 642c 2073 656c  metadata(md, sel
+00020ac0: 6629 0a20 2020 2020 2020 2020 2020 2065  f).            e
+00020ad0: 7863 6570 7420 5379 6e63 4572 726f 7220  xcept SyncError 
+00020ae0: 6173 2065 7272 3a0a 2020 2020 2020 2020  as err:.        
+00020af0: 2020 2020 2020 2020 2320 5265 706c 6163          # Replac
+00020b00: 6520 7265 7620 6e75 6d62 6572 2077 6974  e rev number wit
+00020b10: 6820 7061 7468 2e0a 2020 2020 2020 2020  h path..        
+00020b20: 2020 2020 2020 2020 6572 722e 6462 785f          err.dbx_
+00020b30: 7061 7468 203d 2065 7665 6e74 2e64 6278  path = event.dbx
+00020b40: 5f70 6174 680a 2020 2020 2020 2020 2020  _path.          
+00020b50: 2020 2020 2020 7261 6973 6520 6572 720a        raise err.
+00020b60: 0a20 2020 2020 2020 2020 2020 2023 2052  .            # R
+00020b70: 652d 6368 6563 6b20 666f 7220 636f 6e66  e-check for conf
+00020b80: 6c69 6374 2061 6e64 206d 6f76 6520 7468  lict and move th
+00020b90: 6520 636f 6e66 6c69 6374 0a20 2020 2020  e conflict.     
+00020ba0: 2020 2020 2020 2023 206f 7574 206f 6620         # out of 
+00020bb0: 7468 6520 7761 7920 6966 2061 6e79 7468  the way if anyth
+00020bc0: 696e 6720 6861 7320 6368 616e 6765 642e  ing has changed.
+00020bd0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00020be0: 7365 6c66 2e5f 6368 6563 6b5f 646f 776e  self._check_down
+00020bf0: 6c6f 6164 5f63 6f6e 666c 6963 7428 6576  load_conflict(ev
+00020c00: 656e 7429 203d 3d20 436f 6e66 6c69 6374  ent) == Conflict
+00020c10: 2e43 6f6e 666c 6963 743a 0a20 2020 2020  .Conflict:.     
+00020c20: 2020 2020 2020 2020 2020 2063 635f 6c6f             cc_lo
+00020c30: 6361 6c5f 7061 7468 203d 2073 656c 662e  cal_path = self.
+00020c40: 5f6c 6f63 616c 5f63 635f 6669 6c65 6e61  _local_cc_filena
+00020c50: 6d65 280a 2020 2020 2020 2020 2020 2020  me(.            
+00020c60: 2020 2020 2020 2020 6576 656e 742e 6c6f          event.lo
+00020c70: 6361 6c5f 7061 7468 2c20 6576 656e 742e  cal_path, event.
+00020c80: 6368 616e 6765 5f64 6269 640a 2020 2020  change_dbid.    
+00020c90: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00020ca0: 2020 2020 2020 2020 2020 2020 2020 6576                ev
+00020cb0: 656e 745f 636c 7320 3d20 4469 724d 6f76  ent_cls = DirMov
+00020cc0: 6564 4576 656e 7420 6966 2069 7364 6972  edEvent if isdir
+00020cd0: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
+00020ce0: 6829 2065 6c73 6520 4669 6c65 4d6f 7665  h) else FileMove
+00020cf0: 6445 7665 6e74 0a20 2020 2020 2020 2020  dEvent.         
+00020d00: 2020 2020 2020 2077 6974 6820 7365 6c66         with self
+00020d10: 2e66 735f 6576 656e 7473 2e69 676e 6f72  .fs_events.ignor
+00020d20: 6528 6576 656e 745f 636c 7328 6576 656e  e(event_cls(even
+00020d30: 742e 6c6f 6361 6c5f 7061 7468 2c20 6363  t.local_path, cc
+00020d40: 5f6c 6f63 616c 5f70 6174 6829 293a 0a20  _local_path)):. 
+00020d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020d60: 2020 2077 6974 6820 636f 6e76 6572 745f     with convert_
+00020d70: 6170 695f 6572 726f 7273 2829 3a0a 2020  api_errors():.  
+00020d80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020d90: 2020 2020 2020 6d6f 7665 2865 7665 6e74        move(event
+00020da0: 2e6c 6f63 616c 5f70 6174 682c 2063 635f  .local_path, cc_
+00020db0: 6c6f 6361 6c5f 7061 7468 2c20 7261 6973  local_path, rais
+00020dc0: 655f 6572 726f 723d 5472 7565 290a 0a20  e_error=True).. 
+00020dd0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00020de0: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
+00020df0: 6728 0a20 2020 2020 2020 2020 2020 2020  g(.             
+00020e00: 2020 2020 2020 2027 446f 776e 6c6f 6164         'Download
+00020e10: 2063 6f6e 666c 6963 743a 2072 656e 616d   conflict: renam
+00020e20: 6564 2022 2573 2220 746f 2022 2573 2227  ed "%s" to "%s"'
+00020e30: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00020e40: 2020 2020 2020 6576 656e 742e 6c6f 6361        event.loca
+00020e50: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
+00020e60: 2020 2020 2020 2020 2020 2020 6363 5f6c              cc_l
+00020e70: 6f63 616c 5f70 6174 682c 0a20 2020 2020  ocal_path,.     
+00020e80: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00020e90: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00020ea0: 662e 7265 7363 616e 2863 635f 6c6f 6361  f.rescan(cc_loca
+00020eb0: 6c5f 7061 7468 290a 2020 2020 2020 2020  l_path).        
+00020ec0: 2020 2020 2020 2020 7374 6174 7573 203d          status =
+00020ed0: 2053 796e 6353 7461 7475 732e 436f 6e66   SyncStatus.Conf
+00020ee0: 6c69 6374 0a20 2020 2020 2020 2020 2020  lict.           
+00020ef0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00020f00: 2020 2020 2020 2073 7461 7475 7320 3d20         status = 
+00020f10: 5379 6e63 5374 6174 7573 2e44 6f6e 650a  SyncStatus.Done.
+00020f20: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00020f30: 6973 6469 7228 6576 656e 742e 6c6f 6361  isdir(event.loca
+00020f40: 6c5f 7061 7468 293a 0a20 2020 2020 2020  l_path):.       
+00020f50: 2020 2020 2020 2020 2077 6974 6820 7365           with se
+00020f60: 6c66 2e66 735f 6576 656e 7473 2e69 676e  lf.fs_events.ign
+00020f70: 6f72 6528 4469 7244 656c 6574 6564 4576  ore(DirDeletedEv
+00020f80: 656e 7428 6576 656e 742e 6c6f 6361 6c5f  ent(event.local_
+00020f90: 7061 7468 2929 3a0a 2020 2020 2020 2020  path)):.        
+00020fa0: 2020 2020 2020 2020 2020 2020 6465 6c65              dele
+00020fb0: 7465 280a 2020 2020 2020 2020 2020 2020  te(.            
+00020fc0: 2020 2020 2020 2020 2020 2020 6576 656e              even
+00020fd0: 742e 6c6f 6361 6c5f 7061 7468 2c0a 2020  t.local_path,.  
+00020fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020ff0: 2020 2020 2020 666f 7263 655f 6361 7365        force_case
+00021000: 5f73 656e 7369 7469 7665 3d6e 6f74 2073  _sensitive=not s
+00021010: 656c 662e 6973 5f66 735f 6361 7365 5f73  elf.is_fs_case_s
+00021020: 656e 7369 7469 7665 2c0a 2020 2020 2020  ensitive,.      
+00021030: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00021040: 0a20 2020 2020 2020 2020 2020 2069 676e  .            ign
+00021050: 6f72 655f 6576 656e 7473 3a20 6c69 7374  ore_events: list
+00021060: 5b46 696c 6553 7973 7465 6d45 7665 6e74  [FileSystemEvent
+00021070: 5d20 3d20 5b0a 2020 2020 2020 2020 2020  ] = [.          
+00021080: 2020 2020 2020 4669 6c65 4d6f 7665 6445        FileMovedE
+00021090: 7665 6e74 2874 6d70 5f66 6e61 6d65 2c20  vent(tmp_fname, 
+000210a0: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+000210b0: 290a 2020 2020 2020 2020 2020 2020 5d0a  ).            ].
+000210c0: 0a20 2020 2020 2020 2020 2020 2023 2050  .            # P
+000210d0: 7265 7365 7276 6520 7065 726d 6973 7369  reserve permissi
+000210e0: 6f6e 7320 6f66 2074 6865 2064 6573 7469  ons of the desti
+000210f0: 6e61 7469 6f6e 2066 696c 6520 6966 2077  nation file if w
+00021100: 6520 6172 6520 6f6e 6c79 2073 796e 6369  e are only synci
+00021110: 6e67 2061 6e0a 2020 2020 2020 2020 2020  ng an.          
+00021120: 2020 2320 7570 6461 7465 2074 6f20 7468    # update to th
+00021130: 6520 6669 6c65 2063 6f6e 7465 6e74 2028  e file content (
+00021140: 4472 6f70 626f 7820 4944 206f 6620 7468  Dropbox ID of th
+00021150: 6520 6669 6c65 2072 656d 6169 6e73 2074  e file remains t
+00021160: 6865 2073 616d 6529 2e0a 2020 2020 2020  he same)..      
+00021170: 2020 2020 2020 6f6c 645f 656e 7472 7920        old_entry 
+00021180: 3d20 7365 6c66 2e67 6574 5f69 6e64 6578  = self.get_index
+00021190: 5f65 6e74 7279 2865 7665 6e74 2e64 6278  _entry(event.dbx
+000211a0: 5f70 6174 685f 6c6f 7765 7229 0a20 2020  _path_lower).   
+000211b0: 2020 2020 2020 2020 2070 7265 7365 7276           preserv
+000211c0: 655f 7065 726d 6973 7369 6f6e 7320 3d20  e_permissions = 
+000211d0: 626f 6f6c 286f 6c64 5f65 6e74 7279 2061  bool(old_entry a
+000211e0: 6e64 2065 7665 6e74 2e64 6278 5f69 6420  nd event.dbx_id 
+000211f0: 3d3d 206f 6c64 5f65 6e74 7279 2e64 6278  == old_entry.dbx
+00021200: 5f69 6429 0a0a 2020 2020 2020 2020 2020  _id)..          
+00021210: 2020 6966 2070 7265 7365 7276 655f 7065    if preserve_pe
+00021220: 726d 6973 7369 6f6e 733a 0a20 2020 2020  rmissions:.     
+00021230: 2020 2020 2020 2020 2020 2023 2049 676e             # Ign
+00021240: 6f72 6520 4669 6c65 4d6f 6469 6669 6564  ore FileModified
+00021250: 4576 656e 7420 7768 656e 2063 6861 6e67  Event when chang
+00021260: 696e 6720 7065 726d 6973 7369 6f6e 732e  ing permissions.
+00021270: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021280: 2023 204e 6f74 6520 7468 6174 2074 776f   # Note that two
+00021290: 2046 696c 654d 6f64 6966 6965 6445 7665   FileModifiedEve
+000212a0: 6e74 7320 6d61 7920 6265 2065 6d69 7474  nts may be emitt
+000212b0: 6564 206f 6e20 6d61 634f 532e 0a20 2020  ed on macOS..   
+000212c0: 2020 2020 2020 2020 2020 2020 2069 676e               ign
+000212d0: 6f72 655f 6576 656e 7473 2e61 7070 656e  ore_events.appen
+000212e0: 6428 4669 6c65 4d6f 6469 6669 6564 4576  d(FileModifiedEv
+000212f0: 656e 7428 6576 656e 742e 6c6f 6361 6c5f  ent(event.local_
+00021300: 7061 7468 2929 0a20 2020 2020 2020 2020  path)).         
+00021310: 2020 2020 2020 2069 6620 4953 5f4d 4143         if IS_MAC
+00021320: 4f53 3a0a 2020 2020 2020 2020 2020 2020  OS:.            
+00021330: 2020 2020 2020 2020 6967 6e6f 7265 5f65          ignore_e
+00021340: 7665 6e74 732e 6170 7065 6e64 2846 696c  vents.append(Fil
+00021350: 654d 6f64 6966 6965 6445 7665 6e74 2865  eModifiedEvent(e
+00021360: 7665 6e74 2e6c 6f63 616c 5f70 6174 6829  vent.local_path)
+00021370: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+00021380: 6620 6973 6669 6c65 2865 7665 6e74 2e6c  f isfile(event.l
+00021390: 6f63 616c 5f70 6174 6829 3a0a 2020 2020  ocal_path):.    
+000213a0: 2020 2020 2020 2020 2020 2020 2320 4967              # Ig
+000213b0: 6e6f 7265 2046 696c 6544 656c 6574 6564  nore FileDeleted
+000213c0: 4576 656e 7420 7768 656e 2072 6570 6c61  Event when repla
+000213d0: 6369 6e67 206f 6c64 2066 696c 652e 0a20  cing old file.. 
+000213e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000213f0: 676e 6f72 655f 6576 656e 7473 2e61 7070  gnore_events.app
+00021400: 656e 6428 4669 6c65 4465 6c65 7465 6445  end(FileDeletedE
+00021410: 7665 6e74 2865 7665 6e74 2e6c 6f63 616c  vent(event.local
+00021420: 5f70 6174 6829 290a 0a20 2020 2020 2020  _path))..       
+00021430: 2020 2020 2023 204d 6f76 6520 7468 6520       # Move the 
+00021440: 646f 776e 6c6f 6164 6564 2066 696c 6520  downloaded file 
+00021450: 746f 2069 7473 2064 6573 7469 6e61 7469  to its destinati
+00021460: 6f6e 2e0a 2020 2020 2020 2020 2020 2020  on..            
+00021470: 7769 7468 2073 656c 662e 6673 5f65 7665  with self.fs_eve
+00021480: 6e74 732e 6967 6e6f 7265 282a 6967 6e6f  nts.ignore(*igno
+00021490: 7265 5f65 7665 6e74 732c 2072 6563 7572  re_events, recur
+000214a0: 7369 7665 3d46 616c 7365 293a 0a20 2020  sive=False):.   
+000214b0: 2020 2020 2020 2020 2020 2020 2077 6974               wit
+000214c0: 6820 636f 6e76 6572 745f 6170 695f 6572  h convert_api_er
+000214d0: 726f 7273 280a 2020 2020 2020 2020 2020  rors(.          
+000214e0: 2020 2020 2020 2020 2020 6462 785f 7061            dbx_pa
+000214f0: 7468 3d65 7665 6e74 2e64 6278 5f70 6174  th=event.dbx_pat
+00021500: 682c 206c 6f63 616c 5f70 6174 683d 6576  h, local_path=ev
+00021510: 656e 742e 6c6f 6361 6c5f 7061 7468 0a20  ent.local_path. 
+00021520: 2020 2020 2020 2020 2020 2020 2020 2029                 )
+00021530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00021540: 2020 2020 2020 7374 6174 203d 206f 732e        stat = os.
+00021550: 6c73 7461 7428 746d 705f 666e 616d 6529  lstat(tmp_fname)
+00021560: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021570: 2020 2020 206d 6f76 6528 0a20 2020 2020       move(.     
+00021580: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021590: 2020 2074 6d70 5f66 6e61 6d65 2c0a 2020     tmp_fname,.  
+000215a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215b0: 2020 2020 2020 6576 656e 742e 6c6f 6361        event.loca
+000215c0: 6c5f 7061 7468 2c0a 2020 2020 2020 2020  l_path,.        
+000215d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000215e0: 7072 6573 6572 7665 5f64 6573 745f 7065  preserve_dest_pe
+000215f0: 726d 6973 7369 6f6e 733d 7072 6573 6572  rmissions=preser
+00021600: 7665 5f70 6572 6d69 7373 696f 6e73 2c0a  ve_permissions,.
+00021610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021620: 2020 2020 2020 2020 7261 6973 655f 6572          raise_er
+00021630: 726f 723d 5472 7565 2c0a 2020 2020 2020  ror=True,.      
+00021640: 2020 2020 2020 2020 2020 2020 2020 290a                ).
+00021650: 0a20 2020 2020 2020 2073 656c 662e 7570  .        self.up
+00021660: 6461 7465 5f69 6e64 6578 5f66 726f 6d5f  date_index_from_
+00021670: 7379 6e63 5f65 7665 6e74 2865 7665 6e74  sync_event(event
+00021680: 290a 2020 2020 2020 2020 7365 6c66 2e5f  ).        self._
+00021690: 7361 7665 5f6c 6f63 616c 5f68 6173 6828  save_local_hash(
+000216a0: 0a20 2020 2020 2020 2020 2020 2073 7461  .            sta
+000216b0: 742e 7374 5f69 6e6f 2c20 6576 656e 742e  t.st_ino, event.
+000216c0: 6c6f 6361 6c5f 7061 7468 2c20 6576 656e  local_path, even
+000216d0: 742e 636f 6e74 656e 745f 6861 7368 2c20  t.content_hash, 
+000216e0: 7374 6174 2e73 745f 6d74 696d 650a 2020  stat.st_mtime.  
+000216f0: 2020 2020 2020 290a 0a20 2020 2020 2020        )..       
+00021700: 2073 656c 662e 5f6c 6f67 6765 722e 6465   self._logger.de
+00021710: 6275 6728 2743 7265 6174 6564 206c 6f63  bug('Created loc
+00021720: 616c 2066 696c 6520 2225 7322 272c 2065  al file "%s"', e
+00021730: 7665 6e74 2e64 6278 5f70 6174 6829 0a0a  vent.dbx_path)..
+00021740: 2020 2020 2020 2020 7265 7475 726e 2073          return s
+00021750: 7461 7475 730a 0a20 2020 2064 6566 205f  tatus..    def _
+00021760: 6f6e 5f72 656d 6f74 655f 666f 6c64 6572  on_remote_folder
+00021770: 2873 656c 662c 2065 7665 6e74 3a20 5379  (self, event: Sy
+00021780: 6e63 4576 656e 7429 202d 3e20 5379 6e63  ncEvent) -> Sync
+00021790: 5374 6174 7573 3a0a 2020 2020 2020 2020  Status:.        
+000217a0: 2222 220a 2020 2020 2020 2020 4170 706c  """.        Appl
+000217b0: 6965 7320 6120 7265 6d6f 7465 2066 6f6c  ies a remote fol
+000217c0: 6465 7220 6372 6561 7469 6f6e 206c 6f63  der creation loc
+000217d0: 616c 6c79 2e0a 0a20 2020 2020 2020 203a  ally...        :
+000217e0: 7061 7261 6d20 6576 656e 743a 2053 796e  param event: Syn
+000217f0: 6345 7665 6e74 2066 6f72 2066 6f6c 6465  cEvent for folde
+00021800: 7220 646f 776e 6c6f 6164 2e0a 2020 2020  r download..    
+00021810: 2020 2020 3a72 6574 7572 6e73 3a20 5379      :returns: Sy
+00021820: 6e63 4576 656e 7420 636f 7272 6573 706f  ncEvent correspo
+00021830: 6e64 696e 6720 746f 206c 6f63 616c 2069  nding to local i
+00021840: 7465 6d20 6f72 204e 6f6e 6520 6966 206e  tem or None if n
+00021850: 6f20 6c6f 6361 6c20 6368 616e 6765 730a  o local changes.
+00021860: 2020 2020 2020 2020 2020 2020 6172 6520              are 
+00021870: 6d61 6465 2e0a 2020 2020 2020 2020 2222  made..        ""
+00021880: 220a 2020 2020 2020 2020 7365 6c66 2e5f  ".        self._
+00021890: 6170 706c 795f 6361 7365 5f63 6861 6e67  apply_case_chang
+000218a0: 6528 6576 656e 7429 0a0a 2020 2020 2020  e(event)..      
+000218b0: 2020 2320 5374 6f72 6520 7468 6520 6e65    # Store the ne
+000218c0: 7720 656e 7472 7920 6174 2074 6865 2067  w entry at the g
+000218d0: 6976 656e 2070 6174 6820 696e 2079 6f75  iven path in you
+000218e0: 7220 6c6f 6361 6c20 7374 6174 652e 2049  r local state. I
+000218f0: 6620 7468 6520 7265 7175 6972 6564 0a20  f the required. 
+00021900: 2020 2020 2020 2023 2070 6172 656e 7420         # parent 
+00021910: 666f 6c64 6572 7320 646f 6ee2 8099 7420  folders don...t 
+00021920: 6578 6973 7420 7965 742c 2063 7265 6174  exist yet, creat
+00021930: 6520 7468 656d 2e20 4966 2074 6865 7265  e them. If there
+00021940: e280 9973 2061 6c72 6561 6479 2073 6f6d  ...s already som
+00021950: 6574 6869 6e67 2065 6c73 650a 2020 2020  ething else.    
+00021960: 2020 2020 2320 6174 2074 6865 2067 6976      # at the giv
+00021970: 656e 2070 6174 682c 2072 6570 6c61 6365  en path, replace
+00021980: 2069 7420 6275 7420 6c65 6176 6520 7468   it but leave th
+00021990: 6520 6368 696c 6472 656e 2061 7320 7468  e children as th
+000219a0: 6579 2061 7265 2e0a 0a20 2020 2020 2020  ey are...       
+000219b0: 2063 6f6e 666c 6963 745f 6368 6563 6b20   conflict_check 
+000219c0: 3d20 7365 6c66 2e5f 6368 6563 6b5f 646f  = self._check_do
+000219d0: 776e 6c6f 6164 5f63 6f6e 666c 6963 7428  wnload_conflict(
+000219e0: 6576 656e 7429 0a0a 2020 2020 2020 2020  event)..        
+000219f0: 6966 2063 6f6e 666c 6963 745f 6368 6563  if conflict_chec
+00021a00: 6b20 6973 2043 6f6e 666c 6963 742e 4964  k is Conflict.Id
+00021a10: 656e 7469 6361 6c3a 0a20 2020 2020 2020  entical:.       
+00021a20: 2020 2020 2073 656c 662e 7570 6461 7465       self.update
+00021a30: 5f69 6e64 6578 5f66 726f 6d5f 7379 6e63  _index_from_sync
+00021a40: 5f65 7665 6e74 2865 7665 6e74 290a 2020  _event(event).  
+00021a50: 2020 2020 2020 2020 2020 7265 7475 726e            return
+00021a60: 2053 796e 6353 7461 7475 732e 536b 6970   SyncStatus.Skip
+00021a70: 7065 640a 2020 2020 2020 2020 656c 6966  ped.        elif
+00021a80: 2063 6f6e 666c 6963 745f 6368 6563 6b20   conflict_check 
+00021a90: 6973 2043 6f6e 666c 6963 742e 4c6f 6361  is Conflict.Loca
+00021aa0: 6c4e 6577 6572 4f72 4964 656e 7469 6361  lNewerOrIdentica
+00021ab0: 6c3a 0a20 2020 2020 2020 2020 2020 2072  l:.            r
+00021ac0: 6574 7572 6e20 5379 6e63 5374 6174 7573  eturn SyncStatus
+00021ad0: 2e53 6b69 7070 6564 0a0a 2020 2020 2020  .Skipped..      
+00021ae0: 2020 6966 2063 6f6e 666c 6963 745f 6368    if conflict_ch
+00021af0: 6563 6b20 3d3d 2043 6f6e 666c 6963 742e  eck == Conflict.
+00021b00: 436f 6e66 6c69 6374 3a0a 2020 2020 2020  Conflict:.      
+00021b10: 2020 2020 2020 6363 5f6c 6f63 616c 5f70        cc_local_p
+00021b20: 6174 6820 3d20 7365 6c66 2e5f 6c6f 6361  ath = self._loca
+00021b30: 6c5f 6363 5f66 696c 656e 616d 6528 6576  l_cc_filename(ev
+00021b40: 656e 742e 6c6f 6361 6c5f 7061 7468 2c20  ent.local_path, 
+00021b50: 6576 656e 742e 6368 616e 6765 5f64 6269  event.change_dbi
+00021b60: 6429 0a20 2020 2020 2020 2020 2020 2065  d).            e
+00021b70: 7665 6e74 5f63 6c73 203d 2044 6972 4d6f  vent_cls = DirMo
+00021b80: 7665 6445 7665 6e74 2069 6620 6973 6469  vedEvent if isdi
+00021b90: 7228 6576 656e 742e 6c6f 6361 6c5f 7061  r(event.local_pa
+00021ba0: 7468 2920 656c 7365 2046 696c 654d 6f76  th) else FileMov
+00021bb0: 6564 4576 656e 740a 2020 2020 2020 2020  edEvent.        
+00021bc0: 2020 2020 7769 7468 2073 656c 662e 6673      with self.fs
+00021bd0: 5f65 7665 6e74 732e 6967 6e6f 7265 2865  _events.ignore(e
+00021be0: 7665 6e74 5f63 6c73 2865 7665 6e74 2e6c  vent_cls(event.l
+00021bf0: 6f63 616c 5f70 6174 682c 2063 635f 6c6f  ocal_path, cc_lo
+00021c00: 6361 6c5f 7061 7468 2929 3a0a 2020 2020  cal_path)):.    
+00021c10: 2020 2020 2020 2020 2020 2020 7769 7468              with
+00021c20: 2063 6f6e 7665 7274 5f61 7069 5f65 7272   convert_api_err
+00021c30: 6f72 7328 293a 0a20 2020 2020 2020 2020  ors():.         
+00021c40: 2020 2020 2020 2020 2020 206d 6f76 6528             move(
+00021c50: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+00021c60: 2c20 6363 5f6c 6f63 616c 5f70 6174 682c  , cc_local_path,
+00021c70: 2072 6169 7365 5f65 7272 6f72 3d54 7275   raise_error=Tru
+00021c80: 6529 0a0a 2020 2020 2020 2020 2020 2020  e)..            
+00021c90: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+00021ca0: 7567 280a 2020 2020 2020 2020 2020 2020  ug(.            
+00021cb0: 2020 2020 2744 6f77 6e6c 6f61 6420 636f      'Download co
+00021cc0: 6e66 6c69 6374 3a20 7265 6e61 6d65 6420  nflict: renamed 
+00021cd0: 2225 7322 2074 6f20 2225 7322 272c 0a20  "%s" to "%s"',. 
+00021ce0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00021cf0: 7665 6e74 2e6c 6f63 616c 5f70 6174 682c  vent.local_path,
+00021d00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021d10: 2063 635f 6c6f 6361 6c5f 7061 7468 2c0a   cc_local_path,.
+00021d20: 2020 2020 2020 2020 2020 2020 290a 2020              ).  
+00021d30: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
+00021d40: 6573 6361 6e28 6363 5f6c 6f63 616c 5f70  escan(cc_local_p
+00021d50: 6174 6829 0a20 2020 2020 2020 2020 2020  ath).           
+00021d60: 2073 7461 7475 7320 3d20 5379 6e63 5374   status = SyncSt
+00021d70: 6174 7573 2e43 6f6e 666c 6963 740a 2020  atus.Conflict.  
+00021d80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00021d90: 2020 2020 2020 2020 7374 6174 7573 203d          status =
+00021da0: 2053 796e 6353 7461 7475 732e 446f 6e65   SyncStatus.Done
+00021db0: 0a0a 2020 2020 2020 2020 2320 456e 7375  ..        # Ensu
+00021dc0: 7265 2074 6861 7420 7061 7265 6e74 2066  re that parent f
+00021dd0: 6f6c 6465 7273 2061 7265 2073 796e 6365  olders are synce
+00021de0: 642e 0a20 2020 2020 2020 2073 656c 662e  d..        self.
+00021df0: 5f65 6e73 7572 655f 7061 7265 6e74 2865  _ensure_parent(e
+00021e00: 7665 6e74 290a 0a20 2020 2020 2020 2069  vent)..        i
+00021e10: 6620 6973 6669 6c65 2865 7665 6e74 2e6c  f isfile(event.l
+00021e20: 6f63 616c 5f70 6174 6829 3a0a 2020 2020  ocal_path):.    
+00021e30: 2020 2020 2020 2020 7769 7468 2073 656c          with sel
+00021e40: 662e 6673 5f65 7665 6e74 732e 6967 6e6f  f.fs_events.igno
+00021e50: 7265 280a 2020 2020 2020 2020 2020 2020  re(.            
+00021e60: 2020 2020 4669 6c65 4d6f 6469 6669 6564      FileModified
+00021e70: 4576 656e 7428 6576 656e 742e 6c6f 6361  Event(event.loca
+00021e80: 6c5f 7061 7468 292c 2020 2320 4d61 7920  l_path),  # May 
+00021e90: 6265 2065 6d69 7474 6564 206f 6e20 6d61  be emitted on ma
+00021ea0: 634f 532e 0a20 2020 2020 2020 2020 2020  cOS..           
+00021eb0: 2020 2020 2046 696c 6544 656c 6574 6564       FileDeleted
+00021ec0: 4576 656e 7428 6576 656e 742e 6c6f 6361  Event(event.loca
+00021ed0: 6c5f 7061 7468 292c 0a20 2020 2020 2020  l_path),.       
+00021ee0: 2020 2020 2029 3a0a 2020 2020 2020 2020       ):.        
+00021ef0: 2020 2020 2020 2020 6465 6c65 7465 280a          delete(.
+00021f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021f10: 2020 2020 6576 656e 742e 6c6f 6361 6c5f      event.local_
+00021f20: 7061 7468 2c20 666f 7263 655f 6361 7365  path, force_case
+00021f30: 5f73 656e 7369 7469 7665 3d6e 6f74 2073  _sensitive=not s
+00021f40: 656c 662e 6973 5f66 735f 6361 7365 5f73  elf.is_fs_case_s
+00021f50: 656e 7369 7469 7665 0a20 2020 2020 2020  ensitive.       
+00021f60: 2020 2020 2020 2020 2029 0a0a 2020 2020           )..    
+00021f70: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00021f80: 2020 2020 2077 6974 6820 7365 6c66 2e66       with self.f
+00021f90: 735f 6576 656e 7473 2e69 676e 6f72 6528  s_events.ignore(
+00021fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00021fb0: 2044 6972 4372 6561 7465 6445 7665 6e74   DirCreatedEvent
+00021fc0: 2865 7665 6e74 2e6c 6f63 616c 5f70 6174  (event.local_pat
+00021fd0: 6829 2c20 7265 6375 7273 6976 653d 4661  h), recursive=Fa
+00021fe0: 6c73 650a 2020 2020 2020 2020 2020 2020  lse.            
+00021ff0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+00022000: 2020 206f 732e 6d6b 6469 7228 6576 656e     os.mkdir(even
+00022010: 742e 6c6f 6361 6c5f 7061 7468 290a 2020  t.local_path).  
+00022020: 2020 2020 2020 6578 6365 7074 2046 696c        except Fil
+00022030: 6545 7869 7374 7345 7272 6f72 3a0a 2020  eExistsError:.  
+00022040: 2020 2020 2020 2020 2020 7374 6174 7573            status
+00022050: 203d 2053 796e 6353 7461 7475 732e 536b   = SyncStatus.Sk
+00022060: 6970 7065 640a 2020 2020 2020 2020 6578  ipped.        ex
+00022070: 6365 7074 204f 5345 7272 6f72 2061 7320  cept OSError as 
+00022080: 6572 723a 0a20 2020 2020 2020 2020 2020  err:.           
+00022090: 2073 656c 662e 656e 7375 7265 5f64 726f   self.ensure_dro
+000220a0: 7062 6f78 5f66 6f6c 6465 725f 7072 6573  pbox_folder_pres
+000220b0: 656e 7428 290a 2020 2020 2020 2020 2020  ent().          
+000220c0: 2020 7261 6973 6520 6f73 5f74 6f5f 6d61    raise os_to_ma
+000220d0: 6573 7472 616c 5f65 7272 6f72 2865 7272  estral_error(err
+000220e0: 2c20 6462 785f 7061 7468 3d65 7665 6e74  , dbx_path=event
+000220f0: 2e64 6278 5f70 6174 6829 0a0a 2020 2020  .dbx_path)..    
+00022100: 2020 2020 7365 6c66 2e75 7064 6174 655f      self.update_
+00022110: 696e 6465 785f 6672 6f6d 5f73 796e 635f  index_from_sync_
+00022120: 6576 656e 7428 6576 656e 7429 0a0a 2020  event(event)..  
+00022130: 2020 2020 2020 7365 6c66 2e5f 6c6f 6767        self._logg
+00022140: 6572 2e64 6562 7567 2827 4372 6561 7465  er.debug('Create
+00022150: 6420 6c6f 6361 6c20 666f 6c64 6572 2022  d local folder "
+00022160: 2573 2227 2c20 6576 656e 742e 6462 785f  %s"', event.dbx_
+00022170: 7061 7468 290a 0a20 2020 2020 2020 2072  path)..        r
+00022180: 6574 7572 6e20 7374 6174 7573 0a0a 2020  eturn status..  
+00022190: 2020 6465 6620 5f6f 6e5f 7265 6d6f 7465    def _on_remote
+000221a0: 5f64 656c 6574 6564 2873 656c 662c 2065  _deleted(self, e
+000221b0: 7665 6e74 3a20 5379 6e63 4576 656e 7429  vent: SyncEvent)
+000221c0: 202d 3e20 5379 6e63 5374 6174 7573 3a0a   -> SyncStatus:.
+000221d0: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+000221e0: 2020 2020 4170 706c 6965 7320 6120 7265      Applies a re
+000221f0: 6d6f 7465 2064 656c 6574 696f 6e20 6c6f  mote deletion lo
+00022200: 6361 6c6c 792e 0a0a 2020 2020 2020 2020  cally...        
+00022210: 3a70 6172 616d 2065 7665 6e74 3a20 4472  :param event: Dr
+00022220: 6f70 626f 7820 6465 6c65 7465 6420 6d65  opbox deleted me
+00022230: 7461 6461 7461 2e0a 2020 2020 2020 2020  tadata..        
+00022240: 3a72 6574 7572 6e73 3a20 5379 6e63 4576  :returns: SyncEv
+00022250: 656e 7420 636f 7272 6573 706f 6e64 696e  ent correspondin
+00022260: 6720 746f 206c 6f63 616c 2064 656c 6574  g to local delet
+00022270: 696f 6e20 6f72 204e 6f6e 6520 6966 206e  ion or None if n
+00022280: 6f20 6c6f 6361 6c20 6368 616e 6765 730a  o local changes.
+00022290: 2020 2020 2020 2020 2020 2020 6172 6520              are 
+000222a0: 6d61 6465 2e0a 2020 2020 2020 2020 2222  made..        ""
+000222b0: 220a 2020 2020 2020 2020 7365 6c66 2e5f  ".        self._
+000222c0: 6170 706c 795f 6361 7365 5f63 6861 6e67  apply_case_chang
+000222d0: 6528 6576 656e 7429 0a0a 2020 2020 2020  e(event)..      
+000222e0: 2020 2320 4966 2079 6f75 7220 6c6f 6361    # If your loca
+000222f0: 6c20 7374 6174 6520 6861 7320 736f 6d65  l state has some
+00022300: 7468 696e 6720 6174 2074 6865 2067 6976  thing at the giv
+00022310: 656e 2070 6174 682c 2072 656d 6f76 6520  en path, remove 
+00022320: 6974 2061 6e64 2061 6c6c 2069 7473 0a20  it and all its. 
+00022330: 2020 2020 2020 2023 2063 6869 6c64 7265         # childre
+00022340: 6e2e 2049 6620 7468 6572 65e2 8099 7320  n. If there...s 
+00022350: 6e6f 7468 696e 6720 6174 2074 6865 2067  nothing at the g
+00022360: 6976 656e 2070 6174 682c 2069 676e 6f72  iven path, ignor
+00022370: 6520 7468 6973 2065 6e74 7279 2e0a 0a20  e this entry... 
+00022380: 2020 2020 2020 2063 6f6e 666c 6963 745f         conflict_
+00022390: 6368 6563 6b20 3d20 7365 6c66 2e5f 6368  check = self._ch
+000223a0: 6563 6b5f 646f 776e 6c6f 6164 5f63 6f6e  eck_download_con
+000223b0: 666c 6963 7428 6576 656e 7429 0a0a 2020  flict(event)..  
+000223c0: 2020 2020 2020 6966 2063 6f6e 666c 6963        if conflic
+000223d0: 745f 6368 6563 6b20 6973 2043 6f6e 666c  t_check is Confl
+000223e0: 6963 742e 4964 656e 7469 6361 6c3a 0a20  ict.Identical:. 
+000223f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00022400: 7570 6461 7465 5f69 6e64 6578 5f66 726f  update_index_fro
+00022410: 6d5f 7379 6e63 5f65 7665 6e74 2865 7665  m_sync_event(eve
+00022420: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
+00022430: 7265 7475 726e 2053 796e 6353 7461 7475  return SyncStatu
+00022440: 732e 536b 6970 7065 640a 2020 2020 2020  s.Skipped.      
+00022450: 2020 656c 6966 2063 6f6e 666c 6963 745f    elif conflict_
+00022460: 6368 6563 6b20 6973 2043 6f6e 666c 6963  check is Conflic
+00022470: 742e 4c6f 6361 6c4e 6577 6572 4f72 4964  t.LocalNewerOrId
+00022480: 656e 7469 6361 6c3a 0a20 2020 2020 2020  entical:.       
+00022490: 2020 2020 2072 6574 7572 6e20 5379 6e63       return Sync
+000224a0: 5374 6174 7573 2e53 6b69 7070 6564 0a0a  Status.Skipped..
+000224b0: 2020 2020 2020 2020 6576 656e 745f 636c          event_cl
+000224c0: 7320 3d20 4469 7244 656c 6574 6564 4576  s = DirDeletedEv
+000224d0: 656e 7420 6966 2069 7364 6972 2865 7665  ent if isdir(eve
+000224e0: 6e74 2e6c 6f63 616c 5f70 6174 6829 2065  nt.local_path) e
+000224f0: 6c73 6520 4669 6c65 4465 6c65 7465 6445  lse FileDeletedE
+00022500: 7665 6e74 0a20 2020 2020 2020 2077 6974  vent.        wit
+00022510: 6820 7365 6c66 2e66 735f 6576 656e 7473  h self.fs_events
+00022520: 2e69 676e 6f72 6528 6576 656e 745f 636c  .ignore(event_cl
+00022530: 7328 6576 656e 742e 6c6f 6361 6c5f 7061  s(event.local_pa
+00022540: 7468 2929 3a0a 2020 2020 2020 2020 2020  th)):.          
+00022550: 2020 6578 6320 3d20 6465 6c65 7465 280a    exc = delete(.
+00022560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022570: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+00022580: 2c20 666f 7263 655f 6361 7365 5f73 656e  , force_case_sen
+00022590: 7369 7469 7665 3d6e 6f74 2073 656c 662e  sitive=not self.
+000225a0: 6973 5f66 735f 6361 7365 5f73 656e 7369  is_fs_case_sensi
+000225b0: 7469 7665 0a20 2020 2020 2020 2020 2020  tive.           
+000225c0: 2029 0a0a 2020 2020 2020 2020 6966 206e   )..        if n
+000225d0: 6f74 2065 7863 3a0a 2020 2020 2020 2020  ot exc:.        
+000225e0: 2020 2020 7365 6c66 2e75 7064 6174 655f      self.update_
+000225f0: 696e 6465 785f 6672 6f6d 5f73 796e 635f  index_from_sync_
+00022600: 6576 656e 7428 6576 656e 7429 0a20 2020  event(event).   
+00022610: 2020 2020 2020 2020 2073 656c 662e 5f6c           self._l
+00022620: 6f67 6765 722e 6465 6275 6728 2744 656c  ogger.debug('Del
+00022630: 6574 6564 206c 6f63 616c 2069 7465 6d20  eted local item 
+00022640: 2225 7322 272c 2065 7665 6e74 2e6c 6f63  "%s"', event.loc
+00022650: 616c 5f70 6174 6829 0a20 2020 2020 2020  al_path).       
+00022660: 2020 2020 2072 6574 7572 6e20 5379 6e63       return Sync
+00022670: 5374 6174 7573 2e44 6f6e 650a 2020 2020  Status.Done.    
+00022680: 2020 2020 656c 6966 2069 7369 6e73 7461      elif isinsta
+00022690: 6e63 6528 6578 632c 2028 4669 6c65 4e6f  nce(exc, (FileNo
+000226a0: 7446 6f75 6e64 4572 726f 722c 204e 6f74  tFoundError, Not
+000226b0: 4144 6972 6563 746f 7279 4572 726f 7229  ADirectoryError)
+000226c0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
+000226d0: 656c 662e 7570 6461 7465 5f69 6e64 6578  elf.update_index
+000226e0: 5f66 726f 6d5f 7379 6e63 5f65 7665 6e74  _from_sync_event
+000226f0: 2865 7665 6e74 290a 2020 2020 2020 2020  (event).        
+00022700: 2020 2020 7365 6c66 2e5f 6c6f 6767 6572      self._logger
+00022710: 2e64 6562 7567 2827 4465 6c65 7469 6f6e  .debug('Deletion
+00022720: 2066 6169 6c65 643a 2022 2573 2220 6e6f   failed: "%s" no
+00022730: 7420 666f 756e 6427 2c20 6576 656e 742e  t found', event.
+00022740: 6462 785f 7061 7468 290a 2020 2020 2020  dbx_path).      
+00022750: 2020 2020 2020 7265 7475 726e 2053 796e        return Syn
+00022760: 6353 7461 7475 732e 536b 6970 7065 640a  cStatus.Skipped.
+00022770: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00022780: 2020 2020 2020 2020 2020 7261 6973 6520            raise 
+00022790: 6f73 5f74 6f5f 6d61 6573 7472 616c 5f65  os_to_maestral_e
+000227a0: 7272 6f72 2865 7863 2c20 6462 785f 7061  rror(exc, dbx_pa
+000227b0: 7468 3d65 7665 6e74 2e64 6278 5f70 6174  th=event.dbx_pat
+000227c0: 6829 0a0a 2020 2020 6465 6620 5f61 7070  h)..    def _app
+000227d0: 6c79 5f63 6173 655f 6368 616e 6765 2873  ly_case_change(s
+000227e0: 656c 662c 2065 7665 6e74 3a20 5379 6e63  elf, event: Sync
+000227f0: 4576 656e 7429 202d 3e20 4e6f 6e65 3a0a  Event) -> None:.
+00022800: 2020 2020 2020 2020 2222 220a 2020 2020          """.    
+00022810: 2020 2020 4170 706c 6965 7320 616e 7920      Applies any 
+00022820: 6368 616e 6765 7320 696e 2063 6173 696e  changes in casin
+00022830: 6720 6f66 2074 6865 2072 656d 6f74 6520  g of the remote 
+00022840: 6974 656d 206c 6f63 616c 6c79 2e20 5468  item locally. Th
+00022850: 6973 2073 686f 756c 6420 6265 2063 616c  is should be cal
+00022860: 6c65 640a 2020 2020 2020 2020 6265 666f  led.        befo
+00022870: 7265 2061 6e79 2073 7973 7465 6d20 6361  re any system ca
+00022880: 6c6c 7320 7573 696e 6720 6060 6c6f 6361  lls using ``loca
+00022890: 6c5f 7061 7468 6060 2062 6563 6175 7365  l_path`` because
+000228a0: 2074 6865 2061 6374 7561 6c20 7061 7468   the actual path
+000228b0: 206f 6e20 7468 6520 6669 6c65 0a20 2020   on the file.   
+000228c0: 2020 2020 2073 7973 7465 6d20 6d61 7920       system may 
+000228d0: 6861 7665 2061 2064 6966 6665 7265 6e74  have a different
+000228e0: 2063 6173 696e 6720 6f6e 2063 6173 652d   casing on case-
+000228f0: 7365 6e73 6974 6976 6520 6669 6c65 2073  sensitive file s
+00022900: 7973 7465 6d73 2e20 4f6e 2063 6173 652d  ystems. On case-
+00022910: 0a20 2020 2020 2020 2069 6e73 656e 7369  .        insensi
+00022920: 7469 7665 2066 696c 6520 7379 7374 656d  tive file system
+00022930: 732c 2074 6869 7320 6361 7573 6573 206f  s, this causes o
+00022940: 6e6c 7920 6120 636f 736d 6574 6963 2063  nly a cosmetic c
+00022950: 6861 6e67 652e 0a0a 2020 2020 2020 2020  hange...        
+00022960: 3a70 6172 616d 2065 7665 6e74 3a20 446f  :param event: Do
+00022970: 776e 6c6f 6164 2053 796e 6345 7665 6e74  wnload SyncEvent
+00022980: 2e0a 2020 2020 2020 2020 2222 220a 2020  ..        """.  
+00022990: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000229a0: 5f64 6174 6162 6173 655f 6163 6365 7373  _database_access
+000229b0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+000229c0: 656e 7472 7920 3d20 7365 6c66 2e67 6574  entry = self.get
+000229d0: 5f69 6e64 6578 5f65 6e74 7279 2865 7665  _index_entry(eve
+000229e0: 6e74 2e64 6278 5f70 6174 685f 6c6f 7765  nt.dbx_path_lowe
+000229f0: 7229 0a0a 2020 2020 2020 2020 6966 2065  r)..        if e
+00022a00: 6e74 7279 2061 6e64 2065 6e74 7279 2e64  ntry and entry.d
+00022a10: 6278 5f70 6174 685f 6361 7365 6420 213d  bx_path_cased !=
+00022a20: 2065 7665 6e74 2e64 6278 5f70 6174 683a   event.dbx_path:
+00022a30: 0a20 2020 2020 2020 2020 2020 206c 6f63  .            loc
+00022a40: 616c 5f70 6174 685f 6f6c 6420 3d20 7365  al_path_old = se
+00022a50: 6c66 2e74 6f5f 6c6f 6361 6c5f 7061 7468  lf.to_local_path
+00022a60: 5f66 726f 6d5f 6361 7365 6428 656e 7472  _from_cased(entr
+00022a70: 792e 6462 785f 7061 7468 5f63 6173 6564  y.dbx_path_cased
+00022a80: 290a 0a20 2020 2020 2020 2020 2020 2065  )..            e
+00022a90: 7665 6e74 5f63 6c73 203d 2044 6972 4d6f  vent_cls = DirMo
+00022aa0: 7665 6445 7665 6e74 2069 6620 6973 6469  vedEvent if isdi
+00022ab0: 7228 6c6f 6361 6c5f 7061 7468 5f6f 6c64  r(local_path_old
+00022ac0: 2920 656c 7365 2046 696c 654d 6f76 6564  ) else FileMoved
+00022ad0: 4576 656e 740a 2020 2020 2020 2020 2020  Event.          
+00022ae0: 2020 7769 7468 2073 656c 662e 6673 5f65    with self.fs_e
+00022af0: 7665 6e74 732e 6967 6e6f 7265 2865 7665  vents.ignore(eve
+00022b00: 6e74 5f63 6c73 286c 6f63 616c 5f70 6174  nt_cls(local_pat
+00022b10: 685f 6f6c 642c 2065 7665 6e74 2e6c 6f63  h_old, event.loc
+00022b20: 616c 5f70 6174 6829 293a 0a20 2020 2020  al_path)):.     
+00022b30: 2020 2020 2020 2020 2020 206d 6f76 6528             move(
+00022b40: 6c6f 6361 6c5f 7061 7468 5f6f 6c64 2c20  local_path_old, 
+00022b50: 6576 656e 742e 6c6f 6361 6c5f 7061 7468  event.local_path
+00022b60: 290a 0a20 2020 2020 2020 2020 2020 2077  )..            w
+00022b70: 6974 6820 7365 6c66 2e5f 6461 7461 6261  ith self._databa
+00022b80: 7365 5f61 6363 6573 7328 293a 0a20 2020  se_access():.   
+00022b90: 2020 2020 2020 2020 2020 2020 2065 6e74               ent
+00022ba0: 7279 2e64 6278 5f70 6174 685f 6361 7365  ry.dbx_path_case
+00022bb0: 6420 3d20 6576 656e 742e 6462 785f 7061  d = event.dbx_pa
+00022bc0: 7468 0a20 2020 2020 2020 2020 2020 2020  th.             
+00022bd0: 2020 2073 656c 662e 5f69 6e64 6578 5f74     self._index_t
+00022be0: 6162 6c65 2e75 7064 6174 6528 656e 7472  able.update(entr
+00022bf0: 7929 0a0a 2020 2020 2020 2020 2020 2020  y)..            
+00022c00: 7365 6c66 2e5f 6c6f 6767 6572 2e64 6562  self._logger.deb
+00022c10: 7567 2827 5265 6e61 6d65 6420 2225 7322  ug('Renamed "%s"
+00022c20: 2074 6f20 2225 7322 272c 206c 6f63 616c   to "%s"', local
+00022c30: 5f70 6174 685f 6f6c 642c 2065 7665 6e74  _path_old, event
+00022c40: 2e6c 6f63 616c 5f70 6174 6829 0a0a 2020  .local_path)..  
+00022c50: 2020 6465 6620 7265 7363 616e 2873 656c    def rescan(sel
+00022c60: 662c 206c 6f63 616c 5f70 6174 683a 2073  f, local_path: s
+00022c70: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
+00022c80: 2020 2020 2022 2222 0a20 2020 2020 2020       """.       
+00022c90: 2046 6f72 6365 7320 6120 7265 7363 616e   Forces a rescan
+00022ca0: 206f 6620 6120 6c6f 6361 6c20 7061 7468   of a local path
+00022cb0: 3a20 7363 6865 6475 6c65 7320 6372 6561  : schedules crea
+00022cc0: 7465 6420 6576 656e 7473 2066 6f72 2065  ted events for e
+00022cd0: 7665 7279 2066 6f6c 6465 722c 0a20 2020  very folder,.   
+00022ce0: 2020 2020 206d 6f64 6966 6965 6420 6576       modified ev
+00022cf0: 656e 7473 2066 6f72 2065 7665 7279 2066  ents for every f
+00022d00: 696c 6520 616e 6420 6465 6c65 7465 6420  ile and deleted 
+00022d10: 6576 656e 7473 2066 6f72 2065 7665 7279  events for every
+00022d20: 2064 656c 6574 6564 2069 7465 6d0a 2020   deleted item.  
+00022d30: 2020 2020 2020 2863 6f6d 7061 7265 6420        (compared 
+00022d40: 746f 206f 7572 2069 6e64 6578 292e 0a0a  to our index)...
+00022d50: 2020 2020 2020 2020 3a70 6172 616d 206c          :param l
+00022d60: 6f63 616c 5f70 6174 683a 2050 6174 6820  ocal_path: Path 
+00022d70: 746f 2072 6573 6361 6e2e 0a20 2020 2020  to rescan..     
+00022d80: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
+00022d90: 656c 662e 5f6c 6f67 6765 722e 6465 6275  elf._logger.debu
+00022da0: 6728 2752 6573 6361 6e6e 696e 6720 2225  g('Rescanning "%
+00022db0: 7322 272c 206c 6f63 616c 5f70 6174 6829  s"', local_path)
+00022dc0: 0a0a 2020 2020 2020 2020 6966 2069 7366  ..        if isf
+00022dd0: 696c 6528 6c6f 6361 6c5f 7061 7468 293a  ile(local_path):
+00022de0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00022df0: 662e 6673 5f65 7665 6e74 732e 7175 6575  f.fs_events.queu
+00022e00: 655f 6576 656e 7428 4669 6c65 4d6f 6469  e_event(FileModi
+00022e10: 6669 6564 4576 656e 7428 6c6f 6361 6c5f  fiedEvent(local_
+00022e20: 7061 7468 2929 0a0a 2020 2020 2020 2020  path))..        
+00022e30: 656c 6966 2069 7364 6972 286c 6f63 616c  elif isdir(local
+00022e40: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
+00022e50: 2020 2020 7365 6c66 2e66 735f 6576 656e      self.fs_even
+00022e60: 7473 2e71 7565 7565 5f65 7665 6e74 2844  ts.queue_event(D
+00022e70: 6972 4372 6561 7465 6445 7665 6e74 286c  irCreatedEvent(l
+00022e80: 6f63 616c 5f70 6174 6829 290a 0a20 2020  ocal_path))..   
+00022e90: 2020 2020 2020 2020 2023 2041 6464 2063           # Add c
+00022ea0: 7265 6174 6564 2061 6e64 206d 6f64 6966  reated and modif
+00022eb0: 6965 6420 6576 656e 7473 2066 6f72 2063  ied events for c
+00022ec0: 6869 6c64 7265 6e20 6173 2061 7070 726f  hildren as appro
+00022ed0: 7072 6961 7465 2e0a 0a20 2020 2020 2020  priate...       
+00022ee0: 2020 2020 2066 6f72 2070 6174 682c 2073       for path, s
+00022ef0: 7461 7420 696e 2077 616c 6b28 6c6f 6361  tat in walk(loca
+00022f00: 6c5f 7061 7468 2c20 7365 6c66 2e5f 7363  l_path, self._sc
+00022f10: 616e 6469 725f 7769 7468 5f69 676e 6f72  andir_with_ignor
+00022f20: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00022f30: 2020 2020 6966 2053 5f49 5344 4952 2873      if S_ISDIR(s
+00022f40: 7461 742e 7374 5f6d 6f64 6529 3a0a 2020  tat.st_mode):.  
+00022f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022f60: 2020 7365 6c66 2e66 735f 6576 656e 7473    self.fs_events
+00022f70: 2e71 7565 7565 5f65 7665 6e74 2844 6972  .queue_event(Dir
+00022f80: 4372 6561 7465 6445 7665 6e74 2870 6174  CreatedEvent(pat
+00022f90: 6829 290a 2020 2020 2020 2020 2020 2020  h)).            
+00022fa0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00022fb0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00022fc0: 6c66 2e66 735f 6576 656e 7473 2e71 7565  lf.fs_events.que
+00022fd0: 7565 5f65 7665 6e74 2846 696c 654d 6f64  ue_event(FileMod
+00022fe0: 6966 6965 6445 7665 6e74 2870 6174 6829  ifiedEvent(path)
+00022ff0: 290a 0a20 2020 2020 2020 2020 2020 2023  )..            #
+00023000: 2041 6464 2064 656c 6574 6564 2065 7665   Add deleted eve
+00023010: 6e74 7320 666f 7220 6368 696c 6472 656e  nts for children
+00023020: 2e0a 0a20 2020 2020 2020 2020 2020 2064  ...            d
+00023030: 6278 5f70 6174 685f 6c6f 7765 7220 3d20  bx_path_lower = 
+00023040: 7365 6c66 2e74 6f5f 6462 785f 7061 7468  self.to_dbx_path
+00023050: 5f6c 6f77 6572 286c 6f63 616c 5f70 6174  _lower(local_pat
+00023060: 6829 0a0a 2020 2020 2020 2020 2020 2020  h)..            
+00023070: 7769 7468 2073 656c 662e 5f64 6174 6162  with self._datab
+00023080: 6173 655f 6163 6365 7373 2829 3a0a 2020  ase_access():.  
+00023090: 2020 2020 2020 2020 2020 2020 2020 7175                qu
+000230a0: 6572 7920 3d20 5061 7468 5472 6565 5175  ery = PathTreeQu
+000230b0: 6572 7928 496e 6465 7845 6e74 7279 2e64  ery(IndexEntry.d
+000230c0: 6278 5f70 6174 685f 6c6f 7765 722c 2064  bx_path_lower, d
+000230d0: 6278 5f70 6174 685f 6c6f 7765 7229 0a20  bx_path_lower). 
+000230e0: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+000230f0: 6e74 7269 6573 203d 2073 656c 662e 5f69  ntries = self._i
+00023100: 6e64 6578 5f74 6162 6c65 2e73 656c 6563  ndex_table.selec
+00023110: 7428 7175 6572 7929 0a0a 2020 2020 2020  t(query)..      
+00023120: 2020 2020 2020 666f 7220 656e 7472 7920        for entry 
+00023130: 696e 2065 6e74 7269 6573 3a0a 2020 2020  in entries:.    
+00023140: 2020 2020 2020 2020 2020 2020 6368 696c              chil
+00023150: 645f 7061 7468 203d 2073 656c 662e 746f  d_path = self.to
+00023160: 5f6c 6f63 616c 5f70 6174 685f 6672 6f6d  _local_path_from
+00023170: 5f63 6173 6564 2865 6e74 7279 2e64 6278  _cased(entry.dbx
+00023180: 5f70 6174 685f 6361 7365 6429 0a20 2020  _path_cased).   
+00023190: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+000231a0: 6e6f 7420 6578 6973 7473 2863 6869 6c64  not exists(child
+000231b0: 5f70 6174 6829 3a0a 2020 2020 2020 2020  _path):.        
+000231c0: 2020 2020 2020 2020 2020 2020 6966 2065              if e
+000231d0: 6e74 7279 2e69 735f 6469 7265 6374 6f72  ntry.is_director
+000231e0: 793a 0a20 2020 2020 2020 2020 2020 2020  y:.             
+000231f0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00023200: 6673 5f65 7665 6e74 732e 7175 6575 655f  fs_events.queue_
+00023210: 6576 656e 7428 4469 7244 656c 6574 6564  event(DirDeleted
+00023220: 4576 656e 7428 6368 696c 645f 7061 7468  Event(child_path
+00023230: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
+00023240: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00023250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023260: 2020 2020 2073 656c 662e 6673 5f65 7665       self.fs_eve
+00023270: 6e74 732e 7175 6575 655f 6576 656e 7428  nts.queue_event(
+00023280: 4669 6c65 4465 6c65 7465 6445 7665 6e74  FileDeletedEvent
+00023290: 2863 6869 6c64 5f70 6174 6829 290a 0a20  (child_path)).. 
+000232a0: 2020 2020 2020 2065 6c69 6620 6e6f 7420         elif not 
+000232b0: 6578 6973 7473 286c 6f63 616c 5f70 6174  exists(local_pat
+000232c0: 6829 3a0a 2020 2020 2020 2020 2020 2020  h):.            
+000232d0: 6462 785f 7061 7468 5f6c 6f77 6572 203d  dbx_path_lower =
+000232e0: 2073 656c 662e 746f 5f64 6278 5f70 6174   self.to_dbx_pat
+000232f0: 685f 6c6f 7765 7228 6c6f 6361 6c5f 7061  h_lower(local_pa
+00023300: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+00023310: 6c6f 6361 6c5f 656e 7472 7920 3d20 7365  local_entry = se
+00023320: 6c66 2e67 6574 5f69 6e64 6578 5f65 6e74  lf.get_index_ent
+00023330: 7279 2864 6278 5f70 6174 685f 6c6f 7765  ry(dbx_path_lowe
+00023340: 7229 0a0a 2020 2020 2020 2020 2020 2020  r)..            
+00023350: 6966 206c 6f63 616c 5f65 6e74 7279 3a0a  if local_entry:.
+00023360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023370: 6966 206c 6f63 616c 5f65 6e74 7279 2e69  if local_entry.i
+00023380: 735f 6469 7265 6374 6f72 793a 0a20 2020  s_directory:.   
+00023390: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000233a0: 2073 656c 662e 6673 5f65 7665 6e74 732e   self.fs_events.
+000233b0: 7175 6575 655f 6576 656e 7428 4469 7244  queue_event(DirD
+000233c0: 656c 6574 6564 4576 656e 7428 6c6f 6361  eletedEvent(loca
+000233d0: 6c5f 7061 7468 2929 0a20 2020 2020 2020  l_path)).       
+000233e0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+000233f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023400: 2020 2073 656c 662e 6673 5f65 7665 6e74     self.fs_event
+00023410: 732e 7175 6575 655f 6576 656e 7428 4669  s.queue_event(Fi
+00023420: 6c65 4465 6c65 7465 6445 7665 6e74 286c  leDeletedEvent(l
+00023430: 6f63 616c 5f70 6174 6829 290a 0a20 2020  ocal_path))..   
+00023440: 2064 6566 205f 636c 6561 6e5f 6869 7374   def _clean_hist
+00023450: 6f72 7928 7365 6c66 2920 2d3e 204e 6f6e  ory(self) -> Non
+00023460: 653a 0a20 2020 2020 2020 2022 2222 436f  e:.        """Co
+00023470: 6d6d 6974 7320 6e65 7720 6576 656e 7473  mmits new events
+00023480: 2061 6e64 2072 656d 6f76 6573 2061 6c6c   and removes all
+00023490: 2065 7665 6e74 7320 6f6c 6465 7220 7468   events older th
+000234a0: 616e 2060 605f 6b65 6570 5f68 6973 746f  an ``_keep_histo
+000234b0: 7279 6060 2066 726f 6d0a 2020 2020 2020  ry`` from.      
+000234c0: 2020 6869 7374 6f72 792e 2222 220a 2020    history.""".  
+000234d0: 2020 2020 2020 7769 7468 2073 656c 662e        with self.
+000234e0: 5f64 6174 6162 6173 655f 6163 6365 7373  _database_access
+000234f0: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
+00023500: 2320 4472 6f70 2061 6c6c 2065 6e74 7269  # Drop all entri
+00023510: 6573 206f 6c64 6572 2074 6861 6e20 6b65  es older than ke
+00023520: 6570 5f68 6973 746f 7279 2e0a 2020 2020  ep_history..    
+00023530: 2020 2020 2020 2020 6e6f 7720 3d20 7469          now = ti
+00023540: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
+00023550: 2020 2020 2020 6b65 6570 5f68 6973 746f        keep_histo
+00023560: 7279 203d 2073 656c 662e 5f63 6f6e 662e  ry = self._conf.
+00023570: 6765 7428 2273 796e 6322 2c20 226b 6565  get("sync", "kee
+00023580: 705f 6869 7374 6f72 7922 290a 0a20 2020  p_history")..   
+00023590: 2020 2020 2020 2020 2073 656c 662e 5f64           self._d
+000235a0: 622e 6578 6563 7574 6528 0a20 2020 2020  b.execute(.     
+000235b0: 2020 2020 2020 2020 2020 2022 4445 4c45             "DELE
+000235c0: 5445 2046 524f 4d20 6869 7374 6f72 7920  TE FROM history 
+000235d0: 5748 4552 4520 4946 4e55 4c4c 2863 6861  WHERE IFNULL(cha
+000235e0: 6e67 655f 7469 6d65 2c20 7379 6e63 5f74  nge_time, sync_t
+000235f0: 696d 6529 203c 203f 222c 0a20 2020 2020  ime) < ?",.     
+00023600: 2020 2020 2020 2020 2020 206e 6f77 202d             now -
+00023610: 206b 6565 705f 6869 7374 6f72 792c 0a20   keep_history,. 
+00023620: 2020 2020 2020 2020 2020 2029 0a20 2020             ).   
+00023630: 2020 2020 2020 2020 2073 656c 662e 5f68           self._h
+00023640: 6973 746f 7279 5f74 6162 6c65 2e63 6c65  istory_table.cle
+00023650: 6172 5f63 6163 6865 2829 0a0a 2020 2020  ar_cache()..    
+00023660: 6465 6620 5f73 6361 6e64 6972 5f77 6974  def _scandir_wit
+00023670: 685f 6967 6e6f 7265 280a 2020 2020 2020  h_ignore(.      
+00023680: 2020 7365 6c66 2c20 7061 7468 3a20 7374    self, path: st
+00023690: 7220 7c20 6f73 2e50 6174 684c 696b 655b  r | os.PathLike[
+000236a0: 7374 725d 0a20 2020 2029 202d 3e20 4974  str].    ) -> It
+000236b0: 6572 6174 6f72 5b6f 732e 4469 7245 6e74  erator[os.DirEnt
+000236c0: 7279 5b73 7472 5d5d 3a0a 2020 2020 2020  ry[str]]:.      
+000236d0: 2020 7769 7468 206f 732e 7363 616e 6469    with os.scandi
+000236e0: 7228 7061 7468 2920 6173 2069 743a 0a20  r(path) as it:. 
+000236f0: 2020 2020 2020 2020 2020 2066 6f72 2065             for e
+00023700: 6e74 7279 2069 6e20 6974 3a0a 2020 2020  ntry in it:.    
+00023710: 2020 2020 2020 2020 2020 2020 6462 785f              dbx_
+00023720: 7061 7468 203d 2073 656c 662e 746f 5f64  path = self.to_d
+00023730: 6278 5f70 6174 6828 656e 7472 792e 7061  bx_path(entry.pa
+00023740: 7468 290a 2020 2020 2020 2020 2020 2020  th).            
+00023750: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00023760: 6973 5f65 7863 6c75 6465 6428 656e 7472  is_excluded(entr
+00023770: 792e 7061 7468 2920 616e 6420 6e6f 7420  y.path) and not 
+00023780: 7365 6c66 2e5f 6973 5f6d 6967 6e6f 7265  self._is_mignore
+00023790: 5f70 6174 6828 0a20 2020 2020 2020 2020  _path(.         
+000237a0: 2020 2020 2020 2020 2020 2064 6278 5f70             dbx_p
+000237b0: 6174 682c 2065 6e74 7279 2e69 735f 6469  ath, entry.is_di
+000237c0: 7228 666f 6c6c 6f77 5f73 796d 6c69 6e6b  r(follow_symlink
+000237d0: 733d 4661 6c73 6529 0a20 2020 2020 2020  s=False).       
+000237e0: 2020 2020 2020 2020 2029 3a0a 2020 2020           ):.    
+000237f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00023800: 7969 656c 6420 656e 7472 790a 0a0a 2320  yield entry...# 
+00023810: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023820: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023830: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023840: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023850: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023860: 3d3d 3d3d 3d3d 0a23 2048 656c 7065 7220  ======.# Helper 
+00023870: 6675 6e63 7469 6f6e 730a 2320 3d3d 3d3d  functions.# ====
+00023880: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+00023890: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000238a0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000238b0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000238c0: 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d 3d3d  ================
+000238d0: 3d3d 0a0a 0a64 6566 2064 6f5f 7061 7261  ==...def do_para
+000238e0: 6c6c 656c 280a 2020 2020 6675 6e63 3a20  llel(.    func: 
+000238f0: 4361 6c6c 6162 6c65 5b50 2c20 545d 2c0a  Callable[P, T],.
+00023900: 2020 2020 2a69 7465 7261 626c 653a 2043      *iterable: C
+00023910: 6f6c 6c65 6374 696f 6e5b 502e 6172 6773  ollection[P.args
+00023920: 5d2c 0a20 2020 2074 6872 6561 645f 6e61  ],.    thread_na
+00023930: 6d65 5f70 7265 6669 783a 2073 7472 203d  me_prefix: str =
+00023940: 2022 222c 0a20 2020 206f 6e5f 7072 6f67   "",.    on_prog
+00023950: 7265 7373 3a20 4361 6c6c 6162 6c65 5b5b  ress: Callable[[
+00023960: 696e 742c 2069 6e74 5d2c 2041 6e79 5d20  int, int], Any] 
+00023970: 7c20 4e6f 6e65 203d 204e 6f6e 652c 0a29  | None = None,.)
+00023980: 202d 3e20 4974 6572 6162 6c65 5b54 5d3a   -> Iterable[T]:
+00023990: 0a20 2020 2022 2222 0a20 2020 2053 696d  .    """.    Sim
+000239a0: 696c 6172 2074 6f20 6060 5468 7265 6164  ilar to ``Thread
+000239b0: 506f 6f6c 4578 6563 7574 6f72 2e6d 6170  PoolExecutor.map
+000239c0: 2829 6060 2062 7574 2079 6965 6c64 7320  ()`` but yields 
+000239d0: 7265 7375 6c74 7320 6173 2074 6865 7920  results as they 
+000239e0: 6265 636f 6d65 2061 7661 696c 6162 6c65  become available
+000239f0: 2e0a 0a20 2020 203a 7061 7261 6d20 6675  ...    :param fu
+00023a00: 6e63 3a20 4170 706c 7920 7468 6973 2063  nc: Apply this c
+00023a10: 616c 6c61 626c 6520 746f 2065 7665 7279  allable to every
+00023a20: 2069 7465 6d20 6f66 2060 6069 7465 7261   item of ``itera
+00023a30: 626c 6560 602e 0a20 2020 203a 7061 7261  ble``..    :para
+00023a40: 6d20 6974 6572 6162 6c65 3a20 4974 6572  m iterable: Iter
+00023a50: 6162 6c65 2077 6974 6820 6172 6775 6d65  able with argume
+00023a60: 6e74 7320 746f 2070 6173 7320 746f 2060  nts to pass to `
+00023a70: 6066 756e 6360 602e 0a20 2020 203a 7061  `func``..    :pa
+00023a80: 7261 6d20 7468 7265 6164 5f6e 616d 655f  ram thread_name_
+00023a90: 7072 6566 6978 3a20 5573 6564 2066 6f72  prefix: Used for
+00023aa0: 2069 6e74 6572 6e61 6c20 5468 7265 6164   internal Thread
+00023ab0: 506f 6f6c 4578 6563 7574 6f72 2e0a 2020  PoolExecutor..  
+00023ac0: 2020 3a70 6172 616d 206f 6e5f 7072 6f67    :param on_prog
+00023ad0: 7265 7373 3a20 4361 6c6c 6261 636b 2077  ress: Callback w
+00023ae0: 6865 6e20 6561 6368 2074 6173 6b20 6973  hen each task is
+00023af0: 2063 6f6d 706c 6574 6564 2e20 5461 6b65   completed. Take
+00023b00: 7320 7468 6520 6e75 6d62 6572 206f 660a  s the number of.
+00023b10: 2020 2020 2020 2020 636f 6d70 6c65 7465          complete
+00023b20: 6420 6974 656d 7320 616e 6420 7468 6520  d items and the 
+00023b30: 746f 7461 6c20 6e75 6d62 6572 206f 6620  total number of 
+00023b40: 6974 656d 7320 6173 2061 7267 756d 656e  items as argumen
+00023b50: 7473 2e0a 2020 2020 2222 220a 2020 2020  ts..    """.    
+00023b60: 7769 7468 2054 6872 6561 6450 6f6f 6c45  with ThreadPoolE
+00023b70: 7865 6375 746f 7228 0a20 2020 2020 2020  xecutor(.       
+00023b80: 206d 6178 5f77 6f72 6b65 7273 3d4e 554d   max_workers=NUM
+00023b90: 5f54 4852 4541 4453 2c20 7468 7265 6164  _THREADS, thread
+00023ba0: 5f6e 616d 655f 7072 6566 6978 3d74 6872  _name_prefix=thr
+00023bb0: 6561 645f 6e61 6d65 5f70 7265 6669 780a  ead_name_prefix.
+00023bc0: 2020 2020 2920 6173 2074 7065 3a0a 2020      ) as tpe:.  
+00023bd0: 2020 2020 2020 6673 203d 205b 7470 652e        fs = [tpe.
+00023be0: 7375 626d 6974 2866 756e 632c 202a 6172  submit(func, *ar
+00023bf0: 6773 2920 666f 7220 6172 6773 2069 6e20  gs) for args in 
+00023c00: 7a69 7028 2a69 7465 7261 626c 6529 5d0a  zip(*iterable)].
+00023c10: 0a20 2020 2020 2020 206e 5f64 6f6e 6520  .        n_done 
+00023c20: 3d20 300a 2020 2020 2020 2020 666f 7220  = 0.        for 
+00023c30: 6620 696e 2061 735f 636f 6d70 6c65 7465  f in as_complete
+00023c40: 6428 6673 293a 0a20 2020 2020 2020 2020  d(fs):.         
+00023c50: 2020 206e 5f64 6f6e 6520 2b3d 2031 0a20     n_done += 1. 
+00023c60: 2020 2020 2020 2020 2020 2069 6620 6f6e             if on
+00023c70: 5f70 726f 6772 6573 733a 0a20 2020 2020  _progress:.     
+00023c80: 2020 2020 2020 2020 2020 206f 6e5f 7072             on_pr
+00023c90: 6f67 7265 7373 286e 5f64 6f6e 652c 206c  ogress(n_done, l
+00023ca0: 656e 2869 7465 7261 626c 655b 305d 2929  en(iterable[0]))
+00023cb0: 0a20 2020 2020 2020 2020 2020 2079 6965  .            yie
+00023cc0: 6c64 2066 2e72 6573 756c 7428 290a 0a0a  ld f.result()...
+00023cd0: 6465 6620 6973 5f6d 6f76 6564 2865 7665  def is_moved(eve
+00023ce0: 6e74 3a20 4669 6c65 5379 7374 656d 4576  nt: FileSystemEv
+00023cf0: 656e 7429 202d 3e20 5479 7065 4775 6172  ent) -> TypeGuar
+00023d00: 645b 4669 6c65 4d6f 7665 6445 7665 6e74  d[FileMovedEvent
+00023d10: 207c 2044 6972 4d6f 7665 6445 7665 6e74   | DirMovedEvent
+00023d20: 5d3a 0a20 2020 2072 6574 7572 6e20 6576  ]:.    return ev
+00023d30: 656e 742e 6576 656e 745f 7479 7065 203d  ent.event_type =
+00023d40: 3d20 4556 454e 545f 5459 5045 5f4d 4f56  = EVENT_TYPE_MOV
+00023d50: 4544 0a0a 0a64 6566 2069 735f 6465 6c65  ED...def is_dele
+00023d60: 7465 6428 6576 656e 743a 2046 696c 6553  ted(event: FileS
+00023d70: 7973 7465 6d45 7665 6e74 2920 2d3e 2054  ystemEvent) -> T
+00023d80: 7970 6547 7561 7264 5b46 696c 6544 656c  ypeGuard[FileDel
+00023d90: 6574 6564 4576 656e 7420 7c20 4469 7244  etedEvent | DirD
+00023da0: 656c 6574 6564 4576 656e 745d 3a0a 2020  eletedEvent]:.  
+00023db0: 2020 7265 7475 726e 2065 7665 6e74 2e65    return event.e
+00023dc0: 7665 6e74 5f74 7970 6520 3d3d 2045 5645  vent_type == EVE
+00023dd0: 4e54 5f54 5950 455f 4445 4c45 5445 440a  NT_TYPE_DELETED.
+00023de0: 0a0a 6465 6620 6973 5f63 7265 6174 6564  ..def is_created
+00023df0: 2865 7665 6e74 3a20 4669 6c65 5379 7374  (event: FileSyst
+00023e00: 656d 4576 656e 7429 202d 3e20 5479 7065  emEvent) -> Type
+00023e10: 4775 6172 645b 4669 6c65 4372 6561 7465  Guard[FileCreate
+00023e20: 6445 7665 6e74 207c 2044 6972 4372 6561  dEvent | DirCrea
+00023e30: 7465 6445 7665 6e74 5d3a 0a20 2020 2072  tedEvent]:.    r
+00023e40: 6574 7572 6e20 6576 656e 742e 6576 656e  eturn event.even
+00023e50: 745f 7479 7065 203d 3d20 4556 454e 545f  t_type == EVENT_
+00023e60: 5459 5045 5f43 5245 4154 4544 0a0a 0a40  TYPE_CREATED...@
+00023e70: 6f76 6572 6c6f 6164 0a64 6566 2073 706c  overload.def spl
+00023e80: 6974 5f6d 6f76 6564 5f65 7665 6e74 280a  it_moved_event(.
+00023e90: 2020 2020 6576 656e 743a 2046 696c 654d      event: FileM
+00023ea0: 6f76 6564 4576 656e 742c 0a29 202d 3e20  ovedEvent,.) -> 
+00023eb0: 7475 706c 655b 4669 6c65 4465 6c65 7465  tuple[FileDelete
+00023ec0: 6445 7665 6e74 2c20 4669 6c65 4372 6561  dEvent, FileCrea
+00023ed0: 7465 6445 7665 6e74 5d3a 0a20 2020 202e  tedEvent]:.    .
+00023ee0: 2e2e 0a0a 0a40 6f76 6572 6c6f 6164 0a64  .....@overload.d
+00023ef0: 6566 2073 706c 6974 5f6d 6f76 6564 5f65  ef split_moved_e
+00023f00: 7665 6e74 2865 7665 6e74 3a20 4469 724d  vent(event: DirM
+00023f10: 6f76 6564 4576 656e 7429 202d 3e20 7475  ovedEvent) -> tu
+00023f20: 706c 655b 4469 7244 656c 6574 6564 4576  ple[DirDeletedEv
+00023f30: 656e 742c 2044 6972 4372 6561 7465 6445  ent, DirCreatedE
+00023f40: 7665 6e74 5d3a 0a20 2020 202e 2e2e 0a0a  vent]:.    .....
+00023f50: 0a64 6566 2073 706c 6974 5f6d 6f76 6564  .def split_moved
+00023f60: 5f65 7665 6e74 280a 2020 2020 6576 656e  _event(.    even
+00023f70: 743a 2046 696c 654d 6f76 6564 4576 656e  t: FileMovedEven
+00023f80: 7420 7c20 4469 724d 6f76 6564 4576 656e  t | DirMovedEven
+00023f90: 742c 0a29 202d 3e20 7475 706c 655b 4669  t,.) -> tuple[Fi
+00023fa0: 6c65 5379 7374 656d 4576 656e 742c 2046  leSystemEvent, F
+00023fb0: 696c 6553 7973 7465 6d45 7665 6e74 5d3a  ileSystemEvent]:
+00023fc0: 0a20 2020 2022 2222 0a20 2020 2053 706c  .    """.    Spl
+00023fd0: 6974 7320 6120 4669 6c65 4d6f 7665 6445  its a FileMovedE
+00023fe0: 7665 6e74 206f 7220 4469 724d 6f76 6564  vent or DirMoved
+00023ff0: 4576 656e 7420 696e 746f 2022 6465 6c65  Event into "dele
+00024000: 7465 6422 2061 6e64 2022 6372 6561 7465  ted" and "create
+00024010: 6422 2065 7665 6e74 7320 6f66 2074 6865  d" events of the
+00024020: 0a20 2020 2073 616d 6520 7479 7065 2e20  .    same type. 
+00024030: 4120 6e65 7720 6174 7472 6962 7574 6520  A new attribute 
+00024040: 6060 6d6f 7665 5f69 6460 6020 6973 2061  ``move_id`` is a
+00024050: 6464 6564 2074 6f20 626f 7468 2069 6e73  dded to both ins
+00024060: 7461 6e63 6573 2e0a 0a20 2020 203a 7061  tances...    :pa
+00024070: 7261 6d20 6576 656e 743a 204f 7269 6769  ram event: Origi
+00024080: 6e61 6c20 6576 656e 742e 0a20 2020 203a  nal event..    :
+00024090: 7265 7475 726e 733a 2054 7570 6c65 206f  returns: Tuple o
+000240a0: 6620 6465 6c65 7465 6420 616e 6420 6372  f deleted and cr
+000240b0: 6561 7465 6420 6576 656e 7473 2e0a 2020  eated events..  
+000240c0: 2020 2222 220a 2020 2020 6372 6561 7465    """.    create
+000240d0: 645f 6576 656e 745f 636c 733a 2054 7970  d_event_cls: Typ
+000240e0: 655b 4669 6c65 5379 7374 656d 4576 656e  e[FileSystemEven
+000240f0: 745d 0a20 2020 2064 656c 6574 6564 5f65  t].    deleted_e
+00024100: 7665 6e74 5f63 6c73 3a20 5479 7065 5b46  vent_cls: Type[F
+00024110: 696c 6553 7973 7465 6d45 7665 6e74 5d0a  ileSystemEvent].
+00024120: 2020 2020 6966 2065 7665 6e74 2e69 735f      if event.is_
+00024130: 6469 7265 6374 6f72 793a 0a20 2020 2020  directory:.     
+00024140: 2020 2063 7265 6174 6564 5f65 7665 6e74     created_event
+00024150: 5f63 6c73 203d 2044 6972 4372 6561 7465  _cls = DirCreate
+00024160: 6445 7665 6e74 0a20 2020 2020 2020 2064  dEvent.        d
+00024170: 656c 6574 6564 5f65 7665 6e74 5f63 6c73  eleted_event_cls
+00024180: 203d 2044 6972 4465 6c65 7465 6445 7665   = DirDeletedEve
+00024190: 6e74 0a20 2020 2065 6c73 653a 0a20 2020  nt.    else:.   
+000241a0: 2020 2020 2063 7265 6174 6564 5f65 7665       created_eve
+000241b0: 6e74 5f63 6c73 203d 2046 696c 6543 7265  nt_cls = FileCre
+000241c0: 6174 6564 4576 656e 740a 2020 2020 2020  atedEvent.      
+000241d0: 2020 6465 6c65 7465 645f 6576 656e 745f    deleted_event_
+000241e0: 636c 7320 3d20 4669 6c65 4465 6c65 7465  cls = FileDelete
+000241f0: 6445 7665 6e74 0a0a 2020 2020 6465 6c65  dEvent..    dele
+00024200: 7465 645f 6576 656e 7420 3d20 6465 6c65  ted_event = dele
+00024210: 7465 645f 6576 656e 745f 636c 7328 6576  ted_event_cls(ev
+00024220: 656e 742e 7372 635f 7061 7468 290a 2020  ent.src_path).  
+00024230: 2020 6372 6561 7465 645f 6576 656e 7420    created_event 
+00024240: 3d20 6372 6561 7465 645f 6576 656e 745f  = created_event_
+00024250: 636c 7328 6576 656e 742e 6465 7374 5f70  cls(event.dest_p
+00024260: 6174 6829 0a0a 2020 2020 7265 7475 726e  ath)..    return
+00024270: 2064 656c 6574 6564 5f65 7665 6e74 2c20   deleted_event, 
+00024280: 6372 6561 7465 645f 6576 656e 740a 0a0a  created_event...
+00024290: 636c 6173 7320 7066 5f72 6570 723a 0a20  class pf_repr:. 
+000242a0: 2020 2022 2222 0a20 2020 2043 6c61 7373     """.    Class
+000242b0: 2074 6861 7420 7772 6170 7320 616e 206f   that wraps an o
+000242c0: 626a 6563 7420 616e 6420 6372 6561 7465  bject and create
+000242d0: 7320 6120 7072 6574 7479 2066 6f72 6d61  s a pretty forma
+000242e0: 7474 6564 2072 6570 7265 7365 6e74 6174  tted representat
+000242f0: 696f 6e20 666f 7220 6974 2e0a 2020 2020  ion for it..    
+00024300: 5468 6973 2063 616e 2062 6520 7573 6564  This can be used
+00024310: 2074 6f20 6765 7420 7072 6574 7479 2066   to get pretty f
+00024320: 6f72 6d61 7474 696e 6720 696e 206c 6f67  ormatting in log
+00024330: 206d 6573 7361 6765 7320 7768 696c 6520   messages while 
+00024340: 6465 6665 7272 696e 6720 7468 6520 6163  deferring the ac
+00024350: 7475 616c 0a20 2020 2066 6f72 6d61 7474  tual.    formatt
+00024360: 696e 6720 756e 7469 6c20 7468 6520 6d65  ing until the me
+00024370: 7373 6167 6520 6973 2063 7265 6174 6564  ssage is created
+00024380: 2e0a 0a20 2020 203a 7061 7261 6d20 6f62  ...    :param ob
+00024390: 6a3a 204f 626a 6563 7420 746f 2077 7261  j: Object to wra
+000243a0: 702e 0a20 2020 2022 2222 0a0a 2020 2020  p..    """..    
+000243b0: 6465 6620 5f5f 696e 6974 5f5f 2873 656c  def __init__(sel
+000243c0: 662c 206f 626a 3a20 416e 7929 202d 3e20  f, obj: Any) -> 
+000243d0: 4e6f 6e65 3a0a 2020 2020 2020 2020 7365  None:.        se
+000243e0: 6c66 2e6f 626a 203d 206f 626a 0a0a 2020  lf.obj = obj..  
+000243f0: 2020 6465 6620 5f5f 7265 7072 5f5f 2873    def __repr__(s
+00024400: 656c 6629 202d 3e20 7374 723a 0a20 2020  elf) -> str:.   
+00024410: 2020 2020 2072 6574 7572 6e20 7066 6f72       return pfor
+00024420: 6d61 7428 7365 6c66 2e6f 626a 290a 0a0a  mat(self.obj)...
+00024430: 6465 6620 6368 6563 6b5f 656e 636f 6469  def check_encodi
+00024440: 6e67 286c 6f63 616c 5f70 6174 683a 2073  ng(local_path: s
+00024450: 7472 2920 2d3e 204e 6f6e 653a 0a20 2020  tr) -> None:.   
+00024460: 2022 2222 0a20 2020 2056 616c 6964 6174   """.    Validat
+00024470: 6520 7468 6174 2074 6865 2070 6174 6820  e that the path 
+00024480: 636f 6e74 6169 6e73 206f 6e6c 7920 6368  contains only ch
+00024490: 6172 6163 7465 7273 2069 6e20 7468 6520  aracters in the 
+000244a0: 7265 706f 7274 6564 2066 696c 6520 7379  reported file sy
+000244b0: 7374 656d 0a20 2020 2065 6e63 6f64 696e  stem.    encodin
+000244c0: 672e 204f 6e20 556e 6978 2c20 7061 7468  g. On Unix, path
+000244d0: 7320 6172 6520 6675 6e64 616d 656e 7461  s are fundamenta
+000244e0: 6c6c 7920 6279 7465 7320 616e 6420 736f  lly bytes and so
+000244f0: 6d65 2070 6c61 7466 6f72 6d73 2064 6f20  me platforms do 
+00024500: 6e6f 7420 656e 666f 7263 650a 2020 2020  not enforce.    
+00024510: 6120 756e 6966 6f72 6d20 656e 636f 6469  a uniform encodi
+00024520: 6e67 206f 6620 6669 6c65 206e 616d 6573  ng of file names
+00024530: 2064 6573 7069 7465 2072 6570 6f72 7469   despite reporti
+00024540: 6e67 2061 2066 696c 6520 7379 7374 656d  ng a file system
+00024550: 2065 6e63 6f64 696e 672e 2053 7563 680a   encoding. Such.
+00024560: 2020 2020 7061 7468 7320 7769 6c6c 2062      paths will b
+00024570: 6520 6861 6e64 6564 2074 6f20 7573 2069  e handed to us i
+00024580: 6e20 5079 7468 6f6e 2077 6974 6820 2273  n Python with "s
+00024590: 7572 726f 6761 7465 2065 7363 6170 6573  urrogate escapes
+000245a0: 2220 696e 2070 6c61 6365 206f 6620 7468  " in place of th
+000245b0: 650a 2020 2020 756e 6b6e 6f77 6e20 6368  e.    unknown ch
+000245c0: 6172 6163 7465 7273 2e0a 0a20 2020 2053  aracters...    S
+000245d0: 696e 6365 2074 6865 2044 726f 7062 6f78  ince the Dropbox
+000245e0: 2041 5049 2061 6e64 206f 7572 2064 6174   API and our dat
+000245f0: 6162 6173 6520 626f 7468 2072 6571 7569  abase both requi
+00024600: 7265 2075 7466 2d38 2065 6e63 6f64 6564  re utf-8 encoded
+00024610: 2070 6174 6873 2c20 7765 2075 7365 2074   paths, we use t
+00024620: 6869 730a 2020 2020 6d65 7468 6f64 2074  his.    method t
+00024630: 6f20 6368 6563 6b20 616e 6420 6661 696c  o check and fail
+00024640: 2065 6172 6c79 206f 6e20 756e 6b6e 6f77   early on unknow
+00024650: 6e20 6368 6172 6163 7465 7273 2e0a 0a20  n characters... 
+00024660: 2020 203a 7061 7261 6d20 6c6f 6361 6c5f     :param local_
+00024670: 7061 7468 3a20 5061 7468 2074 6f20 6368  path: Path to ch
+00024680: 6563 6b2e 0a20 2020 203a 7261 6973 6573  eck..    :raises
+00024690: 2050 6174 6845 7272 6f72 3a20 6966 2074   PathError: if t
+000246a0: 6865 2070 6174 6820 636f 6e74 6169 6e73  he path contains
+000246b0: 2063 6861 7261 6374 6572 7320 7769 7468   characters with
+000246c0: 2061 6e20 756e 6b6e 6f77 6e20 656e 636f   an unknown enco
+000246d0: 6469 6e67 2e0a 2020 2020 2222 220a 2020  ding..    """.  
+000246e0: 2020 7472 793a 0a20 2020 2020 2020 206c    try:.        l
+000246f0: 6f63 616c 5f70 6174 682e 656e 636f 6465  ocal_path.encode
+00024700: 2829 0a20 2020 2065 7863 6570 7420 556e  ().    except Un
+00024710: 6963 6f64 6545 6e63 6f64 6545 7272 6f72  icodeEncodeError
+00024720: 3a0a 2020 2020 2020 2020 6673 5f65 6e63  :.        fs_enc
+00024730: 6f64 696e 6720 3d20 7379 732e 6765 7466  oding = sys.getf
+00024740: 696c 6573 7973 7465 6d65 6e63 6f64 696e  ilesystemencodin
+00024750: 6728 290a 2020 2020 2020 2020 6572 726f  g().        erro
+00024760: 7220 3d20 5061 7468 4572 726f 7228 0a20  r = PathError(. 
+00024770: 2020 2020 2020 2020 2020 2022 436f 756c             "Coul
+00024780: 6420 6e6f 7420 7570 6c6f 6164 2069 7465  d not upload ite
+00024790: 6d22 2c0a 2020 2020 2020 2020 2020 2020  m",.            
+000247a0: 6622 5468 6520 6669 6c65 206e 616d 6520  f"The file name 
+000247b0: 636f 6e74 6169 6e73 2063 6861 7261 6374  contains charact
+000247c0: 6572 7320 6f75 7473 6964 6520 7468 6520  ers outside the 
+000247d0: 220a 2020 2020 2020 2020 2020 2020 6622  ".            f"
+000247e0: 7b66 735f 656e 636f 6469 6e67 7d20 656e  {fs_encoding} en
+000247f0: 636f 6469 6e67 206f 6620 796f 7572 2066  coding of your f
+00024800: 696c 6520 7379 7374 656d 222c 0a20 2020  ile system",.   
+00024810: 2020 2020 2029 0a20 2020 2020 2020 2065       ).        e
+00024820: 7272 6f72 2e6c 6f63 616c 5f70 6174 6820  rror.local_path 
+00024830: 3d20 6c6f 6361 6c5f 7061 7468 0a20 2020  = local_path.   
+00024840: 2020 2020 2072 6169 7365 2065 7272 6f72       raise error
+00024850: 0a0a 0a64 6566 2063 6865 636b 5f63 6861  ...def check_cha
+00024860: 6e67 655f 7479 7065 2865 7665 6e74 3a20  nge_type(event: 
+00024870: 5379 6e63 4576 656e 742c 2061 6c6c 6f77  SyncEvent, allow
+00024880: 6564 5f63 6861 6e67 655f 7479 7065 733a  ed_change_types:
+00024890: 2073 6574 5b43 6861 6e67 6554 7970 655d   set[ChangeType]
+000248a0: 2920 2d3e 204e 6f6e 653a 0a20 2020 2022  ) -> None:.    "
+000248b0: 2222 0a20 2020 2043 6865 636b 2069 6620  "".    Check if 
+000248c0: 7468 6520 7379 6e63 2065 7665 6e74 2068  the sync event h
+000248d0: 6173 206f 6e65 206f 6620 7061 7373 6564  as one of passed
+000248e0: 2061 6c6c 6f77 6564 5f63 6861 6e67 655f   allowed_change_
+000248f0: 7479 7065 732e 0a0a 2020 2020 3a70 6172  types...    :par
+00024900: 616d 2065 7665 6e74 3a20 5379 6e63 4576  am event: SyncEv
+00024910: 656e 7420 746f 2063 6865 636b 2e0a 2020  ent to check..  
+00024920: 2020 3a70 6172 616d 2061 6c6c 6f77 6564    :param allowed
+00024930: 5f63 6861 6e67 655f 7479 7065 733a 2053  _change_types: S
+00024940: 6574 206f 6620 616c 6c6f 7765 6420 6368  et of allowed ch
+00024950: 616e 6765 2074 7970 6573 2e0a 2020 2020  ange types..    
+00024960: 3a72 6169 7365 7320 5661 6c75 6545 7272  :raises ValueErr
+00024970: 6f72 3a20 4966 2074 6865 2063 6861 6e67  or: If the chang
+00024980: 6520 7479 7065 2069 7320 6e6f 7420 696e  e type is not in
+00024990: 2074 6865 2061 6c6c 6f77 206c 6973 742e   the allow list.
+000249a0: 0a20 2020 2022 2222 0a20 2020 2069 6620  .    """.    if 
+000249b0: 6576 656e 742e 6368 616e 6765 5f74 7970  event.change_typ
+000249c0: 6520 6e6f 7420 696e 2061 6c6c 6f77 6564  e not in allowed
+000249d0: 5f63 6861 6e67 655f 7479 7065 733a 0a20  _change_types:. 
+000249e0: 2020 2020 2020 2072 6169 7365 2056 616c         raise Val
+000249f0: 7565 4572 726f 7228 0a20 2020 2020 2020  ueError(.       
+00024a00: 2020 2020 2066 2252 6571 7569 7265 2063       f"Require c
+00024a10: 6861 6e67 655f 7479 7065 2069 6e20 7b61  hange_type in {a
+00024a20: 6c6c 6f77 6564 5f63 6861 6e67 655f 7479  llowed_change_ty
+00024a30: 7065 737d 2062 7574 2022 0a20 2020 2020  pes} but ".     
+00024a40: 2020 2020 2020 2066 2266 6f75 6e64 207b         f"found {
+00024a50: 6576 656e 742e 6368 616e 6765 5f74 7970  event.change_typ
+00024a60: 657d 220a 2020 2020 2020 2020 290a       e}".        ).
```

### Comparing `maestral-1.7.3.dev3/src/maestral/utils/__init__.py` & `maestral-1.7.3.dev4/src/maestral/utils/__init__.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/utils/appdirs.py` & `maestral-1.7.3.dev4/src/maestral/utils/appdirs.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/utils/caches.py` & `maestral-1.7.3.dev4/src/maestral/utils/caches.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/utils/hashing.py` & `maestral-1.7.3.dev4/src/maestral/utils/hashing.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral/utils/path.py` & `maestral-1.7.3.dev4/src/maestral/utils/path.py`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral.egg-info/PKG-INFO` & `maestral-1.7.3.dev4/src/maestral.egg-info/PKG-INFO`

 * *Files 2% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: maestral
-Version: 1.7.3.dev3
+Version: 1.7.3.dev4
 Summary: Open-source Dropbox client for macOS and Linux.
 Author-email: Sam Schott <sam.schott@outlook.com>
 License: MIT
 Project-URL: Homepage, https://maestral.app
 Classifier: License :: OSI Approved :: MIT License
 Classifier: Operating System :: Unix
 Classifier: Programming Language :: Python
```

### Comparing `maestral-1.7.3.dev3/src/maestral.egg-info/SOURCES.txt` & `maestral-1.7.3.dev4/src/maestral.egg-info/SOURCES.txt`

 * *Files identical despite different names*

### Comparing `maestral-1.7.3.dev3/src/maestral.egg-info/requires.txt` & `maestral-1.7.3.dev4/src/maestral.egg-info/requires.txt`

 * *Files 3% similar despite different names*

```diff
@@ -28,18 +28,18 @@
 sphinxext-opengraph==0.8.2
 sphinx-autoapi==2.1.0
 sphinx-mdinclude==0.5.3
 
 [gui]
 
 [gui:sys_platform == "darwin"]
-maestral-cocoa>=1.7.3.dev3
+maestral-cocoa>=1.7.3.dev4
 
 [gui:sys_platform == "linux"]
-maestral-qt>=1.7.3.dev3
+maestral-qt>=1.7.3.dev4
 
 [lint]
 black
 flake8
 flake8-pyproject
 mypy
 pyupgrade
```

