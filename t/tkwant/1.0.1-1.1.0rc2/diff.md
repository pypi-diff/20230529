# Comparing `tmp/tkwant-1.0.1.tar.gz` & `tmp/tkwant-1.1.0rc2.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "dist/tkwant-1.0.1.tar", last modified: Wed Sep  2 15:31:25 2020, max compression
+gzip compressed data, was "dist/tkwant-1.1.0rc2.tar", last modified: Mon May 29 09:53:41 2023, max compression
```

## Comparing `tkwant-1.0.1.tar` & `tkwant-1.1.0rc2.tar`

### file list

```diff
@@ -1,147 +1,171 @@
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      252 2019-08-01 15:05:09.000000 tkwant-1.0.1/.coveragerc
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1513 2020-02-10 14:12:19.000000 tkwant-1.0.1/.gitlab-ci.yml
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      682 2020-09-02 13:58:49.000000 tkwant-1.0.1/AUTHORS.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     5477 2020-09-02 13:58:49.000000 tkwant-1.0.1/INSTALL.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1617 2019-07-02 11:11:31.000000 tkwant-1.0.1/LICENSE.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     4403 2020-09-02 15:31:25.000000 tkwant-1.0.1/MANIFEST.in
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     6361 2020-09-02 15:31:25.000000 tkwant-1.0.1/PKG-INFO
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     4498 2020-08-24 14:49:49.000000 tkwant-1.0.1/README.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      584 2019-08-14 18:56:25.000000 tkwant-1.0.1/conftest.py
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     8907 2020-06-30 15:44:11.000000 tkwant-1.0.1/doc/Makefile
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/examples/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1910 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/examples/1d_wire_high_level.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2889 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/examples/1d_wire_low_level.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2134 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/examples/1d_wire_onsite.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     4463 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/examples/alternative_boundary_conditions.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      526 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/examples/alternative_boundary_conditions.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2936 2020-08-12 09:28:50.000000 tkwant-1.0.1/doc/examples/closed_system.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1699 2020-09-02 13:58:49.000000 tkwant-1.0.1/doc/examples/closed_system.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2850 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/examples/graphene.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      977 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/examples/graphene.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2753 2020-09-02 13:58:43.000000 tkwant-1.0.1/doc/examples/open_system.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2288 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/examples/open_system.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     3666 2020-09-02 13:58:49.000000 tkwant-1.0.1/doc/examples/restarting.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     3869 2020-08-12 09:28:50.000000 tkwant-1.0.1/doc/examples/voltage_raise.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     3291 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/examples/voltage_raise.rst
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/kwantdoctheme/
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/kwantdoctheme/static/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     3576 2019-03-13 16:06:13.000000 tkwant-1.0.1/doc/kwantdoctheme/static/kwantdoctheme.css
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      614 2019-03-13 16:06:13.000000 tkwant-1.0.1/doc/kwantdoctheme/theme.conf
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/source/
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/source/_static/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1304 2019-03-13 16:35:38.000000 tkwant-1.0.1/doc/source/_static/kwant.css
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     3017 2019-03-13 16:35:38.000000 tkwant-1.0.1/doc/source/_static/kwant_logo.png
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      294 2019-03-13 16:35:38.000000 tkwant-1.0.1/doc/source/_static/mathconf.js
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     4914 2019-03-13 16:35:38.000000 tkwant-1.0.1/doc/source/_static/sidebar.js
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      293 2019-03-13 16:35:38.000000 tkwant-1.0.1/doc/source/_static/togglediv.js
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    12046 2020-06-30 15:44:11.000000 tkwant-1.0.1/doc/source/conf.py
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/source/extensions/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      290 2020-06-30 15:44:11.000000 tkwant-1.0.1/doc/source/extensions/index.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      235 2020-06-30 15:44:11.000000 tkwant-1.0.1/doc/source/index.rst
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/source/pre/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)       60 2019-03-15 13:13:23.000000 tkwant-1.0.1/doc/source/pre/about.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)       59 2019-07-02 11:11:31.000000 tkwant-1.0.1/doc/source/pre/authors.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      145 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/pre/cite.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      120 2020-06-30 15:44:11.000000 tkwant-1.0.1/doc/source/pre/index.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)       34 2019-07-02 11:11:31.000000 tkwant-1.0.1/doc/source/pre/installation.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)       34 2019-07-02 11:11:31.000000 tkwant-1.0.1/doc/source/pre/license.rst
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/source/reference/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      539 2020-02-10 14:12:19.000000 tkwant-1.0.1/doc/source/reference/index.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      235 2020-06-30 15:44:11.000000 tkwant-1.0.1/doc/source/reference/tkwant.integrate.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      745 2019-03-13 16:37:44.000000 tkwant-1.0.1/doc/source/reference/tkwant.leads.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      191 2020-02-10 14:12:19.000000 tkwant-1.0.1/doc/source/reference/tkwant.logging.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      717 2020-06-30 15:44:11.000000 tkwant-1.0.1/doc/source/reference/tkwant.manybody.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      410 2020-02-10 14:12:19.000000 tkwant-1.0.1/doc/source/reference/tkwant.mpi.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      468 2020-09-02 13:58:43.000000 tkwant-1.0.1/doc/source/reference/tkwant.onebody.kernel.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      425 2019-08-14 18:56:25.000000 tkwant-1.0.1/doc/source/reference/tkwant.onebody.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      387 2019-07-02 11:11:31.000000 tkwant-1.0.1/doc/source/reference/tkwant.onebody.solvers.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      441 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/reference/tkwant.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      333 2020-09-02 13:58:43.000000 tkwant-1.0.1/doc/source/reference/tkwant.system.rst
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/source/tutorial/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    30714 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/1d_chain_closed.png
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    43974 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/1d_chain_open.png
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    27128 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/boundary_condition.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      209 2019-03-13 16:35:38.000000 tkwant-1.0.1/doc/source/tutorial/common.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      184 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/examples.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    49339 2019-03-13 16:36:50.000000 tkwant-1.0.1/doc/source/tutorial/extended_system.png
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2398 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/fabry_perot.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2328 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/fabry_perot.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    67397 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/fabry_perot_grid.png
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     3004 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/faq.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     5834 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/getting_started.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      238 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/index.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2035 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/introduction.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     6710 2020-09-02 13:58:49.000000 tkwant-1.0.1/doc/source/tutorial/logging.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    12229 2020-09-02 13:58:43.000000 tkwant-1.0.1/doc/source/tutorial/manybody.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    25122 2020-09-02 13:58:43.000000 tkwant-1.0.1/doc/source/tutorial/manybody_advanced.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     4669 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/mpi.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    12837 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/onebody.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     5213 2020-09-02 13:58:43.000000 tkwant-1.0.1/doc/source/tutorial/onebody_advanced.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    61574 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/scattering_region.png
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    39276 2019-03-13 16:36:50.000000 tkwant-1.0.1/doc/source/tutorial/system_with_lead.png
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    10485 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/time_dep_system.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    69615 2020-08-24 14:49:49.000000 tkwant-1.0.1/doc/source/tutorial/toy.png
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/sphinxext/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2454 2019-03-13 16:37:44.000000 tkwant-1.0.1/doc/sphinxext/kwantdoc.py
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/templates/
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/doc/templates/autosummary/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      550 2019-03-13 16:06:13.000000 tkwant-1.0.1/doc/templates/autosummary/class.rst
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1493 2020-09-02 13:58:43.000000 tkwant-1.0.1/doc/templates/layout.html
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/docker/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1228 2020-09-02 13:58:43.000000 tkwant-1.0.1/docker/Dockerfile.debian
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      438 2020-06-30 15:44:11.000000 tkwant-1.0.1/docker/howto_make_and_upload_container.txt
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      283 2020-09-02 13:58:43.000000 tkwant-1.0.1/environment.yml
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      695 2020-08-24 14:49:49.000000 tkwant-1.0.1/pytest.ini
--rw-rw-r--   0 cwg       (1000) cwg       (1000)       63 2020-09-02 15:31:25.000000 tkwant-1.0.1/setup.cfg
--rwxrwxr-x   0 cwg       (1000) cwg       (1000)    16265 2020-09-02 15:26:38.000000 tkwant-1.0.1/setup.py
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1349 2020-06-30 15:44:11.000000 tkwant-1.0.1/tkwant/__init__.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     6242 2020-06-30 15:44:11.000000 tkwant-1.0.1/tkwant/_common.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     4516 2020-08-24 14:49:49.000000 tkwant-1.0.1/tkwant/_logging.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)       60 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant/_tkwant_version.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     4476 2020-02-10 14:12:19.000000 tkwant-1.0.1/tkwant/integration.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    77588 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/leads.py
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant/linalg/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)        0 2019-03-13 16:06:13.000000 tkwant-1.0.1/tkwant/linalg/__init__.pxd
--rw-rw-r--   0 cwg       (1000) cwg       (1000)        0 2019-03-13 16:06:13.000000 tkwant-1.0.1/tkwant/linalg/__init__.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    33730 2019-03-13 16:37:44.000000 tkwant-1.0.1/tkwant/linalg/blas.pxd
--rw-rw-r--   0 cwg       (1000) cwg       (1000)   105318 2019-03-14 12:23:46.000000 tkwant-1.0.1/tkwant/linalg/blas_sparse.c
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    13825 2019-03-13 16:37:44.000000 tkwant-1.0.1/tkwant/linalg/blas_sparse.pxd
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      386 2019-03-13 16:06:13.000000 tkwant-1.0.1/tkwant/linalg/blas_sparse.pyx
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    24895 2020-08-24 14:49:49.000000 tkwant-1.0.1/tkwant/line_segment.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)   101956 2020-08-24 14:49:49.000000 tkwant-1.0.1/tkwant/manybody.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     7418 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/mpi.py
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant/onebody/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      857 2019-07-02 11:11:31.000000 tkwant-1.0.1/tkwant/onebody/__init__.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)   857863 2019-07-03 11:53:01.000000 tkwant-1.0.1/tkwant/onebody/_sparse_blas_kernel.c
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     5562 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/onebody/_sparse_blas_kernel.pyx
--rw-rw-r--   0 cwg       (1000) cwg       (1000)  1705012 2020-09-02 14:01:14.000000 tkwant-1.0.1/tkwant/onebody/kernels.c
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      701 2019-03-13 16:49:21.000000 tkwant-1.0.1/tkwant/onebody/kernels.pxd
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    34391 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/onebody/kernels.pyx
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    22161 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/onebody/onebody.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)   240813 2020-09-02 14:01:14.000000 tkwant-1.0.1/tkwant/onebody/solvers.c
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2452 2020-09-02 13:58:49.000000 tkwant-1.0.1/tkwant/onebody/solvers.pyx
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant/onebody/tests/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)        0 2019-03-13 16:06:13.000000 tkwant-1.0.1/tkwant/onebody/tests/__init__.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    11333 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/onebody/tests/test_kernels.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    41258 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/onebody/tests/test_solvers.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     8330 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/system.py
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant/tests/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)       54 2019-03-13 16:06:13.000000 tkwant-1.0.1/tkwant/tests/__init__.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     3974 2019-03-13 16:35:38.000000 tkwant-1.0.1/tkwant/tests/common.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1440 2020-02-10 14:12:19.000000 tkwant-1.0.1/tkwant/tests/mpi_testdriver.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2371 2019-08-01 15:05:12.000000 tkwant-1.0.1/tkwant/tests/test_common.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     2874 2020-02-10 14:12:19.000000 tkwant-1.0.1/tkwant/tests/test_integration.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    24845 2020-06-30 15:44:11.000000 tkwant-1.0.1/tkwant/tests/test_leads.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     1832 2020-06-30 15:44:11.000000 tkwant-1.0.1/tkwant/tests/test_logging.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    79106 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/tests/test_manybody.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)    30574 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/tests/test_mpi.py
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     6638 2020-09-02 13:58:43.000000 tkwant-1.0.1/tkwant/tests/test_system.py
-drwxrwxr-x   0 cwg       (1000) cwg       (1000)        0 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant.egg-info/
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     6361 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant.egg-info/PKG-INFO
--rw-rw-r--   0 cwg       (1000) cwg       (1000)     3643 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant.egg-info/SOURCES.txt
--rw-rw-r--   0 cwg       (1000) cwg       (1000)        1 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant.egg-info/dependency_links.txt
--rw-rw-r--   0 cwg       (1000) cwg       (1000)      100 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant.egg-info/requires.txt
--rw-rw-r--   0 cwg       (1000) cwg       (1000)        7 2020-09-02 15:31:25.000000 tkwant-1.0.1/tkwant.egg-info/top_level.txt
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1617 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/LICENSE.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1009 2023-04-15 11:23:22.000000 tkwant-1.1.0rc2/changelog.txt
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/tkwant.egg-info/
+-rw-r--r--   0 cg229074 (65563) big      (30018)      100 2023-05-29 09:53:40.000000 tkwant-1.1.0rc2/tkwant.egg-info/requires.txt
+-rw-r--r--   0 cg229074 (65563) big      (30018)        1 2023-05-29 09:53:40.000000 tkwant-1.1.0rc2/tkwant.egg-info/dependency_links.txt
+-rw-r--r--   0 cg229074 (65563) big      (30018)     6509 2023-05-29 09:53:40.000000 tkwant-1.1.0rc2/tkwant.egg-info/PKG-INFO
+-rw-r--r--   0 cg229074 (65563) big      (30018)        7 2023-05-29 09:53:40.000000 tkwant-1.1.0rc2/tkwant.egg-info/top_level.txt
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4876 2023-05-29 09:53:40.000000 tkwant-1.1.0rc2/tkwant.egg-info/SOURCES.txt
+-rw-r--r--   0 cg229074 (65563) big      (30018)      584 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/conftest.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)      252 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/.coveragerc
+-rw-r--r--   0 cg229074 (65563) big      (30018)     7351 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/INSTALL.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     5844 2023-05-29 09:53:40.000000 tkwant-1.1.0rc2/MANIFEST.in
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/tkwant/
+-rw-r--r--   0 cg229074 (65563) big      (30018)     5077 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/integration.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    19503 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/greenfunctions.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)   102684 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/tkwant/manybody.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    24895 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/tkwant/line_segment.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    11651 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/tkwant/system.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    11830 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/tkwant/interaction.py
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/tkwant/onebody/
+-rw-r--r--   0 cg229074 (65563) big      (30018)    25469 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/tkwant/onebody/onebody.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)      556 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/onebody/kernels.pxd
+-rw-r--r--   0 cg229074 (65563) big      (30018)    35369 2023-05-02 15:57:55.000000 tkwant-1.1.0rc2/tkwant/onebody/kernels.pyx
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2681 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/tkwant/onebody/solvers.pyx
+-rw-r--r--   0 cg229074 (65563) big      (30018)      914 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/onebody/__init__.py
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/tkwant/onebody/tests/
+-rw-r--r--   0 cg229074 (65563) big      (30018)    13103 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/tkwant/onebody/tests/test_kernels.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    41249 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/onebody/tests/test_solvers.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)        0 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/tkwant/onebody/tests/__init__.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)   268550 2023-05-02 15:51:48.000000 tkwant-1.1.0rc2/tkwant/onebody/solvers.c
+-rw-r--r--   0 cg229074 (65563) big      (30018)  1767336 2023-05-02 15:57:59.000000 tkwant-1.1.0rc2/tkwant/onebody/kernels.c
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4738 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/_logging.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     7829 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/mpi.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1211 2023-05-05 14:44:14.000000 tkwant-1.1.0rc2/tkwant/__init__.py
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/tkwant/tests/
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1906 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/tests/test_logging.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    11140 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/tkwant/tests/test_interaction.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4031 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/tests/common.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2428 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/tests/test_common.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    30897 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/tkwant/tests/test_mpi.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)       54 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/tkwant/tests/__init__.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    26381 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/tests/test_leads.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1497 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/tests/mpi_testdriver.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2931 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/tests/test_integration.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     6290 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/tests/test_system.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    74588 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/tests/test_manybody.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    10122 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/tests/test_greenfunctions.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     8491 2023-05-02 15:05:07.000000 tkwant-1.1.0rc2/tkwant/special.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    77101 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/tkwant/leads.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     5076 2023-05-29 09:03:58.000000 tkwant-1.1.0rc2/tkwant/_common.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     6509 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/PKG-INFO
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/docker/
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1217 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/docker/Dockerfile.debian
+-rw-r--r--   0 cg229074 (65563) big      (30018)      438 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/docker/howto_make_and_upload_container.txt
+-rw-r--r--   0 cg229074 (65563) big      (30018)       63 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/setup.cfg
+-rw-r--r--   0 cg229074 (65563) big      (30018)      687 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/AUTHORS.rst
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/kwantdoctheme/
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/kwantdoctheme/static/
+-rw-r--r--   0 cg229074 (65563) big      (30018)     3576 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/kwantdoctheme/static/kwantdoctheme.css
+-rw-r--r--   0 cg229074 (65563) big      (30018)      614 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/kwantdoctheme/theme.conf
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/tutorial_source/
+-rw-r--r--   0 cg229074 (65563) big      (30018)     7254 2023-04-15 11:23:22.000000 tkwant-1.1.0rc2/doc/tutorial_source/logging.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     5001 2023-04-15 11:23:22.000000 tkwant-1.1.0rc2/doc/tutorial_source/siam_sudden_switch_plot_results.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     5702 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/chem_vs_elec_bias_run_computation.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     3571 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/voltage_raise.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1764 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/plasmon_plot_results.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    12964 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/onebody.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2481 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/open_system.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4213 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/voltage_raise.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1949 2023-04-15 11:23:22.000000 tkwant-1.1.0rc2/doc/tutorial_source/chem_vs_elec_bias_plot_results.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    48153 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/chem_vs_elec_bias_current.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    81972 2023-04-15 11:23:22.000000 tkwant-1.1.0rc2/doc/tutorial_source/fig_siam_sudden_switch.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    39276 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/system_with_lead.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    31413 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/adaptive_solver_sketch.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    67397 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/fabry_perot_grid.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    53665 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/bdg_junction_vj_vs_time.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)     6195 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/getting_started.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2889 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/1d_wire_low_level.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    41908 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/timescale_decoupling.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    49339 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/extended_system.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    30714 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/1d_chain_closed.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2750 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/fabry_perot.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1025 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/bdg_junction_plot_results.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     3004 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/faq.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     7465 2023-04-15 11:23:22.000000 tkwant-1.1.0rc2/doc/tutorial_source/siam_sudden_switch_run_computation.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    12282 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/doc/tutorial_source/pitfalls.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)    15903 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/boundstates.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)    12770 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/manybody.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)    11110 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/time_dep_system.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)    52097 2023-05-02 17:42:51.000000 tkwant-1.1.0rc2/doc/tutorial_source/green_functions.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)    61574 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/scattering_region.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)   729086 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/junction_lrc_circuit.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    43974 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/1d_chain_open.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    14788 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/junction_quantum_part.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    81750 2023-05-02 15:05:07.000000 tkwant-1.1.0rc2/doc/tutorial_source/self_consistent.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4237 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/plasmon_u_0_run_computation.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2936 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/closed_system.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2187 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/1d_wire_onsite.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1287 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/graphene.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1856 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/closed_system.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     3651 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/introduction.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)    62687 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/chem_vs_elec_bias_scheme.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)    22142 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/chem_vs_elec_bias.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)    68464 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/plasmon_propagation.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4654 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/mpi.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      209 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/examples.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2773 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/open_system.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4097 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/restarting.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     5340 2023-04-17 20:01:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/onebody_advanced.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)    69615 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/toy.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)     6670 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/bdg_junction_run_computation.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    22533 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/manybody_advanced.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4641 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/alternative_boundary_conditions.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4677 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/plasmon_u_10_run_computation.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1910 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/1d_wire_high_level.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)    27261 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/boundary_condition.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      684 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/tutorial_source/alternative_boundary_conditions.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     3210 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/graphene.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2718 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/tutorial_source/fabry_perot.py
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/material/
+-rw-r--r--   0 cg229074 (65563) big      (30018)     3225 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/material/make_figure_timescale_decoupling.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)   752860 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/material/adaptive_solver.ai
+-rw-r--r--   0 cg229074 (65563) big      (30018)    70147 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/material/figures_junction_circuit_and_quantum_part.svg
+-rw-r--r--   0 cg229074 (65563) big      (30018)     9030 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/Makefile
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/templates/
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/templates/autosummary/
+-rw-r--r--   0 cg229074 (65563) big      (30018)      550 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/templates/autosummary/class.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1493 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/templates/layout.html
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/sphinxext/
+-rw-r--r--   0 cg229074 (65563) big      (30018)     2553 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/doc/sphinxext/kwantdoc.py
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/source/
+-rw-r--r--   0 cg229074 (65563) big      (30018)    12046 2023-05-02 09:50:34.000000 tkwant-1.1.0rc2/doc/source/conf.py
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/source/extensions/
+-rw-r--r--   0 cg229074 (65563) big      (30018)      290 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/source/extensions/index.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      235 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/source/index.rst
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/source/tutorial/
+-rw-r--r--   0 cg229074 (65563) big      (30018)      307 2023-05-02 15:02:37.000000 tkwant-1.1.0rc2/doc/source/tutorial/index.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      209 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/tutorial/common.py
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/source/pre/
+-rw-r--r--   0 cg229074 (65563) big      (30018)      134 2023-04-15 11:23:22.000000 tkwant-1.1.0rc2/doc/source/pre/index.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)       59 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/pre/authors.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)       34 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/pre/installation.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)       95 2023-04-15 11:23:22.000000 tkwant-1.1.0rc2/doc/source/pre/whats_new.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      477 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/source/pre/cite.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)       60 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/pre/about.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)       34 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/pre/license.rst
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/source/reference/
+-rw-r--r--   0 cg229074 (65563) big      (30018)      539 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/reference/index.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      745 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.leads.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      410 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.mpi.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      387 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.onebody.solvers.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      441 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      235 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.integrate.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      717 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.manybody.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      425 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.onebody.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      300 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.system.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      191 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.logging.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)      453 2023-04-17 15:38:35.000000 tkwant-1.1.0rc2/doc/source/reference/tkwant.onebody.kernel.rst
+drwxr-xr-x   0 cg229074 (65563) big      (30018)        0 2023-05-29 09:53:41.000000 tkwant-1.1.0rc2/doc/source/_static/
+-rw-r--r--   0 cg229074 (65563) big      (30018)      293 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/_static/togglediv.js
+-rw-r--r--   0 cg229074 (65563) big      (30018)      294 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/_static/mathconf.js
+-rw-r--r--   0 cg229074 (65563) big      (30018)     3017 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/_static/kwant_logo.png
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4914 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/_static/sidebar.js
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1304 2022-06-04 13:27:44.000000 tkwant-1.1.0rc2/doc/source/_static/kwant.css
+-rwxr-xr-x   0 cg229074 (65563) big      (30018)    14343 2023-05-29 08:54:19.000000 tkwant-1.1.0rc2/setup.py
+-rw-r--r--   0 cg229074 (65563) big      (30018)      283 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/environment.yml
+-rw-r--r--   0 cg229074 (65563) big      (30018)     4643 2023-05-02 09:06:37.000000 tkwant-1.1.0rc2/README.rst
+-rw-r--r--   0 cg229074 (65563) big      (30018)     1959 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/.gitlab-ci.yml
+-rw-r--r--   0 cg229074 (65563) big      (30018)      695 2023-04-15 11:20:55.000000 tkwant-1.1.0rc2/pytest.ini
```

### Comparing `tkwant-1.0.1/.gitlab-ci.yml` & `tkwant-1.1.0rc2/.gitlab-ci.yml`

 * *Files 16% similar despite different names*

```diff
@@ -1,14 +1,14 @@
 image: gitlab.kwant-project.org:5005/kwant/tkwant:latest
 
 variables:
       GIT_STRATEGY: clone
       # rsync is used to send documentation to our web servers: we never send any
       # secret information, and using 'ssh-keyscan' causes the CI server's IP to be blacklisted
-      IGNORE_HOSTKEY: "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
+      SSH_COMMAND: "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
       OMP_NUM_THREADS: "1"
 
 
 stages:
     - build
     - test
     - deploy
@@ -36,25 +36,37 @@
     script:
         - make -C doc clean ; make -C doc doctest html
     artifacts:
       paths:
         - doc/build/html/
       expire_in: 1 week
 
-upload docs:
+upload dev docs:
   stage: deploy
   environment:
     name: production
-    url: https://kwant-project.org/extensions/tkwant/
+    url: https://tkwant.kwant-project.org/doc/dev/
   only:
     - master@kwant/tkwant
-  before_script:
-    - mkdir -p ~/.ssh
-    - echo $WEBSITE_KEY | base64 -d > ~/.ssh/id_rsa && chmod 600 ~/.ssh/id_rsa
   script:
-    # The webserver is set up such that when we log in with WEBSITE_KEY rsync can only
-    # see the relevant tkwant subfolder of the website, hence why we do not specify an
-    # explicit path on the remote machine.
-    - rsync -rlv -e "$IGNORE_HOSTKEY" --delete doc/build/html/* "kwant@kwant-project.org:"
-  after_script:
-    - rm -rf ~/.ssh
+    - eval $(ssh-agent -s)
+    - echo $WEBSITE_KEY | base64 -d | ssh-add -
+    # Server-side we use rrsync to restrict access to the tkwant website directory.
+    - rsync -rlv -e "$SSH_COMMAND" --delete doc/build/html/* "kwant@kwant-project.org:doc/dev/"
 
+upload stable docs:
+  stage: deploy
+  environment:
+    name: production
+    url: https://tkwant.kwant-project.org/doc/
+  only:
+    - tags
+  script:
+    - desc=$(git describe --first-parent)
+    # Do nothing if this commit is not versioned.
+    - echo "$desc" | egrep -q '^v[0-9]+\.[0-9]+\.[0-9]+$' || exit 0
+    # Extract version in x.y format.
+    - ver=$(echo "$desc" | egrep -o '[0-9]+\.[0-9]+')
+    - eval $(ssh-agent -s)
+    - echo $WEBSITE_KEY | base64 -d | ssh-add -
+    # Server-side we use rrsync to restrict access to the tkwant website directory.
+    - rsync -rlv -e "$SSH_COMMAND" --delete doc/build/html/* "kwant@kwant-project.org:doc/$ver/"
```

### Comparing `tkwant-1.0.1/AUTHORS.rst` & `tkwant-1.1.0rc2/AUTHORS.rst`

 * *Files 24% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 The tkwant authors can be reached at tkwant-authors@kwant-project.org.
 
 The principal developers of tkwant are
 
 * Joseph Weston (TU Delft, CEA Grenoble)
-* Thomas Kloss (CEA Grenoble, HLRS)
+* Thomas Kloss (CEA Grenoble, CNRS)
 * Christoph Groth (CEA Grenoble)
 * Xavier Waintal (CEA Grenoble)
 
 Contributors to tkwant include
 
 * Benoît Gaury (CEA Grenoble)
 * Benoît Rossignol (CEA Grenoble)
@@ -15,8 +15,8 @@
 * Phillipp Reck (CEA Saclay)
 * Adel Kara Slimane (CEA Saclay)
 * Geneviève Fleury (CEA Saclay)
 * Baptiste Anselme Martin (CEA Grenoble)
 * Bas Nijholt (Microsoft)
 
 (CEA = Commissariat à l'énergie atomique et aux énergies alternatives,
-HLRS = Höchstleistungsrechenzentrum Stuttgart)
+CNRS = Centre national de la recherche scientifique)
```

### Comparing `tkwant-1.0.1/INSTALL.rst` & `tkwant-1.1.0rc2/INSTALL.rst`

 * *Files 16% similar despite different names*

```diff
@@ -1,60 +1,110 @@
 .. _install:
 
 Installation
 ============
 
 Tkwant provides conda packages for the installation on Linux, MacOS and Windows.
-Building the package from source for a GNU/Linux system as Debian and Ubuntu is also described below, but it is needed
+Prebuild packages also exist for GNU/Linux systems as Ubuntu and Debian.
+Building the package from source for a GNU/Linux system is also described below, but it is needed
 only for developement.
 
 Conda
 ^^^^^
 
 Tkwant provides conda packages for GNU/Linux, MacOS and Microsoft Windows on the `conda-forge <https://conda-forge.org/>`_ channel.
 First, the `Anaconda <https://www.anaconda.com/products/individual>`_
-Python distribution must be installed. 
-After that, tkwant can be installed with the command::
+Python distribution must be installed. Currently, Python versions of 3.6 and 3.7 are supported for Tkwant.
+We show here the installation with a virtual environment, in order not to affect already installed packages on conda.
+Note that once Tkwant is installed, the environment must be activated for each session in order to use Tkwant::
 
-    conda install -c conda-forge tkwant
+    conda activate env-tkwant
+
+
+Linux and MacOS
+---------------
+
+Tkwant can be installed with the commands::
+
+    conda create -n env-tkwant python=3.7
+    conda activate env-tkwant
+    conda install tkwant -c conda-forge
 
-An additional step is required on a Windows system.
 
 Windows
 -------
 The package `mpi4py <https://mpi4py.readthedocs.io/en/stable/>`_,
 which is required by tkwant, is not provided for Windows by conda-forge and must be installed separately.
-The intel conda channel offers the possibility to install mpi4py with::
+Tkwant can be installed on a Windows computer with the commands::
 
+    conda create -n env-tkwant python=3.7
+    conda activate env-tkwant
     conda install -c intel mpi4py
+    conda install tkwant -c conda-forge
+
+GNU/Linux
+^^^^^^^^^
+Prebuild packages exist for GNU/Linux systems as Ubuntu and Debian.
+
+Ubuntu and derivatives
+----------------------
+Currently only the Ubuntu version 20.04 LTS is supported.
+Tkwant can be installed with the following commands::
+
+    sudo apt-add-repository -s ppa:kwant-project/ppa
+    sudo apt-get update
+    sudo apt-get install python3-tkwant
+
+Debian and derivatives
+----------------------
+The installation of Tkwant is quite similar to the `installation instructions of Kwant <https://kwant-project.org/doc/1/pre/install>`_.
+
+1. Add the following lines to ``/etc/apt/sources.list``::
 
+    deb http://ftp.debian.org/debian stretch-backports main
+    deb http://downloads.kwant-project.org/debian/ stretch-backports main
+    deb-src http://downloads.kwant-project.org/debian/ stretch-backports main
+
+2. (Optional) Add the OpenPGP key used to sign the repositories by executing::
+
+        apt-key adv --keyserver pool.sks-keyservers.net --recv-key C3F147F5980F3535
+
+  The fingerprint of the key is 5229 9057 FAD7 9965 3C4F 088A C3F1 47F5 980F 3535.
+
+3. Update the package data, and install Tkwant::
+
+    apt-get update
+    apt-get -t stretch-backports install python3-tkwant
 
 Installation from source
 ^^^^^^^^^^^^^^^^^^^^^^^^
-Installation from source is more involved, as Tkwant includes compiled Cython modules and non-Python dependencies.
+
+Installing Tkwant from the official repository or with pip is more involved because Tkwant has several non-Python dependencies and requires a C compiler. 
+It is therefore recommended for advanced users only.
 As a first step, the required Python and non-Python dependencies, which are listed below, must
-be installed "by hand".
+be installed.
 In a second step, the Cython modules of Tkwant must be compiled.
 
 Requirements
 ------------
 
+Building requirements
+*********************
+
 Tkwant requires several non-Python dependencies:
 
 - C compiler (eg. `gcc <https://gcc.gnu.org/>`_)
-- `BLAS <http://www.netlib.org/blas/>`_ (eg. `OpenBLAS <http://www.openblas.net/>`_)
-- `Sparse BLAS <http://librsb.sourceforge.net/>`_
 - `MPI <https://www.mpi-forum.org/>`_ (eg. `Open MPI <https://www.open-mpi.org/>`_)
 - `Kwant <https://kwant-project.org/>`_
 
 The non-Python dependencies of Tkwant can be installed with the following command::
 
    sudo apt-add-repository -s ppa:kwant-project/ppa
    sudo apt-get update
-   sudo apt-get install build-essential libopenblas-dev librsb-dev libopenmpi-dev python3-kwant
+   sudo apt-get install build-essential libopenmpi-dev python3-kwant
 
 Tkwant requires at least Python 3.4. The following Python packages must
 be installed to build tkwant:
 
 - `Cython <https://cython.org/>`_
 - `NumPy <https://numpy.org/>`_
 - `SciPy <https://www.scipy.org/>`_
@@ -104,20 +154,25 @@
 
     python3 -m pip install --user sphinx jupyter-sphinx matplotlib
 
 
 Installing tkwant from source
 -----------------------------
 
-Tkwant can be installed from the `official tkwant git repository <https://gitlab.kwant-project.org/kwant/tkwant>`_.
+Tkwant can be installed from the `official tkwant git repository <https://gitlab.kwant-project.org/kwant/tkwant>`_ or from the standard Python package manager `pip <https://pip.pypa.io/en/stable/>`_.
 Make sure that all required packages are installed before installing Tkwant.
-The `installation instructions of Kwant <https://kwant-project.org/doc/1/pre/install>`_ apply mostly also to tkwant, but in many cases installation will be as simple as::
+The `installation instructions of Kwant <https://kwant-project.org/doc/1/pre/install>`_ apply mostly also to tkwant.
+To install Tkwant form the official git repository execute::
 
     python3 -m pip install --user git+https://gitlab.kwant-project.org/kwant/tkwant.git
 
+Alternatively install Tkwant using *pip* with::
+
+    python3 -m pip install --user tkwant
+
 Installing tkwant is convenient for users which only like to use the existing tkwant module.
 If one is interested to also modify or develop the tkwant code,
 the instructions "Building tkwant for development" described below are more appropriate.
 
 Building tkwant for development
 -------------------------------
```

### Comparing `tkwant-1.0.1/LICENSE.rst` & `tkwant-1.1.0rc2/LICENSE.rst`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/MANIFEST.in` & `tkwant-1.1.0rc2/MANIFEST.in`

 * *Files 27% similar despite different names*

```diff
@@ -1,115 +1,141 @@
 include .coveragerc
 include .gitlab-ci.yml
 include AUTHORS.rst
 include INSTALL.rst
 include LICENSE.rst
 include README.rst
+include changelog.txt
 include conftest.py
 include doc/Makefile
-include doc/examples/1d_wire_high_level.py
-include doc/examples/1d_wire_low_level.py
-include doc/examples/1d_wire_onsite.py
-include doc/examples/alternative_boundary_conditions.py
-include doc/examples/alternative_boundary_conditions.rst
-include doc/examples/closed_system.py
-include doc/examples/closed_system.rst
-include doc/examples/graphene.py
-include doc/examples/graphene.rst
-include doc/examples/open_system.py
-include doc/examples/open_system.rst
-include doc/examples/restarting.rst
-include doc/examples/voltage_raise.py
-include doc/examples/voltage_raise.rst
 include doc/kwantdoctheme/static/kwantdoctheme.css
 include doc/kwantdoctheme/theme.conf
+include doc/material/adaptive_solver.ai
+include doc/material/figures_junction_circuit_and_quantum_part.svg
+include doc/material/make_figure_timescale_decoupling.py
 include doc/source/_static/kwant.css
 include doc/source/_static/kwant_logo.png
 include doc/source/_static/mathconf.js
 include doc/source/_static/sidebar.js
 include doc/source/_static/togglediv.js
 include doc/source/conf.py
 include doc/source/extensions/index.rst
 include doc/source/index.rst
 include doc/source/pre/about.rst
 include doc/source/pre/authors.rst
 include doc/source/pre/cite.rst
 include doc/source/pre/index.rst
 include doc/source/pre/installation.rst
 include doc/source/pre/license.rst
+include doc/source/pre/whats_new.rst
 include doc/source/reference/index.rst
 include doc/source/reference/tkwant.integrate.rst
 include doc/source/reference/tkwant.leads.rst
 include doc/source/reference/tkwant.logging.rst
 include doc/source/reference/tkwant.manybody.rst
 include doc/source/reference/tkwant.mpi.rst
 include doc/source/reference/tkwant.onebody.kernel.rst
 include doc/source/reference/tkwant.onebody.rst
 include doc/source/reference/tkwant.onebody.solvers.rst
 include doc/source/reference/tkwant.rst
 include doc/source/reference/tkwant.system.rst
-include doc/source/tutorial/1d_chain_closed.png
-include doc/source/tutorial/1d_chain_open.png
-include doc/source/tutorial/boundary_condition.rst
 include doc/source/tutorial/common.py
-include doc/source/tutorial/examples.rst
-include doc/source/tutorial/extended_system.png
-include doc/source/tutorial/fabry_perot.py
-include doc/source/tutorial/fabry_perot.rst
-include doc/source/tutorial/fabry_perot_grid.png
-include doc/source/tutorial/faq.rst
-include doc/source/tutorial/getting_started.rst
 include doc/source/tutorial/index.rst
-include doc/source/tutorial/introduction.rst
-include doc/source/tutorial/logging.rst
-include doc/source/tutorial/manybody.rst
-include doc/source/tutorial/manybody_advanced.rst
-include doc/source/tutorial/mpi.rst
-include doc/source/tutorial/onebody.rst
-include doc/source/tutorial/onebody_advanced.rst
-include doc/source/tutorial/scattering_region.png
-include doc/source/tutorial/system_with_lead.png
-include doc/source/tutorial/time_dep_system.rst
-include doc/source/tutorial/toy.png
 include doc/sphinxext/kwantdoc.py
 include doc/templates/autosummary/class.rst
 include doc/templates/layout.html
+include doc/tutorial_source/1d_chain_closed.png
+include doc/tutorial_source/1d_chain_open.png
+include doc/tutorial_source/1d_wire_high_level.py
+include doc/tutorial_source/1d_wire_low_level.py
+include doc/tutorial_source/1d_wire_onsite.py
+include doc/tutorial_source/adaptive_solver_sketch.png
+include doc/tutorial_source/alternative_boundary_conditions.py
+include doc/tutorial_source/alternative_boundary_conditions.rst
+include doc/tutorial_source/bdg_junction_plot_results.py
+include doc/tutorial_source/bdg_junction_run_computation.py
+include doc/tutorial_source/bdg_junction_vj_vs_time.png
+include doc/tutorial_source/boundary_condition.rst
+include doc/tutorial_source/boundstates.rst
+include doc/tutorial_source/chem_vs_elec_bias.rst
+include doc/tutorial_source/chem_vs_elec_bias_current.png
+include doc/tutorial_source/chem_vs_elec_bias_plot_results.py
+include doc/tutorial_source/chem_vs_elec_bias_run_computation.py
+include doc/tutorial_source/chem_vs_elec_bias_scheme.png
+include doc/tutorial_source/closed_system.py
+include doc/tutorial_source/closed_system.rst
+include doc/tutorial_source/examples.rst
+include doc/tutorial_source/extended_system.png
+include doc/tutorial_source/fabry_perot.py
+include doc/tutorial_source/fabry_perot.rst
+include doc/tutorial_source/fabry_perot_grid.png
+include doc/tutorial_source/faq.rst
+include doc/tutorial_source/fig_siam_sudden_switch.png
+include doc/tutorial_source/getting_started.rst
+include doc/tutorial_source/graphene.py
+include doc/tutorial_source/graphene.rst
+include doc/tutorial_source/green_functions.rst
+include doc/tutorial_source/introduction.rst
+include doc/tutorial_source/junction_lrc_circuit.png
+include doc/tutorial_source/junction_quantum_part.png
+include doc/tutorial_source/logging.rst
+include doc/tutorial_source/manybody.rst
+include doc/tutorial_source/manybody_advanced.rst
+include doc/tutorial_source/mpi.rst
+include doc/tutorial_source/onebody.rst
+include doc/tutorial_source/onebody_advanced.rst
+include doc/tutorial_source/open_system.py
+include doc/tutorial_source/open_system.rst
+include doc/tutorial_source/pitfalls.rst
+include doc/tutorial_source/plasmon_plot_results.py
+include doc/tutorial_source/plasmon_propagation.png
+include doc/tutorial_source/plasmon_u_0_run_computation.py
+include doc/tutorial_source/plasmon_u_10_run_computation.py
+include doc/tutorial_source/restarting.rst
+include doc/tutorial_source/scattering_region.png
+include doc/tutorial_source/self_consistent.rst
+include doc/tutorial_source/siam_sudden_switch_plot_results.py
+include doc/tutorial_source/siam_sudden_switch_run_computation.py
+include doc/tutorial_source/system_with_lead.png
+include doc/tutorial_source/time_dep_system.rst
+include doc/tutorial_source/timescale_decoupling.png
+include doc/tutorial_source/toy.png
+include doc/tutorial_source/voltage_raise.py
+include doc/tutorial_source/voltage_raise.rst
 include docker/Dockerfile.debian
 include docker/howto_make_and_upload_container.txt
 include environment.yml
 include pytest.ini
 include setup.cfg
 include setup.py
 include tkwant/__init__.py
 include tkwant/_common.py
 include tkwant/_logging.py
-include tkwant/_tkwant_version.py
+include tkwant/greenfunctions.py
 include tkwant/integration.py
+include tkwant/interaction.py
 include tkwant/leads.py
-include tkwant/linalg/__init__.pxd
-include tkwant/linalg/__init__.py
-include tkwant/linalg/blas.pxd
-include tkwant/linalg/blas_sparse.pxd
-include tkwant/linalg/blas_sparse.pyx tkwant/linalg/blas_sparse.c
 include tkwant/line_segment.py
 include tkwant/manybody.py
 include tkwant/mpi.py
 include tkwant/onebody/__init__.py
-include tkwant/onebody/_sparse_blas_kernel.pyx tkwant/onebody/_sparse_blas_kernel.c
 include tkwant/onebody/kernels.pxd
 include tkwant/onebody/kernels.pyx tkwant/onebody/kernels.c
 include tkwant/onebody/onebody.py
 include tkwant/onebody/solvers.pyx tkwant/onebody/solvers.c
 include tkwant/onebody/tests/__init__.py
 include tkwant/onebody/tests/test_kernels.py
 include tkwant/onebody/tests/test_solvers.py
+include tkwant/special.py
 include tkwant/system.py
 include tkwant/tests/__init__.py
 include tkwant/tests/common.py
 include tkwant/tests/mpi_testdriver.py
 include tkwant/tests/test_common.py
+include tkwant/tests/test_greenfunctions.py
 include tkwant/tests/test_integration.py
+include tkwant/tests/test_interaction.py
 include tkwant/tests/test_leads.py
 include tkwant/tests/test_logging.py
 include tkwant/tests/test_manybody.py
 include tkwant/tests/test_mpi.py
 include tkwant/tests/test_system.py
```

### Comparing `tkwant-1.0.1/PKG-INFO` & `tkwant-1.1.0rc2/tkwant.egg-info/PKG-INFO`

 * *Files 25% similar despite different names*

```diff
@@ -1,31 +1,31 @@
 Metadata-Version: 1.1
 Name: tkwant
-Version: 1.0.1
+Version: 1.1.0rc2
 Summary: Package for time-dependent quantum transport simulations
 Home-page: https://tkwant.kwant-project.org/
 Author: tkwant authors
 Author-email: tkwant-authors@kwant-project.org
 License: BSD
 Description: Tkwant is a python package to simulate time-dependent quantum dynamics of
         mesoscopic systems. It is the time-dependent generalization of the
-        `Kwant <http://kwant-project.org>`_ package and distributed under `2-clause BSD license  <https://kwant-project.org/extensions/tkwant/pre/license>`_.
-        Tkwant is developed by the following `authors  <https://kwant-project.org/extensions/tkwant/pre/authors>`_.
+        `Kwant <https://kwant-project.org>`_ package and distributed under `2-clause BSD license  <https://tkwant.kwant-project.org/doc/stable/pre/license.html>`_.
+        Tkwant is developed by the following `authors  <https://tkwant.kwant-project.org/doc/stable/pre/authors.html>`_.
         
         - Website: https://tkwant.kwant-project.org
         
         
         Installation
         ------------
         
         Installation from source
         ~~~~~~~~~~~~~~~~~~~~~~~~
         
         Tkwant can currently only installed from its source.
-        Please visit the `installation instructions <https://kwant-project.org/extensions/tkwant/pre/installation>`_.
+        Please visit the `installation instructions <https://tkwant.kwant-project.org/doc/stable/pre/installation.html>`_.
         
         
         Development
         -----------
         
         Source code
         ~~~~~~~~~~~
@@ -48,15 +48,15 @@
             pytest --integtest
         
         Tests involving MPI can be run by the command::
         
             pytest --mpitest
         
         The test suite needs the Python packages ``pytest`` to be installed and tkwant compiled.
-        Please visit the `installation instructions <https://kwant-project.org/extensions/tkwant/pre/installation>`_.
+        Please visit the `installation instructions <https://tkwant.kwant-project.org/doc/stable/pre/installation.html>`_.
         Additional pep8 compliance checks can be activated with::
         
             pytest --flake8
         
         when the optional `pytest-flake8 <https://pypi.org/project/pytest-flake8/>`_
         package is installed.
         
@@ -69,15 +69,15 @@
         
             make html
         
         
         The generated html documentation can be browsed
         by opening the file ``doc/build/html/index.html`` with a web browser.
         To build the documentation, additional Python packages need to be installed.
-        Please visit the `installation instructions <https://kwant-project.org/extensions/tkwant/pre/installation>`_.
+        Please visit the `installation instructions <https://tkwant.kwant-project.org/doc/stable/pre/installation.html>`_.
         
         Contribution
         ~~~~~~~~~~~~
         Contributions and feedback to tkwant are always welcome.
         We also appreciate if you have suggestions for the documentation or find new bugs.
         If you like to contribute new features,
         feel free do discuss your ideas on the mailing list before opening a merge request.
@@ -86,45 +86,43 @@
         See the `Contribution <https://kwant-project.org/contribute>`_
         section of kwant for coding style and general advice.
         
         Authors
         ~~~~~~~
         
         Tkwant is developed by the following
-        `authors  <https://kwant-project.org/extensions/tkwant/pre/authors>`_.
+        `authors  <https://tkwant.kwant-project.org/doc/stable/pre/authors.html>`_.
         
         License
         ~~~~~~~
         Tkwant is distributed under
-        `2-clause BSD license <https://kwant-project.org/extensions/tkwant/pre/license>`_.
+        `2-clause BSD license <https://tkwant.kwant-project.org/doc/stable/pre/license.html>`_.
         The license can be also found in file ``LICENSE.rst`` in the project repository.
         
         Help and Support
         ----------------
         
         Documentation
         ~~~~~~~~~~~~~
         
         The official user and developer documentation is found under:
         
-        - Documentation: https://kwant-project.org/extensions/tkwant
+        - stable: https://tkwant.kwant-project.org/doc/stable
+        - development (master branch): https://tkwant.kwant-project.org/doc/dev
         
         Communication
         ~~~~~~~~~~~~~
         
         The kwant-discuss mailing list is the main communication channel for
         questions and discussions around tkwant. Searching and using the mailing list
         is explained in section
         `mailing list <https://kwant-project.org/community#mailing-list>`_.
         
         - Mailing list: kwant-discuss@kwant-project.org
         
-        In addition, the `authors  <https://kwant-project.org/extensions/tkwant/pre/authors>`_
-        can be reached by email.
-        
         
         Reporting bugs
         ~~~~~~~~~~~~~~
         
         If you encounter a problem that seems to be a bug of tkwant, you can open a ticket
         with the issue tracker.
         
@@ -140,15 +138,17 @@
         Citation
         ~~~~~~~~
         
         If you have used tkwant for work that has lead to a scientific publication,
         we would appreciate if you cite the publication which introduces tkwant:
         
         T. Kloss, J. Weston, B. Gaury, B. Rossignol, C. Groth and X. Waintal,
-        Tkwant: a software package for time-dependent quantum transport.
+        `Tkwant: a software package for time-dependent quantum transport <https://doi.org/10.1088/1367-2630/abddf7>`_
+        New J. Phys. **23**, 023025 (2021),
+        `arXiv:2009.03132 [cond-mat.mes-hall]. <https://arxiv.org/abs/2009.03132>`_
 Platform: Unix
 Platform: Linux
 Platform: Mac OS-X
 Platform: Windows
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Science/Research
 Classifier: Programming Language :: Python :: 3 :: Only
```

### Comparing `tkwant-1.0.1/README.rst` & `tkwant-1.1.0rc2/README.rst`

 * *Files 7% similar despite different names*

```diff
@@ -1,23 +1,23 @@
 Tkwant is a python package to simulate time-dependent quantum dynamics of
 mesoscopic systems. It is the time-dependent generalization of the 
-`Kwant <http://kwant-project.org>`_ package and distributed under `2-clause BSD license  <https://kwant-project.org/extensions/tkwant/pre/license>`_.
-Tkwant is developed by the following `authors  <https://kwant-project.org/extensions/tkwant/pre/authors>`_.
+`Kwant <https://kwant-project.org>`_ package and distributed under `2-clause BSD license  <https://tkwant.kwant-project.org/doc/stable/pre/license.html>`_.
+Tkwant is developed by the following `authors  <https://tkwant.kwant-project.org/doc/stable/pre/authors.html>`_.
 
 - Website: https://tkwant.kwant-project.org
 
 
 Installation
 ------------
 
 Installation from source
 ~~~~~~~~~~~~~~~~~~~~~~~~
 
 Tkwant can currently only installed from its source.
-Please visit the `installation instructions <https://kwant-project.org/extensions/tkwant/pre/installation>`_.
+Please visit the `installation instructions <https://tkwant.kwant-project.org/doc/stable/pre/installation.html>`_.
 
 
 Development
 -----------
 
 Source code
 ~~~~~~~~~~~
@@ -40,15 +40,15 @@
     pytest --integtest
 
 Tests involving MPI can be run by the command::
 
     pytest --mpitest
 
 The test suite needs the Python packages ``pytest`` to be installed and tkwant compiled.
-Please visit the `installation instructions <https://kwant-project.org/extensions/tkwant/pre/installation>`_.
+Please visit the `installation instructions <https://tkwant.kwant-project.org/doc/stable/pre/installation.html>`_.
 Additional pep8 compliance checks can be activated with::
 
     pytest --flake8
 
 when the optional `pytest-flake8 <https://pypi.org/project/pytest-flake8/>`_
 package is installed.
 
@@ -61,15 +61,15 @@
 
     make html
 
 
 The generated html documentation can be browsed
 by opening the file ``doc/build/html/index.html`` with a web browser.
 To build the documentation, additional Python packages need to be installed.
-Please visit the `installation instructions <https://kwant-project.org/extensions/tkwant/pre/installation>`_.
+Please visit the `installation instructions <https://tkwant.kwant-project.org/doc/stable/pre/installation.html>`_.
 
 Contribution
 ~~~~~~~~~~~~
 Contributions and feedback to tkwant are always welcome.
 We also appreciate if you have suggestions for the documentation or find new bugs.
 If you like to contribute new features,
 feel free do discuss your ideas on the mailing list before opening a merge request.
@@ -78,45 +78,43 @@
 See the `Contribution <https://kwant-project.org/contribute>`_
 section of kwant for coding style and general advice.
 
 Authors
 ~~~~~~~
 
 Tkwant is developed by the following
-`authors  <https://kwant-project.org/extensions/tkwant/pre/authors>`_.
+`authors  <https://tkwant.kwant-project.org/doc/stable/pre/authors.html>`_.
 
 License
 ~~~~~~~
 Tkwant is distributed under 
-`2-clause BSD license <https://kwant-project.org/extensions/tkwant/pre/license>`_.
+`2-clause BSD license <https://tkwant.kwant-project.org/doc/stable/pre/license.html>`_.
 The license can be also found in file ``LICENSE.rst`` in the project repository.
 
 Help and Support
 ----------------
 
 Documentation
 ~~~~~~~~~~~~~
 
 The official user and developer documentation is found under:
 
-- Documentation: https://kwant-project.org/extensions/tkwant
+- stable: https://tkwant.kwant-project.org/doc/stable
+- development (master branch): https://tkwant.kwant-project.org/doc/dev
 
 Communication
 ~~~~~~~~~~~~~
 
 The kwant-discuss mailing list is the main communication channel for
 questions and discussions around tkwant. Searching and using the mailing list
 is explained in section
 `mailing list <https://kwant-project.org/community#mailing-list>`_.
 
 - Mailing list: kwant-discuss@kwant-project.org
 
-In addition, the `authors  <https://kwant-project.org/extensions/tkwant/pre/authors>`_
-can be reached by email.
-
 
 Reporting bugs
 ~~~~~~~~~~~~~~
 
 If you encounter a problem that seems to be a bug of tkwant, you can open a ticket
 with the issue tracker.
 
@@ -132,8 +130,10 @@
 Citation
 ~~~~~~~~
 
 If you have used tkwant for work that has lead to a scientific publication, 
 we would appreciate if you cite the publication which introduces tkwant:
 
 T. Kloss, J. Weston, B. Gaury, B. Rossignol, C. Groth and X. Waintal,
-Tkwant: a software package for time-dependent quantum transport.
+`Tkwant: a software package for time-dependent quantum transport <https://doi.org/10.1088/1367-2630/abddf7>`_
+New J. Phys. **23**, 023025 (2021),
+`arXiv:2009.03132 [cond-mat.mes-hall]. <https://arxiv.org/abs/2009.03132>`_
```

### Comparing `tkwant-1.0.1/conftest.py` & `tkwant-1.1.0rc2/conftest.py`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/Makefile` & `tkwant-1.1.0rc2/doc/Makefile`

 * *Files 5% similar despite different names*

```diff
@@ -57,26 +57,27 @@
 
 ROOT_DIR:=$(shell dirname $(realpath $(firstword $(MAKEFILE_LIST))))
 
 .PHONY: clean
 clean:
 	rm -rf $(BUILDDIR)/*
 	rm -rf source/reference/generated
-	rm -rf $(ROOT_DIR)/source/examples
+	find $(ROOT_DIR)/source/tutorial/ -type l -exec unlink {} \;
 
 .PHONY: htmlfast
 htmlfast:
+	find $(ROOT_DIR)/source/tutorial/ -type l -exec unlink {} \;
 	$(SPHINXBUILD) -b html $(ALLSPHINXOPTS) $(BUILDDIR)/html
 	@echo
 	@echo "Build finished. The HTML pages are in $(BUILDDIR)/html."
 
 .PHONY: html
 html:
-	rm -rf $(ROOT_DIR)/source/examples
-	ln -s $(ROOT_DIR)/examples $(ROOT_DIR)/source/examples
+	find $(ROOT_DIR)/source/tutorial/ -type l -exec unlink {} \;
+	ln -s $(ROOT_DIR)/tutorial_source/* $(ROOT_DIR)/source/tutorial
 	$(SPHINXBUILD) -b html $(ALLSPHINXOPTS) $(BUILDDIR)/html
 	@echo
 	@echo "Build finished. The HTML pages are in $(BUILDDIR)/html."
 
 .PHONY: dirhtml
 dirhtml:
 	$(SPHINXBUILD) -b dirhtml $(ALLSPHINXOPTS) $(BUILDDIR)/dirhtml
```

### Comparing `tkwant-1.0.1/doc/examples/1d_wire_high_level.py` & `tkwant-1.1.0rc2/doc/tutorial_source/1d_wire_high_level.py`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/examples/1d_wire_low_level.py` & `tkwant-1.1.0rc2/doc/tutorial_source/1d_wire_low_level.py`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/examples/1d_wire_onsite.py` & `tkwant-1.1.0rc2/doc/tutorial_source/1d_wire_onsite.py`

 * *Files 4% similar despite different names*

```diff
@@ -67,14 +67,15 @@
 
     # do the actual tkwant simulation
     state = tkwant.manybody.State(syst, tmax=tmax)
 
     densities = []
     for time in times:
         state.evolve(time)
+        state.refine_intervals(rtol=1e-3, atol=1e-3)
         density = state.evaluate(density_operator)
         densities.append(density)
 
     # plot the result
     densities = np.array(densities).T
     for site, density in enumerate(densities):
         plt.plot(times, density, label='site {}'.format(site))
```

### Comparing `tkwant-1.0.1/doc/examples/alternative_boundary_conditions.py` & `tkwant-1.1.0rc2/doc/tutorial_source/alternative_boundary_conditions.py`

 * *Files 2% similar despite different names*

```diff
@@ -71,21 +71,25 @@
     energy = 1.
     tmax = 600
 
     # create initial scattering state
     scattering_states = kwant.wave_function(syst, energy=energy, params={'time': 0})
     psi_st = scattering_states(0)[0]
 
+    # maximal velocity of a mode in the leads
+    vmax = 2 * np.linalg.norm(syst.leads[0].inter_cell_hopping(), ord=2)
+    num_buffer_cells = int(vmax * tmax / 2)
+
     # boundary conditions typically used by `tkwant.solve`
-    simple_boundaries = [tkwant.leads.SimpleBoundary(tmax=tmax)
+    simple_boundaries = [tkwant.leads.SimpleBoundary(num_buffer_cells)
                          for l in syst.leads]
 
     # boundary conditions with an absorbing potential that increases
     # according to x**n where `x` is the distance into the lead
-    absorbing_boundaries = [tkwant.leads.MonomialAbsorbingBoundary(num_cells=100,
+    absorbing_boundaries = [tkwant.leads.MonomialAbsorbingBoundary(num_absorb_cells=100,
                                                                    strength=10,
                                                                    degree=6)
                             for l in syst.leads]
 
     # create time-dependent wavefunctions that starts in a scattering state
     # originating from the left lead, using two different types of boundary
     # conditions
```

### Comparing `tkwant-1.0.1/doc/examples/closed_system.py` & `tkwant-1.1.0rc2/doc/tutorial_source/closed_system.py`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/examples/closed_system.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/closed_system.rst`

 * *Files 17% similar despite different names*

```diff
@@ -1,14 +1,21 @@
 :orphan:
 
 .. _closed_system:
 
 Evolution of an eigenstate of a finite 2D system subject to a time-dependent gate
 =================================================================================
 
+.. jupyter-execute::
+    :hide-code:
+
+    # suppress jupyter warnings messages when calling kwant.plot()
+    import matplotlib.pyplot, matplotlib.backends
+
+
 Problem formulation
 -------------------
 Evolving single-particle states forward in time in a closed system,
 and calculating the expectation value of the radial position operator.
 The Hamiltonian is
 
 .. math::
```

### Comparing `tkwant-1.0.1/doc/examples/graphene.py` & `tkwant-1.1.0rc2/doc/tutorial_source/graphene.py`

 * *Files 9% similar despite different names*

```diff
@@ -77,25 +77,29 @@
                lead_site_lw=0, lead_color='grey')
 
 syst = syst.finalized()
 
 density_operator = kwant.operator.Density(syst)
 occupations = tkwant.manybody.lead_occupation(chemical_potential)
 
-# set up the manybody state
+# Initialize the time-dependent manybody state. Here we use a lower
+# accuracy for the initial adaptive refinement (at time=0) to speed up the calculation.
+# For a realistic simulation, set rtol and atol to smaller values.
 state = tkwant.manybody.State(syst, max(times), occupations, refine=False)
-# poor precision to speed-up simulation
 state.refine_intervals(rtol=1.5E-2, atol=1.5E-2)
 
 
 # simulation
 density0 = state.evaluate(density_operator)
 densities = []
 for time in times:
     state.evolve(time)
+    # For a realistic simulation, one must set rtol and atol to smaller values,
+    # or remove both arguments completely, to converge the manybody integral.
+    state.refine_intervals(rtol=0.1, atol=0.1)
     density = state.evaluate(density_operator)
     if am_master():
         densities.append(density - density0)
 
 # plot the result
 if am_master():
     normalization = 1 / np.max(densities)
```

### Comparing `tkwant-1.0.1/doc/examples/graphene.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/graphene.rst`

 * *Files 21% similar despite different names*

```diff
@@ -1,14 +1,20 @@
 :orphan:
 
 .. _graphene:
 
 Pulse propagation in a graphene quantum dot
 ===========================================
 
+.. jupyter-execute::
+    :hide-code:
+
+    # suppress jupyter warnings messages when calling kwant.plot()
+    import matplotlib.pyplot, matplotlib.backends
+
 The physical system in this example is a downscaled version of the
 "graphene quantum billard" from Ref. `[1] <#references>`__.
 An irregular shaped graphene dot, which is subjected to a time-dependent perturbation
 (the two red sites of the system plot are perturbed by a Gaussian shaped pulse).
 We calculate several snapshots of the electron density after the
 perturbation has been applied. While the accuracy and parameters are arbitrary
 and tuned to speed up the calculation, this example shows that graphene
@@ -20,11 +26,11 @@
     The complete source code of this example can be found in
     :download:`graphene.py <graphene.py>`.
 
 
 References
 ----------
 
-[1]  T. Kloss, J. Weston, B. Gaury, B. Rossignol, C. Groth and X. Waintal,
-Tkwant: a software package for time-dependent quantum transport.
-
-
+[1] T. Kloss, J. Weston, B. Gaury, B. Rossignol, C. Groth and X. Waintal,
+`Tkwant: a software package for time-dependent quantum transport <https://doi.org/10.1088/1367-2630/abddf7>`_
+New J. Phys. **23**, 023025 (2021),
+`arXiv:2009.03132 [cond-mat.mes-hall]. <https://arxiv.org/abs/2009.03132>`_
```

### Comparing `tkwant-1.0.1/doc/examples/open_system.py` & `tkwant-1.1.0rc2/doc/tutorial_source/open_system.py`

 * *Files 7% similar despite different names*

```diff
@@ -52,24 +52,24 @@
     current_operator = kwant.operator.Current(fsyst, where=interface_hoppings,
                                               sum=True)
 
     times = np.arange(0, 600)
 
     # create a time-dependent wavefunction that starts in a scattering state
     # originating from the left lead
-    psi = tkwant.onebody.ScatteringStates(fsyst, energy=1., lead=0, tmax=max(times))[0]
+    mode = 0
+    psi = tkwant.onebody.ScatteringStates(fsyst, energy=1., lead=0,
+                                          tmax=max(times))[mode]
 
     # evolve forward in time, calculating the current
     current = []
     for time in times:
         psi.evolve(time)
         current.append(psi.evaluate(current_operator))
 
-    print(psi.solver.kernel.nevals)
-
     # plot results
     plt.figure(figsize=(18, 7))
 
     gs = matplotlib.gridspec.GridSpec(2, 2)
 
     ax1 = plt.subplot(gs[0, 0])
     ax1.plot(times, current)
@@ -80,11 +80,11 @@
     ax2.set_xlabel(r'time $t$')
     ax2.set_ylabel(r'voltage $V(t)$')
 
     ax3 = plt.subplot(gs[:, 1])
     kwant.plot(syst, ax=ax3, site_color='k', lead_color='grey', num_lead_cells=4,
                hop_lw=lambda a, b: 0.3 if (a, b) in interface_hoppings else 0.1,
                hop_color=lambda a, b: 'r' if (a, b) in interface_hoppings else 'k')
-    #plt.show()
+    plt.show()
 
 if __name__ == '__main__':
     main()
```

### Comparing `tkwant-1.0.1/doc/examples/open_system.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/open_system.rst`

 * *Files 10% similar despite different names*

```diff
@@ -1,14 +1,20 @@
 :orphan:
 
 .. _open_system:
 
 Evolution of a scattering state under a voltage pulse in a quantum dot
 ======================================================================
 
+.. jupyter-execute::
+    :hide-code:
+
+    # suppress jupyter warnings messages when calling kwant.plot()
+    import matplotlib.pyplot, matplotlib.backends
+
 Problem formulation
 -------------------
 
 We consider a circular shaped central scattering region with two leads attached on the left
 and on the right-hand side as shown below.
 The system is perturbed by a time-dependent voltage pulse :math:`V_p(t)`
 which is injected into the left lead. We evolve a single onebody scattering states of the system forward in time
@@ -58,16 +64,16 @@
 
 
 
 
 **tkwant features highlighted**
 
 -  Use of ``tkwant.leads.add_voltage`` to add time-dependence to leads.
--  Use of ``tkwant.onebody.WaveFunction`` to solve the time-dependent Schrödinger
-   equation for an open system.
+-  Use of ``tkwant.onebody.ScatteringStates`` to solve the time-dependent Schrödinger
+   equation for an open system with an initial scattering state.
 
 .. jupyter-execute:: open_system.py
 
 .. seealso::
     The complete source code of this example can be found in
     :download:`open_system.py <open_system.py>`.
```

### Comparing `tkwant-1.0.1/doc/examples/restarting.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/restarting.rst`

 * *Files 7% similar despite different names*

```diff
@@ -1,28 +1,36 @@
 :orphan:
 
 .. _restarting:
 
 Restarting calculations from previously saved results
 =====================================================
 
+.. jupyter-execute::
+    :hide-code:
+
+    # suppress jupyter warnings messages when calling kwant.plot()
+    import matplotlib.pyplot, matplotlib.backends
+
+
 The physical system in this example is similar to :ref:`open_system`.
 For time arguments on the right of the dashed vertical line, the
 result is calculated with the restarted wave function.
 
 **tkwant features highlighted**
 
 -  restarting calculations from previously saved results
 
 
 **Saving**
 
 .. jupyter-execute::
 
     import pickle
+    import functools as ft
     import numpy as np
 
     import kwant
     import tkwant
 
 
     def circle(pos):
@@ -75,15 +83,19 @@
     current_operator = kwant.operator.Current(syst, where=lead_syst_hoppings, sum=True)
 
     tmax = 150
     times = np.linspace(0, tmax, 100)
 
     # create a time-dependent wavefunction that starts in a scattering state
     # originating from the left lead
-    psi = tkwant.onebody.ScatteringStates(syst, energy=1., lead=0, tmax=tmax)[0]
+    wavefunction_type = ft.partial(tkwant.onebody.WaveFunction.from_kwant,
+                                   kernel_type=tkwant.onebody.kernels.Scipy)
+    mode = 0
+    psi = tkwant.onebody.ScatteringStates(syst, energy=1., lead=0, tmax=tmax,
+                                          wavefunction_type=wavefunction_type)[mode]
 
     # evolve forward in time, calculating the current
     current = []
     for time in times:
         psi.evolve(time)
         current.append(psi.evaluate(current_operator))
```

### Comparing `tkwant-1.0.1/doc/examples/voltage_raise.py` & `tkwant-1.1.0rc2/doc/tutorial_source/voltage_raise.py`

 * *Files 8% similar despite different names*

```diff
@@ -59,24 +59,28 @@
     params = {'V_static': V_static, 'V_dynamic': V_dynamic}
 
     # occupation -- for each lead
     occup_left = tkwant.manybody.lead_occupation(chemical_potential + V_static)
     occup_lower = tkwant.manybody.lead_occupation(chemical_potential)
     occupations = [occup_left, occup_lower]
 
-    # instantiate the solver. Use a lower
-    # accuracy for adaptive refinement to speed up the calculation.
+    # Initialize the time-dependent manybody state. Here we use a lower
+    # accuracy for the initial adaptive refinement (at time=0) to speed up the calculation.
+    # For a realistic simulation, set rtol and atol to smaller values.
     state = tkwant.manybody.State(syst, tmax, occupations, params=params, refine=False)
     state.refine_intervals(rtol=0.05, atol=0.05)
 
     # loop over time, calculating the current as we go
     expectation_values = []
     times = range(tmax)
     for time in times:
         state.evolve(time)
+        # For a realistic simulation, one must set rtol and atol to smaller values,
+        # or remove both arguments completely, to converge the manybody integral.
+        state.refine_intervals(rtol=0.05, atol=0.05)
         result = state.evaluate(operator)
         expectation_values.append(result)
     return times, expectation_values
 
 
 def main():
```

### Comparing `tkwant-1.0.1/doc/examples/voltage_raise.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/voltage_raise.rst`

 * *Files 5% similar despite different names*

```diff
@@ -1,14 +1,21 @@
 :orphan:
 
 .. _voltage_raise:
 
 Comparision between bias chemical potential and bias electrical potential
 =========================================================================
 
+.. jupyter-execute::
+    :hide-code:
+
+    # suppress jupyter warnings messages when calling kwant.plot()
+    import matplotlib.pyplot, matplotlib.backends
+
+
 We consider a circular shaped central scattering region with two leads attached on the left
 and on the lower site as shown below. The left lead has an additional
 bias potential :math:`V_b`. In second quantization, the Hamiltonian is
 
 .. math::
 
     \hat{H}(t) =  \sum_{i,j} \gamma_{ij} \, \hat{c}^\dagger_i \hat{c}_j
@@ -66,22 +73,23 @@
 
 Performing a gauge transform, the time-dependent lead potential can be absorbed
 in the time-dependent system-lead coupling element between :math:`i_b` and :math:`i_b + 1`:
 
 .. math::
 
     \hat{H}(t) =  \sum_{i,j} \gamma_{ij} \, \hat{c}^\dagger_i \hat{c}_j
-    - [e^{i \phi(t)} - 1 ] \, \hat{c}^\dagger_{i_b + 1} \hat{c}_{i_b} + \text{h.c.}
+    - [e^{- i \phi(t)} - 1 ] \, \hat{c}^\dagger_{i_b + 1} \hat{c}_{i_b} + \text{h.c.}
 
 The result obtained from the static and from the dynamic case are shown below.
 
 
 **tkwant features highlighted**
 
--  Use of ``tkwant.manybody.State``
+-  Use of ``tkwant.manybody.State`` to solve the manybody Schrödinger equation.
+-  Use of ``refine_intervals`` for adaptive refinement the manybody integral.
 -  Use of ``tkwant.leads.add_voltage`` to add time-dependence to leads.
 
 .. jupyter-execute:: voltage_raise.py
 
 .. seealso::
     The complete source code of this example can be found in
     :download:`voltage_raise.py <voltage_raise.py>`.
@@ -89,9 +97,7 @@
 References
 ~~~~~~~~~~
 
 .. [1] B. Gaury, J. Weston, M. Santin, M. Houzet, C. Groth and X. Waintal,
     `Numerical simulations of time-resolved quantum electronics 
     <https://www.sciencedirect.com/science/article/pii/S0370157313003451?via%3Dihub>`__, Phys. Rep.
     **534**, 1 (2014). `[arXiv] <https://arxiv.org/abs/1307.6419>`__
-
-
```

#### encoding

```diff
@@ -1 +1 @@
-us-ascii
+utf-8
```

### Comparing `tkwant-1.0.1/doc/kwantdoctheme/static/kwantdoctheme.css` & `tkwant-1.1.0rc2/doc/kwantdoctheme/static/kwantdoctheme.css`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/kwantdoctheme/theme.conf` & `tkwant-1.1.0rc2/doc/kwantdoctheme/theme.conf`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/_static/kwant.css` & `tkwant-1.1.0rc2/doc/source/_static/kwant.css`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/_static/kwant_logo.png` & `tkwant-1.1.0rc2/doc/source/_static/kwant_logo.png`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/_static/sidebar.js` & `tkwant-1.1.0rc2/doc/source/_static/sidebar.js`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/conf.py` & `tkwant-1.1.0rc2/doc/source/conf.py`

 * *Files 1% similar despite different names*

```diff
@@ -39,15 +39,15 @@
     'sphinx.ext.autosummary',
     'sphinx.ext.doctest',
     'sphinx.ext.intersphinx',
     'sphinx.ext.coverage',
     'sphinx.ext.mathjax',
     'sphinx.ext.viewcode',
     'sphinx.ext.napoleon',
-    'jupyter_sphinx.execute',
+    'jupyter_sphinx',
     'kwantdoc',
 ]
 
 # Add any paths that contain templates here, relative to this directory.
 templates_path = ['../templates']
 
 # The suffix(es) of source filenames.
@@ -57,16 +57,16 @@
 #source_encoding = 'utf-8-sig'
 
 # The master toctree document.
 master_doc = 'index'
 
 # General information about the project.
 project = 'tkwant'
-author = 'J. Weston (TUD, CEA), T. Kloss (HLRS, CEA), C. W. Groth (CEA), X. Waintal (CEA), and others'
-copyright = '2016-2019, ' + author
+author = 'J. Weston (TUD, CEA), T. Kloss (CNRS, CEA), C. W. Groth (CEA), X. Waintal (CEA), and others'
+copyright = '2016-2023, ' + author
 
 # The version info for the project you're documenting, acts as replacement for
 # |version| and |release|, also used in various other places throughout the
 # built documents.
 #
 # The full version, including alpha/beta/rc tags.
 release = tkwant.__version__
@@ -313,15 +313,15 @@
 #texinfo_no_detailmenu = False
 
 # -- Options for autodoc -------------------------------------------------------
 # Generate stub pages for autosummary directives.
 autosummary_generate = True
 
 autoclass_content = "both"
-autodoc_default_flags = ['show-inheritance']
+autodoc_default_options = {'show_inheritance': True}
 
 # -- Teach Sphinx to document bound methods like functions ---------------------
 import types
 from sphinx.ext import autodoc
 
 class BoundMethodDocumenter(autodoc.FunctionDocumenter):
     objtype = "boundmethod"
```

### Comparing `tkwant-1.0.1/doc/source/reference/index.rst` & `tkwant-1.1.0rc2/doc/source/reference/index.rst`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/reference/tkwant.leads.rst` & `tkwant-1.1.0rc2/doc/source/reference/tkwant.leads.rst`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/reference/tkwant.manybody.rst` & `tkwant-1.1.0rc2/doc/source/reference/tkwant.manybody.rst`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/tutorial/1d_chain_closed.png` & `tkwant-1.1.0rc2/doc/tutorial_source/1d_chain_closed.png`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/tutorial/1d_chain_open.png` & `tkwant-1.1.0rc2/doc/tutorial_source/1d_chain_open.png`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/tutorial/boundary_condition.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/boundary_condition.rst`

 * *Files 3% similar despite different names*

```diff
@@ -221,15 +221,15 @@
 independent) lead. Two different types of cells can be added. In the
 buffer zone, which is the first zone connected to the scattering region
 (colored in blue below), ``num_buffer_cells`` with the lead hamiltonian
 are added. Here in our example, ``num_buffer_cells`` = 3 and the lead
 width is 6. In the buffer zone, the modes coming from the system simply
 continue to propagate into the lead during the simulation. A second zone
 is the so-called absorbing zone (colored in green below), which is in
-our example is ``num_cells`` = 9 cells long. An absorbing potential
+our example is ``num_absorb_cells`` = 9 cells long. An absorbing potential
 :math:`i \Sigma(x)` is added to the Hamiltonian in order to create
 damping and absorb propagating waves. For convenience, we will often
 skip the imaginary unit :math:`i` in front of the absorbing potential
 :math:`\Sigma(x)`. The first discrete absorbing cell corresponds to
 :math:`x = 0` of the (continous) argument for :math:`\Sigma(x)`, whereas
 :math:`x = 1` corresponds to the last absorbing cell on the right, that
 is facing the time-independent lead (shown in grey). Having present only
@@ -240,59 +240,58 @@
 
 .. |image1| image:: system_with_lead.png
 
 Simple boundary conditions
 ~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 One can also set up boundary conditions by hand. The simplest boundary
-condition consists in adding ``num_cells`` additional cells that are
+condition consists in adding ``num_buffer_cells`` additional cells that are
 explicitly taken into account in the time-dependent simulation, in
 between the scattering region and the lead. This type of boundary
 conditions can be obtained via:
 
 .. jupyter-execute::
 
-    boundary = tkwant.leads.SimpleBoundary(tmax=10000)
+    boundary = tkwant.leads.SimpleBoundary(num_buffer_cells=1000)
 
-Up to the simulation time ``tmax``, the boundary condition provided
-by ``SimpleBoundary`` guarantees no reflections from the lead it is used
-for. The disadvantage of this type of boundary condition is that it is
+Up to the simulation time of ``2 * num_buffer_cells / vmax`` 
+where ``vmax`` is the maximal velocity of a mode in the lead,
+very little reflection is comming from the lead where this boundary is used. 
+The disadvantage of this type of boundary condition is that it is
 becomes very inefficient for long simulation times, as the number of
-added lead cells ``num_cells`` increases linearly with the maximal time
-``tmax``. (Vice versa, we might opt to choose the number of
-additional lead cells ``num_cells``, which fixes a maximal simulation
-time ``tmax`` in return.)
+added lead cells ``num_buffer_cells`` increases linearly with the maximal time
+``tmax``.
 
 Monomial absorbing boundary conditions
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 An often much better approach is to use absorbing boundary conditions,
 that add an imaginary background potential :math:`\Sigma(x)` onto the
-``num_cells`` additional lead cells, in order to absorb waves that are
+``num_absorb_cells`` additional lead cells, in order to absorb waves that are
 propagating into the lead. The specific form of a monomial imaginary
 potential
 
 .. math::
 
 
        \Sigma(x) = (n + 1) A x^n ,
 
 was explored in Ref. `[1] <#references>`__. This boundary can easily set
 up by writing:
 
 .. jupyter-execute::
 
-    num_cells = 400
-    boundary = tkwant.leads.MonomialAbsorbingBoundary(num_cells, strength=10, degree=4)
+    num_absorb_cells = 400
+    boundary = tkwant.leads.MonomialAbsorbingBoundary(num_absorb_cells, strength=10, degree=4)
 
 where *n* is the ``degree`` of the polynomial and *A* corresponds to the
 ``strength``. The absorbing boundary condition has the advantage that no
 maximal time has to be choosen in advance of the simulation. In
 addition, it has a much better scaling behavior, as the number of
-explicit lead cells ``num_cells`` does not scale linearly with the
+explicit lead cells ``num_absorb_cells`` does not scale linearly with the
 simulation time as before. The disadvantage of this approach is that the
 choice of the three parameters, as the one we took above, is rather
 heuristic. As absorbing boundary conditions will always lead to a
 hopefully small, but finite reflection from the lead, this is especially
 unpleasant as we have no explicit control of the error in advance. We
 will show in the later section however how to estimate the lead
 reflection for a given choice of the parameters, respectivelly a generic
@@ -307,27 +306,28 @@
 condition, depending on which one is computationally more efficient.
 
 General absorbing boundary conditions
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 Finally, one may choose an arbitrary static imaginary potential
 :math:`\Sigma(x)` to construct an absorbing boundary condition. The
-argument domain is :math:`0 \leq x \leq 1`. Having ``num_cells`` lead
+argument domain is :math:`0 \leq x \leq 1`. Having 
+``num_total_cells = num_absorb_cells + num_buffer_cells`` lead
 cells, :math:`x = 0` corresponds to the first lead cell (index ``0``)
 that is connected to the scattering region respectively to the buffer,
 if ``num_buffer_cells`` > 0, whereas :math:`x = 1` corresponds to the
-the last lead cell (index ``num_cells - 1``). The specific form of
+the last lead cell (index ``num_total_cells - 1``). The specific form of
 monomial potential used above can be simply recovered by setting:
 
 .. jupyter-execute::
 
     def my_imaginary_potential(x):
         return 50 * x**4
 
-    boundary = tkwant.leads.GenericAbsorbingBoundary(num_cells, my_imaginary_potential)
+    boundary = tkwant.leads.GenericAbsorbingBoundary(num_absorb_cells, my_imaginary_potential)
 
 Lead reflection analysis
 ------------------------
 
 Basic analysis
 ~~~~~~~~~~~~~~
 
@@ -337,22 +337,22 @@
 afterwards for spurious reflections. Alternatively, as a ``tkwant``
 simulations are computationally demanding, one can perform an *a priori*
 estimate of the lead reflection with an imaginary potential
 :math:`\Sigma(x)` by a static ``kwant`` calculation. The absorbing
 potential can then be tuned to meet a desired maximal reflection.
 
 The ``AbsorbingReflectionSolver`` calculates the reflection for an
-absorbing lead of length ``num_cells`` with the imaginary potential
+absorbing lead of length ``num_absorb_cells`` with the imaginary potential
 :math:`\Sigma(x)`. Calling an instance of ``AbsorbingReflectionSolver``
 for a given energy ``energies``, it returns the reflection, momenta and
 velocities of all open modes at this energy.
 
 .. jupyter-execute::
 
-    reflection_solver = tkwant.leads.AbsorbingReflectionSolver(lead, num_cells,
+    reflection_solver = tkwant.leads.AbsorbingReflectionSolver(lead, num_absorb_cells,
                                                                my_imaginary_potential)
     refl, k, vel = reflection_solver(energies=0.5)
     print('reflection = {}'.format(refl))
     print('momenta = {}'.format(k))
     print('velocities = {}'.format(vel))
 
 Advanced analysis
@@ -363,15 +363,15 @@
 with the ``AbsorbingReflectionSolver``. A more convenient way is to use
 the ``AnalyzeReflection`` class. Calling an instance of this class with
 a momentum ``k`` and the band index ``band``, we obtain the reflection,
 energy and velocity of the corresponding mode
 
 .. jupyter-execute::
 
-    analyze_reflection = tkwant.leads.AnalyzeReflection(lead, num_cells,
+    analyze_reflection = tkwant.leads.AnalyzeReflection(lead, num_absorb_cells,
                                                         my_imaginary_potential)
     refl, energy, vel = analyze_reflection(k=0.2, band=1)
     print('reflection = {:10.4e}, energy = {:6.4f}, velocity = {:6.4f}'.format(refl, energy, vel))
 
 Moreover, we expect strong reflections around the local dispersion
 minima or maxima. The ``around_extremum`` method of the
 ``AnalyzeReflection`` provides an easy way to examine these regions.
@@ -503,30 +503,30 @@
 We can check the monomial parameters that ``automatic_boundary``
 proposes from the returned ``boundary`` instance:
 
 .. jupyter-execute::
 
     boundary = tkwant.leads.automatic_boundary(lead, tmax, refl_max=1E-5,
                                                emax=fermi_energy)
-    print('num_cells = {b.num_cells}, strength = {b.strength:6.4f}, '
+    print('num_absorb_cells = {b.num_absorb_cells}, strength = {b.strength:6.4f}, '
           'degree = {b.degree}, num_buffer_cells = {b.num_buffer_cells}'
           .format(b=boundary[0]))
 
 Alternatively, we can call directly the parameter estimate routine, that
 is internally used by ``automatic_boundary`` to obtain the monomial
 parameters:
 
 .. jupyter-execute::
 
     tmp = tkwant.leads._monomial_parameter_estimate(spectrum, tmax,refl_max=1E-5,
                                                     degree=6, emax=fermi_energy)
-    num_cells, strength, num_buffer_cells, *_ = tmp
+    num_absorb_cells, strength, num_buffer_cells, *_ = tmp
 
-    print('num_cells = {}, strength = {:6.4f}, num_buffer_cells = {}'
-          .format(num_cells, strength, num_buffer_cells))
+    print('num_absorb_cells = {}, strength = {:6.4f}, num_buffer_cells = {}'
+          .format(num_absorb_cells, strength, num_buffer_cells))
 
 Reflection of the nasty modes
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 As before, we can now analyze the refection of the lead with the
 specific monomial potential. We will use however the
 ``AnalyzeReflectionMonomial`` class, which has a similar functionality
@@ -542,15 +542,15 @@
 horizontal line. Note that the reflectivity of all mode modes that are
 not cut off by the buffer zone have a reflectivity smaller that value,
 as required.
 
 .. jupyter-execute::
 
     # analyze the reflection around two local extremas
-    analyze_reflection = tkwant.leads.AnalyzeReflectionMonomial(lead, num_cells,
+    analyze_reflection = tkwant.leads.AnalyzeReflectionMonomial(lead, num_absorb_cells,
                                                                 strength, degree=6)
 
     refl, e, vel, k, e0, k0 = analyze_reflection.around_extremum(kmin=-1, kmax=-0.7,
                                                                  band=0)
     plt.plot(vel[vel > 0], refl[vel > 0], 'o', label='band 0')
 
     refl, _, vel, *_ = analyze_reflection.around_extremum(kmin=-1.6, kmax=-1, band=1)
@@ -581,36 +581,36 @@
 with the exact numerical result can only be expected if
 
 .. math::
 
 
        q \cdot l \gg 1 , \,\, \text{with} \,\, q = |k - k_0|
 
-The length *l* corresponds to ``num_cells`` and the momentum *q* is the
+The length *l* corresponds to ``num_absorb_cells`` and the momentum *q* is the
 distance from a local extremum :math:`k_0` of the spectrum. We also plot
 the time to show the interest of performing the analytical calculation,
 even though it is only approximate.
 
 .. jupyter-execute::
 
     import time as tt
 
     # reflection from approximate analytical relation
     start_time = tt.time()
-    analyze_reflection = tkwant.leads.AnalyzeReflectionMonomial(lead, num_cells,
+    analyze_reflection = tkwant.leads.AnalyzeReflectionMonomial(lead, num_absorb_cells,
                                                                 strength, degree=6)
     refl, e, vel, k, e0, k0 = analyze_reflection.around_extremum(kmin=-1.6, kmax=-1, band=1)
     plt.plot(np.abs(k[vel > 0] - k0), refl[vel > 0], 'o', label='analytic approx.')
     print('elapsed time monomial approximation: ', tt.time() - start_time)
 
     # reflection from exact numerical kwant calculation
     def my_imaginary_potential(x, degree=6):
         return (degree + 1) * strength * x**degree
     start_time = tt.time()
-    analyze_reflection = tkwant.leads.AnalyzeReflection(lead, num_cells,
+    analyze_reflection = tkwant.leads.AnalyzeReflection(lead, num_absorb_cells,
                                                         my_imaginary_potential)
     refl, e, vel, k, e0, k0 = analyze_reflection.around_extremum(kmin=-1.6, kmax=-1,
                                                                  band=1)
     plt.plot(np.abs(k[vel > 0] - k0), refl[vel > 0], 'x', label='numeric exact')
     print('elapsed time exact numerical: ', tt.time() - start_time)
 
     print('reflection around low-energy mode: energy= {:6.4f}, k0= {:6.4f}'.format(e0, k0))
@@ -627,15 +627,15 @@
 
 If the the maximal simulation time ``tmax`` is very small, we can
 always cut of all modes by a buffer zone that is large enough to cut off
 the fastest mode of the spectrum. We will therefore always find a trade
 off between required reflection ``refl_max`` and ``tmax``.
 
 Let us plot the total length of the lead cells, that is the sum of
-``num_cells`` and ``buffer_cells``, for different maximal simulation
+``num_absorb_cells`` and ``buffer_cells``, for different maximal simulation
 times ``tmax``, keeping ``refl_max`` fixed. Note that our parameter
 estimate algorithm ``_monomial_parameter_estimate`` will use a sole
 buffer zone as a fallback in the case that the absorbing boundary
 conditions turn out to be disadvantageous. For for maximal simulation
 times on the left hand side of the black dashed line, simple boundary
 conditions perform better then absorbing boundary conditions, and vice
 versa for maximal simulation times choosen on the right-hand side of the
@@ -644,16 +644,16 @@
 increses for ``refl_max``.
 
 .. jupyter-execute::
 
     def len_lead(tmax):
         tmp = tkwant.leads._monomial_parameter_estimate(spectrum, tmax, refl_max=1E-5,
                                                         degree=6, emax=fermi_energy)
-        num_cells, _, num_buffer_cells, *_ = tmp
-        return num_cells + num_buffer_cells
+        num_absorb_cells, _, num_buffer_cells, *_ = tmp
+        return num_absorb_cells + num_buffer_cells
 
     times = np.linspace(100, tmax, 100)
     buffer_len = [vmax * t / 2 for t in times]
     absorb_len = [len_lead(t) for t in times]
 
     plt.plot(times, buffer_len, 'r', label='only buffer')
     plt.plot(times, absorb_len, 'b', label='buffer + absorb')
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/extended_system.png` & `tkwant-1.1.0rc2/doc/tutorial_source/extended_system.png`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/tutorial/fabry_perot.py` & `tkwant-1.1.0rc2/doc/tutorial_source/fabry_perot.py`

 * *Files 15% similar despite different names*

```diff
@@ -48,31 +48,35 @@
     times = range(220)
 
     # Make the system and add voltage V(t) to the left lead (index 0).
     syst, lat = make_fabry_perot_system()
     tkwant.leads.add_voltage(syst, 0, phi)
     syst = syst.finalized()
 
-    # Define an operator to measure the current after the barrier.
+    # Define an operator to measure the current from site 77 to site 78
+    # on the right side after the barrier.
     hoppings = [(lat(78, 0), lat(77, 0))]
     current_operator = kwant.operator.Current(syst, where=hoppings)
 
     # Set occupation T = 0 and mu = -1 for both leads.
     occup = tkwant.manybody.lead_occupation(chemical_potential=-1)
 
-    # Initialize the time-dependent manybody state. Use a lower
-    # accuracy for adaptive refinement to speed up the calculation.
-    state = tkwant.manybody.State(syst, tmax=max(times), occupations=occup,
-                                  refine=False, combine=True)
+    # Initialize the time-dependent manybody state. Here we use a lower
+    # accuracy for the initial adaptive refinement (at time=0) to speed up the calculation.
+    # For a realistic simulation, set rtol and atol to smaller values.
+    state = tkwant.manybody.State(syst, tmax=max(times), occupations=occup, refine=False)
     state.refine_intervals(rtol=0.3, atol=0.3)
 
     # Loop over timesteps and evaluate the current.
     currents = []
     for time in times:
         state.evolve(time)
+        # For a realistic simulation, one must set rtol and atol to smaller values,
+        # or remove both arguments completely, to converge the manybody integral.
+        state.refine_intervals(rtol=0.3, atol=0.3)
         current = state.evaluate(current_operator)
         currents.append(current)
 
     # Plot the normalized current vs. time.
     if am_master():
         plt.plot(times, currents / currents[-1])
         plt.xlabel(r'time $t$')
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/fabry_perot.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/fabry_perot.rst`

 * *Files 14% similar despite different names*

```diff
@@ -1,13 +1,13 @@
 :orphan:
 
 .. _fabry_perot:
 
 Second example: Fabry-Perot interferometer
-=========================================
+==========================================
 
 We consider an infinite one-dimensional chain with nearest-neighbor hopping,
 in which two potential barriers A and B form a Fabry-Perot cavity. 
 A sketch of the system is
 
 .. image:: fabry_perot_grid.png
 
@@ -16,15 +16,19 @@
 to a finite value, which is taken into account by a 
 time-dependent coupling element (shown in red) between the left electrode and the central system.
 We want to study the transient
 regime of the current :math:`I(t)` before it eventually reaches its
 stationary value. This system has been studied in Ref. `[1] <#references>`__.
 The actual simulation script in this tutorial is taken from Ref. `[2] <#references>`__,
 but simulation time and accuracy are both reduced in this tutorial
-in order to speed up the calculation. The entire simulation script is:
+in order to speed up the calculation. Note the method ``refine_intervals()``,
+which is used to adaptively refine the manybody integral.
+In practice, both arguments ``rtol`` and ``atol`` must be set to smaller values,
+or removed completely, to converge the result and to obtain numerically correct numbers.
+The entire simulation script is:
 
  .. jupyter-execute:: fabry_perot.py
 
 .. seealso::
     The complete source code of this example can be found in
     :download:`fabry_perot.py <fabry_perot.py>`.
 
@@ -33,24 +37,26 @@
 direct transmission, whereas the second one is due to
 reflection at B followed by reflection at A then transmission. For longer simulation times,
 this series continues until a stationary current value is reached, 
 see Refs. `[1, 2] <#references>`__.
 Another detail is that on each plateau, the current oscillates with a frequency :math:`e V_b / h`,
 where :math:`V_b` is the stationary value of the electric potential :math:`V(t)`.
 
-.. warning::
+.. note::
 
     The examples in this section take several minutes on a single core desktop computer.
     To speed up the computation the script can be run in parallel, see section :ref:`mpi`.
 
 References
 ----------
 
 [1] B. Gaury, J. Weston, X. Waintal,
 `The a.c. Josephson effect without superconductivity 
 <https://www.nature.com/articles/ncomms7524>`__, 
 Nat. Commun. **6**, 6524 (2015).
 `[arXiv] <https://arxiv.org/abs/1407.3911>`__
 
-[2]  T. Kloss, J. Weston, B. Gaury, B. Rossignol, C. Groth and X. Waintal,
-Tkwant: a software package for time-dependent quantum transport.
+[2] T. Kloss, J. Weston, B. Gaury, B. Rossignol, C. Groth and X. Waintal,
+`Tkwant: a software package for time-dependent quantum transport <https://doi.org/10.1088/1367-2630/abddf7>`_
+New J. Phys. **23**, 023025 (2021),
+`arXiv:2009.03132 [cond-mat.mes-hall]. <https://arxiv.org/abs/2009.03132>`_
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/fabry_perot_grid.png` & `tkwant-1.1.0rc2/doc/tutorial_source/fabry_perot_grid.png`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/tutorial/faq.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/faq.rst`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/tutorial/getting_started.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/getting_started.rst`

 * *Files 5% similar despite different names*

```diff
@@ -1,13 +1,19 @@
 .. _getting_started:
 
-
 Getting started: a simple example with a one-dimensional chain
 --------------------------------------------------------------
 
+.. jupyter-execute::
+    :hide-code:
+
+    # suppress jupyter warnings messages when calling kwant.plot()
+    import matplotlib.pyplot, matplotlib.backends
+
+
 As a first simple example, we like to study the electron dynamics on an infinitly long
 one-dimensional chain consisting of nearest-neighbour coupled scatterers. 
 Being initially at thermal equilibrium, we are intersted in the electron
 dynamics if a time-dependent perturbation :math:`V(t)` acts on the one site
 with index zero. In second quantization the Hamiltonian is
 
 .. math::
@@ -158,22 +164,26 @@
 .. jupyter-execute::
 
     density_operator = kwant.operator.Density(syst)
 
 To perform the actual tkwant simulation, we first initialize the
 many-body state. The ``evolve()`` and ``evaluate()`` methods propagate
 the state foreward in time and evaluate the manybody expectation value.
+Note also the method ``refine_intervals()``,
+which is used for adaptive refinement the manybody integral and which is important
+to obtain numerically correct results.
 
 .. jupyter-execute::
 
     state = tkwant.manybody.State(syst, tmax=max(times))
 
     densities = []
     for time in times:
         state.evolve(time)
+        state.refine_intervals(rtol=1e-3, atol=1e-3)
         density = state.evaluate(density_operator)
         densities.append(density)
 
 This was already the entire simulation. We finally plot the result
 
 .. jupyter-execute::
 
@@ -189,9 +199,9 @@
 Starting from equilibrium at initial time :math:`t = 0` where the density is equal
 on all sites, it evolves to different vales when the perturbation is switched on.
 After some transient regime, the density reaches stationary values at long times.
 
 
 .. seealso::
     The complete source code of this example can be found in
-    :download:`1d_wire_onsite.py <../../examples/1d_wire_onsite.py>`
+    :download:`1d_wire_onsite.py <1d_wire_onsite.py>`
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/logging.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/logging.rst`

 * *Files 7% similar despite different names*

```diff
@@ -1,55 +1,76 @@
 .. _logging:
 
 Logging
 =======
 
 Tkwant provides a logger to record events and internal states during a calculation.
-Enabling the logger, which by default is switched off,
+Enabling the logger, which by default prints only warning messages to standard output (stdout),
 can help to find errors in the user code and also facilitate debugging tkwant.
-
-Logging is enabled by the following lines of code:
+Logging is enabled by putting the following line of code at the beginning of a Python script right after importing the tkwant package:
 
 .. jupyter-execute::
+    :hide-code:
 
     import tkwant
+
+.. jupyter-execute::
+
     import logging
+    tkwant.logging.level = logging.INFO  # possible levels (increasing verbosity): WARNING, INFO, DEBUG
 
-    tkwant.logging.handler = tkwant.logging.debug_handler
 
-By default, only warning messages are logged, which typically look like this:
+A typical log message, here a warning, looks like this:
 
 .. jupyter-execute::
     :hide-code:
 
     print("WARNING:tkwant.manybody:1452:rank=0: no occupied states found, the chemical potential is probably wrong.")
 
 The verbosity of the logger can increased to print also status and debug information, see `Level`_.
-Note that logging handler must be set *after* importing the tkwant module and
-*before* executing any tkwant code. A complete `Example`_ is shown below.
+Logging can be also completely turned off as desribed in `Handlers`_, or narrowed to a specific part as desribed in `Filters`_.
+A complete `Example`_ is shown below.
 
 Tkwant's logger is based on logging module of the Python standard library.
 We refer to the
 `Logging HOWTO 
 <https://docs.python.org/3/howto/logging.html#logging-basic-tutorial>`__
 tutorial for more information about Python's logging module.
 
+
+Level
+~~~~~
+
+Logging has several severity levels to control which level of log messages are
+recorded. By default, tkwant is logging only warning messages
+(corresponding to ``logging.WARNING``).
+To change the log level, one has set ``tkwant.logging.level`` to a level,
+as defined in the Python logging module.
+As an example, to log also progress information, the additional line of code
+must be added:
+
+.. jupyter-execute::
+
+    import tkwant
+    import logging
+    tkwant.logging.level = logging.INFO  # possible levels (increasing verbosity): WARNING, INFO, DEBUG
+
+Again, the logging level must be set *after* importing the tkwant module and
+*before* executing any tkwant code. The most verbose output is generated by setting
+the level to ``logging.DEBUG``.
+
+
 Handlers
 ~~~~~~~~
 
 The handler specify the format of the logging output.
 Tkwant has implemented two predefined stream handlers:
 ``tkwant.logging.debug_handler`` and ``tkwant.logging.simple_handler``.
 
-The **debug_handler** can be set with:
-
-.. jupyter-execute::
-
-    tkwant.logging.handler = tkwant.logging.debug_handler
-
+The **debug_handler** aka ``tkwant.logging.debug_handler`` is the default handler.
 With this handler, a typical log output looks like:
 
 .. jupyter-execute::
     :hide-code:
 
     print("INFO:tkwant.manybody:229:rank=0: distribution function: zero-temperature fermi-dirac")
 
@@ -62,14 +83,15 @@
 
 
 The **simple_handler** is less verbose and prints only the log message.
 It can be set with:
 
 .. jupyter-execute::
 
+    import tkwant
     tkwant.logging.handler = tkwant.logging.simple_handler
 
 With this handler, a typical log output looks like:
 
 .. jupyter-execute::
     :hide-code:
 
@@ -78,61 +100,54 @@
 The format is:
 
  *log message*
 
 Alternative handlers whose API matches the logging module of the
 Python standard library can be set in the same way.
 
-
-Level
-~~~~~
-
-Logging has several severity levels to control which level of log messages are
-recorded. By default, tkwant is logging only warning messages
-(corresponding to ``logging.WARNING``).
-To change the log level, one has set ``tkwant.logging.level`` to a level,
-as defined in the Python logging module.
-As an example, to log also progress information, the additional line of code
-must be added:
+Turning off logging completely is possible by setting the handler to the ``NullHandler``:
 
 .. jupyter-execute::
 
-    tkwant.logging.level = logging.INFO
-
-Again, the logging level must be set *after* importing the tkwant module and
-*before* executing any tkwant code. The most verbose output is generated by setting
-the level to ``logging.DEBUG``:
-
-.. jupyter-execute::
-
-    tkwant.logging.level = logging.DEBUG
+    import logging
+    tkwant.logging.level = logging.NullHandler()  # suppress logging
 
+The logging handler must be set *after* importing the tkwant module and
+*before* executing any tkwant code.
 
 
 Filters
 ~~~~~~~
 
 The logging output can be filtered to reduce the output to specific parts.
 To log only logging events triggered by a certain module, as e.g. ``tkwant.leads``,
 on can set
 
 .. jupyter-execute::
 
+    import logging
     tkwant.logging.filter = logging.Filter('tkwant.leads')
 
 Alternatively, one can also define a filter function. The following code
-logs only the messages from MPI with rank zero (which is typically the root rank):
+logs only the messages from MPI with rank zero (which is Tkwant's default behavior):
 
 .. jupyter-execute::
 
     def rank_filter(record):
         return True if record.rank == 0 else False
 
     tkwant.logging.filter = rank_filter
 
+To print the logging output from all MPI ranks one has to set:
+
+.. jupyter-execute::
+
+    tkwant.logging.filter = None
+
+
 If one likes to log only messages containing the word *interval* one can use
 
 .. jupyter-execute::
 
     def message_filter(record):
         return True if 'interval' in record.getMessage() else False
 
@@ -143,34 +158,28 @@
 module provides more information to write custom filters.
 
 Example
 ~~~~~~~
 
 As an example, we show the toy example from
 :ref:`getting_started` with enabled logging and the generated output.
-Note that all logging output is generated by the call to ``tkwant.manybody.State()``
+Note that much logging output is generated by the call to ``tkwant.manybody.State()``
 and reveals the preprocessing steps of the automatic high-level approach.
 
 .. jupyter-execute::
 
     import numpy as np
     import matplotlib.pyplot as plt
 
     import kwant
     import tkwant
 
     #-------------------- enable logging --------------------------------
     import logging
-
-    def rank_filter(record):
-        return True if record.rank == 0 else False
-
-    tkwant.logging.handler = tkwant.logging.debug_handler
-    tkwant.logging.level = logging.DEBUG
-    tkwant.logging.filter = rank_filter
+    tkwant.logging.level = logging.INFO
     #--------------------------------------------------------------------
 
 
     def v(time, tau=8):
         """Time dependent perturbation V(t)"""
         if time < tau:
             return time / tau
@@ -218,14 +227,15 @@
 
     # do the actual tkwant simulation
     state = tkwant.manybody.State(syst, tmax=tmax)
 
     densities = []
     for time in times:
         state.evolve(time)
+        state.refine_intervals(rtol=1e-3, atol=1e-3)
         density = state.evaluate(density_operator)
         densities.append(density)
 
     # plot the result
     plt.plot(times, densities)
     plt.xlabel(r'time $t$')
     plt.ylabel(r'charge density $n$')
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/manybody.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/manybody.rst`

 * *Files 2% similar despite different names*

```diff
@@ -1,13 +1,21 @@
 .. _manybody:
 
+
 Solving the many-body problem
 =============================
 
-.. warning::
+.. jupyter-execute::
+    :hide-code:
+
+    # suppress jupyter warnings messages when calling kwant.plot()
+    import matplotlib.pyplot, matplotlib.backends
+
+
+.. note::
 
     The examples in this section take several minutes on a single core desktop computer.
     To speed up the computation the example scrips can be run in parallel, see section :ref:`mpi`.
 
 
 We like to study manybody problem for an infinite one-dimensional chain.
 In second quantization the Hamiltonian reads
@@ -140,15 +148,15 @@
 to fascilitate the numerical procedure without the need to fine-tune the quadrature by hand.
 While the high-level approach is less flexible, it can still be adapted in various ways.
 In the following we show how to change the lead occupation.
 
 .. seealso::
     The complete example script including MPI directives for parallel execution
     can be found in
-    :download:`1d_wire_high_level.py <../../examples/1d_wire_high_level.py>`.
+    :download:`1d_wire_high_level.py <1d_wire_high_level.py>`.
 
 Chemical potential and temperature of the leads
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 By default, the chemical potential and the temperature in all leads are identical and equal zero.
 To set them in all leads to the same, non-zero value, is possible via
 
@@ -164,14 +172,23 @@
 
     occup_left = tkwant.manybody.lead_occupation(chemical_potential=0.5, temperature=0.1)
     occup_right = tkwant.manybody.lead_occupation(chemical_potential=0.2)
     occupations = [occup_left, occup_right]
 
     state = tkwant.manybody.State(syst, max(times), occupations)
 
+Instead of a scalar value one can also provide a sequence of values for the ``chemical_potential``,
+one value for each band of the lead spectrum:
+
+.. jupyter-execute::
+
+    occupations = tkwant.manybody.lead_occupation(chemical_potential=[-0.5, 0.5])
+
+In this case the number of values must match the number of bands in that lead.
+The ordering of the bands in the same obtained with ``kwantSpectrum``.
 
 
 Adaptive refinement and error estimate
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 The class ``manybody.State`` provides methods to estimate the quadrature error
 of the manybody integral and to adaptively refine the approximation to a given
@@ -309,15 +326,15 @@
 From this follows, that ``order=2`` and ``number_subintervals=10`` and
 ``order=10`` and ``number_subintervals=2`` will both lead to the same number of sampling
 points to approximate the integral, but with a very different distribution of the points.
 
 .. seealso::
     The complete example script including MPI directives for parallel execution
     can be found in
-    :download:`1d_wire_low_level.py <../../examples/1d_wire_low_level.py>`.
+    :download:`1d_wire_low_level.py <1d_wire_low_level.py>`
 
 
 Summary
 -------
 
 To summarize, we like to highlight the similarity between the onebody and the
 manybody approach.
@@ -336,15 +353,16 @@
 
 both states can be evolved forward in time and evaluate expectation values similarly
 
 **Onebody**
 
 .. jupyter-execute::
 
-   psi = tkwant.onebody.ScatteringStates(syst, energy=1, lead=0, tmax=10)[0]
+   mode = 0
+   psi = tkwant.onebody.ScatteringStates(syst, energy=1, lead=0, tmax=10)[mode]
    psi.evolve(time=5)
    density = psi.evaluate(density_operator)
 
 **Manybody**
 
 .. jupyter-execute::
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/manybody_advanced.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/manybody_advanced.rst`

 * *Files 4% similar despite different names*

```diff
@@ -119,43 +119,14 @@
 example, we set the temperature of the lead to the finite value
 :math:`T = 0.5`:
 
 .. jupyter-execute::
 
     occupation = manybody.lead_occupation(temperature=0.5)
 
-Distribution function
-~~~~~~~~~~~~~~~~~~~~~
-
-The distribution function :math:`f_\alpha(E)` can be changed with the keyword
-``distribution``. As an example, we set up a lead with Bose distribution
-at finite temperature:
-
-.. jupyter-execute::
-
-    def bose_function(mu, T, energy):
-        return 1 / (exp((energy - mu) / T) - 1)
-
-    occupation = manybody.lead_occupation(temperature=0.5, distribution=bose_function)
-
-Note that the distribution function :math:`f` must have the calling
-signature ``(chemical_potential, temperature, energy)``.
-
-Energy range
-~~~~~~~~~~~~
-
-Upper and lower energy values can be set with the keyword ``energy_range``,
-which is a sequence of intervals in the form ``(emin, emax)``.
-If present, only modes with energies ``emin``
-:math:`\leq E_n \leq` ``emax`` are considered. As an example, we select
-only the modes with energies :math:`0.4 \leq E_n \leq 0.6`:
-
-.. jupyter-execute::
-
-    occupation = manybody.lead_occupation(energy_range=[(0.4, 0.6)])
 
 Include / exclude bands
 ~~~~~~~~~~~~~~~~~~~~~~~
 
 The statistical average can be performed only over a subset of energy
 bands :math:`E_n`. Specifying the keyword ``bands`` with a list of band
 indices, only the bands with band index :math:`n` specified in the list
@@ -284,45 +255,14 @@
 
 .. jupyter-execute::
 
     # (kmin, kmax) -> [(kmin, k_0), (k_0, k_1).. (k_{n-1}, kmax)]
     intervals = manybody.split_intervals(intervals, number_subintervals=10)
 
 
-**Energy split**
-Splitting intervals in energy space is possible by using `energy_range`.
-The snippet below is to reproduce older calculations performed with
-energy integrations on an energy interval splitted equidistantly into subintervals (here 10).
-
-.. jupyter-execute::
-
-    from itertools import tee
-
-    def pairwise(iterable):
-        "s -> (s0,s1), (s1,s2), (s2, s3), ..."
-        a, b = tee(iterable)
-        next(b, None)
-        return zip(a, b)
-
-    chemical_potential = 1
-
-    # energy interval split (0, 1) -> [(0, 0.1), (0.1, 0.2).. (0.9, 1)]
-    energy_range = [i for i in pairwise(np.linspace(0, chemical_potential, 11))]
-    occupation = manybody.lead_occupation(chemical_potential,
-                                          energy_range=energy_range)
-
-    Interval = functools.partial(manybody.Interval, integration_variable='energy')
-    intervals = manybody.calc_intervals(spectra, occupation, interval_type=Interval)
-
-``intervals`` is now already a sequence of 10 intervals, no additional split
-with ``manybody.split_intervals`` is needed. If
-``integration_variable="momentum"``, the split is still performed in the energy
-range, but the quadrature will be integrate over momentum.
-
-
 Quadrature rule
 ~~~~~~~~~~~~~~~
 
 The quadrature rule can be changed via:
 
 .. jupyter-execute::
 
@@ -524,14 +464,35 @@
                                               wavefunction_type=onebody_wavefunction_type)
     state = manybody.State(syst, tmax=10, scattering_state_type=scattering_state_type)
 
 A similar strategy is possible to change the onebody kernels
 ``onebody.kernels`` that evaluate the right-hand-side of the one-body
 Schrödinger equations.
 
+Time-dependent perturbation
+~~~~~~~~~~~~~~~~~~~~~~~~~~~
+
+Tkwant uses cubic spline interpolation to interpolate the
+time-dependent perturbation :math:`W(t)` in time with an adaptive stepsize.
+The interpolation is used for performance reasons,
+in order to minimize the number of calls to Kwant.
+
+One can switch off interpolation and always evaluate the exact :math:`W(t)` function with:
+
+.. jupyter-execute::
+
+    import functools as ft
+
+    onebody_wavefunction_type = ft.partial(tkwant.onebody.WaveFunction.from_kwant,
+                                           perturbation_type=tkwant.onebody.kernels.PerturbationExtractor)
+
+    scattering_state_type = ft.partial(tkwant.onebody.ScatteringStates,
+                                       wavefunction_type=onebody_wavefunction_type)
+
+    state = tkwant.manybody.State(syst, tmax, scattering_state_type=scattering_state_type)
 
 Retrieve one-body states
 ------------------------
 
 The manybody state ``manybody.WaveFunction`` provides several methods
 to retrieve the underlying one-body states. They can be useful for
 realizing specific problems beyond the examples mentioned above.
@@ -632,15 +593,15 @@
 
 Boundary conditions are calculated internally for all leads of the
 system. In order to provide own boundary conditions, they can be
 precalculate and transferred to the state with keyword ``boundaries``:
 
 .. jupyter-execute::
 
-    boundaries = [tkwant.leads.SimpleBoundary(tmax=10)] * len(syst.leads)
+    boundaries = tkwant.leads.automatic_boundary(syst.leads, tmax=10000, refl_max=1E-10)
     state = manybody.State(syst, boundaries=boundaries)
 
 Initial state
 ~~~~~~~~~~~~~
 
 Arbitrary initial states can be provided to the manybody state with the
 keyword ``psi_init``. The state is simply a dictionary of one-body
@@ -656,42 +617,7 @@
 boundary conditions by initializing ``manybody.State()`` from
 ``psi_init``. Passing the keywords ``boundary`` and/or ``tmax`` together
 with ``psi_init`` leads to a ``ValueError``.
 
 The time attribute ``new_state.time=0`` after initialization.
 As stated above, is not checked if the time attributes in the
 individual one-body states are similar or consistent.
-
-Boundstates
-~~~~~~~~~~~
-
-The following code illustrates how to include boundstates in the manybody
-dynamics. First, the boundstates are calculated in some user-written function,
-here called ``calc_my_boundstates()``:
-
-.. jupyter-execute::
-
-    boundstate_psi, boundstate_tasks = calc_my_boundstates()
-
-``boundstate_psi`` is a dictionary of all boundstate wavefunctions.
-It has basically the same form as an initial manybody state calculated from
-``manybody.calc_initial_state()``.
-``boundstate_tasks`` contain the weighting factor and the energy of each
-boundstate and is similar to the output of ``manybody.calc_tasks()``.
-
-In the case that ``state`` is a manybody state instance created with
-``manybody.State``, boundstates are easily added by the method
-``add_boundstates()``:
-
-.. jupyter-execute::
-
-    state = manybody.State(syst, tmax)
-    state.add_boundstates(boundstate_psi, boundstate_tasks)
-
-In the case that the manybody state instance has been created with
-``manybody.WaveFunction``, the boundstates must be added with the
-function ``manybody.add_boundstates()``.
-If the boundstates are not yet time dependent, they must first transformed
-with ``make_boundstate_time_dependent``.
-In both cases, the keys for the new boundstates must not be present in
-the manybody state already.
-
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/mpi.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/mpi.rst`

 * *Files 1% similar despite different names*

```diff
@@ -139,15 +139,15 @@
 
 
 Examples
 ~~~~~~~~
 
 The example scripts
 :download:`fabry_perot.py <fabry_perot.py>` and
-:download:`voltage_raise.py <../../examples/voltage_raise.py>`
+:download:`voltage_raise.py <voltage_raise.py>`
 can both be executed in parallel using MPI.
 
 
 References
 ----------
 
 `MPI standard documentation
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/onebody.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/onebody.rst`

 * *Files 2% similar despite different names*

```diff
@@ -89,15 +89,15 @@
     # initial condition
     k = np.pi / 6
     psi0 = np.exp(- 0.001 * (xi - 100)**2 + 1j * k * xi)
 
     # hamiltonian matrix
     diag = 2 * np.ones(len(xi))
     offdiag = - np.ones(len(xi) - 1)
-    H0 = scipy.sparse.diags([diag, offdiag, offdiag], [0, 1, -1])
+    H0 = scipy.sparse.diags([diag, offdiag, offdiag], [0, 1, -1], dtype=complex)
 
     # initialize the solver
     wave_func = onebody.WaveFunction(H0, W=None, psi_init=psi0)
 
     # loop over timesteps and plot the result
     for time in times:
         wave_func.evolve(time)
@@ -340,15 +340,17 @@
     # make boundary conditions for the system with leads
     boundaries = leads.automatic_boundary(syst.leads, tmax=max(times))
 
     # initialize the solver
     # create a time-dependent wavefunction that starts in a scattering state
     # originating from the left lead as initial state
     scattering_states = kwant.wave_function(syst, energy=0., params={'time': 0})
-    psi_st = scattering_states(0)[0]
+    lead = 0
+    mode = 0
+    psi_st = scattering_states(lead)[mode]
 
     # initialize the solver starting in the scattering state
     wave_func = onebody.WaveFunction.from_kwant(syst, psi_st, boundaries=boundaries,
                                                 energy=0.)
 
     # loop over timesteps and plot the result
     for time in times:
@@ -429,9 +431,10 @@
     Advanced settings to solve the onebody Schrödinger equation are described in
     section :ref:`onebody_advanced`.
     Further examples are given in section :ref:`examples`.
 
 References
 ----------
 
-[1]  T. Kloss, J. Weston, B. Gaury, B. Rossignol, C. Groth and X. Waintal,
-Tkwant: a software package for time-dependent quantum transport.
+[1] T. Kloss, J. Weston, B. Gaury, B. Rossignol, C. Groth and X. Waintal,
+`Tkwant: a software package for time-dependent quantum transport <https://doi.org/10.1088/1367-2630/abddf7>`_
+New J. Phys. **23**, 023025 (2021).
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/onebody_advanced.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/onebody_advanced.rst`

 * *Files 5% similar despite different names*

```diff
@@ -57,27 +57,27 @@
 
 Special boundary conditions have to be provided in
 order to solve the dynamic equations for an open quantum systems (with leads).
 For ``onebody.WaveFunction`` they must be precalculated:
 
 .. jupyter-execute::
 
-    boundaries = [tkwant.leads.SimpleBoundary(tmax=500)] * len(syst.leads)
+    boundaries = tkwant.leads.automatic_boundary(syst.leads, tmax=10000, refl_max=1E-10)
     scattering_states = kwant.wave_function(syst, energy=1, params={'time':0})
     lead, mode = 0, 0
     psi_st = scattering_states(lead)[mode]
     psi = onebody.WaveFunction.from_kwant(syst, psi_st, boundaries=boundaries, energy=1.)
 
 For the scattering state solver boundary conditions are calculated on the fly.
 One can provide different boundary conditions by the keyword ``boundary``
 
 
 .. jupyter-execute::
 
-    boundaries = [tkwant.leads.SimpleBoundary(tmax=500)] * len(syst.leads)
+    boundaries = tkwant.leads.automatic_boundary(syst.leads, tmax=10000, refl_max=1E-10)
     psi = onebody.ScatteringStates(syst, energy=1, lead=0, boundaries=boundaries)[mode]
 
 For closed quantum systems (without leads), no boundary conditions are needed.
 
 .. seealso::
     A tutorial on boundary conditions is given in :ref:`boundary`.
     An example script which shows alternative boundary conditions is given in :ref:`alternative_boundary_conditions`.
@@ -100,56 +100,63 @@
 
 Time-dependent perturbation
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 When the method ``onebody.WaveFunction.from_kwant()`` is used,
 the time-dependent perturbation :math:`W(t)` is extracted from the Hamiltonian
 of a Kwant system. By defaut, Tkwant uses cubic spline interpolation to interpolate
-:math:`W(t)` in time with a static discretization time :math:`dt`.
+:math:`W(t)` in time with with an adaptive stepsize.
 The interpolation is used for performance reasons,
 in order to minimize the number of calls to Kwant.
 
-One can change the discretization time :math:`dt`, which by default is 
-:math:`dt = 1`, to a different value:
+One can switch off interpolation and always evaluate the exact :math:`W(t)` function with:
 
 .. jupyter-execute::
 
-    import functools as ft
-    perturbation_type = ft.partial(tkwant.onebody.kernels.PerturbationInterpolator, dt=0.5)
     psi = onebody.WaveFunction.from_kwant(syst=syst, psi_init=psi_st, energy=1.,
                                           boundaries=boundaries,
-                                          perturbation_type=perturbation_type)
+                                          perturbation_type=onebody.kernels.PerturbationExtractor)
 
-Setting :math:`dt = 0` will switch off interpolation and always evaluate the exact :math:`W(t)` function.
-Alternatively, one can switch off interpolation directly with
+For the onebody scattering state solver ``onebody.ScatteringStates``,
+the :math:`W(t)` interpolation is switched off with: 
 
 .. jupyter-execute::
 
-    psi = onebody.WaveFunction.from_kwant(syst=syst, psi_init=psi_st, energy=1.,
-                                          boundaries=boundaries,
-                                          perturbation_type=tkwant.onebody.kernels.PerturbationExtractor)
+    import functools as ft
+
+    wavefunction_type = ft.partial(tkwant.onebody.WaveFunction.from_kwant,
+                                   perturbation_type=onebody.kernels.PerturbationExtractor)
+
+    mode = 0
+    psi = onebody.ScatteringStates(syst, energy=1., lead=0, tmax=100,
+                                   wavefunction_type=wavefunction_type)[mode]
+
 
 Saving and restarting states
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 
 Sometimes we might like to save a state in order to resume a calculation
-on a later stage. An easy way is to to use the ``pickle`` package:
+on a later stage.  An easy way is to to use the ``pickle`` package:
 
 .. jupyter-execute::
 
     import pickle
+
+    psi = onebody.WaveFunction.from_kwant(syst=syst, psi_init=psi_st, energy=1.,
+                                          boundaries=boundaries,
+                                          kernel_type=onebody.kernels.Scipy)
+
     saved = pickle.dumps(psi)
 
+Saving a state works currently only with the ``tkwant.onebody.kernels.Scipy`` kernel.
 The saved object ``saved`` can be stored.
 Recovering the state later on in order to continue the
 calculation is possible by using
 
 .. jupyter-execute::
 
     new_psi = pickle.loads(saved)
 
 See :ref:`restarting` for the complete code.
-Saving a state with ``pickle`` might not work for certain non-python kernels like
-``onebody.kernel.Simple`` and ``onebody.kernel.SparseBlas``.
 
 .. seealso::
     An example script showing the restarting of states is given in :ref:`restarting`.
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/scattering_region.png` & `tkwant-1.1.0rc2/doc/tutorial_source/scattering_region.png`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/tutorial/system_with_lead.png` & `tkwant-1.1.0rc2/doc/tutorial_source/system_with_lead.png`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/source/tutorial/time_dep_system.rst` & `tkwant-1.1.0rc2/doc/tutorial_source/time_dep_system.rst`

 * *Files 4% similar despite different names*

```diff
@@ -1,12 +1,19 @@
 .. _time_dep_system:
 
 Time-dependent potentials and pulses
 ====================================
 
+.. jupyter-execute::
+    :hide-code:
+
+    # suppress jupyter warnings messages when calling kwant.plot()
+    import matplotlib.pyplot, matplotlib.backends
+
+
 Tkwant uses Kwant to define the Hamiltonian of the tight-binding system.
 We show in the following how time-dependent onsite and coupling elements
 are defined. The latter can be used to simulate the injection of voltage
 pulses through the lead electrodes.
 
 Time dependent onsite elements
 ------------------------------
@@ -66,15 +73,15 @@
     state = tkwant.manybody.State(syst, tmax=100, params={'fac':0.1, 'omega':0.5})
 
 The position of the ``time`` variable within the optional parameters in 
 the ``onsite()`` function is arbitrary.
 
 .. seealso::
     An example script which a time-dependent onsite potential is
-    :download:`1d_wire_onsite.py <../../examples/1d_wire_onsite.py>`.
+    :download:`1d_wire_onsite.py <1d_wire_onsite.py>`.
     An example using optional parameters can be found in
     :download:`fabry_perot.py <fabry_perot.py>`.
 
 
 Time dependent coupling elements
 --------------------------------
 Time-dependent coupling elements of the Hamiltonian can be defined quite similar.
@@ -135,80 +142,96 @@
 In the current example,
 a time dependent potential drop is injected at a position :math:`i_b`, such that the
 system Hamiltonian becomes
 
 .. math::
 
 
-       \hat{H}(t) =\sum_{ij} \gamma_{ij} c^\dagger_i c_i + \sum_i w(t) \theta(i_b - i) c^\dagger_i c_i
+       \hat{H}(t) = - \gamma \sum_{i} c^\dagger_{i + 1} c_i + \textrm{h.c.} + \sum_i w(t) \theta(i_b - i) c^\dagger_i c_i
 
 :math:`\theta(x)` is the Heaviside function and :math:`w(t)` an
-arbitrary function parametrizing the time-dependent perturbation that we
-like to apply to the system. In this example we choose a Gaussian
-function
+arbitrary function parametrizing the time-dependent perturbation is applied to the system.
+One can absorb the
+effect of the time-dependent perturbation by a gauge transform. Defining
+the integrated pulse
 
 .. math::
 
 
-       w(t) =  v_p e^{- ((t - t_0) / \tau)^2}
+       \phi(t) = (e / \hbar) \int_{- \infty}^t dt' w(t') 
 
-where :math:`v_p` is some strenght and :math:`\tau` accounts for the
-width of the pulse. Note the convention that the time-dependent
-perturbation has to start after time :math:`t=0` and we have introduced a shift
-:math:`t_0` that should be chosen large enought
-to switch on the perturbation adiabatically. 
-One can absorb the
-effect of the time-dependent perturbation by a gauge transform. Defining
-the integrated pulse
+this amount to simply replace the couplings :math:`\gamma` from sites at
+:math:`i_b` to site at :math:`i_b + 1` by the time dependent couplings
+:math:`\gamma(t)`:
 
 .. math::
 
 
-       \phi(t) = (e / \hbar) \int_{- \infty}^t dt' w(t') = A (1 + \textrm{erf}( (t - t_0) / \tau)), \qquad A = (e / \hbar ) v_p \tau \sqrt{\pi}/2 , 
+       \gamma c^\dagger_{i_b +1} c_{i_b}  \rightarrow \gamma(t) c^\dagger_{i_b +1} c_{i_b}, \qquad \gamma(t) = \gamma e^{- i \phi(t)}
 
-we just have to rewrite the coupling :math:`\gamma` between site
-:math:`i_b` and :math:`i_b + 1` by the time dependent coupling
-:math:`\gamma(t)`:
+respectively the hermitian conjugate for the couplings from site
+:math:`i_b + 1` to sites :math:`i_b`.
+
+The Hamiltonian becomes
+
+.. math::
+
+
+       \hat{H}(t) = - \gamma \sum_{ij} c^\dagger_{i + 1} c_i  - \gamma [e^{- i \phi(t)} - 1] c^\dagger_{i_b + 1} c_{i_b} + \textrm{h.c.}
+
+
+In this example we choose a Gaussian function
+
+.. math::
+
+
+       w(t) =  v_p e^{- ((t - t_0) / \tau)^2}
+
+where :math:`v_p` is some strenght and :math:`\tau` accounts for the
+width of the pulse. Note the convention that the time-dependent
+perturbation has to start after time :math:`t=0` and we have introduced a shift
+:math:`t_0` in order to switch it on adiabatically.
+One finds
 
 .. math::
 
 
-       \gamma \rightarrow \gamma(t) = \gamma e^{- i \phi(t)}
+       \phi(t) = A (1 + \textrm{erf}( (t - t_0) / \tau)), \qquad A = (e / \hbar ) v_p \tau \sqrt{\pi}/2 , 
 
-In the following code we define the function :math:`\phi(t)` named
-``gaussian`` and replace the coupling between site 0 and 1 by the time
-dependent coupling
+In the Python code we define directly the function :math:`\phi(t)` and replace the coupling $\gamma$ from sites 0 to 1 by the time
+dependent coupling $\gamma(t)$ defined above. Note that the hermitian conjugate coupling
+from sites 1 to sites 0 is added by Kwant automatically.
 
 .. jupyter-execute::
 
     import kwant
     import cmath
     from scipy.special import erf
 
     def make_system(a=1, gamma=1.0, W=10, L=30):
 
         lat = kwant.lattice.square(a=a, norbs=1)
         syst = kwant.Builder()
 
-        def gaussian(time):
+        def phi(time):
             t0 = 100
             A = 0.00157
             tau = 24
             return A * (1 + erf((time - t0) / tau))
 
         # time dependent coupling with gaussian pulse
-        def coupling_nn(site1, site2, time):
-            return - gamma * cmath.exp(- 1j * gaussian(time))
+        def gamma_t(site1, site2, time):
+            return - gamma * cmath.exp(- 1j * phi(time))
 
         #### Define the scattering region. ####
         syst[(lat(x, y) for x in range(L) for y in range(W))] = 4 * gamma
         syst[lat.neighbors()] = -gamma
-        # time dependent coupling between two sites 0 and 1
-        time_dependent_hoppings = [(lat(0, y), lat(1, y)) for y in range(W)]
-        syst[time_dependent_hoppings] = coupling_nn
+        # time dependent lead-sys couplings from sites (x=0, y) to (x=1, y)
+        time_dependent_hoppings = [(lat(1, y), lat(0, y)) for y in range(W)]
+        syst[time_dependent_hoppings] = gamma_t
 
         #### Define and attach the leads. ####
         # Construct the left lead.
         lead = kwant.Builder(kwant.TranslationalSymmetry((-a, 0)))
         lead[(lat(0, j) for j in range(W))] = 4 * gamma
         lead[lat.neighbors()] = -gamma
 
@@ -258,22 +281,22 @@
 The time dependent couplings are added by
 
 .. jupyter-execute::
 
     import tkwant
     from scipy.special import erf
 
-    def gaussian(time):
+    def phi(time):
         t0 = 100
         A = 0.00157
         tau = 24
         return A * (1 + erf((time - t0) / tau))
 
     syst = make_system()
-    added_sites = tkwant.leads.add_voltage(syst, 0, gaussian)
+    added_sites = tkwant.leads.add_voltage(syst, 0, phi)
 
 In fact, the routine adds new sites at the system-lead interface and
 modifies ``syst``. Note that ``syst`` must not be finalized. We can also
 skip ``added_sites`` and call ``tkwant.leads.add_voltage`` without
 return argument, if we are not interested in the added sites. The second
 function argument of ``tkwant.leads.add_voltage`` corresponds to the
 lead number, here ``0``, where the pulse is injected. We can show the
```

### Comparing `tkwant-1.0.1/doc/source/tutorial/toy.png` & `tkwant-1.1.0rc2/doc/tutorial_source/toy.png`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/sphinxext/kwantdoc.py` & `tkwant-1.1.0rc2/doc/sphinxext/kwantdoc.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,13 +1,15 @@
 # Copyright 2016 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
-# the file AUTHORS.rst at the top-level directory of this distribution.
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
+# the file AUTHORS.rst at the top-level directory of this distribution and at
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 """Simple sphinx extension that allows for a section that can be
 hidden/shown on click using javascript"""
 
 from docutils import nodes
 from docutils.parsers.rst import directives, Directive
```

### Comparing `tkwant-1.0.1/doc/templates/autosummary/class.rst` & `tkwant-1.1.0rc2/doc/templates/autosummary/class.rst`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/doc/templates/layout.html` & `tkwant-1.1.0rc2/doc/templates/layout.html`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/docker/Dockerfile.debian` & `tkwant-1.1.0rc2/docker/Dockerfile.debian`

 * *Files 8% similar despite different names*

```diff
@@ -3,15 +3,15 @@
 FROM debian:stable
 MAINTAINER Kwant developers <authors@kwant-project.org>
 
 RUN apt-get update && apt-get install -y --no-install-recommends\
     # CI requirements
     apt-transport-https file openssh-client rsync\
     # all the hard non-Python dependencies
-    git g++ make patch gfortran libblas-dev liblapack-dev librsb-dev\
+    git g++ make patch gfortran libblas-dev liblapack-dev\
     libmumps-scotch-dev pkg-config libfreetype6-dev texlive texlive-latex-extra\
     dvipng\
     # all the hard Python dependencies -- use the distribution's
     # repositories so we don't rely on versions that are too new
     python3-all-dev python3-pip python3-setuptools python3-tk python3-matplotlib\
     cython3 python3-numpy python3-scipy python3-mpi4py python3-sympy
```

### Comparing `tkwant-1.0.1/pytest.ini` & `tkwant-1.1.0rc2/pytest.ini`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/setup.py` & `tkwant-1.1.0rc2/setup.py`

 * *Files 11% similar despite different names*

```diff
@@ -1,17 +1,18 @@
 #!/usr/bin/env python3
 # -*- coding: utf-8 -*-
 
 # Copyright 2016-2020 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 from __future__ import print_function  # so we can tell python2 users to upgrade
 import os
 import sys
 import re
 import importlib
 import collections
@@ -21,48 +22,52 @@
 v = sys.version_info
 if v[:2] < (3, 4):
     error = "tkwant requires Python 3.4 or above."
     print(error, file=sys.stderr)
     sys.exit(1)
 
 from setuptools import setup, find_packages, Extension
+
+# Until there is an alternative way to add custom build steps, make sure that
+# setuptools' local distutils copy is used.  This works around the removal of
+# distutils from stdlib.  See https://github.com/pypa/setuptools/issues/2928.
+os.environ['SETUPTOOLS_USE_DISTUTILS'] = 'local'
 from distutils.command.build import build
 from distutils.errors import DistutilsError, DistutilsModuleError, \
     CCompilerError
+
 from setuptools.command.sdist import sdist
 from setuptools.command.build_ext import build_ext
 
 import scipy.integrate
 
-STATIC_VERSION_PATH = ('tkwant', '_tkwant_version.py')
 CONFIG_FILE = 'build.conf'
 README_FILE = 'README.rst'
 README_END_BEFORE = 'See also in this directory:'
 REQUIRED_CYTHON_VERSION = (0, 22)
-CYTHON_OPTION = '--cython'
+CYTHON_OPTION = '--no-cython'
 CYTHON_TRACE_OPTION = '--cython-trace'
 MANIFEST_IN_FILE = 'MANIFEST.in'
-SPARSELIB = None
 distr_root = os.path.dirname(os.path.abspath(__file__))
 
 # Let tkwant itself determine its own version.
 # We cannot simply import tkwant, as it is not built yet.
 spec = importlib.util.spec_from_file_location('_common', 'tkwant/_common.py')
 common_module = importlib.util.module_from_spec(spec)
 spec.loader.exec_module(common_module)
 
-version = common_module.version
-version_is_from_git = common_module.version_is_from_git
+version = common_module.TKWANT_VERSION
+
 
 # Cython setup
 try:
     sys.argv.remove(CYTHON_OPTION)
-    use_cython = True
+    use_cython = False
 except ValueError:
-    use_cython = version_is_from_git
+    use_cython = True
 
 try:
     sys.argv.remove(CYTHON_TRACE_OPTION)
     trace_cython = True
 except ValueError:
     trace_cython = False
 
@@ -89,17 +94,14 @@
 def complain_cython_unavailable():
     assert not use_cython or cython_version < REQUIRED_CYTHON_VERSION
     if use_cython:
         msg = ("Install Cython {0} or newer so it can be made\n"
                "or use a source distribution of tkwant.")
         ver = '.'.join(str(e) for e in REQUIRED_CYTHON_VERSION)
         print(msg.format(ver), file=sys.stderr)
-    else:
-        print("Run setup.py with the {} option.".format(CYTHON_OPTION),
-              file=sys.stderr)
 
 
 def extension_config():
     #### Configure external dependencies
     global config_file_present
     config = configparser.ConfigParser()
     try:
@@ -127,27 +129,14 @@
     except OSError:
         return False
     else:
         p.communicate(input=b'int main() {}\n')
         return p.wait() == 0
 
 
-def search_sparse_blas():
-    """Return the configuration for SPBLAS if it is available in a known way."""
-
-    libs = [
-        ['rsb', 'blas'],  # By default, use librsb
-    ]
-
-    for libset in libs:
-        if _successful_link(libset):
-            return {'libraries': libset}
-    return {}
-
-
 def merge_dicts(*dicts):
     result = collections.defaultdict(list)
     for d in dicts:
         for key, item in d.items():
             result[key] = list(set(result[key] + item))
     return result
 
@@ -155,61 +144,19 @@
 def extensions():
     """Return a list of tuples (args, kwrds) to be passed to Extension."""
     global build_summary
     build_summary = []
     result = []
     kwrds_by_section = extension_config()
 
-    # Configure blas
-    blas = kwrds_by_section.get('blas')
-    if blas:
-        build_summary.append('User-configured BLAS')
-    else:
-        blas = {'libraries': ['blas']}
-        build_summary.append('Default BLAS')
-
-    # Setup sparse blas
-    sparseblas = kwrds_by_section.get('sparse-blas')
-    if sparseblas:
-        build_summary.append('User-configured SPARSE BLAS')
-    else:
-        sparseblas = search_sparse_blas()
-        msg = '{} SPARSE BLAS'.format('Auto-configured' if sparseblas else 'No')
-        build_summary.append(msg)
-    if sparseblas:
-        global SPARSELIB
-        if 'rsb' in sparseblas['libraries']:
-            SPARSELIB = 'rsb'
-        else:
-            SPARSELIB = 'generic'
-        # need actual module to perform library-specific initialization
-        result.append((['tkwant.linalg.blas_sparse',
-                        ['tkwant/linalg/blas_sparse.pyx']],
-                       sparseblas))
-
-    # add openmp flags
-    for d in (blas, sparseblas):
-        if not d:
-            continue
-        d['extra_compile_args'] = ['-fopenmp', '-g', '-O2']
-        d['extra_link_args'] = ['-fopenmp']
-
     ### add tkwant components
 
     # kernels
     result.append((['tkwant.onebody.kernels', ['tkwant/onebody/kernels.pyx']],
                    {}))
-    if sparseblas:
-        result.append(
-            (['tkwant.onebody._sparse_blas_kernel',
-              ['tkwant/onebody/_sparse_blas_kernel.pyx']],
-              merge_dicts(sparseblas, blas,
-                          {'depends': ['tkwant/onebody/kernels.pxd',
-                                       'tkwant/linalg/blas_sparse.pxd']}))
-        )
 
     # solvers
     result.append((['tkwant.onebody.solvers',
       ['tkwant/onebody/solvers.pyx']],
      {
       'depends': ['tkwant/onebody/kernels.pxd'],
      }
@@ -233,16 +180,15 @@
     If Cython is not to be run, replace .pyx extensions with .c or .cpp, and
     check timestamps.
     """
     if use_cython and cython_version >= REQUIRED_CYTHON_VERSION:
         return cythonize([Extension(*args, **kwrds) for args, kwrds in extensions],
                          language_level=3,
                          compiler_directives={'profile': False,
-                                              'linetrace': trace_cython},
-                         compile_time_env={'SPARSELIB': SPARSELIB}
+                                              'linetrace': trace_cython}
                         )
 
     # Cython is not going to be run: replace pyx extension by that of
     # the shipped translated file.
 
     result = []
     problematic_files = []
@@ -304,15 +250,15 @@
                 reason = "the installed Cython is too old"
             print(banner(" Error "), msg.format(reason, problematic_files),
                   banner(), sep="\n", file=sys.stderr)
             print()
             complain_cython_unavailable()
             exit(1)
         else:
-            reason = "the option {} has not been given".format(CYTHON_OPTION)
+            reason = "the option {} has been given or no cython available.".format(CYTHON_OPTION)
             dontworry = ('(Do not worry about this if you are building tkwant\n'
                          'from unmodified sources, e.g. with "pip install".)\n')
             print(banner(" Caution "), dontworry,
                   msg.format(reason, problematic_files),
                   banner(), sep='\n', file=sys.stderr)
 
     return result
@@ -342,17 +288,14 @@
                 text.pop()
     except:
         return ''
     return '\n'.join(text)
 
 
 def git_lsfiles():
-    if not version_is_from_git:
-        return
-
     try:
         p = subprocess.Popen(['git', 'ls-files'], cwd=distr_root,
                              stdout=subprocess.PIPE, stderr=subprocess.PIPE)
     except OSError:
         return
 
     if p.wait() != 0:
@@ -368,15 +311,14 @@
 
 ################ build commands
 
 class tkwant_build(build):
 
     def run(self):
         super().run()
-        write_version(os.path.join(self.build_lib, *STATIC_VERSION_PATH))
 
 
 error_msg = """{header}
 The compilation of tkwant has failed.  Please examine the error message
 above and consult the installation instructions in README.rst.
 You might have to customize {{file}}.
 
@@ -448,15 +390,14 @@
                    "to be included in the\n"
                    "source distribution.  The old {} was used.")
             msg = msg.format(MANIFEST_IN_FILE),
             print(banner(' Caution '), msg, banner(), sep='\n', file=sys.stderr)
 
     def make_release_tree(self, base_dir, files):
         sdist.make_release_tree(self, base_dir, files)
-        write_version(os.path.join(base_dir, *STATIC_VERSION_PATH))
 
 
 
 ################ requirements
 
 requirements = (
     "cython>=0.21.1",
```

### Comparing `tkwant-1.0.1/tkwant/__init__.py` & `tkwant-1.1.0rc2/tkwant/__init__.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,42 +1,36 @@
 # -*- coding: utf-8 -*-
 # Copyright 2016 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """tkwant, a Python package for time-resolved quantum transport."""
 
 import os
 
-from ._common import version as __version__  # pragma: no flakes
+from ._common import TKWANT_VERSION
 from ._common import TkwantDeprecationWarning
 from . import _logging as logging
 
 __all__ = ['TkwantDeprecationWarning', 'logging']
 
-for module in ('system', 'leads', 'onebody', 'manybody', 'mpi'):
+for module in ('system', 'leads', 'onebody', 'manybody', 'mpi',
+               'greenfunctions', 'special', 'interaction'):
     exec('from . import {0}'.format(module))
     __all__.append(module)
 
 
-# to make stuff available in tkwant namespace
-# available = [
-#    ('system', [])
-# ]
-
-# for module, names in available:
-#    exec('from .{0} import {1}'.format(module, ', '.join(names)))
-#    __all__.extend(names)
-# del available, module, names  # remove cruft from namespace
-
-
 del module  # remove cruft from namespace
 
+# set version attribute
+__version__ = TKWANT_VERSION
+
 
 def test(verbose=True):
     """Run tkwant's unit tests."""
     import pytest
     return pytest.main([os.path.dirname(os.path.abspath(__file__)), '-s']
                        + (['-v'] if verbose else []))
```

### Comparing `tkwant-1.0.1/tkwant/_logging.py` & `tkwant-1.1.0rc2/tkwant/_logging.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
-# Copyright 2020 tkwant authors.
+# Copyright 2020-2022 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Logging routines."""
 
 import logging
 import functools
 import sys
 
 __all__ = ['level', 'handler', 'filter', 'debug_handler', 'simple_handler',
@@ -132,11 +133,17 @@
 """logging handler with format: level:module-name:line-number:MPI-rank: message"""
 _format = logging.Formatter('%(levelname)s:%(name)s:%(lineno)d:rank=%(rank)s: %(message)s')
 debug_handler = _make_handler(_format)
 
 """logging handler with format: message"""
 simple_handler = _make_handler()
 
+
+# predefined filter
+def _filter_master_rank(record):  # log only MPI master (rank zero)
+    return True if record.rank == 0 else False
+
+
 # tkwant's default logging settings
 level = logging.WARNING
-handler = logging.NullHandler()  # suppress logging
-filter = None
+handler = debug_handler
+filter = _filter_master_rank  # log only MPI master (rank zero)
```

### Comparing `tkwant-1.0.1/tkwant/integration.py` & `tkwant-1.1.0rc2/tkwant/integration.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,19 +1,20 @@
 # -*- coding: utf-8 -*-
 # Copyright 2016-2019 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Tools for calculating numeric integrals."""
 
 import numpy as np
-from . import line_segment
+from . import line_segment, _common
 
 __all__ = ['calc_abscissas_and_weights']
 
 
 def _trapezoidal_rule(n):
     """Calculate trapezoidal abcissas and weights on an interval [-1, 1]
 
@@ -85,17 +86,42 @@
       and the second element `result[1]` corresponds to the higher-order
       (`2*n + 1`) approximation of the integral.
     - For general quadratures with array-like weights aka Gauss-Kronrod,
       we use the convention that the last element of the first array index
       corresponds to the higher-order rule.
     """
 
-    if a > b:
-        raise ValueError('lower bound={} is larger then upper bound={}'
-                         .format(a, b))
+    # weights and abscissas in intervall [-1, 1]
+    x, w = _abscissas_and_weights(n, quadrature)
+
+    # rescale weights and abscissas to interval [a, b]
+    x, w = _rescale_interval(a, b, x, w)
+    return x, w
+
+
+@_common.memoize
+def _abscissas_and_weights(n, quadrature):
+    """Return abscissas and weights in intervall [-1, 1]
+
+    Parameters
+    ----------
+    n : int
+        Order of quadrature integration. Must be positive, n > 0
+    quadrature : string
+        Quadrature rule to use.
+
+    Returns
+    -------
+    x : Numpy float array
+        abscissa values
+
+    w : Numpy float array
+        quadrature weights
+    """
+
     if n <= 0:
         raise ValueError('number of points={} must be positive'.format(n))
     if not np.issubdtype(type(n), np.integer):
         raise TypeError('number of points={} must be an integer'.format(n))
 
     # weights and abscissas in intervall [-1, 1]
     w2 = None
@@ -116,18 +142,18 @@
         x, w2 = _trapezoidal_rule(2 * n - 1)
         w1 = np.zeros(2 * n - 1)
         w1[0::2] = _w1
         w = np.vstack((w1, w2))
     else:
         raise NotImplementedError('quadrature={} not implemented'
                                   .format(quadrature))
-
-    # rescale weights and abscissas to interval [a, b]
-    x, w = _rescale_interval(a, b, x, w)
     return x, w
 
 
 def _rescale_interval(a, b, x, w):
     """rescale weights and abscissas from intervall [-1, 1] to [a, b]"""
+    if a > b:
+        raise ValueError('lower bound={} is larger then upper bound={}'
+                         .format(a, b))
     pp = (b + a) / 2
     mm = (b - a) / 2
     return np.array(x) * mm + pp, np.array(w) * mm
```

### Comparing `tkwant-1.0.1/tkwant/leads.py` & `tkwant-1.1.0rc2/tkwant/leads.py`

 * *Files 13% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
-# Copyright 2016-2019 tkwant authors.
+# Copyright 2016-2022 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Tools for dealing with time-dependent infinite, periodic leads.
 
 Also contains tools for dealing with boundary conditions that simulate
 the effect of leads when solving the time-dependent Schrödinger equation.
 """
 
 import abc
@@ -145,50 +146,29 @@
 
     syst.leads[lead].interface = tuple(map(move, interface))
     return tuple(map(move, lead_builder.H))
 
 
 # ---------- Boundary Conditions
 
-def _return_true(x):
-    return True
-
-
-class _TimeIsValid:
-    # Do not allow us to evolve beyond tmax
-    def __init__(self, tmax):
-        self.tmax = tmax
-
-    def __call__(self, time):
-        return time < self.tmax
-
 
 class EvaluatedBoundary(collections.namedtuple('_System', ['hamiltonian',
                                                            'to_slices',
-                                                           'from_slices',
-                                                           'solution_is_valid',
-                                                           'time_is_valid'])):
+                                                           'from_slices'])):
     """Boundary conditions evaluated for a lead.
 
     Parameters
     ----------
     hamiltonian : `~scipy.sparse.coo_matrix`
         The Hamiltonian matrix of the boundary conditions evaluated over
         the lead.
     to_slices, from_slices : sequence of `tinyarray.array`
         Each array contains a pair of integers: a slice into ``hamiltonian``
         which we wish to connect *to* (or *from*) the Hamiltonian of the
         central region.
-    solution_is_valid : callable
-        Function that takes a 1D array of the same size as ``hamiltonian``
-        (i.e the solution inside the boundary conditions), and returns
-        True if there are no spurious reflections detected.
-    time_is_valid : sequence of callable
-        Function that takes a float (time) and returns True if the
-        boundary conditions will remain valid up till this time.
 
     Notes
     -----
     ``to_slices`` and ``from_slices`` are used when constructing the
     Hamiltonian for the central system + boundary conditions. Usually The first
     slices will be over the first cell of the lead. Subsequent entries in
     ``from_slices`` can be used, for example, when constructing two "copies" of
@@ -196,15 +176,15 @@
     central region, but should not itself have any back-action on the central
     region (see section C of [1] for details).
 
     [1]: http://arxiv.org/abs/1510.05967
     """
 
 
-class BoundaryBase(metaclass=abc.ABCMeta):
+class Boundary(metaclass=abc.ABCMeta):
     """ABC boundary conditions for the time-dependent Schrödinger equation."""
 
     @abc.abstractmethod
     def __call__(self, lead, params=None):
         """Generate boundary conditions for a single lead.
 
         These boundary condition matrices must be formatted such that
@@ -221,104 +201,102 @@
 
         Returns
         -------
         `_EvaluatedBoundary`
         """
         pass
 
+    @property
+    def num_absorb_cells(self):
+        return self._num_absorb_cells
+
+    @num_absorb_cells.setter
+    def num_absorb_cells(self, num_cells):
+        if num_cells < 0:
+            raise ValueError('Number of absorbing cells must be positive.')
+        if not _common.is_type(num_cells, 'integer'):
+            raise ValueError('Number of absorbing cells must be an integer.')
+        self._num_absorb_cells = int(num_cells)
+
+    @property
+    def num_buffer_cells(self):
+        return self._num_buffer_cells
+
+    @num_buffer_cells.setter
+    def num_buffer_cells(self, num_cells):
+        if num_cells < 0:
+            raise ValueError('Number of buffer cells must be positive.')
+        if not _common.is_type(num_cells, 'integer'):
+            raise ValueError('Number of buffer cells must be an integer.')
+        self._num_buffer_cells = int(num_cells)
+
+    @property
+    def num_total_cells(self):
+        return self.num_buffer_cells + self.num_absorb_cells
+
 
-class SimpleBoundary(BoundaryBase):
+class SimpleBoundary(Boundary):
     """Boundary conditions consisting of N lead unit cells.
 
     Parameters
     ----------
-    num_cells : int, optional
-        The number of lead unit cells to add. Mutually exclusive with
-        ``tmax``.
+    num_buffer_cells : int
+        The number of lead unit cells to add.
     tmax : float, optional
-        The maximum time up to which we wish to simulate with these
-        boundary conditions. Mutually exclusive with ``num_cells``
+        Optional maximal time until when the boundary is valid.
     """
 
-    def __init__(self, num_cells=None, tmax=None):
-        self.num_total_cells = self.tmax = None
+    def __init__(self, num_buffer_cells, tmax=None):
+
+        if num_buffer_cells == 0:
+            raise ValueError('Number of unit cells must be greater zero.')
 
-        if num_cells is not None:
-            if num_cells <= 0:
-                raise ValueError('Number of unit cells must be positive.')
-            self.num_total_cells = int(num_cells)
-
-        if tmax is not None:
-            if tmax <= 0:
-                raise ValueError('Maximum time must be positive.')
-            self.tmax = float(tmax + 1)  # 1 to prevent rounding problems
-
-        if self.num_total_cells is None and self.tmax is None:
-            raise TypeError('Either `num_cells` or `tmax` must be provided.')
-        elif self.num_total_cells is not None and self.tmax is not None:
-            raise TypeError('`num_cells` and `tmax` are mutually exclusive.')
+        self.num_buffer_cells = num_buffer_cells
+        self.num_absorb_cells = 0
+        self.tmax = tmax
 
     def __call__(self, lead, params=None):
         H_cell = lead.cell_hamiltonian(params=params, sparse=True)
         V_cell = lead.inter_cell_hopping(params=params, sparse=True)
         V_cell = _make_square_matrix(V_cell)
         cell_norbs = H_cell.shape[0]
 
-        # twice the spectral norm of V_cell gives max velocity
-        max_velocity = (2 * np.linalg.norm(V_cell.todense(), ord=2))
-
-        tmax = self.tmax or self.num_total_cells / max_velocity
-        # add 1 to prevent off-by-one error due to inter-cell hoppings
-        num_cells = (self.num_total_cells
-                     or int(np.ceil(self.tmax * max_velocity)) + 1)
-
-        assert tmax is not None
-
         H = _make_block_tridiagonal(H_cell, V_cell,
                                     V_cell.conjugate().transpose(),
-                                    num_cells)
-
-        # With these boundary conditions there is no way to explicitly
-        # check if the solution is good for a given lead_psi.
-        solution_is_valid = _return_true
-        time_is_valid = _TimeIsValid(tmax)
+                                    self.num_buffer_cells)
 
         return EvaluatedBoundary(hamiltonian=H,
                                  to_slices=[ta.array([0, cell_norbs])],
-                                 from_slices=[ta.array([0, cell_norbs])],
-                                 solution_is_valid=solution_is_valid,
-                                 time_is_valid=time_is_valid)
+                                 from_slices=[ta.array([0, cell_norbs])])
+
 
+class AbsorbingBoundary(Boundary):
+    """Abstract base class for absorbing boundary conditions."""
 
-class AbsorbingBoundary(SimpleBoundary):
+    def __init__(self, num_absorb_cells, num_buffer_cells=0):
+
+        self._simple_boundary = SimpleBoundary(num_absorb_cells + num_buffer_cells)
+        self.num_absorb_cells = num_absorb_cells
+        self.num_buffer_cells = num_buffer_cells
 
     def __call__(self, lead, params=None):
         # get the regular boundary conditions by calling superclass
-        simple_boundary = super().__call__(lead, params)
+        simple_boundary = self._simple_boundary(lead, params)
 
         # make diagonal matrix with entries increasing as we go to further into
         # the lead, but with entries constant over a given cell.
-        bc_diags = [self._absorb(cell) for cell in range(self.num_cells)]
+        bc_diags = [self._absorb(cell) for cell in range(self.num_absorb_cells)]
         bc_diags = [0] * self.num_buffer_cells + bc_diags  # add buffer cells
         cell_norbs = _get_slice(lead, lead.cell_size).start
         S = sp.kron(sp.diags(bc_diags, offsets=0), sp.eye(cell_norbs))
         H = simple_boundary.hamiltonian - 1j * S
 
-        # With these boundary conditions there is no way to explicitly
-        # check if the solution is good for a given lead_psi.
-        solution_is_valid = _return_true
-
-        # apriori there is no "max time" with absorbing boundary conditions
-        time_is_valid = _return_true
-
         return EvaluatedBoundary(hamiltonian=H,
                                  to_slices=simple_boundary.to_slices,
-                                 from_slices=simple_boundary.from_slices,
-                                 solution_is_valid=solution_is_valid,
-                                 time_is_valid=time_is_valid)
+                                 from_slices=simple_boundary.from_slices)
 
     @abc.abstractmethod
     def _absorb(self, cell):
         """Return the absorbing potential in the given cell."""
         pass
 
 
@@ -328,82 +306,74 @@
     The absorbing region has an imaginary potential applied to it.
     The magnitude of the imaginary potential grows according to
     ``n**degree`` where ``n`` is the index (starting from 0) of the
     lead cell counting from the central region.
 
     Parameters
     ----------
-    num_cells : int
+    num_absorb_cells : int
         The number of lead unit cells over which the absorbing potential
         increases.
     strength : float
         The strength of the boundary conditions. Formally
         this is the area underneath the monomial curve.
     degree : int
         The degree of the absorbing monomial.
     num_buffer_cells : int, optional
         If provided, adds this many lead cells to the start
         of the boundary conditions with no absorbing potential
         applied.
+    tmax : float, optional
+        Optional maximal time until when the boundary is valid.
     """
 
-    def __init__(self, num_cells, strength, degree, num_buffer_cells=0):
-        if num_cells < 0:
-            raise ValueError('Cannot add a negative number of absorbing cells')
-        if num_buffer_cells < 0:
-            raise ValueError('Cannot add a negative number of buffer cells')
+    def __init__(self, num_absorb_cells, strength, degree, num_buffer_cells=0, tmax=None):
+
         if degree < 0:
             raise ValueError('Absorbing boundary conditions cannot be given '
                              'by a monomial of negative degree.')
-        super().__init__(num_cells + num_buffer_cells)
-        self.num_cells = int(num_cells)
+
+        super().__init__(num_absorb_cells, num_buffer_cells)
         self.strength = strength
-        self.degree = int(degree)
-        self.num_buffer_cells = int(num_buffer_cells)
+        self.degree = degree
+        self.tmax = tmax
 
     def _absorb(self, cell):
         n = self.degree
-        return (n + 1) * self.strength * (cell**n / self.num_cells**(n + 1))
+        return (n + 1) * self.strength * (cell**n / self.num_absorb_cells**(n + 1))
 
 
 class GenericAbsorbingBoundary(AbsorbingBoundary):
     """Make an absorbing boundary from a user provided-absorbing potential.
 
     Parameters
     ----------
     imaginary_potential : callable
         User-provided absorbing potential.
-    num_cells : int
+    num_absorb_cells : int
         The number of lead unit cells over which the absorbing potential
         increases.
     num_buffer_cells : int, optional
         If provided, adds this many lead cells to the start
         of the boundary conditions with no absorbing potential applied.
+    tmax : float, optional
+        Optional maximal time until when the boundary is valid.
     """
 
-    def __init__(self, num_cells, imaginary_potential, num_buffer_cells=0):
+    def __init__(self, num_absorb_cells, imaginary_potential, num_buffer_cells=0, tmax=None):
 
         if not callable(imaginary_potential):
             raise ValueError('Absorbing potential is not callable')
-        if num_cells < 0:
-            raise ValueError('Cannot add a negative number of absorbing cells')
-        if num_buffer_cells < 0:
-            raise ValueError('Cannot add a negative number of buffer cells')
-
-        super().__init__(num_cells + num_buffer_cells)
-        self.num_cells = int(num_cells)
-        self.num_buffer_cells = int(num_buffer_cells)
+
+        super().__init__(num_absorb_cells, num_buffer_cells)
         self._imaginary_potential = imaginary_potential
+        self.tmax = tmax
 
     def _absorb(self, cell):
-        return self._imaginary_potential(cell / self.num_cells) / self.num_cells
-
-
-# TODO: add boundary conditions with a second "copy" that we can use to tell
-#       if our solution has any spurious reflection.
+        return self._imaginary_potential(cell / self.num_absorb_cells) / self.num_absorb_cells
 
 
 # ---------- Internal functions
 # TODO: move these to Cython
 
 def _set_signature(func, params):
     """Set the signature of 'func'.
@@ -751,56 +721,56 @@
     def hamiltonian(self, i, j, *args, **kwargs):
         i0 = i * self.norbs
         j0 = j * self.norbs
         return np.array([[self.H[i0 + ii, j0 + jj] for jj in range(self.norbs)]
                          for ii in range(self.norbs)], dtype=self.H.dtype)
 
 
-def _finite_lead_hamiltonian(lead, num_cells, imaginary_potential=None,
+def _finite_lead_hamiltonian(lead, num_absorb_cells, imaginary_potential=None,
                              params=None):
     """Extract the Hamiltonian matrix :math:`H` for a lead set to a
     finite lengths in presence of an imaginary potential.
 
     Parameters
     ----------
     lead : `kwant.system.InfiniteSystem`
         Kwant lead
-    num_cells : int
+    num_absorb_cells : int
         number of cells of the finite lead
     imaginary_potential : callable, optional
         imaginary potential function
     params : dict, optional
         Extra parameters for Hamiltonian value functions.
 
     Returns
     -------
     H : scipy.sparse.coo or scipy.sparse.lil matrix
-        Hamiltonian matrix, shape (num_cells*norbs, num_cells*norbs)
+        Hamiltonian matrix, shape (num_absorb_cells*norbs, num_absorb_cells*norbs)
         where norbs is the number of orbitals of the lead
 
     Notes
     -----
     If `imaginary_potential` is present, the Hamiltonian matrix
     will not be hermitian.
     """
 
-    assert _common.is_type(num_cells, 'integer')
-    if num_cells < 0:
-        raise ValueError('number of cells num_cells={} must be positive.'
-                         .format(num_cells))
+    assert _common.is_type(num_absorb_cells, 'integer')
+    if num_absorb_cells < 0:
+        raise ValueError('number of cells num_absorb_cells={} must be positive.'
+                         .format(num_absorb_cells))
     cell_norbs = _get_slice(lead, lead.cell_size).start
 
-    simple_boundary = SimpleBoundary(num_cells=num_cells)
+    simple_boundary = SimpleBoundary(num_absorb_cells)
     H0 = simple_boundary(lead, params).hamiltonian.transpose()
     if imaginary_potential is None:
         return H0, cell_norbs
     if not callable(imaginary_potential):
         raise ValueError('Absorbing potential is not callable')
-    bc_diags = [imaginary_potential(cell / num_cells) / num_cells
-                for cell in range(num_cells)]
+    bc_diags = [imaginary_potential(cell / num_absorb_cells) / num_absorb_cells
+                for cell in range(num_absorb_cells)]
     S = sp.kron(sp.diags(bc_diags, offsets=0), sp.eye(cell_norbs))
     return H0 - 1j * S, cell_norbs
 
 
 def _reflect(syst, energy, params=None):
     """Calculate the reflection amplitude :math:`r` for an absorbing lead."""
     assert _common.is_type(energy, 'real_number')
@@ -821,54 +791,54 @@
 class AbsorbingReflectionSolver:
 
     """Calculate the reflection amplitude :math:`r` for a lead
     with imaginary absorbing potential.
 
     Examples
     --------
-    >>> num_cells = 100
+    >>> num_absorb_cells = 100
     >>> def my_imaginary_potential(x):
             return 50 * x**4
-    >>> reflect = AnalyzeReflection(lead, num_cells, my_imaginary_potential)
+    >>> reflect = AnalyzeReflection(lead, num_absorb_cells, my_imaginary_potential)
     >>> energies = numpy.linspace(0, 0.5, 101)
     >>> r = reflect(energies)
 
 
     Notes
     -------
     An instance of this class can be called like a method to calculate
     the reflection amplitude :math:`r` of all open modes at a given energy.
     The reflection amplitude is calculated by a static kwant calculation.
     """
 
-    def __init__(self, lead, num_cells, imaginary_potential, params=None):
+    def __init__(self, lead, num_absorb_cells, imaginary_potential, params=None):
         """
         Parameters
         ----------
         lead : `kwant.system.InfiniteSystem`
             Kwant lead, for which the reflection should be calculated.
-        num_cells : int
-            number of cells for a finite lead taken into account
+        num_absorb_cells : int
+            number of absorbing cells for the lead
         imaginary_potential : callable
             absorbing potential function
         params : dict, optional
            Extra parameters for Hamiltonian value functions of ``lead``.
 
         """
 
         if not isinstance(lead, kwant.system.InfiniteSystem):
             raise TypeError('lead must be an instance of `InfiniteSystem`')
 
         self.lead = lead
         self.params = params
 
-        H, cell_norbs = _finite_lead_hamiltonian(lead, num_cells,
+        H, cell_norbs = _finite_lead_hamiltonian(lead, num_absorb_cells,
                                                  imaginary_potential,
                                                  params=params)
-        self.syst = _Chain_1d(num_cells, H, norbs=cell_norbs, leads=[lead])
+        self.syst = _Chain_1d(num_absorb_cells, H, norbs=cell_norbs, leads=[lead])
 
     def __call__(self, energies):
         """ Calculates the reflection amplitude :math:`r` for all open modes
         at the given energies.
 
         Parameters
         ----------
@@ -920,35 +890,35 @@
 
         return reflect, momenta, velocities
 
 
 class AnalyzeReflection:
     """ Analyze the the reflection for a lead."""
 
-    def __init__(self, lead, num_cells, imaginary_potential,
+    def __init__(self, lead, num_absorb_cells, imaginary_potential,
                  spectrum=None, params=None):
         """
         Parameters
         ----------
         lead : `kwant.system.InfiniteSystem`
             Kwant lead, for which the reflection should be calculated.
-        num_cells : int
+        num_absorb_cells : int
             number of cells for a finite lead taken into account
         imaginary_potential : callable
             absorbing potential function
         spectrum : `BandSketching`, optional
             `kwant.physics.BandSketching` instance of the lead.
             This is mainly for performance.
             If not present, it will be calculated on the fly from `lead`.
         params : dict, optional
             Extra parameters for Hamiltonian value functions of ``lead``.
 
         """
 
-        self.reflection_solver = AbsorbingReflectionSolver(lead, num_cells,
+        self.reflection_solver = AbsorbingReflectionSolver(lead, num_absorb_cells,
                                                            imaginary_potential,
                                                            params=params)
 
         if spectrum is None:
             self.spectrum = kwantspectrum.spectrum(lead, params=params)
 
     def __call__(self, k, band):
@@ -1050,29 +1020,29 @@
 
     Notes
     -------
     The reflection amplitude is calculated with analytic expressions
     derived in [1]_.
     Good agreement with the exact numerical result (via `AnalyzeReflection`)
     can only be expected if :math:`k * l >> 1`.
-    The length :math:`l` corresponds to `num_cells` and the momentum
+    The length :math:`l` corresponds to `num_absorb_cells` and the momentum
     :math:`k` is the distance from a local extremum of the spectrum.
 
     .. [1] `J. Weston and X. Waintal, Phys. Rev. B 93, 134506 (2016)
        <https://arxiv.org/abs/1510.05967>`_
     """
 
-    def __init__(self, lead, num_cells, strength, degree, params=None):
+    def __init__(self, lead, num_absorb_cells, strength, degree, params=None):
         """
         Parameters
         ----------
         lead : `kwant.system.InfiniteSystem` or `kwantspectrum.BandSketching`
             Kwant lead or `BandSketching` instance of the lead,
             for which the reflection should be calculated.
-        num_cells : int
+        num_absorb_cells : int
             number of cells for a finite lead taken into account
         degree : int
             order of the moniminal absorbing boundary potential.
         strength : float
             The strength of the boundary conditions. Formally
             this is the area underneath the monomial curve.
         params : dict, optional
@@ -1081,18 +1051,18 @@
             `kwant.system.InfiniteSystem`.
         """
         if isinstance(lead, kwant.system.InfiniteSystem):
             self.spectrum = kwantspectrum.spectrum(lead, params=params)
         else:
             self.spectrum = lead
 
-        if num_cells <= 0:
+        if num_absorb_cells <= 0:
             raise ValueError('Number of unit cells must be positive.')
 
-        self._reflect = ft.partial(_monomial_reflect, length_absorb=num_cells,
+        self._reflect = ft.partial(_monomial_reflect, length_absorb=num_absorb_cells,
                                    strength=strength, degree=degree)
 
     def around_extremum(self, kmin, kmax, band, nq=20, dq=0.001, gridtype='log'):
         """Calculate the reflection amplitude :math:`r` within the momentum
         interval ``[kmin, kmax]`` around a local extremum of the dispersion.
 
         Parameters
@@ -1253,17 +1223,17 @@
     r"""Optimal splitting `x` in buffer/absorbing zone for the low energy modes
     Formula obtained from d r_\Sigma / d x = 0 in low energy approximation
 
     Definition
     ----------
 
         length buffer zone (`num_buffer_cells`) = x * length
-        length absorbing zone (`num_cells`) = (1-x) * length
+        length absorbing zone (`num_absorb_cells`) = (1-x) * length
         length is total length of additional lead cells
-        (`num_cells + num_buffer_cells`)
+        (`num_absorb_cells + num_buffer_cells`)
 
     Returns
     -------
     x : float
         optimal splitting parameter
     """
     if degree < 0:
@@ -1642,30 +1612,30 @@
         The strength of the boundary conditions. Formally
         this is the area underneath the monomial curve.
     degree : int
         order of the monominal absorbing boundary potential.
         Must be positive > 0.
     length : float
         total length of all additional lead cells
-        (num_cells+num_buffer_cells)
+        (num_absorb_cells+num_buffer_cells)
 
     Returns
     -------
     refl : float
         reflection amplitude `r`, the value ranges between 0 and 1
 
     Notes
     -------
     If the routine encounters numerical problems, it returns
     a reflection coefficient of one.
     """
 
     x = _optimal_split(degree)
     length_buffer = x * length  # (corresponds to `num_buffer_cells`)
-    length_absorb = (1 - x) * length  # (corresponds to `num_cells`)
+    length_absorb = (1 - x) * length  # (corresponds to `num_absorb_cells`)
 
     # Get maximal momentum `k` of slow mode such that it stays into the buffer
     energy_func, vel_func, kmax = slow_mode
     if not callable(energy_func):
         raise ValueError('Energy function is not callable')
     if not callable(vel_func):
         raise ValueError('Velocity function is not callable')
@@ -1706,23 +1676,23 @@
         The strength of the boundary conditions. Formally
         this is the area underneath the monomial curve.
     degree : int
         order of the monominal absorbing boundary potential.
         Must be positive > 0.
     length_init : float
         initial total length of all additional lead cells
-        (num_cells+num_buffer_cells)
+        (num_absorb_cells+num_buffer_cells)
     lmin : float, optional
         minimal length to perform numerical root finding
 
     Returns
     -------
     length : float
         new estimate for the total length of the additional lead cells
-        (`num_cells + num_buffer_cells`)
+        (`num_absorb_cells + num_buffer_cells`)
         The returned value of length in inside the inteval [lmin, length_init]
     success : bool
         `True`: new smaller length found: `length < length_init`
          such that : `r < refl_max`.
         `False`: not able to find a smaller length such that:
         `length < length_init` and `r < refl_max`.
         `r` is the total reflection amplitude of the lead
@@ -1739,20 +1709,32 @@
     def func(length):  # reflection criterion `r < refl_max`
         length_absorb = length * xabs
         r1 = _monomial_reflect(energy, momentum, length_absorb, strength, degree)
         r2 = _reflect_slow_mode(slow_mode, tmax, strength, degree, length)
         return max(r1, r2) - refl_max
 
     # try to find a smaller length
-    try:
-        length = brentq(func, lmin, length_init)
-        success = True
-    except Exception:
-        length = length_init
-        success = False
+    # for very large length_init the function func() might increase again
+    # unphysically with the length. in that case brentq() does not find
+    # the root correctly and we try to reduce the initial length
+    # in order to have a unique root of func() inbetween lmin and lmax
+    lmax = length_init
+    length = length_init
+    dl = (lmax - lmin) / 4
+    success = False
+    while True:
+        if lmax > lmin:
+            try:
+                length = brentq(func, lmin, lmax)
+                success = True
+                break
+            except Exception:
+                lmax -= dl
+        else:
+            break
     return length, success
 
 
 def _optimize_strength(fast_mode, refl_max, degree, length_init):
     """Find an appropriate strength of the monomial absorbing potential,
     such that such that `r < refl_max`, while keeping the length fixed.
 
@@ -1764,15 +1746,15 @@
         maximal allowed reflection amplitude :math:`r`, must be in (0, 1)
         interval.
     degree : int
         order of the monominal absorbing boundary potential.
         Must be positive > 0.
     length_init : float
         initial total length of all additional lead cells
-        (`num_cells + num_buffer_cells`)
+        (`num_absorb_cells + num_buffer_cells`)
 
     Returns
     -------
     strength : float
         The strength of the boundary conditions. Formally
         this is the area underneath the monomial curve.
         `strength` is only meaningful if `success` is `True`
@@ -1783,15 +1765,15 @@
         `r` is the total reflection amplitude of the lead
     """
 
     # the total lead reflection `r` has absorption and reflection contribution.
     # a large strength lowers absorption but increases reflection and
     # vice versa. the reflection contribution (but not the absorption contrib.)
     # depends however also on the length over which the potential is smeared
-    # (`num_cells`) and can be lowered if we increase the length.
+    # (`num_absorb_cells`) and can be lowered if we increase the length.
     # the goal of this routine is to find a strength sufficiently large that
     # the fast mode is absorbed. we assume that the fast mode needs
     # the largest strength A. the strength should stay as small as possible
     # however to keep the reflection contribution, especially from the slow
     # modes, small, in order to choose the length small as well.
 
     # TODO: can we tune here ?
@@ -1827,21 +1809,21 @@
         maximal allowed reflection amplitude :math:`r`, must be in (0, 1)
         interval.
     degree : int
         order of the monominal absorbing boundary potential.
         Must be positive > 0.
     length_init : float
         initial total length of all additional lead cells
-        (num_cells+num_buffer_cells)
+        (num_absorb_cells+num_buffer_cells)
 
     Returns
     -------
     length : float
         new estimate for the total length of the additional lead cells
-        (`num_cells + num_buffer_cells`)
+        (`num_absorb_cells + num_buffer_cells`)
     strength : float
         The strength of the boundary conditions. Formally
         this is the area underneath the monomial curve.
         `strength` is only meaningful if `success` is `True`
     success : bool
         `True`: new smaller length found: `length < length_init`
         `False`: not able to find a smaller length such that:
@@ -1890,17 +1872,17 @@
         upper energy cutoff. If set, only modes with energies below
         `emax` are considered. Defaut=None
     eps : float, optional
         minimal difference for length minimization step
 
     Returns
     -------
-    num_cells : int
+    num_absorb_cells : int
         number of cells for a finite lead taken into account
-        `num_cells` is only meaningful if `absorbing_boundary` is `True`
+        `num_absorb_cells` is only meaningful if `absorbing_boundary` is `True`
     num_buffer_cells : int
         number of lead cells added to the start
         of the boundary conditions with no absorbing potential applied.
         `num_buffer_cells` is always meaningful,
         independent of `absorbing_boundary`
     strength : float
         The strength of the boundary conditions. Formally
@@ -1938,16 +1920,24 @@
         slow_mode = _slow_mode(spectrum, emin, emax)
     except Exception as error:
         # TODO: the case with emin/emax, where the highest velocity
         # resp. curvature do not follow analytically from the spectrum
         # is not yet handled properly.
         logger.warning('problem to analyse spectrum for boundary conditions: '
                        '{0}'.format(error))
+        try:
+            fast_mode = _fast_mode(spectrum, emin=None, emax=None)
+        except Exception as error:
+            raise RuntimeError('{0}, not possible to obtain boundary conditions'
+                               ' automatically, provide boundaries by hand.'
+                               .format(error))
+        _, vmax, _ = fast_mode
+        num_buffer_cells = ceil(vmax * tmax / 2)
         logger.info('switch to simple boundary conditions fallback')
-        return 0, 0., 0, False
+        return 0, 0., num_buffer_cells, False
 
     _, vmax, _ = fast_mode
 
     assert vmax >= 0
     assert tmax >= 0
     assert eps >= 0
 
@@ -1962,23 +1952,23 @@
                      format(length_new, strength, success))
         if success and length_new <= length - eps:
             length = length_new
         else:
             break
 
     xsplit = _optimal_split(degree) if length < len_max else 1
-    num_cells = ceil(length * (1 - xsplit))
+    num_absorb_cells = ceil(length * (1 - xsplit))
     num_buffer_cells = ceil(length * xsplit)
 
-    assert num_cells >= 0
+    assert num_absorb_cells >= 0
     assert num_buffer_cells >= 0
 
-    absorbing_boundary = length < len_max and num_cells > 0
+    absorbing_boundary = length < len_max and num_absorb_cells > 0
 
-    return num_cells, strength, num_buffer_cells, absorbing_boundary
+    return num_absorb_cells, strength, num_buffer_cells, absorbing_boundary
 
 
 @log_func
 def automatic_boundary(leads, tmax, refl_max=1E-6, degree=6, emin=None,
                        emax=None, params=None):
     """
     Routine to find automatically a boundary condition such that the
@@ -1992,15 +1982,15 @@
     tmax : int or float
         Maximal time for a tkwant simulation to run. Must be positive > 0.
     refl_max : float, optional
         maximal allowed reflection amplitude :math:`r`, must be in (0, 1)
         interval. Default=1E-7
     degree : int, optional
         order of the monominal absorbing boundary potential.
-        Must be positive > 0. Default=4.
+        Must be positive > 0.
     emin : float, optional
         lower energy cutoff. If set, only modes with energies above
         `emin` are considered. Defaut=None
     emax : float, optional
         upper energy cutoff. If set, only modes with energies below
         `emax` are considered. Defaut=None
     params : dict, optional
@@ -2029,26 +2019,26 @@
         if isinstance(lead, kwant.system.InfiniteSystem):
             logger.info('calculate lead spectrum for lead={}'.format(i))
             spectrum = kwantspectrum.spectrum(lead, params=params)
         else:  # assume that lead behaves like a spectrum
             spectrum = lead
 
         logger.info('estimate absorbing boundary parameters for lead={}'.format(i))
-        num_cells, strength, num_buffer_cells, absorbing_boundary = \
+        num_absorb_cells, strength, num_buffer_cells, absorbing_boundary = \
             _monomial_parameter_estimate(spectrum, tmax, refl_max, degree,
                                          emin, emax)
 
         if absorbing_boundary:
-            logger.info('use absorbing boundary for lead={}: num_cells = {}, '
+            logger.info('use absorbing boundary for lead={}: num_absorb_cells = {}, '
                         'strength = {}, num_buffer_cells = {}'
-                        .format(i, num_cells, strength, num_buffer_cells))
-            return MonomialAbsorbingBoundary(num_cells, strength, degree,
-                                             num_buffer_cells)
+                        .format(i, num_absorb_cells, strength, num_buffer_cells))
+            return MonomialAbsorbingBoundary(num_absorb_cells, strength, degree,
+                                             num_buffer_cells, tmax)
         logger.info('use simple boundary for lead={}'.format(i))
-        return SimpleBoundary(tmax=tmax)
+        return SimpleBoundary(num_buffer_cells, tmax)
 
     logger.info('estimate optimal boundary conditions with parameters: '
                 'tmax = {}, refl_max = {}, degree={}, emin={}, emax={}, '
                 'params={}'.format(tmax, refl_max, degree, emin, emax, params))
 
     # type and consistency checks
     assert _common.is_type(tmax, 'real_number')
```

### Comparing `tkwant-1.0.1/tkwant/line_segment.py` & `tkwant-1.1.0rc2/tkwant/line_segment.py`

 * *Files identical despite different names*

### Comparing `tkwant-1.0.1/tkwant/manybody.py` & `tkwant-1.1.0rc2/tkwant/manybody.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,37 +1,40 @@
 # -*- coding: utf-8 -*-
-# Copyright 2016-2020 tkwant authors.
+# Copyright 2016-2023 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Tools for calculating time-dependent, manybody quantities."""
 
 import collections.abc
 import functools as ft
 import itertools
 import copy
 import numpy as np
 
 import kwant
 import kwantspectrum
 
 
-from . import onebody, leads, integration, mpi, _common, _logging
-from .system import add_time_to_params
+from . import onebody, leads, integration, mpi, _common, _logging, greenfunctions
+from .system import add_time_to_params, ExtendedSystem
 
 
 __all__ = ['Occupation', 'Interval', 'lead_occupation',
            'calc_intervals', 'split_intervals', 'combine_intervals',
            'calc_tasks', 'calc_initial_state', 'calc_energy_cutoffs',
            'WaveFunction', 'State', 'make_boundstates_time_dependent',
-           'add_boundstates', 'ManybodyIntegrand']
+           'add_boundstates', 'boundstates_present', 'ManybodyIntegrand']
 
+__all__.append(greenfunctions.__all__)
+GreenFunction = greenfunctions.GreenFunction
 
 # set module logger
 logger = _logging.make_logger(name=__name__)
 log_func = _logging.log_func(logger)
 
 # TODO: reintroduce dataclasses at some point when python 3.7 is stable
 
@@ -43,24 +46,27 @@
     ----------
     distribution : callable
         distribution function
     energy_range : sequence, optional
         Energy cutoffs.
     bands : sequence, optional
         Selected bands.
+    multivariate` : bool, optional
+        multivariate distribution function
     """
-    def __init__(self, distribution, energy_range=None, bands=None):
+    def __init__(self, distribution, energy_range=None, bands=None, multivariate=False):
         self.distribution = distribution
         self.energy_range = energy_range
         self.bands = bands
+        self.multivariate = multivariate
 
     def __str__(self):
         string = "lead occupation: " \
                  "distribution={distribution}, energy_range={energy_range} , " \
-                 "bands={bands}".format(**self.__dict__)
+                 "bands={bands}, multivariate={multivariate}".format(**self.__dict__)
         return string
 
 
 class Interval:
     """Data format for a quadrature interval, see `tkwant.manybody.calc_intervals`.
 
     Attributes
@@ -122,166 +128,130 @@
     assert _common.is_type(epsilon, 'real_number')
     assert temperature > 0
     assert 0 < epsilon < 1
     return temperature * np.log((1 - epsilon) / epsilon)
 
 
 @log_func
-def lead_occupation(chemical_potential=0, temperature=0, energy_range=None,
-                    bands=None, distribution=None, occupation_type=Occupation):
+def lead_occupation(chemical_potential=0, temperature=0, bands=None,
+                    occupation_type=Occupation):
     r"""Set the occupation (:math:`T, \mu, f(E)`) for one lead.
 
-    The main purpose of this routine is to obtain upper energy cutoffs, in order
-    to calculate integrals of the form :math:`I = \int d E \, f(E) \ldots`.
-    Energy cutoffs are estimated from the distribution function *f(E)* only,
-    without knowledge of the band structure. Three cases can be distinguished:
+    Routine to obtain the fermi function f(E) and the upper energy cutoff for a
+    single lead, in order to calculate integrals of the form
+    :math:`I = \int d E \, f(E) \ldots`.
+    Energy cutoffs are estimated from the temperature and the chemical potential
+    only, without knowledge of the band structure.
 
     * Fermi dirac distribution :math:`f(E) = (1 + \exp((E - \mu)/T))^{-1}`
 
         For *T = 0*: :math:`f(E) = \theta(\mu - E)` the chemical
         potential (Fermi energy) is a sharp upper cutoff,
         :math:`I = \int_{-\infty}^\mu d E \, \ldots`.
 
         For *T > 0* we estimate an effective upper cutoff *Eeff*, such that
         :math:`f(E) \leq \varepsilon` for :math:`E \geq Eeff`,
         :math:`I = \int_{-\infty}^{Eeff} d E \, f(E) \ldots`.
 
-    * Arbitrary distribution function:
-        No cutoff is estimated,
-        :math:`I = \int_{-\infty}^{\infty} d E \, f(E) \ldots`.
-
-    It is possible to overwrite all cutoffs by user given values,
-    except the upper energy cutoff `emax` at *T = 0*, which is
-    always set to min(:math:`\mu`, `emax`).
-
     Parameters
     ----------
-    chemical_potential : float, optional
+    chemical_potential : float or sequence of floats, optional
         chemical potential :math:`\mu`, zero by default
+        If a sequence, it must have the same number of elements as bands per
+        lead and acts as a cutoff per band.
+        Setting ``chemical_potential`` to None is equivalent to + infinity.
     temperature : float, optional
         temperature :math:`T`, default: zero temperature
-    energy_range : sequence, optional
-        Sequence of energy intervals, to overwrite the upper and lower cutoff
-        chosen by the routine. Each interval has the form `(emin, emax)`, with
-        `emin` and `emax` being real numbers or None.
-        It is required that ``emin`` :math:`\leq` ``emax`` in each interval, but
-        the intervals are not required to be sorted in the sequence.
-        Moreover, no check is performed if the intervals overlap.
-        Setting ``emin`` and/or ``emax`` to `None`, means the absence of a
-        lower (respect. upper) energy bound. ``energy_range = None`` is
-        interpreted as ``energy_range = [(None, None)]``, meaning no
-        energy bounds, which is the default behavior.
     bands : int or list of int, optional
         If present, only bands with band indices (*n*) present in the list
-        are taken into account. (`emin` and `emax` still limit the energy range
-        of these bands.). By default, all bands are considered.
-    distribution : callable, optional
-        Distribution function *f(E)*, over which the thermal average is taken.
-        Calling signature must be `(chemical_potential, temperature, energy)`.
-        Default: non-interacting Fermi dirac distribution.
+        are taken into account. By default, all bands are considered.
     occupation_type : `~dataclasses.dataclass`, optional
         Data format of the returnded ``occupation`` object
         to store the lead occupation. Default: `tkwant.manybody.Occupation`.
 
     Returns
     -------
-    occupation : ``occupation_type`` or `None`
+    occupation : ``occupation_type``
         Lead occupation.
         Attributes of ``occupation`` that are modified by this routine:
 
             - `distribution` : callable, distribution function *f(E)*,
               calling signature `(energy)`
             - `energy_range` : sequence, energy cutoffs
             - `bands` : list of int, bands to be considered
-
-        If the lead is found to be not occupied (e.g.\ by setting ``emin`` >
-        ``chemical_potential`` at zero temperature),  the routine returns None.
+            - `multivariate` : bool, multivariate distribution function
     """
-    def _fermi_dirac_distribution(energy):
+    def fermi_dirac_distribution(energy, mu):
         """Fermi diract distribution function"""
-        return 1. / (1 + np.exp((energy - chemical_potential) / temperature))
+        if mu is None:
+            return 1. / (1 + np.exp(energy / temperature))
+        return 1. / (1 + np.exp((energy - mu) / temperature))
 
-    def _zero_temperature_fermi_dirac_distribution(energy):
+    def zero_temperature_fermi_dirac_distribution(energy, mu):
         """Fermi diract distribution function"""
-        return np.where(energy <= chemical_potential, 1, 0)
-
-    def _check_energies(emin, emax):
-        if emin is not None and not _common.is_type(emin, 'real_number'):
-            raise TypeError('emin={} in energy_range not a real number.'
-                            .format(emin))
-        if emax is not None and not _common.is_type(emax, 'real_number'):
-            raise TypeError('emax={} in energy_range not a real number.'
-                            .format(emax))
-        if emin is not None and emax is not None:
-            if emax < emin:
-                raise ValueError('emin={} > emax={}'.format(emin, emax))
-
-    if not _common.is_type(chemical_potential, 'real_number'):
-        raise TypeError('chemical potential must be a real number.')
+        if mu is None:
+            return 1
+        return np.where(energy <= mu, 1, 0)
+
+    multivariate = False
+    if not isinstance(chemical_potential, collections.abc.Iterable):
+        if not (_common.is_type(chemical_potential, 'real_number') or (chemical_potential is None)):
+            raise TypeError('chemical potential must be a real number or "None".')
+    else:
+        multivariate = True
+        for mu in chemical_potential:
+            if not (_common.is_type(mu, 'real_number') or (chemical_potential is None)):
+                raise TypeError('chemical potential must be a sequence of real numbers or "None".')
 
     if not _common.is_type(temperature, 'real_number'):
         raise TypeError('temperature must be a real number.')
 
     if temperature < 0:
         raise ValueError('temperature={} is negative.'.format(temperature))
 
-    if distribution is None:  # use fermi dirac distribution
-        if np.isclose(temperature, 0):
-            logger.info('distribution function: zero-temperature fermi-dirac')
-            distribution = _zero_temperature_fermi_dirac_distribution
-            # chemical potential is upper energy cutoff for zero-temp. fermi dirac
-            if energy_range is not None:
-                _energy_range = []
-                for (emin, emax) in energy_range:
-                    _check_energies(emin, emax)
-                    if emax is None:
-                        emax = chemical_potential
-                    else:
-                        emax = min(chemical_potential, emax)
-                    if emin is None or (emin is not None and emin < emax):
-                        _energy_range.append((emin, emax))
-            else:
-                _energy_range = [(None, chemical_potential)]
+    if np.isclose(temperature, 0):
+        logger.info('distribution function: zero-temperature fermi-dirac')
+        # chemical potential is upper energy cutoff for zero-temp. fermi dirac
+        if not multivariate:
+            distribution = ft.partial(zero_temperature_fermi_dirac_distribution, mu=chemical_potential)
+            energy_range = [(None, chemical_potential)]
         else:
-            logger.info('distribution function: finite-temperature fermi-dirac')
-            distribution = _fermi_dirac_distribution
-            effective_emax = chemical_potential + _fermi_function_below_epsilon(temperature)
-            # give the possibility to overwrite calculated energy cutoff
-            if energy_range is not None:
-                _energy_range = []
-                for i, (emin, emax) in enumerate(energy_range):
-                    _check_energies(emin, emax)
-                    if emax is None:
-                        emax = effective_emax
-                    if emin is None or (emin is not None and emin < emax):
-                        _energy_range.append((emin, emax))
-            else:
-                _energy_range = [(None, effective_emax)]
+            distribution = [ft.partial(zero_temperature_fermi_dirac_distribution, mu=mu) for mu in chemical_potential]
+            energy_range = [[(None, mu)] for mu in chemical_potential]
     else:
-        logger.info('distribution function: provided by user')
-        # no upper energy cutoff for arbitrary distribution
-        distribution = ft.partial(distribution, chemical_potential, temperature)
-        if energy_range is None:
-            _energy_range = [(None, None)]
+        logger.info('distribution function: finite-temperature fermi-dirac')
+        edt = _fermi_function_below_epsilon(temperature)
+        if not multivariate:
+            distribution = ft.partial(fermi_dirac_distribution, mu=chemical_potential)
+            if chemical_potential is None:
+                energy_range = [(None, None)]
+            else:
+                effective_emax = chemical_potential + edt
+                energy_range = [(None, effective_emax)]
         else:
-            _energy_range = copy.deepcopy(energy_range)
+            distribution = [ft.partial(fermi_dirac_distribution, mu=mu) for mu in chemical_potential]
+            energy_range = []
+            for mu in chemical_potential:
+                if my is None:
+                    energy_range.append([(None, None)])
+                else:
+                    energy_range.append([(None, mu + edt)])
 
     _bands = copy.deepcopy(bands)
     if _bands is not None:
         try:
             _bands = sorted(set(list(_bands)))
         except TypeError:  # if bands is just a single integer
             _bands = [_bands]
-    if _energy_range:
-        return occupation_type(distribution, _energy_range, _bands)
+    return occupation_type(distribution, energy_range, _bands, multivariate)
 
 
 # selection of the energy/momentum integration region
 
-def _calc_momentum_intervals(spectrum, emin=None, emax=None, bands=None):
+def _calc_momentum_intervals(spectrum, emin=None, emax=None, bands=None, tol=1e-5):
     r"""Get the momentum intervals for one lead.
 
     Parameters
     ----------
     spectrum : `~kwantspectrum.spectrum`
         Energy dispersion :math:`E_n(k)` of one lead.
     emin : int or float, optional
@@ -293,14 +263,16 @@
         If present, select intervals such that :math:`E_n(k) \leq` `emax`.
         Default: no upper energy cutoff, only `chemical_potential`
         will serve as a cutoff for the default fermi dirac distribution.
     bands : list of int, optional
         If present, only bands with band indices (*n*) present in the list
         are taken into account. (`emin` and `emax` still limit the energy range
         of these bands.)
+    tol : intervals below width k < tol might be dropped, optional
+
 
     Returns
     -------
     intervals : list
         List of all momentum intervals in the form `(band, (kmin, kmax))`
         where `band` is the band index (*n*), and `kmin` respectively `kmax` are
         the minimum, respectively maximum values of the momentum (*k*) interval.
@@ -308,29 +280,29 @@
         a priori.
     """
 
     def positive_velocity_intervals(band):
         """Momentum intervals with emin < energy < emax and positive velocity"""
         intervals_valid_energy = spectrum.intervals(band, lower=emin, upper=emax)
         intervals_positve_velocity = spectrum.intervals(band, lower=0,
-                                                        derivative_order=1)
+                                                        derivative_order=1, tol=tol)
         return kwantspectrum.intersect_intervals(
             intervals_valid_energy, intervals_positve_velocity)
 
     if bands is None:
         bands = range(spectrum.nbands)
     assert _common.is_type_array(bands, 'integer').all()
 
     return [(band, interval) for band in bands
             for interval in positive_velocity_intervals(band)
             if _common.is_not_empty(interval)]
 
 
 @log_func
-def calc_intervals(spectra, occupations, interval_type=Interval):
+def calc_intervals(spectra, occupations, interval_type=Interval, tol=1e-5):
     r"""Return a list of momentum intervals to perform the manybody integration.
 
     Parameters
     ----------
     spectra : `kwantspectrum.spectrum` or sequence thereof
         Energy dispersion :math:`E_n(k)` of one lead or sequence thereof
         in case of several leads.
@@ -351,14 +323,15 @@
               all bands considered if `None`
 
         If a lead is not occupied, the corresponding element of ``occupations``
         must be `None` or `False`.
     interval_type : `~dataclasses.dataclass`, optional
         Data format to store an interval in the returned ``intervals`` list.
         Default: `tkwant.manybody.Interval`
+    tol : intervals below width k < tol might be dropped, optional
 
     Returns
     -------
     intervals :  list of ``interval_type``
         All momentum intervals to perform the statistical average.
         Attributes of each ``intervals`` element that are modified by this routine:
 
@@ -372,22 +345,30 @@
         """Intervals and quadrature rule for a single lead."""
         bands = occupation.bands
         if occupation.energy_range is None:
             emin = None
             emax = None
             lead_intervals = [interval_type(lead, band, kmin, kmax)
                               for band, (kmin, kmax) in
-                              _calc_momentum_intervals(spectrum, emin, emax, bands)]
+                              _calc_momentum_intervals(spectrum, emin, emax, bands, tol)]
         else:
             lead_intervals = []
-            for (emin, emax) in occupation.energy_range:
-                lead_intervals += [interval_type(lead, band, kmin, kmax)
-                                   for band, (kmin, kmax) in
-                                   _calc_momentum_intervals(spectrum,
-                                                            emin, emax, bands)]
+            if occupation.multivariate:  # energy range given for each band
+                if len(occupation.energy_range) != spectrum.nbands:
+                    raise ValueError('Multivariate occupation does not match nb of bands.')
+                for band, energy_range in enumerate(occupation.energy_range):
+                    for emin, emax in energy_range:
+                        for _, (kmin, kmax) in _calc_momentum_intervals(spectrum, emin, emax, [band], tol):
+                            lead_intervals.append(interval_type(lead, band, kmin, kmax))
+            else:  # energy range given for all band
+                for (emin, emax) in occupation.energy_range:
+                    lead_intervals += [interval_type(lead, band, kmin, kmax)
+                                       for band, (kmin, kmax) in
+                                       _calc_momentum_intervals(spectrum,
+                                                                emin, emax, bands, tol)]
         return lead_intervals
 
     if not isinstance(spectra, collections.abc.Iterable):
         spectra = [spectra]
     if not isinstance(occupations, collections.abc.Iterable):
         occupations = [occupations]
 
@@ -842,44 +823,54 @@
                                                              interval.kmax)
                           for energy in energies])
         jacobian = 1
         momenta = [None] * len(energies)
     else:
         raise NotImplementedError('integration_variable= {} not implemented'.
                                   format(interval.integration_variable))
+
+    if isinstance(distribution, collections.abc.Iterable):
+        logger.debug('found multivariate distribution function')
+        if len(distribution) != spectrum.nbands:
+            raise ValueError('Multivariate distribution does not match nb of bands.')
+        dist_func = distribution[interval.band]
+    else:
+        dist_func = distribution
+
     try:
-        phys_weights = jacobian * distribution(energies) / (2 * np.pi)
+        phys_weights = jacobian * dist_func(energies) / (2 * np.pi)
     except TypeError:
-        distribution_ = np.array([distribution(energy) for energy in energies])
+        distribution_ = np.array([dist_func(energy) for energy in energies])
         phys_weights = jacobian * distribution_ / (2 * np.pi)
 
     weights = math_weights * phys_weights
     assert _common.is_type_array(modes, 'integer').all()
     assert _common.is_type_array(energies, 'real_number').all()
     assert _common.is_type_array(weights, 'real_number').all()
     assert _common.is_type_array(math_weights, 'real_number').all()
     assert _common.is_type_array(phys_weights, 'real_number').all()
     return modes, energies, momenta, weights.T, math_weights.T, phys_weights
 
 
 # manybody solvers
 
 @log_func
-def calc_initial_state(syst, tasks, boundaries, params=None,
+def calc_initial_state(syst, tasks, boundaries=None, params=None,
                        scattering_state_type=onebody.ScatteringStates,
                        mpi_distribute=mpi.round_robin, comm=None):
     """Calculate the initial manybody scattering wave function using MPI.
 
     Parameters
     ----------
-    syst : `kwant.builder.FiniteSystem`
+    syst : `kwant.builder.FiniteSystem` or `tkwant.system.ExtendedSystem`
         The low level system for which the wave functions are to be
         calculated.
-    boundaries : sequence of `~tkwant.leads.BoundaryBase`
+    boundaries : sequence of `~tkwant.leads.BoundaryBase`, optional
         The boundary conditions for each lead attached to ``syst``.
+        Must be only provided if ``syst`` is a `kwant.builder.FiniteSystem`.
     tasks : sequence of `tkwant.onebody.Task`
         Each element in the sequence represents a one-body state
         that composes the manybody state.
         An element of ``tasks`` must have at least the following three attributes:
 
             - `lead` : int, lead index
             - `mode` : int, scattering mode index
@@ -905,22 +896,37 @@
         corresponds to an element in the ``tasks`` list.
         The list index of ``tasks`` serves as dict key.
     """
     def scattering_state(energy, lead):
         """Calculate a one-body scattering state that can be evolved in time"""
         logger.debug('calc scattering state: energy={}, lead={}'.format(energy, lead))
         try:
-            return scattering_state_type(syst, energy, lead, params=params,
-                                         boundaries=boundaries)
+            return scattering_state_type(extended_syst, energy, lead, params=params)
         except Exception:
             raise RuntimeError('scattering state calculation failed for '
                                'energy={}, lead={}'.format(energy, lead))
 
-    if not isinstance(syst, kwant.system.System):
-        raise TypeError('"syst" must be a finalized kwant system')
+    if isinstance(syst, kwant.system.System):
+        time_name, time_start, onebody_wavefunction_type = \
+            onebody._get_time_name_from_wavefunction(derived_type=scattering_state_type)
+
+        tparams = add_time_to_params(params, time_name=time_name,
+                                     time=time_start, check_numeric_type=True)
+
+        solver_type = _common.get_default_function_argument(onebody_wavefunction_type,
+                                                            'solver_type')
+
+        extended_syst = onebody.make_extended_system(syst, solver_type, boundaries, tparams)
+
+    elif isinstance(syst, ExtendedSystem):
+        extended_syst = syst
+    else:
+        raise TypeError('"syst" must be a finalized kwant system '
+                        'or a "tkwant.system.ExtendedSystem"')
+
     comm = mpi.get_communicator(comm)
     tasks_per_rank = mpi.distribute_dict(tasks, mpi_distribute, comm)
     return {key: scattering_state(task.energy, task.lead)[task.mode]
             for key, task in tasks_per_rank.items()}
 
 
 class WaveFunction:
@@ -996,28 +1002,38 @@
         Notes
         -----
         Returning the result on all MPI ranks (by setting ``root=None``),
         might be slower, as an additional broadcast step is needed.
         """
         return self._calc_expectation_value(observable, root=root)
 
-    def get_onebody_state(self, key):
+    def get_onebody_state(self, key, root=0):
         """ Get the onebody wavefunction corresponding to its key.
 
         Parameters
         ----------
         key : dict key
             Idendentifier key of the state.
+        root : int or None, optional
+            MPI return rank on which to return the state. If ``root`` is an
+            integer, it must be in the range of valid MPI ranks
+            ``0 <= root < self.comm.size``.
+            In that case, the state is returned
+            only on that specific MPI rank where ``rank == root``, whereas the
+            result is `None` on all other MPI ranks with ``rank != root``.
+            Alternatively, if ``root`` is `None`,
+            the calculated state is returned on all MPI ranks.
+            By default, the state is returned on MPI rank zero only.
 
         Returns
         -------
         state : `tkwant.onebody.WaveFunction`
             onebody wavefunction
         """
-        return self.psi.data(key)
+        return self.psi.data(key, to_rank=root)
 
     def add_onebody_state(self, state, task, key=None, rank=None):
         """Add a onebody wavefunction to the manybody state.
 
         Parameters
         ----------
         state : `tkwant.onebody.WaveFunction`
@@ -1117,14 +1133,21 @@
         shape : tuple
             Shape of the weight factor array.
         """
         key = self.get_keys()[0]
         weight = self.tasks[key].weight
         return weight.shape
 
+    def add_perturbation(self, qt):
+        """
+        set perturbation
+        """
+        for onebody_psi in self.psi.local_data().values():
+            onebody_psi.add_perturbation(qt)
+
     def _check_consistency(self):
         """Check if keys for the wave functions consistent in itself and with the tasks.
 
         Returns
         -------
         consistent : bool
             Returns `True` if all keys are unique and if the keys in task list
@@ -1265,17 +1288,23 @@
     lower_energy_cutoff_lead = []
     upper_energy_cutoff_lead = []
 
     if not isinstance(occupations, collections.abc.Iterable):
         occupations = [occupations]
     for occup in occupations:  # loop over all occupied leads
         if occup is not None:
-            lower, upper = _find_min_max_range(occup.energy_range)
-            lower_energy_cutoff_lead.append(lower)
-            upper_energy_cutoff_lead.append(upper)
+            if occup.multivariate:  # energy range given for each band
+                for energy_range in occup.energy_range:
+                    lower, upper = _find_min_max_range(energy_range)
+                    lower_energy_cutoff_lead.append(lower)
+                    upper_energy_cutoff_lead.append(upper)
+            else:  # global energy range given for all bands
+                lower, upper = _find_min_max_range(occup.energy_range)
+                lower_energy_cutoff_lead.append(lower)
+                upper_energy_cutoff_lead.append(upper)
 
     # only occupied leads contribute to the cutoff
     if None in lower_energy_cutoff_lead or not lower_energy_cutoff_lead:
         lower = None
     else:
         lower = min(lower_energy_cutoff_lead)
     if None in upper_energy_cutoff_lead or not upper_energy_cutoff_lead:
@@ -1293,15 +1322,15 @@
                  refine=True, combine=False, error_op=None,
                  scattering_state_type=onebody.ScatteringStates,
                  manybody_wavefunction_type=WaveFunction,
                  mpi_distribute=mpi.round_robin, comm=None):
         r"""
         Parameters
         ----------
-        syst : `kwant.builder.FiniteSystem`
+        syst : `kwant.builder.FiniteSystem` or `tkwant.system.ExtendedSystem`
             The low level system for which the wave functions are to be
             calculated.
         tmax : float, optional
             The maximum time up to which to simulate. Sets the boundary
             conditions such that they are accurate up to ``tmax``.
             Must be set if ``boundaries`` are not provided.
             Mutually exclusive with `boundaries`.
@@ -1397,36 +1426,32 @@
         of the evolution (`time_start`) are taken from the default
         values of the `scattering_state_type.__init__` method. Changing the
         default values by partial prebind (e.g. via functools) is possible.
         """
 
         logger.info('initialize manybody.State')
 
-        if not isinstance(syst, kwant.system.System):
-            raise TypeError('"syst" must be a finalized kwant system')
-        if tmax is None and boundaries is None:
-            raise ValueError("'boundaries' or 'tmax' must be provided ")
+        if isinstance(syst, kwant.system.System):
+            extended_syst = None
+            if tmax is None and boundaries is None:
+                raise ValueError("'boundaries' or 'tmax' must be provided")
+        elif isinstance(syst, ExtendedSystem):
+            if boundaries is not None:
+                logger.warning('boundaries will not be used for extended system')
+            extended_syst = syst
+            syst = extended_syst.syst
+        else:
+            raise TypeError('"syst" must be a finalized kwant system '
+                            'or a "tkwant.system.ExtendedSystem"')
         if tmax is not None and boundaries is not None:
             raise ValueError("'boundaries' and 'tmax' are mutually exclusive.")
 
         # get initial time and time argument name from the onebody wavefunction
-        try:
-            default_arg = _common.get_default_function_argument
-            onebody_wavefunction_type = default_arg(scattering_state_type,
-                                                    'wavefunction_type')
-            time_name = default_arg(onebody_wavefunction_type, 'time_name')
-            time_start = default_arg(onebody_wavefunction_type, 'time_start')
-        except Exception:
-            time_name = _common.time_name
-            time_start = _common.time_start
-            onebody_wavefunction_type = None
-            logger.warning('retrieving initial time and time argument name from',
-                           'the onebody wavefunction failed, use default values: ',
-                           '"time_name"={}, "time_start"={}'.format(time_name,
-                                                                    time_start))
+        time_name, time_start, onebody_wavefunction_type = \
+            onebody._get_time_name_from_wavefunction(derived_type=scattering_state_type)
 
         # add initial time to the params dict
         tparams = add_time_to_params(params, time_name=time_name,
                                      time=time_start, check_numeric_type=True)
 
         if spectra is None:
             spectra = kwantspectrum.spectra(syst.leads, params=tparams)
@@ -1455,36 +1480,47 @@
         if len_int == 0:
             logger.warning('no occupied states found, the chemical potential '
                            'is probably wrong.')
         else:
             logger.info('initial number of intervals={}'.format(len_int))
         for interval in intervals:
             logger.debug(interval)
-        if boundaries is None:
-            emin, emax = calc_energy_cutoffs(occupations)
-            boundaries = leads.automatic_boundary(spectra, tmax,
-                                                  emin=emin, emax=emax)
+
+        if extended_syst is None:
+            if boundaries is None:
+                emin, emax = calc_energy_cutoffs(occupations)
+                boundaries = leads.automatic_boundary(spectra, tmax,
+                                                      emin=emin, emax=emax)
+            solver_type = _common.get_default_function_argument(onebody_wavefunction_type,
+                                                                'solver_type')
+            extended_syst = onebody.make_extended_system(syst, solver_type,
+                                                         boundaries, tparams)
 
         self.time = time_start
-        self.syst = syst
+        self.extended_syst = extended_syst
         self.spectra = spectra
-        self.boundaries = boundaries
         self.occupations = occupations
         self.mpi_distribute = mpi_distribute
         self.onebody_wavefunction_type = onebody_wavefunction_type
         self.scattering_state_type = scattering_state_type
 
         # no public params attribute exists for the manybody state.
         # each individual one-body state holds its own parameters
         # the private params should be only used to create new inital
         # onebody states.
         self._params = params
 
         self._tasks_from_interval = {}
-        tasks = self._calc_tasks(intervals)
+        tasks = {}
+        offset = 0
+        for interval in intervals:
+            tasks_ = self._calc_tasks(interval, offset)
+            if tasks_:
+                offset += len(tasks_)
+                tasks.update(tasks_)
 
         self.comm = mpi.get_communicator(comm)
 
         psi_init = self._calc_initial_state(tasks, self.comm)
 
         self.manybody_wavefunction = manybody_wavefunction_type(psi_init,
                                                                 tasks, self.comm)
@@ -1519,26 +1555,20 @@
 
         Returns
         -------
         tasks : dict
             Dict with all tasks (states) for the interval.
             Dict keys are incremented by one starting at `offset`.
         """
-        if not isinstance(interval, list):
-            interval = [interval]
-        tasks = {}
-        for _interval in interval:
-            _tasks = calc_tasks(_interval, self.spectra, self.occupations,
-                                keys=itertools.count(offset), tol=tol)
-            if _tasks:
-                self._tasks_from_interval.update({_interval: _tasks})
-                tasks.update(_tasks)
-                offset += len(_tasks)
-        if len(tasks) == 0:
-            logger.warning('tasks dict has length zero')
+        tasks = calc_tasks(interval, self.spectra, self.occupations,
+                            keys=itertools.count(offset), tol=tol)
+        if tasks:
+            self._tasks_from_interval[interval] = tasks
+        else:
+            logger.warning('no tasks for given interval={}'.format(interval))
         return tasks
 
     def _calc_initial_state(self, tasks, comm):
         """Calculate the initial manybody state for all tasks.
 
         Parameters
         ----------
@@ -1549,16 +1579,17 @@
 
         Returns
         -------
         psi_init : dict
             Ensemble of all one-body scattering states that form the
             initial manybody state.
         """
-        return calc_initial_state(self.syst, tasks, self.boundaries,
-                                  self._params, self.scattering_state_type,
+        return calc_initial_state(self.extended_syst, tasks,
+                                  params=self._params,
+                                  scattering_state_type=self.scattering_state_type,
                                   mpi_distribute=self.mpi_distribute, comm=comm)
 
     def _get_keys_from_interval(self, interval):
         """Return a list of all keys corresponding to an interval.
 
         Parameters
         ----------
@@ -1569,26 +1600,31 @@
         -------
         keys : list
             List of all keys representing the states of the interval
         """
         tasks = self._tasks_from_interval[interval]
         return list(tasks.keys())
 
-    def _add_interval(self, interval, tol=1E-10):
+    def _add_interval(self, interval, tasks=None, tol=1E-10):
         """Add all one-body states and tasks corresponding to an interval.
 
         Parameters
         ----------
         interval : `tkwant.manybody.Interval`
             Integration interval that should be added to the solver
+        tasks : dict, optional
+            Dict with all tasks corresponding to the interval.
         tol : float, optional
             Numerical tolerance to remove tasks.
         """
-        next_free_key = self.manybody_wavefunction.get_free_key()
-        tasks = self._calc_tasks(interval, offset=next_free_key, tol=tol)
+        if tasks is None:
+            next_free_key = self.manybody_wavefunction.get_free_key()
+            tasks = self._calc_tasks(interval, offset=next_free_key, tol=tol)
+        else:
+            self._tasks_from_interval[interval] = tasks
         psi_init = self._calc_initial_state(tasks, comm=self.comm)
         self.manybody_wavefunction.add_distributed_onebody_states(psi_init, tasks)
 
     def _remove_interval(self, interval):
         """Remove all one-body states and tasks corresponding to an interval.
 
         Parameters
@@ -1625,26 +1661,26 @@
             it true.
         """
         keys = self._get_keys_from_interval(interval)
         return self.manybody_wavefunction._calc_expectation_value(operator,
                                                                   keys=keys, root=root,
                                                                   return_integrand=return_integrand)
 
-    def _calc_integrand(self, interval, operator, root=None):
-        """Return the integrand and the corresponding abscissa values.
+    def calc_integrand(self, operator, interval, root=0):
+        """Return the integrand and the corresponding abscissa values on an interval.
 
-        This routine is only for debugging purpose.
+        This routine is mainly for debugging purpose.
 
         Parameters
         ----------
+        operator : callable or `kwant.operator`
+            Observable to be calculated
         interval : `tkwant.manybody.Interval`
             Interval over which the manybody sum should be calculated.
             Must be present in the solver.
-        operator : callable or `kwant.operator`
-            Observable to be calculated
         root : int or None, optional
             root receive the result, other rank receive None.
             If root is None all ranks receive the result.
 
         Returns
         -------
         abscissa : `~numpy.ndarray`
@@ -1656,17 +1692,20 @@
             The expectation value of ``operator`` on all abcissa points.
         """
         self.evolve(time=self.time)  # make sure interval is at current time
         keys = self._get_keys_from_interval(interval)
         tasks = self._tasks_from_interval[interval]
         abscissa = np.array([getattr(tasks[key], interval.integration_variable)
                              for key in keys])
-        _, integrand = self._evaluate_interval(interval, operator, root=root,
-                                               return_integrand=True)
-        integrand = np.array([integrand[key] for key in keys])
+
+        _, integrand_per_rank = self.manybody_wavefunction._calc_expectation_value(operator,
+                                                                                   keys=keys, root=root,
+                                                                                   return_integrand=True)
+        integrand_ = mpi.DistributedDict(integrand_per_rank, self.comm)
+        integrand = np.array([integrand_.data(key) for key in keys])
         return abscissa, integrand
 
     def get_intervals(self):
         """Return a list of all intervals stored in the solver.
 
         Returns
         -------
@@ -1786,15 +1825,16 @@
 
         def observable_with_error(_intervals):
             observable = []
             errors = []
             for interval in _intervals:
                 error, kronrod = self._error_estimate_quadpack(interval,
                                                                error_op,
-                                                               return_estimate=True)
+                                                               return_estimate=True,
+                                                               tol=0.5 * (atol + rtol))
                 observable.append(kronrod)
                 errors.append(error)
             return np.array(observable), np.array(errors)
 
         if intervals is None:
             intervals = self.get_intervals()
         else:
@@ -1828,19 +1868,19 @@
             results = results[error_idx]
             errors = errors[error_idx]
             max_error_per_interval = max_error_per_interval[error_idx]
 
             errmax = errors[0]
             resultmax = results[0]
 
-            logger.info('refinement step={}, max errsum={}, min errbnd={}, '
-                        'nb intervals={}'.
-                        format(i, np.max(errsum), np.min(errbnd), len(intervals)))
-            for inte, err in zip(intervals, errors):
-                logger.debug("{}, max error={}".format(inte, np.max(err)))
+            logger.info('refinement step={}, time={}, max errsum={}, '
+                        'min errbnd={}, total number of intervals={}'.
+                        format(i, self.time, np.max(errsum), np.min(errbnd), len(intervals)))
+            for j, (inte, err) in enumerate(zip(intervals, errors)):
+                logger.debug("interval_num={}, {}, max error={}".format(j, inte, np.max(err)))
 
             if (errsum <= errbnd).all():  # converged
                 logger.info('refinement converged')
                 break
 
             if len(intervals) >= limit:
                 logger.warning('maximum number of intervals reached')
@@ -1868,108 +1908,34 @@
 
             result = result + new_results[0] + new_results[1] - resultmax
             errsum = errsum + new_errors[0] + new_errors[1] - errmax
             i += 1
 
         return np.max(errsum), intervals, errors
 
-    def refine_intervals_local(self, atol=1E-5, rtol=1E-5, limit=200,
-                               error_op=None):
-        r"""Refine intervals until the quadrature error is below tolerance.
-
-        Parameters
-        ----------
-        atol : float, optional
-            Absolute tolarance value.
-        rtol : float, optional
-            Relative tolarance value.
-        limit : integer, optional
-            Maximum number of intervals stored in the solver. A warning is
-            raised and the refinement stops if limit is reached.
-        error_op : callable or `kwant.operator`, optional
-            Observable used for the quadrature error estimate.
-            Must have the calling signature of `kwant.operator`.
-            Default: ``error_op`` from initialization.
-
-
-        Notes
-        -----
-        This routine implements a local adaptive strategy.
-        For each interval stored in the solver, this routine subdivides
-        the interval until each interval fulfills
-        :math:`|I_n - I_{2 n+1}| <= atol + rtol |I_{ges}|`, where
-        :math:`I_n` is the integral estimate over an interval with order *n*.
-        Moreover, :math:`I_{ges} = \sum{I_{2 n +1}}` and the sum runs over
-        all stored intervals. Note that if `error_op` has a site dependent
-        array output, the criterion must be fulfilled at each site
-        individually. One-body states that are not part of an interval
-        are not altered by this method.
-        """
-        assert _common.is_type(atol, 'real_number')
-        if atol < 0:
-            raise ValueError('atol={} is negative.'.format(atol))
-        assert _common.is_type(rtol, 'real_number')
-        if rtol < 0:
-            raise ValueError('rtol={} is negative.'.format(rtol))
-
-        if error_op is None:
-            error_op = self.error_op
-
-        # loop until converged
-        i = 0
-        while True:
-
-            i += 1
-            tol = atol + rtol * np.abs(self.evaluate(error_op, root=None))
-
-            intervals_to_refine = []
-            intervals = self.get_intervals()
-            for interval in intervals:
-
-                error = self._error_estimate_gauss_kronrod(interval, error_op)
-
-                if np.where(error > tol, True, False).any():
-                    logger.info("refine step={}, max error={}, interval={}".
-                                format(i, np.max(error), interval))
-                    intervals_to_refine.append(interval)
-
-            if not intervals_to_refine:  # converged
-                break
-            if len(intervals) >= limit:
-                logger.warning('maximum number of intervals reached')
-                break
-
-            logger.info('refinement step={}, intervals to refine={}, total={}'.
-                        format(i, len(intervals_to_refine), len(intervals)))
-
-            new_intervals = []
-            for interval in intervals_to_refine:
-                self._remove_interval(interval)
-                assert self.manybody_wavefunction._check_consistency()
-                for new_interval in split_intervals([interval], 2):
-                    new_intervals.append(new_interval)
-            self._add_interval(new_intervals)
-            assert self.manybody_wavefunction._check_consistency()
-            self.evolve(time=self.time)
-
-    def _error_estimate_quadpack(self, interval, error_op, return_estimate=False):
+    def _error_estimate_quadpack(self, interval, error_op, return_estimate=False, tol=1e-5):
         r"""Error estimate for an integration quadrature.
 
         Parameters
         ----------
         interval : `tkwant.manybody.Interval`
             Integration interval with momentum boundaries *[a,b]*.
             The attribute `interval.quadrature` attribute must be "kronrod".
         error_op : callable or `kwant.operator`
             Observable used for the quadrature error estimate.
             Must have the calling signature of `kwant.operator`.
-        return_estimate :bool, optional
+        return_estimate : bool, optional
             If true, return also the expectation value calculated with
             ``error_op``. It corresponds to the Kronrod :math:`K_{2n + 1}`
             estimate of the integral.
+        tol : float, optional
+            Value to use instead of the |error_op| value when the
+            later one becomes exactly zero to avoid a divide by zero error.
+            This happens for instance when a site is completely deconnected from
+            the rest and only switched on with time.
 
         Returns
         -------
         error : `~numpy.ndarray` of floats
             The quadrature error :math:`\varepsilon` estimated
             for the expectation value of the error_op.
             The output array has the same shape as evaluating ``error_op``.
@@ -2011,51 +1977,32 @@
                              'Gauss-Kronrod quadrature intervals')
 
         (gauss, kronrod), func = self._evaluate_interval(interval, error_op,
                                                          return_integrand=True)
 
         dk = interval.kmax - interval.kmin
         assert dk > 0
+        assert tol > 0
         kronrod_scaled = kronrod / dk
 
         integral = 0
         for key, f in func.items():
             kronrod_weight = self.manybody_wavefunction.tasks[key].math_weight[1]
             integral += kronrod_weight * np.abs(f - kronrod_scaled)
         ik = self.comm.allreduce(integral)
 
+        ik = np.where(ik > 0, ik, tol)  # ik can become exactly zero
+
         assert (ik > 0).all()
         tmp = 200 * np.abs(gauss - kronrod) / ik
         error = np.squeeze(ik * np.minimum(1, tmp * np.sqrt(tmp)))
         if return_estimate:
             return error, kronrod
         return error
 
-    def _error_estimate_gauss_kronrod(self, interval, error_op):
-        r"""Maximal absolute error for the solver result with `quadrature="kronrod"`
-
-        Parameters
-        ----------
-        intervals : `tkwant.manybody.Interval`
-            Integration interval with momentum boundaries *[a,b]*.
-        error_op : callable or `kwant.error_op`
-            Observable used for the quadrature error estimate.
-            Must have the calling signature of `kwant.error_op`.
-
-        Returns
-        -------
-        error : float
-            error estimate
-            :math:`\delta = |G_n - K_{2 n+1}|`, where :math:`G_n`
-            *n* point Gauss and :math:`K_{2 n+1}` the corresponding
-            *2*n +1* Kronrod estimate.
-        """
-        gauss, kronrod = self._evaluate_interval(interval, error_op)
-        return np.abs(gauss - kronrod)
-
     def estimate_error(self, intervals=None, error_op=None, estimate=None,
                        full_output=False):
         r"""Estimate the numerical error of the integration quadrature.
 
         Parameters
         ----------
         intervals : `tkwant.manybody.Interval` or sequence thereof, optional
@@ -2183,16 +2130,36 @@
         ----------
         time : int or float
             time argument up to which the solver should be evolved
         """
         self.manybody_wavefunction.evolve(time)
         self.time = time
 
-    def add_boundstates(self, boundstate_psi, boundstate_tasks):
-        """Add boundstates to the manybody solver
+    def add_boundstate(self, psi, energy, weight=1):
+        """Add a boundstate to the manybody solver
+
+        Parameters
+        ----------
+        psi : `~numpy.ndarray`
+            Projection of the boundstate wavefunction to the central scattering region
+        energy : float
+            Energy of the boundstate
+        weight : float, optional
+            Weight of the boundstate in the discrete sum. Set to one by default.
+        """
+
+        key = self.manybody_wavefunction.get_free_key()
+        task = {key: onebody.Task(lead=None, mode=None, energy=energy, weight=weight)}
+
+        # make psi available on only one MPI rank
+        psi_bs = mpi.distribute_dict({key: psi}, self.mpi_distribute, self.comm)
+        self._add_boundstates(psi_bs, task)
+
+    def _add_boundstates(self, boundstate_psi, boundstate_tasks):
+        """Add several boundstates to the manybody solver
 
         Parameters
         ----------
         boundstate_psi : dict
             Dictionary with all boundstate wavefunctions.
             If a wavefunction is of type `tkwant.onebody.WaveFunction`
             and has an `evolve()` method, it is not changed.
@@ -2215,24 +2182,24 @@
         """
         # if onebody_wavefunction_type cannot be extracted from
         # scattering_state_type, this routine fails, do at least some warning
         if self.onebody_wavefunction_type is None:
             logger.warning("wavefunction type is None, ",
                            "provided boundstates must be time dependent")
         make_boundstates_time_dependent(boundstate_psi, boundstate_tasks,
-                                        self.syst, self.boundaries,
-                                        self._params,
-                                        self.onebody_wavefunction_type)
+                                        self.extended_syst, boundaries=None,
+                                        params=self._params,
+                                        onebody_wavefunction=self.onebody_wavefunction_type)
         add_boundstates(self.manybody_wavefunction, boundstate_psi, boundstate_tasks)
 
 
 @log_func
 def make_boundstates_time_dependent(boundstate_psi, boundstate_tasks,
                                     syst, boundaries, params=None,
-                                    onebody_wavefunction=onebody.WaveFunction):
+                                    onebody_wavefunction=onebody.WaveFunction.from_kwant):
     """Make boundstates time dependent, such that they can evolve in time.
 
     Parameters
     ----------
     boundstate_psi : dict
         Dictionary with all boundstate wavefunctions.
         If a wavefunction is of type `tkwant.onebody.WaveFunction`
@@ -2318,14 +2285,41 @@
     weight_shape = np.ones(shape=solver.weight_shape())
     tasks = copy.deepcopy(boundstate_tasks)
     for key, task in tasks.items():
         tasks[key].weight = task.weight * weight_shape
     solver.add_distributed_onebody_states(boundstate_psi, tasks)
 
 
+@log_func
+def boundstates_present(syst, tol=1e-4, params=None):
+    """Check if boundstates are present in the system
+
+    Parameters
+    ----------
+    syst : `kwant.builder.FiniteSystem` or `tkwant.system.ExtendedSystem`
+        The low level system for which the wave functions are to be
+        calculated.
+    tol : foat, optional
+        Tolerance to check density deviation from one.
+    params : dict, optional
+        Extra arguments to pass to the Hamiltonian of ``syst``,
+        excluding time.
+    """
+    #  fill up all bands up to the highest energy
+    occupations = lead_occupation(chemical_potential=None)
+    state = State(syst, 1, occupations, params=params)
+    #  calculate the density at time t=0, should be one everywhere if no boundstates are present
+    density_operator = kwant.operator.Density(syst)
+    density = state.evaluate(density_operator, root=None)
+    density_deviation = density - 1
+    logger.info('max density deviation= {}'.format(np.max(np.abs(density_deviation))))
+    logger.debug('density deviation per site= {}'.format(density_deviation))
+    return np.any(np.abs(density_deviation) > tol)
+
+
 class ManybodyIntegrand:
 
     def __init__(self, syst, interval, operator, time=0, params=None, element=None):
         """Diagnostic routine to evaluate the integrand in the manybody integral
 
         For simplicity, this routine evaluates the integrand only on
         a single lead and band
@@ -2392,32 +2386,37 @@
             energy = x
             velocity = 1  # for jacoby determinant
             mode = self.spectrum.energy_to_scattering_mode(energy, self.band,
                                                            self.kmin, self.kmax)
         elif self.integration_variable == 'momentum':
             energy = self.spectrum(x, band=self.band)
             velocity = self.spectrum(x, band=self.band, derivative_order=1)
+            if velocity < 0:
+                msg = ('negative velocity, probably unphysical region: '
+                       'energy={}, k={}, velocity={}'.format(energy, x, velocity))
+                logger.warning(msg)
             mode = self.spectrum.momentum_to_scattering_mode(x, self.band)
         else:
             raise ValueError('integration_variable = {} not known.'
                              .format(self.integration_variable))
 
         if mode == - 1:  # mode is closed
-            msg = ('no open mode for energy={}, lead={}, band={}, kmin={}, kmax={}'
-                   .format(energy, self.lead, self.band, self.kmin, self.kmax))
+            msg = ('no open mode for energy={}, k={}, lead={}, band={}, kmin={}, kmax={}'
+                   .format(energy, x, self.lead, self.band, self.kmin, self.kmax))
             logger.warning(msg)
             return
 
         psi = onebody.ScatteringStates(self.syst, energy=energy,
                                        lead=self.lead, params=self.params,
                                        boundaries=self.boundaries)[mode]
 
         psi.evolve(self.time)
-
         result = velocity * psi.evaluate(self.operator) / (2 * np.pi)
+        if result.shape == (1,):  # if result is an array with only one element
+            result = result[0]
         if self.element is None:
             return result
         return result[self.element]
 
     def vecfunc(self, k):
         """same as func, but for vector like arguments"""
         return np.array([self.func(kk) for kk in k])
```

### Comparing `tkwant-1.0.1/tkwant/mpi.py` & `tkwant-1.1.0rc2/tkwant/mpi.py`

 * *Files 9% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
-# Copyright 2016-2019 tkwant authors.
+# Copyright 2016-2023 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Tools parallelizing tkwant with the Message Passing Interface (MPI)."""
 
 import numpy as np
 from . import _logging
 
 __all__ = ['communicator_init', 'communicator_free', 'get_communicator',
            'distribute_dict', 'DistributedDict', 'round_robin', 'get_rank']
@@ -162,19 +163,29 @@
             self._data.update({key: value})
 
     def delete(self, key):
         """Delete a dictionary entry"""
         if self.comm.rank == self.rank_from_key(key):
             del self._data[key]
 
-    def data(self, key):
+    def data(self, key, to_rank=None):
         """Get the data corresponding to the key"""
         data = self._data.get(key)
         rank = self.rank_from_key(key)
-        return self.comm.bcast(data, root=rank)
+        my_rank = self.comm.rank
+        if to_rank is None:
+            return self.comm.bcast(data, root=rank)
+        if my_rank == rank == to_rank:
+            return self._data[key]
+        if my_rank == rank:
+            self.comm.send(self._data[key], dest=to_rank, tag=44)
+        if my_rank == to_rank:
+            return self.comm.recv(source=rank, tag=44)
+        return None
+
 
     def local_data(self):
         """Get all data stored on the local MPI ranks"""
         return self._data
 
     def local_keys(self):
         """Get all keys on the local MPI ranks"""
```

### Comparing `tkwant-1.0.1/tkwant/onebody/__init__.py` & `tkwant-1.1.0rc2/tkwant/onebody/__init__.py`

 * *Files 24% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
 # Copyright 2016-2019 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Tools for solving the one-body time-dependent Schrödinger equation."""
 
 __all__ = []
 
 for module in ('solvers', 'kernels', 'onebody'):
     exec('from . import {0}'.format(module))
     __all__.append(module)
```

### Comparing `tkwant-1.0.1/tkwant/onebody/kernels.c` & `tkwant-1.1.0rc2/tkwant/onebody/kernels.c`

 * *Files 2% similar despite different names*

```diff
@@ -1,31 +1,32 @@
-/* Generated by Cython 0.29.2 */
+/* Generated by Cython 0.29.34 */
 
 /* BEGIN: Cython Metadata
 {
     "distutils": {
-        "depends": [],
         "name": "tkwant.onebody.kernels",
         "sources": [
             "tkwant/onebody/kernels.pyx"
         ]
     },
     "module_name": "tkwant.onebody.kernels"
 }
 END: Cython Metadata */
 
+#ifndef PY_SSIZE_T_CLEAN
 #define PY_SSIZE_T_CLEAN
+#endif /* PY_SSIZE_T_CLEAN */
 #include "Python.h"
 #ifndef Py_PYTHON_H
     #error Python headers needed to compile C extensions, please install development version of Python.
 #elif PY_VERSION_HEX < 0x02060000 || (0x03000000 <= PY_VERSION_HEX && PY_VERSION_HEX < 0x03030000)
     #error Cython requires Python 2.6+ or Python 3.3+.
 #else
-#define CYTHON_ABI "0_29_2"
-#define CYTHON_HEX_VERSION 0x001D02F0
+#define CYTHON_ABI "0_29_34"
+#define CYTHON_HEX_VERSION 0x001D22F0
 #define CYTHON_FUTURE_DIVISION 1
 #include <stddef.h>
 #ifndef offsetof
   #define offsetof(type, member) ( (size_t) & ((type*)0) -> member )
 #endif
 #if !defined(WIN32) && !defined(MS_WINDOWS)
   #ifndef __stdcall
@@ -56,14 +57,15 @@
 #ifndef Py_HUGE_VAL
   #define Py_HUGE_VAL HUGE_VAL
 #endif
 #ifdef PYPY_VERSION
   #define CYTHON_COMPILING_IN_PYPY 1
   #define CYTHON_COMPILING_IN_PYSTON 0
   #define CYTHON_COMPILING_IN_CPYTHON 0
+  #define CYTHON_COMPILING_IN_NOGIL 0
   #undef CYTHON_USE_TYPE_SLOTS
   #define CYTHON_USE_TYPE_SLOTS 0
   #undef CYTHON_USE_PYTYPE_LOOKUP
   #define CYTHON_USE_PYTYPE_LOOKUP 0
   #if PY_VERSION_HEX < 0x03050000
     #undef CYTHON_USE_ASYNC_SLOTS
     #define CYTHON_USE_ASYNC_SLOTS 0
@@ -92,18 +94,22 @@
   #define CYTHON_PEP489_MULTI_PHASE_INIT 0
   #undef CYTHON_USE_TP_FINALIZE
   #define CYTHON_USE_TP_FINALIZE 0
   #undef CYTHON_USE_DICT_VERSIONS
   #define CYTHON_USE_DICT_VERSIONS 0
   #undef CYTHON_USE_EXC_INFO_STACK
   #define CYTHON_USE_EXC_INFO_STACK 0
+  #ifndef CYTHON_UPDATE_DESCRIPTOR_DOC
+    #define CYTHON_UPDATE_DESCRIPTOR_DOC 0
+  #endif
 #elif defined(PYSTON_VERSION)
   #define CYTHON_COMPILING_IN_PYPY 0
   #define CYTHON_COMPILING_IN_PYSTON 1
   #define CYTHON_COMPILING_IN_CPYTHON 0
+  #define CYTHON_COMPILING_IN_NOGIL 0
   #ifndef CYTHON_USE_TYPE_SLOTS
     #define CYTHON_USE_TYPE_SLOTS 1
   #endif
   #undef CYTHON_USE_PYTYPE_LOOKUP
   #define CYTHON_USE_PYTYPE_LOOKUP 0
   #undef CYTHON_USE_ASYNC_SLOTS
   #define CYTHON_USE_ASYNC_SLOTS 0
@@ -133,18 +139,67 @@
   #define CYTHON_PEP489_MULTI_PHASE_INIT 0
   #undef CYTHON_USE_TP_FINALIZE
   #define CYTHON_USE_TP_FINALIZE 0
   #undef CYTHON_USE_DICT_VERSIONS
   #define CYTHON_USE_DICT_VERSIONS 0
   #undef CYTHON_USE_EXC_INFO_STACK
   #define CYTHON_USE_EXC_INFO_STACK 0
+  #ifndef CYTHON_UPDATE_DESCRIPTOR_DOC
+    #define CYTHON_UPDATE_DESCRIPTOR_DOC 0
+  #endif
+#elif defined(PY_NOGIL)
+  #define CYTHON_COMPILING_IN_PYPY 0
+  #define CYTHON_COMPILING_IN_PYSTON 0
+  #define CYTHON_COMPILING_IN_CPYTHON 0
+  #define CYTHON_COMPILING_IN_NOGIL 1
+  #ifndef CYTHON_USE_TYPE_SLOTS
+    #define CYTHON_USE_TYPE_SLOTS 1
+  #endif
+  #undef CYTHON_USE_PYTYPE_LOOKUP
+  #define CYTHON_USE_PYTYPE_LOOKUP 0
+  #ifndef CYTHON_USE_ASYNC_SLOTS
+    #define CYTHON_USE_ASYNC_SLOTS 1
+  #endif
+  #undef CYTHON_USE_PYLIST_INTERNALS
+  #define CYTHON_USE_PYLIST_INTERNALS 0
+  #ifndef CYTHON_USE_UNICODE_INTERNALS
+    #define CYTHON_USE_UNICODE_INTERNALS 1
+  #endif
+  #undef CYTHON_USE_UNICODE_WRITER
+  #define CYTHON_USE_UNICODE_WRITER 0
+  #undef CYTHON_USE_PYLONG_INTERNALS
+  #define CYTHON_USE_PYLONG_INTERNALS 0
+  #ifndef CYTHON_AVOID_BORROWED_REFS
+    #define CYTHON_AVOID_BORROWED_REFS 0
+  #endif
+  #ifndef CYTHON_ASSUME_SAFE_MACROS
+    #define CYTHON_ASSUME_SAFE_MACROS 1
+  #endif
+  #ifndef CYTHON_UNPACK_METHODS
+    #define CYTHON_UNPACK_METHODS 1
+  #endif
+  #undef CYTHON_FAST_THREAD_STATE
+  #define CYTHON_FAST_THREAD_STATE 0
+  #undef CYTHON_FAST_PYCALL
+  #define CYTHON_FAST_PYCALL 0
+  #ifndef CYTHON_PEP489_MULTI_PHASE_INIT
+    #define CYTHON_PEP489_MULTI_PHASE_INIT 1
+  #endif
+  #ifndef CYTHON_USE_TP_FINALIZE
+    #define CYTHON_USE_TP_FINALIZE 1
+  #endif
+  #undef CYTHON_USE_DICT_VERSIONS
+  #define CYTHON_USE_DICT_VERSIONS 0
+  #undef CYTHON_USE_EXC_INFO_STACK
+  #define CYTHON_USE_EXC_INFO_STACK 0
 #else
   #define CYTHON_COMPILING_IN_PYPY 0
   #define CYTHON_COMPILING_IN_PYSTON 0
   #define CYTHON_COMPILING_IN_CPYTHON 1
+  #define CYTHON_COMPILING_IN_NOGIL 0
   #ifndef CYTHON_USE_TYPE_SLOTS
     #define CYTHON_USE_TYPE_SLOTS 1
   #endif
   #if PY_VERSION_HEX < 0x02070000
     #undef CYTHON_USE_PYTYPE_LOOKUP
     #define CYTHON_USE_PYTYPE_LOOKUP 0
   #elif !defined(CYTHON_USE_PYTYPE_LOOKUP)
@@ -156,61 +211,72 @@
   #elif !defined(CYTHON_USE_ASYNC_SLOTS)
     #define CYTHON_USE_ASYNC_SLOTS 1
   #endif
   #if PY_VERSION_HEX < 0x02070000
     #undef CYTHON_USE_PYLONG_INTERNALS
     #define CYTHON_USE_PYLONG_INTERNALS 0
   #elif !defined(CYTHON_USE_PYLONG_INTERNALS)
-    #define CYTHON_USE_PYLONG_INTERNALS 1
+    #define CYTHON_USE_PYLONG_INTERNALS (PY_VERSION_HEX < 0x030C00A5)
   #endif
   #ifndef CYTHON_USE_PYLIST_INTERNALS
     #define CYTHON_USE_PYLIST_INTERNALS 1
   #endif
   #ifndef CYTHON_USE_UNICODE_INTERNALS
     #define CYTHON_USE_UNICODE_INTERNALS 1
   #endif
-  #if PY_VERSION_HEX < 0x030300F0
+  #if PY_VERSION_HEX < 0x030300F0 || PY_VERSION_HEX >= 0x030B00A2
     #undef CYTHON_USE_UNICODE_WRITER
     #define CYTHON_USE_UNICODE_WRITER 0
   #elif !defined(CYTHON_USE_UNICODE_WRITER)
     #define CYTHON_USE_UNICODE_WRITER 1
   #endif
   #ifndef CYTHON_AVOID_BORROWED_REFS
     #define CYTHON_AVOID_BORROWED_REFS 0
   #endif
   #ifndef CYTHON_ASSUME_SAFE_MACROS
     #define CYTHON_ASSUME_SAFE_MACROS 1
   #endif
   #ifndef CYTHON_UNPACK_METHODS
     #define CYTHON_UNPACK_METHODS 1
   #endif
-  #ifndef CYTHON_FAST_THREAD_STATE
+  #if PY_VERSION_HEX >= 0x030B00A4
+    #undef CYTHON_FAST_THREAD_STATE
+    #define CYTHON_FAST_THREAD_STATE 0
+  #elif !defined(CYTHON_FAST_THREAD_STATE)
     #define CYTHON_FAST_THREAD_STATE 1
   #endif
   #ifndef CYTHON_FAST_PYCALL
-    #define CYTHON_FAST_PYCALL 1
+    #define CYTHON_FAST_PYCALL (PY_VERSION_HEX < 0x030A0000)
   #endif
   #ifndef CYTHON_PEP489_MULTI_PHASE_INIT
     #define CYTHON_PEP489_MULTI_PHASE_INIT (PY_VERSION_HEX >= 0x03050000)
   #endif
   #ifndef CYTHON_USE_TP_FINALIZE
     #define CYTHON_USE_TP_FINALIZE (PY_VERSION_HEX >= 0x030400a1)
   #endif
   #ifndef CYTHON_USE_DICT_VERSIONS
-    #define CYTHON_USE_DICT_VERSIONS (PY_VERSION_HEX >= 0x030600B1)
+    #define CYTHON_USE_DICT_VERSIONS ((PY_VERSION_HEX >= 0x030600B1) && (PY_VERSION_HEX < 0x030C00A5))
   #endif
-  #ifndef CYTHON_USE_EXC_INFO_STACK
+  #if PY_VERSION_HEX >= 0x030B00A4
+    #undef CYTHON_USE_EXC_INFO_STACK
+    #define CYTHON_USE_EXC_INFO_STACK 0
+  #elif !defined(CYTHON_USE_EXC_INFO_STACK)
     #define CYTHON_USE_EXC_INFO_STACK (PY_VERSION_HEX >= 0x030700A3)
   #endif
+  #ifndef CYTHON_UPDATE_DESCRIPTOR_DOC
+    #define CYTHON_UPDATE_DESCRIPTOR_DOC 1
+  #endif
 #endif
 #if !defined(CYTHON_FAST_PYCCALL)
 #define CYTHON_FAST_PYCCALL  (CYTHON_FAST_PYCALL && PY_VERSION_HEX >= 0x030600B1)
 #endif
 #if CYTHON_USE_PYLONG_INTERNALS
-  #include "longintrepr.h"
+  #if PY_MAJOR_VERSION < 3
+    #include "longintrepr.h"
+  #endif
   #undef SHIFT
   #undef BASE
   #undef MASK
   #ifdef SIZEOF_VOID_P
     enum { __pyx_check_sizeof_voidp = 1 / (int)(SIZEOF_VOID_P == sizeof(void*)) };
   #endif
 #endif
@@ -319,16 +385,80 @@
 #if PY_MAJOR_VERSION < 3
   #define __Pyx_BUILTIN_MODULE_NAME "__builtin__"
   #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
           PyCode_New(a+k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
   #define __Pyx_DefaultClassType PyClass_Type
 #else
   #define __Pyx_BUILTIN_MODULE_NAME "builtins"
+  #define __Pyx_DefaultClassType PyType_Type
+#if PY_VERSION_HEX >= 0x030B00A1
+    static CYTHON_INLINE PyCodeObject* __Pyx_PyCode_New(int a, int k, int l, int s, int f,
+                                                    PyObject *code, PyObject *c, PyObject* n, PyObject *v,
+                                                    PyObject *fv, PyObject *cell, PyObject* fn,
+                                                    PyObject *name, int fline, PyObject *lnos) {
+        PyObject *kwds=NULL, *argcount=NULL, *posonlyargcount=NULL, *kwonlyargcount=NULL;
+        PyObject *nlocals=NULL, *stacksize=NULL, *flags=NULL, *replace=NULL, *call_result=NULL, *empty=NULL;
+        const char *fn_cstr=NULL;
+        const char *name_cstr=NULL;
+        PyCodeObject* co=NULL;
+        PyObject *type, *value, *traceback;
+        PyErr_Fetch(&type, &value, &traceback);
+        if (!(kwds=PyDict_New())) goto end;
+        if (!(argcount=PyLong_FromLong(a))) goto end;
+        if (PyDict_SetItemString(kwds, "co_argcount", argcount) != 0) goto end;
+        if (!(posonlyargcount=PyLong_FromLong(0))) goto end;
+        if (PyDict_SetItemString(kwds, "co_posonlyargcount", posonlyargcount) != 0) goto end;
+        if (!(kwonlyargcount=PyLong_FromLong(k))) goto end;
+        if (PyDict_SetItemString(kwds, "co_kwonlyargcount", kwonlyargcount) != 0) goto end;
+        if (!(nlocals=PyLong_FromLong(l))) goto end;
+        if (PyDict_SetItemString(kwds, "co_nlocals", nlocals) != 0) goto end;
+        if (!(stacksize=PyLong_FromLong(s))) goto end;
+        if (PyDict_SetItemString(kwds, "co_stacksize", stacksize) != 0) goto end;
+        if (!(flags=PyLong_FromLong(f))) goto end;
+        if (PyDict_SetItemString(kwds, "co_flags", flags) != 0) goto end;
+        if (PyDict_SetItemString(kwds, "co_code", code) != 0) goto end;
+        if (PyDict_SetItemString(kwds, "co_consts", c) != 0) goto end;
+        if (PyDict_SetItemString(kwds, "co_names", n) != 0) goto end;
+        if (PyDict_SetItemString(kwds, "co_varnames", v) != 0) goto end;
+        if (PyDict_SetItemString(kwds, "co_freevars", fv) != 0) goto end;
+        if (PyDict_SetItemString(kwds, "co_cellvars", cell) != 0) goto end;
+        if (PyDict_SetItemString(kwds, "co_linetable", lnos) != 0) goto end;
+        if (!(fn_cstr=PyUnicode_AsUTF8AndSize(fn, NULL))) goto end;
+        if (!(name_cstr=PyUnicode_AsUTF8AndSize(name, NULL))) goto end;
+        if (!(co = PyCode_NewEmpty(fn_cstr, name_cstr, fline))) goto end;
+        if (!(replace = PyObject_GetAttrString((PyObject*)co, "replace"))) goto cleanup_code_too;
+        if (!(empty = PyTuple_New(0))) goto cleanup_code_too; // unfortunately __pyx_empty_tuple isn't available here
+        if (!(call_result = PyObject_Call(replace, empty, kwds))) goto cleanup_code_too;
+        Py_XDECREF((PyObject*)co);
+        co = (PyCodeObject*)call_result;
+        call_result = NULL;
+        if (0) {
+            cleanup_code_too:
+            Py_XDECREF((PyObject*)co);
+            co = NULL;
+        }
+        end:
+        Py_XDECREF(kwds);
+        Py_XDECREF(argcount);
+        Py_XDECREF(posonlyargcount);
+        Py_XDECREF(kwonlyargcount);
+        Py_XDECREF(nlocals);
+        Py_XDECREF(stacksize);
+        Py_XDECREF(replace);
+        Py_XDECREF(call_result);
+        Py_XDECREF(empty);
+        if (type) {
+            PyErr_Restore(type, value, traceback);
+        }
+        return co;
+    }
+#else
   #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
           PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
+#endif
   #define __Pyx_DefaultClassType PyType_Type
 #endif
 #ifndef Py_TPFLAGS_CHECKTYPES
   #define Py_TPFLAGS_CHECKTYPES 0
 #endif
 #ifndef Py_TPFLAGS_HAVE_INDEX
   #define Py_TPFLAGS_HAVE_INDEX 0
@@ -355,34 +485,14 @@
 #endif
 #if CYTHON_FAST_PYCCALL
 #define __Pyx_PyFastCFunction_Check(func)\
     ((PyCFunction_Check(func) && (METH_FASTCALL == (PyCFunction_GET_FLAGS(func) & ~(METH_CLASS | METH_STATIC | METH_COEXIST | METH_KEYWORDS | METH_STACKLESS)))))
 #else
 #define __Pyx_PyFastCFunction_Check(func) 0
 #endif
-#if CYTHON_USE_DICT_VERSIONS
-#define __PYX_GET_DICT_VERSION(dict)  (((PyDictObject*)(dict))->ma_version_tag)
-#define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)\
-    (version_var) = __PYX_GET_DICT_VERSION(dict);\
-    (cache_var) = (value);
-#define __PYX_PY_DICT_LOOKUP_IF_MODIFIED(VAR, DICT, LOOKUP) {\
-        static PY_UINT64_T __pyx_dict_version = 0;\
-        static PyObject *__pyx_dict_cached_value = NULL;\
-        if (likely(__PYX_GET_DICT_VERSION(DICT) == __pyx_dict_version)) {\
-            (VAR) = __pyx_dict_cached_value;\
-        } else {\
-            (VAR) = __pyx_dict_cached_value = (LOOKUP);\
-            __pyx_dict_version = __PYX_GET_DICT_VERSION(DICT);\
-        }\
-    }
-#else
-#define __PYX_GET_DICT_VERSION(dict)  (0)
-#define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)
-#define __PYX_PY_DICT_LOOKUP_IF_MODIFIED(VAR, DICT, LOOKUP)  (VAR) = (LOOKUP);
-#endif
 #if CYTHON_COMPILING_IN_PYPY && !defined(PyObject_Malloc)
   #define PyObject_Malloc(s)   PyMem_Malloc(s)
   #define PyObject_Free(p)     PyMem_Free(p)
   #define PyObject_Realloc(p)  PyMem_Realloc(p)
 #endif
 #if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030400A1
   #define PyMem_RawMalloc(n)           PyMem_Malloc(n)
@@ -407,15 +517,15 @@
 #endif
 #if PY_VERSION_HEX < 0x030700A2 && !defined(PyThread_tss_create) && !defined(Py_tss_NEEDS_INIT)
 #include "pythread.h"
 #define Py_tss_NEEDS_INIT 0
 typedef int Py_tss_t;
 static CYTHON_INLINE int PyThread_tss_create(Py_tss_t *key) {
   *key = PyThread_create_key();
-  return 0; // PyThread_create_key reports success always
+  return 0;
 }
 static CYTHON_INLINE Py_tss_t * PyThread_tss_alloc(void) {
   Py_tss_t *key = (Py_tss_t *)PyObject_Malloc(sizeof(Py_tss_t));
   *key = Py_tss_NEEDS_INIT;
   return key;
 }
 static CYTHON_INLINE void PyThread_tss_free(Py_tss_t *key) {
@@ -430,15 +540,15 @@
 }
 static CYTHON_INLINE int PyThread_tss_set(Py_tss_t *key, void *value) {
   return PyThread_set_key_value(*key, value);
 }
 static CYTHON_INLINE void * PyThread_tss_get(Py_tss_t *key) {
   return PyThread_get_key_value(*key);
 }
-#endif // TSS (Thread Specific Storage) API
+#endif
 #if CYTHON_COMPILING_IN_CPYTHON || defined(_PyDict_NewPresized)
 #define __Pyx_PyDict_NewPresized(n)  ((n <= 8) ? PyDict_New() : _PyDict_NewPresized(n))
 #else
 #define __Pyx_PyDict_NewPresized(n)  PyDict_New()
 #endif
 #if PY_MAJOR_VERSION >= 3 || CYTHON_FUTURE_DIVISION
   #define __Pyx_PyNumber_Divide(x,y)         PyNumber_TrueDivide(x,y)
@@ -450,24 +560,36 @@
 #if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030500A1 && CYTHON_USE_UNICODE_INTERNALS
 #define __Pyx_PyDict_GetItemStr(dict, name)  _PyDict_GetItem_KnownHash(dict, name, ((PyASCIIObject *) name)->hash)
 #else
 #define __Pyx_PyDict_GetItemStr(dict, name)  PyDict_GetItem(dict, name)
 #endif
 #if PY_VERSION_HEX > 0x03030000 && defined(PyUnicode_KIND)
   #define CYTHON_PEP393_ENABLED 1
-  #define __Pyx_PyUnicode_READY(op)       (likely(PyUnicode_IS_READY(op)) ?\
-                                              0 : _PyUnicode_Ready((PyObject *)(op)))
+  #if PY_VERSION_HEX >= 0x030C0000
+    #define __Pyx_PyUnicode_READY(op)       (0)
+  #else
+    #define __Pyx_PyUnicode_READY(op)       (likely(PyUnicode_IS_READY(op)) ?\
+                                                0 : _PyUnicode_Ready((PyObject *)(op)))
+  #endif
   #define __Pyx_PyUnicode_GET_LENGTH(u)   PyUnicode_GET_LENGTH(u)
   #define __Pyx_PyUnicode_READ_CHAR(u, i) PyUnicode_READ_CHAR(u, i)
   #define __Pyx_PyUnicode_MAX_CHAR_VALUE(u)   PyUnicode_MAX_CHAR_VALUE(u)
   #define __Pyx_PyUnicode_KIND(u)         PyUnicode_KIND(u)
   #define __Pyx_PyUnicode_DATA(u)         PyUnicode_DATA(u)
   #define __Pyx_PyUnicode_READ(k, d, i)   PyUnicode_READ(k, d, i)
   #define __Pyx_PyUnicode_WRITE(k, d, i, ch)  PyUnicode_WRITE(k, d, i, ch)
-  #define __Pyx_PyUnicode_IS_TRUE(u)      (0 != (likely(PyUnicode_IS_READY(u)) ? PyUnicode_GET_LENGTH(u) : PyUnicode_GET_SIZE(u)))
+  #if PY_VERSION_HEX >= 0x030C0000
+    #define __Pyx_PyUnicode_IS_TRUE(u)      (0 != PyUnicode_GET_LENGTH(u))
+  #else
+    #if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x03090000
+    #define __Pyx_PyUnicode_IS_TRUE(u)      (0 != (likely(PyUnicode_IS_READY(u)) ? PyUnicode_GET_LENGTH(u) : ((PyCompactUnicodeObject *)(u))->wstr_length))
+    #else
+    #define __Pyx_PyUnicode_IS_TRUE(u)      (0 != (likely(PyUnicode_IS_READY(u)) ? PyUnicode_GET_LENGTH(u) : PyUnicode_GET_SIZE(u)))
+    #endif
+  #endif
 #else
   #define CYTHON_PEP393_ENABLED 0
   #define PyUnicode_1BYTE_KIND  1
   #define PyUnicode_2BYTE_KIND  2
   #define PyUnicode_4BYTE_KIND  4
   #define __Pyx_PyUnicode_READY(op)       (0)
   #define __Pyx_PyUnicode_GET_LENGTH(u)   PyUnicode_GET_SIZE(u)
@@ -508,26 +630,35 @@
 #endif
 #if PY_MAJOR_VERSION >= 3
   #define PyBaseString_Type            PyUnicode_Type
   #define PyStringObject               PyUnicodeObject
   #define PyString_Type                PyUnicode_Type
   #define PyString_Check               PyUnicode_Check
   #define PyString_CheckExact          PyUnicode_CheckExact
+#ifndef PyObject_Unicode
   #define PyObject_Unicode             PyObject_Str
 #endif
+#endif
 #if PY_MAJOR_VERSION >= 3
   #define __Pyx_PyBaseString_Check(obj) PyUnicode_Check(obj)
   #define __Pyx_PyBaseString_CheckExact(obj) PyUnicode_CheckExact(obj)
 #else
   #define __Pyx_PyBaseString_Check(obj) (PyString_Check(obj) || PyUnicode_Check(obj))
   #define __Pyx_PyBaseString_CheckExact(obj) (PyString_CheckExact(obj) || PyUnicode_CheckExact(obj))
 #endif
 #ifndef PySet_CheckExact
   #define PySet_CheckExact(obj)        (Py_TYPE(obj) == &PySet_Type)
 #endif
+#if PY_VERSION_HEX >= 0x030900A4
+  #define __Pyx_SET_REFCNT(obj, refcnt) Py_SET_REFCNT(obj, refcnt)
+  #define __Pyx_SET_SIZE(obj, size) Py_SET_SIZE(obj, size)
+#else
+  #define __Pyx_SET_REFCNT(obj, refcnt) Py_REFCNT(obj) = (refcnt)
+  #define __Pyx_SET_SIZE(obj, size) Py_SIZE(obj) = (size)
+#endif
 #if CYTHON_ASSUME_SAFE_MACROS
   #define __Pyx_PySequence_SIZE(seq)  Py_SIZE(seq)
 #else
   #define __Pyx_PySequence_SIZE(seq)  PySequence_Size(seq)
 #endif
 #if PY_MAJOR_VERSION >= 3
   #define PyIntObject                  PyLongObject
@@ -553,21 +684,21 @@
   #ifndef PyUnicode_InternFromString
     #define PyUnicode_InternFromString(s) PyUnicode_FromString(s)
   #endif
 #endif
 #if PY_VERSION_HEX < 0x030200A4
   typedef long Py_hash_t;
   #define __Pyx_PyInt_FromHash_t PyInt_FromLong
-  #define __Pyx_PyInt_AsHash_t   PyInt_AsLong
+  #define __Pyx_PyInt_AsHash_t   __Pyx_PyIndex_AsHash_t
 #else
   #define __Pyx_PyInt_FromHash_t PyInt_FromSsize_t
-  #define __Pyx_PyInt_AsHash_t   PyInt_AsSsize_t
+  #define __Pyx_PyInt_AsHash_t   __Pyx_PyIndex_AsSsize_t
 #endif
 #if PY_MAJOR_VERSION >= 3
-  #define __Pyx_PyMethod_New(func, self, klass) ((self) ? PyMethod_New(func, self) : (Py_INCREF(func), func))
+  #define __Pyx_PyMethod_New(func, self, klass) ((self) ? ((void)(klass), PyMethod_New(func, self)) : __Pyx_NewRef(func))
 #else
   #define __Pyx_PyMethod_New(func, self, klass) PyMethod_New(func, self, klass)
 #endif
 #if CYTHON_USE_ASYNC_SLOTS
   #if PY_VERSION_HEX >= 0x030500B1
     #define __Pyx_PyAsyncMethodsStruct PyAsyncMethods
     #define __Pyx_PyType_AsAsync(obj) (Py_TYPE(obj)->tp_as_async)
@@ -581,16 +712,18 @@
     typedef struct {
         unaryfunc am_await;
         unaryfunc am_aiter;
         unaryfunc am_anext;
     } __Pyx_PyAsyncMethodsStruct;
 #endif
 
-#if defined(WIN32) || defined(MS_WINDOWS)
-  #define _USE_MATH_DEFINES
+#if defined(_WIN32) || defined(WIN32) || defined(MS_WINDOWS)
+  #if !defined(_USE_MATH_DEFINES)
+    #define _USE_MATH_DEFINES
+  #endif
 #endif
 #include <math.h>
 #ifdef NAN
 #define __PYX_NAN() ((float) NAN)
 #else
 static CYTHON_INLINE float __PYX_NAN() {
   float value;
@@ -600,49 +733,49 @@
 #endif
 #if defined(__CYGWIN__) && defined(_LDBL_EQ_DBL)
 #define __Pyx_truncl trunc
 #else
 #define __Pyx_truncl truncl
 #endif
 
-
+#define __PYX_MARK_ERR_POS(f_index, lineno) \
+    { __pyx_filename = __pyx_f[f_index]; (void)__pyx_filename; __pyx_lineno = lineno; (void)__pyx_lineno; __pyx_clineno = __LINE__; (void)__pyx_clineno; }
 #define __PYX_ERR(f_index, lineno, Ln_error) \
-{ \
-  __pyx_filename = __pyx_f[f_index]; __pyx_lineno = lineno; __pyx_clineno = __LINE__; goto Ln_error; \
-}
+    { __PYX_MARK_ERR_POS(f_index, lineno) goto Ln_error; }
 
 #ifndef __PYX_EXTERN_C
   #ifdef __cplusplus
     #define __PYX_EXTERN_C extern "C"
   #else
     #define __PYX_EXTERN_C extern
   #endif
 #endif
 
 #define __PYX_HAVE__tkwant__onebody__kernels
 #define __PYX_HAVE_API__tkwant__onebody__kernels
 /* Early includes */
-#include <string.h>
-#include <stdio.h>
 #include "pythread.h"
+#include <string.h>
 #include <stdlib.h>
+#include <stdio.h>
 #include "pystate.h"
 #ifdef _OPENMP
 #include <omp.h>
 #endif /* _OPENMP */
 
 #if defined(PYREX_WITHOUT_ASSERTIONS) && !defined(CYTHON_WITHOUT_ASSERTIONS)
 #define CYTHON_WITHOUT_ASSERTIONS
 #endif
 
 typedef struct {PyObject **p; const char *s; const Py_ssize_t n; const char* encoding;
                 const char is_unicode; const char is_str; const char intern; } __Pyx_StringTabEntry;
 
 #define __PYX_DEFAULT_STRING_ENCODING_IS_ASCII 0
-#define __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT 0
+#define __PYX_DEFAULT_STRING_ENCODING_IS_UTF8 0
+#define __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT (PY_MAJOR_VERSION >= 3 && __PYX_DEFAULT_STRING_ENCODING_IS_UTF8)
 #define __PYX_DEFAULT_STRING_ENCODING ""
 #define __Pyx_PyObject_FromString __Pyx_PyBytes_FromString
 #define __Pyx_PyObject_FromStringAndSize __Pyx_PyBytes_FromStringAndSize
 #define __Pyx_uchar_cast(c) ((unsigned char)c)
 #define __Pyx_long_cast(x) ((long)x)
 #define __Pyx_fits_Py_ssize_t(v, type, is_signed)  (\
     (sizeof(type) < sizeof(Py_ssize_t))  ||\
@@ -717,14 +850,15 @@
 static CYTHON_INLINE int __Pyx_PyObject_IsTrue(PyObject*);
 static CYTHON_INLINE int __Pyx_PyObject_IsTrueAndDecref(PyObject*);
 static CYTHON_INLINE PyObject* __Pyx_PyNumber_IntOrLong(PyObject* x);
 #define __Pyx_PySequence_Tuple(obj)\
     (likely(PyTuple_CheckExact(obj)) ? __Pyx_NewRef(obj) : PySequence_Tuple(obj))
 static CYTHON_INLINE Py_ssize_t __Pyx_PyIndex_AsSsize_t(PyObject*);
 static CYTHON_INLINE PyObject * __Pyx_PyInt_FromSize_t(size_t);
+static CYTHON_INLINE Py_hash_t __Pyx_PyIndex_AsHash_t(PyObject*);
 #if CYTHON_ASSUME_SAFE_MACROS
 #define __pyx_PyFloat_AsDouble(x) (PyFloat_CheckExact(x) ? PyFloat_AS_DOUBLE(x) : PyFloat_AsDouble(x))
 #else
 #define __pyx_PyFloat_AsDouble(x) PyFloat_AsDouble(x)
 #endif
 #define __pyx_PyFloat_AsFloat(x) ((float) __pyx_PyFloat_AsDouble(x))
 #if PY_MAJOR_VERSION >= 3
@@ -854,15 +988,14 @@
 #endif
 
 
 static const char *__pyx_f[] = {
   "tkwant/onebody/kernels.pyx",
   "stringsource",
   "tkwant/onebody/kernels.pxd",
-  "type.pxd",
 };
 /* MemviewSliceStruct.proto */
 struct __pyx_memoryview_obj;
 typedef struct {
   struct __pyx_memoryview_obj *memview;
   char *data;
   Py_ssize_t shape[8];
@@ -872,51 +1005,47 @@
 #define __Pyx_MemoryView_Len(m)  (m.shape[0])
 
 /* Atomics.proto */
 #include <pythread.h>
 #ifndef CYTHON_ATOMICS
     #define CYTHON_ATOMICS 1
 #endif
+#define __PYX_CYTHON_ATOMICS_ENABLED() CYTHON_ATOMICS
 #define __pyx_atomic_int_type int
-#if CYTHON_ATOMICS && __GNUC__ >= 4 && (__GNUC_MINOR__ > 1 ||\
-                    (__GNUC_MINOR__ == 1 && __GNUC_PATCHLEVEL >= 2)) &&\
-                    !defined(__i386__)
-    #define __pyx_atomic_incr_aligned(value, lock) __sync_fetch_and_add(value, 1)
-    #define __pyx_atomic_decr_aligned(value, lock) __sync_fetch_and_sub(value, 1)
+#if CYTHON_ATOMICS && (__GNUC__ >= 5 || (__GNUC__ == 4 &&\
+                    (__GNUC_MINOR__ > 1 ||\
+                    (__GNUC_MINOR__ == 1 && __GNUC_PATCHLEVEL__ >= 2))))
+    #define __pyx_atomic_incr_aligned(value) __sync_fetch_and_add(value, 1)
+    #define __pyx_atomic_decr_aligned(value) __sync_fetch_and_sub(value, 1)
     #ifdef __PYX_DEBUG_ATOMICS
         #warning "Using GNU atomics"
     #endif
-#elif CYTHON_ATOMICS && defined(_MSC_VER) && 0
-    #include <Windows.h>
+#elif CYTHON_ATOMICS && defined(_MSC_VER) && CYTHON_COMPILING_IN_NOGIL
+    #include <intrin.h>
     #undef __pyx_atomic_int_type
-    #define __pyx_atomic_int_type LONG
-    #define __pyx_atomic_incr_aligned(value, lock) InterlockedIncrement(value)
-    #define __pyx_atomic_decr_aligned(value, lock) InterlockedDecrement(value)
+    #define __pyx_atomic_int_type long
+    #pragma intrinsic (_InterlockedExchangeAdd)
+    #define __pyx_atomic_incr_aligned(value) _InterlockedExchangeAdd(value, 1)
+    #define __pyx_atomic_decr_aligned(value) _InterlockedExchangeAdd(value, -1)
     #ifdef __PYX_DEBUG_ATOMICS
         #pragma message ("Using MSVC atomics")
     #endif
-#elif CYTHON_ATOMICS && (defined(__ICC) || defined(__INTEL_COMPILER)) && 0
-    #define __pyx_atomic_incr_aligned(value, lock) _InterlockedIncrement(value)
-    #define __pyx_atomic_decr_aligned(value, lock) _InterlockedDecrement(value)
-    #ifdef __PYX_DEBUG_ATOMICS
-        #warning "Using Intel atomics"
-    #endif
 #else
     #undef CYTHON_ATOMICS
     #define CYTHON_ATOMICS 0
     #ifdef __PYX_DEBUG_ATOMICS
         #warning "Not using atomics"
     #endif
 #endif
 typedef volatile __pyx_atomic_int_type __pyx_atomic_int;
 #if CYTHON_ATOMICS
     #define __pyx_add_acquisition_count(memview)\
-             __pyx_atomic_incr_aligned(__pyx_get_slice_count_pointer(memview), memview->lock)
+             __pyx_atomic_incr_aligned(__pyx_get_slice_count_pointer(memview))
     #define __pyx_sub_acquisition_count(memview)\
-            __pyx_atomic_decr_aligned(__pyx_get_slice_count_pointer(memview), memview->lock)
+            __pyx_atomic_decr_aligned(__pyx_get_slice_count_pointer(memview))
 #else
     #define __pyx_add_acquisition_count(memview)\
             __pyx_add_acquisition_count_locked(__pyx_get_slice_count_pointer(memview), memview->lock)
     #define __pyx_sub_acquisition_count(memview)\
             __pyx_sub_acquisition_count_locked(__pyx_get_slice_count_pointer(memview), memview->lock)
 #endif
 
@@ -979,108 +1108,105 @@
     typedef struct { double real, imag; } __pyx_t_double_complex;
 #endif
 static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);
 
 
 /*--- Type declarations ---*/
 struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel;
-struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel;
-struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel;
+struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation;
 struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor;
 struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator;
-struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix;
 struct __pyx_obj_6tkwant_7onebody_7kernels_Simple;
+struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc;
 struct __pyx_array_obj;
 struct __pyx_MemviewEnum_obj;
 struct __pyx_memoryview_obj;
 struct __pyx_memoryviewslice_obj;
 struct __pyx_ctuple_double__and_double__and_double__and_double__and_double;
 typedef struct __pyx_ctuple_double__and_double__and_double__and_double__and_double __pyx_ctuple_double__and_double__and_double__and_double__and_double;
 struct __pyx_ctuple_double__and_double__and_double__and_double;
 typedef struct __pyx_ctuple_double__and_double__and_double__and_double __pyx_ctuple_double__and_double__and_double__and_double;
 
-/* "tkwant/onebody/kernels.pxd":18
- * 
- * 
- * ctypedef void (*rhs_t)(const void *self, const complex *psi_bar, complex *dpsidt,             # <<<<<<<<<<<<<<
- *                        double time) except *
- * 
- */
-typedef void (*__pyx_t_6tkwant_7onebody_7kernels_rhs_t)(void const *, __pyx_t_double_complex const *, __pyx_t_double_complex *, double);
-
-/* "tkwant/onebody/kernels.pyx":215
+/* "tkwant/onebody/kernels.pyx":199
  * @cython.boundscheck(False)
  * @cython.wraparound(False)
  * cdef(double, double, double, double, double) update_times(double t, double t0, double dt):             # <<<<<<<<<<<<<<
  *     '''Return new update times for the Hamiltonian matrix.
  *     '''
  */
 struct __pyx_ctuple_double__and_double__and_double__and_double__and_double {
   double f0;
   double f1;
   double f2;
   double f3;
   double f4;
 };
 
-/* "tkwant/onebody/kernels.pyx":235
+/* "tkwant/onebody/kernels.pyx":216
  * @cython.boundscheck(False)
  * @cython.wraparound(False)
  * cdef(double, double, double, double) _get_polynome_coeffs(double t, double t0, double t1, double dt):             # <<<<<<<<<<<<<<
  * 
  *     cdef double rdx = 1 / dt
  */
 struct __pyx_ctuple_double__and_double__and_double__and_double {
   double f0;
   double f1;
   double f2;
   double f3;
 };
 
-/* "tkwant/onebody/kernels.pxd":14
+/* "tkwant/onebody/kernels.pxd":15
  * 
  * 
  * cdef class Kernel:             # <<<<<<<<<<<<<<
  *     cdef public int size, nevals
- * 
  */
 struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel {
   PyObject_HEAD
   int size;
   int nevals;
 };
 
 
-/* "tkwant/onebody/kernels.pxd":22
- * 
- * 
- * cdef class CKernel(Kernel):             # <<<<<<<<<<<<<<
- *     cdef void *c_self
- *     cdef rhs_t c_rhs
- */
-struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel {
-  struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel __pyx_base;
-  void *c_self;
-  __pyx_t_6tkwant_7onebody_7kernels_rhs_t c_rhs;
-};
-
-
-/* "tkwant/onebody/kernels.pyx":102
+/* "tkwant/onebody/kernels.pyx":240
  * 
  * 
- * cdef class PyCKernel(CKernel):             # <<<<<<<<<<<<<<
- *     """C interface to python-implemented kernels."""
+ * cdef class Interpolation:             # <<<<<<<<<<<<<<
  * 
+ *     cdef:
  */
-struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel {
-  struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel __pyx_base;
+struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation {
+  PyObject_HEAD
+  double dt;
+  double t0;
+  double t1;
+  double t2;
+  double t3;
+  double t4;
+  double atol;
+  double rtol;
+  double fac;
+  double facmin;
+  double facmax;
+  double dt_min;
+  PyObject *Ht0;
+  PyObject *Ht1;
+  PyObject *Ht2;
+  PyObject *Ht3;
+  PyObject *Ht4;
+  PyObject *d2Ht0;
+  PyObject *d2Ht1;
+  PyObject *d2Ht2;
+  PyObject *func;
+  unsigned int nnz;
 };
 
 
-/* "tkwant/onebody/kernels.pyx":262
+/* "tkwant/onebody/kernels.pyx":427
  * #       this to something more general?
  * # TODO: change this routine when kwant supports vectorized systems
  * cdef class PerturbationExtractor:             # <<<<<<<<<<<<<<
  *     """Extract the time-dependent perturbation to the Hamiltonian.
  * 
  */
 struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor {
@@ -1090,93 +1216,70 @@
   int size;
   int nnz;
   PyObject *time_name;
   PyObject *td_hamiltonian;
 };
 
 
-/* "tkwant/onebody/kernels.pyx":495
+/* "tkwant/onebody/kernels.pyx":663
  * 
  * 
  * cdef class PerturbationInterpolator:             # <<<<<<<<<<<<<<
  *     r"""A class to extract and interpolate W(t).
  * 
  */
 struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator {
   PyObject_HEAD
   double dt;
-  double t0;
-  double t1;
-  double t2;
-  double t3;
-  double t4;
-  PyObject *Ht0;
   unsigned int size;
-  double time_start;
-  PyObject *time_name;
-  PyObject *tterms;
-  PyObject *Ht1;
-  PyObject *Ht2;
-  PyObject *Ht3;
-  PyObject *Ht4;
-  PyObject *d2Ht0;
-  PyObject *d2Ht1;
-  PyObject *d2Ht2;
-  double x0;
-  double x1;
-  PyObject *y0;
-  PyObject *y1;
-  PyObject *d2y0;
-  PyObject *d2y1;
-  int _do_update;
+  unsigned int nnz;
   PyObject *wt;
   PyObject *wfunc;
-  unsigned int nnz;
+  PyObject *intfunc;
 };
 
 
-/* "tkwant/onebody/kernels.pyx":827
- * # Example Kernel implementation in C
+/* "tkwant/onebody/kernels.pyx":829
+ * 
+ * 
+ * cdef class Simple(Kernel):             # <<<<<<<<<<<<<<
+ *     """A C-implemented kernel using naive CSR matvec."""
  * 
- * cdef class _CSRMatrix:             # <<<<<<<<<<<<<<
- *     cdef complex[:] data
- *     cdef int nrows, ncols
  */
-struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix {
-  PyObject_HEAD
-  __Pyx_memviewslice data;
-  int nrows;
-  int ncols;
-  __Pyx_memviewslice indices;
-  __Pyx_memviewslice indptr;
+struct __pyx_obj_6tkwant_7onebody_7kernels_Simple {
+  struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel __pyx_base;
+  PyObject *H0;
+  PyObject *W;
+  int center_size;
+  __Pyx_memviewslice psi_st;
+  PyObject *_temp;
 };
 
 
-/* "tkwant/onebody/kernels.pyx":857
+/* "tkwant/onebody/kernels.pyx":901
  * 
  * 
- * cdef class Simple(CKernel):             # <<<<<<<<<<<<<<
- *     """A C-implemented kernel using naive CSR matvec."""
+ * cdef class _CalcRHSc:             # <<<<<<<<<<<<<<
  * 
+ *     cdef:
  */
-struct __pyx_obj_6tkwant_7onebody_7kernels_Simple {
-  struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel __pyx_base;
-  struct __pyx_vtabstruct_6tkwant_7onebody_7kernels_Simple *__pyx_vtab;
+struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc {
+  PyObject_HEAD
   PyObject *W;
-  PyObject *params;
   int center_size;
-  __Pyx_memviewslice _psi_st;
-  __Pyx_memviewslice _temp;
-  __pyx_t_double_complex *temp;
+  int size;
   __pyx_t_double_complex *psi_st;
-  struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *H0;
+  __pyx_t_double_complex *temp;
+  __Pyx_memviewslice _data;
+  __Pyx_memviewslice _indices;
+  __Pyx_memviewslice _indptr;
 };
 
 
-/* "View.MemoryView":105
+/* "View.MemoryView":106
  * 
  * @cname("__pyx_array")
  * cdef class array:             # <<<<<<<<<<<<<<
  * 
  *     cdef:
  */
 struct __pyx_array_obj {
@@ -1193,28 +1296,28 @@
   PyObject *_format;
   void (*callback_free_data)(void *);
   int free_data;
   int dtype_is_object;
 };
 
 
-/* "View.MemoryView":279
+/* "View.MemoryView":280
  * 
  * @cname('__pyx_MemviewEnum')
  * cdef class Enum(object):             # <<<<<<<<<<<<<<
  *     cdef object name
  *     def __init__(self, name):
  */
 struct __pyx_MemviewEnum_obj {
   PyObject_HEAD
   PyObject *name;
 };
 
 
-/* "View.MemoryView":330
+/* "View.MemoryView":331
  * 
  * @cname('__pyx_memoryview')
  * cdef class memoryview(object):             # <<<<<<<<<<<<<<
  * 
  *     cdef object obj
  */
 struct __pyx_memoryview_obj {
@@ -1229,15 +1332,15 @@
   Py_buffer view;
   int flags;
   int dtype_is_object;
   __Pyx_TypeInfo *typeinfo;
 };
 
 
-/* "View.MemoryView":961
+/* "View.MemoryView":967
  * 
  * @cname('__pyx_memoryviewslice')
  * cdef class _memoryviewslice(memoryview):             # <<<<<<<<<<<<<<
  *     "Internal class for passing memoryview slices to Python"
  * 
  */
 struct __pyx_memoryviewslice_obj {
@@ -1246,43 +1349,29 @@
   PyObject *from_object;
   PyObject *(*to_object_func)(char *);
   int (*to_dtype_func)(char *, PyObject *);
 };
 
 
 
-/* "tkwant/onebody/kernels.pyx":857
- * 
- * 
- * cdef class Simple(CKernel):             # <<<<<<<<<<<<<<
- *     """A C-implemented kernel using naive CSR matvec."""
- * 
- */
-
-struct __pyx_vtabstruct_6tkwant_7onebody_7kernels_Simple {
-  void (*_rhs)(void const *, __pyx_t_double_complex const *, __pyx_t_double_complex *, double);
-};
-static struct __pyx_vtabstruct_6tkwant_7onebody_7kernels_Simple *__pyx_vtabptr_6tkwant_7onebody_7kernels_Simple;
-
-
-/* "View.MemoryView":105
+/* "View.MemoryView":106
  * 
  * @cname("__pyx_array")
  * cdef class array:             # <<<<<<<<<<<<<<
  * 
  *     cdef:
  */
 
 struct __pyx_vtabstruct_array {
   PyObject *(*get_memview)(struct __pyx_array_obj *);
 };
 static struct __pyx_vtabstruct_array *__pyx_vtabptr_array;
 
 
-/* "View.MemoryView":330
+/* "View.MemoryView":331
  * 
  * @cname('__pyx_memoryview')
  * cdef class memoryview(object):             # <<<<<<<<<<<<<<
  * 
  *     cdef object obj
  */
 
@@ -1294,15 +1383,15 @@
   PyObject *(*setitem_indexed)(struct __pyx_memoryview_obj *, PyObject *, PyObject *);
   PyObject *(*convert_item_to_object)(struct __pyx_memoryview_obj *, char *);
   PyObject *(*assign_item_from_object)(struct __pyx_memoryview_obj *, char *, PyObject *);
 };
 static struct __pyx_vtabstruct_memoryview *__pyx_vtabptr_memoryview;
 
 
-/* "View.MemoryView":961
+/* "View.MemoryView":967
  * 
  * @cname('__pyx_memoryviewslice')
  * cdef class _memoryviewslice(memoryview):             # <<<<<<<<<<<<<<
  *     "Internal class for passing memoryview slices to Python"
  * 
  */
 
@@ -1424,30 +1513,38 @@
 static CYTHON_INLINE void __Pyx_XDEC_MEMVIEW(__Pyx_memviewslice *, int, int);
 
 /* PyFunctionFastCall.proto */
 #if CYTHON_FAST_PYCALL
 #define __Pyx_PyFunction_FastCall(func, args, nargs)\
     __Pyx_PyFunction_FastCallDict((func), (args), (nargs), NULL)
 #if 1 || PY_VERSION_HEX < 0x030600B1
-static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, int nargs, PyObject *kwargs);
+static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs);
 #else
 #define __Pyx_PyFunction_FastCallDict(func, args, nargs, kwargs) _PyFunction_FastCallDict(func, args, nargs, kwargs)
 #endif
 #define __Pyx_BUILD_ASSERT_EXPR(cond)\
     (sizeof(char [1 - 2*!(cond)]) - 1)
 #ifndef Py_MEMBER_SIZE
 #define Py_MEMBER_SIZE(type, member) sizeof(((type *)0)->member)
 #endif
+#if CYTHON_FAST_PYCALL
   static size_t __pyx_pyframe_localsplus_offset = 0;
   #include "frameobject.h"
+#if PY_VERSION_HEX >= 0x030b00a6
+  #ifndef Py_BUILD_CORE
+    #define Py_BUILD_CORE 1
+  #endif
+  #include "internal/pycore_frame.h"
+#endif
   #define __Pxy_PyFrame_Initialize_Offsets()\
     ((void)__Pyx_BUILD_ASSERT_EXPR(sizeof(PyFrameObject) == offsetof(PyFrameObject, f_localsplus) + Py_MEMBER_SIZE(PyFrameObject, f_localsplus)),\
      (void)(__pyx_pyframe_localsplus_offset = ((size_t)PyFrame_Type.tp_basicsize) - Py_MEMBER_SIZE(PyFrameObject, f_localsplus)))
   #define __Pyx_PyFrame_GetLocalsplus(frame)\
     (assert(__pyx_pyframe_localsplus_offset), (PyObject **)(((char *)(frame)) + __pyx_pyframe_localsplus_offset))
+#endif // CYTHON_FAST_PYCALL
 #endif
 
 /* PyObjectCall.proto */
 #if CYTHON_COMPILING_IN_CPYTHON
 static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw);
 #else
 #define __Pyx_PyObject_Call(func, arg, kw) PyObject_Call(func, arg, kw)
@@ -1514,61 +1611,71 @@
 
 /* GetAttr.proto */
 static CYTHON_INLINE PyObject *__Pyx_GetAttr(PyObject *, PyObject *);
 
 /* GetAttr3.proto */
 static CYTHON_INLINE PyObject *__Pyx_GetAttr3(PyObject *, PyObject *, PyObject *);
 
+/* PyDictVersioning.proto */
+#if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
+#define __PYX_DICT_VERSION_INIT  ((PY_UINT64_T) -1)
+#define __PYX_GET_DICT_VERSION(dict)  (((PyDictObject*)(dict))->ma_version_tag)
+#define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)\
+    (version_var) = __PYX_GET_DICT_VERSION(dict);\
+    (cache_var) = (value);
+#define __PYX_PY_DICT_LOOKUP_IF_MODIFIED(VAR, DICT, LOOKUP) {\
+    static PY_UINT64_T __pyx_dict_version = 0;\
+    static PyObject *__pyx_dict_cached_value = NULL;\
+    if (likely(__PYX_GET_DICT_VERSION(DICT) == __pyx_dict_version)) {\
+        (VAR) = __pyx_dict_cached_value;\
+    } else {\
+        (VAR) = __pyx_dict_cached_value = (LOOKUP);\
+        __pyx_dict_version = __PYX_GET_DICT_VERSION(DICT);\
+    }\
+}
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_tp_dict_version(PyObject *obj);
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_object_dict_version(PyObject *obj);
+static CYTHON_INLINE int __Pyx_object_dict_version_matches(PyObject* obj, PY_UINT64_T tp_dict_version, PY_UINT64_T obj_dict_version);
+#else
+#define __PYX_GET_DICT_VERSION(dict)  (0)
+#define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)
+#define __PYX_PY_DICT_LOOKUP_IF_MODIFIED(VAR, DICT, LOOKUP)  (VAR) = (LOOKUP);
+#endif
+
 /* GetModuleGlobalName.proto */
 #if CYTHON_USE_DICT_VERSIONS
-#define __Pyx_GetModuleGlobalName(var, name)  {\
+#define __Pyx_GetModuleGlobalName(var, name)  do {\
     static PY_UINT64_T __pyx_dict_version = 0;\
     static PyObject *__pyx_dict_cached_value = NULL;\
     (var) = (likely(__pyx_dict_version == __PYX_GET_DICT_VERSION(__pyx_d))) ?\
         (likely(__pyx_dict_cached_value) ? __Pyx_NewRef(__pyx_dict_cached_value) : __Pyx_GetBuiltinName(name)) :\
         __Pyx__GetModuleGlobalName(name, &__pyx_dict_version, &__pyx_dict_cached_value);\
-}
-#define __Pyx_GetModuleGlobalNameUncached(var, name)  {\
+} while(0)
+#define __Pyx_GetModuleGlobalNameUncached(var, name)  do {\
     PY_UINT64_T __pyx_dict_version;\
     PyObject *__pyx_dict_cached_value;\
     (var) = __Pyx__GetModuleGlobalName(name, &__pyx_dict_version, &__pyx_dict_cached_value);\
-}
+} while(0)
 static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value);
 #else
 #define __Pyx_GetModuleGlobalName(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
 #define __Pyx_GetModuleGlobalNameUncached(var, name)  (var) = __Pyx__GetModuleGlobalName(name)
 static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name);
 #endif
 
 /* PyCFunctionFastCall.proto */
 #if CYTHON_FAST_PYCCALL
 static CYTHON_INLINE PyObject *__Pyx_PyCFunction_FastCall(PyObject *func, PyObject **args, Py_ssize_t nargs);
 #else
 #define __Pyx_PyCFunction_FastCall(func, args, nargs)  (assert(0), NULL)
 #endif
 
-/* ExtTypeTest.proto */
-static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type);
-
-/* CallableCheck.proto */
-#if CYTHON_USE_TYPE_SLOTS && PY_MAJOR_VERSION >= 3
-#define __Pyx_PyCallable_Check(obj)   ((obj)->ob_type->tp_call != NULL)
-#else
-#define __Pyx_PyCallable_Check(obj)   PyCallable_Check(obj)
-#endif
-
 /* PyObjectCallOneArg.proto */
 static CYTHON_INLINE PyObject* __Pyx_PyObject_CallOneArg(PyObject *func, PyObject *arg);
 
-/* ArgTypeTest.proto */
-#define __Pyx_ArgTypeTest(obj, type, none_allowed, name, exact)\
-    ((likely((Py_TYPE(obj) == type) | (none_allowed && (obj == Py_None)))) ? 1 :\
-        __Pyx__ArgTypeTest(obj, type, name, exact))
-static int __Pyx__ArgTypeTest(PyObject *obj, PyTypeObject *type, const char *name, int exact);
-
 /* PyObjectSetAttrStr.proto */
 #if CYTHON_USE_TYPE_SLOTS
 #define __Pyx_PyObject_DelAttrStr(o,n) __Pyx_PyObject_SetAttrStr(o, n, NULL)
 static CYTHON_INLINE int __Pyx_PyObject_SetAttrStr(PyObject* obj, PyObject* attr_name, PyObject* value);
 #else
 #define __Pyx_PyObject_DelAttrStr(o,n)   PyObject_DelAttr(o,n)
 #define __Pyx_PyObject_SetAttrStr(o,n,v) PyObject_SetAttr(o,n,v)
@@ -1633,54 +1740,61 @@
 #if CYTHON_FAST_THREAD_STATE
 #define __Pyx_ExceptionSwap(type, value, tb)  __Pyx__ExceptionSwap(__pyx_tstate, type, value, tb)
 static CYTHON_INLINE void __Pyx__ExceptionSwap(PyThreadState *tstate, PyObject **type, PyObject **value, PyObject **tb);
 #else
 static CYTHON_INLINE void __Pyx_ExceptionSwap(PyObject **type, PyObject **value, PyObject **tb);
 #endif
 
-/* BufferIndexError.proto */
-static void __Pyx_RaiseBufferIndexError(int axis);
-
-/* PyIntBinop.proto */
-#if !CYTHON_COMPILING_IN_PYPY
-static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, long intval, int inplace);
-#else
-#define __Pyx_PyInt_AddObjC(op1, op2, intval, inplace)\
-    (inplace ? PyNumber_InPlaceAdd(op1, op2) : PyNumber_Add(op1, op2))
-#endif
-
 /* WriteUnraisableException.proto */
 static void __Pyx_WriteUnraisable(const char *name, int clineno,
                                   int lineno, const char *filename,
                                   int full_traceback, int nogil);
 
 /* HasAttr.proto */
 static CYTHON_INLINE int __Pyx_HasAttr(PyObject *, PyObject *);
 
+/* SetItemInt.proto */
+#define __Pyx_SetItemInt(o, i, v, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
+    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
+    __Pyx_SetItemInt_Fast(o, (Py_ssize_t)i, v, is_list, wraparound, boundscheck) :\
+    (is_list ? (PyErr_SetString(PyExc_IndexError, "list assignment index out of range"), -1) :\
+               __Pyx_SetItemInt_Generic(o, to_py_func(i), v)))
+static int __Pyx_SetItemInt_Generic(PyObject *o, PyObject *j, PyObject *v);
+static CYTHON_INLINE int __Pyx_SetItemInt_Fast(PyObject *o, Py_ssize_t i, PyObject *v,
+                                               int is_list, int wraparound, int boundscheck);
+
 /* RaiseTooManyValuesToUnpack.proto */
 static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected);
 
 /* RaiseNeedMoreValuesToUnpack.proto */
 static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index);
 
 /* IterFinish.proto */
 static CYTHON_INLINE int __Pyx_IterFinish(void);
 
 /* UnpackItemEndCheck.proto */
 static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected);
 
+/* PyIntBinop.proto */
+#if !CYTHON_COMPILING_IN_PYPY
+static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, long intval, int inplace, int zerodivision_check);
+#else
+#define __Pyx_PyInt_AddObjC(op1, op2, intval, inplace, zerodivision_check)\
+    (inplace ? PyNumber_InPlaceAdd(op1, op2) : PyNumber_Add(op1, op2))
+#endif
+
 /* ListAppend.proto */
 #if CYTHON_USE_PYLIST_INTERNALS && CYTHON_ASSUME_SAFE_MACROS
 static CYTHON_INLINE int __Pyx_PyList_Append(PyObject* list, PyObject* x) {
     PyListObject* L = (PyListObject*) list;
     Py_ssize_t len = Py_SIZE(list);
     if (likely(L->allocated > len) & likely(len > (L->allocated >> 1))) {
         Py_INCREF(x);
         PyList_SET_ITEM(list, len, x);
-        Py_SIZE(list) = len+1;
+        __Pyx_SET_SIZE(list, len + 1);
         return 0;
     }
     return PyList_Append(list, x);
 }
 #else
 #define __Pyx_PyList_Append(L,x) PyList_Append(L,x)
 #endif
@@ -1688,33 +1802,35 @@
 /* ObjectGetItem.proto */
 #if CYTHON_USE_TYPE_SLOTS
 static CYTHON_INLINE PyObject *__Pyx_PyObject_GetItem(PyObject *obj, PyObject* key);
 #else
 #define __Pyx_PyObject_GetItem(obj, key)  PyObject_GetItem(obj, key)
 #endif
 
-/* SetItemInt.proto */
-#define __Pyx_SetItemInt(o, i, v, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
-    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
-    __Pyx_SetItemInt_Fast(o, (Py_ssize_t)i, v, is_list, wraparound, boundscheck) :\
-    (is_list ? (PyErr_SetString(PyExc_IndexError, "list assignment index out of range"), -1) :\
-               __Pyx_SetItemInt_Generic(o, to_py_func(i), v)))
-static int __Pyx_SetItemInt_Generic(PyObject *o, PyObject *j, PyObject *v);
-static CYTHON_INLINE int __Pyx_SetItemInt_Fast(PyObject *o, Py_ssize_t i, PyObject *v,
-                                               int is_list, int wraparound, int boundscheck);
+/* BufferIndexError.proto */
+static void __Pyx_RaiseBufferIndexError(int axis);
 
-/* None.proto */
-static CYTHON_INLINE void __Pyx_RaiseUnboundLocalError(const char *varname);
+/* PySequenceContains.proto */
+static CYTHON_INLINE int __Pyx_PySequence_ContainsTF(PyObject* item, PyObject* seq, int eq) {
+    int result = PySequence_Contains(seq, item);
+    return unlikely(result < 0) ? result : (result == (eq == Py_EQ));
+}
 
 /* Import.proto */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
 
 /* ImportFrom.proto */
 static PyObject* __Pyx_ImportFrom(PyObject* module, PyObject* name);
 
+/* ArgTypeTest.proto */
+#define __Pyx_ArgTypeTest(obj, type, none_allowed, name, exact)\
+    ((likely((Py_TYPE(obj) == type) | (none_allowed && (obj == Py_None)))) ? 1 :\
+        __Pyx__ArgTypeTest(obj, type, name, exact))
+static int __Pyx__ArgTypeTest(PyObject *obj, PyTypeObject *type, const char *name, int exact);
+
 /* IncludeStringH.proto */
 #include <string.h>
 
 /* BytesEquals.proto */
 static CYTHON_INLINE int __Pyx_PyBytes_Equals(PyObject* s1, PyObject* s2, int equals);
 
 /* UnicodeEquals.proto */
@@ -1723,15 +1839,15 @@
 /* StrEquals.proto */
 #if PY_MAJOR_VERSION >= 3
 #define __Pyx_PyString_Equals __Pyx_PyUnicode_Equals
 #else
 #define __Pyx_PyString_Equals __Pyx_PyBytes_Equals
 #endif
 
-/* None.proto */
+/* DivInt[Py_ssize_t].proto */
 static CYTHON_INLINE Py_ssize_t __Pyx_div_Py_ssize_t(Py_ssize_t, Py_ssize_t);
 
 /* UnaryNegOverflows.proto */
 #define UNARY_NEG_WOULD_OVERFLOW(x)\
         (((x) < 0) & ((unsigned long)(x) == 0-(unsigned long)(x)))
 
 static CYTHON_UNUSED int __pyx_array_getbuffer(PyObject *__pyx_v_self, Py_buffer *__pyx_v_info, int __pyx_v_flags); /*proto*/
@@ -1755,14 +1871,17 @@
          const char* cstring, Py_ssize_t start, Py_ssize_t stop,
          const char* encoding, const char* errors,
          PyObject* (*decode_func)(const char *s, Py_ssize_t size, const char *errors));
 
 /* RaiseNoneIterError.proto */
 static CYTHON_INLINE void __Pyx_RaiseNoneNotIterableError(void);
 
+/* ExtTypeTest.proto */
+static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type);
+
 /* FastTypeChecks.proto */
 #if CYTHON_COMPILING_IN_CPYTHON
 #define __Pyx_TypeCheck(obj, type) __Pyx_IsSubtype(Py_TYPE(obj), (PyTypeObject *)type)
 static CYTHON_INLINE int __Pyx_IsSubtype(PyTypeObject *a, PyTypeObject *b);
 static CYTHON_INLINE int __Pyx_PyErr_GivenExceptionMatches(PyObject *err, PyObject *type);
 static CYTHON_INLINE int __Pyx_PyErr_GivenExceptionMatches2(PyObject *err, PyObject *type1, PyObject *type2);
 #else
@@ -1777,15 +1896,15 @@
 #if CYTHON_USE_PYLIST_INTERNALS && CYTHON_ASSUME_SAFE_MACROS
 static CYTHON_INLINE int __Pyx_ListComp_Append(PyObject* list, PyObject* x) {
     PyListObject* L = (PyListObject*) list;
     Py_ssize_t len = Py_SIZE(list);
     if (likely(L->allocated > len)) {
         Py_INCREF(x);
         PyList_SET_ITEM(list, len, x);
-        Py_SIZE(list) = len+1;
+        __Pyx_SET_SIZE(list, len + 1);
         return 0;
     }
     return PyList_Append(list, x);
 }
 #else
 #define __Pyx_ListComp_Append(L,x) PyList_Append(L,x)
 #endif
@@ -1800,14 +1919,17 @@
     return 0;
 #else
     return PyList_SetSlice(L, PY_SSIZE_T_MAX, PY_SSIZE_T_MAX, v);
 #endif
 }
 
 /* None.proto */
+static CYTHON_INLINE void __Pyx_RaiseUnboundLocalError(const char *varname);
+
+/* DivInt[long].proto */
 static CYTHON_INLINE long __Pyx_div_long(long, long);
 
 /* StringJoin.proto */
 #if PY_MAJOR_VERSION < 3
 #define __Pyx_PyString_Join __Pyx_PyBytes_Join
 #define __Pyx_PyBaseString_Join(s, v) (PyUnicode_CheckExact(s) ? PyUnicode_Join(s, v) : __Pyx_PyBytes_Join(s, v))
 #else
@@ -1849,38 +1971,30 @@
 /* PyObject_GenericGetAttr.proto */
 #if CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP && PY_VERSION_HEX < 0x03070000
 static PyObject* __Pyx_PyObject_GenericGetAttr(PyObject* obj, PyObject* attr_name);
 #else
 #define __Pyx_PyObject_GenericGetAttr PyObject_GenericGetAttr
 #endif
 
+/* PyObjectGetAttrStrNoError.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStrNoError(PyObject* obj, PyObject* attr_name);
+
 /* SetupReduce.proto */
 static int __Pyx_setup_reduce(PyObject* type_obj);
 
 /* SetVTable.proto */
 static int __Pyx_SetVtable(PyObject *dict, void *vtable);
 
-/* TypeImport.proto */
-#ifndef __PYX_HAVE_RT_ImportType_proto
-#define __PYX_HAVE_RT_ImportType_proto
-enum __Pyx_ImportType_CheckSize {
-   __Pyx_ImportType_CheckSize_Error = 0,
-   __Pyx_ImportType_CheckSize_Warn = 1,
-   __Pyx_ImportType_CheckSize_Ignore = 2
-};
-static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, enum __Pyx_ImportType_CheckSize check_size);
-#endif
-
 /* CalculateMetaclass.proto */
 static PyObject *__Pyx_CalculateMetaclass(PyTypeObject *metaclass, PyObject *bases);
 
 /* FetchCommonType.proto */
 static PyTypeObject* __Pyx_FetchCommonType(PyTypeObject* type);
 
-/* CythonFunction.proto */
+/* CythonFunctionShared.proto */
 #define __Pyx_CyFunction_USED 1
 #define __Pyx_CYFUNCTION_STATICMETHOD  0x01
 #define __Pyx_CYFUNCTION_CLASSMETHOD   0x02
 #define __Pyx_CYFUNCTION_CCLASS        0x04
 #define __Pyx_CyFunction_GetClosure(f)\
     (((__pyx_CyFunctionObject *) (f))->func_closure)
 #define __Pyx_CyFunction_GetClassObj(f)\
@@ -1900,25 +2014,24 @@
     PyObject *func_doc;
     PyObject *func_globals;
     PyObject *func_code;
     PyObject *func_closure;
     PyObject *func_classobj;
     void *defaults;
     int defaults_pyobjects;
+    size_t defaults_size;  // used by FusedFunction for copying defaults
     int flags;
     PyObject *defaults_tuple;
     PyObject *defaults_kwdict;
     PyObject *(*defaults_getter)(PyObject *);
     PyObject *func_annotations;
 } __pyx_CyFunctionObject;
 static PyTypeObject *__pyx_CyFunctionType = 0;
 #define __Pyx_CyFunction_Check(obj)  (__Pyx_TypeCheck(obj, __pyx_CyFunctionType))
-#define __Pyx_CyFunction_NewEx(ml, flags, qualname, self, module, globals, code)\
-    __Pyx_CyFunction_New(__pyx_CyFunctionType, ml, flags, qualname, self, module, globals, code)
-static PyObject *__Pyx_CyFunction_New(PyTypeObject *, PyMethodDef *ml,
+static PyObject *__Pyx_CyFunction_Init(__pyx_CyFunctionObject* op, PyMethodDef *ml,
                                       int flags, PyObject* qualname,
                                       PyObject *self,
                                       PyObject *module, PyObject *globals,
                                       PyObject* code);
 static CYTHON_INLINE void *__Pyx_CyFunction_InitDefaults(PyObject *m,
                                                          size_t size,
                                                          int pyobjects);
@@ -1926,14 +2039,21 @@
                                                             PyObject *tuple);
 static CYTHON_INLINE void __Pyx_CyFunction_SetDefaultsKwDict(PyObject *m,
                                                              PyObject *dict);
 static CYTHON_INLINE void __Pyx_CyFunction_SetAnnotationsDict(PyObject *m,
                                                               PyObject *dict);
 static int __pyx_CyFunction_init(void);
 
+/* CythonFunction.proto */
+static PyObject *__Pyx_CyFunction_New(PyMethodDef *ml,
+                                      int flags, PyObject* qualname,
+                                      PyObject *closure,
+                                      PyObject *module, PyObject *globals,
+                                      PyObject* code);
+
 /* SetNameInClass.proto */
 #if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030500A1
 #define __Pyx_SetNameInClass(ns, name, value)\
     (likely(PyDict_CheckExact(ns)) ? _PyDict_SetItem_KnownHash(ns, name, value, ((PyASCIIObject *) name)->hash) : PyObject_SetItem(ns, name, value))
 #elif CYTHON_COMPILING_IN_CPYTHON
 #define __Pyx_SetNameInClass(ns, name, value)\
     (likely(PyDict_CheckExact(ns)) ? PyDict_SetItem(ns, name, value) : PyObject_SetItem(ns, name, value))
@@ -1943,23 +2063,14 @@
 
 /* Py3ClassCreate.proto */
 static PyObject *__Pyx_Py3MetaclassPrepare(PyObject *metaclass, PyObject *bases, PyObject *name, PyObject *qualname,
                                            PyObject *mkw, PyObject *modname, PyObject *doc);
 static PyObject *__Pyx_Py3ClassCreate(PyObject *metaclass, PyObject *name, PyObject *bases, PyObject *dict,
                                       PyObject *mkw, int calculate_metaclass, int allow_py2_metaclass);
 
-/* PyObjectGetMethod.proto */
-static int __Pyx_PyObject_GetMethod(PyObject *obj, PyObject *name, PyObject **method);
-
-/* PyObjectCallMethod1.proto */
-static PyObject* __Pyx_PyObject_CallMethod1(PyObject* obj, PyObject* method_name, PyObject* arg);
-
-/* append.proto */
-static CYTHON_INLINE int __Pyx_PyObject_Append(PyObject* L, PyObject* x);
-
 /* CLineInTraceback.proto */
 #ifdef CYTHON_CLINE_IN_TRACEBACK
 #define __Pyx_CLineForTraceback(tstate, c_line)  (((CYTHON_CLINE_IN_TRACEBACK)) ? c_line : 0)
 #else
 static int __Pyx_CLineForTraceback(PyThreadState *tstate, int c_line);
 #endif
 
@@ -2072,19 +2183,18 @@
 static int __pyx_slices_overlap(__Pyx_memviewslice *slice1,
                                 __Pyx_memviewslice *slice2,
                                 int ndim, size_t itemsize);
 
 /* Capsule.proto */
 static CYTHON_INLINE PyObject *__pyx_capsule_create(void *p, const char *sig);
 
-/* CIntToPy.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value);
-
-/* CIntToPy.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyInt_From_unsigned_int(unsigned int value);
+/* GCCDiagnostics.proto */
+#if defined(__GNUC__) && (__GNUC__ > 4 || (__GNUC__ == 4 && __GNUC_MINOR__ >= 6))
+#define __Pyx_HAS_GCC_DIAGNOSTIC
+#endif
 
 /* IsLittleEndian.proto */
 static CYTHON_INLINE int __Pyx_Is_Little_Endian(void);
 
 /* BufferFormatCheck.proto */
 static const char* __Pyx_BufFmt_CheckString(__Pyx_BufFmt_Context* ctx, const char* ts);
 static void __Pyx_BufFmt_Init(__Pyx_BufFmt_Context* ctx,
@@ -2105,78 +2215,80 @@
                 __Pyx_memviewslice *memviewslice,
                 PyObject *original_obj);
 
 /* ObjectToMemviewSlice.proto */
 static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(PyObject *, int writable_flag);
 
 /* ObjectToMemviewSlice.proto */
-static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex__const__(PyObject *, int writable_flag);
+static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex__const__(PyObject *, int writable_flag);
 
 /* ObjectToMemviewSlice.proto */
-static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex(PyObject *, int writable_flag);
+static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_ds_int(PyObject *, int writable_flag);
 
 /* ObjectToMemviewSlice.proto */
-static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex__const__(PyObject *, int writable_flag);
+static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex__const__(PyObject *, int writable_flag);
+
+/* ObjectToMemviewSlice.proto */
+static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex(PyObject *, int writable_flag);
 
 /* ToPy.proto */
 #define __pyx_PyComplex_FromComplex(z)\
         PyComplex_FromDoubles((double)__Pyx_CREAL(z),\
                               (double)__Pyx_CIMAG(z))
 
+/* MemviewDtypeToObject.proto */
+static CYTHON_INLINE PyObject *__pyx_memview_get___pyx_t_double_complex__const__(const char *itemp);
+
 /* FromPy.proto */
 static __pyx_t_double_complex __Pyx_PyComplex_As___pyx_t_double_complex(PyObject*);
 
 /* MemviewDtypeToObject.proto */
 static CYTHON_INLINE PyObject *__pyx_memview_get___pyx_t_double_complex(const char *itemp);
 static CYTHON_INLINE int __pyx_memview_set___pyx_t_double_complex(const char *itemp, PyObject *obj);
 
-/* CIntToPy.proto */
-static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value);
-
-/* MemviewDtypeToObject.proto */
-static CYTHON_INLINE PyObject *__pyx_memview_get___pyx_t_double_complex__const__(const char *itemp);
-
 /* MemviewSliceCopyTemplate.proto */
 static __Pyx_memviewslice
 __pyx_memoryview_copy_new_contig(const __Pyx_memviewslice *from_mvs,
                                  const char *mode, int ndim,
                                  size_t sizeof_dtype, int contig_flag,
                                  int dtype_is_object);
 
+/* CIntToPy.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value);
+
 /* CIntFromPy.proto */
 static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *);
 
+/* CIntToPy.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_From_unsigned_int(unsigned int value);
+
 /* CIntFromPy.proto */
 static CYTHON_INLINE unsigned int __Pyx_PyInt_As_unsigned_int(PyObject *);
 
 /* TypeInfoToFormat.proto */
 struct __pyx_typeinfo_string {
     char string[3];
 };
 static struct __pyx_typeinfo_string __Pyx_TypeInfoToFormat(__Pyx_TypeInfo *type);
 
 /* CIntFromPy.proto */
 static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *);
 
-/* CIntFromPy.proto */
-static CYTHON_INLINE size_t __Pyx_PyInt_As_size_t(PyObject *);
+/* CIntToPy.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value);
 
 /* CIntFromPy.proto */
 static CYTHON_INLINE char __Pyx_PyInt_As_char(PyObject *);
 
-/* ObjectToMemviewSlice.proto */
-static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_ds_int(PyObject *, int writable_flag);
-
 /* CheckBinaryVersion.proto */
 static int __Pyx_check_binary_version(void);
 
 /* InitStrings.proto */
 static int __Pyx_InitStrings(__Pyx_StringTabEntry *t);
 
-static void __pyx_f_6tkwant_7onebody_7kernels_6Simple__rhs(void const *__pyx_v__self, __pyx_t_double_complex const *__pyx_v_psi, __pyx_t_double_complex *__pyx_v_dpsidt, double __pyx_v_time); /* proto*/
 static PyObject *__pyx_array_get_memview(struct __pyx_array_obj *__pyx_v_self); /* proto*/
 static char *__pyx_memoryview_get_item_pointer(struct __pyx_memoryview_obj *__pyx_v_self, PyObject *__pyx_v_index); /* proto*/
 static PyObject *__pyx_memoryview_is_slice(struct __pyx_memoryview_obj *__pyx_v_self, PyObject *__pyx_v_obj); /* proto*/
 static PyObject *__pyx_memoryview_setitem_slice_assignment(struct __pyx_memoryview_obj *__pyx_v_self, PyObject *__pyx_v_dst, PyObject *__pyx_v_src); /* proto*/
 static PyObject *__pyx_memoryview_setitem_slice_assign_scalar(struct __pyx_memoryview_obj *__pyx_v_self, struct __pyx_memoryview_obj *__pyx_v_dst, PyObject *__pyx_v_value); /* proto*/
 static PyObject *__pyx_memoryview_setitem_indexed(struct __pyx_memoryview_obj *__pyx_v_self, PyObject *__pyx_v_index, PyObject *__pyx_v_value); /* proto*/
 static PyObject *__pyx_memoryview_convert_item_to_object(struct __pyx_memoryview_obj *__pyx_v_self, char *__pyx_v_itemp); /* proto*/
@@ -2185,54 +2297,37 @@
 static PyObject *__pyx_memoryviewslice_assign_item_from_object(struct __pyx_memoryviewslice_obj *__pyx_v_self, char *__pyx_v_itemp, PyObject *__pyx_v_value); /* proto*/
 
 /* Module declarations from 'cython.view' */
 static struct __pyx_array_obj *__pyx_array_new(PyObject *, Py_ssize_t, char *, char *, char *); /*proto*/
 
 /* Module declarations from 'cython' */
 
-/* Module declarations from 'libc.string' */
-
-/* Module declarations from 'libc.stdio' */
-
-/* Module declarations from '__builtin__' */
-
-/* Module declarations from 'cpython.type' */
-static PyTypeObject *__pyx_ptype_7cpython_4type_type = 0;
-
-/* Module declarations from 'cpython' */
-
-/* Module declarations from 'cpython.object' */
-
-/* Module declarations from 'cpython.ref' */
-
 /* Module declarations from 'tkwant.onebody.kernels' */
 static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels_Kernel = 0;
-static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels_CKernel = 0;
-static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels_PyCKernel = 0;
+static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels_Interpolation = 0;
 static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels_PerturbationExtractor = 0;
 static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels_PerturbationInterpolator = 0;
-static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels__CSRMatrix = 0;
 static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels_Simple = 0;
+static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels__CalcRHSc = 0;
 static PyTypeObject *__pyx_array_type = 0;
 static PyTypeObject *__pyx_MemviewEnum_type = 0;
 static PyTypeObject *__pyx_memoryview_type = 0;
 static PyTypeObject *__pyx_memoryviewslice_type = 0;
 static PyObject *generic = 0;
 static PyObject *strided = 0;
 static PyObject *indirect = 0;
 static PyObject *contiguous = 0;
 static PyObject *indirect_contiguous = 0;
 static int __pyx_memoryview_thread_locks_used;
 static PyThread_type_lock __pyx_memoryview_thread_locks[8];
-static void __pyx_f_6tkwant_7onebody_7kernels__wrapped_rhs(void const *, __pyx_t_double_complex const *, __pyx_t_double_complex *, double); /*proto*/
-static struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *__pyx_f_6tkwant_7onebody_7kernels_extract_c_kernel(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *, int __pyx_skip_dispatch); /*proto*/
 static __pyx_ctuple_double__and_double__and_double__and_double__and_double __pyx_f_6tkwant_7onebody_7kernels_update_times(double, double, double); /*proto*/
 static __pyx_ctuple_double__and_double__and_double__and_double __pyx_f_6tkwant_7onebody_7kernels__get_polynome_coeffs(double, double, double, double); /*proto*/
-static PyObject *__pyx_f_6tkwant_7onebody_7kernels__csr_spmv(struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *, __pyx_t_double_complex const *, __pyx_t_double_complex *); /*proto*/
+static PyObject *__pyx_f_6tkwant_7onebody_7kernels__csr_spmv_ptr(int const , int const *, int const *, __pyx_t_double_complex const *, __pyx_t_double_complex const *, __pyx_t_double_complex *); /*proto*/
 static PyObject *__pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_Kernel__set_state(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *, PyObject *); /*proto*/
+static PyObject *__pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_Interpolation__set_state(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *, PyObject *); /*proto*/
 static PyObject *__pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_PerturbationExtractor__set_state(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *, PyObject *); /*proto*/
 static PyObject *__pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_PerturbationInterpolator__set_state(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *, PyObject *); /*proto*/
 static struct __pyx_array_obj *__pyx_array_new(PyObject *, Py_ssize_t, char *, char *, char *); /*proto*/
 static void *__pyx_align_pointer(void *, size_t); /*proto*/
 static PyObject *__pyx_memoryview_new(PyObject *, int, int, __Pyx_TypeInfo *); /*proto*/
 static CYTHON_INLINE int __pyx_memoryview_check(PyObject *); /*proto*/
 static PyObject *_unellipsify(PyObject *, int); /*proto*/
@@ -2269,186 +2364,202 @@
 static __Pyx_TypeInfo __Pyx_TypeInfo___pyx_t_double_complex__const__ = { "const double complex", NULL, sizeof(__pyx_t_double_complex const ), { 0 }, 0, 'C', 0, 0 };
 static __Pyx_TypeInfo __Pyx_TypeInfo_int = { "int", NULL, sizeof(int), { 0 }, 0, IS_UNSIGNED(int) ? 'U' : 'I', IS_UNSIGNED(int), 0 };
 #define __Pyx_MODULE_NAME "tkwant.onebody.kernels"
 extern int __pyx_module_is_main_tkwant__onebody__kernels;
 int __pyx_module_is_main_tkwant__onebody__kernels = 0;
 
 /* Implementation of 'tkwant.onebody.kernels' */
-static PyObject *__pyx_builtin_ImportError;
 static PyObject *__pyx_builtin_NotImplementedError;
-static PyObject *__pyx_builtin_TypeError;
-static PyObject *__pyx_builtin_range;
 static PyObject *__pyx_builtin_ValueError;
+static PyObject *__pyx_builtin_range;
 static PyObject *__pyx_builtin_round;
 static PyObject *__pyx_builtin_enumerate;
+static PyObject *__pyx_builtin_TypeError;
 static PyObject *__pyx_builtin_MemoryError;
 static PyObject *__pyx_builtin_Ellipsis;
 static PyObject *__pyx_builtin_id;
 static PyObject *__pyx_builtin_IndexError;
 static const char __pyx_k_O[] = "O";
 static const char __pyx_k_T[] = "T{";
   static const char __pyx_k_W[] = "W";
   static const char __pyx_k_c[] = "c";
-  static const char __pyx_k_e[] = "e";
   static const char __pyx_k_i[] = "i";
   static const char __pyx_k_s[] = "(%s)";
   static const char __pyx_k_H0[] = "H0";
   static const char __pyx_k_dt[] = "dt";
   static const char __pyx_k_id[] = "id";
   static const char __pyx_k_np[] = "np";
   static const char __pyx_k_sp[] = "sp";
+  static const char __pyx_k_t0[] = "t0";
   static const char __pyx_k_Ket[] = "Ket";
-  static const char __pyx_k__31[] = "^";
-  static const char __pyx_k__32[] = "";
-  static const char __pyx_k__33[] = ":";
-static const char __pyx_k__34[] = "}";
-static const char __pyx_k__35[] = ",";
-static const char __pyx_k__36[] = "*";
+  static const char __pyx_k__32[] = "^";
+  static const char __pyx_k__33[] = "";
+  static const char __pyx_k__34[] = ":";
+static const char __pyx_k__35[] = "}";
+static const char __pyx_k__36[] = ",";
+static const char __pyx_k__37[] = "*";
+static const char __pyx_k_abs[] = "abs";
 static const char __pyx_k_all[] = "__all__";
 static const char __pyx_k_col[] = "col";
+static const char __pyx_k_csr[] = "csr";
 static const char __pyx_k_doc[] = "__doc__";
 static const char __pyx_k_dot[] = "dot";
+static const char __pyx_k_eye[] = "eye";
+static const char __pyx_k_fac[] = "fac";
 static const char __pyx_k_ket[] = "ket";
-static const char __pyx_k_mat[] = "mat";
+static const char __pyx_k_max[] = "max";
 static const char __pyx_k_new[] = "__new__";
 static const char __pyx_k_nnz[] = "nnz";
 static const char __pyx_k_obj[] = "obj";
 static const char __pyx_k_out[] = "out";
 static const char __pyx_k_psi[] = "psi";
 static const char __pyx_k_rhs[] = "rhs";
 static const char __pyx_k_row[] = "row";
 static const char __pyx_k_tmp[] = "_tmp";
+static const char __pyx_k_atol[] = "atol";
 static const char __pyx_k_base[] = "base";
+static const char __pyx_k_call[] = "__call__";
 static const char __pyx_k_data[] = "data";
 static const char __pyx_k_dict[] = "__dict__";
+static const char __pyx_k_eval[] = "eval";
+static const char __pyx_k_func[] = "func";
 static const char __pyx_k_init[] = "__init__";
 static const char __pyx_k_join[] = "join";
 static const char __pyx_k_main[] = "__main__";
 static const char __pyx_k_mode[] = "mode";
 static const char __pyx_k_name[] = "name";
 static const char __pyx_k_ndim[] = "ndim";
 static const char __pyx_k_pack[] = "pack";
+static const char __pyx_k_rtol[] = "rtol";
 static const char __pyx_k_self[] = "self";
 static const char __pyx_k_size[] = "size";
 static const char __pyx_k_step[] = "step";
 static const char __pyx_k_stop[] = "stop";
 static const char __pyx_k_syst[] = "syst";
+static const char __pyx_k_temp[] = "temp";
 static const char __pyx_k_test[] = "__test__";
 static const char __pyx_k_time[] = "time";
+static const char __pyx_k_work[] = "work";
 static const char __pyx_k_ASCII[] = "ASCII";
 static const char __pyx_k_Scipy[] = "Scipy";
 static const char __pyx_k_apply[] = "apply";
 static const char __pyx_k_class[] = "__class__";
 static const char __pyx_k_dtype[] = "dtype";
 static const char __pyx_k_empty[] = "empty";
 static const char __pyx_k_error[] = "error";
 static const char __pyx_k_exept[] = "exept";
 static const char __pyx_k_flags[] = "flags";
 static const char __pyx_k_graph[] = "graph";
 static const char __pyx_k_int32[] = "int32";
 static const char __pyx_k_numpy[] = "numpy";
 static const char __pyx_k_range[] = "range";
 static const char __pyx_k_round[] = "round";
+static const char __pyx_k_set_W[] = "set_W";
 static const char __pyx_k_shape[] = "shape";
 static const char __pyx_k_start[] = "start";
 static const char __pyx_k_tmp_2[] = "tmp";
 static const char __pyx_k_tocsr[] = "tocsr";
 static const char __pyx_k_value[] = "value";
 static const char __pyx_k_zeros[] = "zeros";
 static const char __pyx_k_Kernel[] = "Kernel";
 static const char __pyx_k_Simple[] = "Simple";
-static const char __pyx_k_append[] = "append";
 static const char __pyx_k_common[] = "_common";
 static const char __pyx_k_dpsidt[] = "dpsidt";
+static const char __pyx_k_dt_min[] = "dt_min";
 static const char __pyx_k_encode[] = "encode";
+static const char __pyx_k_energy[] = "energy";
+static const char __pyx_k_facmax[] = "facmax";
+static const char __pyx_k_facmin[] = "facmin";
 static const char __pyx_k_format[] = "format";
 static const char __pyx_k_import[] = "__import__";
 static const char __pyx_k_indptr[] = "indptr";
+static const char __pyx_k_logger[] = "logger";
 static const char __pyx_k_module[] = "__module__";
 static const char __pyx_k_name_2[] = "__name__";
-static const char __pyx_k_nevals[] = "nevals";
 static const char __pyx_k_output[] = "output";
 static const char __pyx_k_params[] = "params";
 static const char __pyx_k_pickle[] = "pickle";
 static const char __pyx_k_psi_st[] = "psi_st";
 static const char __pyx_k_reduce[] = "__reduce__";
 static const char __pyx_k_struct[] = "struct";
 static const char __pyx_k_system[] = "system";
 static const char __pyx_k_unpack[] = "unpack";
 static const char __pyx_k_update[] = "update";
-static const char __pyx_k_CKernel[] = "CKernel";
+static const char __pyx_k_CalcRHS[] = "_CalcRHS";
 static const char __pyx_k_asarray[] = "asarray";
-static const char __pyx_k_complex[] = "complex";
 static const char __pyx_k_default[] = "default";
+static const char __pyx_k_dt_init[] = "dt_init";
 static const char __pyx_k_flatten[] = "flatten";
 static const char __pyx_k_fortran[] = "fortran";
 static const char __pyx_k_indices[] = "indices";
-static const char __pyx_k_isclose[] = "isclose";
+static const char __pyx_k_logging[] = "_logging";
 static const char __pyx_k_memview[] = "memview";
 static const char __pyx_k_onsites[] = "onsites";
 static const char __pyx_k_prepare[] = "__prepare__";
 static const char __pyx_k_row_col[] = "row_col";
+static const char __pyx_k_warning[] = "warning";
+static const char __pyx_k_CalcRHSc[] = "_CalcRHSc";
 static const char __pyx_k_Ellipsis[] = "Ellipsis";
 static const char __pyx_k_errormsg[] = "_errormsg";
 static const char __pyx_k_evaluate[] = "evaluate";
 static const char __pyx_k_getstate[] = "__getstate__";
 static const char __pyx_k_hoppings[] = "hoppings";
 static const char __pyx_k_itemsize[] = "itemsize";
 static const char __pyx_k_pyx_type[] = "__pyx_type";
 static const char __pyx_k_qualname[] = "__qualname__";
 static const char __pyx_k_setstate[] = "__setstate__";
-static const char __pyx_k_CSRMatrix[] = "_CSRMatrix";
-static const char __pyx_k_PyCKernel[] = "PyCKernel";
 static const char __pyx_k_Scipy_rhs[] = "Scipy.rhs";
 static const char __pyx_k_TypeError[] = "TypeError";
 static const char __pyx_k_conjugate[] = "conjugate";
 static const char __pyx_k_enumerate[] = "enumerate";
 static const char __pyx_k_herm_conj[] = "_herm_conj";
 static const char __pyx_k_metaclass[] = "__metaclass__";
 static const char __pyx_k_orb_range[] = "orb_range";
-static const char __pyx_k_py_kernel[] = "py_kernel";
 static const char __pyx_k_pyx_state[] = "__pyx_state";
 static const char __pyx_k_reduce_ex[] = "__reduce_ex__";
 static const char __pyx_k_time_name[] = "time_name";
 static const char __pyx_k_transpose[] = "transpose";
 static const char __pyx_k_IndexError[] = "IndexError";
-static const char __pyx_k_SparseBlas[] = "SparseBlas";
 static const char __pyx_k_ValueError[] = "ValueError";
 static const char __pyx_k_coo_matrix[] = "coo_matrix";
 static const char __pyx_k_coo_matvec[] = "coo_matvec";
+static const char __pyx_k_csr_matrix[] = "csr_matrix";
 static const char __pyx_k_csr_matvec[] = "csr_matvec";
 static const char __pyx_k_output_dat[] = "output.dat";
 static const char __pyx_k_psi_centre[] = "psi_centre";
 static const char __pyx_k_pyx_result[] = "__pyx_result";
 static const char __pyx_k_pyx_vtable[] = "__pyx_vtable__";
-static const char __pyx_k_set_params[] = "set_params";
 static const char __pyx_k_time_start[] = "time_start";
-static const char __pyx_k_ImportError[] = "ImportError";
 static const char __pyx_k_MemoryError[] = "MemoryError";
 static const char __pyx_k_PickleError[] = "PickleError";
+static const char __pyx_k_Scipy_set_W[] = "Scipy.set_W";
 static const char __pyx_k_center_size[] = "center_size";
 static const char __pyx_k_hamiltonian[] = "hamiltonian";
+static const char __pyx_k_make_logger[] = "make_logger";
 static const char __pyx_k_site_ranges[] = "site_ranges";
 static const char __pyx_k_Scipy___init[] = "Scipy.__init__";
 static const char __pyx_k_pyx_checksum[] = "__pyx_checksum";
 static const char __pyx_k_scipy_sparse[] = "scipy.sparse";
 static const char __pyx_k_stringsource[] = "stringsource";
+static const char __pyx_k_Interpolation[] = "Interpolation";
 static const char __pyx_k_pyx_getbuffer[] = "__pyx_getbuffer";
 static const char __pyx_k_reduce_cython[] = "__reduce_cython__";
+static const char __pyx_k_CalcRHS___call[] = "_CalcRHS.__call__";
+static const char __pyx_k_CalcRHS___init[] = "_CalcRHS.__init__";
+static const char __pyx_k_estimate_error[] = "_estimate_error";
 static const char __pyx_k_View_MemoryView[] = "View.MemoryView";
 static const char __pyx_k_allocate_buffer[] = "allocate_buffer";
 static const char __pyx_k_dtype_is_object[] = "dtype_is_object";
 static const char __pyx_k_pyx_PickleError[] = "__pyx_PickleError";
 static const char __pyx_k_setstate_cython[] = "__setstate_cython__";
-static const char __pyx_k_Scipy_set_params[] = "Scipy.set_params";
-static const char __pyx_k_extract_c_kernel[] = "extract_c_kernel";
+static const char __pyx_k_estimate_stepsize[] = "_estimate_stepsize";
 static const char __pyx_k_pyx_unpickle_Enum[] = "__pyx_unpickle_Enum";
 static const char __pyx_k_add_time_to_params[] = "add_time_to_params";
 static const char __pyx_k_cline_in_traceback[] = "cline_in_traceback";
-static const char __pyx_k_sparse_blas_kernel[] = "_sparse_blas_kernel";
+static const char __pyx_k_interpolation_type[] = "interpolation_type";
 static const char __pyx_k_strided_and_direct[] = "<strided and direct>";
 static const char __pyx_k_NotImplementedError[] = "NotImplementedError";
 static const char __pyx_k_pyx_unpickle_Kernel[] = "__pyx_unpickle_Kernel";
 static const char __pyx_k_strided_and_indirect[] = "<strided and indirect>";
 static const char __pyx_k_PerturbationExtractor[] = "PerturbationExtractor";
 static const char __pyx_k_contiguous_and_direct[] = "<contiguous and direct>";
 static const char __pyx_k_MemoryView_of_r_object[] = "<MemoryView of %r object>";
@@ -2456,178 +2567,195 @@
 static const char __pyx_k_MemoryView_of_r_at_0x_x[] = "<MemoryView of %r at 0x%x>";
 static const char __pyx_k_contiguous_and_indirect[] = "<contiguous and indirect>";
 static const char __pyx_k_Cannot_index_with_type_s[] = "Cannot index with type '%s'";
 static const char __pyx_k_PerturbationInterpolator[] = "PerturbationInterpolator";
 static const char __pyx_k_Invalid_shape_in_axis_d_d[] = "Invalid shape in axis %d: %d.";
 static const char __pyx_k_scipy_sparse__sparsetools[] = "scipy.sparse._sparsetools";
 static const char __pyx_k_is_time_dependent_function[] = "is_time_dependent_function";
+static const char __pyx_k_pyx_unpickle_Interpolation[] = "__pyx_unpickle_Interpolation";
 static const char __pyx_k_tkwant_onebody_kernels_pyx[] = "tkwant/onebody/kernels.pyx";
 static const char __pyx_k_itemsize_0_for_cython_array[] = "itemsize <= 0 for cython.array";
-static const char __pyx_k_Kernel_must_have_a_rhs_method[] = "Kernel must have a `rhs` method.";
 static const char __pyx_k_unable_to_allocate_array_data[] = "unable to allocate array data.";
 static const char __pyx_k_pyx_unpickle_PerturbationExtra[] = "__pyx_unpickle_PerturbationExtractor";
 static const char __pyx_k_pyx_unpickle_PerturbationInter[] = "__pyx_unpickle_PerturbationInterpolator";
 static const char __pyx_k_strided_and_direct_or_indirect[] = "<strided and direct or indirect>";
 static const char __pyx_k_0_vector_has_length_1_but_the_s[] = "{0} vector has length {1}, but the system contains {2} orbitals";
 static const char __pyx_k_Calculating_the_right_hand_side[] = "Calculating the right-hand side of the time-dependent Schr\303\266dinger equation.\n\nThis module is mainly for internal use.\n\nThe classes in this module are used for calculating the following expression:\n\n    ..math:: -i(H_0 \317\210 + W(t) \317\210)\n\nwhere :math:`H_0` is the time-independent part of the Hamiltonian,\n:math:`W(t)` is the time-dependent part, and :math:`\317\210` is some vector\ndefined over the Hilbert space of the problem. We recognise this expression\nas the right-hand side of the time-dependent Schr\303\266dinger equation (TDSE),\nwhere the left-hand side is :math:`\342\210\202\317\210/\342\210\202t`.\n\nIn practice we will want to handle many different cases, including solving the\nTDSE on infinite domains, or starting the evolution from an eigenstate.  All\nthe forms of TDSE that we will need to handle these cases are encompassed by\nthe above formula. This module is only concerned with calculating expressions\nof the above form, not performing the mapping from the various problems. For\nmore details on the mapping, see `tkwant/onebody/solver.py`.\n";
-static const char __pyx_k_time_t_must_be_greater_equal_t0[] = "time t={} must be greater equal t0={}";
 static const char __pyx_k_Buffer_view_does_not_expose_stri[] = "Buffer view does not expose strides";
+static const char __pyx_k_Calculate_the_right_hand_side_of[] = "Calculate the right-hand-side of the time-dependent Schr\303\266dinger equation.";
 static const char __pyx_k_Can_only_create_a_buffer_that_is[] = "Can only create a buffer that is contiguous in memory.";
 static const char __pyx_k_Cannot_assign_to_read_only_memor[] = "Cannot assign to read-only memoryview";
 static const char __pyx_k_Cannot_create_writable_memory_vi[] = "Cannot create writable memory view from read-only memoryview";
 static const char __pyx_k_Empty_shape_tuple_for_cython_arr[] = "Empty shape tuple for cython.array";
-static const char __pyx_k_Evaluate_the_RHS_of_the_Schrding[] = "Evaluate the RHS of the Schr\303\266dinger equation using scipy sparse.\n\n    Parameters\n    ----------\n    H0 : `scipy.sparse.base`\n        Hamiltonian at ``t=0`` (including any boundary conditions).\n    W : callable\n        Time-dependent part of the Hamiltonian. Typically the object returned\n        by `tkwant.system.extract_perturbation`.\n    params : dict\n        Extra arguments to pass to the system Hamiltonian excluding time.\n    psi_st : array of complex, optional\n        The wavefunction of the initial eigenstate defined over the central\n        system (if starting in an initial eigenstate).\n\n    Attributes\n    ----------\n    H0 : `scipy.sparse.csr_matrix`\n        Hamiltonian at ``t=0`` (including any boundary conditions).\n    W : callable\n        Time-dependent part of the Hamiltonian. Typically the object returned\n        by `tkwant.system.extract_perturbation`.\n    params : dict\n        Extra arguments to pass to the system Hamiltonian excluding the ``time``\n        argument.\n    psi_st : array of complex or `None`\n        The wavefunction of the initial eigenstate defined over the central\n        system (if starting in an initial eigenstate).\n    size : int\n        The size of the time-independent part of the Hamiltonian. This\n        also sets the size of the solution vector.\n    nevals : int\n        The number of times this kernel has been evaluated since its creation.\n    ";
-static const char __pyx_k_Incompatible_checksums_s_vs_0x1a[] = "Incompatible checksums (%s vs 0x1aa04ed = (Ht0, Ht1, Ht2, Ht3, Ht4, _do_update, d2Ht0, d2Ht1, d2Ht2, d2y0, d2y1, dt, nnz, size, t0, t1, t2, t3, t4, time_name, time_start, tterms, wfunc, wt, x0, x1, y0, y1))";
-static const char __pyx_k_Incompatible_checksums_s_vs_0x26[] = "Incompatible checksums (%s vs 0x26d3271 = (H, nnz, size, td_hamiltonian, time_name, tparams))";
-static const char __pyx_k_Incompatible_checksums_s_vs_0x4d[] = "Incompatible checksums (%s vs 0x4d5deb3 = (nevals, size))";
-static const char __pyx_k_Incompatible_checksums_s_vs_0xb0[] = "Incompatible checksums (%s vs 0xb068931 = (name))";
+static const char __pyx_k_Evaluate_the_RHS_of_the_Schrding[] = "Evaluate the RHS of the Schr\303\266dinger equation using scipy sparse.\n\n    Parameters\n    ----------\n    H0 : `scipy.sparse.base`\n        Hamiltonian at ``t=0`` (including any boundary conditions).\n    W : callable\n        Time-dependent part of the Hamiltonian. Typically the object returned\n        by `tkwant.system.extract_perturbation`.\n    psi_st : array of complex, optional\n        The wavefunction of the initial eigenstate defined over the central\n        system (if starting in an initial eigenstate).\n    work : `~numpy.ndarray` of complex, optional\n        Workarray of size ``H0.shape[0]`` for performance and memory optimization.\n\n    Attributes\n    ----------\n    H0 : `scipy.sparse.csr_matrix`\n        Hamiltonian at ``t=0`` (including any boundary conditions).\n    W : callable\n        Time-dependent part of the Hamiltonian. Typically the object returned\n        by `tkwant.system.extract_perturbation`.\n    psi_st : array of complex or `None`\n        The wavefunction of the initial eigenstate defined over the central\n        system (if starting in an initial eigenstate).\n    ";
+static const char __pyx_k_Incompatible_checksums_0x_x_vs_0[] = "Incompatible checksums (0x%x vs (0x4d5deb3, 0x498303b, 0x82e3adb) = (nevals, size))";
 static const char __pyx_k_Indirect_dimensions_not_supporte[] = "Indirect dimensions not supported";
 static const char __pyx_k_Invalid_mode_expected_c_or_fortr[] = "Invalid mode, expected 'c' or 'fortran', got %s";
 static const char __pyx_k_Out_of_bounds_on_buffer_access_a[] = "Out of bounds on buffer access (axis %d)";
 static const char __pyx_k_Unable_to_convert_item_to_object[] = "Unable to convert item to object";
 static const char __pyx_k_got_differing_extents_in_dimensi[] = "got differing extents in dimension %d (got %d and %d)";
+static const char __pyx_k_minimal_W_t_stepsize_dt_min_reac[] = "minimal W(t) stepsize dt_min={} reached.";
 static const char __pyx_k_no_default___reduce___due_to_non[] = "no default __reduce__ due to non-trivial __cinit__";
-static const char __pyx_k_self_c_rhs_self_c_self_cannot_be[] = "self.c_rhs,self.c_self cannot be converted to a Python object for pickling";
 static const char __pyx_k_unable_to_allocate_shape_and_str[] = "unable to allocate shape and strides.";
+static const char __pyx_k_use_the_scipy_kernel_for_seriali[] = "use the scipy kernel for serialization";
+static const char __pyx_k_work_array_size_must_be_at_least[] = "work array size={} must be at least the size of the central system={}";
+static const char __pyx_k_Incompatible_checksums_0x_x_vs_0_2[] = "Incompatible checksums (0x%x vs (0xa494bc0, 0x30fa593, 0x3e8e3df) = (Ht0, Ht1, Ht2, Ht3, Ht4, atol, d2Ht0, d2Ht1, d2Ht2, dt, dt_min, fac, facmax, facmin, func, nnz, rtol, t0, t1, t2, t3, t4))";
+static const char __pyx_k_Incompatible_checksums_0x_x_vs_0_3[] = "Incompatible checksums (0x%x vs (0x26d3271, 0xb233ad0, 0x66ecb55) = (H, nnz, size, td_hamiltonian, time_name, tparams))";
+static const char __pyx_k_Incompatible_checksums_0x_x_vs_0_4[] = "Incompatible checksums (0x%x vs (0x2ce0fe7, 0xd117aad, 0x95d9714) = (dt, intfunc, nnz, size, wfunc, wt))";
+static const char __pyx_k_Incompatible_checksums_0x_x_vs_0_5[] = "Incompatible checksums (0x%x vs (0xb068931, 0x82a3537, 0x6ae9995) = (name))";
 static PyObject *__pyx_kp_u_0_vector_has_length_1_but_the_s;
 static PyObject *__pyx_n_s_ASCII;
 static PyObject *__pyx_kp_s_Buffer_view_does_not_expose_stri;
-static PyObject *__pyx_n_s_CKernel;
-static PyObject *__pyx_n_u_CKernel;
-static PyObject *__pyx_n_s_CSRMatrix;
+static PyObject *__pyx_n_s_CalcRHS;
+static PyObject *__pyx_n_s_CalcRHS___call;
+static PyObject *__pyx_n_s_CalcRHS___init;
+static PyObject *__pyx_n_s_CalcRHSc;
+static PyObject *__pyx_kp_s_Calculate_the_right_hand_side_of;
 static PyObject *__pyx_kp_s_Can_only_create_a_buffer_that_is;
 static PyObject *__pyx_kp_s_Cannot_assign_to_read_only_memor;
 static PyObject *__pyx_kp_s_Cannot_create_writable_memory_vi;
 static PyObject *__pyx_kp_s_Cannot_index_with_type_s;
 static PyObject *__pyx_n_s_Ellipsis;
 static PyObject *__pyx_kp_s_Empty_shape_tuple_for_cython_arr;
 static PyObject *__pyx_kp_s_Evaluate_the_RHS_of_the_Schrding;
 static PyObject *__pyx_n_s_H0;
-static PyObject *__pyx_n_s_ImportError;
-static PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0x1a;
-static PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0x26;
-static PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0x4d;
-static PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0xb0;
+static PyObject *__pyx_kp_s_Incompatible_checksums_0x_x_vs_0;
+static PyObject *__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_2;
+static PyObject *__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_3;
+static PyObject *__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_4;
+static PyObject *__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_5;
 static PyObject *__pyx_n_s_IndexError;
 static PyObject *__pyx_kp_s_Indirect_dimensions_not_supporte;
+static PyObject *__pyx_n_s_Interpolation;
 static PyObject *__pyx_kp_s_Invalid_mode_expected_c_or_fortr;
 static PyObject *__pyx_kp_s_Invalid_shape_in_axis_d_d;
 static PyObject *__pyx_n_s_Kernel;
 static PyObject *__pyx_n_u_Kernel;
-static PyObject *__pyx_kp_u_Kernel_must_have_a_rhs_method;
 static PyObject *__pyx_n_u_Ket;
 static PyObject *__pyx_n_s_MemoryError;
 static PyObject *__pyx_kp_s_MemoryView_of_r_at_0x_x;
 static PyObject *__pyx_kp_s_MemoryView_of_r_object;
 static PyObject *__pyx_n_s_NotImplementedError;
 static PyObject *__pyx_n_b_O;
 static PyObject *__pyx_kp_s_Out_of_bounds_on_buffer_access_a;
 static PyObject *__pyx_n_s_PerturbationExtractor;
 static PyObject *__pyx_n_u_PerturbationExtractor;
 static PyObject *__pyx_n_s_PerturbationInterpolator;
 static PyObject *__pyx_n_u_PerturbationInterpolator;
 static PyObject *__pyx_n_s_PickleError;
-static PyObject *__pyx_n_s_PyCKernel;
 static PyObject *__pyx_n_s_Scipy;
 static PyObject *__pyx_n_u_Scipy;
 static PyObject *__pyx_n_s_Scipy___init;
 static PyObject *__pyx_n_s_Scipy_rhs;
-static PyObject *__pyx_n_s_Scipy_set_params;
+static PyObject *__pyx_n_s_Scipy_set_W;
 static PyObject *__pyx_n_s_Simple;
 static PyObject *__pyx_n_u_Simple;
-static PyObject *__pyx_n_s_SparseBlas;
-static PyObject *__pyx_n_u_SparseBlas;
 static PyObject *__pyx_kp_b_T;
 static PyObject *__pyx_n_s_TypeError;
 static PyObject *__pyx_kp_s_Unable_to_convert_item_to_object;
 static PyObject *__pyx_n_s_ValueError;
 static PyObject *__pyx_n_s_View_MemoryView;
 static PyObject *__pyx_n_s_W;
-static PyObject *__pyx_kp_b__31;
-static PyObject *__pyx_n_s__32;
 static PyObject *__pyx_kp_b__32;
+static PyObject *__pyx_n_s__33;
 static PyObject *__pyx_kp_b__33;
 static PyObject *__pyx_kp_b__34;
-static PyObject *__pyx_kp_u__35;
-static PyObject *__pyx_n_s__36;
+static PyObject *__pyx_kp_b__35;
+static PyObject *__pyx_kp_u__36;
+static PyObject *__pyx_n_s__37;
+static PyObject *__pyx_n_s_abs;
 static PyObject *__pyx_n_s_add_time_to_params;
 static PyObject *__pyx_n_s_all;
 static PyObject *__pyx_n_s_allocate_buffer;
-static PyObject *__pyx_n_s_append;
 static PyObject *__pyx_n_s_apply;
 static PyObject *__pyx_n_s_asarray;
+static PyObject *__pyx_n_s_atol;
 static PyObject *__pyx_n_s_base;
 static PyObject *__pyx_n_s_c;
 static PyObject *__pyx_n_u_c;
+static PyObject *__pyx_n_s_call;
 static PyObject *__pyx_n_s_center_size;
 static PyObject *__pyx_n_s_class;
 static PyObject *__pyx_n_s_cline_in_traceback;
 static PyObject *__pyx_n_s_col;
 static PyObject *__pyx_n_s_common;
-static PyObject *__pyx_n_s_complex;
 static PyObject *__pyx_n_s_conjugate;
 static PyObject *__pyx_n_u_conjugate;
 static PyObject *__pyx_kp_s_contiguous_and_direct;
 static PyObject *__pyx_kp_s_contiguous_and_indirect;
 static PyObject *__pyx_n_s_coo_matrix;
 static PyObject *__pyx_n_s_coo_matvec;
+static PyObject *__pyx_n_s_csr;
+static PyObject *__pyx_n_s_csr_matrix;
 static PyObject *__pyx_n_s_csr_matvec;
 static PyObject *__pyx_n_s_data;
 static PyObject *__pyx_n_s_default;
 static PyObject *__pyx_n_u_default;
 static PyObject *__pyx_n_s_dict;
 static PyObject *__pyx_n_s_doc;
 static PyObject *__pyx_n_s_dot;
 static PyObject *__pyx_n_s_dpsidt;
 static PyObject *__pyx_n_s_dt;
+static PyObject *__pyx_n_s_dt_init;
+static PyObject *__pyx_n_s_dt_min;
 static PyObject *__pyx_n_s_dtype;
 static PyObject *__pyx_n_s_dtype_is_object;
-static PyObject *__pyx_n_s_e;
 static PyObject *__pyx_n_s_empty;
 static PyObject *__pyx_n_s_encode;
+static PyObject *__pyx_n_s_energy;
 static PyObject *__pyx_n_s_enumerate;
 static PyObject *__pyx_n_s_error;
 static PyObject *__pyx_n_s_errormsg;
+static PyObject *__pyx_n_s_estimate_error;
+static PyObject *__pyx_n_s_estimate_stepsize;
+static PyObject *__pyx_n_s_eval;
 static PyObject *__pyx_n_s_evaluate;
 static PyObject *__pyx_n_s_exept;
-static PyObject *__pyx_n_u_extract_c_kernel;
+static PyObject *__pyx_n_s_eye;
+static PyObject *__pyx_n_s_fac;
+static PyObject *__pyx_n_s_facmax;
+static PyObject *__pyx_n_s_facmin;
 static PyObject *__pyx_n_s_flags;
 static PyObject *__pyx_n_s_flatten;
 static PyObject *__pyx_n_s_format;
 static PyObject *__pyx_n_s_fortran;
 static PyObject *__pyx_n_u_fortran;
+static PyObject *__pyx_n_s_func;
 static PyObject *__pyx_n_s_getstate;
 static PyObject *__pyx_kp_s_got_differing_extents_in_dimensi;
 static PyObject *__pyx_n_s_graph;
 static PyObject *__pyx_n_s_hamiltonian;
 static PyObject *__pyx_n_s_herm_conj;
 static PyObject *__pyx_n_s_hoppings;
 static PyObject *__pyx_n_s_i;
 static PyObject *__pyx_n_s_id;
 static PyObject *__pyx_n_s_import;
 static PyObject *__pyx_n_s_indices;
 static PyObject *__pyx_n_s_indptr;
 static PyObject *__pyx_n_s_init;
 static PyObject *__pyx_n_s_int32;
+static PyObject *__pyx_n_s_interpolation_type;
 static PyObject *__pyx_n_s_is_time_dependent_function;
-static PyObject *__pyx_n_s_isclose;
 static PyObject *__pyx_n_s_itemsize;
 static PyObject *__pyx_kp_s_itemsize_0_for_cython_array;
 static PyObject *__pyx_n_s_join;
 static PyObject *__pyx_n_s_ket;
+static PyObject *__pyx_n_s_logger;
+static PyObject *__pyx_n_s_logging;
 static PyObject *__pyx_n_s_main;
-static PyObject *__pyx_n_s_mat;
+static PyObject *__pyx_n_s_make_logger;
+static PyObject *__pyx_n_s_max;
 static PyObject *__pyx_n_s_memview;
 static PyObject *__pyx_n_s_metaclass;
+static PyObject *__pyx_kp_u_minimal_W_t_stepsize_dt_min_reac;
 static PyObject *__pyx_n_s_mode;
 static PyObject *__pyx_n_s_module;
 static PyObject *__pyx_n_s_name;
 static PyObject *__pyx_n_s_name_2;
 static PyObject *__pyx_n_s_ndim;
-static PyObject *__pyx_n_s_nevals;
 static PyObject *__pyx_n_s_new;
 static PyObject *__pyx_n_s_nnz;
 static PyObject *__pyx_kp_s_no_default___reduce___due_to_non;
 static PyObject *__pyx_n_s_np;
 static PyObject *__pyx_n_s_numpy;
 static PyObject *__pyx_n_s_obj;
 static PyObject *__pyx_n_s_onsites;
@@ -2638,124 +2766,130 @@
 static PyObject *__pyx_n_s_pack;
 static PyObject *__pyx_n_s_params;
 static PyObject *__pyx_n_s_pickle;
 static PyObject *__pyx_n_s_prepare;
 static PyObject *__pyx_n_s_psi;
 static PyObject *__pyx_n_s_psi_centre;
 static PyObject *__pyx_n_s_psi_st;
-static PyObject *__pyx_n_s_py_kernel;
 static PyObject *__pyx_n_s_pyx_PickleError;
 static PyObject *__pyx_n_s_pyx_checksum;
 static PyObject *__pyx_n_s_pyx_getbuffer;
 static PyObject *__pyx_n_s_pyx_result;
 static PyObject *__pyx_n_s_pyx_state;
 static PyObject *__pyx_n_s_pyx_type;
 static PyObject *__pyx_n_s_pyx_unpickle_Enum;
+static PyObject *__pyx_n_s_pyx_unpickle_Interpolation;
 static PyObject *__pyx_n_s_pyx_unpickle_Kernel;
 static PyObject *__pyx_n_s_pyx_unpickle_PerturbationExtra;
 static PyObject *__pyx_n_s_pyx_unpickle_PerturbationInter;
 static PyObject *__pyx_n_s_pyx_vtable;
 static PyObject *__pyx_n_s_qualname;
 static PyObject *__pyx_n_s_range;
 static PyObject *__pyx_n_s_reduce;
 static PyObject *__pyx_n_s_reduce_cython;
 static PyObject *__pyx_n_s_reduce_ex;
 static PyObject *__pyx_n_s_rhs;
 static PyObject *__pyx_n_s_round;
 static PyObject *__pyx_n_s_row;
 static PyObject *__pyx_n_s_row_col;
+static PyObject *__pyx_n_s_rtol;
 static PyObject *__pyx_kp_u_s;
 static PyObject *__pyx_n_s_scipy_sparse;
 static PyObject *__pyx_n_s_scipy_sparse__sparsetools;
 static PyObject *__pyx_n_s_self;
-static PyObject *__pyx_kp_s_self_c_rhs_self_c_self_cannot_be;
-static PyObject *__pyx_n_s_set_params;
+static PyObject *__pyx_n_s_set_W;
 static PyObject *__pyx_n_s_setstate;
 static PyObject *__pyx_n_s_setstate_cython;
 static PyObject *__pyx_n_s_shape;
 static PyObject *__pyx_n_s_site_ranges;
 static PyObject *__pyx_n_s_size;
 static PyObject *__pyx_n_s_sp;
-static PyObject *__pyx_n_s_sparse_blas_kernel;
 static PyObject *__pyx_n_s_start;
 static PyObject *__pyx_n_s_step;
 static PyObject *__pyx_n_s_stop;
 static PyObject *__pyx_kp_s_strided_and_direct;
 static PyObject *__pyx_kp_s_strided_and_direct_or_indirect;
 static PyObject *__pyx_kp_s_strided_and_indirect;
 static PyObject *__pyx_kp_s_stringsource;
 static PyObject *__pyx_n_s_struct;
 static PyObject *__pyx_n_s_syst;
 static PyObject *__pyx_n_s_system;
+static PyObject *__pyx_n_s_t0;
+static PyObject *__pyx_n_s_temp;
 static PyObject *__pyx_n_s_test;
 static PyObject *__pyx_n_s_time;
 static PyObject *__pyx_n_s_time_name;
 static PyObject *__pyx_n_s_time_start;
-static PyObject *__pyx_kp_u_time_t_must_be_greater_equal_t0;
 static PyObject *__pyx_n_s_tkwant_onebody_kernels;
 static PyObject *__pyx_kp_s_tkwant_onebody_kernels_pyx;
 static PyObject *__pyx_n_s_tmp;
 static PyObject *__pyx_n_s_tmp_2;
 static PyObject *__pyx_n_s_tocsr;
 static PyObject *__pyx_n_s_transpose;
 static PyObject *__pyx_n_u_transpose;
 static PyObject *__pyx_kp_s_unable_to_allocate_array_data;
 static PyObject *__pyx_kp_s_unable_to_allocate_shape_and_str;
 static PyObject *__pyx_n_s_unpack;
 static PyObject *__pyx_n_s_update;
+static PyObject *__pyx_kp_u_use_the_scipy_kernel_for_seriali;
 static PyObject *__pyx_n_s_value;
+static PyObject *__pyx_n_s_warning;
+static PyObject *__pyx_n_s_work;
+static PyObject *__pyx_kp_u_work_array_size_must_be_at_least;
 static PyObject *__pyx_n_s_zeros;
-static int __pyx_pf_6tkwant_7onebody_7kernels_6Kernel___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_H0, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED PyObject *__pyx_v_params, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_2set_params(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_params); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4rhs(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_dpsidt, CYTHON_UNUSED double __pyx_v_time); /* proto */
+static int __pyx_pf_6tkwant_7onebody_7kernels_6Kernel___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_H0, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_work); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_2rhs(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_energy); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4size___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self); /* proto */
 static int __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4size_2__set__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, PyObject *__pyx_v_value); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6nevals___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self); /* proto */
 static int __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6nevals_2__set__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, PyObject *__pyx_v_value); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_8__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_7CKernel_rhs(struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *__pyx_v_self, __Pyx_memviewslice __pyx_v_psi, __Pyx_memviewslice __pyx_v_dpsidt, double __pyx_v_time); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_7CKernel_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_7CKernel_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
-static int __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_py_kernel); /* proto */
-static int __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_2__cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self, PyObject *__pyx_v_py_kernel); /* proto */
-static void __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_4__dealloc__(struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_6__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_8__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_extract_c_kernel(CYTHON_UNUSED PyObject *__pyx_self, struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_py_kernel); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy___init__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, PyObject *__pyx_v_params, PyObject *__pyx_v_psi_st); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy_2set_params(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_params); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy_4rhs(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, __Pyx_memviewslice __pyx_v_psi, __Pyx_memviewslice __pyx_v_dpsidt, double __pyx_v_time); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_2_herm_conj(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_value); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy___init__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, PyObject *__pyx_v_psi_st, PyObject *__pyx_v_work); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy_2rhs(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_energy); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy_4set_W(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_W); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_8_CalcRHS___init__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, PyObject *__pyx_v_psi_st, PyObject *__pyx_v_size, PyObject *__pyx_v_center_size, PyObject *__pyx_v_tmp); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_8_CalcRHS_2__call__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, __Pyx_memviewslice __pyx_v_psi, __Pyx_memviewslice __pyx_v_dpsidt, double __pyx_v_time); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels__herm_conj(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_value); /* proto */
+static int __pyx_pf_6tkwant_7onebody_7kernels_13Interpolation___init__(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, PyObject *__pyx_v_func, PyObject *__pyx_v_t0, PyObject *__pyx_v_dt_init, PyObject *__pyx_v_atol, PyObject *__pyx_v_rtol, PyObject *__pyx_v_dt_min, PyObject *__pyx_v_fac, PyObject *__pyx_v_facmin, PyObject *__pyx_v_facmax); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_2eval(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, double __pyx_v_time, __Pyx_memviewslice __pyx_v_out); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_4_estimate_error(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, double __pyx_v_time); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_6_estimate_stepsize(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, double __pyx_v_dt, double __pyx_v_error); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_8__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_10__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
 static int __pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor___init__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self, PyObject *__pyx_v_syst, PyObject *__pyx_v_time_name, PyObject *__pyx_v_time_start, PyObject *__pyx_v_params); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_4size___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_3nnz___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_2data(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self, double __pyx_v_time, PyObject *__pyx_v_out); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_4row_col(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_6empty(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_8evaluate(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self, double __pyx_v_time, PyObject *__pyx_v_out); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_10apply(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self, double __pyx_v_time, PyObject *__pyx_v_ket, PyObject *__pyx_v_out); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_12__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_14__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
-static int __pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator___init__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, PyObject *__pyx_v_syst, PyObject *__pyx_v_time_name, PyObject *__pyx_v_time_start, PyObject *__pyx_v_params, PyObject *__pyx_v_dt); /* proto */
+static int __pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator___init__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, PyObject *__pyx_v_syst, PyObject *__pyx_v_time_name, PyObject *__pyx_v_time_start, PyObject *__pyx_v_params, PyObject *__pyx_v_interpolation_type); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_4size___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_3nnz___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_2evaluate(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, double __pyx_v_time, PyObject *__pyx_v_out); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_4apply(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, double __pyx_v_time, __Pyx_memviewslice __pyx_v_ket, PyObject *__pyx_v_out); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_6__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_8__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
-static int __pyx_pf_6tkwant_7onebody_7kernels_10_CSRMatrix___cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *__pyx_v_self, PyObject *__pyx_v_mat); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_10_CSRMatrix_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_10_CSRMatrix_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
-static int __pyx_pf_6tkwant_7onebody_7kernels_6Simple___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_H0, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED PyObject *__pyx_v_params, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_2set_params(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_params); /* proto */
-static int __pyx_pf_6tkwant_7onebody_7kernels_6Simple_4__cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, PyObject *__pyx_v_params, __Pyx_memviewslice __pyx_v_psi_st); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_6__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_8__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_4__pyx_unpickle_Kernel(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
+static int __pyx_pf_6tkwant_7onebody_7kernels_6Simple___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_H0, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st, CYTHON_UNUSED PyObject *__pyx_v_work); /* proto */
+static int __pyx_pf_6tkwant_7onebody_7kernels_6Simple_2__cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, __Pyx_memviewslice __pyx_v_psi_st, PyObject *__pyx_v_work); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_4rhs(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_energy); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_1W___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_6set_W(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_W); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_8__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_10__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
+static int __pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *__pyx_v_self, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_indptr, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_indices, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_data, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st, CYTHON_UNUSED int __pyx_v_size, CYTHON_UNUSED int __pyx_v_center_size, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_temp); /* proto */
+static int __pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc_2__cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *__pyx_v_self, __Pyx_memviewslice __pyx_v_indptr, __Pyx_memviewslice __pyx_v_indices, __Pyx_memviewslice __pyx_v_data, PyObject *__pyx_v_W, __Pyx_memviewslice __pyx_v_psi_st, int __pyx_v_size, int __pyx_v_center_size, __Pyx_memviewslice __pyx_v_temp); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc_4__call__(struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *__pyx_v_self, __Pyx_memviewslice __pyx_v_psi, __Pyx_memviewslice __pyx_v_dpsidt, double __pyx_v_time); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc_6__reduce__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_2__pyx_unpickle_Kernel(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_4__pyx_unpickle_Interpolation(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6__pyx_unpickle_PerturbationExtractor(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_8__pyx_unpickle_PerturbationInterpolator(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
 static int __pyx_array___pyx_pf_15View_dot_MemoryView_5array___cinit__(struct __pyx_array_obj *__pyx_v_self, PyObject *__pyx_v_shape, Py_ssize_t __pyx_v_itemsize, PyObject *__pyx_v_format, PyObject *__pyx_v_mode, int __pyx_v_allocate_buffer); /* proto */
 static int __pyx_array___pyx_pf_15View_dot_MemoryView_5array_2__getbuffer__(struct __pyx_array_obj *__pyx_v_self, Py_buffer *__pyx_v_info, int __pyx_v_flags); /* proto */
 static void __pyx_array___pyx_pf_15View_dot_MemoryView_5array_4__dealloc__(struct __pyx_array_obj *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_15View_dot_MemoryView_5array_7memview___get__(struct __pyx_array_obj *__pyx_v_self); /* proto */
 static Py_ssize_t __pyx_array___pyx_pf_15View_dot_MemoryView_5array_6__len__(struct __pyx_array_obj *__pyx_v_self); /* proto */
@@ -2793,45 +2927,61 @@
 static PyObject *__pyx_pf___pyx_memoryview_2__setstate_cython__(CYTHON_UNUSED struct __pyx_memoryview_obj *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
 static void __pyx_memoryviewslice___pyx_pf_15View_dot_MemoryView_16_memoryviewslice___dealloc__(struct __pyx_memoryviewslice_obj *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf_15View_dot_MemoryView_16_memoryviewslice_4base___get__(struct __pyx_memoryviewslice_obj *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf___pyx_memoryviewslice___reduce_cython__(CYTHON_UNUSED struct __pyx_memoryviewslice_obj *__pyx_v_self); /* proto */
 static PyObject *__pyx_pf___pyx_memoryviewslice_2__setstate_cython__(CYTHON_UNUSED struct __pyx_memoryviewslice_obj *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state); /* proto */
 static PyObject *__pyx_pf_15View_dot_MemoryView___pyx_unpickle_Enum(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
 static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_Kernel(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
-static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_CKernel(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
-static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_PyCKernel(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
+static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_Interpolation(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_PerturbationExtractor(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_PerturbationInterpolator(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
-static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels__CSRMatrix(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_Simple(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
+static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels__CalcRHSc(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_array(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_Enum(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new_memoryview(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static PyObject *__pyx_tp_new__memoryviewslice(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
+static PyObject *__pyx_float_0_1;
+static PyObject *__pyx_float_0_9;
 static PyObject *__pyx_float_0_25;
+static PyObject *__pyx_float_1Eneg_6;
+static PyObject *__pyx_float_0_001;
+static PyObject *__pyx_float_1Eneg_10;
 static PyObject *__pyx_int_0;
 static PyObject *__pyx_int_1;
 static PyObject *__pyx_int_2;
+static PyObject *__pyx_int_3;
 static PyObject *__pyx_int_10;
-static PyObject *__pyx_int_27919597;
 static PyObject *__pyx_int_40710769;
+static PyObject *__pyx_int_47058919;
+static PyObject *__pyx_int_51357075;
+static PyObject *__pyx_int_65594335;
+static PyObject *__pyx_int_77082683;
 static PyObject *__pyx_int_81125043;
+static PyObject *__pyx_int_107924309;
+static PyObject *__pyx_int_112105877;
+static PyObject *__pyx_int_136983863;
+static PyObject *__pyx_int_137247451;
+static PyObject *__pyx_int_157128468;
+static PyObject *__pyx_int_172575680;
 static PyObject *__pyx_int_184977713;
+static PyObject *__pyx_int_186858192;
+static PyObject *__pyx_int_219249325;
 static PyObject *__pyx_int_neg_1;
 static __Pyx_memviewslice __pyx_k_;
-static __Pyx_memviewslice __pyx_k__9;
-static __Pyx_memviewslice __pyx_k__10;
-static PyObject *__pyx_tuple__2;
-static PyObject *__pyx_tuple__3;
-static PyObject *__pyx_tuple__4;
-static PyObject *__pyx_tuple__5;
+static __Pyx_memviewslice __pyx_k__2;
+static PyObject *__pyx_k__3;
+static __Pyx_memviewslice __pyx_k__4;
+static __Pyx_memviewslice __pyx_k__5;
 static PyObject *__pyx_tuple__6;
 static PyObject *__pyx_tuple__7;
 static PyObject *__pyx_tuple__8;
+static PyObject *__pyx_tuple__9;
 static PyObject *__pyx_slice__27;
+static PyObject *__pyx_tuple__10;
 static PyObject *__pyx_tuple__11;
 static PyObject *__pyx_tuple__12;
 static PyObject *__pyx_tuple__13;
 static PyObject *__pyx_tuple__14;
 static PyObject *__pyx_tuple__15;
 static PyObject *__pyx_tuple__16;
 static PyObject *__pyx_tuple__17;
@@ -2843,58 +2993,69 @@
 static PyObject *__pyx_tuple__23;
 static PyObject *__pyx_tuple__24;
 static PyObject *__pyx_tuple__25;
 static PyObject *__pyx_tuple__26;
 static PyObject *__pyx_tuple__28;
 static PyObject *__pyx_tuple__29;
 static PyObject *__pyx_tuple__30;
-static PyObject *__pyx_tuple__37;
-static PyObject *__pyx_tuple__39;
+static PyObject *__pyx_tuple__31;
+static PyObject *__pyx_tuple__38;
 static PyObject *__pyx_tuple__40;
-static PyObject *__pyx_tuple__42;
+static PyObject *__pyx_tuple__41;
+static PyObject *__pyx_tuple__43;
 static PyObject *__pyx_tuple__44;
 static PyObject *__pyx_tuple__46;
 static PyObject *__pyx_tuple__48;
 static PyObject *__pyx_tuple__50;
 static PyObject *__pyx_tuple__52;
-static PyObject *__pyx_tuple__53;
 static PyObject *__pyx_tuple__54;
-static PyObject *__pyx_tuple__55;
 static PyObject *__pyx_tuple__56;
-static PyObject *__pyx_tuple__57;
-static PyObject *__pyx_codeobj__38;
-static PyObject *__pyx_codeobj__41;
-static PyObject *__pyx_codeobj__43;
+static PyObject *__pyx_tuple__58;
+static PyObject *__pyx_tuple__60;
+static PyObject *__pyx_tuple__61;
+static PyObject *__pyx_tuple__62;
+static PyObject *__pyx_tuple__63;
+static PyObject *__pyx_tuple__64;
+static PyObject *__pyx_tuple__65;
+static PyObject *__pyx_codeobj__39;
+static PyObject *__pyx_codeobj__42;
 static PyObject *__pyx_codeobj__45;
 static PyObject *__pyx_codeobj__47;
 static PyObject *__pyx_codeobj__49;
 static PyObject *__pyx_codeobj__51;
-static PyObject *__pyx_codeobj__58;
+static PyObject *__pyx_codeobj__53;
+static PyObject *__pyx_codeobj__55;
+static PyObject *__pyx_codeobj__57;
+static PyObject *__pyx_codeobj__59;
+static PyObject *__pyx_codeobj__66;
 /* Late includes */
 
-/* "tkwant/onebody/kernels.pyx":59
+/* "tkwant/onebody/kernels.pyx":60
  *     """
  * 
- *     def __init__(self, H0, W, params, complex[:] psi_st=None):             # <<<<<<<<<<<<<<
+ *     def __init__(self, H0, W, complex[:] psi_st=None, complex[:] work=None):             # <<<<<<<<<<<<<<
  *         raise NotImplementedError()
  * 
  */
 
 /* Python wrapper */
 static int __pyx_pw_6tkwant_7onebody_7kernels_6Kernel_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static int __pyx_pw_6tkwant_7onebody_7kernels_6Kernel_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   CYTHON_UNUSED PyObject *__pyx_v_H0 = 0;
   CYTHON_UNUSED PyObject *__pyx_v_W = 0;
-  CYTHON_UNUSED PyObject *__pyx_v_params = 0;
   CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st = { 0, 0, { 0 }, { 0 }, { 0 } };
+  CYTHON_UNUSED __Pyx_memviewslice __pyx_v_work = { 0, 0, { 0 }, { 0 }, { 0 } };
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_H0,&__pyx_n_s_W,&__pyx_n_s_params,&__pyx_n_s_psi_st,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_H0,&__pyx_n_s_W,&__pyx_n_s_psi_st,&__pyx_n_s_work,0};
     PyObject* values[4] = {0,0,0,0};
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
         case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
@@ -2912,290 +3073,227 @@
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_H0)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, 1); __PYX_ERR(0, 59, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 4, 1); __PYX_ERR(0, 60, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
-        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_params)) != 0)) kw_args--;
-        else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, 2); __PYX_ERR(0, 59, __pyx_L3_error)
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st);
+          if (value) { values[2] = value; kw_args--; }
         }
         CYTHON_FALLTHROUGH;
         case  3:
         if (kw_args > 0) {
-          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st);
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_work);
           if (value) { values[3] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 59, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 60, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
         case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
-        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
     __pyx_v_H0 = values[0];
     __pyx_v_W = values[1];
-    __pyx_v_params = values[2];
-    if (values[3]) {
-      __pyx_v_psi_st = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[3], PyBUF_WRITABLE); if (unlikely(!__pyx_v_psi_st.memview)) __PYX_ERR(0, 59, __pyx_L3_error)
+    if (values[2]) {
+      __pyx_v_psi_st = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[2], PyBUF_WRITABLE); if (unlikely(!__pyx_v_psi_st.memview)) __PYX_ERR(0, 60, __pyx_L3_error)
     } else {
       __pyx_v_psi_st = __pyx_k_;
       __PYX_INC_MEMVIEW(&__pyx_v_psi_st, 1);
     }
+    if (values[3]) {
+      __pyx_v_work = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[3], PyBUF_WRITABLE); if (unlikely(!__pyx_v_work.memview)) __PYX_ERR(0, 60, __pyx_L3_error)
+    } else {
+      __pyx_v_work = __pyx_k__2;
+      __PYX_INC_MEMVIEW(&__pyx_v_work, 1);
+    }
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 59, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 60, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.Kernel.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Kernel___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_self), __pyx_v_H0, __pyx_v_W, __pyx_v_params, __pyx_v_psi_st);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Kernel___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_self), __pyx_v_H0, __pyx_v_W, __pyx_v_psi_st, __pyx_v_work);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static int __pyx_pf_6tkwant_7onebody_7kernels_6Kernel___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_H0, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED PyObject *__pyx_v_params, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st) {
+static int __pyx_pf_6tkwant_7onebody_7kernels_6Kernel___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_H0, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_work) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":60
+  /* "tkwant/onebody/kernels.pyx":61
  * 
- *     def __init__(self, H0, W, params, complex[:] psi_st=None):
+ *     def __init__(self, H0, W, complex[:] psi_st=None, complex[:] work=None):
  *         raise NotImplementedError()             # <<<<<<<<<<<<<<
  * 
- *     def set_params(self, params):
+ *     def rhs(self, energy=None):
  */
-  __pyx_t_1 = __Pyx_PyObject_CallNoArg(__pyx_builtin_NotImplementedError); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 60, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_CallNoArg(__pyx_builtin_NotImplementedError); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 61, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_Raise(__pyx_t_1, 0, 0, 0);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(0, 60, __pyx_L1_error)
+  __PYX_ERR(0, 61, __pyx_L1_error)
 
-  /* "tkwant/onebody/kernels.pyx":59
+  /* "tkwant/onebody/kernels.pyx":60
  *     """
  * 
- *     def __init__(self, H0, W, params, complex[:] psi_st=None):             # <<<<<<<<<<<<<<
+ *     def __init__(self, H0, W, complex[:] psi_st=None, complex[:] work=None):             # <<<<<<<<<<<<<<
  *         raise NotImplementedError()
  * 
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_AddTraceback("tkwant.onebody.kernels.Kernel.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __PYX_XDEC_MEMVIEW(&__pyx_v_psi_st, 1);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_work, 1);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":62
+/* "tkwant/onebody/kernels.pyx":63
  *         raise NotImplementedError()
  * 
- *     def set_params(self, params):             # <<<<<<<<<<<<<<
- *         raise NotImplementedError()
- * 
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_3set_params(PyObject *__pyx_v_self, PyObject *__pyx_v_params); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_2set_params[] = "Kernel.set_params(self, params)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_3set_params(PyObject *__pyx_v_self, PyObject *__pyx_v_params) {
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("set_params (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_2set_params(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_self), ((PyObject *)__pyx_v_params));
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_2set_params(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_params) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("set_params", 0);
-
-  /* "tkwant/onebody/kernels.pyx":63
- * 
- *     def set_params(self, params):
- *         raise NotImplementedError()             # <<<<<<<<<<<<<<
- * 
- *     def rhs(self, complex[:] psi, complex[:] dpsidt, double time):
- */
-  __pyx_t_1 = __Pyx_PyObject_CallNoArg(__pyx_builtin_NotImplementedError); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 63, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(0, 63, __pyx_L1_error)
-
-  /* "tkwant/onebody/kernels.pyx":62
- *         raise NotImplementedError()
- * 
- *     def set_params(self, params):             # <<<<<<<<<<<<<<
- *         raise NotImplementedError()
- * 
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Kernel.set_params", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "tkwant/onebody/kernels.pyx":65
- *         raise NotImplementedError()
- * 
- *     def rhs(self, complex[:] psi, complex[:] dpsidt, double time):             # <<<<<<<<<<<<<<
+ *     def rhs(self, energy=None):             # <<<<<<<<<<<<<<
  *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
  *         raise NotImplementedError()
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_5rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_4rhs[] = "Kernel.rhs(self, double complex[:] psi, double complex[:] dpsidt, double time)\nEvaluate the RHS of the TDSE and store the result in `dpsidt`.";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_5rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi = { 0, 0, { 0 }, { 0 }, { 0 } };
-  CYTHON_UNUSED __Pyx_memviewslice __pyx_v_dpsidt = { 0, 0, { 0 }, { 0 }, { 0 } };
-  CYTHON_UNUSED double __pyx_v_time;
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_3rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_2rhs[] = "Kernel.rhs(self, energy=None)\nEvaluate the RHS of the TDSE and store the result in `dpsidt`.";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_3rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  CYTHON_UNUSED PyObject *__pyx_v_energy = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("rhs (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_psi,&__pyx_n_s_dpsidt,&__pyx_n_s_time,0};
-    PyObject* values[3] = {0,0,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_energy,0};
+    PyObject* values[1] = {0};
+    values[0] = ((PyObject *)Py_None);
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
-        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
-        CYTHON_FALLTHROUGH;
-        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
-        CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi)) != 0)) kw_args--;
-        else goto __pyx_L5_argtuple_error;
-        CYTHON_FALLTHROUGH;
-        case  1:
-        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_dpsidt)) != 0)) kw_args--;
-        else {
-          __Pyx_RaiseArgtupleInvalid("rhs", 1, 3, 3, 1); __PYX_ERR(0, 65, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  2:
-        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time)) != 0)) kw_args--;
-        else {
-          __Pyx_RaiseArgtupleInvalid("rhs", 1, 3, 3, 2); __PYX_ERR(0, 65, __pyx_L3_error)
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_energy);
+          if (value) { values[0] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "rhs") < 0)) __PYX_ERR(0, 65, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "rhs") < 0)) __PYX_ERR(0, 63, __pyx_L3_error)
       }
-    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
-      goto __pyx_L5_argtuple_error;
     } else {
-      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
-      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
-      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+      switch (PyTuple_GET_SIZE(__pyx_args)) {
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
     }
-    __pyx_v_psi = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[0], PyBUF_WRITABLE); if (unlikely(!__pyx_v_psi.memview)) __PYX_ERR(0, 65, __pyx_L3_error)
-    __pyx_v_dpsidt = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[1], PyBUF_WRITABLE); if (unlikely(!__pyx_v_dpsidt.memview)) __PYX_ERR(0, 65, __pyx_L3_error)
-    __pyx_v_time = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 65, __pyx_L3_error)
+    __pyx_v_energy = values[0];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("rhs", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 65, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("rhs", 0, 0, 1, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 63, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.Kernel.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4rhs(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_self), __pyx_v_psi, __pyx_v_dpsidt, __pyx_v_time);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_2rhs(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_self), __pyx_v_energy);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4rhs(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_dpsidt, CYTHON_UNUSED double __pyx_v_time) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_2rhs(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_energy) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("rhs", 0);
 
-  /* "tkwant/onebody/kernels.pyx":67
- *     def rhs(self, complex[:] psi, complex[:] dpsidt, double time):
+  /* "tkwant/onebody/kernels.pyx":65
+ *     def rhs(self, energy=None):
  *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
  *         raise NotImplementedError()             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_t_1 = __Pyx_PyObject_CallNoArg(__pyx_builtin_NotImplementedError); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 67, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_CallNoArg(__pyx_builtin_NotImplementedError); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 65, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_Raise(__pyx_t_1, 0, 0, 0);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(0, 67, __pyx_L1_error)
+  __PYX_ERR(0, 65, __pyx_L1_error)
 
-  /* "tkwant/onebody/kernels.pyx":65
+  /* "tkwant/onebody/kernels.pyx":63
  *         raise NotImplementedError()
  * 
- *     def rhs(self, complex[:] psi, complex[:] dpsidt, double time):             # <<<<<<<<<<<<<<
+ *     def rhs(self, energy=None):             # <<<<<<<<<<<<<<
  *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
  *         raise NotImplementedError()
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_AddTraceback("tkwant.onebody.kernels.Kernel.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
-  __PYX_XDEC_MEMVIEW(&__pyx_v_psi, 1);
-  __PYX_XDEC_MEMVIEW(&__pyx_v_dpsidt, 1);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pxd":15
+/* "tkwant/onebody/kernels.pxd":16
  * 
  * cdef class Kernel:
  *     cdef public int size, nevals             # <<<<<<<<<<<<<<
- * 
- * 
  */
 
 /* Python wrapper */
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_4size_1__get__(PyObject *__pyx_v_self); /*proto*/
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_4size_1__get__(PyObject *__pyx_v_self) {
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
@@ -3207,17 +3305,20 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4size___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 15, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 16, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* function exit code */
   __pyx_L1_error:;
@@ -3243,16 +3344,19 @@
   return __pyx_r;
 }
 
 static int __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4size_2__set__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, PyObject *__pyx_v_value) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__set__", 0);
-  __pyx_t_1 = __Pyx_PyInt_As_int(__pyx_v_value); if (unlikely((__pyx_t_1 == (int)-1) && PyErr_Occurred())) __PYX_ERR(2, 15, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_As_int(__pyx_v_value); if (unlikely((__pyx_t_1 == (int)-1) && PyErr_Occurred())) __PYX_ERR(2, 16, __pyx_L1_error)
   __pyx_v_self->size = __pyx_t_1;
 
   /* function exit code */
   __pyx_r = 0;
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.Kernel.size.__set__", __pyx_clineno, __pyx_lineno, __pyx_filename);
@@ -3275,17 +3379,20 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6nevals___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->nevals); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 15, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->nevals); if (unlikely(!__pyx_t_1)) __PYX_ERR(2, 16, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
   /* function exit code */
   __pyx_L1_error:;
@@ -3311,16 +3418,19 @@
   return __pyx_r;
 }
 
 static int __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6nevals_2__set__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, PyObject *__pyx_v_value) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__set__", 0);
-  __pyx_t_1 = __Pyx_PyInt_As_int(__pyx_v_value); if (unlikely((__pyx_t_1 == (int)-1) && PyErr_Occurred())) __PYX_ERR(2, 15, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_As_int(__pyx_v_value); if (unlikely((__pyx_t_1 == (int)-1) && PyErr_Occurred())) __PYX_ERR(2, 16, __pyx_L1_error)
   __pyx_v_self->nevals = __pyx_t_1;
 
   /* function exit code */
   __pyx_r = 0;
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.Kernel.nevals.__set__", __pyx_clineno, __pyx_lineno, __pyx_filename);
@@ -3333,38 +3443,41 @@
 /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
  *     cdef tuple state
  *     cdef object _dict
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_7__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_6__reduce_cython__[] = "Kernel.__reduce_cython__(self)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_7__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_5__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_4__reduce_cython__[] = "Kernel.__reduce_cython__(self)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_5__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6__reduce_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_self));
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4__reduce_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_self));
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_4__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self) {
   PyObject *__pyx_v_state = 0;
   PyObject *__pyx_v__dict = 0;
   int __pyx_v_use_setstate;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   int __pyx_t_4;
   int __pyx_t_5;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__reduce_cython__", 0);
 
   /* "(tree fragment)":5
  *     cdef object _dict
  *     cdef bint use_setstate
  *     state = (self.nevals, self.size)             # <<<<<<<<<<<<<<
  *     _dict = getattr(self, '__dict__', None)
@@ -3572,39 +3685,42 @@
  *     else:
  *         return __pyx_unpickle_Kernel, (type(self), 0x4d5deb3, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_Kernel__set_state(self, __pyx_state)
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_9__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_8__setstate_cython__[] = "Kernel.__setstate_cython__(self, __pyx_state)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_9__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_7__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_6__setstate_cython__[] = "Kernel.__setstate_cython__(self, __pyx_state)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_7__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_8__setstate_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_self), ((PyObject *)__pyx_v___pyx_state));
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6__setstate_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_self), ((PyObject *)__pyx_v___pyx_state));
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_8__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Kernel_6__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setstate_cython__", 0);
 
   /* "(tree fragment)":17
  *         return __pyx_unpickle_Kernel, (type(self), 0x4d5deb3, state)
  * def __setstate_cython__(self, __pyx_state):
  *     __pyx_unpickle_Kernel__set_state(self, __pyx_state)             # <<<<<<<<<<<<<<
  */
-  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
+  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
   __pyx_t_1 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_Kernel__set_state(__pyx_v_self, ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 17, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
   /* "(tree fragment)":16
  *     else:
  *         return __pyx_unpickle_Kernel, (type(self), 0x4d5deb3, state)
@@ -3621,1369 +3737,1139 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":89
- *     @cython.boundscheck(False)
- *     @cython.wraparound(False)
- *     def rhs(self, const complex[::1] psi, complex[::1] dpsidt, double time):             # <<<<<<<<<<<<<<
- *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
- *         self.c_rhs(self.c_self, &psi[0], &dpsidt[0], time)
+/* "tkwant/onebody/kernels.pyx":103
+ *     """
+ * 
+ *     def __init__(self, H0, W, psi_st=None, work=None):             # <<<<<<<<<<<<<<
+ * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_7CKernel_1rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_7CKernel_rhs[] = "CKernel.rhs(self, const double complex[::1] psi, double complex[::1] dpsidt, double time)\nEvaluate the RHS of the TDSE and store the result in `dpsidt`.";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_7CKernel_1rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  __Pyx_memviewslice __pyx_v_psi = { 0, 0, { 0 }, { 0 }, { 0 } };
-  __Pyx_memviewslice __pyx_v_dpsidt = { 0, 0, { 0 }, { 0 }, { 0 } };
-  double __pyx_v_time;
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_1__init__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_5Scipy___init__[] = "Scipy.__init__(self, H0, W, psi_st=None, work=None)";
+static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_1__init__ = {"__init__", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_1__init__, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_5Scipy___init__};
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_1__init__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  PyObject *__pyx_v_self = 0;
+  PyObject *__pyx_v_H0 = 0;
+  PyObject *__pyx_v_W = 0;
+  PyObject *__pyx_v_psi_st = 0;
+  PyObject *__pyx_v_work = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("rhs (wrapper)", 0);
+  __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_psi,&__pyx_n_s_dpsidt,&__pyx_n_s_time,0};
-    PyObject* values[3] = {0,0,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_H0,&__pyx_n_s_W,&__pyx_n_s_psi_st,&__pyx_n_s_work,0};
+    PyObject* values[5] = {0,0,0,0,0};
+    values[3] = ((PyObject *)((PyObject *)Py_None));
+    values[4] = ((PyObject *)((PyObject *)Py_None));
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
+        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+        CYTHON_FALLTHROUGH;
+        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+        CYTHON_FALLTHROUGH;
         case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
         CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi)) != 0)) kw_args--;
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
-        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_dpsidt)) != 0)) kw_args--;
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_H0)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("rhs", 1, 3, 3, 1); __PYX_ERR(0, 89, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 5, 1); __PYX_ERR(0, 103, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
-        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time)) != 0)) kw_args--;
+        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("rhs", 1, 3, 3, 2); __PYX_ERR(0, 89, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 5, 2); __PYX_ERR(0, 103, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  3:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st);
+          if (value) { values[3] = value; kw_args--; }
+        }
+        CYTHON_FALLTHROUGH;
+        case  4:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_work);
+          if (value) { values[4] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "rhs") < 0)) __PYX_ERR(0, 89, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 103, __pyx_L3_error)
       }
-    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
-      goto __pyx_L5_argtuple_error;
     } else {
-      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
-      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
-      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+      switch (PyTuple_GET_SIZE(__pyx_args)) {
+        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+        CYTHON_FALLTHROUGH;
+        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+        CYTHON_FALLTHROUGH;
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        break;
+        default: goto __pyx_L5_argtuple_error;
+      }
     }
-    __pyx_v_psi = __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex__const__(values[0], 0); if (unlikely(!__pyx_v_psi.memview)) __PYX_ERR(0, 89, __pyx_L3_error)
-    __pyx_v_dpsidt = __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex(values[1], PyBUF_WRITABLE); if (unlikely(!__pyx_v_dpsidt.memview)) __PYX_ERR(0, 89, __pyx_L3_error)
-    __pyx_v_time = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 89, __pyx_L3_error)
+    __pyx_v_self = values[0];
+    __pyx_v_H0 = values[1];
+    __pyx_v_W = values[2];
+    __pyx_v_psi_st = values[3];
+    __pyx_v_work = values[4];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("rhs", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 89, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 5, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 103, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.CKernel.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_7CKernel_rhs(((struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *)__pyx_v_self), __pyx_v_psi, __pyx_v_dpsidt, __pyx_v_time);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_5Scipy___init__(__pyx_self, __pyx_v_self, __pyx_v_H0, __pyx_v_W, __pyx_v_psi_st, __pyx_v_work);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_7CKernel_rhs(struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *__pyx_v_self, __Pyx_memviewslice __pyx_v_psi, __Pyx_memviewslice __pyx_v_dpsidt, double __pyx_v_time) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy___init__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, PyObject *__pyx_v_psi_st, PyObject *__pyx_v_work) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  Py_ssize_t __pyx_t_1;
-  Py_ssize_t __pyx_t_2;
-  __Pyx_RefNannySetupContext("rhs", 0);
+  PyObject *__pyx_t_1 = NULL;
+  PyObject *__pyx_t_2 = NULL;
+  int __pyx_t_3;
+  int __pyx_t_4;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
+  PyObject *__pyx_t_7 = NULL;
+  int __pyx_t_8;
+  PyObject *__pyx_t_9 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":91
- *     def rhs(self, const complex[::1] psi, complex[::1] dpsidt, double time):
- *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
- *         self.c_rhs(self.c_self, &psi[0], &dpsidt[0], time)             # <<<<<<<<<<<<<<
- *         self.nevals += 1
+  /* "tkwant/onebody/kernels.pyx":105
+ *     def __init__(self, H0, W, psi_st=None, work=None):
  * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):             # <<<<<<<<<<<<<<
+ *             self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case
+ *         else:
  */
-  __pyx_t_1 = 0;
-  __pyx_t_2 = 0;
-  __pyx_v_self->c_rhs(__pyx_v_self->c_self, (&(*((__pyx_t_double_complex const  *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex const  *) __pyx_v_psi.data) + __pyx_t_1)) )))), (&(*((__pyx_t_double_complex *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex *) __pyx_v_dpsidt.data) + __pyx_t_2)) )))), __pyx_v_time); if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 91, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_sp); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 105, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_csr); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 105, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_csr_matrix); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 105, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_t_3 = PyObject_IsInstance(__pyx_v_H0, __pyx_t_1); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(0, 105, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_4 = ((!(__pyx_t_3 != 0)) != 0);
+  if (__pyx_t_4) {
 
-  /* "tkwant/onebody/kernels.pyx":92
- *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
- *         self.c_rhs(self.c_self, &psi[0], &dpsidt[0], time)
- *         self.nevals += 1             # <<<<<<<<<<<<<<
- * 
+    /* "tkwant/onebody/kernels.pyx":106
  * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):
+ *             self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case             # <<<<<<<<<<<<<<
+ *         else:
+ *             self.H0 = H0
  */
-  __pyx_v_self->__pyx_base.nevals = (__pyx_v_self->__pyx_base.nevals + 1);
+    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_H0, __pyx_n_s_tocsr); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 106, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_5 = NULL;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
+      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
+      if (likely(__pyx_t_5)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
+        __Pyx_INCREF(__pyx_t_5);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_2, function);
+      }
+    }
+    __pyx_t_1 = (__pyx_t_5) ? __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_5) : __Pyx_PyObject_CallNoArg(__pyx_t_2);
+    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 106, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_H0, __pyx_t_1) < 0) __PYX_ERR(0, 106, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":89
- *     @cython.boundscheck(False)
- *     @cython.wraparound(False)
- *     def rhs(self, const complex[::1] psi, complex[::1] dpsidt, double time):             # <<<<<<<<<<<<<<
- *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
- *         self.c_rhs(self.c_self, &psi[0], &dpsidt[0], time)
+    /* "tkwant/onebody/kernels.pyx":105
+ *     def __init__(self, H0, W, psi_st=None, work=None):
+ * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):             # <<<<<<<<<<<<<<
+ *             self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case
+ *         else:
  */
+    goto __pyx_L3;
+  }
 
-  /* function exit code */
-  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
-  goto __pyx_L0;
-  __pyx_L1_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.CKernel.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __pyx_L0:;
-  __PYX_XDEC_MEMVIEW(&__pyx_v_psi, 1);
-  __PYX_XDEC_MEMVIEW(&__pyx_v_dpsidt, 1);
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
- * def __setstate_cython__(self, __pyx_state):
+  /* "tkwant/onebody/kernels.pyx":108
+ *             self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case
+ *         else:
+ *             self.H0 = H0             # <<<<<<<<<<<<<<
+ * 
+ *         self.W = W
  */
+  /*else*/ {
+    if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_H0, __pyx_v_H0) < 0) __PYX_ERR(0, 108, __pyx_L1_error)
+  }
+  __pyx_L3:;
 
-/* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_7CKernel_3__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_7CKernel_2__reduce_cython__[] = "CKernel.__reduce_cython__(self)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_7CKernel_3__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_7CKernel_2__reduce_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *)__pyx_v_self));
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
+  /* "tkwant/onebody/kernels.pyx":110
+ *             self.H0 = H0
+ * 
+ *         self.W = W             # <<<<<<<<<<<<<<
+ *         self.psi_st = psi_st
+ *         # The size of the time-independent part of the Hamiltonian. This
+ */
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_W, __pyx_v_W) < 0) __PYX_ERR(0, 110, __pyx_L1_error)
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_7CKernel_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *__pyx_v_self) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("__reduce_cython__", 0);
+  /* "tkwant/onebody/kernels.pyx":111
+ * 
+ *         self.W = W
+ *         self.psi_st = psi_st             # <<<<<<<<<<<<<<
+ *         # The size of the time-independent part of the Hamiltonian. This
+ *         # also sets the size of the solution vector.
+ */
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_psi_st, __pyx_v_psi_st) < 0) __PYX_ERR(0, 111, __pyx_L1_error)
 
-  /* "(tree fragment)":2
- * def __reduce_cython__(self):
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")             # <<<<<<<<<<<<<<
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
+  /* "tkwant/onebody/kernels.pyx":114
+ *         # The size of the time-independent part of the Hamiltonian. This
+ *         # also sets the size of the solution vector.
+ *         self.size = self.H0.shape[0]             # <<<<<<<<<<<<<<
+ * 
+ *         if W is not None:
  */
-  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__2, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 2, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 114, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_shape); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 114, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_2, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 114, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_size, __pyx_t_1) < 0) __PYX_ERR(0, 114, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(1, 2, __pyx_L1_error)
 
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
- * def __setstate_cython__(self, __pyx_state):
+  /* "tkwant/onebody/kernels.pyx":116
+ *         self.size = self.H0.shape[0]
+ * 
+ *         if W is not None:             # <<<<<<<<<<<<<<
+ *             self.center_size = self.W.size
+ *         else:
  */
+  __pyx_t_4 = (__pyx_v_W != Py_None);
+  __pyx_t_3 = (__pyx_t_4 != 0);
+  if (__pyx_t_3) {
 
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.CKernel.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
+    /* "tkwant/onebody/kernels.pyx":117
+ * 
+ *         if W is not None:
+ *             self.center_size = self.W.size             # <<<<<<<<<<<<<<
+ *         else:
+ *             self.center_size = self.size
  */
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_W); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 117, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 117, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_center_size, __pyx_t_2) < 0) __PYX_ERR(0, 117, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-/* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_7CKernel_5__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_7CKernel_4__setstate_cython__[] = "CKernel.__setstate_cython__(self, __pyx_state)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_7CKernel_5__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_7CKernel_4__setstate_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *)__pyx_v_self), ((PyObject *)__pyx_v___pyx_state));
+    /* "tkwant/onebody/kernels.pyx":116
+ *         self.size = self.H0.shape[0]
+ * 
+ *         if W is not None:             # <<<<<<<<<<<<<<
+ *             self.center_size = self.W.size
+ *         else:
+ */
+    goto __pyx_L4;
+  }
 
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
+  /* "tkwant/onebody/kernels.pyx":119
+ *             self.center_size = self.W.size
+ *         else:
+ *             self.center_size = self.size             # <<<<<<<<<<<<<<
+ * 
+ *         if work is None:
+ */
+  /*else*/ {
+    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 119, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_center_size, __pyx_t_2) < 0) __PYX_ERR(0, 119, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  }
+  __pyx_L4:;
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_7CKernel_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("__setstate_cython__", 0);
+  /* "tkwant/onebody/kernels.pyx":121
+ *             self.center_size = self.size
+ * 
+ *         if work is None:             # <<<<<<<<<<<<<<
+ *             self._tmp = np.zeros((self.size,), dtype=complex)
+ *         else:
+ */
+  __pyx_t_3 = (__pyx_v_work == Py_None);
+  __pyx_t_4 = (__pyx_t_3 != 0);
+  if (__pyx_t_4) {
 
-  /* "(tree fragment)":4
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")             # <<<<<<<<<<<<<<
+    /* "tkwant/onebody/kernels.pyx":122
+ * 
+ *         if work is None:
+ *             self._tmp = np.zeros((self.size,), dtype=complex)             # <<<<<<<<<<<<<<
+ *         else:
+ *             if work.size < self.center_size:
  */
-  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__3, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(1, 4, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_GIVEREF(__pyx_t_2);
+    PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2);
+    __pyx_t_2 = 0;
+    __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_GIVEREF(__pyx_t_5);
+    PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5);
+    __pyx_t_5 = 0;
+    __pyx_t_5 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 122, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_tmp, __pyx_t_6) < 0) __PYX_ERR(0, 122, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
 
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
+    /* "tkwant/onebody/kernels.pyx":121
+ *             self.center_size = self.size
+ * 
+ *         if work is None:             # <<<<<<<<<<<<<<
+ *             self._tmp = np.zeros((self.size,), dtype=complex)
+ *         else:
  */
+    goto __pyx_L5;
+  }
 
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.CKernel.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
+  /* "tkwant/onebody/kernels.pyx":124
+ *             self._tmp = np.zeros((self.size,), dtype=complex)
+ *         else:
+ *             if work.size < self.center_size:             # <<<<<<<<<<<<<<
+ *                 raise ValueError('work array size={} must be at least '
+ *                      'the size of the central system={}'
+ */
+  /*else*/ {
+    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_work, __pyx_n_s_size); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 124, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_center_size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 124, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_2 = PyObject_RichCompare(__pyx_t_6, __pyx_t_5, Py_LT); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 124, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely(__pyx_t_4 < 0)) __PYX_ERR(0, 124, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    if (unlikely(__pyx_t_4)) {
 
-/* "tkwant/onebody/kernels.pyx":96
+      /* "tkwant/onebody/kernels.pyx":127
+ *                 raise ValueError('work array size={} must be at least '
+ *                      'the size of the central system={}'
+ *                      .format(work.size, self.center_size))             # <<<<<<<<<<<<<<
+ *             self._tmp = work
  * 
- * # C wrapped to access pure Python Kernel implementation
- * cdef void _wrapped_rhs(const void *self, const complex *psi, complex *dpsidt,             # <<<<<<<<<<<<<<
- *                        double time) except *:
- *     cdef size_t size = (<object>self).size
  */
+      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_kp_u_work_array_size_must_be_at_least, __pyx_n_s_format); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 127, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_work, __pyx_n_s_size); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 127, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_6);
+      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_center_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 127, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_1);
+      __pyx_t_7 = NULL;
+      __pyx_t_8 = 0;
+      if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_5))) {
+        __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_5);
+        if (likely(__pyx_t_7)) {
+          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
+          __Pyx_INCREF(__pyx_t_7);
+          __Pyx_INCREF(function);
+          __Pyx_DECREF_SET(__pyx_t_5, function);
+          __pyx_t_8 = 1;
+        }
+      }
+      #if CYTHON_FAST_PYCALL
+      if (PyFunction_Check(__pyx_t_5)) {
+        PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_6, __pyx_t_1};
+        __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 127, __pyx_L1_error)
+        __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+        __Pyx_GOTREF(__pyx_t_2);
+        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+      } else
+      #endif
+      #if CYTHON_FAST_PYCCALL
+      if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
+        PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_6, __pyx_t_1};
+        __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 127, __pyx_L1_error)
+        __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+        __Pyx_GOTREF(__pyx_t_2);
+        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+      } else
+      #endif
+      {
+        __pyx_t_9 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 127, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_9);
+        if (__pyx_t_7) {
+          __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_7); __pyx_t_7 = NULL;
+        }
+        __Pyx_GIVEREF(__pyx_t_6);
+        PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_8, __pyx_t_6);
+        __Pyx_GIVEREF(__pyx_t_1);
+        PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_8, __pyx_t_1);
+        __pyx_t_6 = 0;
+        __pyx_t_1 = 0;
+        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_9, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 127, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_2);
+        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+      }
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-static void __pyx_f_6tkwant_7onebody_7kernels__wrapped_rhs(void const *__pyx_v_self, __pyx_t_double_complex const *__pyx_v_psi, __pyx_t_double_complex *__pyx_v_dpsidt, double __pyx_v_time) {
-  CYTHON_UNUSED size_t __pyx_v_size;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  size_t __pyx_t_2;
-  PyObject *__pyx_t_3 = NULL;
-  struct __pyx_array_obj *__pyx_t_4 = NULL;
-  PyObject *__pyx_t_5 = NULL;
-  PyObject *__pyx_t_6 = NULL;
-  struct __pyx_array_obj *__pyx_t_7 = NULL;
-  int __pyx_t_8;
-  PyObject *__pyx_t_9 = NULL;
-  __Pyx_RefNannySetupContext("_wrapped_rhs", 0);
+      /* "tkwant/onebody/kernels.pyx":125
+ *         else:
+ *             if work.size < self.center_size:
+ *                 raise ValueError('work array size={} must be at least '             # <<<<<<<<<<<<<<
+ *                      'the size of the central system={}'
+ *                      .format(work.size, self.center_size))
+ */
+      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 125, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_Raise(__pyx_t_5, 0, 0, 0);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __PYX_ERR(0, 125, __pyx_L1_error)
 
-  /* "tkwant/onebody/kernels.pyx":98
- * cdef void _wrapped_rhs(const void *self, const complex *psi, complex *dpsidt,
- *                        double time) except *:
- *     cdef size_t size = (<object>self).size             # <<<<<<<<<<<<<<
- *     (<object>self).rhs(<complex[:size]>psi, <complex[:size]>dpsidt, time)
- * 
+      /* "tkwant/onebody/kernels.pyx":124
+ *             self._tmp = np.zeros((self.size,), dtype=complex)
+ *         else:
+ *             if work.size < self.center_size:             # <<<<<<<<<<<<<<
+ *                 raise ValueError('work array size={} must be at least '
+ *                      'the size of the central system={}'
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 98, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyInt_As_size_t(__pyx_t_1); if (unlikely((__pyx_t_2 == (size_t)-1) && PyErr_Occurred())) __PYX_ERR(0, 98, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v_size = __pyx_t_2;
+    }
 
-  /* "tkwant/onebody/kernels.pyx":99
- *                        double time) except *:
- *     cdef size_t size = (<object>self).size
- *     (<object>self).rhs(<complex[:size]>psi, <complex[:size]>dpsidt, time)             # <<<<<<<<<<<<<<
- * 
+    /* "tkwant/onebody/kernels.pyx":128
+ *                      'the size of the central system={}'
+ *                      .format(work.size, self.center_size))
+ *             self._tmp = work             # <<<<<<<<<<<<<<
  * 
+ *     def rhs(self, energy=None):
  */
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_rhs); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 99, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  if (!__pyx_v_psi) {
-    PyErr_SetString(PyExc_ValueError,"Cannot create cython.array from NULL pointer");
-    __PYX_ERR(0, 99, __pyx_L1_error)
-  }
-  __pyx_t_6 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex);
-  __pyx_t_5 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_size));
-  if (unlikely(!__pyx_t_6 || !__pyx_t_5 || !PyBytes_AsString(__pyx_t_6))) __PYX_ERR(0, 99, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_4 = __pyx_array_new(__pyx_t_5, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_6), (char *) "c", (char *) __pyx_v_psi);
-  if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 99, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  if (!__pyx_v_dpsidt) {
-    PyErr_SetString(PyExc_ValueError,"Cannot create cython.array from NULL pointer");
-    __PYX_ERR(0, 99, __pyx_L1_error)
-  }
-  __pyx_t_5 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex);
-  __pyx_t_6 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_size));
-  if (unlikely(!__pyx_t_5 || !__pyx_t_6 || !PyBytes_AsString(__pyx_t_5))) __PYX_ERR(0, 99, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_GOTREF(__pyx_t_6);
-  __pyx_t_7 = __pyx_array_new(__pyx_t_6, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_5), (char *) "c", (char *) __pyx_v_dpsidt);
-  if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 99, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_7);
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 99, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_6 = NULL;
-  __pyx_t_8 = 0;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
-    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_3);
-    if (likely(__pyx_t_6)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
-      __Pyx_INCREF(__pyx_t_6);
-      __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_3, function);
-      __pyx_t_8 = 1;
-    }
-  }
-  #if CYTHON_FAST_PYCALL
-  if (PyFunction_Check(__pyx_t_3)) {
-    PyObject *__pyx_temp[4] = {__pyx_t_6, ((PyObject *)__pyx_t_4), ((PyObject *)__pyx_t_7), __pyx_t_5};
-    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 99, __pyx_L1_error)
-    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
-    __Pyx_DECREF(((PyObject *)__pyx_t_7)); __pyx_t_7 = 0;
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  } else
-  #endif
-  #if CYTHON_FAST_PYCCALL
-  if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
-    PyObject *__pyx_temp[4] = {__pyx_t_6, ((PyObject *)__pyx_t_4), ((PyObject *)__pyx_t_7), __pyx_t_5};
-    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 99, __pyx_L1_error)
-    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(((PyObject *)__pyx_t_4)); __pyx_t_4 = 0;
-    __Pyx_DECREF(((PyObject *)__pyx_t_7)); __pyx_t_7 = 0;
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  } else
-  #endif
-  {
-    __pyx_t_9 = PyTuple_New(3+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 99, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    if (__pyx_t_6) {
-      __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_6); __pyx_t_6 = NULL;
-    }
-    __Pyx_GIVEREF(((PyObject *)__pyx_t_4));
-    PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_8, ((PyObject *)__pyx_t_4));
-    __Pyx_GIVEREF(((PyObject *)__pyx_t_7));
-    PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_8, ((PyObject *)__pyx_t_7));
-    __Pyx_GIVEREF(__pyx_t_5);
-    PyTuple_SET_ITEM(__pyx_t_9, 2+__pyx_t_8, __pyx_t_5);
-    __pyx_t_4 = 0;
-    __pyx_t_7 = 0;
-    __pyx_t_5 = 0;
-    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_9, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 99, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_tmp, __pyx_v_work) < 0) __PYX_ERR(0, 128, __pyx_L1_error)
   }
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_L5:;
 
-  /* "tkwant/onebody/kernels.pyx":96
+  /* "tkwant/onebody/kernels.pyx":103
+ *     """
  * 
- * # C wrapped to access pure Python Kernel implementation
- * cdef void _wrapped_rhs(const void *self, const complex *psi, complex *dpsidt,             # <<<<<<<<<<<<<<
- *                        double time) except *:
- *     cdef size_t size = (<object>self).size
+ *     def __init__(self, H0, W, psi_st=None, work=None):             # <<<<<<<<<<<<<<
+ * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):
  */
 
   /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_XDECREF(((PyObject *)__pyx_t_4));
+  __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_5);
   __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_XDECREF(((PyObject *)__pyx_t_7));
+  __Pyx_XDECREF(__pyx_t_7);
   __Pyx_XDECREF(__pyx_t_9);
-  __Pyx_AddTraceback("tkwant.onebody.kernels._wrapped_rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
   __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
+  return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":105
- *     """C interface to python-implemented kernels."""
+/* "tkwant/onebody/kernels.pyx":130
+ *             self._tmp = work
  * 
- *     def __init__(self, py_kernel):             # <<<<<<<<<<<<<<
- *         pass
+ *     def rhs(self, energy=None):             # <<<<<<<<<<<<<<
  * 
+ *         if energy is None:
  */
 
 /* Python wrapper */
-static int __pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static int __pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  CYTHON_UNUSED PyObject *__pyx_v_py_kernel = 0;
-  int __pyx_r;
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_3rhs(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_5Scipy_2rhs[] = "Scipy.rhs(self, energy=None)";
+static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_3rhs = {"rhs", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_3rhs, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_5Scipy_2rhs};
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_3rhs(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  PyObject *__pyx_v_self = 0;
+  PyObject *__pyx_v_energy = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
+  __Pyx_RefNannySetupContext("rhs (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_py_kernel,0};
-    PyObject* values[1] = {0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_energy,0};
+    PyObject* values[2] = {0,0};
+    values[1] = ((PyObject *)((PyObject *)Py_None));
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_py_kernel)) != 0)) kw_args--;
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
+        CYTHON_FALLTHROUGH;
+        case  1:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_energy);
+          if (value) { values[1] = value; kw_args--; }
+        }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 105, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "rhs") < 0)) __PYX_ERR(0, 130, __pyx_L3_error)
       }
-    } else if (PyTuple_GET_SIZE(__pyx_args) != 1) {
-      goto __pyx_L5_argtuple_error;
     } else {
-      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
-    }
-    __pyx_v_py_kernel = values[0];
-  }
-  goto __pyx_L4_argument_unpacking_done;
-  __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 1, 1, 1, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 105, __pyx_L3_error)
-  __pyx_L3_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.PyCKernel.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __Pyx_RefNannyFinishContext();
-  return -1;
-  __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *)__pyx_v_self), __pyx_v_py_kernel);
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static int __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_py_kernel) {
-  int __pyx_r;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__init__", 0);
-
-  /* function exit code */
-  __pyx_r = 0;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "tkwant/onebody/kernels.pyx":108
- *         pass
- * 
- *     def __cinit__(self, py_kernel):             # <<<<<<<<<<<<<<
- *         self.size = py_kernel.size
- *         self.nevals = py_kernel.nevals
- */
-
-/* Python wrapper */
-static int __pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_3__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static int __pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_3__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  PyObject *__pyx_v_py_kernel = 0;
-  int __pyx_r;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__cinit__ (wrapper)", 0);
-  {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_py_kernel,0};
-    PyObject* values[1] = {0};
-    if (unlikely(__pyx_kwds)) {
-      Py_ssize_t kw_args;
-      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
-      switch (pos_args) {
-        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      switch (PyTuple_GET_SIZE(__pyx_args)) {
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
-        case  0: break;
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        break;
         default: goto __pyx_L5_argtuple_error;
       }
-      kw_args = PyDict_Size(__pyx_kwds);
-      switch (pos_args) {
-        case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_py_kernel)) != 0)) kw_args--;
-        else goto __pyx_L5_argtuple_error;
-      }
-      if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__cinit__") < 0)) __PYX_ERR(0, 108, __pyx_L3_error)
-      }
-    } else if (PyTuple_GET_SIZE(__pyx_args) != 1) {
-      goto __pyx_L5_argtuple_error;
-    } else {
-      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
     }
-    __pyx_v_py_kernel = values[0];
+    __pyx_v_self = values[0];
+    __pyx_v_energy = values[1];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 1, 1, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 108, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("rhs", 0, 1, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 130, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.PyCKernel.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
-  return -1;
+  return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_2__cinit__(((struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *)__pyx_v_self), __pyx_v_py_kernel);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_5Scipy_2rhs(__pyx_self, __pyx_v_self, __pyx_v_energy);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static int __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_2__cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self, PyObject *__pyx_v_py_kernel) {
-  int __pyx_r;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  int __pyx_t_2;
-  __Pyx_RefNannySetupContext("__cinit__", 0);
-
-  /* "tkwant/onebody/kernels.pyx":109
- * 
- *     def __cinit__(self, py_kernel):
- *         self.size = py_kernel.size             # <<<<<<<<<<<<<<
- *         self.nevals = py_kernel.nevals
- *         self.c_rhs = _wrapped_rhs
- */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_py_kernel, __pyx_n_s_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_2 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 109, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v_self->__pyx_base.__pyx_base.size = __pyx_t_2;
-
-  /* "tkwant/onebody/kernels.pyx":110
- *     def __cinit__(self, py_kernel):
- *         self.size = py_kernel.size
- *         self.nevals = py_kernel.nevals             # <<<<<<<<<<<<<<
- *         self.c_rhs = _wrapped_rhs
- *         self.c_self = <void*>py_kernel
- */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_py_kernel, __pyx_n_s_nevals); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 110, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_2 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 110, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v_self->__pyx_base.__pyx_base.nevals = __pyx_t_2;
-
-  /* "tkwant/onebody/kernels.pyx":111
- *         self.size = py_kernel.size
- *         self.nevals = py_kernel.nevals
- *         self.c_rhs = _wrapped_rhs             # <<<<<<<<<<<<<<
- *         self.c_self = <void*>py_kernel
- *         # increment the reference count to prevent garbage collection
- */
-  __pyx_v_self->__pyx_base.c_rhs = __pyx_f_6tkwant_7onebody_7kernels__wrapped_rhs;
-
-  /* "tkwant/onebody/kernels.pyx":112
- *         self.nevals = py_kernel.nevals
- *         self.c_rhs = _wrapped_rhs
- *         self.c_self = <void*>py_kernel             # <<<<<<<<<<<<<<
- *         # increment the reference count to prevent garbage collection
- *         Py_INCREF(<object>self.c_self)
- */
-  __pyx_v_self->__pyx_base.c_self = ((void *)__pyx_v_py_kernel);
-
-  /* "tkwant/onebody/kernels.pyx":114
- *         self.c_self = <void*>py_kernel
- *         # increment the reference count to prevent garbage collection
- *         Py_INCREF(<object>self.c_self)             # <<<<<<<<<<<<<<
- * 
- *     def __dealloc__(self):
- */
-  __pyx_t_1 = ((PyObject *)__pyx_v_self->__pyx_base.c_self);
-  __Pyx_INCREF(__pyx_t_1);
-  Py_INCREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-  /* "tkwant/onebody/kernels.pyx":108
- *         pass
- * 
- *     def __cinit__(self, py_kernel):             # <<<<<<<<<<<<<<
- *         self.size = py_kernel.size
- *         self.nevals = py_kernel.nevals
- */
-
-  /* function exit code */
-  __pyx_r = 0;
-  goto __pyx_L0;
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.PyCKernel.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = -1;
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "tkwant/onebody/kernels.pyx":116
- *         Py_INCREF(<object>self.c_self)
- * 
- *     def __dealloc__(self):             # <<<<<<<<<<<<<<
- *         Py_DECREF(<object>self.c_self)
- * 
- */
-
-/* Python wrapper */
-static void __pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_5__dealloc__(PyObject *__pyx_v_self); /*proto*/
-static void __pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_5__dealloc__(PyObject *__pyx_v_self) {
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__dealloc__ (wrapper)", 0);
-  __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_4__dealloc__(((struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *)__pyx_v_self));
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-}
-
-static void __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_4__dealloc__(struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self) {
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("__dealloc__", 0);
-
-  /* "tkwant/onebody/kernels.pyx":117
- * 
- *     def __dealloc__(self):
- *         Py_DECREF(<object>self.c_self)             # <<<<<<<<<<<<<<
- * 
- * 
- */
-  __pyx_t_1 = ((PyObject *)__pyx_v_self->__pyx_base.c_self);
-  __Pyx_INCREF(__pyx_t_1);
-  Py_DECREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-  /* "tkwant/onebody/kernels.pyx":116
- *         Py_INCREF(<object>self.c_self)
- * 
- *     def __dealloc__(self):             # <<<<<<<<<<<<<<
- *         Py_DECREF(<object>self.c_self)
- * 
- */
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-}
-
-/* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_7__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_9PyCKernel_6__reduce_cython__[] = "PyCKernel.__reduce_cython__(self)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_7__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_6__reduce_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *)__pyx_v_self));
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_6__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy_2rhs(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_energy) {
+  PyObject *__pyx_v_H0 = NULL;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("__reduce_cython__", 0);
-
-  /* "(tree fragment)":2
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- */
-  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 2, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(1, 2, __pyx_L1_error)
-
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.PyCKernel.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_9__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_9PyCKernel_8__setstate_cython__[] = "PyCKernel.__setstate_cython__(self, __pyx_state)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_9__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_8__setstate_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *)__pyx_v_self), ((PyObject *)__pyx_v___pyx_state));
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_9PyCKernel_8__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("__setstate_cython__", 0);
-
-  /* "(tree fragment)":4
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
- */
-  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(1, 4, __pyx_L1_error)
-
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.PyCKernel.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "tkwant/onebody/kernels.pyx":120
- * 
- * 
- * cpdef CKernel extract_c_kernel(Kernel py_kernel):             # <<<<<<<<<<<<<<
- *     """Extract a C-level interface from a (possibly pure-python) Kernel."""
- *     if isinstance(py_kernel, CKernel):
- */
-
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_1extract_c_kernel(PyObject *__pyx_self, PyObject *__pyx_v_py_kernel); /*proto*/
-static struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *__pyx_f_6tkwant_7onebody_7kernels_extract_c_kernel(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_py_kernel, CYTHON_UNUSED int __pyx_skip_dispatch) {
-  struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
-  __Pyx_RefNannySetupContext("extract_c_kernel", 0);
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
+  PyObject *__pyx_t_7 = NULL;
+  PyObject *__pyx_t_8 = NULL;
+  PyObject *__pyx_t_9 = NULL;
+  PyObject *__pyx_t_10 = NULL;
+  int __pyx_t_11;
+  PyObject *__pyx_t_12 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("rhs", 0);
 
-  /* "tkwant/onebody/kernels.pyx":122
- * cpdef CKernel extract_c_kernel(Kernel py_kernel):
- *     """Extract a C-level interface from a (possibly pure-python) Kernel."""
- *     if isinstance(py_kernel, CKernel):             # <<<<<<<<<<<<<<
- *         return py_kernel
- *     elif not callable(py_kernel.rhs):
+  /* "tkwant/onebody/kernels.pyx":132
+ *     def rhs(self, energy=None):
+ * 
+ *         if energy is None:             # <<<<<<<<<<<<<<
+ *             H0 = self.H0
+ *         else:
  */
-  __pyx_t_1 = __Pyx_TypeCheck(((PyObject *)__pyx_v_py_kernel), __pyx_ptype_6tkwant_7onebody_7kernels_CKernel); 
+  __pyx_t_1 = (__pyx_v_energy == Py_None);
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "tkwant/onebody/kernels.pyx":123
- *     """Extract a C-level interface from a (possibly pure-python) Kernel."""
- *     if isinstance(py_kernel, CKernel):
- *         return py_kernel             # <<<<<<<<<<<<<<
- *     elif not callable(py_kernel.rhs):
- *         raise TypeError('Kernel must have a `rhs` method.')
+    /* "tkwant/onebody/kernels.pyx":133
+ * 
+ *         if energy is None:
+ *             H0 = self.H0             # <<<<<<<<<<<<<<
+ *         else:
+ *             H0 = self.H0 - energy * sp.eye(self.size)
  */
-    __Pyx_XDECREF(((PyObject *)__pyx_r));
-    if (!(likely(((((PyObject *)__pyx_v_py_kernel)) == Py_None) || likely(__Pyx_TypeTest(((PyObject *)__pyx_v_py_kernel), __pyx_ptype_6tkwant_7onebody_7kernels_CKernel))))) __PYX_ERR(0, 123, __pyx_L1_error)
-    __Pyx_INCREF(((PyObject *)__pyx_v_py_kernel));
-    __pyx_r = ((struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *)__pyx_v_py_kernel);
-    goto __pyx_L0;
+    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 133, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_v_H0 = __pyx_t_3;
+    __pyx_t_3 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":122
- * cpdef CKernel extract_c_kernel(Kernel py_kernel):
- *     """Extract a C-level interface from a (possibly pure-python) Kernel."""
- *     if isinstance(py_kernel, CKernel):             # <<<<<<<<<<<<<<
- *         return py_kernel
- *     elif not callable(py_kernel.rhs):
+    /* "tkwant/onebody/kernels.pyx":132
+ *     def rhs(self, energy=None):
+ * 
+ *         if energy is None:             # <<<<<<<<<<<<<<
+ *             H0 = self.H0
+ *         else:
  */
+    goto __pyx_L3;
   }
 
-  /* "tkwant/onebody/kernels.pyx":124
- *     if isinstance(py_kernel, CKernel):
- *         return py_kernel
- *     elif not callable(py_kernel.rhs):             # <<<<<<<<<<<<<<
- *         raise TypeError('Kernel must have a `rhs` method.')
- *     return PyCKernel(py_kernel)
- */
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_py_kernel), __pyx_n_s_rhs); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 124, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_2 = __Pyx_PyCallable_Check(__pyx_t_3); if (unlikely(__pyx_t_2 == ((int)-1))) __PYX_ERR(0, 124, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_1 = ((!(__pyx_t_2 != 0)) != 0);
-  if (unlikely(__pyx_t_1)) {
-
-    /* "tkwant/onebody/kernels.pyx":125
- *         return py_kernel
- *     elif not callable(py_kernel.rhs):
- *         raise TypeError('Kernel must have a `rhs` method.')             # <<<<<<<<<<<<<<
- *     return PyCKernel(py_kernel)
+  /* "tkwant/onebody/kernels.pyx":135
+ *             H0 = self.H0
+ *         else:
+ *             H0 = self.H0 - energy * sp.eye(self.size)             # <<<<<<<<<<<<<<
  * 
+ *         # The approach with a separated class ``_CalcRHS`` to calculate the r.h.s.
  */
-    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__6, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 125, __pyx_L1_error)
+  /*else*/ {
+    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 135, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
+    __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_sp); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 135, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_eye); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 135, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 135, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_7 = NULL;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_6))) {
+      __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_6);
+      if (likely(__pyx_t_7)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
+        __Pyx_INCREF(__pyx_t_7);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_6, function);
+      }
+    }
+    __pyx_t_4 = (__pyx_t_7) ? __Pyx_PyObject_Call2Args(__pyx_t_6, __pyx_t_7, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_5);
+    __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 135, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __pyx_t_6 = PyNumber_Multiply(__pyx_v_energy, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 135, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_t_4 = PyNumber_Subtract(__pyx_t_3, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 135, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __PYX_ERR(0, 125, __pyx_L1_error)
-
-    /* "tkwant/onebody/kernels.pyx":124
- *     if isinstance(py_kernel, CKernel):
- *         return py_kernel
- *     elif not callable(py_kernel.rhs):             # <<<<<<<<<<<<<<
- *         raise TypeError('Kernel must have a `rhs` method.')
- *     return PyCKernel(py_kernel)
- */
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __pyx_v_H0 = __pyx_t_4;
+    __pyx_t_4 = 0;
   }
+  __pyx_L3:;
 
-  /* "tkwant/onebody/kernels.pyx":126
- *     elif not callable(py_kernel.rhs):
- *         raise TypeError('Kernel must have a `rhs` method.')
- *     return PyCKernel(py_kernel)             # <<<<<<<<<<<<<<
- * 
+  /* "tkwant/onebody/kernels.pyx":150
+ *         # which not stored in the ``onebody.WaveFunction``, such
+ *         # that it is cleaned by the garbage collector.
+ *         return _CalcRHS(H0, self.W, self.psi_st, self.size, self.center_size, self._tmp)             # <<<<<<<<<<<<<<
  * 
+ *     def set_W(self, W):
  */
-  __Pyx_XDECREF(((PyObject *)__pyx_r));
-  __pyx_t_3 = __Pyx_PyObject_CallOneArg(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_PyCKernel), ((PyObject *)__pyx_v_py_kernel)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 126, __pyx_L1_error)
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_CalcRHS); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 150, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_W); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 150, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_r = ((struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel *)__pyx_t_3);
-  __pyx_t_3 = 0;
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_psi_st); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 150, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_size); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 150, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_7);
+  __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_center_size); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 150, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_8);
+  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_tmp); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 150, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_9);
+  __pyx_t_10 = NULL;
+  __pyx_t_11 = 0;
+  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_6))) {
+    __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_6);
+    if (likely(__pyx_t_10)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
+      __Pyx_INCREF(__pyx_t_10);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_6, function);
+      __pyx_t_11 = 1;
+    }
+  }
+  #if CYTHON_FAST_PYCALL
+  if (PyFunction_Check(__pyx_t_6)) {
+    PyObject *__pyx_temp[7] = {__pyx_t_10, __pyx_v_H0, __pyx_t_3, __pyx_t_5, __pyx_t_7, __pyx_t_8, __pyx_t_9};
+    __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_11, 6+__pyx_t_11); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 150, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+  } else
+  #endif
+  #if CYTHON_FAST_PYCCALL
+  if (__Pyx_PyFastCFunction_Check(__pyx_t_6)) {
+    PyObject *__pyx_temp[7] = {__pyx_t_10, __pyx_v_H0, __pyx_t_3, __pyx_t_5, __pyx_t_7, __pyx_t_8, __pyx_t_9};
+    __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_11, 6+__pyx_t_11); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 150, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+  } else
+  #endif
+  {
+    __pyx_t_12 = PyTuple_New(6+__pyx_t_11); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 150, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_12);
+    if (__pyx_t_10) {
+      __Pyx_GIVEREF(__pyx_t_10); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_10); __pyx_t_10 = NULL;
+    }
+    __Pyx_INCREF(__pyx_v_H0);
+    __Pyx_GIVEREF(__pyx_v_H0);
+    PyTuple_SET_ITEM(__pyx_t_12, 0+__pyx_t_11, __pyx_v_H0);
+    __Pyx_GIVEREF(__pyx_t_3);
+    PyTuple_SET_ITEM(__pyx_t_12, 1+__pyx_t_11, __pyx_t_3);
+    __Pyx_GIVEREF(__pyx_t_5);
+    PyTuple_SET_ITEM(__pyx_t_12, 2+__pyx_t_11, __pyx_t_5);
+    __Pyx_GIVEREF(__pyx_t_7);
+    PyTuple_SET_ITEM(__pyx_t_12, 3+__pyx_t_11, __pyx_t_7);
+    __Pyx_GIVEREF(__pyx_t_8);
+    PyTuple_SET_ITEM(__pyx_t_12, 4+__pyx_t_11, __pyx_t_8);
+    __Pyx_GIVEREF(__pyx_t_9);
+    PyTuple_SET_ITEM(__pyx_t_12, 5+__pyx_t_11, __pyx_t_9);
+    __pyx_t_3 = 0;
+    __pyx_t_5 = 0;
+    __pyx_t_7 = 0;
+    __pyx_t_8 = 0;
+    __pyx_t_9 = 0;
+    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_12, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 150, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
+  }
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __pyx_r = __pyx_t_4;
+  __pyx_t_4 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":120
+  /* "tkwant/onebody/kernels.pyx":130
+ *             self._tmp = work
  * 
+ *     def rhs(self, energy=None):             # <<<<<<<<<<<<<<
  * 
- * cpdef CKernel extract_c_kernel(Kernel py_kernel):             # <<<<<<<<<<<<<<
- *     """Extract a C-level interface from a (possibly pure-python) Kernel."""
- *     if isinstance(py_kernel, CKernel):
+ *         if energy is None:
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.extract_c_kernel", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = 0;
-  __pyx_L0:;
-  __Pyx_XGIVEREF((PyObject *)__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_1extract_c_kernel(PyObject *__pyx_self, PyObject *__pyx_v_py_kernel); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_extract_c_kernel[] = "extract_c_kernel(Kernel py_kernel) -> CKernel\nExtract a C-level interface from a (possibly pure-python) Kernel.";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_1extract_c_kernel(PyObject *__pyx_self, PyObject *__pyx_v_py_kernel) {
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("extract_c_kernel (wrapper)", 0);
-  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_py_kernel), __pyx_ptype_6tkwant_7onebody_7kernels_Kernel, 1, "py_kernel", 0))) __PYX_ERR(0, 120, __pyx_L1_error)
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_extract_c_kernel(__pyx_self, ((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v_py_kernel));
-
-  /* function exit code */
-  goto __pyx_L0;
-  __pyx_L1_error:;
-  __pyx_r = NULL;
-  __pyx_L0:;
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_extract_c_kernel(CYTHON_UNUSED PyObject *__pyx_self, struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *__pyx_v_py_kernel) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("extract_c_kernel", 0);
-  __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = ((PyObject *)__pyx_f_6tkwant_7onebody_7kernels_extract_c_kernel(__pyx_v_py_kernel, 0)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 120, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_r = __pyx_t_1;
-  __pyx_t_1 = 0;
-  goto __pyx_L0;
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.extract_c_kernel", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
+  __Pyx_XDECREF(__pyx_t_7);
+  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_XDECREF(__pyx_t_9);
+  __Pyx_XDECREF(__pyx_t_10);
+  __Pyx_XDECREF(__pyx_t_12);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v_H0);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":167
- *     """
+/* "tkwant/onebody/kernels.pyx":152
+ *         return _CalcRHS(H0, self.W, self.psi_st, self.size, self.center_size, self._tmp)
  * 
- *     def __init__(self, H0, W, params, psi_st=None):             # <<<<<<<<<<<<<<
- *         self.H0 = H0.tocsr()
+ *     def set_W(self, W):             # <<<<<<<<<<<<<<
+ *         '''Set the time dependent perturbation W(t)'''
  *         self.W = W
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_1__init__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_5Scipy___init__[] = "Scipy.__init__(self, H0, W, params, psi_st=None)";
-static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_1__init__ = {"__init__", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_1__init__, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_5Scipy___init__};
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_1__init__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_5set_W(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_5Scipy_4set_W[] = "Scipy.set_W(self, W)\nSet the time dependent perturbation W(t)";
+static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_5set_W = {"set_W", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_5set_W, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_5Scipy_4set_W};
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_5set_W(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_self = 0;
-  PyObject *__pyx_v_H0 = 0;
   PyObject *__pyx_v_W = 0;
-  PyObject *__pyx_v_params = 0;
-  PyObject *__pyx_v_psi_st = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
+  __Pyx_RefNannySetupContext("set_W (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_H0,&__pyx_n_s_W,&__pyx_n_s_params,&__pyx_n_s_psi_st,0};
-    PyObject* values[5] = {0,0,0,0,0};
-    values[4] = ((PyObject *)((PyObject *)Py_None));
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_W,0};
+    PyObject* values[2] = {0,0};
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
-        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
-        CYTHON_FALLTHROUGH;
-        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
-        CYTHON_FALLTHROUGH;
-        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
-        CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
-        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_H0)) != 0)) kw_args--;
-        else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 4, 5, 1); __PYX_ERR(0, 167, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  2:
-        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
-        else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 4, 5, 2); __PYX_ERR(0, 167, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  3:
-        if (likely((values[3] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_params)) != 0)) kw_args--;
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 4, 5, 3); __PYX_ERR(0, 167, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  4:
-        if (kw_args > 0) {
-          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st);
-          if (value) { values[4] = value; kw_args--; }
+          __Pyx_RaiseArgtupleInvalid("set_W", 1, 2, 2, 1); __PYX_ERR(0, 152, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 167, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "set_W") < 0)) __PYX_ERR(0, 152, __pyx_L3_error)
       }
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
+      goto __pyx_L5_argtuple_error;
     } else {
-      switch (PyTuple_GET_SIZE(__pyx_args)) {
-        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
-        CYTHON_FALLTHROUGH;
-        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
-        values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
-        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
-        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
-        break;
-        default: goto __pyx_L5_argtuple_error;
-      }
+      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
     }
     __pyx_v_self = values[0];
-    __pyx_v_H0 = values[1];
-    __pyx_v_W = values[2];
-    __pyx_v_params = values[3];
-    __pyx_v_psi_st = values[4];
+    __pyx_v_W = values[1];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 0, 4, 5, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 167, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("set_W", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 152, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.set_W", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_5Scipy___init__(__pyx_self, __pyx_v_self, __pyx_v_H0, __pyx_v_W, __pyx_v_params, __pyx_v_psi_st);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_5Scipy_4set_W(__pyx_self, __pyx_v_self, __pyx_v_W);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy___init__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, PyObject *__pyx_v_params, PyObject *__pyx_v_psi_st) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy_4set_W(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_W) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
-  int __pyx_t_4;
-  int __pyx_t_5;
-  PyObject *__pyx_t_6 = NULL;
-  __Pyx_RefNannySetupContext("__init__", 0);
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("set_W", 0);
 
-  /* "tkwant/onebody/kernels.pyx":168
- * 
- *     def __init__(self, H0, W, params, psi_st=None):
- *         self.H0 = H0.tocsr()             # <<<<<<<<<<<<<<
- *         self.W = W
- *         self.psi_st = psi_st
- */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_H0, __pyx_n_s_tocsr); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 168, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = NULL;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
-    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
-    if (likely(__pyx_t_3)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-      __Pyx_INCREF(__pyx_t_3);
-      __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_2, function);
-    }
-  }
-  __pyx_t_1 = (__pyx_t_3) ? __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallNoArg(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 168, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_H0, __pyx_t_1) < 0) __PYX_ERR(0, 168, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-  /* "tkwant/onebody/kernels.pyx":169
- *     def __init__(self, H0, W, params, psi_st=None):
- *         self.H0 = H0.tocsr()
+  /* "tkwant/onebody/kernels.pyx":154
+ *     def set_W(self, W):
+ *         '''Set the time dependent perturbation W(t)'''
  *         self.W = W             # <<<<<<<<<<<<<<
- *         self.psi_st = psi_st
- *         self.size = self.H0.shape[0]
- */
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_W, __pyx_v_W) < 0) __PYX_ERR(0, 169, __pyx_L1_error)
-
-  /* "tkwant/onebody/kernels.pyx":170
- *         self.H0 = H0.tocsr()
- *         self.W = W
- *         self.psi_st = psi_st             # <<<<<<<<<<<<<<
- *         self.size = self.H0.shape[0]
- *         if W is not None:
- */
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_psi_st, __pyx_v_psi_st) < 0) __PYX_ERR(0, 170, __pyx_L1_error)
-
-  /* "tkwant/onebody/kernels.pyx":171
- *         self.W = W
- *         self.psi_st = psi_st
- *         self.size = self.H0.shape[0]             # <<<<<<<<<<<<<<
- *         if W is not None:
- *             self.center_size = self.W.size
- */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 171, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_shape); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 171, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_2, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 171, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_size, __pyx_t_1) < 0) __PYX_ERR(0, 171, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-  /* "tkwant/onebody/kernels.pyx":172
- *         self.psi_st = psi_st
- *         self.size = self.H0.shape[0]
- *         if W is not None:             # <<<<<<<<<<<<<<
- *             self.center_size = self.W.size
- *         else:
- */
-  __pyx_t_4 = (__pyx_v_W != Py_None);
-  __pyx_t_5 = (__pyx_t_4 != 0);
-  if (__pyx_t_5) {
-
-    /* "tkwant/onebody/kernels.pyx":173
- *         self.size = self.H0.shape[0]
- *         if W is not None:
- *             self.center_size = self.W.size             # <<<<<<<<<<<<<<
- *         else:
- *             self.center_size = self.size
- */
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_W); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 173, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 173, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_center_size, __pyx_t_2) < 0) __PYX_ERR(0, 173, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":172
- *         self.psi_st = psi_st
- *         self.size = self.H0.shape[0]
- *         if W is not None:             # <<<<<<<<<<<<<<
- *             self.center_size = self.W.size
- *         else:
- */
-    goto __pyx_L3;
-  }
-
-  /* "tkwant/onebody/kernels.pyx":175
- *             self.center_size = self.W.size
- *         else:
- *             self.center_size = self.size             # <<<<<<<<<<<<<<
- *         self.nevals = 0
- *         self.params = params
- */
-  /*else*/ {
-    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 175, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_center_size, __pyx_t_2) < 0) __PYX_ERR(0, 175, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  }
-  __pyx_L3:;
-
-  /* "tkwant/onebody/kernels.pyx":176
- *         else:
- *             self.center_size = self.size
- *         self.nevals = 0             # <<<<<<<<<<<<<<
- *         self.params = params
- *         self._tmp = np.zeros((self.size,), dtype=complex)
- */
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_nevals, __pyx_int_0) < 0) __PYX_ERR(0, 176, __pyx_L1_error)
-
-  /* "tkwant/onebody/kernels.pyx":177
- *             self.center_size = self.size
- *         self.nevals = 0
- *         self.params = params             # <<<<<<<<<<<<<<
- *         self._tmp = np.zeros((self.size,), dtype=complex)
  * 
- */
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_params, __pyx_v_params) < 0) __PYX_ERR(0, 177, __pyx_L1_error)
-
-  /* "tkwant/onebody/kernels.pyx":178
- *         self.nevals = 0
- *         self.params = params
- *         self._tmp = np.zeros((self.size,), dtype=complex)             # <<<<<<<<<<<<<<
  * 
- *     def set_params(self, params):
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 178, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 178, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 178, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 178, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_GIVEREF(__pyx_t_2);
-  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
-  __pyx_t_2 = 0;
-  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 178, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_GIVEREF(__pyx_t_3);
-  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3);
-  __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 178, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 178, __pyx_L1_error)
-  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 178, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_tmp, __pyx_t_6) < 0) __PYX_ERR(0, 178, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_W, __pyx_v_W) < 0) __PYX_ERR(0, 154, __pyx_L1_error)
 
-  /* "tkwant/onebody/kernels.pyx":167
- *     """
+  /* "tkwant/onebody/kernels.pyx":152
+ *         return _CalcRHS(H0, self.W, self.psi_st, self.size, self.center_size, self._tmp)
  * 
- *     def __init__(self, H0, W, params, psi_st=None):             # <<<<<<<<<<<<<<
- *         self.H0 = H0.tocsr()
+ *     def set_W(self, W):             # <<<<<<<<<<<<<<
+ *         '''Set the time dependent perturbation W(t)'''
  *         self.W = W
  */
 
   /* function exit code */
   __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.set_W", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":180
- *         self._tmp = np.zeros((self.size,), dtype=complex)
- * 
- *     def set_params(self, params):             # <<<<<<<<<<<<<<
- *         self.params = params
+/* "tkwant/onebody/kernels.pyx":159
+ * class _CalcRHS:
+ *     """Calculate the right-hand-side of the time-dependent Schrdinger equation."""
+ *     def __init__(self, H0, W, psi_st, size, center_size, tmp):             # <<<<<<<<<<<<<<
  * 
+ *         self.H0 = H0
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_3set_params(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_5Scipy_2set_params[] = "Scipy.set_params(self, params)";
-static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_3set_params = {"set_params", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_3set_params, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_5Scipy_2set_params};
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_3set_params(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_8_CalcRHS_1__init__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_8_CalcRHS___init__[] = "_CalcRHS.__init__(self, H0, W, psi_st, size, center_size, tmp)";
+static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_8_CalcRHS_1__init__ = {"__init__", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_8_CalcRHS_1__init__, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_8_CalcRHS___init__};
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_8_CalcRHS_1__init__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_self = 0;
-  PyObject *__pyx_v_params = 0;
+  PyObject *__pyx_v_H0 = 0;
+  PyObject *__pyx_v_W = 0;
+  PyObject *__pyx_v_psi_st = 0;
+  PyObject *__pyx_v_size = 0;
+  PyObject *__pyx_v_center_size = 0;
+  PyObject *__pyx_v_tmp = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("set_params (wrapper)", 0);
+  __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_params,0};
-    PyObject* values[2] = {0,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_H0,&__pyx_n_s_W,&__pyx_n_s_psi_st,&__pyx_n_s_size,&__pyx_n_s_center_size,&__pyx_n_s_tmp_2,0};
+    PyObject* values[7] = {0,0,0,0,0,0,0};
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
+        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
+        CYTHON_FALLTHROUGH;
+        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
+        CYTHON_FALLTHROUGH;
+        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+        CYTHON_FALLTHROUGH;
+        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+        CYTHON_FALLTHROUGH;
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
-        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_params)) != 0)) kw_args--;
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_H0)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 7, 7, 1); __PYX_ERR(0, 159, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  2:
+        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 7, 7, 2); __PYX_ERR(0, 159, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  3:
+        if (likely((values[3] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 7, 7, 3); __PYX_ERR(0, 159, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  4:
+        if (likely((values[4] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_size)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 7, 7, 4); __PYX_ERR(0, 159, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  5:
+        if (likely((values[5] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_center_size)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 7, 7, 5); __PYX_ERR(0, 159, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  6:
+        if (likely((values[6] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_tmp_2)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("set_params", 1, 2, 2, 1); __PYX_ERR(0, 180, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 7, 7, 6); __PYX_ERR(0, 159, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "set_params") < 0)) __PYX_ERR(0, 180, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 159, __pyx_L3_error)
       }
-    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 7) {
       goto __pyx_L5_argtuple_error;
     } else {
       values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
       values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
+      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
     }
     __pyx_v_self = values[0];
-    __pyx_v_params = values[1];
+    __pyx_v_H0 = values[1];
+    __pyx_v_W = values[2];
+    __pyx_v_psi_st = values[3];
+    __pyx_v_size = values[4];
+    __pyx_v_center_size = values[5];
+    __pyx_v_tmp = values[6];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("set_params", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 180, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 1, 7, 7, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 159, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.set_params", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHS.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_5Scipy_2set_params(__pyx_self, __pyx_v_self, __pyx_v_params);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_8_CalcRHS___init__(__pyx_self, __pyx_v_self, __pyx_v_H0, __pyx_v_W, __pyx_v_psi_st, __pyx_v_size, __pyx_v_center_size, __pyx_v_tmp);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy_2set_params(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_params) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_8_CalcRHS___init__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, PyObject *__pyx_v_psi_st, PyObject *__pyx_v_size, PyObject *__pyx_v_center_size, PyObject *__pyx_v_tmp) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("set_params", 0);
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":181
+  /* "tkwant/onebody/kernels.pyx":161
+ *     def __init__(self, H0, W, psi_st, size, center_size, tmp):
  * 
- *     def set_params(self, params):
- *         self.params = params             # <<<<<<<<<<<<<<
+ *         self.H0 = H0             # <<<<<<<<<<<<<<
+ *         self.W = W
+ *         self.psi_st = psi_st
+ */
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_H0, __pyx_v_H0) < 0) __PYX_ERR(0, 161, __pyx_L1_error)
+
+  /* "tkwant/onebody/kernels.pyx":162
  * 
- *     def rhs(self, const complex[:] psi, complex[:] dpsidt, double time):
+ *         self.H0 = H0
+ *         self.W = W             # <<<<<<<<<<<<<<
+ *         self.psi_st = psi_st
+ *         self.size = size
  */
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_params, __pyx_v_params) < 0) __PYX_ERR(0, 181, __pyx_L1_error)
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_W, __pyx_v_W) < 0) __PYX_ERR(0, 162, __pyx_L1_error)
 
-  /* "tkwant/onebody/kernels.pyx":180
- *         self._tmp = np.zeros((self.size,), dtype=complex)
+  /* "tkwant/onebody/kernels.pyx":163
+ *         self.H0 = H0
+ *         self.W = W
+ *         self.psi_st = psi_st             # <<<<<<<<<<<<<<
+ *         self.size = size
+ *         self.center_size = center_size
+ */
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_psi_st, __pyx_v_psi_st) < 0) __PYX_ERR(0, 163, __pyx_L1_error)
+
+  /* "tkwant/onebody/kernels.pyx":164
+ *         self.W = W
+ *         self.psi_st = psi_st
+ *         self.size = size             # <<<<<<<<<<<<<<
+ *         self.center_size = center_size
+ *         self._tmp = tmp
+ */
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_size, __pyx_v_size) < 0) __PYX_ERR(0, 164, __pyx_L1_error)
+
+  /* "tkwant/onebody/kernels.pyx":165
+ *         self.psi_st = psi_st
+ *         self.size = size
+ *         self.center_size = center_size             # <<<<<<<<<<<<<<
+ *         self._tmp = tmp
+ * 
+ */
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_center_size, __pyx_v_center_size) < 0) __PYX_ERR(0, 165, __pyx_L1_error)
+
+  /* "tkwant/onebody/kernels.pyx":166
+ *         self.size = size
+ *         self.center_size = center_size
+ *         self._tmp = tmp             # <<<<<<<<<<<<<<
  * 
- *     def set_params(self, params):             # <<<<<<<<<<<<<<
- *         self.params = params
+ *     @cython.boundscheck(False)
+ */
+  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_tmp, __pyx_v_tmp) < 0) __PYX_ERR(0, 166, __pyx_L1_error)
+
+  /* "tkwant/onebody/kernels.pyx":159
+ * class _CalcRHS:
+ *     """Calculate the right-hand-side of the time-dependent Schrdinger equation."""
+ *     def __init__(self, H0, W, psi_st, size, center_size, tmp):             # <<<<<<<<<<<<<<
  * 
+ *         self.H0 = H0
  */
 
   /* function exit code */
   __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.set_params", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHS.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":183
- *         self.params = params
+/* "tkwant/onebody/kernels.pyx":170
+ *     @cython.boundscheck(False)
+ *     @cython.wraparound(False)
+ *     def __call__(self, const complex[:] psi, complex[:] dpsidt, const double time):             # <<<<<<<<<<<<<<
  * 
- *     def rhs(self, const complex[:] psi, complex[:] dpsidt, double time):             # <<<<<<<<<<<<<<
- *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
- *         psi_centre = np.asarray(psi[:self.center_size])
+ *         # H0 @ psi -> tmp
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_5rhs(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_5Scipy_4rhs[] = "Scipy.rhs(self, const double complex[:] psi, double complex[:] dpsidt, double time)\nEvaluate the RHS of the TDSE and store the result in `dpsidt`.";
-static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_5rhs = {"rhs", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_5rhs, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_5Scipy_4rhs};
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5Scipy_5rhs(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_8_CalcRHS_3__call__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_8_CalcRHS_2__call__[] = "_CalcRHS.__call__(self, const double complex[:] psi, double complex[:] dpsidt, double time)";
+static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_8_CalcRHS_3__call__ = {"__call__", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_8_CalcRHS_3__call__, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_8_CalcRHS_2__call__};
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_8_CalcRHS_3__call__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_self = 0;
   __Pyx_memviewslice __pyx_v_psi = { 0, 0, { 0 }, { 0 }, { 0 } };
   __Pyx_memviewslice __pyx_v_dpsidt = { 0, 0, { 0 }, { 0 }, { 0 } };
   double __pyx_v_time;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("rhs (wrapper)", 0);
+  __Pyx_RefNannySetupContext("__call__ (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_psi,&__pyx_n_s_dpsidt,&__pyx_n_s_time,0};
     PyObject* values[4] = {0,0,0,0};
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
@@ -5003,82 +4889,82 @@
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("rhs", 1, 4, 4, 1); __PYX_ERR(0, 183, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, 1); __PYX_ERR(0, 170, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
         if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_dpsidt)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("rhs", 1, 4, 4, 2); __PYX_ERR(0, 183, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, 2); __PYX_ERR(0, 170, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
         if (likely((values[3] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("rhs", 1, 4, 4, 3); __PYX_ERR(0, 183, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, 3); __PYX_ERR(0, 170, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "rhs") < 0)) __PYX_ERR(0, 183, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__call__") < 0)) __PYX_ERR(0, 170, __pyx_L3_error)
       }
     } else if (PyTuple_GET_SIZE(__pyx_args) != 4) {
       goto __pyx_L5_argtuple_error;
     } else {
       values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
       values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
       values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
       values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
     }
     __pyx_v_self = values[0];
-    __pyx_v_psi = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex__const__(values[1], 0); if (unlikely(!__pyx_v_psi.memview)) __PYX_ERR(0, 183, __pyx_L3_error)
-    __pyx_v_dpsidt = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[2], PyBUF_WRITABLE); if (unlikely(!__pyx_v_dpsidt.memview)) __PYX_ERR(0, 183, __pyx_L3_error)
-    __pyx_v_time = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 183, __pyx_L3_error)
+    __pyx_v_psi = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex__const__(values[1], 0); if (unlikely(!__pyx_v_psi.memview)) __PYX_ERR(0, 170, __pyx_L3_error)
+    __pyx_v_dpsidt = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[2], PyBUF_WRITABLE); if (unlikely(!__pyx_v_dpsidt.memview)) __PYX_ERR(0, 170, __pyx_L3_error)
+    __pyx_v_time = __pyx_PyFloat_AsDouble(values[3]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 170, __pyx_L3_error)
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("rhs", 1, 4, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 183, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 170, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHS.__call__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_5Scipy_4rhs(__pyx_self, __pyx_v_self, __pyx_v_psi, __pyx_v_dpsidt, __pyx_v_time);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_8_CalcRHS_2__call__(__pyx_self, __pyx_v_self, __pyx_v_psi, __pyx_v_dpsidt, __pyx_v_time);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_5Scipy_4rhs(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, __Pyx_memviewslice __pyx_v_psi, __Pyx_memviewslice __pyx_v_dpsidt, double __pyx_v_time) {
-  PyObject *__pyx_v_psi_centre = NULL;
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_8_CalcRHS_2__call__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, __Pyx_memviewslice __pyx_v_psi, __Pyx_memviewslice __pyx_v_dpsidt, double __pyx_v_time) {
   __Pyx_memviewslice __pyx_v_tmp = { 0, 0, { 0 }, { 0 }, { 0 } };
+  PyObject *__pyx_v_psi_centre = NULL;
   PyObject *__pyx_v_exept = NULL;
   int __pyx_v_i;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
-  PyObject *__pyx_t_2 = NULL;
+  __Pyx_memviewslice __pyx_t_2 = { 0, 0, { 0 }, { 0 }, { 0 } };
   PyObject *__pyx_t_3 = NULL;
-  Py_ssize_t __pyx_t_4;
-  __Pyx_memviewslice __pyx_t_5 = { 0, 0, { 0 }, { 0 }, { 0 } };
-  int __pyx_t_6;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
   PyObject *__pyx_t_7 = NULL;
-  __Pyx_memviewslice __pyx_t_8 = { 0, 0, { 0 }, { 0 }, { 0 } };
+  PyObject *__pyx_t_8 = NULL;
   PyObject *__pyx_t_9 = NULL;
   PyObject *__pyx_t_10 = NULL;
   PyObject *__pyx_t_11 = NULL;
-  PyObject *__pyx_t_12 = NULL;
+  int __pyx_t_12;
   PyObject *__pyx_t_13 = NULL;
-  PyObject *__pyx_t_14 = NULL;
-  PyObject *__pyx_t_15 = NULL;
+  Py_ssize_t __pyx_t_14;
+  __Pyx_memviewslice __pyx_t_15 = { 0, 0, { 0 }, { 0 }, { 0 } };
   int __pyx_t_16;
   int __pyx_t_17;
   PyObject *__pyx_t_18 = NULL;
   PyObject *__pyx_t_19 = NULL;
   PyObject *__pyx_t_20 = NULL;
   int __pyx_t_21;
   char const *__pyx_t_22;
@@ -5088,98 +4974,40 @@
   PyObject *__pyx_t_26 = NULL;
   PyObject *__pyx_t_27 = NULL;
   PyObject *__pyx_t_28 = NULL;
   long __pyx_t_29;
   long __pyx_t_30;
   Py_ssize_t __pyx_t_31;
   Py_ssize_t __pyx_t_32;
-  __Pyx_RefNannySetupContext("rhs", 0);
-
-  /* "tkwant/onebody/kernels.pyx":185
- *     def rhs(self, const complex[:] psi, complex[:] dpsidt, double time):
- *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
- *         psi_centre = np.asarray(psi[:self.center_size])             # <<<<<<<<<<<<<<
- *         # H0 @ psi -> tmp
- *         cdef complex[:] tmp = self._tmp
- */
-  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 185, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_asarray); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 185, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_center_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 185, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_4 = __Pyx_PyIndex_AsSsize_t(__pyx_t_2); if (unlikely((__pyx_t_4 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(0, 185, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_5.data = __pyx_v_psi.data;
-  __pyx_t_5.memview = __pyx_v_psi.memview;
-  __PYX_INC_MEMVIEW(&__pyx_t_5, 0);
-  __pyx_t_6 = -1;
-  if (unlikely(__pyx_memoryview_slice_memviewslice(
-    &__pyx_t_5,
-    __pyx_v_psi.shape[0], __pyx_v_psi.strides[0], __pyx_v_psi.suboffsets[0],
-    0,
-    0,
-    &__pyx_t_6,
-    0,
-    __pyx_t_4,
-    0,
-    0,
-    1,
-    0,
-    1) < 0))
-{
-    __PYX_ERR(0, 185, __pyx_L1_error)
-}
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__call__", 0);
 
-__pyx_t_2 = __pyx_memoryview_fromslice(__pyx_t_5, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex__const__, (int (*)(char *, PyObject *)) NULL, 0);; if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 185, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __PYX_XDEC_MEMVIEW(&__pyx_t_5, 1);
-  __pyx_t_5.memview = NULL;
-  __pyx_t_5.data = NULL;
-  __pyx_t_7 = NULL;
-  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
-    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_3);
-    if (likely(__pyx_t_7)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
-      __Pyx_INCREF(__pyx_t_7);
-      __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_3, function);
-    }
-  }
-  __pyx_t_1 = (__pyx_t_7) ? __Pyx_PyObject_Call2Args(__pyx_t_3, __pyx_t_7, __pyx_t_2) : __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 185, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_v_psi_centre = __pyx_t_1;
-  __pyx_t_1 = 0;
-
-  /* "tkwant/onebody/kernels.pyx":187
- *         psi_centre = np.asarray(psi[:self.center_size])
+  /* "tkwant/onebody/kernels.pyx":173
+ * 
  *         # H0 @ psi -> tmp
  *         cdef complex[:] tmp = self._tmp             # <<<<<<<<<<<<<<
  *         tmp[:] = 0
  *         csr_matvec(
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_tmp); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 187, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_tmp); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 173, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_8 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(__pyx_t_1, PyBUF_WRITABLE); if (unlikely(!__pyx_t_8.memview)) __PYX_ERR(0, 187, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(__pyx_t_1, PyBUF_WRITABLE); if (unlikely(!__pyx_t_2.memview)) __PYX_ERR(0, 173, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v_tmp = __pyx_t_8;
-  __pyx_t_8.memview = NULL;
-  __pyx_t_8.data = NULL;
+  __pyx_v_tmp = __pyx_t_2;
+  __pyx_t_2.memview = NULL;
+  __pyx_t_2.data = NULL;
 
-  /* "tkwant/onebody/kernels.pyx":188
+  /* "tkwant/onebody/kernels.pyx":174
  *         # H0 @ psi -> tmp
  *         cdef complex[:] tmp = self._tmp
  *         tmp[:] = 0             # <<<<<<<<<<<<<<
  *         csr_matvec(
- *             self.H0.shape[0], self.H0.shape[1], self.H0.indptr, self.H0.indices, self.H0.data,
+ *             self.H0.shape[0], self.H0.shape[1], self.H0.indptr,
  */
   {
       __pyx_t_double_complex __pyx_temp_scalar = __pyx_t_double_complex_from_parts(0, 0);
       {
           Py_ssize_t __pyx_temp_extent_0 = __pyx_v_tmp.shape[0];
           Py_ssize_t __pyx_temp_stride_0 = __pyx_v_tmp.strides[0];
           char *__pyx_temp_pointer_0;
@@ -5188,348 +5016,409 @@
           for (__pyx_temp_idx_0 = 0; __pyx_temp_idx_0 < __pyx_temp_extent_0; __pyx_temp_idx_0++) {
             *((__pyx_t_double_complex *) __pyx_temp_pointer_0) = __pyx_temp_scalar;
             __pyx_temp_pointer_0 += __pyx_temp_stride_0;
           }
       }
   }
 
-  /* "tkwant/onebody/kernels.pyx":189
+  /* "tkwant/onebody/kernels.pyx":175
  *         cdef complex[:] tmp = self._tmp
  *         tmp[:] = 0
  *         csr_matvec(             # <<<<<<<<<<<<<<
- *             self.H0.shape[0], self.H0.shape[1], self.H0.indptr, self.H0.indices, self.H0.data,
- *             psi, tmp)
+ *             self.H0.shape[0], self.H0.shape[1], self.H0.indptr,
+ *             self.H0.indices, self.H0.data, psi, tmp)
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_csr_matvec); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 189, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_csr_matvec); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 175, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
 
-  /* "tkwant/onebody/kernels.pyx":190
+  /* "tkwant/onebody/kernels.pyx":176
  *         tmp[:] = 0
  *         csr_matvec(
- *             self.H0.shape[0], self.H0.shape[1], self.H0.indptr, self.H0.indices, self.H0.data,             # <<<<<<<<<<<<<<
- *             psi, tmp)
- * #         cdef complex[:] tmp = self.H0.dot(psi)
+ *             self.H0.shape[0], self.H0.shape[1], self.H0.indptr,             # <<<<<<<<<<<<<<
+ *             self.H0.indices, self.H0.data, psi, tmp)
+ * 
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_shape); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_7);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_GetItemInt(__pyx_t_7, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_7);
-  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_shape); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_9);
-  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-  __pyx_t_7 = __Pyx_GetItemInt(__pyx_t_9, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 190, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 176, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 176, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 176, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 176, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_shape); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 176, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_6, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 176, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 176, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_indptr); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 176, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_7);
-  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_9);
-  __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_indptr); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_10);
-  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_9);
-  __pyx_t_11 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_indices); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_11);
-  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_9);
-  __pyx_t_12 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_data); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 190, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_12);
-  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":191
+  /* "tkwant/onebody/kernels.pyx":177
  *         csr_matvec(
- *             self.H0.shape[0], self.H0.shape[1], self.H0.indptr, self.H0.indices, self.H0.data,
- *             psi, tmp)             # <<<<<<<<<<<<<<
- * #         cdef complex[:] tmp = self.H0.dot(psi)
+ *             self.H0.shape[0], self.H0.shape[1], self.H0.indptr,
+ *             self.H0.indices, self.H0.data, psi, tmp)             # <<<<<<<<<<<<<<
+ * 
  *         # W(t) @ (psi + psi_st) + tmp -> tmp
  */
-  __pyx_t_9 = __pyx_memoryview_fromslice(__pyx_v_psi, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex__const__, (int (*)(char *, PyObject *)) NULL, 0);; if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 191, __pyx_L1_error)
+  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 177, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_indices); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 177, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_8);
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_H0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 177, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 177, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_9);
-  __pyx_t_13 = __pyx_memoryview_fromslice(__pyx_v_tmp, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex, (int (*)(char *, PyObject *)) __pyx_memview_set___pyx_t_double_complex, 0);; if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 191, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_13);
-  __pyx_t_14 = NULL;
-  __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __pyx_t_6 = __pyx_memoryview_fromslice(__pyx_v_psi, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex__const__, (int (*)(char *, PyObject *)) NULL, 0);; if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 177, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_10 = __pyx_memoryview_fromslice(__pyx_v_tmp, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex, (int (*)(char *, PyObject *)) __pyx_memview_set___pyx_t_double_complex, 0);; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 177, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_10);
+  __pyx_t_11 = NULL;
+  __pyx_t_12 = 0;
   if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
-    __pyx_t_14 = PyMethod_GET_SELF(__pyx_t_3);
-    if (likely(__pyx_t_14)) {
+    __pyx_t_11 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_11)) {
       PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
-      __Pyx_INCREF(__pyx_t_14);
+      __Pyx_INCREF(__pyx_t_11);
       __Pyx_INCREF(function);
       __Pyx_DECREF_SET(__pyx_t_3, function);
-      __pyx_t_6 = 1;
+      __pyx_t_12 = 1;
     }
   }
   #if CYTHON_FAST_PYCALL
   if (PyFunction_Check(__pyx_t_3)) {
-    PyObject *__pyx_temp[8] = {__pyx_t_14, __pyx_t_2, __pyx_t_7, __pyx_t_10, __pyx_t_11, __pyx_t_12, __pyx_t_9, __pyx_t_13};
-    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 7+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 189, __pyx_L1_error)
-    __Pyx_XDECREF(__pyx_t_14); __pyx_t_14 = 0;
+    PyObject *__pyx_temp[8] = {__pyx_t_11, __pyx_t_4, __pyx_t_5, __pyx_t_7, __pyx_t_8, __pyx_t_9, __pyx_t_6, __pyx_t_10};
+    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_12, 7+__pyx_t_12); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 175, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
     __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
-    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
   } else
   #endif
   #if CYTHON_FAST_PYCCALL
   if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
-    PyObject *__pyx_temp[8] = {__pyx_t_14, __pyx_t_2, __pyx_t_7, __pyx_t_10, __pyx_t_11, __pyx_t_12, __pyx_t_9, __pyx_t_13};
-    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 7+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 189, __pyx_L1_error)
-    __Pyx_XDECREF(__pyx_t_14); __pyx_t_14 = 0;
+    PyObject *__pyx_temp[8] = {__pyx_t_11, __pyx_t_4, __pyx_t_5, __pyx_t_7, __pyx_t_8, __pyx_t_9, __pyx_t_6, __pyx_t_10};
+    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_12, 7+__pyx_t_12); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 175, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
     __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
-    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
   } else
   #endif
   {
-    __pyx_t_15 = PyTuple_New(7+__pyx_t_6); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 189, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_15);
-    if (__pyx_t_14) {
-      __Pyx_GIVEREF(__pyx_t_14); PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_14); __pyx_t_14 = NULL;
+    __pyx_t_13 = PyTuple_New(7+__pyx_t_12); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 175, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_13);
+    if (__pyx_t_11) {
+      __Pyx_GIVEREF(__pyx_t_11); PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_t_11); __pyx_t_11 = NULL;
     }
-    __Pyx_GIVEREF(__pyx_t_2);
-    PyTuple_SET_ITEM(__pyx_t_15, 0+__pyx_t_6, __pyx_t_2);
+    __Pyx_GIVEREF(__pyx_t_4);
+    PyTuple_SET_ITEM(__pyx_t_13, 0+__pyx_t_12, __pyx_t_4);
+    __Pyx_GIVEREF(__pyx_t_5);
+    PyTuple_SET_ITEM(__pyx_t_13, 1+__pyx_t_12, __pyx_t_5);
     __Pyx_GIVEREF(__pyx_t_7);
-    PyTuple_SET_ITEM(__pyx_t_15, 1+__pyx_t_6, __pyx_t_7);
-    __Pyx_GIVEREF(__pyx_t_10);
-    PyTuple_SET_ITEM(__pyx_t_15, 2+__pyx_t_6, __pyx_t_10);
-    __Pyx_GIVEREF(__pyx_t_11);
-    PyTuple_SET_ITEM(__pyx_t_15, 3+__pyx_t_6, __pyx_t_11);
-    __Pyx_GIVEREF(__pyx_t_12);
-    PyTuple_SET_ITEM(__pyx_t_15, 4+__pyx_t_6, __pyx_t_12);
+    PyTuple_SET_ITEM(__pyx_t_13, 2+__pyx_t_12, __pyx_t_7);
+    __Pyx_GIVEREF(__pyx_t_8);
+    PyTuple_SET_ITEM(__pyx_t_13, 3+__pyx_t_12, __pyx_t_8);
     __Pyx_GIVEREF(__pyx_t_9);
-    PyTuple_SET_ITEM(__pyx_t_15, 5+__pyx_t_6, __pyx_t_9);
-    __Pyx_GIVEREF(__pyx_t_13);
-    PyTuple_SET_ITEM(__pyx_t_15, 6+__pyx_t_6, __pyx_t_13);
-    __pyx_t_2 = 0;
+    PyTuple_SET_ITEM(__pyx_t_13, 4+__pyx_t_12, __pyx_t_9);
+    __Pyx_GIVEREF(__pyx_t_6);
+    PyTuple_SET_ITEM(__pyx_t_13, 5+__pyx_t_12, __pyx_t_6);
+    __Pyx_GIVEREF(__pyx_t_10);
+    PyTuple_SET_ITEM(__pyx_t_13, 6+__pyx_t_12, __pyx_t_10);
+    __pyx_t_4 = 0;
+    __pyx_t_5 = 0;
     __pyx_t_7 = 0;
-    __pyx_t_10 = 0;
-    __pyx_t_11 = 0;
-    __pyx_t_12 = 0;
+    __pyx_t_8 = 0;
     __pyx_t_9 = 0;
-    __pyx_t_13 = 0;
-    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_15, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 189, __pyx_L1_error)
+    __pyx_t_6 = 0;
+    __pyx_t_10 = 0;
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_13, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 175, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
+    __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
   }
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":194
- * #         cdef complex[:] tmp = self.H0.dot(psi)
+  /* "tkwant/onebody/kernels.pyx":180
+ * 
  *         # W(t) @ (psi + psi_st) + tmp -> tmp
+ *         psi_centre = np.asarray(psi[:self.center_size])             # <<<<<<<<<<<<<<
+ *         if self.psi_st is not None:
+ *             psi_centre = psi_centre + self.psi_st
+ */
+  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 180, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_asarray); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 180, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_13);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_center_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 180, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_14 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_14 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(0, 180, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_15.data = __pyx_v_psi.data;
+  __pyx_t_15.memview = __pyx_v_psi.memview;
+  __PYX_INC_MEMVIEW(&__pyx_t_15, 0);
+  __pyx_t_12 = -1;
+  if (unlikely(__pyx_memoryview_slice_memviewslice(
+    &__pyx_t_15,
+    __pyx_v_psi.shape[0], __pyx_v_psi.strides[0], __pyx_v_psi.suboffsets[0],
+    0,
+    0,
+    &__pyx_t_12,
+    0,
+    __pyx_t_14,
+    0,
+    0,
+    1,
+    0,
+    1) < 0))
+{
+    __PYX_ERR(0, 180, __pyx_L1_error)
+}
+
+__pyx_t_3 = __pyx_memoryview_fromslice(__pyx_t_15, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex__const__, (int (*)(char *, PyObject *)) NULL, 0);; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 180, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __PYX_XDEC_MEMVIEW(&__pyx_t_15, 1);
+  __pyx_t_15.memview = NULL;
+  __pyx_t_15.data = NULL;
+  __pyx_t_10 = NULL;
+  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_13))) {
+    __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_13);
+    if (likely(__pyx_t_10)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_13);
+      __Pyx_INCREF(__pyx_t_10);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_13, function);
+    }
+  }
+  __pyx_t_1 = (__pyx_t_10) ? __Pyx_PyObject_Call2Args(__pyx_t_13, __pyx_t_10, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_13, __pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 180, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+  __pyx_v_psi_centre = __pyx_t_1;
+  __pyx_t_1 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":181
+ *         # W(t) @ (psi + psi_st) + tmp -> tmp
+ *         psi_centre = np.asarray(psi[:self.center_size])
  *         if self.psi_st is not None:             # <<<<<<<<<<<<<<
  *             psi_centre = psi_centre + self.psi_st
- * 
+ *         try:
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_psi_st); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 194, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_psi_st); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 181, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_t_16 = (__pyx_t_1 != Py_None);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_t_17 = (__pyx_t_16 != 0);
   if (__pyx_t_17) {
 
-    /* "tkwant/onebody/kernels.pyx":195
- *         # W(t) @ (psi + psi_st) + tmp -> tmp
+    /* "tkwant/onebody/kernels.pyx":182
+ *         psi_centre = np.asarray(psi[:self.center_size])
  *         if self.psi_st is not None:
  *             psi_centre = psi_centre + self.psi_st             # <<<<<<<<<<<<<<
- * 
  *         try:
+ *             self.W.apply(time, psi_centre[:self.center_size], out=tmp[:self.center_size])
  */
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_psi_st); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 195, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_psi_st); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 182, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_3 = PyNumber_Add(__pyx_v_psi_centre, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 195, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_13 = PyNumber_Add(__pyx_v_psi_centre, __pyx_t_1); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 182, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_13);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __Pyx_DECREF_SET(__pyx_v_psi_centre, __pyx_t_3);
-    __pyx_t_3 = 0;
+    __Pyx_DECREF_SET(__pyx_v_psi_centre, __pyx_t_13);
+    __pyx_t_13 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":194
- * #         cdef complex[:] tmp = self.H0.dot(psi)
+    /* "tkwant/onebody/kernels.pyx":181
  *         # W(t) @ (psi + psi_st) + tmp -> tmp
+ *         psi_centre = np.asarray(psi[:self.center_size])
  *         if self.psi_st is not None:             # <<<<<<<<<<<<<<
  *             psi_centre = psi_centre + self.psi_st
- * 
+ *         try:
  */
   }
 
-  /* "tkwant/onebody/kernels.pyx":197
+  /* "tkwant/onebody/kernels.pyx":183
+ *         if self.psi_st is not None:
  *             psi_centre = psi_centre + self.psi_st
- * 
  *         try:             # <<<<<<<<<<<<<<
  *             self.W.apply(time, psi_centre[:self.center_size], out=tmp[:self.center_size])
  *         except Exception as exept:
  */
   {
     __Pyx_PyThreadState_declare
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_18, &__pyx_t_19, &__pyx_t_20);
     __Pyx_XGOTREF(__pyx_t_18);
     __Pyx_XGOTREF(__pyx_t_19);
     __Pyx_XGOTREF(__pyx_t_20);
     /*try:*/ {
 
-      /* "tkwant/onebody/kernels.pyx":198
- * 
+      /* "tkwant/onebody/kernels.pyx":184
+ *             psi_centre = psi_centre + self.psi_st
  *         try:
  *             self.W.apply(time, psi_centre[:self.center_size], out=tmp[:self.center_size])             # <<<<<<<<<<<<<<
  *         except Exception as exept:
  *             if self.W is None:
  */
-      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_W); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 198, __pyx_L4_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_apply); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 198, __pyx_L4_error)
+      __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_W); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 184, __pyx_L4_error)
+      __Pyx_GOTREF(__pyx_t_13);
+      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_13, __pyx_n_s_apply); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 184, __pyx_L4_error)
       __Pyx_GOTREF(__pyx_t_1);
+      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+      __pyx_t_13 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 184, __pyx_L4_error)
+      __Pyx_GOTREF(__pyx_t_13);
+      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_center_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 184, __pyx_L4_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __pyx_t_10 = __Pyx_PyObject_GetSlice(__pyx_v_psi_centre, 0, 0, NULL, &__pyx_t_3, NULL, 0, 0, 0); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 184, __pyx_L4_error)
+      __Pyx_GOTREF(__pyx_t_10);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 198, __pyx_L4_error)
+      __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 184, __pyx_L4_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_15 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_center_size); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 198, __pyx_L4_error)
-      __Pyx_GOTREF(__pyx_t_15);
-      __pyx_t_13 = __Pyx_PyObject_GetSlice(__pyx_v_psi_centre, 0, 0, NULL, &__pyx_t_15, NULL, 0, 0, 1); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 198, __pyx_L4_error)
-      __Pyx_GOTREF(__pyx_t_13);
-      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
-      __pyx_t_15 = PyTuple_New(2); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 198, __pyx_L4_error)
-      __Pyx_GOTREF(__pyx_t_15);
-      __Pyx_GIVEREF(__pyx_t_3);
-      PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_3);
       __Pyx_GIVEREF(__pyx_t_13);
-      PyTuple_SET_ITEM(__pyx_t_15, 1, __pyx_t_13);
-      __pyx_t_3 = 0;
+      PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_13);
+      __Pyx_GIVEREF(__pyx_t_10);
+      PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_10);
       __pyx_t_13 = 0;
-      __pyx_t_13 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 198, __pyx_L4_error)
+      __pyx_t_10 = 0;
+      __pyx_t_10 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 184, __pyx_L4_error)
+      __Pyx_GOTREF(__pyx_t_10);
+      __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_center_size); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 184, __pyx_L4_error)
       __Pyx_GOTREF(__pyx_t_13);
-      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_center_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 198, __pyx_L4_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_4 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_4 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(0, 198, __pyx_L4_error)
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_8.data = __pyx_v_tmp.data;
-      __pyx_t_8.memview = __pyx_v_tmp.memview;
-      __PYX_INC_MEMVIEW(&__pyx_t_8, 0);
-      __pyx_t_6 = -1;
+      __pyx_t_14 = __Pyx_PyIndex_AsSsize_t(__pyx_t_13); if (unlikely((__pyx_t_14 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(0, 184, __pyx_L4_error)
+      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+      __pyx_t_2.data = __pyx_v_tmp.data;
+      __pyx_t_2.memview = __pyx_v_tmp.memview;
+      __PYX_INC_MEMVIEW(&__pyx_t_2, 0);
+      __pyx_t_12 = -1;
       if (unlikely(__pyx_memoryview_slice_memviewslice(
-    &__pyx_t_8,
+    &__pyx_t_2,
     __pyx_v_tmp.shape[0], __pyx_v_tmp.strides[0], __pyx_v_tmp.suboffsets[0],
     0,
     0,
-    &__pyx_t_6,
+    &__pyx_t_12,
     0,
-    __pyx_t_4,
+    __pyx_t_14,
     0,
     0,
     1,
     0,
     1) < 0))
 {
-    __PYX_ERR(0, 198, __pyx_L4_error)
+    __PYX_ERR(0, 184, __pyx_L4_error)
 }
 
-__pyx_t_3 = __pyx_memoryview_fromslice(__pyx_t_8, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex, (int (*)(char *, PyObject *)) __pyx_memview_set___pyx_t_double_complex, 0);; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 198, __pyx_L4_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __PYX_XDEC_MEMVIEW(&__pyx_t_8, 1);
-      __pyx_t_8.memview = NULL;
-      __pyx_t_8.data = NULL;
-      if (PyDict_SetItem(__pyx_t_13, __pyx_n_s_out, __pyx_t_3) < 0) __PYX_ERR(0, 198, __pyx_L4_error)
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_15, __pyx_t_13); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 198, __pyx_L4_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
+__pyx_t_13 = __pyx_memoryview_fromslice(__pyx_t_2, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex, (int (*)(char *, PyObject *)) __pyx_memview_set___pyx_t_double_complex, 0);; if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 184, __pyx_L4_error)
+      __Pyx_GOTREF(__pyx_t_13);
+      __PYX_XDEC_MEMVIEW(&__pyx_t_2, 1);
+      __pyx_t_2.memview = NULL;
+      __pyx_t_2.data = NULL;
+      if (PyDict_SetItem(__pyx_t_10, __pyx_n_s_out, __pyx_t_13) < 0) __PYX_ERR(0, 184, __pyx_L4_error)
       __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+      __pyx_t_13 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, __pyx_t_10); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 184, __pyx_L4_error)
+      __Pyx_GOTREF(__pyx_t_13);
+      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+      __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":197
+      /* "tkwant/onebody/kernels.pyx":183
+ *         if self.psi_st is not None:
  *             psi_centre = psi_centre + self.psi_st
- * 
  *         try:             # <<<<<<<<<<<<<<
  *             self.W.apply(time, psi_centre[:self.center_size], out=tmp[:self.center_size])
  *         except Exception as exept:
  */
     }
     __Pyx_XDECREF(__pyx_t_18); __pyx_t_18 = 0;
     __Pyx_XDECREF(__pyx_t_19); __pyx_t_19 = 0;
     __Pyx_XDECREF(__pyx_t_20); __pyx_t_20 = 0;
     goto __pyx_L9_try_end;
     __pyx_L4_error:;
-    __Pyx_XDECREF(__pyx_t_14); __pyx_t_14 = 0;
-    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
     __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
-    __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
-    __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __Pyx_XDECREF(__pyx_t_15); __pyx_t_15 = 0;
     __Pyx_XDECREF(__pyx_t_13); __pyx_t_13 = 0;
+    __PYX_XDEC_MEMVIEW(&__pyx_t_15, 1);
+    __PYX_XDEC_MEMVIEW(&__pyx_t_2, 1);
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __PYX_XDEC_MEMVIEW(&__pyx_t_5, 1);
-    __PYX_XDEC_MEMVIEW(&__pyx_t_8, 1);
+    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":199
+    /* "tkwant/onebody/kernels.pyx":185
  *         try:
  *             self.W.apply(time, psi_centre[:self.center_size], out=tmp[:self.center_size])
  *         except Exception as exept:             # <<<<<<<<<<<<<<
  *             if self.W is None:
  *                 pass
  */
-    __pyx_t_6 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
-    if (__pyx_t_6) {
-      __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
-      if (__Pyx_GetException(&__pyx_t_3, &__pyx_t_13, &__pyx_t_15) < 0) __PYX_ERR(0, 199, __pyx_L6_except_error)
-      __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_12 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
+    if (__pyx_t_12) {
+      __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHS.__call__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+      if (__Pyx_GetException(&__pyx_t_13, &__pyx_t_10, &__pyx_t_3) < 0) __PYX_ERR(0, 185, __pyx_L6_except_error)
       __Pyx_GOTREF(__pyx_t_13);
-      __Pyx_GOTREF(__pyx_t_15);
-      __Pyx_INCREF(__pyx_t_13);
-      __pyx_v_exept = __pyx_t_13;
+      __Pyx_GOTREF(__pyx_t_10);
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_10);
+      __pyx_v_exept = __pyx_t_10;
       /*try:*/ {
 
-        /* "tkwant/onebody/kernels.pyx":200
+        /* "tkwant/onebody/kernels.pyx":186
  *             self.W.apply(time, psi_centre[:self.center_size], out=tmp[:self.center_size])
  *         except Exception as exept:
  *             if self.W is None:             # <<<<<<<<<<<<<<
  *                 pass
  *             else:
  */
-        __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_W); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 200, __pyx_L15_error)
+        __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_W); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 186, __pyx_L15_error)
         __Pyx_GOTREF(__pyx_t_1);
         __pyx_t_17 = (__pyx_t_1 == Py_None);
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
         __pyx_t_16 = (__pyx_t_17 != 0);
         if (likely(__pyx_t_16)) {
           goto __pyx_L17;
         }
 
-        /* "tkwant/onebody/kernels.pyx":203
+        /* "tkwant/onebody/kernels.pyx":189
  *                 pass
  *             else:
  *                 raise exept             # <<<<<<<<<<<<<<
  * 
  *         # dpsidt = -1j * tmp
  */
         /*else*/ {
           __Pyx_Raise(__pyx_v_exept, 0, 0, 0);
-          __PYX_ERR(0, 203, __pyx_L15_error)
+          __PYX_ERR(0, 189, __pyx_L15_error)
         }
         __pyx_L17:;
       }
 
-      /* "tkwant/onebody/kernels.pyx":199
+      /* "tkwant/onebody/kernels.pyx":185
  *         try:
  *             self.W.apply(time, psi_centre[:self.center_size], out=tmp[:self.center_size])
  *         except Exception as exept:             # <<<<<<<<<<<<<<
  *             if self.W is None:
  *                 pass
  */
       /*finally:*/ {
@@ -5539,33 +5428,33 @@
           goto __pyx_L16;
         }
         __pyx_L15_error:;
         /*exception exit:*/{
           __Pyx_PyThreadState_declare
           __Pyx_PyThreadState_assign
           __pyx_t_23 = 0; __pyx_t_24 = 0; __pyx_t_25 = 0; __pyx_t_26 = 0; __pyx_t_27 = 0; __pyx_t_28 = 0;
-          __Pyx_XDECREF(__pyx_t_14); __pyx_t_14 = 0;
-          __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-          __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+          __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
           __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
-          __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
+          __PYX_XDEC_MEMVIEW(&__pyx_t_15, 1);
+          __PYX_XDEC_MEMVIEW(&__pyx_t_2, 1);
+          __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+          __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+          __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+          __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+          __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
           __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
-          __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
-          __PYX_XDEC_MEMVIEW(&__pyx_t_5, 1);
-          __PYX_XDEC_MEMVIEW(&__pyx_t_8, 1);
           if (PY_MAJOR_VERSION >= 3) __Pyx_ExceptionSwap(&__pyx_t_26, &__pyx_t_27, &__pyx_t_28);
           if ((PY_MAJOR_VERSION < 3) || unlikely(__Pyx_GetException(&__pyx_t_23, &__pyx_t_24, &__pyx_t_25) < 0)) __Pyx_ErrFetch(&__pyx_t_23, &__pyx_t_24, &__pyx_t_25);
           __Pyx_XGOTREF(__pyx_t_23);
           __Pyx_XGOTREF(__pyx_t_24);
           __Pyx_XGOTREF(__pyx_t_25);
           __Pyx_XGOTREF(__pyx_t_26);
           __Pyx_XGOTREF(__pyx_t_27);
           __Pyx_XGOTREF(__pyx_t_28);
-          __pyx_t_6 = __pyx_lineno; __pyx_t_21 = __pyx_clineno; __pyx_t_22 = __pyx_filename;
+          __pyx_t_12 = __pyx_lineno; __pyx_t_21 = __pyx_clineno; __pyx_t_22 = __pyx_filename;
           {
             __Pyx_DECREF(__pyx_v_exept);
             __pyx_v_exept = NULL;
           }
           if (PY_MAJOR_VERSION >= 3) {
             __Pyx_XGIVEREF(__pyx_t_26);
             __Pyx_XGIVEREF(__pyx_t_27);
@@ -5573,30 +5462,30 @@
             __Pyx_ExceptionReset(__pyx_t_26, __pyx_t_27, __pyx_t_28);
           }
           __Pyx_XGIVEREF(__pyx_t_23);
           __Pyx_XGIVEREF(__pyx_t_24);
           __Pyx_XGIVEREF(__pyx_t_25);
           __Pyx_ErrRestore(__pyx_t_23, __pyx_t_24, __pyx_t_25);
           __pyx_t_23 = 0; __pyx_t_24 = 0; __pyx_t_25 = 0; __pyx_t_26 = 0; __pyx_t_27 = 0; __pyx_t_28 = 0;
-          __pyx_lineno = __pyx_t_6; __pyx_clineno = __pyx_t_21; __pyx_filename = __pyx_t_22;
+          __pyx_lineno = __pyx_t_12; __pyx_clineno = __pyx_t_21; __pyx_filename = __pyx_t_22;
           goto __pyx_L6_except_error;
         }
         __pyx_L16:;
       }
-      __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
       __Pyx_XDECREF(__pyx_t_13); __pyx_t_13 = 0;
-      __Pyx_XDECREF(__pyx_t_15); __pyx_t_15 = 0;
+      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+      __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
       goto __pyx_L5_exception_handled;
     }
     goto __pyx_L6_except_error;
     __pyx_L6_except_error:;
 
-    /* "tkwant/onebody/kernels.pyx":197
+    /* "tkwant/onebody/kernels.pyx":183
+ *         if self.psi_st is not None:
  *             psi_centre = psi_centre + self.psi_st
- * 
  *         try:             # <<<<<<<<<<<<<<
  *             self.W.apply(time, psi_centre[:self.center_size], out=tmp[:self.center_size])
  *         except Exception as exept:
  */
     __Pyx_XGIVEREF(__pyx_t_18);
     __Pyx_XGIVEREF(__pyx_t_19);
     __Pyx_XGIVEREF(__pyx_t_20);
@@ -5606,113 +5495,80 @@
     __Pyx_XGIVEREF(__pyx_t_18);
     __Pyx_XGIVEREF(__pyx_t_19);
     __Pyx_XGIVEREF(__pyx_t_20);
     __Pyx_ExceptionReset(__pyx_t_18, __pyx_t_19, __pyx_t_20);
     __pyx_L9_try_end:;
   }
 
-  /* "tkwant/onebody/kernels.pyx":207
+  /* "tkwant/onebody/kernels.pyx":193
  *         # dpsidt = -1j * tmp
  *         cdef int i
  *         for i in range(self.size):             # <<<<<<<<<<<<<<
  *             dpsidt[i] = -1j * tmp[i]
  * 
  */
-  __pyx_t_15 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_size); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 207, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_15);
-  __pyx_t_29 = __Pyx_PyInt_As_long(__pyx_t_15); if (unlikely((__pyx_t_29 == (long)-1) && PyErr_Occurred())) __PYX_ERR(0, 207, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 193, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_29 = __Pyx_PyInt_As_long(__pyx_t_3); if (unlikely((__pyx_t_29 == (long)-1) && PyErr_Occurred())) __PYX_ERR(0, 193, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __pyx_t_30 = __pyx_t_29;
   for (__pyx_t_21 = 0; __pyx_t_21 < __pyx_t_30; __pyx_t_21+=1) {
     __pyx_v_i = __pyx_t_21;
 
-    /* "tkwant/onebody/kernels.pyx":208
+    /* "tkwant/onebody/kernels.pyx":194
  *         cdef int i
  *         for i in range(self.size):
  *             dpsidt[i] = -1j * tmp[i]             # <<<<<<<<<<<<<<
  * 
- *         self.nevals += 1
+ * 
  */
     __pyx_t_31 = __pyx_v_i;
-    __pyx_t_6 = -1;
-    if (__pyx_t_31 < 0) {
-      __pyx_t_31 += __pyx_v_tmp.shape[0];
-      if (unlikely(__pyx_t_31 < 0)) __pyx_t_6 = 0;
-    } else if (unlikely(__pyx_t_31 >= __pyx_v_tmp.shape[0])) __pyx_t_6 = 0;
-    if (unlikely(__pyx_t_6 != -1)) {
-      __Pyx_RaiseBufferIndexError(__pyx_t_6);
-      __PYX_ERR(0, 208, __pyx_L1_error)
-    }
     __pyx_t_32 = __pyx_v_i;
-    __pyx_t_6 = -1;
-    if (__pyx_t_32 < 0) {
-      __pyx_t_32 += __pyx_v_dpsidt.shape[0];
-      if (unlikely(__pyx_t_32 < 0)) __pyx_t_6 = 0;
-    } else if (unlikely(__pyx_t_32 >= __pyx_v_dpsidt.shape[0])) __pyx_t_6 = 0;
-    if (unlikely(__pyx_t_6 != -1)) {
-      __Pyx_RaiseBufferIndexError(__pyx_t_6);
-      __PYX_ERR(0, 208, __pyx_L1_error)
-    }
     *((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_dpsidt.data + __pyx_t_32 * __pyx_v_dpsidt.strides[0]) )) = __Pyx_c_prod_double(__Pyx_c_neg_double(__pyx_t_double_complex_from_parts(0, 1.0)), (*((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_tmp.data + __pyx_t_31 * __pyx_v_tmp.strides[0]) ))));
   }
 
-  /* "tkwant/onebody/kernels.pyx":210
- *             dpsidt[i] = -1j * tmp[i]
- * 
- *         self.nevals += 1             # <<<<<<<<<<<<<<
- * 
- * 
- */
-  __pyx_t_15 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_nevals); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 210, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_15);
-  __pyx_t_13 = __Pyx_PyInt_AddObjC(__pyx_t_15, __pyx_int_1, 1, 1); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 210, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_13);
-  __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_nevals, __pyx_t_13) < 0) __PYX_ERR(0, 210, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-
-  /* "tkwant/onebody/kernels.pyx":183
- *         self.params = params
+  /* "tkwant/onebody/kernels.pyx":170
+ *     @cython.boundscheck(False)
+ *     @cython.wraparound(False)
+ *     def __call__(self, const complex[:] psi, complex[:] dpsidt, const double time):             # <<<<<<<<<<<<<<
  * 
- *     def rhs(self, const complex[:] psi, complex[:] dpsidt, double time):             # <<<<<<<<<<<<<<
- *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
- *         psi_centre = np.asarray(psi[:self.center_size])
+ *         # H0 @ psi -> tmp
  */
 
   /* function exit code */
   __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_2);
+  __PYX_XDEC_MEMVIEW(&__pyx_t_2, 1);
   __Pyx_XDECREF(__pyx_t_3);
-  __PYX_XDEC_MEMVIEW(&__pyx_t_5, 1);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
   __Pyx_XDECREF(__pyx_t_7);
-  __PYX_XDEC_MEMVIEW(&__pyx_t_8, 1);
+  __Pyx_XDECREF(__pyx_t_8);
   __Pyx_XDECREF(__pyx_t_9);
   __Pyx_XDECREF(__pyx_t_10);
   __Pyx_XDECREF(__pyx_t_11);
-  __Pyx_XDECREF(__pyx_t_12);
   __Pyx_XDECREF(__pyx_t_13);
-  __Pyx_XDECREF(__pyx_t_14);
-  __Pyx_XDECREF(__pyx_t_15);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Scipy.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __PYX_XDEC_MEMVIEW(&__pyx_t_15, 1);
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHS.__call__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
-  __Pyx_XDECREF(__pyx_v_psi_centre);
   __PYX_XDEC_MEMVIEW(&__pyx_v_tmp, 1);
+  __Pyx_XDECREF(__pyx_v_psi_centre);
   __Pyx_XDECREF(__pyx_v_exept);
   __PYX_XDEC_MEMVIEW(&__pyx_v_psi, 1);
   __PYX_XDEC_MEMVIEW(&__pyx_v_dpsidt, 1);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":215
+/* "tkwant/onebody/kernels.pyx":199
  * @cython.boundscheck(False)
  * @cython.wraparound(False)
  * cdef(double, double, double, double, double) update_times(double t, double t0, double dt):             # <<<<<<<<<<<<<<
  *     '''Return new update times for the Hamiltonian matrix.
  *     '''
  */
 
@@ -5720,265 +5576,152 @@
   int __pyx_v_quotient;
   double __pyx_v_t1;
   double __pyx_v_t2;
   double __pyx_v_t3;
   double __pyx_v_t4;
   __pyx_ctuple_double__and_double__and_double__and_double__and_double __pyx_r;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
+  double __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
-  PyObject *__pyx_t_4 = NULL;
-  PyObject *__pyx_t_5 = NULL;
-  PyObject *__pyx_t_6 = NULL;
-  int __pyx_t_7;
-  PyObject *__pyx_t_8 = NULL;
-  double __pyx_t_9;
-  __pyx_ctuple_double__and_double__and_double__and_double__and_double __pyx_t_10;
+  int __pyx_t_4;
+  __pyx_ctuple_double__and_double__and_double__and_double__and_double __pyx_t_5;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("update_times", 0);
 
-  /* "tkwant/onebody/kernels.pyx":218
+  /* "tkwant/onebody/kernels.pyx":202
  *     '''Return new update times for the Hamiltonian matrix.
  *     '''
  *     assert dt > 0             # <<<<<<<<<<<<<<
  *     cdef int quotient
- *     if t < t0:
+ *     quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics
  */
   #ifndef CYTHON_WITHOUT_ASSERTIONS
   if (unlikely(!Py_OptimizeFlag)) {
     if (unlikely(!((__pyx_v_dt > 0.0) != 0))) {
       PyErr_SetNone(PyExc_AssertionError);
-      __PYX_ERR(0, 218, __pyx_L1_error)
+      __PYX_ERR(0, 202, __pyx_L1_error)
     }
   }
   #endif
 
-  /* "tkwant/onebody/kernels.pyx":220
- *     assert dt > 0
- *     cdef int quotient
- *     if t < t0:             # <<<<<<<<<<<<<<
- *         raise ValueError('time t={} must be greater equal t0={}'.format(t, t0))
- *     if t >= t0 + dt + dt:
- */
-  __pyx_t_1 = ((__pyx_v_t < __pyx_v_t0) != 0);
-  if (unlikely(__pyx_t_1)) {
-
-    /* "tkwant/onebody/kernels.pyx":221
- *     cdef int quotient
- *     if t < t0:
- *         raise ValueError('time t={} must be greater equal t0={}'.format(t, t0))             # <<<<<<<<<<<<<<
- *     if t >= t0 + dt + dt:
- *         quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics
- */
-    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_kp_u_time_t_must_be_greater_equal_t0, __pyx_n_s_format); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 221, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_t); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 221, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_t0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 221, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_6 = NULL;
-    __pyx_t_7 = 0;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
-      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_3);
-      if (likely(__pyx_t_6)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
-        __Pyx_INCREF(__pyx_t_6);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_3, function);
-        __pyx_t_7 = 1;
-      }
-    }
-    #if CYTHON_FAST_PYCALL
-    if (PyFunction_Check(__pyx_t_3)) {
-      PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_4, __pyx_t_5};
-      __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 221, __pyx_L1_error)
-      __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    } else
-    #endif
-    #if CYTHON_FAST_PYCCALL
-    if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
-      PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_4, __pyx_t_5};
-      __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 221, __pyx_L1_error)
-      __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    } else
-    #endif
-    {
-      __pyx_t_8 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 221, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_8);
-      if (__pyx_t_6) {
-        __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6); __pyx_t_6 = NULL;
-      }
-      __Pyx_GIVEREF(__pyx_t_4);
-      PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_7, __pyx_t_4);
-      __Pyx_GIVEREF(__pyx_t_5);
-      PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_7, __pyx_t_5);
-      __pyx_t_4 = 0;
-      __pyx_t_5 = 0;
-      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_8, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 221, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-    }
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 221, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __PYX_ERR(0, 221, __pyx_L1_error)
-
-    /* "tkwant/onebody/kernels.pyx":220
+  /* "tkwant/onebody/kernels.pyx":204
  *     assert dt > 0
  *     cdef int quotient
- *     if t < t0:             # <<<<<<<<<<<<<<
- *         raise ValueError('time t={} must be greater equal t0={}'.format(t, t0))
- *     if t >= t0 + dt + dt:
- */
-  }
-
-  /* "tkwant/onebody/kernels.pyx":222
- *     if t < t0:
- *         raise ValueError('time t={} must be greater equal t0={}'.format(t, t0))
- *     if t >= t0 + dt + dt:             # <<<<<<<<<<<<<<
- *         quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics
- *         t0 = t0 + quotient * dt
- */
-  __pyx_t_1 = ((__pyx_v_t >= ((__pyx_v_t0 + __pyx_v_dt) + __pyx_v_dt)) != 0);
-  if (__pyx_t_1) {
-
-    /* "tkwant/onebody/kernels.pyx":223
- *         raise ValueError('time t={} must be greater equal t0={}'.format(t, t0))
- *     if t >= t0 + dt + dt:
- *         quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics             # <<<<<<<<<<<<<<
- *         t0 = t0 + quotient * dt
+ *     quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics             # <<<<<<<<<<<<<<
+ *     t0 = t0 + quotient * dt
  *     # adding dt up we get inaccurate routings
  */
-    __pyx_t_9 = (__pyx_v_t - __pyx_v_t0);
-    if (unlikely(__pyx_v_dt == 0)) {
-      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
-      __PYX_ERR(0, 223, __pyx_L1_error)
-    }
-    __pyx_t_3 = PyFloat_FromDouble((__pyx_t_9 / __pyx_v_dt)); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 223, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 223, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_GIVEREF(__pyx_t_3);
-    PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3);
-    __Pyx_INCREF(__pyx_int_10);
-    __Pyx_GIVEREF(__pyx_int_10);
-    PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_int_10);
-    __pyx_t_3 = 0;
-    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_round, __pyx_t_2, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 223, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_PyNumber_Int(__pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 223, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __pyx_t_7 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_7 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 223, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_v_quotient = __pyx_t_7;
+  __pyx_t_1 = (__pyx_v_t - __pyx_v_t0);
+  if (unlikely(__pyx_v_dt == 0)) {
+    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
+    __PYX_ERR(0, 204, __pyx_L1_error)
+  }
+  __pyx_t_2 = PyFloat_FromDouble((__pyx_t_1 / __pyx_v_dt)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 204, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 204, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_2);
+  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
+  __Pyx_INCREF(__pyx_int_10);
+  __Pyx_GIVEREF(__pyx_int_10);
+  PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_int_10);
+  __pyx_t_2 = 0;
+  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_round, __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 204, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = __Pyx_PyNumber_Int(__pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 204, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_t_4 = __Pyx_PyInt_As_int(__pyx_t_3); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 204, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_v_quotient = __pyx_t_4;
 
-    /* "tkwant/onebody/kernels.pyx":224
- *     if t >= t0 + dt + dt:
- *         quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics
- *         t0 = t0 + quotient * dt             # <<<<<<<<<<<<<<
+  /* "tkwant/onebody/kernels.pyx":205
+ *     cdef int quotient
+ *     quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics
+ *     t0 = t0 + quotient * dt             # <<<<<<<<<<<<<<
  *     # adding dt up we get inaccurate routings
  *     cdef double t1 = t0 + dt
  */
-    __pyx_v_t0 = (__pyx_v_t0 + (__pyx_v_quotient * __pyx_v_dt));
-
-    /* "tkwant/onebody/kernels.pyx":222
- *     if t < t0:
- *         raise ValueError('time t={} must be greater equal t0={}'.format(t, t0))
- *     if t >= t0 + dt + dt:             # <<<<<<<<<<<<<<
- *         quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics
- *         t0 = t0 + quotient * dt
- */
-  }
+  __pyx_v_t0 = (__pyx_v_t0 + (__pyx_v_quotient * __pyx_v_dt));
 
-  /* "tkwant/onebody/kernels.pyx":226
- *         t0 = t0 + quotient * dt
+  /* "tkwant/onebody/kernels.pyx":207
+ *     t0 = t0 + quotient * dt
  *     # adding dt up we get inaccurate routings
  *     cdef double t1 = t0 + dt             # <<<<<<<<<<<<<<
  *     cdef double t2 = t0 + 2 * dt
  *     cdef double t3 = t0 + 3 * dt
  */
   __pyx_v_t1 = (__pyx_v_t0 + __pyx_v_dt);
 
-  /* "tkwant/onebody/kernels.pyx":227
+  /* "tkwant/onebody/kernels.pyx":208
  *     # adding dt up we get inaccurate routings
  *     cdef double t1 = t0 + dt
  *     cdef double t2 = t0 + 2 * dt             # <<<<<<<<<<<<<<
  *     cdef double t3 = t0 + 3 * dt
  *     cdef double t4 = t0 + 4 * dt
  */
   __pyx_v_t2 = (__pyx_v_t0 + (2.0 * __pyx_v_dt));
 
-  /* "tkwant/onebody/kernels.pyx":228
+  /* "tkwant/onebody/kernels.pyx":209
  *     cdef double t1 = t0 + dt
  *     cdef double t2 = t0 + 2 * dt
  *     cdef double t3 = t0 + 3 * dt             # <<<<<<<<<<<<<<
  *     cdef double t4 = t0 + 4 * dt
  *     return t0, t1, t2, t3, t4
  */
   __pyx_v_t3 = (__pyx_v_t0 + (3.0 * __pyx_v_dt));
 
-  /* "tkwant/onebody/kernels.pyx":229
+  /* "tkwant/onebody/kernels.pyx":210
  *     cdef double t2 = t0 + 2 * dt
  *     cdef double t3 = t0 + 3 * dt
  *     cdef double t4 = t0 + 4 * dt             # <<<<<<<<<<<<<<
  *     return t0, t1, t2, t3, t4
  * 
  */
   __pyx_v_t4 = (__pyx_v_t0 + (4.0 * __pyx_v_dt));
 
-  /* "tkwant/onebody/kernels.pyx":230
+  /* "tkwant/onebody/kernels.pyx":211
  *     cdef double t3 = t0 + 3 * dt
  *     cdef double t4 = t0 + 4 * dt
  *     return t0, t1, t2, t3, t4             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_t_10.f0 = __pyx_v_t0;
-  __pyx_t_10.f1 = __pyx_v_t1;
-  __pyx_t_10.f2 = __pyx_v_t2;
-  __pyx_t_10.f3 = __pyx_v_t3;
-  __pyx_t_10.f4 = __pyx_v_t4;
-  __pyx_r = __pyx_t_10;
+  __pyx_t_5.f0 = __pyx_v_t0;
+  __pyx_t_5.f1 = __pyx_v_t1;
+  __pyx_t_5.f2 = __pyx_v_t2;
+  __pyx_t_5.f3 = __pyx_v_t3;
+  __pyx_t_5.f4 = __pyx_v_t4;
+  __pyx_r = __pyx_t_5;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":215
+  /* "tkwant/onebody/kernels.pyx":199
  * @cython.boundscheck(False)
  * @cython.wraparound(False)
  * cdef(double, double, double, double, double) update_times(double t, double t0, double dt):             # <<<<<<<<<<<<<<
  *     '''Return new update times for the Hamiltonian matrix.
  *     '''
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_XDECREF(__pyx_t_4);
-  __Pyx_XDECREF(__pyx_t_5);
-  __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_XDECREF(__pyx_t_8);
   __Pyx_WriteUnraisable("tkwant.onebody.kernels.update_times", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
   __Pyx_pretend_to_initialize(&__pyx_r);
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":235
+/* "tkwant/onebody/kernels.pyx":216
  * @cython.boundscheck(False)
  * @cython.wraparound(False)
  * cdef(double, double, double, double) _get_polynome_coeffs(double t, double t0, double t1, double dt):             # <<<<<<<<<<<<<<
  * 
  *     cdef double rdx = 1 / dt
  */
 
@@ -5988,89 +5731,92 @@
   double __pyx_v_a;
   double __pyx_v_b;
   double __pyx_v_c;
   double __pyx_v_d;
   __pyx_ctuple_double__and_double__and_double__and_double __pyx_r;
   __Pyx_RefNannyDeclarations
   __pyx_ctuple_double__and_double__and_double__and_double __pyx_t_1;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("_get_polynome_coeffs", 0);
 
-  /* "tkwant/onebody/kernels.pyx":237
+  /* "tkwant/onebody/kernels.pyx":218
  * cdef(double, double, double, double) _get_polynome_coeffs(double t, double t0, double t1, double dt):
  * 
  *     cdef double rdx = 1 / dt             # <<<<<<<<<<<<<<
  *     cdef double fac = dt * dt / 6.
  * 
  */
   if (unlikely(__pyx_v_dt == 0)) {
     PyErr_SetString(PyExc_ZeroDivisionError, "float division");
-    __PYX_ERR(0, 237, __pyx_L1_error)
+    __PYX_ERR(0, 218, __pyx_L1_error)
   }
   __pyx_v_rdx = (1.0 / __pyx_v_dt);
 
-  /* "tkwant/onebody/kernels.pyx":238
+  /* "tkwant/onebody/kernels.pyx":219
  * 
  *     cdef double rdx = 1 / dt
  *     cdef double fac = dt * dt / 6.             # <<<<<<<<<<<<<<
  * 
  *     cdef double a = (t1 - t) * rdx
  */
   __pyx_v_fac = ((__pyx_v_dt * __pyx_v_dt) / 6.);
 
-  /* "tkwant/onebody/kernels.pyx":240
+  /* "tkwant/onebody/kernels.pyx":221
  *     cdef double fac = dt * dt / 6.
  * 
  *     cdef double a = (t1 - t) * rdx             # <<<<<<<<<<<<<<
  *     cdef double b = (t - t0) * rdx
  *     cdef double c = (a * a * a - a) * fac
  */
   __pyx_v_a = ((__pyx_v_t1 - __pyx_v_t) * __pyx_v_rdx);
 
-  /* "tkwant/onebody/kernels.pyx":241
+  /* "tkwant/onebody/kernels.pyx":222
  * 
  *     cdef double a = (t1 - t) * rdx
  *     cdef double b = (t - t0) * rdx             # <<<<<<<<<<<<<<
  *     cdef double c = (a * a * a - a) * fac
  *     cdef double d = (b * b * b - b) * fac
  */
   __pyx_v_b = ((__pyx_v_t - __pyx_v_t0) * __pyx_v_rdx);
 
-  /* "tkwant/onebody/kernels.pyx":242
+  /* "tkwant/onebody/kernels.pyx":223
  *     cdef double a = (t1 - t) * rdx
  *     cdef double b = (t - t0) * rdx
  *     cdef double c = (a * a * a - a) * fac             # <<<<<<<<<<<<<<
  *     cdef double d = (b * b * b - b) * fac
  *     return a, b, c, d
  */
   __pyx_v_c = ((((__pyx_v_a * __pyx_v_a) * __pyx_v_a) - __pyx_v_a) * __pyx_v_fac);
 
-  /* "tkwant/onebody/kernels.pyx":243
+  /* "tkwant/onebody/kernels.pyx":224
  *     cdef double b = (t - t0) * rdx
  *     cdef double c = (a * a * a - a) * fac
  *     cdef double d = (b * b * b - b) * fac             # <<<<<<<<<<<<<<
  *     return a, b, c, d
  * 
  */
   __pyx_v_d = ((((__pyx_v_b * __pyx_v_b) * __pyx_v_b) - __pyx_v_b) * __pyx_v_fac);
 
-  /* "tkwant/onebody/kernels.pyx":244
+  /* "tkwant/onebody/kernels.pyx":225
  *     cdef double c = (a * a * a - a) * fac
  *     cdef double d = (b * b * b - b) * fac
  *     return a, b, c, d             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_t_1.f0 = __pyx_v_a;
   __pyx_t_1.f1 = __pyx_v_b;
   __pyx_t_1.f2 = __pyx_v_c;
   __pyx_t_1.f3 = __pyx_v_d;
   __pyx_r = __pyx_t_1;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":235
+  /* "tkwant/onebody/kernels.pyx":216
  * @cython.boundscheck(False)
  * @cython.wraparound(False)
  * cdef(double, double, double, double) _get_polynome_coeffs(double t, double t0, double t1, double dt):             # <<<<<<<<<<<<<<
  * 
  *     cdef double rdx = 1 / dt
  */
 
@@ -6079,155 +5825,158 @@
   __Pyx_WriteUnraisable("tkwant.onebody.kernels._get_polynome_coeffs", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
   __Pyx_pretend_to_initialize(&__pyx_r);
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":247
+/* "tkwant/onebody/kernels.pyx":228
  * 
  * 
  * def _herm_conj(value):             # <<<<<<<<<<<<<<
  *     if hasattr(value, 'conjugate'):
  *         value = value.conjugate()
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_3_herm_conj(PyObject *__pyx_self, PyObject *__pyx_v_value); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_2_herm_conj[] = "_herm_conj(value)";
-static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_3_herm_conj = {"_herm_conj", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_3_herm_conj, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_2_herm_conj};
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_3_herm_conj(PyObject *__pyx_self, PyObject *__pyx_v_value) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_1_herm_conj(PyObject *__pyx_self, PyObject *__pyx_v_value); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels__herm_conj[] = "_herm_conj(value)";
+static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_1_herm_conj = {"_herm_conj", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_1_herm_conj, METH_O, __pyx_doc_6tkwant_7onebody_7kernels__herm_conj};
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_1_herm_conj(PyObject *__pyx_self, PyObject *__pyx_v_value) {
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("_herm_conj (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_2_herm_conj(__pyx_self, ((PyObject *)__pyx_v_value));
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels__herm_conj(__pyx_self, ((PyObject *)__pyx_v_value));
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_2_herm_conj(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_value) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels__herm_conj(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_value) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("_herm_conj", 0);
   __Pyx_INCREF(__pyx_v_value);
 
-  /* "tkwant/onebody/kernels.pyx":248
+  /* "tkwant/onebody/kernels.pyx":229
  * 
  * def _herm_conj(value):
  *     if hasattr(value, 'conjugate'):             # <<<<<<<<<<<<<<
  *         value = value.conjugate()
  *     if hasattr(value, 'transpose'):
  */
-  __pyx_t_1 = __Pyx_HasAttr(__pyx_v_value, __pyx_n_u_conjugate); if (unlikely(__pyx_t_1 == ((int)-1))) __PYX_ERR(0, 248, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_HasAttr(__pyx_v_value, __pyx_n_u_conjugate); if (unlikely(__pyx_t_1 == ((int)-1))) __PYX_ERR(0, 229, __pyx_L1_error)
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "tkwant/onebody/kernels.pyx":249
+    /* "tkwant/onebody/kernels.pyx":230
  * def _herm_conj(value):
  *     if hasattr(value, 'conjugate'):
  *         value = value.conjugate()             # <<<<<<<<<<<<<<
  *     if hasattr(value, 'transpose'):
  *         value = value.transpose()
  */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_value, __pyx_n_s_conjugate); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 249, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_value, __pyx_n_s_conjugate); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 230, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __pyx_t_5 = NULL;
     if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
       __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
       if (likely(__pyx_t_5)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
         __Pyx_INCREF(__pyx_t_5);
         __Pyx_INCREF(function);
         __Pyx_DECREF_SET(__pyx_t_4, function);
       }
     }
     __pyx_t_3 = (__pyx_t_5) ? __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5) : __Pyx_PyObject_CallNoArg(__pyx_t_4);
     __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-    if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 249, __pyx_L1_error)
+    if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 230, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_DECREF_SET(__pyx_v_value, __pyx_t_3);
     __pyx_t_3 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":248
+    /* "tkwant/onebody/kernels.pyx":229
  * 
  * def _herm_conj(value):
  *     if hasattr(value, 'conjugate'):             # <<<<<<<<<<<<<<
  *         value = value.conjugate()
  *     if hasattr(value, 'transpose'):
  */
   }
 
-  /* "tkwant/onebody/kernels.pyx":250
+  /* "tkwant/onebody/kernels.pyx":231
  *     if hasattr(value, 'conjugate'):
  *         value = value.conjugate()
  *     if hasattr(value, 'transpose'):             # <<<<<<<<<<<<<<
  *         value = value.transpose()
  *     return value
  */
-  __pyx_t_2 = __Pyx_HasAttr(__pyx_v_value, __pyx_n_u_transpose); if (unlikely(__pyx_t_2 == ((int)-1))) __PYX_ERR(0, 250, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_HasAttr(__pyx_v_value, __pyx_n_u_transpose); if (unlikely(__pyx_t_2 == ((int)-1))) __PYX_ERR(0, 231, __pyx_L1_error)
   __pyx_t_1 = (__pyx_t_2 != 0);
   if (__pyx_t_1) {
 
-    /* "tkwant/onebody/kernels.pyx":251
+    /* "tkwant/onebody/kernels.pyx":232
  *         value = value.conjugate()
  *     if hasattr(value, 'transpose'):
  *         value = value.transpose()             # <<<<<<<<<<<<<<
  *     return value
  * 
  */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_value, __pyx_n_s_transpose); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 251, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_value, __pyx_n_s_transpose); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 232, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __pyx_t_5 = NULL;
     if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
       __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
       if (likely(__pyx_t_5)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
         __Pyx_INCREF(__pyx_t_5);
         __Pyx_INCREF(function);
         __Pyx_DECREF_SET(__pyx_t_4, function);
       }
     }
     __pyx_t_3 = (__pyx_t_5) ? __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5) : __Pyx_PyObject_CallNoArg(__pyx_t_4);
     __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-    if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 251, __pyx_L1_error)
+    if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 232, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_DECREF_SET(__pyx_v_value, __pyx_t_3);
     __pyx_t_3 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":250
+    /* "tkwant/onebody/kernels.pyx":231
  *     if hasattr(value, 'conjugate'):
  *         value = value.conjugate()
  *     if hasattr(value, 'transpose'):             # <<<<<<<<<<<<<<
  *         value = value.transpose()
  *     return value
  */
   }
 
-  /* "tkwant/onebody/kernels.pyx":252
+  /* "tkwant/onebody/kernels.pyx":233
  *     if hasattr(value, 'transpose'):
  *         value = value.transpose()
  *     return value             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(__pyx_v_value);
   __pyx_r = __pyx_v_value;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":247
+  /* "tkwant/onebody/kernels.pyx":228
  * 
  * 
  * def _herm_conj(value):             # <<<<<<<<<<<<<<
  *     if hasattr(value, 'conjugate'):
  *         value = value.conjugate()
  */
 
@@ -6241,29 +5990,3491 @@
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v_value);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":297
+/* "tkwant/onebody/kernels.pyx":253
+ *         unsigned nnz
+ * 
+ *     def __init__(self, func, t0, dt_init=0.001, atol=1E-10, rtol=1E-10, dt_min=1E-6, fac=0.9, facmin=0.1, facmax=3):             # <<<<<<<<<<<<<<
+ * 
+ *         # The spline interpolation in this routine is done "on the fly".
+ */
+
+/* Python wrapper */
+static int __pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static int __pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  PyObject *__pyx_v_func = 0;
+  PyObject *__pyx_v_t0 = 0;
+  PyObject *__pyx_v_dt_init = 0;
+  PyObject *__pyx_v_atol = 0;
+  PyObject *__pyx_v_rtol = 0;
+  PyObject *__pyx_v_dt_min = 0;
+  PyObject *__pyx_v_fac = 0;
+  PyObject *__pyx_v_facmin = 0;
+  PyObject *__pyx_v_facmax = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
+  {
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_func,&__pyx_n_s_t0,&__pyx_n_s_dt_init,&__pyx_n_s_atol,&__pyx_n_s_rtol,&__pyx_n_s_dt_min,&__pyx_n_s_fac,&__pyx_n_s_facmin,&__pyx_n_s_facmax,0};
+    PyObject* values[9] = {0,0,0,0,0,0,0,0,0};
+    values[2] = ((PyObject *)__pyx_float_0_001);
+    values[3] = ((PyObject *)__pyx_float_1Eneg_10);
+    values[4] = ((PyObject *)__pyx_float_1Eneg_10);
+    values[5] = ((PyObject *)__pyx_float_1Eneg_6);
+    values[6] = ((PyObject *)__pyx_float_0_9);
+    values[7] = ((PyObject *)__pyx_float_0_1);
+    values[8] = ((PyObject *)__pyx_int_3);
+    if (unlikely(__pyx_kwds)) {
+      Py_ssize_t kw_args;
+      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
+      switch (pos_args) {
+        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
+        CYTHON_FALLTHROUGH;
+        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
+        CYTHON_FALLTHROUGH;
+        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
+        CYTHON_FALLTHROUGH;
+        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
+        CYTHON_FALLTHROUGH;
+        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+        CYTHON_FALLTHROUGH;
+        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+        CYTHON_FALLTHROUGH;
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = PyDict_Size(__pyx_kwds);
+      switch (pos_args) {
+        case  0:
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_func)) != 0)) kw_args--;
+        else goto __pyx_L5_argtuple_error;
+        CYTHON_FALLTHROUGH;
+        case  1:
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_t0)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 9, 1); __PYX_ERR(0, 253, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  2:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_dt_init);
+          if (value) { values[2] = value; kw_args--; }
+        }
+        CYTHON_FALLTHROUGH;
+        case  3:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_atol);
+          if (value) { values[3] = value; kw_args--; }
+        }
+        CYTHON_FALLTHROUGH;
+        case  4:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_rtol);
+          if (value) { values[4] = value; kw_args--; }
+        }
+        CYTHON_FALLTHROUGH;
+        case  5:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_dt_min);
+          if (value) { values[5] = value; kw_args--; }
+        }
+        CYTHON_FALLTHROUGH;
+        case  6:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_fac);
+          if (value) { values[6] = value; kw_args--; }
+        }
+        CYTHON_FALLTHROUGH;
+        case  7:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_facmin);
+          if (value) { values[7] = value; kw_args--; }
+        }
+        CYTHON_FALLTHROUGH;
+        case  8:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_facmax);
+          if (value) { values[8] = value; kw_args--; }
+        }
+      }
+      if (unlikely(kw_args > 0)) {
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 253, __pyx_L3_error)
+      }
+    } else {
+      switch (PyTuple_GET_SIZE(__pyx_args)) {
+        case  9: values[8] = PyTuple_GET_ITEM(__pyx_args, 8);
+        CYTHON_FALLTHROUGH;
+        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
+        CYTHON_FALLTHROUGH;
+        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
+        CYTHON_FALLTHROUGH;
+        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
+        CYTHON_FALLTHROUGH;
+        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+        CYTHON_FALLTHROUGH;
+        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+        CYTHON_FALLTHROUGH;
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+    }
+    __pyx_v_func = values[0];
+    __pyx_v_t0 = values[1];
+    __pyx_v_dt_init = values[2];
+    __pyx_v_atol = values[3];
+    __pyx_v_rtol = values[4];
+    __pyx_v_dt_min = values[5];
+    __pyx_v_fac = values[6];
+    __pyx_v_facmin = values[7];
+    __pyx_v_facmax = values[8];
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 9, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 253, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return -1;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_13Interpolation___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)__pyx_v_self), __pyx_v_func, __pyx_v_t0, __pyx_v_dt_init, __pyx_v_atol, __pyx_v_rtol, __pyx_v_dt_min, __pyx_v_fac, __pyx_v_facmin, __pyx_v_facmax);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static int __pyx_pf_6tkwant_7onebody_7kernels_13Interpolation___init__(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, PyObject *__pyx_v_func, PyObject *__pyx_v_t0, PyObject *__pyx_v_dt_init, PyObject *__pyx_v_atol, PyObject *__pyx_v_rtol, PyObject *__pyx_v_dt_min, PyObject *__pyx_v_fac, PyObject *__pyx_v_facmin, PyObject *__pyx_v_facmax) {
+  PyObject *__pyx_v_Ht02 = NULL;
+  PyObject *__pyx_v_Ht12 = NULL;
+  PyObject *__pyx_v_Ht22 = NULL;
+  double __pyx_v_rdt2;
+  double __pyx_v_rdt2h;
+  double __pyx_v_cl0;
+  double __pyx_v_cl1;
+  double __pyx_v_cl2;
+  double __pyx_v_cl3;
+  double __pyx_v_cl4;
+  double __pyx_v_cl5;
+  unsigned int __pyx_v_i;
+  double __pyx_v_cc2;
+  double __pyx_v_cc1;
+  double __pyx_v_cc0;
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_t_2;
+  double __pyx_t_3;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
+  unsigned int __pyx_t_7;
+  unsigned int __pyx_t_8;
+  unsigned int __pyx_t_9;
+  PyObject *__pyx_t_10 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__init__", 0);
+
+  /* "tkwant/onebody/kernels.pyx":273
+ *         # We use a foreward derivative in this case.
+ * 
+ *         assert dt_init > 0             # <<<<<<<<<<<<<<
+ *         assert dt_min > 0
+ *         assert atol >= 0
+ */
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    __pyx_t_1 = PyObject_RichCompare(__pyx_v_dt_init, __pyx_int_0, Py_GT); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 273, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 273, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    if (unlikely(!__pyx_t_2)) {
+      PyErr_SetNone(PyExc_AssertionError);
+      __PYX_ERR(0, 273, __pyx_L1_error)
+    }
+  }
+  #endif
+
+  /* "tkwant/onebody/kernels.pyx":274
+ * 
+ *         assert dt_init > 0
+ *         assert dt_min > 0             # <<<<<<<<<<<<<<
+ *         assert atol >= 0
+ *         assert rtol >= 0
+ */
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    __pyx_t_1 = PyObject_RichCompare(__pyx_v_dt_min, __pyx_int_0, Py_GT); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 274, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 274, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    if (unlikely(!__pyx_t_2)) {
+      PyErr_SetNone(PyExc_AssertionError);
+      __PYX_ERR(0, 274, __pyx_L1_error)
+    }
+  }
+  #endif
+
+  /* "tkwant/onebody/kernels.pyx":275
+ *         assert dt_init > 0
+ *         assert dt_min > 0
+ *         assert atol >= 0             # <<<<<<<<<<<<<<
+ *         assert rtol >= 0
+ * 
+ */
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    __pyx_t_1 = PyObject_RichCompare(__pyx_v_atol, __pyx_int_0, Py_GE); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 275, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 275, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    if (unlikely(!__pyx_t_2)) {
+      PyErr_SetNone(PyExc_AssertionError);
+      __PYX_ERR(0, 275, __pyx_L1_error)
+    }
+  }
+  #endif
+
+  /* "tkwant/onebody/kernels.pyx":276
+ *         assert dt_min > 0
+ *         assert atol >= 0
+ *         assert rtol >= 0             # <<<<<<<<<<<<<<
+ * 
+ *         self.dt = dt_init
+ */
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    __pyx_t_1 = PyObject_RichCompare(__pyx_v_rtol, __pyx_int_0, Py_GE); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 276, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 276, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    if (unlikely(!__pyx_t_2)) {
+      PyErr_SetNone(PyExc_AssertionError);
+      __PYX_ERR(0, 276, __pyx_L1_error)
+    }
+  }
+  #endif
+
+  /* "tkwant/onebody/kernels.pyx":278
+ *         assert rtol >= 0
+ * 
+ *         self.dt = dt_init             # <<<<<<<<<<<<<<
+ *         self.func = func
+ * 
+ */
+  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_v_dt_init); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 278, __pyx_L1_error)
+  __pyx_v_self->dt = __pyx_t_3;
+
+  /* "tkwant/onebody/kernels.pyx":279
+ * 
+ *         self.dt = dt_init
+ *         self.func = func             # <<<<<<<<<<<<<<
+ * 
+ *         self.atol = atol
+ */
+  __Pyx_INCREF(__pyx_v_func);
+  __Pyx_GIVEREF(__pyx_v_func);
+  __Pyx_GOTREF(__pyx_v_self->func);
+  __Pyx_DECREF(__pyx_v_self->func);
+  __pyx_v_self->func = __pyx_v_func;
+
+  /* "tkwant/onebody/kernels.pyx":281
+ *         self.func = func
+ * 
+ *         self.atol = atol             # <<<<<<<<<<<<<<
+ *         self.rtol = rtol
+ * 
+ */
+  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_v_atol); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 281, __pyx_L1_error)
+  __pyx_v_self->atol = __pyx_t_3;
+
+  /* "tkwant/onebody/kernels.pyx":282
+ * 
+ *         self.atol = atol
+ *         self.rtol = rtol             # <<<<<<<<<<<<<<
+ * 
+ *         self.fac = fac
+ */
+  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_v_rtol); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 282, __pyx_L1_error)
+  __pyx_v_self->rtol = __pyx_t_3;
+
+  /* "tkwant/onebody/kernels.pyx":284
+ *         self.rtol = rtol
+ * 
+ *         self.fac = fac             # <<<<<<<<<<<<<<
+ *         self.facmin = facmin
+ *         self.facmax = facmax
+ */
+  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_v_fac); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 284, __pyx_L1_error)
+  __pyx_v_self->fac = __pyx_t_3;
+
+  /* "tkwant/onebody/kernels.pyx":285
+ * 
+ *         self.fac = fac
+ *         self.facmin = facmin             # <<<<<<<<<<<<<<
+ *         self.facmax = facmax
+ * 
+ */
+  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_v_facmin); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 285, __pyx_L1_error)
+  __pyx_v_self->facmin = __pyx_t_3;
+
+  /* "tkwant/onebody/kernels.pyx":286
+ *         self.fac = fac
+ *         self.facmin = facmin
+ *         self.facmax = facmax             # <<<<<<<<<<<<<<
+ * 
+ *         self.dt_min = dt_min
+ */
+  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_v_facmax); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 286, __pyx_L1_error)
+  __pyx_v_self->facmax = __pyx_t_3;
+
+  /* "tkwant/onebody/kernels.pyx":288
+ *         self.facmax = facmax
+ * 
+ *         self.dt_min = dt_min             # <<<<<<<<<<<<<<
+ * 
+ *         self.t0 = t0
+ */
+  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_v_dt_min); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 288, __pyx_L1_error)
+  __pyx_v_self->dt_min = __pyx_t_3;
+
+  /* "tkwant/onebody/kernels.pyx":290
+ *         self.dt_min = dt_min
+ * 
+ *         self.t0 = t0             # <<<<<<<<<<<<<<
+ *         self.t1 = self.t0 + self.dt
+ *         self.t2 = self.t1 + self.dt
+ */
+  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_v_t0); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 290, __pyx_L1_error)
+  __pyx_v_self->t0 = __pyx_t_3;
+
+  /* "tkwant/onebody/kernels.pyx":291
+ * 
+ *         self.t0 = t0
+ *         self.t1 = self.t0 + self.dt             # <<<<<<<<<<<<<<
+ *         self.t2 = self.t1 + self.dt
+ *         self.t3 = self.t2 + self.dt
+ */
+  __pyx_v_self->t1 = (__pyx_v_self->t0 + __pyx_v_self->dt);
+
+  /* "tkwant/onebody/kernels.pyx":292
+ *         self.t0 = t0
+ *         self.t1 = self.t0 + self.dt
+ *         self.t2 = self.t1 + self.dt             # <<<<<<<<<<<<<<
+ *         self.t3 = self.t2 + self.dt
+ *         self.t4 = self.t3 + self.dt
+ */
+  __pyx_v_self->t2 = (__pyx_v_self->t1 + __pyx_v_self->dt);
+
+  /* "tkwant/onebody/kernels.pyx":293
+ *         self.t1 = self.t0 + self.dt
+ *         self.t2 = self.t1 + self.dt
+ *         self.t3 = self.t2 + self.dt             # <<<<<<<<<<<<<<
+ *         self.t4 = self.t3 + self.dt
+ * 
+ */
+  __pyx_v_self->t3 = (__pyx_v_self->t2 + __pyx_v_self->dt);
+
+  /* "tkwant/onebody/kernels.pyx":294
+ *         self.t2 = self.t1 + self.dt
+ *         self.t3 = self.t2 + self.dt
+ *         self.t4 = self.t3 + self.dt             # <<<<<<<<<<<<<<
+ * 
+ *         self.Ht0 = self.func(self.t0)
+ */
+  __pyx_v_self->t4 = (__pyx_v_self->t3 + __pyx_v_self->dt);
+
+  /* "tkwant/onebody/kernels.pyx":296
+ *         self.t4 = self.t3 + self.dt
+ * 
+ *         self.Ht0 = self.func(self.t0)             # <<<<<<<<<<<<<<
+ *         self.Ht1 = self.func(self.t1)
+ *         self.Ht2 = self.func(self.t2)
+ */
+  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_self->t0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 296, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __pyx_t_5 = __pyx_v_self->func; __pyx_t_6 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_5))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
+    if (likely(__pyx_t_6)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
+      __Pyx_INCREF(__pyx_t_6);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_5, function);
+    }
+  }
+  __pyx_t_1 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_5, __pyx_t_6, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 296, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v_self->Ht0);
+  __Pyx_DECREF(__pyx_v_self->Ht0);
+  __pyx_v_self->Ht0 = __pyx_t_1;
+  __pyx_t_1 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":297
+ * 
+ *         self.Ht0 = self.func(self.t0)
+ *         self.Ht1 = self.func(self.t1)             # <<<<<<<<<<<<<<
+ *         self.Ht2 = self.func(self.t2)
+ *         self.Ht3 = self.func(self.t3)
+ */
+  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_self->t1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 297, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __pyx_t_4 = __pyx_v_self->func; __pyx_t_6 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
+    if (likely(__pyx_t_6)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+      __Pyx_INCREF(__pyx_t_6);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_4, function);
+    }
+  }
+  __pyx_t_1 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 297, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v_self->Ht1);
+  __Pyx_DECREF(__pyx_v_self->Ht1);
+  __pyx_v_self->Ht1 = __pyx_t_1;
+  __pyx_t_1 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":298
+ *         self.Ht0 = self.func(self.t0)
+ *         self.Ht1 = self.func(self.t1)
+ *         self.Ht2 = self.func(self.t2)             # <<<<<<<<<<<<<<
+ *         self.Ht3 = self.func(self.t3)
+ *         self.Ht4 = self.func(self.t4)
+ */
+  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_self->t2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 298, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __pyx_t_5 = __pyx_v_self->func; __pyx_t_6 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_5))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
+    if (likely(__pyx_t_6)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
+      __Pyx_INCREF(__pyx_t_6);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_5, function);
+    }
+  }
+  __pyx_t_1 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_5, __pyx_t_6, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 298, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v_self->Ht2);
+  __Pyx_DECREF(__pyx_v_self->Ht2);
+  __pyx_v_self->Ht2 = __pyx_t_1;
+  __pyx_t_1 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":299
+ *         self.Ht1 = self.func(self.t1)
+ *         self.Ht2 = self.func(self.t2)
+ *         self.Ht3 = self.func(self.t3)             # <<<<<<<<<<<<<<
+ *         self.Ht4 = self.func(self.t4)
+ * 
+ */
+  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_self->t3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 299, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __pyx_t_4 = __pyx_v_self->func; __pyx_t_6 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
+    if (likely(__pyx_t_6)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+      __Pyx_INCREF(__pyx_t_6);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_4, function);
+    }
+  }
+  __pyx_t_1 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 299, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v_self->Ht3);
+  __Pyx_DECREF(__pyx_v_self->Ht3);
+  __pyx_v_self->Ht3 = __pyx_t_1;
+  __pyx_t_1 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":300
+ *         self.Ht2 = self.func(self.t2)
+ *         self.Ht3 = self.func(self.t3)
+ *         self.Ht4 = self.func(self.t4)             # <<<<<<<<<<<<<<
+ * 
+ *         self.nnz = self.Ht0.shape[0]
+ */
+  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_self->t4); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 300, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __pyx_t_5 = __pyx_v_self->func; __pyx_t_6 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_5))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
+    if (likely(__pyx_t_6)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
+      __Pyx_INCREF(__pyx_t_6);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_5, function);
+    }
+  }
+  __pyx_t_1 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_5, __pyx_t_6, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 300, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v_self->Ht4);
+  __Pyx_DECREF(__pyx_v_self->Ht4);
+  __pyx_v_self->Ht4 = __pyx_t_1;
+  __pyx_t_1 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":302
+ *         self.Ht4 = self.func(self.t4)
+ * 
+ *         self.nnz = self.Ht0.shape[0]             # <<<<<<<<<<<<<<
+ * 
+ *         Ht02 = self.func(self.t0 + 0.5 * self.dt)
+ */
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->Ht0, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 302, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 302, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_7 = __Pyx_PyInt_As_unsigned_int(__pyx_t_5); if (unlikely((__pyx_t_7 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(0, 302, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_v_self->nnz = __pyx_t_7;
+
+  /* "tkwant/onebody/kernels.pyx":304
+ *         self.nnz = self.Ht0.shape[0]
+ * 
+ *         Ht02 = self.func(self.t0 + 0.5 * self.dt)             # <<<<<<<<<<<<<<
+ *         Ht12 = self.func(self.t0 + 1.5 * self.dt)
+ *         Ht22 = self.func(self.t0 + 2.5 * self.dt)
+ */
+  __pyx_t_1 = PyFloat_FromDouble((__pyx_v_self->t0 + (0.5 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 304, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __pyx_t_4 = __pyx_v_self->func; __pyx_t_6 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
+    if (likely(__pyx_t_6)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+      __Pyx_INCREF(__pyx_t_6);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_4, function);
+    }
+  }
+  __pyx_t_5 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_6, __pyx_t_1) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 304, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_v_Ht02 = __pyx_t_5;
+  __pyx_t_5 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":305
+ * 
+ *         Ht02 = self.func(self.t0 + 0.5 * self.dt)
+ *         Ht12 = self.func(self.t0 + 1.5 * self.dt)             # <<<<<<<<<<<<<<
+ *         Ht22 = self.func(self.t0 + 2.5 * self.dt)
+ * 
+ */
+  __pyx_t_4 = PyFloat_FromDouble((__pyx_v_self->t0 + (1.5 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 305, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __pyx_t_1 = __pyx_v_self->func; __pyx_t_6 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_1))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
+    if (likely(__pyx_t_6)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+      __Pyx_INCREF(__pyx_t_6);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_1, function);
+    }
+  }
+  __pyx_t_5 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_6, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 305, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v_Ht12 = __pyx_t_5;
+  __pyx_t_5 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":306
+ *         Ht02 = self.func(self.t0 + 0.5 * self.dt)
+ *         Ht12 = self.func(self.t0 + 1.5 * self.dt)
+ *         Ht22 = self.func(self.t0 + 2.5 * self.dt)             # <<<<<<<<<<<<<<
+ * 
+ *         rdt2 = 1 / (self.dt * self.dt)
+ */
+  __pyx_t_1 = PyFloat_FromDouble((__pyx_v_self->t0 + (2.5 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 306, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __pyx_t_4 = __pyx_v_self->func; __pyx_t_6 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
+    if (likely(__pyx_t_6)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+      __Pyx_INCREF(__pyx_t_6);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_4, function);
+    }
+  }
+  __pyx_t_5 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_6, __pyx_t_1) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 306, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_v_Ht22 = __pyx_t_5;
+  __pyx_t_5 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":308
+ *         Ht22 = self.func(self.t0 + 2.5 * self.dt)
+ * 
+ *         rdt2 = 1 / (self.dt * self.dt)             # <<<<<<<<<<<<<<
+ *         rdt2h = 4 * rdt2
+ * 
+ */
+  __pyx_t_3 = (__pyx_v_self->dt * __pyx_v_self->dt);
+  if (unlikely(__pyx_t_3 == 0)) {
+    PyErr_SetString(PyExc_ZeroDivisionError, "float division");
+    __PYX_ERR(0, 308, __pyx_L1_error)
+  }
+  __pyx_v_rdt2 = (1.0 / __pyx_t_3);
+
+  /* "tkwant/onebody/kernels.pyx":309
+ * 
+ *         rdt2 = 1 / (self.dt * self.dt)
+ *         rdt2h = 4 * rdt2             # <<<<<<<<<<<<<<
+ * 
+ *         # w''(t0), forward finite difference scheme (4. order)
+ */
+  __pyx_v_rdt2h = (4.0 * __pyx_v_rdt2);
+
+  /* "tkwant/onebody/kernels.pyx":313
+ *         # w''(t0), forward finite difference scheme (4. order)
+ *         # on the half interval dt / 2
+ *         cl0 = 15 / 4 * rdt2h             # <<<<<<<<<<<<<<
+ *         cl1 = -77 / 6 * rdt2h
+ *         cl2 = 107 / 6 * rdt2h
+ */
+  __pyx_v_cl0 = ((15.0 / 4.0) * __pyx_v_rdt2h);
+
+  /* "tkwant/onebody/kernels.pyx":314
+ *         # on the half interval dt / 2
+ *         cl0 = 15 / 4 * rdt2h
+ *         cl1 = -77 / 6 * rdt2h             # <<<<<<<<<<<<<<
+ *         cl2 = 107 / 6 * rdt2h
+ *         cl3 = -13 * rdt2h
+ */
+  __pyx_v_cl1 = ((-77.0 / 6.0) * __pyx_v_rdt2h);
+
+  /* "tkwant/onebody/kernels.pyx":315
+ *         cl0 = 15 / 4 * rdt2h
+ *         cl1 = -77 / 6 * rdt2h
+ *         cl2 = 107 / 6 * rdt2h             # <<<<<<<<<<<<<<
+ *         cl3 = -13 * rdt2h
+ *         cl4 = 61 / 12 * rdt2h
+ */
+  __pyx_v_cl2 = ((107.0 / 6.0) * __pyx_v_rdt2h);
+
+  /* "tkwant/onebody/kernels.pyx":316
+ *         cl1 = -77 / 6 * rdt2h
+ *         cl2 = 107 / 6 * rdt2h
+ *         cl3 = -13 * rdt2h             # <<<<<<<<<<<<<<
+ *         cl4 = 61 / 12 * rdt2h
+ *         cl5 = -5 / 6 * rdt2h
+ */
+  __pyx_v_cl3 = (-13.0 * __pyx_v_rdt2h);
+
+  /* "tkwant/onebody/kernels.pyx":317
+ *         cl2 = 107 / 6 * rdt2h
+ *         cl3 = -13 * rdt2h
+ *         cl4 = 61 / 12 * rdt2h             # <<<<<<<<<<<<<<
+ *         cl5 = -5 / 6 * rdt2h
+ *         self.d2Ht0 = np.zeros((self.nnz,), dtype=complex)
+ */
+  __pyx_v_cl4 = ((61.0 / 12.0) * __pyx_v_rdt2h);
+
+  /* "tkwant/onebody/kernels.pyx":318
+ *         cl3 = -13 * rdt2h
+ *         cl4 = 61 / 12 * rdt2h
+ *         cl5 = -5 / 6 * rdt2h             # <<<<<<<<<<<<<<
+ *         self.d2Ht0 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):
+ */
+  __pyx_v_cl5 = ((-5.0 / 6.0) * __pyx_v_rdt2h);
+
+  /* "tkwant/onebody/kernels.pyx":319
+ *         cl4 = 61 / 12 * rdt2h
+ *         cl5 = -5 / 6 * rdt2h
+ *         self.d2Ht0 = np.zeros((self.nnz,), dtype=complex)             # <<<<<<<<<<<<<<
+ *         for i in range(self.nnz):
+ *             self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \
+ */
+  __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 319, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 319, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 319, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 319, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_5);
+  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_5);
+  __pyx_t_5 = 0;
+  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 319, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_GIVEREF(__pyx_t_1);
+  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_1);
+  __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 319, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 319, __pyx_L1_error)
+  __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, __pyx_t_1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 319, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __Pyx_GIVEREF(__pyx_t_6);
+  __Pyx_GOTREF(__pyx_v_self->d2Ht0);
+  __Pyx_DECREF(__pyx_v_self->d2Ht0);
+  __pyx_v_self->d2Ht0 = __pyx_t_6;
+  __pyx_t_6 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":320
+ *         cl5 = -5 / 6 * rdt2h
+ *         self.d2Ht0 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):             # <<<<<<<<<<<<<<
+ *             self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \
+ *                 + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]
+ */
+  __pyx_t_7 = __pyx_v_self->nnz;
+  __pyx_t_8 = __pyx_t_7;
+  for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_8; __pyx_t_9+=1) {
+    __pyx_v_i = __pyx_t_9;
+
+    /* "tkwant/onebody/kernels.pyx":321
+ *         self.d2Ht0 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):
+ *             self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \             # <<<<<<<<<<<<<<
+ *                 + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]
+ * 
+ */
+    __pyx_t_6 = PyFloat_FromDouble(__pyx_v_cl0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = PyNumber_Multiply(__pyx_t_6, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = PyFloat_FromDouble(__pyx_v_cl1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_Ht02, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_4 = PyNumber_Multiply(__pyx_t_1, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __pyx_t_6 = PyNumber_Add(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cl2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_1 = PyNumber_Multiply(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_5 = PyNumber_Add(__pyx_t_6, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":322
+ *         for i in range(self.nnz):
+ *             self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \
+ *                 + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]             # <<<<<<<<<<<<<<
+ * 
+ *         # w''(t2), central finite difference scheme (4. order)
+ */
+    __pyx_t_1 = PyFloat_FromDouble(__pyx_v_cl3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_Ht12, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_4 = PyNumber_Multiply(__pyx_t_1, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __pyx_t_6 = PyNumber_Add(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cl4); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_1 = PyNumber_Multiply(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_5 = PyNumber_Add(__pyx_t_6, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = PyFloat_FromDouble(__pyx_v_cl5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_Ht22, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_4 = PyNumber_Multiply(__pyx_t_1, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __pyx_t_6 = PyNumber_Add(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 322, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":321
+ *         self.d2Ht0 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):
+ *             self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \             # <<<<<<<<<<<<<<
+ *                 + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]
+ * 
+ */
+    if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, __pyx_t_6, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1) < 0)) __PYX_ERR(0, 321, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":325
+ * 
+ *         # w''(t2), central finite difference scheme (4. order)
+ *         cc2 = - rdt2 / 12             # <<<<<<<<<<<<<<
+ *         cc1 = rdt2 * 4 / 3
+ *         cc0 = - 2.5 * rdt2
+ */
+  __pyx_v_cc2 = ((-__pyx_v_rdt2) / 12.0);
+
+  /* "tkwant/onebody/kernels.pyx":326
+ *         # w''(t2), central finite difference scheme (4. order)
+ *         cc2 = - rdt2 / 12
+ *         cc1 = rdt2 * 4 / 3             # <<<<<<<<<<<<<<
+ *         cc0 = - 2.5 * rdt2
+ *         self.d2Ht2 = np.zeros((self.nnz,), dtype=complex)
+ */
+  __pyx_v_cc1 = ((__pyx_v_rdt2 * 4.0) / 3.0);
+
+  /* "tkwant/onebody/kernels.pyx":327
+ *         cc2 = - rdt2 / 12
+ *         cc1 = rdt2 * 4 / 3
+ *         cc0 = - 2.5 * rdt2             # <<<<<<<<<<<<<<
+ *         self.d2Ht2 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):
+ */
+  __pyx_v_cc0 = (-2.5 * __pyx_v_rdt2);
+
+  /* "tkwant/onebody/kernels.pyx":328
+ *         cc1 = rdt2 * 4 / 3
+ *         cc0 = - 2.5 * rdt2
+ *         self.d2Ht2 = np.zeros((self.nnz,), dtype=complex)             # <<<<<<<<<<<<<<
+ *         for i in range(self.nnz):
+ *             self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+ */
+  __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 328, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 328, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __pyx_t_6 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 328, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 328, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_GIVEREF(__pyx_t_6);
+  PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_6);
+  __pyx_t_6 = 0;
+  __pyx_t_6 = PyTuple_New(1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 328, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __Pyx_GIVEREF(__pyx_t_5);
+  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5);
+  __pyx_t_5 = 0;
+  __pyx_t_5 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 328, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 328, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 328, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v_self->d2Ht2);
+  __Pyx_DECREF(__pyx_v_self->d2Ht2);
+  __pyx_v_self->d2Ht2 = __pyx_t_1;
+  __pyx_t_1 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":329
+ *         cc0 = - 2.5 * rdt2
+ *         self.d2Ht2 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):             # <<<<<<<<<<<<<<
+ *             self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+ *                 + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+ */
+  __pyx_t_7 = __pyx_v_self->nnz;
+  __pyx_t_8 = __pyx_t_7;
+  for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_8; __pyx_t_9+=1) {
+    __pyx_v_i = __pyx_t_9;
+
+    /* "tkwant/onebody/kernels.pyx":330
+ *         self.d2Ht2 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):
+ *             self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
+ *                 + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+ *                 + cc0 * self.Ht2[i]
+ */
+    __pyx_t_1 = PyFloat_FromDouble(__pyx_v_cc2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 330, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 330, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->Ht4, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 330, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_4 = PyNumber_Add(__pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 330, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __pyx_t_6 = PyNumber_Multiply(__pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 330, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":331
+ *         for i in range(self.nnz):
+ *             self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+ *                 + cc1 * (self.Ht1[i] + self.Ht3[i]) \             # <<<<<<<<<<<<<<
+ *                 + cc0 * self.Ht2[i]
+ * 
+ */
+    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cc1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht3, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_10 = PyNumber_Add(__pyx_t_1, __pyx_t_5); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_5 = PyNumber_Multiply(__pyx_t_4, __pyx_t_10); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __pyx_t_10 = PyNumber_Add(__pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 331, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":332
+ *             self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+ *                 + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+ *                 + cc0 * self.Ht2[i]             # <<<<<<<<<<<<<<
+ * 
+ *         # w''(t1), spline formula
+ */
+    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_cc0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 332, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 332, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_4 = PyNumber_Multiply(__pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 332, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __pyx_t_6 = PyNumber_Add(__pyx_t_10, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 332, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":330
+ *         self.d2Ht2 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):
+ *             self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
+ *                 + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+ *                 + cc0 * self.Ht2[i]
+ */
+    if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, __pyx_t_6, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1) < 0)) __PYX_ERR(0, 330, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":335
+ * 
+ *         # w''(t1), spline formula
+ *         self.d2Ht1 = np.zeros((self.nnz,), dtype=complex)             # <<<<<<<<<<<<<<
+ *         for i in range(self.nnz):
+ *             self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \
+ */
+  __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_np); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 335, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 335, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __pyx_t_6 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 335, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_10 = PyTuple_New(1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 335, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_10);
+  __Pyx_GIVEREF(__pyx_t_6);
+  PyTuple_SET_ITEM(__pyx_t_10, 0, __pyx_t_6);
+  __pyx_t_6 = 0;
+  __pyx_t_6 = PyTuple_New(1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 335, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __Pyx_GIVEREF(__pyx_t_10);
+  PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_10);
+  __pyx_t_10 = 0;
+  __pyx_t_10 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 335, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_10);
+  if (PyDict_SetItem(__pyx_t_10, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 335, __pyx_L1_error)
+  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_6, __pyx_t_10); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 335, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+  __Pyx_GIVEREF(__pyx_t_5);
+  __Pyx_GOTREF(__pyx_v_self->d2Ht1);
+  __Pyx_DECREF(__pyx_v_self->d2Ht1);
+  __pyx_v_self->d2Ht1 = __pyx_t_5;
+  __pyx_t_5 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":336
+ *         # w''(t1), spline formula
+ *         self.d2Ht1 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):             # <<<<<<<<<<<<<<
+ *             self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \
+ *                 - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
+ */
+  __pyx_t_7 = __pyx_v_self->nnz;
+  __pyx_t_8 = __pyx_t_7;
+  for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_8; __pyx_t_9+=1) {
+    __pyx_v_i = __pyx_t_9;
+
+    /* "tkwant/onebody/kernels.pyx":337
+ *         self.d2Ht1 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):
+ *             self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \             # <<<<<<<<<<<<<<
+ *                 - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
+ * 
+ */
+    __pyx_t_5 = PyFloat_FromDouble((1.5 * __pyx_v_rdt2)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 337, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_10 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 337, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 337, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_4 = PyNumber_Add(__pyx_t_10, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 337, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 337, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_10 = PyNumber_Multiply(__pyx_int_2, __pyx_t_6); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 337, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __pyx_t_6 = PyNumber_Subtract(__pyx_t_4, __pyx_t_10); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 337, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __pyx_t_10 = PyNumber_Multiply(__pyx_t_5, __pyx_t_6); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 337, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_10);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":338
+ *         for i in range(self.nnz):
+ *             self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \
+ *                 - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])             # <<<<<<<<<<<<<<
+ * 
+ *     @cython.boundscheck(False)
+ */
+    __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 338, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 338, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_4 = PyNumber_Add(__pyx_t_6, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 338, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_5 = PyNumber_Multiply(__pyx_float_0_25, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 338, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_t_4 = PyNumber_Subtract(__pyx_t_10, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 338, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":337
+ *         self.d2Ht1 = np.zeros((self.nnz,), dtype=complex)
+ *         for i in range(self.nnz):
+ *             self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \             # <<<<<<<<<<<<<<
+ *                 - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
+ * 
+ */
+    if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht1, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1) < 0)) __PYX_ERR(0, 337, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":253
+ *         unsigned nnz
+ * 
+ *     def __init__(self, func, t0, dt_init=0.001, atol=1E-10, rtol=1E-10, dt_min=1E-6, fac=0.9, facmin=0.1, facmax=3):             # <<<<<<<<<<<<<<
+ * 
+ *         # The spline interpolation in this routine is done "on the fly".
+ */
+
+  /* function exit code */
+  __pyx_r = 0;
+  goto __pyx_L0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
+  __Pyx_XDECREF(__pyx_t_10);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = -1;
+  __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v_Ht02);
+  __Pyx_XDECREF(__pyx_v_Ht12);
+  __Pyx_XDECREF(__pyx_v_Ht22);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "tkwant/onebody/kernels.pyx":342
+ *     @cython.boundscheck(False)
+ *     @cython.wraparound(False)
+ *     def eval(self, double time, complex[:] out):             # <<<<<<<<<<<<<<
+ * 
+ *         if self.nnz == 0: return
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_3eval(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_2eval[] = "Interpolation.eval(self, double time, double complex[:] out)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_3eval(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  double __pyx_v_time;
+  __Pyx_memviewslice __pyx_v_out = { 0, 0, { 0 }, { 0 }, { 0 } };
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("eval (wrapper)", 0);
+  {
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_time,&__pyx_n_s_out,0};
+    PyObject* values[2] = {0,0};
+    if (unlikely(__pyx_kwds)) {
+      Py_ssize_t kw_args;
+      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
+      switch (pos_args) {
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = PyDict_Size(__pyx_kwds);
+      switch (pos_args) {
+        case  0:
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time)) != 0)) kw_args--;
+        else goto __pyx_L5_argtuple_error;
+        CYTHON_FALLTHROUGH;
+        case  1:
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_out)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("eval", 1, 2, 2, 1); __PYX_ERR(0, 342, __pyx_L3_error)
+        }
+      }
+      if (unlikely(kw_args > 0)) {
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "eval") < 0)) __PYX_ERR(0, 342, __pyx_L3_error)
+      }
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
+      goto __pyx_L5_argtuple_error;
+    } else {
+      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+    }
+    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 342, __pyx_L3_error)
+    __pyx_v_out = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[1], PyBUF_WRITABLE); if (unlikely(!__pyx_v_out.memview)) __PYX_ERR(0, 342, __pyx_L3_error)
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("eval", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 342, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation.eval", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_2eval(((struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)__pyx_v_self), __pyx_v_time, __pyx_v_out);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_2eval(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, double __pyx_v_time, __Pyx_memviewslice __pyx_v_out) {
+  double __pyx_v_rdt2;
+  double __pyx_v_a;
+  double __pyx_v_b;
+  double __pyx_v_c;
+  double __pyx_v_d;
+  unsigned int __pyx_v_i;
+  PyObject *__pyx_v_time_larger = NULL;
+  PyObject *__pyx_v_time_smaller = NULL;
+  PyObject *__pyx_v_error = NULL;
+  double __pyx_v_t0_new;
+  double __pyx_v_t1_new;
+  double __pyx_v_t2_new;
+  double __pyx_v_t3_new;
+  double __pyx_v_t4_new;
+  double __pyx_v_cc2;
+  double __pyx_v_cc1;
+  double __pyx_v_cc0;
+  PyObject *__pyx_v_Htm2 = NULL;
+  PyObject *__pyx_v_Htm1 = NULL;
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  int __pyx_t_1;
+  PyObject *__pyx_t_2 = NULL;
+  int __pyx_t_3;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
+  int __pyx_t_7;
+  PyObject *__pyx_t_8 = NULL;
+  double __pyx_t_9;
+  __pyx_ctuple_double__and_double__and_double__and_double__and_double __pyx_t_10;
+  double __pyx_t_11;
+  double __pyx_t_12;
+  double __pyx_t_13;
+  double __pyx_t_14;
+  unsigned int __pyx_t_15;
+  unsigned int __pyx_t_16;
+  unsigned int __pyx_t_17;
+  __pyx_ctuple_double__and_double__and_double__and_double __pyx_t_18;
+  __pyx_t_double_complex __pyx_t_19;
+  size_t __pyx_t_20;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("eval", 0);
+
+  /* "tkwant/onebody/kernels.pyx":344
+ *     def eval(self, double time, complex[:] out):
+ * 
+ *         if self.nnz == 0: return             # <<<<<<<<<<<<<<
+ * 
+ *         cdef double c0, c1, c2, rdt2
+ */
+  __pyx_t_1 = ((__pyx_v_self->nnz == 0) != 0);
+  if (__pyx_t_1) {
+    __Pyx_XDECREF(__pyx_r);
+    __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+    goto __pyx_L0;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":351
+ * 
+ *         # update matrices
+ *         time_larger = time >= self.t2             # <<<<<<<<<<<<<<
+ *         time_smaller = time < self.t0
+ * 
+ */
+  __pyx_t_2 = __Pyx_PyBool_FromLong((__pyx_v_time >= __pyx_v_self->t2)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 351, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_v_time_larger = __pyx_t_2;
+  __pyx_t_2 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":352
+ *         # update matrices
+ *         time_larger = time >= self.t2
+ *         time_smaller = time < self.t0             # <<<<<<<<<<<<<<
+ * 
+ *         if time_larger or time_smaller:
+ */
+  __pyx_t_2 = __Pyx_PyBool_FromLong((__pyx_v_time < __pyx_v_self->t0)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 352, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_v_time_smaller = __pyx_t_2;
+  __pyx_t_2 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":354
+ *         time_smaller = time < self.t0
+ * 
+ *         if time_larger or time_smaller:             # <<<<<<<<<<<<<<
+ * 
+ *             if time_larger:
+ */
+  __pyx_t_3 = __Pyx_PyObject_IsTrue(__pyx_v_time_larger); if (unlikely(__pyx_t_3 < 0)) __PYX_ERR(0, 354, __pyx_L1_error)
+  if (!__pyx_t_3) {
+  } else {
+    __pyx_t_1 = __pyx_t_3;
+    goto __pyx_L5_bool_binop_done;
+  }
+  __pyx_t_3 = __Pyx_PyObject_IsTrue(__pyx_v_time_smaller); if (unlikely(__pyx_t_3 < 0)) __PYX_ERR(0, 354, __pyx_L1_error)
+  __pyx_t_1 = __pyx_t_3;
+  __pyx_L5_bool_binop_done:;
+  if (__pyx_t_1) {
+
+    /* "tkwant/onebody/kernels.pyx":356
+ *         if time_larger or time_smaller:
+ * 
+ *             if time_larger:             # <<<<<<<<<<<<<<
+ *                 error = self._estimate_error(self.t1 + 0.5 * self.dt)
+ *             else:
+ */
+    __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_time_larger); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 356, __pyx_L1_error)
+    if (__pyx_t_1) {
+
+      /* "tkwant/onebody/kernels.pyx":357
+ * 
+ *             if time_larger:
+ *                 error = self._estimate_error(self.t1 + 0.5 * self.dt)             # <<<<<<<<<<<<<<
+ *             else:
+ *                 error = self._estimate_error(self.t0 + 0.5 * self.dt)
+ */
+      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_estimate_error); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 357, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_5 = PyFloat_FromDouble((__pyx_v_self->t1 + (0.5 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 357, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_6 = NULL;
+      if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+        __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
+        if (likely(__pyx_t_6)) {
+          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+          __Pyx_INCREF(__pyx_t_6);
+          __Pyx_INCREF(function);
+          __Pyx_DECREF_SET(__pyx_t_4, function);
+        }
+      }
+      __pyx_t_2 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5);
+      __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 357, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_v_error = __pyx_t_2;
+      __pyx_t_2 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":356
+ *         if time_larger or time_smaller:
+ * 
+ *             if time_larger:             # <<<<<<<<<<<<<<
+ *                 error = self._estimate_error(self.t1 + 0.5 * self.dt)
+ *             else:
+ */
+      goto __pyx_L7;
+    }
+
+    /* "tkwant/onebody/kernels.pyx":359
+ *                 error = self._estimate_error(self.t1 + 0.5 * self.dt)
+ *             else:
+ *                 error = self._estimate_error(self.t0 + 0.5 * self.dt)             # <<<<<<<<<<<<<<
+ * 
+ *             self.dt = self._estimate_stepsize(self.dt, error)
+ */
+    /*else*/ {
+      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_estimate_error); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 359, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_5 = PyFloat_FromDouble((__pyx_v_self->t0 + (0.5 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 359, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_6 = NULL;
+      if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+        __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
+        if (likely(__pyx_t_6)) {
+          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+          __Pyx_INCREF(__pyx_t_6);
+          __Pyx_INCREF(function);
+          __Pyx_DECREF_SET(__pyx_t_4, function);
+        }
+      }
+      __pyx_t_2 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5);
+      __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 359, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_v_error = __pyx_t_2;
+      __pyx_t_2 = 0;
+    }
+    __pyx_L7:;
+
+    /* "tkwant/onebody/kernels.pyx":361
+ *                 error = self._estimate_error(self.t0 + 0.5 * self.dt)
+ * 
+ *             self.dt = self._estimate_stepsize(self.dt, error)             # <<<<<<<<<<<<<<
+ * 
+ *             t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)
+ */
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_estimate_stepsize); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 361, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_self->dt); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 361, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_6 = NULL;
+    __pyx_t_7 = 0;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
+      if (likely(__pyx_t_6)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+        __Pyx_INCREF(__pyx_t_6);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_4, function);
+        __pyx_t_7 = 1;
+      }
+    }
+    #if CYTHON_FAST_PYCALL
+    if (PyFunction_Check(__pyx_t_4)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_5, __pyx_v_error};
+      __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 361, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    } else
+    #endif
+    #if CYTHON_FAST_PYCCALL
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_5, __pyx_v_error};
+      __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 361, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    } else
+    #endif
+    {
+      __pyx_t_8 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 361, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      if (__pyx_t_6) {
+        __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6); __pyx_t_6 = NULL;
+      }
+      __Pyx_GIVEREF(__pyx_t_5);
+      PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_7, __pyx_t_5);
+      __Pyx_INCREF(__pyx_v_error);
+      __Pyx_GIVEREF(__pyx_v_error);
+      PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_7, __pyx_v_error);
+      __pyx_t_5 = 0;
+      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_8, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 361, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    }
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_t_9 = __pyx_PyFloat_AsDouble(__pyx_t_2); if (unlikely((__pyx_t_9 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 361, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_v_self->dt = __pyx_t_9;
+
+    /* "tkwant/onebody/kernels.pyx":363
+ *             self.dt = self._estimate_stepsize(self.dt, error)
+ * 
+ *             t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)             # <<<<<<<<<<<<<<
+ *             rdt2 = 1 / (self.dt * self.dt)
+ *             cc2 = - rdt2 / 12
+ */
+    __pyx_t_10 = __pyx_f_6tkwant_7onebody_7kernels_update_times(__pyx_v_time, __pyx_v_self->t0, __pyx_v_self->dt);
+    __pyx_t_9 = __pyx_t_10.f0;
+    __pyx_t_11 = __pyx_t_10.f1;
+    __pyx_t_12 = __pyx_t_10.f2;
+    __pyx_t_13 = __pyx_t_10.f3;
+    __pyx_t_14 = __pyx_t_10.f4;
+    __pyx_v_t0_new = __pyx_t_9;
+    __pyx_v_t1_new = __pyx_t_11;
+    __pyx_v_t2_new = __pyx_t_12;
+    __pyx_v_t3_new = __pyx_t_13;
+    __pyx_v_t4_new = __pyx_t_14;
+
+    /* "tkwant/onebody/kernels.pyx":364
+ * 
+ *             t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)
+ *             rdt2 = 1 / (self.dt * self.dt)             # <<<<<<<<<<<<<<
+ *             cc2 = - rdt2 / 12
+ *             cc1 = rdt2 * 4 / 3
+ */
+    __pyx_t_14 = (__pyx_v_self->dt * __pyx_v_self->dt);
+    if (unlikely(__pyx_t_14 == 0)) {
+      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
+      __PYX_ERR(0, 364, __pyx_L1_error)
+    }
+    __pyx_v_rdt2 = (1.0 / __pyx_t_14);
+
+    /* "tkwant/onebody/kernels.pyx":365
+ *             t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)
+ *             rdt2 = 1 / (self.dt * self.dt)
+ *             cc2 = - rdt2 / 12             # <<<<<<<<<<<<<<
+ *             cc1 = rdt2 * 4 / 3
+ *             cc0 = - 2.5 * rdt2
+ */
+    __pyx_v_cc2 = ((-__pyx_v_rdt2) / 12.0);
+
+    /* "tkwant/onebody/kernels.pyx":366
+ *             rdt2 = 1 / (self.dt * self.dt)
+ *             cc2 = - rdt2 / 12
+ *             cc1 = rdt2 * 4 / 3             # <<<<<<<<<<<<<<
+ *             cc0 = - 2.5 * rdt2
+ * 
+ */
+    __pyx_v_cc1 = ((__pyx_v_rdt2 * 4.0) / 3.0);
+
+    /* "tkwant/onebody/kernels.pyx":367
+ *             cc2 = - rdt2 / 12
+ *             cc1 = rdt2 * 4 / 3
+ *             cc0 = - 2.5 * rdt2             # <<<<<<<<<<<<<<
+ * 
+ *             Htm2 = self.func(t0_new - 2 * self.dt)
+ */
+    __pyx_v_cc0 = (-2.5 * __pyx_v_rdt2);
+
+    /* "tkwant/onebody/kernels.pyx":369
+ *             cc0 = - 2.5 * rdt2
+ * 
+ *             Htm2 = self.func(t0_new - 2 * self.dt)             # <<<<<<<<<<<<<<
+ *             Htm1 = self.func(t0_new - self.dt)
+ *             self.func(t0_new, self.Ht0)
+ */
+    __pyx_t_4 = PyFloat_FromDouble((__pyx_v_t0_new - (2.0 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 369, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_INCREF(__pyx_v_self->func);
+    __pyx_t_8 = __pyx_v_self->func; __pyx_t_5 = NULL;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_8))) {
+      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_8);
+      if (likely(__pyx_t_5)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
+        __Pyx_INCREF(__pyx_t_5);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_8, function);
+      }
+    }
+    __pyx_t_2 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_8, __pyx_t_5, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_8, __pyx_t_4);
+    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 369, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __pyx_v_Htm2 = __pyx_t_2;
+    __pyx_t_2 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":370
+ * 
+ *             Htm2 = self.func(t0_new - 2 * self.dt)
+ *             Htm1 = self.func(t0_new - self.dt)             # <<<<<<<<<<<<<<
+ *             self.func(t0_new, self.Ht0)
+ *             self.func(t1_new, self.Ht1)
+ */
+    __pyx_t_8 = PyFloat_FromDouble((__pyx_v_t0_new - __pyx_v_self->dt)); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 370, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __Pyx_INCREF(__pyx_v_self->func);
+    __pyx_t_4 = __pyx_v_self->func; __pyx_t_5 = NULL;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
+      if (likely(__pyx_t_5)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+        __Pyx_INCREF(__pyx_t_5);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_4, function);
+      }
+    }
+    __pyx_t_2 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_5, __pyx_t_8) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_8);
+    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 370, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_v_Htm1 = __pyx_t_2;
+    __pyx_t_2 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":371
+ *             Htm2 = self.func(t0_new - 2 * self.dt)
+ *             Htm1 = self.func(t0_new - self.dt)
+ *             self.func(t0_new, self.Ht0)             # <<<<<<<<<<<<<<
+ *             self.func(t1_new, self.Ht1)
+ *             self.func(t2_new, self.Ht2)
+ */
+    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_t0_new); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 371, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_INCREF(__pyx_v_self->func);
+    __pyx_t_8 = __pyx_v_self->func; __pyx_t_5 = NULL;
+    __pyx_t_7 = 0;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_8))) {
+      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_8);
+      if (likely(__pyx_t_5)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
+        __Pyx_INCREF(__pyx_t_5);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_8, function);
+        __pyx_t_7 = 1;
+      }
+    }
+    #if CYTHON_FAST_PYCALL
+    if (PyFunction_Check(__pyx_t_8)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_4, __pyx_v_self->Ht0};
+      __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 371, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    } else
+    #endif
+    #if CYTHON_FAST_PYCCALL
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_8)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_4, __pyx_v_self->Ht0};
+      __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 371, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    } else
+    #endif
+    {
+      __pyx_t_6 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 371, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_6);
+      if (__pyx_t_5) {
+        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5); __pyx_t_5 = NULL;
+      }
+      __Pyx_GIVEREF(__pyx_t_4);
+      PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_7, __pyx_t_4);
+      __Pyx_INCREF(__pyx_v_self->Ht0);
+      __Pyx_GIVEREF(__pyx_v_self->Ht0);
+      PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_7, __pyx_v_self->Ht0);
+      __pyx_t_4 = 0;
+      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_6, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 371, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    }
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":372
+ *             Htm1 = self.func(t0_new - self.dt)
+ *             self.func(t0_new, self.Ht0)
+ *             self.func(t1_new, self.Ht1)             # <<<<<<<<<<<<<<
+ *             self.func(t2_new, self.Ht2)
+ *             self.func(t3_new, self.Ht3)
+ */
+    __pyx_t_8 = PyFloat_FromDouble(__pyx_v_t1_new); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 372, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __Pyx_INCREF(__pyx_v_self->func);
+    __pyx_t_6 = __pyx_v_self->func; __pyx_t_4 = NULL;
+    __pyx_t_7 = 0;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_6))) {
+      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_6);
+      if (likely(__pyx_t_4)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
+        __Pyx_INCREF(__pyx_t_4);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_6, function);
+        __pyx_t_7 = 1;
+      }
+    }
+    #if CYTHON_FAST_PYCALL
+    if (PyFunction_Check(__pyx_t_6)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_8, __pyx_v_self->Ht1};
+      __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 372, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    } else
+    #endif
+    #if CYTHON_FAST_PYCCALL
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_6)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_8, __pyx_v_self->Ht1};
+      __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 372, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    } else
+    #endif
+    {
+      __pyx_t_5 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 372, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      if (__pyx_t_4) {
+        __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4); __pyx_t_4 = NULL;
+      }
+      __Pyx_GIVEREF(__pyx_t_8);
+      PyTuple_SET_ITEM(__pyx_t_5, 0+__pyx_t_7, __pyx_t_8);
+      __Pyx_INCREF(__pyx_v_self->Ht1);
+      __Pyx_GIVEREF(__pyx_v_self->Ht1);
+      PyTuple_SET_ITEM(__pyx_t_5, 1+__pyx_t_7, __pyx_v_self->Ht1);
+      __pyx_t_8 = 0;
+      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_5, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 372, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    }
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":373
+ *             self.func(t0_new, self.Ht0)
+ *             self.func(t1_new, self.Ht1)
+ *             self.func(t2_new, self.Ht2)             # <<<<<<<<<<<<<<
+ *             self.func(t3_new, self.Ht3)
+ *             self.func(t4_new, self.Ht4)
+ */
+    __pyx_t_6 = PyFloat_FromDouble(__pyx_v_t2_new); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 373, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_INCREF(__pyx_v_self->func);
+    __pyx_t_5 = __pyx_v_self->func; __pyx_t_8 = NULL;
+    __pyx_t_7 = 0;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_5))) {
+      __pyx_t_8 = PyMethod_GET_SELF(__pyx_t_5);
+      if (likely(__pyx_t_8)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
+        __Pyx_INCREF(__pyx_t_8);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_5, function);
+        __pyx_t_7 = 1;
+      }
+    }
+    #if CYTHON_FAST_PYCALL
+    if (PyFunction_Check(__pyx_t_5)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_8, __pyx_t_6, __pyx_v_self->Ht2};
+      __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 373, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    } else
+    #endif
+    #if CYTHON_FAST_PYCCALL
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_8, __pyx_t_6, __pyx_v_self->Ht2};
+      __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 373, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    } else
+    #endif
+    {
+      __pyx_t_4 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 373, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      if (__pyx_t_8) {
+        __Pyx_GIVEREF(__pyx_t_8); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_8); __pyx_t_8 = NULL;
+      }
+      __Pyx_GIVEREF(__pyx_t_6);
+      PyTuple_SET_ITEM(__pyx_t_4, 0+__pyx_t_7, __pyx_t_6);
+      __Pyx_INCREF(__pyx_v_self->Ht2);
+      __Pyx_GIVEREF(__pyx_v_self->Ht2);
+      PyTuple_SET_ITEM(__pyx_t_4, 1+__pyx_t_7, __pyx_v_self->Ht2);
+      __pyx_t_6 = 0;
+      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_4, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 373, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    }
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":374
+ *             self.func(t1_new, self.Ht1)
+ *             self.func(t2_new, self.Ht2)
+ *             self.func(t3_new, self.Ht3)             # <<<<<<<<<<<<<<
+ *             self.func(t4_new, self.Ht4)
+ * 
+ */
+    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_t3_new); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 374, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_INCREF(__pyx_v_self->func);
+    __pyx_t_4 = __pyx_v_self->func; __pyx_t_6 = NULL;
+    __pyx_t_7 = 0;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
+      if (likely(__pyx_t_6)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+        __Pyx_INCREF(__pyx_t_6);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_4, function);
+        __pyx_t_7 = 1;
+      }
+    }
+    #if CYTHON_FAST_PYCALL
+    if (PyFunction_Check(__pyx_t_4)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_5, __pyx_v_self->Ht3};
+      __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 374, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    } else
+    #endif
+    #if CYTHON_FAST_PYCCALL
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_5, __pyx_v_self->Ht3};
+      __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 374, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    } else
+    #endif
+    {
+      __pyx_t_8 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 374, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      if (__pyx_t_6) {
+        __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6); __pyx_t_6 = NULL;
+      }
+      __Pyx_GIVEREF(__pyx_t_5);
+      PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_7, __pyx_t_5);
+      __Pyx_INCREF(__pyx_v_self->Ht3);
+      __Pyx_GIVEREF(__pyx_v_self->Ht3);
+      PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_7, __pyx_v_self->Ht3);
+      __pyx_t_5 = 0;
+      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_8, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 374, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    }
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":375
+ *             self.func(t2_new, self.Ht2)
+ *             self.func(t3_new, self.Ht3)
+ *             self.func(t4_new, self.Ht4)             # <<<<<<<<<<<<<<
+ * 
+ *             for i in range(self.nnz):
+ */
+    __pyx_t_4 = PyFloat_FromDouble(__pyx_v_t4_new); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 375, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_INCREF(__pyx_v_self->func);
+    __pyx_t_8 = __pyx_v_self->func; __pyx_t_5 = NULL;
+    __pyx_t_7 = 0;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_8))) {
+      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_8);
+      if (likely(__pyx_t_5)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
+        __Pyx_INCREF(__pyx_t_5);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_8, function);
+        __pyx_t_7 = 1;
+      }
+    }
+    #if CYTHON_FAST_PYCALL
+    if (PyFunction_Check(__pyx_t_8)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_4, __pyx_v_self->Ht4};
+      __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 375, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    } else
+    #endif
+    #if CYTHON_FAST_PYCCALL
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_8)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_4, __pyx_v_self->Ht4};
+      __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 375, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    } else
+    #endif
+    {
+      __pyx_t_6 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 375, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_6);
+      if (__pyx_t_5) {
+        __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5); __pyx_t_5 = NULL;
+      }
+      __Pyx_GIVEREF(__pyx_t_4);
+      PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_7, __pyx_t_4);
+      __Pyx_INCREF(__pyx_v_self->Ht4);
+      __Pyx_GIVEREF(__pyx_v_self->Ht4);
+      PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_7, __pyx_v_self->Ht4);
+      __pyx_t_4 = 0;
+      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_6, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 375, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    }
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":377
+ *             self.func(t4_new, self.Ht4)
+ * 
+ *             for i in range(self.nnz):             # <<<<<<<<<<<<<<
+ *                 # w''(t) on t0 and t2, central finite difference scheme
+ *                 self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \
+ */
+    __pyx_t_15 = __pyx_v_self->nnz;
+    __pyx_t_16 = __pyx_t_15;
+    for (__pyx_t_17 = 0; __pyx_t_17 < __pyx_t_16; __pyx_t_17+=1) {
+      __pyx_v_i = __pyx_t_17;
+
+      /* "tkwant/onebody/kernels.pyx":379
+ *             for i in range(self.nnz):
+ *                 # w''(t) on t0 and t2, central finite difference scheme
+ *                 self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \             # <<<<<<<<<<<<<<
+ *                     + cc1 * (Htm1[i] + self.Ht1[i]) \
+ *                     + cc0 * self.Ht0[i]
+ */
+      __pyx_t_2 = PyFloat_FromDouble(__pyx_v_cc2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 379, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_8 = __Pyx_GetItemInt(__pyx_v_Htm2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 379, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 379, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_6);
+      __pyx_t_4 = PyNumber_Add(__pyx_t_8, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 379, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __pyx_t_6 = PyNumber_Multiply(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 379, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_6);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":380
+ *                 # w''(t) on t0 and t2, central finite difference scheme
+ *                 self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \
+ *                     + cc1 * (Htm1[i] + self.Ht1[i]) \             # <<<<<<<<<<<<<<
+ *                     + cc0 * self.Ht0[i]
+ *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+ */
+      __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cc1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 380, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_Htm1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 380, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_8 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 380, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __pyx_t_5 = PyNumber_Add(__pyx_t_2, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 380, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __pyx_t_8 = PyNumber_Multiply(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 380, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_5 = PyNumber_Add(__pyx_t_6, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 380, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":381
+ *                 self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \
+ *                     + cc1 * (Htm1[i] + self.Ht1[i]) \
+ *                     + cc0 * self.Ht0[i]             # <<<<<<<<<<<<<<
+ *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+ *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+ */
+      __pyx_t_8 = PyFloat_FromDouble(__pyx_v_cc0); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 381, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 381, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_6);
+      __pyx_t_4 = PyNumber_Multiply(__pyx_t_8, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 381, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __pyx_t_6 = PyNumber_Add(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 381, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_6);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":379
+ *             for i in range(self.nnz):
+ *                 # w''(t) on t0 and t2, central finite difference scheme
+ *                 self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \             # <<<<<<<<<<<<<<
+ *                     + cc1 * (Htm1[i] + self.Ht1[i]) \
+ *                     + cc0 * self.Ht0[i]
+ */
+      if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, __pyx_t_6, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 379, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":382
+ *                     + cc1 * (Htm1[i] + self.Ht1[i]) \
+ *                     + cc0 * self.Ht0[i]
+ *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
+ *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+ *                     + cc0 * self.Ht2[i]
+ */
+      __pyx_t_6 = PyFloat_FromDouble(__pyx_v_cc2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 382, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_6);
+      __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 382, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht4, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 382, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_8 = PyNumber_Add(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 382, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_5 = PyNumber_Multiply(__pyx_t_6, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 382, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":383
+ *                     + cc0 * self.Ht0[i]
+ *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+ *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \             # <<<<<<<<<<<<<<
+ *                     + cc0 * self.Ht2[i]
+ *                 # w''(t) on t1, spline formula
+ */
+      __pyx_t_8 = PyFloat_FromDouble(__pyx_v_cc1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 383, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 383, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_6);
+      __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht3, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 383, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_2 = PyNumber_Add(__pyx_t_6, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 383, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_4 = PyNumber_Multiply(__pyx_t_8, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 383, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_2 = PyNumber_Add(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 383, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":384
+ *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+ *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+ *                     + cc0 * self.Ht2[i]             # <<<<<<<<<<<<<<
+ *                 # w''(t) on t1, spline formula
+ *                 self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\
+ */
+      __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cc0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 384, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 384, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_8 = PyNumber_Multiply(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 384, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_5 = PyNumber_Add(__pyx_t_2, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 384, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":382
+ *                     + cc1 * (Htm1[i] + self.Ht1[i]) \
+ *                     + cc0 * self.Ht0[i]
+ *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
+ *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+ *                     + cc0 * self.Ht2[i]
+ */
+      if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, __pyx_t_5, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 382, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":386
+ *                     + cc0 * self.Ht2[i]
+ *                 # w''(t) on t1, spline formula
+ *                 self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\             # <<<<<<<<<<<<<<
+ *                     - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
+ * 
+ */
+      __pyx_t_5 = PyFloat_FromDouble((1.5 * __pyx_v_rdt2)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 386, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_8 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 386, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 386, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_4 = PyNumber_Add(__pyx_t_8, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 386, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 386, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_8 = PyNumber_Multiply(__pyx_int_2, __pyx_t_2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 386, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_2 = PyNumber_Subtract(__pyx_t_4, __pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 386, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __pyx_t_8 = PyNumber_Multiply(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 386, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":387
+ *                 # w''(t) on t1, spline formula
+ *                 self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\
+ *                     - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])             # <<<<<<<<<<<<<<
+ * 
+ *             self.t0, self.t1, self.t2, self.t3, self.t4 = t0_new, t1_new, t2_new, t3_new, t4_new
+ */
+      __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 387, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 387, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_4 = PyNumber_Add(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 387, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_5 = PyNumber_Multiply(__pyx_float_0_25, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 387, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_4 = PyNumber_Subtract(__pyx_t_8, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 387, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":386
+ *                     + cc0 * self.Ht2[i]
+ *                 # w''(t) on t1, spline formula
+ *                 self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\             # <<<<<<<<<<<<<<
+ *                     - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
+ * 
+ */
+      if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht1, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 386, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    }
+
+    /* "tkwant/onebody/kernels.pyx":389
+ *                     - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
+ * 
+ *             self.t0, self.t1, self.t2, self.t3, self.t4 = t0_new, t1_new, t2_new, t3_new, t4_new             # <<<<<<<<<<<<<<
+ * 
+ *         # construct the spline, either on [t0, t1] or on [t1, t2] interval.
+ */
+    __pyx_t_14 = __pyx_v_t0_new;
+    __pyx_t_13 = __pyx_v_t1_new;
+    __pyx_t_12 = __pyx_v_t2_new;
+    __pyx_t_11 = __pyx_v_t3_new;
+    __pyx_t_9 = __pyx_v_t4_new;
+    __pyx_v_self->t0 = __pyx_t_14;
+    __pyx_v_self->t1 = __pyx_t_13;
+    __pyx_v_self->t2 = __pyx_t_12;
+    __pyx_v_self->t3 = __pyx_t_11;
+    __pyx_v_self->t4 = __pyx_t_9;
+
+    /* "tkwant/onebody/kernels.pyx":354
+ *         time_smaller = time < self.t0
+ * 
+ *         if time_larger or time_smaller:             # <<<<<<<<<<<<<<
+ * 
+ *             if time_larger:
+ */
+  }
+
+  /* "tkwant/onebody/kernels.pyx":392
+ * 
+ *         # construct the spline, either on [t0, t1] or on [t1, t2] interval.
+ *         if time < self.t1:             # <<<<<<<<<<<<<<
+ *             a, b, c, d = _get_polynome_coeffs(time, self.t0, self.t1, self.dt)
+ *             for i in range(self.nnz):
+ */
+  __pyx_t_1 = ((__pyx_v_time < __pyx_v_self->t1) != 0);
+  if (__pyx_t_1) {
+
+    /* "tkwant/onebody/kernels.pyx":393
+ *         # construct the spline, either on [t0, t1] or on [t1, t2] interval.
+ *         if time < self.t1:
+ *             a, b, c, d = _get_polynome_coeffs(time, self.t0, self.t1, self.dt)             # <<<<<<<<<<<<<<
+ *             for i in range(self.nnz):
+ *                 out[i] = a * self.Ht0[i] + b * self.Ht1[i] + c * self.d2Ht0[i] + d * self.d2Ht1[i]
+ */
+    __pyx_t_18 = __pyx_f_6tkwant_7onebody_7kernels__get_polynome_coeffs(__pyx_v_time, __pyx_v_self->t0, __pyx_v_self->t1, __pyx_v_self->dt);
+    __pyx_t_9 = __pyx_t_18.f0;
+    __pyx_t_11 = __pyx_t_18.f1;
+    __pyx_t_12 = __pyx_t_18.f2;
+    __pyx_t_13 = __pyx_t_18.f3;
+    __pyx_v_a = __pyx_t_9;
+    __pyx_v_b = __pyx_t_11;
+    __pyx_v_c = __pyx_t_12;
+    __pyx_v_d = __pyx_t_13;
+
+    /* "tkwant/onebody/kernels.pyx":394
+ *         if time < self.t1:
+ *             a, b, c, d = _get_polynome_coeffs(time, self.t0, self.t1, self.dt)
+ *             for i in range(self.nnz):             # <<<<<<<<<<<<<<
+ *                 out[i] = a * self.Ht0[i] + b * self.Ht1[i] + c * self.d2Ht0[i] + d * self.d2Ht1[i]
+ *         else:
+ */
+    __pyx_t_15 = __pyx_v_self->nnz;
+    __pyx_t_16 = __pyx_t_15;
+    for (__pyx_t_17 = 0; __pyx_t_17 < __pyx_t_16; __pyx_t_17+=1) {
+      __pyx_v_i = __pyx_t_17;
+
+      /* "tkwant/onebody/kernels.pyx":395
+ *             a, b, c, d = _get_polynome_coeffs(time, self.t0, self.t1, self.dt)
+ *             for i in range(self.nnz):
+ *                 out[i] = a * self.Ht0[i] + b * self.Ht1[i] + c * self.d2Ht0[i] + d * self.d2Ht1[i]             # <<<<<<<<<<<<<<
+ *         else:
+ *             a, b, c, d = _get_polynome_coeffs(time, self.t1, self.t2, self.dt)
+ */
+      __pyx_t_4 = PyFloat_FromDouble(__pyx_v_a); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_8 = PyNumber_Multiply(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_5 = PyFloat_FromDouble(__pyx_v_b); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_2 = PyNumber_Multiply(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_4 = PyNumber_Add(__pyx_t_8, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_2 = PyFloat_FromDouble(__pyx_v_c); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_8 = __Pyx_GetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __pyx_t_5 = PyNumber_Multiply(__pyx_t_2, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __pyx_t_8 = PyNumber_Add(__pyx_t_4, __pyx_t_5); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_5 = PyFloat_FromDouble(__pyx_v_d); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->d2Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_2 = PyNumber_Multiply(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_4 = PyNumber_Add(__pyx_t_8, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_19 = __Pyx_PyComplex_As___pyx_t_double_complex(__pyx_t_4); if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 395, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_20 = __pyx_v_i;
+      *((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_out.data + __pyx_t_20 * __pyx_v_out.strides[0]) )) = __pyx_t_19;
+    }
+
+    /* "tkwant/onebody/kernels.pyx":392
+ * 
+ *         # construct the spline, either on [t0, t1] or on [t1, t2] interval.
+ *         if time < self.t1:             # <<<<<<<<<<<<<<
+ *             a, b, c, d = _get_polynome_coeffs(time, self.t0, self.t1, self.dt)
+ *             for i in range(self.nnz):
+ */
+    goto __pyx_L10;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":397
+ *                 out[i] = a * self.Ht0[i] + b * self.Ht1[i] + c * self.d2Ht0[i] + d * self.d2Ht1[i]
+ *         else:
+ *             a, b, c, d = _get_polynome_coeffs(time, self.t1, self.t2, self.dt)             # <<<<<<<<<<<<<<
+ *             for i in range(self.nnz):
+ *                 out[i] = a * self.Ht1[i] + b * self.Ht2[i] + c * self.d2Ht1[i] + d * self.d2Ht2[i]
+ */
+  /*else*/ {
+    __pyx_t_18 = __pyx_f_6tkwant_7onebody_7kernels__get_polynome_coeffs(__pyx_v_time, __pyx_v_self->t1, __pyx_v_self->t2, __pyx_v_self->dt);
+    __pyx_t_13 = __pyx_t_18.f0;
+    __pyx_t_12 = __pyx_t_18.f1;
+    __pyx_t_11 = __pyx_t_18.f2;
+    __pyx_t_9 = __pyx_t_18.f3;
+    __pyx_v_a = __pyx_t_13;
+    __pyx_v_b = __pyx_t_12;
+    __pyx_v_c = __pyx_t_11;
+    __pyx_v_d = __pyx_t_9;
+
+    /* "tkwant/onebody/kernels.pyx":398
+ *         else:
+ *             a, b, c, d = _get_polynome_coeffs(time, self.t1, self.t2, self.dt)
+ *             for i in range(self.nnz):             # <<<<<<<<<<<<<<
+ *                 out[i] = a * self.Ht1[i] + b * self.Ht2[i] + c * self.d2Ht1[i] + d * self.d2Ht2[i]
+ * 
+ */
+    __pyx_t_15 = __pyx_v_self->nnz;
+    __pyx_t_16 = __pyx_t_15;
+    for (__pyx_t_17 = 0; __pyx_t_17 < __pyx_t_16; __pyx_t_17+=1) {
+      __pyx_v_i = __pyx_t_17;
+
+      /* "tkwant/onebody/kernels.pyx":399
+ *             a, b, c, d = _get_polynome_coeffs(time, self.t1, self.t2, self.dt)
+ *             for i in range(self.nnz):
+ *                 out[i] = a * self.Ht1[i] + b * self.Ht2[i] + c * self.d2Ht1[i] + d * self.d2Ht2[i]             # <<<<<<<<<<<<<<
+ * 
+ *     def _estimate_error(self, double time):
+ */
+      __pyx_t_4 = PyFloat_FromDouble(__pyx_v_a); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_8 = PyNumber_Multiply(__pyx_t_4, __pyx_t_2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_2 = PyFloat_FromDouble(__pyx_v_b); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_5 = PyNumber_Multiply(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_4 = PyNumber_Add(__pyx_t_8, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_5 = PyFloat_FromDouble(__pyx_v_c); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_8 = __Pyx_GetItemInt(__pyx_v_self->d2Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __pyx_t_2 = PyNumber_Multiply(__pyx_t_5, __pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __pyx_t_8 = PyNumber_Add(__pyx_t_4, __pyx_t_2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_8);
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_2 = PyFloat_FromDouble(__pyx_v_d); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_5 = PyNumber_Multiply(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_4 = PyNumber_Add(__pyx_t_8, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_19 = __Pyx_PyComplex_As___pyx_t_double_complex(__pyx_t_4); if (unlikely(PyErr_Occurred())) __PYX_ERR(0, 399, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_20 = __pyx_v_i;
+      *((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_out.data + __pyx_t_20 * __pyx_v_out.strides[0]) )) = __pyx_t_19;
+    }
+  }
+  __pyx_L10:;
+
+  /* "tkwant/onebody/kernels.pyx":342
+ *     @cython.boundscheck(False)
+ *     @cython.wraparound(False)
+ *     def eval(self, double time, complex[:] out):             # <<<<<<<<<<<<<<
+ * 
+ *         if self.nnz == 0: return
+ */
+
+  /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  goto __pyx_L0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
+  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation.eval", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v_time_larger);
+  __Pyx_XDECREF(__pyx_v_time_smaller);
+  __Pyx_XDECREF(__pyx_v_error);
+  __Pyx_XDECREF(__pyx_v_Htm2);
+  __Pyx_XDECREF(__pyx_v_Htm1);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_out, 1);
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "tkwant/onebody/kernels.pyx":401
+ *                 out[i] = a * self.Ht1[i] + b * self.Ht2[i] + c * self.d2Ht1[i] + d * self.d2Ht2[i]
+ * 
+ *     def _estimate_error(self, double time):             # <<<<<<<<<<<<<<
+ *         fx = self.func(time)
+ *         fapp = np.zeros((self.nnz,), dtype=complex)
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_5_estimate_error(PyObject *__pyx_v_self, PyObject *__pyx_arg_time); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_4_estimate_error[] = "Interpolation._estimate_error(self, double time)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_5_estimate_error(PyObject *__pyx_v_self, PyObject *__pyx_arg_time) {
+  double __pyx_v_time;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("_estimate_error (wrapper)", 0);
+  assert(__pyx_arg_time); {
+    __pyx_v_time = __pyx_PyFloat_AsDouble(__pyx_arg_time); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 401, __pyx_L3_error)
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation._estimate_error", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_4_estimate_error(((struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)__pyx_v_self), ((double)__pyx_v_time));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_4_estimate_error(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, double __pyx_v_time) {
+  PyObject *__pyx_v_fx = NULL;
+  PyObject *__pyx_v_fapp = NULL;
+  PyObject *__pyx_v_scale = NULL;
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  PyObject *__pyx_t_2 = NULL;
+  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_4 = NULL;
+  int __pyx_t_5;
+  PyObject *__pyx_t_6 = NULL;
+  PyObject *__pyx_t_7 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("_estimate_error", 0);
+
+  /* "tkwant/onebody/kernels.pyx":402
+ * 
+ *     def _estimate_error(self, double time):
+ *         fx = self.func(time)             # <<<<<<<<<<<<<<
+ *         fapp = np.zeros((self.nnz,), dtype=complex)
+ *         self.eval(time, fapp)
+ */
+  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 402, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __pyx_t_3 = __pyx_v_self->func; __pyx_t_4 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_4)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_4);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
+    }
+  }
+  __pyx_t_1 = (__pyx_t_4) ? __Pyx_PyObject_Call2Args(__pyx_t_3, __pyx_t_4, __pyx_t_2) : __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 402, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_v_fx = __pyx_t_1;
+  __pyx_t_1 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":403
+ *     def _estimate_error(self, double time):
+ *         fx = self.func(time)
+ *         fapp = np.zeros((self.nnz,), dtype=complex)             # <<<<<<<<<<<<<<
+ *         self.eval(time, fapp)
+ *         scale = self.atol + self.rtol * np.abs(fx)
+ */
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 403, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 403, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 403, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 403, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_GIVEREF(__pyx_t_1);
+  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_1);
+  __pyx_t_1 = 0;
+  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 403, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_2);
+  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_2);
+  __pyx_t_2 = 0;
+  __pyx_t_2 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 403, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 403, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_1, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 403, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_v_fapp = __pyx_t_4;
+  __pyx_t_4 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":404
+ *         fx = self.func(time)
+ *         fapp = np.zeros((self.nnz,), dtype=complex)
+ *         self.eval(time, fapp)             # <<<<<<<<<<<<<<
+ *         scale = self.atol + self.rtol * np.abs(fx)
+ *         return np.max(np.abs(fx - fapp) / scale)
+ */
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_eval); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 404, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 404, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = NULL;
+  __pyx_t_5 = 0;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
+    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
+    if (likely(__pyx_t_3)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
+      __Pyx_INCREF(__pyx_t_3);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_2, function);
+      __pyx_t_5 = 1;
+    }
+  }
+  #if CYTHON_FAST_PYCALL
+  if (PyFunction_Check(__pyx_t_2)) {
+    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_t_1, __pyx_v_fapp};
+    __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_5, 2+__pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 404, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  } else
+  #endif
+  #if CYTHON_FAST_PYCCALL
+  if (__Pyx_PyFastCFunction_Check(__pyx_t_2)) {
+    PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_t_1, __pyx_v_fapp};
+    __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_5, 2+__pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 404, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  } else
+  #endif
+  {
+    __pyx_t_6 = PyTuple_New(2+__pyx_t_5); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 404, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    if (__pyx_t_3) {
+      __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_3); __pyx_t_3 = NULL;
+    }
+    __Pyx_GIVEREF(__pyx_t_1);
+    PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_5, __pyx_t_1);
+    __Pyx_INCREF(__pyx_v_fapp);
+    __Pyx_GIVEREF(__pyx_v_fapp);
+    PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_5, __pyx_v_fapp);
+    __pyx_t_1 = 0;
+    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 404, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  }
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":405
+ *         fapp = np.zeros((self.nnz,), dtype=complex)
+ *         self.eval(time, fapp)
+ *         scale = self.atol + self.rtol * np.abs(fx)             # <<<<<<<<<<<<<<
+ *         return np.max(np.abs(fx - fapp) / scale)
+ * 
+ */
+  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_self->atol); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 405, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_self->rtol); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 405, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 405, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_abs); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 405, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = NULL;
+  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_1)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_1);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
+    }
+  }
+  __pyx_t_6 = (__pyx_t_1) ? __Pyx_PyObject_Call2Args(__pyx_t_3, __pyx_t_1, __pyx_v_fx) : __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_v_fx);
+  __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
+  if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 405, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = PyNumber_Multiply(__pyx_t_2, __pyx_t_6); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 405, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+  __pyx_t_6 = PyNumber_Add(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 405, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_v_scale = __pyx_t_6;
+  __pyx_t_6 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":406
+ *         self.eval(time, fapp)
+ *         scale = self.atol + self.rtol * np.abs(fx)
+ *         return np.max(np.abs(fx - fapp) / scale)             # <<<<<<<<<<<<<<
+ * 
+ *     def _estimate_stepsize(self, double dt, double error):
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 406, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_max); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 406, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 406, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_abs); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 406, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_t_2 = PyNumber_Subtract(__pyx_v_fx, __pyx_v_fapp); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 406, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_7 = NULL;
+  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
+    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_1);
+    if (likely(__pyx_t_7)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+      __Pyx_INCREF(__pyx_t_7);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_1, function);
+    }
+  }
+  __pyx_t_3 = (__pyx_t_7) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_7, __pyx_t_2) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 406, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyNumber_Divide(__pyx_t_3, __pyx_v_scale); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 406, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = NULL;
+  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
+    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
+    if (likely(__pyx_t_3)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+      __Pyx_INCREF(__pyx_t_3);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_4, function);
+    }
+  }
+  __pyx_t_6 = (__pyx_t_3) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_3, __pyx_t_1) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 406, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_r = __pyx_t_6;
+  __pyx_t_6 = 0;
+  goto __pyx_L0;
+
+  /* "tkwant/onebody/kernels.pyx":401
+ *                 out[i] = a * self.Ht1[i] + b * self.Ht2[i] + c * self.d2Ht1[i] + d * self.d2Ht2[i]
+ * 
+ *     def _estimate_error(self, double time):             # <<<<<<<<<<<<<<
+ *         fx = self.func(time)
+ *         fapp = np.zeros((self.nnz,), dtype=complex)
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_6);
+  __Pyx_XDECREF(__pyx_t_7);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation._estimate_error", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v_fx);
+  __Pyx_XDECREF(__pyx_v_fapp);
+  __Pyx_XDECREF(__pyx_v_scale);
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "tkwant/onebody/kernels.pyx":408
+ *         return np.max(np.abs(fx - fapp) / scale)
+ * 
+ *     def _estimate_stepsize(self, double dt, double error):             # <<<<<<<<<<<<<<
+ *         # Eq. (4.13), page 168 in book:
+ *         # E. Hairer, S. Nrsett, and G. Wanner, Solving Ordinary Differential Equations,
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_7_estimate_stepsize(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_6_estimate_stepsize[] = "Interpolation._estimate_stepsize(self, double dt, double error)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_7_estimate_stepsize(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  double __pyx_v_dt;
+  double __pyx_v_error;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("_estimate_stepsize (wrapper)", 0);
+  {
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_dt,&__pyx_n_s_error,0};
+    PyObject* values[2] = {0,0};
+    if (unlikely(__pyx_kwds)) {
+      Py_ssize_t kw_args;
+      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
+      switch (pos_args) {
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = PyDict_Size(__pyx_kwds);
+      switch (pos_args) {
+        case  0:
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_dt)) != 0)) kw_args--;
+        else goto __pyx_L5_argtuple_error;
+        CYTHON_FALLTHROUGH;
+        case  1:
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_error)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("_estimate_stepsize", 1, 2, 2, 1); __PYX_ERR(0, 408, __pyx_L3_error)
+        }
+      }
+      if (unlikely(kw_args > 0)) {
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "_estimate_stepsize") < 0)) __PYX_ERR(0, 408, __pyx_L3_error)
+      }
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
+      goto __pyx_L5_argtuple_error;
+    } else {
+      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+    }
+    __pyx_v_dt = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_dt == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 408, __pyx_L3_error)
+    __pyx_v_error = __pyx_PyFloat_AsDouble(values[1]); if (unlikely((__pyx_v_error == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 408, __pyx_L3_error)
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("_estimate_stepsize", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 408, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation._estimate_stepsize", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_6_estimate_stepsize(((struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)__pyx_v_self), __pyx_v_dt, __pyx_v_error);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_6_estimate_stepsize(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, double __pyx_v_dt, double __pyx_v_error) {
+  double __pyx_v_a;
+  double __pyx_v_dt_new;
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  double __pyx_t_1;
+  double __pyx_t_2;
+  double __pyx_t_3;
+  int __pyx_t_4;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
+  PyObject *__pyx_t_7 = NULL;
+  PyObject *__pyx_t_8 = NULL;
+  PyObject *__pyx_t_9 = NULL;
+  PyObject *__pyx_t_10 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("_estimate_stepsize", 0);
+
+  /* "tkwant/onebody/kernels.pyx":412
+ *         # E. Hairer, S. Nrsett, and G. Wanner, Solving Ordinary Differential Equations,
+ *         # I: Nonstiff Problems, Second  revised edition (Springer, Berlin, Heidelberg, 2008).
+ *         assert dt > 0             # <<<<<<<<<<<<<<
+ *         assert error >= 0
+ *         a = - 1 / 4  # cubic order p = 3
+ */
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    if (unlikely(!((__pyx_v_dt > 0.0) != 0))) {
+      PyErr_SetNone(PyExc_AssertionError);
+      __PYX_ERR(0, 412, __pyx_L1_error)
+    }
+  }
+  #endif
+
+  /* "tkwant/onebody/kernels.pyx":413
+ *         # I: Nonstiff Problems, Second  revised edition (Springer, Berlin, Heidelberg, 2008).
+ *         assert dt > 0
+ *         assert error >= 0             # <<<<<<<<<<<<<<
+ *         a = - 1 / 4  # cubic order p = 3
+ *         dt_new = dt * min(self.facmax, max(self.facmin, self.fac * error**a))
+ */
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    if (unlikely(!((__pyx_v_error >= 0.0) != 0))) {
+      PyErr_SetNone(PyExc_AssertionError);
+      __PYX_ERR(0, 413, __pyx_L1_error)
+    }
+  }
+  #endif
+
+  /* "tkwant/onebody/kernels.pyx":414
+ *         assert dt > 0
+ *         assert error >= 0
+ *         a = - 1 / 4  # cubic order p = 3             # <<<<<<<<<<<<<<
+ *         dt_new = dt * min(self.facmax, max(self.facmin, self.fac * error**a))
+ *         if dt_new < self.dt_min:
+ */
+  __pyx_v_a = (-1.0 / 4.0);
+
+  /* "tkwant/onebody/kernels.pyx":415
+ *         assert error >= 0
+ *         a = - 1 / 4  # cubic order p = 3
+ *         dt_new = dt * min(self.facmax, max(self.facmin, self.fac * error**a))             # <<<<<<<<<<<<<<
+ *         if dt_new < self.dt_min:
+ *             logger.warning('minimal W(t) stepsize dt_min={} reached.'
+ */
+  __pyx_t_1 = (__pyx_v_self->fac * pow(__pyx_v_error, __pyx_v_a));
+  __pyx_t_2 = __pyx_v_self->facmin;
+  if (((__pyx_t_1 > __pyx_t_2) != 0)) {
+    __pyx_t_3 = __pyx_t_1;
+  } else {
+    __pyx_t_3 = __pyx_t_2;
+  }
+  __pyx_t_1 = __pyx_t_3;
+  __pyx_t_3 = __pyx_v_self->facmax;
+  if (((__pyx_t_1 < __pyx_t_3) != 0)) {
+    __pyx_t_2 = __pyx_t_1;
+  } else {
+    __pyx_t_2 = __pyx_t_3;
+  }
+  __pyx_v_dt_new = (__pyx_v_dt * __pyx_t_2);
+
+  /* "tkwant/onebody/kernels.pyx":416
+ *         a = - 1 / 4  # cubic order p = 3
+ *         dt_new = dt * min(self.facmax, max(self.facmin, self.fac * error**a))
+ *         if dt_new < self.dt_min:             # <<<<<<<<<<<<<<
+ *             logger.warning('minimal W(t) stepsize dt_min={} reached.'
+ *                            .format(self.dt_min))
+ */
+  __pyx_t_4 = ((__pyx_v_dt_new < __pyx_v_self->dt_min) != 0);
+  if (__pyx_t_4) {
+
+    /* "tkwant/onebody/kernels.pyx":417
+ *         dt_new = dt * min(self.facmax, max(self.facmin, self.fac * error**a))
+ *         if dt_new < self.dt_min:
+ *             logger.warning('minimal W(t) stepsize dt_min={} reached.'             # <<<<<<<<<<<<<<
+ *                            .format(self.dt_min))
+ *             dt_new = self.dt_min
+ */
+    __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_logger); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 417, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_6, __pyx_n_s_warning); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 417, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":418
+ *         if dt_new < self.dt_min:
+ *             logger.warning('minimal W(t) stepsize dt_min={} reached.'
+ *                            .format(self.dt_min))             # <<<<<<<<<<<<<<
+ *             dt_new = self.dt_min
+ *         return dt_new
+ */
+    __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_kp_u_minimal_W_t_stepsize_dt_min_reac, __pyx_n_s_format); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 418, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __pyx_t_9 = PyFloat_FromDouble(__pyx_v_self->dt_min); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 418, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_9);
+    __pyx_t_10 = NULL;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_8))) {
+      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_8);
+      if (likely(__pyx_t_10)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
+        __Pyx_INCREF(__pyx_t_10);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_8, function);
+      }
+    }
+    __pyx_t_6 = (__pyx_t_10) ? __Pyx_PyObject_Call2Args(__pyx_t_8, __pyx_t_10, __pyx_t_9) : __Pyx_PyObject_CallOneArg(__pyx_t_8, __pyx_t_9);
+    __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 418, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __pyx_t_8 = NULL;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_7))) {
+      __pyx_t_8 = PyMethod_GET_SELF(__pyx_t_7);
+      if (likely(__pyx_t_8)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
+        __Pyx_INCREF(__pyx_t_8);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_7, function);
+      }
+    }
+    __pyx_t_5 = (__pyx_t_8) ? __Pyx_PyObject_Call2Args(__pyx_t_7, __pyx_t_8, __pyx_t_6) : __Pyx_PyObject_CallOneArg(__pyx_t_7, __pyx_t_6);
+    __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 417, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":419
+ *             logger.warning('minimal W(t) stepsize dt_min={} reached.'
+ *                            .format(self.dt_min))
+ *             dt_new = self.dt_min             # <<<<<<<<<<<<<<
+ *         return dt_new
+ * 
+ */
+    __pyx_t_2 = __pyx_v_self->dt_min;
+    __pyx_v_dt_new = __pyx_t_2;
+
+    /* "tkwant/onebody/kernels.pyx":416
+ *         a = - 1 / 4  # cubic order p = 3
+ *         dt_new = dt * min(self.facmax, max(self.facmin, self.fac * error**a))
+ *         if dt_new < self.dt_min:             # <<<<<<<<<<<<<<
+ *             logger.warning('minimal W(t) stepsize dt_min={} reached.'
+ *                            .format(self.dt_min))
+ */
+  }
+
+  /* "tkwant/onebody/kernels.pyx":420
+ *                            .format(self.dt_min))
+ *             dt_new = self.dt_min
+ *         return dt_new             # <<<<<<<<<<<<<<
+ * 
+ * 
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_dt_new); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 420, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_r = __pyx_t_5;
+  __pyx_t_5 = 0;
+  goto __pyx_L0;
+
+  /* "tkwant/onebody/kernels.pyx":408
+ *         return np.max(np.abs(fx - fapp) / scale)
+ * 
+ *     def _estimate_stepsize(self, double dt, double error):             # <<<<<<<<<<<<<<
+ *         # Eq. (4.13), page 168 in book:
+ *         # E. Hairer, S. Nrsett, and G. Wanner, Solving Ordinary Differential Equations,
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
+  __Pyx_XDECREF(__pyx_t_7);
+  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_XDECREF(__pyx_t_9);
+  __Pyx_XDECREF(__pyx_t_10);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation._estimate_stepsize", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":1
+ * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
+ *     cdef tuple state
+ *     cdef object _dict
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_9__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_8__reduce_cython__[] = "Interpolation.__reduce_cython__(self)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_9__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_8__reduce_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)__pyx_v_self));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_8__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self) {
+  PyObject *__pyx_v_state = 0;
+  PyObject *__pyx_v__dict = 0;
+  int __pyx_v_use_setstate;
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  PyObject *__pyx_t_2 = NULL;
+  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
+  PyObject *__pyx_t_7 = NULL;
+  PyObject *__pyx_t_8 = NULL;
+  PyObject *__pyx_t_9 = NULL;
+  PyObject *__pyx_t_10 = NULL;
+  PyObject *__pyx_t_11 = NULL;
+  PyObject *__pyx_t_12 = NULL;
+  PyObject *__pyx_t_13 = NULL;
+  PyObject *__pyx_t_14 = NULL;
+  int __pyx_t_15;
+  int __pyx_t_16;
+  int __pyx_t_17;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__reduce_cython__", 0);
+
+  /* "(tree fragment)":5
+ *     cdef object _dict
+ *     cdef bint use_setstate
+ *     state = (self.Ht0, self.Ht1, self.Ht2, self.Ht3, self.Ht4, self.atol, self.d2Ht0, self.d2Ht1, self.d2Ht2, self.dt, self.dt_min, self.fac, self.facmax, self.facmin, self.func, self.nnz, self.rtol, self.t0, self.t1, self.t2, self.t3, self.t4)             # <<<<<<<<<<<<<<
+ *     _dict = getattr(self, '__dict__', None)
+ *     if _dict is not None:
+ */
+  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_self->atol); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_self->dt); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_3 = PyFloat_FromDouble(__pyx_v_self->dt_min); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_4 = PyFloat_FromDouble(__pyx_v_self->fac); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_self->facmax); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_6 = PyFloat_FromDouble(__pyx_v_self->facmin); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+  __pyx_t_7 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_7);
+  __pyx_t_8 = PyFloat_FromDouble(__pyx_v_self->rtol); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_8);
+  __pyx_t_9 = PyFloat_FromDouble(__pyx_v_self->t0); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_9);
+  __pyx_t_10 = PyFloat_FromDouble(__pyx_v_self->t1); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_10);
+  __pyx_t_11 = PyFloat_FromDouble(__pyx_v_self->t2); if (unlikely(!__pyx_t_11)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_11);
+  __pyx_t_12 = PyFloat_FromDouble(__pyx_v_self->t3); if (unlikely(!__pyx_t_12)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_12);
+  __pyx_t_13 = PyFloat_FromDouble(__pyx_v_self->t4); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_13);
+  __pyx_t_14 = PyTuple_New(22); if (unlikely(!__pyx_t_14)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_14);
+  __Pyx_INCREF(__pyx_v_self->Ht0);
+  __Pyx_GIVEREF(__pyx_v_self->Ht0);
+  PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_v_self->Ht0);
+  __Pyx_INCREF(__pyx_v_self->Ht1);
+  __Pyx_GIVEREF(__pyx_v_self->Ht1);
+  PyTuple_SET_ITEM(__pyx_t_14, 1, __pyx_v_self->Ht1);
+  __Pyx_INCREF(__pyx_v_self->Ht2);
+  __Pyx_GIVEREF(__pyx_v_self->Ht2);
+  PyTuple_SET_ITEM(__pyx_t_14, 2, __pyx_v_self->Ht2);
+  __Pyx_INCREF(__pyx_v_self->Ht3);
+  __Pyx_GIVEREF(__pyx_v_self->Ht3);
+  PyTuple_SET_ITEM(__pyx_t_14, 3, __pyx_v_self->Ht3);
+  __Pyx_INCREF(__pyx_v_self->Ht4);
+  __Pyx_GIVEREF(__pyx_v_self->Ht4);
+  PyTuple_SET_ITEM(__pyx_t_14, 4, __pyx_v_self->Ht4);
+  __Pyx_GIVEREF(__pyx_t_1);
+  PyTuple_SET_ITEM(__pyx_t_14, 5, __pyx_t_1);
+  __Pyx_INCREF(__pyx_v_self->d2Ht0);
+  __Pyx_GIVEREF(__pyx_v_self->d2Ht0);
+  PyTuple_SET_ITEM(__pyx_t_14, 6, __pyx_v_self->d2Ht0);
+  __Pyx_INCREF(__pyx_v_self->d2Ht1);
+  __Pyx_GIVEREF(__pyx_v_self->d2Ht1);
+  PyTuple_SET_ITEM(__pyx_t_14, 7, __pyx_v_self->d2Ht1);
+  __Pyx_INCREF(__pyx_v_self->d2Ht2);
+  __Pyx_GIVEREF(__pyx_v_self->d2Ht2);
+  PyTuple_SET_ITEM(__pyx_t_14, 8, __pyx_v_self->d2Ht2);
+  __Pyx_GIVEREF(__pyx_t_2);
+  PyTuple_SET_ITEM(__pyx_t_14, 9, __pyx_t_2);
+  __Pyx_GIVEREF(__pyx_t_3);
+  PyTuple_SET_ITEM(__pyx_t_14, 10, __pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_4);
+  PyTuple_SET_ITEM(__pyx_t_14, 11, __pyx_t_4);
+  __Pyx_GIVEREF(__pyx_t_5);
+  PyTuple_SET_ITEM(__pyx_t_14, 12, __pyx_t_5);
+  __Pyx_GIVEREF(__pyx_t_6);
+  PyTuple_SET_ITEM(__pyx_t_14, 13, __pyx_t_6);
+  __Pyx_INCREF(__pyx_v_self->func);
+  __Pyx_GIVEREF(__pyx_v_self->func);
+  PyTuple_SET_ITEM(__pyx_t_14, 14, __pyx_v_self->func);
+  __Pyx_GIVEREF(__pyx_t_7);
+  PyTuple_SET_ITEM(__pyx_t_14, 15, __pyx_t_7);
+  __Pyx_GIVEREF(__pyx_t_8);
+  PyTuple_SET_ITEM(__pyx_t_14, 16, __pyx_t_8);
+  __Pyx_GIVEREF(__pyx_t_9);
+  PyTuple_SET_ITEM(__pyx_t_14, 17, __pyx_t_9);
+  __Pyx_GIVEREF(__pyx_t_10);
+  PyTuple_SET_ITEM(__pyx_t_14, 18, __pyx_t_10);
+  __Pyx_GIVEREF(__pyx_t_11);
+  PyTuple_SET_ITEM(__pyx_t_14, 19, __pyx_t_11);
+  __Pyx_GIVEREF(__pyx_t_12);
+  PyTuple_SET_ITEM(__pyx_t_14, 20, __pyx_t_12);
+  __Pyx_GIVEREF(__pyx_t_13);
+  PyTuple_SET_ITEM(__pyx_t_14, 21, __pyx_t_13);
+  __pyx_t_1 = 0;
+  __pyx_t_2 = 0;
+  __pyx_t_3 = 0;
+  __pyx_t_4 = 0;
+  __pyx_t_5 = 0;
+  __pyx_t_6 = 0;
+  __pyx_t_7 = 0;
+  __pyx_t_8 = 0;
+  __pyx_t_9 = 0;
+  __pyx_t_10 = 0;
+  __pyx_t_11 = 0;
+  __pyx_t_12 = 0;
+  __pyx_t_13 = 0;
+  __pyx_v_state = ((PyObject*)__pyx_t_14);
+  __pyx_t_14 = 0;
+
+  /* "(tree fragment)":6
+ *     cdef bint use_setstate
+ *     state = (self.Ht0, self.Ht1, self.Ht2, self.Ht3, self.Ht4, self.atol, self.d2Ht0, self.d2Ht1, self.d2Ht2, self.dt, self.dt_min, self.fac, self.facmax, self.facmin, self.func, self.nnz, self.rtol, self.t0, self.t1, self.t2, self.t3, self.t4)
+ *     _dict = getattr(self, '__dict__', None)             # <<<<<<<<<<<<<<
+ *     if _dict is not None:
+ *         state += (_dict,)
+ */
+  __pyx_t_14 = __Pyx_GetAttr3(((PyObject *)__pyx_v_self), __pyx_n_s_dict, Py_None); if (unlikely(!__pyx_t_14)) __PYX_ERR(1, 6, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_14);
+  __pyx_v__dict = __pyx_t_14;
+  __pyx_t_14 = 0;
+
+  /* "(tree fragment)":7
+ *     state = (self.Ht0, self.Ht1, self.Ht2, self.Ht3, self.Ht4, self.atol, self.d2Ht0, self.d2Ht1, self.d2Ht2, self.dt, self.dt_min, self.fac, self.facmax, self.facmin, self.func, self.nnz, self.rtol, self.t0, self.t1, self.t2, self.t3, self.t4)
+ *     _dict = getattr(self, '__dict__', None)
+ *     if _dict is not None:             # <<<<<<<<<<<<<<
+ *         state += (_dict,)
+ *         use_setstate = True
+ */
+  __pyx_t_15 = (__pyx_v__dict != Py_None);
+  __pyx_t_16 = (__pyx_t_15 != 0);
+  if (__pyx_t_16) {
+
+    /* "(tree fragment)":8
+ *     _dict = getattr(self, '__dict__', None)
+ *     if _dict is not None:
+ *         state += (_dict,)             # <<<<<<<<<<<<<<
+ *         use_setstate = True
+ *     else:
+ */
+    __pyx_t_14 = PyTuple_New(1); if (unlikely(!__pyx_t_14)) __PYX_ERR(1, 8, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    __Pyx_INCREF(__pyx_v__dict);
+    __Pyx_GIVEREF(__pyx_v__dict);
+    PyTuple_SET_ITEM(__pyx_t_14, 0, __pyx_v__dict);
+    __pyx_t_13 = PyNumber_InPlaceAdd(__pyx_v_state, __pyx_t_14); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 8, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_13);
+    __Pyx_DECREF(__pyx_t_14); __pyx_t_14 = 0;
+    __Pyx_DECREF_SET(__pyx_v_state, ((PyObject*)__pyx_t_13));
+    __pyx_t_13 = 0;
+
+    /* "(tree fragment)":9
+ *     if _dict is not None:
+ *         state += (_dict,)
+ *         use_setstate = True             # <<<<<<<<<<<<<<
+ *     else:
+ *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.func is not None
+ */
+    __pyx_v_use_setstate = 1;
+
+    /* "(tree fragment)":7
+ *     state = (self.Ht0, self.Ht1, self.Ht2, self.Ht3, self.Ht4, self.atol, self.d2Ht0, self.d2Ht1, self.d2Ht2, self.dt, self.dt_min, self.fac, self.facmax, self.facmin, self.func, self.nnz, self.rtol, self.t0, self.t1, self.t2, self.t3, self.t4)
+ *     _dict = getattr(self, '__dict__', None)
+ *     if _dict is not None:             # <<<<<<<<<<<<<<
+ *         state += (_dict,)
+ *         use_setstate = True
+ */
+    goto __pyx_L3;
+  }
+
+  /* "(tree fragment)":11
+ *         use_setstate = True
+ *     else:
+ *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.func is not None             # <<<<<<<<<<<<<<
+ *     if use_setstate:
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, None), state
+ */
+  /*else*/ {
+    __pyx_t_15 = (__pyx_v_self->Ht0 != Py_None);
+    __pyx_t_17 = (__pyx_t_15 != 0);
+    if (!__pyx_t_17) {
+    } else {
+      __pyx_t_16 = __pyx_t_17;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_17 = (__pyx_v_self->Ht1 != Py_None);
+    __pyx_t_15 = (__pyx_t_17 != 0);
+    if (!__pyx_t_15) {
+    } else {
+      __pyx_t_16 = __pyx_t_15;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_15 = (__pyx_v_self->Ht2 != Py_None);
+    __pyx_t_17 = (__pyx_t_15 != 0);
+    if (!__pyx_t_17) {
+    } else {
+      __pyx_t_16 = __pyx_t_17;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_17 = (__pyx_v_self->Ht3 != Py_None);
+    __pyx_t_15 = (__pyx_t_17 != 0);
+    if (!__pyx_t_15) {
+    } else {
+      __pyx_t_16 = __pyx_t_15;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_15 = (__pyx_v_self->Ht4 != Py_None);
+    __pyx_t_17 = (__pyx_t_15 != 0);
+    if (!__pyx_t_17) {
+    } else {
+      __pyx_t_16 = __pyx_t_17;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_17 = (__pyx_v_self->d2Ht0 != Py_None);
+    __pyx_t_15 = (__pyx_t_17 != 0);
+    if (!__pyx_t_15) {
+    } else {
+      __pyx_t_16 = __pyx_t_15;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_15 = (__pyx_v_self->d2Ht1 != Py_None);
+    __pyx_t_17 = (__pyx_t_15 != 0);
+    if (!__pyx_t_17) {
+    } else {
+      __pyx_t_16 = __pyx_t_17;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_17 = (__pyx_v_self->d2Ht2 != Py_None);
+    __pyx_t_15 = (__pyx_t_17 != 0);
+    if (!__pyx_t_15) {
+    } else {
+      __pyx_t_16 = __pyx_t_15;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_15 = (__pyx_v_self->func != Py_None);
+    __pyx_t_17 = (__pyx_t_15 != 0);
+    __pyx_t_16 = __pyx_t_17;
+    __pyx_L4_bool_binop_done:;
+    __pyx_v_use_setstate = __pyx_t_16;
+  }
+  __pyx_L3:;
+
+  /* "(tree fragment)":12
+ *     else:
+ *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.func is not None
+ *     if use_setstate:             # <<<<<<<<<<<<<<
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, None), state
+ *     else:
+ */
+  __pyx_t_16 = (__pyx_v_use_setstate != 0);
+  if (__pyx_t_16) {
+
+    /* "(tree fragment)":13
+ *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.func is not None
+ *     if use_setstate:
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, None), state             # <<<<<<<<<<<<<<
+ *     else:
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, state)
+ */
+    __Pyx_XDECREF(__pyx_r);
+    __Pyx_GetModuleGlobalName(__pyx_t_13, __pyx_n_s_pyx_unpickle_Interpolation); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 13, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_13);
+    __pyx_t_14 = PyTuple_New(3); if (unlikely(!__pyx_t_14)) __PYX_ERR(1, 13, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    PyTuple_SET_ITEM(__pyx_t_14, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_INCREF(__pyx_int_172575680);
+    __Pyx_GIVEREF(__pyx_int_172575680);
+    PyTuple_SET_ITEM(__pyx_t_14, 1, __pyx_int_172575680);
+    __Pyx_INCREF(Py_None);
+    __Pyx_GIVEREF(Py_None);
+    PyTuple_SET_ITEM(__pyx_t_14, 2, Py_None);
+    __pyx_t_12 = PyTuple_New(3); if (unlikely(!__pyx_t_12)) __PYX_ERR(1, 13, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_12);
+    __Pyx_GIVEREF(__pyx_t_13);
+    PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_13);
+    __Pyx_GIVEREF(__pyx_t_14);
+    PyTuple_SET_ITEM(__pyx_t_12, 1, __pyx_t_14);
+    __Pyx_INCREF(__pyx_v_state);
+    __Pyx_GIVEREF(__pyx_v_state);
+    PyTuple_SET_ITEM(__pyx_t_12, 2, __pyx_v_state);
+    __pyx_t_13 = 0;
+    __pyx_t_14 = 0;
+    __pyx_r = __pyx_t_12;
+    __pyx_t_12 = 0;
+    goto __pyx_L0;
+
+    /* "(tree fragment)":12
+ *     else:
+ *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.func is not None
+ *     if use_setstate:             # <<<<<<<<<<<<<<
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, None), state
+ *     else:
+ */
+  }
+
+  /* "(tree fragment)":15
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, None), state
+ *     else:
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, state)             # <<<<<<<<<<<<<<
+ * def __setstate_cython__(self, __pyx_state):
+ *     __pyx_unpickle_Interpolation__set_state(self, __pyx_state)
+ */
+  /*else*/ {
+    __Pyx_XDECREF(__pyx_r);
+    __Pyx_GetModuleGlobalName(__pyx_t_12, __pyx_n_s_pyx_unpickle_Interpolation); if (unlikely(!__pyx_t_12)) __PYX_ERR(1, 15, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_12);
+    __pyx_t_14 = PyTuple_New(3); if (unlikely(!__pyx_t_14)) __PYX_ERR(1, 15, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_14);
+    __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    PyTuple_SET_ITEM(__pyx_t_14, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_INCREF(__pyx_int_172575680);
+    __Pyx_GIVEREF(__pyx_int_172575680);
+    PyTuple_SET_ITEM(__pyx_t_14, 1, __pyx_int_172575680);
+    __Pyx_INCREF(__pyx_v_state);
+    __Pyx_GIVEREF(__pyx_v_state);
+    PyTuple_SET_ITEM(__pyx_t_14, 2, __pyx_v_state);
+    __pyx_t_13 = PyTuple_New(2); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 15, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_13);
+    __Pyx_GIVEREF(__pyx_t_12);
+    PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_t_12);
+    __Pyx_GIVEREF(__pyx_t_14);
+    PyTuple_SET_ITEM(__pyx_t_13, 1, __pyx_t_14);
+    __pyx_t_12 = 0;
+    __pyx_t_14 = 0;
+    __pyx_r = __pyx_t_13;
+    __pyx_t_13 = 0;
+    goto __pyx_L0;
+  }
+
+  /* "(tree fragment)":1
+ * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
+ *     cdef tuple state
+ *     cdef object _dict
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
+  __Pyx_XDECREF(__pyx_t_7);
+  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_XDECREF(__pyx_t_9);
+  __Pyx_XDECREF(__pyx_t_10);
+  __Pyx_XDECREF(__pyx_t_11);
+  __Pyx_XDECREF(__pyx_t_12);
+  __Pyx_XDECREF(__pyx_t_13);
+  __Pyx_XDECREF(__pyx_t_14);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v_state);
+  __Pyx_XDECREF(__pyx_v__dict);
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":16
+ *     else:
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, state)
+ * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
+ *     __pyx_unpickle_Interpolation__set_state(self, __pyx_state)
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_11__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_10__setstate_cython__[] = "Interpolation.__setstate_cython__(self, __pyx_state)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_11__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_10__setstate_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)__pyx_v_self), ((PyObject *)__pyx_v___pyx_state));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_13Interpolation_10__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__setstate_cython__", 0);
+
+  /* "(tree fragment)":17
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, state)
+ * def __setstate_cython__(self, __pyx_state):
+ *     __pyx_unpickle_Interpolation__set_state(self, __pyx_state)             # <<<<<<<<<<<<<<
+ */
+  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
+  __pyx_t_1 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_Interpolation__set_state(__pyx_v_self, ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+
+  /* "(tree fragment)":16
+ *     else:
+ *         return __pyx_unpickle_Interpolation, (type(self), 0xa494bc0, state)
+ * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
+ *     __pyx_unpickle_Interpolation__set_state(self, __pyx_state)
+ */
+
+  /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  goto __pyx_L0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Interpolation.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "tkwant/onebody/kernels.pyx":462
  *         object td_hamiltonian
  * 
  *     def __init__(self, syst, time_name, time_start, params=None):             # <<<<<<<<<<<<<<
  *         self.tparams = system.add_time_to_params(params, time_name, time_start)
  *         self.time_name = time_name
  */
 
 /* Python wrapper */
 static int __pyx_pw_6tkwant_7onebody_7kernels_21PerturbationExtractor_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static int __pyx_pw_6tkwant_7onebody_7kernels_21PerturbationExtractor_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_syst = 0;
   PyObject *__pyx_v_time_name = 0;
   PyObject *__pyx_v_time_start = 0;
   PyObject *__pyx_v_params = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_syst,&__pyx_n_s_time_name,&__pyx_n_s_time_start,&__pyx_n_s_params,0};
     PyObject* values[4] = {0,0,0,0};
     values[3] = ((PyObject *)Py_None);
@@ -6287,31 +9498,31 @@
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_syst)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time_name)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, 1); __PYX_ERR(0, 297, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, 1); __PYX_ERR(0, 462, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
         if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time_start)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, 2); __PYX_ERR(0, 297, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, 2); __PYX_ERR(0, 462, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_params);
           if (value) { values[3] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 297, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 462, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
         case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
         values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
@@ -6323,15 +9534,15 @@
     __pyx_v_syst = values[0];
     __pyx_v_time_name = values[1];
     __pyx_v_time_start = values[2];
     __pyx_v_params = values[3];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 297, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 462, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationExtractor.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *)__pyx_v_self), __pyx_v_syst, __pyx_v_time_name, __pyx_v_time_start, __pyx_v_params);
 
@@ -6369,26 +9580,29 @@
   Py_ssize_t __pyx_t_6;
   PyObject *(*__pyx_t_7)(PyObject *);
   PyObject *__pyx_t_8 = NULL;
   PyObject *__pyx_t_9 = NULL;
   PyObject *(*__pyx_t_10)(PyObject *);
   int __pyx_t_11;
   int __pyx_t_12;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":298
+  /* "tkwant/onebody/kernels.pyx":463
  * 
  *     def __init__(self, syst, time_name, time_start, params=None):
  *         self.tparams = system.add_time_to_params(params, time_name, time_start)             # <<<<<<<<<<<<<<
  *         self.time_name = time_name
  *         self.H = H = syst.hamiltonian
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_system); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 298, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_system); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 463, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_add_time_to_params); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 298, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_add_time_to_params); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 463, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __pyx_t_2 = NULL;
   __pyx_t_4 = 0;
   if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
     __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
     if (likely(__pyx_t_2)) {
@@ -6398,231 +9612,231 @@
       __Pyx_DECREF_SET(__pyx_t_3, function);
       __pyx_t_4 = 1;
     }
   }
   #if CYTHON_FAST_PYCALL
   if (PyFunction_Check(__pyx_t_3)) {
     PyObject *__pyx_temp[4] = {__pyx_t_2, __pyx_v_params, __pyx_v_time_name, __pyx_v_time_start};
-    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_4, 3+__pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 298, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_4, 3+__pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 463, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_GOTREF(__pyx_t_1);
   } else
   #endif
   #if CYTHON_FAST_PYCCALL
   if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
     PyObject *__pyx_temp[4] = {__pyx_t_2, __pyx_v_params, __pyx_v_time_name, __pyx_v_time_start};
-    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_4, 3+__pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 298, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_4, 3+__pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 463, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_GOTREF(__pyx_t_1);
   } else
   #endif
   {
-    __pyx_t_5 = PyTuple_New(3+__pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 298, __pyx_L1_error)
+    __pyx_t_5 = PyTuple_New(3+__pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 463, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     if (__pyx_t_2) {
       __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
     }
     __Pyx_INCREF(__pyx_v_params);
     __Pyx_GIVEREF(__pyx_v_params);
     PyTuple_SET_ITEM(__pyx_t_5, 0+__pyx_t_4, __pyx_v_params);
     __Pyx_INCREF(__pyx_v_time_name);
     __Pyx_GIVEREF(__pyx_v_time_name);
     PyTuple_SET_ITEM(__pyx_t_5, 1+__pyx_t_4, __pyx_v_time_name);
     __Pyx_INCREF(__pyx_v_time_start);
     __Pyx_GIVEREF(__pyx_v_time_start);
     PyTuple_SET_ITEM(__pyx_t_5, 2+__pyx_t_4, __pyx_v_time_start);
-    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 298, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 463, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
   }
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_GIVEREF(__pyx_t_1);
   __Pyx_GOTREF(__pyx_v_self->tparams);
   __Pyx_DECREF(__pyx_v_self->tparams);
   __pyx_v_self->tparams = __pyx_t_1;
   __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":299
+  /* "tkwant/onebody/kernels.pyx":464
  *     def __init__(self, syst, time_name, time_start, params=None):
  *         self.tparams = system.add_time_to_params(params, time_name, time_start)
  *         self.time_name = time_name             # <<<<<<<<<<<<<<
  *         self.H = H = syst.hamiltonian
  * 
  */
   __Pyx_INCREF(__pyx_v_time_name);
   __Pyx_GIVEREF(__pyx_v_time_name);
   __Pyx_GOTREF(__pyx_v_self->time_name);
   __Pyx_DECREF(__pyx_v_self->time_name);
   __pyx_v_self->time_name = __pyx_v_time_name;
 
-  /* "tkwant/onebody/kernels.pyx":300
+  /* "tkwant/onebody/kernels.pyx":465
  *         self.tparams = system.add_time_to_params(params, time_name, time_start)
  *         self.time_name = time_name
  *         self.H = H = syst.hamiltonian             # <<<<<<<<<<<<<<
  * 
  *         # Number of (potentially) non-zero entries in the time-dependent
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_hamiltonian); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 300, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_hamiltonian); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 465, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_INCREF(__pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_1);
   __Pyx_GOTREF(__pyx_v_self->H);
   __Pyx_DECREF(__pyx_v_self->H);
   __pyx_v_self->H = __pyx_t_1;
   __Pyx_INCREF(__pyx_t_1);
   __pyx_v_H = __pyx_t_1;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":304
+  /* "tkwant/onebody/kernels.pyx":469
  *         # Number of (potentially) non-zero entries in the time-dependent
  *         # Hamiltonian matrix.
  *         nnz = 0             # <<<<<<<<<<<<<<
  * 
  *         # Process onsites.
  */
   __Pyx_INCREF(__pyx_int_0);
   __pyx_v_nnz = __pyx_int_0;
 
-  /* "tkwant/onebody/kernels.pyx":307
+  /* "tkwant/onebody/kernels.pyx":472
  * 
  *         # Process onsites.
  *         self.td_hamiltonian = td_hamiltonian = []             # <<<<<<<<<<<<<<
  *         for i, (onsite, _) in enumerate(syst.onsites):
  *             if system.is_time_dependent_function(onsite, time_name):
  */
-  __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 307, __pyx_L1_error)
+  __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 472, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_INCREF(__pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_1);
   __Pyx_GOTREF(__pyx_v_self->td_hamiltonian);
   __Pyx_DECREF(__pyx_v_self->td_hamiltonian);
   __pyx_v_self->td_hamiltonian = __pyx_t_1;
   __Pyx_INCREF(__pyx_t_1);
   __pyx_v_td_hamiltonian = __pyx_t_1;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":308
+  /* "tkwant/onebody/kernels.pyx":473
  *         # Process onsites.
  *         self.td_hamiltonian = td_hamiltonian = []
  *         for i, (onsite, _) in enumerate(syst.onsites):             # <<<<<<<<<<<<<<
  *             if system.is_time_dependent_function(onsite, time_name):
  *                 a, b = rng = system.orb_range(syst, i)
  */
   __Pyx_INCREF(__pyx_int_0);
   __pyx_t_1 = __pyx_int_0;
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_onsites); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 308, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_onsites); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 473, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   if (likely(PyList_CheckExact(__pyx_t_3)) || PyTuple_CheckExact(__pyx_t_3)) {
     __pyx_t_5 = __pyx_t_3; __Pyx_INCREF(__pyx_t_5); __pyx_t_6 = 0;
     __pyx_t_7 = NULL;
   } else {
-    __pyx_t_6 = -1; __pyx_t_5 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 308, __pyx_L1_error)
+    __pyx_t_6 = -1; __pyx_t_5 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 473, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_7 = Py_TYPE(__pyx_t_5)->tp_iternext; if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 308, __pyx_L1_error)
+    __pyx_t_7 = Py_TYPE(__pyx_t_5)->tp_iternext; if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 473, __pyx_L1_error)
   }
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   for (;;) {
     if (likely(!__pyx_t_7)) {
       if (likely(PyList_CheckExact(__pyx_t_5))) {
         if (__pyx_t_6 >= PyList_GET_SIZE(__pyx_t_5)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_3 = PyList_GET_ITEM(__pyx_t_5, __pyx_t_6); __Pyx_INCREF(__pyx_t_3); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 308, __pyx_L1_error)
+        __pyx_t_3 = PyList_GET_ITEM(__pyx_t_5, __pyx_t_6); __Pyx_INCREF(__pyx_t_3); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 473, __pyx_L1_error)
         #else
-        __pyx_t_3 = PySequence_ITEM(__pyx_t_5, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 308, __pyx_L1_error)
+        __pyx_t_3 = PySequence_ITEM(__pyx_t_5, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 473, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
         #endif
       } else {
         if (__pyx_t_6 >= PyTuple_GET_SIZE(__pyx_t_5)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_3 = PyTuple_GET_ITEM(__pyx_t_5, __pyx_t_6); __Pyx_INCREF(__pyx_t_3); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 308, __pyx_L1_error)
+        __pyx_t_3 = PyTuple_GET_ITEM(__pyx_t_5, __pyx_t_6); __Pyx_INCREF(__pyx_t_3); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 473, __pyx_L1_error)
         #else
-        __pyx_t_3 = PySequence_ITEM(__pyx_t_5, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 308, __pyx_L1_error)
+        __pyx_t_3 = PySequence_ITEM(__pyx_t_5, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 473, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
         #endif
       }
     } else {
       __pyx_t_3 = __pyx_t_7(__pyx_t_5);
       if (unlikely(!__pyx_t_3)) {
         PyObject* exc_type = PyErr_Occurred();
         if (exc_type) {
           if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-          else __PYX_ERR(0, 308, __pyx_L1_error)
+          else __PYX_ERR(0, 473, __pyx_L1_error)
         }
         break;
       }
       __Pyx_GOTREF(__pyx_t_3);
     }
     if ((likely(PyTuple_CheckExact(__pyx_t_3))) || (PyList_CheckExact(__pyx_t_3))) {
       PyObject* sequence = __pyx_t_3;
       Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
       if (unlikely(size != 2)) {
         if (size > 2) __Pyx_RaiseTooManyValuesError(2);
         else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-        __PYX_ERR(0, 308, __pyx_L1_error)
+        __PYX_ERR(0, 473, __pyx_L1_error)
       }
       #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
       if (likely(PyTuple_CheckExact(sequence))) {
         __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
         __pyx_t_8 = PyTuple_GET_ITEM(sequence, 1); 
       } else {
         __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
         __pyx_t_8 = PyList_GET_ITEM(sequence, 1); 
       }
       __Pyx_INCREF(__pyx_t_2);
       __Pyx_INCREF(__pyx_t_8);
       #else
-      __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 308, __pyx_L1_error)
+      __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 473, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 308, __pyx_L1_error)
+      __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 473, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       #endif
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     } else {
       Py_ssize_t index = -1;
-      __pyx_t_9 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 308, __pyx_L1_error)
+      __pyx_t_9 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 473, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
       __pyx_t_10 = Py_TYPE(__pyx_t_9)->tp_iternext;
       index = 0; __pyx_t_2 = __pyx_t_10(__pyx_t_9); if (unlikely(!__pyx_t_2)) goto __pyx_L5_unpacking_failed;
       __Pyx_GOTREF(__pyx_t_2);
       index = 1; __pyx_t_8 = __pyx_t_10(__pyx_t_9); if (unlikely(!__pyx_t_8)) goto __pyx_L5_unpacking_failed;
       __Pyx_GOTREF(__pyx_t_8);
-      if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_9), 2) < 0) __PYX_ERR(0, 308, __pyx_L1_error)
+      if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_9), 2) < 0) __PYX_ERR(0, 473, __pyx_L1_error)
       __pyx_t_10 = NULL;
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       goto __pyx_L6_unpacking_done;
       __pyx_L5_unpacking_failed:;
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       __pyx_t_10 = NULL;
       if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-      __PYX_ERR(0, 308, __pyx_L1_error)
+      __PYX_ERR(0, 473, __pyx_L1_error)
       __pyx_L6_unpacking_done:;
     }
     __Pyx_XDECREF_SET(__pyx_v_onsite, __pyx_t_2);
     __pyx_t_2 = 0;
     __Pyx_XDECREF_SET(__pyx_v__, __pyx_t_8);
     __pyx_t_8 = 0;
     __Pyx_INCREF(__pyx_t_1);
     __Pyx_XDECREF_SET(__pyx_v_i, __pyx_t_1);
-    __pyx_t_3 = __Pyx_PyInt_AddObjC(__pyx_t_1, __pyx_int_1, 1, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 308, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyInt_AddObjC(__pyx_t_1, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 473, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_1);
     __pyx_t_1 = __pyx_t_3;
     __pyx_t_3 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":309
+    /* "tkwant/onebody/kernels.pyx":474
  *         self.td_hamiltonian = td_hamiltonian = []
  *         for i, (onsite, _) in enumerate(syst.onsites):
  *             if system.is_time_dependent_function(onsite, time_name):             # <<<<<<<<<<<<<<
  *                 a, b = rng = system.orb_range(syst, i)
  *                 norbs = b - a
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_8, __pyx_n_s_system); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 309, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_8, __pyx_n_s_system); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 474, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
-    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_is_time_dependent_function); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 309, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_is_time_dependent_function); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 474, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     __pyx_t_8 = NULL;
     __pyx_t_4 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
       __pyx_t_8 = PyMethod_GET_SELF(__pyx_t_2);
       if (likely(__pyx_t_8)) {
@@ -6632,58 +9846,58 @@
         __Pyx_DECREF_SET(__pyx_t_2, function);
         __pyx_t_4 = 1;
       }
     }
     #if CYTHON_FAST_PYCALL
     if (PyFunction_Check(__pyx_t_2)) {
       PyObject *__pyx_temp[3] = {__pyx_t_8, __pyx_v_onsite, __pyx_v_time_name};
-      __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 309, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 474, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
       __Pyx_GOTREF(__pyx_t_3);
     } else
     #endif
     #if CYTHON_FAST_PYCCALL
     if (__Pyx_PyFastCFunction_Check(__pyx_t_2)) {
       PyObject *__pyx_temp[3] = {__pyx_t_8, __pyx_v_onsite, __pyx_v_time_name};
-      __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 309, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 474, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
       __Pyx_GOTREF(__pyx_t_3);
     } else
     #endif
     {
-      __pyx_t_9 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 309, __pyx_L1_error)
+      __pyx_t_9 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 474, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
       if (__pyx_t_8) {
         __Pyx_GIVEREF(__pyx_t_8); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_8); __pyx_t_8 = NULL;
       }
       __Pyx_INCREF(__pyx_v_onsite);
       __Pyx_GIVEREF(__pyx_v_onsite);
       PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_4, __pyx_v_onsite);
       __Pyx_INCREF(__pyx_v_time_name);
       __Pyx_GIVEREF(__pyx_v_time_name);
       PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_4, __pyx_v_time_name);
-      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_9, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 309, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_9, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 474, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
     }
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_11 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 309, __pyx_L1_error)
+    __pyx_t_11 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 474, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     if (__pyx_t_11) {
 
-      /* "tkwant/onebody/kernels.pyx":310
+      /* "tkwant/onebody/kernels.pyx":475
  *         for i, (onsite, _) in enumerate(syst.onsites):
  *             if system.is_time_dependent_function(onsite, time_name):
  *                 a, b = rng = system.orb_range(syst, i)             # <<<<<<<<<<<<<<
  *                 norbs = b - a
  *                 nnz += norbs * norbs
  */
-      __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_system); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 310, __pyx_L1_error)
+      __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_system); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 475, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_orb_range); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 310, __pyx_L1_error)
+      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_orb_range); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 475, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       __pyx_t_2 = NULL;
       __pyx_t_4 = 0;
       if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_9))) {
         __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_9);
         if (likely(__pyx_t_2)) {
@@ -6693,146 +9907,146 @@
           __Pyx_DECREF_SET(__pyx_t_9, function);
           __pyx_t_4 = 1;
         }
       }
       #if CYTHON_FAST_PYCALL
       if (PyFunction_Check(__pyx_t_9)) {
         PyObject *__pyx_temp[3] = {__pyx_t_2, __pyx_v_syst, __pyx_v_i};
-        __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 310, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 475, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
         __Pyx_GOTREF(__pyx_t_3);
       } else
       #endif
       #if CYTHON_FAST_PYCCALL
       if (__Pyx_PyFastCFunction_Check(__pyx_t_9)) {
         PyObject *__pyx_temp[3] = {__pyx_t_2, __pyx_v_syst, __pyx_v_i};
-        __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 310, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 475, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
         __Pyx_GOTREF(__pyx_t_3);
       } else
       #endif
       {
-        __pyx_t_8 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 310, __pyx_L1_error)
+        __pyx_t_8 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 475, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
         if (__pyx_t_2) {
           __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_2); __pyx_t_2 = NULL;
         }
         __Pyx_INCREF(__pyx_v_syst);
         __Pyx_GIVEREF(__pyx_v_syst);
         PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_4, __pyx_v_syst);
         __Pyx_INCREF(__pyx_v_i);
         __Pyx_GIVEREF(__pyx_v_i);
         PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_4, __pyx_v_i);
-        __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_t_8, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 310, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_t_8, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 475, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
         __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       }
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       if ((likely(PyTuple_CheckExact(__pyx_t_3))) || (PyList_CheckExact(__pyx_t_3))) {
         PyObject* sequence = __pyx_t_3;
         Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
         if (unlikely(size != 2)) {
           if (size > 2) __Pyx_RaiseTooManyValuesError(2);
           else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-          __PYX_ERR(0, 310, __pyx_L1_error)
+          __PYX_ERR(0, 475, __pyx_L1_error)
         }
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
         if (likely(PyTuple_CheckExact(sequence))) {
           __pyx_t_9 = PyTuple_GET_ITEM(sequence, 0); 
           __pyx_t_8 = PyTuple_GET_ITEM(sequence, 1); 
         } else {
           __pyx_t_9 = PyList_GET_ITEM(sequence, 0); 
           __pyx_t_8 = PyList_GET_ITEM(sequence, 1); 
         }
         __Pyx_INCREF(__pyx_t_9);
         __Pyx_INCREF(__pyx_t_8);
         #else
-        __pyx_t_9 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 310, __pyx_L1_error)
+        __pyx_t_9 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 475, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 310, __pyx_L1_error)
+        __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 475, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
         #endif
       } else {
         Py_ssize_t index = -1;
-        __pyx_t_2 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 310, __pyx_L1_error)
+        __pyx_t_2 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 475, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
         __pyx_t_10 = Py_TYPE(__pyx_t_2)->tp_iternext;
         index = 0; __pyx_t_9 = __pyx_t_10(__pyx_t_2); if (unlikely(!__pyx_t_9)) goto __pyx_L8_unpacking_failed;
         __Pyx_GOTREF(__pyx_t_9);
         index = 1; __pyx_t_8 = __pyx_t_10(__pyx_t_2); if (unlikely(!__pyx_t_8)) goto __pyx_L8_unpacking_failed;
         __Pyx_GOTREF(__pyx_t_8);
-        if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_2), 2) < 0) __PYX_ERR(0, 310, __pyx_L1_error)
+        if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_2), 2) < 0) __PYX_ERR(0, 475, __pyx_L1_error)
         __pyx_t_10 = NULL;
         __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
         goto __pyx_L9_unpacking_done;
         __pyx_L8_unpacking_failed:;
         __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
         __pyx_t_10 = NULL;
         if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-        __PYX_ERR(0, 310, __pyx_L1_error)
+        __PYX_ERR(0, 475, __pyx_L1_error)
         __pyx_L9_unpacking_done:;
       }
       __Pyx_XDECREF_SET(__pyx_v_a, __pyx_t_9);
       __pyx_t_9 = 0;
       __Pyx_XDECREF_SET(__pyx_v_b, __pyx_t_8);
       __pyx_t_8 = 0;
       __Pyx_INCREF(__pyx_t_3);
       __Pyx_XDECREF_SET(__pyx_v_rng, __pyx_t_3);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":311
+      /* "tkwant/onebody/kernels.pyx":476
  *             if system.is_time_dependent_function(onsite, time_name):
  *                 a, b = rng = system.orb_range(syst, i)
  *                 norbs = b - a             # <<<<<<<<<<<<<<
  *                 nnz += norbs * norbs
  *                 td_hamiltonian.append(
  */
-      __pyx_t_3 = PyNumber_Subtract(__pyx_v_b, __pyx_v_a); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 311, __pyx_L1_error)
+      __pyx_t_3 = PyNumber_Subtract(__pyx_v_b, __pyx_v_a); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 476, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_XDECREF_SET(__pyx_v_norbs, __pyx_t_3);
       __pyx_t_3 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":312
+      /* "tkwant/onebody/kernels.pyx":477
  *                 a, b = rng = system.orb_range(syst, i)
  *                 norbs = b - a
  *                 nnz += norbs * norbs             # <<<<<<<<<<<<<<
  *                 td_hamiltonian.append(
  *                     ((i, i, rng, rng, H(i, i, params=self.tparams))))
  */
-      __pyx_t_3 = PyNumber_Multiply(__pyx_v_norbs, __pyx_v_norbs); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 312, __pyx_L1_error)
+      __pyx_t_3 = PyNumber_Multiply(__pyx_v_norbs, __pyx_v_norbs); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 477, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_8 = PyNumber_InPlaceAdd(__pyx_v_nnz, __pyx_t_3); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 312, __pyx_L1_error)
+      __pyx_t_8 = PyNumber_InPlaceAdd(__pyx_v_nnz, __pyx_t_3); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 477, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
       __Pyx_DECREF_SET(__pyx_v_nnz, __pyx_t_8);
       __pyx_t_8 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":314
+      /* "tkwant/onebody/kernels.pyx":479
  *                 nnz += norbs * norbs
  *                 td_hamiltonian.append(
  *                     ((i, i, rng, rng, H(i, i, params=self.tparams))))             # <<<<<<<<<<<<<<
  * 
  *         # Process hoppings.
  */
-      __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 314, __pyx_L1_error)
+      __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 479, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_INCREF(__pyx_v_i);
       __Pyx_GIVEREF(__pyx_v_i);
       PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_v_i);
       __Pyx_INCREF(__pyx_v_i);
       __Pyx_GIVEREF(__pyx_v_i);
       PyTuple_SET_ITEM(__pyx_t_8, 1, __pyx_v_i);
-      __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 314, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 479, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_params, __pyx_v_self->tparams) < 0) __PYX_ERR(0, 314, __pyx_L1_error)
-      __pyx_t_9 = __Pyx_PyObject_Call(__pyx_v_H, __pyx_t_8, __pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 314, __pyx_L1_error)
+      if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_params, __pyx_v_self->tparams) < 0) __PYX_ERR(0, 479, __pyx_L1_error)
+      __pyx_t_9 = __Pyx_PyObject_Call(__pyx_v_H, __pyx_t_8, __pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 479, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = PyTuple_New(5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 314, __pyx_L1_error)
+      __pyx_t_3 = PyTuple_New(5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 479, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_INCREF(__pyx_v_i);
       __Pyx_GIVEREF(__pyx_v_i);
       PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_v_i);
       __Pyx_INCREF(__pyx_v_i);
       __Pyx_GIVEREF(__pyx_v_i);
       PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_v_i);
@@ -6842,226 +10056,226 @@
       __Pyx_INCREF(__pyx_v_rng);
       __Pyx_GIVEREF(__pyx_v_rng);
       PyTuple_SET_ITEM(__pyx_t_3, 3, __pyx_v_rng);
       __Pyx_GIVEREF(__pyx_t_9);
       PyTuple_SET_ITEM(__pyx_t_3, 4, __pyx_t_9);
       __pyx_t_9 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":313
+      /* "tkwant/onebody/kernels.pyx":478
  *                 norbs = b - a
  *                 nnz += norbs * norbs
  *                 td_hamiltonian.append(             # <<<<<<<<<<<<<<
  *                     ((i, i, rng, rng, H(i, i, params=self.tparams))))
  * 
  */
-      __pyx_t_12 = __Pyx_PyList_Append(__pyx_v_td_hamiltonian, __pyx_t_3); if (unlikely(__pyx_t_12 == ((int)-1))) __PYX_ERR(0, 313, __pyx_L1_error)
+      __pyx_t_12 = __Pyx_PyList_Append(__pyx_v_td_hamiltonian, __pyx_t_3); if (unlikely(__pyx_t_12 == ((int)-1))) __PYX_ERR(0, 478, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":309
+      /* "tkwant/onebody/kernels.pyx":474
  *         self.td_hamiltonian = td_hamiltonian = []
  *         for i, (onsite, _) in enumerate(syst.onsites):
  *             if system.is_time_dependent_function(onsite, time_name):             # <<<<<<<<<<<<<<
  *                 a, b = rng = system.orb_range(syst, i)
  *                 norbs = b - a
  */
     }
 
-    /* "tkwant/onebody/kernels.pyx":308
+    /* "tkwant/onebody/kernels.pyx":473
  *         # Process onsites.
  *         self.td_hamiltonian = td_hamiltonian = []
  *         for i, (onsite, _) in enumerate(syst.onsites):             # <<<<<<<<<<<<<<
  *             if system.is_time_dependent_function(onsite, time_name):
  *                 a, b = rng = system.orb_range(syst, i)
  */
   }
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":317
+  /* "tkwant/onebody/kernels.pyx":482
  * 
  *         # Process hoppings.
  *         for edge_id, (i, j) in enumerate(syst.graph):             # <<<<<<<<<<<<<<
  *             hop_val, _ = syst.hoppings[edge_id]
  *             if system.is_time_dependent_function(hop_val, time_name):
  */
   __Pyx_INCREF(__pyx_int_0);
   __pyx_t_1 = __pyx_int_0;
-  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_graph); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 317, __pyx_L1_error)
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_graph); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 482, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
   if (likely(PyList_CheckExact(__pyx_t_5)) || PyTuple_CheckExact(__pyx_t_5)) {
     __pyx_t_3 = __pyx_t_5; __Pyx_INCREF(__pyx_t_3); __pyx_t_6 = 0;
     __pyx_t_7 = NULL;
   } else {
-    __pyx_t_6 = -1; __pyx_t_3 = PyObject_GetIter(__pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 317, __pyx_L1_error)
+    __pyx_t_6 = -1; __pyx_t_3 = PyObject_GetIter(__pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 482, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_7 = Py_TYPE(__pyx_t_3)->tp_iternext; if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 317, __pyx_L1_error)
+    __pyx_t_7 = Py_TYPE(__pyx_t_3)->tp_iternext; if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 482, __pyx_L1_error)
   }
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
   for (;;) {
     if (likely(!__pyx_t_7)) {
       if (likely(PyList_CheckExact(__pyx_t_3))) {
         if (__pyx_t_6 >= PyList_GET_SIZE(__pyx_t_3)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_5 = PyList_GET_ITEM(__pyx_t_3, __pyx_t_6); __Pyx_INCREF(__pyx_t_5); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 317, __pyx_L1_error)
+        __pyx_t_5 = PyList_GET_ITEM(__pyx_t_3, __pyx_t_6); __Pyx_INCREF(__pyx_t_5); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 482, __pyx_L1_error)
         #else
-        __pyx_t_5 = PySequence_ITEM(__pyx_t_3, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 317, __pyx_L1_error)
+        __pyx_t_5 = PySequence_ITEM(__pyx_t_3, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 482, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         #endif
       } else {
         if (__pyx_t_6 >= PyTuple_GET_SIZE(__pyx_t_3)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_3, __pyx_t_6); __Pyx_INCREF(__pyx_t_5); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 317, __pyx_L1_error)
+        __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_3, __pyx_t_6); __Pyx_INCREF(__pyx_t_5); __pyx_t_6++; if (unlikely(0 < 0)) __PYX_ERR(0, 482, __pyx_L1_error)
         #else
-        __pyx_t_5 = PySequence_ITEM(__pyx_t_3, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 317, __pyx_L1_error)
+        __pyx_t_5 = PySequence_ITEM(__pyx_t_3, __pyx_t_6); __pyx_t_6++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 482, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         #endif
       }
     } else {
       __pyx_t_5 = __pyx_t_7(__pyx_t_3);
       if (unlikely(!__pyx_t_5)) {
         PyObject* exc_type = PyErr_Occurred();
         if (exc_type) {
           if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-          else __PYX_ERR(0, 317, __pyx_L1_error)
+          else __PYX_ERR(0, 482, __pyx_L1_error)
         }
         break;
       }
       __Pyx_GOTREF(__pyx_t_5);
     }
     if ((likely(PyTuple_CheckExact(__pyx_t_5))) || (PyList_CheckExact(__pyx_t_5))) {
       PyObject* sequence = __pyx_t_5;
       Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
       if (unlikely(size != 2)) {
         if (size > 2) __Pyx_RaiseTooManyValuesError(2);
         else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-        __PYX_ERR(0, 317, __pyx_L1_error)
+        __PYX_ERR(0, 482, __pyx_L1_error)
       }
       #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
       if (likely(PyTuple_CheckExact(sequence))) {
         __pyx_t_9 = PyTuple_GET_ITEM(sequence, 0); 
         __pyx_t_8 = PyTuple_GET_ITEM(sequence, 1); 
       } else {
         __pyx_t_9 = PyList_GET_ITEM(sequence, 0); 
         __pyx_t_8 = PyList_GET_ITEM(sequence, 1); 
       }
       __Pyx_INCREF(__pyx_t_9);
       __Pyx_INCREF(__pyx_t_8);
       #else
-      __pyx_t_9 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 317, __pyx_L1_error)
+      __pyx_t_9 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 482, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 317, __pyx_L1_error)
+      __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 482, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       #endif
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     } else {
       Py_ssize_t index = -1;
-      __pyx_t_2 = PyObject_GetIter(__pyx_t_5); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 317, __pyx_L1_error)
+      __pyx_t_2 = PyObject_GetIter(__pyx_t_5); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 482, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
       __pyx_t_10 = Py_TYPE(__pyx_t_2)->tp_iternext;
       index = 0; __pyx_t_9 = __pyx_t_10(__pyx_t_2); if (unlikely(!__pyx_t_9)) goto __pyx_L12_unpacking_failed;
       __Pyx_GOTREF(__pyx_t_9);
       index = 1; __pyx_t_8 = __pyx_t_10(__pyx_t_2); if (unlikely(!__pyx_t_8)) goto __pyx_L12_unpacking_failed;
       __Pyx_GOTREF(__pyx_t_8);
-      if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_2), 2) < 0) __PYX_ERR(0, 317, __pyx_L1_error)
+      if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_2), 2) < 0) __PYX_ERR(0, 482, __pyx_L1_error)
       __pyx_t_10 = NULL;
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       goto __pyx_L13_unpacking_done;
       __pyx_L12_unpacking_failed:;
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       __pyx_t_10 = NULL;
       if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-      __PYX_ERR(0, 317, __pyx_L1_error)
+      __PYX_ERR(0, 482, __pyx_L1_error)
       __pyx_L13_unpacking_done:;
     }
     __Pyx_XDECREF_SET(__pyx_v_i, __pyx_t_9);
     __pyx_t_9 = 0;
     __Pyx_XDECREF_SET(__pyx_v_j, __pyx_t_8);
     __pyx_t_8 = 0;
     __Pyx_INCREF(__pyx_t_1);
     __Pyx_XDECREF_SET(__pyx_v_edge_id, __pyx_t_1);
-    __pyx_t_5 = __Pyx_PyInt_AddObjC(__pyx_t_1, __pyx_int_1, 1, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 317, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyInt_AddObjC(__pyx_t_1, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 482, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1);
     __pyx_t_1 = __pyx_t_5;
     __pyx_t_5 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":318
+    /* "tkwant/onebody/kernels.pyx":483
  *         # Process hoppings.
  *         for edge_id, (i, j) in enumerate(syst.graph):
  *             hop_val, _ = syst.hoppings[edge_id]             # <<<<<<<<<<<<<<
  *             if system.is_time_dependent_function(hop_val, time_name):
  *                 a, b = ori = system.orb_range(syst, i)
  */
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_hoppings); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 318, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_hoppings); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 483, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_8 = __Pyx_PyObject_GetItem(__pyx_t_5, __pyx_v_edge_id); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 318, __pyx_L1_error)
+    __pyx_t_8 = __Pyx_PyObject_GetItem(__pyx_t_5, __pyx_v_edge_id); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 483, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     if ((likely(PyTuple_CheckExact(__pyx_t_8))) || (PyList_CheckExact(__pyx_t_8))) {
       PyObject* sequence = __pyx_t_8;
       Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
       if (unlikely(size != 2)) {
         if (size > 2) __Pyx_RaiseTooManyValuesError(2);
         else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-        __PYX_ERR(0, 318, __pyx_L1_error)
+        __PYX_ERR(0, 483, __pyx_L1_error)
       }
       #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
       if (likely(PyTuple_CheckExact(sequence))) {
         __pyx_t_5 = PyTuple_GET_ITEM(sequence, 0); 
         __pyx_t_9 = PyTuple_GET_ITEM(sequence, 1); 
       } else {
         __pyx_t_5 = PyList_GET_ITEM(sequence, 0); 
         __pyx_t_9 = PyList_GET_ITEM(sequence, 1); 
       }
       __Pyx_INCREF(__pyx_t_5);
       __Pyx_INCREF(__pyx_t_9);
       #else
-      __pyx_t_5 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 318, __pyx_L1_error)
+      __pyx_t_5 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 483, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_9 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 318, __pyx_L1_error)
+      __pyx_t_9 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 483, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
       #endif
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     } else {
       Py_ssize_t index = -1;
-      __pyx_t_2 = PyObject_GetIter(__pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 318, __pyx_L1_error)
+      __pyx_t_2 = PyObject_GetIter(__pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 483, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __pyx_t_10 = Py_TYPE(__pyx_t_2)->tp_iternext;
       index = 0; __pyx_t_5 = __pyx_t_10(__pyx_t_2); if (unlikely(!__pyx_t_5)) goto __pyx_L14_unpacking_failed;
       __Pyx_GOTREF(__pyx_t_5);
       index = 1; __pyx_t_9 = __pyx_t_10(__pyx_t_2); if (unlikely(!__pyx_t_9)) goto __pyx_L14_unpacking_failed;
       __Pyx_GOTREF(__pyx_t_9);
-      if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_2), 2) < 0) __PYX_ERR(0, 318, __pyx_L1_error)
+      if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_2), 2) < 0) __PYX_ERR(0, 483, __pyx_L1_error)
       __pyx_t_10 = NULL;
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       goto __pyx_L15_unpacking_done;
       __pyx_L14_unpacking_failed:;
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       __pyx_t_10 = NULL;
       if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-      __PYX_ERR(0, 318, __pyx_L1_error)
+      __PYX_ERR(0, 483, __pyx_L1_error)
       __pyx_L15_unpacking_done:;
     }
     __Pyx_XDECREF_SET(__pyx_v_hop_val, __pyx_t_5);
     __pyx_t_5 = 0;
     __Pyx_XDECREF_SET(__pyx_v__, __pyx_t_9);
     __pyx_t_9 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":319
+    /* "tkwant/onebody/kernels.pyx":484
  *         for edge_id, (i, j) in enumerate(syst.graph):
  *             hop_val, _ = syst.hoppings[edge_id]
  *             if system.is_time_dependent_function(hop_val, time_name):             # <<<<<<<<<<<<<<
  *                 a, b = ori = system.orb_range(syst, i)
  *                 c, d = orj = system.orb_range(syst, j)
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_system); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 319, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_system); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 484, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_is_time_dependent_function); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 319, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_is_time_dependent_function); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 484, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
     __pyx_t_9 = NULL;
     __pyx_t_4 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_5))) {
       __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_5);
       if (likely(__pyx_t_9)) {
@@ -7071,58 +10285,58 @@
         __Pyx_DECREF_SET(__pyx_t_5, function);
         __pyx_t_4 = 1;
       }
     }
     #if CYTHON_FAST_PYCALL
     if (PyFunction_Check(__pyx_t_5)) {
       PyObject *__pyx_temp[3] = {__pyx_t_9, __pyx_v_hop_val, __pyx_v_time_name};
-      __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 319, __pyx_L1_error)
+      __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 484, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
       __Pyx_GOTREF(__pyx_t_8);
     } else
     #endif
     #if CYTHON_FAST_PYCCALL
     if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
       PyObject *__pyx_temp[3] = {__pyx_t_9, __pyx_v_hop_val, __pyx_v_time_name};
-      __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 319, __pyx_L1_error)
+      __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 484, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
       __Pyx_GOTREF(__pyx_t_8);
     } else
     #endif
     {
-      __pyx_t_2 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 319, __pyx_L1_error)
+      __pyx_t_2 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 484, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       if (__pyx_t_9) {
         __Pyx_GIVEREF(__pyx_t_9); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_9); __pyx_t_9 = NULL;
       }
       __Pyx_INCREF(__pyx_v_hop_val);
       __Pyx_GIVEREF(__pyx_v_hop_val);
       PyTuple_SET_ITEM(__pyx_t_2, 0+__pyx_t_4, __pyx_v_hop_val);
       __Pyx_INCREF(__pyx_v_time_name);
       __Pyx_GIVEREF(__pyx_v_time_name);
       PyTuple_SET_ITEM(__pyx_t_2, 1+__pyx_t_4, __pyx_v_time_name);
-      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 319, __pyx_L1_error)
+      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 484, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     }
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_11 = __Pyx_PyObject_IsTrue(__pyx_t_8); if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 319, __pyx_L1_error)
+    __pyx_t_11 = __Pyx_PyObject_IsTrue(__pyx_t_8); if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 484, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     if (__pyx_t_11) {
 
-      /* "tkwant/onebody/kernels.pyx":320
+      /* "tkwant/onebody/kernels.pyx":485
  *             hop_val, _ = syst.hoppings[edge_id]
  *             if system.is_time_dependent_function(hop_val, time_name):
  *                 a, b = ori = system.orb_range(syst, i)             # <<<<<<<<<<<<<<
  *                 c, d = orj = system.orb_range(syst, j)
  *                 nnz += 2 * (b - a) * (d - c)
  */
-      __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_system); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 320, __pyx_L1_error)
+      __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_system); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 485, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_orb_range); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 320, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_orb_range); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 485, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
       __pyx_t_5 = NULL;
       __pyx_t_4 = 0;
       if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
         __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
         if (likely(__pyx_t_5)) {
@@ -7132,106 +10346,106 @@
           __Pyx_DECREF_SET(__pyx_t_2, function);
           __pyx_t_4 = 1;
         }
       }
       #if CYTHON_FAST_PYCALL
       if (PyFunction_Check(__pyx_t_2)) {
         PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_v_syst, __pyx_v_i};
-        __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 320, __pyx_L1_error)
+        __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 485, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
         __Pyx_GOTREF(__pyx_t_8);
       } else
       #endif
       #if CYTHON_FAST_PYCCALL
       if (__Pyx_PyFastCFunction_Check(__pyx_t_2)) {
         PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_v_syst, __pyx_v_i};
-        __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 320, __pyx_L1_error)
+        __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 485, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
         __Pyx_GOTREF(__pyx_t_8);
       } else
       #endif
       {
-        __pyx_t_9 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 320, __pyx_L1_error)
+        __pyx_t_9 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 485, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_9);
         if (__pyx_t_5) {
           __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_5); __pyx_t_5 = NULL;
         }
         __Pyx_INCREF(__pyx_v_syst);
         __Pyx_GIVEREF(__pyx_v_syst);
         PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_4, __pyx_v_syst);
         __Pyx_INCREF(__pyx_v_i);
         __Pyx_GIVEREF(__pyx_v_i);
         PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_4, __pyx_v_i);
-        __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_9, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 320, __pyx_L1_error)
+        __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_9, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 485, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       }
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       if ((likely(PyTuple_CheckExact(__pyx_t_8))) || (PyList_CheckExact(__pyx_t_8))) {
         PyObject* sequence = __pyx_t_8;
         Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
         if (unlikely(size != 2)) {
           if (size > 2) __Pyx_RaiseTooManyValuesError(2);
           else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-          __PYX_ERR(0, 320, __pyx_L1_error)
+          __PYX_ERR(0, 485, __pyx_L1_error)
         }
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
         if (likely(PyTuple_CheckExact(sequence))) {
           __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
           __pyx_t_9 = PyTuple_GET_ITEM(sequence, 1); 
         } else {
           __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
           __pyx_t_9 = PyList_GET_ITEM(sequence, 1); 
         }
         __Pyx_INCREF(__pyx_t_2);
         __Pyx_INCREF(__pyx_t_9);
         #else
-        __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 320, __pyx_L1_error)
+        __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 485, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
-        __pyx_t_9 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 320, __pyx_L1_error)
+        __pyx_t_9 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 485, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_9);
         #endif
       } else {
         Py_ssize_t index = -1;
-        __pyx_t_5 = PyObject_GetIter(__pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 320, __pyx_L1_error)
+        __pyx_t_5 = PyObject_GetIter(__pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 485, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         __pyx_t_10 = Py_TYPE(__pyx_t_5)->tp_iternext;
         index = 0; __pyx_t_2 = __pyx_t_10(__pyx_t_5); if (unlikely(!__pyx_t_2)) goto __pyx_L17_unpacking_failed;
         __Pyx_GOTREF(__pyx_t_2);
         index = 1; __pyx_t_9 = __pyx_t_10(__pyx_t_5); if (unlikely(!__pyx_t_9)) goto __pyx_L17_unpacking_failed;
         __Pyx_GOTREF(__pyx_t_9);
-        if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_5), 2) < 0) __PYX_ERR(0, 320, __pyx_L1_error)
+        if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_5), 2) < 0) __PYX_ERR(0, 485, __pyx_L1_error)
         __pyx_t_10 = NULL;
         __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
         goto __pyx_L18_unpacking_done;
         __pyx_L17_unpacking_failed:;
         __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
         __pyx_t_10 = NULL;
         if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-        __PYX_ERR(0, 320, __pyx_L1_error)
+        __PYX_ERR(0, 485, __pyx_L1_error)
         __pyx_L18_unpacking_done:;
       }
       __Pyx_XDECREF_SET(__pyx_v_a, __pyx_t_2);
       __pyx_t_2 = 0;
       __Pyx_XDECREF_SET(__pyx_v_b, __pyx_t_9);
       __pyx_t_9 = 0;
       __Pyx_INCREF(__pyx_t_8);
       __Pyx_XDECREF_SET(__pyx_v_ori, __pyx_t_8);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":321
+      /* "tkwant/onebody/kernels.pyx":486
  *             if system.is_time_dependent_function(hop_val, time_name):
  *                 a, b = ori = system.orb_range(syst, i)
  *                 c, d = orj = system.orb_range(syst, j)             # <<<<<<<<<<<<<<
  *                 nnz += 2 * (b - a) * (d - c)
  *                 td_hamiltonian.append((i, j, ori, orj, H(i, j, params=self.tparams)))
  */
-      __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_system); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 321, __pyx_L1_error)
+      __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_system); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 486, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_orb_range); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 321, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_orb_range); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 486, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       __pyx_t_9 = NULL;
       __pyx_t_4 = 0;
       if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
         __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_2);
         if (likely(__pyx_t_9)) {
@@ -7241,143 +10455,143 @@
           __Pyx_DECREF_SET(__pyx_t_2, function);
           __pyx_t_4 = 1;
         }
       }
       #if CYTHON_FAST_PYCALL
       if (PyFunction_Check(__pyx_t_2)) {
         PyObject *__pyx_temp[3] = {__pyx_t_9, __pyx_v_syst, __pyx_v_j};
-        __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 321, __pyx_L1_error)
+        __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 486, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
         __Pyx_GOTREF(__pyx_t_8);
       } else
       #endif
       #if CYTHON_FAST_PYCCALL
       if (__Pyx_PyFastCFunction_Check(__pyx_t_2)) {
         PyObject *__pyx_temp[3] = {__pyx_t_9, __pyx_v_syst, __pyx_v_j};
-        __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 321, __pyx_L1_error)
+        __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_4, 2+__pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 486, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
         __Pyx_GOTREF(__pyx_t_8);
       } else
       #endif
       {
-        __pyx_t_5 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 321, __pyx_L1_error)
+        __pyx_t_5 = PyTuple_New(2+__pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 486, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         if (__pyx_t_9) {
           __Pyx_GIVEREF(__pyx_t_9); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_9); __pyx_t_9 = NULL;
         }
         __Pyx_INCREF(__pyx_v_syst);
         __Pyx_GIVEREF(__pyx_v_syst);
         PyTuple_SET_ITEM(__pyx_t_5, 0+__pyx_t_4, __pyx_v_syst);
         __Pyx_INCREF(__pyx_v_j);
         __Pyx_GIVEREF(__pyx_v_j);
         PyTuple_SET_ITEM(__pyx_t_5, 1+__pyx_t_4, __pyx_v_j);
-        __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 321, __pyx_L1_error)
+        __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_5, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 486, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
         __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
       }
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       if ((likely(PyTuple_CheckExact(__pyx_t_8))) || (PyList_CheckExact(__pyx_t_8))) {
         PyObject* sequence = __pyx_t_8;
         Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
         if (unlikely(size != 2)) {
           if (size > 2) __Pyx_RaiseTooManyValuesError(2);
           else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-          __PYX_ERR(0, 321, __pyx_L1_error)
+          __PYX_ERR(0, 486, __pyx_L1_error)
         }
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
         if (likely(PyTuple_CheckExact(sequence))) {
           __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
           __pyx_t_5 = PyTuple_GET_ITEM(sequence, 1); 
         } else {
           __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
           __pyx_t_5 = PyList_GET_ITEM(sequence, 1); 
         }
         __Pyx_INCREF(__pyx_t_2);
         __Pyx_INCREF(__pyx_t_5);
         #else
-        __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 321, __pyx_L1_error)
+        __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 486, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
-        __pyx_t_5 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 321, __pyx_L1_error)
+        __pyx_t_5 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 486, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         #endif
       } else {
         Py_ssize_t index = -1;
-        __pyx_t_9 = PyObject_GetIter(__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 321, __pyx_L1_error)
+        __pyx_t_9 = PyObject_GetIter(__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 486, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_9);
         __pyx_t_10 = Py_TYPE(__pyx_t_9)->tp_iternext;
         index = 0; __pyx_t_2 = __pyx_t_10(__pyx_t_9); if (unlikely(!__pyx_t_2)) goto __pyx_L19_unpacking_failed;
         __Pyx_GOTREF(__pyx_t_2);
         index = 1; __pyx_t_5 = __pyx_t_10(__pyx_t_9); if (unlikely(!__pyx_t_5)) goto __pyx_L19_unpacking_failed;
         __Pyx_GOTREF(__pyx_t_5);
-        if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_9), 2) < 0) __PYX_ERR(0, 321, __pyx_L1_error)
+        if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_9), 2) < 0) __PYX_ERR(0, 486, __pyx_L1_error)
         __pyx_t_10 = NULL;
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
         goto __pyx_L20_unpacking_done;
         __pyx_L19_unpacking_failed:;
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
         __pyx_t_10 = NULL;
         if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-        __PYX_ERR(0, 321, __pyx_L1_error)
+        __PYX_ERR(0, 486, __pyx_L1_error)
         __pyx_L20_unpacking_done:;
       }
       __Pyx_XDECREF_SET(__pyx_v_c, __pyx_t_2);
       __pyx_t_2 = 0;
       __Pyx_XDECREF_SET(__pyx_v_d, __pyx_t_5);
       __pyx_t_5 = 0;
       __Pyx_INCREF(__pyx_t_8);
       __Pyx_XDECREF_SET(__pyx_v_orj, __pyx_t_8);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":322
+      /* "tkwant/onebody/kernels.pyx":487
  *                 a, b = ori = system.orb_range(syst, i)
  *                 c, d = orj = system.orb_range(syst, j)
  *                 nnz += 2 * (b - a) * (d - c)             # <<<<<<<<<<<<<<
  *                 td_hamiltonian.append((i, j, ori, orj, H(i, j, params=self.tparams)))
  * 
  */
-      __pyx_t_8 = PyNumber_Subtract(__pyx_v_b, __pyx_v_a); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 322, __pyx_L1_error)
+      __pyx_t_8 = PyNumber_Subtract(__pyx_v_b, __pyx_v_a); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 487, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
-      __pyx_t_5 = PyNumber_Multiply(__pyx_int_2, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 322, __pyx_L1_error)
+      __pyx_t_5 = PyNumber_Multiply(__pyx_int_2, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 487, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __pyx_t_8 = PyNumber_Subtract(__pyx_v_d, __pyx_v_c); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 322, __pyx_L1_error)
+      __pyx_t_8 = PyNumber_Subtract(__pyx_v_d, __pyx_v_c); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 487, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
-      __pyx_t_2 = PyNumber_Multiply(__pyx_t_5, __pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 322, __pyx_L1_error)
+      __pyx_t_2 = PyNumber_Multiply(__pyx_t_5, __pyx_t_8); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 487, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __pyx_t_8 = PyNumber_InPlaceAdd(__pyx_v_nnz, __pyx_t_2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 322, __pyx_L1_error)
+      __pyx_t_8 = PyNumber_InPlaceAdd(__pyx_v_nnz, __pyx_t_2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 487, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       __Pyx_DECREF_SET(__pyx_v_nnz, __pyx_t_8);
       __pyx_t_8 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":323
+      /* "tkwant/onebody/kernels.pyx":488
  *                 c, d = orj = system.orb_range(syst, j)
  *                 nnz += 2 * (b - a) * (d - c)
  *                 td_hamiltonian.append((i, j, ori, orj, H(i, j, params=self.tparams)))             # <<<<<<<<<<<<<<
  * 
  *         _, _, total_norbs = syst.site_ranges[-1]
  */
-      __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 323, __pyx_L1_error)
+      __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 488, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       __Pyx_INCREF(__pyx_v_i);
       __Pyx_GIVEREF(__pyx_v_i);
       PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_v_i);
       __Pyx_INCREF(__pyx_v_j);
       __Pyx_GIVEREF(__pyx_v_j);
       PyTuple_SET_ITEM(__pyx_t_8, 1, __pyx_v_j);
-      __pyx_t_2 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 323, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 488, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
-      if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_params, __pyx_v_self->tparams) < 0) __PYX_ERR(0, 323, __pyx_L1_error)
-      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_v_H, __pyx_t_8, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 323, __pyx_L1_error)
+      if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_params, __pyx_v_self->tparams) < 0) __PYX_ERR(0, 488, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_v_H, __pyx_t_8, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 488, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __pyx_t_2 = PyTuple_New(5); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 323, __pyx_L1_error)
+      __pyx_t_2 = PyTuple_New(5); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 488, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_INCREF(__pyx_v_i);
       __Pyx_GIVEREF(__pyx_v_i);
       PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_v_i);
       __Pyx_INCREF(__pyx_v_j);
       __Pyx_GIVEREF(__pyx_v_j);
       PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_v_j);
@@ -7386,56 +10600,56 @@
       PyTuple_SET_ITEM(__pyx_t_2, 2, __pyx_v_ori);
       __Pyx_INCREF(__pyx_v_orj);
       __Pyx_GIVEREF(__pyx_v_orj);
       PyTuple_SET_ITEM(__pyx_t_2, 3, __pyx_v_orj);
       __Pyx_GIVEREF(__pyx_t_5);
       PyTuple_SET_ITEM(__pyx_t_2, 4, __pyx_t_5);
       __pyx_t_5 = 0;
-      __pyx_t_12 = __Pyx_PyList_Append(__pyx_v_td_hamiltonian, __pyx_t_2); if (unlikely(__pyx_t_12 == ((int)-1))) __PYX_ERR(0, 323, __pyx_L1_error)
+      __pyx_t_12 = __Pyx_PyList_Append(__pyx_v_td_hamiltonian, __pyx_t_2); if (unlikely(__pyx_t_12 == ((int)-1))) __PYX_ERR(0, 488, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":319
+      /* "tkwant/onebody/kernels.pyx":484
  *         for edge_id, (i, j) in enumerate(syst.graph):
  *             hop_val, _ = syst.hoppings[edge_id]
  *             if system.is_time_dependent_function(hop_val, time_name):             # <<<<<<<<<<<<<<
  *                 a, b = ori = system.orb_range(syst, i)
  *                 c, d = orj = system.orb_range(syst, j)
  */
     }
 
-    /* "tkwant/onebody/kernels.pyx":317
+    /* "tkwant/onebody/kernels.pyx":482
  * 
  *         # Process hoppings.
  *         for edge_id, (i, j) in enumerate(syst.graph):             # <<<<<<<<<<<<<<
  *             hop_val, _ = syst.hoppings[edge_id]
  *             if system.is_time_dependent_function(hop_val, time_name):
  */
   }
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":325
+  /* "tkwant/onebody/kernels.pyx":490
  *                 td_hamiltonian.append((i, j, ori, orj, H(i, j, params=self.tparams)))
  * 
  *         _, _, total_norbs = syst.site_ranges[-1]             # <<<<<<<<<<<<<<
  *         self.nnz = nnz
  *         self.size = total_norbs
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_site_ranges); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 325, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_site_ranges); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 490, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __Pyx_GetItemInt(__pyx_t_1, -1L, long, 1, __Pyx_PyInt_From_long, 0, 1, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 325, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_GetItemInt(__pyx_t_1, -1L, long, 1, __Pyx_PyInt_From_long, 0, 1, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 490, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   if ((likely(PyTuple_CheckExact(__pyx_t_3))) || (PyList_CheckExact(__pyx_t_3))) {
     PyObject* sequence = __pyx_t_3;
     Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
     if (unlikely(size != 3)) {
       if (size > 3) __Pyx_RaiseTooManyValuesError(3);
       else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-      __PYX_ERR(0, 325, __pyx_L1_error)
+      __PYX_ERR(0, 490, __pyx_L1_error)
     }
     #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
     if (likely(PyTuple_CheckExact(sequence))) {
       __pyx_t_1 = PyTuple_GET_ITEM(sequence, 0); 
       __pyx_t_2 = PyTuple_GET_ITEM(sequence, 1); 
       __pyx_t_5 = PyTuple_GET_ITEM(sequence, 2); 
     } else {
@@ -7443,73 +10657,73 @@
       __pyx_t_2 = PyList_GET_ITEM(sequence, 1); 
       __pyx_t_5 = PyList_GET_ITEM(sequence, 2); 
     }
     __Pyx_INCREF(__pyx_t_1);
     __Pyx_INCREF(__pyx_t_2);
     __Pyx_INCREF(__pyx_t_5);
     #else
-    __pyx_t_1 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 325, __pyx_L1_error)
+    __pyx_t_1 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 490, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_2 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 325, __pyx_L1_error)
+    __pyx_t_2 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 490, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_5 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 325, __pyx_L1_error)
+    __pyx_t_5 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 490, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     #endif
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   } else {
     Py_ssize_t index = -1;
-    __pyx_t_8 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 325, __pyx_L1_error)
+    __pyx_t_8 = PyObject_GetIter(__pyx_t_3); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 490, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __pyx_t_10 = Py_TYPE(__pyx_t_8)->tp_iternext;
     index = 0; __pyx_t_1 = __pyx_t_10(__pyx_t_8); if (unlikely(!__pyx_t_1)) goto __pyx_L21_unpacking_failed;
     __Pyx_GOTREF(__pyx_t_1);
     index = 1; __pyx_t_2 = __pyx_t_10(__pyx_t_8); if (unlikely(!__pyx_t_2)) goto __pyx_L21_unpacking_failed;
     __Pyx_GOTREF(__pyx_t_2);
     index = 2; __pyx_t_5 = __pyx_t_10(__pyx_t_8); if (unlikely(!__pyx_t_5)) goto __pyx_L21_unpacking_failed;
     __Pyx_GOTREF(__pyx_t_5);
-    if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_8), 3) < 0) __PYX_ERR(0, 325, __pyx_L1_error)
+    if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_8), 3) < 0) __PYX_ERR(0, 490, __pyx_L1_error)
     __pyx_t_10 = NULL;
     __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     goto __pyx_L22_unpacking_done;
     __pyx_L21_unpacking_failed:;
     __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     __pyx_t_10 = NULL;
     if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-    __PYX_ERR(0, 325, __pyx_L1_error)
+    __PYX_ERR(0, 490, __pyx_L1_error)
     __pyx_L22_unpacking_done:;
   }
   __Pyx_XDECREF_SET(__pyx_v__, __pyx_t_1);
   __pyx_t_1 = 0;
   __Pyx_DECREF_SET(__pyx_v__, __pyx_t_2);
   __pyx_t_2 = 0;
   __pyx_v_total_norbs = __pyx_t_5;
   __pyx_t_5 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":326
+  /* "tkwant/onebody/kernels.pyx":491
  * 
  *         _, _, total_norbs = syst.site_ranges[-1]
  *         self.nnz = nnz             # <<<<<<<<<<<<<<
  *         self.size = total_norbs
  * 
  */
-  __pyx_t_4 = __Pyx_PyInt_As_int(__pyx_v_nnz); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 326, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyInt_As_int(__pyx_v_nnz); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 491, __pyx_L1_error)
   __pyx_v_self->nnz = __pyx_t_4;
 
-  /* "tkwant/onebody/kernels.pyx":327
+  /* "tkwant/onebody/kernels.pyx":492
  *         _, _, total_norbs = syst.site_ranges[-1]
  *         self.nnz = nnz
  *         self.size = total_norbs             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
-  __pyx_t_4 = __Pyx_PyInt_As_int(__pyx_v_total_norbs); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 327, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyInt_As_int(__pyx_v_total_norbs); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 492, __pyx_L1_error)
   __pyx_v_self->size = __pyx_t_4;
 
-  /* "tkwant/onebody/kernels.pyx":297
+  /* "tkwant/onebody/kernels.pyx":462
  *         object td_hamiltonian
  * 
  *     def __init__(self, syst, time_name, time_start, params=None):             # <<<<<<<<<<<<<<
  *         self.tparams = system.add_time_to_params(params, time_name, time_start)
  *         self.time_name = time_name
  */
 
@@ -7544,15 +10758,15 @@
   __Pyx_XDECREF(__pyx_v_d);
   __Pyx_XDECREF(__pyx_v_orj);
   __Pyx_XDECREF(__pyx_v_total_norbs);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":330
+/* "tkwant/onebody/kernels.pyx":495
  * 
  *     @property
  *     def size(self):             # <<<<<<<<<<<<<<
  *         '''The size of the W(t) matrix.
  * 
  */
 
@@ -7569,31 +10783,34 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_4size___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":338
+  /* "tkwant/onebody/kernels.pyx":503
  *             The size of the W(t) matrix is ``size`` x ``size``.
  *         '''
  *         return self.size             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 338, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 503, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":330
+  /* "tkwant/onebody/kernels.pyx":495
  * 
  *     @property
  *     def size(self):             # <<<<<<<<<<<<<<
  *         '''The size of the W(t) matrix.
  * 
  */
 
@@ -7604,15 +10821,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":341
+/* "tkwant/onebody/kernels.pyx":506
  * 
  *     @property
  *     def nnz(self):             # <<<<<<<<<<<<<<
  *         '''The total number of time-dependent matrix elements.
  * 
  */
 
@@ -7629,31 +10846,34 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_3nnz___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":350
+  /* "tkwant/onebody/kernels.pyx":515
  *             len(W(t).data).
  *         '''
  *         return self.nnz             # <<<<<<<<<<<<<<
  * 
  *     def data(self, double time, object out=None):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 350, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 515, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":341
+  /* "tkwant/onebody/kernels.pyx":506
  * 
  *     @property
  *     def nnz(self):             # <<<<<<<<<<<<<<
  *         '''The total number of time-dependent matrix elements.
  * 
  */
 
@@ -7664,28 +10884,31 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":352
+/* "tkwant/onebody/kernels.pyx":517
  *         return self.nnz
  * 
  *     def data(self, double time, object out=None):             # <<<<<<<<<<<<<<
  *         '''Return the time-dependent matrix elements.
  * 
  */
 
 /* Python wrapper */
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_21PerturbationExtractor_3data(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static char __pyx_doc_6tkwant_7onebody_7kernels_21PerturbationExtractor_2data[] = "PerturbationExtractor.data(self, double time, out=None)\nReturn the time-dependent matrix elements.\n\n        Parameters\n        ----------\n        time : int or float\n            Time argument, must be equal or larger than `time_start`.\n        out : `numpy.ndarray`, optional\n            Data array of the W(t) matrix for operation in-place.\n\n        Returns\n        -------\n        out : `numpy.ndarray` or `None`\n            Data array of the W(t) matrix (W(t).data). If an ``out`` argument is given,\n            the operation is performed in-place and the routine returns `None`.\n        ";
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_21PerturbationExtractor_3data(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   double __pyx_v_time;
   PyObject *__pyx_v_out = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("data (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_time,&__pyx_n_s_out,0};
     PyObject* values[2] = {0,0};
     values[1] = ((PyObject *)Py_None);
@@ -7709,31 +10932,31 @@
         case  1:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_out);
           if (value) { values[1] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "data") < 0)) __PYX_ERR(0, 352, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "data") < 0)) __PYX_ERR(0, 517, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
-    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 352, __pyx_L3_error)
+    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 517, __pyx_L3_error)
     __pyx_v_out = values[1];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("data", 0, 1, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 352, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("data", 0, 1, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 517, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationExtractor.data", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_2data(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *)__pyx_v_self), __pyx_v_time, __pyx_v_out);
 
@@ -7745,15 +10968,16 @@
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_2data(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self, double __pyx_v_time, PyObject *__pyx_v_out) {
   int __pyx_v_do_return;
   PyObject *__pyx_v_index = NULL;
   PyObject *__pyx_v_i = NULL;
   PyObject *__pyx_v_j = NULL;
   CYTHON_UNUSED PyObject *__pyx_v__ = NULL;
   PyObject *__pyx_v_H_0 = NULL;
-  PyObject *__pyx_v_mat_el = NULL;
+  PyObject *__pyx_v_H = NULL;
+  PyObject *__pyx_v_mat_els = NULL;
   PyObject *__pyx_v_val = NULL;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
@@ -7765,50 +10989,53 @@
   Py_ssize_t __pyx_t_10;
   PyObject *(*__pyx_t_11)(PyObject *);
   PyObject *__pyx_t_12 = NULL;
   PyObject *__pyx_t_13 = NULL;
   PyObject *(*__pyx_t_14)(PyObject *);
   Py_ssize_t __pyx_t_15;
   PyObject *(*__pyx_t_16)(PyObject *);
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("data", 0);
   __Pyx_INCREF(__pyx_v_out);
 
-  /* "tkwant/onebody/kernels.pyx":368
+  /* "tkwant/onebody/kernels.pyx":533
  *             the operation is performed in-place and the routine returns `None`.
  *         '''
  *         if out is None:             # <<<<<<<<<<<<<<
  *             do_return = True
  *             out = np.empty(self.nnz, complex)
  */
   __pyx_t_1 = (__pyx_v_out == Py_None);
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "tkwant/onebody/kernels.pyx":369
+    /* "tkwant/onebody/kernels.pyx":534
  *         '''
  *         if out is None:
  *             do_return = True             # <<<<<<<<<<<<<<
  *             out = np.empty(self.nnz, complex)
  *         else:
  */
     __pyx_v_do_return = 1;
 
-    /* "tkwant/onebody/kernels.pyx":370
+    /* "tkwant/onebody/kernels.pyx":535
  *         if out is None:
  *             do_return = True
  *             out = np.empty(self.nnz, complex)             # <<<<<<<<<<<<<<
  *         else:
  *             do_return = False
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 370, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 535, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_empty); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 370, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_empty); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 535, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 370, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 535, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __pyx_t_6 = NULL;
     __pyx_t_7 = 0;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_5))) {
       __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
       if (likely(__pyx_t_6)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
@@ -7817,118 +11044,118 @@
         __Pyx_DECREF_SET(__pyx_t_5, function);
         __pyx_t_7 = 1;
       }
     }
     #if CYTHON_FAST_PYCALL
     if (PyFunction_Check(__pyx_t_5)) {
       PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_4, ((PyObject *)(&PyComplex_Type))};
-      __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 370, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 535, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     } else
     #endif
     #if CYTHON_FAST_PYCCALL
     if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
       PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_4, ((PyObject *)(&PyComplex_Type))};
-      __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 370, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 535, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     } else
     #endif
     {
-      __pyx_t_8 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 370, __pyx_L1_error)
+      __pyx_t_8 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 535, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       if (__pyx_t_6) {
         __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6); __pyx_t_6 = NULL;
       }
       __Pyx_GIVEREF(__pyx_t_4);
       PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_7, __pyx_t_4);
       __Pyx_INCREF(((PyObject *)(&PyComplex_Type)));
       __Pyx_GIVEREF(((PyObject *)(&PyComplex_Type)));
       PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_7, ((PyObject *)(&PyComplex_Type)));
       __pyx_t_4 = 0;
-      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_8, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 370, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_8, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 535, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     }
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_DECREF_SET(__pyx_v_out, __pyx_t_3);
     __pyx_t_3 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":368
+    /* "tkwant/onebody/kernels.pyx":533
  *             the operation is performed in-place and the routine returns `None`.
  *         '''
  *         if out is None:             # <<<<<<<<<<<<<<
  *             do_return = True
  *             out = np.empty(self.nnz, complex)
  */
     goto __pyx_L3;
   }
 
-  /* "tkwant/onebody/kernels.pyx":372
+  /* "tkwant/onebody/kernels.pyx":537
  *             out = np.empty(self.nnz, complex)
  *         else:
  *             do_return = False             # <<<<<<<<<<<<<<
  *             assert out.shape[0] == self.nnz, _errormsg.format('output',
  *                                                               out.shape[0],
  */
   /*else*/ {
     __pyx_v_do_return = 0;
 
-    /* "tkwant/onebody/kernels.pyx":373
+    /* "tkwant/onebody/kernels.pyx":538
  *         else:
  *             do_return = False
  *             assert out.shape[0] == self.nnz, _errormsg.format('output',             # <<<<<<<<<<<<<<
  *                                                               out.shape[0],
  *                                                               self.nnz)
  */
     #ifndef CYTHON_WITHOUT_ASSERTIONS
     if (unlikely(!Py_OptimizeFlag)) {
-      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 373, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 538, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 373, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 538, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 373, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 538, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_8 = PyObject_RichCompare(__pyx_t_5, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_8); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 373, __pyx_L1_error)
+      __pyx_t_8 = PyObject_RichCompare(__pyx_t_5, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_8); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 538, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_8); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 373, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_8); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 538, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       if (unlikely(!__pyx_t_2)) {
-        __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 373, __pyx_L1_error)
+        __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 538, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_format); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 373, __pyx_L1_error)
+        __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_format); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 538, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":374
+        /* "tkwant/onebody/kernels.pyx":539
  *             do_return = False
  *             assert out.shape[0] == self.nnz, _errormsg.format('output',
  *                                                               out.shape[0],             # <<<<<<<<<<<<<<
  *                                                               self.nnz)
  *         index = 0
  */
-        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 374, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 539, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 374, __pyx_L1_error)
+        __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 539, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_4);
         __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":375
+        /* "tkwant/onebody/kernels.pyx":540
  *             assert out.shape[0] == self.nnz, _errormsg.format('output',
  *                                                               out.shape[0],
  *                                                               self.nnz)             # <<<<<<<<<<<<<<
  *         index = 0
  *         self.tparams[self.time_name] = time
  */
-        __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 375, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 540, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
         __pyx_t_6 = NULL;
         __pyx_t_7 = 0;
         if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_5))) {
           __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
           if (likely(__pyx_t_6)) {
             PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
@@ -7937,146 +11164,146 @@
             __Pyx_DECREF_SET(__pyx_t_5, function);
             __pyx_t_7 = 1;
           }
         }
         #if CYTHON_FAST_PYCALL
         if (PyFunction_Check(__pyx_t_5)) {
           PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_n_u_output, __pyx_t_4, __pyx_t_3};
-          __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 373, __pyx_L1_error)
+          __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 538, __pyx_L1_error)
           __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
           __Pyx_GOTREF(__pyx_t_8);
           __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         } else
         #endif
         #if CYTHON_FAST_PYCCALL
         if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
           PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_n_u_output, __pyx_t_4, __pyx_t_3};
-          __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 373, __pyx_L1_error)
+          __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 538, __pyx_L1_error)
           __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
           __Pyx_GOTREF(__pyx_t_8);
           __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         } else
         #endif
         {
-          __pyx_t_9 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 373, __pyx_L1_error)
+          __pyx_t_9 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 538, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_9);
           if (__pyx_t_6) {
             __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_6); __pyx_t_6 = NULL;
           }
           __Pyx_INCREF(__pyx_n_u_output);
           __Pyx_GIVEREF(__pyx_n_u_output);
           PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_7, __pyx_n_u_output);
           __Pyx_GIVEREF(__pyx_t_4);
           PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_7, __pyx_t_4);
           __Pyx_GIVEREF(__pyx_t_3);
           PyTuple_SET_ITEM(__pyx_t_9, 2+__pyx_t_7, __pyx_t_3);
           __pyx_t_4 = 0;
           __pyx_t_3 = 0;
-          __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_9, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 373, __pyx_L1_error)
+          __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_9, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 538, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_8);
           __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
         }
         __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":373
+        /* "tkwant/onebody/kernels.pyx":538
  *         else:
  *             do_return = False
  *             assert out.shape[0] == self.nnz, _errormsg.format('output',             # <<<<<<<<<<<<<<
  *                                                               out.shape[0],
  *                                                               self.nnz)
  */
-        __pyx_t_5 = PyTuple_Pack(1, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 373, __pyx_L1_error)
+        __pyx_t_5 = PyTuple_Pack(1, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 538, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
         PyErr_SetObject(PyExc_AssertionError, __pyx_t_5);
         __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-        __PYX_ERR(0, 373, __pyx_L1_error)
+        __PYX_ERR(0, 538, __pyx_L1_error)
       }
     }
     #endif
   }
   __pyx_L3:;
 
-  /* "tkwant/onebody/kernels.pyx":376
+  /* "tkwant/onebody/kernels.pyx":541
  *                                                               out.shape[0],
  *                                                               self.nnz)
  *         index = 0             # <<<<<<<<<<<<<<
  *         self.tparams[self.time_name] = time
  *         for i, j, _, _, H_0 in self.td_hamiltonian:
  */
   __Pyx_INCREF(__pyx_int_0);
   __pyx_v_index = __pyx_int_0;
 
-  /* "tkwant/onebody/kernels.pyx":377
+  /* "tkwant/onebody/kernels.pyx":542
  *                                                               self.nnz)
  *         index = 0
  *         self.tparams[self.time_name] = time             # <<<<<<<<<<<<<<
  *         for i, j, _, _, H_0 in self.td_hamiltonian:
- *             mat_el = np.asarray(self.H(i, j, params=self.tparams) - H_0)
+ *             H = self.H(i, j, params=self.tparams)
  */
-  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 377, __pyx_L1_error)
+  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 542, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  if (unlikely(PyObject_SetItem(__pyx_v_self->tparams, __pyx_v_self->time_name, __pyx_t_5) < 0)) __PYX_ERR(0, 377, __pyx_L1_error)
+  if (unlikely(PyObject_SetItem(__pyx_v_self->tparams, __pyx_v_self->time_name, __pyx_t_5) < 0)) __PYX_ERR(0, 542, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":378
+  /* "tkwant/onebody/kernels.pyx":543
  *         index = 0
  *         self.tparams[self.time_name] = time
  *         for i, j, _, _, H_0 in self.td_hamiltonian:             # <<<<<<<<<<<<<<
- *             mat_el = np.asarray(self.H(i, j, params=self.tparams) - H_0)
- *             for val in mat_el.flatten():
+ *             H = self.H(i, j, params=self.tparams)
+ *             mat_els = np.asarray(H - H_0).flatten()
  */
   if (likely(PyList_CheckExact(__pyx_v_self->td_hamiltonian)) || PyTuple_CheckExact(__pyx_v_self->td_hamiltonian)) {
     __pyx_t_5 = __pyx_v_self->td_hamiltonian; __Pyx_INCREF(__pyx_t_5); __pyx_t_10 = 0;
     __pyx_t_11 = NULL;
   } else {
-    __pyx_t_10 = -1; __pyx_t_5 = PyObject_GetIter(__pyx_v_self->td_hamiltonian); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 378, __pyx_L1_error)
+    __pyx_t_10 = -1; __pyx_t_5 = PyObject_GetIter(__pyx_v_self->td_hamiltonian); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 543, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_11 = Py_TYPE(__pyx_t_5)->tp_iternext; if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 378, __pyx_L1_error)
+    __pyx_t_11 = Py_TYPE(__pyx_t_5)->tp_iternext; if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 543, __pyx_L1_error)
   }
   for (;;) {
     if (likely(!__pyx_t_11)) {
       if (likely(PyList_CheckExact(__pyx_t_5))) {
         if (__pyx_t_10 >= PyList_GET_SIZE(__pyx_t_5)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_8 = PyList_GET_ITEM(__pyx_t_5, __pyx_t_10); __Pyx_INCREF(__pyx_t_8); __pyx_t_10++; if (unlikely(0 < 0)) __PYX_ERR(0, 378, __pyx_L1_error)
+        __pyx_t_8 = PyList_GET_ITEM(__pyx_t_5, __pyx_t_10); __Pyx_INCREF(__pyx_t_8); __pyx_t_10++; if (unlikely(0 < 0)) __PYX_ERR(0, 543, __pyx_L1_error)
         #else
-        __pyx_t_8 = PySequence_ITEM(__pyx_t_5, __pyx_t_10); __pyx_t_10++; if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 378, __pyx_L1_error)
+        __pyx_t_8 = PySequence_ITEM(__pyx_t_5, __pyx_t_10); __pyx_t_10++; if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 543, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
         #endif
       } else {
         if (__pyx_t_10 >= PyTuple_GET_SIZE(__pyx_t_5)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_8 = PyTuple_GET_ITEM(__pyx_t_5, __pyx_t_10); __Pyx_INCREF(__pyx_t_8); __pyx_t_10++; if (unlikely(0 < 0)) __PYX_ERR(0, 378, __pyx_L1_error)
+        __pyx_t_8 = PyTuple_GET_ITEM(__pyx_t_5, __pyx_t_10); __Pyx_INCREF(__pyx_t_8); __pyx_t_10++; if (unlikely(0 < 0)) __PYX_ERR(0, 543, __pyx_L1_error)
         #else
-        __pyx_t_8 = PySequence_ITEM(__pyx_t_5, __pyx_t_10); __pyx_t_10++; if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 378, __pyx_L1_error)
+        __pyx_t_8 = PySequence_ITEM(__pyx_t_5, __pyx_t_10); __pyx_t_10++; if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 543, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
         #endif
       }
     } else {
       __pyx_t_8 = __pyx_t_11(__pyx_t_5);
       if (unlikely(!__pyx_t_8)) {
         PyObject* exc_type = PyErr_Occurred();
         if (exc_type) {
           if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-          else __PYX_ERR(0, 378, __pyx_L1_error)
+          else __PYX_ERR(0, 543, __pyx_L1_error)
         }
         break;
       }
       __Pyx_GOTREF(__pyx_t_8);
     }
     if ((likely(PyTuple_CheckExact(__pyx_t_8))) || (PyList_CheckExact(__pyx_t_8))) {
       PyObject* sequence = __pyx_t_8;
       Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
       if (unlikely(size != 5)) {
         if (size > 5) __Pyx_RaiseTooManyValuesError(5);
         else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-        __PYX_ERR(0, 378, __pyx_L1_error)
+        __PYX_ERR(0, 543, __pyx_L1_error)
       }
       #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
       if (likely(PyTuple_CheckExact(sequence))) {
         __pyx_t_9 = PyTuple_GET_ITEM(sequence, 0); 
         __pyx_t_3 = PyTuple_GET_ITEM(sequence, 1); 
         __pyx_t_4 = PyTuple_GET_ITEM(sequence, 2); 
         __pyx_t_6 = PyTuple_GET_ITEM(sequence, 3); 
@@ -8094,350 +11321,350 @@
       __Pyx_INCREF(__pyx_t_6);
       __Pyx_INCREF(__pyx_t_12);
       #else
       {
         Py_ssize_t i;
         PyObject** temps[5] = {&__pyx_t_9,&__pyx_t_3,&__pyx_t_4,&__pyx_t_6,&__pyx_t_12};
         for (i=0; i < 5; i++) {
-          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 378, __pyx_L1_error)
+          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 543, __pyx_L1_error)
           __Pyx_GOTREF(item);
           *(temps[i]) = item;
         }
       }
       #endif
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     } else {
       Py_ssize_t index = -1;
       PyObject** temps[5] = {&__pyx_t_9,&__pyx_t_3,&__pyx_t_4,&__pyx_t_6,&__pyx_t_12};
-      __pyx_t_13 = PyObject_GetIter(__pyx_t_8); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 378, __pyx_L1_error)
+      __pyx_t_13 = PyObject_GetIter(__pyx_t_8); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 543, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_13);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       __pyx_t_14 = Py_TYPE(__pyx_t_13)->tp_iternext;
       for (index=0; index < 5; index++) {
         PyObject* item = __pyx_t_14(__pyx_t_13); if (unlikely(!item)) goto __pyx_L6_unpacking_failed;
         __Pyx_GOTREF(item);
         *(temps[index]) = item;
       }
-      if (__Pyx_IternextUnpackEndCheck(__pyx_t_14(__pyx_t_13), 5) < 0) __PYX_ERR(0, 378, __pyx_L1_error)
+      if (__Pyx_IternextUnpackEndCheck(__pyx_t_14(__pyx_t_13), 5) < 0) __PYX_ERR(0, 543, __pyx_L1_error)
       __pyx_t_14 = NULL;
       __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
       goto __pyx_L7_unpacking_done;
       __pyx_L6_unpacking_failed:;
       __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
       __pyx_t_14 = NULL;
       if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-      __PYX_ERR(0, 378, __pyx_L1_error)
+      __PYX_ERR(0, 543, __pyx_L1_error)
       __pyx_L7_unpacking_done:;
     }
     __Pyx_XDECREF_SET(__pyx_v_i, __pyx_t_9);
     __pyx_t_9 = 0;
     __Pyx_XDECREF_SET(__pyx_v_j, __pyx_t_3);
     __pyx_t_3 = 0;
     __Pyx_XDECREF_SET(__pyx_v__, __pyx_t_4);
     __pyx_t_4 = 0;
     __Pyx_DECREF_SET(__pyx_v__, __pyx_t_6);
     __pyx_t_6 = 0;
     __Pyx_XDECREF_SET(__pyx_v_H_0, __pyx_t_12);
     __pyx_t_12 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":379
+    /* "tkwant/onebody/kernels.pyx":544
  *         self.tparams[self.time_name] = time
  *         for i, j, _, _, H_0 in self.td_hamiltonian:
- *             mat_el = np.asarray(self.H(i, j, params=self.tparams) - H_0)             # <<<<<<<<<<<<<<
- *             for val in mat_el.flatten():
- *                 out[index] = val
+ *             H = self.H(i, j, params=self.tparams)             # <<<<<<<<<<<<<<
+ *             mat_els = np.asarray(H - H_0).flatten()
+ *             for val in mat_els:
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_12, __pyx_n_s_np); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 379, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_12);
-    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_t_12, __pyx_n_s_asarray); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 379, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
-    __pyx_t_12 = PyTuple_New(2); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 379, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_12);
+    __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 544, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
     __Pyx_INCREF(__pyx_v_i);
     __Pyx_GIVEREF(__pyx_v_i);
-    PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_v_i);
+    PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_v_i);
     __Pyx_INCREF(__pyx_v_j);
     __Pyx_GIVEREF(__pyx_v_j);
-    PyTuple_SET_ITEM(__pyx_t_12, 1, __pyx_v_j);
-    __pyx_t_4 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 379, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_params, __pyx_v_self->tparams) < 0) __PYX_ERR(0, 379, __pyx_L1_error)
-    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_v_self->H, __pyx_t_12, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 379, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
+    PyTuple_SET_ITEM(__pyx_t_8, 1, __pyx_v_j);
+    __pyx_t_12 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 544, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_12);
+    if (PyDict_SetItem(__pyx_t_12, __pyx_n_s_params, __pyx_v_self->tparams) < 0) __PYX_ERR(0, 544, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyObject_Call(__pyx_v_self->H, __pyx_t_8, __pyx_t_12); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 544, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_t_4 = PyNumber_Subtract(__pyx_t_3, __pyx_v_H_0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 379, __pyx_L1_error)
+    __Pyx_XDECREF_SET(__pyx_v_H, __pyx_t_6);
+    __pyx_t_6 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":545
+ *         for i, j, _, _, H_0 in self.td_hamiltonian:
+ *             H = self.H(i, j, params=self.tparams)
+ *             mat_els = np.asarray(H - H_0).flatten()             # <<<<<<<<<<<<<<
+ *             for val in mat_els:
+ *                 out[index] = val
+ */
+    __Pyx_GetModuleGlobalName(__pyx_t_8, __pyx_n_s_np); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 545, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_asarray); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 545, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __pyx_t_8 = PyNumber_Subtract(__pyx_v_H, __pyx_v_H_0); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 545, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
     __pyx_t_3 = NULL;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_6))) {
-      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_6);
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
+      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
       if (likely(__pyx_t_3)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
         __Pyx_INCREF(__pyx_t_3);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_6, function);
+        __Pyx_DECREF_SET(__pyx_t_4, function);
       }
     }
-    __pyx_t_8 = (__pyx_t_3) ? __Pyx_PyObject_Call2Args(__pyx_t_6, __pyx_t_3, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_4);
+    __pyx_t_12 = (__pyx_t_3) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_3, __pyx_t_8) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_8);
     __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 545, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_12);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 379, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_8);
-    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    __Pyx_XDECREF_SET(__pyx_v_mat_el, __pyx_t_8);
-    __pyx_t_8 = 0;
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_12, __pyx_n_s_flatten); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 545, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
+    __pyx_t_12 = NULL;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+      __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_4);
+      if (likely(__pyx_t_12)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+        __Pyx_INCREF(__pyx_t_12);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_4, function);
+      }
+    }
+    __pyx_t_6 = (__pyx_t_12) ? __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_12) : __Pyx_PyObject_CallNoArg(__pyx_t_4);
+    __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
+    if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 545, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_XDECREF_SET(__pyx_v_mat_els, __pyx_t_6);
+    __pyx_t_6 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":380
- *         for i, j, _, _, H_0 in self.td_hamiltonian:
- *             mat_el = np.asarray(self.H(i, j, params=self.tparams) - H_0)
- *             for val in mat_el.flatten():             # <<<<<<<<<<<<<<
+    /* "tkwant/onebody/kernels.pyx":546
+ *             H = self.H(i, j, params=self.tparams)
+ *             mat_els = np.asarray(H - H_0).flatten()
+ *             for val in mat_els:             # <<<<<<<<<<<<<<
  *                 out[index] = val
  *                 index += 1
  */
-    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_mat_el, __pyx_n_s_flatten); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 380, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_4 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_6))) {
-      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_6);
-      if (likely(__pyx_t_4)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
-        __Pyx_INCREF(__pyx_t_4);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_6, function);
-      }
-    }
-    __pyx_t_8 = (__pyx_t_4) ? __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_4) : __Pyx_PyObject_CallNoArg(__pyx_t_6);
-    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-    if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 380, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_8);
-    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    if (likely(PyList_CheckExact(__pyx_t_8)) || PyTuple_CheckExact(__pyx_t_8)) {
-      __pyx_t_6 = __pyx_t_8; __Pyx_INCREF(__pyx_t_6); __pyx_t_15 = 0;
+    if (likely(PyList_CheckExact(__pyx_v_mat_els)) || PyTuple_CheckExact(__pyx_v_mat_els)) {
+      __pyx_t_6 = __pyx_v_mat_els; __Pyx_INCREF(__pyx_t_6); __pyx_t_15 = 0;
       __pyx_t_16 = NULL;
     } else {
-      __pyx_t_15 = -1; __pyx_t_6 = PyObject_GetIter(__pyx_t_8); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 380, __pyx_L1_error)
+      __pyx_t_15 = -1; __pyx_t_6 = PyObject_GetIter(__pyx_v_mat_els); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 546, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
-      __pyx_t_16 = Py_TYPE(__pyx_t_6)->tp_iternext; if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 380, __pyx_L1_error)
+      __pyx_t_16 = Py_TYPE(__pyx_t_6)->tp_iternext; if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 546, __pyx_L1_error)
     }
-    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     for (;;) {
       if (likely(!__pyx_t_16)) {
         if (likely(PyList_CheckExact(__pyx_t_6))) {
           if (__pyx_t_15 >= PyList_GET_SIZE(__pyx_t_6)) break;
           #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-          __pyx_t_8 = PyList_GET_ITEM(__pyx_t_6, __pyx_t_15); __Pyx_INCREF(__pyx_t_8); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 380, __pyx_L1_error)
+          __pyx_t_4 = PyList_GET_ITEM(__pyx_t_6, __pyx_t_15); __Pyx_INCREF(__pyx_t_4); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 546, __pyx_L1_error)
           #else
-          __pyx_t_8 = PySequence_ITEM(__pyx_t_6, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 380, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_8);
+          __pyx_t_4 = PySequence_ITEM(__pyx_t_6, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 546, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_4);
           #endif
         } else {
           if (__pyx_t_15 >= PyTuple_GET_SIZE(__pyx_t_6)) break;
           #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-          __pyx_t_8 = PyTuple_GET_ITEM(__pyx_t_6, __pyx_t_15); __Pyx_INCREF(__pyx_t_8); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 380, __pyx_L1_error)
+          __pyx_t_4 = PyTuple_GET_ITEM(__pyx_t_6, __pyx_t_15); __Pyx_INCREF(__pyx_t_4); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 546, __pyx_L1_error)
           #else
-          __pyx_t_8 = PySequence_ITEM(__pyx_t_6, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 380, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_8);
+          __pyx_t_4 = PySequence_ITEM(__pyx_t_6, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 546, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_4);
           #endif
         }
       } else {
-        __pyx_t_8 = __pyx_t_16(__pyx_t_6);
-        if (unlikely(!__pyx_t_8)) {
+        __pyx_t_4 = __pyx_t_16(__pyx_t_6);
+        if (unlikely(!__pyx_t_4)) {
           PyObject* exc_type = PyErr_Occurred();
           if (exc_type) {
             if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-            else __PYX_ERR(0, 380, __pyx_L1_error)
+            else __PYX_ERR(0, 546, __pyx_L1_error)
           }
           break;
         }
-        __Pyx_GOTREF(__pyx_t_8);
+        __Pyx_GOTREF(__pyx_t_4);
       }
-      __Pyx_XDECREF_SET(__pyx_v_val, __pyx_t_8);
-      __pyx_t_8 = 0;
+      __Pyx_XDECREF_SET(__pyx_v_val, __pyx_t_4);
+      __pyx_t_4 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":381
- *             mat_el = np.asarray(self.H(i, j, params=self.tparams) - H_0)
- *             for val in mat_el.flatten():
+      /* "tkwant/onebody/kernels.pyx":547
+ *             mat_els = np.asarray(H - H_0).flatten()
+ *             for val in mat_els:
  *                 out[index] = val             # <<<<<<<<<<<<<<
  *                 index += 1
  *             if i != j:
  */
-      if (unlikely(PyObject_SetItem(__pyx_v_out, __pyx_v_index, __pyx_v_val) < 0)) __PYX_ERR(0, 381, __pyx_L1_error)
+      if (unlikely(PyObject_SetItem(__pyx_v_out, __pyx_v_index, __pyx_v_val) < 0)) __PYX_ERR(0, 547, __pyx_L1_error)
 
-      /* "tkwant/onebody/kernels.pyx":382
- *             for val in mat_el.flatten():
+      /* "tkwant/onebody/kernels.pyx":548
+ *             for val in mat_els:
  *                 out[index] = val
  *                 index += 1             # <<<<<<<<<<<<<<
  *             if i != j:
- *                 for val in _herm_conj(mat_el).flatten():
+ *                 mat_els = mat_els.conjugate()
  */
-      __pyx_t_8 = __Pyx_PyInt_AddObjC(__pyx_v_index, __pyx_int_1, 1, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 382, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_8);
-      __Pyx_DECREF_SET(__pyx_v_index, __pyx_t_8);
-      __pyx_t_8 = 0;
+      __pyx_t_4 = __Pyx_PyInt_AddObjC(__pyx_v_index, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 548, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF_SET(__pyx_v_index, __pyx_t_4);
+      __pyx_t_4 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":380
- *         for i, j, _, _, H_0 in self.td_hamiltonian:
- *             mat_el = np.asarray(self.H(i, j, params=self.tparams) - H_0)
- *             for val in mat_el.flatten():             # <<<<<<<<<<<<<<
+      /* "tkwant/onebody/kernels.pyx":546
+ *             H = self.H(i, j, params=self.tparams)
+ *             mat_els = np.asarray(H - H_0).flatten()
+ *             for val in mat_els:             # <<<<<<<<<<<<<<
  *                 out[index] = val
  *                 index += 1
  */
     }
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":383
+    /* "tkwant/onebody/kernels.pyx":549
  *                 out[index] = val
  *                 index += 1
  *             if i != j:             # <<<<<<<<<<<<<<
- *                 for val in _herm_conj(mat_el).flatten():
- *                     out[index] = val
+ *                 mat_els = mat_els.conjugate()
+ *                 for val in mat_els:
  */
-    __pyx_t_6 = PyObject_RichCompare(__pyx_v_i, __pyx_v_j, Py_NE); __Pyx_XGOTREF(__pyx_t_6); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 383, __pyx_L1_error)
-    __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_6); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 383, __pyx_L1_error)
+    __pyx_t_6 = PyObject_RichCompare(__pyx_v_i, __pyx_v_j, Py_NE); __Pyx_XGOTREF(__pyx_t_6); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 549, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_6); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 549, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     if (__pyx_t_2) {
 
-      /* "tkwant/onebody/kernels.pyx":384
+      /* "tkwant/onebody/kernels.pyx":550
  *                 index += 1
  *             if i != j:
- *                 for val in _herm_conj(mat_el).flatten():             # <<<<<<<<<<<<<<
+ *                 mat_els = mat_els.conjugate()             # <<<<<<<<<<<<<<
+ *                 for val in mat_els:
  *                     out[index] = val
- *                     index += 1
  */
-      __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_herm_conj); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 384, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_mat_els, __pyx_n_s_conjugate); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 550, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
-      __pyx_t_3 = NULL;
-      if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
-        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
-        if (likely(__pyx_t_3)) {
-          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-          __Pyx_INCREF(__pyx_t_3);
-          __Pyx_INCREF(function);
-          __Pyx_DECREF_SET(__pyx_t_4, function);
-        }
-      }
-      __pyx_t_8 = (__pyx_t_3) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_3, __pyx_v_mat_el) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_v_mat_el);
-      __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-      if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 384, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_8);
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_flatten); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 384, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __pyx_t_8 = NULL;
+      __pyx_t_12 = NULL;
       if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-        __pyx_t_8 = PyMethod_GET_SELF(__pyx_t_4);
-        if (likely(__pyx_t_8)) {
+        __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_4);
+        if (likely(__pyx_t_12)) {
           PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-          __Pyx_INCREF(__pyx_t_8);
+          __Pyx_INCREF(__pyx_t_12);
           __Pyx_INCREF(function);
           __Pyx_DECREF_SET(__pyx_t_4, function);
         }
       }
-      __pyx_t_6 = (__pyx_t_8) ? __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_8) : __Pyx_PyObject_CallNoArg(__pyx_t_4);
-      __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
-      if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 384, __pyx_L1_error)
+      __pyx_t_6 = (__pyx_t_12) ? __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_12) : __Pyx_PyObject_CallNoArg(__pyx_t_4);
+      __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
+      if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 550, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      if (likely(PyList_CheckExact(__pyx_t_6)) || PyTuple_CheckExact(__pyx_t_6)) {
-        __pyx_t_4 = __pyx_t_6; __Pyx_INCREF(__pyx_t_4); __pyx_t_15 = 0;
+      __Pyx_DECREF_SET(__pyx_v_mat_els, __pyx_t_6);
+      __pyx_t_6 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":551
+ *             if i != j:
+ *                 mat_els = mat_els.conjugate()
+ *                 for val in mat_els:             # <<<<<<<<<<<<<<
+ *                     out[index] = val
+ *                     index += 1
+ */
+      if (likely(PyList_CheckExact(__pyx_v_mat_els)) || PyTuple_CheckExact(__pyx_v_mat_els)) {
+        __pyx_t_6 = __pyx_v_mat_els; __Pyx_INCREF(__pyx_t_6); __pyx_t_15 = 0;
         __pyx_t_16 = NULL;
       } else {
-        __pyx_t_15 = -1; __pyx_t_4 = PyObject_GetIter(__pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 384, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __pyx_t_16 = Py_TYPE(__pyx_t_4)->tp_iternext; if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 384, __pyx_L1_error)
+        __pyx_t_15 = -1; __pyx_t_6 = PyObject_GetIter(__pyx_v_mat_els); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 551, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_6);
+        __pyx_t_16 = Py_TYPE(__pyx_t_6)->tp_iternext; if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 551, __pyx_L1_error)
       }
-      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
       for (;;) {
         if (likely(!__pyx_t_16)) {
-          if (likely(PyList_CheckExact(__pyx_t_4))) {
-            if (__pyx_t_15 >= PyList_GET_SIZE(__pyx_t_4)) break;
+          if (likely(PyList_CheckExact(__pyx_t_6))) {
+            if (__pyx_t_15 >= PyList_GET_SIZE(__pyx_t_6)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_6 = PyList_GET_ITEM(__pyx_t_4, __pyx_t_15); __Pyx_INCREF(__pyx_t_6); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 384, __pyx_L1_error)
+            __pyx_t_4 = PyList_GET_ITEM(__pyx_t_6, __pyx_t_15); __Pyx_INCREF(__pyx_t_4); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 551, __pyx_L1_error)
             #else
-            __pyx_t_6 = PySequence_ITEM(__pyx_t_4, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 384, __pyx_L1_error)
-            __Pyx_GOTREF(__pyx_t_6);
+            __pyx_t_4 = PySequence_ITEM(__pyx_t_6, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 551, __pyx_L1_error)
+            __Pyx_GOTREF(__pyx_t_4);
             #endif
           } else {
-            if (__pyx_t_15 >= PyTuple_GET_SIZE(__pyx_t_4)) break;
+            if (__pyx_t_15 >= PyTuple_GET_SIZE(__pyx_t_6)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_6 = PyTuple_GET_ITEM(__pyx_t_4, __pyx_t_15); __Pyx_INCREF(__pyx_t_6); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 384, __pyx_L1_error)
+            __pyx_t_4 = PyTuple_GET_ITEM(__pyx_t_6, __pyx_t_15); __Pyx_INCREF(__pyx_t_4); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 551, __pyx_L1_error)
             #else
-            __pyx_t_6 = PySequence_ITEM(__pyx_t_4, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 384, __pyx_L1_error)
-            __Pyx_GOTREF(__pyx_t_6);
+            __pyx_t_4 = PySequence_ITEM(__pyx_t_6, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 551, __pyx_L1_error)
+            __Pyx_GOTREF(__pyx_t_4);
             #endif
           }
         } else {
-          __pyx_t_6 = __pyx_t_16(__pyx_t_4);
-          if (unlikely(!__pyx_t_6)) {
+          __pyx_t_4 = __pyx_t_16(__pyx_t_6);
+          if (unlikely(!__pyx_t_4)) {
             PyObject* exc_type = PyErr_Occurred();
             if (exc_type) {
               if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-              else __PYX_ERR(0, 384, __pyx_L1_error)
+              else __PYX_ERR(0, 551, __pyx_L1_error)
             }
             break;
           }
-          __Pyx_GOTREF(__pyx_t_6);
+          __Pyx_GOTREF(__pyx_t_4);
         }
-        __Pyx_XDECREF_SET(__pyx_v_val, __pyx_t_6);
-        __pyx_t_6 = 0;
+        __Pyx_XDECREF_SET(__pyx_v_val, __pyx_t_4);
+        __pyx_t_4 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":385
- *             if i != j:
- *                 for val in _herm_conj(mat_el).flatten():
+        /* "tkwant/onebody/kernels.pyx":552
+ *                 mat_els = mat_els.conjugate()
+ *                 for val in mat_els:
  *                     out[index] = val             # <<<<<<<<<<<<<<
  *                     index += 1
  *         return out if do_return else None
  */
-        if (unlikely(PyObject_SetItem(__pyx_v_out, __pyx_v_index, __pyx_v_val) < 0)) __PYX_ERR(0, 385, __pyx_L1_error)
+        if (unlikely(PyObject_SetItem(__pyx_v_out, __pyx_v_index, __pyx_v_val) < 0)) __PYX_ERR(0, 552, __pyx_L1_error)
 
-        /* "tkwant/onebody/kernels.pyx":386
- *                 for val in _herm_conj(mat_el).flatten():
+        /* "tkwant/onebody/kernels.pyx":553
+ *                 for val in mat_els:
  *                     out[index] = val
  *                     index += 1             # <<<<<<<<<<<<<<
  *         return out if do_return else None
  * 
  */
-        __pyx_t_6 = __Pyx_PyInt_AddObjC(__pyx_v_index, __pyx_int_1, 1, 1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 386, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __Pyx_DECREF_SET(__pyx_v_index, __pyx_t_6);
-        __pyx_t_6 = 0;
+        __pyx_t_4 = __Pyx_PyInt_AddObjC(__pyx_v_index, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 553, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_4);
+        __Pyx_DECREF_SET(__pyx_v_index, __pyx_t_4);
+        __pyx_t_4 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":384
- *                 index += 1
+        /* "tkwant/onebody/kernels.pyx":551
  *             if i != j:
- *                 for val in _herm_conj(mat_el).flatten():             # <<<<<<<<<<<<<<
+ *                 mat_els = mat_els.conjugate()
+ *                 for val in mat_els:             # <<<<<<<<<<<<<<
  *                     out[index] = val
  *                     index += 1
  */
       }
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":383
+      /* "tkwant/onebody/kernels.pyx":549
  *                 out[index] = val
  *                 index += 1
  *             if i != j:             # <<<<<<<<<<<<<<
- *                 for val in _herm_conj(mat_el).flatten():
- *                     out[index] = val
+ *                 mat_els = mat_els.conjugate()
+ *                 for val in mat_els:
  */
     }
 
-    /* "tkwant/onebody/kernels.pyx":378
+    /* "tkwant/onebody/kernels.pyx":543
  *         index = 0
  *         self.tparams[self.time_name] = time
  *         for i, j, _, _, H_0 in self.td_hamiltonian:             # <<<<<<<<<<<<<<
- *             mat_el = np.asarray(self.H(i, j, params=self.tparams) - H_0)
- *             for val in mat_el.flatten():
+ *             H = self.H(i, j, params=self.tparams)
+ *             mat_els = np.asarray(H - H_0).flatten()
  */
   }
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":387
+  /* "tkwant/onebody/kernels.pyx":554
  *                     out[index] = val
  *                     index += 1
  *         return out if do_return else None             # <<<<<<<<<<<<<<
  * 
  *     def row_col(self):
  */
   __Pyx_XDECREF(__pyx_r);
@@ -8448,15 +11675,15 @@
     __Pyx_INCREF(Py_None);
     __pyx_t_5 = Py_None;
   }
   __pyx_r = __pyx_t_5;
   __pyx_t_5 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":352
+  /* "tkwant/onebody/kernels.pyx":517
  *         return self.nnz
  * 
  *     def data(self, double time, object out=None):             # <<<<<<<<<<<<<<
  *         '''Return the time-dependent matrix elements.
  * 
  */
 
@@ -8474,23 +11701,24 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v_index);
   __Pyx_XDECREF(__pyx_v_i);
   __Pyx_XDECREF(__pyx_v_j);
   __Pyx_XDECREF(__pyx_v__);
   __Pyx_XDECREF(__pyx_v_H_0);
-  __Pyx_XDECREF(__pyx_v_mat_el);
+  __Pyx_XDECREF(__pyx_v_H);
+  __Pyx_XDECREF(__pyx_v_mat_els);
   __Pyx_XDECREF(__pyx_v_val);
   __Pyx_XDECREF(__pyx_v_out);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":389
+/* "tkwant/onebody/kernels.pyx":556
  *         return out if do_return else None
  * 
  *     def row_col(self):             # <<<<<<<<<<<<<<
  *         '''Return the row and column vectors of the W(t) matrix.
  * 
  */
 
@@ -8534,33 +11762,36 @@
   PyObject *__pyx_t_11 = NULL;
   PyObject *(*__pyx_t_12)(PyObject *);
   Py_ssize_t __pyx_t_13;
   PyObject *(*__pyx_t_14)(PyObject *);
   Py_ssize_t __pyx_t_15;
   PyObject *(*__pyx_t_16)(PyObject *);
   int __pyx_t_17;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("row_col", 0);
 
-  /* "tkwant/onebody/kernels.pyx":399
+  /* "tkwant/onebody/kernels.pyx":566
  *             Column vector of the W(t) matrix in coo format.
  *         '''
  *         row = np.empty(self.nnz, np.int32)             # <<<<<<<<<<<<<<
  *         col = np.empty(self.nnz, np.int32)
  *         index = 0
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 399, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 566, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_empty); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 399, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_empty); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 566, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 399, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 566, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 399, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 566, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_int32); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 399, __pyx_L1_error)
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_int32); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 566, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   __pyx_t_4 = NULL;
   __pyx_t_6 = 0;
   if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
     __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
     if (likely(__pyx_t_4)) {
@@ -8570,68 +11801,68 @@
       __Pyx_DECREF_SET(__pyx_t_3, function);
       __pyx_t_6 = 1;
     }
   }
   #if CYTHON_FAST_PYCALL
   if (PyFunction_Check(__pyx_t_3)) {
     PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_2, __pyx_t_5};
-    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 399, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 566, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
   } else
   #endif
   #if CYTHON_FAST_PYCCALL
   if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
     PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_2, __pyx_t_5};
-    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 399, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 566, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
   } else
   #endif
   {
-    __pyx_t_7 = PyTuple_New(2+__pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 399, __pyx_L1_error)
+    __pyx_t_7 = PyTuple_New(2+__pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 566, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     if (__pyx_t_4) {
       __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_4); __pyx_t_4 = NULL;
     }
     __Pyx_GIVEREF(__pyx_t_2);
     PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_6, __pyx_t_2);
     __Pyx_GIVEREF(__pyx_t_5);
     PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_6, __pyx_t_5);
     __pyx_t_2 = 0;
     __pyx_t_5 = 0;
-    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 399, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 566, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
   }
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __pyx_v_row = __pyx_t_1;
   __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":400
+  /* "tkwant/onebody/kernels.pyx":567
  *         '''
  *         row = np.empty(self.nnz, np.int32)
  *         col = np.empty(self.nnz, np.int32)             # <<<<<<<<<<<<<<
  *         index = 0
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 400, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 567, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_empty); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 400, __pyx_L1_error)
+  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_empty); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 567, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_7);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 400, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 567, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 400, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 567, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_int32); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 400, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_int32); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 567, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
   __pyx_t_5 = NULL;
   __pyx_t_6 = 0;
   if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_7))) {
     __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_7);
     if (likely(__pyx_t_5)) {
@@ -8641,114 +11872,114 @@
       __Pyx_DECREF_SET(__pyx_t_7, function);
       __pyx_t_6 = 1;
     }
   }
   #if CYTHON_FAST_PYCALL
   if (PyFunction_Check(__pyx_t_7)) {
     PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_3, __pyx_t_2};
-    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 400, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 567, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   } else
   #endif
   #if CYTHON_FAST_PYCCALL
   if (__Pyx_PyFastCFunction_Check(__pyx_t_7)) {
     PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_3, __pyx_t_2};
-    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 400, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 567, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   } else
   #endif
   {
-    __pyx_t_4 = PyTuple_New(2+__pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 400, __pyx_L1_error)
+    __pyx_t_4 = PyTuple_New(2+__pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 567, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     if (__pyx_t_5) {
       __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_5); __pyx_t_5 = NULL;
     }
     __Pyx_GIVEREF(__pyx_t_3);
     PyTuple_SET_ITEM(__pyx_t_4, 0+__pyx_t_6, __pyx_t_3);
     __Pyx_GIVEREF(__pyx_t_2);
     PyTuple_SET_ITEM(__pyx_t_4, 1+__pyx_t_6, __pyx_t_2);
     __pyx_t_3 = 0;
     __pyx_t_2 = 0;
-    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 400, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_4, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 567, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   }
   __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
   __pyx_v_col = __pyx_t_1;
   __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":401
+  /* "tkwant/onebody/kernels.pyx":568
  *         row = np.empty(self.nnz, np.int32)
  *         col = np.empty(self.nnz, np.int32)
  *         index = 0             # <<<<<<<<<<<<<<
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:
  *             to = range(*to)
  */
   __Pyx_INCREF(__pyx_int_0);
   __pyx_v_index = __pyx_int_0;
 
-  /* "tkwant/onebody/kernels.pyx":402
+  /* "tkwant/onebody/kernels.pyx":569
  *         col = np.empty(self.nnz, np.int32)
  *         index = 0
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:             # <<<<<<<<<<<<<<
  *             to = range(*to)
  *             frm = range(*frm)
  */
   if (likely(PyList_CheckExact(__pyx_v_self->td_hamiltonian)) || PyTuple_CheckExact(__pyx_v_self->td_hamiltonian)) {
     __pyx_t_1 = __pyx_v_self->td_hamiltonian; __Pyx_INCREF(__pyx_t_1); __pyx_t_8 = 0;
     __pyx_t_9 = NULL;
   } else {
-    __pyx_t_8 = -1; __pyx_t_1 = PyObject_GetIter(__pyx_v_self->td_hamiltonian); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 402, __pyx_L1_error)
+    __pyx_t_8 = -1; __pyx_t_1 = PyObject_GetIter(__pyx_v_self->td_hamiltonian); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 569, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_9 = Py_TYPE(__pyx_t_1)->tp_iternext; if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 402, __pyx_L1_error)
+    __pyx_t_9 = Py_TYPE(__pyx_t_1)->tp_iternext; if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 569, __pyx_L1_error)
   }
   for (;;) {
     if (likely(!__pyx_t_9)) {
       if (likely(PyList_CheckExact(__pyx_t_1))) {
         if (__pyx_t_8 >= PyList_GET_SIZE(__pyx_t_1)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_7 = PyList_GET_ITEM(__pyx_t_1, __pyx_t_8); __Pyx_INCREF(__pyx_t_7); __pyx_t_8++; if (unlikely(0 < 0)) __PYX_ERR(0, 402, __pyx_L1_error)
+        __pyx_t_7 = PyList_GET_ITEM(__pyx_t_1, __pyx_t_8); __Pyx_INCREF(__pyx_t_7); __pyx_t_8++; if (unlikely(0 < 0)) __PYX_ERR(0, 569, __pyx_L1_error)
         #else
-        __pyx_t_7 = PySequence_ITEM(__pyx_t_1, __pyx_t_8); __pyx_t_8++; if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 402, __pyx_L1_error)
+        __pyx_t_7 = PySequence_ITEM(__pyx_t_1, __pyx_t_8); __pyx_t_8++; if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 569, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
         #endif
       } else {
         if (__pyx_t_8 >= PyTuple_GET_SIZE(__pyx_t_1)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_7 = PyTuple_GET_ITEM(__pyx_t_1, __pyx_t_8); __Pyx_INCREF(__pyx_t_7); __pyx_t_8++; if (unlikely(0 < 0)) __PYX_ERR(0, 402, __pyx_L1_error)
+        __pyx_t_7 = PyTuple_GET_ITEM(__pyx_t_1, __pyx_t_8); __Pyx_INCREF(__pyx_t_7); __pyx_t_8++; if (unlikely(0 < 0)) __PYX_ERR(0, 569, __pyx_L1_error)
         #else
-        __pyx_t_7 = PySequence_ITEM(__pyx_t_1, __pyx_t_8); __pyx_t_8++; if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 402, __pyx_L1_error)
+        __pyx_t_7 = PySequence_ITEM(__pyx_t_1, __pyx_t_8); __pyx_t_8++; if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 569, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
         #endif
       }
     } else {
       __pyx_t_7 = __pyx_t_9(__pyx_t_1);
       if (unlikely(!__pyx_t_7)) {
         PyObject* exc_type = PyErr_Occurred();
         if (exc_type) {
           if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-          else __PYX_ERR(0, 402, __pyx_L1_error)
+          else __PYX_ERR(0, 569, __pyx_L1_error)
         }
         break;
       }
       __Pyx_GOTREF(__pyx_t_7);
     }
     if ((likely(PyTuple_CheckExact(__pyx_t_7))) || (PyList_CheckExact(__pyx_t_7))) {
       PyObject* sequence = __pyx_t_7;
       Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
       if (unlikely(size != 5)) {
         if (size > 5) __Pyx_RaiseTooManyValuesError(5);
         else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-        __PYX_ERR(0, 402, __pyx_L1_error)
+        __PYX_ERR(0, 569, __pyx_L1_error)
       }
       #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
       if (likely(PyTuple_CheckExact(sequence))) {
         __pyx_t_4 = PyTuple_GET_ITEM(sequence, 0); 
         __pyx_t_2 = PyTuple_GET_ITEM(sequence, 1); 
         __pyx_t_3 = PyTuple_GET_ITEM(sequence, 2); 
         __pyx_t_5 = PyTuple_GET_ITEM(sequence, 3); 
@@ -8766,433 +11997,433 @@
       __Pyx_INCREF(__pyx_t_5);
       __Pyx_INCREF(__pyx_t_10);
       #else
       {
         Py_ssize_t i;
         PyObject** temps[5] = {&__pyx_t_4,&__pyx_t_2,&__pyx_t_3,&__pyx_t_5,&__pyx_t_10};
         for (i=0; i < 5; i++) {
-          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 402, __pyx_L1_error)
+          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 569, __pyx_L1_error)
           __Pyx_GOTREF(item);
           *(temps[i]) = item;
         }
       }
       #endif
       __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
     } else {
       Py_ssize_t index = -1;
       PyObject** temps[5] = {&__pyx_t_4,&__pyx_t_2,&__pyx_t_3,&__pyx_t_5,&__pyx_t_10};
-      __pyx_t_11 = PyObject_GetIter(__pyx_t_7); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 402, __pyx_L1_error)
+      __pyx_t_11 = PyObject_GetIter(__pyx_t_7); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 569, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_11);
       __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
       __pyx_t_12 = Py_TYPE(__pyx_t_11)->tp_iternext;
       for (index=0; index < 5; index++) {
         PyObject* item = __pyx_t_12(__pyx_t_11); if (unlikely(!item)) goto __pyx_L5_unpacking_failed;
         __Pyx_GOTREF(item);
         *(temps[index]) = item;
       }
-      if (__Pyx_IternextUnpackEndCheck(__pyx_t_12(__pyx_t_11), 5) < 0) __PYX_ERR(0, 402, __pyx_L1_error)
+      if (__Pyx_IternextUnpackEndCheck(__pyx_t_12(__pyx_t_11), 5) < 0) __PYX_ERR(0, 569, __pyx_L1_error)
       __pyx_t_12 = NULL;
       __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
       goto __pyx_L6_unpacking_done;
       __pyx_L5_unpacking_failed:;
       __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
       __pyx_t_12 = NULL;
       if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-      __PYX_ERR(0, 402, __pyx_L1_error)
+      __PYX_ERR(0, 569, __pyx_L1_error)
       __pyx_L6_unpacking_done:;
     }
     __Pyx_XDECREF_SET(__pyx_v_i, __pyx_t_4);
     __pyx_t_4 = 0;
     __Pyx_XDECREF_SET(__pyx_v_j, __pyx_t_2);
     __pyx_t_2 = 0;
     __Pyx_XDECREF_SET(__pyx_v_to, __pyx_t_3);
     __pyx_t_3 = 0;
     __Pyx_XDECREF_SET(__pyx_v_frm, __pyx_t_5);
     __pyx_t_5 = 0;
     __Pyx_XDECREF_SET(__pyx_v_H_0, __pyx_t_10);
     __pyx_t_10 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":403
+    /* "tkwant/onebody/kernels.pyx":570
  *         index = 0
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:
  *             to = range(*to)             # <<<<<<<<<<<<<<
  *             frm = range(*frm)
  *             for k in to:
  */
-    __pyx_t_7 = __Pyx_PySequence_Tuple(__pyx_v_to); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 403, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PySequence_Tuple(__pyx_v_to); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 570, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_10 = __Pyx_PyObject_Call(__pyx_builtin_range, __pyx_t_7, NULL); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 403, __pyx_L1_error)
+    __pyx_t_10 = __Pyx_PyObject_Call(__pyx_builtin_range, __pyx_t_7, NULL); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 570, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_10);
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
     __Pyx_DECREF_SET(__pyx_v_to, __pyx_t_10);
     __pyx_t_10 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":404
+    /* "tkwant/onebody/kernels.pyx":571
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:
  *             to = range(*to)
  *             frm = range(*frm)             # <<<<<<<<<<<<<<
  *             for k in to:
  *                 for l in frm:
  */
-    __pyx_t_10 = __Pyx_PySequence_Tuple(__pyx_v_frm); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 404, __pyx_L1_error)
+    __pyx_t_10 = __Pyx_PySequence_Tuple(__pyx_v_frm); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 571, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_builtin_range, __pyx_t_10, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 404, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_builtin_range, __pyx_t_10, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 571, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
     __Pyx_DECREF_SET(__pyx_v_frm, __pyx_t_7);
     __pyx_t_7 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":405
+    /* "tkwant/onebody/kernels.pyx":572
  *             to = range(*to)
  *             frm = range(*frm)
  *             for k in to:             # <<<<<<<<<<<<<<
  *                 for l in frm:
  *                     row[index] = k
  */
     if (likely(PyList_CheckExact(__pyx_v_to)) || PyTuple_CheckExact(__pyx_v_to)) {
       __pyx_t_7 = __pyx_v_to; __Pyx_INCREF(__pyx_t_7); __pyx_t_13 = 0;
       __pyx_t_14 = NULL;
     } else {
-      __pyx_t_13 = -1; __pyx_t_7 = PyObject_GetIter(__pyx_v_to); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 405, __pyx_L1_error)
+      __pyx_t_13 = -1; __pyx_t_7 = PyObject_GetIter(__pyx_v_to); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 572, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_7);
-      __pyx_t_14 = Py_TYPE(__pyx_t_7)->tp_iternext; if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 405, __pyx_L1_error)
+      __pyx_t_14 = Py_TYPE(__pyx_t_7)->tp_iternext; if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 572, __pyx_L1_error)
     }
     for (;;) {
       if (likely(!__pyx_t_14)) {
         if (likely(PyList_CheckExact(__pyx_t_7))) {
           if (__pyx_t_13 >= PyList_GET_SIZE(__pyx_t_7)) break;
           #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-          __pyx_t_10 = PyList_GET_ITEM(__pyx_t_7, __pyx_t_13); __Pyx_INCREF(__pyx_t_10); __pyx_t_13++; if (unlikely(0 < 0)) __PYX_ERR(0, 405, __pyx_L1_error)
+          __pyx_t_10 = PyList_GET_ITEM(__pyx_t_7, __pyx_t_13); __Pyx_INCREF(__pyx_t_10); __pyx_t_13++; if (unlikely(0 < 0)) __PYX_ERR(0, 572, __pyx_L1_error)
           #else
-          __pyx_t_10 = PySequence_ITEM(__pyx_t_7, __pyx_t_13); __pyx_t_13++; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 405, __pyx_L1_error)
+          __pyx_t_10 = PySequence_ITEM(__pyx_t_7, __pyx_t_13); __pyx_t_13++; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 572, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_10);
           #endif
         } else {
           if (__pyx_t_13 >= PyTuple_GET_SIZE(__pyx_t_7)) break;
           #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-          __pyx_t_10 = PyTuple_GET_ITEM(__pyx_t_7, __pyx_t_13); __Pyx_INCREF(__pyx_t_10); __pyx_t_13++; if (unlikely(0 < 0)) __PYX_ERR(0, 405, __pyx_L1_error)
+          __pyx_t_10 = PyTuple_GET_ITEM(__pyx_t_7, __pyx_t_13); __Pyx_INCREF(__pyx_t_10); __pyx_t_13++; if (unlikely(0 < 0)) __PYX_ERR(0, 572, __pyx_L1_error)
           #else
-          __pyx_t_10 = PySequence_ITEM(__pyx_t_7, __pyx_t_13); __pyx_t_13++; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 405, __pyx_L1_error)
+          __pyx_t_10 = PySequence_ITEM(__pyx_t_7, __pyx_t_13); __pyx_t_13++; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 572, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_10);
           #endif
         }
       } else {
         __pyx_t_10 = __pyx_t_14(__pyx_t_7);
         if (unlikely(!__pyx_t_10)) {
           PyObject* exc_type = PyErr_Occurred();
           if (exc_type) {
             if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-            else __PYX_ERR(0, 405, __pyx_L1_error)
+            else __PYX_ERR(0, 572, __pyx_L1_error)
           }
           break;
         }
         __Pyx_GOTREF(__pyx_t_10);
       }
       __Pyx_XDECREF_SET(__pyx_v_k, __pyx_t_10);
       __pyx_t_10 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":406
+      /* "tkwant/onebody/kernels.pyx":573
  *             frm = range(*frm)
  *             for k in to:
  *                 for l in frm:             # <<<<<<<<<<<<<<
  *                     row[index] = k
  *                     col[index] = l
  */
       if (likely(PyList_CheckExact(__pyx_v_frm)) || PyTuple_CheckExact(__pyx_v_frm)) {
         __pyx_t_10 = __pyx_v_frm; __Pyx_INCREF(__pyx_t_10); __pyx_t_15 = 0;
         __pyx_t_16 = NULL;
       } else {
-        __pyx_t_15 = -1; __pyx_t_10 = PyObject_GetIter(__pyx_v_frm); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 406, __pyx_L1_error)
+        __pyx_t_15 = -1; __pyx_t_10 = PyObject_GetIter(__pyx_v_frm); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 573, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_10);
-        __pyx_t_16 = Py_TYPE(__pyx_t_10)->tp_iternext; if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 406, __pyx_L1_error)
+        __pyx_t_16 = Py_TYPE(__pyx_t_10)->tp_iternext; if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 573, __pyx_L1_error)
       }
       for (;;) {
         if (likely(!__pyx_t_16)) {
           if (likely(PyList_CheckExact(__pyx_t_10))) {
             if (__pyx_t_15 >= PyList_GET_SIZE(__pyx_t_10)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_5 = PyList_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_5); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 406, __pyx_L1_error)
+            __pyx_t_5 = PyList_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_5); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 573, __pyx_L1_error)
             #else
-            __pyx_t_5 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 406, __pyx_L1_error)
+            __pyx_t_5 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 573, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_5);
             #endif
           } else {
             if (__pyx_t_15 >= PyTuple_GET_SIZE(__pyx_t_10)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_5); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 406, __pyx_L1_error)
+            __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_5); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 573, __pyx_L1_error)
             #else
-            __pyx_t_5 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 406, __pyx_L1_error)
+            __pyx_t_5 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 573, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_5);
             #endif
           }
         } else {
           __pyx_t_5 = __pyx_t_16(__pyx_t_10);
           if (unlikely(!__pyx_t_5)) {
             PyObject* exc_type = PyErr_Occurred();
             if (exc_type) {
               if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-              else __PYX_ERR(0, 406, __pyx_L1_error)
+              else __PYX_ERR(0, 573, __pyx_L1_error)
             }
             break;
           }
           __Pyx_GOTREF(__pyx_t_5);
         }
         __Pyx_XDECREF_SET(__pyx_v_l, __pyx_t_5);
         __pyx_t_5 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":407
+        /* "tkwant/onebody/kernels.pyx":574
  *             for k in to:
  *                 for l in frm:
  *                     row[index] = k             # <<<<<<<<<<<<<<
  *                     col[index] = l
  *                     index += 1
  */
-        if (unlikely(PyObject_SetItem(__pyx_v_row, __pyx_v_index, __pyx_v_k) < 0)) __PYX_ERR(0, 407, __pyx_L1_error)
+        if (unlikely(PyObject_SetItem(__pyx_v_row, __pyx_v_index, __pyx_v_k) < 0)) __PYX_ERR(0, 574, __pyx_L1_error)
 
-        /* "tkwant/onebody/kernels.pyx":408
+        /* "tkwant/onebody/kernels.pyx":575
  *                 for l in frm:
  *                     row[index] = k
  *                     col[index] = l             # <<<<<<<<<<<<<<
  *                     index += 1
  *             if i != j:
  */
-        if (unlikely(PyObject_SetItem(__pyx_v_col, __pyx_v_index, __pyx_v_l) < 0)) __PYX_ERR(0, 408, __pyx_L1_error)
+        if (unlikely(PyObject_SetItem(__pyx_v_col, __pyx_v_index, __pyx_v_l) < 0)) __PYX_ERR(0, 575, __pyx_L1_error)
 
-        /* "tkwant/onebody/kernels.pyx":409
+        /* "tkwant/onebody/kernels.pyx":576
  *                     row[index] = k
  *                     col[index] = l
  *                     index += 1             # <<<<<<<<<<<<<<
  *             if i != j:
  *                 for k in to:
  */
-        __pyx_t_5 = __Pyx_PyInt_AddObjC(__pyx_v_index, __pyx_int_1, 1, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 409, __pyx_L1_error)
+        __pyx_t_5 = __Pyx_PyInt_AddObjC(__pyx_v_index, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 576, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         __Pyx_DECREF_SET(__pyx_v_index, __pyx_t_5);
         __pyx_t_5 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":406
+        /* "tkwant/onebody/kernels.pyx":573
  *             frm = range(*frm)
  *             for k in to:
  *                 for l in frm:             # <<<<<<<<<<<<<<
  *                     row[index] = k
  *                     col[index] = l
  */
       }
       __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":405
+      /* "tkwant/onebody/kernels.pyx":572
  *             to = range(*to)
  *             frm = range(*frm)
  *             for k in to:             # <<<<<<<<<<<<<<
  *                 for l in frm:
  *                     row[index] = k
  */
     }
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":410
+    /* "tkwant/onebody/kernels.pyx":577
  *                     col[index] = l
  *                     index += 1
  *             if i != j:             # <<<<<<<<<<<<<<
  *                 for k in to:
  *                     for l in frm:
  */
-    __pyx_t_7 = PyObject_RichCompare(__pyx_v_i, __pyx_v_j, Py_NE); __Pyx_XGOTREF(__pyx_t_7); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 410, __pyx_L1_error)
-    __pyx_t_17 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely(__pyx_t_17 < 0)) __PYX_ERR(0, 410, __pyx_L1_error)
+    __pyx_t_7 = PyObject_RichCompare(__pyx_v_i, __pyx_v_j, Py_NE); __Pyx_XGOTREF(__pyx_t_7); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 577, __pyx_L1_error)
+    __pyx_t_17 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely(__pyx_t_17 < 0)) __PYX_ERR(0, 577, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
     if (__pyx_t_17) {
 
-      /* "tkwant/onebody/kernels.pyx":411
+      /* "tkwant/onebody/kernels.pyx":578
  *                     index += 1
  *             if i != j:
  *                 for k in to:             # <<<<<<<<<<<<<<
  *                     for l in frm:
  *                         row[index] = l
  */
       if (likely(PyList_CheckExact(__pyx_v_to)) || PyTuple_CheckExact(__pyx_v_to)) {
         __pyx_t_7 = __pyx_v_to; __Pyx_INCREF(__pyx_t_7); __pyx_t_13 = 0;
         __pyx_t_14 = NULL;
       } else {
-        __pyx_t_13 = -1; __pyx_t_7 = PyObject_GetIter(__pyx_v_to); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 411, __pyx_L1_error)
+        __pyx_t_13 = -1; __pyx_t_7 = PyObject_GetIter(__pyx_v_to); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 578, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
-        __pyx_t_14 = Py_TYPE(__pyx_t_7)->tp_iternext; if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 411, __pyx_L1_error)
+        __pyx_t_14 = Py_TYPE(__pyx_t_7)->tp_iternext; if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 578, __pyx_L1_error)
       }
       for (;;) {
         if (likely(!__pyx_t_14)) {
           if (likely(PyList_CheckExact(__pyx_t_7))) {
             if (__pyx_t_13 >= PyList_GET_SIZE(__pyx_t_7)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_10 = PyList_GET_ITEM(__pyx_t_7, __pyx_t_13); __Pyx_INCREF(__pyx_t_10); __pyx_t_13++; if (unlikely(0 < 0)) __PYX_ERR(0, 411, __pyx_L1_error)
+            __pyx_t_10 = PyList_GET_ITEM(__pyx_t_7, __pyx_t_13); __Pyx_INCREF(__pyx_t_10); __pyx_t_13++; if (unlikely(0 < 0)) __PYX_ERR(0, 578, __pyx_L1_error)
             #else
-            __pyx_t_10 = PySequence_ITEM(__pyx_t_7, __pyx_t_13); __pyx_t_13++; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 411, __pyx_L1_error)
+            __pyx_t_10 = PySequence_ITEM(__pyx_t_7, __pyx_t_13); __pyx_t_13++; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 578, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_10);
             #endif
           } else {
             if (__pyx_t_13 >= PyTuple_GET_SIZE(__pyx_t_7)) break;
             #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-            __pyx_t_10 = PyTuple_GET_ITEM(__pyx_t_7, __pyx_t_13); __Pyx_INCREF(__pyx_t_10); __pyx_t_13++; if (unlikely(0 < 0)) __PYX_ERR(0, 411, __pyx_L1_error)
+            __pyx_t_10 = PyTuple_GET_ITEM(__pyx_t_7, __pyx_t_13); __Pyx_INCREF(__pyx_t_10); __pyx_t_13++; if (unlikely(0 < 0)) __PYX_ERR(0, 578, __pyx_L1_error)
             #else
-            __pyx_t_10 = PySequence_ITEM(__pyx_t_7, __pyx_t_13); __pyx_t_13++; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 411, __pyx_L1_error)
+            __pyx_t_10 = PySequence_ITEM(__pyx_t_7, __pyx_t_13); __pyx_t_13++; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 578, __pyx_L1_error)
             __Pyx_GOTREF(__pyx_t_10);
             #endif
           }
         } else {
           __pyx_t_10 = __pyx_t_14(__pyx_t_7);
           if (unlikely(!__pyx_t_10)) {
             PyObject* exc_type = PyErr_Occurred();
             if (exc_type) {
               if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-              else __PYX_ERR(0, 411, __pyx_L1_error)
+              else __PYX_ERR(0, 578, __pyx_L1_error)
             }
             break;
           }
           __Pyx_GOTREF(__pyx_t_10);
         }
         __Pyx_XDECREF_SET(__pyx_v_k, __pyx_t_10);
         __pyx_t_10 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":412
+        /* "tkwant/onebody/kernels.pyx":579
  *             if i != j:
  *                 for k in to:
  *                     for l in frm:             # <<<<<<<<<<<<<<
  *                         row[index] = l
  *                         col[index] = k
  */
         if (likely(PyList_CheckExact(__pyx_v_frm)) || PyTuple_CheckExact(__pyx_v_frm)) {
           __pyx_t_10 = __pyx_v_frm; __Pyx_INCREF(__pyx_t_10); __pyx_t_15 = 0;
           __pyx_t_16 = NULL;
         } else {
-          __pyx_t_15 = -1; __pyx_t_10 = PyObject_GetIter(__pyx_v_frm); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 412, __pyx_L1_error)
+          __pyx_t_15 = -1; __pyx_t_10 = PyObject_GetIter(__pyx_v_frm); if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 579, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_10);
-          __pyx_t_16 = Py_TYPE(__pyx_t_10)->tp_iternext; if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 412, __pyx_L1_error)
+          __pyx_t_16 = Py_TYPE(__pyx_t_10)->tp_iternext; if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 579, __pyx_L1_error)
         }
         for (;;) {
           if (likely(!__pyx_t_16)) {
             if (likely(PyList_CheckExact(__pyx_t_10))) {
               if (__pyx_t_15 >= PyList_GET_SIZE(__pyx_t_10)) break;
               #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-              __pyx_t_5 = PyList_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_5); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 412, __pyx_L1_error)
+              __pyx_t_5 = PyList_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_5); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 579, __pyx_L1_error)
               #else
-              __pyx_t_5 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 412, __pyx_L1_error)
+              __pyx_t_5 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 579, __pyx_L1_error)
               __Pyx_GOTREF(__pyx_t_5);
               #endif
             } else {
               if (__pyx_t_15 >= PyTuple_GET_SIZE(__pyx_t_10)) break;
               #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-              __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_5); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 412, __pyx_L1_error)
+              __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_10, __pyx_t_15); __Pyx_INCREF(__pyx_t_5); __pyx_t_15++; if (unlikely(0 < 0)) __PYX_ERR(0, 579, __pyx_L1_error)
               #else
-              __pyx_t_5 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 412, __pyx_L1_error)
+              __pyx_t_5 = PySequence_ITEM(__pyx_t_10, __pyx_t_15); __pyx_t_15++; if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 579, __pyx_L1_error)
               __Pyx_GOTREF(__pyx_t_5);
               #endif
             }
           } else {
             __pyx_t_5 = __pyx_t_16(__pyx_t_10);
             if (unlikely(!__pyx_t_5)) {
               PyObject* exc_type = PyErr_Occurred();
               if (exc_type) {
                 if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-                else __PYX_ERR(0, 412, __pyx_L1_error)
+                else __PYX_ERR(0, 579, __pyx_L1_error)
               }
               break;
             }
             __Pyx_GOTREF(__pyx_t_5);
           }
           __Pyx_XDECREF_SET(__pyx_v_l, __pyx_t_5);
           __pyx_t_5 = 0;
 
-          /* "tkwant/onebody/kernels.pyx":413
+          /* "tkwant/onebody/kernels.pyx":580
  *                 for k in to:
  *                     for l in frm:
  *                         row[index] = l             # <<<<<<<<<<<<<<
  *                         col[index] = k
  *                         index += 1
  */
-          if (unlikely(PyObject_SetItem(__pyx_v_row, __pyx_v_index, __pyx_v_l) < 0)) __PYX_ERR(0, 413, __pyx_L1_error)
+          if (unlikely(PyObject_SetItem(__pyx_v_row, __pyx_v_index, __pyx_v_l) < 0)) __PYX_ERR(0, 580, __pyx_L1_error)
 
-          /* "tkwant/onebody/kernels.pyx":414
+          /* "tkwant/onebody/kernels.pyx":581
  *                     for l in frm:
  *                         row[index] = l
  *                         col[index] = k             # <<<<<<<<<<<<<<
  *                         index += 1
  *         return row, col
  */
-          if (unlikely(PyObject_SetItem(__pyx_v_col, __pyx_v_index, __pyx_v_k) < 0)) __PYX_ERR(0, 414, __pyx_L1_error)
+          if (unlikely(PyObject_SetItem(__pyx_v_col, __pyx_v_index, __pyx_v_k) < 0)) __PYX_ERR(0, 581, __pyx_L1_error)
 
-          /* "tkwant/onebody/kernels.pyx":415
+          /* "tkwant/onebody/kernels.pyx":582
  *                         row[index] = l
  *                         col[index] = k
  *                         index += 1             # <<<<<<<<<<<<<<
  *         return row, col
  * 
  */
-          __pyx_t_5 = __Pyx_PyInt_AddObjC(__pyx_v_index, __pyx_int_1, 1, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 415, __pyx_L1_error)
+          __pyx_t_5 = __Pyx_PyInt_AddObjC(__pyx_v_index, __pyx_int_1, 1, 1, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 582, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_5);
           __Pyx_DECREF_SET(__pyx_v_index, __pyx_t_5);
           __pyx_t_5 = 0;
 
-          /* "tkwant/onebody/kernels.pyx":412
+          /* "tkwant/onebody/kernels.pyx":579
  *             if i != j:
  *                 for k in to:
  *                     for l in frm:             # <<<<<<<<<<<<<<
  *                         row[index] = l
  *                         col[index] = k
  */
         }
         __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":411
+        /* "tkwant/onebody/kernels.pyx":578
  *                     index += 1
  *             if i != j:
  *                 for k in to:             # <<<<<<<<<<<<<<
  *                     for l in frm:
  *                         row[index] = l
  */
       }
       __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":410
+      /* "tkwant/onebody/kernels.pyx":577
  *                     col[index] = l
  *                     index += 1
  *             if i != j:             # <<<<<<<<<<<<<<
  *                 for k in to:
  *                     for l in frm:
  */
     }
 
-    /* "tkwant/onebody/kernels.pyx":402
+    /* "tkwant/onebody/kernels.pyx":569
  *         col = np.empty(self.nnz, np.int32)
  *         index = 0
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:             # <<<<<<<<<<<<<<
  *             to = range(*to)
  *             frm = range(*frm)
  */
   }
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":416
+  /* "tkwant/onebody/kernels.pyx":583
  *                         col[index] = k
  *                         index += 1
  *         return row, col             # <<<<<<<<<<<<<<
  * 
  *     def empty(self):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 416, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 583, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_INCREF(__pyx_v_row);
   __Pyx_GIVEREF(__pyx_v_row);
   PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_v_row);
   __Pyx_INCREF(__pyx_v_col);
   __Pyx_GIVEREF(__pyx_v_col);
   PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_v_col);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":389
+  /* "tkwant/onebody/kernels.pyx":556
  *         return out if do_return else None
  * 
  *     def row_col(self):             # <<<<<<<<<<<<<<
  *         '''Return the row and column vectors of the W(t) matrix.
  * 
  */
 
@@ -9220,15 +12451,15 @@
   __Pyx_XDECREF(__pyx_v_k);
   __Pyx_XDECREF(__pyx_v_l);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":418
+/* "tkwant/onebody/kernels.pyx":585
  *         return row, col
  * 
  *     def empty(self):             # <<<<<<<<<<<<<<
  *         '''Return an empty W(t) matrix with correct shape and indices.
  * 
  */
 
@@ -9254,171 +12485,168 @@
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
   PyObject *__pyx_t_6 = NULL;
   int __pyx_t_7;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("empty", 0);
 
-  /* "tkwant/onebody/kernels.pyx":426
+  /* "tkwant/onebody/kernels.pyx":593
  *             An "empty" W(t) matrix filled with zeros.
  *         '''
- *         data = np.zeros((self.nnz,), dtype=np.complex)             # <<<<<<<<<<<<<<
+ *         data = np.zeros((self.nnz,), dtype=complex)             # <<<<<<<<<<<<<<
  *         row_col = self.row_col()
  *         return sp.coo_matrix((data, row_col), (self.size, self.size))
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 426, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 426, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 426, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 426, __pyx_L1_error)
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
   __pyx_t_1 = 0;
-  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 426, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_3);
   PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_3);
   __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 426, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 426, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 593, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_complex); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 426, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 426, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 426, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_v_data = __pyx_t_5;
-  __pyx_t_5 = 0;
+  __pyx_v_data = __pyx_t_4;
+  __pyx_t_4 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":427
+  /* "tkwant/onebody/kernels.pyx":594
  *         '''
- *         data = np.zeros((self.nnz,), dtype=np.complex)
+ *         data = np.zeros((self.nnz,), dtype=complex)
  *         row_col = self.row_col()             # <<<<<<<<<<<<<<
  *         return sp.coo_matrix((data, row_col), (self.size, self.size))
  * 
  */
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_row_col); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 427, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_row_col); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 594, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __pyx_t_1 = NULL;
   if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
     __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_3);
     if (likely(__pyx_t_1)) {
       PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
       __Pyx_INCREF(__pyx_t_1);
       __Pyx_INCREF(function);
       __Pyx_DECREF_SET(__pyx_t_3, function);
     }
   }
-  __pyx_t_5 = (__pyx_t_1) ? __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_1) : __Pyx_PyObject_CallNoArg(__pyx_t_3);
+  __pyx_t_4 = (__pyx_t_1) ? __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_1) : __Pyx_PyObject_CallNoArg(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
-  if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 427, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
+  if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 594, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_v_row_col = __pyx_t_5;
-  __pyx_t_5 = 0;
+  __pyx_v_row_col = __pyx_t_4;
+  __pyx_t_4 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":428
- *         data = np.zeros((self.nnz,), dtype=np.complex)
+  /* "tkwant/onebody/kernels.pyx":595
+ *         data = np.zeros((self.nnz,), dtype=complex)
  *         row_col = self.row_col()
  *         return sp.coo_matrix((data, row_col), (self.size, self.size))             # <<<<<<<<<<<<<<
  * 
  *     def evaluate(self, double time, object out=None):
  */
   __Pyx_XDECREF(__pyx_r);
-  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_sp); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 428, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_sp); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 595, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_coo_matrix); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 428, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_coo_matrix); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 595, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 428, __pyx_L1_error)
+  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 595, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_INCREF(__pyx_v_data);
   __Pyx_GIVEREF(__pyx_v_data);
   PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_v_data);
   __Pyx_INCREF(__pyx_v_row_col);
   __Pyx_GIVEREF(__pyx_v_row_col);
   PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_v_row_col);
-  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 428, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 595, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 428, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 428, __pyx_L1_error)
+  __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 595, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_6 = PyTuple_New(2); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 595, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
   __Pyx_GIVEREF(__pyx_t_2);
   PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_2);
-  __Pyx_GIVEREF(__pyx_t_4);
-  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_4);
+  __Pyx_GIVEREF(__pyx_t_5);
+  PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_5);
   __pyx_t_2 = 0;
-  __pyx_t_4 = 0;
-  __pyx_t_4 = NULL;
+  __pyx_t_5 = 0;
+  __pyx_t_5 = NULL;
   __pyx_t_7 = 0;
   if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
-    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_1);
-    if (likely(__pyx_t_4)) {
+    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_1);
+    if (likely(__pyx_t_5)) {
       PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
-      __Pyx_INCREF(__pyx_t_4);
+      __Pyx_INCREF(__pyx_t_5);
       __Pyx_INCREF(function);
       __Pyx_DECREF_SET(__pyx_t_1, function);
       __pyx_t_7 = 1;
     }
   }
   #if CYTHON_FAST_PYCALL
   if (PyFunction_Check(__pyx_t_1)) {
-    PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_3, __pyx_t_6};
-    __pyx_t_5 = __Pyx_PyFunction_FastCall(__pyx_t_1, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 428, __pyx_L1_error)
-    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_GOTREF(__pyx_t_5);
+    PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_3, __pyx_t_6};
+    __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_1, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 595, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
   } else
   #endif
   #if CYTHON_FAST_PYCCALL
   if (__Pyx_PyFastCFunction_Check(__pyx_t_1)) {
-    PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_3, __pyx_t_6};
-    __pyx_t_5 = __Pyx_PyCFunction_FastCall(__pyx_t_1, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 428, __pyx_L1_error)
-    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_GOTREF(__pyx_t_5);
+    PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_3, __pyx_t_6};
+    __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_1, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 595, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
   } else
   #endif
   {
-    __pyx_t_2 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 428, __pyx_L1_error)
+    __pyx_t_2 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 595, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    if (__pyx_t_4) {
-      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_4); __pyx_t_4 = NULL;
+    if (__pyx_t_5) {
+      __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
     }
     __Pyx_GIVEREF(__pyx_t_3);
     PyTuple_SET_ITEM(__pyx_t_2, 0+__pyx_t_7, __pyx_t_3);
     __Pyx_GIVEREF(__pyx_t_6);
     PyTuple_SET_ITEM(__pyx_t_2, 1+__pyx_t_7, __pyx_t_6);
     __pyx_t_3 = 0;
     __pyx_t_6 = 0;
-    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_2, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 428, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_2, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 595, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   }
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_r = __pyx_t_5;
-  __pyx_t_5 = 0;
+  __pyx_r = __pyx_t_4;
+  __pyx_t_4 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":418
+  /* "tkwant/onebody/kernels.pyx":585
  *         return row, col
  * 
  *     def empty(self):             # <<<<<<<<<<<<<<
  *         '''Return an empty W(t) matrix with correct shape and indices.
  * 
  */
 
@@ -9436,28 +12664,31 @@
   __Pyx_XDECREF(__pyx_v_data);
   __Pyx_XDECREF(__pyx_v_row_col);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":430
+/* "tkwant/onebody/kernels.pyx":597
  *         return sp.coo_matrix((data, row_col), (self.size, self.size))
  * 
  *     def evaluate(self, double time, object out=None):             # <<<<<<<<<<<<<<
  *         '''Evaluate the W(t) matrix for the given time t.
  * 
  */
 
 /* Python wrapper */
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_21PerturbationExtractor_9evaluate(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static char __pyx_doc_6tkwant_7onebody_7kernels_21PerturbationExtractor_8evaluate[] = "PerturbationExtractor.evaluate(self, double time, out=None)\nEvaluate the W(t) matrix for the given time t.\n\n        Parameters\n        ----------\n        time : int or float\n            Time argument, must be equal or larger than `time_start`.\n        out : `~scipy.sparse.coo_matrix`, optional\n            Sparse matrix with to perform the operation in-place.\n\n        Returns\n        -------\n        out : `~scipy.sparse.coo_matrix` or `None`\n            The matrix W(t).\n            The size of the W(t) matrix is ``size`` x ``size``, containing\n            ``nnz`` complex entries. If an ``out`` argument is given,\n            the operation is performed in-place and the routine returns `None`.\n        ";
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_21PerturbationExtractor_9evaluate(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   double __pyx_v_time;
   PyObject *__pyx_v_out = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("evaluate (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_time,&__pyx_n_s_out,0};
     PyObject* values[2] = {0,0};
     values[1] = ((PyObject *)Py_None);
@@ -9481,31 +12712,31 @@
         case  1:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_out);
           if (value) { values[1] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "evaluate") < 0)) __PYX_ERR(0, 430, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "evaluate") < 0)) __PYX_ERR(0, 597, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
-    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 430, __pyx_L3_error)
+    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 597, __pyx_L3_error)
     __pyx_v_out = values[1];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("evaluate", 0, 1, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 430, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("evaluate", 0, 1, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 597, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationExtractor.evaluate", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_8evaluate(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *)__pyx_v_self), __pyx_v_time, __pyx_v_out);
 
@@ -9524,110 +12755,113 @@
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
   PyObject *__pyx_t_6 = NULL;
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_t_9;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("evaluate", 0);
 
-  /* "tkwant/onebody/kernels.pyx":448
+  /* "tkwant/onebody/kernels.pyx":615
  *             the operation is performed in-place and the routine returns `None`.
  *         '''
  *         if out is None:             # <<<<<<<<<<<<<<
  *             data = self.data(time)
  *             row_col = self.row_col()
  */
   __pyx_t_1 = (__pyx_v_out == Py_None);
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "tkwant/onebody/kernels.pyx":449
+    /* "tkwant/onebody/kernels.pyx":616
  *         '''
  *         if out is None:
  *             data = self.data(time)             # <<<<<<<<<<<<<<
  *             row_col = self.row_col()
  *             return sp.coo_matrix((data, row_col), (self.size, self.size))
  */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 449, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 616, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 449, __pyx_L1_error)
+    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 616, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __pyx_t_6 = NULL;
     if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
       __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
       if (likely(__pyx_t_6)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
         __Pyx_INCREF(__pyx_t_6);
         __Pyx_INCREF(function);
         __Pyx_DECREF_SET(__pyx_t_4, function);
       }
     }
     __pyx_t_3 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5);
     __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 449, __pyx_L1_error)
+    if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 616, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __pyx_v_data = __pyx_t_3;
     __pyx_t_3 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":450
+    /* "tkwant/onebody/kernels.pyx":617
  *         if out is None:
  *             data = self.data(time)
  *             row_col = self.row_col()             # <<<<<<<<<<<<<<
  *             return sp.coo_matrix((data, row_col), (self.size, self.size))
  *         else:
  */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_row_col); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 450, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_row_col); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 617, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __pyx_t_5 = NULL;
     if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
       __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
       if (likely(__pyx_t_5)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
         __Pyx_INCREF(__pyx_t_5);
         __Pyx_INCREF(function);
         __Pyx_DECREF_SET(__pyx_t_4, function);
       }
     }
     __pyx_t_3 = (__pyx_t_5) ? __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_5) : __Pyx_PyObject_CallNoArg(__pyx_t_4);
     __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-    if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 450, __pyx_L1_error)
+    if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 617, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __pyx_v_row_col = __pyx_t_3;
     __pyx_t_3 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":451
+    /* "tkwant/onebody/kernels.pyx":618
  *             data = self.data(time)
  *             row_col = self.row_col()
  *             return sp.coo_matrix((data, row_col), (self.size, self.size))             # <<<<<<<<<<<<<<
  *         else:
  *             assert out.shape[0] == self.size, _errormsg.format('output',
  */
     __Pyx_XDECREF(__pyx_r);
-    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_sp); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 451, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_sp); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 618, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_coo_matrix); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 451, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_coo_matrix); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 618, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 451, __pyx_L1_error)
+    __pyx_t_4 = PyTuple_New(2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 618, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_INCREF(__pyx_v_data);
     __Pyx_GIVEREF(__pyx_v_data);
     PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_v_data);
     __Pyx_INCREF(__pyx_v_row_col);
     __Pyx_GIVEREF(__pyx_v_row_col);
     PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_v_row_col);
-    __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 451, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 618, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_7 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 451, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 618, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 451, __pyx_L1_error)
+    __pyx_t_8 = PyTuple_New(2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 618, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
     __Pyx_GIVEREF(__pyx_t_6);
     PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6);
     __Pyx_GIVEREF(__pyx_t_7);
     PyTuple_SET_ITEM(__pyx_t_8, 1, __pyx_t_7);
     __pyx_t_6 = 0;
     __pyx_t_7 = 0;
@@ -9642,111 +12876,111 @@
         __Pyx_DECREF_SET(__pyx_t_5, function);
         __pyx_t_9 = 1;
       }
     }
     #if CYTHON_FAST_PYCALL
     if (PyFunction_Check(__pyx_t_5)) {
       PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_4, __pyx_t_8};
-      __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 451, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 618, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     } else
     #endif
     #if CYTHON_FAST_PYCCALL
     if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
       PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_4, __pyx_t_8};
-      __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 451, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 618, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     } else
     #endif
     {
-      __pyx_t_6 = PyTuple_New(2+__pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 451, __pyx_L1_error)
+      __pyx_t_6 = PyTuple_New(2+__pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 618, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
       if (__pyx_t_7) {
         __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_7); __pyx_t_7 = NULL;
       }
       __Pyx_GIVEREF(__pyx_t_4);
       PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_9, __pyx_t_4);
       __Pyx_GIVEREF(__pyx_t_8);
       PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_9, __pyx_t_8);
       __pyx_t_4 = 0;
       __pyx_t_8 = 0;
-      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_6, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 451, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_6, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 618, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     }
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __pyx_r = __pyx_t_3;
     __pyx_t_3 = 0;
     goto __pyx_L0;
 
-    /* "tkwant/onebody/kernels.pyx":448
+    /* "tkwant/onebody/kernels.pyx":615
  *             the operation is performed in-place and the routine returns `None`.
  *         '''
  *         if out is None:             # <<<<<<<<<<<<<<
  *             data = self.data(time)
  *             row_col = self.row_col()
  */
   }
 
-  /* "tkwant/onebody/kernels.pyx":453
+  /* "tkwant/onebody/kernels.pyx":620
  *             return sp.coo_matrix((data, row_col), (self.size, self.size))
  *         else:
  *             assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
  *                                                                 out.shape[0],
  *                                                                 self.size)
  */
   /*else*/ {
     #ifndef CYTHON_WITHOUT_ASSERTIONS
     if (unlikely(!Py_OptimizeFlag)) {
-      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 453, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 620, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 453, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 620, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 453, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 620, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_6 = PyObject_RichCompare(__pyx_t_5, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_6); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 453, __pyx_L1_error)
+      __pyx_t_6 = PyObject_RichCompare(__pyx_t_5, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_6); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 620, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_6); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 453, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_6); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 620, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
       if (unlikely(!__pyx_t_2)) {
-        __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 453, __pyx_L1_error)
+        __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 620, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_format); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 453, __pyx_L1_error)
+        __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_format); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 620, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":454
+        /* "tkwant/onebody/kernels.pyx":621
  *         else:
  *             assert out.shape[0] == self.size, _errormsg.format('output',
  *                                                                 out.shape[0],             # <<<<<<<<<<<<<<
  *                                                                 self.size)
  *             self.data(time, out.data)
  */
-        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 454, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 621, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_8 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 454, __pyx_L1_error)
+        __pyx_t_8 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 621, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
         __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":455
+        /* "tkwant/onebody/kernels.pyx":622
  *             assert out.shape[0] == self.size, _errormsg.format('output',
  *                                                                 out.shape[0],
  *                                                                 self.size)             # <<<<<<<<<<<<<<
  *             self.data(time, out.data)
  * 
  */
-        __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 455, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 622, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
         __pyx_t_4 = NULL;
         __pyx_t_9 = 0;
         if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_5))) {
           __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_5);
           if (likely(__pyx_t_4)) {
             PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
@@ -9755,81 +12989,81 @@
             __Pyx_DECREF_SET(__pyx_t_5, function);
             __pyx_t_9 = 1;
           }
         }
         #if CYTHON_FAST_PYCALL
         if (PyFunction_Check(__pyx_t_5)) {
           PyObject *__pyx_temp[4] = {__pyx_t_4, __pyx_n_u_output, __pyx_t_8, __pyx_t_3};
-          __pyx_t_6 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_9, 3+__pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 453, __pyx_L1_error)
+          __pyx_t_6 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_9, 3+__pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 620, __pyx_L1_error)
           __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
           __Pyx_GOTREF(__pyx_t_6);
           __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         } else
         #endif
         #if CYTHON_FAST_PYCCALL
         if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
           PyObject *__pyx_temp[4] = {__pyx_t_4, __pyx_n_u_output, __pyx_t_8, __pyx_t_3};
-          __pyx_t_6 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_9, 3+__pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 453, __pyx_L1_error)
+          __pyx_t_6 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_9, 3+__pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 620, __pyx_L1_error)
           __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
           __Pyx_GOTREF(__pyx_t_6);
           __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         } else
         #endif
         {
-          __pyx_t_7 = PyTuple_New(3+__pyx_t_9); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 453, __pyx_L1_error)
+          __pyx_t_7 = PyTuple_New(3+__pyx_t_9); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 620, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_7);
           if (__pyx_t_4) {
             __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_4); __pyx_t_4 = NULL;
           }
           __Pyx_INCREF(__pyx_n_u_output);
           __Pyx_GIVEREF(__pyx_n_u_output);
           PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_9, __pyx_n_u_output);
           __Pyx_GIVEREF(__pyx_t_8);
           PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_9, __pyx_t_8);
           __Pyx_GIVEREF(__pyx_t_3);
           PyTuple_SET_ITEM(__pyx_t_7, 2+__pyx_t_9, __pyx_t_3);
           __pyx_t_8 = 0;
           __pyx_t_3 = 0;
-          __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_7, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 453, __pyx_L1_error)
+          __pyx_t_6 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_7, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 620, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_6);
           __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
         }
         __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":453
+        /* "tkwant/onebody/kernels.pyx":620
  *             return sp.coo_matrix((data, row_col), (self.size, self.size))
  *         else:
  *             assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
  *                                                                 out.shape[0],
  *                                                                 self.size)
  */
-        __pyx_t_5 = PyTuple_Pack(1, __pyx_t_6); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 453, __pyx_L1_error)
+        __pyx_t_5 = PyTuple_Pack(1, __pyx_t_6); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 620, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
         PyErr_SetObject(PyExc_AssertionError, __pyx_t_5);
         __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-        __PYX_ERR(0, 453, __pyx_L1_error)
+        __PYX_ERR(0, 620, __pyx_L1_error)
       }
     }
     #endif
 
-    /* "tkwant/onebody/kernels.pyx":456
+    /* "tkwant/onebody/kernels.pyx":623
  *                                                                 out.shape[0],
  *                                                                 self.size)
  *             self.data(time, out.data)             # <<<<<<<<<<<<<<
  * 
  *     def apply(self, double time, ket, out=None):
  */
-    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_data); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 456, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_data); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 623, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_7 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 456, __pyx_L1_error)
+    __pyx_t_7 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 623, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
-    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_data); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 456, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_data); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 623, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __pyx_t_8 = NULL;
     __pyx_t_9 = 0;
     if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_6))) {
       __pyx_t_8 = PyMethod_GET_SELF(__pyx_t_6);
       if (likely(__pyx_t_8)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
@@ -9838,52 +13072,52 @@
         __Pyx_DECREF_SET(__pyx_t_6, function);
         __pyx_t_9 = 1;
       }
     }
     #if CYTHON_FAST_PYCALL
     if (PyFunction_Check(__pyx_t_6)) {
       PyObject *__pyx_temp[3] = {__pyx_t_8, __pyx_t_7, __pyx_t_3};
-      __pyx_t_5 = __Pyx_PyFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 456, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_PyFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 623, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     } else
     #endif
     #if CYTHON_FAST_PYCCALL
     if (__Pyx_PyFastCFunction_Check(__pyx_t_6)) {
       PyObject *__pyx_temp[3] = {__pyx_t_8, __pyx_t_7, __pyx_t_3};
-      __pyx_t_5 = __Pyx_PyCFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 456, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_PyCFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 623, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     } else
     #endif
     {
-      __pyx_t_4 = PyTuple_New(2+__pyx_t_9); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 456, __pyx_L1_error)
+      __pyx_t_4 = PyTuple_New(2+__pyx_t_9); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 623, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
       if (__pyx_t_8) {
         __Pyx_GIVEREF(__pyx_t_8); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_8); __pyx_t_8 = NULL;
       }
       __Pyx_GIVEREF(__pyx_t_7);
       PyTuple_SET_ITEM(__pyx_t_4, 0+__pyx_t_9, __pyx_t_7);
       __Pyx_GIVEREF(__pyx_t_3);
       PyTuple_SET_ITEM(__pyx_t_4, 1+__pyx_t_9, __pyx_t_3);
       __pyx_t_7 = 0;
       __pyx_t_3 = 0;
-      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_4, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 456, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_4, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 623, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     }
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
   }
 
-  /* "tkwant/onebody/kernels.pyx":430
+  /* "tkwant/onebody/kernels.pyx":597
  *         return sp.coo_matrix((data, row_col), (self.size, self.size))
  * 
  *     def evaluate(self, double time, object out=None):             # <<<<<<<<<<<<<<
  *         '''Evaluate the W(t) matrix for the given time t.
  * 
  */
 
@@ -9903,29 +13137,32 @@
   __Pyx_XDECREF(__pyx_v_data);
   __Pyx_XDECREF(__pyx_v_row_col);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":458
+/* "tkwant/onebody/kernels.pyx":625
  *             self.data(time, out.data)
  * 
  *     def apply(self, double time, ket, out=None):             # <<<<<<<<<<<<<<
  *         '''Evaluate the matrix-vector product W(t) @ ket for the given time.
  * 
  */
 
 /* Python wrapper */
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_21PerturbationExtractor_11apply(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_21PerturbationExtractor_10apply[] = "PerturbationExtractor.apply(self, double time, ket, out=None)\nEvaluate the matrix-vector product W(t) @ ket for the given time.\n\n        Parameters\n        ----------\n        time : int or float\n            Time argument, must be equal or larger than `time_start`.\n        out : `numpy.ndarray`, optional\n            Sparse matrix with to perform the operation in-place.\n\n        Returns\n        -------\n        out : `numpy.ndarray` or `None`\n            The product W(t) @ ket. If an ``out`` argument is given,\n            the operation is performed in-place and the routine returns `None`.\n        ";
+static char __pyx_doc_6tkwant_7onebody_7kernels_21PerturbationExtractor_10apply[] = "PerturbationExtractor.apply(self, double time, ket, out=None)\nEvaluate the matrix-vector product W(t) @ ket for the given time.\n\n        Parameters\n        ----------\n        time : int or float\n            Time argument, must be equal or larger than `time_start`.\n        out : `numpy.ndarray`, optional\n            Sparse matrix with to perform the operation in-place.\n            If provided, array must be zero on input.\n\n        Returns\n        -------\n        out : `numpy.ndarray` or `None`\n            The product W(t) @ ket. If an ``out`` argument is given,\n            the operation is performed in-place and the routine returns `None`.\n        ";
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_21PerturbationExtractor_11apply(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   double __pyx_v_time;
   PyObject *__pyx_v_ket = 0;
   PyObject *__pyx_v_out = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("apply (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_time,&__pyx_n_s_ket,&__pyx_n_s_out,0};
     PyObject* values[3] = {0,0,0};
     values[2] = ((PyObject *)Py_None);
@@ -9947,43 +13184,43 @@
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_ket)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("apply", 0, 2, 3, 1); __PYX_ERR(0, 458, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("apply", 0, 2, 3, 1); __PYX_ERR(0, 625, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_out);
           if (value) { values[2] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "apply") < 0)) __PYX_ERR(0, 458, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "apply") < 0)) __PYX_ERR(0, 625, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
         CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
-    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 458, __pyx_L3_error)
+    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 625, __pyx_L3_error)
     __pyx_v_ket = values[1];
     __pyx_v_out = values[2];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("apply", 0, 2, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 458, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("apply", 0, 2, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 625, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationExtractor.apply", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_10apply(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *)__pyx_v_self), __pyx_v_time, __pyx_v_ket, __pyx_v_out);
 
@@ -10013,58 +13250,61 @@
   int __pyx_t_9;
   Py_ssize_t __pyx_t_10;
   PyObject *(*__pyx_t_11)(PyObject *);
   PyObject *__pyx_t_12 = NULL;
   PyObject *__pyx_t_13 = NULL;
   PyObject *(*__pyx_t_14)(PyObject *);
   PyObject *__pyx_t_15 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("apply", 0);
   __Pyx_INCREF(__pyx_v_out);
 
-  /* "tkwant/onebody/kernels.pyx":474
+  /* "tkwant/onebody/kernels.pyx":642
  *             the operation is performed in-place and the routine returns `None`.
  *         '''
  *         assert ket.shape[0] == self.size, _errormsg.format('Ket', ket.shape[0],             # <<<<<<<<<<<<<<
  *                                                            self.size)
  *         if out is None:
  */
   #ifndef CYTHON_WITHOUT_ASSERTIONS
   if (unlikely(!Py_OptimizeFlag)) {
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_ket, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 474, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_ket, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 642, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_2 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 474, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 642, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 474, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 642, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_3 = PyObject_RichCompare(__pyx_t_2, __pyx_t_1, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 474, __pyx_L1_error)
+    __pyx_t_3 = PyObject_RichCompare(__pyx_t_2, __pyx_t_1, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 642, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_4 < 0)) __PYX_ERR(0, 474, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_4 < 0)) __PYX_ERR(0, 642, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     if (unlikely(!__pyx_t_4)) {
-      __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 474, __pyx_L1_error)
+      __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 642, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_format); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 474, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_format); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 642, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_ket, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 474, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_ket, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 642, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 474, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 642, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":475
+      /* "tkwant/onebody/kernels.pyx":643
  *         '''
  *         assert ket.shape[0] == self.size, _errormsg.format('Ket', ket.shape[0],
  *                                                            self.size)             # <<<<<<<<<<<<<<
  *         if out is None:
  *             do_return = True
  */
-      __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 475, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 643, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
       __pyx_t_6 = NULL;
       __pyx_t_7 = 0;
       if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
         __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_2);
         if (likely(__pyx_t_6)) {
           PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
@@ -10073,580 +13313,574 @@
           __Pyx_DECREF_SET(__pyx_t_2, function);
           __pyx_t_7 = 1;
         }
       }
       #if CYTHON_FAST_PYCALL
       if (PyFunction_Check(__pyx_t_2)) {
         PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_n_u_Ket, __pyx_t_5, __pyx_t_1};
-        __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 474, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 642, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
         __Pyx_GOTREF(__pyx_t_3);
         __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       } else
       #endif
       #if CYTHON_FAST_PYCCALL
       if (__Pyx_PyFastCFunction_Check(__pyx_t_2)) {
         PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_n_u_Ket, __pyx_t_5, __pyx_t_1};
-        __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 474, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_2, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 642, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
         __Pyx_GOTREF(__pyx_t_3);
         __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
         __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       } else
       #endif
       {
-        __pyx_t_8 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 474, __pyx_L1_error)
+        __pyx_t_8 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 642, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
         if (__pyx_t_6) {
           __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6); __pyx_t_6 = NULL;
         }
         __Pyx_INCREF(__pyx_n_u_Ket);
         __Pyx_GIVEREF(__pyx_n_u_Ket);
         PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_7, __pyx_n_u_Ket);
         __Pyx_GIVEREF(__pyx_t_5);
         PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_7, __pyx_t_5);
         __Pyx_GIVEREF(__pyx_t_1);
         PyTuple_SET_ITEM(__pyx_t_8, 2+__pyx_t_7, __pyx_t_1);
         __pyx_t_5 = 0;
         __pyx_t_1 = 0;
-        __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_8, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 474, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_8, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 642, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
         __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
       }
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":474
+      /* "tkwant/onebody/kernels.pyx":642
  *             the operation is performed in-place and the routine returns `None`.
  *         '''
  *         assert ket.shape[0] == self.size, _errormsg.format('Ket', ket.shape[0],             # <<<<<<<<<<<<<<
  *                                                            self.size)
  *         if out is None:
  */
-      __pyx_t_2 = PyTuple_Pack(1, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 474, __pyx_L1_error)
+      __pyx_t_2 = PyTuple_Pack(1, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 642, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
       PyErr_SetObject(PyExc_AssertionError, __pyx_t_2);
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __PYX_ERR(0, 474, __pyx_L1_error)
+      __PYX_ERR(0, 642, __pyx_L1_error)
     }
   }
   #endif
 
-  /* "tkwant/onebody/kernels.pyx":476
+  /* "tkwant/onebody/kernels.pyx":644
  *         assert ket.shape[0] == self.size, _errormsg.format('Ket', ket.shape[0],
  *                                                            self.size)
  *         if out is None:             # <<<<<<<<<<<<<<
  *             do_return = True
- *             out = np.zeros((self.size,), dtype=np.complex)
+ *             out = np.zeros((self.size,), dtype=complex)
  */
   __pyx_t_4 = (__pyx_v_out == Py_None);
   __pyx_t_9 = (__pyx_t_4 != 0);
   if (__pyx_t_9) {
 
-    /* "tkwant/onebody/kernels.pyx":477
+    /* "tkwant/onebody/kernels.pyx":645
  *                                                            self.size)
  *         if out is None:
  *             do_return = True             # <<<<<<<<<<<<<<
- *             out = np.zeros((self.size,), dtype=np.complex)
+ *             out = np.zeros((self.size,), dtype=complex)
  *         else:
  */
     __pyx_v_do_return = 1;
 
-    /* "tkwant/onebody/kernels.pyx":478
+    /* "tkwant/onebody/kernels.pyx":646
  *         if out is None:
  *             do_return = True
- *             out = np.zeros((self.size,), dtype=np.complex)             # <<<<<<<<<<<<<<
+ *             out = np.zeros((self.size,), dtype=complex)             # <<<<<<<<<<<<<<
  *         else:
  *             do_return = False
  */
-    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 478, __pyx_L1_error)
+    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 646, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 478, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_zeros); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 646, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 478, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 646, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_8 = PyTuple_New(1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 478, __pyx_L1_error)
+    __pyx_t_8 = PyTuple_New(1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 646, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
     __Pyx_GIVEREF(__pyx_t_2);
     PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_2);
     __pyx_t_2 = 0;
-    __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 478, __pyx_L1_error)
+    __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 646, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_GIVEREF(__pyx_t_8);
     PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_8);
     __pyx_t_8 = 0;
-    __pyx_t_8 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 478, __pyx_L1_error)
+    __pyx_t_8 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 646, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
-    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 478, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_8, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 646, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, __pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 646, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_complex); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 478, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    if (PyDict_SetItem(__pyx_t_8, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 478, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_2, __pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 478, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-    __Pyx_DECREF_SET(__pyx_v_out, __pyx_t_5);
-    __pyx_t_5 = 0;
+    __Pyx_DECREF_SET(__pyx_v_out, __pyx_t_1);
+    __pyx_t_1 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":476
+    /* "tkwant/onebody/kernels.pyx":644
  *         assert ket.shape[0] == self.size, _errormsg.format('Ket', ket.shape[0],
  *                                                            self.size)
  *         if out is None:             # <<<<<<<<<<<<<<
  *             do_return = True
- *             out = np.zeros((self.size,), dtype=np.complex)
+ *             out = np.zeros((self.size,), dtype=complex)
  */
     goto __pyx_L3;
   }
 
-  /* "tkwant/onebody/kernels.pyx":480
- *             out = np.zeros((self.size,), dtype=np.complex)
+  /* "tkwant/onebody/kernels.pyx":648
+ *             out = np.zeros((self.size,), dtype=complex)
  *         else:
  *             do_return = False             # <<<<<<<<<<<<<<
  *             assert out.shape[0] == self.size, _errormsg.format('output',
  *                                                                out.shape[0],
  */
   /*else*/ {
     __pyx_v_do_return = 0;
 
-    /* "tkwant/onebody/kernels.pyx":481
+    /* "tkwant/onebody/kernels.pyx":649
  *         else:
  *             do_return = False
  *             assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
  *                                                                out.shape[0],
  *                                                                self.size)
  */
     #ifndef CYTHON_WITHOUT_ASSERTIONS
     if (unlikely(!Py_OptimizeFlag)) {
-      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 481, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_8 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 481, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 649, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_1);
+      __pyx_t_8 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 649, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 481, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_2 = PyObject_RichCompare(__pyx_t_8, __pyx_t_5, Py_EQ); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 481, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+      __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 649, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_1);
+      __pyx_t_2 = PyObject_RichCompare(__pyx_t_8, __pyx_t_1, Py_EQ); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 649, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 481, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+      __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 649, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       if (unlikely(!__pyx_t_9)) {
-        __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 481, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_format); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 481, __pyx_L1_error)
+        __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 649, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_1);
+        __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_format); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 649, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":482
+        /* "tkwant/onebody/kernels.pyx":650
  *             do_return = False
  *             assert out.shape[0] == self.size, _errormsg.format('output',
  *                                                                out.shape[0],             # <<<<<<<<<<<<<<
  *                                                                self.size)
  *         self.tparams[self.time_name] = time
  */
-        __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 482, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __pyx_t_3 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 482, __pyx_L1_error)
+        __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 650, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_1);
+        __pyx_t_3 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 650, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":483
+        /* "tkwant/onebody/kernels.pyx":651
  *             assert out.shape[0] == self.size, _errormsg.format('output',
  *                                                                out.shape[0],
  *                                                                self.size)             # <<<<<<<<<<<<<<
  *         self.tparams[self.time_name] = time
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:
  */
-        __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 483, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __pyx_t_1 = NULL;
+        __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 651, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_1);
+        __pyx_t_5 = NULL;
         __pyx_t_7 = 0;
         if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_8))) {
-          __pyx_t_1 = PyMethod_GET_SELF(__pyx_t_8);
-          if (likely(__pyx_t_1)) {
+          __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_8);
+          if (likely(__pyx_t_5)) {
             PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
-            __Pyx_INCREF(__pyx_t_1);
+            __Pyx_INCREF(__pyx_t_5);
             __Pyx_INCREF(function);
             __Pyx_DECREF_SET(__pyx_t_8, function);
             __pyx_t_7 = 1;
           }
         }
         #if CYTHON_FAST_PYCALL
         if (PyFunction_Check(__pyx_t_8)) {
-          PyObject *__pyx_temp[4] = {__pyx_t_1, __pyx_n_u_output, __pyx_t_3, __pyx_t_5};
-          __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 481, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
+          PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_n_u_output, __pyx_t_3, __pyx_t_1};
+          __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 649, __pyx_L1_error)
+          __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
           __Pyx_GOTREF(__pyx_t_2);
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+          __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
         } else
         #endif
         #if CYTHON_FAST_PYCCALL
         if (__Pyx_PyFastCFunction_Check(__pyx_t_8)) {
-          PyObject *__pyx_temp[4] = {__pyx_t_1, __pyx_n_u_output, __pyx_t_3, __pyx_t_5};
-          __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 481, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
+          PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_n_u_output, __pyx_t_3, __pyx_t_1};
+          __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 649, __pyx_L1_error)
+          __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
           __Pyx_GOTREF(__pyx_t_2);
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+          __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
         } else
         #endif
         {
-          __pyx_t_6 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 481, __pyx_L1_error)
+          __pyx_t_6 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 649, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_6);
-          if (__pyx_t_1) {
-            __Pyx_GIVEREF(__pyx_t_1); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_1); __pyx_t_1 = NULL;
+          if (__pyx_t_5) {
+            __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5); __pyx_t_5 = NULL;
           }
           __Pyx_INCREF(__pyx_n_u_output);
           __Pyx_GIVEREF(__pyx_n_u_output);
           PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_7, __pyx_n_u_output);
           __Pyx_GIVEREF(__pyx_t_3);
           PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_7, __pyx_t_3);
-          __Pyx_GIVEREF(__pyx_t_5);
-          PyTuple_SET_ITEM(__pyx_t_6, 2+__pyx_t_7, __pyx_t_5);
+          __Pyx_GIVEREF(__pyx_t_1);
+          PyTuple_SET_ITEM(__pyx_t_6, 2+__pyx_t_7, __pyx_t_1);
           __pyx_t_3 = 0;
-          __pyx_t_5 = 0;
-          __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_6, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 481, __pyx_L1_error)
+          __pyx_t_1 = 0;
+          __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_6, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 649, __pyx_L1_error)
           __Pyx_GOTREF(__pyx_t_2);
           __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
         }
         __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":481
+        /* "tkwant/onebody/kernels.pyx":649
  *         else:
  *             do_return = False
  *             assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
  *                                                                out.shape[0],
  *                                                                self.size)
  */
-        __pyx_t_8 = PyTuple_Pack(1, __pyx_t_2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 481, __pyx_L1_error)
+        __pyx_t_8 = PyTuple_Pack(1, __pyx_t_2); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 649, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_8);
         __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
         PyErr_SetObject(PyExc_AssertionError, __pyx_t_8);
         __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-        __PYX_ERR(0, 481, __pyx_L1_error)
+        __PYX_ERR(0, 649, __pyx_L1_error)
       }
     }
     #endif
   }
   __pyx_L3:;
 
-  /* "tkwant/onebody/kernels.pyx":484
+  /* "tkwant/onebody/kernels.pyx":652
  *                                                                out.shape[0],
  *                                                                self.size)
  *         self.tparams[self.time_name] = time             # <<<<<<<<<<<<<<
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:
  *             to = slice(*to)
  */
-  __pyx_t_8 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 484, __pyx_L1_error)
+  __pyx_t_8 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 652, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_8);
-  if (unlikely(PyObject_SetItem(__pyx_v_self->tparams, __pyx_v_self->time_name, __pyx_t_8) < 0)) __PYX_ERR(0, 484, __pyx_L1_error)
+  if (unlikely(PyObject_SetItem(__pyx_v_self->tparams, __pyx_v_self->time_name, __pyx_t_8) < 0)) __PYX_ERR(0, 652, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":485
+  /* "tkwant/onebody/kernels.pyx":653
  *                                                                self.size)
  *         self.tparams[self.time_name] = time
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:             # <<<<<<<<<<<<<<
  *             to = slice(*to)
  *             frm = slice(*frm)
  */
   if (likely(PyList_CheckExact(__pyx_v_self->td_hamiltonian)) || PyTuple_CheckExact(__pyx_v_self->td_hamiltonian)) {
     __pyx_t_8 = __pyx_v_self->td_hamiltonian; __Pyx_INCREF(__pyx_t_8); __pyx_t_10 = 0;
     __pyx_t_11 = NULL;
   } else {
-    __pyx_t_10 = -1; __pyx_t_8 = PyObject_GetIter(__pyx_v_self->td_hamiltonian); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 485, __pyx_L1_error)
+    __pyx_t_10 = -1; __pyx_t_8 = PyObject_GetIter(__pyx_v_self->td_hamiltonian); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 653, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
-    __pyx_t_11 = Py_TYPE(__pyx_t_8)->tp_iternext; if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 485, __pyx_L1_error)
+    __pyx_t_11 = Py_TYPE(__pyx_t_8)->tp_iternext; if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 653, __pyx_L1_error)
   }
   for (;;) {
     if (likely(!__pyx_t_11)) {
       if (likely(PyList_CheckExact(__pyx_t_8))) {
         if (__pyx_t_10 >= PyList_GET_SIZE(__pyx_t_8)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_2 = PyList_GET_ITEM(__pyx_t_8, __pyx_t_10); __Pyx_INCREF(__pyx_t_2); __pyx_t_10++; if (unlikely(0 < 0)) __PYX_ERR(0, 485, __pyx_L1_error)
+        __pyx_t_2 = PyList_GET_ITEM(__pyx_t_8, __pyx_t_10); __Pyx_INCREF(__pyx_t_2); __pyx_t_10++; if (unlikely(0 < 0)) __PYX_ERR(0, 653, __pyx_L1_error)
         #else
-        __pyx_t_2 = PySequence_ITEM(__pyx_t_8, __pyx_t_10); __pyx_t_10++; if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 485, __pyx_L1_error)
+        __pyx_t_2 = PySequence_ITEM(__pyx_t_8, __pyx_t_10); __pyx_t_10++; if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 653, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
         #endif
       } else {
         if (__pyx_t_10 >= PyTuple_GET_SIZE(__pyx_t_8)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_2 = PyTuple_GET_ITEM(__pyx_t_8, __pyx_t_10); __Pyx_INCREF(__pyx_t_2); __pyx_t_10++; if (unlikely(0 < 0)) __PYX_ERR(0, 485, __pyx_L1_error)
+        __pyx_t_2 = PyTuple_GET_ITEM(__pyx_t_8, __pyx_t_10); __Pyx_INCREF(__pyx_t_2); __pyx_t_10++; if (unlikely(0 < 0)) __PYX_ERR(0, 653, __pyx_L1_error)
         #else
-        __pyx_t_2 = PySequence_ITEM(__pyx_t_8, __pyx_t_10); __pyx_t_10++; if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 485, __pyx_L1_error)
+        __pyx_t_2 = PySequence_ITEM(__pyx_t_8, __pyx_t_10); __pyx_t_10++; if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 653, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
         #endif
       }
     } else {
       __pyx_t_2 = __pyx_t_11(__pyx_t_8);
       if (unlikely(!__pyx_t_2)) {
         PyObject* exc_type = PyErr_Occurred();
         if (exc_type) {
           if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-          else __PYX_ERR(0, 485, __pyx_L1_error)
+          else __PYX_ERR(0, 653, __pyx_L1_error)
         }
         break;
       }
       __Pyx_GOTREF(__pyx_t_2);
     }
     if ((likely(PyTuple_CheckExact(__pyx_t_2))) || (PyList_CheckExact(__pyx_t_2))) {
       PyObject* sequence = __pyx_t_2;
       Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
       if (unlikely(size != 5)) {
         if (size > 5) __Pyx_RaiseTooManyValuesError(5);
         else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-        __PYX_ERR(0, 485, __pyx_L1_error)
+        __PYX_ERR(0, 653, __pyx_L1_error)
       }
       #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
       if (likely(PyTuple_CheckExact(sequence))) {
         __pyx_t_6 = PyTuple_GET_ITEM(sequence, 0); 
-        __pyx_t_5 = PyTuple_GET_ITEM(sequence, 1); 
+        __pyx_t_1 = PyTuple_GET_ITEM(sequence, 1); 
         __pyx_t_3 = PyTuple_GET_ITEM(sequence, 2); 
-        __pyx_t_1 = PyTuple_GET_ITEM(sequence, 3); 
+        __pyx_t_5 = PyTuple_GET_ITEM(sequence, 3); 
         __pyx_t_12 = PyTuple_GET_ITEM(sequence, 4); 
       } else {
         __pyx_t_6 = PyList_GET_ITEM(sequence, 0); 
-        __pyx_t_5 = PyList_GET_ITEM(sequence, 1); 
+        __pyx_t_1 = PyList_GET_ITEM(sequence, 1); 
         __pyx_t_3 = PyList_GET_ITEM(sequence, 2); 
-        __pyx_t_1 = PyList_GET_ITEM(sequence, 3); 
+        __pyx_t_5 = PyList_GET_ITEM(sequence, 3); 
         __pyx_t_12 = PyList_GET_ITEM(sequence, 4); 
       }
       __Pyx_INCREF(__pyx_t_6);
-      __Pyx_INCREF(__pyx_t_5);
-      __Pyx_INCREF(__pyx_t_3);
       __Pyx_INCREF(__pyx_t_1);
+      __Pyx_INCREF(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_5);
       __Pyx_INCREF(__pyx_t_12);
       #else
       {
         Py_ssize_t i;
-        PyObject** temps[5] = {&__pyx_t_6,&__pyx_t_5,&__pyx_t_3,&__pyx_t_1,&__pyx_t_12};
+        PyObject** temps[5] = {&__pyx_t_6,&__pyx_t_1,&__pyx_t_3,&__pyx_t_5,&__pyx_t_12};
         for (i=0; i < 5; i++) {
-          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 485, __pyx_L1_error)
+          PyObject* item = PySequence_ITEM(sequence, i); if (unlikely(!item)) __PYX_ERR(0, 653, __pyx_L1_error)
           __Pyx_GOTREF(item);
           *(temps[i]) = item;
         }
       }
       #endif
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     } else {
       Py_ssize_t index = -1;
-      PyObject** temps[5] = {&__pyx_t_6,&__pyx_t_5,&__pyx_t_3,&__pyx_t_1,&__pyx_t_12};
-      __pyx_t_13 = PyObject_GetIter(__pyx_t_2); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 485, __pyx_L1_error)
+      PyObject** temps[5] = {&__pyx_t_6,&__pyx_t_1,&__pyx_t_3,&__pyx_t_5,&__pyx_t_12};
+      __pyx_t_13 = PyObject_GetIter(__pyx_t_2); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 653, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_13);
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       __pyx_t_14 = Py_TYPE(__pyx_t_13)->tp_iternext;
       for (index=0; index < 5; index++) {
         PyObject* item = __pyx_t_14(__pyx_t_13); if (unlikely(!item)) goto __pyx_L6_unpacking_failed;
         __Pyx_GOTREF(item);
         *(temps[index]) = item;
       }
-      if (__Pyx_IternextUnpackEndCheck(__pyx_t_14(__pyx_t_13), 5) < 0) __PYX_ERR(0, 485, __pyx_L1_error)
+      if (__Pyx_IternextUnpackEndCheck(__pyx_t_14(__pyx_t_13), 5) < 0) __PYX_ERR(0, 653, __pyx_L1_error)
       __pyx_t_14 = NULL;
       __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
       goto __pyx_L7_unpacking_done;
       __pyx_L6_unpacking_failed:;
       __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
       __pyx_t_14 = NULL;
       if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-      __PYX_ERR(0, 485, __pyx_L1_error)
+      __PYX_ERR(0, 653, __pyx_L1_error)
       __pyx_L7_unpacking_done:;
     }
     __Pyx_XDECREF_SET(__pyx_v_i, __pyx_t_6);
     __pyx_t_6 = 0;
-    __Pyx_XDECREF_SET(__pyx_v_j, __pyx_t_5);
-    __pyx_t_5 = 0;
+    __Pyx_XDECREF_SET(__pyx_v_j, __pyx_t_1);
+    __pyx_t_1 = 0;
     __Pyx_XDECREF_SET(__pyx_v_to, __pyx_t_3);
     __pyx_t_3 = 0;
-    __Pyx_XDECREF_SET(__pyx_v_frm, __pyx_t_1);
-    __pyx_t_1 = 0;
+    __Pyx_XDECREF_SET(__pyx_v_frm, __pyx_t_5);
+    __pyx_t_5 = 0;
     __Pyx_XDECREF_SET(__pyx_v_H_0, __pyx_t_12);
     __pyx_t_12 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":486
+    /* "tkwant/onebody/kernels.pyx":654
  *         self.tparams[self.time_name] = time
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:
  *             to = slice(*to)             # <<<<<<<<<<<<<<
  *             frm = slice(*frm)
  *             mat_el = self.H(i, j, params=self.tparams) - H_0
  */
-    __pyx_t_2 = __Pyx_PySequence_Tuple(__pyx_v_to); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 486, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PySequence_Tuple(__pyx_v_to); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 654, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_12 = __Pyx_PyObject_Call(((PyObject *)(&PySlice_Type)), __pyx_t_2, NULL); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 486, __pyx_L1_error)
+    __pyx_t_12 = __Pyx_PyObject_Call(((PyObject *)(&PySlice_Type)), __pyx_t_2, NULL); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 654, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_12);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF_SET(__pyx_v_to, __pyx_t_12);
     __pyx_t_12 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":487
+    /* "tkwant/onebody/kernels.pyx":655
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:
  *             to = slice(*to)
  *             frm = slice(*frm)             # <<<<<<<<<<<<<<
  *             mat_el = self.H(i, j, params=self.tparams) - H_0
  *             out[to] += np.dot(mat_el, ket[frm])
  */
-    __pyx_t_12 = __Pyx_PySequence_Tuple(__pyx_v_frm); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 487, __pyx_L1_error)
+    __pyx_t_12 = __Pyx_PySequence_Tuple(__pyx_v_frm); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 655, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_12);
-    __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)(&PySlice_Type)), __pyx_t_12, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 487, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)(&PySlice_Type)), __pyx_t_12, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 655, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
     __Pyx_DECREF_SET(__pyx_v_frm, __pyx_t_2);
     __pyx_t_2 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":488
+    /* "tkwant/onebody/kernels.pyx":656
  *             to = slice(*to)
  *             frm = slice(*frm)
  *             mat_el = self.H(i, j, params=self.tparams) - H_0             # <<<<<<<<<<<<<<
  *             out[to] += np.dot(mat_el, ket[frm])
  *             if i != j:
  */
-    __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 488, __pyx_L1_error)
+    __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 656, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_INCREF(__pyx_v_i);
     __Pyx_GIVEREF(__pyx_v_i);
     PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_v_i);
     __Pyx_INCREF(__pyx_v_j);
     __Pyx_GIVEREF(__pyx_v_j);
     PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_v_j);
-    __pyx_t_12 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 488, __pyx_L1_error)
+    __pyx_t_12 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 656, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_12);
-    if (PyDict_SetItem(__pyx_t_12, __pyx_n_s_params, __pyx_v_self->tparams) < 0) __PYX_ERR(0, 488, __pyx_L1_error)
-    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_v_self->H, __pyx_t_2, __pyx_t_12); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 488, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
+    if (PyDict_SetItem(__pyx_t_12, __pyx_n_s_params, __pyx_v_self->tparams) < 0) __PYX_ERR(0, 656, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_v_self->H, __pyx_t_2, __pyx_t_12); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 656, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
-    __pyx_t_12 = PyNumber_Subtract(__pyx_t_1, __pyx_v_H_0); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 488, __pyx_L1_error)
+    __pyx_t_12 = PyNumber_Subtract(__pyx_t_5, __pyx_v_H_0); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 656, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_12);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_XDECREF_SET(__pyx_v_mat_el, __pyx_t_12);
     __pyx_t_12 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":489
+    /* "tkwant/onebody/kernels.pyx":657
  *             frm = slice(*frm)
  *             mat_el = self.H(i, j, params=self.tparams) - H_0
  *             out[to] += np.dot(mat_el, ket[frm])             # <<<<<<<<<<<<<<
  *             if i != j:
  *                 out[frm] += np.dot(_herm_conj(mat_el), ket[to])
  */
     __Pyx_INCREF(__pyx_v_to);
     __pyx_t_12 = __pyx_v_to;
-    __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_out, __pyx_t_12); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 489, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 489, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_dot); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 489, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetItem(__pyx_v_out, __pyx_t_12); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 657, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 657, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_dot); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 657, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __pyx_t_3 = __Pyx_PyObject_GetItem(__pyx_v_ket, __pyx_v_frm); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 489, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyObject_GetItem(__pyx_v_ket, __pyx_v_frm); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 657, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __pyx_t_6 = NULL;
     __pyx_t_7 = 0;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_5))) {
-      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
+      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
       if (likely(__pyx_t_6)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
         __Pyx_INCREF(__pyx_t_6);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_5, function);
+        __Pyx_DECREF_SET(__pyx_t_1, function);
         __pyx_t_7 = 1;
       }
     }
     #if CYTHON_FAST_PYCALL
-    if (PyFunction_Check(__pyx_t_5)) {
+    if (PyFunction_Check(__pyx_t_1)) {
       PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_v_mat_el, __pyx_t_3};
-      __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 489, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_1, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 657, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     } else
     #endif
     #if CYTHON_FAST_PYCCALL
-    if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_1)) {
       PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_v_mat_el, __pyx_t_3};
-      __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 489, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_1, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 657, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     } else
     #endif
     {
-      __pyx_t_13 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 489, __pyx_L1_error)
+      __pyx_t_13 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 657, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_13);
       if (__pyx_t_6) {
         __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_t_6); __pyx_t_6 = NULL;
       }
       __Pyx_INCREF(__pyx_v_mat_el);
       __Pyx_GIVEREF(__pyx_v_mat_el);
       PyTuple_SET_ITEM(__pyx_t_13, 0+__pyx_t_7, __pyx_v_mat_el);
       __Pyx_GIVEREF(__pyx_t_3);
       PyTuple_SET_ITEM(__pyx_t_13, 1+__pyx_t_7, __pyx_t_3);
       __pyx_t_3 = 0;
-      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_13, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 489, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_13, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 657, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
     }
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_5 = PyNumber_InPlaceAdd(__pyx_t_1, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 489, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    if (unlikely(PyObject_SetItem(__pyx_v_out, __pyx_t_12, __pyx_t_5) < 0)) __PYX_ERR(0, 489, __pyx_L1_error)
+    __pyx_t_1 = PyNumber_InPlaceAdd(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 657, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    if (unlikely(PyObject_SetItem(__pyx_v_out, __pyx_t_12, __pyx_t_1) < 0)) __PYX_ERR(0, 657, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":490
+    /* "tkwant/onebody/kernels.pyx":658
  *             mat_el = self.H(i, j, params=self.tparams) - H_0
  *             out[to] += np.dot(mat_el, ket[frm])
  *             if i != j:             # <<<<<<<<<<<<<<
  *                 out[frm] += np.dot(_herm_conj(mat_el), ket[to])
  *         return out if do_return else None
  */
-    __pyx_t_12 = PyObject_RichCompare(__pyx_v_i, __pyx_v_j, Py_NE); __Pyx_XGOTREF(__pyx_t_12); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 490, __pyx_L1_error)
-    __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_12); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 490, __pyx_L1_error)
+    __pyx_t_12 = PyObject_RichCompare(__pyx_v_i, __pyx_v_j, Py_NE); __Pyx_XGOTREF(__pyx_t_12); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 658, __pyx_L1_error)
+    __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_12); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 658, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
     if (__pyx_t_9) {
 
-      /* "tkwant/onebody/kernels.pyx":491
+      /* "tkwant/onebody/kernels.pyx":659
  *             out[to] += np.dot(mat_el, ket[frm])
  *             if i != j:
  *                 out[frm] += np.dot(_herm_conj(mat_el), ket[to])             # <<<<<<<<<<<<<<
  *         return out if do_return else None
  * 
  */
       __Pyx_INCREF(__pyx_v_frm);
       __pyx_t_12 = __pyx_v_frm;
-      __pyx_t_5 = __Pyx_PyObject_GetItem(__pyx_v_out, __pyx_t_12); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 491, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 491, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_GetItem(__pyx_v_out, __pyx_t_12); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 659, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_dot); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 491, __pyx_L1_error)
+      __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 659, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_13 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_dot); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 659, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_13);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_herm_conj); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 491, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_herm_conj); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 659, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __pyx_t_6 = NULL;
       if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
         __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_3);
         if (likely(__pyx_t_6)) {
           PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
           __Pyx_INCREF(__pyx_t_6);
           __Pyx_INCREF(function);
           __Pyx_DECREF_SET(__pyx_t_3, function);
         }
       }
-      __pyx_t_1 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_3, __pyx_t_6, __pyx_v_mat_el) : __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_v_mat_el);
+      __pyx_t_5 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_3, __pyx_t_6, __pyx_v_mat_el) : __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_v_mat_el);
       __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-      if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 491, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
+      if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 659, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = __Pyx_PyObject_GetItem(__pyx_v_ket, __pyx_v_to); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 491, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyObject_GetItem(__pyx_v_ket, __pyx_v_to); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 659, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __pyx_t_6 = NULL;
       __pyx_t_7 = 0;
       if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_13))) {
         __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_13);
         if (likely(__pyx_t_6)) {
           PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_13);
@@ -10654,77 +13888,77 @@
           __Pyx_INCREF(function);
           __Pyx_DECREF_SET(__pyx_t_13, function);
           __pyx_t_7 = 1;
         }
       }
       #if CYTHON_FAST_PYCALL
       if (PyFunction_Check(__pyx_t_13)) {
-        PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_1, __pyx_t_3};
-        __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_13, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 491, __pyx_L1_error)
+        PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_5, __pyx_t_3};
+        __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_13, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 659, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
         __Pyx_GOTREF(__pyx_t_2);
-        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
         __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
       } else
       #endif
       #if CYTHON_FAST_PYCCALL
       if (__Pyx_PyFastCFunction_Check(__pyx_t_13)) {
-        PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_1, __pyx_t_3};
-        __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_13, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 491, __pyx_L1_error)
+        PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_5, __pyx_t_3};
+        __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_13, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 659, __pyx_L1_error)
         __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
         __Pyx_GOTREF(__pyx_t_2);
-        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
         __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
       } else
       #endif
       {
-        __pyx_t_15 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 491, __pyx_L1_error)
+        __pyx_t_15 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 659, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_15);
         if (__pyx_t_6) {
           __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_15, 0, __pyx_t_6); __pyx_t_6 = NULL;
         }
-        __Pyx_GIVEREF(__pyx_t_1);
-        PyTuple_SET_ITEM(__pyx_t_15, 0+__pyx_t_7, __pyx_t_1);
+        __Pyx_GIVEREF(__pyx_t_5);
+        PyTuple_SET_ITEM(__pyx_t_15, 0+__pyx_t_7, __pyx_t_5);
         __Pyx_GIVEREF(__pyx_t_3);
         PyTuple_SET_ITEM(__pyx_t_15, 1+__pyx_t_7, __pyx_t_3);
-        __pyx_t_1 = 0;
+        __pyx_t_5 = 0;
         __pyx_t_3 = 0;
-        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_13, __pyx_t_15, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 491, __pyx_L1_error)
+        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_13, __pyx_t_15, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 659, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_2);
         __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
       }
       __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-      __pyx_t_13 = PyNumber_InPlaceAdd(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 491, __pyx_L1_error)
+      __pyx_t_13 = PyNumber_InPlaceAdd(__pyx_t_1, __pyx_t_2); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 659, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_13);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      if (unlikely(PyObject_SetItem(__pyx_v_out, __pyx_t_12, __pyx_t_13) < 0)) __PYX_ERR(0, 491, __pyx_L1_error)
+      if (unlikely(PyObject_SetItem(__pyx_v_out, __pyx_t_12, __pyx_t_13) < 0)) __PYX_ERR(0, 659, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
       __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":490
+      /* "tkwant/onebody/kernels.pyx":658
  *             mat_el = self.H(i, j, params=self.tparams) - H_0
  *             out[to] += np.dot(mat_el, ket[frm])
  *             if i != j:             # <<<<<<<<<<<<<<
  *                 out[frm] += np.dot(_herm_conj(mat_el), ket[to])
  *         return out if do_return else None
  */
     }
 
-    /* "tkwant/onebody/kernels.pyx":485
+    /* "tkwant/onebody/kernels.pyx":653
  *                                                                self.size)
  *         self.tparams[self.time_name] = time
  *         for i, j, to, frm, H_0 in self.td_hamiltonian:             # <<<<<<<<<<<<<<
  *             to = slice(*to)
  *             frm = slice(*frm)
  */
   }
   __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":492
+  /* "tkwant/onebody/kernels.pyx":660
  *             if i != j:
  *                 out[frm] += np.dot(_herm_conj(mat_el), ket[to])
  *         return out if do_return else None             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __Pyx_XDECREF(__pyx_r);
@@ -10735,15 +13969,15 @@
     __Pyx_INCREF(Py_None);
     __pyx_t_8 = Py_None;
   }
   __pyx_r = __pyx_t_8;
   __pyx_t_8 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":458
+  /* "tkwant/onebody/kernels.pyx":625
  *             self.data(time, out.data)
  * 
  *     def apply(self, double time, ket, out=None):             # <<<<<<<<<<<<<<
  *         '''Evaluate the matrix-vector product W(t) @ ket for the given time.
  * 
  */
 
@@ -10801,14 +14035,17 @@
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   int __pyx_t_4;
   int __pyx_t_5;
   int __pyx_t_6;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__reduce_cython__", 0);
 
   /* "(tree fragment)":5
  *     cdef object _dict
  *     cdef bint use_setstate
  *     state = (self.H, self.nnz, self.size, self.td_hamiltonian, self.time_name, self.tparams)             # <<<<<<<<<<<<<<
  *     _dict = getattr(self, '__dict__', None)
@@ -11070,22 +14307,25 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_21PerturbationExtractor_14__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setstate_cython__", 0);
 
   /* "(tree fragment)":17
  *         return __pyx_unpickle_PerturbationExtractor, (type(self), 0x26d3271, state)
  * def __setstate_cython__(self, __pyx_state):
  *     __pyx_unpickle_PerturbationExtractor__set_state(self, __pyx_state)             # <<<<<<<<<<<<<<
  */
-  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
+  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
   __pyx_t_1 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_PerturbationExtractor__set_state(__pyx_v_self, ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 17, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
   /* "(tree fragment)":16
  *     else:
  *         return __pyx_unpickle_PerturbationExtractor, (type(self), 0x26d3271, state)
@@ -11102,38 +14342,41 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":545
- *     cdef unsigned nnz
+/* "tkwant/onebody/kernels.pyx":701
+ *         object intfunc
  * 
- *     def __init__(self, syst, time_name, time_start, params=None, dt=1):             # <<<<<<<<<<<<<<
+ *     def __init__(self, syst, time_name, time_start, params=None, interpolation_type=Interpolation):             # <<<<<<<<<<<<<<
  * 
- *         # The spline interpolation in this routine is done "on the fly".
+ *         self.wfunc = PerturbationExtractor(syst, time_name, time_start, params)
  */
 
 /* Python wrapper */
 static int __pyx_pw_6tkwant_7onebody_7kernels_24PerturbationInterpolator_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static int __pyx_pw_6tkwant_7onebody_7kernels_24PerturbationInterpolator_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_syst = 0;
   PyObject *__pyx_v_time_name = 0;
   PyObject *__pyx_v_time_start = 0;
   PyObject *__pyx_v_params = 0;
-  PyObject *__pyx_v_dt = 0;
+  PyObject *__pyx_v_interpolation_type = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_syst,&__pyx_n_s_time_name,&__pyx_n_s_time_start,&__pyx_n_s_params,&__pyx_n_s_dt,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_syst,&__pyx_n_s_time_name,&__pyx_n_s_time_start,&__pyx_n_s_params,&__pyx_n_s_interpolation_type,0};
     PyObject* values[5] = {0,0,0,0,0};
     values[3] = ((PyObject *)Py_None);
-    values[4] = ((PyObject *)__pyx_int_1);
+    values[4] = __pyx_k__3;
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
         case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
         CYTHON_FALLTHROUGH;
         case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
@@ -11152,37 +14395,37 @@
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_syst)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time_name)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 5, 1); __PYX_ERR(0, 545, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 5, 1); __PYX_ERR(0, 701, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
         if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time_start)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 5, 2); __PYX_ERR(0, 545, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 5, 2); __PYX_ERR(0, 701, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_params);
           if (value) { values[3] = value; kw_args--; }
         }
         CYTHON_FALLTHROUGH;
         case  4:
         if (kw_args > 0) {
-          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_dt);
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_interpolation_type);
           if (value) { values[4] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 545, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 701, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
         CYTHON_FALLTHROUGH;
         case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
@@ -11193,114 +14436,98 @@
         default: goto __pyx_L5_argtuple_error;
       }
     }
     __pyx_v_syst = values[0];
     __pyx_v_time_name = values[1];
     __pyx_v_time_start = values[2];
     __pyx_v_params = values[3];
-    __pyx_v_dt = values[4];
+    __pyx_v_interpolation_type = values[4];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 5, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 545, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 5, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 701, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationInterpolator.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)__pyx_v_self), __pyx_v_syst, __pyx_v_time_name, __pyx_v_time_start, __pyx_v_params, __pyx_v_dt);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)__pyx_v_self), __pyx_v_syst, __pyx_v_time_name, __pyx_v_time_start, __pyx_v_params, __pyx_v_interpolation_type);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static int __pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator___init__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, PyObject *__pyx_v_syst, PyObject *__pyx_v_time_name, PyObject *__pyx_v_time_start, PyObject *__pyx_v_params, PyObject *__pyx_v_dt) {
+static int __pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator___init__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, PyObject *__pyx_v_syst, PyObject *__pyx_v_time_name, PyObject *__pyx_v_time_start, PyObject *__pyx_v_params, PyObject *__pyx_v_interpolation_type) {
   CYTHON_UNUSED PyObject *__pyx_v__ = NULL;
   PyObject *__pyx_v_norbs = NULL;
-  PyObject *__pyx_v_Ht02 = NULL;
-  PyObject *__pyx_v_Ht12 = NULL;
-  PyObject *__pyx_v_Ht22 = NULL;
-  double __pyx_v_rdt2;
-  double __pyx_v_rdt2h;
-  double __pyx_v_cl0;
-  double __pyx_v_cl1;
-  double __pyx_v_cl2;
-  double __pyx_v_cl3;
-  double __pyx_v_cl4;
-  double __pyx_v_cl5;
-  unsigned int __pyx_v_i;
-  double __pyx_v_cc2;
-  double __pyx_v_cc1;
-  double __pyx_v_cc0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
   PyObject *(*__pyx_t_6)(PyObject *);
   unsigned int __pyx_t_7;
-  double __pyx_t_8;
-  int __pyx_t_9;
-  unsigned int __pyx_t_10;
-  unsigned int __pyx_t_11;
-  double __pyx_t_12;
+  int __pyx_t_8;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":565
- *         # We use a foreward derivative in this case.
+  /* "tkwant/onebody/kernels.pyx":703
+ *     def __init__(self, syst, time_name, time_start, params=None, interpolation_type=Interpolation):
  * 
  *         self.wfunc = PerturbationExtractor(syst, time_name, time_start, params)             # <<<<<<<<<<<<<<
  * 
  *         # for non-vectorized systems
  */
-  __pyx_t_1 = PyTuple_New(4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 565, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_New(4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 703, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_INCREF(__pyx_v_syst);
   __Pyx_GIVEREF(__pyx_v_syst);
   PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_v_syst);
   __Pyx_INCREF(__pyx_v_time_name);
   __Pyx_GIVEREF(__pyx_v_time_name);
   PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_v_time_name);
   __Pyx_INCREF(__pyx_v_time_start);
   __Pyx_GIVEREF(__pyx_v_time_start);
   PyTuple_SET_ITEM(__pyx_t_1, 2, __pyx_v_time_start);
   __Pyx_INCREF(__pyx_v_params);
   __Pyx_GIVEREF(__pyx_v_params);
   PyTuple_SET_ITEM(__pyx_t_1, 3, __pyx_v_params);
-  __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_PerturbationExtractor), __pyx_t_1, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 565, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_PerturbationExtractor), __pyx_t_1, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 703, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_GIVEREF(__pyx_t_2);
   __Pyx_GOTREF(__pyx_v_self->wfunc);
   __Pyx_DECREF(__pyx_v_self->wfunc);
   __pyx_v_self->wfunc = __pyx_t_2;
   __pyx_t_2 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":568
+  /* "tkwant/onebody/kernels.pyx":706
  * 
  *         # for non-vectorized systems
  *         _, _, norbs = syst.site_ranges[-1]             # <<<<<<<<<<<<<<
  *         self.size = norbs
  *         self.nnz = self.wfunc.nnz
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_site_ranges); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 568, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_syst, __pyx_n_s_site_ranges); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 706, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_2, -1L, long, 1, __Pyx_PyInt_From_long, 0, 1, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 568, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_2, -1L, long, 1, __Pyx_PyInt_From_long, 0, 1, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 706, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
     PyObject* sequence = __pyx_t_1;
     Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
     if (unlikely(size != 3)) {
       if (size > 3) __Pyx_RaiseTooManyValuesError(3);
       else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-      __PYX_ERR(0, 568, __pyx_L1_error)
+      __PYX_ERR(0, 706, __pyx_L1_error)
     }
     #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
     if (likely(PyTuple_CheckExact(sequence))) {
       __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
       __pyx_t_3 = PyTuple_GET_ITEM(sequence, 1); 
       __pyx_t_4 = PyTuple_GET_ITEM(sequence, 2); 
     } else {
@@ -11308,1058 +14535,174 @@
       __pyx_t_3 = PyList_GET_ITEM(sequence, 1); 
       __pyx_t_4 = PyList_GET_ITEM(sequence, 2); 
     }
     __Pyx_INCREF(__pyx_t_2);
     __Pyx_INCREF(__pyx_t_3);
     __Pyx_INCREF(__pyx_t_4);
     #else
-    __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 568, __pyx_L1_error)
+    __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 706, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_3 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 568, __pyx_L1_error)
+    __pyx_t_3 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 706, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_4 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 568, __pyx_L1_error)
+    __pyx_t_4 = PySequence_ITEM(sequence, 2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 706, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     #endif
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   } else {
     Py_ssize_t index = -1;
-    __pyx_t_5 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 568, __pyx_L1_error)
+    __pyx_t_5 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 706, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_t_6 = Py_TYPE(__pyx_t_5)->tp_iternext;
     index = 0; __pyx_t_2 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_2)) goto __pyx_L3_unpacking_failed;
     __Pyx_GOTREF(__pyx_t_2);
     index = 1; __pyx_t_3 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_3)) goto __pyx_L3_unpacking_failed;
     __Pyx_GOTREF(__pyx_t_3);
     index = 2; __pyx_t_4 = __pyx_t_6(__pyx_t_5); if (unlikely(!__pyx_t_4)) goto __pyx_L3_unpacking_failed;
     __Pyx_GOTREF(__pyx_t_4);
-    if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 3) < 0) __PYX_ERR(0, 568, __pyx_L1_error)
+    if (__Pyx_IternextUnpackEndCheck(__pyx_t_6(__pyx_t_5), 3) < 0) __PYX_ERR(0, 706, __pyx_L1_error)
     __pyx_t_6 = NULL;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     goto __pyx_L4_unpacking_done;
     __pyx_L3_unpacking_failed:;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __pyx_t_6 = NULL;
     if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-    __PYX_ERR(0, 568, __pyx_L1_error)
+    __PYX_ERR(0, 706, __pyx_L1_error)
     __pyx_L4_unpacking_done:;
   }
   __pyx_v__ = __pyx_t_2;
   __pyx_t_2 = 0;
   __Pyx_DECREF_SET(__pyx_v__, __pyx_t_3);
   __pyx_t_3 = 0;
   __pyx_v_norbs = __pyx_t_4;
   __pyx_t_4 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":569
+  /* "tkwant/onebody/kernels.pyx":707
  *         # for non-vectorized systems
  *         _, _, norbs = syst.site_ranges[-1]
  *         self.size = norbs             # <<<<<<<<<<<<<<
  *         self.nnz = self.wfunc.nnz
- *         self.time_start = time_start
+ * 
  */
-  __pyx_t_7 = __Pyx_PyInt_As_unsigned_int(__pyx_v_norbs); if (unlikely((__pyx_t_7 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(0, 569, __pyx_L1_error)
+  __pyx_t_7 = __Pyx_PyInt_As_unsigned_int(__pyx_v_norbs); if (unlikely((__pyx_t_7 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(0, 707, __pyx_L1_error)
   __pyx_v_self->size = __pyx_t_7;
 
-  /* "tkwant/onebody/kernels.pyx":570
+  /* "tkwant/onebody/kernels.pyx":708
  *         _, _, norbs = syst.site_ranges[-1]
  *         self.size = norbs
  *         self.nnz = self.wfunc.nnz             # <<<<<<<<<<<<<<
- *         self.time_start = time_start
- *         self.time_name = time_name
+ * 
+ *         self.intfunc = interpolation_type(self.wfunc.data, time_start)
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 570, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 708, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_7 = __Pyx_PyInt_As_unsigned_int(__pyx_t_1); if (unlikely((__pyx_t_7 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(0, 570, __pyx_L1_error)
+  __pyx_t_7 = __Pyx_PyInt_As_unsigned_int(__pyx_t_1); if (unlikely((__pyx_t_7 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(0, 708, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_v_self->nnz = __pyx_t_7;
 
-  /* "tkwant/onebody/kernels.pyx":571
- *         self.size = norbs
- *         self.nnz = self.wfunc.nnz
- *         self.time_start = time_start             # <<<<<<<<<<<<<<
- *         self.time_name = time_name
- *         self.dt = dt
- */
-  __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_v_time_start); if (unlikely((__pyx_t_8 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 571, __pyx_L1_error)
-  __pyx_v_self->time_start = __pyx_t_8;
-
-  /* "tkwant/onebody/kernels.pyx":572
+  /* "tkwant/onebody/kernels.pyx":710
  *         self.nnz = self.wfunc.nnz
- *         self.time_start = time_start
- *         self.time_name = time_name             # <<<<<<<<<<<<<<
- *         self.dt = dt
- * 
- */
-  __Pyx_INCREF(__pyx_v_time_name);
-  __Pyx_GIVEREF(__pyx_v_time_name);
-  __Pyx_GOTREF(__pyx_v_self->time_name);
-  __Pyx_DECREF(__pyx_v_self->time_name);
-  __pyx_v_self->time_name = __pyx_v_time_name;
-
-  /* "tkwant/onebody/kernels.pyx":573
- *         self.time_start = time_start
- *         self.time_name = time_name
- *         self.dt = dt             # <<<<<<<<<<<<<<
- * 
- *         if dt > 0:
- */
-  __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_v_dt); if (unlikely((__pyx_t_8 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 573, __pyx_L1_error)
-  __pyx_v_self->dt = __pyx_t_8;
-
-  /* "tkwant/onebody/kernels.pyx":575
- *         self.dt = dt
- * 
- *         if dt > 0:             # <<<<<<<<<<<<<<
- * 
- *             self.t0 = time_start
- */
-  __pyx_t_1 = PyObject_RichCompare(__pyx_v_dt, __pyx_int_0, Py_GT); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 575, __pyx_L1_error)
-  __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 575, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  if (__pyx_t_9) {
-
-    /* "tkwant/onebody/kernels.pyx":577
- *         if dt > 0:
- * 
- *             self.t0 = time_start             # <<<<<<<<<<<<<<
- *             self.t1 = self.t0 + self.dt
- *             self.t2 = self.t1 + self.dt
- */
-    __pyx_t_8 = __pyx_PyFloat_AsDouble(__pyx_v_time_start); if (unlikely((__pyx_t_8 == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 577, __pyx_L1_error)
-    __pyx_v_self->t0 = __pyx_t_8;
-
-    /* "tkwant/onebody/kernels.pyx":578
- * 
- *             self.t0 = time_start
- *             self.t1 = self.t0 + self.dt             # <<<<<<<<<<<<<<
- *             self.t2 = self.t1 + self.dt
- *             self.t3 = self.t2 + self.dt
- */
-    __pyx_v_self->t1 = (__pyx_v_self->t0 + __pyx_v_self->dt);
-
-    /* "tkwant/onebody/kernels.pyx":579
- *             self.t0 = time_start
- *             self.t1 = self.t0 + self.dt
- *             self.t2 = self.t1 + self.dt             # <<<<<<<<<<<<<<
- *             self.t3 = self.t2 + self.dt
- *             self.t4 = self.t3 + self.dt
- */
-    __pyx_v_self->t2 = (__pyx_v_self->t1 + __pyx_v_self->dt);
-
-    /* "tkwant/onebody/kernels.pyx":580
- *             self.t1 = self.t0 + self.dt
- *             self.t2 = self.t1 + self.dt
- *             self.t3 = self.t2 + self.dt             # <<<<<<<<<<<<<<
- *             self.t4 = self.t3 + self.dt
- * 
- */
-    __pyx_v_self->t3 = (__pyx_v_self->t2 + __pyx_v_self->dt);
-
-    /* "tkwant/onebody/kernels.pyx":581
- *             self.t2 = self.t1 + self.dt
- *             self.t3 = self.t2 + self.dt
- *             self.t4 = self.t3 + self.dt             # <<<<<<<<<<<<<<
  * 
- *             self.Ht0 = self.wfunc.data(self.t0)
- */
-    __pyx_v_self->t4 = (__pyx_v_self->t3 + __pyx_v_self->dt);
-
-    /* "tkwant/onebody/kernels.pyx":583
- *             self.t4 = self.t3 + self.dt
- * 
- *             self.Ht0 = self.wfunc.data(self.t0)             # <<<<<<<<<<<<<<
- *             self.Ht1 = self.wfunc.data(self.t1)
- *             self.Ht2 = self.wfunc.data(self.t2)
- */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 583, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_self->t0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 583, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_2)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_2);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-      }
-    }
-    __pyx_t_1 = (__pyx_t_2) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3);
-    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 583, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_GIVEREF(__pyx_t_1);
-    __Pyx_GOTREF(__pyx_v_self->Ht0);
-    __Pyx_DECREF(__pyx_v_self->Ht0);
-    __pyx_v_self->Ht0 = __pyx_t_1;
-    __pyx_t_1 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":584
- * 
- *             self.Ht0 = self.wfunc.data(self.t0)
- *             self.Ht1 = self.wfunc.data(self.t1)             # <<<<<<<<<<<<<<
- *             self.Ht2 = self.wfunc.data(self.t2)
- *             self.Ht3 = self.wfunc.data(self.t3)
- */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 584, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_self->t1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 584, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_2)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_2);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-      }
-    }
-    __pyx_t_1 = (__pyx_t_2) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3);
-    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 584, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_GIVEREF(__pyx_t_1);
-    __Pyx_GOTREF(__pyx_v_self->Ht1);
-    __Pyx_DECREF(__pyx_v_self->Ht1);
-    __pyx_v_self->Ht1 = __pyx_t_1;
-    __pyx_t_1 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":585
- *             self.Ht0 = self.wfunc.data(self.t0)
- *             self.Ht1 = self.wfunc.data(self.t1)
- *             self.Ht2 = self.wfunc.data(self.t2)             # <<<<<<<<<<<<<<
- *             self.Ht3 = self.wfunc.data(self.t3)
- *             self.Ht4 = self.wfunc.data(self.t4)
- */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 585, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_self->t2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 585, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_2)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_2);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-      }
-    }
-    __pyx_t_1 = (__pyx_t_2) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3);
-    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 585, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_GIVEREF(__pyx_t_1);
-    __Pyx_GOTREF(__pyx_v_self->Ht2);
-    __Pyx_DECREF(__pyx_v_self->Ht2);
-    __pyx_v_self->Ht2 = __pyx_t_1;
-    __pyx_t_1 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":586
- *             self.Ht1 = self.wfunc.data(self.t1)
- *             self.Ht2 = self.wfunc.data(self.t2)
- *             self.Ht3 = self.wfunc.data(self.t3)             # <<<<<<<<<<<<<<
- *             self.Ht4 = self.wfunc.data(self.t4)
+ *         self.intfunc = interpolation_type(self.wfunc.data, time_start)             # <<<<<<<<<<<<<<
+ *         self.wt = self.wfunc.empty()
  * 
  */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 586, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_self->t3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 586, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_2)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_2);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-      }
-    }
-    __pyx_t_1 = (__pyx_t_2) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3);
-    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 586, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_GIVEREF(__pyx_t_1);
-    __Pyx_GOTREF(__pyx_v_self->Ht3);
-    __Pyx_DECREF(__pyx_v_self->Ht3);
-    __pyx_v_self->Ht3 = __pyx_t_1;
-    __pyx_t_1 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":587
- *             self.Ht2 = self.wfunc.data(self.t2)
- *             self.Ht3 = self.wfunc.data(self.t3)
- *             self.Ht4 = self.wfunc.data(self.t4)             # <<<<<<<<<<<<<<
- * 
- *             Ht02 = self.wfunc.data(self.t0 + 0.5 * self.dt)
- */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 587, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_3 = PyFloat_FromDouble(__pyx_v_self->t4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 587, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_2)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_2);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-      }
-    }
-    __pyx_t_1 = (__pyx_t_2) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3);
-    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 587, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_GIVEREF(__pyx_t_1);
-    __Pyx_GOTREF(__pyx_v_self->Ht4);
-    __Pyx_DECREF(__pyx_v_self->Ht4);
-    __pyx_v_self->Ht4 = __pyx_t_1;
-    __pyx_t_1 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":589
- *             self.Ht4 = self.wfunc.data(self.t4)
- * 
- *             Ht02 = self.wfunc.data(self.t0 + 0.5 * self.dt)             # <<<<<<<<<<<<<<
- *             Ht12 = self.wfunc.data(self.t0 + 1.5 * self.dt)
- *             Ht22 = self.wfunc.data(self.t0 + 2.5 * self.dt)
- */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 589, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_3 = PyFloat_FromDouble((__pyx_v_self->t0 + (0.5 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 589, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_2)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_2);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-      }
-    }
-    __pyx_t_1 = (__pyx_t_2) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3);
-    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 589, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_v_Ht02 = __pyx_t_1;
-    __pyx_t_1 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":590
- * 
- *             Ht02 = self.wfunc.data(self.t0 + 0.5 * self.dt)
- *             Ht12 = self.wfunc.data(self.t0 + 1.5 * self.dt)             # <<<<<<<<<<<<<<
- *             Ht22 = self.wfunc.data(self.t0 + 2.5 * self.dt)
- * 
- */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 590, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_3 = PyFloat_FromDouble((__pyx_v_self->t0 + (1.5 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 590, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_2)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_2);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-      }
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 710, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_INCREF(__pyx_v_interpolation_type);
+  __pyx_t_3 = __pyx_v_interpolation_type; __pyx_t_2 = NULL;
+  __pyx_t_8 = 0;
+  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_2)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_2);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
+      __pyx_t_8 = 1;
     }
-    __pyx_t_1 = (__pyx_t_2) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3);
+  }
+  #if CYTHON_FAST_PYCALL
+  if (PyFunction_Check(__pyx_t_3)) {
+    PyObject *__pyx_temp[3] = {__pyx_t_2, __pyx_t_4, __pyx_v_time_start};
+    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 710, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 590, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_v_Ht12 = __pyx_t_1;
-    __pyx_t_1 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":591
- *             Ht02 = self.wfunc.data(self.t0 + 0.5 * self.dt)
- *             Ht12 = self.wfunc.data(self.t0 + 1.5 * self.dt)
- *             Ht22 = self.wfunc.data(self.t0 + 2.5 * self.dt)             # <<<<<<<<<<<<<<
- * 
- *             rdt2 = 1 / (self.dt * self.dt)
- */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 591, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_3 = PyFloat_FromDouble((__pyx_v_self->t0 + (2.5 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 591, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_2)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_2);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-      }
-    }
-    __pyx_t_1 = (__pyx_t_2) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3);
+  } else
+  #endif
+  #if CYTHON_FAST_PYCCALL
+  if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
+    PyObject *__pyx_temp[3] = {__pyx_t_2, __pyx_t_4, __pyx_v_time_start};
+    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 710, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 591, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_v_Ht22 = __pyx_t_1;
-    __pyx_t_1 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":593
- *             Ht22 = self.wfunc.data(self.t0 + 2.5 * self.dt)
- * 
- *             rdt2 = 1 / (self.dt * self.dt)             # <<<<<<<<<<<<<<
- *             rdt2h = 4 * rdt2
- * 
- */
-    __pyx_t_8 = (__pyx_v_self->dt * __pyx_v_self->dt);
-    if (unlikely(__pyx_t_8 == 0)) {
-      PyErr_SetString(PyExc_ZeroDivisionError, "float division");
-      __PYX_ERR(0, 593, __pyx_L1_error)
-    }
-    __pyx_v_rdt2 = (1.0 / __pyx_t_8);
-
-    /* "tkwant/onebody/kernels.pyx":594
- * 
- *             rdt2 = 1 / (self.dt * self.dt)
- *             rdt2h = 4 * rdt2             # <<<<<<<<<<<<<<
- * 
- *             # w''(t0), forward finite difference scheme (4. order)
- */
-    __pyx_v_rdt2h = (4.0 * __pyx_v_rdt2);
-
-    /* "tkwant/onebody/kernels.pyx":598
- *             # w''(t0), forward finite difference scheme (4. order)
- *             # on the half interval dt / 2
- *             cl0 = 15 / 4 * rdt2h             # <<<<<<<<<<<<<<
- *             cl1 = -77 / 6 * rdt2h
- *             cl2 = 107 / 6 * rdt2h
- */
-    __pyx_v_cl0 = ((15.0 / 4.0) * __pyx_v_rdt2h);
-
-    /* "tkwant/onebody/kernels.pyx":599
- *             # on the half interval dt / 2
- *             cl0 = 15 / 4 * rdt2h
- *             cl1 = -77 / 6 * rdt2h             # <<<<<<<<<<<<<<
- *             cl2 = 107 / 6 * rdt2h
- *             cl3 = -13 * rdt2h
- */
-    __pyx_v_cl1 = ((-77.0 / 6.0) * __pyx_v_rdt2h);
-
-    /* "tkwant/onebody/kernels.pyx":600
- *             cl0 = 15 / 4 * rdt2h
- *             cl1 = -77 / 6 * rdt2h
- *             cl2 = 107 / 6 * rdt2h             # <<<<<<<<<<<<<<
- *             cl3 = -13 * rdt2h
- *             cl4 = 61 / 12 * rdt2h
- */
-    __pyx_v_cl2 = ((107.0 / 6.0) * __pyx_v_rdt2h);
-
-    /* "tkwant/onebody/kernels.pyx":601
- *             cl1 = -77 / 6 * rdt2h
- *             cl2 = 107 / 6 * rdt2h
- *             cl3 = -13 * rdt2h             # <<<<<<<<<<<<<<
- *             cl4 = 61 / 12 * rdt2h
- *             cl5 = -5 / 6 * rdt2h
- */
-    __pyx_v_cl3 = (-13.0 * __pyx_v_rdt2h);
-
-    /* "tkwant/onebody/kernels.pyx":602
- *             cl2 = 107 / 6 * rdt2h
- *             cl3 = -13 * rdt2h
- *             cl4 = 61 / 12 * rdt2h             # <<<<<<<<<<<<<<
- *             cl5 = -5 / 6 * rdt2h
- *             self.d2Ht0 = np.zeros((self.nnz,), dtype=np.complex)
- */
-    __pyx_v_cl4 = ((61.0 / 12.0) * __pyx_v_rdt2h);
-
-    /* "tkwant/onebody/kernels.pyx":603
- *             cl3 = -13 * rdt2h
- *             cl4 = 61 / 12 * rdt2h
- *             cl5 = -5 / 6 * rdt2h             # <<<<<<<<<<<<<<
- *             self.d2Ht0 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):
- */
-    __pyx_v_cl5 = ((-5.0 / 6.0) * __pyx_v_rdt2h);
-
-    /* "tkwant/onebody/kernels.pyx":604
- *             cl4 = 61 / 12 * rdt2h
- *             cl5 = -5 / 6 * rdt2h
- *             self.d2Ht0 = np.zeros((self.nnz,), dtype=np.complex)             # <<<<<<<<<<<<<<
- *             for i in range(self.nnz):
- *                 self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \
- */
-    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 604, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 604, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_1 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 604, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 604, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_GIVEREF(__pyx_t_1);
-    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
-    __pyx_t_1 = 0;
-    __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 604, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_GIVEREF(__pyx_t_3);
-    PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_3);
-    __pyx_t_3 = 0;
-    __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 604, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 604, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_complex); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 604, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_5) < 0) __PYX_ERR(0, 604, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 604, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __Pyx_GIVEREF(__pyx_t_5);
-    __Pyx_GOTREF(__pyx_v_self->d2Ht0);
-    __Pyx_DECREF(__pyx_v_self->d2Ht0);
-    __pyx_v_self->d2Ht0 = __pyx_t_5;
-    __pyx_t_5 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":605
- *             cl5 = -5 / 6 * rdt2h
- *             self.d2Ht0 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                 self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \
- *                     + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]
- */
-    __pyx_t_7 = __pyx_v_self->nnz;
-    __pyx_t_10 = __pyx_t_7;
-    for (__pyx_t_11 = 0; __pyx_t_11 < __pyx_t_10; __pyx_t_11+=1) {
-      __pyx_v_i = __pyx_t_11;
-
-      /* "tkwant/onebody/kernels.pyx":606
- *             self.d2Ht0 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):
- *                 self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \             # <<<<<<<<<<<<<<
- *                     + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]
- * 
- */
-      __pyx_t_5 = PyFloat_FromDouble(__pyx_v_cl0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_1 = PyNumber_Multiply(__pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = PyFloat_FromDouble(__pyx_v_cl1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_Ht02, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_4 = PyNumber_Multiply(__pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = PyNumber_Add(__pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cl2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_3 = PyNumber_Multiply(__pyx_t_4, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __pyx_t_1 = PyNumber_Add(__pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-      /* "tkwant/onebody/kernels.pyx":607
- *             for i in range(self.nnz):
- *                 self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \
- *                     + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]             # <<<<<<<<<<<<<<
- * 
- *             # w''(t2), central finite difference scheme (4. order)
- */
-      __pyx_t_3 = PyFloat_FromDouble(__pyx_v_cl3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_Ht12, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_4 = PyNumber_Multiply(__pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = PyNumber_Add(__pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cl4); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_3 = PyNumber_Multiply(__pyx_t_4, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __pyx_t_1 = PyNumber_Add(__pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = PyFloat_FromDouble(__pyx_v_cl5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_Ht22, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_4 = PyNumber_Multiply(__pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = PyNumber_Add(__pyx_t_1, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 607, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-      /* "tkwant/onebody/kernels.pyx":606
- *             self.d2Ht0 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):
- *                 self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \             # <<<<<<<<<<<<<<
- *                     + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]
- * 
- */
-      if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, __pyx_t_5, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1) < 0)) __PYX_ERR(0, 606, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    }
-
-    /* "tkwant/onebody/kernels.pyx":610
- * 
- *             # w''(t2), central finite difference scheme (4. order)
- *             cc2 = - rdt2 / 12             # <<<<<<<<<<<<<<
- *             cc1 = rdt2 * 4 / 3
- *             cc0 = - 2.5 * rdt2
- */
-    __pyx_v_cc2 = ((-__pyx_v_rdt2) / 12.0);
-
-    /* "tkwant/onebody/kernels.pyx":611
- *             # w''(t2), central finite difference scheme (4. order)
- *             cc2 = - rdt2 / 12
- *             cc1 = rdt2 * 4 / 3             # <<<<<<<<<<<<<<
- *             cc0 = - 2.5 * rdt2
- *             self.d2Ht2 = np.zeros((self.nnz,), dtype=np.complex)
- */
-    __pyx_v_cc1 = ((__pyx_v_rdt2 * 4.0) / 3.0);
-
-    /* "tkwant/onebody/kernels.pyx":612
- *             cc2 = - rdt2 / 12
- *             cc1 = rdt2 * 4 / 3
- *             cc0 = - 2.5 * rdt2             # <<<<<<<<<<<<<<
- *             self.d2Ht2 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):
- */
-    __pyx_v_cc0 = (-2.5 * __pyx_v_rdt2);
-
-    /* "tkwant/onebody/kernels.pyx":613
- *             cc1 = rdt2 * 4 / 3
- *             cc0 = - 2.5 * rdt2
- *             self.d2Ht2 = np.zeros((self.nnz,), dtype=np.complex)             # <<<<<<<<<<<<<<
- *             for i in range(self.nnz):
- *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- */
-    __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_5 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_GIVEREF(__pyx_t_5);
-    PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_5);
-    __pyx_t_5 = 0;
-    __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __Pyx_GIVEREF(__pyx_t_1);
-    PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_1);
-    __pyx_t_1 = 0;
-    __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_complex); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, __pyx_t_2) < 0) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, __pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 613, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __Pyx_GIVEREF(__pyx_t_2);
-    __Pyx_GOTREF(__pyx_v_self->d2Ht2);
-    __Pyx_DECREF(__pyx_v_self->d2Ht2);
-    __pyx_v_self->d2Ht2 = __pyx_t_2;
-    __pyx_t_2 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":614
- *             cc0 = - 2.5 * rdt2
- *             self.d2Ht2 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- */
-    __pyx_t_7 = __pyx_v_self->nnz;
-    __pyx_t_10 = __pyx_t_7;
-    for (__pyx_t_11 = 0; __pyx_t_11 < __pyx_t_10; __pyx_t_11+=1) {
-      __pyx_v_i = __pyx_t_11;
-
-      /* "tkwant/onebody/kernels.pyx":615
- *             self.d2Ht2 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):
- *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
- *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- *                     + cc0 * self.Ht2[i]
- */
-      __pyx_t_2 = PyFloat_FromDouble(__pyx_v_cc2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 615, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 615, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht4, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 615, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_4 = PyNumber_Add(__pyx_t_1, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 615, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = PyNumber_Multiply(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 615, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-      /* "tkwant/onebody/kernels.pyx":616
- *             for i in range(self.nnz):
- *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \             # <<<<<<<<<<<<<<
- *                     + cc0 * self.Ht2[i]
- * 
- */
-      __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cc1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 616, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 616, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_self->Ht3, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 616, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_3 = PyNumber_Add(__pyx_t_2, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 616, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __pyx_t_1 = PyNumber_Multiply(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 616, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = PyNumber_Add(__pyx_t_5, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 616, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-      /* "tkwant/onebody/kernels.pyx":617
- *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- *                     + cc0 * self.Ht2[i]             # <<<<<<<<<<<<<<
- * 
- *             # w''(t1), spline formula
- */
-      __pyx_t_1 = PyFloat_FromDouble(__pyx_v_cc0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 617, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 617, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_4 = PyNumber_Multiply(__pyx_t_1, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 617, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = PyNumber_Add(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 617, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-      /* "tkwant/onebody/kernels.pyx":615
- *             self.d2Ht2 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):
- *                 self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
- *                     + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- *                     + cc0 * self.Ht2[i]
- */
-      if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, __pyx_t_5, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1) < 0)) __PYX_ERR(0, 615, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    }
-
-    /* "tkwant/onebody/kernels.pyx":620
- * 
- *             # w''(t1), spline formula
- *             self.d2Ht1 = np.zeros((self.nnz,), dtype=np.complex)             # <<<<<<<<<<<<<<
- *             for i in range(self.nnz):
- *                 self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \
- */
-    __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 620, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_zeros); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 620, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __pyx_t_5 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 620, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 620, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_GIVEREF(__pyx_t_5);
-    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_5);
-    __pyx_t_5 = 0;
-    __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 620, __pyx_L1_error)
+  } else
+  #endif
+  {
+    __pyx_t_5 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 710, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __Pyx_GIVEREF(__pyx_t_3);
-    PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_3);
-    __pyx_t_3 = 0;
-    __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 620, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 620, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_complex); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 620, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, __pyx_t_2) < 0) __PYX_ERR(0, 620, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 620, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __Pyx_GIVEREF(__pyx_t_2);
-    __Pyx_GOTREF(__pyx_v_self->d2Ht1);
-    __Pyx_DECREF(__pyx_v_self->d2Ht1);
-    __pyx_v_self->d2Ht1 = __pyx_t_2;
-    __pyx_t_2 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":621
- *             # w''(t1), spline formula
- *             self.d2Ht1 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                 self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \
- *                     - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
- */
-    __pyx_t_7 = __pyx_v_self->nnz;
-    __pyx_t_10 = __pyx_t_7;
-    for (__pyx_t_11 = 0; __pyx_t_11 < __pyx_t_10; __pyx_t_11+=1) {
-      __pyx_v_i = __pyx_t_11;
-
-      /* "tkwant/onebody/kernels.pyx":622
- *             self.d2Ht1 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):
- *                 self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \             # <<<<<<<<<<<<<<
- *                     - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
- * 
- */
-      __pyx_t_2 = PyFloat_FromDouble((1.5 * __pyx_v_rdt2)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 622, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 622, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 622, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_4 = PyNumber_Add(__pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 622, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 622, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_3 = PyNumber_Multiply(__pyx_int_2, __pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 622, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = PyNumber_Subtract(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 622, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = PyNumber_Multiply(__pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 622, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-
-      /* "tkwant/onebody/kernels.pyx":623
- *             for i in range(self.nnz):
- *                 self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \
- *                     - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])             # <<<<<<<<<<<<<<
- * 
- *             self.x0, self.x1 = self.t0, self.t1
- */
-      __pyx_t_5 = __Pyx_GetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 623, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_2 = __Pyx_GetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 623, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_4 = PyNumber_Add(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 623, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __pyx_t_2 = PyNumber_Multiply(__pyx_float_0_25, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 623, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __pyx_t_4 = PyNumber_Subtract(__pyx_t_3, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 623, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-
-      /* "tkwant/onebody/kernels.pyx":622
- *             self.d2Ht1 = np.zeros((self.nnz,), dtype=np.complex)
- *             for i in range(self.nnz):
- *                 self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \             # <<<<<<<<<<<<<<
- *                     - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
- * 
- */
-      if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht1, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 1) < 0)) __PYX_ERR(0, 622, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    if (__pyx_t_2) {
+      __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
     }
-
-    /* "tkwant/onebody/kernels.pyx":625
- *                     - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
- * 
- *             self.x0, self.x1 = self.t0, self.t1             # <<<<<<<<<<<<<<
- *             self.y0 = self.Ht0
- *             self.y1 = self.Ht1
- */
-    __pyx_t_8 = __pyx_v_self->t0;
-    __pyx_t_12 = __pyx_v_self->t1;
-    __pyx_v_self->x0 = __pyx_t_8;
-    __pyx_v_self->x1 = __pyx_t_12;
-
-    /* "tkwant/onebody/kernels.pyx":626
- * 
- *             self.x0, self.x1 = self.t0, self.t1
- *             self.y0 = self.Ht0             # <<<<<<<<<<<<<<
- *             self.y1 = self.Ht1
- *             self.d2y0 = self.d2Ht0
- */
-    __pyx_t_4 = __pyx_v_self->Ht0;
-    __Pyx_INCREF(__pyx_t_4);
-    __Pyx_GIVEREF(__pyx_t_4);
-    __Pyx_GOTREF(__pyx_v_self->y0);
-    __Pyx_DECREF(__pyx_v_self->y0);
-    __pyx_v_self->y0 = __pyx_t_4;
-    __pyx_t_4 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":627
- *             self.x0, self.x1 = self.t0, self.t1
- *             self.y0 = self.Ht0
- *             self.y1 = self.Ht1             # <<<<<<<<<<<<<<
- *             self.d2y0 = self.d2Ht0
- *             self.d2y1 = self.d2Ht1
- */
-    __pyx_t_4 = __pyx_v_self->Ht1;
-    __Pyx_INCREF(__pyx_t_4);
     __Pyx_GIVEREF(__pyx_t_4);
-    __Pyx_GOTREF(__pyx_v_self->y1);
-    __Pyx_DECREF(__pyx_v_self->y1);
-    __pyx_v_self->y1 = __pyx_t_4;
-    __pyx_t_4 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":628
- *             self.y0 = self.Ht0
- *             self.y1 = self.Ht1
- *             self.d2y0 = self.d2Ht0             # <<<<<<<<<<<<<<
- *             self.d2y1 = self.d2Ht1
- *             self._do_update = True
- */
-    __pyx_t_4 = __pyx_v_self->d2Ht0;
-    __Pyx_INCREF(__pyx_t_4);
-    __Pyx_GIVEREF(__pyx_t_4);
-    __Pyx_GOTREF(__pyx_v_self->d2y0);
-    __Pyx_DECREF(__pyx_v_self->d2y0);
-    __pyx_v_self->d2y0 = __pyx_t_4;
-    __pyx_t_4 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":629
- *             self.y1 = self.Ht1
- *             self.d2y0 = self.d2Ht0
- *             self.d2y1 = self.d2Ht1             # <<<<<<<<<<<<<<
- *             self._do_update = True
- * 
- */
-    __pyx_t_4 = __pyx_v_self->d2Ht1;
-    __Pyx_INCREF(__pyx_t_4);
-    __Pyx_GIVEREF(__pyx_t_4);
-    __Pyx_GOTREF(__pyx_v_self->d2y1);
-    __Pyx_DECREF(__pyx_v_self->d2y1);
-    __pyx_v_self->d2y1 = __pyx_t_4;
+    PyTuple_SET_ITEM(__pyx_t_5, 0+__pyx_t_8, __pyx_t_4);
+    __Pyx_INCREF(__pyx_v_time_start);
+    __Pyx_GIVEREF(__pyx_v_time_start);
+    PyTuple_SET_ITEM(__pyx_t_5, 1+__pyx_t_8, __pyx_v_time_start);
     __pyx_t_4 = 0;
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_5, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 710, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  }
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v_self->intfunc);
+  __Pyx_DECREF(__pyx_v_self->intfunc);
+  __pyx_v_self->intfunc = __pyx_t_1;
+  __pyx_t_1 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":630
- *             self.d2y0 = self.d2Ht0
- *             self.d2y1 = self.d2Ht1
- *             self._do_update = True             # <<<<<<<<<<<<<<
- * 
- *             self.wt = self.wfunc.empty()
- */
-    __pyx_v_self->_do_update = 1;
-
-    /* "tkwant/onebody/kernels.pyx":632
- *             self._do_update = True
+  /* "tkwant/onebody/kernels.pyx":711
  * 
- *             self.wt = self.wfunc.empty()             # <<<<<<<<<<<<<<
+ *         self.intfunc = interpolation_type(self.wfunc.data, time_start)
+ *         self.wt = self.wfunc.empty()             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
-    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 632, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_3 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
-      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
-      if (likely(__pyx_t_3)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-        __Pyx_INCREF(__pyx_t_3);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_2, function);
-      }
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_empty); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 711, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_5 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_5)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_5);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
     }
-    __pyx_t_4 = (__pyx_t_3) ? __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallNoArg(__pyx_t_2);
-    __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 632, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_GIVEREF(__pyx_t_4);
-    __Pyx_GOTREF(__pyx_v_self->wt);
-    __Pyx_DECREF(__pyx_v_self->wt);
-    __pyx_v_self->wt = __pyx_t_4;
-    __pyx_t_4 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":575
- *         self.dt = dt
- * 
- *         if dt > 0:             # <<<<<<<<<<<<<<
- * 
- *             self.t0 = time_start
- */
   }
+  __pyx_t_1 = (__pyx_t_5) ? __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_5) : __Pyx_PyObject_CallNoArg(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 711, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v_self->wt);
+  __Pyx_DECREF(__pyx_v_self->wt);
+  __pyx_v_self->wt = __pyx_t_1;
+  __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":545
- *     cdef unsigned nnz
+  /* "tkwant/onebody/kernels.pyx":701
+ *         object intfunc
  * 
- *     def __init__(self, syst, time_name, time_start, params=None, dt=1):             # <<<<<<<<<<<<<<
+ *     def __init__(self, syst, time_name, time_start, params=None, interpolation_type=Interpolation):             # <<<<<<<<<<<<<<
  * 
- *         # The spline interpolation in this routine is done "on the fly".
+ *         self.wfunc = PerturbationExtractor(syst, time_name, time_start, params)
  */
 
   /* function exit code */
   __pyx_r = 0;
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
@@ -12368,22 +14711,19 @@
   __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_5);
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationInterpolator.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v__);
   __Pyx_XDECREF(__pyx_v_norbs);
-  __Pyx_XDECREF(__pyx_v_Ht02);
-  __Pyx_XDECREF(__pyx_v_Ht12);
-  __Pyx_XDECREF(__pyx_v_Ht22);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":635
+/* "tkwant/onebody/kernels.pyx":714
  * 
  *     @property
  *     def size(self):             # <<<<<<<<<<<<<<
  *         '''The size of the W(t) matrix.
  * 
  */
 
@@ -12400,31 +14740,34 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_4size___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":643
+  /* "tkwant/onebody/kernels.pyx":722
  *             The size of the W(t) matrix is ``size`` x ``size``.
  *         '''
  *         return self.size             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 643, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 722, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":635
+  /* "tkwant/onebody/kernels.pyx":714
  * 
  *     @property
  *     def size(self):             # <<<<<<<<<<<<<<
  *         '''The size of the W(t) matrix.
  * 
  */
 
@@ -12435,15 +14778,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":646
+/* "tkwant/onebody/kernels.pyx":725
  * 
  *     @property
  *     def nnz(self):             # <<<<<<<<<<<<<<
  *         '''The total number of time-dependent matrix elements.
  * 
  */
 
@@ -12460,31 +14803,34 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_3nnz___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":655
+  /* "tkwant/onebody/kernels.pyx":734
  *             len(W(t).data).
  *         '''
  *         return self.nnz             # <<<<<<<<<<<<<<
  * 
  *     @cython.boundscheck(False)
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 655, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 734, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":646
+  /* "tkwant/onebody/kernels.pyx":725
  * 
  *     @property
  *     def nnz(self):             # <<<<<<<<<<<<<<
  *         '''The total number of time-dependent matrix elements.
  * 
  */
 
@@ -12495,28 +14841,31 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":659
+/* "tkwant/onebody/kernels.pyx":738
  *     @cython.boundscheck(False)
  *     @cython.wraparound(False)
  *     def evaluate(self, double time, object out=None):             # <<<<<<<<<<<<<<
  *         '''Evaluate the W(t) matrix for the given time t.
  * 
  */
 
 /* Python wrapper */
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_24PerturbationInterpolator_3evaluate(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static char __pyx_doc_6tkwant_7onebody_7kernels_24PerturbationInterpolator_2evaluate[] = "PerturbationInterpolator.evaluate(self, double time, out=None)\nEvaluate the W(t) matrix for the given time t.\n\n        Parameters\n        ----------\n        time : int or float\n            Time argument, must be equal or larger than `time_start`.\n        out : `~scipy.sparse.coo_matrix`, optional\n            Sparse matrix with to perform the operation in-place.\n\n        Returns\n        -------\n        out : `~scipy.sparse.coo_matrix` or `None`\n            The matrix W(t).\n            The size of the W(t) matrix is ``size`` x ``size``, containing\n            ``nnz`` complex entries. If an ``out`` argument is given,\n            the operation is performed in-place and the routine returns `None`.\n        ";
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_24PerturbationInterpolator_3evaluate(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   double __pyx_v_time;
   PyObject *__pyx_v_out = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("evaluate (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_time,&__pyx_n_s_out,0};
     PyObject* values[2] = {0,0};
     values[1] = ((PyObject *)Py_None);
@@ -12540,271 +14889,332 @@
         case  1:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_out);
           if (value) { values[1] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "evaluate") < 0)) __PYX_ERR(0, 659, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "evaluate") < 0)) __PYX_ERR(0, 738, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
-    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 659, __pyx_L3_error)
+    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 738, __pyx_L3_error)
     __pyx_v_out = values[1];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("evaluate", 0, 1, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 659, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("evaluate", 0, 1, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 738, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationInterpolator.evaluate", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_2evaluate(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)__pyx_v_self), __pyx_v_time, __pyx_v_out);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_2evaluate(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, double __pyx_v_time, PyObject *__pyx_v_out) {
-  double __pyx_v_rdt2;
-  double __pyx_v_a;
-  double __pyx_v_b;
-  double __pyx_v_c;
-  double __pyx_v_d;
-  unsigned int __pyx_v_i;
-  double __pyx_v_t0_new;
-  double __pyx_v_t1_new;
-  double __pyx_v_t2_new;
-  double __pyx_v_t3_new;
-  double __pyx_v_t4_new;
-  double __pyx_v_cc2;
-  double __pyx_v_cc1;
-  double __pyx_v_cc0;
-  PyObject *__pyx_v_Htm2 = NULL;
-  PyObject *__pyx_v_Htm1 = NULL;
-  int __pyx_v_do_return;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
   PyObject *__pyx_t_6 = NULL;
   PyObject *__pyx_t_7 = NULL;
   int __pyx_t_8;
   PyObject *__pyx_t_9 = NULL;
-  __pyx_ctuple_double__and_double__and_double__and_double__and_double __pyx_t_10;
-  double __pyx_t_11;
-  double __pyx_t_12;
-  double __pyx_t_13;
-  double __pyx_t_14;
-  double __pyx_t_15;
-  unsigned int __pyx_t_16;
-  unsigned int __pyx_t_17;
-  unsigned int __pyx_t_18;
-  __pyx_ctuple_double__and_double__and_double__and_double __pyx_t_19;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("evaluate", 0);
-  __Pyx_INCREF(__pyx_v_out);
 
-  /* "tkwant/onebody/kernels.pyx":682
- *         cdef unsigned i
+  /* "tkwant/onebody/kernels.pyx":757
+ *         '''
  * 
- *         if out is not None:             # <<<<<<<<<<<<<<
- *             assert out.shape[0] == self.size, _errormsg.format('output',
- *                                                                out.shape[0],
+ *         if out is None:             # <<<<<<<<<<<<<<
+ *             self.intfunc.eval(time, self.wt.data)
+ *             return self.wt
  */
-  __pyx_t_1 = (__pyx_v_out != Py_None);
+  __pyx_t_1 = (__pyx_v_out == Py_None);
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "tkwant/onebody/kernels.pyx":683
+    /* "tkwant/onebody/kernels.pyx":758
  * 
- *         if out is not None:
+ *         if out is None:
+ *             self.intfunc.eval(time, self.wt.data)             # <<<<<<<<<<<<<<
+ *             return self.wt
+ *         else:
+ */
+    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->intfunc, __pyx_n_s_eval); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 758, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 758, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_data); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 758, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_7 = NULL;
+    __pyx_t_8 = 0;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
+      __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_4);
+      if (likely(__pyx_t_7)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+        __Pyx_INCREF(__pyx_t_7);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_4, function);
+        __pyx_t_8 = 1;
+      }
+    }
+    #if CYTHON_FAST_PYCALL
+    if (PyFunction_Check(__pyx_t_4)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_5, __pyx_t_6};
+      __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 758, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    } else
+    #endif
+    #if CYTHON_FAST_PYCCALL
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_5, __pyx_t_6};
+      __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 758, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
+    } else
+    #endif
+    {
+      __pyx_t_9 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 758, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_9);
+      if (__pyx_t_7) {
+        __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_7); __pyx_t_7 = NULL;
+      }
+      __Pyx_GIVEREF(__pyx_t_5);
+      PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_8, __pyx_t_5);
+      __Pyx_GIVEREF(__pyx_t_6);
+      PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_8, __pyx_t_6);
+      __pyx_t_5 = 0;
+      __pyx_t_6 = 0;
+      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_9, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 758, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    }
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":759
+ *         if out is None:
+ *             self.intfunc.eval(time, self.wt.data)
+ *             return self.wt             # <<<<<<<<<<<<<<
+ *         else:
+ *             assert out.shape[0] == self.size, _errormsg.format('output',
+ */
+    __Pyx_XDECREF(__pyx_r);
+    __Pyx_INCREF(__pyx_v_self->wt);
+    __pyx_r = __pyx_v_self->wt;
+    goto __pyx_L0;
+
+    /* "tkwant/onebody/kernels.pyx":757
+ *         '''
+ * 
+ *         if out is None:             # <<<<<<<<<<<<<<
+ *             self.intfunc.eval(time, self.wt.data)
+ *             return self.wt
+ */
+  }
+
+  /* "tkwant/onebody/kernels.pyx":761
+ *             return self.wt
+ *         else:
  *             assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
  *                                                                out.shape[0],
  *                                                                self.size)
  */
+  /*else*/ {
     #ifndef CYTHON_WITHOUT_ASSERTIONS
     if (unlikely(!Py_OptimizeFlag)) {
-      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 683, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 761, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 683, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 761, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 683, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 761, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = PyObject_RichCompare(__pyx_t_4, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_5); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 683, __pyx_L1_error)
+      __pyx_t_9 = PyObject_RichCompare(__pyx_t_4, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_9); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 761, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_5); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 683, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 761, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       if (unlikely(!__pyx_t_2)) {
-        __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 683, __pyx_L1_error)
+        __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 761, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_format); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 683, __pyx_L1_error)
+        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_format); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 761, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_4);
         __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":684
- *         if out is not None:
+        /* "tkwant/onebody/kernels.pyx":762
+ *         else:
  *             assert out.shape[0] == self.size, _errormsg.format('output',
  *                                                                out.shape[0],             # <<<<<<<<<<<<<<
  *                                                                self.size)
  *             assert out.data.shape[0] == self.nnz, _errormsg.format('output.dat',
  */
-        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 684, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 762, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_6 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 684, __pyx_L1_error)
+        __pyx_t_6 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 762, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_6);
         __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":685
+        /* "tkwant/onebody/kernels.pyx":763
  *             assert out.shape[0] == self.size, _errormsg.format('output',
  *                                                                out.shape[0],
  *                                                                self.size)             # <<<<<<<<<<<<<<
  *             assert out.data.shape[0] == self.nnz, _errormsg.format('output.dat',
  *                                                                    out.data.shape[0],
  */
-        __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 685, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 763, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_7 = NULL;
+        __pyx_t_5 = NULL;
         __pyx_t_8 = 0;
         if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
-          __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_4);
-          if (likely(__pyx_t_7)) {
+          __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
+          if (likely(__pyx_t_5)) {
             PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-            __Pyx_INCREF(__pyx_t_7);
+            __Pyx_INCREF(__pyx_t_5);
             __Pyx_INCREF(function);
             __Pyx_DECREF_SET(__pyx_t_4, function);
             __pyx_t_8 = 1;
           }
         }
         #if CYTHON_FAST_PYCALL
         if (PyFunction_Check(__pyx_t_4)) {
-          PyObject *__pyx_temp[4] = {__pyx_t_7, __pyx_n_u_output, __pyx_t_6, __pyx_t_3};
-          __pyx_t_5 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 683, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_GOTREF(__pyx_t_5);
+          PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_n_u_output, __pyx_t_6, __pyx_t_3};
+          __pyx_t_9 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 761, __pyx_L1_error)
+          __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+          __Pyx_GOTREF(__pyx_t_9);
           __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         } else
         #endif
         #if CYTHON_FAST_PYCCALL
         if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
-          PyObject *__pyx_temp[4] = {__pyx_t_7, __pyx_n_u_output, __pyx_t_6, __pyx_t_3};
-          __pyx_t_5 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 683, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_GOTREF(__pyx_t_5);
+          PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_n_u_output, __pyx_t_6, __pyx_t_3};
+          __pyx_t_9 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 761, __pyx_L1_error)
+          __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+          __Pyx_GOTREF(__pyx_t_9);
           __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         } else
         #endif
         {
-          __pyx_t_9 = PyTuple_New(3+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 683, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          if (__pyx_t_7) {
-            __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_7); __pyx_t_7 = NULL;
+          __pyx_t_7 = PyTuple_New(3+__pyx_t_8); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 761, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_7);
+          if (__pyx_t_5) {
+            __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_5); __pyx_t_5 = NULL;
           }
           __Pyx_INCREF(__pyx_n_u_output);
           __Pyx_GIVEREF(__pyx_n_u_output);
-          PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_8, __pyx_n_u_output);
+          PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_8, __pyx_n_u_output);
           __Pyx_GIVEREF(__pyx_t_6);
-          PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_8, __pyx_t_6);
+          PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_8, __pyx_t_6);
           __Pyx_GIVEREF(__pyx_t_3);
-          PyTuple_SET_ITEM(__pyx_t_9, 2+__pyx_t_8, __pyx_t_3);
+          PyTuple_SET_ITEM(__pyx_t_7, 2+__pyx_t_8, __pyx_t_3);
           __pyx_t_6 = 0;
           __pyx_t_3 = 0;
-          __pyx_t_5 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_9, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 683, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_5);
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+          __pyx_t_9 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 761, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_9);
+          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
         }
         __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":683
- * 
- *         if out is not None:
+        /* "tkwant/onebody/kernels.pyx":761
+ *             return self.wt
+ *         else:
  *             assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
  *                                                                out.shape[0],
  *                                                                self.size)
  */
-        __pyx_t_4 = PyTuple_Pack(1, __pyx_t_5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 683, __pyx_L1_error)
+        __pyx_t_4 = PyTuple_Pack(1, __pyx_t_9); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 761, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
         PyErr_SetObject(PyExc_AssertionError, __pyx_t_4);
         __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __PYX_ERR(0, 683, __pyx_L1_error)
+        __PYX_ERR(0, 761, __pyx_L1_error)
       }
     }
     #endif
 
-    /* "tkwant/onebody/kernels.pyx":686
+    /* "tkwant/onebody/kernels.pyx":764
  *                                                                out.shape[0],
  *                                                                self.size)
  *             assert out.data.shape[0] == self.nnz, _errormsg.format('output.dat',             # <<<<<<<<<<<<<<
  *                                                                    out.data.shape[0],
  *                                                                    self.nnz)
  */
     #ifndef CYTHON_WITHOUT_ASSERTIONS
     if (unlikely(!Py_OptimizeFlag)) {
-      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 686, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 764, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
-      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_shape); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 686, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_shape); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 764, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_9);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_5, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 686, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_GetItemInt(__pyx_t_9, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 764, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 686, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_9 = PyObject_RichCompare(__pyx_t_4, __pyx_t_5, Py_EQ); __Pyx_XGOTREF(__pyx_t_9); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 686, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+      __pyx_t_9 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 764, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_9);
+      __pyx_t_7 = PyObject_RichCompare(__pyx_t_4, __pyx_t_9, Py_EQ); __Pyx_XGOTREF(__pyx_t_7); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 764, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 686, __pyx_L1_error)
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+      __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_7); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 764, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
       if (unlikely(!__pyx_t_2)) {
-        __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 686, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_format); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 686, __pyx_L1_error)
+        __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 764, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_9);
+        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_format); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 764, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":687
+        /* "tkwant/onebody/kernels.pyx":765
  *                                                                self.size)
  *             assert out.data.shape[0] == self.nnz, _errormsg.format('output.dat',
  *                                                                    out.data.shape[0],             # <<<<<<<<<<<<<<
  *                                                                    self.nnz)
- * 
+ *             self.intfunc.eval(time, out.data)
  */
-        __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_data); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 687, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 687, __pyx_L1_error)
+        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 765, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_9);
+        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 765, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-        __pyx_t_5 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 687, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_5);
+        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+        __pyx_t_9 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 765, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_9);
         __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":688
+        /* "tkwant/onebody/kernels.pyx":766
  *             assert out.data.shape[0] == self.nnz, _errormsg.format('output.dat',
  *                                                                    out.data.shape[0],
  *                                                                    self.nnz)             # <<<<<<<<<<<<<<
+ *             self.intfunc.eval(time, out.data)
  * 
- *         if self.dt > 0:
  */
-        __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 688, __pyx_L1_error)
+        __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 766, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_3);
         __pyx_t_6 = NULL;
         __pyx_t_8 = 0;
         if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
           __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
           if (likely(__pyx_t_6)) {
             PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
@@ -12812,1712 +15222,136 @@
             __Pyx_INCREF(function);
             __Pyx_DECREF_SET(__pyx_t_4, function);
             __pyx_t_8 = 1;
           }
         }
         #if CYTHON_FAST_PYCALL
         if (PyFunction_Check(__pyx_t_4)) {
-          PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_kp_u_output_dat, __pyx_t_5, __pyx_t_3};
-          __pyx_t_9 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 686, __pyx_L1_error)
+          PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_kp_u_output_dat, __pyx_t_9, __pyx_t_3};
+          __pyx_t_7 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 764, __pyx_L1_error)
           __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_9);
-          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+          __Pyx_GOTREF(__pyx_t_7);
+          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         } else
         #endif
         #if CYTHON_FAST_PYCCALL
         if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
-          PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_kp_u_output_dat, __pyx_t_5, __pyx_t_3};
-          __pyx_t_9 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 686, __pyx_L1_error)
+          PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_kp_u_output_dat, __pyx_t_9, __pyx_t_3};
+          __pyx_t_7 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_8, 3+__pyx_t_8); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 764, __pyx_L1_error)
           __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_9);
-          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+          __Pyx_GOTREF(__pyx_t_7);
+          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
           __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
         } else
         #endif
         {
-          __pyx_t_7 = PyTuple_New(3+__pyx_t_8); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 686, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
+          __pyx_t_5 = PyTuple_New(3+__pyx_t_8); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 764, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_5);
           if (__pyx_t_6) {
-            __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_6); __pyx_t_6 = NULL;
+            __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_6); __pyx_t_6 = NULL;
           }
           __Pyx_INCREF(__pyx_kp_u_output_dat);
           __Pyx_GIVEREF(__pyx_kp_u_output_dat);
-          PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_8, __pyx_kp_u_output_dat);
-          __Pyx_GIVEREF(__pyx_t_5);
-          PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_8, __pyx_t_5);
+          PyTuple_SET_ITEM(__pyx_t_5, 0+__pyx_t_8, __pyx_kp_u_output_dat);
+          __Pyx_GIVEREF(__pyx_t_9);
+          PyTuple_SET_ITEM(__pyx_t_5, 1+__pyx_t_8, __pyx_t_9);
           __Pyx_GIVEREF(__pyx_t_3);
-          PyTuple_SET_ITEM(__pyx_t_7, 2+__pyx_t_8, __pyx_t_3);
-          __pyx_t_5 = 0;
+          PyTuple_SET_ITEM(__pyx_t_5, 2+__pyx_t_8, __pyx_t_3);
+          __pyx_t_9 = 0;
           __pyx_t_3 = 0;
-          __pyx_t_9 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_7, NULL); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 686, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+          __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 764, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_7);
+          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
         }
         __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":686
+        /* "tkwant/onebody/kernels.pyx":764
  *                                                                out.shape[0],
  *                                                                self.size)
  *             assert out.data.shape[0] == self.nnz, _errormsg.format('output.dat',             # <<<<<<<<<<<<<<
  *                                                                    out.data.shape[0],
  *                                                                    self.nnz)
  */
-        __pyx_t_4 = PyTuple_Pack(1, __pyx_t_9); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 686, __pyx_L1_error)
+        __pyx_t_4 = PyTuple_Pack(1, __pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 764, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
         PyErr_SetObject(PyExc_AssertionError, __pyx_t_4);
         __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __PYX_ERR(0, 686, __pyx_L1_error)
+        __PYX_ERR(0, 764, __pyx_L1_error)
       }
     }
     #endif
 
-    /* "tkwant/onebody/kernels.pyx":682
- *         cdef unsigned i
- * 
- *         if out is not None:             # <<<<<<<<<<<<<<
- *             assert out.shape[0] == self.size, _errormsg.format('output',
- *                                                                out.shape[0],
- */
-  }
-
-  /* "tkwant/onebody/kernels.pyx":690
+    /* "tkwant/onebody/kernels.pyx":767
+ *                                                                    out.data.shape[0],
  *                                                                    self.nnz)
+ *             self.intfunc.eval(time, out.data)             # <<<<<<<<<<<<<<
  * 
- *         if self.dt > 0:             # <<<<<<<<<<<<<<
- * 
- *             # update matrices
- */
-  __pyx_t_2 = ((__pyx_v_self->dt > 0.0) != 0);
-  if (__pyx_t_2) {
-
-    /* "tkwant/onebody/kernels.pyx":693
- * 
- *             # update matrices
- *             if time >= self.t2:             # <<<<<<<<<<<<<<
- *                 t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)
- *                 rdt2 = 1 / (self.dt * self.dt)
- */
-    __pyx_t_2 = ((__pyx_v_time >= __pyx_v_self->t2) != 0);
-    if (__pyx_t_2) {
-
-      /* "tkwant/onebody/kernels.pyx":694
- *             # update matrices
- *             if time >= self.t2:
- *                 t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)             # <<<<<<<<<<<<<<
- *                 rdt2 = 1 / (self.dt * self.dt)
- *                 cc2 = - rdt2 / 12
- */
-      __pyx_t_10 = __pyx_f_6tkwant_7onebody_7kernels_update_times(__pyx_v_time, __pyx_v_self->t0, __pyx_v_self->dt);
-      __pyx_t_11 = __pyx_t_10.f0;
-      __pyx_t_12 = __pyx_t_10.f1;
-      __pyx_t_13 = __pyx_t_10.f2;
-      __pyx_t_14 = __pyx_t_10.f3;
-      __pyx_t_15 = __pyx_t_10.f4;
-      __pyx_v_t0_new = __pyx_t_11;
-      __pyx_v_t1_new = __pyx_t_12;
-      __pyx_v_t2_new = __pyx_t_13;
-      __pyx_v_t3_new = __pyx_t_14;
-      __pyx_v_t4_new = __pyx_t_15;
-
-      /* "tkwant/onebody/kernels.pyx":695
- *             if time >= self.t2:
- *                 t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)
- *                 rdt2 = 1 / (self.dt * self.dt)             # <<<<<<<<<<<<<<
- *                 cc2 = - rdt2 / 12
- *                 cc1 = rdt2 * 4 / 3
- */
-      __pyx_t_15 = (__pyx_v_self->dt * __pyx_v_self->dt);
-      if (unlikely(__pyx_t_15 == 0)) {
-        PyErr_SetString(PyExc_ZeroDivisionError, "float division");
-        __PYX_ERR(0, 695, __pyx_L1_error)
-      }
-      __pyx_v_rdt2 = (1.0 / __pyx_t_15);
-
-      /* "tkwant/onebody/kernels.pyx":696
- *                 t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)
- *                 rdt2 = 1 / (self.dt * self.dt)
- *                 cc2 = - rdt2 / 12             # <<<<<<<<<<<<<<
- *                 cc1 = rdt2 * 4 / 3
- *                 cc0 = - 2.5 * rdt2
- */
-      __pyx_v_cc2 = ((-__pyx_v_rdt2) / 12.0);
-
-      /* "tkwant/onebody/kernels.pyx":697
- *                 rdt2 = 1 / (self.dt * self.dt)
- *                 cc2 = - rdt2 / 12
- *                 cc1 = rdt2 * 4 / 3             # <<<<<<<<<<<<<<
- *                 cc0 = - 2.5 * rdt2
- *                 # update matrices H0t, H1t, H2t, try to reuse stuff from last step
- */
-      __pyx_v_cc1 = ((__pyx_v_rdt2 * 4.0) / 3.0);
-
-      /* "tkwant/onebody/kernels.pyx":698
- *                 cc2 = - rdt2 / 12
- *                 cc1 = rdt2 * 4 / 3
- *                 cc0 = - 2.5 * rdt2             # <<<<<<<<<<<<<<
- *                 # update matrices H0t, H1t, H2t, try to reuse stuff from last step
- *                 if np.isclose(t0_new, self.t2):
- */
-      __pyx_v_cc0 = (-2.5 * __pyx_v_rdt2);
-
-      /* "tkwant/onebody/kernels.pyx":700
- *                 cc0 = - 2.5 * rdt2
- *                 # update matrices H0t, H1t, H2t, try to reuse stuff from last step
- *                 if np.isclose(t0_new, self.t2):             # <<<<<<<<<<<<<<
- *                     for i in range(self.nnz):
- *                         self.Ht0[i] = self.Ht2[i]
- */
-      __Pyx_GetModuleGlobalName(__pyx_t_9, __pyx_n_s_np); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 700, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_isclose); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 700, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_7);
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-      __pyx_t_9 = PyFloat_FromDouble(__pyx_v_t0_new); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 700, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_3 = PyFloat_FromDouble(__pyx_v_self->t2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 700, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = NULL;
-      __pyx_t_8 = 0;
-      if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_7))) {
-        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_7);
-        if (likely(__pyx_t_5)) {
-          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
-          __Pyx_INCREF(__pyx_t_5);
-          __Pyx_INCREF(function);
-          __Pyx_DECREF_SET(__pyx_t_7, function);
-          __pyx_t_8 = 1;
-        }
-      }
-      #if CYTHON_FAST_PYCALL
-      if (PyFunction_Check(__pyx_t_7)) {
-        PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_9, __pyx_t_3};
-        __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 700, __pyx_L1_error)
-        __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      } else
-      #endif
-      #if CYTHON_FAST_PYCCALL
-      if (__Pyx_PyFastCFunction_Check(__pyx_t_7)) {
-        PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_9, __pyx_t_3};
-        __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 700, __pyx_L1_error)
-        __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      } else
-      #endif
-      {
-        __pyx_t_6 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 700, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        if (__pyx_t_5) {
-          __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5); __pyx_t_5 = NULL;
-        }
-        __Pyx_GIVEREF(__pyx_t_9);
-        PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_8, __pyx_t_9);
-        __Pyx_GIVEREF(__pyx_t_3);
-        PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_8, __pyx_t_3);
-        __pyx_t_9 = 0;
-        __pyx_t_3 = 0;
-        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 700, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-      }
-      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-      __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 700, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      if (__pyx_t_2) {
-
-        /* "tkwant/onebody/kernels.pyx":701
- *                 # update matrices H0t, H1t, H2t, try to reuse stuff from last step
- *                 if np.isclose(t0_new, self.t2):
- *                     for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                         self.Ht0[i] = self.Ht2[i]
- *                         self.Ht1[i] = self.Ht3[i]
- */
-        __pyx_t_16 = __pyx_v_self->nnz;
-        __pyx_t_17 = __pyx_t_16;
-        for (__pyx_t_18 = 0; __pyx_t_18 < __pyx_t_17; __pyx_t_18+=1) {
-          __pyx_v_i = __pyx_t_18;
-
-          /* "tkwant/onebody/kernels.pyx":702
- *                 if np.isclose(t0_new, self.t2):
- *                     for i in range(self.nnz):
- *                         self.Ht0[i] = self.Ht2[i]             # <<<<<<<<<<<<<<
- *                         self.Ht1[i] = self.Ht3[i]
- *                         self.Ht2[i] = self.Ht4[i]
- */
-          __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 702, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          if (unlikely(__Pyx_SetItemInt(__pyx_v_self->Ht0, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 702, __pyx_L1_error)
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":703
- *                     for i in range(self.nnz):
- *                         self.Ht0[i] = self.Ht2[i]
- *                         self.Ht1[i] = self.Ht3[i]             # <<<<<<<<<<<<<<
- *                         self.Ht2[i] = self.Ht4[i]
- *                     self.wfunc.data(t3_new, self.Ht3)
- */
-          __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht3, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 703, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          if (unlikely(__Pyx_SetItemInt(__pyx_v_self->Ht1, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 703, __pyx_L1_error)
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":704
- *                         self.Ht0[i] = self.Ht2[i]
- *                         self.Ht1[i] = self.Ht3[i]
- *                         self.Ht2[i] = self.Ht4[i]             # <<<<<<<<<<<<<<
- *                     self.wfunc.data(t3_new, self.Ht3)
- *                     self.wfunc.data(t4_new, self.Ht4)
- */
-          __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht4, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 704, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          if (unlikely(__Pyx_SetItemInt(__pyx_v_self->Ht2, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 704, __pyx_L1_error)
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        }
-
-        /* "tkwant/onebody/kernels.pyx":705
- *                         self.Ht1[i] = self.Ht3[i]
- *                         self.Ht2[i] = self.Ht4[i]
- *                     self.wfunc.data(t3_new, self.Ht3)             # <<<<<<<<<<<<<<
- *                     self.wfunc.data(t4_new, self.Ht4)
- *                     for i in range(self.nnz):
- */
-        __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 705, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_7);
-        __pyx_t_6 = PyFloat_FromDouble(__pyx_v_t3_new); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 705, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_3 = NULL;
-        __pyx_t_8 = 0;
-        if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_7))) {
-          __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_7);
-          if (likely(__pyx_t_3)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
-            __Pyx_INCREF(__pyx_t_3);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_7, function);
-            __pyx_t_8 = 1;
-          }
-        }
-        #if CYTHON_FAST_PYCALL
-        if (PyFunction_Check(__pyx_t_7)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_t_6, __pyx_v_self->Ht3};
-          __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 705, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_GOTREF(__pyx_t_4);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        } else
-        #endif
-        #if CYTHON_FAST_PYCCALL
-        if (__Pyx_PyFastCFunction_Check(__pyx_t_7)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_t_6, __pyx_v_self->Ht3};
-          __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 705, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_GOTREF(__pyx_t_4);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        } else
-        #endif
-        {
-          __pyx_t_9 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 705, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          if (__pyx_t_3) {
-            __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_3); __pyx_t_3 = NULL;
-          }
-          __Pyx_GIVEREF(__pyx_t_6);
-          PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_8, __pyx_t_6);
-          __Pyx_INCREF(__pyx_v_self->Ht3);
-          __Pyx_GIVEREF(__pyx_v_self->Ht3);
-          PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_8, __pyx_v_self->Ht3);
-          __pyx_t_6 = 0;
-          __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_9, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 705, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":706
- *                         self.Ht2[i] = self.Ht4[i]
- *                     self.wfunc.data(t3_new, self.Ht3)
- *                     self.wfunc.data(t4_new, self.Ht4)             # <<<<<<<<<<<<<<
- *                     for i in range(self.nnz):
- *                         self.d2Ht0[i] = self.d2Ht2[i]
- */
-        __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 706, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_7);
-        __pyx_t_9 = PyFloat_FromDouble(__pyx_v_t4_new); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 706, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_6 = NULL;
-        __pyx_t_8 = 0;
-        if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_7))) {
-          __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_7);
-          if (likely(__pyx_t_6)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
-            __Pyx_INCREF(__pyx_t_6);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_7, function);
-            __pyx_t_8 = 1;
-          }
-        }
-        #if CYTHON_FAST_PYCALL
-        if (PyFunction_Check(__pyx_t_7)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_9, __pyx_v_self->Ht4};
-          __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 706, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_4);
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        } else
-        #endif
-        #if CYTHON_FAST_PYCCALL
-        if (__Pyx_PyFastCFunction_Check(__pyx_t_7)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_9, __pyx_v_self->Ht4};
-          __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 706, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_4);
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        } else
-        #endif
-        {
-          __pyx_t_3 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 706, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          if (__pyx_t_6) {
-            __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_6); __pyx_t_6 = NULL;
-          }
-          __Pyx_GIVEREF(__pyx_t_9);
-          PyTuple_SET_ITEM(__pyx_t_3, 0+__pyx_t_8, __pyx_t_9);
-          __Pyx_INCREF(__pyx_v_self->Ht4);
-          __Pyx_GIVEREF(__pyx_v_self->Ht4);
-          PyTuple_SET_ITEM(__pyx_t_3, 1+__pyx_t_8, __pyx_v_self->Ht4);
-          __pyx_t_9 = 0;
-          __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_3, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 706, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":707
- *                     self.wfunc.data(t3_new, self.Ht3)
- *                     self.wfunc.data(t4_new, self.Ht4)
- *                     for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                         self.d2Ht0[i] = self.d2Ht2[i]
- *                         # w''(t2), central finite difference scheme
- */
-        __pyx_t_16 = __pyx_v_self->nnz;
-        __pyx_t_17 = __pyx_t_16;
-        for (__pyx_t_18 = 0; __pyx_t_18 < __pyx_t_17; __pyx_t_18+=1) {
-          __pyx_v_i = __pyx_t_18;
-
-          /* "tkwant/onebody/kernels.pyx":708
- *                     self.wfunc.data(t4_new, self.Ht4)
- *                     for i in range(self.nnz):
- *                         self.d2Ht0[i] = self.d2Ht2[i]             # <<<<<<<<<<<<<<
- *                         # w''(t2), central finite difference scheme
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- */
-          __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 708, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 708, __pyx_L1_error)
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":710
- *                         self.d2Ht0[i] = self.d2Ht2[i]
- *                         # w''(t2), central finite difference scheme
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
- *                             + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- *                             + cc0 * self.Ht2[i]
- */
-          __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cc2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 710, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __pyx_t_7 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 710, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_self->Ht4, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 710, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __pyx_t_9 = PyNumber_Add(__pyx_t_7, __pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 710, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __pyx_t_3 = PyNumber_Multiply(__pyx_t_4, __pyx_t_9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 710, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":711
- *                         # w''(t2), central finite difference scheme
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- *                             + cc1 * (self.Ht1[i] + self.Ht3[i]) \             # <<<<<<<<<<<<<<
- *                             + cc0 * self.Ht2[i]
- *                 else:
- */
-          __pyx_t_9 = PyFloat_FromDouble(__pyx_v_cc1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 711, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 711, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __pyx_t_7 = __Pyx_GetItemInt(__pyx_v_self->Ht3, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 711, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __pyx_t_6 = PyNumber_Add(__pyx_t_4, __pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 711, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_6);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __pyx_t_7 = PyNumber_Multiply(__pyx_t_9, __pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 711, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __pyx_t_6 = PyNumber_Add(__pyx_t_3, __pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 711, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_6);
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":712
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- *                             + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- *                             + cc0 * self.Ht2[i]             # <<<<<<<<<<<<<<
- *                 else:
- *                     Htm2 = self.wfunc.data(t0_new - 2 * self.dt)
- */
-          __pyx_t_7 = PyFloat_FromDouble(__pyx_v_cc0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 712, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 712, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __pyx_t_9 = PyNumber_Multiply(__pyx_t_7, __pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 712, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __pyx_t_3 = PyNumber_Add(__pyx_t_6, __pyx_t_9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 712, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":710
- *                         self.d2Ht0[i] = self.d2Ht2[i]
- *                         # w''(t2), central finite difference scheme
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
- *                             + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- *                             + cc0 * self.Ht2[i]
- */
-          if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, __pyx_t_3, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 710, __pyx_L1_error)
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        }
-
-        /* "tkwant/onebody/kernels.pyx":700
- *                 cc0 = - 2.5 * rdt2
- *                 # update matrices H0t, H1t, H2t, try to reuse stuff from last step
- *                 if np.isclose(t0_new, self.t2):             # <<<<<<<<<<<<<<
- *                     for i in range(self.nnz):
- *                         self.Ht0[i] = self.Ht2[i]
- */
-        goto __pyx_L6;
-      }
-
-      /* "tkwant/onebody/kernels.pyx":714
- *                             + cc0 * self.Ht2[i]
- *                 else:
- *                     Htm2 = self.wfunc.data(t0_new - 2 * self.dt)             # <<<<<<<<<<<<<<
- *                     Htm1 = self.wfunc.data(t0_new - self.dt)
- *                     self.wfunc.data(t0_new, self.Ht0)
- */
-      /*else*/ {
-        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 714, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_6 = PyFloat_FromDouble((__pyx_v_t0_new - (2.0 * __pyx_v_self->dt))); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 714, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_7 = NULL;
-        if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_9))) {
-          __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_9);
-          if (likely(__pyx_t_7)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-            __Pyx_INCREF(__pyx_t_7);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_9, function);
-          }
-        }
-        __pyx_t_3 = (__pyx_t_7) ? __Pyx_PyObject_Call2Args(__pyx_t_9, __pyx_t_7, __pyx_t_6) : __Pyx_PyObject_CallOneArg(__pyx_t_9, __pyx_t_6);
-        __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 714, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __pyx_v_Htm2 = __pyx_t_3;
-        __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":715
- *                 else:
- *                     Htm2 = self.wfunc.data(t0_new - 2 * self.dt)
- *                     Htm1 = self.wfunc.data(t0_new - self.dt)             # <<<<<<<<<<<<<<
- *                     self.wfunc.data(t0_new, self.Ht0)
- *                     self.wfunc.data(t1_new, self.Ht1)
- */
-        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 715, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_6 = PyFloat_FromDouble((__pyx_v_t0_new - __pyx_v_self->dt)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 715, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_7 = NULL;
-        if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_9))) {
-          __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_9);
-          if (likely(__pyx_t_7)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-            __Pyx_INCREF(__pyx_t_7);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_9, function);
-          }
-        }
-        __pyx_t_3 = (__pyx_t_7) ? __Pyx_PyObject_Call2Args(__pyx_t_9, __pyx_t_7, __pyx_t_6) : __Pyx_PyObject_CallOneArg(__pyx_t_9, __pyx_t_6);
-        __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 715, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __pyx_v_Htm1 = __pyx_t_3;
-        __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":716
- *                     Htm2 = self.wfunc.data(t0_new - 2 * self.dt)
- *                     Htm1 = self.wfunc.data(t0_new - self.dt)
- *                     self.wfunc.data(t0_new, self.Ht0)             # <<<<<<<<<<<<<<
- *                     self.wfunc.data(t1_new, self.Ht1)
- *                     self.wfunc.data(t2_new, self.Ht2)
- */
-        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 716, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_6 = PyFloat_FromDouble(__pyx_v_t0_new); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 716, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_7 = NULL;
-        __pyx_t_8 = 0;
-        if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_9))) {
-          __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_9);
-          if (likely(__pyx_t_7)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-            __Pyx_INCREF(__pyx_t_7);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_9, function);
-            __pyx_t_8 = 1;
-          }
-        }
-        #if CYTHON_FAST_PYCALL
-        if (PyFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_6, __pyx_v_self->Ht0};
-          __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 716, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        } else
-        #endif
-        #if CYTHON_FAST_PYCCALL
-        if (__Pyx_PyFastCFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_6, __pyx_v_self->Ht0};
-          __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 716, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        } else
-        #endif
-        {
-          __pyx_t_4 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 716, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          if (__pyx_t_7) {
-            __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_7); __pyx_t_7 = NULL;
-          }
-          __Pyx_GIVEREF(__pyx_t_6);
-          PyTuple_SET_ITEM(__pyx_t_4, 0+__pyx_t_8, __pyx_t_6);
-          __Pyx_INCREF(__pyx_v_self->Ht0);
-          __Pyx_GIVEREF(__pyx_v_self->Ht0);
-          PyTuple_SET_ITEM(__pyx_t_4, 1+__pyx_t_8, __pyx_v_self->Ht0);
-          __pyx_t_6 = 0;
-          __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_t_4, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 716, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":717
- *                     Htm1 = self.wfunc.data(t0_new - self.dt)
- *                     self.wfunc.data(t0_new, self.Ht0)
- *                     self.wfunc.data(t1_new, self.Ht1)             # <<<<<<<<<<<<<<
- *                     self.wfunc.data(t2_new, self.Ht2)
- *                     self.wfunc.data(t3_new, self.Ht3)
- */
-        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 717, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_4 = PyFloat_FromDouble(__pyx_v_t1_new); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 717, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __pyx_t_6 = NULL;
-        __pyx_t_8 = 0;
-        if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_9))) {
-          __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_9);
-          if (likely(__pyx_t_6)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-            __Pyx_INCREF(__pyx_t_6);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_9, function);
-            __pyx_t_8 = 1;
-          }
-        }
-        #if CYTHON_FAST_PYCALL
-        if (PyFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_4, __pyx_v_self->Ht1};
-          __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 717, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        } else
-        #endif
-        #if CYTHON_FAST_PYCCALL
-        if (__Pyx_PyFastCFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_4, __pyx_v_self->Ht1};
-          __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 717, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        } else
-        #endif
-        {
-          __pyx_t_7 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 717, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          if (__pyx_t_6) {
-            __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_6); __pyx_t_6 = NULL;
-          }
-          __Pyx_GIVEREF(__pyx_t_4);
-          PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_8, __pyx_t_4);
-          __Pyx_INCREF(__pyx_v_self->Ht1);
-          __Pyx_GIVEREF(__pyx_v_self->Ht1);
-          PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_8, __pyx_v_self->Ht1);
-          __pyx_t_4 = 0;
-          __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_t_7, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 717, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":718
- *                     self.wfunc.data(t0_new, self.Ht0)
- *                     self.wfunc.data(t1_new, self.Ht1)
- *                     self.wfunc.data(t2_new, self.Ht2)             # <<<<<<<<<<<<<<
- *                     self.wfunc.data(t3_new, self.Ht3)
- *                     self.wfunc.data(t4_new, self.Ht4)
- */
-        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 718, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_7 = PyFloat_FromDouble(__pyx_v_t2_new); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 718, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_7);
-        __pyx_t_4 = NULL;
-        __pyx_t_8 = 0;
-        if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_9))) {
-          __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_9);
-          if (likely(__pyx_t_4)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-            __Pyx_INCREF(__pyx_t_4);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_9, function);
-            __pyx_t_8 = 1;
-          }
-        }
-        #if CYTHON_FAST_PYCALL
-        if (PyFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_7, __pyx_v_self->Ht2};
-          __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 718, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-        } else
-        #endif
-        #if CYTHON_FAST_PYCCALL
-        if (__Pyx_PyFastCFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_7, __pyx_v_self->Ht2};
-          __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 718, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-        } else
-        #endif
-        {
-          __pyx_t_6 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 718, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_6);
-          if (__pyx_t_4) {
-            __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_4); __pyx_t_4 = NULL;
-          }
-          __Pyx_GIVEREF(__pyx_t_7);
-          PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_8, __pyx_t_7);
-          __Pyx_INCREF(__pyx_v_self->Ht2);
-          __Pyx_GIVEREF(__pyx_v_self->Ht2);
-          PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_8, __pyx_v_self->Ht2);
-          __pyx_t_7 = 0;
-          __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_t_6, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 718, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":719
- *                     self.wfunc.data(t1_new, self.Ht1)
- *                     self.wfunc.data(t2_new, self.Ht2)
- *                     self.wfunc.data(t3_new, self.Ht3)             # <<<<<<<<<<<<<<
- *                     self.wfunc.data(t4_new, self.Ht4)
- *                     # w''(t) on t0 and t2, central finite difference scheme
- */
-        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 719, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_6 = PyFloat_FromDouble(__pyx_v_t3_new); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 719, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_7 = NULL;
-        __pyx_t_8 = 0;
-        if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_9))) {
-          __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_9);
-          if (likely(__pyx_t_7)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-            __Pyx_INCREF(__pyx_t_7);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_9, function);
-            __pyx_t_8 = 1;
-          }
-        }
-        #if CYTHON_FAST_PYCALL
-        if (PyFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_6, __pyx_v_self->Ht3};
-          __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 719, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        } else
-        #endif
-        #if CYTHON_FAST_PYCCALL
-        if (__Pyx_PyFastCFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_6, __pyx_v_self->Ht3};
-          __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 719, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        } else
-        #endif
-        {
-          __pyx_t_4 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 719, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          if (__pyx_t_7) {
-            __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_7); __pyx_t_7 = NULL;
-          }
-          __Pyx_GIVEREF(__pyx_t_6);
-          PyTuple_SET_ITEM(__pyx_t_4, 0+__pyx_t_8, __pyx_t_6);
-          __Pyx_INCREF(__pyx_v_self->Ht3);
-          __Pyx_GIVEREF(__pyx_v_self->Ht3);
-          PyTuple_SET_ITEM(__pyx_t_4, 1+__pyx_t_8, __pyx_v_self->Ht3);
-          __pyx_t_6 = 0;
-          __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_t_4, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 719, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":720
- *                     self.wfunc.data(t2_new, self.Ht2)
- *                     self.wfunc.data(t3_new, self.Ht3)
- *                     self.wfunc.data(t4_new, self.Ht4)             # <<<<<<<<<<<<<<
- *                     # w''(t) on t0 and t2, central finite difference scheme
- *                     for i in range(self.nnz):
- */
-        __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_data); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 720, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_4 = PyFloat_FromDouble(__pyx_v_t4_new); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 720, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __pyx_t_6 = NULL;
-        __pyx_t_8 = 0;
-        if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_9))) {
-          __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_9);
-          if (likely(__pyx_t_6)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
-            __Pyx_INCREF(__pyx_t_6);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_9, function);
-            __pyx_t_8 = 1;
-          }
-        }
-        #if CYTHON_FAST_PYCALL
-        if (PyFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_4, __pyx_v_self->Ht4};
-          __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 720, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        } else
-        #endif
-        #if CYTHON_FAST_PYCCALL
-        if (__Pyx_PyFastCFunction_Check(__pyx_t_9)) {
-          PyObject *__pyx_temp[3] = {__pyx_t_6, __pyx_t_4, __pyx_v_self->Ht4};
-          __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_9, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 720, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        } else
-        #endif
-        {
-          __pyx_t_7 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 720, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          if (__pyx_t_6) {
-            __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_6); __pyx_t_6 = NULL;
-          }
-          __Pyx_GIVEREF(__pyx_t_4);
-          PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_8, __pyx_t_4);
-          __Pyx_INCREF(__pyx_v_self->Ht4);
-          __Pyx_GIVEREF(__pyx_v_self->Ht4);
-          PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_8, __pyx_v_self->Ht4);
-          __pyx_t_4 = 0;
-          __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_9, __pyx_t_7, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 720, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":722
- *                     self.wfunc.data(t4_new, self.Ht4)
- *                     # w''(t) on t0 and t2, central finite difference scheme
- *                     for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                         self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \
- *                             + cc1 * (Htm1[i] + self.Ht1[i]) \
- */
-        __pyx_t_16 = __pyx_v_self->nnz;
-        __pyx_t_17 = __pyx_t_16;
-        for (__pyx_t_18 = 0; __pyx_t_18 < __pyx_t_17; __pyx_t_18+=1) {
-          __pyx_v_i = __pyx_t_18;
-
-          /* "tkwant/onebody/kernels.pyx":723
- *                     # w''(t) on t0 and t2, central finite difference scheme
- *                     for i in range(self.nnz):
- *                         self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \             # <<<<<<<<<<<<<<
- *                             + cc1 * (Htm1[i] + self.Ht1[i]) \
- *                             + cc0 * self.Ht0[i]
- */
-          __pyx_t_3 = PyFloat_FromDouble(__pyx_v_cc2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 723, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __pyx_t_9 = __Pyx_GetItemInt(__pyx_v_Htm2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 723, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __pyx_t_7 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 723, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __pyx_t_4 = PyNumber_Add(__pyx_t_9, __pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 723, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __pyx_t_7 = PyNumber_Multiply(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 723, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":724
- *                     for i in range(self.nnz):
- *                         self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \
- *                             + cc1 * (Htm1[i] + self.Ht1[i]) \             # <<<<<<<<<<<<<<
- *                             + cc0 * self.Ht0[i]
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- */
-          __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cc1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 724, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_Htm1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 724, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __pyx_t_9 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 724, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __pyx_t_6 = PyNumber_Add(__pyx_t_3, __pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 724, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_6);
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-          __pyx_t_9 = PyNumber_Multiply(__pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 724, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __pyx_t_6 = PyNumber_Add(__pyx_t_7, __pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 724, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_6);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":725
- *                         self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \
- *                             + cc1 * (Htm1[i] + self.Ht1[i]) \
- *                             + cc0 * self.Ht0[i]             # <<<<<<<<<<<<<<
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- *                             + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- */
-          __pyx_t_9 = PyFloat_FromDouble(__pyx_v_cc0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 725, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __pyx_t_7 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 725, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __pyx_t_4 = PyNumber_Multiply(__pyx_t_9, __pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 725, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __pyx_t_7 = PyNumber_Add(__pyx_t_6, __pyx_t_4); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 725, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":723
- *                     # w''(t) on t0 and t2, central finite difference scheme
- *                     for i in range(self.nnz):
- *                         self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \             # <<<<<<<<<<<<<<
- *                             + cc1 * (Htm1[i] + self.Ht1[i]) \
- *                             + cc0 * self.Ht0[i]
- */
-          if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, __pyx_t_7, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 723, __pyx_L1_error)
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":726
- *                             + cc1 * (Htm1[i] + self.Ht1[i]) \
- *                             + cc0 * self.Ht0[i]
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
- *                             + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- *                             + cc0 * self.Ht2[i]
- */
-          __pyx_t_7 = PyFloat_FromDouble(__pyx_v_cc2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 726, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 726, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->Ht4, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 726, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_6);
-          __pyx_t_9 = PyNumber_Add(__pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 726, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __pyx_t_6 = PyNumber_Multiply(__pyx_t_7, __pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 726, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_6);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":727
- *                             + cc0 * self.Ht0[i]
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- *                             + cc1 * (self.Ht1[i] + self.Ht3[i]) \             # <<<<<<<<<<<<<<
- *                             + cc0 * self.Ht2[i]
- * 
- */
-          __pyx_t_9 = PyFloat_FromDouble(__pyx_v_cc1); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 727, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __pyx_t_7 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 727, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_7);
-          __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht3, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 727, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __pyx_t_3 = PyNumber_Add(__pyx_t_7, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 727, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-          __pyx_t_4 = PyNumber_Multiply(__pyx_t_9, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 727, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __pyx_t_3 = PyNumber_Add(__pyx_t_6, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 727, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":728
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
- *                             + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- *                             + cc0 * self.Ht2[i]             # <<<<<<<<<<<<<<
- * 
- *                 for i in range(self.nnz):
- */
-          __pyx_t_4 = PyFloat_FromDouble(__pyx_v_cc0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 728, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_4);
-          __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 728, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_6);
-          __pyx_t_9 = PyNumber_Multiply(__pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 728, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_9);
-          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __pyx_t_6 = PyNumber_Add(__pyx_t_3, __pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 728, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_6);
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":726
- *                             + cc1 * (Htm1[i] + self.Ht1[i]) \
- *                             + cc0 * self.Ht0[i]
- *                         self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \             # <<<<<<<<<<<<<<
- *                             + cc1 * (self.Ht1[i] + self.Ht3[i]) \
- *                             + cc0 * self.Ht2[i]
- */
-          if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, __pyx_t_6, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 726, __pyx_L1_error)
-          __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        }
-      }
-      __pyx_L6:;
-
-      /* "tkwant/onebody/kernels.pyx":730
- *                             + cc0 * self.Ht2[i]
- * 
- *                 for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                     # w''(t) on t1, spline formula
- *                     self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\
- */
-      __pyx_t_16 = __pyx_v_self->nnz;
-      __pyx_t_17 = __pyx_t_16;
-      for (__pyx_t_18 = 0; __pyx_t_18 < __pyx_t_17; __pyx_t_18+=1) {
-        __pyx_v_i = __pyx_t_18;
-
-        /* "tkwant/onebody/kernels.pyx":732
- *                 for i in range(self.nnz):
- *                     # w''(t) on t1, spline formula
- *                     self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\             # <<<<<<<<<<<<<<
- *                         - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
- *                     self.y0[i] = self.Ht0[i]
- */
-        __pyx_t_6 = PyFloat_FromDouble((1.5 * __pyx_v_rdt2)); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 732, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_9 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 732, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 732, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_4 = PyNumber_Add(__pyx_t_9, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 732, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 732, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_9 = PyNumber_Multiply(__pyx_int_2, __pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 732, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __pyx_t_3 = PyNumber_Subtract(__pyx_t_4, __pyx_t_9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 732, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __pyx_t_9 = PyNumber_Multiply(__pyx_t_6, __pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 732, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":733
- *                     # w''(t) on t1, spline formula
- *                     self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\
- *                         - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])             # <<<<<<<<<<<<<<
- *                     self.y0[i] = self.Ht0[i]
- *                     self.y1[i] = self.Ht1[i]
- */
-        __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 733, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 733, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_4 = PyNumber_Add(__pyx_t_3, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 733, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        __pyx_t_6 = PyNumber_Multiply(__pyx_float_0_25, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 733, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __pyx_t_4 = PyNumber_Subtract(__pyx_t_9, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 733, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":732
- *                 for i in range(self.nnz):
- *                     # w''(t) on t1, spline formula
- *                     self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\             # <<<<<<<<<<<<<<
- *                         - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
- *                     self.y0[i] = self.Ht0[i]
- */
-        if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2Ht1, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 732, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":734
- *                     self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\
- *                         - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
- *                     self.y0[i] = self.Ht0[i]             # <<<<<<<<<<<<<<
- *                     self.y1[i] = self.Ht1[i]
- *                     self.d2y0[i] = self.d2Ht0[i]
- */
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 734, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        if (unlikely(__Pyx_SetItemInt(__pyx_v_self->y0, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 734, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":735
- *                         - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
- *                     self.y0[i] = self.Ht0[i]
- *                     self.y1[i] = self.Ht1[i]             # <<<<<<<<<<<<<<
- *                     self.d2y0[i] = self.d2Ht0[i]
- *                     self.d2y1[i] = self.d2Ht1[i]
- */
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 735, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        if (unlikely(__Pyx_SetItemInt(__pyx_v_self->y1, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 735, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":736
- *                     self.y0[i] = self.Ht0[i]
- *                     self.y1[i] = self.Ht1[i]
- *                     self.d2y0[i] = self.d2Ht0[i]             # <<<<<<<<<<<<<<
- *                     self.d2y1[i] = self.d2Ht1[i]
- *                 self.t0, self.t1, self.t2, self.t3, self.t4 = t0_new, t1_new, t2_new, t3_new, t4_new
- */
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->d2Ht0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 736, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2y0, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 736, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":737
- *                     self.y1[i] = self.Ht1[i]
- *                     self.d2y0[i] = self.d2Ht0[i]
- *                     self.d2y1[i] = self.d2Ht1[i]             # <<<<<<<<<<<<<<
- *                 self.t0, self.t1, self.t2, self.t3, self.t4 = t0_new, t1_new, t2_new, t3_new, t4_new
- *                 self.x0, self.x1 = self.t0, self.t1
- */
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->d2Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 737, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2y1, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 737, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      }
-
-      /* "tkwant/onebody/kernels.pyx":738
- *                     self.d2y0[i] = self.d2Ht0[i]
- *                     self.d2y1[i] = self.d2Ht1[i]
- *                 self.t0, self.t1, self.t2, self.t3, self.t4 = t0_new, t1_new, t2_new, t3_new, t4_new             # <<<<<<<<<<<<<<
- *                 self.x0, self.x1 = self.t0, self.t1
- *                 self._do_update = True
- */
-      __pyx_t_15 = __pyx_v_t0_new;
-      __pyx_t_14 = __pyx_v_t1_new;
-      __pyx_t_13 = __pyx_v_t2_new;
-      __pyx_t_12 = __pyx_v_t3_new;
-      __pyx_t_11 = __pyx_v_t4_new;
-      __pyx_v_self->t0 = __pyx_t_15;
-      __pyx_v_self->t1 = __pyx_t_14;
-      __pyx_v_self->t2 = __pyx_t_13;
-      __pyx_v_self->t3 = __pyx_t_12;
-      __pyx_v_self->t4 = __pyx_t_11;
-
-      /* "tkwant/onebody/kernels.pyx":739
- *                     self.d2y1[i] = self.d2Ht1[i]
- *                 self.t0, self.t1, self.t2, self.t3, self.t4 = t0_new, t1_new, t2_new, t3_new, t4_new
- *                 self.x0, self.x1 = self.t0, self.t1             # <<<<<<<<<<<<<<
- *                 self._do_update = True
- * 
- */
-      __pyx_t_11 = __pyx_v_self->t0;
-      __pyx_t_12 = __pyx_v_self->t1;
-      __pyx_v_self->x0 = __pyx_t_11;
-      __pyx_v_self->x1 = __pyx_t_12;
-
-      /* "tkwant/onebody/kernels.pyx":740
- *                 self.t0, self.t1, self.t2, self.t3, self.t4 = t0_new, t1_new, t2_new, t3_new, t4_new
- *                 self.x0, self.x1 = self.t0, self.t1
- *                 self._do_update = True             # <<<<<<<<<<<<<<
- * 
- *             # to construct the spline, we need f and f''
- */
-      __pyx_v_self->_do_update = 1;
-
-      /* "tkwant/onebody/kernels.pyx":693
- * 
- *             # update matrices
- *             if time >= self.t2:             # <<<<<<<<<<<<<<
- *                 t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)
- *                 rdt2 = 1 / (self.dt * self.dt)
- */
-    }
-
-    /* "tkwant/onebody/kernels.pyx":746
- *             # the spline is then evaluated first on the left, then on the right
- *             # interval. again f and f'' are shifted from left to right interval.
- *             if self._do_update and time > self.t1:             # <<<<<<<<<<<<<<
- *                 for i in range(self.nnz):
- *                     self.y0[i] = self.Ht1[i]
- */
-    __pyx_t_1 = (__pyx_v_self->_do_update != 0);
-    if (__pyx_t_1) {
-    } else {
-      __pyx_t_2 = __pyx_t_1;
-      goto __pyx_L16_bool_binop_done;
-    }
-    __pyx_t_1 = ((__pyx_v_time > __pyx_v_self->t1) != 0);
-    __pyx_t_2 = __pyx_t_1;
-    __pyx_L16_bool_binop_done:;
-    if (__pyx_t_2) {
-
-      /* "tkwant/onebody/kernels.pyx":747
- *             # interval. again f and f'' are shifted from left to right interval.
- *             if self._do_update and time > self.t1:
- *                 for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                     self.y0[i] = self.Ht1[i]
- *                     self.y1[i] = self.Ht2[i]
- */
-      __pyx_t_16 = __pyx_v_self->nnz;
-      __pyx_t_17 = __pyx_t_16;
-      for (__pyx_t_18 = 0; __pyx_t_18 < __pyx_t_17; __pyx_t_18+=1) {
-        __pyx_v_i = __pyx_t_18;
-
-        /* "tkwant/onebody/kernels.pyx":748
- *             if self._do_update and time > self.t1:
- *                 for i in range(self.nnz):
- *                     self.y0[i] = self.Ht1[i]             # <<<<<<<<<<<<<<
- *                     self.y1[i] = self.Ht2[i]
- *                     self.d2y0[i] = self.d2Ht1[i]
- */
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 748, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        if (unlikely(__Pyx_SetItemInt(__pyx_v_self->y0, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 748, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":749
- *                 for i in range(self.nnz):
- *                     self.y0[i] = self.Ht1[i]
- *                     self.y1[i] = self.Ht2[i]             # <<<<<<<<<<<<<<
- *                     self.d2y0[i] = self.d2Ht1[i]
- *                     self.d2y1[i] = self.d2Ht2[i]
- */
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 749, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        if (unlikely(__Pyx_SetItemInt(__pyx_v_self->y1, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 749, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":750
- *                     self.y0[i] = self.Ht1[i]
- *                     self.y1[i] = self.Ht2[i]
- *                     self.d2y0[i] = self.d2Ht1[i]             # <<<<<<<<<<<<<<
- *                     self.d2y1[i] = self.d2Ht2[i]
- *                 self.x0, self.x1 = self.t1, self.t2
- */
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->d2Ht1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 750, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2y0, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 750, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":751
- *                     self.y1[i] = self.Ht2[i]
- *                     self.d2y0[i] = self.d2Ht1[i]
- *                     self.d2y1[i] = self.d2Ht2[i]             # <<<<<<<<<<<<<<
- *                 self.x0, self.x1 = self.t1, self.t2
- *                 self._do_update = False
- */
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->d2Ht2, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 751, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        if (unlikely(__Pyx_SetItemInt(__pyx_v_self->d2y1, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 751, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      }
-
-      /* "tkwant/onebody/kernels.pyx":752
- *                     self.d2y0[i] = self.d2Ht1[i]
- *                     self.d2y1[i] = self.d2Ht2[i]
- *                 self.x0, self.x1 = self.t1, self.t2             # <<<<<<<<<<<<<<
- *                 self._do_update = False
- * 
- */
-      __pyx_t_12 = __pyx_v_self->t1;
-      __pyx_t_11 = __pyx_v_self->t2;
-      __pyx_v_self->x0 = __pyx_t_12;
-      __pyx_v_self->x1 = __pyx_t_11;
-
-      /* "tkwant/onebody/kernels.pyx":753
- *                     self.d2y1[i] = self.d2Ht2[i]
- *                 self.x0, self.x1 = self.t1, self.t2
- *                 self._do_update = False             # <<<<<<<<<<<<<<
- * 
- *             a, b, c, d = _get_polynome_coeffs(time, self.x0, self.x1, self.dt)
- */
-      __pyx_v_self->_do_update = 0;
-
-      /* "tkwant/onebody/kernels.pyx":746
- *             # the spline is then evaluated first on the left, then on the right
- *             # interval. again f and f'' are shifted from left to right interval.
- *             if self._do_update and time > self.t1:             # <<<<<<<<<<<<<<
- *                 for i in range(self.nnz):
- *                     self.y0[i] = self.Ht1[i]
- */
-    }
-
-    /* "tkwant/onebody/kernels.pyx":755
- *                 self._do_update = False
- * 
- *             a, b, c, d = _get_polynome_coeffs(time, self.x0, self.x1, self.dt)             # <<<<<<<<<<<<<<
- * 
- *             if out is None:
- */
-    __pyx_t_19 = __pyx_f_6tkwant_7onebody_7kernels__get_polynome_coeffs(__pyx_v_time, __pyx_v_self->x0, __pyx_v_self->x1, __pyx_v_self->dt);
-    __pyx_t_11 = __pyx_t_19.f0;
-    __pyx_t_12 = __pyx_t_19.f1;
-    __pyx_t_13 = __pyx_t_19.f2;
-    __pyx_t_14 = __pyx_t_19.f3;
-    __pyx_v_a = __pyx_t_11;
-    __pyx_v_b = __pyx_t_12;
-    __pyx_v_c = __pyx_t_13;
-    __pyx_v_d = __pyx_t_14;
-
-    /* "tkwant/onebody/kernels.pyx":757
- *             a, b, c, d = _get_polynome_coeffs(time, self.x0, self.x1, self.dt)
- * 
- *             if out is None:             # <<<<<<<<<<<<<<
- *                 for i in range(self.nnz):
- *                     self.wt.data[i] = a * self.y0[i] + b * self.y1[i] \
- */
-    __pyx_t_2 = (__pyx_v_out == Py_None);
-    __pyx_t_1 = (__pyx_t_2 != 0);
-    if (__pyx_t_1) {
-
-      /* "tkwant/onebody/kernels.pyx":758
- * 
- *             if out is None:
- *                 for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                     self.wt.data[i] = a * self.y0[i] + b * self.y1[i] \
- *                         + c * self.d2y0[i] + d * self.d2y1[i]
- */
-      __pyx_t_16 = __pyx_v_self->nnz;
-      __pyx_t_17 = __pyx_t_16;
-      for (__pyx_t_18 = 0; __pyx_t_18 < __pyx_t_17; __pyx_t_18+=1) {
-        __pyx_v_i = __pyx_t_18;
-
-        /* "tkwant/onebody/kernels.pyx":759
- *             if out is None:
- *                 for i in range(self.nnz):
- *                     self.wt.data[i] = a * self.y0[i] + b * self.y1[i] \             # <<<<<<<<<<<<<<
- *                         + c * self.d2y0[i] + d * self.d2y1[i]
- *                 return self.wt
- */
-        __pyx_t_4 = PyFloat_FromDouble(__pyx_v_a); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 759, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __pyx_t_6 = __Pyx_GetItemInt(__pyx_v_self->y0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 759, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_9 = PyNumber_Multiply(__pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 759, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        __pyx_t_6 = PyFloat_FromDouble(__pyx_v_b); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 759, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->y1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 759, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __pyx_t_3 = PyNumber_Multiply(__pyx_t_6, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 759, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __pyx_t_4 = PyNumber_Add(__pyx_t_9, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 759, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":760
- *                 for i in range(self.nnz):
- *                     self.wt.data[i] = a * self.y0[i] + b * self.y1[i] \
- *                         + c * self.d2y0[i] + d * self.d2y1[i]             # <<<<<<<<<<<<<<
- *                 return self.wt
- *             else:
- */
-        __pyx_t_3 = PyFloat_FromDouble(__pyx_v_c); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 760, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_9 = __Pyx_GetItemInt(__pyx_v_self->d2y0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 760, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_6 = PyNumber_Multiply(__pyx_t_3, __pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 760, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __pyx_t_9 = PyNumber_Add(__pyx_t_4, __pyx_t_6); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 760, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        __pyx_t_6 = PyFloat_FromDouble(__pyx_v_d); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 760, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->d2y1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 760, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __pyx_t_3 = PyNumber_Multiply(__pyx_t_6, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 760, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __pyx_t_4 = PyNumber_Add(__pyx_t_9, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 760, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":759
- *             if out is None:
- *                 for i in range(self.nnz):
- *                     self.wt.data[i] = a * self.y0[i] + b * self.y1[i] \             # <<<<<<<<<<<<<<
- *                         + c * self.d2y0[i] + d * self.d2y1[i]
- *                 return self.wt
- */
-        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_data); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 759, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        if (unlikely(__Pyx_SetItemInt(__pyx_t_3, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 759, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      }
-
-      /* "tkwant/onebody/kernels.pyx":761
- *                     self.wt.data[i] = a * self.y0[i] + b * self.y1[i] \
- *                         + c * self.d2y0[i] + d * self.d2y1[i]
- *                 return self.wt             # <<<<<<<<<<<<<<
- *             else:
- *                 for i in range(self.nnz):
- */
-      __Pyx_XDECREF(__pyx_r);
-      __Pyx_INCREF(__pyx_v_self->wt);
-      __pyx_r = __pyx_v_self->wt;
-      goto __pyx_L0;
-
-      /* "tkwant/onebody/kernels.pyx":757
- *             a, b, c, d = _get_polynome_coeffs(time, self.x0, self.x1, self.dt)
- * 
- *             if out is None:             # <<<<<<<<<<<<<<
- *                 for i in range(self.nnz):
- *                     self.wt.data[i] = a * self.y0[i] + b * self.y1[i] \
- */
-    }
-
-    /* "tkwant/onebody/kernels.pyx":763
- *                 return self.wt
- *             else:
- *                 for i in range(self.nnz):             # <<<<<<<<<<<<<<
- *                     out.data[i] = a * self.y0[i] + b * self.y1[i] \
- *                         + c * self.d2y0[i] + d * self.d2y1[i]
- */
-    /*else*/ {
-      __pyx_t_16 = __pyx_v_self->nnz;
-      __pyx_t_17 = __pyx_t_16;
-      for (__pyx_t_18 = 0; __pyx_t_18 < __pyx_t_17; __pyx_t_18+=1) {
-        __pyx_v_i = __pyx_t_18;
-
-        /* "tkwant/onebody/kernels.pyx":764
- *             else:
- *                 for i in range(self.nnz):
- *                     out.data[i] = a * self.y0[i] + b * self.y1[i] \             # <<<<<<<<<<<<<<
- *                         + c * self.d2y0[i] + d * self.d2y1[i]
- * 
- */
-        __pyx_t_4 = PyFloat_FromDouble(__pyx_v_a); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 764, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __pyx_t_3 = __Pyx_GetItemInt(__pyx_v_self->y0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 764, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_9 = PyNumber_Multiply(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 764, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __pyx_t_3 = PyFloat_FromDouble(__pyx_v_b); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 764, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->y1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 764, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __pyx_t_6 = PyNumber_Multiply(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 764, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __pyx_t_4 = PyNumber_Add(__pyx_t_9, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 764, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":765
- *                 for i in range(self.nnz):
- *                     out.data[i] = a * self.y0[i] + b * self.y1[i] \
- *                         + c * self.d2y0[i] + d * self.d2y1[i]             # <<<<<<<<<<<<<<
- * 
- *         else:
- */
-        __pyx_t_6 = PyFloat_FromDouble(__pyx_v_c); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 765, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __pyx_t_9 = __Pyx_GetItemInt(__pyx_v_self->d2y0, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 765, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __pyx_t_3 = PyNumber_Multiply(__pyx_t_6, __pyx_t_9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 765, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __pyx_t_9 = PyNumber_Add(__pyx_t_4, __pyx_t_3); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 765, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_9);
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __pyx_t_3 = PyFloat_FromDouble(__pyx_v_d); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 765, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_4 = __Pyx_GetItemInt(__pyx_v_self->d2y1, __pyx_v_i, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 765, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __pyx_t_6 = PyNumber_Multiply(__pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 765, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __pyx_t_4 = PyNumber_Add(__pyx_t_9, __pyx_t_6); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 765, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-
-        /* "tkwant/onebody/kernels.pyx":764
- *             else:
- *                 for i in range(self.nnz):
- *                     out.data[i] = a * self.y0[i] + b * self.y1[i] \             # <<<<<<<<<<<<<<
- *                         + c * self.d2y0[i] + d * self.d2y1[i]
- * 
+ *     @cython.boundscheck(False)
  */
-        __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_data); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 764, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_6);
-        if (unlikely(__Pyx_SetItemInt(__pyx_t_6, __pyx_v_i, __pyx_t_4, unsigned int, 0, __Pyx_PyInt_From_unsigned_int, 0, 0, 0) < 0)) __PYX_ERR(0, 764, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->intfunc, __pyx_n_s_eval); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 767, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    __pyx_t_5 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 767, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_data); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 767, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_9 = NULL;
+    __pyx_t_8 = 0;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_7))) {
+      __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_7);
+      if (likely(__pyx_t_9)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
+        __Pyx_INCREF(__pyx_t_9);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_7, function);
+        __pyx_t_8 = 1;
       }
     }
-
-    /* "tkwant/onebody/kernels.pyx":690
- *                                                                    self.nnz)
- * 
- *         if self.dt > 0:             # <<<<<<<<<<<<<<
- * 
- *             # update matrices
- */
-    goto __pyx_L4;
-  }
-
-  /* "tkwant/onebody/kernels.pyx":768
- * 
- *         else:
- *             if out is None:             # <<<<<<<<<<<<<<
- *                 do_return = True
- *                 out = self.wfunc.evaluate(time)
- */
-  /*else*/ {
-    __pyx_t_1 = (__pyx_v_out == Py_None);
-    __pyx_t_2 = (__pyx_t_1 != 0);
-    if (__pyx_t_2) {
-
-      /* "tkwant/onebody/kernels.pyx":769
- *         else:
- *             if out is None:
- *                 do_return = True             # <<<<<<<<<<<<<<
- *                 out = self.wfunc.evaluate(time)
- *             else:
- */
-      __pyx_v_do_return = 1;
-
-      /* "tkwant/onebody/kernels.pyx":770
- *             if out is None:
- *                 do_return = True
- *                 out = self.wfunc.evaluate(time)             # <<<<<<<<<<<<<<
- *             else:
- *                 do_return = False
- */
-      __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_evaluate); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 770, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_6);
-      __pyx_t_9 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 770, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_3 = NULL;
-      if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_6))) {
-        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_6);
-        if (likely(__pyx_t_3)) {
-          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
-          __Pyx_INCREF(__pyx_t_3);
-          __Pyx_INCREF(function);
-          __Pyx_DECREF_SET(__pyx_t_6, function);
-        }
-      }
-      __pyx_t_4 = (__pyx_t_3) ? __Pyx_PyObject_Call2Args(__pyx_t_6, __pyx_t_3, __pyx_t_9) : __Pyx_PyObject_CallOneArg(__pyx_t_6, __pyx_t_9);
-      __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-      if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 770, __pyx_L1_error)
+    #if CYTHON_FAST_PYCALL
+    if (PyFunction_Check(__pyx_t_7)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_9, __pyx_t_5, __pyx_t_3};
+      __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 767, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
       __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __Pyx_DECREF_SET(__pyx_v_out, __pyx_t_4);
-      __pyx_t_4 = 0;
-
-      /* "tkwant/onebody/kernels.pyx":768
- * 
- *         else:
- *             if out is None:             # <<<<<<<<<<<<<<
- *                 do_return = True
- *                 out = self.wfunc.evaluate(time)
- */
-      goto __pyx_L25;
-    }
-
-    /* "tkwant/onebody/kernels.pyx":772
- *                 out = self.wfunc.evaluate(time)
- *             else:
- *                 do_return = False             # <<<<<<<<<<<<<<
- *                 self.wfunc.evaluate(time, out)
- *             return out if do_return else None
- */
-    /*else*/ {
-      __pyx_v_do_return = 0;
-
-      /* "tkwant/onebody/kernels.pyx":773
- *             else:
- *                 do_return = False
- *                 self.wfunc.evaluate(time, out)             # <<<<<<<<<<<<<<
- *             return out if do_return else None
- * 
- */
-      __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_evaluate); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 773, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    } else
+    #endif
+    #if CYTHON_FAST_PYCCALL
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_7)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_9, __pyx_t_5, __pyx_t_3};
+      __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 767, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    } else
+    #endif
+    {
+      __pyx_t_6 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 767, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
-      __pyx_t_9 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 773, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_3 = NULL;
-      __pyx_t_8 = 0;
-      if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_6))) {
-        __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_6);
-        if (likely(__pyx_t_3)) {
-          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
-          __Pyx_INCREF(__pyx_t_3);
-          __Pyx_INCREF(function);
-          __Pyx_DECREF_SET(__pyx_t_6, function);
-          __pyx_t_8 = 1;
-        }
-      }
-      #if CYTHON_FAST_PYCALL
-      if (PyFunction_Check(__pyx_t_6)) {
-        PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_t_9, __pyx_v_out};
-        __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 773, __pyx_L1_error)
-        __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-      } else
-      #endif
-      #if CYTHON_FAST_PYCCALL
-      if (__Pyx_PyFastCFunction_Check(__pyx_t_6)) {
-        PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_t_9, __pyx_v_out};
-        __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 773, __pyx_L1_error)
-        __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-      } else
-      #endif
-      {
-        __pyx_t_7 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 773, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_7);
-        if (__pyx_t_3) {
-          __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_3); __pyx_t_3 = NULL;
-        }
-        __Pyx_GIVEREF(__pyx_t_9);
-        PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_8, __pyx_t_9);
-        __Pyx_INCREF(__pyx_v_out);
-        __Pyx_GIVEREF(__pyx_v_out);
-        PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_8, __pyx_v_out);
-        __pyx_t_9 = 0;
-        __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_7, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 773, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+      if (__pyx_t_9) {
+        __Pyx_GIVEREF(__pyx_t_9); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_9); __pyx_t_9 = NULL;
       }
+      __Pyx_GIVEREF(__pyx_t_5);
+      PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_8, __pyx_t_5);
+      __Pyx_GIVEREF(__pyx_t_3);
+      PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_8, __pyx_t_3);
+      __pyx_t_5 = 0;
+      __pyx_t_3 = 0;
+      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 767, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
       __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    }
-    __pyx_L25:;
-
-    /* "tkwant/onebody/kernels.pyx":774
- *                 do_return = False
- *                 self.wfunc.evaluate(time, out)
- *             return out if do_return else None             # <<<<<<<<<<<<<<
- * 
- *     @cython.boundscheck(False)
- */
-    __Pyx_XDECREF(__pyx_r);
-    if ((__pyx_v_do_return != 0)) {
-      __Pyx_INCREF(__pyx_v_out);
-      __pyx_t_4 = __pyx_v_out;
-    } else {
-      __Pyx_INCREF(Py_None);
-      __pyx_t_4 = Py_None;
     }
-    __pyx_r = __pyx_t_4;
-    __pyx_t_4 = 0;
-    goto __pyx_L0;
+    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   }
-  __pyx_L4:;
 
-  /* "tkwant/onebody/kernels.pyx":659
+  /* "tkwant/onebody/kernels.pyx":738
  *     @cython.boundscheck(False)
  *     @cython.wraparound(False)
  *     def evaluate(self, double time, object out=None):             # <<<<<<<<<<<<<<
  *         '''Evaluate the W(t) matrix for the given time t.
  * 
  */
 
@@ -14530,37 +15364,37 @@
   __Pyx_XDECREF(__pyx_t_5);
   __Pyx_XDECREF(__pyx_t_6);
   __Pyx_XDECREF(__pyx_t_7);
   __Pyx_XDECREF(__pyx_t_9);
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationInterpolator.evaluate", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
-  __Pyx_XDECREF(__pyx_v_Htm2);
-  __Pyx_XDECREF(__pyx_v_Htm1);
-  __Pyx_XDECREF(__pyx_v_out);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":778
+/* "tkwant/onebody/kernels.pyx":771
  *     @cython.boundscheck(False)
  *     @cython.wraparound(False)
  *     def apply(self, double time, const complex[:] ket, object out=None):             # <<<<<<<<<<<<<<
  *         '''Evaluate the matrix-vector product W(t) @ ket for the given time.
  * 
  */
 
 /* Python wrapper */
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_24PerturbationInterpolator_5apply(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static char __pyx_doc_6tkwant_7onebody_7kernels_24PerturbationInterpolator_4apply[] = "PerturbationInterpolator.apply(self, double time, const double complex[:] ket, out=None)\nEvaluate the matrix-vector product W(t) @ ket for the given time.\n\n        Parameters\n        ----------\n        time : int or float\n            Time argument, must be equal or larger than `time_start`.\n        out : `numpy.ndarray`, optional\n            Sparse matrix with to perform the operation in-place.\n\n        Returns\n        -------\n        out : `numpy.ndarray` or `None`\n            The product W(t) @ ket. If an ``out`` argument is given,\n            the operation is performed in-place and the routine returns `None`.\n        ";
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_24PerturbationInterpolator_5apply(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   double __pyx_v_time;
   __Pyx_memviewslice __pyx_v_ket = { 0, 0, { 0 }, { 0 }, { 0 } };
   PyObject *__pyx_v_out = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("apply (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_time,&__pyx_n_s_ket,&__pyx_n_s_out,0};
     PyObject* values[3] = {0,0,0};
     values[2] = ((PyObject *)Py_None);
@@ -14582,756 +15416,575 @@
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_ket)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("apply", 0, 2, 3, 1); __PYX_ERR(0, 778, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("apply", 0, 2, 3, 1); __PYX_ERR(0, 771, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_out);
           if (value) { values[2] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "apply") < 0)) __PYX_ERR(0, 778, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "apply") < 0)) __PYX_ERR(0, 771, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
         CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
-    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 778, __pyx_L3_error)
-    __pyx_v_ket = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex__const__(values[1], 0); if (unlikely(!__pyx_v_ket.memview)) __PYX_ERR(0, 778, __pyx_L3_error)
+    __pyx_v_time = __pyx_PyFloat_AsDouble(values[0]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 771, __pyx_L3_error)
+    __pyx_v_ket = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex__const__(values[1], 0); if (unlikely(!__pyx_v_ket.memview)) __PYX_ERR(0, 771, __pyx_L3_error)
     __pyx_v_out = values[2];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("apply", 0, 2, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 778, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("apply", 0, 2, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 771, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationInterpolator.apply", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_4apply(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)__pyx_v_self), __pyx_v_time, __pyx_v_ket, __pyx_v_out);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_4apply(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, double __pyx_v_time, __Pyx_memviewslice __pyx_v_ket, PyObject *__pyx_v_out) {
-  PyObject *__pyx_v_do_return = NULL;
+  int __pyx_v_do_return;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
+  PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
-  PyObject *__pyx_t_6 = NULL;
-  int __pyx_t_7;
-  PyObject *__pyx_t_8 = NULL;
+  int __pyx_t_6;
+  PyObject *__pyx_t_7 = NULL;
+  int __pyx_t_8;
   int __pyx_t_9;
   PyObject *__pyx_t_10 = NULL;
   PyObject *__pyx_t_11 = NULL;
   PyObject *__pyx_t_12 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("apply", 0);
   __Pyx_INCREF(__pyx_v_out);
 
-  /* "tkwant/onebody/kernels.pyx":795
+  /* "tkwant/onebody/kernels.pyx":788
  *         '''
  * 
- *         do_return = out is None             # <<<<<<<<<<<<<<
- * 
- *         if self.dt > 0:
+ *         assert ket.shape[0] == self.size, _errormsg.format('Ket',             # <<<<<<<<<<<<<<
+ *                                                            ket.shape[0],
+ *                                                            self.size)
  */
-  __pyx_t_1 = (__pyx_v_out == Py_None);
-  __pyx_t_2 = __Pyx_PyBool_FromLong(__pyx_t_1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 795, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_v_do_return = __pyx_t_2;
-  __pyx_t_2 = 0;
+  #ifndef CYTHON_WITHOUT_ASSERTIONS
+  if (unlikely(!Py_OptimizeFlag)) {
+    if (unlikely(!(((__pyx_v_ket.shape[0]) == __pyx_v_self->size) != 0))) {
+      __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 788, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_format); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 788, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":797
- *         do_return = out is None
- * 
- *         if self.dt > 0:             # <<<<<<<<<<<<<<
+      /* "tkwant/onebody/kernels.pyx":789
  * 
- *             assert ket.shape[0] == self.size, _errormsg.format('Ket',
+ *         assert ket.shape[0] == self.size, _errormsg.format('Ket',
+ *                                                            ket.shape[0],             # <<<<<<<<<<<<<<
+ *                                                            self.size)
+ *         if out is None:
  */
-  __pyx_t_1 = ((__pyx_v_self->dt > 0.0) != 0);
-  if (__pyx_t_1) {
+      __pyx_t_2 = PyInt_FromSsize_t((__pyx_v_ket.shape[0])); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 789, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
 
-    /* "tkwant/onebody/kernels.pyx":799
- *         if self.dt > 0:
- * 
- *             assert ket.shape[0] == self.size, _errormsg.format('Ket',             # <<<<<<<<<<<<<<
- *                                                                ket.shape[0],
- *                                                                self.size)
+      /* "tkwant/onebody/kernels.pyx":790
+ *         assert ket.shape[0] == self.size, _errormsg.format('Ket',
+ *                                                            ket.shape[0],
+ *                                                            self.size)             # <<<<<<<<<<<<<<
+ *         if out is None:
+ *             do_return = True
  */
-    #ifndef CYTHON_WITHOUT_ASSERTIONS
-    if (unlikely(!Py_OptimizeFlag)) {
-      if (unlikely(!(((__pyx_v_ket.shape[0]) == __pyx_v_self->size) != 0))) {
-        __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 799, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_format); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 799, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __pyx_t_4 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 790, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_5 = NULL;
+      __pyx_t_6 = 0;
+      if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
+        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_3);
+        if (likely(__pyx_t_5)) {
+          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
+          __Pyx_INCREF(__pyx_t_5);
+          __Pyx_INCREF(function);
+          __Pyx_DECREF_SET(__pyx_t_3, function);
+          __pyx_t_6 = 1;
+        }
+      }
+      #if CYTHON_FAST_PYCALL
+      if (PyFunction_Check(__pyx_t_3)) {
+        PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_n_u_Ket, __pyx_t_2, __pyx_t_4};
+        __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 3+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 788, __pyx_L1_error)
+        __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+        __Pyx_GOTREF(__pyx_t_1);
+        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      } else
+      #endif
+      #if CYTHON_FAST_PYCCALL
+      if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
+        PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_n_u_Ket, __pyx_t_2, __pyx_t_4};
+        __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 3+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 788, __pyx_L1_error)
+        __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+        __Pyx_GOTREF(__pyx_t_1);
+        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      } else
+      #endif
+      {
+        __pyx_t_7 = PyTuple_New(3+__pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 788, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_7);
+        if (__pyx_t_5) {
+          __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_5); __pyx_t_5 = NULL;
+        }
+        __Pyx_INCREF(__pyx_n_u_Ket);
+        __Pyx_GIVEREF(__pyx_n_u_Ket);
+        PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_6, __pyx_n_u_Ket);
+        __Pyx_GIVEREF(__pyx_t_2);
+        PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_6, __pyx_t_2);
+        __Pyx_GIVEREF(__pyx_t_4);
+        PyTuple_SET_ITEM(__pyx_t_7, 2+__pyx_t_6, __pyx_t_4);
+        __pyx_t_2 = 0;
+        __pyx_t_4 = 0;
+        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 788, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_1);
+        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+      }
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":800
+      /* "tkwant/onebody/kernels.pyx":788
+ *         '''
  * 
- *             assert ket.shape[0] == self.size, _errormsg.format('Ket',
- *                                                                ket.shape[0],             # <<<<<<<<<<<<<<
- *                                                                self.size)
- *             if out is None:
+ *         assert ket.shape[0] == self.size, _errormsg.format('Ket',             # <<<<<<<<<<<<<<
+ *                                                            ket.shape[0],
+ *                                                            self.size)
  */
-        __pyx_t_3 = PyInt_FromSsize_t((__pyx_v_ket.shape[0])); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 800, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
+      __pyx_t_3 = PyTuple_Pack(1, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 788, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+      PyErr_SetObject(PyExc_AssertionError, __pyx_t_3);
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __PYX_ERR(0, 788, __pyx_L1_error)
+    }
+  }
+  #endif
 
-        /* "tkwant/onebody/kernels.pyx":801
- *             assert ket.shape[0] == self.size, _errormsg.format('Ket',
- *                                                                ket.shape[0],
- *                                                                self.size)             # <<<<<<<<<<<<<<
- *             if out is None:
- *                 out = np.zeros((self.size,), dtype=np.complex)
+  /* "tkwant/onebody/kernels.pyx":791
+ *                                                            ket.shape[0],
+ *                                                            self.size)
+ *         if out is None:             # <<<<<<<<<<<<<<
+ *             do_return = True
+ *             out = np.zeros((self.size,), dtype=complex)
  */
-        __pyx_t_5 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 801, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __pyx_t_6 = NULL;
-        __pyx_t_7 = 0;
-        if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
-          __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_4);
-          if (likely(__pyx_t_6)) {
-            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-            __Pyx_INCREF(__pyx_t_6);
-            __Pyx_INCREF(function);
-            __Pyx_DECREF_SET(__pyx_t_4, function);
-            __pyx_t_7 = 1;
-          }
-        }
-        #if CYTHON_FAST_PYCALL
-        if (PyFunction_Check(__pyx_t_4)) {
-          PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_n_u_Ket, __pyx_t_3, __pyx_t_5};
-          __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 799, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_2);
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-        } else
-        #endif
-        #if CYTHON_FAST_PYCCALL
-        if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
-          PyObject *__pyx_temp[4] = {__pyx_t_6, __pyx_n_u_Ket, __pyx_t_3, __pyx_t_5};
-          __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 799, __pyx_L1_error)
-          __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-          __Pyx_GOTREF(__pyx_t_2);
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-        } else
-        #endif
-        {
-          __pyx_t_8 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 799, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_8);
-          if (__pyx_t_6) {
-            __Pyx_GIVEREF(__pyx_t_6); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_6); __pyx_t_6 = NULL;
-          }
-          __Pyx_INCREF(__pyx_n_u_Ket);
-          __Pyx_GIVEREF(__pyx_n_u_Ket);
-          PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_7, __pyx_n_u_Ket);
-          __Pyx_GIVEREF(__pyx_t_3);
-          PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_7, __pyx_t_3);
-          __Pyx_GIVEREF(__pyx_t_5);
-          PyTuple_SET_ITEM(__pyx_t_8, 2+__pyx_t_7, __pyx_t_5);
-          __pyx_t_3 = 0;
-          __pyx_t_5 = 0;
-          __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_8, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 799, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_2);
-          __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-        }
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_8 = (__pyx_v_out == Py_None);
+  __pyx_t_9 = (__pyx_t_8 != 0);
+  if (__pyx_t_9) {
 
-        /* "tkwant/onebody/kernels.pyx":799
- *         if self.dt > 0:
- * 
- *             assert ket.shape[0] == self.size, _errormsg.format('Ket',             # <<<<<<<<<<<<<<
- *                                                                ket.shape[0],
- *                                                                self.size)
+    /* "tkwant/onebody/kernels.pyx":792
+ *                                                            self.size)
+ *         if out is None:
+ *             do_return = True             # <<<<<<<<<<<<<<
+ *             out = np.zeros((self.size,), dtype=complex)
+ *         else:
  */
-        __pyx_t_4 = PyTuple_Pack(1, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 799, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_4);
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-        PyErr_SetObject(PyExc_AssertionError, __pyx_t_4);
-        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        __PYX_ERR(0, 799, __pyx_L1_error)
-      }
-    }
-    #endif
+    __pyx_v_do_return = 1;
 
-    /* "tkwant/onebody/kernels.pyx":802
- *                                                                ket.shape[0],
- *                                                                self.size)
- *             if out is None:             # <<<<<<<<<<<<<<
- *                 out = np.zeros((self.size,), dtype=np.complex)
- *             else:
+    /* "tkwant/onebody/kernels.pyx":793
+ *         if out is None:
+ *             do_return = True
+ *             out = np.zeros((self.size,), dtype=complex)             # <<<<<<<<<<<<<<
+ *         else:
+ *             assert out.shape[0] == self.size, _errormsg.format('output',
  */
-    __pyx_t_1 = (__pyx_v_out == Py_None);
-    __pyx_t_9 = (__pyx_t_1 != 0);
-    if (__pyx_t_9) {
+    __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 793, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_zeros); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 793, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 793, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_7 = PyTuple_New(1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 793, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    __Pyx_GIVEREF(__pyx_t_3);
+    PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_3);
+    __pyx_t_3 = 0;
+    __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 793, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __Pyx_GIVEREF(__pyx_t_7);
+    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_7);
+    __pyx_t_7 = 0;
+    __pyx_t_7 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 793, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    if (PyDict_SetItem(__pyx_t_7, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 793, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, __pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 793, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_DECREF_SET(__pyx_v_out, __pyx_t_4);
+    __pyx_t_4 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":803
+    /* "tkwant/onebody/kernels.pyx":791
+ *                                                            ket.shape[0],
+ *                                                            self.size)
+ *         if out is None:             # <<<<<<<<<<<<<<
+ *             do_return = True
+ *             out = np.zeros((self.size,), dtype=complex)
+ */
+    goto __pyx_L3;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":795
+ *             out = np.zeros((self.size,), dtype=complex)
+ *         else:
+ *             assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
+ *                                                                out.shape[0],
  *                                                                self.size)
- *             if out is None:
- *                 out = np.zeros((self.size,), dtype=np.complex)             # <<<<<<<<<<<<<<
- *             else:
- *                 assert out.shape[0] == self.size, _errormsg.format('output',
  */
-      __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_np); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 803, __pyx_L1_error)
+  /*else*/ {
+    #ifndef CYTHON_WITHOUT_ASSERTIONS
+    if (unlikely(!Py_OptimizeFlag)) {
+      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 795, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
-      __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_zeros); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 803, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_7 = __Pyx_GetItemInt(__pyx_t_4, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 795, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_7);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __pyx_t_4 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 803, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 795, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
-      __pyx_t_8 = PyTuple_New(1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 803, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_8);
-      __Pyx_GIVEREF(__pyx_t_4);
-      PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_4);
-      __pyx_t_4 = 0;
-      __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 803, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __Pyx_GIVEREF(__pyx_t_8);
-      PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_8);
-      __pyx_t_8 = 0;
-      __pyx_t_8 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 803, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_8);
-      __Pyx_GetModuleGlobalName(__pyx_t_5, __pyx_n_s_np); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 803, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_5, __pyx_n_s_complex); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 803, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      if (PyDict_SetItem(__pyx_t_8, __pyx_n_s_dtype, __pyx_t_3) < 0) __PYX_ERR(0, 803, __pyx_L1_error)
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_4, __pyx_t_8); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 803, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_3 = PyObject_RichCompare(__pyx_t_7, __pyx_t_4, Py_EQ); __Pyx_XGOTREF(__pyx_t_3); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 795, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __Pyx_DECREF_SET(__pyx_v_out, __pyx_t_3);
-      __pyx_t_3 = 0;
+      __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_3); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 795, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+      if (unlikely(!__pyx_t_9)) {
+        __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 795, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_4);
+        __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_format); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 795, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_7);
+        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":802
- *                                                                ket.shape[0],
+        /* "tkwant/onebody/kernels.pyx":796
+ *         else:
+ *             assert out.shape[0] == self.size, _errormsg.format('output',
+ *                                                                out.shape[0],             # <<<<<<<<<<<<<<
  *                                                                self.size)
- *             if out is None:             # <<<<<<<<<<<<<<
- *                 out = np.zeros((self.size,), dtype=np.complex)
- *             else:
- */
-      goto __pyx_L4;
-    }
-
-    /* "tkwant/onebody/kernels.pyx":805
- *                 out = np.zeros((self.size,), dtype=np.complex)
- *             else:
- *                 assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
- *                                                                    out.shape[0],
- *                                                                    self.size)
+ * 
  */
-    /*else*/ {
-      #ifndef CYTHON_WITHOUT_ASSERTIONS
-      if (unlikely(!Py_OptimizeFlag)) {
-        __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 805, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_8 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 805, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 805, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __pyx_t_4 = PyObject_RichCompare(__pyx_t_8, __pyx_t_3, Py_EQ); __Pyx_XGOTREF(__pyx_t_4); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 805, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-        __pyx_t_9 = __Pyx_PyObject_IsTrue(__pyx_t_4); if (unlikely(__pyx_t_9 < 0)) __PYX_ERR(0, 805, __pyx_L1_error)
+        __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 796, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_4);
+        __pyx_t_1 = __Pyx_GetItemInt(__pyx_t_4, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 796, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_1);
         __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-        if (unlikely(!__pyx_t_9)) {
-          __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_errormsg); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 805, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_3);
-          __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_format); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 805, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_8);
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-          /* "tkwant/onebody/kernels.pyx":806
- *             else:
- *                 assert out.shape[0] == self.size, _errormsg.format('output',
- *                                                                    out.shape[0],             # <<<<<<<<<<<<<<
- *                                                                    self.size)
+        /* "tkwant/onebody/kernels.pyx":797
+ *             assert out.shape[0] == self.size, _errormsg.format('output',
+ *                                                                out.shape[0],
+ *                                                                self.size)             # <<<<<<<<<<<<<<
  * 
+ *         self.evaluate(time, self.wt)
  */
-          __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_out, __pyx_n_s_shape); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 806, __pyx_L1_error)
+        __pyx_t_4 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 797, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_4);
+        __pyx_t_2 = NULL;
+        __pyx_t_6 = 0;
+        if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_7))) {
+          __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_7);
+          if (likely(__pyx_t_2)) {
+            PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
+            __Pyx_INCREF(__pyx_t_2);
+            __Pyx_INCREF(function);
+            __Pyx_DECREF_SET(__pyx_t_7, function);
+            __pyx_t_6 = 1;
+          }
+        }
+        #if CYTHON_FAST_PYCALL
+        if (PyFunction_Check(__pyx_t_7)) {
+          PyObject *__pyx_temp[4] = {__pyx_t_2, __pyx_n_u_output, __pyx_t_1, __pyx_t_4};
+          __pyx_t_3 = __Pyx_PyFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_6, 3+__pyx_t_6); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 795, __pyx_L1_error)
+          __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
           __Pyx_GOTREF(__pyx_t_3);
-          __pyx_t_2 = __Pyx_GetItemInt(__pyx_t_3, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 806, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_2);
-          __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":807
- *                 assert out.shape[0] == self.size, _errormsg.format('output',
- *                                                                    out.shape[0],
- *                                                                    self.size)             # <<<<<<<<<<<<<<
- * 
- *             self.wt = self.evaluate(time)
- */
-          __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 807, __pyx_L1_error)
+          __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+          __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+        } else
+        #endif
+        #if CYTHON_FAST_PYCCALL
+        if (__Pyx_PyFastCFunction_Check(__pyx_t_7)) {
+          PyObject *__pyx_temp[4] = {__pyx_t_2, __pyx_n_u_output, __pyx_t_1, __pyx_t_4};
+          __pyx_t_3 = __Pyx_PyCFunction_FastCall(__pyx_t_7, __pyx_temp+1-__pyx_t_6, 3+__pyx_t_6); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 795, __pyx_L1_error)
+          __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
           __Pyx_GOTREF(__pyx_t_3);
-          __pyx_t_5 = NULL;
-          __pyx_t_7 = 0;
-          if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_8))) {
-            __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_8);
-            if (likely(__pyx_t_5)) {
-              PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
-              __Pyx_INCREF(__pyx_t_5);
-              __Pyx_INCREF(function);
-              __Pyx_DECREF_SET(__pyx_t_8, function);
-              __pyx_t_7 = 1;
-            }
-          }
-          #if CYTHON_FAST_PYCALL
-          if (PyFunction_Check(__pyx_t_8)) {
-            PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_n_u_output, __pyx_t_2, __pyx_t_3};
-            __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 805, __pyx_L1_error)
-            __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-            __Pyx_GOTREF(__pyx_t_4);
-            __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-            __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          } else
-          #endif
-          #if CYTHON_FAST_PYCCALL
-          if (__Pyx_PyFastCFunction_Check(__pyx_t_8)) {
-            PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_n_u_output, __pyx_t_2, __pyx_t_3};
-            __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 805, __pyx_L1_error)
-            __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-            __Pyx_GOTREF(__pyx_t_4);
-            __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-            __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-          } else
-          #endif
-          {
-            __pyx_t_6 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 805, __pyx_L1_error)
-            __Pyx_GOTREF(__pyx_t_6);
-            if (__pyx_t_5) {
-              __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_5); __pyx_t_5 = NULL;
-            }
-            __Pyx_INCREF(__pyx_n_u_output);
-            __Pyx_GIVEREF(__pyx_n_u_output);
-            PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_7, __pyx_n_u_output);
-            __Pyx_GIVEREF(__pyx_t_2);
-            PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_7, __pyx_t_2);
-            __Pyx_GIVEREF(__pyx_t_3);
-            PyTuple_SET_ITEM(__pyx_t_6, 2+__pyx_t_7, __pyx_t_3);
-            __pyx_t_2 = 0;
-            __pyx_t_3 = 0;
-            __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 805, __pyx_L1_error)
-            __Pyx_GOTREF(__pyx_t_4);
-            __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-          }
-          __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-
-          /* "tkwant/onebody/kernels.pyx":805
- *                 out = np.zeros((self.size,), dtype=np.complex)
- *             else:
- *                 assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
- *                                                                    out.shape[0],
- *                                                                    self.size)
- */
-          __pyx_t_8 = PyTuple_Pack(1, __pyx_t_4); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 805, __pyx_L1_error)
-          __Pyx_GOTREF(__pyx_t_8);
+          __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
           __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-          PyErr_SetObject(PyExc_AssertionError, __pyx_t_8);
-          __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-          __PYX_ERR(0, 805, __pyx_L1_error)
+        } else
+        #endif
+        {
+          __pyx_t_5 = PyTuple_New(3+__pyx_t_6); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 795, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_5);
+          if (__pyx_t_2) {
+            __Pyx_GIVEREF(__pyx_t_2); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2); __pyx_t_2 = NULL;
+          }
+          __Pyx_INCREF(__pyx_n_u_output);
+          __Pyx_GIVEREF(__pyx_n_u_output);
+          PyTuple_SET_ITEM(__pyx_t_5, 0+__pyx_t_6, __pyx_n_u_output);
+          __Pyx_GIVEREF(__pyx_t_1);
+          PyTuple_SET_ITEM(__pyx_t_5, 1+__pyx_t_6, __pyx_t_1);
+          __Pyx_GIVEREF(__pyx_t_4);
+          PyTuple_SET_ITEM(__pyx_t_5, 2+__pyx_t_6, __pyx_t_4);
+          __pyx_t_1 = 0;
+          __pyx_t_4 = 0;
+          __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_5, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 795, __pyx_L1_error)
+          __Pyx_GOTREF(__pyx_t_3);
+          __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
         }
-      }
-      #endif
-    }
-    __pyx_L4:;
-
-    /* "tkwant/onebody/kernels.pyx":809
- *                                                                    self.size)
- * 
- *             self.wt = self.evaluate(time)             # <<<<<<<<<<<<<<
- * 
- *             coo_matvec(
- */
-    __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_evaluate); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 809, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_6 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 809, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_3 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_3)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_3);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-      }
-    }
-    __pyx_t_8 = (__pyx_t_3) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_3, __pyx_t_6) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_6);
-    __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 809, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_8);
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_GIVEREF(__pyx_t_8);
-    __Pyx_GOTREF(__pyx_v_self->wt);
-    __Pyx_DECREF(__pyx_v_self->wt);
-    __pyx_v_self->wt = __pyx_t_8;
-    __pyx_t_8 = 0;
-
-    /* "tkwant/onebody/kernels.pyx":811
- *             self.wt = self.evaluate(time)
- * 
- *             coo_matvec(             # <<<<<<<<<<<<<<
- *                 self.wt.nnz, self.wt.row, self.wt.col, self.wt.data,
- *                 ket, out)
- */
-    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_coo_matvec); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 811, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-
-    /* "tkwant/onebody/kernels.pyx":812
- * 
- *             coo_matvec(
- *                 self.wt.nnz, self.wt.row, self.wt.col, self.wt.data,             # <<<<<<<<<<<<<<
- *                 ket, out)
- * 
- */
-    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_nnz); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 812, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_row); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 812, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_col); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 812, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_data); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 812, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_5);
+        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-    /* "tkwant/onebody/kernels.pyx":813
- *             coo_matvec(
- *                 self.wt.nnz, self.wt.row, self.wt.col, self.wt.data,
- *                 ket, out)             # <<<<<<<<<<<<<<
- * 
+        /* "tkwant/onebody/kernels.pyx":795
+ *             out = np.zeros((self.size,), dtype=complex)
  *         else:
+ *             assert out.shape[0] == self.size, _errormsg.format('output',             # <<<<<<<<<<<<<<
+ *                                                                out.shape[0],
+ *                                                                self.size)
  */
-    __pyx_t_10 = __pyx_memoryview_fromslice(__pyx_v_ket, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex__const__, (int (*)(char *, PyObject *)) NULL, 0);; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 813, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __pyx_t_11 = NULL;
-    __pyx_t_7 = 0;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
-      __pyx_t_11 = PyMethod_GET_SELF(__pyx_t_4);
-      if (likely(__pyx_t_11)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-        __Pyx_INCREF(__pyx_t_11);
-        __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_4, function);
-        __pyx_t_7 = 1;
+        __pyx_t_7 = PyTuple_Pack(1, __pyx_t_3); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 795, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_7);
+        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+        PyErr_SetObject(PyExc_AssertionError, __pyx_t_7);
+        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+        __PYX_ERR(0, 795, __pyx_L1_error)
       }
     }
-    #if CYTHON_FAST_PYCALL
-    if (PyFunction_Check(__pyx_t_4)) {
-      PyObject *__pyx_temp[7] = {__pyx_t_11, __pyx_t_6, __pyx_t_3, __pyx_t_2, __pyx_t_5, __pyx_t_10, __pyx_v_out};
-      __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 6+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 811, __pyx_L1_error)
-      __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
-      __Pyx_GOTREF(__pyx_t_8);
-      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    } else
     #endif
-    #if CYTHON_FAST_PYCCALL
-    if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
-      PyObject *__pyx_temp[7] = {__pyx_t_11, __pyx_t_6, __pyx_t_3, __pyx_t_2, __pyx_t_5, __pyx_t_10, __pyx_v_out};
-      __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 6+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 811, __pyx_L1_error)
-      __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
-      __Pyx_GOTREF(__pyx_t_8);
-      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    } else
-    #endif
-    {
-      __pyx_t_12 = PyTuple_New(6+__pyx_t_7); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 811, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_12);
-      if (__pyx_t_11) {
-        __Pyx_GIVEREF(__pyx_t_11); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_11); __pyx_t_11 = NULL;
-      }
-      __Pyx_GIVEREF(__pyx_t_6);
-      PyTuple_SET_ITEM(__pyx_t_12, 0+__pyx_t_7, __pyx_t_6);
-      __Pyx_GIVEREF(__pyx_t_3);
-      PyTuple_SET_ITEM(__pyx_t_12, 1+__pyx_t_7, __pyx_t_3);
-      __Pyx_GIVEREF(__pyx_t_2);
-      PyTuple_SET_ITEM(__pyx_t_12, 2+__pyx_t_7, __pyx_t_2);
-      __Pyx_GIVEREF(__pyx_t_5);
-      PyTuple_SET_ITEM(__pyx_t_12, 3+__pyx_t_7, __pyx_t_5);
-      __Pyx_GIVEREF(__pyx_t_10);
-      PyTuple_SET_ITEM(__pyx_t_12, 4+__pyx_t_7, __pyx_t_10);
-      __Pyx_INCREF(__pyx_v_out);
-      __Pyx_GIVEREF(__pyx_v_out);
-      PyTuple_SET_ITEM(__pyx_t_12, 5+__pyx_t_7, __pyx_v_out);
-      __pyx_t_6 = 0;
-      __pyx_t_3 = 0;
-      __pyx_t_2 = 0;
-      __pyx_t_5 = 0;
-      __pyx_t_10 = 0;
-      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_12, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 811, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_8);
-      __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
-    }
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+  }
+  __pyx_L3:;
 
-    /* "tkwant/onebody/kernels.pyx":797
- *         do_return = out is None
+  /* "tkwant/onebody/kernels.pyx":799
+ *                                                                self.size)
  * 
- *         if self.dt > 0:             # <<<<<<<<<<<<<<
+ *         self.evaluate(time, self.wt)             # <<<<<<<<<<<<<<
  * 
- *             assert ket.shape[0] == self.size, _errormsg.format('Ket',
+ *         coo_matvec(
  */
-    goto __pyx_L3;
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_evaluate); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 799, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 799, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_4 = NULL;
+  __pyx_t_6 = 0;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_4)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_4);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
+      __pyx_t_6 = 1;
+    }
   }
+  #if CYTHON_FAST_PYCALL
+  if (PyFunction_Check(__pyx_t_3)) {
+    PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_5, __pyx_v_self->wt};
+    __pyx_t_7 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 799, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_GOTREF(__pyx_t_7);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  } else
+  #endif
+  #if CYTHON_FAST_PYCCALL
+  if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
+    PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_t_5, __pyx_v_self->wt};
+    __pyx_t_7 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 799, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_GOTREF(__pyx_t_7);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  } else
+  #endif
+  {
+    __pyx_t_1 = PyTuple_New(2+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 799, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    if (__pyx_t_4) {
+      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_4); __pyx_t_4 = NULL;
+    }
+    __Pyx_GIVEREF(__pyx_t_5);
+    PyTuple_SET_ITEM(__pyx_t_1, 0+__pyx_t_6, __pyx_t_5);
+    __Pyx_INCREF(__pyx_v_self->wt);
+    __Pyx_GIVEREF(__pyx_v_self->wt);
+    PyTuple_SET_ITEM(__pyx_t_1, 1+__pyx_t_6, __pyx_v_self->wt);
+    __pyx_t_5 = 0;
+    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_1, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 799, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  }
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":816
+  /* "tkwant/onebody/kernels.pyx":801
+ *         self.evaluate(time, self.wt)
  * 
- *         else:
- *             if out is None:             # <<<<<<<<<<<<<<
- *                 do_return = True
- *                 out = self.wfunc.apply(time, ket)
- */
-  /*else*/ {
-    __pyx_t_9 = (__pyx_v_out == Py_None);
-    __pyx_t_1 = (__pyx_t_9 != 0);
-    if (__pyx_t_1) {
-
-      /* "tkwant/onebody/kernels.pyx":817
- *         else:
- *             if out is None:
- *                 do_return = True             # <<<<<<<<<<<<<<
- *                 out = self.wfunc.apply(time, ket)
- *             else:
+ *         coo_matvec(             # <<<<<<<<<<<<<<
+ *             self.wt.nnz, self.wt.row, self.wt.col, self.wt.data,
+ *             ket, out)
  */
-      __Pyx_INCREF(Py_True);
-      __Pyx_DECREF_SET(__pyx_v_do_return, Py_True);
-
-      /* "tkwant/onebody/kernels.pyx":818
- *             if out is None:
- *                 do_return = True
- *                 out = self.wfunc.apply(time, ket)             # <<<<<<<<<<<<<<
- *             else:
- *                 do_return = False
- */
-      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_apply); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 818, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __pyx_t_12 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 818, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_12);
-      __pyx_t_10 = __pyx_memoryview_fromslice(__pyx_v_ket, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex__const__, (int (*)(char *, PyObject *)) NULL, 0);; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 818, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_10);
-      __pyx_t_5 = NULL;
-      __pyx_t_7 = 0;
-      if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-        __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
-        if (likely(__pyx_t_5)) {
-          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-          __Pyx_INCREF(__pyx_t_5);
-          __Pyx_INCREF(function);
-          __Pyx_DECREF_SET(__pyx_t_4, function);
-          __pyx_t_7 = 1;
-        }
-      }
-      #if CYTHON_FAST_PYCALL
-      if (PyFunction_Check(__pyx_t_4)) {
-        PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_12, __pyx_t_10};
-        __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 818, __pyx_L1_error)
-        __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
-        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      } else
-      #endif
-      #if CYTHON_FAST_PYCCALL
-      if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
-        PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_12, __pyx_t_10};
-        __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 818, __pyx_L1_error)
-        __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
-        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      } else
-      #endif
-      {
-        __pyx_t_2 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 818, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_2);
-        if (__pyx_t_5) {
-          __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5); __pyx_t_5 = NULL;
-        }
-        __Pyx_GIVEREF(__pyx_t_12);
-        PyTuple_SET_ITEM(__pyx_t_2, 0+__pyx_t_7, __pyx_t_12);
-        __Pyx_GIVEREF(__pyx_t_10);
-        PyTuple_SET_ITEM(__pyx_t_2, 1+__pyx_t_7, __pyx_t_10);
-        __pyx_t_12 = 0;
-        __pyx_t_10 = 0;
-        __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_2, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 818, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      }
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF_SET(__pyx_v_out, __pyx_t_8);
-      __pyx_t_8 = 0;
+  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_coo_matvec); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 801, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
 
-      /* "tkwant/onebody/kernels.pyx":816
+  /* "tkwant/onebody/kernels.pyx":802
  * 
- *         else:
- *             if out is None:             # <<<<<<<<<<<<<<
- *                 do_return = True
- *                 out = self.wfunc.apply(time, ket)
- */
-      goto __pyx_L5;
-    }
-
-    /* "tkwant/onebody/kernels.pyx":820
- *                 out = self.wfunc.apply(time, ket)
- *             else:
- *                 do_return = False             # <<<<<<<<<<<<<<
- *                 self.wfunc.apply(time, ket, out)
+ *         coo_matvec(
+ *             self.wt.nnz, self.wt.row, self.wt.col, self.wt.data,             # <<<<<<<<<<<<<<
+ *             ket, out)
  * 
  */
-    /*else*/ {
-      __Pyx_INCREF(Py_False);
-      __Pyx_DECREF_SET(__pyx_v_do_return, Py_False);
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_nnz); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 802, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_row); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 802, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_col); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 802, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wt, __pyx_n_s_data); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 802, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
 
-      /* "tkwant/onebody/kernels.pyx":821
- *             else:
- *                 do_return = False
- *                 self.wfunc.apply(time, ket, out)             # <<<<<<<<<<<<<<
+  /* "tkwant/onebody/kernels.pyx":803
+ *         coo_matvec(
+ *             self.wt.nnz, self.wt.row, self.wt.col, self.wt.data,
+ *             ket, out)             # <<<<<<<<<<<<<<
  * 
  *         return out if do_return else None
  */
-      __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->wfunc, __pyx_n_s_apply); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 821, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_4);
-      __pyx_t_2 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 821, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_10 = __pyx_memoryview_fromslice(__pyx_v_ket, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex__const__, (int (*)(char *, PyObject *)) NULL, 0);; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 821, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_10);
-      __pyx_t_12 = NULL;
-      __pyx_t_7 = 0;
-      if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-        __pyx_t_12 = PyMethod_GET_SELF(__pyx_t_4);
-        if (likely(__pyx_t_12)) {
-          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-          __Pyx_INCREF(__pyx_t_12);
-          __Pyx_INCREF(function);
-          __Pyx_DECREF_SET(__pyx_t_4, function);
-          __pyx_t_7 = 1;
-        }
-      }
-      #if CYTHON_FAST_PYCALL
-      if (PyFunction_Check(__pyx_t_4)) {
-        PyObject *__pyx_temp[4] = {__pyx_t_12, __pyx_t_2, __pyx_t_10, __pyx_v_out};
-        __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 821, __pyx_L1_error)
-        __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      } else
-      #endif
-      #if CYTHON_FAST_PYCCALL
-      if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
-        PyObject *__pyx_temp[4] = {__pyx_t_12, __pyx_t_2, __pyx_t_10, __pyx_v_out};
-        __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_7, 3+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 821, __pyx_L1_error)
-        __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-        __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      } else
-      #endif
-      {
-        __pyx_t_5 = PyTuple_New(3+__pyx_t_7); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 821, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        if (__pyx_t_12) {
-          __Pyx_GIVEREF(__pyx_t_12); PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_12); __pyx_t_12 = NULL;
-        }
-        __Pyx_GIVEREF(__pyx_t_2);
-        PyTuple_SET_ITEM(__pyx_t_5, 0+__pyx_t_7, __pyx_t_2);
-        __Pyx_GIVEREF(__pyx_t_10);
-        PyTuple_SET_ITEM(__pyx_t_5, 1+__pyx_t_7, __pyx_t_10);
-        __Pyx_INCREF(__pyx_v_out);
-        __Pyx_GIVEREF(__pyx_v_out);
-        PyTuple_SET_ITEM(__pyx_t_5, 2+__pyx_t_7, __pyx_v_out);
-        __pyx_t_2 = 0;
-        __pyx_t_10 = 0;
-        __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_5, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 821, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_8);
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      }
-      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+  __pyx_t_10 = __pyx_memoryview_fromslice(__pyx_v_ket, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex__const__, (int (*)(char *, PyObject *)) NULL, 0);; if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 803, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_10);
+  __pyx_t_11 = NULL;
+  __pyx_t_6 = 0;
+  if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_11 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_11)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_11);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
+      __pyx_t_6 = 1;
     }
-    __pyx_L5:;
   }
-  __pyx_L3:;
+  #if CYTHON_FAST_PYCALL
+  if (PyFunction_Check(__pyx_t_3)) {
+    PyObject *__pyx_temp[7] = {__pyx_t_11, __pyx_t_1, __pyx_t_5, __pyx_t_4, __pyx_t_2, __pyx_t_10, __pyx_v_out};
+    __pyx_t_7 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 6+__pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 801, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
+    __Pyx_GOTREF(__pyx_t_7);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+  } else
+  #endif
+  #if CYTHON_FAST_PYCCALL
+  if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
+    PyObject *__pyx_temp[7] = {__pyx_t_11, __pyx_t_1, __pyx_t_5, __pyx_t_4, __pyx_t_2, __pyx_t_10, __pyx_v_out};
+    __pyx_t_7 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 6+__pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 801, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
+    __Pyx_GOTREF(__pyx_t_7);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+  } else
+  #endif
+  {
+    __pyx_t_12 = PyTuple_New(6+__pyx_t_6); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 801, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_12);
+    if (__pyx_t_11) {
+      __Pyx_GIVEREF(__pyx_t_11); PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_11); __pyx_t_11 = NULL;
+    }
+    __Pyx_GIVEREF(__pyx_t_1);
+    PyTuple_SET_ITEM(__pyx_t_12, 0+__pyx_t_6, __pyx_t_1);
+    __Pyx_GIVEREF(__pyx_t_5);
+    PyTuple_SET_ITEM(__pyx_t_12, 1+__pyx_t_6, __pyx_t_5);
+    __Pyx_GIVEREF(__pyx_t_4);
+    PyTuple_SET_ITEM(__pyx_t_12, 2+__pyx_t_6, __pyx_t_4);
+    __Pyx_GIVEREF(__pyx_t_2);
+    PyTuple_SET_ITEM(__pyx_t_12, 3+__pyx_t_6, __pyx_t_2);
+    __Pyx_GIVEREF(__pyx_t_10);
+    PyTuple_SET_ITEM(__pyx_t_12, 4+__pyx_t_6, __pyx_t_10);
+    __Pyx_INCREF(__pyx_v_out);
+    __Pyx_GIVEREF(__pyx_v_out);
+    PyTuple_SET_ITEM(__pyx_t_12, 5+__pyx_t_6, __pyx_v_out);
+    __pyx_t_1 = 0;
+    __pyx_t_5 = 0;
+    __pyx_t_4 = 0;
+    __pyx_t_2 = 0;
+    __pyx_t_10 = 0;
+    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_12, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 801, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
+  }
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":823
- *                 self.wfunc.apply(time, ket, out)
+  /* "tkwant/onebody/kernels.pyx":805
+ *             ket, out)
  * 
  *         return out if do_return else None             # <<<<<<<<<<<<<<
  * 
- * # Example Kernel implementation in C
+ * 
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_do_return); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(0, 823, __pyx_L1_error)
-  if (__pyx_t_1) {
+  if ((__pyx_v_do_return != 0)) {
     __Pyx_INCREF(__pyx_v_out);
-    __pyx_t_8 = __pyx_v_out;
+    __pyx_t_7 = __pyx_v_out;
   } else {
     __Pyx_INCREF(Py_None);
-    __pyx_t_8 = Py_None;
+    __pyx_t_7 = Py_None;
   }
-  __pyx_r = __pyx_t_8;
-  __pyx_t_8 = 0;
+  __pyx_r = __pyx_t_7;
+  __pyx_t_7 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/kernels.pyx":778
+  /* "tkwant/onebody/kernels.pyx":771
  *     @cython.boundscheck(False)
  *     @cython.wraparound(False)
  *     def apply(self, double time, const complex[:] ket, object out=None):             # <<<<<<<<<<<<<<
  *         '''Evaluate the matrix-vector product W(t) @ ket for the given time.
  * 
  */
 
   /* function exit code */
   __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_5);
-  __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_XDECREF(__pyx_t_7);
   __Pyx_XDECREF(__pyx_t_10);
   __Pyx_XDECREF(__pyx_t_11);
   __Pyx_XDECREF(__pyx_t_12);
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationInterpolator.apply", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
-  __Pyx_XDECREF(__pyx_v_do_return);
   __PYX_XDEC_MEMVIEW(&__pyx_v_ket, 1);
   __Pyx_XDECREF(__pyx_v_out);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
@@ -15361,416 +16014,235 @@
   int __pyx_v_use_setstate;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
-  PyObject *__pyx_t_5 = NULL;
-  PyObject *__pyx_t_6 = NULL;
-  PyObject *__pyx_t_7 = NULL;
-  PyObject *__pyx_t_8 = NULL;
-  PyObject *__pyx_t_9 = NULL;
-  PyObject *__pyx_t_10 = NULL;
-  PyObject *__pyx_t_11 = NULL;
-  PyObject *__pyx_t_12 = NULL;
-  PyObject *__pyx_t_13 = NULL;
-  int __pyx_t_14;
-  int __pyx_t_15;
-  int __pyx_t_16;
+  int __pyx_t_5;
+  int __pyx_t_6;
+  int __pyx_t_7;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__reduce_cython__", 0);
 
   /* "(tree fragment)":5
  *     cdef object _dict
  *     cdef bint use_setstate
- *     state = (self.Ht0, self.Ht1, self.Ht2, self.Ht3, self.Ht4, self._do_update, self.d2Ht0, self.d2Ht1, self.d2Ht2, self.d2y0, self.d2y1, self.dt, self.nnz, self.size, self.t0, self.t1, self.t2, self.t3, self.t4, self.time_name, self.time_start, self.tterms, self.wfunc, self.wt, self.x0, self.x1, self.y0, self.y1)             # <<<<<<<<<<<<<<
+ *     state = (self.dt, self.intfunc, self.nnz, self.size, self.wfunc, self.wt)             # <<<<<<<<<<<<<<
  *     _dict = getattr(self, '__dict__', None)
  *     if _dict is not None:
  */
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->_do_update); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __pyx_t_1 = PyFloat_FromDouble(__pyx_v_self->dt); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = PyFloat_FromDouble(__pyx_v_self->dt); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->nnz); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_4 = __Pyx_PyInt_From_unsigned_int(__pyx_v_self->size); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __pyx_t_4 = PyTuple_New(6); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 5, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_5 = PyFloat_FromDouble(__pyx_v_self->t0); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_6 = PyFloat_FromDouble(__pyx_v_self->t1); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_6);
-  __pyx_t_7 = PyFloat_FromDouble(__pyx_v_self->t2); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_7);
-  __pyx_t_8 = PyFloat_FromDouble(__pyx_v_self->t3); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_8);
-  __pyx_t_9 = PyFloat_FromDouble(__pyx_v_self->t4); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_9);
-  __pyx_t_10 = PyFloat_FromDouble(__pyx_v_self->time_start); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_10);
-  __pyx_t_11 = PyFloat_FromDouble(__pyx_v_self->x0); if (unlikely(!__pyx_t_11)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_11);
-  __pyx_t_12 = PyFloat_FromDouble(__pyx_v_self->x1); if (unlikely(!__pyx_t_12)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_12);
-  __pyx_t_13 = PyTuple_New(28); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 5, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_13);
-  __Pyx_INCREF(__pyx_v_self->Ht0);
-  __Pyx_GIVEREF(__pyx_v_self->Ht0);
-  PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_v_self->Ht0);
-  __Pyx_INCREF(__pyx_v_self->Ht1);
-  __Pyx_GIVEREF(__pyx_v_self->Ht1);
-  PyTuple_SET_ITEM(__pyx_t_13, 1, __pyx_v_self->Ht1);
-  __Pyx_INCREF(__pyx_v_self->Ht2);
-  __Pyx_GIVEREF(__pyx_v_self->Ht2);
-  PyTuple_SET_ITEM(__pyx_t_13, 2, __pyx_v_self->Ht2);
-  __Pyx_INCREF(__pyx_v_self->Ht3);
-  __Pyx_GIVEREF(__pyx_v_self->Ht3);
-  PyTuple_SET_ITEM(__pyx_t_13, 3, __pyx_v_self->Ht3);
-  __Pyx_INCREF(__pyx_v_self->Ht4);
-  __Pyx_GIVEREF(__pyx_v_self->Ht4);
-  PyTuple_SET_ITEM(__pyx_t_13, 4, __pyx_v_self->Ht4);
   __Pyx_GIVEREF(__pyx_t_1);
-  PyTuple_SET_ITEM(__pyx_t_13, 5, __pyx_t_1);
-  __Pyx_INCREF(__pyx_v_self->d2Ht0);
-  __Pyx_GIVEREF(__pyx_v_self->d2Ht0);
-  PyTuple_SET_ITEM(__pyx_t_13, 6, __pyx_v_self->d2Ht0);
-  __Pyx_INCREF(__pyx_v_self->d2Ht1);
-  __Pyx_GIVEREF(__pyx_v_self->d2Ht1);
-  PyTuple_SET_ITEM(__pyx_t_13, 7, __pyx_v_self->d2Ht1);
-  __Pyx_INCREF(__pyx_v_self->d2Ht2);
-  __Pyx_GIVEREF(__pyx_v_self->d2Ht2);
-  PyTuple_SET_ITEM(__pyx_t_13, 8, __pyx_v_self->d2Ht2);
-  __Pyx_INCREF(__pyx_v_self->d2y0);
-  __Pyx_GIVEREF(__pyx_v_self->d2y0);
-  PyTuple_SET_ITEM(__pyx_t_13, 9, __pyx_v_self->d2y0);
-  __Pyx_INCREF(__pyx_v_self->d2y1);
-  __Pyx_GIVEREF(__pyx_v_self->d2y1);
-  PyTuple_SET_ITEM(__pyx_t_13, 10, __pyx_v_self->d2y1);
+  PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
+  __Pyx_INCREF(__pyx_v_self->intfunc);
+  __Pyx_GIVEREF(__pyx_v_self->intfunc);
+  PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_v_self->intfunc);
   __Pyx_GIVEREF(__pyx_t_2);
-  PyTuple_SET_ITEM(__pyx_t_13, 11, __pyx_t_2);
+  PyTuple_SET_ITEM(__pyx_t_4, 2, __pyx_t_2);
   __Pyx_GIVEREF(__pyx_t_3);
-  PyTuple_SET_ITEM(__pyx_t_13, 12, __pyx_t_3);
-  __Pyx_GIVEREF(__pyx_t_4);
-  PyTuple_SET_ITEM(__pyx_t_13, 13, __pyx_t_4);
-  __Pyx_GIVEREF(__pyx_t_5);
-  PyTuple_SET_ITEM(__pyx_t_13, 14, __pyx_t_5);
-  __Pyx_GIVEREF(__pyx_t_6);
-  PyTuple_SET_ITEM(__pyx_t_13, 15, __pyx_t_6);
-  __Pyx_GIVEREF(__pyx_t_7);
-  PyTuple_SET_ITEM(__pyx_t_13, 16, __pyx_t_7);
-  __Pyx_GIVEREF(__pyx_t_8);
-  PyTuple_SET_ITEM(__pyx_t_13, 17, __pyx_t_8);
-  __Pyx_GIVEREF(__pyx_t_9);
-  PyTuple_SET_ITEM(__pyx_t_13, 18, __pyx_t_9);
-  __Pyx_INCREF(__pyx_v_self->time_name);
-  __Pyx_GIVEREF(__pyx_v_self->time_name);
-  PyTuple_SET_ITEM(__pyx_t_13, 19, __pyx_v_self->time_name);
-  __Pyx_GIVEREF(__pyx_t_10);
-  PyTuple_SET_ITEM(__pyx_t_13, 20, __pyx_t_10);
-  __Pyx_INCREF(__pyx_v_self->tterms);
-  __Pyx_GIVEREF(__pyx_v_self->tterms);
-  PyTuple_SET_ITEM(__pyx_t_13, 21, __pyx_v_self->tterms);
+  PyTuple_SET_ITEM(__pyx_t_4, 3, __pyx_t_3);
   __Pyx_INCREF(__pyx_v_self->wfunc);
   __Pyx_GIVEREF(__pyx_v_self->wfunc);
-  PyTuple_SET_ITEM(__pyx_t_13, 22, __pyx_v_self->wfunc);
+  PyTuple_SET_ITEM(__pyx_t_4, 4, __pyx_v_self->wfunc);
   __Pyx_INCREF(__pyx_v_self->wt);
   __Pyx_GIVEREF(__pyx_v_self->wt);
-  PyTuple_SET_ITEM(__pyx_t_13, 23, __pyx_v_self->wt);
-  __Pyx_GIVEREF(__pyx_t_11);
-  PyTuple_SET_ITEM(__pyx_t_13, 24, __pyx_t_11);
-  __Pyx_GIVEREF(__pyx_t_12);
-  PyTuple_SET_ITEM(__pyx_t_13, 25, __pyx_t_12);
-  __Pyx_INCREF(__pyx_v_self->y0);
-  __Pyx_GIVEREF(__pyx_v_self->y0);
-  PyTuple_SET_ITEM(__pyx_t_13, 26, __pyx_v_self->y0);
-  __Pyx_INCREF(__pyx_v_self->y1);
-  __Pyx_GIVEREF(__pyx_v_self->y1);
-  PyTuple_SET_ITEM(__pyx_t_13, 27, __pyx_v_self->y1);
+  PyTuple_SET_ITEM(__pyx_t_4, 5, __pyx_v_self->wt);
   __pyx_t_1 = 0;
   __pyx_t_2 = 0;
   __pyx_t_3 = 0;
+  __pyx_v_state = ((PyObject*)__pyx_t_4);
   __pyx_t_4 = 0;
-  __pyx_t_5 = 0;
-  __pyx_t_6 = 0;
-  __pyx_t_7 = 0;
-  __pyx_t_8 = 0;
-  __pyx_t_9 = 0;
-  __pyx_t_10 = 0;
-  __pyx_t_11 = 0;
-  __pyx_t_12 = 0;
-  __pyx_v_state = ((PyObject*)__pyx_t_13);
-  __pyx_t_13 = 0;
 
   /* "(tree fragment)":6
  *     cdef bint use_setstate
- *     state = (self.Ht0, self.Ht1, self.Ht2, self.Ht3, self.Ht4, self._do_update, self.d2Ht0, self.d2Ht1, self.d2Ht2, self.d2y0, self.d2y1, self.dt, self.nnz, self.size, self.t0, self.t1, self.t2, self.t3, self.t4, self.time_name, self.time_start, self.tterms, self.wfunc, self.wt, self.x0, self.x1, self.y0, self.y1)
+ *     state = (self.dt, self.intfunc, self.nnz, self.size, self.wfunc, self.wt)
  *     _dict = getattr(self, '__dict__', None)             # <<<<<<<<<<<<<<
  *     if _dict is not None:
  *         state += (_dict,)
  */
-  __pyx_t_13 = __Pyx_GetAttr3(((PyObject *)__pyx_v_self), __pyx_n_s_dict, Py_None); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 6, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_13);
-  __pyx_v__dict = __pyx_t_13;
-  __pyx_t_13 = 0;
+  __pyx_t_4 = __Pyx_GetAttr3(((PyObject *)__pyx_v_self), __pyx_n_s_dict, Py_None); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_v__dict = __pyx_t_4;
+  __pyx_t_4 = 0;
 
   /* "(tree fragment)":7
- *     state = (self.Ht0, self.Ht1, self.Ht2, self.Ht3, self.Ht4, self._do_update, self.d2Ht0, self.d2Ht1, self.d2Ht2, self.d2y0, self.d2y1, self.dt, self.nnz, self.size, self.t0, self.t1, self.t2, self.t3, self.t4, self.time_name, self.time_start, self.tterms, self.wfunc, self.wt, self.x0, self.x1, self.y0, self.y1)
+ *     state = (self.dt, self.intfunc, self.nnz, self.size, self.wfunc, self.wt)
  *     _dict = getattr(self, '__dict__', None)
  *     if _dict is not None:             # <<<<<<<<<<<<<<
  *         state += (_dict,)
  *         use_setstate = True
  */
-  __pyx_t_14 = (__pyx_v__dict != Py_None);
-  __pyx_t_15 = (__pyx_t_14 != 0);
-  if (__pyx_t_15) {
+  __pyx_t_5 = (__pyx_v__dict != Py_None);
+  __pyx_t_6 = (__pyx_t_5 != 0);
+  if (__pyx_t_6) {
 
     /* "(tree fragment)":8
  *     _dict = getattr(self, '__dict__', None)
  *     if _dict is not None:
  *         state += (_dict,)             # <<<<<<<<<<<<<<
  *         use_setstate = True
  *     else:
  */
-    __pyx_t_13 = PyTuple_New(1); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 8, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
+    __pyx_t_4 = PyTuple_New(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 8, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
     __Pyx_INCREF(__pyx_v__dict);
     __Pyx_GIVEREF(__pyx_v__dict);
-    PyTuple_SET_ITEM(__pyx_t_13, 0, __pyx_v__dict);
-    __pyx_t_12 = PyNumber_InPlaceAdd(__pyx_v_state, __pyx_t_13); if (unlikely(!__pyx_t_12)) __PYX_ERR(1, 8, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_12);
-    __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-    __Pyx_DECREF_SET(__pyx_v_state, ((PyObject*)__pyx_t_12));
-    __pyx_t_12 = 0;
+    PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_v__dict);
+    __pyx_t_3 = PyNumber_InPlaceAdd(__pyx_v_state, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 8, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __Pyx_DECREF_SET(__pyx_v_state, ((PyObject*)__pyx_t_3));
+    __pyx_t_3 = 0;
 
     /* "(tree fragment)":9
  *     if _dict is not None:
  *         state += (_dict,)
  *         use_setstate = True             # <<<<<<<<<<<<<<
  *     else:
- *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.d2y0 is not None or self.d2y1 is not None or self.time_name is not None or self.tterms is not None or self.wfunc is not None or self.wt is not None or self.y0 is not None or self.y1 is not None
+ *         use_setstate = self.intfunc is not None or self.wfunc is not None or self.wt is not None
  */
     __pyx_v_use_setstate = 1;
 
     /* "(tree fragment)":7
- *     state = (self.Ht0, self.Ht1, self.Ht2, self.Ht3, self.Ht4, self._do_update, self.d2Ht0, self.d2Ht1, self.d2Ht2, self.d2y0, self.d2y1, self.dt, self.nnz, self.size, self.t0, self.t1, self.t2, self.t3, self.t4, self.time_name, self.time_start, self.tterms, self.wfunc, self.wt, self.x0, self.x1, self.y0, self.y1)
+ *     state = (self.dt, self.intfunc, self.nnz, self.size, self.wfunc, self.wt)
  *     _dict = getattr(self, '__dict__', None)
  *     if _dict is not None:             # <<<<<<<<<<<<<<
  *         state += (_dict,)
  *         use_setstate = True
  */
     goto __pyx_L3;
   }
 
   /* "(tree fragment)":11
  *         use_setstate = True
  *     else:
- *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.d2y0 is not None or self.d2y1 is not None or self.time_name is not None or self.tterms is not None or self.wfunc is not None or self.wt is not None or self.y0 is not None or self.y1 is not None             # <<<<<<<<<<<<<<
+ *         use_setstate = self.intfunc is not None or self.wfunc is not None or self.wt is not None             # <<<<<<<<<<<<<<
  *     if use_setstate:
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, None), state
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, None), state
  */
   /*else*/ {
-    __pyx_t_14 = (__pyx_v_self->Ht0 != Py_None);
-    __pyx_t_16 = (__pyx_t_14 != 0);
-    if (!__pyx_t_16) {
-    } else {
-      __pyx_t_15 = __pyx_t_16;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_16 = (__pyx_v_self->Ht1 != Py_None);
-    __pyx_t_14 = (__pyx_t_16 != 0);
-    if (!__pyx_t_14) {
-    } else {
-      __pyx_t_15 = __pyx_t_14;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_14 = (__pyx_v_self->Ht2 != Py_None);
-    __pyx_t_16 = (__pyx_t_14 != 0);
-    if (!__pyx_t_16) {
-    } else {
-      __pyx_t_15 = __pyx_t_16;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_16 = (__pyx_v_self->Ht3 != Py_None);
-    __pyx_t_14 = (__pyx_t_16 != 0);
-    if (!__pyx_t_14) {
-    } else {
-      __pyx_t_15 = __pyx_t_14;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_14 = (__pyx_v_self->Ht4 != Py_None);
-    __pyx_t_16 = (__pyx_t_14 != 0);
-    if (!__pyx_t_16) {
-    } else {
-      __pyx_t_15 = __pyx_t_16;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_16 = (__pyx_v_self->d2Ht0 != Py_None);
-    __pyx_t_14 = (__pyx_t_16 != 0);
-    if (!__pyx_t_14) {
-    } else {
-      __pyx_t_15 = __pyx_t_14;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_14 = (__pyx_v_self->d2Ht1 != Py_None);
-    __pyx_t_16 = (__pyx_t_14 != 0);
-    if (!__pyx_t_16) {
-    } else {
-      __pyx_t_15 = __pyx_t_16;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_16 = (__pyx_v_self->d2Ht2 != Py_None);
-    __pyx_t_14 = (__pyx_t_16 != 0);
-    if (!__pyx_t_14) {
-    } else {
-      __pyx_t_15 = __pyx_t_14;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_14 = (__pyx_v_self->d2y0 != Py_None);
-    __pyx_t_16 = (__pyx_t_14 != 0);
-    if (!__pyx_t_16) {
-    } else {
-      __pyx_t_15 = __pyx_t_16;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_16 = (__pyx_v_self->d2y1 != Py_None);
-    __pyx_t_14 = (__pyx_t_16 != 0);
-    if (!__pyx_t_14) {
-    } else {
-      __pyx_t_15 = __pyx_t_14;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_14 = (__pyx_v_self->time_name != Py_None);
-    __pyx_t_16 = (__pyx_t_14 != 0);
-    if (!__pyx_t_16) {
-    } else {
-      __pyx_t_15 = __pyx_t_16;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_16 = (__pyx_v_self->tterms != Py_None);
-    __pyx_t_14 = (__pyx_t_16 != 0);
-    if (!__pyx_t_14) {
-    } else {
-      __pyx_t_15 = __pyx_t_14;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_14 = (__pyx_v_self->wfunc != Py_None);
-    __pyx_t_16 = (__pyx_t_14 != 0);
-    if (!__pyx_t_16) {
-    } else {
-      __pyx_t_15 = __pyx_t_16;
-      goto __pyx_L4_bool_binop_done;
-    }
-    __pyx_t_16 = (__pyx_v_self->wt != Py_None);
-    __pyx_t_14 = (__pyx_t_16 != 0);
-    if (!__pyx_t_14) {
+    __pyx_t_5 = (__pyx_v_self->intfunc != Py_None);
+    __pyx_t_7 = (__pyx_t_5 != 0);
+    if (!__pyx_t_7) {
     } else {
-      __pyx_t_15 = __pyx_t_14;
+      __pyx_t_6 = __pyx_t_7;
       goto __pyx_L4_bool_binop_done;
     }
-    __pyx_t_14 = (__pyx_v_self->y0 != Py_None);
-    __pyx_t_16 = (__pyx_t_14 != 0);
-    if (!__pyx_t_16) {
+    __pyx_t_7 = (__pyx_v_self->wfunc != Py_None);
+    __pyx_t_5 = (__pyx_t_7 != 0);
+    if (!__pyx_t_5) {
     } else {
-      __pyx_t_15 = __pyx_t_16;
+      __pyx_t_6 = __pyx_t_5;
       goto __pyx_L4_bool_binop_done;
     }
-    __pyx_t_16 = (__pyx_v_self->y1 != Py_None);
-    __pyx_t_14 = (__pyx_t_16 != 0);
-    __pyx_t_15 = __pyx_t_14;
+    __pyx_t_5 = (__pyx_v_self->wt != Py_None);
+    __pyx_t_7 = (__pyx_t_5 != 0);
+    __pyx_t_6 = __pyx_t_7;
     __pyx_L4_bool_binop_done:;
-    __pyx_v_use_setstate = __pyx_t_15;
+    __pyx_v_use_setstate = __pyx_t_6;
   }
   __pyx_L3:;
 
   /* "(tree fragment)":12
  *     else:
- *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.d2y0 is not None or self.d2y1 is not None or self.time_name is not None or self.tterms is not None or self.wfunc is not None or self.wt is not None or self.y0 is not None or self.y1 is not None
+ *         use_setstate = self.intfunc is not None or self.wfunc is not None or self.wt is not None
  *     if use_setstate:             # <<<<<<<<<<<<<<
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, None), state
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, None), state
  *     else:
  */
-  __pyx_t_15 = (__pyx_v_use_setstate != 0);
-  if (__pyx_t_15) {
+  __pyx_t_6 = (__pyx_v_use_setstate != 0);
+  if (__pyx_t_6) {
 
     /* "(tree fragment)":13
- *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.d2y0 is not None or self.d2y1 is not None or self.time_name is not None or self.tterms is not None or self.wfunc is not None or self.wt is not None or self.y0 is not None or self.y1 is not None
+ *         use_setstate = self.intfunc is not None or self.wfunc is not None or self.wt is not None
  *     if use_setstate:
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, None), state             # <<<<<<<<<<<<<<
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, None), state             # <<<<<<<<<<<<<<
  *     else:
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, state)
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, state)
  */
     __Pyx_XDECREF(__pyx_r);
-    __Pyx_GetModuleGlobalName(__pyx_t_12, __pyx_n_s_pyx_unpickle_PerturbationInter); if (unlikely(!__pyx_t_12)) __PYX_ERR(1, 13, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_12);
-    __pyx_t_13 = PyTuple_New(3); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 13, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
+    __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_pyx_unpickle_PerturbationInter); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 13, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_4 = PyTuple_New(3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 13, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
     __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
     __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    PyTuple_SET_ITEM(__pyx_t_13, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    __Pyx_INCREF(__pyx_int_27919597);
-    __Pyx_GIVEREF(__pyx_int_27919597);
-    PyTuple_SET_ITEM(__pyx_t_13, 1, __pyx_int_27919597);
+    PyTuple_SET_ITEM(__pyx_t_4, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_INCREF(__pyx_int_47058919);
+    __Pyx_GIVEREF(__pyx_int_47058919);
+    PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_int_47058919);
     __Pyx_INCREF(Py_None);
     __Pyx_GIVEREF(Py_None);
-    PyTuple_SET_ITEM(__pyx_t_13, 2, Py_None);
-    __pyx_t_11 = PyTuple_New(3); if (unlikely(!__pyx_t_11)) __PYX_ERR(1, 13, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_11);
-    __Pyx_GIVEREF(__pyx_t_12);
-    PyTuple_SET_ITEM(__pyx_t_11, 0, __pyx_t_12);
-    __Pyx_GIVEREF(__pyx_t_13);
-    PyTuple_SET_ITEM(__pyx_t_11, 1, __pyx_t_13);
+    PyTuple_SET_ITEM(__pyx_t_4, 2, Py_None);
+    __pyx_t_2 = PyTuple_New(3); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 13, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_GIVEREF(__pyx_t_3);
+    PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_3);
+    __Pyx_GIVEREF(__pyx_t_4);
+    PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_t_4);
     __Pyx_INCREF(__pyx_v_state);
     __Pyx_GIVEREF(__pyx_v_state);
-    PyTuple_SET_ITEM(__pyx_t_11, 2, __pyx_v_state);
-    __pyx_t_12 = 0;
-    __pyx_t_13 = 0;
-    __pyx_r = __pyx_t_11;
-    __pyx_t_11 = 0;
+    PyTuple_SET_ITEM(__pyx_t_2, 2, __pyx_v_state);
+    __pyx_t_3 = 0;
+    __pyx_t_4 = 0;
+    __pyx_r = __pyx_t_2;
+    __pyx_t_2 = 0;
     goto __pyx_L0;
 
     /* "(tree fragment)":12
  *     else:
- *         use_setstate = self.Ht0 is not None or self.Ht1 is not None or self.Ht2 is not None or self.Ht3 is not None or self.Ht4 is not None or self.d2Ht0 is not None or self.d2Ht1 is not None or self.d2Ht2 is not None or self.d2y0 is not None or self.d2y1 is not None or self.time_name is not None or self.tterms is not None or self.wfunc is not None or self.wt is not None or self.y0 is not None or self.y1 is not None
+ *         use_setstate = self.intfunc is not None or self.wfunc is not None or self.wt is not None
  *     if use_setstate:             # <<<<<<<<<<<<<<
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, None), state
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, None), state
  *     else:
  */
   }
 
   /* "(tree fragment)":15
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, None), state
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, None), state
  *     else:
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, state)             # <<<<<<<<<<<<<<
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, state)             # <<<<<<<<<<<<<<
  * def __setstate_cython__(self, __pyx_state):
  *     __pyx_unpickle_PerturbationInterpolator__set_state(self, __pyx_state)
  */
   /*else*/ {
     __Pyx_XDECREF(__pyx_r);
-    __Pyx_GetModuleGlobalName(__pyx_t_11, __pyx_n_s_pyx_unpickle_PerturbationInter); if (unlikely(!__pyx_t_11)) __PYX_ERR(1, 15, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_11);
-    __pyx_t_13 = PyTuple_New(3); if (unlikely(!__pyx_t_13)) __PYX_ERR(1, 15, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_13);
+    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_pyx_unpickle_PerturbationInter); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 15, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_4 = PyTuple_New(3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 15, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
     __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
     __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    PyTuple_SET_ITEM(__pyx_t_13, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
-    __Pyx_INCREF(__pyx_int_27919597);
-    __Pyx_GIVEREF(__pyx_int_27919597);
-    PyTuple_SET_ITEM(__pyx_t_13, 1, __pyx_int_27919597);
+    PyTuple_SET_ITEM(__pyx_t_4, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_INCREF(__pyx_int_47058919);
+    __Pyx_GIVEREF(__pyx_int_47058919);
+    PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_int_47058919);
     __Pyx_INCREF(__pyx_v_state);
     __Pyx_GIVEREF(__pyx_v_state);
-    PyTuple_SET_ITEM(__pyx_t_13, 2, __pyx_v_state);
-    __pyx_t_12 = PyTuple_New(2); if (unlikely(!__pyx_t_12)) __PYX_ERR(1, 15, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_12);
-    __Pyx_GIVEREF(__pyx_t_11);
-    PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_11);
-    __Pyx_GIVEREF(__pyx_t_13);
-    PyTuple_SET_ITEM(__pyx_t_12, 1, __pyx_t_13);
-    __pyx_t_11 = 0;
-    __pyx_t_13 = 0;
-    __pyx_r = __pyx_t_12;
-    __pyx_t_12 = 0;
+    PyTuple_SET_ITEM(__pyx_t_4, 2, __pyx_v_state);
+    __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 15, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __Pyx_GIVEREF(__pyx_t_2);
+    PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_2);
+    __Pyx_GIVEREF(__pyx_t_4);
+    PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_4);
+    __pyx_t_2 = 0;
+    __pyx_t_4 = 0;
+    __pyx_r = __pyx_t_3;
+    __pyx_t_3 = 0;
     goto __pyx_L0;
   }
 
   /* "(tree fragment)":1
  * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
  *     cdef tuple state
  *     cdef object _dict
@@ -15778,36 +16250,27 @@
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_4);
-  __Pyx_XDECREF(__pyx_t_5);
-  __Pyx_XDECREF(__pyx_t_6);
-  __Pyx_XDECREF(__pyx_t_7);
-  __Pyx_XDECREF(__pyx_t_8);
-  __Pyx_XDECREF(__pyx_t_9);
-  __Pyx_XDECREF(__pyx_t_10);
-  __Pyx_XDECREF(__pyx_t_11);
-  __Pyx_XDECREF(__pyx_t_12);
-  __Pyx_XDECREF(__pyx_t_13);
   __Pyx_AddTraceback("tkwant.onebody.kernels.PerturbationInterpolator.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v_state);
   __Pyx_XDECREF(__pyx_v__dict);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 /* "(tree fragment)":16
  *     else:
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, state)
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_PerturbationInterpolator__set_state(self, __pyx_state)
  */
 
 /* Python wrapper */
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_24PerturbationInterpolator_9__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
 static char __pyx_doc_6tkwant_7onebody_7kernels_24PerturbationInterpolator_8__setstate_cython__[] = "PerturbationInterpolator.__setstate_cython__(self, __pyx_state)";
@@ -15822,29 +16285,32 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_24PerturbationInterpolator_8__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setstate_cython__", 0);
 
   /* "(tree fragment)":17
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, state)
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, state)
  * def __setstate_cython__(self, __pyx_state):
  *     __pyx_unpickle_PerturbationInterpolator__set_state(self, __pyx_state)             # <<<<<<<<<<<<<<
  */
-  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
+  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
   __pyx_t_1 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_PerturbationInterpolator__set_state(__pyx_v_self, ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 17, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
   /* "(tree fragment)":16
  *     else:
- *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x1aa04ed, state)
+ *         return __pyx_unpickle_PerturbationInterpolator, (type(self), 0x2ce0fe7, state)
  * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_unpickle_PerturbationInterpolator__set_state(self, __pyx_state)
  */
 
   /* function exit code */
   __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
@@ -15854,1772 +16320,2490 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":832
- *     cdef int[:] indices, indptr
+/* "tkwant/onebody/kernels.pyx":813
+ * @cython.wraparound(False)
+ * @cython.initializedcheck(False)
+ * cdef _csr_spmv_ptr(const int size, const int *indptr, const int *indices,             # <<<<<<<<<<<<<<
+ *                    const complex *data,  const complex *X, complex *Y):
+ *     """Naive implementation of CSR-format matrix-vector multiplication.
+ */
+
+static PyObject *__pyx_f_6tkwant_7onebody_7kernels__csr_spmv_ptr(int const __pyx_v_size, int const *__pyx_v_indptr, int const *__pyx_v_indices, __pyx_t_double_complex const *__pyx_v_data, __pyx_t_double_complex const *__pyx_v_X, __pyx_t_double_complex *__pyx_v_Y) {
+  __pyx_t_double_complex __pyx_v_sum;
+  unsigned int __pyx_v_i;
+  unsigned int __pyx_v_jj;
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  int __pyx_t_1;
+  int __pyx_t_2;
+  unsigned int __pyx_t_3;
+  int __pyx_t_4;
+  int __pyx_t_5;
+  unsigned int __pyx_t_6;
+  __Pyx_RefNannySetupContext("_csr_spmv_ptr", 0);
+
+  /* "tkwant/onebody/kernels.pyx":822
+ *     cdef unsigned i, jj
+ * 
+ *     for i in range(size):             # <<<<<<<<<<<<<<
+ *        sum = Y[i]
+ *        for jj in range(indptr[i], indptr[i+1]):
+ */
+  __pyx_t_1 = __pyx_v_size;
+  __pyx_t_2 = __pyx_t_1;
+  for (__pyx_t_3 = 0; __pyx_t_3 < __pyx_t_2; __pyx_t_3+=1) {
+    __pyx_v_i = __pyx_t_3;
+
+    /* "tkwant/onebody/kernels.pyx":823
+ * 
+ *     for i in range(size):
+ *        sum = Y[i]             # <<<<<<<<<<<<<<
+ *        for jj in range(indptr[i], indptr[i+1]):
+ *            sum += data[jj] * X[indices[jj]]
+ */
+    __pyx_v_sum = (__pyx_v_Y[__pyx_v_i]);
+
+    /* "tkwant/onebody/kernels.pyx":824
+ *     for i in range(size):
+ *        sum = Y[i]
+ *        for jj in range(indptr[i], indptr[i+1]):             # <<<<<<<<<<<<<<
+ *            sum += data[jj] * X[indices[jj]]
+ *        Y[i] = sum
+ */
+    __pyx_t_4 = (__pyx_v_indptr[(__pyx_v_i + 1)]);
+    __pyx_t_5 = __pyx_t_4;
+    for (__pyx_t_6 = (__pyx_v_indptr[__pyx_v_i]); __pyx_t_6 < __pyx_t_5; __pyx_t_6+=1) {
+      __pyx_v_jj = __pyx_t_6;
+
+      /* "tkwant/onebody/kernels.pyx":825
+ *        sum = Y[i]
+ *        for jj in range(indptr[i], indptr[i+1]):
+ *            sum += data[jj] * X[indices[jj]]             # <<<<<<<<<<<<<<
+ *        Y[i] = sum
+ * 
+ */
+      __pyx_v_sum = __Pyx_c_sum_double(__pyx_v_sum, __Pyx_c_prod_double((__pyx_v_data[__pyx_v_jj]), (__pyx_v_X[(__pyx_v_indices[__pyx_v_jj])])));
+    }
+
+    /* "tkwant/onebody/kernels.pyx":826
+ *        for jj in range(indptr[i], indptr[i+1]):
+ *            sum += data[jj] * X[indices[jj]]
+ *        Y[i] = sum             # <<<<<<<<<<<<<<
+ * 
+ * 
+ */
+    (__pyx_v_Y[__pyx_v_i]) = __pyx_v_sum;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":813
+ * @cython.wraparound(False)
+ * @cython.initializedcheck(False)
+ * cdef _csr_spmv_ptr(const int size, const int *indptr, const int *indices,             # <<<<<<<<<<<<<<
+ *                    const complex *data,  const complex *X, complex *Y):
+ *     """Naive implementation of CSR-format matrix-vector multiplication.
+ */
+
+  /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "tkwant/onebody/kernels.pyx":840
+ *         object _temp
+ * 
+ *     def __init__(self, H0, W, complex[:] psi_st=None, work=None):             # <<<<<<<<<<<<<<
+ *         pass
  * 
- *     def __cinit__(self, mat):             # <<<<<<<<<<<<<<
- *         mat = mat.tocsr()
- *         self.nrows, self.ncols = mat.shape
  */
 
 /* Python wrapper */
-static int __pyx_pw_6tkwant_7onebody_7kernels_10_CSRMatrix_1__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static int __pyx_pw_6tkwant_7onebody_7kernels_10_CSRMatrix_1__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  PyObject *__pyx_v_mat = 0;
+static int __pyx_pw_6tkwant_7onebody_7kernels_6Simple_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static int __pyx_pw_6tkwant_7onebody_7kernels_6Simple_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  CYTHON_UNUSED PyObject *__pyx_v_H0 = 0;
+  CYTHON_UNUSED PyObject *__pyx_v_W = 0;
+  CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st = { 0, 0, { 0 }, { 0 }, { 0 } };
+  CYTHON_UNUSED PyObject *__pyx_v_work = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
+  {
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_H0,&__pyx_n_s_W,&__pyx_n_s_psi_st,&__pyx_n_s_work,0};
+    PyObject* values[4] = {0,0,0,0};
+    values[3] = ((PyObject *)Py_None);
+    if (unlikely(__pyx_kwds)) {
+      Py_ssize_t kw_args;
+      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
+      switch (pos_args) {
+        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+        CYTHON_FALLTHROUGH;
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = PyDict_Size(__pyx_kwds);
+      switch (pos_args) {
+        case  0:
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_H0)) != 0)) kw_args--;
+        else goto __pyx_L5_argtuple_error;
+        CYTHON_FALLTHROUGH;
+        case  1:
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 4, 1); __PYX_ERR(0, 840, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  2:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st);
+          if (value) { values[2] = value; kw_args--; }
+        }
+        CYTHON_FALLTHROUGH;
+        case  3:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_work);
+          if (value) { values[3] = value; kw_args--; }
+        }
+      }
+      if (unlikely(kw_args > 0)) {
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 840, __pyx_L3_error)
+      }
+    } else {
+      switch (PyTuple_GET_SIZE(__pyx_args)) {
+        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+        CYTHON_FALLTHROUGH;
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+    }
+    __pyx_v_H0 = values[0];
+    __pyx_v_W = values[1];
+    if (values[2]) {
+      __pyx_v_psi_st = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[2], PyBUF_WRITABLE); if (unlikely(!__pyx_v_psi_st.memview)) __PYX_ERR(0, 840, __pyx_L3_error)
+    } else {
+      __pyx_v_psi_st = __pyx_k__4;
+      __PYX_INC_MEMVIEW(&__pyx_v_psi_st, 1);
+    }
+    __pyx_v_work = values[3];
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 840, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return -1;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self), __pyx_v_H0, __pyx_v_W, __pyx_v_psi_st, __pyx_v_work);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static int __pyx_pf_6tkwant_7onebody_7kernels_6Simple___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_H0, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st, CYTHON_UNUSED PyObject *__pyx_v_work) {
+  int __pyx_r;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__init__", 0);
+
+  /* function exit code */
+  __pyx_r = 0;
+  __PYX_XDEC_MEMVIEW(&__pyx_v_psi_st, 1);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "tkwant/onebody/kernels.pyx":843
+ *         pass
+ * 
+ *     def __cinit__(self, H0, W, complex[:] psi_st=None, work=None):             # <<<<<<<<<<<<<<
+ * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):
+ */
+
+/* Python wrapper */
+static int __pyx_pw_6tkwant_7onebody_7kernels_6Simple_3__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static int __pyx_pw_6tkwant_7onebody_7kernels_6Simple_3__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  PyObject *__pyx_v_H0 = 0;
+  PyObject *__pyx_v_W = 0;
+  __Pyx_memviewslice __pyx_v_psi_st = { 0, 0, { 0 }, { 0 }, { 0 } };
+  PyObject *__pyx_v_work = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__cinit__ (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_mat,0};
-    PyObject* values[1] = {0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_H0,&__pyx_n_s_W,&__pyx_n_s_psi_st,&__pyx_n_s_work,0};
+    PyObject* values[4] = {0,0,0,0};
+    values[3] = ((PyObject *)Py_None);
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
+        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+        CYTHON_FALLTHROUGH;
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_mat)) != 0)) kw_args--;
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_H0)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
+        CYTHON_FALLTHROUGH;
+        case  1:
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 2, 4, 1); __PYX_ERR(0, 843, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  2:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st);
+          if (value) { values[2] = value; kw_args--; }
+        }
+        CYTHON_FALLTHROUGH;
+        case  3:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_work);
+          if (value) { values[3] = value; kw_args--; }
+        }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__cinit__") < 0)) __PYX_ERR(0, 832, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__cinit__") < 0)) __PYX_ERR(0, 843, __pyx_L3_error)
       }
-    } else if (PyTuple_GET_SIZE(__pyx_args) != 1) {
-      goto __pyx_L5_argtuple_error;
     } else {
-      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      switch (PyTuple_GET_SIZE(__pyx_args)) {
+        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+        CYTHON_FALLTHROUGH;
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+    }
+    __pyx_v_H0 = values[0];
+    __pyx_v_W = values[1];
+    if (values[2]) {
+      __pyx_v_psi_st = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[2], PyBUF_WRITABLE); if (unlikely(!__pyx_v_psi_st.memview)) __PYX_ERR(0, 843, __pyx_L3_error)
+    } else {
+      __pyx_v_psi_st = __pyx_k__5;
+      __PYX_INC_MEMVIEW(&__pyx_v_psi_st, 1);
     }
-    __pyx_v_mat = values[0];
+    __pyx_v_work = values[3];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 1, 1, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 832, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 2, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 843, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels._CSRMatrix.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_10_CSRMatrix___cinit__(((struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *)__pyx_v_self), __pyx_v_mat);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_2__cinit__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self), __pyx_v_H0, __pyx_v_W, __pyx_v_psi_st, __pyx_v_work);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static int __pyx_pf_6tkwant_7onebody_7kernels_10_CSRMatrix___cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *__pyx_v_self, PyObject *__pyx_v_mat) {
+static int __pyx_pf_6tkwant_7onebody_7kernels_6Simple_2__cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, __Pyx_memviewslice __pyx_v_psi_st, PyObject *__pyx_v_work) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
-  PyObject *__pyx_t_4 = NULL;
-  PyObject *(*__pyx_t_5)(PyObject *);
+  int __pyx_t_3;
+  int __pyx_t_4;
+  PyObject *__pyx_t_5 = NULL;
   int __pyx_t_6;
-  int __pyx_t_7;
-  __Pyx_memviewslice __pyx_t_8 = { 0, 0, { 0 }, { 0 }, { 0 } };
-  __Pyx_memviewslice __pyx_t_9 = { 0, 0, { 0 }, { 0 }, { 0 } };
-  __Pyx_memviewslice __pyx_t_10 = { 0, 0, { 0 }, { 0 }, { 0 } };
+  PyObject *__pyx_t_7 = NULL;
+  PyObject *__pyx_t_8 = NULL;
+  PyObject *__pyx_t_9 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__cinit__", 0);
-  __Pyx_INCREF(__pyx_v_mat);
 
-  /* "tkwant/onebody/kernels.pyx":833
+  /* "tkwant/onebody/kernels.pyx":845
+ *     def __cinit__(self, H0, W, complex[:] psi_st=None, work=None):
  * 
- *     def __cinit__(self, mat):
- *         mat = mat.tocsr()             # <<<<<<<<<<<<<<
- *         self.nrows, self.ncols = mat.shape
- *         self.data = mat.data
+ *         if not isinstance(H0, sp.csr.csr_matrix):             # <<<<<<<<<<<<<<
+ *             self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case
+ *         else:
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_mat, __pyx_n_s_tocsr); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 833, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_sp); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 845, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_csr); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 845, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = NULL;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
-    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_2);
-    if (likely(__pyx_t_3)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-      __Pyx_INCREF(__pyx_t_3);
-      __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_2, function);
-    }
-  }
-  __pyx_t_1 = (__pyx_t_3) ? __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_3) : __Pyx_PyObject_CallNoArg(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 833, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_csr_matrix); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 845, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __Pyx_DECREF_SET(__pyx_v_mat, __pyx_t_1);
-  __pyx_t_1 = 0;
+  __pyx_t_3 = PyObject_IsInstance(__pyx_v_H0, __pyx_t_1); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(0, 845, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_4 = ((!(__pyx_t_3 != 0)) != 0);
+  if (__pyx_t_4) {
 
-  /* "tkwant/onebody/kernels.pyx":834
- *     def __cinit__(self, mat):
- *         mat = mat.tocsr()
- *         self.nrows, self.ncols = mat.shape             # <<<<<<<<<<<<<<
- *         self.data = mat.data
- *         self.indices, self.indptr = mat.indices, mat.indptr
+    /* "tkwant/onebody/kernels.pyx":846
+ * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):
+ *             self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case             # <<<<<<<<<<<<<<
+ *         else:
+ *             self.H0 = H0
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_mat, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 834, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
-    PyObject* sequence = __pyx_t_1;
-    Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
-    if (unlikely(size != 2)) {
-      if (size > 2) __Pyx_RaiseTooManyValuesError(2);
-      else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-      __PYX_ERR(0, 834, __pyx_L1_error)
-    }
-    #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-    if (likely(PyTuple_CheckExact(sequence))) {
-      __pyx_t_2 = PyTuple_GET_ITEM(sequence, 0); 
-      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 1); 
-    } else {
-      __pyx_t_2 = PyList_GET_ITEM(sequence, 0); 
-      __pyx_t_3 = PyList_GET_ITEM(sequence, 1); 
-    }
-    __Pyx_INCREF(__pyx_t_2);
-    __Pyx_INCREF(__pyx_t_3);
-    #else
-    __pyx_t_2 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 834, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_H0, __pyx_n_s_tocsr); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 846, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_3 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 834, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    #endif
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  } else {
-    Py_ssize_t index = -1;
-    __pyx_t_4 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 834, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __pyx_t_5 = Py_TYPE(__pyx_t_4)->tp_iternext;
-    index = 0; __pyx_t_2 = __pyx_t_5(__pyx_t_4); if (unlikely(!__pyx_t_2)) goto __pyx_L3_unpacking_failed;
-    __Pyx_GOTREF(__pyx_t_2);
-    index = 1; __pyx_t_3 = __pyx_t_5(__pyx_t_4); if (unlikely(!__pyx_t_3)) goto __pyx_L3_unpacking_failed;
-    __Pyx_GOTREF(__pyx_t_3);
-    if (__Pyx_IternextUnpackEndCheck(__pyx_t_5(__pyx_t_4), 2) < 0) __PYX_ERR(0, 834, __pyx_L1_error)
-    __pyx_t_5 = NULL;
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    goto __pyx_L4_unpacking_done;
-    __pyx_L3_unpacking_failed:;
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __pyx_t_5 = NULL;
-    if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-    __PYX_ERR(0, 834, __pyx_L1_error)
-    __pyx_L4_unpacking_done:;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
+      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
+      if (likely(__pyx_t_5)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
+        __Pyx_INCREF(__pyx_t_5);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_2, function);
+      }
+    }
+    __pyx_t_1 = (__pyx_t_5) ? __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_5) : __Pyx_PyObject_CallNoArg(__pyx_t_2);
+    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 846, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_GIVEREF(__pyx_t_1);
+    __Pyx_GOTREF(__pyx_v_self->H0);
+    __Pyx_DECREF(__pyx_v_self->H0);
+    __pyx_v_self->H0 = __pyx_t_1;
+    __pyx_t_1 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":845
+ *     def __cinit__(self, H0, W, complex[:] psi_st=None, work=None):
+ * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):             # <<<<<<<<<<<<<<
+ *             self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case
+ *         else:
+ */
+    goto __pyx_L3;
   }
-  __pyx_t_6 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_6 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 834, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_7 = __Pyx_PyInt_As_int(__pyx_t_3); if (unlikely((__pyx_t_7 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 834, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_v_self->nrows = __pyx_t_6;
-  __pyx_v_self->ncols = __pyx_t_7;
 
-  /* "tkwant/onebody/kernels.pyx":835
- *         mat = mat.tocsr()
- *         self.nrows, self.ncols = mat.shape
- *         self.data = mat.data             # <<<<<<<<<<<<<<
- *         self.indices, self.indptr = mat.indices, mat.indptr
+  /* "tkwant/onebody/kernels.pyx":848
+ *             self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case
+ *         else:
+ *             self.H0 = H0             # <<<<<<<<<<<<<<
  * 
+ *         self.W = W
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_mat, __pyx_n_s_data); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 835, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_8 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(__pyx_t_1, PyBUF_WRITABLE); if (unlikely(!__pyx_t_8.memview)) __PYX_ERR(0, 835, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_XDEC_MEMVIEW(&__pyx_v_self->data, 0);
-  __pyx_v_self->data = __pyx_t_8;
-  __pyx_t_8.memview = NULL;
-  __pyx_t_8.data = NULL;
+  /*else*/ {
+    __Pyx_INCREF(__pyx_v_H0);
+    __Pyx_GIVEREF(__pyx_v_H0);
+    __Pyx_GOTREF(__pyx_v_self->H0);
+    __Pyx_DECREF(__pyx_v_self->H0);
+    __pyx_v_self->H0 = __pyx_v_H0;
+  }
+  __pyx_L3:;
 
-  /* "tkwant/onebody/kernels.pyx":836
- *         self.nrows, self.ncols = mat.shape
- *         self.data = mat.data
- *         self.indices, self.indptr = mat.indices, mat.indptr             # <<<<<<<<<<<<<<
+  /* "tkwant/onebody/kernels.pyx":850
+ *             self.H0 = H0
  * 
+ *         self.W = W             # <<<<<<<<<<<<<<
+ *         self.size = H0.shape[0]
  * 
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_mat, __pyx_n_s_indices); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 836, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_9 = __Pyx_PyObject_to_MemoryviewSlice_ds_int(__pyx_t_1, PyBUF_WRITABLE); if (unlikely(!__pyx_t_9.memview)) __PYX_ERR(0, 836, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_mat, __pyx_n_s_indptr); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 836, __pyx_L1_error)
+  __Pyx_INCREF(__pyx_v_W);
+  __Pyx_GIVEREF(__pyx_v_W);
+  __Pyx_GOTREF(__pyx_v_self->W);
+  __Pyx_DECREF(__pyx_v_self->W);
+  __pyx_v_self->W = __pyx_v_W;
+
+  /* "tkwant/onebody/kernels.pyx":851
+ * 
+ *         self.W = W
+ *         self.size = H0.shape[0]             # <<<<<<<<<<<<<<
+ * 
+ *         if W is not None:
+ */
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_H0, __pyx_n_s_shape); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 851, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_10 = __Pyx_PyObject_to_MemoryviewSlice_ds_int(__pyx_t_1, PyBUF_WRITABLE); if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 836, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_GetItemInt(__pyx_t_1, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 851, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_XDEC_MEMVIEW(&__pyx_v_self->indices, 0);
-  __pyx_v_self->indices = __pyx_t_9;
-  __pyx_t_9.memview = NULL;
-  __pyx_t_9.data = NULL;
-  __PYX_XDEC_MEMVIEW(&__pyx_v_self->indptr, 0);
-  __pyx_v_self->indptr = __pyx_t_10;
-  __pyx_t_10.memview = NULL;
-  __pyx_t_10.data = NULL;
+  __pyx_t_6 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_6 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 851, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_v_self->__pyx_base.size = __pyx_t_6;
+
+  /* "tkwant/onebody/kernels.pyx":853
+ *         self.size = H0.shape[0]
+ * 
+ *         if W is not None:             # <<<<<<<<<<<<<<
+ *             self.center_size = self.W.size
+ *         else:
+ */
+  __pyx_t_4 = (__pyx_v_W != Py_None);
+  __pyx_t_3 = (__pyx_t_4 != 0);
+  if (__pyx_t_3) {
+
+    /* "tkwant/onebody/kernels.pyx":854
+ * 
+ *         if W is not None:
+ *             self.center_size = self.W.size             # <<<<<<<<<<<<<<
+ *         else:
+ *             self.center_size = self.size
+ */
+    __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->W, __pyx_n_s_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 854, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_6 = __Pyx_PyInt_As_int(__pyx_t_2); if (unlikely((__pyx_t_6 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 854, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_v_self->center_size = __pyx_t_6;
+
+    /* "tkwant/onebody/kernels.pyx":853
+ *         self.size = H0.shape[0]
+ * 
+ *         if W is not None:             # <<<<<<<<<<<<<<
+ *             self.center_size = self.W.size
+ *         else:
+ */
+    goto __pyx_L4;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":856
+ *             self.center_size = self.W.size
+ *         else:
+ *             self.center_size = self.size             # <<<<<<<<<<<<<<
+ *         self.psi_st = psi_st
+ *         if work is None:
+ */
+  /*else*/ {
+    __pyx_t_6 = __pyx_v_self->__pyx_base.size;
+    __pyx_v_self->center_size = __pyx_t_6;
+  }
+  __pyx_L4:;
+
+  /* "tkwant/onebody/kernels.pyx":857
+ *         else:
+ *             self.center_size = self.size
+ *         self.psi_st = psi_st             # <<<<<<<<<<<<<<
+ *         if work is None:
+ *             self._temp = np.empty((self.center_size,), dtype=complex)
+ */
+  __PYX_XDEC_MEMVIEW(&__pyx_v_self->psi_st, 0);
+  __PYX_INC_MEMVIEW(&__pyx_v_psi_st, 0);
+  __pyx_v_self->psi_st = __pyx_v_psi_st;
+
+  /* "tkwant/onebody/kernels.pyx":858
+ *             self.center_size = self.size
+ *         self.psi_st = psi_st
+ *         if work is None:             # <<<<<<<<<<<<<<
+ *             self._temp = np.empty((self.center_size,), dtype=complex)
+ *         else:
+ */
+  __pyx_t_3 = (__pyx_v_work == Py_None);
+  __pyx_t_4 = (__pyx_t_3 != 0);
+  if (__pyx_t_4) {
+
+    /* "tkwant/onebody/kernels.pyx":859
+ *         self.psi_st = psi_st
+ *         if work is None:
+ *             self._temp = np.empty((self.center_size,), dtype=complex)             # <<<<<<<<<<<<<<
+ *         else:
+ *             if work.size < self.center_size:
+ */
+    __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_np); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 859, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_empty); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 859, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->center_size); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 859, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 859, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_GIVEREF(__pyx_t_2);
+    PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_2);
+    __pyx_t_2 = 0;
+    __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 859, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_GIVEREF(__pyx_t_5);
+    PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_5);
+    __pyx_t_5 = 0;
+    __pyx_t_5 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 859, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    if (PyDict_SetItem(__pyx_t_5, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 859, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_2, __pyx_t_5); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 859, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_GIVEREF(__pyx_t_7);
+    __Pyx_GOTREF(__pyx_v_self->_temp);
+    __Pyx_DECREF(__pyx_v_self->_temp);
+    __pyx_v_self->_temp = __pyx_t_7;
+    __pyx_t_7 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":858
+ *             self.center_size = self.size
+ *         self.psi_st = psi_st
+ *         if work is None:             # <<<<<<<<<<<<<<
+ *             self._temp = np.empty((self.center_size,), dtype=complex)
+ *         else:
+ */
+    goto __pyx_L5;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":861
+ *             self._temp = np.empty((self.center_size,), dtype=complex)
+ *         else:
+ *             if work.size < self.center_size:             # <<<<<<<<<<<<<<
+ *                 raise ValueError('work array size={} must be at least '
+ *                      'the size of the central system={}'
+ */
+  /*else*/ {
+    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_work, __pyx_n_s_size); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 861, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_self->center_size); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 861, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __pyx_t_2 = PyObject_RichCompare(__pyx_t_7, __pyx_t_5, Py_LT); __Pyx_XGOTREF(__pyx_t_2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 861, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_2); if (unlikely(__pyx_t_4 < 0)) __PYX_ERR(0, 861, __pyx_L1_error)
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    if (unlikely(__pyx_t_4)) {
 
-  /* "tkwant/onebody/kernels.pyx":832
- *     cdef int[:] indices, indptr
+      /* "tkwant/onebody/kernels.pyx":864
+ *                 raise ValueError('work array size={} must be at least '
+ *                      'the size of the central system={}'
+ *                      .format(work.size, self.center_size))             # <<<<<<<<<<<<<<
+ *             self._temp = work
  * 
- *     def __cinit__(self, mat):             # <<<<<<<<<<<<<<
- *         mat = mat.tocsr()
- *         self.nrows, self.ncols = mat.shape
+ */
+      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_kp_u_work_array_size_must_be_at_least, __pyx_n_s_format); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 864, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_work, __pyx_n_s_size); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 864, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_7);
+      __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->center_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 864, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_1);
+      __pyx_t_8 = NULL;
+      __pyx_t_6 = 0;
+      if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_5))) {
+        __pyx_t_8 = PyMethod_GET_SELF(__pyx_t_5);
+        if (likely(__pyx_t_8)) {
+          PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
+          __Pyx_INCREF(__pyx_t_8);
+          __Pyx_INCREF(function);
+          __Pyx_DECREF_SET(__pyx_t_5, function);
+          __pyx_t_6 = 1;
+        }
+      }
+      #if CYTHON_FAST_PYCALL
+      if (PyFunction_Check(__pyx_t_5)) {
+        PyObject *__pyx_temp[3] = {__pyx_t_8, __pyx_t_7, __pyx_t_1};
+        __pyx_t_2 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 864, __pyx_L1_error)
+        __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
+        __Pyx_GOTREF(__pyx_t_2);
+        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+      } else
+      #endif
+      #if CYTHON_FAST_PYCCALL
+      if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
+        PyObject *__pyx_temp[3] = {__pyx_t_8, __pyx_t_7, __pyx_t_1};
+        __pyx_t_2 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_6, 2+__pyx_t_6); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 864, __pyx_L1_error)
+        __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
+        __Pyx_GOTREF(__pyx_t_2);
+        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+      } else
+      #endif
+      {
+        __pyx_t_9 = PyTuple_New(2+__pyx_t_6); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 864, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_9);
+        if (__pyx_t_8) {
+          __Pyx_GIVEREF(__pyx_t_8); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_8); __pyx_t_8 = NULL;
+        }
+        __Pyx_GIVEREF(__pyx_t_7);
+        PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_6, __pyx_t_7);
+        __Pyx_GIVEREF(__pyx_t_1);
+        PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_6, __pyx_t_1);
+        __pyx_t_7 = 0;
+        __pyx_t_1 = 0;
+        __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_9, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 864, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_2);
+        __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+      }
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+
+      /* "tkwant/onebody/kernels.pyx":862
+ *         else:
+ *             if work.size < self.center_size:
+ *                 raise ValueError('work array size={} must be at least '             # <<<<<<<<<<<<<<
+ *                      'the size of the central system={}'
+ *                      .format(work.size, self.center_size))
+ */
+      __pyx_t_5 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 862, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_Raise(__pyx_t_5, 0, 0, 0);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __PYX_ERR(0, 862, __pyx_L1_error)
+
+      /* "tkwant/onebody/kernels.pyx":861
+ *             self._temp = np.empty((self.center_size,), dtype=complex)
+ *         else:
+ *             if work.size < self.center_size:             # <<<<<<<<<<<<<<
+ *                 raise ValueError('work array size={} must be at least '
+ *                      'the size of the central system={}'
+ */
+    }
+
+    /* "tkwant/onebody/kernels.pyx":865
+ *                      'the size of the central system={}'
+ *                      .format(work.size, self.center_size))
+ *             self._temp = work             # <<<<<<<<<<<<<<
+ * 
+ * 
+ */
+    __Pyx_INCREF(__pyx_v_work);
+    __Pyx_GIVEREF(__pyx_v_work);
+    __Pyx_GOTREF(__pyx_v_self->_temp);
+    __Pyx_DECREF(__pyx_v_self->_temp);
+    __pyx_v_self->_temp = __pyx_v_work;
+  }
+  __pyx_L5:;
+
+  /* "tkwant/onebody/kernels.pyx":843
+ *         pass
+ * 
+ *     def __cinit__(self, H0, W, complex[:] psi_st=None, work=None):             # <<<<<<<<<<<<<<
+ * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):
  */
 
   /* function exit code */
   __pyx_r = 0;
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_XDECREF(__pyx_t_4);
-  __PYX_XDEC_MEMVIEW(&__pyx_t_8, 1);
-  __PYX_XDEC_MEMVIEW(&__pyx_t_9, 1);
-  __PYX_XDEC_MEMVIEW(&__pyx_t_10, 1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels._CSRMatrix.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_7);
+  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_XDECREF(__pyx_t_9);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
-  __Pyx_XDECREF(__pyx_v_mat);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_psi_st, 1);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
+/* "tkwant/onebody/kernels.pyx":868
+ * 
+ * 
+ *     def rhs(self, energy=None):             # <<<<<<<<<<<<<<
+ * 
+ *         if energy is None:
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_10_CSRMatrix_3__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_10_CSRMatrix_2__reduce_cython__[] = "_CSRMatrix.__reduce_cython__(self)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_10_CSRMatrix_3__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_5rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_6Simple_4rhs[] = "Simple.rhs(self, energy=None)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_5rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  PyObject *__pyx_v_energy = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_10_CSRMatrix_2__reduce_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *)__pyx_v_self));
+  __Pyx_RefNannySetupContext("rhs (wrapper)", 0);
+  {
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_energy,0};
+    PyObject* values[1] = {0};
+    values[0] = ((PyObject *)Py_None);
+    if (unlikely(__pyx_kwds)) {
+      Py_ssize_t kw_args;
+      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
+      switch (pos_args) {
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = PyDict_Size(__pyx_kwds);
+      switch (pos_args) {
+        case  0:
+        if (kw_args > 0) {
+          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_energy);
+          if (value) { values[0] = value; kw_args--; }
+        }
+      }
+      if (unlikely(kw_args > 0)) {
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "rhs") < 0)) __PYX_ERR(0, 868, __pyx_L3_error)
+      }
+    } else {
+      switch (PyTuple_GET_SIZE(__pyx_args)) {
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+    }
+    __pyx_v_energy = values[0];
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("rhs", 0, 0, 1, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 868, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_4rhs(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self), __pyx_v_energy);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_10_CSRMatrix_2__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *__pyx_v_self) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_4rhs(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_energy) {
+  PyObject *__pyx_v_H0 = NULL;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("__reduce_cython__", 0);
+  int __pyx_t_1;
+  int __pyx_t_2;
+  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
+  PyObject *__pyx_t_7 = NULL;
+  PyObject *__pyx_t_8 = NULL;
+  PyObject *__pyx_t_9 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("rhs", 0);
 
-  /* "(tree fragment)":2
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+  /* "tkwant/onebody/kernels.pyx":870
+ *     def rhs(self, energy=None):
+ * 
+ *         if energy is None:             # <<<<<<<<<<<<<<
+ *             H0 = self.H0
+ *         else:
  */
-  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 2, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(1, 2, __pyx_L1_error)
+  __pyx_t_1 = (__pyx_v_energy == Py_None);
+  __pyx_t_2 = (__pyx_t_1 != 0);
+  if (__pyx_t_2) {
 
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
+    /* "tkwant/onebody/kernels.pyx":871
+ * 
+ *         if energy is None:
+ *             H0 = self.H0             # <<<<<<<<<<<<<<
+ *         else:
+ *             H0 = self.H0 - energy * sp.eye(self.size)
+ */
+    __pyx_t_3 = __pyx_v_self->H0;
+    __Pyx_INCREF(__pyx_t_3);
+    __pyx_v_H0 = __pyx_t_3;
+    __pyx_t_3 = 0;
+
+    /* "tkwant/onebody/kernels.pyx":870
+ *     def rhs(self, energy=None):
+ * 
+ *         if energy is None:             # <<<<<<<<<<<<<<
+ *             H0 = self.H0
+ *         else:
+ */
+    goto __pyx_L3;
+  }
+
+  /* "tkwant/onebody/kernels.pyx":873
+ *             H0 = self.H0
+ *         else:
+ *             H0 = self.H0 - energy * sp.eye(self.size)             # <<<<<<<<<<<<<<
+ * 
+ *         # The approach with a separated class ``_CalcRHS`` to calculate the r.h.s.
+ */
+  /*else*/ {
+    __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_sp); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 873, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_eye); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 873, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __pyx_t_4 = __Pyx_PyInt_From_int(__pyx_v_self->__pyx_base.size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 873, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_6 = NULL;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_5))) {
+      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
+      if (likely(__pyx_t_6)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
+        __Pyx_INCREF(__pyx_t_6);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_5, function);
+      }
+    }
+    __pyx_t_3 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_5, __pyx_t_6, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_t_4);
+    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 873, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_5 = PyNumber_Multiply(__pyx_v_energy, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 873, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __pyx_t_3 = PyNumber_Subtract(__pyx_v_self->H0, __pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 873, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_v_H0 = __pyx_t_3;
+    __pyx_t_3 = 0;
+  }
+  __pyx_L3:;
+
+  /* "tkwant/onebody/kernels.pyx":888
+ *         # which not stored in the ``onebody.WaveFunction``, such
+ *         # that it is cleaned by the garbage collector.
+ *         return _CalcRHSc(H0.indptr, H0.indices, H0.data, self.W, self.psi_st,             # <<<<<<<<<<<<<<
+ *                          self.size, self.center_size, self._temp)
+ * 
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_H0, __pyx_n_s_indptr); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 888, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_H0, __pyx_n_s_indices); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 888, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_5);
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_H0, __pyx_n_s_data); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 888, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  if (unlikely(!__pyx_v_self->psi_st.memview)) {PyErr_SetString(PyExc_AttributeError,"Memoryview is not initialized");__PYX_ERR(0, 888, __pyx_L1_error)}
+  __pyx_t_6 = __pyx_memoryview_fromslice(__pyx_v_self->psi_st, 1, (PyObject *(*)(char *)) __pyx_memview_get___pyx_t_double_complex, (int (*)(char *, PyObject *)) __pyx_memview_set___pyx_t_double_complex, 0);; if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 888, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_6);
+
+  /* "tkwant/onebody/kernels.pyx":889
+ *         # that it is cleaned by the garbage collector.
+ *         return _CalcRHSc(H0.indptr, H0.indices, H0.data, self.W, self.psi_st,
+ *                          self.size, self.center_size, self._temp)             # <<<<<<<<<<<<<<
+ * 
+ *     @property
+ */
+  __pyx_t_7 = __Pyx_PyInt_From_int(__pyx_v_self->__pyx_base.size); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 889, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_7);
+  __pyx_t_8 = __Pyx_PyInt_From_int(__pyx_v_self->center_size); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 889, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_8);
+
+  /* "tkwant/onebody/kernels.pyx":888
+ *         # which not stored in the ``onebody.WaveFunction``, such
+ *         # that it is cleaned by the garbage collector.
+ *         return _CalcRHSc(H0.indptr, H0.indices, H0.data, self.W, self.psi_st,             # <<<<<<<<<<<<<<
+ *                          self.size, self.center_size, self._temp)
+ * 
+ */
+  __pyx_t_9 = PyTuple_New(8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 888, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_9);
+  __Pyx_GIVEREF(__pyx_t_3);
+  PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_5);
+  PyTuple_SET_ITEM(__pyx_t_9, 1, __pyx_t_5);
+  __Pyx_GIVEREF(__pyx_t_4);
+  PyTuple_SET_ITEM(__pyx_t_9, 2, __pyx_t_4);
+  __Pyx_INCREF(__pyx_v_self->W);
+  __Pyx_GIVEREF(__pyx_v_self->W);
+  PyTuple_SET_ITEM(__pyx_t_9, 3, __pyx_v_self->W);
+  __Pyx_GIVEREF(__pyx_t_6);
+  PyTuple_SET_ITEM(__pyx_t_9, 4, __pyx_t_6);
+  __Pyx_GIVEREF(__pyx_t_7);
+  PyTuple_SET_ITEM(__pyx_t_9, 5, __pyx_t_7);
+  __Pyx_GIVEREF(__pyx_t_8);
+  PyTuple_SET_ITEM(__pyx_t_9, 6, __pyx_t_8);
+  __Pyx_INCREF(__pyx_v_self->_temp);
+  __Pyx_GIVEREF(__pyx_v_self->_temp);
+  PyTuple_SET_ITEM(__pyx_t_9, 7, __pyx_v_self->_temp);
+  __pyx_t_3 = 0;
+  __pyx_t_5 = 0;
+  __pyx_t_4 = 0;
+  __pyx_t_6 = 0;
+  __pyx_t_7 = 0;
+  __pyx_t_8 = 0;
+  __pyx_t_8 = __Pyx_PyObject_Call(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels__CalcRHSc), __pyx_t_9, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 888, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_8);
+  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+  __pyx_r = __pyx_t_8;
+  __pyx_t_8 = 0;
+  goto __pyx_L0;
+
+  /* "tkwant/onebody/kernels.pyx":868
+ * 
+ * 
+ *     def rhs(self, energy=None):             # <<<<<<<<<<<<<<
+ * 
+ *         if energy is None:
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels._CSRMatrix.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
+  __Pyx_XDECREF(__pyx_t_7);
+  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_XDECREF(__pyx_t_9);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v_H0);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+/* "tkwant/onebody/kernels.pyx":892
+ * 
+ *     @property
+ *     def W(self):             # <<<<<<<<<<<<<<
+ *         '''The time dependent perturbation W(t)'''
+ *         return self.W
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_10_CSRMatrix_5__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_10_CSRMatrix_4__setstate_cython__[] = "_CSRMatrix.__setstate_cython__(self, __pyx_state)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_10_CSRMatrix_5__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_1W_1__get__(PyObject *__pyx_v_self); /*proto*/
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_1W_1__get__(PyObject *__pyx_v_self) {
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_10_CSRMatrix_4__setstate_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *)__pyx_v_self), ((PyObject *)__pyx_v___pyx_state));
+  __Pyx_RefNannySetupContext("__get__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_1W___get__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self));
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_10_CSRMatrix_4__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_1W___get__(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("__setstate_cython__", 0);
+  __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "(tree fragment)":4
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
+  /* "tkwant/onebody/kernels.pyx":894
+ *     def W(self):
+ *         '''The time dependent perturbation W(t)'''
+ *         return self.W             # <<<<<<<<<<<<<<
+ * 
+ *     def set_W(self, W):
  */
-  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__8, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_INCREF(__pyx_v_self->W);
+  __pyx_r = __pyx_v_self->W;
+  goto __pyx_L0;
 
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+  /* "tkwant/onebody/kernels.pyx":892
+ * 
+ *     @property
+ *     def W(self):             # <<<<<<<<<<<<<<
+ *         '''The time dependent perturbation W(t)'''
+ *         return self.W
  */
 
   /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels._CSRMatrix.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
+  __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":842
- * @cython.wraparound(False)
- * @cython.initializedcheck(False)
- * cdef _csr_spmv(_CSRMatrix A, const complex *X, complex *Y):             # <<<<<<<<<<<<<<
- *     """Naive implementation of CSR-format matrix-vector multiplication.
+/* "tkwant/onebody/kernels.pyx":896
+ *         return self.W
  * 
+ *     def set_W(self, W):             # <<<<<<<<<<<<<<
+ *         '''Set the time dependent perturbation W(t)'''
+ *         self.W = W
  */
 
-static PyObject *__pyx_f_6tkwant_7onebody_7kernels__csr_spmv(struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *__pyx_v_A, __pyx_t_double_complex const *__pyx_v_X, __pyx_t_double_complex *__pyx_v_Y) {
-  __pyx_t_double_complex __pyx_v_sum;
-  unsigned int __pyx_v_i;
-  unsigned int __pyx_v_jj;
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_7set_W(PyObject *__pyx_v_self, PyObject *__pyx_v_W); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_6Simple_6set_W[] = "Simple.set_W(self, W)\nSet the time dependent perturbation W(t)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_7set_W(PyObject *__pyx_v_self, PyObject *__pyx_v_W) {
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("set_W (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_6set_W(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self), ((PyObject *)__pyx_v_W));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_6set_W(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_W) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  int __pyx_t_2;
-  unsigned int __pyx_t_3;
-  Py_ssize_t __pyx_t_4;
-  int __pyx_t_5;
-  size_t __pyx_t_6;
-  int __pyx_t_7;
-  unsigned int __pyx_t_8;
-  size_t __pyx_t_9;
-  size_t __pyx_t_10;
-  __Pyx_RefNannySetupContext("_csr_spmv", 0);
+  __Pyx_RefNannySetupContext("set_W", 0);
 
-  /* "tkwant/onebody/kernels.pyx":850
- *     cdef unsigned i, jj
+  /* "tkwant/onebody/kernels.pyx":898
+ *     def set_W(self, W):
+ *         '''Set the time dependent perturbation W(t)'''
+ *         self.W = W             # <<<<<<<<<<<<<<
+ * 
  * 
- *     for i in range(A.nrows):             # <<<<<<<<<<<<<<
- *        sum = Y[i]
- *        for jj in range(A.indptr[i], A.indptr[i+1]):
  */
-  __pyx_t_1 = __pyx_v_A->nrows;
-  __pyx_t_2 = __pyx_t_1;
-  for (__pyx_t_3 = 0; __pyx_t_3 < __pyx_t_2; __pyx_t_3+=1) {
-    __pyx_v_i = __pyx_t_3;
+  __Pyx_INCREF(__pyx_v_W);
+  __Pyx_GIVEREF(__pyx_v_W);
+  __Pyx_GOTREF(__pyx_v_self->W);
+  __Pyx_DECREF(__pyx_v_self->W);
+  __pyx_v_self->W = __pyx_v_W;
 
-    /* "tkwant/onebody/kernels.pyx":851
+  /* "tkwant/onebody/kernels.pyx":896
+ *         return self.W
  * 
- *     for i in range(A.nrows):
- *        sum = Y[i]             # <<<<<<<<<<<<<<
- *        for jj in range(A.indptr[i], A.indptr[i+1]):
- *            sum += A.data[jj] * X[A.indices[jj]]
+ *     def set_W(self, W):             # <<<<<<<<<<<<<<
+ *         '''Set the time dependent perturbation W(t)'''
+ *         self.W = W
  */
-    __pyx_v_sum = (__pyx_v_Y[__pyx_v_i]);
 
-    /* "tkwant/onebody/kernels.pyx":852
- *     for i in range(A.nrows):
- *        sum = Y[i]
- *        for jj in range(A.indptr[i], A.indptr[i+1]):             # <<<<<<<<<<<<<<
- *            sum += A.data[jj] * X[A.indices[jj]]
- *        Y[i] = sum
+  /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":1
+ * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+ * def __setstate_cython__(self, __pyx_state):
  */
-    __pyx_t_4 = (__pyx_v_i + 1);
-    __pyx_t_5 = (*((int *) ( /* dim=0 */ (__pyx_v_A->indptr.data + __pyx_t_4 * __pyx_v_A->indptr.strides[0]) )));
-    __pyx_t_6 = __pyx_v_i;
-    __pyx_t_7 = __pyx_t_5;
-    for (__pyx_t_8 = (*((int *) ( /* dim=0 */ (__pyx_v_A->indptr.data + __pyx_t_6 * __pyx_v_A->indptr.strides[0]) ))); __pyx_t_8 < __pyx_t_7; __pyx_t_8+=1) {
-      __pyx_v_jj = __pyx_t_8;
 
-      /* "tkwant/onebody/kernels.pyx":853
- *        sum = Y[i]
- *        for jj in range(A.indptr[i], A.indptr[i+1]):
- *            sum += A.data[jj] * X[A.indices[jj]]             # <<<<<<<<<<<<<<
- *        Y[i] = sum
- * 
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_9__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_6Simple_8__reduce_cython__[] = "Simple.__reduce_cython__(self)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_9__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_8__reduce_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_8__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__reduce_cython__", 0);
+
+  /* "(tree fragment)":2
+ * def __reduce_cython__(self):
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
+ * def __setstate_cython__(self, __pyx_state):
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
  */
-      __pyx_t_9 = __pyx_v_jj;
-      __pyx_t_10 = __pyx_v_jj;
-      __pyx_v_sum = __Pyx_c_sum_double(__pyx_v_sum, __Pyx_c_prod_double((*((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_A->data.data + __pyx_t_9 * __pyx_v_A->data.strides[0]) ))), (__pyx_v_X[(*((int *) ( /* dim=0 */ (__pyx_v_A->indices.data + __pyx_t_10 * __pyx_v_A->indices.strides[0]) )))])));
-    }
+  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__6, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 2, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __PYX_ERR(1, 2, __pyx_L1_error)
+
+  /* "(tree fragment)":1
+ * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+ * def __setstate_cython__(self, __pyx_state):
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":3
+ * def __reduce_cython__(self):
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+ * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_11__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_6Simple_10__setstate_cython__[] = "Simple.__setstate_cython__(self, __pyx_state)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_11__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_10__setstate_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self), ((PyObject *)__pyx_v___pyx_state));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
 
-    /* "tkwant/onebody/kernels.pyx":854
- *        for jj in range(A.indptr[i], A.indptr[i+1]):
- *            sum += A.data[jj] * X[A.indices[jj]]
- *        Y[i] = sum             # <<<<<<<<<<<<<<
- * 
- * 
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_10__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__setstate_cython__", 0);
+
+  /* "(tree fragment)":4
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+ * def __setstate_cython__(self, __pyx_state):
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  */
-    (__pyx_v_Y[__pyx_v_i]) = __pyx_v_sum;
-  }
+  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __PYX_ERR(1, 4, __pyx_L1_error)
 
-  /* "tkwant/onebody/kernels.pyx":842
- * @cython.wraparound(False)
- * @cython.initializedcheck(False)
- * cdef _csr_spmv(_CSRMatrix A, const complex *X, complex *Y):             # <<<<<<<<<<<<<<
- *     """Naive implementation of CSR-format matrix-vector multiplication.
- * 
+  /* "(tree fragment)":3
+ * def __reduce_cython__(self):
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+ * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
+ *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
  */
 
   /* function exit code */
-  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":869
- *         _CSRMatrix H0
+/* "tkwant/onebody/kernels.pyx":912
+ *         int[:] _indices, _indptr
  * 
- *     def __init__(self, H0, W, params, complex[:] psi_st=None):             # <<<<<<<<<<<<<<
+ *     def __init__(self, int[:] indptr, int[:] indices, complex[:] data, W, complex[:] psi_st,             # <<<<<<<<<<<<<<
+ *                  int size, int center_size, complex[:] temp):
  *         pass
- * 
  */
 
 /* Python wrapper */
-static int __pyx_pw_6tkwant_7onebody_7kernels_6Simple_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static int __pyx_pw_6tkwant_7onebody_7kernels_6Simple_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  CYTHON_UNUSED PyObject *__pyx_v_H0 = 0;
+static int __pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static int __pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  CYTHON_UNUSED __Pyx_memviewslice __pyx_v_indptr = { 0, 0, { 0 }, { 0 }, { 0 } };
+  CYTHON_UNUSED __Pyx_memviewslice __pyx_v_indices = { 0, 0, { 0 }, { 0 }, { 0 } };
+  CYTHON_UNUSED __Pyx_memviewslice __pyx_v_data = { 0, 0, { 0 }, { 0 }, { 0 } };
   CYTHON_UNUSED PyObject *__pyx_v_W = 0;
-  CYTHON_UNUSED PyObject *__pyx_v_params = 0;
   CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st = { 0, 0, { 0 }, { 0 }, { 0 } };
+  CYTHON_UNUSED int __pyx_v_size;
+  CYTHON_UNUSED int __pyx_v_center_size;
+  CYTHON_UNUSED __Pyx_memviewslice __pyx_v_temp = { 0, 0, { 0 }, { 0 }, { 0 } };
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_H0,&__pyx_n_s_W,&__pyx_n_s_params,&__pyx_n_s_psi_st,0};
-    PyObject* values[4] = {0,0,0,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_indptr,&__pyx_n_s_indices,&__pyx_n_s_data,&__pyx_n_s_W,&__pyx_n_s_psi_st,&__pyx_n_s_size,&__pyx_n_s_center_size,&__pyx_n_s_temp,0};
+    PyObject* values[8] = {0,0,0,0,0,0,0,0};
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
+        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
+        CYTHON_FALLTHROUGH;
+        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
+        CYTHON_FALLTHROUGH;
+        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
+        CYTHON_FALLTHROUGH;
+        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+        CYTHON_FALLTHROUGH;
         case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
         case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
         CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_H0)) != 0)) kw_args--;
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_indptr)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
-        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_indices)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, 1); __PYX_ERR(0, 869, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 8, 8, 1); __PYX_ERR(0, 912, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
-        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_params)) != 0)) kw_args--;
+        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_data)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, 2); __PYX_ERR(0, 869, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 8, 8, 2); __PYX_ERR(0, 912, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
-        if (kw_args > 0) {
-          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st);
-          if (value) { values[3] = value; kw_args--; }
+        if (likely((values[3] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 8, 8, 3); __PYX_ERR(0, 912, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  4:
+        if (likely((values[4] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 8, 8, 4); __PYX_ERR(0, 912, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  5:
+        if (likely((values[5] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_size)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 8, 8, 5); __PYX_ERR(0, 912, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  6:
+        if (likely((values[6] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_center_size)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 8, 8, 6); __PYX_ERR(0, 912, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  7:
+        if (likely((values[7] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_temp)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__init__", 1, 8, 8, 7); __PYX_ERR(0, 912, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 869, __pyx_L3_error)
-      }
-    } else {
-      switch (PyTuple_GET_SIZE(__pyx_args)) {
-        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
-        CYTHON_FALLTHROUGH;
-        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
-        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
-        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
-        break;
-        default: goto __pyx_L5_argtuple_error;
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 912, __pyx_L3_error)
       }
-    }
-    __pyx_v_H0 = values[0];
-    __pyx_v_W = values[1];
-    __pyx_v_params = values[2];
-    if (values[3]) {
-      __pyx_v_psi_st = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[3], PyBUF_WRITABLE); if (unlikely(!__pyx_v_psi_st.memview)) __PYX_ERR(0, 869, __pyx_L3_error)
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 8) {
+      goto __pyx_L5_argtuple_error;
     } else {
-      __pyx_v_psi_st = __pyx_k__9;
-      __PYX_INC_MEMVIEW(&__pyx_v_psi_st, 1);
-    }
+      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
+      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
+      values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
+    }
+    __pyx_v_indptr = __Pyx_PyObject_to_MemoryviewSlice_ds_int(values[0], PyBUF_WRITABLE); if (unlikely(!__pyx_v_indptr.memview)) __PYX_ERR(0, 912, __pyx_L3_error)
+    __pyx_v_indices = __Pyx_PyObject_to_MemoryviewSlice_ds_int(values[1], PyBUF_WRITABLE); if (unlikely(!__pyx_v_indices.memview)) __PYX_ERR(0, 912, __pyx_L3_error)
+    __pyx_v_data = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[2], PyBUF_WRITABLE); if (unlikely(!__pyx_v_data.memview)) __PYX_ERR(0, 912, __pyx_L3_error)
+    __pyx_v_W = values[3];
+    __pyx_v_psi_st = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[4], PyBUF_WRITABLE); if (unlikely(!__pyx_v_psi_st.memview)) __PYX_ERR(0, 912, __pyx_L3_error)
+    __pyx_v_size = __Pyx_PyInt_As_int(values[5]); if (unlikely((__pyx_v_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 913, __pyx_L3_error)
+    __pyx_v_center_size = __Pyx_PyInt_As_int(values[6]); if (unlikely((__pyx_v_center_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 913, __pyx_L3_error)
+    __pyx_v_temp = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[7], PyBUF_WRITABLE); if (unlikely(!__pyx_v_temp.memview)) __PYX_ERR(0, 913, __pyx_L3_error)
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 869, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 1, 8, 8, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 912, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHSc.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self), __pyx_v_H0, __pyx_v_W, __pyx_v_params, __pyx_v_psi_st);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc___init__(((struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *)__pyx_v_self), __pyx_v_indptr, __pyx_v_indices, __pyx_v_data, __pyx_v_W, __pyx_v_psi_st, __pyx_v_size, __pyx_v_center_size, __pyx_v_temp);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static int __pyx_pf_6tkwant_7onebody_7kernels_6Simple___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v_H0, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED PyObject *__pyx_v_params, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st) {
+static int __pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc___init__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *__pyx_v_self, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_indptr, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_indices, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_data, CYTHON_UNUSED PyObject *__pyx_v_W, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_psi_st, CYTHON_UNUSED int __pyx_v_size, CYTHON_UNUSED int __pyx_v_center_size, CYTHON_UNUSED __Pyx_memviewslice __pyx_v_temp) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__", 0);
 
   /* function exit code */
   __pyx_r = 0;
+  __PYX_XDEC_MEMVIEW(&__pyx_v_indptr, 1);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_indices, 1);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_data, 1);
   __PYX_XDEC_MEMVIEW(&__pyx_v_psi_st, 1);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_temp, 1);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":872
- *         pass
- * 
- *     def set_params(self, params):             # <<<<<<<<<<<<<<
- *         self.params = params
- * 
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_3set_params(PyObject *__pyx_v_self, PyObject *__pyx_v_params); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_6Simple_2set_params[] = "Simple.set_params(self, params)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_3set_params(PyObject *__pyx_v_self, PyObject *__pyx_v_params) {
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("set_params (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_2set_params(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self), ((PyObject *)__pyx_v_params));
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_2set_params(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_params) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("set_params", 0);
-
-  /* "tkwant/onebody/kernels.pyx":873
- * 
- *     def set_params(self, params):
- *         self.params = params             # <<<<<<<<<<<<<<
- * 
- *     def __cinit__(self, H0, W, params, complex[:] psi_st=None):
- */
-  __Pyx_INCREF(__pyx_v_params);
-  __Pyx_GIVEREF(__pyx_v_params);
-  __Pyx_GOTREF(__pyx_v_self->params);
-  __Pyx_DECREF(__pyx_v_self->params);
-  __pyx_v_self->params = __pyx_v_params;
-
-  /* "tkwant/onebody/kernels.pyx":872
- *         pass
+/* "tkwant/onebody/kernels.pyx":917
  * 
- *     def set_params(self, params):             # <<<<<<<<<<<<<<
- *         self.params = params
+ *     """Calculate the right-hand-side of the time-dependent Schrdinger equation."""
+ *     def __cinit__(self, int[:] indptr, int[:] indices, complex[:] data, W, complex[:] psi_st,             # <<<<<<<<<<<<<<
+ *                   int size, int center_size, complex[:] temp):
  * 
  */
 
-  /* function exit code */
-  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-/* "tkwant/onebody/kernels.pyx":875
- *         self.params = params
- * 
- *     def __cinit__(self, H0, W, params, complex[:] psi_st=None):             # <<<<<<<<<<<<<<
- *         self.c_self = <void*> self
- *         self.params = params
- */
-
 /* Python wrapper */
-static int __pyx_pw_6tkwant_7onebody_7kernels_6Simple_5__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static int __pyx_pw_6tkwant_7onebody_7kernels_6Simple_5__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  PyObject *__pyx_v_H0 = 0;
+static int __pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_3__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static int __pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_3__cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  __Pyx_memviewslice __pyx_v_indptr = { 0, 0, { 0 }, { 0 }, { 0 } };
+  __Pyx_memviewslice __pyx_v_indices = { 0, 0, { 0 }, { 0 }, { 0 } };
+  __Pyx_memviewslice __pyx_v_data = { 0, 0, { 0 }, { 0 }, { 0 } };
   PyObject *__pyx_v_W = 0;
-  PyObject *__pyx_v_params = 0;
   __Pyx_memviewslice __pyx_v_psi_st = { 0, 0, { 0 }, { 0 }, { 0 } };
+  int __pyx_v_size;
+  int __pyx_v_center_size;
+  __Pyx_memviewslice __pyx_v_temp = { 0, 0, { 0 }, { 0 }, { 0 } };
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__cinit__ (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_H0,&__pyx_n_s_W,&__pyx_n_s_params,&__pyx_n_s_psi_st,0};
-    PyObject* values[4] = {0,0,0,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_indptr,&__pyx_n_s_indices,&__pyx_n_s_data,&__pyx_n_s_W,&__pyx_n_s_psi_st,&__pyx_n_s_size,&__pyx_n_s_center_size,&__pyx_n_s_temp,0};
+    PyObject* values[8] = {0,0,0,0,0,0,0,0};
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
+        case  8: values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
+        CYTHON_FALLTHROUGH;
+        case  7: values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
+        CYTHON_FALLTHROUGH;
+        case  6: values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
+        CYTHON_FALLTHROUGH;
+        case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+        CYTHON_FALLTHROUGH;
         case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
         case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
         CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_H0)) != 0)) kw_args--;
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_indptr)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
-        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_indices)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 3, 4, 1); __PYX_ERR(0, 875, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 8, 8, 1); __PYX_ERR(0, 917, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
-        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_params)) != 0)) kw_args--;
+        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_data)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 3, 4, 2); __PYX_ERR(0, 875, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 8, 8, 2); __PYX_ERR(0, 917, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
-        if (kw_args > 0) {
-          PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st);
-          if (value) { values[3] = value; kw_args--; }
+        if (likely((values[3] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_W)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 8, 8, 3); __PYX_ERR(0, 917, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  4:
+        if (likely((values[4] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi_st)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 8, 8, 4); __PYX_ERR(0, 917, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  5:
+        if (likely((values[5] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_size)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 8, 8, 5); __PYX_ERR(0, 917, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  6:
+        if (likely((values[6] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_center_size)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 8, 8, 6); __PYX_ERR(0, 917, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  7:
+        if (likely((values[7] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_temp)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 8, 8, 7); __PYX_ERR(0, 917, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__cinit__") < 0)) __PYX_ERR(0, 875, __pyx_L3_error)
-      }
-    } else {
-      switch (PyTuple_GET_SIZE(__pyx_args)) {
-        case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
-        CYTHON_FALLTHROUGH;
-        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
-        values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
-        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
-        break;
-        default: goto __pyx_L5_argtuple_error;
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__cinit__") < 0)) __PYX_ERR(0, 917, __pyx_L3_error)
       }
-    }
-    __pyx_v_H0 = values[0];
-    __pyx_v_W = values[1];
-    __pyx_v_params = values[2];
-    if (values[3]) {
-      __pyx_v_psi_st = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[3], PyBUF_WRITABLE); if (unlikely(!__pyx_v_psi_st.memview)) __PYX_ERR(0, 875, __pyx_L3_error)
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 8) {
+      goto __pyx_L5_argtuple_error;
     } else {
-      __pyx_v_psi_st = __pyx_k__10;
-      __PYX_INC_MEMVIEW(&__pyx_v_psi_st, 1);
-    }
+      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+      values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
+      values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
+      values[5] = PyTuple_GET_ITEM(__pyx_args, 5);
+      values[6] = PyTuple_GET_ITEM(__pyx_args, 6);
+      values[7] = PyTuple_GET_ITEM(__pyx_args, 7);
+    }
+    __pyx_v_indptr = __Pyx_PyObject_to_MemoryviewSlice_ds_int(values[0], PyBUF_WRITABLE); if (unlikely(!__pyx_v_indptr.memview)) __PYX_ERR(0, 917, __pyx_L3_error)
+    __pyx_v_indices = __Pyx_PyObject_to_MemoryviewSlice_ds_int(values[1], PyBUF_WRITABLE); if (unlikely(!__pyx_v_indices.memview)) __PYX_ERR(0, 917, __pyx_L3_error)
+    __pyx_v_data = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[2], PyBUF_WRITABLE); if (unlikely(!__pyx_v_data.memview)) __PYX_ERR(0, 917, __pyx_L3_error)
+    __pyx_v_W = values[3];
+    __pyx_v_psi_st = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[4], PyBUF_WRITABLE); if (unlikely(!__pyx_v_psi_st.memview)) __PYX_ERR(0, 917, __pyx_L3_error)
+    __pyx_v_size = __Pyx_PyInt_As_int(values[5]); if (unlikely((__pyx_v_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 918, __pyx_L3_error)
+    __pyx_v_center_size = __Pyx_PyInt_As_int(values[6]); if (unlikely((__pyx_v_center_size == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 918, __pyx_L3_error)
+    __pyx_v_temp = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(values[7], PyBUF_WRITABLE); if (unlikely(!__pyx_v_temp.memview)) __PYX_ERR(0, 918, __pyx_L3_error)
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 3, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 875, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__cinit__", 1, 8, 8, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 917, __pyx_L3_error)
   __pyx_L3_error:;
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHSc.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_4__cinit__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self), __pyx_v_H0, __pyx_v_W, __pyx_v_params, __pyx_v_psi_st);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc_2__cinit__(((struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *)__pyx_v_self), __pyx_v_indptr, __pyx_v_indices, __pyx_v_data, __pyx_v_W, __pyx_v_psi_st, __pyx_v_size, __pyx_v_center_size, __pyx_v_temp);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static int __pyx_pf_6tkwant_7onebody_7kernels_6Simple_4__cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, PyObject *__pyx_v_H0, PyObject *__pyx_v_W, PyObject *__pyx_v_params, __Pyx_memviewslice __pyx_v_psi_st) {
+static int __pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc_2__cinit__(struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *__pyx_v_self, __Pyx_memviewslice __pyx_v_indptr, __Pyx_memviewslice __pyx_v_indices, __Pyx_memviewslice __pyx_v_data, PyObject *__pyx_v_W, __Pyx_memviewslice __pyx_v_psi_st, int __pyx_v_size, int __pyx_v_center_size, __Pyx_memviewslice __pyx_v_temp) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
-  void (*__pyx_t_1)(void const *, __pyx_t_double_complex const *, __pyx_t_double_complex *, double);
-  PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
-  int __pyx_t_4;
-  int __pyx_t_5;
-  Py_ssize_t __pyx_t_6;
-  int __pyx_t_7;
-  PyObject *__pyx_t_8 = NULL;
-  PyObject *__pyx_t_9 = NULL;
-  __Pyx_memviewslice __pyx_t_10 = { 0, 0, { 0 }, { 0 }, { 0 } };
-  Py_ssize_t __pyx_t_11;
+  int __pyx_t_1;
+  Py_ssize_t __pyx_t_2;
+  int __pyx_t_3;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__cinit__", 0);
 
-  /* "tkwant/onebody/kernels.pyx":876
+  /* "tkwant/onebody/kernels.pyx":920
+ *                   int size, int center_size, complex[:] temp):
  * 
- *     def __cinit__(self, H0, W, params, complex[:] psi_st=None):
- *         self.c_self = <void*> self             # <<<<<<<<<<<<<<
- *         self.params = params
- *         self.c_rhs = self._rhs
- */
-  __pyx_v_self->__pyx_base.c_self = ((void *)__pyx_v_self);
-
-  /* "tkwant/onebody/kernels.pyx":877
- *     def __cinit__(self, H0, W, params, complex[:] psi_st=None):
- *         self.c_self = <void*> self
- *         self.params = params             # <<<<<<<<<<<<<<
- *         self.c_rhs = self._rhs
+ *         self._data = data             # <<<<<<<<<<<<<<
+ *         self._indices = indices
+ *         self._indptr = indptr
+ */
+  __PYX_XDEC_MEMVIEW(&__pyx_v_self->_data, 0);
+  __PYX_INC_MEMVIEW(&__pyx_v_data, 0);
+  __pyx_v_self->_data = __pyx_v_data;
+
+  /* "tkwant/onebody/kernels.pyx":921
+ * 
+ *         self._data = data
+ *         self._indices = indices             # <<<<<<<<<<<<<<
+ *         self._indptr = indptr
  *         self.W = W
  */
-  __Pyx_INCREF(__pyx_v_params);
-  __Pyx_GIVEREF(__pyx_v_params);
-  __Pyx_GOTREF(__pyx_v_self->params);
-  __Pyx_DECREF(__pyx_v_self->params);
-  __pyx_v_self->params = __pyx_v_params;
-
-  /* "tkwant/onebody/kernels.pyx":878
- *         self.c_self = <void*> self
- *         self.params = params
- *         self.c_rhs = self._rhs             # <<<<<<<<<<<<<<
+  __PYX_XDEC_MEMVIEW(&__pyx_v_self->_indices, 0);
+  __PYX_INC_MEMVIEW(&__pyx_v_indices, 0);
+  __pyx_v_self->_indices = __pyx_v_indices;
+
+  /* "tkwant/onebody/kernels.pyx":922
+ *         self._data = data
+ *         self._indices = indices
+ *         self._indptr = indptr             # <<<<<<<<<<<<<<
  *         self.W = W
- *         self.size = H0.shape[0]
+ *         if psi_st is None:
  */
-  __pyx_t_1 = ((struct __pyx_vtabstruct_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self->__pyx_vtab)->_rhs;
-  __pyx_v_self->__pyx_base.c_rhs = __pyx_t_1;
-
-  /* "tkwant/onebody/kernels.pyx":879
- *         self.params = params
- *         self.c_rhs = self._rhs
+  __PYX_XDEC_MEMVIEW(&__pyx_v_self->_indptr, 0);
+  __PYX_INC_MEMVIEW(&__pyx_v_indptr, 0);
+  __pyx_v_self->_indptr = __pyx_v_indptr;
+
+  /* "tkwant/onebody/kernels.pyx":923
+ *         self._indices = indices
+ *         self._indptr = indptr
  *         self.W = W             # <<<<<<<<<<<<<<
- *         self.size = H0.shape[0]
- *         self._psi_st = psi_st
+ *         if psi_st is None:
+ *             self.psi_st = NULL
  */
   __Pyx_INCREF(__pyx_v_W);
   __Pyx_GIVEREF(__pyx_v_W);
   __Pyx_GOTREF(__pyx_v_self->W);
   __Pyx_DECREF(__pyx_v_self->W);
   __pyx_v_self->W = __pyx_v_W;
 
-  /* "tkwant/onebody/kernels.pyx":880
- *         self.c_rhs = self._rhs
- *         self.W = W
- *         self.size = H0.shape[0]             # <<<<<<<<<<<<<<
- *         self._psi_st = psi_st
- *         if psi_st is None:
- */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_H0, __pyx_n_s_shape); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 880, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_GetItemInt(__pyx_t_2, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 880, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_4 = __Pyx_PyInt_As_int(__pyx_t_3); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 880, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_v_self->__pyx_base.__pyx_base.size = __pyx_t_4;
-
-  /* "tkwant/onebody/kernels.pyx":881
+  /* "tkwant/onebody/kernels.pyx":924
+ *         self._indptr = indptr
  *         self.W = W
- *         self.size = H0.shape[0]
- *         self._psi_st = psi_st             # <<<<<<<<<<<<<<
- *         if psi_st is None:
- *             self.psi_st = NULL
- */
-  __PYX_XDEC_MEMVIEW(&__pyx_v_self->_psi_st, 0);
-  __PYX_INC_MEMVIEW(&__pyx_v_psi_st, 0);
-  __pyx_v_self->_psi_st = __pyx_v_psi_st;
-
-  /* "tkwant/onebody/kernels.pyx":882
- *         self.size = H0.shape[0]
- *         self._psi_st = psi_st
  *         if psi_st is None:             # <<<<<<<<<<<<<<
  *             self.psi_st = NULL
  *         else:
  */
-  __pyx_t_5 = ((((PyObject *) __pyx_v_psi_st.memview) == Py_None) != 0);
-  if (__pyx_t_5) {
+  __pyx_t_1 = ((((PyObject *) __pyx_v_psi_st.memview) == Py_None) != 0);
+  if (__pyx_t_1) {
 
-    /* "tkwant/onebody/kernels.pyx":883
- *         self._psi_st = psi_st
+    /* "tkwant/onebody/kernels.pyx":925
+ *         self.W = W
  *         if psi_st is None:
  *             self.psi_st = NULL             # <<<<<<<<<<<<<<
  *         else:
  *             self.psi_st = &psi_st[0]
  */
     __pyx_v_self->psi_st = NULL;
 
-    /* "tkwant/onebody/kernels.pyx":882
- *         self.size = H0.shape[0]
- *         self._psi_st = psi_st
+    /* "tkwant/onebody/kernels.pyx":924
+ *         self._indptr = indptr
+ *         self.W = W
  *         if psi_st is None:             # <<<<<<<<<<<<<<
  *             self.psi_st = NULL
  *         else:
  */
     goto __pyx_L3;
   }
 
-  /* "tkwant/onebody/kernels.pyx":885
+  /* "tkwant/onebody/kernels.pyx":927
  *             self.psi_st = NULL
  *         else:
  *             self.psi_st = &psi_st[0]             # <<<<<<<<<<<<<<
- *         if W is not None:
- *             self.center_size = self.W.size
+ *         self.size = size
+ *         self.center_size = center_size
  */
   /*else*/ {
-    __pyx_t_6 = 0;
-    __pyx_t_4 = -1;
-    if (__pyx_t_6 < 0) {
-      __pyx_t_6 += __pyx_v_psi_st.shape[0];
-      if (unlikely(__pyx_t_6 < 0)) __pyx_t_4 = 0;
-    } else if (unlikely(__pyx_t_6 >= __pyx_v_psi_st.shape[0])) __pyx_t_4 = 0;
-    if (unlikely(__pyx_t_4 != -1)) {
-      __Pyx_RaiseBufferIndexError(__pyx_t_4);
-      __PYX_ERR(0, 885, __pyx_L1_error)
+    __pyx_t_2 = 0;
+    __pyx_t_3 = -1;
+    if (__pyx_t_2 < 0) {
+      __pyx_t_2 += __pyx_v_psi_st.shape[0];
+      if (unlikely(__pyx_t_2 < 0)) __pyx_t_3 = 0;
+    } else if (unlikely(__pyx_t_2 >= __pyx_v_psi_st.shape[0])) __pyx_t_3 = 0;
+    if (unlikely(__pyx_t_3 != -1)) {
+      __Pyx_RaiseBufferIndexError(__pyx_t_3);
+      __PYX_ERR(0, 927, __pyx_L1_error)
     }
-    __pyx_v_self->psi_st = (&(*((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_psi_st.data + __pyx_t_6 * __pyx_v_psi_st.strides[0]) ))));
+    __pyx_v_self->psi_st = (&(*((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_psi_st.data + __pyx_t_2 * __pyx_v_psi_st.strides[0]) ))));
   }
   __pyx_L3:;
 
-  /* "tkwant/onebody/kernels.pyx":886
+  /* "tkwant/onebody/kernels.pyx":928
  *         else:
  *             self.psi_st = &psi_st[0]
- *         if W is not None:             # <<<<<<<<<<<<<<
- *             self.center_size = self.W.size
- *         else:
- */
-  __pyx_t_5 = (__pyx_v_W != Py_None);
-  __pyx_t_7 = (__pyx_t_5 != 0);
-  if (__pyx_t_7) {
-
-    /* "tkwant/onebody/kernels.pyx":887
- *             self.psi_st = &psi_st[0]
- *         if W is not None:
- *             self.center_size = self.W.size             # <<<<<<<<<<<<<<
- *         else:
- *             self.center_size = self.size
+ *         self.size = size             # <<<<<<<<<<<<<<
+ *         self.center_size = center_size
+ * 
  */
-    __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->W, __pyx_n_s_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 887, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_4 = __Pyx_PyInt_As_int(__pyx_t_3); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 887, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __pyx_v_self->center_size = __pyx_t_4;
+  __pyx_v_self->size = __pyx_v_size;
 
-    /* "tkwant/onebody/kernels.pyx":886
- *         else:
+  /* "tkwant/onebody/kernels.pyx":929
  *             self.psi_st = &psi_st[0]
- *         if W is not None:             # <<<<<<<<<<<<<<
- *             self.center_size = self.W.size
- *         else:
- */
-    goto __pyx_L4;
-  }
-
-  /* "tkwant/onebody/kernels.pyx":889
- *             self.center_size = self.W.size
- *         else:
- *             self.center_size = self.size             # <<<<<<<<<<<<<<
- *         self.H0 = _CSRMatrix(H0)
- *         self._temp = np.empty((self.center_size,), dtype=complex)
- */
-  /*else*/ {
-    __pyx_t_4 = __pyx_v_self->__pyx_base.__pyx_base.size;
-    __pyx_v_self->center_size = __pyx_t_4;
-  }
-  __pyx_L4:;
-
-  /* "tkwant/onebody/kernels.pyx":890
- *         else:
- *             self.center_size = self.size
- *         self.H0 = _CSRMatrix(H0)             # <<<<<<<<<<<<<<
- *         self._temp = np.empty((self.center_size,), dtype=complex)
- *         self.temp = &self._temp[0]
- */
-  __pyx_t_3 = __Pyx_PyObject_CallOneArg(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels__CSRMatrix), __pyx_v_H0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 890, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_GIVEREF(__pyx_t_3);
-  __Pyx_GOTREF(__pyx_v_self->H0);
-  __Pyx_DECREF(((PyObject *)__pyx_v_self->H0));
-  __pyx_v_self->H0 = ((struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *)__pyx_t_3);
-  __pyx_t_3 = 0;
-
-  /* "tkwant/onebody/kernels.pyx":891
- *             self.center_size = self.size
- *         self.H0 = _CSRMatrix(H0)
- *         self._temp = np.empty((self.center_size,), dtype=complex)             # <<<<<<<<<<<<<<
- *         self.temp = &self._temp[0]
+ *         self.size = size
+ *         self.center_size = center_size             # <<<<<<<<<<<<<<
  * 
+ *         # the id of the temp array is not the same any more due to argument complex[:] temp
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_np); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 891, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 891, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_self->center_size); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 891, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_8 = PyTuple_New(1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 891, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_8);
-  __Pyx_GIVEREF(__pyx_t_3);
-  PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_3);
-  __pyx_t_3 = 0;
-  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 891, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_GIVEREF(__pyx_t_8);
-  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_8);
-  __pyx_t_8 = 0;
-  __pyx_t_8 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 891, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_8);
-  if (PyDict_SetItem(__pyx_t_8, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 891, __pyx_L1_error)
-  __pyx_t_9 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(0, 891, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_9);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-  __pyx_t_10 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(__pyx_t_9, PyBUF_WRITABLE); if (unlikely(!__pyx_t_10.memview)) __PYX_ERR(0, 891, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
-  __PYX_XDEC_MEMVIEW(&__pyx_v_self->_temp, 0);
-  __pyx_v_self->_temp = __pyx_t_10;
-  __pyx_t_10.memview = NULL;
-  __pyx_t_10.data = NULL;
+  __pyx_v_self->center_size = __pyx_v_center_size;
 
-  /* "tkwant/onebody/kernels.pyx":892
- *         self.H0 = _CSRMatrix(H0)
- *         self._temp = np.empty((self.center_size,), dtype=complex)
- *         self.temp = &self._temp[0]             # <<<<<<<<<<<<<<
+  /* "tkwant/onebody/kernels.pyx":935
+ *         #exit(0)
+ * 
+ *         self.temp = &temp[0]             # <<<<<<<<<<<<<<
+ * 
  * 
- *     # RHS implemented as a static method to conform to the solver interface.
  */
-  if (unlikely(!__pyx_v_self->_temp.memview)) {PyErr_SetString(PyExc_AttributeError,"Memoryview is not initialized");__PYX_ERR(0, 892, __pyx_L1_error)}
-  __pyx_t_11 = 0;
-  __pyx_t_4 = -1;
-  if (__pyx_t_11 < 0) {
-    __pyx_t_11 += __pyx_v_self->_temp.shape[0];
-    if (unlikely(__pyx_t_11 < 0)) __pyx_t_4 = 0;
-  } else if (unlikely(__pyx_t_11 >= __pyx_v_self->_temp.shape[0])) __pyx_t_4 = 0;
-  if (unlikely(__pyx_t_4 != -1)) {
-    __Pyx_RaiseBufferIndexError(__pyx_t_4);
-    __PYX_ERR(0, 892, __pyx_L1_error)
-  }
-  __pyx_v_self->temp = (&(*((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_self->_temp.data + __pyx_t_11 * __pyx_v_self->_temp.strides[0]) ))));
-
-  /* "tkwant/onebody/kernels.pyx":875
- *         self.params = params
- * 
- *     def __cinit__(self, H0, W, params, complex[:] psi_st=None):             # <<<<<<<<<<<<<<
- *         self.c_self = <void*> self
- *         self.params = params
+  __pyx_t_2 = 0;
+  __pyx_t_3 = -1;
+  if (__pyx_t_2 < 0) {
+    __pyx_t_2 += __pyx_v_temp.shape[0];
+    if (unlikely(__pyx_t_2 < 0)) __pyx_t_3 = 0;
+  } else if (unlikely(__pyx_t_2 >= __pyx_v_temp.shape[0])) __pyx_t_3 = 0;
+  if (unlikely(__pyx_t_3 != -1)) {
+    __Pyx_RaiseBufferIndexError(__pyx_t_3);
+    __PYX_ERR(0, 935, __pyx_L1_error)
+  }
+  __pyx_v_self->temp = (&(*((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_temp.data + __pyx_t_2 * __pyx_v_temp.strides[0]) ))));
+
+  /* "tkwant/onebody/kernels.pyx":917
+ * 
+ *     """Calculate the right-hand-side of the time-dependent Schrdinger equation."""
+ *     def __cinit__(self, int[:] indptr, int[:] indices, complex[:] data, W, complex[:] psi_st,             # <<<<<<<<<<<<<<
+ *                   int size, int center_size, complex[:] temp):
+ * 
  */
 
   /* function exit code */
   __pyx_r = 0;
   goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_XDECREF(__pyx_t_8);
-  __Pyx_XDECREF(__pyx_t_9);
-  __PYX_XDEC_MEMVIEW(&__pyx_t_10, 1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHSc.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
+  __PYX_XDEC_MEMVIEW(&__pyx_v_indptr, 1);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_indices, 1);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_data, 1);
   __PYX_XDEC_MEMVIEW(&__pyx_v_psi_st, 1);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_temp, 1);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/kernels.pyx":898
+/* "tkwant/onebody/kernels.pyx":941
  *     @cython.boundscheck(False)
  *     @cython.wraparound(False)
- *     cdef void _rhs(const void *_self, const complex *psi, complex *dpsidt,             # <<<<<<<<<<<<<<
- *                    double time) except *:
- *         cdef Simple self = <Simple>_self
+ *     def __call__(self, const complex[::1] psi, complex[::1] dpsidt, double time):             # <<<<<<<<<<<<<<
+ * 
+ *         cdef int *indptr
  */
 
-static void __pyx_f_6tkwant_7onebody_7kernels_6Simple__rhs(void const *__pyx_v__self, __pyx_t_double_complex const *__pyx_v_psi, __pyx_t_double_complex *__pyx_v_dpsidt, double __pyx_v_time) {
-  struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self = 0;
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_5__call__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_5__call__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  __Pyx_memviewslice __pyx_v_psi = { 0, 0, { 0 }, { 0 }, { 0 } };
+  __Pyx_memviewslice __pyx_v_dpsidt = { 0, 0, { 0 }, { 0 }, { 0 } };
+  double __pyx_v_time;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__call__ (wrapper)", 0);
+  {
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_psi,&__pyx_n_s_dpsidt,&__pyx_n_s_time,0};
+    PyObject* values[3] = {0,0,0};
+    if (unlikely(__pyx_kwds)) {
+      Py_ssize_t kw_args;
+      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
+      switch (pos_args) {
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = PyDict_Size(__pyx_kwds);
+      switch (pos_args) {
+        case  0:
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi)) != 0)) kw_args--;
+        else goto __pyx_L5_argtuple_error;
+        CYTHON_FALLTHROUGH;
+        case  1:
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_dpsidt)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__call__", 1, 3, 3, 1); __PYX_ERR(0, 941, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  2:
+        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__call__", 1, 3, 3, 2); __PYX_ERR(0, 941, __pyx_L3_error)
+        }
+      }
+      if (unlikely(kw_args > 0)) {
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__call__") < 0)) __PYX_ERR(0, 941, __pyx_L3_error)
+      }
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
+      goto __pyx_L5_argtuple_error;
+    } else {
+      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+    }
+    __pyx_v_psi = __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex__const__(values[0], 0); if (unlikely(!__pyx_v_psi.memview)) __PYX_ERR(0, 941, __pyx_L3_error)
+    __pyx_v_dpsidt = __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex(values[1], PyBUF_WRITABLE); if (unlikely(!__pyx_v_dpsidt.memview)) __PYX_ERR(0, 941, __pyx_L3_error)
+    __pyx_v_time = __pyx_PyFloat_AsDouble(values[2]); if (unlikely((__pyx_v_time == (double)-1) && PyErr_Occurred())) __PYX_ERR(0, 941, __pyx_L3_error)
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("__call__", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 941, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHSc.__call__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc_4__call__(((struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *)__pyx_v_self), __pyx_v_psi, __pyx_v_dpsidt, __pyx_v_time);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc_4__call__(struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *__pyx_v_self, __Pyx_memviewslice __pyx_v_psi, __Pyx_memviewslice __pyx_v_dpsidt, double __pyx_v_time) {
+  int *__pyx_v_indptr;
+  int *__pyx_v_indices;
+  __pyx_t_double_complex *__pyx_v_data;
   unsigned int __pyx_v_i;
   PyObject *__pyx_v_exept = NULL;
+  PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
+  Py_ssize_t __pyx_t_1;
   int __pyx_t_2;
   int __pyx_t_3;
   unsigned int __pyx_t_4;
-  PyObject *__pyx_t_5 = NULL;
-  int __pyx_t_6;
+  size_t __pyx_t_5;
+  Py_ssize_t __pyx_t_6;
   PyObject *__pyx_t_7 = NULL;
-  PyObject *__pyx_t_8 = NULL;
+  int __pyx_t_8;
   PyObject *__pyx_t_9 = NULL;
-  struct __pyx_array_obj *__pyx_t_10 = NULL;
+  PyObject *__pyx_t_10 = NULL;
   PyObject *__pyx_t_11 = NULL;
   PyObject *__pyx_t_12 = NULL;
-  PyObject *__pyx_t_13 = NULL;
-  int __pyx_t_14;
-  char const *__pyx_t_15;
+  __pyx_t_double_complex const *__pyx_t_13;
+  struct __pyx_array_obj *__pyx_t_14 = NULL;
+  PyObject *__pyx_t_15 = NULL;
   PyObject *__pyx_t_16 = NULL;
-  PyObject *__pyx_t_17 = NULL;
+  __pyx_t_double_complex *__pyx_t_17;
   PyObject *__pyx_t_18 = NULL;
-  PyObject *__pyx_t_19 = NULL;
-  PyObject *__pyx_t_20 = NULL;
+  int __pyx_t_19;
+  char const *__pyx_t_20;
   PyObject *__pyx_t_21 = NULL;
-  __pyx_t_double_complex *__pyx_t_22;
-  char const *__pyx_t_23;
-  __Pyx_RefNannySetupContext("_rhs", 0);
-
-  /* "tkwant/onebody/kernels.pyx":900
- *     cdef void _rhs(const void *_self, const complex *psi, complex *dpsidt,
- *                    double time) except *:
- *         cdef Simple self = <Simple>_self             # <<<<<<<<<<<<<<
+  PyObject *__pyx_t_22 = NULL;
+  PyObject *__pyx_t_23 = NULL;
+  PyObject *__pyx_t_24 = NULL;
+  PyObject *__pyx_t_25 = NULL;
+  PyObject *__pyx_t_26 = NULL;
+  char const *__pyx_t_27;
+  size_t __pyx_t_28;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__call__", 0);
+
+  /* "tkwant/onebody/kernels.pyx":947
+ *         cdef complex *data
+ * 
+ *         data = &self._data[0]             # <<<<<<<<<<<<<<
+ *         indices = &self._indices[0]
+ *         indptr = &self._indptr[0]
+ */
+  if (unlikely(!__pyx_v_self->_data.memview)) {PyErr_SetString(PyExc_AttributeError,"Memoryview is not initialized");__PYX_ERR(0, 947, __pyx_L1_error)}
+  __pyx_t_1 = 0;
+  __pyx_v_data = (&(*((__pyx_t_double_complex *) ( /* dim=0 */ (__pyx_v_self->_data.data + __pyx_t_1 * __pyx_v_self->_data.strides[0]) ))));
+
+  /* "tkwant/onebody/kernels.pyx":948
+ * 
+ *         data = &self._data[0]
+ *         indices = &self._indices[0]             # <<<<<<<<<<<<<<
+ *         indptr = &self._indptr[0]
+ * 
+ */
+  if (unlikely(!__pyx_v_self->_indices.memview)) {PyErr_SetString(PyExc_AttributeError,"Memoryview is not initialized");__PYX_ERR(0, 948, __pyx_L1_error)}
+  __pyx_t_1 = 0;
+  __pyx_v_indices = (&(*((int *) ( /* dim=0 */ (__pyx_v_self->_indices.data + __pyx_t_1 * __pyx_v_self->_indices.strides[0]) ))));
+
+  /* "tkwant/onebody/kernels.pyx":949
+ *         data = &self._data[0]
+ *         indices = &self._indices[0]
+ *         indptr = &self._indptr[0]             # <<<<<<<<<<<<<<
+ * 
  *         cdef unsigned i
- *         for i in range(self.size):
  */
-  __pyx_t_1 = ((PyObject *)__pyx_v__self);
-  __Pyx_INCREF(__pyx_t_1);
-  __pyx_v_self = ((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_t_1);
+  if (unlikely(!__pyx_v_self->_indptr.memview)) {PyErr_SetString(PyExc_AttributeError,"Memoryview is not initialized");__PYX_ERR(0, 949, __pyx_L1_error)}
   __pyx_t_1 = 0;
+  __pyx_v_indptr = (&(*((int *) ( /* dim=0 */ (__pyx_v_self->_indptr.data + __pyx_t_1 * __pyx_v_self->_indptr.strides[0]) ))));
 
-  /* "tkwant/onebody/kernels.pyx":902
- *         cdef Simple self = <Simple>_self
+  /* "tkwant/onebody/kernels.pyx":952
+ * 
  *         cdef unsigned i
  *         for i in range(self.size):             # <<<<<<<<<<<<<<
  *             dpsidt[i] = 0
- *         ### H0 @ psi -> dpsidt
+ * 
  */
-  __pyx_t_2 = __pyx_v_self->__pyx_base.__pyx_base.size;
+  __pyx_t_2 = __pyx_v_self->size;
   __pyx_t_3 = __pyx_t_2;
   for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
     __pyx_v_i = __pyx_t_4;
 
-    /* "tkwant/onebody/kernels.pyx":903
+    /* "tkwant/onebody/kernels.pyx":953
  *         cdef unsigned i
  *         for i in range(self.size):
  *             dpsidt[i] = 0             # <<<<<<<<<<<<<<
+ * 
  *         ### H0 @ psi -> dpsidt
- *         _csr_spmv(self.H0, psi, dpsidt)
  */
-    (__pyx_v_dpsidt[__pyx_v_i]) = __pyx_t_double_complex_from_parts(0, 0);
+    __pyx_t_5 = __pyx_v_i;
+    *((__pyx_t_double_complex *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex *) __pyx_v_dpsidt.data) + __pyx_t_5)) )) = __pyx_t_double_complex_from_parts(0, 0);
   }
 
-  /* "tkwant/onebody/kernels.pyx":905
- *             dpsidt[i] = 0
+  /* "tkwant/onebody/kernels.pyx":956
+ * 
  *         ### H0 @ psi -> dpsidt
- *         _csr_spmv(self.H0, psi, dpsidt)             # <<<<<<<<<<<<<<
- *         ### W(t) @ psi + dpsidt -> dpsidt
- *         if self.psi_st == NULL:
+ *         _csr_spmv_ptr(self.size, indptr, indices, data, &psi[0], &dpsidt[0])             # <<<<<<<<<<<<<<
+ * 
+ * 
  */
-  __pyx_t_1 = ((PyObject *)__pyx_v_self->H0);
-  __Pyx_INCREF(__pyx_t_1);
-  __pyx_t_5 = __pyx_f_6tkwant_7onebody_7kernels__csr_spmv(((struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *)__pyx_t_1), __pyx_v_psi, __pyx_v_dpsidt); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 905, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+  __pyx_t_1 = 0;
+  __pyx_t_6 = 0;
+  __pyx_t_7 = __pyx_f_6tkwant_7onebody_7kernels__csr_spmv_ptr(__pyx_v_self->size, __pyx_v_indptr, __pyx_v_indices, __pyx_v_data, (&(*((__pyx_t_double_complex const  *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex const  *) __pyx_v_psi.data) + __pyx_t_1)) )))), (&(*((__pyx_t_double_complex *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex *) __pyx_v_dpsidt.data) + __pyx_t_6)) ))))); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 956, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_7);
+  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":907
- *         _csr_spmv(self.H0, psi, dpsidt)
+  /* "tkwant/onebody/kernels.pyx":960
+ * 
  *         ### W(t) @ psi + dpsidt -> dpsidt
  *         if self.psi_st == NULL:             # <<<<<<<<<<<<<<
  *             try:
- *                 self.W.apply(time, <complex[:self.center_size]>psi,
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],
  */
-  __pyx_t_6 = ((__pyx_v_self->psi_st == NULL) != 0);
-  if (__pyx_t_6) {
+  __pyx_t_8 = ((__pyx_v_self->psi_st == NULL) != 0);
+  if (__pyx_t_8) {
 
-    /* "tkwant/onebody/kernels.pyx":908
+    /* "tkwant/onebody/kernels.pyx":961
  *         ### W(t) @ psi + dpsidt -> dpsidt
  *         if self.psi_st == NULL:
  *             try:             # <<<<<<<<<<<<<<
- *                 self.W.apply(time, <complex[:self.center_size]>psi,
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  */
     {
       __Pyx_PyThreadState_declare
       __Pyx_PyThreadState_assign
-      __Pyx_ExceptionSave(&__pyx_t_7, &__pyx_t_8, &__pyx_t_9);
-      __Pyx_XGOTREF(__pyx_t_7);
-      __Pyx_XGOTREF(__pyx_t_8);
+      __Pyx_ExceptionSave(&__pyx_t_9, &__pyx_t_10, &__pyx_t_11);
       __Pyx_XGOTREF(__pyx_t_9);
+      __Pyx_XGOTREF(__pyx_t_10);
+      __Pyx_XGOTREF(__pyx_t_11);
       /*try:*/ {
 
-        /* "tkwant/onebody/kernels.pyx":909
+        /* "tkwant/onebody/kernels.pyx":962
  *         if self.psi_st == NULL:
  *             try:
- *                 self.W.apply(time, <complex[:self.center_size]>psi,             # <<<<<<<<<<<<<<
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],             # <<<<<<<<<<<<<<
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:
  */
-        __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->W, __pyx_n_s_apply); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 909, __pyx_L6_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __pyx_t_1 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 909, __pyx_L6_error)
-        __Pyx_GOTREF(__pyx_t_1);
-        if (unlikely(!__pyx_v_self)) { __Pyx_RaiseUnboundLocalError("self"); __PYX_ERR(0, 909, __pyx_L6_error) }
-        if (!__pyx_v_psi) {
+        __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->W, __pyx_n_s_apply); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 962, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_7);
+        __pyx_t_12 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 962, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_12);
+        __pyx_t_6 = 0;
+        __pyx_t_13 = (&(*((__pyx_t_double_complex const  *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex const  *) __pyx_v_psi.data) + __pyx_t_6)) ))));
+        if (!__pyx_t_13) {
           PyErr_SetString(PyExc_ValueError,"Cannot create cython.array from NULL pointer");
-          __PYX_ERR(0, 909, __pyx_L6_error)
+          __PYX_ERR(0, 962, __pyx_L6_error)
         }
-        __pyx_t_12 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex);
-        __pyx_t_11 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_self->center_size));
-        if (unlikely(!__pyx_t_12 || !__pyx_t_11 || !PyBytes_AsString(__pyx_t_12))) __PYX_ERR(0, 909, __pyx_L6_error)
-        __Pyx_GOTREF(__pyx_t_12);
-        __Pyx_GOTREF(__pyx_t_11);
-        __pyx_t_10 = __pyx_array_new(__pyx_t_11, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_12), (char *) "c", (char *) __pyx_v_psi);
-        if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 909, __pyx_L6_error)
-        __Pyx_GOTREF(__pyx_t_10);
-        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
-        __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
-        __pyx_t_12 = PyTuple_New(2); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 909, __pyx_L6_error)
-        __Pyx_GOTREF(__pyx_t_12);
-        __Pyx_GIVEREF(__pyx_t_1);
-        PyTuple_SET_ITEM(__pyx_t_12, 0, __pyx_t_1);
-        __Pyx_GIVEREF(((PyObject *)__pyx_t_10));
-        PyTuple_SET_ITEM(__pyx_t_12, 1, ((PyObject *)__pyx_t_10));
-        __pyx_t_1 = 0;
-        __pyx_t_10 = 0;
+        __pyx_t_16 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 962, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_16);
+        __pyx_t_15 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_self->center_size)); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 962, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_15);
+        __pyx_t_14 = __pyx_array_new(__pyx_t_15, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_16), (char *) "c", (char *) __pyx_t_13);
+        if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 962, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_14);
+        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
+        __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
+        __pyx_t_16 = PyTuple_New(2); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 962, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_16);
+        __Pyx_GIVEREF(__pyx_t_12);
+        PyTuple_SET_ITEM(__pyx_t_16, 0, __pyx_t_12);
+        __Pyx_GIVEREF(((PyObject *)__pyx_t_14));
+        PyTuple_SET_ITEM(__pyx_t_16, 1, ((PyObject *)__pyx_t_14));
+        __pyx_t_12 = 0;
+        __pyx_t_14 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":910
+        /* "tkwant/onebody/kernels.pyx":963
  *             try:
- *                 self.W.apply(time, <complex[:self.center_size]>psi,
- *                              out=<complex[:self.center_size]>dpsidt)             # <<<<<<<<<<<<<<
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],
+ *                              out=<complex[:self.center_size]>&dpsidt[0])             # <<<<<<<<<<<<<<
  *             except Exception as exept:
  *                 if self.W is None:
  */
-        __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 910, __pyx_L6_error)
-        __Pyx_GOTREF(__pyx_t_1);
-        if (unlikely(!__pyx_v_self)) { __Pyx_RaiseUnboundLocalError("self"); __PYX_ERR(0, 910, __pyx_L6_error) }
-        if (!__pyx_v_dpsidt) {
+        __pyx_t_12 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 963, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_12);
+        __pyx_t_6 = 0;
+        __pyx_t_17 = (&(*((__pyx_t_double_complex *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex *) __pyx_v_dpsidt.data) + __pyx_t_6)) ))));
+        if (!__pyx_t_17) {
           PyErr_SetString(PyExc_ValueError,"Cannot create cython.array from NULL pointer");
-          __PYX_ERR(0, 910, __pyx_L6_error)
+          __PYX_ERR(0, 963, __pyx_L6_error)
         }
-        __pyx_t_13 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex);
-        __pyx_t_11 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_self->center_size));
-        if (unlikely(!__pyx_t_13 || !__pyx_t_11 || !PyBytes_AsString(__pyx_t_13))) __PYX_ERR(0, 910, __pyx_L6_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __Pyx_GOTREF(__pyx_t_11);
-        __pyx_t_10 = __pyx_array_new(__pyx_t_11, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_13), (char *) "c", (char *) __pyx_v_dpsidt);
-        if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 910, __pyx_L6_error)
-        __Pyx_GOTREF(__pyx_t_10);
-        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
-        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-        if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_out, ((PyObject *)__pyx_t_10)) < 0) __PYX_ERR(0, 910, __pyx_L6_error)
-        __Pyx_DECREF(((PyObject *)__pyx_t_10)); __pyx_t_10 = 0;
+        __pyx_t_18 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex); if (unlikely(!__pyx_t_18)) __PYX_ERR(0, 963, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_18);
+        __pyx_t_15 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_self->center_size)); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 963, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_15);
+        __pyx_t_14 = __pyx_array_new(__pyx_t_15, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_18), (char *) "c", (char *) __pyx_t_17);
+        if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 963, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_14);
+        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
+        __Pyx_DECREF(__pyx_t_18); __pyx_t_18 = 0;
+        if (PyDict_SetItem(__pyx_t_12, __pyx_n_s_out, ((PyObject *)__pyx_t_14)) < 0) __PYX_ERR(0, 963, __pyx_L6_error)
+        __Pyx_DECREF(((PyObject *)__pyx_t_14)); __pyx_t_14 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":909
+        /* "tkwant/onebody/kernels.pyx":962
  *         if self.psi_st == NULL:
  *             try:
- *                 self.W.apply(time, <complex[:self.center_size]>psi,             # <<<<<<<<<<<<<<
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],             # <<<<<<<<<<<<<<
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:
  */
-        __pyx_t_13 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_12, __pyx_t_1); if (unlikely(!__pyx_t_13)) __PYX_ERR(0, 909, __pyx_L6_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+        __pyx_t_18 = __Pyx_PyObject_Call(__pyx_t_7, __pyx_t_16, __pyx_t_12); if (unlikely(!__pyx_t_18)) __PYX_ERR(0, 962, __pyx_L6_error)
+        __Pyx_GOTREF(__pyx_t_18);
+        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+        __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
         __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
-        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
+        __Pyx_DECREF(__pyx_t_18); __pyx_t_18 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":908
+        /* "tkwant/onebody/kernels.pyx":961
  *         ### W(t) @ psi + dpsidt -> dpsidt
  *         if self.psi_st == NULL:
  *             try:             # <<<<<<<<<<<<<<
- *                 self.W.apply(time, <complex[:self.center_size]>psi,
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  */
       }
-      __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-      __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
       __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
+      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+      __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
       goto __pyx_L11_try_end;
       __pyx_L6_error:;
-      __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
-      __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
       __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
-      __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_XDECREF(__pyx_t_13); __pyx_t_13 = 0;
-      __Pyx_XDECREF(((PyObject *)__pyx_t_10)); __pyx_t_10 = 0;
+      __Pyx_XDECREF(((PyObject *)__pyx_t_14)); __pyx_t_14 = 0;
+      __Pyx_XDECREF(__pyx_t_15); __pyx_t_15 = 0;
+      __Pyx_XDECREF(__pyx_t_16); __pyx_t_16 = 0;
+      __Pyx_XDECREF(__pyx_t_18); __pyx_t_18 = 0;
+      __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":911
- *                 self.W.apply(time, <complex[:self.center_size]>psi,
- *                              out=<complex[:self.center_size]>dpsidt)
+      /* "tkwant/onebody/kernels.pyx":964
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:             # <<<<<<<<<<<<<<
  *                 if self.W is None:
  *                     pass
  */
       __pyx_t_2 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
       if (__pyx_t_2) {
-        __Pyx_AddTraceback("tkwant.onebody.kernels.Simple._rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
-        if (__Pyx_GetException(&__pyx_t_13, &__pyx_t_1, &__pyx_t_12) < 0) __PYX_ERR(0, 911, __pyx_L8_except_error)
-        __Pyx_GOTREF(__pyx_t_13);
-        __Pyx_GOTREF(__pyx_t_1);
+        __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHSc.__call__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+        if (__Pyx_GetException(&__pyx_t_18, &__pyx_t_12, &__pyx_t_16) < 0) __PYX_ERR(0, 964, __pyx_L8_except_error)
+        __Pyx_GOTREF(__pyx_t_18);
         __Pyx_GOTREF(__pyx_t_12);
-        __Pyx_INCREF(__pyx_t_1);
-        __pyx_v_exept = __pyx_t_1;
+        __Pyx_GOTREF(__pyx_t_16);
+        __Pyx_INCREF(__pyx_t_12);
+        __pyx_v_exept = __pyx_t_12;
         /*try:*/ {
 
-          /* "tkwant/onebody/kernels.pyx":912
- *                              out=<complex[:self.center_size]>dpsidt)
+          /* "tkwant/onebody/kernels.pyx":965
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:
  *                 if self.W is None:             # <<<<<<<<<<<<<<
  *                     pass
  *                 else:
  */
-          __pyx_t_6 = (__pyx_v_self->W == Py_None);
-          __pyx_t_14 = (__pyx_t_6 != 0);
-          if (likely(__pyx_t_14)) {
+          __pyx_t_8 = (__pyx_v_self->W == Py_None);
+          __pyx_t_19 = (__pyx_t_8 != 0);
+          if (likely(__pyx_t_19)) {
             goto __pyx_L19;
           }
 
-          /* "tkwant/onebody/kernels.pyx":915
+          /* "tkwant/onebody/kernels.pyx":968
  *                     pass
  *                 else:
  *                     raise exept             # <<<<<<<<<<<<<<
  *         else:
  *             # we need to act on `temp = psi + psi_st`
  */
           /*else*/ {
             __Pyx_Raise(__pyx_v_exept, 0, 0, 0);
-            __PYX_ERR(0, 915, __pyx_L17_error)
+            __PYX_ERR(0, 968, __pyx_L17_error)
           }
           __pyx_L19:;
         }
 
-        /* "tkwant/onebody/kernels.pyx":911
- *                 self.W.apply(time, <complex[:self.center_size]>psi,
- *                              out=<complex[:self.center_size]>dpsidt)
+        /* "tkwant/onebody/kernels.pyx":964
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:             # <<<<<<<<<<<<<<
  *                 if self.W is None:
  *                     pass
  */
         /*finally:*/ {
           /*normal exit:*/{
             __Pyx_DECREF(__pyx_v_exept);
             __pyx_v_exept = NULL;
             goto __pyx_L18;
           }
           __pyx_L17_error:;
           /*exception exit:*/{
             __Pyx_PyThreadState_declare
             __Pyx_PyThreadState_assign
-            __pyx_t_16 = 0; __pyx_t_17 = 0; __pyx_t_18 = 0; __pyx_t_19 = 0; __pyx_t_20 = 0; __pyx_t_21 = 0;
-            __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
-            __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-            __Pyx_XDECREF(((PyObject *)__pyx_t_10)); __pyx_t_10 = 0;
-            if (PY_MAJOR_VERSION >= 3) __Pyx_ExceptionSwap(&__pyx_t_19, &__pyx_t_20, &__pyx_t_21);
-            if ((PY_MAJOR_VERSION < 3) || unlikely(__Pyx_GetException(&__pyx_t_16, &__pyx_t_17, &__pyx_t_18) < 0)) __Pyx_ErrFetch(&__pyx_t_16, &__pyx_t_17, &__pyx_t_18);
-            __Pyx_XGOTREF(__pyx_t_16);
-            __Pyx_XGOTREF(__pyx_t_17);
-            __Pyx_XGOTREF(__pyx_t_18);
-            __Pyx_XGOTREF(__pyx_t_19);
-            __Pyx_XGOTREF(__pyx_t_20);
+            __pyx_t_21 = 0; __pyx_t_22 = 0; __pyx_t_23 = 0; __pyx_t_24 = 0; __pyx_t_25 = 0; __pyx_t_26 = 0;
+            __Pyx_XDECREF(((PyObject *)__pyx_t_14)); __pyx_t_14 = 0;
+            __Pyx_XDECREF(__pyx_t_15); __pyx_t_15 = 0;
+            __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+            if (PY_MAJOR_VERSION >= 3) __Pyx_ExceptionSwap(&__pyx_t_24, &__pyx_t_25, &__pyx_t_26);
+            if ((PY_MAJOR_VERSION < 3) || unlikely(__Pyx_GetException(&__pyx_t_21, &__pyx_t_22, &__pyx_t_23) < 0)) __Pyx_ErrFetch(&__pyx_t_21, &__pyx_t_22, &__pyx_t_23);
             __Pyx_XGOTREF(__pyx_t_21);
-            __pyx_t_2 = __pyx_lineno; __pyx_t_3 = __pyx_clineno; __pyx_t_15 = __pyx_filename;
+            __Pyx_XGOTREF(__pyx_t_22);
+            __Pyx_XGOTREF(__pyx_t_23);
+            __Pyx_XGOTREF(__pyx_t_24);
+            __Pyx_XGOTREF(__pyx_t_25);
+            __Pyx_XGOTREF(__pyx_t_26);
+            __pyx_t_2 = __pyx_lineno; __pyx_t_3 = __pyx_clineno; __pyx_t_20 = __pyx_filename;
             {
               __Pyx_DECREF(__pyx_v_exept);
               __pyx_v_exept = NULL;
             }
             if (PY_MAJOR_VERSION >= 3) {
-              __Pyx_XGIVEREF(__pyx_t_19);
-              __Pyx_XGIVEREF(__pyx_t_20);
-              __Pyx_XGIVEREF(__pyx_t_21);
-              __Pyx_ExceptionReset(__pyx_t_19, __pyx_t_20, __pyx_t_21);
+              __Pyx_XGIVEREF(__pyx_t_24);
+              __Pyx_XGIVEREF(__pyx_t_25);
+              __Pyx_XGIVEREF(__pyx_t_26);
+              __Pyx_ExceptionReset(__pyx_t_24, __pyx_t_25, __pyx_t_26);
             }
-            __Pyx_XGIVEREF(__pyx_t_16);
-            __Pyx_XGIVEREF(__pyx_t_17);
-            __Pyx_XGIVEREF(__pyx_t_18);
-            __Pyx_ErrRestore(__pyx_t_16, __pyx_t_17, __pyx_t_18);
-            __pyx_t_16 = 0; __pyx_t_17 = 0; __pyx_t_18 = 0; __pyx_t_19 = 0; __pyx_t_20 = 0; __pyx_t_21 = 0;
-            __pyx_lineno = __pyx_t_2; __pyx_clineno = __pyx_t_3; __pyx_filename = __pyx_t_15;
+            __Pyx_XGIVEREF(__pyx_t_21);
+            __Pyx_XGIVEREF(__pyx_t_22);
+            __Pyx_XGIVEREF(__pyx_t_23);
+            __Pyx_ErrRestore(__pyx_t_21, __pyx_t_22, __pyx_t_23);
+            __pyx_t_21 = 0; __pyx_t_22 = 0; __pyx_t_23 = 0; __pyx_t_24 = 0; __pyx_t_25 = 0; __pyx_t_26 = 0;
+            __pyx_lineno = __pyx_t_2; __pyx_clineno = __pyx_t_3; __pyx_filename = __pyx_t_20;
             goto __pyx_L8_except_error;
           }
           __pyx_L18:;
         }
-        __Pyx_XDECREF(__pyx_t_13); __pyx_t_13 = 0;
-        __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
+        __Pyx_XDECREF(__pyx_t_18); __pyx_t_18 = 0;
         __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
+        __Pyx_XDECREF(__pyx_t_16); __pyx_t_16 = 0;
         goto __pyx_L7_exception_handled;
       }
       goto __pyx_L8_except_error;
       __pyx_L8_except_error:;
 
-      /* "tkwant/onebody/kernels.pyx":908
+      /* "tkwant/onebody/kernels.pyx":961
  *         ### W(t) @ psi + dpsidt -> dpsidt
  *         if self.psi_st == NULL:
  *             try:             # <<<<<<<<<<<<<<
- *                 self.W.apply(time, <complex[:self.center_size]>psi,
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  */
-      __Pyx_XGIVEREF(__pyx_t_7);
-      __Pyx_XGIVEREF(__pyx_t_8);
       __Pyx_XGIVEREF(__pyx_t_9);
-      __Pyx_ExceptionReset(__pyx_t_7, __pyx_t_8, __pyx_t_9);
+      __Pyx_XGIVEREF(__pyx_t_10);
+      __Pyx_XGIVEREF(__pyx_t_11);
+      __Pyx_ExceptionReset(__pyx_t_9, __pyx_t_10, __pyx_t_11);
       goto __pyx_L1_error;
       __pyx_L7_exception_handled:;
-      __Pyx_XGIVEREF(__pyx_t_7);
-      __Pyx_XGIVEREF(__pyx_t_8);
       __Pyx_XGIVEREF(__pyx_t_9);
-      __Pyx_ExceptionReset(__pyx_t_7, __pyx_t_8, __pyx_t_9);
+      __Pyx_XGIVEREF(__pyx_t_10);
+      __Pyx_XGIVEREF(__pyx_t_11);
+      __Pyx_ExceptionReset(__pyx_t_9, __pyx_t_10, __pyx_t_11);
       __pyx_L11_try_end:;
     }
 
-    /* "tkwant/onebody/kernels.pyx":907
- *         _csr_spmv(self.H0, psi, dpsidt)
+    /* "tkwant/onebody/kernels.pyx":960
+ * 
  *         ### W(t) @ psi + dpsidt -> dpsidt
  *         if self.psi_st == NULL:             # <<<<<<<<<<<<<<
  *             try:
- *                 self.W.apply(time, <complex[:self.center_size]>psi,
+ *                 self.W.apply(time, <complex[:self.center_size]>&psi[0],
  */
     goto __pyx_L5;
   }
 
-  /* "tkwant/onebody/kernels.pyx":919
+  /* "tkwant/onebody/kernels.pyx":972
  *             # we need to act on `temp = psi + psi_st`
  *             # use pre-allocated storage
  *             for i in range(self.center_size):             # <<<<<<<<<<<<<<
  *                 self.temp[i] = psi[i] + self.psi_st[i]
  *             try:
  */
   /*else*/ {
     __pyx_t_3 = __pyx_v_self->center_size;
     __pyx_t_2 = __pyx_t_3;
     for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_2; __pyx_t_4+=1) {
       __pyx_v_i = __pyx_t_4;
 
-      /* "tkwant/onebody/kernels.pyx":920
+      /* "tkwant/onebody/kernels.pyx":973
  *             # use pre-allocated storage
  *             for i in range(self.center_size):
  *                 self.temp[i] = psi[i] + self.psi_st[i]             # <<<<<<<<<<<<<<
  *             try:
  *                 self.W.apply(time, <complex[:self.center_size]>self.temp,
  */
-      (__pyx_v_self->temp[__pyx_v_i]) = __Pyx_c_sum_double((__pyx_v_psi[__pyx_v_i]), (__pyx_v_self->psi_st[__pyx_v_i]));
+      __pyx_t_5 = __pyx_v_i;
+      (__pyx_v_self->temp[__pyx_v_i]) = __Pyx_c_sum_double((*((__pyx_t_double_complex const  *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex const  *) __pyx_v_psi.data) + __pyx_t_5)) ))), (__pyx_v_self->psi_st[__pyx_v_i]));
     }
 
-    /* "tkwant/onebody/kernels.pyx":921
+    /* "tkwant/onebody/kernels.pyx":974
  *             for i in range(self.center_size):
  *                 self.temp[i] = psi[i] + self.psi_st[i]
  *             try:             # <<<<<<<<<<<<<<
  *                 self.W.apply(time, <complex[:self.center_size]>self.temp,
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  */
     {
       __Pyx_PyThreadState_declare
       __Pyx_PyThreadState_assign
-      __Pyx_ExceptionSave(&__pyx_t_9, &__pyx_t_8, &__pyx_t_7);
+      __Pyx_ExceptionSave(&__pyx_t_11, &__pyx_t_10, &__pyx_t_9);
+      __Pyx_XGOTREF(__pyx_t_11);
+      __Pyx_XGOTREF(__pyx_t_10);
       __Pyx_XGOTREF(__pyx_t_9);
-      __Pyx_XGOTREF(__pyx_t_8);
-      __Pyx_XGOTREF(__pyx_t_7);
       /*try:*/ {
 
-        /* "tkwant/onebody/kernels.pyx":922
+        /* "tkwant/onebody/kernels.pyx":975
  *                 self.temp[i] = psi[i] + self.psi_st[i]
  *             try:
  *                 self.W.apply(time, <complex[:self.center_size]>self.temp,             # <<<<<<<<<<<<<<
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:
  */
-        __pyx_t_12 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->W, __pyx_n_s_apply); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 922, __pyx_L26_error)
+        __pyx_t_16 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->W, __pyx_n_s_apply); if (unlikely(!__pyx_t_16)) __PYX_ERR(0, 975, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_16);
+        __pyx_t_12 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 975, __pyx_L26_error)
         __Pyx_GOTREF(__pyx_t_12);
-        __pyx_t_1 = PyFloat_FromDouble(__pyx_v_time); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 922, __pyx_L26_error)
-        __Pyx_GOTREF(__pyx_t_1);
-        __pyx_t_22 = __pyx_v_self->temp;
-        if (unlikely(!__pyx_v_self)) { __Pyx_RaiseUnboundLocalError("self"); __PYX_ERR(0, 922, __pyx_L26_error) }
-        if (!__pyx_t_22) {
+        __pyx_t_17 = __pyx_v_self->temp;
+        if (!__pyx_t_17) {
           PyErr_SetString(PyExc_ValueError,"Cannot create cython.array from NULL pointer");
-          __PYX_ERR(0, 922, __pyx_L26_error)
+          __PYX_ERR(0, 975, __pyx_L26_error)
         }
-        __pyx_t_5 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex);
-        __pyx_t_13 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_self->center_size));
-        if (unlikely(!__pyx_t_5 || !__pyx_t_13 || !PyBytes_AsString(__pyx_t_5))) __PYX_ERR(0, 922, __pyx_L26_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __Pyx_GOTREF(__pyx_t_13);
-        __pyx_t_10 = __pyx_array_new(__pyx_t_13, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_5), (char *) "c", (char *) __pyx_t_22);
-        if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 922, __pyx_L26_error)
-        __Pyx_GOTREF(__pyx_t_10);
-        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-        __pyx_t_5 = PyTuple_New(2); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 922, __pyx_L26_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __Pyx_GIVEREF(__pyx_t_1);
-        PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_1);
-        __Pyx_GIVEREF(((PyObject *)__pyx_t_10));
-        PyTuple_SET_ITEM(__pyx_t_5, 1, ((PyObject *)__pyx_t_10));
-        __pyx_t_1 = 0;
-        __pyx_t_10 = 0;
+        __pyx_t_7 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 975, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_7);
+        __pyx_t_18 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_self->center_size)); if (unlikely(!__pyx_t_18)) __PYX_ERR(0, 975, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_18);
+        __pyx_t_14 = __pyx_array_new(__pyx_t_18, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_7), (char *) "c", (char *) __pyx_t_17);
+        if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 975, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_14);
+        __Pyx_DECREF(__pyx_t_18); __pyx_t_18 = 0;
+        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+        __pyx_t_7 = PyTuple_New(2); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 975, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_7);
+        __Pyx_GIVEREF(__pyx_t_12);
+        PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_12);
+        __Pyx_GIVEREF(((PyObject *)__pyx_t_14));
+        PyTuple_SET_ITEM(__pyx_t_7, 1, ((PyObject *)__pyx_t_14));
+        __pyx_t_12 = 0;
+        __pyx_t_14 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":923
+        /* "tkwant/onebody/kernels.pyx":976
  *             try:
  *                 self.W.apply(time, <complex[:self.center_size]>self.temp,
- *                              out=<complex[:self.center_size]>dpsidt)             # <<<<<<<<<<<<<<
+ *                              out=<complex[:self.center_size]>&dpsidt[0])             # <<<<<<<<<<<<<<
  *             except Exception as exept:
  *                 if self.W is None:
  */
-        __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 923, __pyx_L26_error)
-        __Pyx_GOTREF(__pyx_t_1);
-        if (unlikely(!__pyx_v_self)) { __Pyx_RaiseUnboundLocalError("self"); __PYX_ERR(0, 923, __pyx_L26_error) }
-        if (!__pyx_v_dpsidt) {
+        __pyx_t_12 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_12)) __PYX_ERR(0, 976, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_12);
+        __pyx_t_6 = 0;
+        __pyx_t_17 = (&(*((__pyx_t_double_complex *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex *) __pyx_v_dpsidt.data) + __pyx_t_6)) ))));
+        if (!__pyx_t_17) {
           PyErr_SetString(PyExc_ValueError,"Cannot create cython.array from NULL pointer");
-          __PYX_ERR(0, 923, __pyx_L26_error)
+          __PYX_ERR(0, 976, __pyx_L26_error)
         }
-        __pyx_t_11 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex);
-        __pyx_t_13 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_self->center_size));
-        if (unlikely(!__pyx_t_11 || !__pyx_t_13 || !PyBytes_AsString(__pyx_t_11))) __PYX_ERR(0, 923, __pyx_L26_error)
-        __Pyx_GOTREF(__pyx_t_11);
-        __Pyx_GOTREF(__pyx_t_13);
-        __pyx_t_10 = __pyx_array_new(__pyx_t_13, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_11), (char *) "c", (char *) __pyx_v_dpsidt);
-        if (unlikely(!__pyx_t_10)) __PYX_ERR(0, 923, __pyx_L26_error)
-        __Pyx_GOTREF(__pyx_t_10);
-        __Pyx_DECREF(__pyx_t_13); __pyx_t_13 = 0;
-        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
-        if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_out, ((PyObject *)__pyx_t_10)) < 0) __PYX_ERR(0, 923, __pyx_L26_error)
-        __Pyx_DECREF(((PyObject *)__pyx_t_10)); __pyx_t_10 = 0;
+        __pyx_t_15 = __pyx_format_from_typeinfo(&__Pyx_TypeInfo___pyx_t_double_complex); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 976, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_15);
+        __pyx_t_18 = Py_BuildValue((char*) "("  __PYX_BUILD_PY_SSIZE_T  ")", ((Py_ssize_t)__pyx_v_self->center_size)); if (unlikely(!__pyx_t_18)) __PYX_ERR(0, 976, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_18);
+        __pyx_t_14 = __pyx_array_new(__pyx_t_18, sizeof(__pyx_t_double_complex), PyBytes_AS_STRING(__pyx_t_15), (char *) "c", (char *) __pyx_t_17);
+        if (unlikely(!__pyx_t_14)) __PYX_ERR(0, 976, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_14);
+        __Pyx_DECREF(__pyx_t_18); __pyx_t_18 = 0;
+        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
+        if (PyDict_SetItem(__pyx_t_12, __pyx_n_s_out, ((PyObject *)__pyx_t_14)) < 0) __PYX_ERR(0, 976, __pyx_L26_error)
+        __Pyx_DECREF(((PyObject *)__pyx_t_14)); __pyx_t_14 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":922
+        /* "tkwant/onebody/kernels.pyx":975
  *                 self.temp[i] = psi[i] + self.psi_st[i]
  *             try:
  *                 self.W.apply(time, <complex[:self.center_size]>self.temp,             # <<<<<<<<<<<<<<
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:
  */
-        __pyx_t_11 = __Pyx_PyObject_Call(__pyx_t_12, __pyx_t_5, __pyx_t_1); if (unlikely(!__pyx_t_11)) __PYX_ERR(0, 922, __pyx_L26_error)
-        __Pyx_GOTREF(__pyx_t_11);
+        __pyx_t_15 = __Pyx_PyObject_Call(__pyx_t_16, __pyx_t_7, __pyx_t_12); if (unlikely(!__pyx_t_15)) __PYX_ERR(0, 975, __pyx_L26_error)
+        __Pyx_GOTREF(__pyx_t_15);
+        __Pyx_DECREF(__pyx_t_16); __pyx_t_16 = 0;
+        __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
         __Pyx_DECREF(__pyx_t_12); __pyx_t_12 = 0;
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-        __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-        __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
+        __Pyx_DECREF(__pyx_t_15); __pyx_t_15 = 0;
 
-        /* "tkwant/onebody/kernels.pyx":921
+        /* "tkwant/onebody/kernels.pyx":974
  *             for i in range(self.center_size):
  *                 self.temp[i] = psi[i] + self.psi_st[i]
  *             try:             # <<<<<<<<<<<<<<
  *                 self.W.apply(time, <complex[:self.center_size]>self.temp,
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  */
       }
+      __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
+      __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
       __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
-      __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
-      __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
       goto __pyx_L31_try_end;
       __pyx_L26_error:;
-      __Pyx_XDECREF(__pyx_t_13); __pyx_t_13 = 0;
       __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
-      __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
-      __Pyx_XDECREF(((PyObject *)__pyx_t_10)); __pyx_t_10 = 0;
+      __Pyx_XDECREF(((PyObject *)__pyx_t_14)); __pyx_t_14 = 0;
+      __Pyx_XDECREF(__pyx_t_15); __pyx_t_15 = 0;
+      __Pyx_XDECREF(__pyx_t_16); __pyx_t_16 = 0;
+      __Pyx_XDECREF(__pyx_t_18); __pyx_t_18 = 0;
+      __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-      /* "tkwant/onebody/kernels.pyx":924
+      /* "tkwant/onebody/kernels.pyx":977
  *                 self.W.apply(time, <complex[:self.center_size]>self.temp,
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:             # <<<<<<<<<<<<<<
  *                 if self.W is None:
  *                     pass
  */
       __pyx_t_3 = __Pyx_PyErr_ExceptionMatches(((PyObject *)(&((PyTypeObject*)PyExc_Exception)[0])));
       if (__pyx_t_3) {
-        __Pyx_AddTraceback("tkwant.onebody.kernels.Simple._rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
-        if (__Pyx_GetException(&__pyx_t_11, &__pyx_t_1, &__pyx_t_5) < 0) __PYX_ERR(0, 924, __pyx_L28_except_error)
-        __Pyx_GOTREF(__pyx_t_11);
-        __Pyx_GOTREF(__pyx_t_1);
-        __Pyx_GOTREF(__pyx_t_5);
-        __Pyx_INCREF(__pyx_t_1);
-        __pyx_v_exept = __pyx_t_1;
+        __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHSc.__call__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+        if (__Pyx_GetException(&__pyx_t_15, &__pyx_t_12, &__pyx_t_7) < 0) __PYX_ERR(0, 977, __pyx_L28_except_error)
+        __Pyx_GOTREF(__pyx_t_15);
+        __Pyx_GOTREF(__pyx_t_12);
+        __Pyx_GOTREF(__pyx_t_7);
+        __Pyx_INCREF(__pyx_t_12);
+        __pyx_v_exept = __pyx_t_12;
         /*try:*/ {
 
-          /* "tkwant/onebody/kernels.pyx":925
- *                              out=<complex[:self.center_size]>dpsidt)
+          /* "tkwant/onebody/kernels.pyx":978
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:
  *                 if self.W is None:             # <<<<<<<<<<<<<<
  *                     pass
  *                 else:
  */
-          __pyx_t_14 = (__pyx_v_self->W == Py_None);
-          __pyx_t_6 = (__pyx_t_14 != 0);
-          if (likely(__pyx_t_6)) {
+          __pyx_t_19 = (__pyx_v_self->W == Py_None);
+          __pyx_t_8 = (__pyx_t_19 != 0);
+          if (likely(__pyx_t_8)) {
             goto __pyx_L39;
           }
 
-          /* "tkwant/onebody/kernels.pyx":928
+          /* "tkwant/onebody/kernels.pyx":981
  *                     pass
  *                 else:
  *                     raise exept             # <<<<<<<<<<<<<<
  *         ### dpsidt = -1j * dpsidt
  *         for i in range(self.size):
  */
           /*else*/ {
             __Pyx_Raise(__pyx_v_exept, 0, 0, 0);
-            __PYX_ERR(0, 928, __pyx_L37_error)
+            __PYX_ERR(0, 981, __pyx_L37_error)
           }
           __pyx_L39:;
         }
 
-        /* "tkwant/onebody/kernels.pyx":924
+        /* "tkwant/onebody/kernels.pyx":977
  *                 self.W.apply(time, <complex[:self.center_size]>self.temp,
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  *             except Exception as exept:             # <<<<<<<<<<<<<<
  *                 if self.W is None:
  *                     pass
  */
         /*finally:*/ {
           /*normal exit:*/{
             __Pyx_DECREF(__pyx_v_exept);
             __pyx_v_exept = NULL;
             goto __pyx_L38;
           }
           __pyx_L37_error:;
           /*exception exit:*/{
             __Pyx_PyThreadState_declare
             __Pyx_PyThreadState_assign
-            __pyx_t_21 = 0; __pyx_t_20 = 0; __pyx_t_19 = 0; __pyx_t_18 = 0; __pyx_t_17 = 0; __pyx_t_16 = 0;
-            __Pyx_XDECREF(__pyx_t_13); __pyx_t_13 = 0;
-            __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
-            __Pyx_XDECREF(((PyObject *)__pyx_t_10)); __pyx_t_10 = 0;
-            if (PY_MAJOR_VERSION >= 3) __Pyx_ExceptionSwap(&__pyx_t_18, &__pyx_t_17, &__pyx_t_16);
-            if ((PY_MAJOR_VERSION < 3) || unlikely(__Pyx_GetException(&__pyx_t_21, &__pyx_t_20, &__pyx_t_19) < 0)) __Pyx_ErrFetch(&__pyx_t_21, &__pyx_t_20, &__pyx_t_19);
+            __pyx_t_26 = 0; __pyx_t_25 = 0; __pyx_t_24 = 0; __pyx_t_23 = 0; __pyx_t_22 = 0; __pyx_t_21 = 0;
+            __Pyx_XDECREF(((PyObject *)__pyx_t_14)); __pyx_t_14 = 0;
+            __Pyx_XDECREF(__pyx_t_16); __pyx_t_16 = 0;
+            __Pyx_XDECREF(__pyx_t_18); __pyx_t_18 = 0;
+            if (PY_MAJOR_VERSION >= 3) __Pyx_ExceptionSwap(&__pyx_t_23, &__pyx_t_22, &__pyx_t_21);
+            if ((PY_MAJOR_VERSION < 3) || unlikely(__Pyx_GetException(&__pyx_t_26, &__pyx_t_25, &__pyx_t_24) < 0)) __Pyx_ErrFetch(&__pyx_t_26, &__pyx_t_25, &__pyx_t_24);
+            __Pyx_XGOTREF(__pyx_t_26);
+            __Pyx_XGOTREF(__pyx_t_25);
+            __Pyx_XGOTREF(__pyx_t_24);
+            __Pyx_XGOTREF(__pyx_t_23);
+            __Pyx_XGOTREF(__pyx_t_22);
             __Pyx_XGOTREF(__pyx_t_21);
-            __Pyx_XGOTREF(__pyx_t_20);
-            __Pyx_XGOTREF(__pyx_t_19);
-            __Pyx_XGOTREF(__pyx_t_18);
-            __Pyx_XGOTREF(__pyx_t_17);
-            __Pyx_XGOTREF(__pyx_t_16);
-            __pyx_t_3 = __pyx_lineno; __pyx_t_2 = __pyx_clineno; __pyx_t_23 = __pyx_filename;
+            __pyx_t_3 = __pyx_lineno; __pyx_t_2 = __pyx_clineno; __pyx_t_27 = __pyx_filename;
             {
               __Pyx_DECREF(__pyx_v_exept);
               __pyx_v_exept = NULL;
             }
             if (PY_MAJOR_VERSION >= 3) {
-              __Pyx_XGIVEREF(__pyx_t_18);
-              __Pyx_XGIVEREF(__pyx_t_17);
-              __Pyx_XGIVEREF(__pyx_t_16);
-              __Pyx_ExceptionReset(__pyx_t_18, __pyx_t_17, __pyx_t_16);
+              __Pyx_XGIVEREF(__pyx_t_23);
+              __Pyx_XGIVEREF(__pyx_t_22);
+              __Pyx_XGIVEREF(__pyx_t_21);
+              __Pyx_ExceptionReset(__pyx_t_23, __pyx_t_22, __pyx_t_21);
             }
-            __Pyx_XGIVEREF(__pyx_t_21);
-            __Pyx_XGIVEREF(__pyx_t_20);
-            __Pyx_XGIVEREF(__pyx_t_19);
-            __Pyx_ErrRestore(__pyx_t_21, __pyx_t_20, __pyx_t_19);
-            __pyx_t_21 = 0; __pyx_t_20 = 0; __pyx_t_19 = 0; __pyx_t_18 = 0; __pyx_t_17 = 0; __pyx_t_16 = 0;
-            __pyx_lineno = __pyx_t_3; __pyx_clineno = __pyx_t_2; __pyx_filename = __pyx_t_23;
+            __Pyx_XGIVEREF(__pyx_t_26);
+            __Pyx_XGIVEREF(__pyx_t_25);
+            __Pyx_XGIVEREF(__pyx_t_24);
+            __Pyx_ErrRestore(__pyx_t_26, __pyx_t_25, __pyx_t_24);
+            __pyx_t_26 = 0; __pyx_t_25 = 0; __pyx_t_24 = 0; __pyx_t_23 = 0; __pyx_t_22 = 0; __pyx_t_21 = 0;
+            __pyx_lineno = __pyx_t_3; __pyx_clineno = __pyx_t_2; __pyx_filename = __pyx_t_27;
             goto __pyx_L28_except_error;
           }
           __pyx_L38:;
         }
-        __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
-        __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
-        __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+        __Pyx_XDECREF(__pyx_t_15); __pyx_t_15 = 0;
+        __Pyx_XDECREF(__pyx_t_12); __pyx_t_12 = 0;
+        __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
         goto __pyx_L27_exception_handled;
       }
       goto __pyx_L28_except_error;
       __pyx_L28_except_error:;
 
-      /* "tkwant/onebody/kernels.pyx":921
+      /* "tkwant/onebody/kernels.pyx":974
  *             for i in range(self.center_size):
  *                 self.temp[i] = psi[i] + self.psi_st[i]
  *             try:             # <<<<<<<<<<<<<<
  *                 self.W.apply(time, <complex[:self.center_size]>self.temp,
- *                              out=<complex[:self.center_size]>dpsidt)
+ *                              out=<complex[:self.center_size]>&dpsidt[0])
  */
+      __Pyx_XGIVEREF(__pyx_t_11);
+      __Pyx_XGIVEREF(__pyx_t_10);
       __Pyx_XGIVEREF(__pyx_t_9);
-      __Pyx_XGIVEREF(__pyx_t_8);
-      __Pyx_XGIVEREF(__pyx_t_7);
-      __Pyx_ExceptionReset(__pyx_t_9, __pyx_t_8, __pyx_t_7);
+      __Pyx_ExceptionReset(__pyx_t_11, __pyx_t_10, __pyx_t_9);
       goto __pyx_L1_error;
       __pyx_L27_exception_handled:;
+      __Pyx_XGIVEREF(__pyx_t_11);
+      __Pyx_XGIVEREF(__pyx_t_10);
       __Pyx_XGIVEREF(__pyx_t_9);
-      __Pyx_XGIVEREF(__pyx_t_8);
-      __Pyx_XGIVEREF(__pyx_t_7);
-      __Pyx_ExceptionReset(__pyx_t_9, __pyx_t_8, __pyx_t_7);
+      __Pyx_ExceptionReset(__pyx_t_11, __pyx_t_10, __pyx_t_9);
       __pyx_L31_try_end:;
     }
   }
   __pyx_L5:;
 
-  /* "tkwant/onebody/kernels.pyx":930
+  /* "tkwant/onebody/kernels.pyx":983
  *                     raise exept
  *         ### dpsidt = -1j * dpsidt
  *         for i in range(self.size):             # <<<<<<<<<<<<<<
  *             dpsidt[i] = -1j * dpsidt[i]
  * 
  */
-  __pyx_t_2 = __pyx_v_self->__pyx_base.__pyx_base.size;
+  __pyx_t_2 = __pyx_v_self->size;
   __pyx_t_3 = __pyx_t_2;
   for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
     __pyx_v_i = __pyx_t_4;
 
-    /* "tkwant/onebody/kernels.pyx":931
+    /* "tkwant/onebody/kernels.pyx":984
  *         ### dpsidt = -1j * dpsidt
  *         for i in range(self.size):
  *             dpsidt[i] = -1j * dpsidt[i]             # <<<<<<<<<<<<<<
  * 
- * 
+ *     def __reduce__(self):
  */
-    (__pyx_v_dpsidt[__pyx_v_i]) = __Pyx_c_prod_double(__Pyx_c_neg_double(__pyx_t_double_complex_from_parts(0, 1.0)), (__pyx_v_dpsidt[__pyx_v_i]));
+    __pyx_t_5 = __pyx_v_i;
+    __pyx_t_28 = __pyx_v_i;
+    *((__pyx_t_double_complex *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex *) __pyx_v_dpsidt.data) + __pyx_t_28)) )) = __Pyx_c_prod_double(__Pyx_c_neg_double(__pyx_t_double_complex_from_parts(0, 1.0)), (*((__pyx_t_double_complex *) ( /* dim=0 */ ((char *) (((__pyx_t_double_complex *) __pyx_v_dpsidt.data) + __pyx_t_5)) ))));
   }
 
-  /* "tkwant/onebody/kernels.pyx":898
+  /* "tkwant/onebody/kernels.pyx":941
  *     @cython.boundscheck(False)
  *     @cython.wraparound(False)
- *     cdef void _rhs(const void *_self, const complex *psi, complex *dpsidt,             # <<<<<<<<<<<<<<
- *                    double time) except *:
- *         cdef Simple self = <Simple>_self
+ *     def __call__(self, const complex[::1] psi, complex[::1] dpsidt, double time):             # <<<<<<<<<<<<<<
+ * 
+ *         cdef int *indptr
  */
 
   /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_5);
-  __Pyx_XDECREF(((PyObject *)__pyx_t_10));
-  __Pyx_XDECREF(__pyx_t_11);
+  __Pyx_XDECREF(__pyx_t_7);
   __Pyx_XDECREF(__pyx_t_12);
-  __Pyx_XDECREF(__pyx_t_13);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple._rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_XDECREF(((PyObject *)__pyx_t_14));
+  __Pyx_XDECREF(__pyx_t_15);
+  __Pyx_XDECREF(__pyx_t_16);
+  __Pyx_XDECREF(__pyx_t_18);
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHSc.__call__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
   __pyx_L0:;
-  __Pyx_XDECREF((PyObject *)__pyx_v_self);
   __Pyx_XDECREF(__pyx_v_exept);
-  __Pyx_RefNannyFinishContext();
-}
-
-/* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
- */
-
-/* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_7__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_6Simple_6__reduce_cython__[] = "Simple.__reduce_cython__(self)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_7__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
-  PyObject *__pyx_r = 0;
-  __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_6__reduce_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self));
-
-  /* function exit code */
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_6__reduce_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("__reduce_cython__", 0);
-
-  /* "(tree fragment)":2
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- */
-  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__11, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 2, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_Raise(__pyx_t_1, 0, 0, 0);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(1, 2, __pyx_L1_error)
-
-  /* "(tree fragment)":1
- * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
- */
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
+  __PYX_XDEC_MEMVIEW(&__pyx_v_psi, 1);
+  __PYX_XDEC_MEMVIEW(&__pyx_v_dpsidt, 1);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+/* "tkwant/onebody/kernels.pyx":986
+ *             dpsidt[i] = -1j * dpsidt[i]
+ * 
+ *     def __reduce__(self):             # <<<<<<<<<<<<<<
+ *         raise NotImplementedError("use the scipy kernel for serialization")
+ * 
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_9__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_6Simple_8__setstate_cython__[] = "Simple.__setstate_cython__(self, __pyx_state)";
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_6Simple_9__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_7__reduce__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_9_CalcRHSc_6__reduce__[] = "_CalcRHSc.__reduce__(self)";
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_7__reduce__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
-  __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_6Simple_8__setstate_cython__(((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)__pyx_v_self), ((PyObject *)__pyx_v___pyx_state));
+  __Pyx_RefNannySetupContext("__reduce__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc_6__reduce__(((struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *)__pyx_v_self));
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6Simple_8__setstate_cython__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_9_CalcRHSc_6__reduce__(CYTHON_UNUSED struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
-  __Pyx_RefNannySetupContext("__setstate_cython__", 0);
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__reduce__", 0);
 
-  /* "(tree fragment)":4
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
+  /* "tkwant/onebody/kernels.pyx":987
+ * 
+ *     def __reduce__(self):
+ *         raise NotImplementedError("use the scipy kernel for serialization")             # <<<<<<<<<<<<<<
+ * 
+ * default = Simple
  */
-  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__12, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_builtin_NotImplementedError, __pyx_tuple__8, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 987, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_Raise(__pyx_t_1, 0, 0, 0);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(1, 4, __pyx_L1_error)
+  __PYX_ERR(0, 987, __pyx_L1_error)
 
-  /* "(tree fragment)":3
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+  /* "tkwant/onebody/kernels.pyx":986
+ *             dpsidt[i] = -1j * dpsidt[i]
+ * 
+ *     def __reduce__(self):             # <<<<<<<<<<<<<<
+ *         raise NotImplementedError("use the scipy kernel for serialization")
+ * 
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_AddTraceback("tkwant.onebody.kernels.Simple.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_AddTraceback("tkwant.onebody.kernels._CalcRHSc.__reduce__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 /* "(tree fragment)":1
  * def __pyx_unpickle_Kernel(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5__pyx_unpickle_Kernel(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static char __pyx_doc_6tkwant_7onebody_7kernels_4__pyx_unpickle_Kernel[] = "__pyx_unpickle_Kernel(__pyx_type, long __pyx_checksum, __pyx_state)";
-static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_5__pyx_unpickle_Kernel = {"__pyx_unpickle_Kernel", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_5__pyx_unpickle_Kernel, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_4__pyx_unpickle_Kernel};
-static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5__pyx_unpickle_Kernel(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_3__pyx_unpickle_Kernel(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_2__pyx_unpickle_Kernel[] = "__pyx_unpickle_Kernel(__pyx_type, long __pyx_checksum, __pyx_state)";
+static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_3__pyx_unpickle_Kernel = {"__pyx_unpickle_Kernel", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_3__pyx_unpickle_Kernel, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_2__pyx_unpickle_Kernel};
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_3__pyx_unpickle_Kernel(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v___pyx_type = 0;
   long __pyx_v___pyx_checksum;
   PyObject *__pyx_v___pyx_state = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__pyx_unpickle_Kernel (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_type,&__pyx_n_s_pyx_checksum,&__pyx_n_s_pyx_state,0};
     PyObject* values[3] = {0,0,0};
     if (unlikely(__pyx_kwds)) {
@@ -17671,160 +18855,167 @@
   __pyx_L5_argtuple_error:;
   __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Kernel", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(1, 1, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.kernels.__pyx_unpickle_Kernel", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_4__pyx_unpickle_Kernel(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_2__pyx_unpickle_Kernel(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_4__pyx_unpickle_Kernel(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_2__pyx_unpickle_Kernel(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_v___pyx_PickleError = 0;
   PyObject *__pyx_v___pyx_result = 0;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_t_2;
+  int __pyx_t_3;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
-  int __pyx_t_6;
+  PyObject *__pyx_t_6 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_Kernel", 0);
 
   /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0x4d5deb3:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum not in (0x4d5deb3, 0x498303b, 0x82e3adb):             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x4d5deb3 = (nevals, size))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x4d5deb3, 0x498303b, 0x82e3adb) = (nevals, size))" % __pyx_checksum)
  */
-  __pyx_t_1 = ((__pyx_v___pyx_checksum != 0x4d5deb3) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = (__Pyx_PySequence_ContainsTF(__pyx_t_1, __pyx_tuple__9, Py_NE)); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_3 = (__pyx_t_2 != 0);
+  if (__pyx_t_3) {
 
     /* "(tree fragment)":5
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0x4d5deb3:
+ *     if __pyx_checksum not in (0x4d5deb3, 0x498303b, 0x82e3adb):
  *         from pickle import PickleError as __pyx_PickleError             # <<<<<<<<<<<<<<
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x4d5deb3 = (nevals, size))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x4d5deb3, 0x498303b, 0x82e3adb) = (nevals, size))" % __pyx_checksum)
  *     __pyx_result = Kernel.__new__(__pyx_type)
  */
-    __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_1 = PyList_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
     __Pyx_INCREF(__pyx_n_s_PickleError);
     __Pyx_GIVEREF(__pyx_n_s_PickleError);
-    PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_PickleError);
-    __pyx_t_3 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_2, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_INCREF(__pyx_t_2);
-    __pyx_v___pyx_PickleError = __pyx_t_2;
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_s_PickleError);
+    __pyx_t_4 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_1, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = __Pyx_ImportFrom(__pyx_t_4, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_INCREF(__pyx_t_1);
+    __pyx_v___pyx_PickleError = __pyx_t_1;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
     /* "(tree fragment)":6
- *     if __pyx_checksum != 0x4d5deb3:
+ *     if __pyx_checksum not in (0x4d5deb3, 0x498303b, 0x82e3adb):
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x4d5deb3 = (nevals, size))" % __pyx_checksum)             # <<<<<<<<<<<<<<
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x4d5deb3, 0x498303b, 0x82e3adb) = (nevals, size))" % __pyx_checksum)             # <<<<<<<<<<<<<<
  *     __pyx_result = Kernel.__new__(__pyx_type)
  *     if __pyx_state is not None:
  */
-    __pyx_t_2 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_4 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_s_vs_0x4d, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_0x_x_vs_0, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_INCREF(__pyx_v___pyx_PickleError);
-    __pyx_t_2 = __pyx_v___pyx_PickleError; __pyx_t_5 = NULL;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
-      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
-      if (likely(__pyx_t_5)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-        __Pyx_INCREF(__pyx_t_5);
+    __pyx_t_1 = __pyx_v___pyx_PickleError; __pyx_t_6 = NULL;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
+      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
+      if (likely(__pyx_t_6)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+        __Pyx_INCREF(__pyx_t_6);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_2, function);
+        __Pyx_DECREF_SET(__pyx_t_1, function);
       }
     }
-    __pyx_t_3 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_5, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4);
-    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_4 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_5);
+    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_Raise(__pyx_t_4, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __PYX_ERR(1, 6, __pyx_L1_error)
 
     /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0x4d5deb3:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum not in (0x4d5deb3, 0x498303b, 0x82e3adb):             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x4d5deb3 = (nevals, size))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x4d5deb3, 0x498303b, 0x82e3adb) = (nevals, size))" % __pyx_checksum)
  */
   }
 
   /* "(tree fragment)":7
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x4d5deb3 = (nevals, size))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x4d5deb3, 0x498303b, 0x82e3adb) = (nevals, size))" % __pyx_checksum)
  *     __pyx_result = Kernel.__new__(__pyx_type)             # <<<<<<<<<<<<<<
  *     if __pyx_state is not None:
  *         __pyx_unpickle_Kernel__set_state(<Kernel> __pyx_result, __pyx_state)
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Kernel), __pyx_n_s_new); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 7, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_4 = NULL;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
-    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
-    if (likely(__pyx_t_4)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-      __Pyx_INCREF(__pyx_t_4);
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Kernel), __pyx_n_s_new); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_5 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_1))) {
+    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_1);
+    if (likely(__pyx_t_5)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+      __Pyx_INCREF(__pyx_t_5);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_2, function);
+      __Pyx_DECREF_SET(__pyx_t_1, function);
     }
   }
-  __pyx_t_3 = (__pyx_t_4) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_4, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_v___pyx_type);
-  __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-  if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 7, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_v___pyx_result = __pyx_t_3;
-  __pyx_t_3 = 0;
+  __pyx_t_4 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_5, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_v___pyx_type);
+  __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+  if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result = __pyx_t_4;
+  __pyx_t_4 = 0;
 
   /* "(tree fragment)":8
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x4d5deb3 = (nevals, size))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x4d5deb3, 0x498303b, 0x82e3adb) = (nevals, size))" % __pyx_checksum)
  *     __pyx_result = Kernel.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_Kernel__set_state(<Kernel> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
-  __pyx_t_1 = (__pyx_v___pyx_state != Py_None);
-  __pyx_t_6 = (__pyx_t_1 != 0);
-  if (__pyx_t_6) {
+  __pyx_t_3 = (__pyx_v___pyx_state != Py_None);
+  __pyx_t_2 = (__pyx_t_3 != 0);
+  if (__pyx_t_2) {
 
     /* "(tree fragment)":9
  *     __pyx_result = Kernel.__new__(__pyx_type)
  *     if __pyx_state is not None:
  *         __pyx_unpickle_Kernel__set_state(<Kernel> __pyx_result, __pyx_state)             # <<<<<<<<<<<<<<
  *     return __pyx_result
  * cdef __pyx_unpickle_Kernel__set_state(Kernel __pyx_result, tuple __pyx_state):
  */
-    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
-    __pyx_t_3 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_Kernel__set_state(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 9, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
+    __pyx_t_4 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_Kernel__set_state(((struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 9, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
     /* "(tree fragment)":8
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x4d5deb3 = (nevals, size))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x4d5deb3, 0x498303b, 0x82e3adb) = (nevals, size))" % __pyx_checksum)
  *     __pyx_result = Kernel.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_Kernel__set_state(<Kernel> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
   }
 
@@ -17844,18 +19035,18 @@
  * def __pyx_unpickle_Kernel(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
   __Pyx_AddTraceback("tkwant.onebody.kernels.__pyx_unpickle_Kernel", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v___pyx_PickleError);
   __Pyx_XDECREF(__pyx_v___pyx_result);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
@@ -17878,14 +19069,17 @@
   int __pyx_t_3;
   Py_ssize_t __pyx_t_4;
   int __pyx_t_5;
   int __pyx_t_6;
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   PyObject *__pyx_t_9 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_Kernel__set_state", 0);
 
   /* "(tree fragment)":12
  *     return __pyx_result
  * cdef __pyx_unpickle_Kernel__set_state(Kernel __pyx_result, tuple __pyx_state):
  *     __pyx_result.nevals = __pyx_state[0]; __pyx_result.size = __pyx_state[1]             # <<<<<<<<<<<<<<
  *     if len(__pyx_state) > 2 and hasattr(__pyx_result, '__dict__'):
@@ -17996,27 +19190,639 @@
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 /* "(tree fragment)":1
+ * def __pyx_unpickle_Interpolation(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5__pyx_unpickle_Interpolation(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static char __pyx_doc_6tkwant_7onebody_7kernels_4__pyx_unpickle_Interpolation[] = "__pyx_unpickle_Interpolation(__pyx_type, long __pyx_checksum, __pyx_state)";
+static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_5__pyx_unpickle_Interpolation = {"__pyx_unpickle_Interpolation", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_5__pyx_unpickle_Interpolation, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_4__pyx_unpickle_Interpolation};
+static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_5__pyx_unpickle_Interpolation(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  PyObject *__pyx_v___pyx_type = 0;
+  long __pyx_v___pyx_checksum;
+  PyObject *__pyx_v___pyx_state = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__pyx_unpickle_Interpolation (wrapper)", 0);
+  {
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_type,&__pyx_n_s_pyx_checksum,&__pyx_n_s_pyx_state,0};
+    PyObject* values[3] = {0,0,0};
+    if (unlikely(__pyx_kwds)) {
+      Py_ssize_t kw_args;
+      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
+      switch (pos_args) {
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = PyDict_Size(__pyx_kwds);
+      switch (pos_args) {
+        case  0:
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_pyx_type)) != 0)) kw_args--;
+        else goto __pyx_L5_argtuple_error;
+        CYTHON_FALLTHROUGH;
+        case  1:
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_pyx_checksum)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Interpolation", 1, 3, 3, 1); __PYX_ERR(1, 1, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  2:
+        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_pyx_state)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Interpolation", 1, 3, 3, 2); __PYX_ERR(1, 1, __pyx_L3_error)
+        }
+      }
+      if (unlikely(kw_args > 0)) {
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__pyx_unpickle_Interpolation") < 0)) __PYX_ERR(1, 1, __pyx_L3_error)
+      }
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
+      goto __pyx_L5_argtuple_error;
+    } else {
+      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+    }
+    __pyx_v___pyx_type = values[0];
+    __pyx_v___pyx_checksum = __Pyx_PyInt_As_long(values[1]); if (unlikely((__pyx_v___pyx_checksum == (long)-1) && PyErr_Occurred())) __PYX_ERR(1, 1, __pyx_L3_error)
+    __pyx_v___pyx_state = values[2];
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Interpolation", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(1, 1, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("tkwant.onebody.kernels.__pyx_unpickle_Interpolation", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7kernels_4__pyx_unpickle_Interpolation(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_4__pyx_unpickle_Interpolation(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_v___pyx_PickleError = 0;
+  PyObject *__pyx_v___pyx_result = 0;
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_t_2;
+  int __pyx_t_3;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  PyObject *__pyx_t_6 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__pyx_unpickle_Interpolation", 0);
+
+  /* "(tree fragment)":4
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
+ *     if __pyx_checksum not in (0xa494bc0, 0x30fa593, 0x3e8e3df):             # <<<<<<<<<<<<<<
+ *         from pickle import PickleError as __pyx_PickleError
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xa494bc0, 0x30fa593, 0x3e8e3df) = (Ht0, Ht1, Ht2, Ht3, Ht4, atol, d2Ht0, d2Ht1, d2Ht2, dt, dt_min, fac, facmax, facmin, func, nnz, rtol, t0, t1, t2, t3, t4))" % __pyx_checksum)
+ */
+  __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = (__Pyx_PySequence_ContainsTF(__pyx_t_1, __pyx_tuple__10, Py_NE)); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_3 = (__pyx_t_2 != 0);
+  if (__pyx_t_3) {
+
+    /* "(tree fragment)":5
+ *     cdef object __pyx_result
+ *     if __pyx_checksum not in (0xa494bc0, 0x30fa593, 0x3e8e3df):
+ *         from pickle import PickleError as __pyx_PickleError             # <<<<<<<<<<<<<<
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xa494bc0, 0x30fa593, 0x3e8e3df) = (Ht0, Ht1, Ht2, Ht3, Ht4, atol, d2Ht0, d2Ht1, d2Ht2, dt, dt_min, fac, facmax, facmin, func, nnz, rtol, t0, t1, t2, t3, t4))" % __pyx_checksum)
+ *     __pyx_result = Interpolation.__new__(__pyx_type)
+ */
+    __pyx_t_1 = PyList_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_INCREF(__pyx_n_s_PickleError);
+    __Pyx_GIVEREF(__pyx_n_s_PickleError);
+    PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_s_PickleError);
+    __pyx_t_4 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_1, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = __Pyx_ImportFrom(__pyx_t_4, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_INCREF(__pyx_t_1);
+    __pyx_v___pyx_PickleError = __pyx_t_1;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+    /* "(tree fragment)":6
+ *     if __pyx_checksum not in (0xa494bc0, 0x30fa593, 0x3e8e3df):
+ *         from pickle import PickleError as __pyx_PickleError
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xa494bc0, 0x30fa593, 0x3e8e3df) = (Ht0, Ht1, Ht2, Ht3, Ht4, atol, d2Ht0, d2Ht1, d2Ht2, dt, dt_min, fac, facmax, facmin, func, nnz, rtol, t0, t1, t2, t3, t4))" % __pyx_checksum)             # <<<<<<<<<<<<<<
+ *     __pyx_result = Interpolation.__new__(__pyx_type)
+ *     if __pyx_state is not None:
+ */
+    __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_2, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_INCREF(__pyx_v___pyx_PickleError);
+    __pyx_t_1 = __pyx_v___pyx_PickleError; __pyx_t_6 = NULL;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
+      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
+      if (likely(__pyx_t_6)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+        __Pyx_INCREF(__pyx_t_6);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_1, function);
+      }
+    }
+    __pyx_t_4 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_5);
+    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_Raise(__pyx_t_4, 0, 0, 0);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    __PYX_ERR(1, 6, __pyx_L1_error)
+
+    /* "(tree fragment)":4
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
+ *     if __pyx_checksum not in (0xa494bc0, 0x30fa593, 0x3e8e3df):             # <<<<<<<<<<<<<<
+ *         from pickle import PickleError as __pyx_PickleError
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xa494bc0, 0x30fa593, 0x3e8e3df) = (Ht0, Ht1, Ht2, Ht3, Ht4, atol, d2Ht0, d2Ht1, d2Ht2, dt, dt_min, fac, facmax, facmin, func, nnz, rtol, t0, t1, t2, t3, t4))" % __pyx_checksum)
+ */
+  }
+
+  /* "(tree fragment)":7
+ *         from pickle import PickleError as __pyx_PickleError
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xa494bc0, 0x30fa593, 0x3e8e3df) = (Ht0, Ht1, Ht2, Ht3, Ht4, atol, d2Ht0, d2Ht1, d2Ht2, dt, dt_min, fac, facmax, facmin, func, nnz, rtol, t0, t1, t2, t3, t4))" % __pyx_checksum)
+ *     __pyx_result = Interpolation.__new__(__pyx_type)             # <<<<<<<<<<<<<<
+ *     if __pyx_state is not None:
+ *         __pyx_unpickle_Interpolation__set_state(<Interpolation> __pyx_result, __pyx_state)
+ */
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Interpolation), __pyx_n_s_new); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_5 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_1))) {
+    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_1);
+    if (likely(__pyx_t_5)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+      __Pyx_INCREF(__pyx_t_5);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_1, function);
+    }
+  }
+  __pyx_t_4 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_5, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_v___pyx_type);
+  __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+  if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result = __pyx_t_4;
+  __pyx_t_4 = 0;
+
+  /* "(tree fragment)":8
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xa494bc0, 0x30fa593, 0x3e8e3df) = (Ht0, Ht1, Ht2, Ht3, Ht4, atol, d2Ht0, d2Ht1, d2Ht2, dt, dt_min, fac, facmax, facmin, func, nnz, rtol, t0, t1, t2, t3, t4))" % __pyx_checksum)
+ *     __pyx_result = Interpolation.__new__(__pyx_type)
+ *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
+ *         __pyx_unpickle_Interpolation__set_state(<Interpolation> __pyx_result, __pyx_state)
+ *     return __pyx_result
+ */
+  __pyx_t_3 = (__pyx_v___pyx_state != Py_None);
+  __pyx_t_2 = (__pyx_t_3 != 0);
+  if (__pyx_t_2) {
+
+    /* "(tree fragment)":9
+ *     __pyx_result = Interpolation.__new__(__pyx_type)
+ *     if __pyx_state is not None:
+ *         __pyx_unpickle_Interpolation__set_state(<Interpolation> __pyx_result, __pyx_state)             # <<<<<<<<<<<<<<
+ *     return __pyx_result
+ * cdef __pyx_unpickle_Interpolation__set_state(Interpolation __pyx_result, tuple __pyx_state):
+ */
+    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
+    __pyx_t_4 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_Interpolation__set_state(((struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 9, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+
+    /* "(tree fragment)":8
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xa494bc0, 0x30fa593, 0x3e8e3df) = (Ht0, Ht1, Ht2, Ht3, Ht4, atol, d2Ht0, d2Ht1, d2Ht2, dt, dt_min, fac, facmax, facmin, func, nnz, rtol, t0, t1, t2, t3, t4))" % __pyx_checksum)
+ *     __pyx_result = Interpolation.__new__(__pyx_type)
+ *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
+ *         __pyx_unpickle_Interpolation__set_state(<Interpolation> __pyx_result, __pyx_state)
+ *     return __pyx_result
+ */
+  }
+
+  /* "(tree fragment)":10
+ *     if __pyx_state is not None:
+ *         __pyx_unpickle_Interpolation__set_state(<Interpolation> __pyx_result, __pyx_state)
+ *     return __pyx_result             # <<<<<<<<<<<<<<
+ * cdef __pyx_unpickle_Interpolation__set_state(Interpolation __pyx_result, tuple __pyx_state):
+ *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result.atol = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.dt = __pyx_state[9]; __pyx_result.dt_min = __pyx_state[10]; __pyx_result.fac = __pyx_state[11]; __pyx_result.facmax = __pyx_state[12]; __pyx_result.facmin = __pyx_state[13]; __pyx_result.func = __pyx_state[14]; __pyx_result.nnz = __pyx_state[15]; __pyx_result.rtol = __pyx_state[16]; __pyx_result.t0 = __pyx_state[17]; __pyx_result.t1 = __pyx_state[18]; __pyx_result.t2 = __pyx_state[19]; __pyx_result.t3 = __pyx_state[20]; __pyx_result.t4 = __pyx_state[21]
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_INCREF(__pyx_v___pyx_result);
+  __pyx_r = __pyx_v___pyx_result;
+  goto __pyx_L0;
+
+  /* "(tree fragment)":1
+ * def __pyx_unpickle_Interpolation(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.__pyx_unpickle_Interpolation", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v___pyx_PickleError);
+  __Pyx_XDECREF(__pyx_v___pyx_result);
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":11
+ *         __pyx_unpickle_Interpolation__set_state(<Interpolation> __pyx_result, __pyx_state)
+ *     return __pyx_result
+ * cdef __pyx_unpickle_Interpolation__set_state(Interpolation __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
+ *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result.atol = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.dt = __pyx_state[9]; __pyx_result.dt_min = __pyx_state[10]; __pyx_result.fac = __pyx_state[11]; __pyx_result.facmax = __pyx_state[12]; __pyx_result.facmin = __pyx_state[13]; __pyx_result.func = __pyx_state[14]; __pyx_result.nnz = __pyx_state[15]; __pyx_result.rtol = __pyx_state[16]; __pyx_result.t0 = __pyx_state[17]; __pyx_result.t1 = __pyx_state[18]; __pyx_result.t2 = __pyx_state[19]; __pyx_result.t3 = __pyx_state[20]; __pyx_result.t4 = __pyx_state[21]
+ *     if len(__pyx_state) > 22 and hasattr(__pyx_result, '__dict__'):
+ */
+
+static PyObject *__pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_Interpolation__set_state(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *__pyx_v___pyx_result, PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  double __pyx_t_2;
+  unsigned int __pyx_t_3;
+  int __pyx_t_4;
+  Py_ssize_t __pyx_t_5;
+  int __pyx_t_6;
+  int __pyx_t_7;
+  PyObject *__pyx_t_8 = NULL;
+  PyObject *__pyx_t_9 = NULL;
+  PyObject *__pyx_t_10 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
+  __Pyx_RefNannySetupContext("__pyx_unpickle_Interpolation__set_state", 0);
+
+  /* "(tree fragment)":12
+ *     return __pyx_result
+ * cdef __pyx_unpickle_Interpolation__set_state(Interpolation __pyx_result, tuple __pyx_state):
+ *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result.atol = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.dt = __pyx_state[9]; __pyx_result.dt_min = __pyx_state[10]; __pyx_result.fac = __pyx_state[11]; __pyx_result.facmax = __pyx_state[12]; __pyx_result.facmin = __pyx_state[13]; __pyx_result.func = __pyx_state[14]; __pyx_result.nnz = __pyx_state[15]; __pyx_result.rtol = __pyx_state[16]; __pyx_result.t0 = __pyx_state[17]; __pyx_result.t1 = __pyx_state[18]; __pyx_result.t2 = __pyx_state[19]; __pyx_result.t3 = __pyx_state[20]; __pyx_result.t4 = __pyx_state[21]             # <<<<<<<<<<<<<<
+ *     if len(__pyx_state) > 22 and hasattr(__pyx_result, '__dict__'):
+ *         __pyx_result.__dict__.update(__pyx_state[22])
+ */
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->Ht0);
+  __Pyx_DECREF(__pyx_v___pyx_result->Ht0);
+  __pyx_v___pyx_result->Ht0 = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->Ht1);
+  __Pyx_DECREF(__pyx_v___pyx_result->Ht1);
+  __pyx_v___pyx_result->Ht1 = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 2, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->Ht2);
+  __Pyx_DECREF(__pyx_v___pyx_result->Ht2);
+  __pyx_v___pyx_result->Ht2 = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 3, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->Ht3);
+  __Pyx_DECREF(__pyx_v___pyx_result->Ht3);
+  __pyx_v___pyx_result->Ht3 = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 4, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->Ht4);
+  __Pyx_DECREF(__pyx_v___pyx_result->Ht4);
+  __pyx_v___pyx_result->Ht4 = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 5, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->atol = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 6, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->d2Ht0);
+  __Pyx_DECREF(__pyx_v___pyx_result->d2Ht0);
+  __pyx_v___pyx_result->d2Ht0 = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 7, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->d2Ht1);
+  __Pyx_DECREF(__pyx_v___pyx_result->d2Ht1);
+  __pyx_v___pyx_result->d2Ht1 = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 8, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->d2Ht2);
+  __Pyx_DECREF(__pyx_v___pyx_result->d2Ht2);
+  __pyx_v___pyx_result->d2Ht2 = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 9, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->dt = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 10, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->dt_min = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 11, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->fac = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 12, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->facmax = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 13, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->facmin = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 14, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->func);
+  __Pyx_DECREF(__pyx_v___pyx_result->func);
+  __pyx_v___pyx_result->func = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 15, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_3 = __Pyx_PyInt_As_unsigned_int(__pyx_t_1); if (unlikely((__pyx_t_3 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->nnz = __pyx_t_3;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 16, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->rtol = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 17, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->t0 = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 18, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->t1 = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 19, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->t2 = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 20, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->t3 = __pyx_t_2;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 21, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->t4 = __pyx_t_2;
+
+  /* "(tree fragment)":13
+ * cdef __pyx_unpickle_Interpolation__set_state(Interpolation __pyx_result, tuple __pyx_state):
+ *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result.atol = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.dt = __pyx_state[9]; __pyx_result.dt_min = __pyx_state[10]; __pyx_result.fac = __pyx_state[11]; __pyx_result.facmax = __pyx_state[12]; __pyx_result.facmin = __pyx_state[13]; __pyx_result.func = __pyx_state[14]; __pyx_result.nnz = __pyx_state[15]; __pyx_result.rtol = __pyx_state[16]; __pyx_result.t0 = __pyx_state[17]; __pyx_result.t1 = __pyx_state[18]; __pyx_result.t2 = __pyx_state[19]; __pyx_result.t3 = __pyx_state[20]; __pyx_result.t4 = __pyx_state[21]
+ *     if len(__pyx_state) > 22 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
+ *         __pyx_result.__dict__.update(__pyx_state[22])
+ */
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "object of type 'NoneType' has no len()");
+    __PYX_ERR(1, 13, __pyx_L1_error)
+  }
+  __pyx_t_5 = PyTuple_GET_SIZE(__pyx_v___pyx_state); if (unlikely(__pyx_t_5 == ((Py_ssize_t)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
+  __pyx_t_6 = ((__pyx_t_5 > 22) != 0);
+  if (__pyx_t_6) {
+  } else {
+    __pyx_t_4 = __pyx_t_6;
+    goto __pyx_L4_bool_binop_done;
+  }
+  __pyx_t_6 = __Pyx_HasAttr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(__pyx_t_6 == ((int)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
+  __pyx_t_7 = (__pyx_t_6 != 0);
+  __pyx_t_4 = __pyx_t_7;
+  __pyx_L4_bool_binop_done:;
+  if (__pyx_t_4) {
+
+    /* "(tree fragment)":14
+ *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result.atol = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.dt = __pyx_state[9]; __pyx_result.dt_min = __pyx_state[10]; __pyx_result.fac = __pyx_state[11]; __pyx_result.facmax = __pyx_state[12]; __pyx_result.facmin = __pyx_state[13]; __pyx_result.func = __pyx_state[14]; __pyx_result.nnz = __pyx_state[15]; __pyx_result.rtol = __pyx_state[16]; __pyx_result.t0 = __pyx_state[17]; __pyx_result.t1 = __pyx_state[18]; __pyx_result.t2 = __pyx_state[19]; __pyx_result.t3 = __pyx_state[20]; __pyx_result.t4 = __pyx_state[21]
+ *     if len(__pyx_state) > 22 and hasattr(__pyx_result, '__dict__'):
+ *         __pyx_result.__dict__.update(__pyx_state[22])             # <<<<<<<<<<<<<<
+ */
+    __pyx_t_8 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_update); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_9);
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    if (unlikely(__pyx_v___pyx_state == Py_None)) {
+      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+      __PYX_ERR(1, 14, __pyx_L1_error)
+    }
+    __pyx_t_8 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 22, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __pyx_t_10 = NULL;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_9))) {
+      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_9);
+      if (likely(__pyx_t_10)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
+        __Pyx_INCREF(__pyx_t_10);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_9, function);
+      }
+    }
+    __pyx_t_1 = (__pyx_t_10) ? __Pyx_PyObject_Call2Args(__pyx_t_9, __pyx_t_10, __pyx_t_8) : __Pyx_PyObject_CallOneArg(__pyx_t_9, __pyx_t_8);
+    __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+
+    /* "(tree fragment)":13
+ * cdef __pyx_unpickle_Interpolation__set_state(Interpolation __pyx_result, tuple __pyx_state):
+ *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result.atol = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.dt = __pyx_state[9]; __pyx_result.dt_min = __pyx_state[10]; __pyx_result.fac = __pyx_state[11]; __pyx_result.facmax = __pyx_state[12]; __pyx_result.facmin = __pyx_state[13]; __pyx_result.func = __pyx_state[14]; __pyx_result.nnz = __pyx_state[15]; __pyx_result.rtol = __pyx_state[16]; __pyx_result.t0 = __pyx_state[17]; __pyx_result.t1 = __pyx_state[18]; __pyx_result.t2 = __pyx_state[19]; __pyx_result.t3 = __pyx_state[20]; __pyx_result.t4 = __pyx_state[21]
+ *     if len(__pyx_state) > 22 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
+ *         __pyx_result.__dict__.update(__pyx_state[22])
+ */
+  }
+
+  /* "(tree fragment)":11
+ *         __pyx_unpickle_Interpolation__set_state(<Interpolation> __pyx_result, __pyx_state)
+ *     return __pyx_result
+ * cdef __pyx_unpickle_Interpolation__set_state(Interpolation __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
+ *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result.atol = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.dt = __pyx_state[9]; __pyx_result.dt_min = __pyx_state[10]; __pyx_result.fac = __pyx_state[11]; __pyx_result.facmax = __pyx_state[12]; __pyx_result.facmin = __pyx_state[13]; __pyx_result.func = __pyx_state[14]; __pyx_result.nnz = __pyx_state[15]; __pyx_result.rtol = __pyx_state[16]; __pyx_result.t0 = __pyx_state[17]; __pyx_result.t1 = __pyx_state[18]; __pyx_result.t2 = __pyx_state[19]; __pyx_result.t3 = __pyx_state[20]; __pyx_result.t4 = __pyx_state[21]
+ *     if len(__pyx_state) > 22 and hasattr(__pyx_result, '__dict__'):
+ */
+
+  /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  goto __pyx_L0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_XDECREF(__pyx_t_9);
+  __Pyx_XDECREF(__pyx_t_10);
+  __Pyx_AddTraceback("tkwant.onebody.kernels.__pyx_unpickle_Interpolation__set_state", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = 0;
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":1
  * def __pyx_unpickle_PerturbationExtractor(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
 
 /* Python wrapper */
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_7__pyx_unpickle_PerturbationExtractor(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static char __pyx_doc_6tkwant_7onebody_7kernels_6__pyx_unpickle_PerturbationExtractor[] = "__pyx_unpickle_PerturbationExtractor(__pyx_type, long __pyx_checksum, __pyx_state)";
 static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_7__pyx_unpickle_PerturbationExtractor = {"__pyx_unpickle_PerturbationExtractor", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_7__pyx_unpickle_PerturbationExtractor, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_6__pyx_unpickle_PerturbationExtractor};
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_7__pyx_unpickle_PerturbationExtractor(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v___pyx_type = 0;
   long __pyx_v___pyx_checksum;
   PyObject *__pyx_v___pyx_state = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__pyx_unpickle_PerturbationExtractor (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_type,&__pyx_n_s_pyx_checksum,&__pyx_n_s_pyx_state,0};
     PyObject* values[3] = {0,0,0};
     if (unlikely(__pyx_kwds)) {
@@ -18080,148 +19886,155 @@
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_6__pyx_unpickle_PerturbationExtractor(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_v___pyx_PickleError = 0;
   PyObject *__pyx_v___pyx_result = 0;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_t_2;
+  int __pyx_t_3;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
-  int __pyx_t_6;
+  PyObject *__pyx_t_6 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_PerturbationExtractor", 0);
 
   /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0x26d3271:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum not in (0x26d3271, 0xb233ad0, 0x66ecb55):             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x26d3271 = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x26d3271, 0xb233ad0, 0x66ecb55) = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
  */
-  __pyx_t_1 = ((__pyx_v___pyx_checksum != 0x26d3271) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = (__Pyx_PySequence_ContainsTF(__pyx_t_1, __pyx_tuple__11, Py_NE)); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_3 = (__pyx_t_2 != 0);
+  if (__pyx_t_3) {
 
     /* "(tree fragment)":5
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0x26d3271:
+ *     if __pyx_checksum not in (0x26d3271, 0xb233ad0, 0x66ecb55):
  *         from pickle import PickleError as __pyx_PickleError             # <<<<<<<<<<<<<<
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x26d3271 = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x26d3271, 0xb233ad0, 0x66ecb55) = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
  *     __pyx_result = PerturbationExtractor.__new__(__pyx_type)
  */
-    __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_1 = PyList_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
     __Pyx_INCREF(__pyx_n_s_PickleError);
     __Pyx_GIVEREF(__pyx_n_s_PickleError);
-    PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_PickleError);
-    __pyx_t_3 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_2, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_INCREF(__pyx_t_2);
-    __pyx_v___pyx_PickleError = __pyx_t_2;
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_s_PickleError);
+    __pyx_t_4 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_1, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = __Pyx_ImportFrom(__pyx_t_4, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_INCREF(__pyx_t_1);
+    __pyx_v___pyx_PickleError = __pyx_t_1;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
     /* "(tree fragment)":6
- *     if __pyx_checksum != 0x26d3271:
+ *     if __pyx_checksum not in (0x26d3271, 0xb233ad0, 0x66ecb55):
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x26d3271 = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)             # <<<<<<<<<<<<<<
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x26d3271, 0xb233ad0, 0x66ecb55) = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)             # <<<<<<<<<<<<<<
  *     __pyx_result = PerturbationExtractor.__new__(__pyx_type)
  *     if __pyx_state is not None:
  */
-    __pyx_t_2 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_4 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_s_vs_0x26, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_3, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_INCREF(__pyx_v___pyx_PickleError);
-    __pyx_t_2 = __pyx_v___pyx_PickleError; __pyx_t_5 = NULL;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
-      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
-      if (likely(__pyx_t_5)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-        __Pyx_INCREF(__pyx_t_5);
+    __pyx_t_1 = __pyx_v___pyx_PickleError; __pyx_t_6 = NULL;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
+      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
+      if (likely(__pyx_t_6)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+        __Pyx_INCREF(__pyx_t_6);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_2, function);
+        __Pyx_DECREF_SET(__pyx_t_1, function);
       }
     }
-    __pyx_t_3 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_5, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4);
-    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_4 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_5);
+    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_Raise(__pyx_t_4, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __PYX_ERR(1, 6, __pyx_L1_error)
 
     /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0x26d3271:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum not in (0x26d3271, 0xb233ad0, 0x66ecb55):             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x26d3271 = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x26d3271, 0xb233ad0, 0x66ecb55) = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
  */
   }
 
   /* "(tree fragment)":7
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x26d3271 = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x26d3271, 0xb233ad0, 0x66ecb55) = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
  *     __pyx_result = PerturbationExtractor.__new__(__pyx_type)             # <<<<<<<<<<<<<<
  *     if __pyx_state is not None:
  *         __pyx_unpickle_PerturbationExtractor__set_state(<PerturbationExtractor> __pyx_result, __pyx_state)
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_PerturbationExtractor), __pyx_n_s_new); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 7, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_4 = NULL;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
-    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
-    if (likely(__pyx_t_4)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-      __Pyx_INCREF(__pyx_t_4);
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_PerturbationExtractor), __pyx_n_s_new); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_5 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_1))) {
+    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_1);
+    if (likely(__pyx_t_5)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+      __Pyx_INCREF(__pyx_t_5);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_2, function);
+      __Pyx_DECREF_SET(__pyx_t_1, function);
     }
   }
-  __pyx_t_3 = (__pyx_t_4) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_4, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_v___pyx_type);
-  __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-  if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 7, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_v___pyx_result = __pyx_t_3;
-  __pyx_t_3 = 0;
+  __pyx_t_4 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_5, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_v___pyx_type);
+  __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+  if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result = __pyx_t_4;
+  __pyx_t_4 = 0;
 
   /* "(tree fragment)":8
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x26d3271 = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x26d3271, 0xb233ad0, 0x66ecb55) = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
  *     __pyx_result = PerturbationExtractor.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_PerturbationExtractor__set_state(<PerturbationExtractor> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
-  __pyx_t_1 = (__pyx_v___pyx_state != Py_None);
-  __pyx_t_6 = (__pyx_t_1 != 0);
-  if (__pyx_t_6) {
+  __pyx_t_3 = (__pyx_v___pyx_state != Py_None);
+  __pyx_t_2 = (__pyx_t_3 != 0);
+  if (__pyx_t_2) {
 
     /* "(tree fragment)":9
  *     __pyx_result = PerturbationExtractor.__new__(__pyx_type)
  *     if __pyx_state is not None:
  *         __pyx_unpickle_PerturbationExtractor__set_state(<PerturbationExtractor> __pyx_result, __pyx_state)             # <<<<<<<<<<<<<<
  *     return __pyx_result
  * cdef __pyx_unpickle_PerturbationExtractor__set_state(PerturbationExtractor __pyx_result, tuple __pyx_state):
  */
-    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
-    __pyx_t_3 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_PerturbationExtractor__set_state(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 9, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
+    __pyx_t_4 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_PerturbationExtractor__set_state(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 9, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
     /* "(tree fragment)":8
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x26d3271 = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x26d3271, 0xb233ad0, 0x66ecb55) = (H, nnz, size, td_hamiltonian, time_name, tparams))" % __pyx_checksum)
  *     __pyx_result = PerturbationExtractor.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_PerturbationExtractor__set_state(<PerturbationExtractor> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
   }
 
@@ -18241,18 +20054,18 @@
  * def __pyx_unpickle_PerturbationExtractor(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
   __Pyx_AddTraceback("tkwant.onebody.kernels.__pyx_unpickle_PerturbationExtractor", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v___pyx_PickleError);
   __Pyx_XDECREF(__pyx_v___pyx_result);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
@@ -18275,14 +20088,17 @@
   int __pyx_t_3;
   Py_ssize_t __pyx_t_4;
   int __pyx_t_5;
   int __pyx_t_6;
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   PyObject *__pyx_t_9 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_PerturbationExtractor__set_state", 0);
 
   /* "(tree fragment)":12
  *     return __pyx_result
  * cdef __pyx_unpickle_PerturbationExtractor__set_state(PerturbationExtractor __pyx_result, tuple __pyx_state):
  *     __pyx_result.H = __pyx_state[0]; __pyx_result.nnz = __pyx_state[1]; __pyx_result.size = __pyx_state[2]; __pyx_result.td_hamiltonian = __pyx_state[3]; __pyx_result.time_name = __pyx_state[4]; __pyx_result.tparams = __pyx_state[5]             # <<<<<<<<<<<<<<
  *     if len(__pyx_state) > 6 and hasattr(__pyx_result, '__dict__'):
@@ -18450,14 +20266,17 @@
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9__pyx_unpickle_PerturbationInterpolator(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static char __pyx_doc_6tkwant_7onebody_7kernels_8__pyx_unpickle_PerturbationInterpolator[] = "__pyx_unpickle_PerturbationInterpolator(__pyx_type, long __pyx_checksum, __pyx_state)";
 static PyMethodDef __pyx_mdef_6tkwant_7onebody_7kernels_9__pyx_unpickle_PerturbationInterpolator = {"__pyx_unpickle_PerturbationInterpolator", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_9__pyx_unpickle_PerturbationInterpolator, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_8__pyx_unpickle_PerturbationInterpolator};
 static PyObject *__pyx_pw_6tkwant_7onebody_7kernels_9__pyx_unpickle_PerturbationInterpolator(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v___pyx_type = 0;
   long __pyx_v___pyx_checksum;
   PyObject *__pyx_v___pyx_state = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__pyx_unpickle_PerturbationInterpolator (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_type,&__pyx_n_s_pyx_checksum,&__pyx_n_s_pyx_state,0};
     PyObject* values[3] = {0,0,0};
     if (unlikely(__pyx_kwds)) {
@@ -18521,595 +20340,380 @@
 }
 
 static PyObject *__pyx_pf_6tkwant_7onebody_7kernels_8__pyx_unpickle_PerturbationInterpolator(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_v___pyx_PickleError = 0;
   PyObject *__pyx_v___pyx_result = 0;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_t_2;
+  int __pyx_t_3;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
-  int __pyx_t_6;
+  PyObject *__pyx_t_6 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_PerturbationInterpolator", 0);
 
   /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0x1aa04ed:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum not in (0x2ce0fe7, 0xd117aad, 0x95d9714):             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x1aa04ed = (Ht0, Ht1, Ht2, Ht3, Ht4, _do_update, d2Ht0, d2Ht1, d2Ht2, d2y0, d2y1, dt, nnz, size, t0, t1, t2, t3, t4, time_name, time_start, tterms, wfunc, wt, x0, x1, y0, y1))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x2ce0fe7, 0xd117aad, 0x95d9714) = (dt, intfunc, nnz, size, wfunc, wt))" % __pyx_checksum)
  */
-  __pyx_t_1 = ((__pyx_v___pyx_checksum != 0x1aa04ed) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = (__Pyx_PySequence_ContainsTF(__pyx_t_1, __pyx_tuple__12, Py_NE)); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_3 = (__pyx_t_2 != 0);
+  if (__pyx_t_3) {
 
     /* "(tree fragment)":5
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0x1aa04ed:
+ *     if __pyx_checksum not in (0x2ce0fe7, 0xd117aad, 0x95d9714):
  *         from pickle import PickleError as __pyx_PickleError             # <<<<<<<<<<<<<<
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x1aa04ed = (Ht0, Ht1, Ht2, Ht3, Ht4, _do_update, d2Ht0, d2Ht1, d2Ht2, d2y0, d2y1, dt, nnz, size, t0, t1, t2, t3, t4, time_name, time_start, tterms, wfunc, wt, x0, x1, y0, y1))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x2ce0fe7, 0xd117aad, 0x95d9714) = (dt, intfunc, nnz, size, wfunc, wt))" % __pyx_checksum)
  *     __pyx_result = PerturbationInterpolator.__new__(__pyx_type)
  */
-    __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_1 = PyList_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
     __Pyx_INCREF(__pyx_n_s_PickleError);
     __Pyx_GIVEREF(__pyx_n_s_PickleError);
-    PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_PickleError);
-    __pyx_t_3 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_2, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_INCREF(__pyx_t_2);
-    __pyx_v___pyx_PickleError = __pyx_t_2;
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_s_PickleError);
+    __pyx_t_4 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_1, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = __Pyx_ImportFrom(__pyx_t_4, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_INCREF(__pyx_t_1);
+    __pyx_v___pyx_PickleError = __pyx_t_1;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
     /* "(tree fragment)":6
- *     if __pyx_checksum != 0x1aa04ed:
+ *     if __pyx_checksum not in (0x2ce0fe7, 0xd117aad, 0x95d9714):
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x1aa04ed = (Ht0, Ht1, Ht2, Ht3, Ht4, _do_update, d2Ht0, d2Ht1, d2Ht2, d2y0, d2y1, dt, nnz, size, t0, t1, t2, t3, t4, time_name, time_start, tterms, wfunc, wt, x0, x1, y0, y1))" % __pyx_checksum)             # <<<<<<<<<<<<<<
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x2ce0fe7, 0xd117aad, 0x95d9714) = (dt, intfunc, nnz, size, wfunc, wt))" % __pyx_checksum)             # <<<<<<<<<<<<<<
  *     __pyx_result = PerturbationInterpolator.__new__(__pyx_type)
  *     if __pyx_state is not None:
  */
-    __pyx_t_2 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_4 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_s_vs_0x1a, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_4, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_INCREF(__pyx_v___pyx_PickleError);
-    __pyx_t_2 = __pyx_v___pyx_PickleError; __pyx_t_5 = NULL;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
-      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
-      if (likely(__pyx_t_5)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-        __Pyx_INCREF(__pyx_t_5);
+    __pyx_t_1 = __pyx_v___pyx_PickleError; __pyx_t_6 = NULL;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
+      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
+      if (likely(__pyx_t_6)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+        __Pyx_INCREF(__pyx_t_6);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_2, function);
+        __Pyx_DECREF_SET(__pyx_t_1, function);
       }
     }
-    __pyx_t_3 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_5, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4);
-    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_4 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_5);
+    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_Raise(__pyx_t_4, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __PYX_ERR(1, 6, __pyx_L1_error)
 
     /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0x1aa04ed:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum not in (0x2ce0fe7, 0xd117aad, 0x95d9714):             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x1aa04ed = (Ht0, Ht1, Ht2, Ht3, Ht4, _do_update, d2Ht0, d2Ht1, d2Ht2, d2y0, d2y1, dt, nnz, size, t0, t1, t2, t3, t4, time_name, time_start, tterms, wfunc, wt, x0, x1, y0, y1))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x2ce0fe7, 0xd117aad, 0x95d9714) = (dt, intfunc, nnz, size, wfunc, wt))" % __pyx_checksum)
  */
   }
 
   /* "(tree fragment)":7
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x1aa04ed = (Ht0, Ht1, Ht2, Ht3, Ht4, _do_update, d2Ht0, d2Ht1, d2Ht2, d2y0, d2y1, dt, nnz, size, t0, t1, t2, t3, t4, time_name, time_start, tterms, wfunc, wt, x0, x1, y0, y1))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x2ce0fe7, 0xd117aad, 0x95d9714) = (dt, intfunc, nnz, size, wfunc, wt))" % __pyx_checksum)
  *     __pyx_result = PerturbationInterpolator.__new__(__pyx_type)             # <<<<<<<<<<<<<<
  *     if __pyx_state is not None:
  *         __pyx_unpickle_PerturbationInterpolator__set_state(<PerturbationInterpolator> __pyx_result, __pyx_state)
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_PerturbationInterpolator), __pyx_n_s_new); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 7, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_4 = NULL;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
-    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
-    if (likely(__pyx_t_4)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-      __Pyx_INCREF(__pyx_t_4);
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_PerturbationInterpolator), __pyx_n_s_new); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_5 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_1))) {
+    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_1);
+    if (likely(__pyx_t_5)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+      __Pyx_INCREF(__pyx_t_5);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_2, function);
+      __Pyx_DECREF_SET(__pyx_t_1, function);
     }
   }
-  __pyx_t_3 = (__pyx_t_4) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_4, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_v___pyx_type);
-  __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-  if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 7, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_v___pyx_result = __pyx_t_3;
-  __pyx_t_3 = 0;
+  __pyx_t_4 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_5, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_v___pyx_type);
+  __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+  if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result = __pyx_t_4;
+  __pyx_t_4 = 0;
 
   /* "(tree fragment)":8
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x1aa04ed = (Ht0, Ht1, Ht2, Ht3, Ht4, _do_update, d2Ht0, d2Ht1, d2Ht2, d2y0, d2y1, dt, nnz, size, t0, t1, t2, t3, t4, time_name, time_start, tterms, wfunc, wt, x0, x1, y0, y1))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x2ce0fe7, 0xd117aad, 0x95d9714) = (dt, intfunc, nnz, size, wfunc, wt))" % __pyx_checksum)
  *     __pyx_result = PerturbationInterpolator.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_PerturbationInterpolator__set_state(<PerturbationInterpolator> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
-  __pyx_t_1 = (__pyx_v___pyx_state != Py_None);
-  __pyx_t_6 = (__pyx_t_1 != 0);
-  if (__pyx_t_6) {
+  __pyx_t_3 = (__pyx_v___pyx_state != Py_None);
+  __pyx_t_2 = (__pyx_t_3 != 0);
+  if (__pyx_t_2) {
 
     /* "(tree fragment)":9
  *     __pyx_result = PerturbationInterpolator.__new__(__pyx_type)
  *     if __pyx_state is not None:
  *         __pyx_unpickle_PerturbationInterpolator__set_state(<PerturbationInterpolator> __pyx_result, __pyx_state)             # <<<<<<<<<<<<<<
  *     return __pyx_result
  * cdef __pyx_unpickle_PerturbationInterpolator__set_state(PerturbationInterpolator __pyx_result, tuple __pyx_state):
  */
-    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
-    __pyx_t_3 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_PerturbationInterpolator__set_state(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 9, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
+    __pyx_t_4 = __pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_PerturbationInterpolator__set_state(((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 9, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
     /* "(tree fragment)":8
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0x1aa04ed = (Ht0, Ht1, Ht2, Ht3, Ht4, _do_update, d2Ht0, d2Ht1, d2Ht2, d2y0, d2y1, dt, nnz, size, t0, t1, t2, t3, t4, time_name, time_start, tterms, wfunc, wt, x0, x1, y0, y1))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x2ce0fe7, 0xd117aad, 0x95d9714) = (dt, intfunc, nnz, size, wfunc, wt))" % __pyx_checksum)
  *     __pyx_result = PerturbationInterpolator.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_PerturbationInterpolator__set_state(<PerturbationInterpolator> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
   }
 
   /* "(tree fragment)":10
  *     if __pyx_state is not None:
  *         __pyx_unpickle_PerturbationInterpolator__set_state(<PerturbationInterpolator> __pyx_result, __pyx_state)
  *     return __pyx_result             # <<<<<<<<<<<<<<
  * cdef __pyx_unpickle_PerturbationInterpolator__set_state(PerturbationInterpolator __pyx_result, tuple __pyx_state):
- *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result._do_update = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.d2y0 = __pyx_state[9]; __pyx_result.d2y1 = __pyx_state[10]; __pyx_result.dt = __pyx_state[11]; __pyx_result.nnz = __pyx_state[12]; __pyx_result.size = __pyx_state[13]; __pyx_result.t0 = __pyx_state[14]; __pyx_result.t1 = __pyx_state[15]; __pyx_result.t2 = __pyx_state[16]; __pyx_result.t3 = __pyx_state[17]; __pyx_result.t4 = __pyx_state[18]; __pyx_result.time_name = __pyx_state[19]; __pyx_result.time_start = __pyx_state[20]; __pyx_result.tterms = __pyx_state[21]; __pyx_result.wfunc = __pyx_state[22]; __pyx_result.wt = __pyx_state[23]; __pyx_result.x0 = __pyx_state[24]; __pyx_result.x1 = __pyx_state[25]; __pyx_result.y0 = __pyx_state[26]; __pyx_result.y1 = __pyx_state[27]
+ *     __pyx_result.dt = __pyx_state[0]; __pyx_result.intfunc = __pyx_state[1]; __pyx_result.nnz = __pyx_state[2]; __pyx_result.size = __pyx_state[3]; __pyx_result.wfunc = __pyx_state[4]; __pyx_result.wt = __pyx_state[5]
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(__pyx_v___pyx_result);
   __pyx_r = __pyx_v___pyx_result;
   goto __pyx_L0;
 
   /* "(tree fragment)":1
  * def __pyx_unpickle_PerturbationInterpolator(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
   __Pyx_AddTraceback("tkwant.onebody.kernels.__pyx_unpickle_PerturbationInterpolator", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v___pyx_PickleError);
   __Pyx_XDECREF(__pyx_v___pyx_result);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
 /* "(tree fragment)":11
  *         __pyx_unpickle_PerturbationInterpolator__set_state(<PerturbationInterpolator> __pyx_result, __pyx_state)
  *     return __pyx_result
  * cdef __pyx_unpickle_PerturbationInterpolator__set_state(PerturbationInterpolator __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result._do_update = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.d2y0 = __pyx_state[9]; __pyx_result.d2y1 = __pyx_state[10]; __pyx_result.dt = __pyx_state[11]; __pyx_result.nnz = __pyx_state[12]; __pyx_result.size = __pyx_state[13]; __pyx_result.t0 = __pyx_state[14]; __pyx_result.t1 = __pyx_state[15]; __pyx_result.t2 = __pyx_state[16]; __pyx_result.t3 = __pyx_state[17]; __pyx_result.t4 = __pyx_state[18]; __pyx_result.time_name = __pyx_state[19]; __pyx_result.time_start = __pyx_state[20]; __pyx_result.tterms = __pyx_state[21]; __pyx_result.wfunc = __pyx_state[22]; __pyx_result.wt = __pyx_state[23]; __pyx_result.x0 = __pyx_state[24]; __pyx_result.x1 = __pyx_state[25]; __pyx_result.y0 = __pyx_state[26]; __pyx_result.y1 = __pyx_state[27]
- *     if len(__pyx_state) > 28 and hasattr(__pyx_result, '__dict__'):
+ *     __pyx_result.dt = __pyx_state[0]; __pyx_result.intfunc = __pyx_state[1]; __pyx_result.nnz = __pyx_state[2]; __pyx_result.size = __pyx_state[3]; __pyx_result.wfunc = __pyx_state[4]; __pyx_result.wt = __pyx_state[5]
+ *     if len(__pyx_state) > 6 and hasattr(__pyx_result, '__dict__'):
  */
 
 static PyObject *__pyx_f_6tkwant_7onebody_7kernels___pyx_unpickle_PerturbationInterpolator__set_state(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *__pyx_v___pyx_result, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
-  int __pyx_t_2;
-  double __pyx_t_3;
-  unsigned int __pyx_t_4;
-  int __pyx_t_5;
-  Py_ssize_t __pyx_t_6;
+  double __pyx_t_2;
+  unsigned int __pyx_t_3;
+  int __pyx_t_4;
+  Py_ssize_t __pyx_t_5;
+  int __pyx_t_6;
   int __pyx_t_7;
-  int __pyx_t_8;
+  PyObject *__pyx_t_8 = NULL;
   PyObject *__pyx_t_9 = NULL;
   PyObject *__pyx_t_10 = NULL;
-  PyObject *__pyx_t_11 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_PerturbationInterpolator__set_state", 0);
 
   /* "(tree fragment)":12
  *     return __pyx_result
  * cdef __pyx_unpickle_PerturbationInterpolator__set_state(PerturbationInterpolator __pyx_result, tuple __pyx_state):
- *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result._do_update = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.d2y0 = __pyx_state[9]; __pyx_result.d2y1 = __pyx_state[10]; __pyx_result.dt = __pyx_state[11]; __pyx_result.nnz = __pyx_state[12]; __pyx_result.size = __pyx_state[13]; __pyx_result.t0 = __pyx_state[14]; __pyx_result.t1 = __pyx_state[15]; __pyx_result.t2 = __pyx_state[16]; __pyx_result.t3 = __pyx_state[17]; __pyx_result.t4 = __pyx_state[18]; __pyx_result.time_name = __pyx_state[19]; __pyx_result.time_start = __pyx_state[20]; __pyx_result.tterms = __pyx_state[21]; __pyx_result.wfunc = __pyx_state[22]; __pyx_result.wt = __pyx_state[23]; __pyx_result.x0 = __pyx_state[24]; __pyx_result.x1 = __pyx_state[25]; __pyx_result.y0 = __pyx_state[26]; __pyx_result.y1 = __pyx_state[27]             # <<<<<<<<<<<<<<
- *     if len(__pyx_state) > 28 and hasattr(__pyx_result, '__dict__'):
- *         __pyx_result.__dict__.update(__pyx_state[28])
+ *     __pyx_result.dt = __pyx_state[0]; __pyx_result.intfunc = __pyx_state[1]; __pyx_result.nnz = __pyx_state[2]; __pyx_result.size = __pyx_state[3]; __pyx_result.wfunc = __pyx_state[4]; __pyx_result.wt = __pyx_state[5]             # <<<<<<<<<<<<<<
+ *     if len(__pyx_state) > 6 and hasattr(__pyx_result, '__dict__'):
+ *         __pyx_result.__dict__.update(__pyx_state[6])
  */
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
   __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->Ht0);
-  __Pyx_DECREF(__pyx_v___pyx_result->Ht0);
-  __pyx_v___pyx_result->Ht0 = __pyx_t_1;
-  __pyx_t_1 = 0;
+  __pyx_t_2 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_2 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->dt = __pyx_t_2;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
   __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->Ht1);
-  __Pyx_DECREF(__pyx_v___pyx_result->Ht1);
-  __pyx_v___pyx_result->Ht1 = __pyx_t_1;
+  __Pyx_GOTREF(__pyx_v___pyx_result->intfunc);
+  __Pyx_DECREF(__pyx_v___pyx_result->intfunc);
+  __pyx_v___pyx_result->intfunc = __pyx_t_1;
   __pyx_t_1 = 0;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
   __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 2, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->Ht2);
-  __Pyx_DECREF(__pyx_v___pyx_result->Ht2);
-  __pyx_v___pyx_result->Ht2 = __pyx_t_1;
-  __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 3, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->Ht3);
-  __Pyx_DECREF(__pyx_v___pyx_result->Ht3);
-  __pyx_v___pyx_result->Ht3 = __pyx_t_1;
-  __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 4, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->Ht4);
-  __Pyx_DECREF(__pyx_v___pyx_result->Ht4);
-  __pyx_v___pyx_result->Ht4 = __pyx_t_1;
-  __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 5, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_2 == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->_do_update = __pyx_t_2;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 6, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->d2Ht0);
-  __Pyx_DECREF(__pyx_v___pyx_result->d2Ht0);
-  __pyx_v___pyx_result->d2Ht0 = __pyx_t_1;
-  __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 7, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->d2Ht1);
-  __Pyx_DECREF(__pyx_v___pyx_result->d2Ht1);
-  __pyx_v___pyx_result->d2Ht1 = __pyx_t_1;
-  __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 8, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->d2Ht2);
-  __Pyx_DECREF(__pyx_v___pyx_result->d2Ht2);
-  __pyx_v___pyx_result->d2Ht2 = __pyx_t_1;
-  __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 9, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->d2y0);
-  __Pyx_DECREF(__pyx_v___pyx_result->d2y0);
-  __pyx_v___pyx_result->d2y0 = __pyx_t_1;
-  __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 10, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->d2y1);
-  __Pyx_DECREF(__pyx_v___pyx_result->d2y1);
-  __pyx_v___pyx_result->d2y1 = __pyx_t_1;
-  __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 11, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->dt = __pyx_t_3;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 12, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_4 = __Pyx_PyInt_As_unsigned_int(__pyx_t_1); if (unlikely((__pyx_t_4 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->nnz = __pyx_t_4;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 13, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_4 = __Pyx_PyInt_As_unsigned_int(__pyx_t_1); if (unlikely((__pyx_t_4 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->size = __pyx_t_4;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 14, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->t0 = __pyx_t_3;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 15, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->t1 = __pyx_t_3;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 16, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->t2 = __pyx_t_3;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 17, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->t3 = __pyx_t_3;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 18, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyInt_As_unsigned_int(__pyx_t_1); if (unlikely((__pyx_t_3 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->t4 = __pyx_t_3;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 19, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->time_name);
-  __Pyx_DECREF(__pyx_v___pyx_result->time_name);
-  __pyx_v___pyx_result->time_name = __pyx_t_1;
-  __pyx_t_1 = 0;
+  __pyx_v___pyx_result->nnz = __pyx_t_3;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 20, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 3, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyInt_As_unsigned_int(__pyx_t_1); if (unlikely((__pyx_t_3 == (unsigned int)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->time_start = __pyx_t_3;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 21, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->tterms);
-  __Pyx_DECREF(__pyx_v___pyx_result->tterms);
-  __pyx_v___pyx_result->tterms = __pyx_t_1;
-  __pyx_t_1 = 0;
+  __pyx_v___pyx_result->size = __pyx_t_3;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 22, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 4, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_1);
   __Pyx_GOTREF(__pyx_v___pyx_result->wfunc);
   __Pyx_DECREF(__pyx_v___pyx_result->wfunc);
   __pyx_v___pyx_result->wfunc = __pyx_t_1;
   __pyx_t_1 = 0;
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
     __PYX_ERR(1, 12, __pyx_L1_error)
   }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 23, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 5, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_1);
   __Pyx_GOTREF(__pyx_v___pyx_result->wt);
   __Pyx_DECREF(__pyx_v___pyx_result->wt);
   __pyx_v___pyx_result->wt = __pyx_t_1;
   __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 24, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->x0 = __pyx_t_3;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 25, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __pyx_PyFloat_AsDouble(__pyx_t_1); if (unlikely((__pyx_t_3 == (double)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_v___pyx_result->x1 = __pyx_t_3;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 26, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->y0);
-  __Pyx_DECREF(__pyx_v___pyx_result->y0);
-  __pyx_v___pyx_result->y0 = __pyx_t_1;
-  __pyx_t_1 = 0;
-  if (unlikely(__pyx_v___pyx_state == Py_None)) {
-    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
-    __PYX_ERR(1, 12, __pyx_L1_error)
-  }
-  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 27, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_1);
-  __Pyx_GOTREF(__pyx_v___pyx_result->y1);
-  __Pyx_DECREF(__pyx_v___pyx_result->y1);
-  __pyx_v___pyx_result->y1 = __pyx_t_1;
-  __pyx_t_1 = 0;
 
   /* "(tree fragment)":13
  * cdef __pyx_unpickle_PerturbationInterpolator__set_state(PerturbationInterpolator __pyx_result, tuple __pyx_state):
- *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result._do_update = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.d2y0 = __pyx_state[9]; __pyx_result.d2y1 = __pyx_state[10]; __pyx_result.dt = __pyx_state[11]; __pyx_result.nnz = __pyx_state[12]; __pyx_result.size = __pyx_state[13]; __pyx_result.t0 = __pyx_state[14]; __pyx_result.t1 = __pyx_state[15]; __pyx_result.t2 = __pyx_state[16]; __pyx_result.t3 = __pyx_state[17]; __pyx_result.t4 = __pyx_state[18]; __pyx_result.time_name = __pyx_state[19]; __pyx_result.time_start = __pyx_state[20]; __pyx_result.tterms = __pyx_state[21]; __pyx_result.wfunc = __pyx_state[22]; __pyx_result.wt = __pyx_state[23]; __pyx_result.x0 = __pyx_state[24]; __pyx_result.x1 = __pyx_state[25]; __pyx_result.y0 = __pyx_state[26]; __pyx_result.y1 = __pyx_state[27]
- *     if len(__pyx_state) > 28 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
- *         __pyx_result.__dict__.update(__pyx_state[28])
+ *     __pyx_result.dt = __pyx_state[0]; __pyx_result.intfunc = __pyx_state[1]; __pyx_result.nnz = __pyx_state[2]; __pyx_result.size = __pyx_state[3]; __pyx_result.wfunc = __pyx_state[4]; __pyx_result.wt = __pyx_state[5]
+ *     if len(__pyx_state) > 6 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
+ *         __pyx_result.__dict__.update(__pyx_state[6])
  */
   if (unlikely(__pyx_v___pyx_state == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "object of type 'NoneType' has no len()");
     __PYX_ERR(1, 13, __pyx_L1_error)
   }
-  __pyx_t_6 = PyTuple_GET_SIZE(__pyx_v___pyx_state); if (unlikely(__pyx_t_6 == ((Py_ssize_t)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
-  __pyx_t_7 = ((__pyx_t_6 > 28) != 0);
-  if (__pyx_t_7) {
+  __pyx_t_5 = PyTuple_GET_SIZE(__pyx_v___pyx_state); if (unlikely(__pyx_t_5 == ((Py_ssize_t)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
+  __pyx_t_6 = ((__pyx_t_5 > 6) != 0);
+  if (__pyx_t_6) {
   } else {
-    __pyx_t_5 = __pyx_t_7;
+    __pyx_t_4 = __pyx_t_6;
     goto __pyx_L4_bool_binop_done;
   }
-  __pyx_t_7 = __Pyx_HasAttr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(__pyx_t_7 == ((int)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
-  __pyx_t_8 = (__pyx_t_7 != 0);
-  __pyx_t_5 = __pyx_t_8;
+  __pyx_t_6 = __Pyx_HasAttr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(__pyx_t_6 == ((int)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
+  __pyx_t_7 = (__pyx_t_6 != 0);
+  __pyx_t_4 = __pyx_t_7;
   __pyx_L4_bool_binop_done:;
-  if (__pyx_t_5) {
+  if (__pyx_t_4) {
 
     /* "(tree fragment)":14
- *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result._do_update = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.d2y0 = __pyx_state[9]; __pyx_result.d2y1 = __pyx_state[10]; __pyx_result.dt = __pyx_state[11]; __pyx_result.nnz = __pyx_state[12]; __pyx_result.size = __pyx_state[13]; __pyx_result.t0 = __pyx_state[14]; __pyx_result.t1 = __pyx_state[15]; __pyx_result.t2 = __pyx_state[16]; __pyx_result.t3 = __pyx_state[17]; __pyx_result.t4 = __pyx_state[18]; __pyx_result.time_name = __pyx_state[19]; __pyx_result.time_start = __pyx_state[20]; __pyx_result.tterms = __pyx_state[21]; __pyx_result.wfunc = __pyx_state[22]; __pyx_result.wt = __pyx_state[23]; __pyx_result.x0 = __pyx_state[24]; __pyx_result.x1 = __pyx_state[25]; __pyx_result.y0 = __pyx_state[26]; __pyx_result.y1 = __pyx_state[27]
- *     if len(__pyx_state) > 28 and hasattr(__pyx_result, '__dict__'):
- *         __pyx_result.__dict__.update(__pyx_state[28])             # <<<<<<<<<<<<<<
+ *     __pyx_result.dt = __pyx_state[0]; __pyx_result.intfunc = __pyx_state[1]; __pyx_result.nnz = __pyx_state[2]; __pyx_result.size = __pyx_state[3]; __pyx_result.wfunc = __pyx_state[4]; __pyx_result.wt = __pyx_state[5]
+ *     if len(__pyx_state) > 6 and hasattr(__pyx_result, '__dict__'):
+ *         __pyx_result.__dict__.update(__pyx_state[6])             # <<<<<<<<<<<<<<
  */
-    __pyx_t_9 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __pyx_t_8 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_t_8, __pyx_n_s_update); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 14, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_10 = __Pyx_PyObject_GetAttrStr(__pyx_t_9, __pyx_n_s_update); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 14, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_10);
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     if (unlikely(__pyx_v___pyx_state == Py_None)) {
       PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
       __PYX_ERR(1, 14, __pyx_L1_error)
     }
-    __pyx_t_9 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 28, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 14, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_9);
-    __pyx_t_11 = NULL;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_10))) {
-      __pyx_t_11 = PyMethod_GET_SELF(__pyx_t_10);
-      if (likely(__pyx_t_11)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_10);
-        __Pyx_INCREF(__pyx_t_11);
+    __pyx_t_8 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 6, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __pyx_t_10 = NULL;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_9))) {
+      __pyx_t_10 = PyMethod_GET_SELF(__pyx_t_9);
+      if (likely(__pyx_t_10)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_9);
+        __Pyx_INCREF(__pyx_t_10);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_10, function);
+        __Pyx_DECREF_SET(__pyx_t_9, function);
       }
     }
-    __pyx_t_1 = (__pyx_t_11) ? __Pyx_PyObject_Call2Args(__pyx_t_10, __pyx_t_11, __pyx_t_9) : __Pyx_PyObject_CallOneArg(__pyx_t_10, __pyx_t_9);
-    __Pyx_XDECREF(__pyx_t_11); __pyx_t_11 = 0;
-    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __pyx_t_1 = (__pyx_t_10) ? __Pyx_PyObject_Call2Args(__pyx_t_9, __pyx_t_10, __pyx_t_8) : __Pyx_PyObject_CallOneArg(__pyx_t_9, __pyx_t_8);
+    __Pyx_XDECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 14, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
+    __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
     /* "(tree fragment)":13
  * cdef __pyx_unpickle_PerturbationInterpolator__set_state(PerturbationInterpolator __pyx_result, tuple __pyx_state):
- *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result._do_update = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.d2y0 = __pyx_state[9]; __pyx_result.d2y1 = __pyx_state[10]; __pyx_result.dt = __pyx_state[11]; __pyx_result.nnz = __pyx_state[12]; __pyx_result.size = __pyx_state[13]; __pyx_result.t0 = __pyx_state[14]; __pyx_result.t1 = __pyx_state[15]; __pyx_result.t2 = __pyx_state[16]; __pyx_result.t3 = __pyx_state[17]; __pyx_result.t4 = __pyx_state[18]; __pyx_result.time_name = __pyx_state[19]; __pyx_result.time_start = __pyx_state[20]; __pyx_result.tterms = __pyx_state[21]; __pyx_result.wfunc = __pyx_state[22]; __pyx_result.wt = __pyx_state[23]; __pyx_result.x0 = __pyx_state[24]; __pyx_result.x1 = __pyx_state[25]; __pyx_result.y0 = __pyx_state[26]; __pyx_result.y1 = __pyx_state[27]
- *     if len(__pyx_state) > 28 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
- *         __pyx_result.__dict__.update(__pyx_state[28])
+ *     __pyx_result.dt = __pyx_state[0]; __pyx_result.intfunc = __pyx_state[1]; __pyx_result.nnz = __pyx_state[2]; __pyx_result.size = __pyx_state[3]; __pyx_result.wfunc = __pyx_state[4]; __pyx_result.wt = __pyx_state[5]
+ *     if len(__pyx_state) > 6 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
+ *         __pyx_result.__dict__.update(__pyx_state[6])
  */
   }
 
   /* "(tree fragment)":11
  *         __pyx_unpickle_PerturbationInterpolator__set_state(<PerturbationInterpolator> __pyx_result, __pyx_state)
  *     return __pyx_result
  * cdef __pyx_unpickle_PerturbationInterpolator__set_state(PerturbationInterpolator __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
- *     __pyx_result.Ht0 = __pyx_state[0]; __pyx_result.Ht1 = __pyx_state[1]; __pyx_result.Ht2 = __pyx_state[2]; __pyx_result.Ht3 = __pyx_state[3]; __pyx_result.Ht4 = __pyx_state[4]; __pyx_result._do_update = __pyx_state[5]; __pyx_result.d2Ht0 = __pyx_state[6]; __pyx_result.d2Ht1 = __pyx_state[7]; __pyx_result.d2Ht2 = __pyx_state[8]; __pyx_result.d2y0 = __pyx_state[9]; __pyx_result.d2y1 = __pyx_state[10]; __pyx_result.dt = __pyx_state[11]; __pyx_result.nnz = __pyx_state[12]; __pyx_result.size = __pyx_state[13]; __pyx_result.t0 = __pyx_state[14]; __pyx_result.t1 = __pyx_state[15]; __pyx_result.t2 = __pyx_state[16]; __pyx_result.t3 = __pyx_state[17]; __pyx_result.t4 = __pyx_state[18]; __pyx_result.time_name = __pyx_state[19]; __pyx_result.time_start = __pyx_state[20]; __pyx_result.tterms = __pyx_state[21]; __pyx_result.wfunc = __pyx_state[22]; __pyx_result.wt = __pyx_state[23]; __pyx_result.x0 = __pyx_state[24]; __pyx_result.x1 = __pyx_state[25]; __pyx_result.y0 = __pyx_state[26]; __pyx_result.y1 = __pyx_state[27]
- *     if len(__pyx_state) > 28 and hasattr(__pyx_result, '__dict__'):
+ *     __pyx_result.dt = __pyx_state[0]; __pyx_result.intfunc = __pyx_state[1]; __pyx_result.nnz = __pyx_state[2]; __pyx_result.size = __pyx_state[3]; __pyx_result.wfunc = __pyx_state[4]; __pyx_result.wt = __pyx_state[5]
+ *     if len(__pyx_state) > 6 and hasattr(__pyx_result, '__dict__'):
  */
 
   /* function exit code */
   __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_8);
   __Pyx_XDECREF(__pyx_t_9);
   __Pyx_XDECREF(__pyx_t_10);
-  __Pyx_XDECREF(__pyx_t_11);
   __Pyx_AddTraceback("tkwant.onebody.kernels.__pyx_unpickle_PerturbationInterpolator__set_state", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":122
+/* "View.MemoryView":123
  *         cdef bint dtype_is_object
  * 
  *     def __cinit__(array self, tuple shape, Py_ssize_t itemsize, format not None,             # <<<<<<<<<<<<<<
  *                   mode="c", bint allocate_buffer=True):
  * 
  */
 
@@ -19117,14 +20721,17 @@
 static int __pyx_array___cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static int __pyx_array___cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_shape = 0;
   Py_ssize_t __pyx_v_itemsize;
   PyObject *__pyx_v_format = 0;
   PyObject *__pyx_v_mode = 0;
   int __pyx_v_allocate_buffer;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__cinit__ (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_shape,&__pyx_n_s_itemsize,&__pyx_n_s_format,&__pyx_n_s_mode,&__pyx_n_s_allocate_buffer,0};
     PyObject* values[5] = {0,0,0,0,0};
     values[3] = ((PyObject *)__pyx_n_s_c);
@@ -19150,21 +20757,21 @@
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_shape)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_itemsize)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 3, 5, 1); __PYX_ERR(1, 122, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 3, 5, 1); __PYX_ERR(1, 123, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
         if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_format)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 3, 5, 2); __PYX_ERR(1, 122, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 3, 5, 2); __PYX_ERR(1, 123, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_mode);
           if (value) { values[3] = value; kw_args--; }
         }
@@ -19172,15 +20779,15 @@
         case  4:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_allocate_buffer);
           if (value) { values[4] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__cinit__") < 0)) __PYX_ERR(1, 122, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__cinit__") < 0)) __PYX_ERR(1, 123, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  5: values[4] = PyTuple_GET_ITEM(__pyx_args, 4);
         CYTHON_FALLTHROUGH;
         case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
@@ -19188,46 +20795,46 @@
         values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
     __pyx_v_shape = ((PyObject*)values[0]);
-    __pyx_v_itemsize = __Pyx_PyIndex_AsSsize_t(values[1]); if (unlikely((__pyx_v_itemsize == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 122, __pyx_L3_error)
+    __pyx_v_itemsize = __Pyx_PyIndex_AsSsize_t(values[1]); if (unlikely((__pyx_v_itemsize == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 123, __pyx_L3_error)
     __pyx_v_format = values[2];
     __pyx_v_mode = values[3];
     if (values[4]) {
-      __pyx_v_allocate_buffer = __Pyx_PyObject_IsTrue(values[4]); if (unlikely((__pyx_v_allocate_buffer == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 123, __pyx_L3_error)
+      __pyx_v_allocate_buffer = __Pyx_PyObject_IsTrue(values[4]); if (unlikely((__pyx_v_allocate_buffer == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 124, __pyx_L3_error)
     } else {
 
-      /* "View.MemoryView":123
+      /* "View.MemoryView":124
  * 
  *     def __cinit__(array self, tuple shape, Py_ssize_t itemsize, format not None,
  *                   mode="c", bint allocate_buffer=True):             # <<<<<<<<<<<<<<
  * 
  *         cdef int idx
  */
       __pyx_v_allocate_buffer = ((int)1);
     }
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 3, 5, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(1, 122, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 3, 5, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(1, 123, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("View.MemoryView.array.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
-  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_shape), (&PyTuple_Type), 1, "shape", 1))) __PYX_ERR(1, 122, __pyx_L1_error)
+  if (unlikely(!__Pyx_ArgTypeTest(((PyObject *)__pyx_v_shape), (&PyTuple_Type), 1, "shape", 1))) __PYX_ERR(1, 123, __pyx_L1_error)
   if (unlikely(((PyObject *)__pyx_v_format) == Py_None)) {
-    PyErr_Format(PyExc_TypeError, "Argument '%.200s' must not be None", "format"); __PYX_ERR(1, 122, __pyx_L1_error)
+    PyErr_Format(PyExc_TypeError, "Argument '%.200s' must not be None", "format"); __PYX_ERR(1, 123, __pyx_L1_error)
   }
   __pyx_r = __pyx_array___pyx_pf_15View_dot_MemoryView_5array___cinit__(((struct __pyx_array_obj *)__pyx_v_self), __pyx_v_shape, __pyx_v_itemsize, __pyx_v_format, __pyx_v_mode, __pyx_v_allocate_buffer);
 
-  /* "View.MemoryView":122
+  /* "View.MemoryView":123
  *         cdef bint dtype_is_object
  * 
  *     def __cinit__(array self, tuple shape, Py_ssize_t itemsize, format not None,             # <<<<<<<<<<<<<<
  *                   mode="c", bint allocate_buffer=True):
  * 
  */
 
@@ -19255,582 +20862,585 @@
   PyObject *__pyx_t_5 = NULL;
   PyObject *__pyx_t_6 = NULL;
   char *__pyx_t_7;
   int __pyx_t_8;
   Py_ssize_t __pyx_t_9;
   PyObject *__pyx_t_10 = NULL;
   Py_ssize_t __pyx_t_11;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__cinit__", 0);
   __Pyx_INCREF(__pyx_v_format);
 
-  /* "View.MemoryView":129
+  /* "View.MemoryView":130
  *         cdef PyObject **p
  * 
  *         self.ndim = <int> len(shape)             # <<<<<<<<<<<<<<
  *         self.itemsize = itemsize
  * 
  */
   if (unlikely(__pyx_v_shape == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "object of type 'NoneType' has no len()");
-    __PYX_ERR(1, 129, __pyx_L1_error)
+    __PYX_ERR(1, 130, __pyx_L1_error)
   }
-  __pyx_t_1 = PyTuple_GET_SIZE(__pyx_v_shape); if (unlikely(__pyx_t_1 == ((Py_ssize_t)-1))) __PYX_ERR(1, 129, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_GET_SIZE(__pyx_v_shape); if (unlikely(__pyx_t_1 == ((Py_ssize_t)-1))) __PYX_ERR(1, 130, __pyx_L1_error)
   __pyx_v_self->ndim = ((int)__pyx_t_1);
 
-  /* "View.MemoryView":130
+  /* "View.MemoryView":131
  * 
  *         self.ndim = <int> len(shape)
  *         self.itemsize = itemsize             # <<<<<<<<<<<<<<
  * 
  *         if not self.ndim:
  */
   __pyx_v_self->itemsize = __pyx_v_itemsize;
 
-  /* "View.MemoryView":132
+  /* "View.MemoryView":133
  *         self.itemsize = itemsize
  * 
  *         if not self.ndim:             # <<<<<<<<<<<<<<
  *             raise ValueError("Empty shape tuple for cython.array")
  * 
  */
   __pyx_t_2 = ((!(__pyx_v_self->ndim != 0)) != 0);
   if (unlikely(__pyx_t_2)) {
 
-    /* "View.MemoryView":133
+    /* "View.MemoryView":134
  * 
  *         if not self.ndim:
  *             raise ValueError("Empty shape tuple for cython.array")             # <<<<<<<<<<<<<<
  * 
  *         if itemsize <= 0:
  */
-    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__13, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 133, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__13, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 134, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_Raise(__pyx_t_3, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __PYX_ERR(1, 133, __pyx_L1_error)
+    __PYX_ERR(1, 134, __pyx_L1_error)
 
-    /* "View.MemoryView":132
+    /* "View.MemoryView":133
  *         self.itemsize = itemsize
  * 
  *         if not self.ndim:             # <<<<<<<<<<<<<<
  *             raise ValueError("Empty shape tuple for cython.array")
  * 
  */
   }
 
-  /* "View.MemoryView":135
+  /* "View.MemoryView":136
  *             raise ValueError("Empty shape tuple for cython.array")
  * 
  *         if itemsize <= 0:             # <<<<<<<<<<<<<<
  *             raise ValueError("itemsize <= 0 for cython.array")
  * 
  */
   __pyx_t_2 = ((__pyx_v_itemsize <= 0) != 0);
   if (unlikely(__pyx_t_2)) {
 
-    /* "View.MemoryView":136
+    /* "View.MemoryView":137
  * 
  *         if itemsize <= 0:
  *             raise ValueError("itemsize <= 0 for cython.array")             # <<<<<<<<<<<<<<
  * 
  *         if not isinstance(format, bytes):
  */
-    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__14, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 136, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__14, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 137, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_Raise(__pyx_t_3, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __PYX_ERR(1, 136, __pyx_L1_error)
+    __PYX_ERR(1, 137, __pyx_L1_error)
 
-    /* "View.MemoryView":135
+    /* "View.MemoryView":136
  *             raise ValueError("Empty shape tuple for cython.array")
  * 
  *         if itemsize <= 0:             # <<<<<<<<<<<<<<
  *             raise ValueError("itemsize <= 0 for cython.array")
  * 
  */
   }
 
-  /* "View.MemoryView":138
+  /* "View.MemoryView":139
  *             raise ValueError("itemsize <= 0 for cython.array")
  * 
  *         if not isinstance(format, bytes):             # <<<<<<<<<<<<<<
  *             format = format.encode('ASCII')
  *         self._format = format  # keep a reference to the byte string
  */
   __pyx_t_2 = PyBytes_Check(__pyx_v_format); 
   __pyx_t_4 = ((!(__pyx_t_2 != 0)) != 0);
   if (__pyx_t_4) {
 
-    /* "View.MemoryView":139
+    /* "View.MemoryView":140
  * 
  *         if not isinstance(format, bytes):
  *             format = format.encode('ASCII')             # <<<<<<<<<<<<<<
  *         self._format = format  # keep a reference to the byte string
  *         self.format = self._format
  */
-    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_format, __pyx_n_s_encode); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 139, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_format, __pyx_n_s_encode); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 140, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __pyx_t_6 = NULL;
     if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_5))) {
       __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_5);
       if (likely(__pyx_t_6)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
         __Pyx_INCREF(__pyx_t_6);
         __Pyx_INCREF(function);
         __Pyx_DECREF_SET(__pyx_t_5, function);
       }
     }
     __pyx_t_3 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_5, __pyx_t_6, __pyx_n_s_ASCII) : __Pyx_PyObject_CallOneArg(__pyx_t_5, __pyx_n_s_ASCII);
     __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-    if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 139, __pyx_L1_error)
+    if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 140, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_DECREF_SET(__pyx_v_format, __pyx_t_3);
     __pyx_t_3 = 0;
 
-    /* "View.MemoryView":138
+    /* "View.MemoryView":139
  *             raise ValueError("itemsize <= 0 for cython.array")
  * 
  *         if not isinstance(format, bytes):             # <<<<<<<<<<<<<<
  *             format = format.encode('ASCII')
  *         self._format = format  # keep a reference to the byte string
  */
   }
 
-  /* "View.MemoryView":140
+  /* "View.MemoryView":141
  *         if not isinstance(format, bytes):
  *             format = format.encode('ASCII')
  *         self._format = format  # keep a reference to the byte string             # <<<<<<<<<<<<<<
  *         self.format = self._format
  * 
  */
-  if (!(likely(PyBytes_CheckExact(__pyx_v_format))||((__pyx_v_format) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_v_format)->tp_name), 0))) __PYX_ERR(1, 140, __pyx_L1_error)
+  if (!(likely(PyBytes_CheckExact(__pyx_v_format))||((__pyx_v_format) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_v_format)->tp_name), 0))) __PYX_ERR(1, 141, __pyx_L1_error)
   __pyx_t_3 = __pyx_v_format;
   __Pyx_INCREF(__pyx_t_3);
   __Pyx_GIVEREF(__pyx_t_3);
   __Pyx_GOTREF(__pyx_v_self->_format);
   __Pyx_DECREF(__pyx_v_self->_format);
   __pyx_v_self->_format = ((PyObject*)__pyx_t_3);
   __pyx_t_3 = 0;
 
-  /* "View.MemoryView":141
+  /* "View.MemoryView":142
  *             format = format.encode('ASCII')
  *         self._format = format  # keep a reference to the byte string
  *         self.format = self._format             # <<<<<<<<<<<<<<
  * 
  * 
  */
   if (unlikely(__pyx_v_self->_format == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "expected bytes, NoneType found");
-    __PYX_ERR(1, 141, __pyx_L1_error)
+    __PYX_ERR(1, 142, __pyx_L1_error)
   }
-  __pyx_t_7 = __Pyx_PyBytes_AsWritableString(__pyx_v_self->_format); if (unlikely((!__pyx_t_7) && PyErr_Occurred())) __PYX_ERR(1, 141, __pyx_L1_error)
+  __pyx_t_7 = __Pyx_PyBytes_AsWritableString(__pyx_v_self->_format); if (unlikely((!__pyx_t_7) && PyErr_Occurred())) __PYX_ERR(1, 142, __pyx_L1_error)
   __pyx_v_self->format = __pyx_t_7;
 
-  /* "View.MemoryView":144
+  /* "View.MemoryView":145
  * 
  * 
  *         self._shape = <Py_ssize_t *> PyObject_Malloc(sizeof(Py_ssize_t)*self.ndim*2)             # <<<<<<<<<<<<<<
  *         self._strides = self._shape + self.ndim
  * 
  */
   __pyx_v_self->_shape = ((Py_ssize_t *)PyObject_Malloc((((sizeof(Py_ssize_t)) * __pyx_v_self->ndim) * 2)));
 
-  /* "View.MemoryView":145
+  /* "View.MemoryView":146
  * 
  *         self._shape = <Py_ssize_t *> PyObject_Malloc(sizeof(Py_ssize_t)*self.ndim*2)
  *         self._strides = self._shape + self.ndim             # <<<<<<<<<<<<<<
  * 
  *         if not self._shape:
  */
   __pyx_v_self->_strides = (__pyx_v_self->_shape + __pyx_v_self->ndim);
 
-  /* "View.MemoryView":147
+  /* "View.MemoryView":148
  *         self._strides = self._shape + self.ndim
  * 
  *         if not self._shape:             # <<<<<<<<<<<<<<
  *             raise MemoryError("unable to allocate shape and strides.")
  * 
  */
   __pyx_t_4 = ((!(__pyx_v_self->_shape != 0)) != 0);
   if (unlikely(__pyx_t_4)) {
 
-    /* "View.MemoryView":148
+    /* "View.MemoryView":149
  * 
  *         if not self._shape:
  *             raise MemoryError("unable to allocate shape and strides.")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_MemoryError, __pyx_tuple__15, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 148, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_MemoryError, __pyx_tuple__15, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 149, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_Raise(__pyx_t_3, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __PYX_ERR(1, 148, __pyx_L1_error)
+    __PYX_ERR(1, 149, __pyx_L1_error)
 
-    /* "View.MemoryView":147
+    /* "View.MemoryView":148
  *         self._strides = self._shape + self.ndim
  * 
  *         if not self._shape:             # <<<<<<<<<<<<<<
  *             raise MemoryError("unable to allocate shape and strides.")
  * 
  */
   }
 
-  /* "View.MemoryView":151
+  /* "View.MemoryView":152
  * 
  * 
  *         for idx, dim in enumerate(shape):             # <<<<<<<<<<<<<<
  *             if dim <= 0:
  *                 raise ValueError("Invalid shape in axis %d: %d." % (idx, dim))
  */
   __pyx_t_8 = 0;
   __pyx_t_3 = __pyx_v_shape; __Pyx_INCREF(__pyx_t_3); __pyx_t_1 = 0;
   for (;;) {
     if (__pyx_t_1 >= PyTuple_GET_SIZE(__pyx_t_3)) break;
     #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-    __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_3, __pyx_t_1); __Pyx_INCREF(__pyx_t_5); __pyx_t_1++; if (unlikely(0 < 0)) __PYX_ERR(1, 151, __pyx_L1_error)
+    __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_3, __pyx_t_1); __Pyx_INCREF(__pyx_t_5); __pyx_t_1++; if (unlikely(0 < 0)) __PYX_ERR(1, 152, __pyx_L1_error)
     #else
-    __pyx_t_5 = PySequence_ITEM(__pyx_t_3, __pyx_t_1); __pyx_t_1++; if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 151, __pyx_L1_error)
+    __pyx_t_5 = PySequence_ITEM(__pyx_t_3, __pyx_t_1); __pyx_t_1++; if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 152, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     #endif
-    __pyx_t_9 = __Pyx_PyIndex_AsSsize_t(__pyx_t_5); if (unlikely((__pyx_t_9 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 151, __pyx_L1_error)
+    __pyx_t_9 = __Pyx_PyIndex_AsSsize_t(__pyx_t_5); if (unlikely((__pyx_t_9 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 152, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __pyx_v_dim = __pyx_t_9;
     __pyx_v_idx = __pyx_t_8;
     __pyx_t_8 = (__pyx_t_8 + 1);
 
-    /* "View.MemoryView":152
+    /* "View.MemoryView":153
  * 
  *         for idx, dim in enumerate(shape):
  *             if dim <= 0:             # <<<<<<<<<<<<<<
  *                 raise ValueError("Invalid shape in axis %d: %d." % (idx, dim))
  *             self._shape[idx] = dim
  */
     __pyx_t_4 = ((__pyx_v_dim <= 0) != 0);
     if (unlikely(__pyx_t_4)) {
 
-      /* "View.MemoryView":153
+      /* "View.MemoryView":154
  *         for idx, dim in enumerate(shape):
  *             if dim <= 0:
  *                 raise ValueError("Invalid shape in axis %d: %d." % (idx, dim))             # <<<<<<<<<<<<<<
  *             self._shape[idx] = dim
  * 
  */
-      __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_idx); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 153, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_PyInt_From_int(__pyx_v_idx); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 154, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_6 = PyInt_FromSsize_t(__pyx_v_dim); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 153, __pyx_L1_error)
+      __pyx_t_6 = PyInt_FromSsize_t(__pyx_v_dim); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 154, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
-      __pyx_t_10 = PyTuple_New(2); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 153, __pyx_L1_error)
+      __pyx_t_10 = PyTuple_New(2); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 154, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
       __Pyx_GIVEREF(__pyx_t_5);
       PyTuple_SET_ITEM(__pyx_t_10, 0, __pyx_t_5);
       __Pyx_GIVEREF(__pyx_t_6);
       PyTuple_SET_ITEM(__pyx_t_10, 1, __pyx_t_6);
       __pyx_t_5 = 0;
       __pyx_t_6 = 0;
-      __pyx_t_6 = __Pyx_PyString_Format(__pyx_kp_s_Invalid_shape_in_axis_d_d, __pyx_t_10); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 153, __pyx_L1_error)
+      __pyx_t_6 = __Pyx_PyString_Format(__pyx_kp_s_Invalid_shape_in_axis_d_d, __pyx_t_10); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 154, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __pyx_t_10 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_6); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 153, __pyx_L1_error)
+      __pyx_t_10 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_6); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 154, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
       __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
       __Pyx_Raise(__pyx_t_10, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __PYX_ERR(1, 153, __pyx_L1_error)
+      __PYX_ERR(1, 154, __pyx_L1_error)
 
-      /* "View.MemoryView":152
+      /* "View.MemoryView":153
  * 
  *         for idx, dim in enumerate(shape):
  *             if dim <= 0:             # <<<<<<<<<<<<<<
  *                 raise ValueError("Invalid shape in axis %d: %d." % (idx, dim))
  *             self._shape[idx] = dim
  */
     }
 
-    /* "View.MemoryView":154
+    /* "View.MemoryView":155
  *             if dim <= 0:
  *                 raise ValueError("Invalid shape in axis %d: %d." % (idx, dim))
  *             self._shape[idx] = dim             # <<<<<<<<<<<<<<
  * 
  *         cdef char order
  */
     (__pyx_v_self->_shape[__pyx_v_idx]) = __pyx_v_dim;
 
-    /* "View.MemoryView":151
+    /* "View.MemoryView":152
  * 
  * 
  *         for idx, dim in enumerate(shape):             # <<<<<<<<<<<<<<
  *             if dim <= 0:
  *                 raise ValueError("Invalid shape in axis %d: %d." % (idx, dim))
  */
   }
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "View.MemoryView":157
+  /* "View.MemoryView":158
  * 
  *         cdef char order
  *         if mode == 'fortran':             # <<<<<<<<<<<<<<
  *             order = b'F'
  *             self.mode = u'fortran'
  */
-  __pyx_t_4 = (__Pyx_PyString_Equals(__pyx_v_mode, __pyx_n_s_fortran, Py_EQ)); if (unlikely(__pyx_t_4 < 0)) __PYX_ERR(1, 157, __pyx_L1_error)
+  __pyx_t_4 = (__Pyx_PyString_Equals(__pyx_v_mode, __pyx_n_s_fortran, Py_EQ)); if (unlikely(__pyx_t_4 < 0)) __PYX_ERR(1, 158, __pyx_L1_error)
   if (__pyx_t_4) {
 
-    /* "View.MemoryView":158
+    /* "View.MemoryView":159
  *         cdef char order
  *         if mode == 'fortran':
  *             order = b'F'             # <<<<<<<<<<<<<<
  *             self.mode = u'fortran'
  *         elif mode == 'c':
  */
     __pyx_v_order = 'F';
 
-    /* "View.MemoryView":159
+    /* "View.MemoryView":160
  *         if mode == 'fortran':
  *             order = b'F'
  *             self.mode = u'fortran'             # <<<<<<<<<<<<<<
  *         elif mode == 'c':
  *             order = b'C'
  */
     __Pyx_INCREF(__pyx_n_u_fortran);
     __Pyx_GIVEREF(__pyx_n_u_fortran);
     __Pyx_GOTREF(__pyx_v_self->mode);
     __Pyx_DECREF(__pyx_v_self->mode);
     __pyx_v_self->mode = __pyx_n_u_fortran;
 
-    /* "View.MemoryView":157
+    /* "View.MemoryView":158
  * 
  *         cdef char order
  *         if mode == 'fortran':             # <<<<<<<<<<<<<<
  *             order = b'F'
  *             self.mode = u'fortran'
  */
     goto __pyx_L10;
   }
 
-  /* "View.MemoryView":160
+  /* "View.MemoryView":161
  *             order = b'F'
  *             self.mode = u'fortran'
  *         elif mode == 'c':             # <<<<<<<<<<<<<<
  *             order = b'C'
  *             self.mode = u'c'
  */
-  __pyx_t_4 = (__Pyx_PyString_Equals(__pyx_v_mode, __pyx_n_s_c, Py_EQ)); if (unlikely(__pyx_t_4 < 0)) __PYX_ERR(1, 160, __pyx_L1_error)
+  __pyx_t_4 = (__Pyx_PyString_Equals(__pyx_v_mode, __pyx_n_s_c, Py_EQ)); if (unlikely(__pyx_t_4 < 0)) __PYX_ERR(1, 161, __pyx_L1_error)
   if (likely(__pyx_t_4)) {
 
-    /* "View.MemoryView":161
+    /* "View.MemoryView":162
  *             self.mode = u'fortran'
  *         elif mode == 'c':
  *             order = b'C'             # <<<<<<<<<<<<<<
  *             self.mode = u'c'
  *         else:
  */
     __pyx_v_order = 'C';
 
-    /* "View.MemoryView":162
+    /* "View.MemoryView":163
  *         elif mode == 'c':
  *             order = b'C'
  *             self.mode = u'c'             # <<<<<<<<<<<<<<
  *         else:
  *             raise ValueError("Invalid mode, expected 'c' or 'fortran', got %s" % mode)
  */
     __Pyx_INCREF(__pyx_n_u_c);
     __Pyx_GIVEREF(__pyx_n_u_c);
     __Pyx_GOTREF(__pyx_v_self->mode);
     __Pyx_DECREF(__pyx_v_self->mode);
     __pyx_v_self->mode = __pyx_n_u_c;
 
-    /* "View.MemoryView":160
+    /* "View.MemoryView":161
  *             order = b'F'
  *             self.mode = u'fortran'
  *         elif mode == 'c':             # <<<<<<<<<<<<<<
  *             order = b'C'
  *             self.mode = u'c'
  */
     goto __pyx_L10;
   }
 
-  /* "View.MemoryView":164
+  /* "View.MemoryView":165
  *             self.mode = u'c'
  *         else:
  *             raise ValueError("Invalid mode, expected 'c' or 'fortran', got %s" % mode)             # <<<<<<<<<<<<<<
  * 
  *         self.len = fill_contig_strides_array(self._shape, self._strides,
  */
   /*else*/ {
-    __pyx_t_3 = __Pyx_PyString_FormatSafe(__pyx_kp_s_Invalid_mode_expected_c_or_fortr, __pyx_v_mode); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 164, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyString_FormatSafe(__pyx_kp_s_Invalid_mode_expected_c_or_fortr, __pyx_v_mode); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 165, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_10 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_3); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 164, __pyx_L1_error)
+    __pyx_t_10 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_3); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 165, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_10);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __Pyx_Raise(__pyx_t_10, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-    __PYX_ERR(1, 164, __pyx_L1_error)
+    __PYX_ERR(1, 165, __pyx_L1_error)
   }
   __pyx_L10:;
 
-  /* "View.MemoryView":166
+  /* "View.MemoryView":167
  *             raise ValueError("Invalid mode, expected 'c' or 'fortran', got %s" % mode)
  * 
  *         self.len = fill_contig_strides_array(self._shape, self._strides,             # <<<<<<<<<<<<<<
  *                                              itemsize, self.ndim, order)
  * 
  */
   __pyx_v_self->len = __pyx_fill_contig_strides_array(__pyx_v_self->_shape, __pyx_v_self->_strides, __pyx_v_itemsize, __pyx_v_self->ndim, __pyx_v_order);
 
-  /* "View.MemoryView":169
+  /* "View.MemoryView":170
  *                                              itemsize, self.ndim, order)
  * 
  *         self.free_data = allocate_buffer             # <<<<<<<<<<<<<<
  *         self.dtype_is_object = format == b'O'
  *         if allocate_buffer:
  */
   __pyx_v_self->free_data = __pyx_v_allocate_buffer;
 
-  /* "View.MemoryView":170
+  /* "View.MemoryView":171
  * 
  *         self.free_data = allocate_buffer
  *         self.dtype_is_object = format == b'O'             # <<<<<<<<<<<<<<
  *         if allocate_buffer:
  * 
  */
-  __pyx_t_10 = PyObject_RichCompare(__pyx_v_format, __pyx_n_b_O, Py_EQ); __Pyx_XGOTREF(__pyx_t_10); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 170, __pyx_L1_error)
-  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_10); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 170, __pyx_L1_error)
+  __pyx_t_10 = PyObject_RichCompare(__pyx_v_format, __pyx_n_b_O, Py_EQ); __Pyx_XGOTREF(__pyx_t_10); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 171, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_IsTrue(__pyx_t_10); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 171, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
   __pyx_v_self->dtype_is_object = __pyx_t_4;
 
-  /* "View.MemoryView":171
+  /* "View.MemoryView":172
  *         self.free_data = allocate_buffer
  *         self.dtype_is_object = format == b'O'
  *         if allocate_buffer:             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_t_4 = (__pyx_v_allocate_buffer != 0);
   if (__pyx_t_4) {
 
-    /* "View.MemoryView":174
+    /* "View.MemoryView":175
  * 
  * 
  *             self.data = <char *>malloc(self.len)             # <<<<<<<<<<<<<<
  *             if not self.data:
  *                 raise MemoryError("unable to allocate array data.")
  */
     __pyx_v_self->data = ((char *)malloc(__pyx_v_self->len));
 
-    /* "View.MemoryView":175
+    /* "View.MemoryView":176
  * 
  *             self.data = <char *>malloc(self.len)
  *             if not self.data:             # <<<<<<<<<<<<<<
  *                 raise MemoryError("unable to allocate array data.")
  * 
  */
     __pyx_t_4 = ((!(__pyx_v_self->data != 0)) != 0);
     if (unlikely(__pyx_t_4)) {
 
-      /* "View.MemoryView":176
+      /* "View.MemoryView":177
  *             self.data = <char *>malloc(self.len)
  *             if not self.data:
  *                 raise MemoryError("unable to allocate array data.")             # <<<<<<<<<<<<<<
  * 
  *             if self.dtype_is_object:
  */
-      __pyx_t_10 = __Pyx_PyObject_Call(__pyx_builtin_MemoryError, __pyx_tuple__16, NULL); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 176, __pyx_L1_error)
+      __pyx_t_10 = __Pyx_PyObject_Call(__pyx_builtin_MemoryError, __pyx_tuple__16, NULL); if (unlikely(!__pyx_t_10)) __PYX_ERR(1, 177, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_10);
       __Pyx_Raise(__pyx_t_10, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
-      __PYX_ERR(1, 176, __pyx_L1_error)
+      __PYX_ERR(1, 177, __pyx_L1_error)
 
-      /* "View.MemoryView":175
+      /* "View.MemoryView":176
  * 
  *             self.data = <char *>malloc(self.len)
  *             if not self.data:             # <<<<<<<<<<<<<<
  *                 raise MemoryError("unable to allocate array data.")
  * 
  */
     }
 
-    /* "View.MemoryView":178
+    /* "View.MemoryView":179
  *                 raise MemoryError("unable to allocate array data.")
  * 
  *             if self.dtype_is_object:             # <<<<<<<<<<<<<<
  *                 p = <PyObject **> self.data
  *                 for i in range(self.len / itemsize):
  */
     __pyx_t_4 = (__pyx_v_self->dtype_is_object != 0);
     if (__pyx_t_4) {
 
-      /* "View.MemoryView":179
+      /* "View.MemoryView":180
  * 
  *             if self.dtype_is_object:
  *                 p = <PyObject **> self.data             # <<<<<<<<<<<<<<
  *                 for i in range(self.len / itemsize):
  *                     p[i] = Py_None
  */
       __pyx_v_p = ((PyObject **)__pyx_v_self->data);
 
-      /* "View.MemoryView":180
+      /* "View.MemoryView":181
  *             if self.dtype_is_object:
  *                 p = <PyObject **> self.data
  *                 for i in range(self.len / itemsize):             # <<<<<<<<<<<<<<
  *                     p[i] = Py_None
  *                     Py_INCREF(Py_None)
  */
       if (unlikely(__pyx_v_itemsize == 0)) {
         PyErr_SetString(PyExc_ZeroDivisionError, "integer division or modulo by zero");
-        __PYX_ERR(1, 180, __pyx_L1_error)
+        __PYX_ERR(1, 181, __pyx_L1_error)
       }
       else if (sizeof(Py_ssize_t) == sizeof(long) && (!(((Py_ssize_t)-1) > 0)) && unlikely(__pyx_v_itemsize == (Py_ssize_t)-1)  && unlikely(UNARY_NEG_WOULD_OVERFLOW(__pyx_v_self->len))) {
         PyErr_SetString(PyExc_OverflowError, "value too large to perform division");
-        __PYX_ERR(1, 180, __pyx_L1_error)
+        __PYX_ERR(1, 181, __pyx_L1_error)
       }
       __pyx_t_1 = __Pyx_div_Py_ssize_t(__pyx_v_self->len, __pyx_v_itemsize);
       __pyx_t_9 = __pyx_t_1;
       for (__pyx_t_11 = 0; __pyx_t_11 < __pyx_t_9; __pyx_t_11+=1) {
         __pyx_v_i = __pyx_t_11;
 
-        /* "View.MemoryView":181
+        /* "View.MemoryView":182
  *                 p = <PyObject **> self.data
  *                 for i in range(self.len / itemsize):
  *                     p[i] = Py_None             # <<<<<<<<<<<<<<
  *                     Py_INCREF(Py_None)
  * 
  */
         (__pyx_v_p[__pyx_v_i]) = Py_None;
 
-        /* "View.MemoryView":182
+        /* "View.MemoryView":183
  *                 for i in range(self.len / itemsize):
  *                     p[i] = Py_None
  *                     Py_INCREF(Py_None)             # <<<<<<<<<<<<<<
  * 
  *     @cname('getbuffer')
  */
         Py_INCREF(Py_None);
       }
 
-      /* "View.MemoryView":178
+      /* "View.MemoryView":179
  *                 raise MemoryError("unable to allocate array data.")
  * 
  *             if self.dtype_is_object:             # <<<<<<<<<<<<<<
  *                 p = <PyObject **> self.data
  *                 for i in range(self.len / itemsize):
  */
     }
 
-    /* "View.MemoryView":171
+    /* "View.MemoryView":172
  *         self.free_data = allocate_buffer
  *         self.dtype_is_object = format == b'O'
  *         if allocate_buffer:             # <<<<<<<<<<<<<<
  * 
  * 
  */
   }
 
-  /* "View.MemoryView":122
+  /* "View.MemoryView":123
  *         cdef bint dtype_is_object
  * 
  *     def __cinit__(array self, tuple shape, Py_ssize_t itemsize, format not None,             # <<<<<<<<<<<<<<
  *                   mode="c", bint allocate_buffer=True):
  * 
  */
 
@@ -19846,15 +21456,15 @@
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v_format);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":185
+/* "View.MemoryView":186
  * 
  *     @cname('getbuffer')
  *     def __getbuffer__(self, Py_buffer *info, int flags):             # <<<<<<<<<<<<<<
  *         cdef int bufmode = -1
  *         if self.mode == u"c":
  */
 
@@ -19878,257 +21488,260 @@
   int __pyx_t_1;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
   char *__pyx_t_4;
   Py_ssize_t __pyx_t_5;
   int __pyx_t_6;
   Py_ssize_t *__pyx_t_7;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   if (__pyx_v_info == NULL) {
     PyErr_SetString(PyExc_BufferError, "PyObject_GetBuffer: view==NULL argument is obsolete");
     return -1;
   }
   __Pyx_RefNannySetupContext("__getbuffer__", 0);
   __pyx_v_info->obj = Py_None; __Pyx_INCREF(Py_None);
   __Pyx_GIVEREF(__pyx_v_info->obj);
 
-  /* "View.MemoryView":186
+  /* "View.MemoryView":187
  *     @cname('getbuffer')
  *     def __getbuffer__(self, Py_buffer *info, int flags):
  *         cdef int bufmode = -1             # <<<<<<<<<<<<<<
  *         if self.mode == u"c":
  *             bufmode = PyBUF_C_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  */
   __pyx_v_bufmode = -1;
 
-  /* "View.MemoryView":187
+  /* "View.MemoryView":188
  *     def __getbuffer__(self, Py_buffer *info, int flags):
  *         cdef int bufmode = -1
  *         if self.mode == u"c":             # <<<<<<<<<<<<<<
  *             bufmode = PyBUF_C_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         elif self.mode == u"fortran":
  */
-  __pyx_t_1 = (__Pyx_PyUnicode_Equals(__pyx_v_self->mode, __pyx_n_u_c, Py_EQ)); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 187, __pyx_L1_error)
+  __pyx_t_1 = (__Pyx_PyUnicode_Equals(__pyx_v_self->mode, __pyx_n_u_c, Py_EQ)); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 188, __pyx_L1_error)
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":188
+    /* "View.MemoryView":189
  *         cdef int bufmode = -1
  *         if self.mode == u"c":
  *             bufmode = PyBUF_C_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS             # <<<<<<<<<<<<<<
  *         elif self.mode == u"fortran":
  *             bufmode = PyBUF_F_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  */
     __pyx_v_bufmode = (PyBUF_C_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS);
 
-    /* "View.MemoryView":187
+    /* "View.MemoryView":188
  *     def __getbuffer__(self, Py_buffer *info, int flags):
  *         cdef int bufmode = -1
  *         if self.mode == u"c":             # <<<<<<<<<<<<<<
  *             bufmode = PyBUF_C_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         elif self.mode == u"fortran":
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":189
+  /* "View.MemoryView":190
  *         if self.mode == u"c":
  *             bufmode = PyBUF_C_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         elif self.mode == u"fortran":             # <<<<<<<<<<<<<<
  *             bufmode = PyBUF_F_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         if not (flags & bufmode):
  */
-  __pyx_t_2 = (__Pyx_PyUnicode_Equals(__pyx_v_self->mode, __pyx_n_u_fortran, Py_EQ)); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(1, 189, __pyx_L1_error)
+  __pyx_t_2 = (__Pyx_PyUnicode_Equals(__pyx_v_self->mode, __pyx_n_u_fortran, Py_EQ)); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(1, 190, __pyx_L1_error)
   __pyx_t_1 = (__pyx_t_2 != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":190
+    /* "View.MemoryView":191
  *             bufmode = PyBUF_C_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         elif self.mode == u"fortran":
  *             bufmode = PyBUF_F_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS             # <<<<<<<<<<<<<<
  *         if not (flags & bufmode):
  *             raise ValueError("Can only create a buffer that is contiguous in memory.")
  */
     __pyx_v_bufmode = (PyBUF_F_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS);
 
-    /* "View.MemoryView":189
+    /* "View.MemoryView":190
  *         if self.mode == u"c":
  *             bufmode = PyBUF_C_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         elif self.mode == u"fortran":             # <<<<<<<<<<<<<<
  *             bufmode = PyBUF_F_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         if not (flags & bufmode):
  */
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":191
+  /* "View.MemoryView":192
  *         elif self.mode == u"fortran":
  *             bufmode = PyBUF_F_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         if not (flags & bufmode):             # <<<<<<<<<<<<<<
  *             raise ValueError("Can only create a buffer that is contiguous in memory.")
  *         info.buf = self.data
  */
   __pyx_t_1 = ((!((__pyx_v_flags & __pyx_v_bufmode) != 0)) != 0);
   if (unlikely(__pyx_t_1)) {
 
-    /* "View.MemoryView":192
+    /* "View.MemoryView":193
  *             bufmode = PyBUF_F_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         if not (flags & bufmode):
  *             raise ValueError("Can only create a buffer that is contiguous in memory.")             # <<<<<<<<<<<<<<
  *         info.buf = self.data
  *         info.len = self.len
  */
-    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__17, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 192, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__17, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 193, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_Raise(__pyx_t_3, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __PYX_ERR(1, 192, __pyx_L1_error)
+    __PYX_ERR(1, 193, __pyx_L1_error)
 
-    /* "View.MemoryView":191
+    /* "View.MemoryView":192
  *         elif self.mode == u"fortran":
  *             bufmode = PyBUF_F_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         if not (flags & bufmode):             # <<<<<<<<<<<<<<
  *             raise ValueError("Can only create a buffer that is contiguous in memory.")
  *         info.buf = self.data
  */
   }
 
-  /* "View.MemoryView":193
+  /* "View.MemoryView":194
  *         if not (flags & bufmode):
  *             raise ValueError("Can only create a buffer that is contiguous in memory.")
  *         info.buf = self.data             # <<<<<<<<<<<<<<
  *         info.len = self.len
  *         info.ndim = self.ndim
  */
   __pyx_t_4 = __pyx_v_self->data;
   __pyx_v_info->buf = __pyx_t_4;
 
-  /* "View.MemoryView":194
+  /* "View.MemoryView":195
  *             raise ValueError("Can only create a buffer that is contiguous in memory.")
  *         info.buf = self.data
  *         info.len = self.len             # <<<<<<<<<<<<<<
  *         info.ndim = self.ndim
  *         info.shape = self._shape
  */
   __pyx_t_5 = __pyx_v_self->len;
   __pyx_v_info->len = __pyx_t_5;
 
-  /* "View.MemoryView":195
+  /* "View.MemoryView":196
  *         info.buf = self.data
  *         info.len = self.len
  *         info.ndim = self.ndim             # <<<<<<<<<<<<<<
  *         info.shape = self._shape
  *         info.strides = self._strides
  */
   __pyx_t_6 = __pyx_v_self->ndim;
   __pyx_v_info->ndim = __pyx_t_6;
 
-  /* "View.MemoryView":196
+  /* "View.MemoryView":197
  *         info.len = self.len
  *         info.ndim = self.ndim
  *         info.shape = self._shape             # <<<<<<<<<<<<<<
  *         info.strides = self._strides
  *         info.suboffsets = NULL
  */
   __pyx_t_7 = __pyx_v_self->_shape;
   __pyx_v_info->shape = __pyx_t_7;
 
-  /* "View.MemoryView":197
+  /* "View.MemoryView":198
  *         info.ndim = self.ndim
  *         info.shape = self._shape
  *         info.strides = self._strides             # <<<<<<<<<<<<<<
  *         info.suboffsets = NULL
  *         info.itemsize = self.itemsize
  */
   __pyx_t_7 = __pyx_v_self->_strides;
   __pyx_v_info->strides = __pyx_t_7;
 
-  /* "View.MemoryView":198
+  /* "View.MemoryView":199
  *         info.shape = self._shape
  *         info.strides = self._strides
  *         info.suboffsets = NULL             # <<<<<<<<<<<<<<
  *         info.itemsize = self.itemsize
  *         info.readonly = 0
  */
   __pyx_v_info->suboffsets = NULL;
 
-  /* "View.MemoryView":199
+  /* "View.MemoryView":200
  *         info.strides = self._strides
  *         info.suboffsets = NULL
  *         info.itemsize = self.itemsize             # <<<<<<<<<<<<<<
  *         info.readonly = 0
  * 
  */
   __pyx_t_5 = __pyx_v_self->itemsize;
   __pyx_v_info->itemsize = __pyx_t_5;
 
-  /* "View.MemoryView":200
+  /* "View.MemoryView":201
  *         info.suboffsets = NULL
  *         info.itemsize = self.itemsize
  *         info.readonly = 0             # <<<<<<<<<<<<<<
  * 
  *         if flags & PyBUF_FORMAT:
  */
   __pyx_v_info->readonly = 0;
 
-  /* "View.MemoryView":202
+  /* "View.MemoryView":203
  *         info.readonly = 0
  * 
  *         if flags & PyBUF_FORMAT:             # <<<<<<<<<<<<<<
  *             info.format = self.format
  *         else:
  */
   __pyx_t_1 = ((__pyx_v_flags & PyBUF_FORMAT) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":203
+    /* "View.MemoryView":204
  * 
  *         if flags & PyBUF_FORMAT:
  *             info.format = self.format             # <<<<<<<<<<<<<<
  *         else:
  *             info.format = NULL
  */
     __pyx_t_4 = __pyx_v_self->format;
     __pyx_v_info->format = __pyx_t_4;
 
-    /* "View.MemoryView":202
+    /* "View.MemoryView":203
  *         info.readonly = 0
  * 
  *         if flags & PyBUF_FORMAT:             # <<<<<<<<<<<<<<
  *             info.format = self.format
  *         else:
  */
     goto __pyx_L5;
   }
 
-  /* "View.MemoryView":205
+  /* "View.MemoryView":206
  *             info.format = self.format
  *         else:
  *             info.format = NULL             # <<<<<<<<<<<<<<
  * 
  *         info.obj = self
  */
   /*else*/ {
     __pyx_v_info->format = NULL;
   }
   __pyx_L5:;
 
-  /* "View.MemoryView":207
+  /* "View.MemoryView":208
  *             info.format = NULL
  * 
  *         info.obj = self             # <<<<<<<<<<<<<<
  * 
  *     __pyx_getbuffer = capsule(<void *> &__pyx_array_getbuffer, "getbuffer(obj, view, flags)")
  */
   __Pyx_INCREF(((PyObject *)__pyx_v_self));
   __Pyx_GIVEREF(((PyObject *)__pyx_v_self));
   __Pyx_GOTREF(__pyx_v_info->obj);
   __Pyx_DECREF(__pyx_v_info->obj);
   __pyx_v_info->obj = ((PyObject *)__pyx_v_self);
 
-  /* "View.MemoryView":185
+  /* "View.MemoryView":186
  * 
  *     @cname('getbuffer')
  *     def __getbuffer__(self, Py_buffer *info, int flags):             # <<<<<<<<<<<<<<
  *         cdef int bufmode = -1
  *         if self.mode == u"c":
  */
 
@@ -20150,15 +21763,15 @@
     __Pyx_DECREF(__pyx_v_info->obj); __pyx_v_info->obj = 0;
   }
   __pyx_L2:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":211
+/* "View.MemoryView":212
  *     __pyx_getbuffer = capsule(<void *> &__pyx_array_getbuffer, "getbuffer(obj, view, flags)")
  * 
  *     def __dealloc__(array self):             # <<<<<<<<<<<<<<
  *         if self.callback_free_data != NULL:
  *             self.callback_free_data(self.data)
  */
 
@@ -20174,122 +21787,122 @@
 }
 
 static void __pyx_array___pyx_pf_15View_dot_MemoryView_5array_4__dealloc__(struct __pyx_array_obj *__pyx_v_self) {
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("__dealloc__", 0);
 
-  /* "View.MemoryView":212
+  /* "View.MemoryView":213
  * 
  *     def __dealloc__(array self):
  *         if self.callback_free_data != NULL:             # <<<<<<<<<<<<<<
  *             self.callback_free_data(self.data)
  *         elif self.free_data:
  */
   __pyx_t_1 = ((__pyx_v_self->callback_free_data != NULL) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":213
+    /* "View.MemoryView":214
  *     def __dealloc__(array self):
  *         if self.callback_free_data != NULL:
  *             self.callback_free_data(self.data)             # <<<<<<<<<<<<<<
  *         elif self.free_data:
  *             if self.dtype_is_object:
  */
     __pyx_v_self->callback_free_data(__pyx_v_self->data);
 
-    /* "View.MemoryView":212
+    /* "View.MemoryView":213
  * 
  *     def __dealloc__(array self):
  *         if self.callback_free_data != NULL:             # <<<<<<<<<<<<<<
  *             self.callback_free_data(self.data)
  *         elif self.free_data:
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":214
+  /* "View.MemoryView":215
  *         if self.callback_free_data != NULL:
  *             self.callback_free_data(self.data)
  *         elif self.free_data:             # <<<<<<<<<<<<<<
  *             if self.dtype_is_object:
  *                 refcount_objects_in_slice(self.data, self._shape,
  */
   __pyx_t_1 = (__pyx_v_self->free_data != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":215
+    /* "View.MemoryView":216
  *             self.callback_free_data(self.data)
  *         elif self.free_data:
  *             if self.dtype_is_object:             # <<<<<<<<<<<<<<
  *                 refcount_objects_in_slice(self.data, self._shape,
  *                                           self._strides, self.ndim, False)
  */
     __pyx_t_1 = (__pyx_v_self->dtype_is_object != 0);
     if (__pyx_t_1) {
 
-      /* "View.MemoryView":216
+      /* "View.MemoryView":217
  *         elif self.free_data:
  *             if self.dtype_is_object:
  *                 refcount_objects_in_slice(self.data, self._shape,             # <<<<<<<<<<<<<<
  *                                           self._strides, self.ndim, False)
  *             free(self.data)
  */
       __pyx_memoryview_refcount_objects_in_slice(__pyx_v_self->data, __pyx_v_self->_shape, __pyx_v_self->_strides, __pyx_v_self->ndim, 0);
 
-      /* "View.MemoryView":215
+      /* "View.MemoryView":216
  *             self.callback_free_data(self.data)
  *         elif self.free_data:
  *             if self.dtype_is_object:             # <<<<<<<<<<<<<<
  *                 refcount_objects_in_slice(self.data, self._shape,
  *                                           self._strides, self.ndim, False)
  */
     }
 
-    /* "View.MemoryView":218
+    /* "View.MemoryView":219
  *                 refcount_objects_in_slice(self.data, self._shape,
  *                                           self._strides, self.ndim, False)
  *             free(self.data)             # <<<<<<<<<<<<<<
  *         PyObject_Free(self._shape)
  * 
  */
     free(__pyx_v_self->data);
 
-    /* "View.MemoryView":214
+    /* "View.MemoryView":215
  *         if self.callback_free_data != NULL:
  *             self.callback_free_data(self.data)
  *         elif self.free_data:             # <<<<<<<<<<<<<<
  *             if self.dtype_is_object:
  *                 refcount_objects_in_slice(self.data, self._shape,
  */
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":219
+  /* "View.MemoryView":220
  *                                           self._strides, self.ndim, False)
  *             free(self.data)
  *         PyObject_Free(self._shape)             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   PyObject_Free(__pyx_v_self->_shape);
 
-  /* "View.MemoryView":211
+  /* "View.MemoryView":212
  *     __pyx_getbuffer = capsule(<void *> &__pyx_array_getbuffer, "getbuffer(obj, view, flags)")
  * 
  *     def __dealloc__(array self):             # <<<<<<<<<<<<<<
  *         if self.callback_free_data != NULL:
  *             self.callback_free_data(self.data)
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
 }
 
-/* "View.MemoryView":222
+/* "View.MemoryView":223
  * 
  *     @property
  *     def memview(self):             # <<<<<<<<<<<<<<
  *         return self.get_memview()
  * 
  */
 
@@ -20306,31 +21919,34 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_15View_dot_MemoryView_5array_7memview___get__(struct __pyx_array_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":223
+  /* "View.MemoryView":224
  *     @property
  *     def memview(self):
  *         return self.get_memview()             # <<<<<<<<<<<<<<
  * 
  *     @cname('get_memview')
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = ((struct __pyx_vtabstruct_array *)__pyx_v_self->__pyx_vtab)->get_memview(__pyx_v_self); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 223, __pyx_L1_error)
+  __pyx_t_1 = ((struct __pyx_vtabstruct_array *)__pyx_v_self->__pyx_vtab)->get_memview(__pyx_v_self); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 224, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":222
+  /* "View.MemoryView":223
  * 
  *     @property
  *     def memview(self):             # <<<<<<<<<<<<<<
  *         return self.get_memview()
  * 
  */
 
@@ -20341,71 +21957,74 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":226
+/* "View.MemoryView":227
  * 
  *     @cname('get_memview')
  *     cdef get_memview(self):             # <<<<<<<<<<<<<<
  *         flags =  PyBUF_ANY_CONTIGUOUS|PyBUF_FORMAT|PyBUF_WRITABLE
  *         return  memoryview(self, flags, self.dtype_is_object)
  */
 
 static PyObject *__pyx_array_get_memview(struct __pyx_array_obj *__pyx_v_self) {
   int __pyx_v_flags;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("get_memview", 0);
 
-  /* "View.MemoryView":227
+  /* "View.MemoryView":228
  *     @cname('get_memview')
  *     cdef get_memview(self):
  *         flags =  PyBUF_ANY_CONTIGUOUS|PyBUF_FORMAT|PyBUF_WRITABLE             # <<<<<<<<<<<<<<
  *         return  memoryview(self, flags, self.dtype_is_object)
  * 
  */
   __pyx_v_flags = ((PyBUF_ANY_CONTIGUOUS | PyBUF_FORMAT) | PyBUF_WRITABLE);
 
-  /* "View.MemoryView":228
+  /* "View.MemoryView":229
  *     cdef get_memview(self):
  *         flags =  PyBUF_ANY_CONTIGUOUS|PyBUF_FORMAT|PyBUF_WRITABLE
  *         return  memoryview(self, flags, self.dtype_is_object)             # <<<<<<<<<<<<<<
  * 
  *     def __len__(self):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_flags); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 228, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_flags); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 229, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyBool_FromLong(__pyx_v_self->dtype_is_object); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 228, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyBool_FromLong(__pyx_v_self->dtype_is_object); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 229, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 228, __pyx_L1_error)
+  __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 229, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_INCREF(((PyObject *)__pyx_v_self));
   __Pyx_GIVEREF(((PyObject *)__pyx_v_self));
   PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)__pyx_v_self));
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_2);
   PyTuple_SET_ITEM(__pyx_t_3, 2, __pyx_t_2);
   __pyx_t_1 = 0;
   __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)__pyx_memoryview_type), __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 228, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)__pyx_memoryview_type), __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 229, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __pyx_r = __pyx_t_2;
   __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":226
+  /* "View.MemoryView":227
  * 
  *     @cname('get_memview')
  *     cdef get_memview(self):             # <<<<<<<<<<<<<<
  *         flags =  PyBUF_ANY_CONTIGUOUS|PyBUF_FORMAT|PyBUF_WRITABLE
  *         return  memoryview(self, flags, self.dtype_is_object)
  */
 
@@ -20418,15 +22037,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":230
+/* "View.MemoryView":231
  *         return  memoryview(self, flags, self.dtype_is_object)
  * 
  *     def __len__(self):             # <<<<<<<<<<<<<<
  *         return self._shape[0]
  * 
  */
 
@@ -20444,39 +22063,39 @@
 }
 
 static Py_ssize_t __pyx_array___pyx_pf_15View_dot_MemoryView_5array_6__len__(struct __pyx_array_obj *__pyx_v_self) {
   Py_ssize_t __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__len__", 0);
 
-  /* "View.MemoryView":231
+  /* "View.MemoryView":232
  * 
  *     def __len__(self):
  *         return self._shape[0]             # <<<<<<<<<<<<<<
  * 
  *     def __getattr__(self, attr):
  */
   __pyx_r = (__pyx_v_self->_shape[0]);
   goto __pyx_L0;
 
-  /* "View.MemoryView":230
+  /* "View.MemoryView":231
  *         return  memoryview(self, flags, self.dtype_is_object)
  * 
  *     def __len__(self):             # <<<<<<<<<<<<<<
  *         return self._shape[0]
  * 
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":233
+/* "View.MemoryView":234
  *         return self._shape[0]
  * 
  *     def __getattr__(self, attr):             # <<<<<<<<<<<<<<
  *         return getattr(self.memview, attr)
  * 
  */
 
@@ -20494,34 +22113,37 @@
 }
 
 static PyObject *__pyx_array___pyx_pf_15View_dot_MemoryView_5array_8__getattr__(struct __pyx_array_obj *__pyx_v_self, PyObject *__pyx_v_attr) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__getattr__", 0);
 
-  /* "View.MemoryView":234
+  /* "View.MemoryView":235
  * 
  *     def __getattr__(self, attr):
  *         return getattr(self.memview, attr)             # <<<<<<<<<<<<<<
  * 
  *     def __getitem__(self, item):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_memview); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 234, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_memview); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 235, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_GetAttr(__pyx_t_1, __pyx_v_attr); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 234, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_GetAttr(__pyx_t_1, __pyx_v_attr); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 235, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_r = __pyx_t_2;
   __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":233
+  /* "View.MemoryView":234
  *         return self._shape[0]
  * 
  *     def __getattr__(self, attr):             # <<<<<<<<<<<<<<
  *         return getattr(self.memview, attr)
  * 
  */
 
@@ -20533,15 +22155,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":236
+/* "View.MemoryView":237
  *         return getattr(self.memview, attr)
  * 
  *     def __getitem__(self, item):             # <<<<<<<<<<<<<<
  *         return self.memview[item]
  * 
  */
 
@@ -20559,34 +22181,37 @@
 }
 
 static PyObject *__pyx_array___pyx_pf_15View_dot_MemoryView_5array_10__getitem__(struct __pyx_array_obj *__pyx_v_self, PyObject *__pyx_v_item) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__getitem__", 0);
 
-  /* "View.MemoryView":237
+  /* "View.MemoryView":238
  * 
  *     def __getitem__(self, item):
  *         return self.memview[item]             # <<<<<<<<<<<<<<
  * 
  *     def __setitem__(self, item, value):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_memview); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 237, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_memview); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 238, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyObject_GetItem(__pyx_t_1, __pyx_v_item); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 237, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetItem(__pyx_t_1, __pyx_v_item); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 238, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_r = __pyx_t_2;
   __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":236
+  /* "View.MemoryView":237
  *         return getattr(self.memview, attr)
  * 
  *     def __getitem__(self, item):             # <<<<<<<<<<<<<<
  *         return self.memview[item]
  * 
  */
 
@@ -20598,15 +22223,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":239
+/* "View.MemoryView":240
  *         return self.memview[item]
  * 
  *     def __setitem__(self, item, value):             # <<<<<<<<<<<<<<
  *         self.memview[item] = value
  * 
  */
 
@@ -20623,29 +22248,32 @@
   return __pyx_r;
 }
 
 static int __pyx_array___pyx_pf_15View_dot_MemoryView_5array_12__setitem__(struct __pyx_array_obj *__pyx_v_self, PyObject *__pyx_v_item, PyObject *__pyx_v_value) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setitem__", 0);
 
-  /* "View.MemoryView":240
+  /* "View.MemoryView":241
  * 
  *     def __setitem__(self, item, value):
  *         self.memview[item] = value             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_memview); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 240, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_memview); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 241, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  if (unlikely(PyObject_SetItem(__pyx_t_1, __pyx_v_item, __pyx_v_value) < 0)) __PYX_ERR(1, 240, __pyx_L1_error)
+  if (unlikely(PyObject_SetItem(__pyx_t_1, __pyx_v_item, __pyx_v_value) < 0)) __PYX_ERR(1, 241, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "View.MemoryView":239
+  /* "View.MemoryView":240
  *         return self.memview[item]
  * 
  *     def __setitem__(self, item, value):             # <<<<<<<<<<<<<<
  *         self.memview[item] = value
  * 
  */
 
@@ -20680,14 +22308,17 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf___pyx_array___reduce_cython__(CYTHON_UNUSED struct __pyx_array_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__reduce_cython__", 0);
 
   /* "(tree fragment)":2
  * def __reduce_cython__(self):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
@@ -20734,14 +22365,17 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf___pyx_array_2__setstate_cython__(CYTHON_UNUSED struct __pyx_array_obj *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setstate_cython__", 0);
 
   /* "(tree fragment)":4
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  */
@@ -20764,15 +22398,15 @@
   __Pyx_AddTraceback("View.MemoryView.array.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":244
+/* "View.MemoryView":245
  * 
  * @cname("__pyx_array_new")
  * cdef array array_cwrapper(tuple shape, Py_ssize_t itemsize, char *format,             # <<<<<<<<<<<<<<
  *                           char *mode, char *buf):
  *     cdef array result
  */
 
@@ -20781,147 +22415,150 @@
   struct __pyx_array_obj *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("array_cwrapper", 0);
 
-  /* "View.MemoryView":248
+  /* "View.MemoryView":249
  *     cdef array result
  * 
  *     if buf == NULL:             # <<<<<<<<<<<<<<
  *         result = array(shape, itemsize, format, mode.decode('ASCII'))
  *     else:
  */
   __pyx_t_1 = ((__pyx_v_buf == NULL) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":249
+    /* "View.MemoryView":250
  * 
  *     if buf == NULL:
  *         result = array(shape, itemsize, format, mode.decode('ASCII'))             # <<<<<<<<<<<<<<
  *     else:
  *         result = array(shape, itemsize, format, mode.decode('ASCII'),
  */
-    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_itemsize); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 249, __pyx_L1_error)
+    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_itemsize); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 250, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_3 = __Pyx_PyBytes_FromString(__pyx_v_format); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 249, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyBytes_FromString(__pyx_v_format); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 250, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_4 = __Pyx_decode_c_string(__pyx_v_mode, 0, strlen(__pyx_v_mode), NULL, NULL, PyUnicode_DecodeASCII); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 249, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_decode_c_string(__pyx_v_mode, 0, strlen(__pyx_v_mode), NULL, NULL, PyUnicode_DecodeASCII); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 250, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_5 = PyTuple_New(4); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 249, __pyx_L1_error)
+    __pyx_t_5 = PyTuple_New(4); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 250, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_INCREF(__pyx_v_shape);
     __Pyx_GIVEREF(__pyx_v_shape);
     PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_v_shape);
     __Pyx_GIVEREF(__pyx_t_2);
     PyTuple_SET_ITEM(__pyx_t_5, 1, __pyx_t_2);
     __Pyx_GIVEREF(__pyx_t_3);
     PyTuple_SET_ITEM(__pyx_t_5, 2, __pyx_t_3);
     __Pyx_GIVEREF(__pyx_t_4);
     PyTuple_SET_ITEM(__pyx_t_5, 3, __pyx_t_4);
     __pyx_t_2 = 0;
     __pyx_t_3 = 0;
     __pyx_t_4 = 0;
-    __pyx_t_4 = __Pyx_PyObject_Call(((PyObject *)__pyx_array_type), __pyx_t_5, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 249, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_Call(((PyObject *)__pyx_array_type), __pyx_t_5, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 250, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __pyx_v_result = ((struct __pyx_array_obj *)__pyx_t_4);
     __pyx_t_4 = 0;
 
-    /* "View.MemoryView":248
+    /* "View.MemoryView":249
  *     cdef array result
  * 
  *     if buf == NULL:             # <<<<<<<<<<<<<<
  *         result = array(shape, itemsize, format, mode.decode('ASCII'))
  *     else:
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":251
+  /* "View.MemoryView":252
  *         result = array(shape, itemsize, format, mode.decode('ASCII'))
  *     else:
  *         result = array(shape, itemsize, format, mode.decode('ASCII'),             # <<<<<<<<<<<<<<
  *                        allocate_buffer=False)
  *         result.data = buf
  */
   /*else*/ {
-    __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_itemsize); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 251, __pyx_L1_error)
+    __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_itemsize); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 252, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_5 = __Pyx_PyBytes_FromString(__pyx_v_format); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 251, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyBytes_FromString(__pyx_v_format); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 252, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_3 = __Pyx_decode_c_string(__pyx_v_mode, 0, strlen(__pyx_v_mode), NULL, NULL, PyUnicode_DecodeASCII); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 251, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_decode_c_string(__pyx_v_mode, 0, strlen(__pyx_v_mode), NULL, NULL, PyUnicode_DecodeASCII); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 252, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_2 = PyTuple_New(4); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 251, __pyx_L1_error)
+    __pyx_t_2 = PyTuple_New(4); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 252, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_INCREF(__pyx_v_shape);
     __Pyx_GIVEREF(__pyx_v_shape);
     PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_v_shape);
     __Pyx_GIVEREF(__pyx_t_4);
     PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_t_4);
     __Pyx_GIVEREF(__pyx_t_5);
     PyTuple_SET_ITEM(__pyx_t_2, 2, __pyx_t_5);
     __Pyx_GIVEREF(__pyx_t_3);
     PyTuple_SET_ITEM(__pyx_t_2, 3, __pyx_t_3);
     __pyx_t_4 = 0;
     __pyx_t_5 = 0;
     __pyx_t_3 = 0;
 
-    /* "View.MemoryView":252
+    /* "View.MemoryView":253
  *     else:
  *         result = array(shape, itemsize, format, mode.decode('ASCII'),
  *                        allocate_buffer=False)             # <<<<<<<<<<<<<<
  *         result.data = buf
  * 
  */
-    __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 252, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 253, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_allocate_buffer, Py_False) < 0) __PYX_ERR(1, 252, __pyx_L1_error)
+    if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_allocate_buffer, Py_False) < 0) __PYX_ERR(1, 253, __pyx_L1_error)
 
-    /* "View.MemoryView":251
+    /* "View.MemoryView":252
  *         result = array(shape, itemsize, format, mode.decode('ASCII'))
  *     else:
  *         result = array(shape, itemsize, format, mode.decode('ASCII'),             # <<<<<<<<<<<<<<
  *                        allocate_buffer=False)
  *         result.data = buf
  */
-    __pyx_t_5 = __Pyx_PyObject_Call(((PyObject *)__pyx_array_type), __pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 251, __pyx_L1_error)
+    __pyx_t_5 = __Pyx_PyObject_Call(((PyObject *)__pyx_array_type), __pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 252, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __pyx_v_result = ((struct __pyx_array_obj *)__pyx_t_5);
     __pyx_t_5 = 0;
 
-    /* "View.MemoryView":253
+    /* "View.MemoryView":254
  *         result = array(shape, itemsize, format, mode.decode('ASCII'),
  *                        allocate_buffer=False)
  *         result.data = buf             # <<<<<<<<<<<<<<
  * 
  *     return result
  */
     __pyx_v_result->data = __pyx_v_buf;
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":255
+  /* "View.MemoryView":256
  *         result.data = buf
  * 
  *     return result             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __Pyx_XDECREF(((PyObject *)__pyx_r));
   __Pyx_INCREF(((PyObject *)__pyx_v_result));
   __pyx_r = __pyx_v_result;
   goto __pyx_L0;
 
-  /* "View.MemoryView":244
+  /* "View.MemoryView":245
  * 
  * @cname("__pyx_array_new")
  * cdef array array_cwrapper(tuple shape, Py_ssize_t itemsize, char *format,             # <<<<<<<<<<<<<<
  *                           char *mode, char *buf):
  *     cdef array result
  */
 
@@ -20936,26 +22573,29 @@
   __pyx_L0:;
   __Pyx_XDECREF((PyObject *)__pyx_v_result);
   __Pyx_XGIVEREF((PyObject *)__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":281
+/* "View.MemoryView":282
  * cdef class Enum(object):
  *     cdef object name
  *     def __init__(self, name):             # <<<<<<<<<<<<<<
  *         self.name = name
  *     def __repr__(self):
  */
 
 /* Python wrapper */
 static int __pyx_MemviewEnum___init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static int __pyx_MemviewEnum___init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_name = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_name,0};
     PyObject* values[1] = {0};
     if (unlikely(__pyx_kwds)) {
@@ -20970,26 +22610,26 @@
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_name)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(1, 281, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__init__") < 0)) __PYX_ERR(1, 282, __pyx_L3_error)
       }
     } else if (PyTuple_GET_SIZE(__pyx_args) != 1) {
       goto __pyx_L5_argtuple_error;
     } else {
       values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
     }
     __pyx_v_name = values[0];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 1, 1, 1, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(1, 281, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 1, 1, 1, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(1, 282, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("View.MemoryView.Enum.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_MemviewEnum___pyx_pf_15View_dot_MemoryView_4Enum___init__(((struct __pyx_MemviewEnum_obj *)__pyx_v_self), __pyx_v_name);
 
@@ -20999,42 +22639,42 @@
 }
 
 static int __pyx_MemviewEnum___pyx_pf_15View_dot_MemoryView_4Enum___init__(struct __pyx_MemviewEnum_obj *__pyx_v_self, PyObject *__pyx_v_name) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "View.MemoryView":282
+  /* "View.MemoryView":283
  *     cdef object name
  *     def __init__(self, name):
  *         self.name = name             # <<<<<<<<<<<<<<
  *     def __repr__(self):
  *         return self.name
  */
   __Pyx_INCREF(__pyx_v_name);
   __Pyx_GIVEREF(__pyx_v_name);
   __Pyx_GOTREF(__pyx_v_self->name);
   __Pyx_DECREF(__pyx_v_self->name);
   __pyx_v_self->name = __pyx_v_name;
 
-  /* "View.MemoryView":281
+  /* "View.MemoryView":282
  * cdef class Enum(object):
  *     cdef object name
  *     def __init__(self, name):             # <<<<<<<<<<<<<<
  *         self.name = name
  *     def __repr__(self):
  */
 
   /* function exit code */
   __pyx_r = 0;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":283
+/* "View.MemoryView":284
  *     def __init__(self, name):
  *         self.name = name
  *     def __repr__(self):             # <<<<<<<<<<<<<<
  *         return self.name
  * 
  */
 
@@ -21052,27 +22692,27 @@
 }
 
 static PyObject *__pyx_MemviewEnum___pyx_pf_15View_dot_MemoryView_4Enum_2__repr__(struct __pyx_MemviewEnum_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__repr__", 0);
 
-  /* "View.MemoryView":284
+  /* "View.MemoryView":285
  *         self.name = name
  *     def __repr__(self):
  *         return self.name             # <<<<<<<<<<<<<<
  * 
  * cdef generic = Enum("<strided and direct or indirect>")
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(__pyx_v_self->name);
   __pyx_r = __pyx_v_self->name;
   goto __pyx_L0;
 
-  /* "View.MemoryView":283
+  /* "View.MemoryView":284
  *     def __init__(self, name):
  *         self.name = name
  *     def __repr__(self):             # <<<<<<<<<<<<<<
  *         return self.name
  * 
  */
 
@@ -21109,14 +22749,17 @@
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_t_2;
   int __pyx_t_3;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__reduce_cython__", 0);
 
   /* "(tree fragment)":5
  *     cdef object _dict
  *     cdef bint use_setstate
  *     state = (self.name,)             # <<<<<<<<<<<<<<
  *     _dict = getattr(self, '__dict__', None)
@@ -21334,22 +22977,25 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf___pyx_MemviewEnum_2__setstate_cython__(struct __pyx_MemviewEnum_obj *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setstate_cython__", 0);
 
   /* "(tree fragment)":17
  *         return __pyx_unpickle_Enum, (type(self), 0xb068931, state)
  * def __setstate_cython__(self, __pyx_state):
  *     __pyx_unpickle_Enum__set_state(self, __pyx_state)             # <<<<<<<<<<<<<<
  */
-  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
+  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
   __pyx_t_1 = __pyx_unpickle_Enum__set_state(__pyx_v_self, ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 17, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
   /* "(tree fragment)":16
  *     else:
  *         return __pyx_unpickle_Enum, (type(self), 0xb068931, state)
@@ -21366,111 +23012,114 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":298
+/* "View.MemoryView":299
  * 
  * @cname('__pyx_align_pointer')
  * cdef void *align_pointer(void *memory, size_t alignment) nogil:             # <<<<<<<<<<<<<<
  *     "Align pointer memory on a given boundary"
  *     cdef Py_intptr_t aligned_p = <Py_intptr_t> memory
  */
 
 static void *__pyx_align_pointer(void *__pyx_v_memory, size_t __pyx_v_alignment) {
   Py_intptr_t __pyx_v_aligned_p;
   size_t __pyx_v_offset;
   void *__pyx_r;
   int __pyx_t_1;
 
-  /* "View.MemoryView":300
+  /* "View.MemoryView":301
  * cdef void *align_pointer(void *memory, size_t alignment) nogil:
  *     "Align pointer memory on a given boundary"
  *     cdef Py_intptr_t aligned_p = <Py_intptr_t> memory             # <<<<<<<<<<<<<<
  *     cdef size_t offset
  * 
  */
   __pyx_v_aligned_p = ((Py_intptr_t)__pyx_v_memory);
 
-  /* "View.MemoryView":304
+  /* "View.MemoryView":305
  * 
  *     with cython.cdivision(True):
  *         offset = aligned_p % alignment             # <<<<<<<<<<<<<<
  * 
  *     if offset > 0:
  */
   __pyx_v_offset = (__pyx_v_aligned_p % __pyx_v_alignment);
 
-  /* "View.MemoryView":306
+  /* "View.MemoryView":307
  *         offset = aligned_p % alignment
  * 
  *     if offset > 0:             # <<<<<<<<<<<<<<
  *         aligned_p += alignment - offset
  * 
  */
   __pyx_t_1 = ((__pyx_v_offset > 0) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":307
+    /* "View.MemoryView":308
  * 
  *     if offset > 0:
  *         aligned_p += alignment - offset             # <<<<<<<<<<<<<<
  * 
  *     return <void *> aligned_p
  */
     __pyx_v_aligned_p = (__pyx_v_aligned_p + (__pyx_v_alignment - __pyx_v_offset));
 
-    /* "View.MemoryView":306
+    /* "View.MemoryView":307
  *         offset = aligned_p % alignment
  * 
  *     if offset > 0:             # <<<<<<<<<<<<<<
  *         aligned_p += alignment - offset
  * 
  */
   }
 
-  /* "View.MemoryView":309
+  /* "View.MemoryView":310
  *         aligned_p += alignment - offset
  * 
  *     return <void *> aligned_p             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = ((void *)__pyx_v_aligned_p);
   goto __pyx_L0;
 
-  /* "View.MemoryView":298
+  /* "View.MemoryView":299
  * 
  * @cname('__pyx_align_pointer')
  * cdef void *align_pointer(void *memory, size_t alignment) nogil:             # <<<<<<<<<<<<<<
  *     "Align pointer memory on a given boundary"
  *     cdef Py_intptr_t aligned_p = <Py_intptr_t> memory
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "View.MemoryView":345
+/* "View.MemoryView":346
  *     cdef __Pyx_TypeInfo *typeinfo
  * 
  *     def __cinit__(memoryview self, object obj, int flags, bint dtype_is_object=False):             # <<<<<<<<<<<<<<
  *         self.obj = obj
  *         self.flags = flags
  */
 
 /* Python wrapper */
 static int __pyx_memoryview___cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static int __pyx_memoryview___cinit__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_obj = 0;
   int __pyx_v_flags;
   int __pyx_v_dtype_is_object;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__cinit__ (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_obj,&__pyx_n_s_flags,&__pyx_n_s_dtype_is_object,0};
     PyObject* values[3] = {0,0,0};
     if (unlikely(__pyx_kwds)) {
@@ -21491,47 +23140,47 @@
         case  0:
         if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_obj)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
         if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_flags)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 2, 3, 1); __PYX_ERR(1, 345, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 2, 3, 1); __PYX_ERR(1, 346, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_dtype_is_object);
           if (value) { values[2] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__cinit__") < 0)) __PYX_ERR(1, 345, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__cinit__") < 0)) __PYX_ERR(1, 346, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
         case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
         CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
     __pyx_v_obj = values[0];
-    __pyx_v_flags = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_flags == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 345, __pyx_L3_error)
+    __pyx_v_flags = __Pyx_PyInt_As_int(values[1]); if (unlikely((__pyx_v_flags == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 346, __pyx_L3_error)
     if (values[2]) {
-      __pyx_v_dtype_is_object = __Pyx_PyObject_IsTrue(values[2]); if (unlikely((__pyx_v_dtype_is_object == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 345, __pyx_L3_error)
+      __pyx_v_dtype_is_object = __Pyx_PyObject_IsTrue(values[2]); if (unlikely((__pyx_v_dtype_is_object == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 346, __pyx_L3_error)
     } else {
       __pyx_v_dtype_is_object = ((int)0);
     }
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 2, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(1, 345, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__cinit__", 0, 2, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(1, 346, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("View.MemoryView.memoryview.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return -1;
   __pyx_L4_argument_unpacking_done:;
   __pyx_r = __pyx_memoryview___pyx_pf_15View_dot_MemoryView_10memoryview___cinit__(((struct __pyx_memoryview_obj *)__pyx_v_self), __pyx_v_obj, __pyx_v_flags, __pyx_v_dtype_is_object);
 
@@ -21543,39 +23192,42 @@
 static int __pyx_memoryview___pyx_pf_15View_dot_MemoryView_10memoryview___cinit__(struct __pyx_memoryview_obj *__pyx_v_self, PyObject *__pyx_v_obj, int __pyx_v_flags, int __pyx_v_dtype_is_object) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   int __pyx_t_3;
   int __pyx_t_4;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__cinit__", 0);
 
-  /* "View.MemoryView":346
+  /* "View.MemoryView":347
  * 
  *     def __cinit__(memoryview self, object obj, int flags, bint dtype_is_object=False):
  *         self.obj = obj             # <<<<<<<<<<<<<<
  *         self.flags = flags
  *         if type(self) is memoryview or obj is not None:
  */
   __Pyx_INCREF(__pyx_v_obj);
   __Pyx_GIVEREF(__pyx_v_obj);
   __Pyx_GOTREF(__pyx_v_self->obj);
   __Pyx_DECREF(__pyx_v_self->obj);
   __pyx_v_self->obj = __pyx_v_obj;
 
-  /* "View.MemoryView":347
+  /* "View.MemoryView":348
  *     def __cinit__(memoryview self, object obj, int flags, bint dtype_is_object=False):
  *         self.obj = obj
  *         self.flags = flags             # <<<<<<<<<<<<<<
  *         if type(self) is memoryview or obj is not None:
  *             __Pyx_GetBuffer(obj, &self.view, flags)
  */
   __pyx_v_self->flags = __pyx_v_flags;
 
-  /* "View.MemoryView":348
+  /* "View.MemoryView":349
  *         self.obj = obj
  *         self.flags = flags
  *         if type(self) is memoryview or obj is not None:             # <<<<<<<<<<<<<<
  *             __Pyx_GetBuffer(obj, &self.view, flags)
  *             if <PyObject *> self.view.obj == NULL:
  */
   __pyx_t_2 = (((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))) == ((PyObject *)__pyx_memoryview_type));
@@ -21587,231 +23239,250 @@
   }
   __pyx_t_3 = (__pyx_v_obj != Py_None);
   __pyx_t_2 = (__pyx_t_3 != 0);
   __pyx_t_1 = __pyx_t_2;
   __pyx_L4_bool_binop_done:;
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":349
+    /* "View.MemoryView":350
  *         self.flags = flags
  *         if type(self) is memoryview or obj is not None:
  *             __Pyx_GetBuffer(obj, &self.view, flags)             # <<<<<<<<<<<<<<
  *             if <PyObject *> self.view.obj == NULL:
  *                 (<__pyx_buffer *> &self.view).obj = Py_None
  */
-    __pyx_t_4 = __Pyx_GetBuffer(__pyx_v_obj, (&__pyx_v_self->view), __pyx_v_flags); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 349, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_GetBuffer(__pyx_v_obj, (&__pyx_v_self->view), __pyx_v_flags); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 350, __pyx_L1_error)
 
-    /* "View.MemoryView":350
+    /* "View.MemoryView":351
  *         if type(self) is memoryview or obj is not None:
  *             __Pyx_GetBuffer(obj, &self.view, flags)
  *             if <PyObject *> self.view.obj == NULL:             # <<<<<<<<<<<<<<
  *                 (<__pyx_buffer *> &self.view).obj = Py_None
  *                 Py_INCREF(Py_None)
  */
     __pyx_t_1 = ((((PyObject *)__pyx_v_self->view.obj) == NULL) != 0);
     if (__pyx_t_1) {
 
-      /* "View.MemoryView":351
+      /* "View.MemoryView":352
  *             __Pyx_GetBuffer(obj, &self.view, flags)
  *             if <PyObject *> self.view.obj == NULL:
  *                 (<__pyx_buffer *> &self.view).obj = Py_None             # <<<<<<<<<<<<<<
  *                 Py_INCREF(Py_None)
  * 
  */
       ((Py_buffer *)(&__pyx_v_self->view))->obj = Py_None;
 
-      /* "View.MemoryView":352
+      /* "View.MemoryView":353
  *             if <PyObject *> self.view.obj == NULL:
  *                 (<__pyx_buffer *> &self.view).obj = Py_None
  *                 Py_INCREF(Py_None)             # <<<<<<<<<<<<<<
  * 
- *         global __pyx_memoryview_thread_locks_used
+ *         if not __PYX_CYTHON_ATOMICS_ENABLED():
  */
       Py_INCREF(Py_None);
 
-      /* "View.MemoryView":350
+      /* "View.MemoryView":351
  *         if type(self) is memoryview or obj is not None:
  *             __Pyx_GetBuffer(obj, &self.view, flags)
  *             if <PyObject *> self.view.obj == NULL:             # <<<<<<<<<<<<<<
  *                 (<__pyx_buffer *> &self.view).obj = Py_None
  *                 Py_INCREF(Py_None)
  */
     }
 
-    /* "View.MemoryView":348
+    /* "View.MemoryView":349
  *         self.obj = obj
  *         self.flags = flags
  *         if type(self) is memoryview or obj is not None:             # <<<<<<<<<<<<<<
  *             __Pyx_GetBuffer(obj, &self.view, flags)
  *             if <PyObject *> self.view.obj == NULL:
  */
   }
 
   /* "View.MemoryView":355
+ *                 Py_INCREF(Py_None)
  * 
- *         global __pyx_memoryview_thread_locks_used
- *         if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:             # <<<<<<<<<<<<<<
- *             self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
- *             __pyx_memoryview_thread_locks_used += 1
+ *         if not __PYX_CYTHON_ATOMICS_ENABLED():             # <<<<<<<<<<<<<<
+ *             global __pyx_memoryview_thread_locks_used
+ *             if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:
  */
-  __pyx_t_1 = ((__pyx_memoryview_thread_locks_used < 8) != 0);
+  __pyx_t_1 = ((!(__PYX_CYTHON_ATOMICS_ENABLED() != 0)) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":356
- *         global __pyx_memoryview_thread_locks_used
- *         if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:
- *             self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]             # <<<<<<<<<<<<<<
- *             __pyx_memoryview_thread_locks_used += 1
- *         if self.lock is NULL:
- */
-    __pyx_v_self->lock = (__pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]);
-
     /* "View.MemoryView":357
- *         if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:
- *             self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
- *             __pyx_memoryview_thread_locks_used += 1             # <<<<<<<<<<<<<<
- *         if self.lock is NULL:
- *             self.lock = PyThread_allocate_lock()
+ *         if not __PYX_CYTHON_ATOMICS_ENABLED():
+ *             global __pyx_memoryview_thread_locks_used
+ *             if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:             # <<<<<<<<<<<<<<
+ *                 self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
+ *                 __pyx_memoryview_thread_locks_used += 1
  */
-    __pyx_memoryview_thread_locks_used = (__pyx_memoryview_thread_locks_used + 1);
+    __pyx_t_1 = ((__pyx_memoryview_thread_locks_used < 8) != 0);
+    if (__pyx_t_1) {
 
-    /* "View.MemoryView":355
- * 
- *         global __pyx_memoryview_thread_locks_used
- *         if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:             # <<<<<<<<<<<<<<
- *             self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
- *             __pyx_memoryview_thread_locks_used += 1
+      /* "View.MemoryView":358
+ *             global __pyx_memoryview_thread_locks_used
+ *             if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:
+ *                 self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]             # <<<<<<<<<<<<<<
+ *                 __pyx_memoryview_thread_locks_used += 1
+ *             if self.lock is NULL:
  */
-  }
+      __pyx_v_self->lock = (__pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]);
 
-  /* "View.MemoryView":358
- *             self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
- *             __pyx_memoryview_thread_locks_used += 1
- *         if self.lock is NULL:             # <<<<<<<<<<<<<<
- *             self.lock = PyThread_allocate_lock()
+      /* "View.MemoryView":359
+ *             if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:
+ *                 self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
+ *                 __pyx_memoryview_thread_locks_used += 1             # <<<<<<<<<<<<<<
  *             if self.lock is NULL:
+ *                 self.lock = PyThread_allocate_lock()
  */
-  __pyx_t_1 = ((__pyx_v_self->lock == NULL) != 0);
-  if (__pyx_t_1) {
+      __pyx_memoryview_thread_locks_used = (__pyx_memoryview_thread_locks_used + 1);
 
-    /* "View.MemoryView":359
- *             __pyx_memoryview_thread_locks_used += 1
- *         if self.lock is NULL:
- *             self.lock = PyThread_allocate_lock()             # <<<<<<<<<<<<<<
- *             if self.lock is NULL:
- *                 raise MemoryError
+      /* "View.MemoryView":357
+ *         if not __PYX_CYTHON_ATOMICS_ENABLED():
+ *             global __pyx_memoryview_thread_locks_used
+ *             if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:             # <<<<<<<<<<<<<<
+ *                 self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
+ *                 __pyx_memoryview_thread_locks_used += 1
  */
-    __pyx_v_self->lock = PyThread_allocate_lock();
+    }
 
     /* "View.MemoryView":360
- *         if self.lock is NULL:
- *             self.lock = PyThread_allocate_lock()
+ *                 self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
+ *                 __pyx_memoryview_thread_locks_used += 1
  *             if self.lock is NULL:             # <<<<<<<<<<<<<<
- *                 raise MemoryError
- * 
+ *                 self.lock = PyThread_allocate_lock()
+ *                 if self.lock is NULL:
  */
     __pyx_t_1 = ((__pyx_v_self->lock == NULL) != 0);
-    if (unlikely(__pyx_t_1)) {
+    if (__pyx_t_1) {
 
       /* "View.MemoryView":361
- *             self.lock = PyThread_allocate_lock()
+ *                 __pyx_memoryview_thread_locks_used += 1
  *             if self.lock is NULL:
- *                 raise MemoryError             # <<<<<<<<<<<<<<
+ *                 self.lock = PyThread_allocate_lock()             # <<<<<<<<<<<<<<
+ *                 if self.lock is NULL:
+ *                     raise MemoryError
+ */
+      __pyx_v_self->lock = PyThread_allocate_lock();
+
+      /* "View.MemoryView":362
+ *             if self.lock is NULL:
+ *                 self.lock = PyThread_allocate_lock()
+ *                 if self.lock is NULL:             # <<<<<<<<<<<<<<
+ *                     raise MemoryError
+ * 
+ */
+      __pyx_t_1 = ((__pyx_v_self->lock == NULL) != 0);
+      if (unlikely(__pyx_t_1)) {
+
+        /* "View.MemoryView":363
+ *                 self.lock = PyThread_allocate_lock()
+ *                 if self.lock is NULL:
+ *                     raise MemoryError             # <<<<<<<<<<<<<<
  * 
  *         if flags & PyBUF_FORMAT:
  */
-      PyErr_NoMemory(); __PYX_ERR(1, 361, __pyx_L1_error)
+        PyErr_NoMemory(); __PYX_ERR(1, 363, __pyx_L1_error)
+
+        /* "View.MemoryView":362
+ *             if self.lock is NULL:
+ *                 self.lock = PyThread_allocate_lock()
+ *                 if self.lock is NULL:             # <<<<<<<<<<<<<<
+ *                     raise MemoryError
+ * 
+ */
+      }
 
       /* "View.MemoryView":360
- *         if self.lock is NULL:
- *             self.lock = PyThread_allocate_lock()
+ *                 self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
+ *                 __pyx_memoryview_thread_locks_used += 1
  *             if self.lock is NULL:             # <<<<<<<<<<<<<<
- *                 raise MemoryError
- * 
+ *                 self.lock = PyThread_allocate_lock()
+ *                 if self.lock is NULL:
  */
     }
 
-    /* "View.MemoryView":358
- *             self.lock = __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]
- *             __pyx_memoryview_thread_locks_used += 1
- *         if self.lock is NULL:             # <<<<<<<<<<<<<<
- *             self.lock = PyThread_allocate_lock()
- *             if self.lock is NULL:
+    /* "View.MemoryView":355
+ *                 Py_INCREF(Py_None)
+ * 
+ *         if not __PYX_CYTHON_ATOMICS_ENABLED():             # <<<<<<<<<<<<<<
+ *             global __pyx_memoryview_thread_locks_used
+ *             if __pyx_memoryview_thread_locks_used < THREAD_LOCKS_PREALLOCATED:
  */
   }
 
-  /* "View.MemoryView":363
- *                 raise MemoryError
+  /* "View.MemoryView":365
+ *                     raise MemoryError
  * 
  *         if flags & PyBUF_FORMAT:             # <<<<<<<<<<<<<<
  *             self.dtype_is_object = (self.view.format[0] == b'O' and self.view.format[1] == b'\0')
  *         else:
  */
   __pyx_t_1 = ((__pyx_v_flags & PyBUF_FORMAT) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":364
+    /* "View.MemoryView":366
  * 
  *         if flags & PyBUF_FORMAT:
  *             self.dtype_is_object = (self.view.format[0] == b'O' and self.view.format[1] == b'\0')             # <<<<<<<<<<<<<<
  *         else:
  *             self.dtype_is_object = dtype_is_object
  */
     __pyx_t_2 = (((__pyx_v_self->view.format[0]) == 'O') != 0);
     if (__pyx_t_2) {
     } else {
       __pyx_t_1 = __pyx_t_2;
-      goto __pyx_L11_bool_binop_done;
+      goto __pyx_L12_bool_binop_done;
     }
     __pyx_t_2 = (((__pyx_v_self->view.format[1]) == '\x00') != 0);
     __pyx_t_1 = __pyx_t_2;
-    __pyx_L11_bool_binop_done:;
+    __pyx_L12_bool_binop_done:;
     __pyx_v_self->dtype_is_object = __pyx_t_1;
 
-    /* "View.MemoryView":363
- *                 raise MemoryError
+    /* "View.MemoryView":365
+ *                     raise MemoryError
  * 
  *         if flags & PyBUF_FORMAT:             # <<<<<<<<<<<<<<
  *             self.dtype_is_object = (self.view.format[0] == b'O' and self.view.format[1] == b'\0')
  *         else:
  */
-    goto __pyx_L10;
+    goto __pyx_L11;
   }
 
-  /* "View.MemoryView":366
+  /* "View.MemoryView":368
  *             self.dtype_is_object = (self.view.format[0] == b'O' and self.view.format[1] == b'\0')
  *         else:
  *             self.dtype_is_object = dtype_is_object             # <<<<<<<<<<<<<<
  * 
  *         self.acquisition_count_aligned_p = <__pyx_atomic_int *> align_pointer(
  */
   /*else*/ {
     __pyx_v_self->dtype_is_object = __pyx_v_dtype_is_object;
   }
-  __pyx_L10:;
+  __pyx_L11:;
 
-  /* "View.MemoryView":368
+  /* "View.MemoryView":370
  *             self.dtype_is_object = dtype_is_object
  * 
  *         self.acquisition_count_aligned_p = <__pyx_atomic_int *> align_pointer(             # <<<<<<<<<<<<<<
  *                   <void *> &self.acquisition_count[0], sizeof(__pyx_atomic_int))
  *         self.typeinfo = NULL
  */
   __pyx_v_self->acquisition_count_aligned_p = ((__pyx_atomic_int *)__pyx_align_pointer(((void *)(&(__pyx_v_self->acquisition_count[0]))), (sizeof(__pyx_atomic_int))));
 
-  /* "View.MemoryView":370
+  /* "View.MemoryView":372
  *         self.acquisition_count_aligned_p = <__pyx_atomic_int *> align_pointer(
  *                   <void *> &self.acquisition_count[0], sizeof(__pyx_atomic_int))
  *         self.typeinfo = NULL             # <<<<<<<<<<<<<<
  * 
  *     def __dealloc__(memoryview self):
  */
   __pyx_v_self->typeinfo = NULL;
 
-  /* "View.MemoryView":345
+  /* "View.MemoryView":346
  *     cdef __Pyx_TypeInfo *typeinfo
  * 
  *     def __cinit__(memoryview self, object obj, int flags, bint dtype_is_object=False):             # <<<<<<<<<<<<<<
  *         self.obj = obj
  *         self.flags = flags
  */
 
@@ -21822,15 +23493,15 @@
   __Pyx_AddTraceback("View.MemoryView.memoryview.__cinit__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = -1;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":372
+/* "View.MemoryView":374
  *         self.typeinfo = NULL
  * 
  *     def __dealloc__(memoryview self):             # <<<<<<<<<<<<<<
  *         if self.obj is not None:
  *             __Pyx_ReleaseBuffer(&self.view)
  */
 
@@ -21853,176 +23524,215 @@
   int __pyx_t_3;
   int __pyx_t_4;
   int __pyx_t_5;
   PyThread_type_lock __pyx_t_6;
   PyThread_type_lock __pyx_t_7;
   __Pyx_RefNannySetupContext("__dealloc__", 0);
 
-  /* "View.MemoryView":373
+  /* "View.MemoryView":375
  * 
  *     def __dealloc__(memoryview self):
  *         if self.obj is not None:             # <<<<<<<<<<<<<<
  *             __Pyx_ReleaseBuffer(&self.view)
- * 
+ *         elif (<__pyx_buffer *> &self.view).obj == Py_None:
  */
   __pyx_t_1 = (__pyx_v_self->obj != Py_None);
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":374
+    /* "View.MemoryView":376
  *     def __dealloc__(memoryview self):
  *         if self.obj is not None:
  *             __Pyx_ReleaseBuffer(&self.view)             # <<<<<<<<<<<<<<
+ *         elif (<__pyx_buffer *> &self.view).obj == Py_None:
  * 
- *         cdef int i
  */
     __Pyx_ReleaseBuffer((&__pyx_v_self->view));
 
-    /* "View.MemoryView":373
+    /* "View.MemoryView":375
  * 
  *     def __dealloc__(memoryview self):
  *         if self.obj is not None:             # <<<<<<<<<<<<<<
  *             __Pyx_ReleaseBuffer(&self.view)
+ *         elif (<__pyx_buffer *> &self.view).obj == Py_None:
+ */
+    goto __pyx_L3;
+  }
+
+  /* "View.MemoryView":377
+ *         if self.obj is not None:
+ *             __Pyx_ReleaseBuffer(&self.view)
+ *         elif (<__pyx_buffer *> &self.view).obj == Py_None:             # <<<<<<<<<<<<<<
+ * 
+ *             (<__pyx_buffer *> &self.view).obj = NULL
+ */
+  __pyx_t_2 = ((((Py_buffer *)(&__pyx_v_self->view))->obj == Py_None) != 0);
+  if (__pyx_t_2) {
+
+    /* "View.MemoryView":379
+ *         elif (<__pyx_buffer *> &self.view).obj == Py_None:
+ * 
+ *             (<__pyx_buffer *> &self.view).obj = NULL             # <<<<<<<<<<<<<<
+ *             Py_DECREF(Py_None)
+ * 
+ */
+    ((Py_buffer *)(&__pyx_v_self->view))->obj = NULL;
+
+    /* "View.MemoryView":380
+ * 
+ *             (<__pyx_buffer *> &self.view).obj = NULL
+ *             Py_DECREF(Py_None)             # <<<<<<<<<<<<<<
+ * 
+ *         cdef int i
+ */
+    Py_DECREF(Py_None);
+
+    /* "View.MemoryView":377
+ *         if self.obj is not None:
+ *             __Pyx_ReleaseBuffer(&self.view)
+ *         elif (<__pyx_buffer *> &self.view).obj == Py_None:             # <<<<<<<<<<<<<<
  * 
+ *             (<__pyx_buffer *> &self.view).obj = NULL
  */
   }
+  __pyx_L3:;
 
-  /* "View.MemoryView":378
+  /* "View.MemoryView":384
  *         cdef int i
  *         global __pyx_memoryview_thread_locks_used
  *         if self.lock != NULL:             # <<<<<<<<<<<<<<
  *             for i in range(__pyx_memoryview_thread_locks_used):
  *                 if __pyx_memoryview_thread_locks[i] is self.lock:
  */
   __pyx_t_2 = ((__pyx_v_self->lock != NULL) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":379
+    /* "View.MemoryView":385
  *         global __pyx_memoryview_thread_locks_used
  *         if self.lock != NULL:
  *             for i in range(__pyx_memoryview_thread_locks_used):             # <<<<<<<<<<<<<<
  *                 if __pyx_memoryview_thread_locks[i] is self.lock:
  *                     __pyx_memoryview_thread_locks_used -= 1
  */
     __pyx_t_3 = __pyx_memoryview_thread_locks_used;
     __pyx_t_4 = __pyx_t_3;
     for (__pyx_t_5 = 0; __pyx_t_5 < __pyx_t_4; __pyx_t_5+=1) {
       __pyx_v_i = __pyx_t_5;
 
-      /* "View.MemoryView":380
+      /* "View.MemoryView":386
  *         if self.lock != NULL:
  *             for i in range(__pyx_memoryview_thread_locks_used):
  *                 if __pyx_memoryview_thread_locks[i] is self.lock:             # <<<<<<<<<<<<<<
  *                     __pyx_memoryview_thread_locks_used -= 1
  *                     if i != __pyx_memoryview_thread_locks_used:
  */
       __pyx_t_2 = (((__pyx_memoryview_thread_locks[__pyx_v_i]) == __pyx_v_self->lock) != 0);
       if (__pyx_t_2) {
 
-        /* "View.MemoryView":381
+        /* "View.MemoryView":387
  *             for i in range(__pyx_memoryview_thread_locks_used):
  *                 if __pyx_memoryview_thread_locks[i] is self.lock:
  *                     __pyx_memoryview_thread_locks_used -= 1             # <<<<<<<<<<<<<<
  *                     if i != __pyx_memoryview_thread_locks_used:
  *                         __pyx_memoryview_thread_locks[i], __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used] = (
  */
         __pyx_memoryview_thread_locks_used = (__pyx_memoryview_thread_locks_used - 1);
 
-        /* "View.MemoryView":382
+        /* "View.MemoryView":388
  *                 if __pyx_memoryview_thread_locks[i] is self.lock:
  *                     __pyx_memoryview_thread_locks_used -= 1
  *                     if i != __pyx_memoryview_thread_locks_used:             # <<<<<<<<<<<<<<
  *                         __pyx_memoryview_thread_locks[i], __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used] = (
  *                             __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used], __pyx_memoryview_thread_locks[i])
  */
         __pyx_t_2 = ((__pyx_v_i != __pyx_memoryview_thread_locks_used) != 0);
         if (__pyx_t_2) {
 
-          /* "View.MemoryView":384
+          /* "View.MemoryView":390
  *                     if i != __pyx_memoryview_thread_locks_used:
  *                         __pyx_memoryview_thread_locks[i], __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used] = (
  *                             __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used], __pyx_memoryview_thread_locks[i])             # <<<<<<<<<<<<<<
  *                     break
  *             else:
  */
           __pyx_t_6 = (__pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]);
           __pyx_t_7 = (__pyx_memoryview_thread_locks[__pyx_v_i]);
 
-          /* "View.MemoryView":383
+          /* "View.MemoryView":389
  *                     __pyx_memoryview_thread_locks_used -= 1
  *                     if i != __pyx_memoryview_thread_locks_used:
  *                         __pyx_memoryview_thread_locks[i], __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used] = (             # <<<<<<<<<<<<<<
  *                             __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used], __pyx_memoryview_thread_locks[i])
  *                     break
  */
           (__pyx_memoryview_thread_locks[__pyx_v_i]) = __pyx_t_6;
           (__pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used]) = __pyx_t_7;
 
-          /* "View.MemoryView":382
+          /* "View.MemoryView":388
  *                 if __pyx_memoryview_thread_locks[i] is self.lock:
  *                     __pyx_memoryview_thread_locks_used -= 1
  *                     if i != __pyx_memoryview_thread_locks_used:             # <<<<<<<<<<<<<<
  *                         __pyx_memoryview_thread_locks[i], __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used] = (
  *                             __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used], __pyx_memoryview_thread_locks[i])
  */
         }
 
-        /* "View.MemoryView":385
+        /* "View.MemoryView":391
  *                         __pyx_memoryview_thread_locks[i], __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used] = (
  *                             __pyx_memoryview_thread_locks[__pyx_memoryview_thread_locks_used], __pyx_memoryview_thread_locks[i])
  *                     break             # <<<<<<<<<<<<<<
  *             else:
  *                 PyThread_free_lock(self.lock)
  */
         goto __pyx_L6_break;
 
-        /* "View.MemoryView":380
+        /* "View.MemoryView":386
  *         if self.lock != NULL:
  *             for i in range(__pyx_memoryview_thread_locks_used):
  *                 if __pyx_memoryview_thread_locks[i] is self.lock:             # <<<<<<<<<<<<<<
  *                     __pyx_memoryview_thread_locks_used -= 1
  *                     if i != __pyx_memoryview_thread_locks_used:
  */
       }
     }
     /*else*/ {
 
-      /* "View.MemoryView":387
+      /* "View.MemoryView":393
  *                     break
  *             else:
  *                 PyThread_free_lock(self.lock)             # <<<<<<<<<<<<<<
  * 
  *     cdef char *get_item_pointer(memoryview self, object index) except NULL:
  */
       PyThread_free_lock(__pyx_v_self->lock);
     }
     __pyx_L6_break:;
 
-    /* "View.MemoryView":378
+    /* "View.MemoryView":384
  *         cdef int i
  *         global __pyx_memoryview_thread_locks_used
  *         if self.lock != NULL:             # <<<<<<<<<<<<<<
  *             for i in range(__pyx_memoryview_thread_locks_used):
  *                 if __pyx_memoryview_thread_locks[i] is self.lock:
  */
   }
 
-  /* "View.MemoryView":372
+  /* "View.MemoryView":374
  *         self.typeinfo = NULL
  * 
  *     def __dealloc__(memoryview self):             # <<<<<<<<<<<<<<
  *         if self.obj is not None:
  *             __Pyx_ReleaseBuffer(&self.view)
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
 }
 
-/* "View.MemoryView":389
+/* "View.MemoryView":395
  *                 PyThread_free_lock(self.lock)
  * 
  *     cdef char *get_item_pointer(memoryview self, object index) except NULL:             # <<<<<<<<<<<<<<
  *         cdef Py_ssize_t dim
  *         cdef char *itemp = <char *> self.view.buf
  */
 
@@ -22035,109 +23745,112 @@
   Py_ssize_t __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   Py_ssize_t __pyx_t_3;
   PyObject *(*__pyx_t_4)(PyObject *);
   PyObject *__pyx_t_5 = NULL;
   Py_ssize_t __pyx_t_6;
   char *__pyx_t_7;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("get_item_pointer", 0);
 
-  /* "View.MemoryView":391
+  /* "View.MemoryView":397
  *     cdef char *get_item_pointer(memoryview self, object index) except NULL:
  *         cdef Py_ssize_t dim
  *         cdef char *itemp = <char *> self.view.buf             # <<<<<<<<<<<<<<
  * 
  *         for dim, idx in enumerate(index):
  */
   __pyx_v_itemp = ((char *)__pyx_v_self->view.buf);
 
-  /* "View.MemoryView":393
+  /* "View.MemoryView":399
  *         cdef char *itemp = <char *> self.view.buf
  * 
  *         for dim, idx in enumerate(index):             # <<<<<<<<<<<<<<
  *             itemp = pybuffer_index(&self.view, itemp, idx, dim)
  * 
  */
   __pyx_t_1 = 0;
   if (likely(PyList_CheckExact(__pyx_v_index)) || PyTuple_CheckExact(__pyx_v_index)) {
     __pyx_t_2 = __pyx_v_index; __Pyx_INCREF(__pyx_t_2); __pyx_t_3 = 0;
     __pyx_t_4 = NULL;
   } else {
-    __pyx_t_3 = -1; __pyx_t_2 = PyObject_GetIter(__pyx_v_index); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 393, __pyx_L1_error)
+    __pyx_t_3 = -1; __pyx_t_2 = PyObject_GetIter(__pyx_v_index); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 399, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_4 = Py_TYPE(__pyx_t_2)->tp_iternext; if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 393, __pyx_L1_error)
+    __pyx_t_4 = Py_TYPE(__pyx_t_2)->tp_iternext; if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 399, __pyx_L1_error)
   }
   for (;;) {
     if (likely(!__pyx_t_4)) {
       if (likely(PyList_CheckExact(__pyx_t_2))) {
         if (__pyx_t_3 >= PyList_GET_SIZE(__pyx_t_2)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_5 = PyList_GET_ITEM(__pyx_t_2, __pyx_t_3); __Pyx_INCREF(__pyx_t_5); __pyx_t_3++; if (unlikely(0 < 0)) __PYX_ERR(1, 393, __pyx_L1_error)
+        __pyx_t_5 = PyList_GET_ITEM(__pyx_t_2, __pyx_t_3); __Pyx_INCREF(__pyx_t_5); __pyx_t_3++; if (unlikely(0 < 0)) __PYX_ERR(1, 399, __pyx_L1_error)
         #else
-        __pyx_t_5 = PySequence_ITEM(__pyx_t_2, __pyx_t_3); __pyx_t_3++; if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 393, __pyx_L1_error)
+        __pyx_t_5 = PySequence_ITEM(__pyx_t_2, __pyx_t_3); __pyx_t_3++; if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 399, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         #endif
       } else {
         if (__pyx_t_3 >= PyTuple_GET_SIZE(__pyx_t_2)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_2, __pyx_t_3); __Pyx_INCREF(__pyx_t_5); __pyx_t_3++; if (unlikely(0 < 0)) __PYX_ERR(1, 393, __pyx_L1_error)
+        __pyx_t_5 = PyTuple_GET_ITEM(__pyx_t_2, __pyx_t_3); __Pyx_INCREF(__pyx_t_5); __pyx_t_3++; if (unlikely(0 < 0)) __PYX_ERR(1, 399, __pyx_L1_error)
         #else
-        __pyx_t_5 = PySequence_ITEM(__pyx_t_2, __pyx_t_3); __pyx_t_3++; if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 393, __pyx_L1_error)
+        __pyx_t_5 = PySequence_ITEM(__pyx_t_2, __pyx_t_3); __pyx_t_3++; if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 399, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_5);
         #endif
       }
     } else {
       __pyx_t_5 = __pyx_t_4(__pyx_t_2);
       if (unlikely(!__pyx_t_5)) {
         PyObject* exc_type = PyErr_Occurred();
         if (exc_type) {
           if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-          else __PYX_ERR(1, 393, __pyx_L1_error)
+          else __PYX_ERR(1, 399, __pyx_L1_error)
         }
         break;
       }
       __Pyx_GOTREF(__pyx_t_5);
     }
     __Pyx_XDECREF_SET(__pyx_v_idx, __pyx_t_5);
     __pyx_t_5 = 0;
     __pyx_v_dim = __pyx_t_1;
     __pyx_t_1 = (__pyx_t_1 + 1);
 
-    /* "View.MemoryView":394
+    /* "View.MemoryView":400
  * 
  *         for dim, idx in enumerate(index):
  *             itemp = pybuffer_index(&self.view, itemp, idx, dim)             # <<<<<<<<<<<<<<
  * 
  *         return itemp
  */
-    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_v_idx); if (unlikely((__pyx_t_6 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 394, __pyx_L1_error)
-    __pyx_t_7 = __pyx_pybuffer_index((&__pyx_v_self->view), __pyx_v_itemp, __pyx_t_6, __pyx_v_dim); if (unlikely(__pyx_t_7 == ((char *)NULL))) __PYX_ERR(1, 394, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyIndex_AsSsize_t(__pyx_v_idx); if (unlikely((__pyx_t_6 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 400, __pyx_L1_error)
+    __pyx_t_7 = __pyx_pybuffer_index((&__pyx_v_self->view), __pyx_v_itemp, __pyx_t_6, __pyx_v_dim); if (unlikely(__pyx_t_7 == ((char *)NULL))) __PYX_ERR(1, 400, __pyx_L1_error)
     __pyx_v_itemp = __pyx_t_7;
 
-    /* "View.MemoryView":393
+    /* "View.MemoryView":399
  *         cdef char *itemp = <char *> self.view.buf
  * 
  *         for dim, idx in enumerate(index):             # <<<<<<<<<<<<<<
  *             itemp = pybuffer_index(&self.view, itemp, idx, dim)
  * 
  */
   }
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "View.MemoryView":396
+  /* "View.MemoryView":402
  *             itemp = pybuffer_index(&self.view, itemp, idx, dim)
  * 
  *         return itemp             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = __pyx_v_itemp;
   goto __pyx_L0;
 
-  /* "View.MemoryView":389
+  /* "View.MemoryView":395
  *                 PyThread_free_lock(self.lock)
  * 
  *     cdef char *get_item_pointer(memoryview self, object index) except NULL:             # <<<<<<<<<<<<<<
  *         cdef Py_ssize_t dim
  *         cdef char *itemp = <char *> self.view.buf
  */
 
@@ -22149,15 +23862,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v_idx);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":399
+/* "View.MemoryView":405
  * 
  * 
  *     def __getitem__(memoryview self, object index):             # <<<<<<<<<<<<<<
  *         if index is Ellipsis:
  *             return self
  */
 
@@ -22182,145 +23895,148 @@
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
   char *__pyx_t_6;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__getitem__", 0);
 
-  /* "View.MemoryView":400
+  /* "View.MemoryView":406
  * 
  *     def __getitem__(memoryview self, object index):
  *         if index is Ellipsis:             # <<<<<<<<<<<<<<
  *             return self
  * 
  */
   __pyx_t_1 = (__pyx_v_index == __pyx_builtin_Ellipsis);
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":401
+    /* "View.MemoryView":407
  *     def __getitem__(memoryview self, object index):
  *         if index is Ellipsis:
  *             return self             # <<<<<<<<<<<<<<
  * 
  *         have_slices, indices = _unellipsify(index, self.view.ndim)
  */
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(((PyObject *)__pyx_v_self));
     __pyx_r = ((PyObject *)__pyx_v_self);
     goto __pyx_L0;
 
-    /* "View.MemoryView":400
+    /* "View.MemoryView":406
  * 
  *     def __getitem__(memoryview self, object index):
  *         if index is Ellipsis:             # <<<<<<<<<<<<<<
  *             return self
  * 
  */
   }
 
-  /* "View.MemoryView":403
+  /* "View.MemoryView":409
  *             return self
  * 
  *         have_slices, indices = _unellipsify(index, self.view.ndim)             # <<<<<<<<<<<<<<
  * 
  *         cdef char *itemp
  */
-  __pyx_t_3 = _unellipsify(__pyx_v_index, __pyx_v_self->view.ndim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 403, __pyx_L1_error)
+  __pyx_t_3 = _unellipsify(__pyx_v_index, __pyx_v_self->view.ndim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 409, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   if (likely(__pyx_t_3 != Py_None)) {
     PyObject* sequence = __pyx_t_3;
     Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
     if (unlikely(size != 2)) {
       if (size > 2) __Pyx_RaiseTooManyValuesError(2);
       else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-      __PYX_ERR(1, 403, __pyx_L1_error)
+      __PYX_ERR(1, 409, __pyx_L1_error)
     }
     #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
     __pyx_t_4 = PyTuple_GET_ITEM(sequence, 0); 
     __pyx_t_5 = PyTuple_GET_ITEM(sequence, 1); 
     __Pyx_INCREF(__pyx_t_4);
     __Pyx_INCREF(__pyx_t_5);
     #else
-    __pyx_t_4 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 403, __pyx_L1_error)
+    __pyx_t_4 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 409, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_5 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 403, __pyx_L1_error)
+    __pyx_t_5 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 409, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     #endif
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   } else {
-    __Pyx_RaiseNoneNotIterableError(); __PYX_ERR(1, 403, __pyx_L1_error)
+    __Pyx_RaiseNoneNotIterableError(); __PYX_ERR(1, 409, __pyx_L1_error)
   }
   __pyx_v_have_slices = __pyx_t_4;
   __pyx_t_4 = 0;
   __pyx_v_indices = __pyx_t_5;
   __pyx_t_5 = 0;
 
-  /* "View.MemoryView":406
+  /* "View.MemoryView":412
  * 
  *         cdef char *itemp
  *         if have_slices:             # <<<<<<<<<<<<<<
  *             return memview_slice(self, indices)
  *         else:
  */
-  __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_v_have_slices); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(1, 406, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_v_have_slices); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(1, 412, __pyx_L1_error)
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":407
+    /* "View.MemoryView":413
  *         cdef char *itemp
  *         if have_slices:
  *             return memview_slice(self, indices)             # <<<<<<<<<<<<<<
  *         else:
  *             itemp = self.get_item_pointer(indices)
  */
     __Pyx_XDECREF(__pyx_r);
-    __pyx_t_3 = ((PyObject *)__pyx_memview_slice(__pyx_v_self, __pyx_v_indices)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 407, __pyx_L1_error)
+    __pyx_t_3 = ((PyObject *)__pyx_memview_slice(__pyx_v_self, __pyx_v_indices)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 413, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __pyx_r = __pyx_t_3;
     __pyx_t_3 = 0;
     goto __pyx_L0;
 
-    /* "View.MemoryView":406
+    /* "View.MemoryView":412
  * 
  *         cdef char *itemp
  *         if have_slices:             # <<<<<<<<<<<<<<
  *             return memview_slice(self, indices)
  *         else:
  */
   }
 
-  /* "View.MemoryView":409
+  /* "View.MemoryView":415
  *             return memview_slice(self, indices)
  *         else:
  *             itemp = self.get_item_pointer(indices)             # <<<<<<<<<<<<<<
  *             return self.convert_item_to_object(itemp)
  * 
  */
   /*else*/ {
-    __pyx_t_6 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->get_item_pointer(__pyx_v_self, __pyx_v_indices); if (unlikely(__pyx_t_6 == ((char *)NULL))) __PYX_ERR(1, 409, __pyx_L1_error)
+    __pyx_t_6 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->get_item_pointer(__pyx_v_self, __pyx_v_indices); if (unlikely(__pyx_t_6 == ((char *)NULL))) __PYX_ERR(1, 415, __pyx_L1_error)
     __pyx_v_itemp = __pyx_t_6;
 
-    /* "View.MemoryView":410
+    /* "View.MemoryView":416
  *         else:
  *             itemp = self.get_item_pointer(indices)
  *             return self.convert_item_to_object(itemp)             # <<<<<<<<<<<<<<
  * 
  *     def __setitem__(memoryview self, object index, object value):
  */
     __Pyx_XDECREF(__pyx_r);
-    __pyx_t_3 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->convert_item_to_object(__pyx_v_self, __pyx_v_itemp); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 410, __pyx_L1_error)
+    __pyx_t_3 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->convert_item_to_object(__pyx_v_self, __pyx_v_itemp); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 416, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __pyx_r = __pyx_t_3;
     __pyx_t_3 = 0;
     goto __pyx_L0;
   }
 
-  /* "View.MemoryView":399
+  /* "View.MemoryView":405
  * 
  * 
  *     def __getitem__(memoryview self, object index):             # <<<<<<<<<<<<<<
  *         if index is Ellipsis:
  *             return self
  */
 
@@ -22335,15 +24051,15 @@
   __Pyx_XDECREF(__pyx_v_have_slices);
   __Pyx_XDECREF(__pyx_v_indices);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":412
+/* "View.MemoryView":418
  *             return self.convert_item_to_object(itemp)
  * 
  *     def __setitem__(memoryview self, object index, object value):             # <<<<<<<<<<<<<<
  *         if self.view.readonly:
  *             raise TypeError("Cannot assign to read-only memoryview")
  */
 
@@ -22365,185 +24081,188 @@
   PyObject *__pyx_v_obj = NULL;
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setitem__", 0);
   __Pyx_INCREF(__pyx_v_index);
 
-  /* "View.MemoryView":413
+  /* "View.MemoryView":419
  * 
  *     def __setitem__(memoryview self, object index, object value):
  *         if self.view.readonly:             # <<<<<<<<<<<<<<
  *             raise TypeError("Cannot assign to read-only memoryview")
  * 
  */
   __pyx_t_1 = (__pyx_v_self->view.readonly != 0);
   if (unlikely(__pyx_t_1)) {
 
-    /* "View.MemoryView":414
+    /* "View.MemoryView":420
  *     def __setitem__(memoryview self, object index, object value):
  *         if self.view.readonly:
  *             raise TypeError("Cannot assign to read-only memoryview")             # <<<<<<<<<<<<<<
  * 
  *         have_slices, index = _unellipsify(index, self.view.ndim)
  */
-    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__20, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 414, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_TypeError, __pyx_tuple__20, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 420, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_Raise(__pyx_t_2, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __PYX_ERR(1, 414, __pyx_L1_error)
+    __PYX_ERR(1, 420, __pyx_L1_error)
 
-    /* "View.MemoryView":413
+    /* "View.MemoryView":419
  * 
  *     def __setitem__(memoryview self, object index, object value):
  *         if self.view.readonly:             # <<<<<<<<<<<<<<
  *             raise TypeError("Cannot assign to read-only memoryview")
  * 
  */
   }
 
-  /* "View.MemoryView":416
+  /* "View.MemoryView":422
  *             raise TypeError("Cannot assign to read-only memoryview")
  * 
  *         have_slices, index = _unellipsify(index, self.view.ndim)             # <<<<<<<<<<<<<<
  * 
  *         if have_slices:
  */
-  __pyx_t_2 = _unellipsify(__pyx_v_index, __pyx_v_self->view.ndim); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 416, __pyx_L1_error)
+  __pyx_t_2 = _unellipsify(__pyx_v_index, __pyx_v_self->view.ndim); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 422, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (likely(__pyx_t_2 != Py_None)) {
     PyObject* sequence = __pyx_t_2;
     Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
     if (unlikely(size != 2)) {
       if (size > 2) __Pyx_RaiseTooManyValuesError(2);
       else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-      __PYX_ERR(1, 416, __pyx_L1_error)
+      __PYX_ERR(1, 422, __pyx_L1_error)
     }
     #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
     __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
     __pyx_t_4 = PyTuple_GET_ITEM(sequence, 1); 
     __Pyx_INCREF(__pyx_t_3);
     __Pyx_INCREF(__pyx_t_4);
     #else
-    __pyx_t_3 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 416, __pyx_L1_error)
+    __pyx_t_3 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 422, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 416, __pyx_L1_error)
+    __pyx_t_4 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 422, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     #endif
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   } else {
-    __Pyx_RaiseNoneNotIterableError(); __PYX_ERR(1, 416, __pyx_L1_error)
+    __Pyx_RaiseNoneNotIterableError(); __PYX_ERR(1, 422, __pyx_L1_error)
   }
   __pyx_v_have_slices = __pyx_t_3;
   __pyx_t_3 = 0;
   __Pyx_DECREF_SET(__pyx_v_index, __pyx_t_4);
   __pyx_t_4 = 0;
 
-  /* "View.MemoryView":418
+  /* "View.MemoryView":424
  *         have_slices, index = _unellipsify(index, self.view.ndim)
  * 
  *         if have_slices:             # <<<<<<<<<<<<<<
  *             obj = self.is_slice(value)
  *             if obj:
  */
-  __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_have_slices); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 418, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_have_slices); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 424, __pyx_L1_error)
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":419
+    /* "View.MemoryView":425
  * 
  *         if have_slices:
  *             obj = self.is_slice(value)             # <<<<<<<<<<<<<<
  *             if obj:
  *                 self.setitem_slice_assignment(self[index], obj)
  */
-    __pyx_t_2 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->is_slice(__pyx_v_self, __pyx_v_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 419, __pyx_L1_error)
+    __pyx_t_2 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->is_slice(__pyx_v_self, __pyx_v_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 425, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __pyx_v_obj = __pyx_t_2;
     __pyx_t_2 = 0;
 
-    /* "View.MemoryView":420
+    /* "View.MemoryView":426
  *         if have_slices:
  *             obj = self.is_slice(value)
  *             if obj:             # <<<<<<<<<<<<<<
  *                 self.setitem_slice_assignment(self[index], obj)
  *             else:
  */
-    __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_obj); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 420, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_v_obj); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 426, __pyx_L1_error)
     if (__pyx_t_1) {
 
-      /* "View.MemoryView":421
+      /* "View.MemoryView":427
  *             obj = self.is_slice(value)
  *             if obj:
  *                 self.setitem_slice_assignment(self[index], obj)             # <<<<<<<<<<<<<<
  *             else:
  *                 self.setitem_slice_assign_scalar(self[index], value)
  */
-      __pyx_t_2 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_self), __pyx_v_index); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 421, __pyx_L1_error)
+      __pyx_t_2 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_self), __pyx_v_index); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 427, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
-      __pyx_t_4 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->setitem_slice_assignment(__pyx_v_self, __pyx_t_2, __pyx_v_obj); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 421, __pyx_L1_error)
+      __pyx_t_4 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->setitem_slice_assignment(__pyx_v_self, __pyx_t_2, __pyx_v_obj); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 427, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-      /* "View.MemoryView":420
+      /* "View.MemoryView":426
  *         if have_slices:
  *             obj = self.is_slice(value)
  *             if obj:             # <<<<<<<<<<<<<<
  *                 self.setitem_slice_assignment(self[index], obj)
  *             else:
  */
       goto __pyx_L5;
     }
 
-    /* "View.MemoryView":423
+    /* "View.MemoryView":429
  *                 self.setitem_slice_assignment(self[index], obj)
  *             else:
  *                 self.setitem_slice_assign_scalar(self[index], value)             # <<<<<<<<<<<<<<
  *         else:
  *             self.setitem_indexed(index, value)
  */
     /*else*/ {
-      __pyx_t_4 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_self), __pyx_v_index); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 423, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_PyObject_GetItem(((PyObject *)__pyx_v_self), __pyx_v_index); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 429, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
-      if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_memoryview_type))))) __PYX_ERR(1, 423, __pyx_L1_error)
-      __pyx_t_2 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->setitem_slice_assign_scalar(__pyx_v_self, ((struct __pyx_memoryview_obj *)__pyx_t_4), __pyx_v_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 423, __pyx_L1_error)
+      if (!(likely(((__pyx_t_4) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_4, __pyx_memoryview_type))))) __PYX_ERR(1, 429, __pyx_L1_error)
+      __pyx_t_2 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->setitem_slice_assign_scalar(__pyx_v_self, ((struct __pyx_memoryview_obj *)__pyx_t_4), __pyx_v_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 429, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_2);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
       __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     }
     __pyx_L5:;
 
-    /* "View.MemoryView":418
+    /* "View.MemoryView":424
  *         have_slices, index = _unellipsify(index, self.view.ndim)
  * 
  *         if have_slices:             # <<<<<<<<<<<<<<
  *             obj = self.is_slice(value)
  *             if obj:
  */
     goto __pyx_L4;
   }
 
-  /* "View.MemoryView":425
+  /* "View.MemoryView":431
  *                 self.setitem_slice_assign_scalar(self[index], value)
  *         else:
  *             self.setitem_indexed(index, value)             # <<<<<<<<<<<<<<
  * 
  *     cdef is_slice(self, obj):
  */
   /*else*/ {
-    __pyx_t_2 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->setitem_indexed(__pyx_v_self, __pyx_v_index, __pyx_v_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 425, __pyx_L1_error)
+    __pyx_t_2 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->setitem_indexed(__pyx_v_self, __pyx_v_index, __pyx_v_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 431, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   }
   __pyx_L4:;
 
-  /* "View.MemoryView":412
+  /* "View.MemoryView":418
  *             return self.convert_item_to_object(itemp)
  * 
  *     def __setitem__(memoryview self, object index, object value):             # <<<<<<<<<<<<<<
  *         if self.view.readonly:
  *             raise TypeError("Cannot assign to read-only memoryview")
  */
 
@@ -22560,15 +24279,15 @@
   __Pyx_XDECREF(__pyx_v_have_slices);
   __Pyx_XDECREF(__pyx_v_obj);
   __Pyx_XDECREF(__pyx_v_index);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":427
+/* "View.MemoryView":433
  *             self.setitem_indexed(index, value)
  * 
  *     cdef is_slice(self, obj):             # <<<<<<<<<<<<<<
  *         if not isinstance(obj, memoryview):
  *             try:
  */
 
@@ -22580,29 +24299,32 @@
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
   PyObject *__pyx_t_6 = NULL;
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_t_9;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("is_slice", 0);
   __Pyx_INCREF(__pyx_v_obj);
 
-  /* "View.MemoryView":428
+  /* "View.MemoryView":434
  * 
  *     cdef is_slice(self, obj):
  *         if not isinstance(obj, memoryview):             # <<<<<<<<<<<<<<
  *             try:
  *                 obj = memoryview(obj, self.flags & ~PyBUF_WRITABLE | PyBUF_ANY_CONTIGUOUS,
  */
   __pyx_t_1 = __Pyx_TypeCheck(__pyx_v_obj, __pyx_memoryview_type); 
   __pyx_t_2 = ((!(__pyx_t_1 != 0)) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":429
+    /* "View.MemoryView":435
  *     cdef is_slice(self, obj):
  *         if not isinstance(obj, memoryview):
  *             try:             # <<<<<<<<<<<<<<
  *                 obj = memoryview(obj, self.flags & ~PyBUF_WRITABLE | PyBUF_ANY_CONTIGUOUS,
  *                                  self.dtype_is_object)
  */
     {
@@ -22610,91 +24332,91 @@
       __Pyx_PyThreadState_assign
       __Pyx_ExceptionSave(&__pyx_t_3, &__pyx_t_4, &__pyx_t_5);
       __Pyx_XGOTREF(__pyx_t_3);
       __Pyx_XGOTREF(__pyx_t_4);
       __Pyx_XGOTREF(__pyx_t_5);
       /*try:*/ {
 
-        /* "View.MemoryView":430
+        /* "View.MemoryView":436
  *         if not isinstance(obj, memoryview):
  *             try:
  *                 obj = memoryview(obj, self.flags & ~PyBUF_WRITABLE | PyBUF_ANY_CONTIGUOUS,             # <<<<<<<<<<<<<<
  *                                  self.dtype_is_object)
  *             except TypeError:
  */
-        __pyx_t_6 = __Pyx_PyInt_From_int(((__pyx_v_self->flags & (~PyBUF_WRITABLE)) | PyBUF_ANY_CONTIGUOUS)); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 430, __pyx_L4_error)
+        __pyx_t_6 = __Pyx_PyInt_From_int(((__pyx_v_self->flags & (~PyBUF_WRITABLE)) | PyBUF_ANY_CONTIGUOUS)); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 436, __pyx_L4_error)
         __Pyx_GOTREF(__pyx_t_6);
 
-        /* "View.MemoryView":431
+        /* "View.MemoryView":437
  *             try:
  *                 obj = memoryview(obj, self.flags & ~PyBUF_WRITABLE | PyBUF_ANY_CONTIGUOUS,
  *                                  self.dtype_is_object)             # <<<<<<<<<<<<<<
  *             except TypeError:
  *                 return None
  */
-        __pyx_t_7 = __Pyx_PyBool_FromLong(__pyx_v_self->dtype_is_object); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 431, __pyx_L4_error)
+        __pyx_t_7 = __Pyx_PyBool_FromLong(__pyx_v_self->dtype_is_object); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 437, __pyx_L4_error)
         __Pyx_GOTREF(__pyx_t_7);
 
-        /* "View.MemoryView":430
+        /* "View.MemoryView":436
  *         if not isinstance(obj, memoryview):
  *             try:
  *                 obj = memoryview(obj, self.flags & ~PyBUF_WRITABLE | PyBUF_ANY_CONTIGUOUS,             # <<<<<<<<<<<<<<
  *                                  self.dtype_is_object)
  *             except TypeError:
  */
-        __pyx_t_8 = PyTuple_New(3); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 430, __pyx_L4_error)
+        __pyx_t_8 = PyTuple_New(3); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 436, __pyx_L4_error)
         __Pyx_GOTREF(__pyx_t_8);
         __Pyx_INCREF(__pyx_v_obj);
         __Pyx_GIVEREF(__pyx_v_obj);
         PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_v_obj);
         __Pyx_GIVEREF(__pyx_t_6);
         PyTuple_SET_ITEM(__pyx_t_8, 1, __pyx_t_6);
         __Pyx_GIVEREF(__pyx_t_7);
         PyTuple_SET_ITEM(__pyx_t_8, 2, __pyx_t_7);
         __pyx_t_6 = 0;
         __pyx_t_7 = 0;
-        __pyx_t_7 = __Pyx_PyObject_Call(((PyObject *)__pyx_memoryview_type), __pyx_t_8, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 430, __pyx_L4_error)
+        __pyx_t_7 = __Pyx_PyObject_Call(((PyObject *)__pyx_memoryview_type), __pyx_t_8, NULL); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 436, __pyx_L4_error)
         __Pyx_GOTREF(__pyx_t_7);
         __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
         __Pyx_DECREF_SET(__pyx_v_obj, __pyx_t_7);
         __pyx_t_7 = 0;
 
-        /* "View.MemoryView":429
+        /* "View.MemoryView":435
  *     cdef is_slice(self, obj):
  *         if not isinstance(obj, memoryview):
  *             try:             # <<<<<<<<<<<<<<
  *                 obj = memoryview(obj, self.flags & ~PyBUF_WRITABLE | PyBUF_ANY_CONTIGUOUS,
  *                                  self.dtype_is_object)
  */
       }
       __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
       __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
       __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
       goto __pyx_L9_try_end;
       __pyx_L4_error:;
       __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
       __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+      __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
 
-      /* "View.MemoryView":432
+      /* "View.MemoryView":438
  *                 obj = memoryview(obj, self.flags & ~PyBUF_WRITABLE | PyBUF_ANY_CONTIGUOUS,
  *                                  self.dtype_is_object)
  *             except TypeError:             # <<<<<<<<<<<<<<
  *                 return None
  * 
  */
       __pyx_t_9 = __Pyx_PyErr_ExceptionMatches(__pyx_builtin_TypeError);
       if (__pyx_t_9) {
         __Pyx_AddTraceback("View.MemoryView.memoryview.is_slice", __pyx_clineno, __pyx_lineno, __pyx_filename);
-        if (__Pyx_GetException(&__pyx_t_7, &__pyx_t_8, &__pyx_t_6) < 0) __PYX_ERR(1, 432, __pyx_L6_except_error)
+        if (__Pyx_GetException(&__pyx_t_7, &__pyx_t_8, &__pyx_t_6) < 0) __PYX_ERR(1, 438, __pyx_L6_except_error)
         __Pyx_GOTREF(__pyx_t_7);
         __Pyx_GOTREF(__pyx_t_8);
         __Pyx_GOTREF(__pyx_t_6);
 
-        /* "View.MemoryView":433
+        /* "View.MemoryView":439
  *                                  self.dtype_is_object)
  *             except TypeError:
  *                 return None             # <<<<<<<<<<<<<<
  * 
  *         return obj
  */
         __Pyx_XDECREF(__pyx_r);
@@ -22703,15 +24425,15 @@
         __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
         __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
         goto __pyx_L7_except_return;
       }
       goto __pyx_L6_except_error;
       __pyx_L6_except_error:;
 
-      /* "View.MemoryView":429
+      /* "View.MemoryView":435
  *     cdef is_slice(self, obj):
  *         if not isinstance(obj, memoryview):
  *             try:             # <<<<<<<<<<<<<<
  *                 obj = memoryview(obj, self.flags & ~PyBUF_WRITABLE | PyBUF_ANY_CONTIGUOUS,
  *                                  self.dtype_is_object)
  */
       __Pyx_XGIVEREF(__pyx_t_3);
@@ -22724,36 +24446,36 @@
       __Pyx_XGIVEREF(__pyx_t_4);
       __Pyx_XGIVEREF(__pyx_t_5);
       __Pyx_ExceptionReset(__pyx_t_3, __pyx_t_4, __pyx_t_5);
       goto __pyx_L0;
       __pyx_L9_try_end:;
     }
 
-    /* "View.MemoryView":428
+    /* "View.MemoryView":434
  * 
  *     cdef is_slice(self, obj):
  *         if not isinstance(obj, memoryview):             # <<<<<<<<<<<<<<
  *             try:
  *                 obj = memoryview(obj, self.flags & ~PyBUF_WRITABLE | PyBUF_ANY_CONTIGUOUS,
  */
   }
 
-  /* "View.MemoryView":435
+  /* "View.MemoryView":441
  *                 return None
  * 
  *         return obj             # <<<<<<<<<<<<<<
  * 
  *     cdef setitem_slice_assignment(self, dst, src):
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(__pyx_v_obj);
   __pyx_r = __pyx_v_obj;
   goto __pyx_L0;
 
-  /* "View.MemoryView":427
+  /* "View.MemoryView":433
  *             self.setitem_indexed(index, value)
  * 
  *     cdef is_slice(self, obj):             # <<<<<<<<<<<<<<
  *         if not isinstance(obj, memoryview):
  *             try:
  */
 
@@ -22767,98 +24489,105 @@
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v_obj);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":437
+/* "View.MemoryView":443
  *         return obj
  * 
  *     cdef setitem_slice_assignment(self, dst, src):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice dst_slice
  *         cdef __Pyx_memviewslice src_slice
  */
 
 static PyObject *__pyx_memoryview_setitem_slice_assignment(struct __pyx_memoryview_obj *__pyx_v_self, PyObject *__pyx_v_dst, PyObject *__pyx_v_src) {
   __Pyx_memviewslice __pyx_v_dst_slice;
   __Pyx_memviewslice __pyx_v_src_slice;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  int __pyx_t_2;
-  int __pyx_t_3;
+  __Pyx_memviewslice *__pyx_t_1;
+  __Pyx_memviewslice *__pyx_t_2;
+  PyObject *__pyx_t_3 = NULL;
   int __pyx_t_4;
+  int __pyx_t_5;
+  int __pyx_t_6;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("setitem_slice_assignment", 0);
 
-  /* "View.MemoryView":441
+  /* "View.MemoryView":447
  *         cdef __Pyx_memviewslice src_slice
  * 
  *         memoryview_copy_contents(get_slice_from_memview(src, &src_slice)[0],             # <<<<<<<<<<<<<<
  *                                  get_slice_from_memview(dst, &dst_slice)[0],
  *                                  src.ndim, dst.ndim, self.dtype_is_object)
  */
-  if (!(likely(((__pyx_v_src) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_src, __pyx_memoryview_type))))) __PYX_ERR(1, 441, __pyx_L1_error)
+  if (!(likely(((__pyx_v_src) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_src, __pyx_memoryview_type))))) __PYX_ERR(1, 447, __pyx_L1_error)
+  __pyx_t_1 = __pyx_memoryview_get_slice_from_memoryview(((struct __pyx_memoryview_obj *)__pyx_v_src), (&__pyx_v_src_slice)); if (unlikely(__pyx_t_1 == ((__Pyx_memviewslice *)NULL))) __PYX_ERR(1, 447, __pyx_L1_error)
 
-  /* "View.MemoryView":442
+  /* "View.MemoryView":448
  * 
  *         memoryview_copy_contents(get_slice_from_memview(src, &src_slice)[0],
  *                                  get_slice_from_memview(dst, &dst_slice)[0],             # <<<<<<<<<<<<<<
  *                                  src.ndim, dst.ndim, self.dtype_is_object)
  * 
  */
-  if (!(likely(((__pyx_v_dst) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_dst, __pyx_memoryview_type))))) __PYX_ERR(1, 442, __pyx_L1_error)
+  if (!(likely(((__pyx_v_dst) == Py_None) || likely(__Pyx_TypeTest(__pyx_v_dst, __pyx_memoryview_type))))) __PYX_ERR(1, 448, __pyx_L1_error)
+  __pyx_t_2 = __pyx_memoryview_get_slice_from_memoryview(((struct __pyx_memoryview_obj *)__pyx_v_dst), (&__pyx_v_dst_slice)); if (unlikely(__pyx_t_2 == ((__Pyx_memviewslice *)NULL))) __PYX_ERR(1, 448, __pyx_L1_error)
 
-  /* "View.MemoryView":443
+  /* "View.MemoryView":449
  *         memoryview_copy_contents(get_slice_from_memview(src, &src_slice)[0],
  *                                  get_slice_from_memview(dst, &dst_slice)[0],
  *                                  src.ndim, dst.ndim, self.dtype_is_object)             # <<<<<<<<<<<<<<
  * 
  *     cdef setitem_slice_assign_scalar(self, memoryview dst, value):
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_src, __pyx_n_s_ndim); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 443, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_2 == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 443, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_dst, __pyx_n_s_ndim); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 443, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_3 == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 443, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_src, __pyx_n_s_ndim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 449, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_4 = __Pyx_PyInt_As_int(__pyx_t_3); if (unlikely((__pyx_t_4 == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 449, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_dst, __pyx_n_s_ndim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 449, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_5 = __Pyx_PyInt_As_int(__pyx_t_3); if (unlikely((__pyx_t_5 == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 449, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "View.MemoryView":441
+  /* "View.MemoryView":447
  *         cdef __Pyx_memviewslice src_slice
  * 
  *         memoryview_copy_contents(get_slice_from_memview(src, &src_slice)[0],             # <<<<<<<<<<<<<<
  *                                  get_slice_from_memview(dst, &dst_slice)[0],
  *                                  src.ndim, dst.ndim, self.dtype_is_object)
  */
-  __pyx_t_4 = __pyx_memoryview_copy_contents((__pyx_memoryview_get_slice_from_memoryview(((struct __pyx_memoryview_obj *)__pyx_v_src), (&__pyx_v_src_slice))[0]), (__pyx_memoryview_get_slice_from_memoryview(((struct __pyx_memoryview_obj *)__pyx_v_dst), (&__pyx_v_dst_slice))[0]), __pyx_t_2, __pyx_t_3, __pyx_v_self->dtype_is_object); if (unlikely(__pyx_t_4 == ((int)-1))) __PYX_ERR(1, 441, __pyx_L1_error)
+  __pyx_t_6 = __pyx_memoryview_copy_contents((__pyx_t_1[0]), (__pyx_t_2[0]), __pyx_t_4, __pyx_t_5, __pyx_v_self->dtype_is_object); if (unlikely(__pyx_t_6 == ((int)-1))) __PYX_ERR(1, 447, __pyx_L1_error)
 
-  /* "View.MemoryView":437
+  /* "View.MemoryView":443
  *         return obj
  * 
  *     cdef setitem_slice_assignment(self, dst, src):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice dst_slice
  *         cdef __Pyx_memviewslice src_slice
  */
 
   /* function exit code */
   __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_3);
   __Pyx_AddTraceback("View.MemoryView.memoryview.setitem_slice_assignment", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":445
+/* "View.MemoryView":451
  *                                  src.ndim, dst.ndim, self.dtype_is_object)
  * 
  *     cdef setitem_slice_assign_scalar(self, memoryview dst, value):             # <<<<<<<<<<<<<<
  *         cdef int array[128]
  *         cdef void *tmp = NULL
  */
 
@@ -22866,216 +24595,221 @@
   int __pyx_v_array[0x80];
   void *__pyx_v_tmp;
   void *__pyx_v_item;
   __Pyx_memviewslice *__pyx_v_dst_slice;
   __Pyx_memviewslice __pyx_v_tmp_slice;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  int __pyx_t_3;
+  __Pyx_memviewslice *__pyx_t_1;
+  int __pyx_t_2;
+  PyObject *__pyx_t_3 = NULL;
   int __pyx_t_4;
-  char const *__pyx_t_5;
-  PyObject *__pyx_t_6 = NULL;
+  int __pyx_t_5;
+  char const *__pyx_t_6;
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   PyObject *__pyx_t_9 = NULL;
   PyObject *__pyx_t_10 = NULL;
   PyObject *__pyx_t_11 = NULL;
+  PyObject *__pyx_t_12 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("setitem_slice_assign_scalar", 0);
 
-  /* "View.MemoryView":447
+  /* "View.MemoryView":453
  *     cdef setitem_slice_assign_scalar(self, memoryview dst, value):
  *         cdef int array[128]
  *         cdef void *tmp = NULL             # <<<<<<<<<<<<<<
  *         cdef void *item
  * 
  */
   __pyx_v_tmp = NULL;
 
-  /* "View.MemoryView":452
+  /* "View.MemoryView":458
  *         cdef __Pyx_memviewslice *dst_slice
  *         cdef __Pyx_memviewslice tmp_slice
  *         dst_slice = get_slice_from_memview(dst, &tmp_slice)             # <<<<<<<<<<<<<<
  * 
  *         if <size_t>self.view.itemsize > sizeof(array):
  */
-  __pyx_v_dst_slice = __pyx_memoryview_get_slice_from_memoryview(__pyx_v_dst, (&__pyx_v_tmp_slice));
+  __pyx_t_1 = __pyx_memoryview_get_slice_from_memoryview(__pyx_v_dst, (&__pyx_v_tmp_slice)); if (unlikely(__pyx_t_1 == ((__Pyx_memviewslice *)NULL))) __PYX_ERR(1, 458, __pyx_L1_error)
+  __pyx_v_dst_slice = __pyx_t_1;
 
-  /* "View.MemoryView":454
+  /* "View.MemoryView":460
  *         dst_slice = get_slice_from_memview(dst, &tmp_slice)
  * 
  *         if <size_t>self.view.itemsize > sizeof(array):             # <<<<<<<<<<<<<<
  *             tmp = PyMem_Malloc(self.view.itemsize)
  *             if tmp == NULL:
  */
-  __pyx_t_1 = ((((size_t)__pyx_v_self->view.itemsize) > (sizeof(__pyx_v_array))) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_2 = ((((size_t)__pyx_v_self->view.itemsize) > (sizeof(__pyx_v_array))) != 0);
+  if (__pyx_t_2) {
 
-    /* "View.MemoryView":455
+    /* "View.MemoryView":461
  * 
  *         if <size_t>self.view.itemsize > sizeof(array):
  *             tmp = PyMem_Malloc(self.view.itemsize)             # <<<<<<<<<<<<<<
  *             if tmp == NULL:
  *                 raise MemoryError
  */
     __pyx_v_tmp = PyMem_Malloc(__pyx_v_self->view.itemsize);
 
-    /* "View.MemoryView":456
+    /* "View.MemoryView":462
  *         if <size_t>self.view.itemsize > sizeof(array):
  *             tmp = PyMem_Malloc(self.view.itemsize)
  *             if tmp == NULL:             # <<<<<<<<<<<<<<
  *                 raise MemoryError
  *             item = tmp
  */
-    __pyx_t_1 = ((__pyx_v_tmp == NULL) != 0);
-    if (unlikely(__pyx_t_1)) {
+    __pyx_t_2 = ((__pyx_v_tmp == NULL) != 0);
+    if (unlikely(__pyx_t_2)) {
 
-      /* "View.MemoryView":457
+      /* "View.MemoryView":463
  *             tmp = PyMem_Malloc(self.view.itemsize)
  *             if tmp == NULL:
  *                 raise MemoryError             # <<<<<<<<<<<<<<
  *             item = tmp
  *         else:
  */
-      PyErr_NoMemory(); __PYX_ERR(1, 457, __pyx_L1_error)
+      PyErr_NoMemory(); __PYX_ERR(1, 463, __pyx_L1_error)
 
-      /* "View.MemoryView":456
+      /* "View.MemoryView":462
  *         if <size_t>self.view.itemsize > sizeof(array):
  *             tmp = PyMem_Malloc(self.view.itemsize)
  *             if tmp == NULL:             # <<<<<<<<<<<<<<
  *                 raise MemoryError
  *             item = tmp
  */
     }
 
-    /* "View.MemoryView":458
+    /* "View.MemoryView":464
  *             if tmp == NULL:
  *                 raise MemoryError
  *             item = tmp             # <<<<<<<<<<<<<<
  *         else:
  *             item = <void *> array
  */
     __pyx_v_item = __pyx_v_tmp;
 
-    /* "View.MemoryView":454
+    /* "View.MemoryView":460
  *         dst_slice = get_slice_from_memview(dst, &tmp_slice)
  * 
  *         if <size_t>self.view.itemsize > sizeof(array):             # <<<<<<<<<<<<<<
  *             tmp = PyMem_Malloc(self.view.itemsize)
  *             if tmp == NULL:
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":460
+  /* "View.MemoryView":466
  *             item = tmp
  *         else:
  *             item = <void *> array             # <<<<<<<<<<<<<<
  * 
  *         try:
  */
   /*else*/ {
     __pyx_v_item = ((void *)__pyx_v_array);
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":462
+  /* "View.MemoryView":468
  *             item = <void *> array
  * 
  *         try:             # <<<<<<<<<<<<<<
  *             if self.dtype_is_object:
  *                 (<PyObject **> item)[0] = <PyObject *> value
  */
   /*try:*/ {
 
-    /* "View.MemoryView":463
+    /* "View.MemoryView":469
  * 
  *         try:
  *             if self.dtype_is_object:             # <<<<<<<<<<<<<<
  *                 (<PyObject **> item)[0] = <PyObject *> value
  *             else:
  */
-    __pyx_t_1 = (__pyx_v_self->dtype_is_object != 0);
-    if (__pyx_t_1) {
+    __pyx_t_2 = (__pyx_v_self->dtype_is_object != 0);
+    if (__pyx_t_2) {
 
-      /* "View.MemoryView":464
+      /* "View.MemoryView":470
  *         try:
  *             if self.dtype_is_object:
  *                 (<PyObject **> item)[0] = <PyObject *> value             # <<<<<<<<<<<<<<
  *             else:
  *                 self.assign_item_from_object(<char *> item, value)
  */
       (((PyObject **)__pyx_v_item)[0]) = ((PyObject *)__pyx_v_value);
 
-      /* "View.MemoryView":463
+      /* "View.MemoryView":469
  * 
  *         try:
  *             if self.dtype_is_object:             # <<<<<<<<<<<<<<
  *                 (<PyObject **> item)[0] = <PyObject *> value
  *             else:
  */
       goto __pyx_L8;
     }
 
-    /* "View.MemoryView":466
+    /* "View.MemoryView":472
  *                 (<PyObject **> item)[0] = <PyObject *> value
  *             else:
  *                 self.assign_item_from_object(<char *> item, value)             # <<<<<<<<<<<<<<
  * 
  * 
  */
     /*else*/ {
-      __pyx_t_2 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->assign_item_from_object(__pyx_v_self, ((char *)__pyx_v_item), __pyx_v_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 466, __pyx_L6_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_3 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->assign_item_from_object(__pyx_v_self, ((char *)__pyx_v_item), __pyx_v_value); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 472, __pyx_L6_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     }
     __pyx_L8:;
 
-    /* "View.MemoryView":470
+    /* "View.MemoryView":476
  * 
  * 
  *             if self.view.suboffsets != NULL:             # <<<<<<<<<<<<<<
  *                 assert_direct_dimensions(self.view.suboffsets, self.view.ndim)
  *             slice_assign_scalar(dst_slice, dst.view.ndim, self.view.itemsize,
  */
-    __pyx_t_1 = ((__pyx_v_self->view.suboffsets != NULL) != 0);
-    if (__pyx_t_1) {
+    __pyx_t_2 = ((__pyx_v_self->view.suboffsets != NULL) != 0);
+    if (__pyx_t_2) {
 
-      /* "View.MemoryView":471
+      /* "View.MemoryView":477
  * 
  *             if self.view.suboffsets != NULL:
  *                 assert_direct_dimensions(self.view.suboffsets, self.view.ndim)             # <<<<<<<<<<<<<<
  *             slice_assign_scalar(dst_slice, dst.view.ndim, self.view.itemsize,
  *                                 item, self.dtype_is_object)
  */
-      __pyx_t_2 = assert_direct_dimensions(__pyx_v_self->view.suboffsets, __pyx_v_self->view.ndim); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 471, __pyx_L6_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_3 = assert_direct_dimensions(__pyx_v_self->view.suboffsets, __pyx_v_self->view.ndim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 477, __pyx_L6_error)
+      __Pyx_GOTREF(__pyx_t_3);
+      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-      /* "View.MemoryView":470
+      /* "View.MemoryView":476
  * 
  * 
  *             if self.view.suboffsets != NULL:             # <<<<<<<<<<<<<<
  *                 assert_direct_dimensions(self.view.suboffsets, self.view.ndim)
  *             slice_assign_scalar(dst_slice, dst.view.ndim, self.view.itemsize,
  */
     }
 
-    /* "View.MemoryView":472
+    /* "View.MemoryView":478
  *             if self.view.suboffsets != NULL:
  *                 assert_direct_dimensions(self.view.suboffsets, self.view.ndim)
  *             slice_assign_scalar(dst_slice, dst.view.ndim, self.view.itemsize,             # <<<<<<<<<<<<<<
  *                                 item, self.dtype_is_object)
  *         finally:
  */
     __pyx_memoryview_slice_assign_scalar(__pyx_v_dst_slice, __pyx_v_dst->view.ndim, __pyx_v_self->view.itemsize, __pyx_v_item, __pyx_v_self->dtype_is_object);
   }
 
-  /* "View.MemoryView":475
+  /* "View.MemoryView":481
  *                                 item, self.dtype_is_object)
  *         finally:
  *             PyMem_Free(tmp)             # <<<<<<<<<<<<<<
  * 
  *     cdef setitem_indexed(self, index, value):
  */
   /*finally:*/ {
@@ -23083,104 +24817,107 @@
       PyMem_Free(__pyx_v_tmp);
       goto __pyx_L7;
     }
     __pyx_L6_error:;
     /*exception exit:*/{
       __Pyx_PyThreadState_declare
       __Pyx_PyThreadState_assign
-      __pyx_t_6 = 0; __pyx_t_7 = 0; __pyx_t_8 = 0; __pyx_t_9 = 0; __pyx_t_10 = 0; __pyx_t_11 = 0;
-      __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-      if (PY_MAJOR_VERSION >= 3) __Pyx_ExceptionSwap(&__pyx_t_9, &__pyx_t_10, &__pyx_t_11);
-      if ((PY_MAJOR_VERSION < 3) || unlikely(__Pyx_GetException(&__pyx_t_6, &__pyx_t_7, &__pyx_t_8) < 0)) __Pyx_ErrFetch(&__pyx_t_6, &__pyx_t_7, &__pyx_t_8);
-      __Pyx_XGOTREF(__pyx_t_6);
+      __pyx_t_7 = 0; __pyx_t_8 = 0; __pyx_t_9 = 0; __pyx_t_10 = 0; __pyx_t_11 = 0; __pyx_t_12 = 0;
+      __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+      if (PY_MAJOR_VERSION >= 3) __Pyx_ExceptionSwap(&__pyx_t_10, &__pyx_t_11, &__pyx_t_12);
+      if ((PY_MAJOR_VERSION < 3) || unlikely(__Pyx_GetException(&__pyx_t_7, &__pyx_t_8, &__pyx_t_9) < 0)) __Pyx_ErrFetch(&__pyx_t_7, &__pyx_t_8, &__pyx_t_9);
       __Pyx_XGOTREF(__pyx_t_7);
       __Pyx_XGOTREF(__pyx_t_8);
       __Pyx_XGOTREF(__pyx_t_9);
       __Pyx_XGOTREF(__pyx_t_10);
       __Pyx_XGOTREF(__pyx_t_11);
-      __pyx_t_3 = __pyx_lineno; __pyx_t_4 = __pyx_clineno; __pyx_t_5 = __pyx_filename;
+      __Pyx_XGOTREF(__pyx_t_12);
+      __pyx_t_4 = __pyx_lineno; __pyx_t_5 = __pyx_clineno; __pyx_t_6 = __pyx_filename;
       {
         PyMem_Free(__pyx_v_tmp);
       }
       if (PY_MAJOR_VERSION >= 3) {
-        __Pyx_XGIVEREF(__pyx_t_9);
         __Pyx_XGIVEREF(__pyx_t_10);
         __Pyx_XGIVEREF(__pyx_t_11);
-        __Pyx_ExceptionReset(__pyx_t_9, __pyx_t_10, __pyx_t_11);
+        __Pyx_XGIVEREF(__pyx_t_12);
+        __Pyx_ExceptionReset(__pyx_t_10, __pyx_t_11, __pyx_t_12);
       }
-      __Pyx_XGIVEREF(__pyx_t_6);
       __Pyx_XGIVEREF(__pyx_t_7);
       __Pyx_XGIVEREF(__pyx_t_8);
-      __Pyx_ErrRestore(__pyx_t_6, __pyx_t_7, __pyx_t_8);
-      __pyx_t_6 = 0; __pyx_t_7 = 0; __pyx_t_8 = 0; __pyx_t_9 = 0; __pyx_t_10 = 0; __pyx_t_11 = 0;
-      __pyx_lineno = __pyx_t_3; __pyx_clineno = __pyx_t_4; __pyx_filename = __pyx_t_5;
+      __Pyx_XGIVEREF(__pyx_t_9);
+      __Pyx_ErrRestore(__pyx_t_7, __pyx_t_8, __pyx_t_9);
+      __pyx_t_7 = 0; __pyx_t_8 = 0; __pyx_t_9 = 0; __pyx_t_10 = 0; __pyx_t_11 = 0; __pyx_t_12 = 0;
+      __pyx_lineno = __pyx_t_4; __pyx_clineno = __pyx_t_5; __pyx_filename = __pyx_t_6;
       goto __pyx_L1_error;
     }
     __pyx_L7:;
   }
 
-  /* "View.MemoryView":445
+  /* "View.MemoryView":451
  *                                  src.ndim, dst.ndim, self.dtype_is_object)
  * 
  *     cdef setitem_slice_assign_scalar(self, memoryview dst, value):             # <<<<<<<<<<<<<<
  *         cdef int array[128]
  *         cdef void *tmp = NULL
  */
 
   /* function exit code */
   __pyx_r = Py_None; __Pyx_INCREF(Py_None);
   goto __pyx_L0;
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_3);
   __Pyx_AddTraceback("View.MemoryView.memoryview.setitem_slice_assign_scalar", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":477
+/* "View.MemoryView":483
  *             PyMem_Free(tmp)
  * 
  *     cdef setitem_indexed(self, index, value):             # <<<<<<<<<<<<<<
  *         cdef char *itemp = self.get_item_pointer(index)
  *         self.assign_item_from_object(itemp, value)
  */
 
 static PyObject *__pyx_memoryview_setitem_indexed(struct __pyx_memoryview_obj *__pyx_v_self, PyObject *__pyx_v_index, PyObject *__pyx_v_value) {
   char *__pyx_v_itemp;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   char *__pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("setitem_indexed", 0);
 
-  /* "View.MemoryView":478
+  /* "View.MemoryView":484
  * 
  *     cdef setitem_indexed(self, index, value):
  *         cdef char *itemp = self.get_item_pointer(index)             # <<<<<<<<<<<<<<
  *         self.assign_item_from_object(itemp, value)
  * 
  */
-  __pyx_t_1 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->get_item_pointer(__pyx_v_self, __pyx_v_index); if (unlikely(__pyx_t_1 == ((char *)NULL))) __PYX_ERR(1, 478, __pyx_L1_error)
+  __pyx_t_1 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->get_item_pointer(__pyx_v_self, __pyx_v_index); if (unlikely(__pyx_t_1 == ((char *)NULL))) __PYX_ERR(1, 484, __pyx_L1_error)
   __pyx_v_itemp = __pyx_t_1;
 
-  /* "View.MemoryView":479
+  /* "View.MemoryView":485
  *     cdef setitem_indexed(self, index, value):
  *         cdef char *itemp = self.get_item_pointer(index)
  *         self.assign_item_from_object(itemp, value)             # <<<<<<<<<<<<<<
  * 
  *     cdef convert_item_to_object(self, char *itemp):
  */
-  __pyx_t_2 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->assign_item_from_object(__pyx_v_self, __pyx_v_itemp, __pyx_v_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 479, __pyx_L1_error)
+  __pyx_t_2 = ((struct __pyx_vtabstruct_memoryview *)__pyx_v_self->__pyx_vtab)->assign_item_from_object(__pyx_v_self, __pyx_v_itemp, __pyx_v_value); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 485, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "View.MemoryView":477
+  /* "View.MemoryView":483
  *             PyMem_Free(tmp)
  * 
  *     cdef setitem_indexed(self, index, value):             # <<<<<<<<<<<<<<
  *         cdef char *itemp = self.get_item_pointer(index)
  *         self.assign_item_from_object(itemp, value)
  */
 
@@ -23193,15 +24930,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":481
+/* "View.MemoryView":487
  *         self.assign_item_from_object(itemp, value)
  * 
  *     cdef convert_item_to_object(self, char *itemp):             # <<<<<<<<<<<<<<
  *         """Only used if instantiated manually by the user, or if Cython doesn't
  *         know how to convert the type"""
  */
 
@@ -23218,41 +24955,44 @@
   PyObject *__pyx_t_5 = NULL;
   PyObject *__pyx_t_6 = NULL;
   PyObject *__pyx_t_7 = NULL;
   int __pyx_t_8;
   PyObject *__pyx_t_9 = NULL;
   size_t __pyx_t_10;
   int __pyx_t_11;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("convert_item_to_object", 0);
 
-  /* "View.MemoryView":484
+  /* "View.MemoryView":490
  *         """Only used if instantiated manually by the user, or if Cython doesn't
  *         know how to convert the type"""
  *         import struct             # <<<<<<<<<<<<<<
  *         cdef bytes bytesitem
  * 
  */
-  __pyx_t_1 = __Pyx_Import(__pyx_n_s_struct, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 484, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_Import(__pyx_n_s_struct, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 490, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_v_struct = __pyx_t_1;
   __pyx_t_1 = 0;
 
-  /* "View.MemoryView":487
+  /* "View.MemoryView":493
  *         cdef bytes bytesitem
  * 
  *         bytesitem = itemp[:self.view.itemsize]             # <<<<<<<<<<<<<<
  *         try:
  *             result = struct.unpack(self.view.format, bytesitem)
  */
-  __pyx_t_1 = __Pyx_PyBytes_FromStringAndSize(__pyx_v_itemp + 0, __pyx_v_self->view.itemsize - 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 487, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyBytes_FromStringAndSize(__pyx_v_itemp + 0, __pyx_v_self->view.itemsize - 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 493, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_v_bytesitem = ((PyObject*)__pyx_t_1);
   __pyx_t_1 = 0;
 
-  /* "View.MemoryView":488
+  /* "View.MemoryView":494
  * 
  *         bytesitem = itemp[:self.view.itemsize]
  *         try:             # <<<<<<<<<<<<<<
  *             result = struct.unpack(self.view.format, bytesitem)
  *         except struct.error:
  */
   {
@@ -23260,24 +25000,24 @@
     __Pyx_PyThreadState_assign
     __Pyx_ExceptionSave(&__pyx_t_2, &__pyx_t_3, &__pyx_t_4);
     __Pyx_XGOTREF(__pyx_t_2);
     __Pyx_XGOTREF(__pyx_t_3);
     __Pyx_XGOTREF(__pyx_t_4);
     /*try:*/ {
 
-      /* "View.MemoryView":489
+      /* "View.MemoryView":495
  *         bytesitem = itemp[:self.view.itemsize]
  *         try:
  *             result = struct.unpack(self.view.format, bytesitem)             # <<<<<<<<<<<<<<
  *         except struct.error:
  *             raise ValueError("Unable to convert item to object")
  */
-      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_struct, __pyx_n_s_unpack); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 489, __pyx_L3_error)
+      __pyx_t_5 = __Pyx_PyObject_GetAttrStr(__pyx_v_struct, __pyx_n_s_unpack); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 495, __pyx_L3_error)
       __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_6 = __Pyx_PyBytes_FromString(__pyx_v_self->view.format); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 489, __pyx_L3_error)
+      __pyx_t_6 = __Pyx_PyBytes_FromString(__pyx_v_self->view.format); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 495, __pyx_L3_error)
       __Pyx_GOTREF(__pyx_t_6);
       __pyx_t_7 = NULL;
       __pyx_t_8 = 0;
       if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_5))) {
         __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_5);
         if (likely(__pyx_t_7)) {
           PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_5);
@@ -23286,150 +25026,150 @@
           __Pyx_DECREF_SET(__pyx_t_5, function);
           __pyx_t_8 = 1;
         }
       }
       #if CYTHON_FAST_PYCALL
       if (PyFunction_Check(__pyx_t_5)) {
         PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_6, __pyx_v_bytesitem};
-        __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 489, __pyx_L3_error)
+        __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 495, __pyx_L3_error)
         __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
         __Pyx_GOTREF(__pyx_t_1);
         __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
       } else
       #endif
       #if CYTHON_FAST_PYCCALL
       if (__Pyx_PyFastCFunction_Check(__pyx_t_5)) {
         PyObject *__pyx_temp[3] = {__pyx_t_7, __pyx_t_6, __pyx_v_bytesitem};
-        __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 489, __pyx_L3_error)
+        __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_5, __pyx_temp+1-__pyx_t_8, 2+__pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 495, __pyx_L3_error)
         __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
         __Pyx_GOTREF(__pyx_t_1);
         __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
       } else
       #endif
       {
-        __pyx_t_9 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 489, __pyx_L3_error)
+        __pyx_t_9 = PyTuple_New(2+__pyx_t_8); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 495, __pyx_L3_error)
         __Pyx_GOTREF(__pyx_t_9);
         if (__pyx_t_7) {
           __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_9, 0, __pyx_t_7); __pyx_t_7 = NULL;
         }
         __Pyx_GIVEREF(__pyx_t_6);
         PyTuple_SET_ITEM(__pyx_t_9, 0+__pyx_t_8, __pyx_t_6);
         __Pyx_INCREF(__pyx_v_bytesitem);
         __Pyx_GIVEREF(__pyx_v_bytesitem);
         PyTuple_SET_ITEM(__pyx_t_9, 1+__pyx_t_8, __pyx_v_bytesitem);
         __pyx_t_6 = 0;
-        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_9, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 489, __pyx_L3_error)
+        __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_5, __pyx_t_9, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 495, __pyx_L3_error)
         __Pyx_GOTREF(__pyx_t_1);
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       }
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
       __pyx_v_result = __pyx_t_1;
       __pyx_t_1 = 0;
 
-      /* "View.MemoryView":488
+      /* "View.MemoryView":494
  * 
  *         bytesitem = itemp[:self.view.itemsize]
  *         try:             # <<<<<<<<<<<<<<
  *             result = struct.unpack(self.view.format, bytesitem)
  *         except struct.error:
  */
     }
 
-    /* "View.MemoryView":493
+    /* "View.MemoryView":499
  *             raise ValueError("Unable to convert item to object")
  *         else:
  *             if len(self.view.format) == 1:             # <<<<<<<<<<<<<<
  *                 return result[0]
  *             return result
  */
     /*else:*/ {
       __pyx_t_10 = strlen(__pyx_v_self->view.format); 
       __pyx_t_11 = ((__pyx_t_10 == 1) != 0);
       if (__pyx_t_11) {
 
-        /* "View.MemoryView":494
+        /* "View.MemoryView":500
  *         else:
  *             if len(self.view.format) == 1:
  *                 return result[0]             # <<<<<<<<<<<<<<
  *             return result
  * 
  */
         __Pyx_XDECREF(__pyx_r);
-        __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_result, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 494, __pyx_L5_except_error)
+        __pyx_t_1 = __Pyx_GetItemInt(__pyx_v_result, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 500, __pyx_L5_except_error)
         __Pyx_GOTREF(__pyx_t_1);
         __pyx_r = __pyx_t_1;
         __pyx_t_1 = 0;
         goto __pyx_L6_except_return;
 
-        /* "View.MemoryView":493
+        /* "View.MemoryView":499
  *             raise ValueError("Unable to convert item to object")
  *         else:
  *             if len(self.view.format) == 1:             # <<<<<<<<<<<<<<
  *                 return result[0]
  *             return result
  */
       }
 
-      /* "View.MemoryView":495
+      /* "View.MemoryView":501
  *             if len(self.view.format) == 1:
  *                 return result[0]
  *             return result             # <<<<<<<<<<<<<<
  * 
  *     cdef assign_item_from_object(self, char *itemp, object value):
  */
       __Pyx_XDECREF(__pyx_r);
       __Pyx_INCREF(__pyx_v_result);
       __pyx_r = __pyx_v_result;
       goto __pyx_L6_except_return;
     }
     __pyx_L3_error:;
-    __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
     __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
-    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-    /* "View.MemoryView":490
+    /* "View.MemoryView":496
  *         try:
  *             result = struct.unpack(self.view.format, bytesitem)
  *         except struct.error:             # <<<<<<<<<<<<<<
  *             raise ValueError("Unable to convert item to object")
  *         else:
  */
     __Pyx_ErrFetch(&__pyx_t_1, &__pyx_t_5, &__pyx_t_9);
-    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_struct, __pyx_n_s_error); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 490, __pyx_L5_except_error)
+    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_struct, __pyx_n_s_error); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 496, __pyx_L5_except_error)
     __Pyx_GOTREF(__pyx_t_6);
     __pyx_t_8 = __Pyx_PyErr_GivenExceptionMatches(__pyx_t_1, __pyx_t_6);
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     __Pyx_ErrRestore(__pyx_t_1, __pyx_t_5, __pyx_t_9);
     __pyx_t_1 = 0; __pyx_t_5 = 0; __pyx_t_9 = 0;
     if (__pyx_t_8) {
       __Pyx_AddTraceback("View.MemoryView.memoryview.convert_item_to_object", __pyx_clineno, __pyx_lineno, __pyx_filename);
-      if (__Pyx_GetException(&__pyx_t_9, &__pyx_t_5, &__pyx_t_1) < 0) __PYX_ERR(1, 490, __pyx_L5_except_error)
+      if (__Pyx_GetException(&__pyx_t_9, &__pyx_t_5, &__pyx_t_1) < 0) __PYX_ERR(1, 496, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_9);
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_GOTREF(__pyx_t_1);
 
-      /* "View.MemoryView":491
+      /* "View.MemoryView":497
  *             result = struct.unpack(self.view.format, bytesitem)
  *         except struct.error:
  *             raise ValueError("Unable to convert item to object")             # <<<<<<<<<<<<<<
  *         else:
  *             if len(self.view.format) == 1:
  */
-      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__21, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 491, __pyx_L5_except_error)
+      __pyx_t_6 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__21, NULL); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 497, __pyx_L5_except_error)
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_Raise(__pyx_t_6, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __PYX_ERR(1, 491, __pyx_L5_except_error)
+      __PYX_ERR(1, 497, __pyx_L5_except_error)
     }
     goto __pyx_L5_except_error;
     __pyx_L5_except_error:;
 
-    /* "View.MemoryView":488
+    /* "View.MemoryView":494
  * 
  *         bytesitem = itemp[:self.view.itemsize]
  *         try:             # <<<<<<<<<<<<<<
  *             result = struct.unpack(self.view.format, bytesitem)
  *         except struct.error:
  */
     __Pyx_XGIVEREF(__pyx_t_2);
@@ -23441,15 +25181,15 @@
     __Pyx_XGIVEREF(__pyx_t_2);
     __Pyx_XGIVEREF(__pyx_t_3);
     __Pyx_XGIVEREF(__pyx_t_4);
     __Pyx_ExceptionReset(__pyx_t_2, __pyx_t_3, __pyx_t_4);
     goto __pyx_L0;
   }
 
-  /* "View.MemoryView":481
+  /* "View.MemoryView":487
  *         self.assign_item_from_object(itemp, value)
  * 
  *     cdef convert_item_to_object(self, char *itemp):             # <<<<<<<<<<<<<<
  *         """Only used if instantiated manually by the user, or if Cython doesn't
  *         know how to convert the type"""
  */
 
@@ -23467,15 +25207,15 @@
   __Pyx_XDECREF(__pyx_v_bytesitem);
   __Pyx_XDECREF(__pyx_v_result);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":497
+/* "View.MemoryView":503
  *             return result
  * 
  *     cdef assign_item_from_object(self, char *itemp, object value):             # <<<<<<<<<<<<<<
  *         """Only used if instantiated manually by the user, or if Cython doesn't
  *         know how to convert the type"""
  */
 
@@ -23496,90 +25236,93 @@
   PyObject *__pyx_t_8 = NULL;
   Py_ssize_t __pyx_t_9;
   PyObject *__pyx_t_10 = NULL;
   char *__pyx_t_11;
   char *__pyx_t_12;
   char *__pyx_t_13;
   char *__pyx_t_14;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("assign_item_from_object", 0);
 
-  /* "View.MemoryView":500
+  /* "View.MemoryView":506
  *         """Only used if instantiated manually by the user, or if Cython doesn't
  *         know how to convert the type"""
  *         import struct             # <<<<<<<<<<<<<<
  *         cdef char c
  *         cdef bytes bytesvalue
  */
-  __pyx_t_1 = __Pyx_Import(__pyx_n_s_struct, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 500, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_Import(__pyx_n_s_struct, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 506, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_v_struct = __pyx_t_1;
   __pyx_t_1 = 0;
 
-  /* "View.MemoryView":505
+  /* "View.MemoryView":511
  *         cdef Py_ssize_t i
  * 
  *         if isinstance(value, tuple):             # <<<<<<<<<<<<<<
  *             bytesvalue = struct.pack(self.view.format, *value)
  *         else:
  */
   __pyx_t_2 = PyTuple_Check(__pyx_v_value); 
   __pyx_t_3 = (__pyx_t_2 != 0);
   if (__pyx_t_3) {
 
-    /* "View.MemoryView":506
+    /* "View.MemoryView":512
  * 
  *         if isinstance(value, tuple):
  *             bytesvalue = struct.pack(self.view.format, *value)             # <<<<<<<<<<<<<<
  *         else:
  *             bytesvalue = struct.pack(self.view.format, value)
  */
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_struct, __pyx_n_s_pack); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 506, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_struct, __pyx_n_s_pack); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 512, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_4 = __Pyx_PyBytes_FromString(__pyx_v_self->view.format); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 506, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyBytes_FromString(__pyx_v_self->view.format); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 512, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 506, __pyx_L1_error)
+    __pyx_t_5 = PyTuple_New(1); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 512, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
     __Pyx_GIVEREF(__pyx_t_4);
     PyTuple_SET_ITEM(__pyx_t_5, 0, __pyx_t_4);
     __pyx_t_4 = 0;
-    __pyx_t_4 = __Pyx_PySequence_Tuple(__pyx_v_value); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 506, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PySequence_Tuple(__pyx_v_value); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 512, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_6 = PyNumber_Add(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 506, __pyx_L1_error)
+    __pyx_t_6 = PyNumber_Add(__pyx_t_5, __pyx_t_4); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 512, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 506, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_6, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 512, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    if (!(likely(PyBytes_CheckExact(__pyx_t_4))||((__pyx_t_4) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_t_4)->tp_name), 0))) __PYX_ERR(1, 506, __pyx_L1_error)
+    if (!(likely(PyBytes_CheckExact(__pyx_t_4))||((__pyx_t_4) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_t_4)->tp_name), 0))) __PYX_ERR(1, 512, __pyx_L1_error)
     __pyx_v_bytesvalue = ((PyObject*)__pyx_t_4);
     __pyx_t_4 = 0;
 
-    /* "View.MemoryView":505
+    /* "View.MemoryView":511
  *         cdef Py_ssize_t i
  * 
  *         if isinstance(value, tuple):             # <<<<<<<<<<<<<<
  *             bytesvalue = struct.pack(self.view.format, *value)
  *         else:
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":508
+  /* "View.MemoryView":514
  *             bytesvalue = struct.pack(self.view.format, *value)
  *         else:
  *             bytesvalue = struct.pack(self.view.format, value)             # <<<<<<<<<<<<<<
  * 
  *         for i, c in enumerate(bytesvalue):
  */
   /*else*/ {
-    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_struct, __pyx_n_s_pack); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 508, __pyx_L1_error)
+    __pyx_t_6 = __Pyx_PyObject_GetAttrStr(__pyx_v_struct, __pyx_n_s_pack); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 514, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
-    __pyx_t_1 = __Pyx_PyBytes_FromString(__pyx_v_self->view.format); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 508, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyBytes_FromString(__pyx_v_self->view.format); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 514, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __pyx_t_5 = NULL;
     __pyx_t_7 = 0;
     if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_6))) {
       __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_6);
       if (likely(__pyx_t_5)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_6);
@@ -23588,102 +25331,102 @@
         __Pyx_DECREF_SET(__pyx_t_6, function);
         __pyx_t_7 = 1;
       }
     }
     #if CYTHON_FAST_PYCALL
     if (PyFunction_Check(__pyx_t_6)) {
       PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_1, __pyx_v_value};
-      __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 508, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_PyFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 514, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
       __Pyx_GOTREF(__pyx_t_4);
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     } else
     #endif
     #if CYTHON_FAST_PYCCALL
     if (__Pyx_PyFastCFunction_Check(__pyx_t_6)) {
       PyObject *__pyx_temp[3] = {__pyx_t_5, __pyx_t_1, __pyx_v_value};
-      __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 508, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_PyCFunction_FastCall(__pyx_t_6, __pyx_temp+1-__pyx_t_7, 2+__pyx_t_7); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 514, __pyx_L1_error)
       __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
       __Pyx_GOTREF(__pyx_t_4);
       __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     } else
     #endif
     {
-      __pyx_t_8 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 508, __pyx_L1_error)
+      __pyx_t_8 = PyTuple_New(2+__pyx_t_7); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 514, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_8);
       if (__pyx_t_5) {
         __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_5); __pyx_t_5 = NULL;
       }
       __Pyx_GIVEREF(__pyx_t_1);
       PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_7, __pyx_t_1);
       __Pyx_INCREF(__pyx_v_value);
       __Pyx_GIVEREF(__pyx_v_value);
       PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_7, __pyx_v_value);
       __pyx_t_1 = 0;
-      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_8, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 508, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_6, __pyx_t_8, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 514, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
       __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
     }
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-    if (!(likely(PyBytes_CheckExact(__pyx_t_4))||((__pyx_t_4) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_t_4)->tp_name), 0))) __PYX_ERR(1, 508, __pyx_L1_error)
+    if (!(likely(PyBytes_CheckExact(__pyx_t_4))||((__pyx_t_4) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_t_4)->tp_name), 0))) __PYX_ERR(1, 514, __pyx_L1_error)
     __pyx_v_bytesvalue = ((PyObject*)__pyx_t_4);
     __pyx_t_4 = 0;
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":510
+  /* "View.MemoryView":516
  *             bytesvalue = struct.pack(self.view.format, value)
  * 
  *         for i, c in enumerate(bytesvalue):             # <<<<<<<<<<<<<<
  *             itemp[i] = c
  * 
  */
   __pyx_t_9 = 0;
   if (unlikely(__pyx_v_bytesvalue == Py_None)) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' is not iterable");
-    __PYX_ERR(1, 510, __pyx_L1_error)
+    __PYX_ERR(1, 516, __pyx_L1_error)
   }
   __Pyx_INCREF(__pyx_v_bytesvalue);
   __pyx_t_10 = __pyx_v_bytesvalue;
   __pyx_t_12 = PyBytes_AS_STRING(__pyx_t_10);
   __pyx_t_13 = (__pyx_t_12 + PyBytes_GET_SIZE(__pyx_t_10));
   for (__pyx_t_14 = __pyx_t_12; __pyx_t_14 < __pyx_t_13; __pyx_t_14++) {
     __pyx_t_11 = __pyx_t_14;
     __pyx_v_c = (__pyx_t_11[0]);
 
-    /* "View.MemoryView":511
+    /* "View.MemoryView":517
  * 
  *         for i, c in enumerate(bytesvalue):
  *             itemp[i] = c             # <<<<<<<<<<<<<<
  * 
  *     @cname('getbuffer')
  */
     __pyx_v_i = __pyx_t_9;
 
-    /* "View.MemoryView":510
+    /* "View.MemoryView":516
  *             bytesvalue = struct.pack(self.view.format, value)
  * 
  *         for i, c in enumerate(bytesvalue):             # <<<<<<<<<<<<<<
  *             itemp[i] = c
  * 
  */
     __pyx_t_9 = (__pyx_t_9 + 1);
 
-    /* "View.MemoryView":511
+    /* "View.MemoryView":517
  * 
  *         for i, c in enumerate(bytesvalue):
  *             itemp[i] = c             # <<<<<<<<<<<<<<
  * 
  *     @cname('getbuffer')
  */
     (__pyx_v_itemp[__pyx_v_i]) = __pyx_v_c;
   }
   __Pyx_DECREF(__pyx_t_10); __pyx_t_10 = 0;
 
-  /* "View.MemoryView":497
+  /* "View.MemoryView":503
  *             return result
  * 
  *     cdef assign_item_from_object(self, char *itemp, object value):             # <<<<<<<<<<<<<<
  *         """Only used if instantiated manually by the user, or if Cython doesn't
  *         know how to convert the type"""
  */
 
@@ -23703,15 +25446,15 @@
   __Pyx_XDECREF(__pyx_v_struct);
   __Pyx_XDECREF(__pyx_v_bytesvalue);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":514
+/* "View.MemoryView":520
  * 
  *     @cname('getbuffer')
  *     def __getbuffer__(self, Py_buffer *info, int flags):             # <<<<<<<<<<<<<<
  *         if flags & PyBUF_WRITABLE and self.view.readonly:
  *             raise ValueError("Cannot create writable memory view from read-only memoryview")
  */
 
@@ -23735,23 +25478,26 @@
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
   Py_ssize_t *__pyx_t_4;
   char *__pyx_t_5;
   void *__pyx_t_6;
   int __pyx_t_7;
   Py_ssize_t __pyx_t_8;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   if (__pyx_v_info == NULL) {
     PyErr_SetString(PyExc_BufferError, "PyObject_GetBuffer: view==NULL argument is obsolete");
     return -1;
   }
   __Pyx_RefNannySetupContext("__getbuffer__", 0);
   __pyx_v_info->obj = Py_None; __Pyx_INCREF(Py_None);
   __Pyx_GIVEREF(__pyx_v_info->obj);
 
-  /* "View.MemoryView":515
+  /* "View.MemoryView":521
  *     @cname('getbuffer')
  *     def __getbuffer__(self, Py_buffer *info, int flags):
  *         if flags & PyBUF_WRITABLE and self.view.readonly:             # <<<<<<<<<<<<<<
  *             raise ValueError("Cannot create writable memory view from read-only memoryview")
  * 
  */
   __pyx_t_2 = ((__pyx_v_flags & PyBUF_WRITABLE) != 0);
@@ -23761,268 +25507,268 @@
     goto __pyx_L4_bool_binop_done;
   }
   __pyx_t_2 = (__pyx_v_self->view.readonly != 0);
   __pyx_t_1 = __pyx_t_2;
   __pyx_L4_bool_binop_done:;
   if (unlikely(__pyx_t_1)) {
 
-    /* "View.MemoryView":516
+    /* "View.MemoryView":522
  *     def __getbuffer__(self, Py_buffer *info, int flags):
  *         if flags & PyBUF_WRITABLE and self.view.readonly:
  *             raise ValueError("Cannot create writable memory view from read-only memoryview")             # <<<<<<<<<<<<<<
  * 
  *         if flags & PyBUF_ND:
  */
-    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__22, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 516, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__22, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 522, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_Raise(__pyx_t_3, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __PYX_ERR(1, 516, __pyx_L1_error)
+    __PYX_ERR(1, 522, __pyx_L1_error)
 
-    /* "View.MemoryView":515
+    /* "View.MemoryView":521
  *     @cname('getbuffer')
  *     def __getbuffer__(self, Py_buffer *info, int flags):
  *         if flags & PyBUF_WRITABLE and self.view.readonly:             # <<<<<<<<<<<<<<
  *             raise ValueError("Cannot create writable memory view from read-only memoryview")
  * 
  */
   }
 
-  /* "View.MemoryView":518
+  /* "View.MemoryView":524
  *             raise ValueError("Cannot create writable memory view from read-only memoryview")
  * 
  *         if flags & PyBUF_ND:             # <<<<<<<<<<<<<<
  *             info.shape = self.view.shape
  *         else:
  */
   __pyx_t_1 = ((__pyx_v_flags & PyBUF_ND) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":519
+    /* "View.MemoryView":525
  * 
  *         if flags & PyBUF_ND:
  *             info.shape = self.view.shape             # <<<<<<<<<<<<<<
  *         else:
  *             info.shape = NULL
  */
     __pyx_t_4 = __pyx_v_self->view.shape;
     __pyx_v_info->shape = __pyx_t_4;
 
-    /* "View.MemoryView":518
+    /* "View.MemoryView":524
  *             raise ValueError("Cannot create writable memory view from read-only memoryview")
  * 
  *         if flags & PyBUF_ND:             # <<<<<<<<<<<<<<
  *             info.shape = self.view.shape
  *         else:
  */
     goto __pyx_L6;
   }
 
-  /* "View.MemoryView":521
+  /* "View.MemoryView":527
  *             info.shape = self.view.shape
  *         else:
  *             info.shape = NULL             # <<<<<<<<<<<<<<
  * 
  *         if flags & PyBUF_STRIDES:
  */
   /*else*/ {
     __pyx_v_info->shape = NULL;
   }
   __pyx_L6:;
 
-  /* "View.MemoryView":523
+  /* "View.MemoryView":529
  *             info.shape = NULL
  * 
  *         if flags & PyBUF_STRIDES:             # <<<<<<<<<<<<<<
  *             info.strides = self.view.strides
  *         else:
  */
   __pyx_t_1 = ((__pyx_v_flags & PyBUF_STRIDES) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":524
+    /* "View.MemoryView":530
  * 
  *         if flags & PyBUF_STRIDES:
  *             info.strides = self.view.strides             # <<<<<<<<<<<<<<
  *         else:
  *             info.strides = NULL
  */
     __pyx_t_4 = __pyx_v_self->view.strides;
     __pyx_v_info->strides = __pyx_t_4;
 
-    /* "View.MemoryView":523
+    /* "View.MemoryView":529
  *             info.shape = NULL
  * 
  *         if flags & PyBUF_STRIDES:             # <<<<<<<<<<<<<<
  *             info.strides = self.view.strides
  *         else:
  */
     goto __pyx_L7;
   }
 
-  /* "View.MemoryView":526
+  /* "View.MemoryView":532
  *             info.strides = self.view.strides
  *         else:
  *             info.strides = NULL             # <<<<<<<<<<<<<<
  * 
  *         if flags & PyBUF_INDIRECT:
  */
   /*else*/ {
     __pyx_v_info->strides = NULL;
   }
   __pyx_L7:;
 
-  /* "View.MemoryView":528
+  /* "View.MemoryView":534
  *             info.strides = NULL
  * 
  *         if flags & PyBUF_INDIRECT:             # <<<<<<<<<<<<<<
  *             info.suboffsets = self.view.suboffsets
  *         else:
  */
   __pyx_t_1 = ((__pyx_v_flags & PyBUF_INDIRECT) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":529
+    /* "View.MemoryView":535
  * 
  *         if flags & PyBUF_INDIRECT:
  *             info.suboffsets = self.view.suboffsets             # <<<<<<<<<<<<<<
  *         else:
  *             info.suboffsets = NULL
  */
     __pyx_t_4 = __pyx_v_self->view.suboffsets;
     __pyx_v_info->suboffsets = __pyx_t_4;
 
-    /* "View.MemoryView":528
+    /* "View.MemoryView":534
  *             info.strides = NULL
  * 
  *         if flags & PyBUF_INDIRECT:             # <<<<<<<<<<<<<<
  *             info.suboffsets = self.view.suboffsets
  *         else:
  */
     goto __pyx_L8;
   }
 
-  /* "View.MemoryView":531
+  /* "View.MemoryView":537
  *             info.suboffsets = self.view.suboffsets
  *         else:
  *             info.suboffsets = NULL             # <<<<<<<<<<<<<<
  * 
  *         if flags & PyBUF_FORMAT:
  */
   /*else*/ {
     __pyx_v_info->suboffsets = NULL;
   }
   __pyx_L8:;
 
-  /* "View.MemoryView":533
+  /* "View.MemoryView":539
  *             info.suboffsets = NULL
  * 
  *         if flags & PyBUF_FORMAT:             # <<<<<<<<<<<<<<
  *             info.format = self.view.format
  *         else:
  */
   __pyx_t_1 = ((__pyx_v_flags & PyBUF_FORMAT) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":534
+    /* "View.MemoryView":540
  * 
  *         if flags & PyBUF_FORMAT:
  *             info.format = self.view.format             # <<<<<<<<<<<<<<
  *         else:
  *             info.format = NULL
  */
     __pyx_t_5 = __pyx_v_self->view.format;
     __pyx_v_info->format = __pyx_t_5;
 
-    /* "View.MemoryView":533
+    /* "View.MemoryView":539
  *             info.suboffsets = NULL
  * 
  *         if flags & PyBUF_FORMAT:             # <<<<<<<<<<<<<<
  *             info.format = self.view.format
  *         else:
  */
     goto __pyx_L9;
   }
 
-  /* "View.MemoryView":536
+  /* "View.MemoryView":542
  *             info.format = self.view.format
  *         else:
  *             info.format = NULL             # <<<<<<<<<<<<<<
  * 
  *         info.buf = self.view.buf
  */
   /*else*/ {
     __pyx_v_info->format = NULL;
   }
   __pyx_L9:;
 
-  /* "View.MemoryView":538
+  /* "View.MemoryView":544
  *             info.format = NULL
  * 
  *         info.buf = self.view.buf             # <<<<<<<<<<<<<<
  *         info.ndim = self.view.ndim
  *         info.itemsize = self.view.itemsize
  */
   __pyx_t_6 = __pyx_v_self->view.buf;
   __pyx_v_info->buf = __pyx_t_6;
 
-  /* "View.MemoryView":539
+  /* "View.MemoryView":545
  * 
  *         info.buf = self.view.buf
  *         info.ndim = self.view.ndim             # <<<<<<<<<<<<<<
  *         info.itemsize = self.view.itemsize
  *         info.len = self.view.len
  */
   __pyx_t_7 = __pyx_v_self->view.ndim;
   __pyx_v_info->ndim = __pyx_t_7;
 
-  /* "View.MemoryView":540
+  /* "View.MemoryView":546
  *         info.buf = self.view.buf
  *         info.ndim = self.view.ndim
  *         info.itemsize = self.view.itemsize             # <<<<<<<<<<<<<<
  *         info.len = self.view.len
  *         info.readonly = self.view.readonly
  */
   __pyx_t_8 = __pyx_v_self->view.itemsize;
   __pyx_v_info->itemsize = __pyx_t_8;
 
-  /* "View.MemoryView":541
+  /* "View.MemoryView":547
  *         info.ndim = self.view.ndim
  *         info.itemsize = self.view.itemsize
  *         info.len = self.view.len             # <<<<<<<<<<<<<<
  *         info.readonly = self.view.readonly
  *         info.obj = self
  */
   __pyx_t_8 = __pyx_v_self->view.len;
   __pyx_v_info->len = __pyx_t_8;
 
-  /* "View.MemoryView":542
+  /* "View.MemoryView":548
  *         info.itemsize = self.view.itemsize
  *         info.len = self.view.len
  *         info.readonly = self.view.readonly             # <<<<<<<<<<<<<<
  *         info.obj = self
  * 
  */
   __pyx_t_1 = __pyx_v_self->view.readonly;
   __pyx_v_info->readonly = __pyx_t_1;
 
-  /* "View.MemoryView":543
+  /* "View.MemoryView":549
  *         info.len = self.view.len
  *         info.readonly = self.view.readonly
  *         info.obj = self             # <<<<<<<<<<<<<<
  * 
  *     __pyx_getbuffer = capsule(<void *> &__pyx_memoryview_getbuffer, "getbuffer(obj, view, flags)")
  */
   __Pyx_INCREF(((PyObject *)__pyx_v_self));
   __Pyx_GIVEREF(((PyObject *)__pyx_v_self));
   __Pyx_GOTREF(__pyx_v_info->obj);
   __Pyx_DECREF(__pyx_v_info->obj);
   __pyx_v_info->obj = ((PyObject *)__pyx_v_self);
 
-  /* "View.MemoryView":514
+  /* "View.MemoryView":520
  * 
  *     @cname('getbuffer')
  *     def __getbuffer__(self, Py_buffer *info, int flags):             # <<<<<<<<<<<<<<
  *         if flags & PyBUF_WRITABLE and self.view.readonly:
  *             raise ValueError("Cannot create writable memory view from read-only memoryview")
  */
 
@@ -24044,15 +25790,15 @@
     __Pyx_DECREF(__pyx_v_info->obj); __pyx_v_info->obj = 0;
   }
   __pyx_L2:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":549
+/* "View.MemoryView":555
  * 
  *     @property
  *     def T(self):             # <<<<<<<<<<<<<<
  *         cdef _memoryviewslice result = memoryview_copy(self)
  *         transpose_memslice(&result.from_slice)
  */
 
@@ -24071,51 +25817,54 @@
 
 static PyObject *__pyx_pf_15View_dot_MemoryView_10memoryview_1T___get__(struct __pyx_memoryview_obj *__pyx_v_self) {
   struct __pyx_memoryviewslice_obj *__pyx_v_result = 0;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_t_2;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":550
+  /* "View.MemoryView":556
  *     @property
  *     def T(self):
  *         cdef _memoryviewslice result = memoryview_copy(self)             # <<<<<<<<<<<<<<
  *         transpose_memslice(&result.from_slice)
  *         return result
  */
-  __pyx_t_1 = __pyx_memoryview_copy_object(__pyx_v_self); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 550, __pyx_L1_error)
+  __pyx_t_1 = __pyx_memoryview_copy_object(__pyx_v_self); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 556, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_memoryviewslice_type))))) __PYX_ERR(1, 550, __pyx_L1_error)
+  if (!(likely(((__pyx_t_1) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_1, __pyx_memoryviewslice_type))))) __PYX_ERR(1, 556, __pyx_L1_error)
   __pyx_v_result = ((struct __pyx_memoryviewslice_obj *)__pyx_t_1);
   __pyx_t_1 = 0;
 
-  /* "View.MemoryView":551
+  /* "View.MemoryView":557
  *     def T(self):
  *         cdef _memoryviewslice result = memoryview_copy(self)
  *         transpose_memslice(&result.from_slice)             # <<<<<<<<<<<<<<
  *         return result
  * 
  */
-  __pyx_t_2 = __pyx_memslice_transpose((&__pyx_v_result->from_slice)); if (unlikely(__pyx_t_2 == ((int)0))) __PYX_ERR(1, 551, __pyx_L1_error)
+  __pyx_t_2 = __pyx_memslice_transpose((&__pyx_v_result->from_slice)); if (unlikely(__pyx_t_2 == ((int)0))) __PYX_ERR(1, 557, __pyx_L1_error)
 
-  /* "View.MemoryView":552
+  /* "View.MemoryView":558
  *         cdef _memoryviewslice result = memoryview_copy(self)
  *         transpose_memslice(&result.from_slice)
  *         return result             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(((PyObject *)__pyx_v_result));
   __pyx_r = ((PyObject *)__pyx_v_result);
   goto __pyx_L0;
 
-  /* "View.MemoryView":549
+  /* "View.MemoryView":555
  * 
  *     @property
  *     def T(self):             # <<<<<<<<<<<<<<
  *         cdef _memoryviewslice result = memoryview_copy(self)
  *         transpose_memslice(&result.from_slice)
  */
 
@@ -24127,15 +25876,15 @@
   __pyx_L0:;
   __Pyx_XDECREF((PyObject *)__pyx_v_result);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":555
+/* "View.MemoryView":561
  * 
  *     @property
  *     def base(self):             # <<<<<<<<<<<<<<
  *         return self.obj
  * 
  */
 
@@ -24153,42 +25902,42 @@
 }
 
 static PyObject *__pyx_pf_15View_dot_MemoryView_10memoryview_4base___get__(struct __pyx_memoryview_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":556
+  /* "View.MemoryView":562
  *     @property
  *     def base(self):
  *         return self.obj             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(__pyx_v_self->obj);
   __pyx_r = __pyx_v_self->obj;
   goto __pyx_L0;
 
-  /* "View.MemoryView":555
+  /* "View.MemoryView":561
  * 
  *     @property
  *     def base(self):             # <<<<<<<<<<<<<<
  *         return self.obj
  * 
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":559
+/* "View.MemoryView":565
  * 
  *     @property
  *     def shape(self):             # <<<<<<<<<<<<<<
  *         return tuple([length for length in self.view.shape[:self.view.ndim]])
  * 
  */
 
@@ -24210,43 +25959,46 @@
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   Py_ssize_t *__pyx_t_2;
   Py_ssize_t *__pyx_t_3;
   Py_ssize_t *__pyx_t_4;
   PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":560
+  /* "View.MemoryView":566
  *     @property
  *     def shape(self):
  *         return tuple([length for length in self.view.shape[:self.view.ndim]])             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 560, __pyx_L1_error)
+  __pyx_t_1 = PyList_New(0); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 566, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_t_3 = (__pyx_v_self->view.shape + __pyx_v_self->view.ndim);
   for (__pyx_t_4 = __pyx_v_self->view.shape; __pyx_t_4 < __pyx_t_3; __pyx_t_4++) {
     __pyx_t_2 = __pyx_t_4;
     __pyx_v_length = (__pyx_t_2[0]);
-    __pyx_t_5 = PyInt_FromSsize_t(__pyx_v_length); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 560, __pyx_L1_error)
+    __pyx_t_5 = PyInt_FromSsize_t(__pyx_v_length); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 566, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    if (unlikely(__Pyx_ListComp_Append(__pyx_t_1, (PyObject*)__pyx_t_5))) __PYX_ERR(1, 560, __pyx_L1_error)
+    if (unlikely(__Pyx_ListComp_Append(__pyx_t_1, (PyObject*)__pyx_t_5))) __PYX_ERR(1, 566, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
   }
-  __pyx_t_5 = PyList_AsTuple(((PyObject*)__pyx_t_1)); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 560, __pyx_L1_error)
+  __pyx_t_5 = PyList_AsTuple(((PyObject*)__pyx_t_1)); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 566, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_r = __pyx_t_5;
   __pyx_t_5 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":559
+  /* "View.MemoryView":565
  * 
  *     @property
  *     def shape(self):             # <<<<<<<<<<<<<<
  *         return tuple([length for length in self.view.shape[:self.view.ndim]])
  * 
  */
 
@@ -24258,15 +26010,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":563
+/* "View.MemoryView":569
  * 
  *     @property
  *     def strides(self):             # <<<<<<<<<<<<<<
  *         if self.view.strides == NULL:
  * 
  */
 
@@ -24289,75 +26041,78 @@
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   Py_ssize_t *__pyx_t_3;
   Py_ssize_t *__pyx_t_4;
   Py_ssize_t *__pyx_t_5;
   PyObject *__pyx_t_6 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":564
+  /* "View.MemoryView":570
  *     @property
  *     def strides(self):
  *         if self.view.strides == NULL:             # <<<<<<<<<<<<<<
  * 
  *             raise ValueError("Buffer view does not expose strides")
  */
   __pyx_t_1 = ((__pyx_v_self->view.strides == NULL) != 0);
   if (unlikely(__pyx_t_1)) {
 
-    /* "View.MemoryView":566
+    /* "View.MemoryView":572
  *         if self.view.strides == NULL:
  * 
  *             raise ValueError("Buffer view does not expose strides")             # <<<<<<<<<<<<<<
  * 
  *         return tuple([stride for stride in self.view.strides[:self.view.ndim]])
  */
-    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__23, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 566, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__23, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 572, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_Raise(__pyx_t_2, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __PYX_ERR(1, 566, __pyx_L1_error)
+    __PYX_ERR(1, 572, __pyx_L1_error)
 
-    /* "View.MemoryView":564
+    /* "View.MemoryView":570
  *     @property
  *     def strides(self):
  *         if self.view.strides == NULL:             # <<<<<<<<<<<<<<
  * 
  *             raise ValueError("Buffer view does not expose strides")
  */
   }
 
-  /* "View.MemoryView":568
+  /* "View.MemoryView":574
  *             raise ValueError("Buffer view does not expose strides")
  * 
  *         return tuple([stride for stride in self.view.strides[:self.view.ndim]])             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_2 = PyList_New(0); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 568, __pyx_L1_error)
+  __pyx_t_2 = PyList_New(0); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 574, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __pyx_t_4 = (__pyx_v_self->view.strides + __pyx_v_self->view.ndim);
   for (__pyx_t_5 = __pyx_v_self->view.strides; __pyx_t_5 < __pyx_t_4; __pyx_t_5++) {
     __pyx_t_3 = __pyx_t_5;
     __pyx_v_stride = (__pyx_t_3[0]);
-    __pyx_t_6 = PyInt_FromSsize_t(__pyx_v_stride); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 568, __pyx_L1_error)
+    __pyx_t_6 = PyInt_FromSsize_t(__pyx_v_stride); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 574, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
-    if (unlikely(__Pyx_ListComp_Append(__pyx_t_2, (PyObject*)__pyx_t_6))) __PYX_ERR(1, 568, __pyx_L1_error)
+    if (unlikely(__Pyx_ListComp_Append(__pyx_t_2, (PyObject*)__pyx_t_6))) __PYX_ERR(1, 574, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
   }
-  __pyx_t_6 = PyList_AsTuple(((PyObject*)__pyx_t_2)); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 568, __pyx_L1_error)
+  __pyx_t_6 = PyList_AsTuple(((PyObject*)__pyx_t_2)); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 574, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __pyx_r = __pyx_t_6;
   __pyx_t_6 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":563
+  /* "View.MemoryView":569
  * 
  *     @property
  *     def strides(self):             # <<<<<<<<<<<<<<
  *         if self.view.strides == NULL:
  * 
  */
 
@@ -24369,15 +26124,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":571
+/* "View.MemoryView":577
  * 
  *     @property
  *     def suboffsets(self):             # <<<<<<<<<<<<<<
  *         if self.view.suboffsets == NULL:
  *             return (-1,) * self.view.ndim
  */
 
@@ -24400,79 +26155,82 @@
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   Py_ssize_t *__pyx_t_4;
   Py_ssize_t *__pyx_t_5;
   Py_ssize_t *__pyx_t_6;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":572
+  /* "View.MemoryView":578
  *     @property
  *     def suboffsets(self):
  *         if self.view.suboffsets == NULL:             # <<<<<<<<<<<<<<
  *             return (-1,) * self.view.ndim
  * 
  */
   __pyx_t_1 = ((__pyx_v_self->view.suboffsets == NULL) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":573
+    /* "View.MemoryView":579
  *     def suboffsets(self):
  *         if self.view.suboffsets == NULL:
  *             return (-1,) * self.view.ndim             # <<<<<<<<<<<<<<
  * 
  *         return tuple([suboffset for suboffset in self.view.suboffsets[:self.view.ndim]])
  */
     __Pyx_XDECREF(__pyx_r);
-    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->view.ndim); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 573, __pyx_L1_error)
+    __pyx_t_2 = __Pyx_PyInt_From_int(__pyx_v_self->view.ndim); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 579, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_3 = PyNumber_Multiply(__pyx_tuple__24, __pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 573, __pyx_L1_error)
+    __pyx_t_3 = PyNumber_Multiply(__pyx_tuple__24, __pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 579, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
     __pyx_r = __pyx_t_3;
     __pyx_t_3 = 0;
     goto __pyx_L0;
 
-    /* "View.MemoryView":572
+    /* "View.MemoryView":578
  *     @property
  *     def suboffsets(self):
  *         if self.view.suboffsets == NULL:             # <<<<<<<<<<<<<<
  *             return (-1,) * self.view.ndim
  * 
  */
   }
 
-  /* "View.MemoryView":575
+  /* "View.MemoryView":581
  *             return (-1,) * self.view.ndim
  * 
  *         return tuple([suboffset for suboffset in self.view.suboffsets[:self.view.ndim]])             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_3 = PyList_New(0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 575, __pyx_L1_error)
+  __pyx_t_3 = PyList_New(0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 581, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __pyx_t_5 = (__pyx_v_self->view.suboffsets + __pyx_v_self->view.ndim);
   for (__pyx_t_6 = __pyx_v_self->view.suboffsets; __pyx_t_6 < __pyx_t_5; __pyx_t_6++) {
     __pyx_t_4 = __pyx_t_6;
     __pyx_v_suboffset = (__pyx_t_4[0]);
-    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_suboffset); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 575, __pyx_L1_error)
+    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_suboffset); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 581, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    if (unlikely(__Pyx_ListComp_Append(__pyx_t_3, (PyObject*)__pyx_t_2))) __PYX_ERR(1, 575, __pyx_L1_error)
+    if (unlikely(__Pyx_ListComp_Append(__pyx_t_3, (PyObject*)__pyx_t_2))) __PYX_ERR(1, 581, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   }
-  __pyx_t_2 = PyList_AsTuple(((PyObject*)__pyx_t_3)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 575, __pyx_L1_error)
+  __pyx_t_2 = PyList_AsTuple(((PyObject*)__pyx_t_3)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 581, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __pyx_r = __pyx_t_2;
   __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":571
+  /* "View.MemoryView":577
  * 
  *     @property
  *     def suboffsets(self):             # <<<<<<<<<<<<<<
  *         if self.view.suboffsets == NULL:
  *             return (-1,) * self.view.ndim
  */
 
@@ -24484,15 +26242,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":578
+/* "View.MemoryView":584
  * 
  *     @property
  *     def ndim(self):             # <<<<<<<<<<<<<<
  *         return self.view.ndim
  * 
  */
 
@@ -24509,31 +26267,34 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_15View_dot_MemoryView_10memoryview_4ndim___get__(struct __pyx_memoryview_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":579
+  /* "View.MemoryView":585
  *     @property
  *     def ndim(self):
  *         return self.view.ndim             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->view.ndim); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 579, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->view.ndim); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 585, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":578
+  /* "View.MemoryView":584
  * 
  *     @property
  *     def ndim(self):             # <<<<<<<<<<<<<<
  *         return self.view.ndim
  * 
  */
 
@@ -24544,15 +26305,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":582
+/* "View.MemoryView":588
  * 
  *     @property
  *     def itemsize(self):             # <<<<<<<<<<<<<<
  *         return self.view.itemsize
  * 
  */
 
@@ -24569,31 +26330,34 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf_15View_dot_MemoryView_10memoryview_8itemsize___get__(struct __pyx_memoryview_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":583
+  /* "View.MemoryView":589
  *     @property
  *     def itemsize(self):
  *         return self.view.itemsize             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_self->view.itemsize); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 583, __pyx_L1_error)
+  __pyx_t_1 = PyInt_FromSsize_t(__pyx_v_self->view.itemsize); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 589, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":582
+  /* "View.MemoryView":588
  * 
  *     @property
  *     def itemsize(self):             # <<<<<<<<<<<<<<
  *         return self.view.itemsize
  * 
  */
 
@@ -24604,15 +26368,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":586
+/* "View.MemoryView":592
  * 
  *     @property
  *     def nbytes(self):             # <<<<<<<<<<<<<<
  *         return self.size * self.view.itemsize
  * 
  */
 
@@ -24631,37 +26395,40 @@
 
 static PyObject *__pyx_pf_15View_dot_MemoryView_10memoryview_6nbytes___get__(struct __pyx_memoryview_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":587
+  /* "View.MemoryView":593
  *     @property
  *     def nbytes(self):
  *         return self.size * self.view.itemsize             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 587, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_self->view.itemsize); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 587, __pyx_L1_error)
+  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_self->view.itemsize); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = PyNumber_Multiply(__pyx_t_1, __pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 587, __pyx_L1_error)
+  __pyx_t_3 = PyNumber_Multiply(__pyx_t_1, __pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 593, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __pyx_r = __pyx_t_3;
   __pyx_t_3 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":586
+  /* "View.MemoryView":592
  * 
  *     @property
  *     def nbytes(self):             # <<<<<<<<<<<<<<
  *         return self.size * self.view.itemsize
  * 
  */
 
@@ -24674,15 +26441,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":590
+/* "View.MemoryView":596
  * 
  *     @property
  *     def size(self):             # <<<<<<<<<<<<<<
  *         if self._size is None:
  *             result = 1
  */
 
@@ -24706,100 +26473,103 @@
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   Py_ssize_t *__pyx_t_3;
   Py_ssize_t *__pyx_t_4;
   Py_ssize_t *__pyx_t_5;
   PyObject *__pyx_t_6 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":591
+  /* "View.MemoryView":597
  *     @property
  *     def size(self):
  *         if self._size is None:             # <<<<<<<<<<<<<<
  *             result = 1
  * 
  */
   __pyx_t_1 = (__pyx_v_self->_size == Py_None);
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":592
+    /* "View.MemoryView":598
  *     def size(self):
  *         if self._size is None:
  *             result = 1             # <<<<<<<<<<<<<<
  * 
  *             for length in self.view.shape[:self.view.ndim]:
  */
     __Pyx_INCREF(__pyx_int_1);
     __pyx_v_result = __pyx_int_1;
 
-    /* "View.MemoryView":594
+    /* "View.MemoryView":600
  *             result = 1
  * 
  *             for length in self.view.shape[:self.view.ndim]:             # <<<<<<<<<<<<<<
  *                 result *= length
  * 
  */
     __pyx_t_4 = (__pyx_v_self->view.shape + __pyx_v_self->view.ndim);
     for (__pyx_t_5 = __pyx_v_self->view.shape; __pyx_t_5 < __pyx_t_4; __pyx_t_5++) {
       __pyx_t_3 = __pyx_t_5;
-      __pyx_t_6 = PyInt_FromSsize_t((__pyx_t_3[0])); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 594, __pyx_L1_error)
+      __pyx_t_6 = PyInt_FromSsize_t((__pyx_t_3[0])); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 600, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_XDECREF_SET(__pyx_v_length, __pyx_t_6);
       __pyx_t_6 = 0;
 
-      /* "View.MemoryView":595
+      /* "View.MemoryView":601
  * 
  *             for length in self.view.shape[:self.view.ndim]:
  *                 result *= length             # <<<<<<<<<<<<<<
  * 
  *             self._size = result
  */
-      __pyx_t_6 = PyNumber_InPlaceMultiply(__pyx_v_result, __pyx_v_length); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 595, __pyx_L1_error)
+      __pyx_t_6 = PyNumber_InPlaceMultiply(__pyx_v_result, __pyx_v_length); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 601, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
       __Pyx_DECREF_SET(__pyx_v_result, __pyx_t_6);
       __pyx_t_6 = 0;
     }
 
-    /* "View.MemoryView":597
+    /* "View.MemoryView":603
  *                 result *= length
  * 
  *             self._size = result             # <<<<<<<<<<<<<<
  * 
  *         return self._size
  */
     __Pyx_INCREF(__pyx_v_result);
     __Pyx_GIVEREF(__pyx_v_result);
     __Pyx_GOTREF(__pyx_v_self->_size);
     __Pyx_DECREF(__pyx_v_self->_size);
     __pyx_v_self->_size = __pyx_v_result;
 
-    /* "View.MemoryView":591
+    /* "View.MemoryView":597
  *     @property
  *     def size(self):
  *         if self._size is None:             # <<<<<<<<<<<<<<
  *             result = 1
  * 
  */
   }
 
-  /* "View.MemoryView":599
+  /* "View.MemoryView":605
  *             self._size = result
  * 
  *         return self._size             # <<<<<<<<<<<<<<
  * 
  *     def __len__(self):
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(__pyx_v_self->_size);
   __pyx_r = __pyx_v_self->_size;
   goto __pyx_L0;
 
-  /* "View.MemoryView":590
+  /* "View.MemoryView":596
  * 
  *     @property
  *     def size(self):             # <<<<<<<<<<<<<<
  *         if self._size is None:
  *             result = 1
  */
 
@@ -24812,15 +26582,15 @@
   __Pyx_XDECREF(__pyx_v_result);
   __Pyx_XDECREF(__pyx_v_length);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":601
+/* "View.MemoryView":607
  *         return self._size
  * 
  *     def __len__(self):             # <<<<<<<<<<<<<<
  *         if self.view.ndim >= 1:
  *             return self.view.shape[0]
  */
 
@@ -24839,68 +26609,68 @@
 
 static Py_ssize_t __pyx_memoryview___pyx_pf_15View_dot_MemoryView_10memoryview_10__len__(struct __pyx_memoryview_obj *__pyx_v_self) {
   Py_ssize_t __pyx_r;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("__len__", 0);
 
-  /* "View.MemoryView":602
+  /* "View.MemoryView":608
  * 
  *     def __len__(self):
  *         if self.view.ndim >= 1:             # <<<<<<<<<<<<<<
  *             return self.view.shape[0]
  * 
  */
   __pyx_t_1 = ((__pyx_v_self->view.ndim >= 1) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":603
+    /* "View.MemoryView":609
  *     def __len__(self):
  *         if self.view.ndim >= 1:
  *             return self.view.shape[0]             # <<<<<<<<<<<<<<
  * 
  *         return 0
  */
     __pyx_r = (__pyx_v_self->view.shape[0]);
     goto __pyx_L0;
 
-    /* "View.MemoryView":602
+    /* "View.MemoryView":608
  * 
  *     def __len__(self):
  *         if self.view.ndim >= 1:             # <<<<<<<<<<<<<<
  *             return self.view.shape[0]
  * 
  */
   }
 
-  /* "View.MemoryView":605
+  /* "View.MemoryView":611
  *             return self.view.shape[0]
  * 
  *         return 0             # <<<<<<<<<<<<<<
  * 
  *     def __repr__(self):
  */
   __pyx_r = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":601
+  /* "View.MemoryView":607
  *         return self._size
  * 
  *     def __len__(self):             # <<<<<<<<<<<<<<
  *         if self.view.ndim >= 1:
  *             return self.view.shape[0]
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":607
+/* "View.MemoryView":613
  *         return 0
  * 
  *     def __repr__(self):             # <<<<<<<<<<<<<<
  *         return "<MemoryView of %r at 0x%x>" % (self.base.__class__.__name__,
  *                                                id(self))
  */
 
@@ -24919,66 +26689,69 @@
 
 static PyObject *__pyx_memoryview___pyx_pf_15View_dot_MemoryView_10memoryview_12__repr__(struct __pyx_memoryview_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__repr__", 0);
 
-  /* "View.MemoryView":608
+  /* "View.MemoryView":614
  * 
  *     def __repr__(self):
  *         return "<MemoryView of %r at 0x%x>" % (self.base.__class__.__name__,             # <<<<<<<<<<<<<<
  *                                                id(self))
  * 
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_base); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 608, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_base); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 614, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_class); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 608, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_class); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 614, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_name_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 608, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_name_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 614, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "View.MemoryView":609
+  /* "View.MemoryView":615
  *     def __repr__(self):
  *         return "<MemoryView of %r at 0x%x>" % (self.base.__class__.__name__,
  *                                                id(self))             # <<<<<<<<<<<<<<
  * 
  *     def __str__(self):
  */
-  __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_builtin_id, ((PyObject *)__pyx_v_self)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 609, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_CallOneArg(__pyx_builtin_id, ((PyObject *)__pyx_v_self)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 615, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
 
-  /* "View.MemoryView":608
+  /* "View.MemoryView":614
  * 
  *     def __repr__(self):
  *         return "<MemoryView of %r at 0x%x>" % (self.base.__class__.__name__,             # <<<<<<<<<<<<<<
  *                                                id(self))
  * 
  */
-  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 608, __pyx_L1_error)
+  __pyx_t_3 = PyTuple_New(2); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 614, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_2);
   PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_2);
   __pyx_t_1 = 0;
   __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyString_Format(__pyx_kp_s_MemoryView_of_r_at_0x_x, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 608, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyString_Format(__pyx_kp_s_MemoryView_of_r_at_0x_x, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 614, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __pyx_r = __pyx_t_2;
   __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":607
+  /* "View.MemoryView":613
  *         return 0
  * 
  *     def __repr__(self):             # <<<<<<<<<<<<<<
  *         return "<MemoryView of %r at 0x%x>" % (self.base.__class__.__name__,
  *                                                id(self))
  */
 
@@ -24991,15 +26764,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":611
+/* "View.MemoryView":617
  *                                                id(self))
  * 
  *     def __str__(self):             # <<<<<<<<<<<<<<
  *         return "<MemoryView of %r object>" % (self.base.__class__.__name__,)
  * 
  */
 
@@ -25017,45 +26790,48 @@
 }
 
 static PyObject *__pyx_memoryview___pyx_pf_15View_dot_MemoryView_10memoryview_14__str__(struct __pyx_memoryview_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__str__", 0);
 
-  /* "View.MemoryView":612
+  /* "View.MemoryView":618
  * 
  *     def __str__(self):
  *         return "<MemoryView of %r object>" % (self.base.__class__.__name__,)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_base); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 612, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_base); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 618, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_class); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 612, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_class); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 618, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_name_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 612, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_name_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 618, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 612, __pyx_L1_error)
+  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 618, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_1);
   __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyString_Format(__pyx_kp_s_MemoryView_of_r_object, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 612, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyString_Format(__pyx_kp_s_MemoryView_of_r_object, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 618, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":611
+  /* "View.MemoryView":617
  *                                                id(self))
  * 
  *     def __str__(self):             # <<<<<<<<<<<<<<
  *         return "<MemoryView of %r object>" % (self.base.__class__.__name__,)
  * 
  */
 
@@ -25067,15 +26843,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":615
+/* "View.MemoryView":621
  * 
  * 
  *     def is_c_contig(self):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice *mslice
  *         cdef __Pyx_memviewslice tmp
  */
 
@@ -25093,60 +26869,65 @@
 }
 
 static PyObject *__pyx_memoryview___pyx_pf_15View_dot_MemoryView_10memoryview_16is_c_contig(struct __pyx_memoryview_obj *__pyx_v_self) {
   __Pyx_memviewslice *__pyx_v_mslice;
   __Pyx_memviewslice __pyx_v_tmp;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
+  __Pyx_memviewslice *__pyx_t_1;
+  PyObject *__pyx_t_2 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("is_c_contig", 0);
 
-  /* "View.MemoryView":618
+  /* "View.MemoryView":624
  *         cdef __Pyx_memviewslice *mslice
  *         cdef __Pyx_memviewslice tmp
  *         mslice = get_slice_from_memview(self, &tmp)             # <<<<<<<<<<<<<<
  *         return slice_is_contig(mslice[0], 'C', self.view.ndim)
  * 
  */
-  __pyx_v_mslice = __pyx_memoryview_get_slice_from_memoryview(__pyx_v_self, (&__pyx_v_tmp));
+  __pyx_t_1 = __pyx_memoryview_get_slice_from_memoryview(__pyx_v_self, (&__pyx_v_tmp)); if (unlikely(__pyx_t_1 == ((__Pyx_memviewslice *)NULL))) __PYX_ERR(1, 624, __pyx_L1_error)
+  __pyx_v_mslice = __pyx_t_1;
 
-  /* "View.MemoryView":619
+  /* "View.MemoryView":625
  *         cdef __Pyx_memviewslice tmp
  *         mslice = get_slice_from_memview(self, &tmp)
  *         return slice_is_contig(mslice[0], 'C', self.view.ndim)             # <<<<<<<<<<<<<<
  * 
  *     def is_f_contig(self):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyBool_FromLong(__pyx_memviewslice_is_contig((__pyx_v_mslice[0]), 'C', __pyx_v_self->view.ndim)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 619, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_r = __pyx_t_1;
-  __pyx_t_1 = 0;
+  __pyx_t_2 = __Pyx_PyBool_FromLong(__pyx_memviewslice_is_contig((__pyx_v_mslice[0]), 'C', __pyx_v_self->view.ndim)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 625, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_r = __pyx_t_2;
+  __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":615
+  /* "View.MemoryView":621
  * 
  * 
  *     def is_c_contig(self):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice *mslice
  *         cdef __Pyx_memviewslice tmp
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_2);
   __Pyx_AddTraceback("View.MemoryView.memoryview.is_c_contig", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":621
+/* "View.MemoryView":627
  *         return slice_is_contig(mslice[0], 'C', self.view.ndim)
  * 
  *     def is_f_contig(self):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice *mslice
  *         cdef __Pyx_memviewslice tmp
  */
 
@@ -25164,60 +26945,65 @@
 }
 
 static PyObject *__pyx_memoryview___pyx_pf_15View_dot_MemoryView_10memoryview_18is_f_contig(struct __pyx_memoryview_obj *__pyx_v_self) {
   __Pyx_memviewslice *__pyx_v_mslice;
   __Pyx_memviewslice __pyx_v_tmp;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
+  __Pyx_memviewslice *__pyx_t_1;
+  PyObject *__pyx_t_2 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("is_f_contig", 0);
 
-  /* "View.MemoryView":624
+  /* "View.MemoryView":630
  *         cdef __Pyx_memviewslice *mslice
  *         cdef __Pyx_memviewslice tmp
  *         mslice = get_slice_from_memview(self, &tmp)             # <<<<<<<<<<<<<<
  *         return slice_is_contig(mslice[0], 'F', self.view.ndim)
  * 
  */
-  __pyx_v_mslice = __pyx_memoryview_get_slice_from_memoryview(__pyx_v_self, (&__pyx_v_tmp));
+  __pyx_t_1 = __pyx_memoryview_get_slice_from_memoryview(__pyx_v_self, (&__pyx_v_tmp)); if (unlikely(__pyx_t_1 == ((__Pyx_memviewslice *)NULL))) __PYX_ERR(1, 630, __pyx_L1_error)
+  __pyx_v_mslice = __pyx_t_1;
 
-  /* "View.MemoryView":625
+  /* "View.MemoryView":631
  *         cdef __Pyx_memviewslice tmp
  *         mslice = get_slice_from_memview(self, &tmp)
  *         return slice_is_contig(mslice[0], 'F', self.view.ndim)             # <<<<<<<<<<<<<<
  * 
  *     def copy(self):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __Pyx_PyBool_FromLong(__pyx_memviewslice_is_contig((__pyx_v_mslice[0]), 'F', __pyx_v_self->view.ndim)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 625, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_r = __pyx_t_1;
-  __pyx_t_1 = 0;
+  __pyx_t_2 = __Pyx_PyBool_FromLong(__pyx_memviewslice_is_contig((__pyx_v_mslice[0]), 'F', __pyx_v_self->view.ndim)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 631, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_r = __pyx_t_2;
+  __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":621
+  /* "View.MemoryView":627
  *         return slice_is_contig(mslice[0], 'C', self.view.ndim)
  * 
  *     def is_f_contig(self):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice *mslice
  *         cdef __Pyx_memviewslice tmp
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_2);
   __Pyx_AddTraceback("View.MemoryView.memoryview.is_f_contig", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":627
+/* "View.MemoryView":633
  *         return slice_is_contig(mslice[0], 'F', self.view.ndim)
  * 
  *     def copy(self):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice mslice
  *         cdef int flags = self.flags & ~PyBUF_F_CONTIGUOUS
  */
 
@@ -25237,59 +27023,62 @@
 static PyObject *__pyx_memoryview___pyx_pf_15View_dot_MemoryView_10memoryview_20copy(struct __pyx_memoryview_obj *__pyx_v_self) {
   __Pyx_memviewslice __pyx_v_mslice;
   int __pyx_v_flags;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   __Pyx_memviewslice __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("copy", 0);
 
-  /* "View.MemoryView":629
+  /* "View.MemoryView":635
  *     def copy(self):
  *         cdef __Pyx_memviewslice mslice
  *         cdef int flags = self.flags & ~PyBUF_F_CONTIGUOUS             # <<<<<<<<<<<<<<
  * 
  *         slice_copy(self, &mslice)
  */
   __pyx_v_flags = (__pyx_v_self->flags & (~PyBUF_F_CONTIGUOUS));
 
-  /* "View.MemoryView":631
+  /* "View.MemoryView":637
  *         cdef int flags = self.flags & ~PyBUF_F_CONTIGUOUS
  * 
  *         slice_copy(self, &mslice)             # <<<<<<<<<<<<<<
  *         mslice = slice_copy_contig(&mslice, "c", self.view.ndim,
  *                                    self.view.itemsize,
  */
   __pyx_memoryview_slice_copy(__pyx_v_self, (&__pyx_v_mslice));
 
-  /* "View.MemoryView":632
+  /* "View.MemoryView":638
  * 
  *         slice_copy(self, &mslice)
  *         mslice = slice_copy_contig(&mslice, "c", self.view.ndim,             # <<<<<<<<<<<<<<
  *                                    self.view.itemsize,
  *                                    flags|PyBUF_C_CONTIGUOUS,
  */
-  __pyx_t_1 = __pyx_memoryview_copy_new_contig((&__pyx_v_mslice), ((char *)"c"), __pyx_v_self->view.ndim, __pyx_v_self->view.itemsize, (__pyx_v_flags | PyBUF_C_CONTIGUOUS), __pyx_v_self->dtype_is_object); if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 632, __pyx_L1_error)
+  __pyx_t_1 = __pyx_memoryview_copy_new_contig((&__pyx_v_mslice), ((char *)"c"), __pyx_v_self->view.ndim, __pyx_v_self->view.itemsize, (__pyx_v_flags | PyBUF_C_CONTIGUOUS), __pyx_v_self->dtype_is_object); if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 638, __pyx_L1_error)
   __pyx_v_mslice = __pyx_t_1;
 
-  /* "View.MemoryView":637
+  /* "View.MemoryView":643
  *                                    self.dtype_is_object)
  * 
  *         return memoryview_copy_from_slice(self, &mslice)             # <<<<<<<<<<<<<<
  * 
  *     def copy_fortran(self):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_2 = __pyx_memoryview_copy_object_from_slice(__pyx_v_self, (&__pyx_v_mslice)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 637, __pyx_L1_error)
+  __pyx_t_2 = __pyx_memoryview_copy_object_from_slice(__pyx_v_self, (&__pyx_v_mslice)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 643, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __pyx_r = __pyx_t_2;
   __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":627
+  /* "View.MemoryView":633
  *         return slice_is_contig(mslice[0], 'F', self.view.ndim)
  * 
  *     def copy(self):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice mslice
  *         cdef int flags = self.flags & ~PyBUF_F_CONTIGUOUS
  */
 
@@ -25300,15 +27089,15 @@
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":639
+/* "View.MemoryView":645
  *         return memoryview_copy_from_slice(self, &mslice)
  * 
  *     def copy_fortran(self):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice src, dst
  *         cdef int flags = self.flags & ~PyBUF_C_CONTIGUOUS
  */
 
@@ -25329,59 +27118,62 @@
   __Pyx_memviewslice __pyx_v_src;
   __Pyx_memviewslice __pyx_v_dst;
   int __pyx_v_flags;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   __Pyx_memviewslice __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("copy_fortran", 0);
 
-  /* "View.MemoryView":641
+  /* "View.MemoryView":647
  *     def copy_fortran(self):
  *         cdef __Pyx_memviewslice src, dst
  *         cdef int flags = self.flags & ~PyBUF_C_CONTIGUOUS             # <<<<<<<<<<<<<<
  * 
  *         slice_copy(self, &src)
  */
   __pyx_v_flags = (__pyx_v_self->flags & (~PyBUF_C_CONTIGUOUS));
 
-  /* "View.MemoryView":643
+  /* "View.MemoryView":649
  *         cdef int flags = self.flags & ~PyBUF_C_CONTIGUOUS
  * 
  *         slice_copy(self, &src)             # <<<<<<<<<<<<<<
  *         dst = slice_copy_contig(&src, "fortran", self.view.ndim,
  *                                 self.view.itemsize,
  */
   __pyx_memoryview_slice_copy(__pyx_v_self, (&__pyx_v_src));
 
-  /* "View.MemoryView":644
+  /* "View.MemoryView":650
  * 
  *         slice_copy(self, &src)
  *         dst = slice_copy_contig(&src, "fortran", self.view.ndim,             # <<<<<<<<<<<<<<
  *                                 self.view.itemsize,
  *                                 flags|PyBUF_F_CONTIGUOUS,
  */
-  __pyx_t_1 = __pyx_memoryview_copy_new_contig((&__pyx_v_src), ((char *)"fortran"), __pyx_v_self->view.ndim, __pyx_v_self->view.itemsize, (__pyx_v_flags | PyBUF_F_CONTIGUOUS), __pyx_v_self->dtype_is_object); if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 644, __pyx_L1_error)
+  __pyx_t_1 = __pyx_memoryview_copy_new_contig((&__pyx_v_src), ((char *)"fortran"), __pyx_v_self->view.ndim, __pyx_v_self->view.itemsize, (__pyx_v_flags | PyBUF_F_CONTIGUOUS), __pyx_v_self->dtype_is_object); if (unlikely(PyErr_Occurred())) __PYX_ERR(1, 650, __pyx_L1_error)
   __pyx_v_dst = __pyx_t_1;
 
-  /* "View.MemoryView":649
+  /* "View.MemoryView":655
  *                                 self.dtype_is_object)
  * 
  *         return memoryview_copy_from_slice(self, &dst)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_2 = __pyx_memoryview_copy_object_from_slice(__pyx_v_self, (&__pyx_v_dst)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 649, __pyx_L1_error)
+  __pyx_t_2 = __pyx_memoryview_copy_object_from_slice(__pyx_v_self, (&__pyx_v_dst)); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 655, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __pyx_r = __pyx_t_2;
   __pyx_t_2 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":639
+  /* "View.MemoryView":645
  *         return memoryview_copy_from_slice(self, &mslice)
  * 
  *     def copy_fortran(self):             # <<<<<<<<<<<<<<
  *         cdef __Pyx_memviewslice src, dst
  *         cdef int flags = self.flags & ~PyBUF_C_CONTIGUOUS
  */
 
@@ -25415,14 +27207,17 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf___pyx_memoryview___reduce_cython__(CYTHON_UNUSED struct __pyx_memoryview_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__reduce_cython__", 0);
 
   /* "(tree fragment)":2
  * def __reduce_cython__(self):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
@@ -25469,14 +27264,17 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf___pyx_memoryview_2__setstate_cython__(CYTHON_UNUSED struct __pyx_memoryview_obj *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setstate_cython__", 0);
 
   /* "(tree fragment)":4
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  */
@@ -25499,81 +27297,84 @@
   __Pyx_AddTraceback("View.MemoryView.memoryview.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":653
+/* "View.MemoryView":659
  * 
  * @cname('__pyx_memoryview_new')
  * cdef memoryview_cwrapper(object o, int flags, bint dtype_is_object, __Pyx_TypeInfo *typeinfo):             # <<<<<<<<<<<<<<
  *     cdef memoryview result = memoryview(o, flags, dtype_is_object)
  *     result.typeinfo = typeinfo
  */
 
 static PyObject *__pyx_memoryview_new(PyObject *__pyx_v_o, int __pyx_v_flags, int __pyx_v_dtype_is_object, __Pyx_TypeInfo *__pyx_v_typeinfo) {
   struct __pyx_memoryview_obj *__pyx_v_result = 0;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("memoryview_cwrapper", 0);
 
-  /* "View.MemoryView":654
+  /* "View.MemoryView":660
  * @cname('__pyx_memoryview_new')
  * cdef memoryview_cwrapper(object o, int flags, bint dtype_is_object, __Pyx_TypeInfo *typeinfo):
  *     cdef memoryview result = memoryview(o, flags, dtype_is_object)             # <<<<<<<<<<<<<<
  *     result.typeinfo = typeinfo
  *     return result
  */
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_flags); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 654, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_flags); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 660, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyBool_FromLong(__pyx_v_dtype_is_object); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 654, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyBool_FromLong(__pyx_v_dtype_is_object); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 660, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 654, __pyx_L1_error)
+  __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 660, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_INCREF(__pyx_v_o);
   __Pyx_GIVEREF(__pyx_v_o);
   PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_v_o);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_2);
   PyTuple_SET_ITEM(__pyx_t_3, 2, __pyx_t_2);
   __pyx_t_1 = 0;
   __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)__pyx_memoryview_type), __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 654, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)__pyx_memoryview_type), __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 660, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __pyx_v_result = ((struct __pyx_memoryview_obj *)__pyx_t_2);
   __pyx_t_2 = 0;
 
-  /* "View.MemoryView":655
+  /* "View.MemoryView":661
  * cdef memoryview_cwrapper(object o, int flags, bint dtype_is_object, __Pyx_TypeInfo *typeinfo):
  *     cdef memoryview result = memoryview(o, flags, dtype_is_object)
  *     result.typeinfo = typeinfo             # <<<<<<<<<<<<<<
  *     return result
  * 
  */
   __pyx_v_result->typeinfo = __pyx_v_typeinfo;
 
-  /* "View.MemoryView":656
+  /* "View.MemoryView":662
  *     cdef memoryview result = memoryview(o, flags, dtype_is_object)
  *     result.typeinfo = typeinfo
  *     return result             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_check')
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(((PyObject *)__pyx_v_result));
   __pyx_r = ((PyObject *)__pyx_v_result);
   goto __pyx_L0;
 
-  /* "View.MemoryView":653
+  /* "View.MemoryView":659
  * 
  * @cname('__pyx_memoryview_new')
  * cdef memoryview_cwrapper(object o, int flags, bint dtype_is_object, __Pyx_TypeInfo *typeinfo):             # <<<<<<<<<<<<<<
  *     cdef memoryview result = memoryview(o, flags, dtype_is_object)
  *     result.typeinfo = typeinfo
  */
 
@@ -25587,54 +27388,54 @@
   __pyx_L0:;
   __Pyx_XDECREF((PyObject *)__pyx_v_result);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":659
+/* "View.MemoryView":665
  * 
  * @cname('__pyx_memoryview_check')
  * cdef inline bint memoryview_check(object o):             # <<<<<<<<<<<<<<
  *     return isinstance(o, memoryview)
  * 
  */
 
 static CYTHON_INLINE int __pyx_memoryview_check(PyObject *__pyx_v_o) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   __Pyx_RefNannySetupContext("memoryview_check", 0);
 
-  /* "View.MemoryView":660
+  /* "View.MemoryView":666
  * @cname('__pyx_memoryview_check')
  * cdef inline bint memoryview_check(object o):
  *     return isinstance(o, memoryview)             # <<<<<<<<<<<<<<
  * 
  * cdef tuple _unellipsify(object index, int ndim):
  */
   __pyx_t_1 = __Pyx_TypeCheck(__pyx_v_o, __pyx_memoryview_type); 
   __pyx_r = __pyx_t_1;
   goto __pyx_L0;
 
-  /* "View.MemoryView":659
+  /* "View.MemoryView":665
  * 
  * @cname('__pyx_memoryview_check')
  * cdef inline bint memoryview_check(object o):             # <<<<<<<<<<<<<<
  *     return isinstance(o, memoryview)
  * 
  */
 
   /* function exit code */
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":662
+/* "View.MemoryView":668
  *     return isinstance(o, memoryview)
  * 
  * cdef tuple _unellipsify(object index, int ndim):             # <<<<<<<<<<<<<<
  *     """
  *     Replace all ellipses with full slices and fill incomplete indices with
  */
 
@@ -25655,245 +27456,248 @@
   Py_ssize_t __pyx_t_5;
   PyObject *(*__pyx_t_6)(PyObject *);
   PyObject *__pyx_t_7 = NULL;
   Py_ssize_t __pyx_t_8;
   int __pyx_t_9;
   int __pyx_t_10;
   PyObject *__pyx_t_11 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("_unellipsify", 0);
 
-  /* "View.MemoryView":667
+  /* "View.MemoryView":673
  *     full slices.
  *     """
  *     if not isinstance(index, tuple):             # <<<<<<<<<<<<<<
  *         tup = (index,)
  *     else:
  */
   __pyx_t_1 = PyTuple_Check(__pyx_v_index); 
   __pyx_t_2 = ((!(__pyx_t_1 != 0)) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":668
+    /* "View.MemoryView":674
  *     """
  *     if not isinstance(index, tuple):
  *         tup = (index,)             # <<<<<<<<<<<<<<
  *     else:
  *         tup = index
  */
-    __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 668, __pyx_L1_error)
+    __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 674, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_INCREF(__pyx_v_index);
     __Pyx_GIVEREF(__pyx_v_index);
     PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_v_index);
     __pyx_v_tup = __pyx_t_3;
     __pyx_t_3 = 0;
 
-    /* "View.MemoryView":667
+    /* "View.MemoryView":673
  *     full slices.
  *     """
  *     if not isinstance(index, tuple):             # <<<<<<<<<<<<<<
  *         tup = (index,)
  *     else:
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":670
+  /* "View.MemoryView":676
  *         tup = (index,)
  *     else:
  *         tup = index             # <<<<<<<<<<<<<<
  * 
  *     result = []
  */
   /*else*/ {
     __Pyx_INCREF(__pyx_v_index);
     __pyx_v_tup = __pyx_v_index;
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":672
+  /* "View.MemoryView":678
  *         tup = index
  * 
  *     result = []             # <<<<<<<<<<<<<<
  *     have_slices = False
  *     seen_ellipsis = False
  */
-  __pyx_t_3 = PyList_New(0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 672, __pyx_L1_error)
+  __pyx_t_3 = PyList_New(0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 678, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __pyx_v_result = ((PyObject*)__pyx_t_3);
   __pyx_t_3 = 0;
 
-  /* "View.MemoryView":673
+  /* "View.MemoryView":679
  * 
  *     result = []
  *     have_slices = False             # <<<<<<<<<<<<<<
  *     seen_ellipsis = False
  *     for idx, item in enumerate(tup):
  */
   __pyx_v_have_slices = 0;
 
-  /* "View.MemoryView":674
+  /* "View.MemoryView":680
  *     result = []
  *     have_slices = False
  *     seen_ellipsis = False             # <<<<<<<<<<<<<<
  *     for idx, item in enumerate(tup):
  *         if item is Ellipsis:
  */
   __pyx_v_seen_ellipsis = 0;
 
-  /* "View.MemoryView":675
+  /* "View.MemoryView":681
  *     have_slices = False
  *     seen_ellipsis = False
  *     for idx, item in enumerate(tup):             # <<<<<<<<<<<<<<
  *         if item is Ellipsis:
  *             if not seen_ellipsis:
  */
   __Pyx_INCREF(__pyx_int_0);
   __pyx_t_3 = __pyx_int_0;
   if (likely(PyList_CheckExact(__pyx_v_tup)) || PyTuple_CheckExact(__pyx_v_tup)) {
     __pyx_t_4 = __pyx_v_tup; __Pyx_INCREF(__pyx_t_4); __pyx_t_5 = 0;
     __pyx_t_6 = NULL;
   } else {
-    __pyx_t_5 = -1; __pyx_t_4 = PyObject_GetIter(__pyx_v_tup); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 675, __pyx_L1_error)
+    __pyx_t_5 = -1; __pyx_t_4 = PyObject_GetIter(__pyx_v_tup); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 681, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_6 = Py_TYPE(__pyx_t_4)->tp_iternext; if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 675, __pyx_L1_error)
+    __pyx_t_6 = Py_TYPE(__pyx_t_4)->tp_iternext; if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 681, __pyx_L1_error)
   }
   for (;;) {
     if (likely(!__pyx_t_6)) {
       if (likely(PyList_CheckExact(__pyx_t_4))) {
         if (__pyx_t_5 >= PyList_GET_SIZE(__pyx_t_4)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_7 = PyList_GET_ITEM(__pyx_t_4, __pyx_t_5); __Pyx_INCREF(__pyx_t_7); __pyx_t_5++; if (unlikely(0 < 0)) __PYX_ERR(1, 675, __pyx_L1_error)
+        __pyx_t_7 = PyList_GET_ITEM(__pyx_t_4, __pyx_t_5); __Pyx_INCREF(__pyx_t_7); __pyx_t_5++; if (unlikely(0 < 0)) __PYX_ERR(1, 681, __pyx_L1_error)
         #else
-        __pyx_t_7 = PySequence_ITEM(__pyx_t_4, __pyx_t_5); __pyx_t_5++; if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 675, __pyx_L1_error)
+        __pyx_t_7 = PySequence_ITEM(__pyx_t_4, __pyx_t_5); __pyx_t_5++; if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 681, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
         #endif
       } else {
         if (__pyx_t_5 >= PyTuple_GET_SIZE(__pyx_t_4)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_7 = PyTuple_GET_ITEM(__pyx_t_4, __pyx_t_5); __Pyx_INCREF(__pyx_t_7); __pyx_t_5++; if (unlikely(0 < 0)) __PYX_ERR(1, 675, __pyx_L1_error)
+        __pyx_t_7 = PyTuple_GET_ITEM(__pyx_t_4, __pyx_t_5); __Pyx_INCREF(__pyx_t_7); __pyx_t_5++; if (unlikely(0 < 0)) __PYX_ERR(1, 681, __pyx_L1_error)
         #else
-        __pyx_t_7 = PySequence_ITEM(__pyx_t_4, __pyx_t_5); __pyx_t_5++; if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 675, __pyx_L1_error)
+        __pyx_t_7 = PySequence_ITEM(__pyx_t_4, __pyx_t_5); __pyx_t_5++; if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 681, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
         #endif
       }
     } else {
       __pyx_t_7 = __pyx_t_6(__pyx_t_4);
       if (unlikely(!__pyx_t_7)) {
         PyObject* exc_type = PyErr_Occurred();
         if (exc_type) {
           if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-          else __PYX_ERR(1, 675, __pyx_L1_error)
+          else __PYX_ERR(1, 681, __pyx_L1_error)
         }
         break;
       }
       __Pyx_GOTREF(__pyx_t_7);
     }
     __Pyx_XDECREF_SET(__pyx_v_item, __pyx_t_7);
     __pyx_t_7 = 0;
     __Pyx_INCREF(__pyx_t_3);
     __Pyx_XDECREF_SET(__pyx_v_idx, __pyx_t_3);
-    __pyx_t_7 = __Pyx_PyInt_AddObjC(__pyx_t_3, __pyx_int_1, 1, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 675, __pyx_L1_error)
+    __pyx_t_7 = __Pyx_PyInt_AddObjC(__pyx_t_3, __pyx_int_1, 1, 0, 0); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 681, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_7);
     __Pyx_DECREF(__pyx_t_3);
     __pyx_t_3 = __pyx_t_7;
     __pyx_t_7 = 0;
 
-    /* "View.MemoryView":676
+    /* "View.MemoryView":682
  *     seen_ellipsis = False
  *     for idx, item in enumerate(tup):
  *         if item is Ellipsis:             # <<<<<<<<<<<<<<
  *             if not seen_ellipsis:
  *                 result.extend([slice(None)] * (ndim - len(tup) + 1))
  */
     __pyx_t_2 = (__pyx_v_item == __pyx_builtin_Ellipsis);
     __pyx_t_1 = (__pyx_t_2 != 0);
     if (__pyx_t_1) {
 
-      /* "View.MemoryView":677
+      /* "View.MemoryView":683
  *     for idx, item in enumerate(tup):
  *         if item is Ellipsis:
  *             if not seen_ellipsis:             # <<<<<<<<<<<<<<
  *                 result.extend([slice(None)] * (ndim - len(tup) + 1))
  *                 seen_ellipsis = True
  */
       __pyx_t_1 = ((!(__pyx_v_seen_ellipsis != 0)) != 0);
       if (__pyx_t_1) {
 
-        /* "View.MemoryView":678
+        /* "View.MemoryView":684
  *         if item is Ellipsis:
  *             if not seen_ellipsis:
  *                 result.extend([slice(None)] * (ndim - len(tup) + 1))             # <<<<<<<<<<<<<<
  *                 seen_ellipsis = True
  *             else:
  */
-        __pyx_t_8 = PyObject_Length(__pyx_v_tup); if (unlikely(__pyx_t_8 == ((Py_ssize_t)-1))) __PYX_ERR(1, 678, __pyx_L1_error)
-        __pyx_t_7 = PyList_New(1 * ((((__pyx_v_ndim - __pyx_t_8) + 1)<0) ? 0:((__pyx_v_ndim - __pyx_t_8) + 1))); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 678, __pyx_L1_error)
+        __pyx_t_8 = PyObject_Length(__pyx_v_tup); if (unlikely(__pyx_t_8 == ((Py_ssize_t)-1))) __PYX_ERR(1, 684, __pyx_L1_error)
+        __pyx_t_7 = PyList_New(1 * ((((__pyx_v_ndim - __pyx_t_8) + 1)<0) ? 0:((__pyx_v_ndim - __pyx_t_8) + 1))); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 684, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
         { Py_ssize_t __pyx_temp;
           for (__pyx_temp=0; __pyx_temp < ((__pyx_v_ndim - __pyx_t_8) + 1); __pyx_temp++) {
             __Pyx_INCREF(__pyx_slice__27);
             __Pyx_GIVEREF(__pyx_slice__27);
             PyList_SET_ITEM(__pyx_t_7, __pyx_temp, __pyx_slice__27);
           }
         }
-        __pyx_t_9 = __Pyx_PyList_Extend(__pyx_v_result, __pyx_t_7); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 678, __pyx_L1_error)
+        __pyx_t_9 = __Pyx_PyList_Extend(__pyx_v_result, __pyx_t_7); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 684, __pyx_L1_error)
         __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
 
-        /* "View.MemoryView":679
+        /* "View.MemoryView":685
  *             if not seen_ellipsis:
  *                 result.extend([slice(None)] * (ndim - len(tup) + 1))
  *                 seen_ellipsis = True             # <<<<<<<<<<<<<<
  *             else:
  *                 result.append(slice(None))
  */
         __pyx_v_seen_ellipsis = 1;
 
-        /* "View.MemoryView":677
+        /* "View.MemoryView":683
  *     for idx, item in enumerate(tup):
  *         if item is Ellipsis:
  *             if not seen_ellipsis:             # <<<<<<<<<<<<<<
  *                 result.extend([slice(None)] * (ndim - len(tup) + 1))
  *                 seen_ellipsis = True
  */
         goto __pyx_L7;
       }
 
-      /* "View.MemoryView":681
+      /* "View.MemoryView":687
  *                 seen_ellipsis = True
  *             else:
  *                 result.append(slice(None))             # <<<<<<<<<<<<<<
  *             have_slices = True
  *         else:
  */
       /*else*/ {
-        __pyx_t_9 = __Pyx_PyList_Append(__pyx_v_result, __pyx_slice__27); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 681, __pyx_L1_error)
+        __pyx_t_9 = __Pyx_PyList_Append(__pyx_v_result, __pyx_slice__27); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 687, __pyx_L1_error)
       }
       __pyx_L7:;
 
-      /* "View.MemoryView":682
+      /* "View.MemoryView":688
  *             else:
  *                 result.append(slice(None))
  *             have_slices = True             # <<<<<<<<<<<<<<
  *         else:
  *             if not isinstance(item, slice) and not PyIndex_Check(item):
  */
       __pyx_v_have_slices = 1;
 
-      /* "View.MemoryView":676
+      /* "View.MemoryView":682
  *     seen_ellipsis = False
  *     for idx, item in enumerate(tup):
  *         if item is Ellipsis:             # <<<<<<<<<<<<<<
  *             if not seen_ellipsis:
  *                 result.extend([slice(None)] * (ndim - len(tup) + 1))
  */
       goto __pyx_L6;
     }
 
-    /* "View.MemoryView":684
+    /* "View.MemoryView":690
  *             have_slices = True
  *         else:
  *             if not isinstance(item, slice) and not PyIndex_Check(item):             # <<<<<<<<<<<<<<
  *                 raise TypeError("Cannot index with type '%s'" % type(item))
  * 
  */
     /*else*/ {
@@ -25905,40 +27709,40 @@
         goto __pyx_L9_bool_binop_done;
       }
       __pyx_t_10 = ((!(PyIndex_Check(__pyx_v_item) != 0)) != 0);
       __pyx_t_1 = __pyx_t_10;
       __pyx_L9_bool_binop_done:;
       if (unlikely(__pyx_t_1)) {
 
-        /* "View.MemoryView":685
+        /* "View.MemoryView":691
  *         else:
  *             if not isinstance(item, slice) and not PyIndex_Check(item):
  *                 raise TypeError("Cannot index with type '%s'" % type(item))             # <<<<<<<<<<<<<<
  * 
  *             have_slices = have_slices or isinstance(item, slice)
  */
-        __pyx_t_7 = __Pyx_PyString_FormatSafe(__pyx_kp_s_Cannot_index_with_type_s, ((PyObject *)Py_TYPE(__pyx_v_item))); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 685, __pyx_L1_error)
+        __pyx_t_7 = __Pyx_PyString_FormatSafe(__pyx_kp_s_Cannot_index_with_type_s, ((PyObject *)Py_TYPE(__pyx_v_item))); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 691, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_7);
-        __pyx_t_11 = __Pyx_PyObject_CallOneArg(__pyx_builtin_TypeError, __pyx_t_7); if (unlikely(!__pyx_t_11)) __PYX_ERR(1, 685, __pyx_L1_error)
+        __pyx_t_11 = __Pyx_PyObject_CallOneArg(__pyx_builtin_TypeError, __pyx_t_7); if (unlikely(!__pyx_t_11)) __PYX_ERR(1, 691, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_11);
         __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
         __Pyx_Raise(__pyx_t_11, 0, 0, 0);
         __Pyx_DECREF(__pyx_t_11); __pyx_t_11 = 0;
-        __PYX_ERR(1, 685, __pyx_L1_error)
+        __PYX_ERR(1, 691, __pyx_L1_error)
 
-        /* "View.MemoryView":684
+        /* "View.MemoryView":690
  *             have_slices = True
  *         else:
  *             if not isinstance(item, slice) and not PyIndex_Check(item):             # <<<<<<<<<<<<<<
  *                 raise TypeError("Cannot index with type '%s'" % type(item))
  * 
  */
       }
 
-      /* "View.MemoryView":687
+      /* "View.MemoryView":693
  *                 raise TypeError("Cannot index with type '%s'" % type(item))
  * 
  *             have_slices = have_slices or isinstance(item, slice)             # <<<<<<<<<<<<<<
  *             result.append(item)
  * 
  */
       __pyx_t_10 = (__pyx_v_have_slices != 0);
@@ -25949,120 +27753,120 @@
       }
       __pyx_t_10 = PySlice_Check(__pyx_v_item); 
       __pyx_t_2 = (__pyx_t_10 != 0);
       __pyx_t_1 = __pyx_t_2;
       __pyx_L11_bool_binop_done:;
       __pyx_v_have_slices = __pyx_t_1;
 
-      /* "View.MemoryView":688
+      /* "View.MemoryView":694
  * 
  *             have_slices = have_slices or isinstance(item, slice)
  *             result.append(item)             # <<<<<<<<<<<<<<
  * 
  *     nslices = ndim - len(result)
  */
-      __pyx_t_9 = __Pyx_PyList_Append(__pyx_v_result, __pyx_v_item); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 688, __pyx_L1_error)
+      __pyx_t_9 = __Pyx_PyList_Append(__pyx_v_result, __pyx_v_item); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 694, __pyx_L1_error)
     }
     __pyx_L6:;
 
-    /* "View.MemoryView":675
+    /* "View.MemoryView":681
  *     have_slices = False
  *     seen_ellipsis = False
  *     for idx, item in enumerate(tup):             # <<<<<<<<<<<<<<
  *         if item is Ellipsis:
  *             if not seen_ellipsis:
  */
   }
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "View.MemoryView":690
+  /* "View.MemoryView":696
  *             result.append(item)
  * 
  *     nslices = ndim - len(result)             # <<<<<<<<<<<<<<
  *     if nslices:
  *         result.extend([slice(None)] * nslices)
  */
-  __pyx_t_5 = PyList_GET_SIZE(__pyx_v_result); if (unlikely(__pyx_t_5 == ((Py_ssize_t)-1))) __PYX_ERR(1, 690, __pyx_L1_error)
+  __pyx_t_5 = PyList_GET_SIZE(__pyx_v_result); if (unlikely(__pyx_t_5 == ((Py_ssize_t)-1))) __PYX_ERR(1, 696, __pyx_L1_error)
   __pyx_v_nslices = (__pyx_v_ndim - __pyx_t_5);
 
-  /* "View.MemoryView":691
+  /* "View.MemoryView":697
  * 
  *     nslices = ndim - len(result)
  *     if nslices:             # <<<<<<<<<<<<<<
  *         result.extend([slice(None)] * nslices)
  * 
  */
   __pyx_t_1 = (__pyx_v_nslices != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":692
+    /* "View.MemoryView":698
  *     nslices = ndim - len(result)
  *     if nslices:
  *         result.extend([slice(None)] * nslices)             # <<<<<<<<<<<<<<
  * 
  *     return have_slices or nslices, tuple(result)
  */
-    __pyx_t_3 = PyList_New(1 * ((__pyx_v_nslices<0) ? 0:__pyx_v_nslices)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 692, __pyx_L1_error)
+    __pyx_t_3 = PyList_New(1 * ((__pyx_v_nslices<0) ? 0:__pyx_v_nslices)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 698, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     { Py_ssize_t __pyx_temp;
       for (__pyx_temp=0; __pyx_temp < __pyx_v_nslices; __pyx_temp++) {
         __Pyx_INCREF(__pyx_slice__27);
         __Pyx_GIVEREF(__pyx_slice__27);
         PyList_SET_ITEM(__pyx_t_3, __pyx_temp, __pyx_slice__27);
       }
     }
-    __pyx_t_9 = __Pyx_PyList_Extend(__pyx_v_result, __pyx_t_3); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 692, __pyx_L1_error)
+    __pyx_t_9 = __Pyx_PyList_Extend(__pyx_v_result, __pyx_t_3); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 698, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-    /* "View.MemoryView":691
+    /* "View.MemoryView":697
  * 
  *     nslices = ndim - len(result)
  *     if nslices:             # <<<<<<<<<<<<<<
  *         result.extend([slice(None)] * nslices)
  * 
  */
   }
 
-  /* "View.MemoryView":694
+  /* "View.MemoryView":700
  *         result.extend([slice(None)] * nslices)
  * 
  *     return have_slices or nslices, tuple(result)             # <<<<<<<<<<<<<<
  * 
  * cdef assert_direct_dimensions(Py_ssize_t *suboffsets, int ndim):
  */
   __Pyx_XDECREF(__pyx_r);
   if (!__pyx_v_have_slices) {
   } else {
-    __pyx_t_4 = __Pyx_PyBool_FromLong(__pyx_v_have_slices); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 694, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyBool_FromLong(__pyx_v_have_slices); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 700, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __pyx_t_3 = __pyx_t_4;
     __pyx_t_4 = 0;
     goto __pyx_L14_bool_binop_done;
   }
-  __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_nslices); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 694, __pyx_L1_error)
+  __pyx_t_4 = PyInt_FromSsize_t(__pyx_v_nslices); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 700, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __pyx_t_3 = __pyx_t_4;
   __pyx_t_4 = 0;
   __pyx_L14_bool_binop_done:;
-  __pyx_t_4 = PyList_AsTuple(__pyx_v_result); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 694, __pyx_L1_error)
+  __pyx_t_4 = PyList_AsTuple(__pyx_v_result); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 700, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_11 = PyTuple_New(2); if (unlikely(!__pyx_t_11)) __PYX_ERR(1, 694, __pyx_L1_error)
+  __pyx_t_11 = PyTuple_New(2); if (unlikely(!__pyx_t_11)) __PYX_ERR(1, 700, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_11);
   __Pyx_GIVEREF(__pyx_t_3);
   PyTuple_SET_ITEM(__pyx_t_11, 0, __pyx_t_3);
   __Pyx_GIVEREF(__pyx_t_4);
   PyTuple_SET_ITEM(__pyx_t_11, 1, __pyx_t_4);
   __pyx_t_3 = 0;
   __pyx_t_4 = 0;
   __pyx_r = ((PyObject*)__pyx_t_11);
   __pyx_t_11 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":662
+  /* "View.MemoryView":668
  *     return isinstance(o, memoryview)
  * 
  * cdef tuple _unellipsify(object index, int ndim):             # <<<<<<<<<<<<<<
  *     """
  *     Replace all ellipses with full slices and fill incomplete indices with
  */
 
@@ -26080,15 +27884,15 @@
   __Pyx_XDECREF(__pyx_v_idx);
   __Pyx_XDECREF(__pyx_v_item);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":696
+/* "View.MemoryView":702
  *     return have_slices or nslices, tuple(result)
  * 
  * cdef assert_direct_dimensions(Py_ssize_t *suboffsets, int ndim):             # <<<<<<<<<<<<<<
  *     for suboffset in suboffsets[:ndim]:
  *         if suboffset >= 0:
  */
 
@@ -26097,62 +27901,65 @@
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   Py_ssize_t *__pyx_t_1;
   Py_ssize_t *__pyx_t_2;
   Py_ssize_t *__pyx_t_3;
   int __pyx_t_4;
   PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("assert_direct_dimensions", 0);
 
-  /* "View.MemoryView":697
+  /* "View.MemoryView":703
  * 
  * cdef assert_direct_dimensions(Py_ssize_t *suboffsets, int ndim):
  *     for suboffset in suboffsets[:ndim]:             # <<<<<<<<<<<<<<
  *         if suboffset >= 0:
  *             raise ValueError("Indirect dimensions not supported")
  */
   __pyx_t_2 = (__pyx_v_suboffsets + __pyx_v_ndim);
   for (__pyx_t_3 = __pyx_v_suboffsets; __pyx_t_3 < __pyx_t_2; __pyx_t_3++) {
     __pyx_t_1 = __pyx_t_3;
     __pyx_v_suboffset = (__pyx_t_1[0]);
 
-    /* "View.MemoryView":698
+    /* "View.MemoryView":704
  * cdef assert_direct_dimensions(Py_ssize_t *suboffsets, int ndim):
  *     for suboffset in suboffsets[:ndim]:
  *         if suboffset >= 0:             # <<<<<<<<<<<<<<
  *             raise ValueError("Indirect dimensions not supported")
  * 
  */
     __pyx_t_4 = ((__pyx_v_suboffset >= 0) != 0);
     if (unlikely(__pyx_t_4)) {
 
-      /* "View.MemoryView":699
+      /* "View.MemoryView":705
  *     for suboffset in suboffsets[:ndim]:
  *         if suboffset >= 0:
  *             raise ValueError("Indirect dimensions not supported")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__28, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 699, __pyx_L1_error)
+      __pyx_t_5 = __Pyx_PyObject_Call(__pyx_builtin_ValueError, __pyx_tuple__28, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 705, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
       __Pyx_Raise(__pyx_t_5, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __PYX_ERR(1, 699, __pyx_L1_error)
+      __PYX_ERR(1, 705, __pyx_L1_error)
 
-      /* "View.MemoryView":698
+      /* "View.MemoryView":704
  * cdef assert_direct_dimensions(Py_ssize_t *suboffsets, int ndim):
  *     for suboffset in suboffsets[:ndim]:
  *         if suboffset >= 0:             # <<<<<<<<<<<<<<
  *             raise ValueError("Indirect dimensions not supported")
  * 
  */
     }
   }
 
-  /* "View.MemoryView":696
+  /* "View.MemoryView":702
  *     return have_slices or nslices, tuple(result)
  * 
  * cdef assert_direct_dimensions(Py_ssize_t *suboffsets, int ndim):             # <<<<<<<<<<<<<<
  *     for suboffset in suboffsets[:ndim]:
  *         if suboffset >= 0:
  */
 
@@ -26165,15 +27972,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":706
+/* "View.MemoryView":712
  * 
  * @cname('__pyx_memview_slice')
  * cdef memoryview memview_slice(memoryview memview, object indices):             # <<<<<<<<<<<<<<
  *     cdef int new_ndim = 0, suboffset_dim = -1, dim
  *     cdef bint negative_step
  */
 
@@ -26204,531 +28011,534 @@
   int __pyx_t_6;
   Py_ssize_t __pyx_t_7;
   PyObject *(*__pyx_t_8)(PyObject *);
   PyObject *__pyx_t_9 = NULL;
   Py_ssize_t __pyx_t_10;
   int __pyx_t_11;
   Py_ssize_t __pyx_t_12;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("memview_slice", 0);
 
-  /* "View.MemoryView":707
+  /* "View.MemoryView":713
  * @cname('__pyx_memview_slice')
  * cdef memoryview memview_slice(memoryview memview, object indices):
  *     cdef int new_ndim = 0, suboffset_dim = -1, dim             # <<<<<<<<<<<<<<
  *     cdef bint negative_step
  *     cdef __Pyx_memviewslice src, dst
  */
   __pyx_v_new_ndim = 0;
   __pyx_v_suboffset_dim = -1;
 
-  /* "View.MemoryView":714
+  /* "View.MemoryView":720
  * 
  * 
  *     memset(&dst, 0, sizeof(dst))             # <<<<<<<<<<<<<<
  * 
  *     cdef _memoryviewslice memviewsliceobj
  */
   (void)(memset((&__pyx_v_dst), 0, (sizeof(__pyx_v_dst))));
 
-  /* "View.MemoryView":718
+  /* "View.MemoryView":724
  *     cdef _memoryviewslice memviewsliceobj
  * 
  *     assert memview.view.ndim > 0             # <<<<<<<<<<<<<<
  * 
  *     if isinstance(memview, _memoryviewslice):
  */
   #ifndef CYTHON_WITHOUT_ASSERTIONS
   if (unlikely(!Py_OptimizeFlag)) {
     if (unlikely(!((__pyx_v_memview->view.ndim > 0) != 0))) {
       PyErr_SetNone(PyExc_AssertionError);
-      __PYX_ERR(1, 718, __pyx_L1_error)
+      __PYX_ERR(1, 724, __pyx_L1_error)
     }
   }
   #endif
 
-  /* "View.MemoryView":720
+  /* "View.MemoryView":726
  *     assert memview.view.ndim > 0
  * 
  *     if isinstance(memview, _memoryviewslice):             # <<<<<<<<<<<<<<
  *         memviewsliceobj = memview
  *         p_src = &memviewsliceobj.from_slice
  */
   __pyx_t_1 = __Pyx_TypeCheck(((PyObject *)__pyx_v_memview), __pyx_memoryviewslice_type); 
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":721
+    /* "View.MemoryView":727
  * 
  *     if isinstance(memview, _memoryviewslice):
  *         memviewsliceobj = memview             # <<<<<<<<<<<<<<
  *         p_src = &memviewsliceobj.from_slice
  *     else:
  */
-    if (!(likely(((((PyObject *)__pyx_v_memview)) == Py_None) || likely(__Pyx_TypeTest(((PyObject *)__pyx_v_memview), __pyx_memoryviewslice_type))))) __PYX_ERR(1, 721, __pyx_L1_error)
+    if (!(likely(((((PyObject *)__pyx_v_memview)) == Py_None) || likely(__Pyx_TypeTest(((PyObject *)__pyx_v_memview), __pyx_memoryviewslice_type))))) __PYX_ERR(1, 727, __pyx_L1_error)
     __pyx_t_3 = ((PyObject *)__pyx_v_memview);
     __Pyx_INCREF(__pyx_t_3);
     __pyx_v_memviewsliceobj = ((struct __pyx_memoryviewslice_obj *)__pyx_t_3);
     __pyx_t_3 = 0;
 
-    /* "View.MemoryView":722
+    /* "View.MemoryView":728
  *     if isinstance(memview, _memoryviewslice):
  *         memviewsliceobj = memview
  *         p_src = &memviewsliceobj.from_slice             # <<<<<<<<<<<<<<
  *     else:
  *         slice_copy(memview, &src)
  */
     __pyx_v_p_src = (&__pyx_v_memviewsliceobj->from_slice);
 
-    /* "View.MemoryView":720
+    /* "View.MemoryView":726
  *     assert memview.view.ndim > 0
  * 
  *     if isinstance(memview, _memoryviewslice):             # <<<<<<<<<<<<<<
  *         memviewsliceobj = memview
  *         p_src = &memviewsliceobj.from_slice
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":724
+  /* "View.MemoryView":730
  *         p_src = &memviewsliceobj.from_slice
  *     else:
  *         slice_copy(memview, &src)             # <<<<<<<<<<<<<<
  *         p_src = &src
  * 
  */
   /*else*/ {
     __pyx_memoryview_slice_copy(__pyx_v_memview, (&__pyx_v_src));
 
-    /* "View.MemoryView":725
+    /* "View.MemoryView":731
  *     else:
  *         slice_copy(memview, &src)
  *         p_src = &src             # <<<<<<<<<<<<<<
  * 
  * 
  */
     __pyx_v_p_src = (&__pyx_v_src);
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":731
+  /* "View.MemoryView":737
  * 
  * 
  *     dst.memview = p_src.memview             # <<<<<<<<<<<<<<
  *     dst.data = p_src.data
  * 
  */
   __pyx_t_4 = __pyx_v_p_src->memview;
   __pyx_v_dst.memview = __pyx_t_4;
 
-  /* "View.MemoryView":732
+  /* "View.MemoryView":738
  * 
  *     dst.memview = p_src.memview
  *     dst.data = p_src.data             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_t_5 = __pyx_v_p_src->data;
   __pyx_v_dst.data = __pyx_t_5;
 
-  /* "View.MemoryView":737
+  /* "View.MemoryView":743
  * 
  * 
  *     cdef __Pyx_memviewslice *p_dst = &dst             # <<<<<<<<<<<<<<
  *     cdef int *p_suboffset_dim = &suboffset_dim
  *     cdef Py_ssize_t start, stop, step
  */
   __pyx_v_p_dst = (&__pyx_v_dst);
 
-  /* "View.MemoryView":738
+  /* "View.MemoryView":744
  * 
  *     cdef __Pyx_memviewslice *p_dst = &dst
  *     cdef int *p_suboffset_dim = &suboffset_dim             # <<<<<<<<<<<<<<
  *     cdef Py_ssize_t start, stop, step
  *     cdef bint have_start, have_stop, have_step
  */
   __pyx_v_p_suboffset_dim = (&__pyx_v_suboffset_dim);
 
-  /* "View.MemoryView":742
+  /* "View.MemoryView":748
  *     cdef bint have_start, have_stop, have_step
  * 
  *     for dim, index in enumerate(indices):             # <<<<<<<<<<<<<<
  *         if PyIndex_Check(index):
  *             slice_memviewslice(
  */
   __pyx_t_6 = 0;
   if (likely(PyList_CheckExact(__pyx_v_indices)) || PyTuple_CheckExact(__pyx_v_indices)) {
     __pyx_t_3 = __pyx_v_indices; __Pyx_INCREF(__pyx_t_3); __pyx_t_7 = 0;
     __pyx_t_8 = NULL;
   } else {
-    __pyx_t_7 = -1; __pyx_t_3 = PyObject_GetIter(__pyx_v_indices); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 742, __pyx_L1_error)
+    __pyx_t_7 = -1; __pyx_t_3 = PyObject_GetIter(__pyx_v_indices); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 748, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_8 = Py_TYPE(__pyx_t_3)->tp_iternext; if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 742, __pyx_L1_error)
+    __pyx_t_8 = Py_TYPE(__pyx_t_3)->tp_iternext; if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 748, __pyx_L1_error)
   }
   for (;;) {
     if (likely(!__pyx_t_8)) {
       if (likely(PyList_CheckExact(__pyx_t_3))) {
         if (__pyx_t_7 >= PyList_GET_SIZE(__pyx_t_3)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_9 = PyList_GET_ITEM(__pyx_t_3, __pyx_t_7); __Pyx_INCREF(__pyx_t_9); __pyx_t_7++; if (unlikely(0 < 0)) __PYX_ERR(1, 742, __pyx_L1_error)
+        __pyx_t_9 = PyList_GET_ITEM(__pyx_t_3, __pyx_t_7); __Pyx_INCREF(__pyx_t_9); __pyx_t_7++; if (unlikely(0 < 0)) __PYX_ERR(1, 748, __pyx_L1_error)
         #else
-        __pyx_t_9 = PySequence_ITEM(__pyx_t_3, __pyx_t_7); __pyx_t_7++; if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 742, __pyx_L1_error)
+        __pyx_t_9 = PySequence_ITEM(__pyx_t_3, __pyx_t_7); __pyx_t_7++; if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 748, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_9);
         #endif
       } else {
         if (__pyx_t_7 >= PyTuple_GET_SIZE(__pyx_t_3)) break;
         #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
-        __pyx_t_9 = PyTuple_GET_ITEM(__pyx_t_3, __pyx_t_7); __Pyx_INCREF(__pyx_t_9); __pyx_t_7++; if (unlikely(0 < 0)) __PYX_ERR(1, 742, __pyx_L1_error)
+        __pyx_t_9 = PyTuple_GET_ITEM(__pyx_t_3, __pyx_t_7); __Pyx_INCREF(__pyx_t_9); __pyx_t_7++; if (unlikely(0 < 0)) __PYX_ERR(1, 748, __pyx_L1_error)
         #else
-        __pyx_t_9 = PySequence_ITEM(__pyx_t_3, __pyx_t_7); __pyx_t_7++; if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 742, __pyx_L1_error)
+        __pyx_t_9 = PySequence_ITEM(__pyx_t_3, __pyx_t_7); __pyx_t_7++; if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 748, __pyx_L1_error)
         __Pyx_GOTREF(__pyx_t_9);
         #endif
       }
     } else {
       __pyx_t_9 = __pyx_t_8(__pyx_t_3);
       if (unlikely(!__pyx_t_9)) {
         PyObject* exc_type = PyErr_Occurred();
         if (exc_type) {
           if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) PyErr_Clear();
-          else __PYX_ERR(1, 742, __pyx_L1_error)
+          else __PYX_ERR(1, 748, __pyx_L1_error)
         }
         break;
       }
       __Pyx_GOTREF(__pyx_t_9);
     }
     __Pyx_XDECREF_SET(__pyx_v_index, __pyx_t_9);
     __pyx_t_9 = 0;
     __pyx_v_dim = __pyx_t_6;
     __pyx_t_6 = (__pyx_t_6 + 1);
 
-    /* "View.MemoryView":743
+    /* "View.MemoryView":749
  * 
  *     for dim, index in enumerate(indices):
  *         if PyIndex_Check(index):             # <<<<<<<<<<<<<<
  *             slice_memviewslice(
  *                 p_dst, p_src.shape[dim], p_src.strides[dim], p_src.suboffsets[dim],
  */
     __pyx_t_2 = (PyIndex_Check(__pyx_v_index) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":747
+      /* "View.MemoryView":753
  *                 p_dst, p_src.shape[dim], p_src.strides[dim], p_src.suboffsets[dim],
  *                 dim, new_ndim, p_suboffset_dim,
  *                 index, 0, 0, # start, stop, step             # <<<<<<<<<<<<<<
  *                 0, 0, 0, # have_{start,stop,step}
  *                 False)
  */
-      __pyx_t_10 = __Pyx_PyIndex_AsSsize_t(__pyx_v_index); if (unlikely((__pyx_t_10 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 747, __pyx_L1_error)
+      __pyx_t_10 = __Pyx_PyIndex_AsSsize_t(__pyx_v_index); if (unlikely((__pyx_t_10 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 753, __pyx_L1_error)
 
-      /* "View.MemoryView":744
+      /* "View.MemoryView":750
  *     for dim, index in enumerate(indices):
  *         if PyIndex_Check(index):
  *             slice_memviewslice(             # <<<<<<<<<<<<<<
  *                 p_dst, p_src.shape[dim], p_src.strides[dim], p_src.suboffsets[dim],
  *                 dim, new_ndim, p_suboffset_dim,
  */
-      __pyx_t_11 = __pyx_memoryview_slice_memviewslice(__pyx_v_p_dst, (__pyx_v_p_src->shape[__pyx_v_dim]), (__pyx_v_p_src->strides[__pyx_v_dim]), (__pyx_v_p_src->suboffsets[__pyx_v_dim]), __pyx_v_dim, __pyx_v_new_ndim, __pyx_v_p_suboffset_dim, __pyx_t_10, 0, 0, 0, 0, 0, 0); if (unlikely(__pyx_t_11 == ((int)-1))) __PYX_ERR(1, 744, __pyx_L1_error)
+      __pyx_t_11 = __pyx_memoryview_slice_memviewslice(__pyx_v_p_dst, (__pyx_v_p_src->shape[__pyx_v_dim]), (__pyx_v_p_src->strides[__pyx_v_dim]), (__pyx_v_p_src->suboffsets[__pyx_v_dim]), __pyx_v_dim, __pyx_v_new_ndim, __pyx_v_p_suboffset_dim, __pyx_t_10, 0, 0, 0, 0, 0, 0); if (unlikely(__pyx_t_11 == ((int)-1))) __PYX_ERR(1, 750, __pyx_L1_error)
 
-      /* "View.MemoryView":743
+      /* "View.MemoryView":749
  * 
  *     for dim, index in enumerate(indices):
  *         if PyIndex_Check(index):             # <<<<<<<<<<<<<<
  *             slice_memviewslice(
  *                 p_dst, p_src.shape[dim], p_src.strides[dim], p_src.suboffsets[dim],
  */
       goto __pyx_L6;
     }
 
-    /* "View.MemoryView":750
+    /* "View.MemoryView":756
  *                 0, 0, 0, # have_{start,stop,step}
  *                 False)
  *         elif index is None:             # <<<<<<<<<<<<<<
  *             p_dst.shape[new_ndim] = 1
  *             p_dst.strides[new_ndim] = 0
  */
     __pyx_t_2 = (__pyx_v_index == Py_None);
     __pyx_t_1 = (__pyx_t_2 != 0);
     if (__pyx_t_1) {
 
-      /* "View.MemoryView":751
+      /* "View.MemoryView":757
  *                 False)
  *         elif index is None:
  *             p_dst.shape[new_ndim] = 1             # <<<<<<<<<<<<<<
  *             p_dst.strides[new_ndim] = 0
  *             p_dst.suboffsets[new_ndim] = -1
  */
       (__pyx_v_p_dst->shape[__pyx_v_new_ndim]) = 1;
 
-      /* "View.MemoryView":752
+      /* "View.MemoryView":758
  *         elif index is None:
  *             p_dst.shape[new_ndim] = 1
  *             p_dst.strides[new_ndim] = 0             # <<<<<<<<<<<<<<
  *             p_dst.suboffsets[new_ndim] = -1
  *             new_ndim += 1
  */
       (__pyx_v_p_dst->strides[__pyx_v_new_ndim]) = 0;
 
-      /* "View.MemoryView":753
+      /* "View.MemoryView":759
  *             p_dst.shape[new_ndim] = 1
  *             p_dst.strides[new_ndim] = 0
  *             p_dst.suboffsets[new_ndim] = -1             # <<<<<<<<<<<<<<
  *             new_ndim += 1
  *         else:
  */
       (__pyx_v_p_dst->suboffsets[__pyx_v_new_ndim]) = -1L;
 
-      /* "View.MemoryView":754
+      /* "View.MemoryView":760
  *             p_dst.strides[new_ndim] = 0
  *             p_dst.suboffsets[new_ndim] = -1
  *             new_ndim += 1             # <<<<<<<<<<<<<<
  *         else:
  *             start = index.start or 0
  */
       __pyx_v_new_ndim = (__pyx_v_new_ndim + 1);
 
-      /* "View.MemoryView":750
+      /* "View.MemoryView":756
  *                 0, 0, 0, # have_{start,stop,step}
  *                 False)
  *         elif index is None:             # <<<<<<<<<<<<<<
  *             p_dst.shape[new_ndim] = 1
  *             p_dst.strides[new_ndim] = 0
  */
       goto __pyx_L6;
     }
 
-    /* "View.MemoryView":756
+    /* "View.MemoryView":762
  *             new_ndim += 1
  *         else:
  *             start = index.start or 0             # <<<<<<<<<<<<<<
  *             stop = index.stop or 0
  *             step = index.step or 0
  */
     /*else*/ {
-      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_start); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 756, __pyx_L1_error)
+      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_start); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 762, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 756, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 762, __pyx_L1_error)
       if (!__pyx_t_1) {
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       } else {
-        __pyx_t_12 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_12 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 756, __pyx_L1_error)
+        __pyx_t_12 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_12 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 762, __pyx_L1_error)
         __pyx_t_10 = __pyx_t_12;
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
         goto __pyx_L7_bool_binop_done;
       }
       __pyx_t_10 = 0;
       __pyx_L7_bool_binop_done:;
       __pyx_v_start = __pyx_t_10;
 
-      /* "View.MemoryView":757
+      /* "View.MemoryView":763
  *         else:
  *             start = index.start or 0
  *             stop = index.stop or 0             # <<<<<<<<<<<<<<
  *             step = index.step or 0
  * 
  */
-      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_stop); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 757, __pyx_L1_error)
+      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_stop); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 763, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 757, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 763, __pyx_L1_error)
       if (!__pyx_t_1) {
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       } else {
-        __pyx_t_12 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_12 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 757, __pyx_L1_error)
+        __pyx_t_12 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_12 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 763, __pyx_L1_error)
         __pyx_t_10 = __pyx_t_12;
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
         goto __pyx_L9_bool_binop_done;
       }
       __pyx_t_10 = 0;
       __pyx_L9_bool_binop_done:;
       __pyx_v_stop = __pyx_t_10;
 
-      /* "View.MemoryView":758
+      /* "View.MemoryView":764
  *             start = index.start or 0
  *             stop = index.stop or 0
  *             step = index.step or 0             # <<<<<<<<<<<<<<
  * 
  *             have_start = index.start is not None
  */
-      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_step); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 758, __pyx_L1_error)
+      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_step); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 764, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
-      __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 758, __pyx_L1_error)
+      __pyx_t_1 = __Pyx_PyObject_IsTrue(__pyx_t_9); if (unlikely(__pyx_t_1 < 0)) __PYX_ERR(1, 764, __pyx_L1_error)
       if (!__pyx_t_1) {
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       } else {
-        __pyx_t_12 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_12 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 758, __pyx_L1_error)
+        __pyx_t_12 = __Pyx_PyIndex_AsSsize_t(__pyx_t_9); if (unlikely((__pyx_t_12 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 764, __pyx_L1_error)
         __pyx_t_10 = __pyx_t_12;
         __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
         goto __pyx_L11_bool_binop_done;
       }
       __pyx_t_10 = 0;
       __pyx_L11_bool_binop_done:;
       __pyx_v_step = __pyx_t_10;
 
-      /* "View.MemoryView":760
+      /* "View.MemoryView":766
  *             step = index.step or 0
  * 
  *             have_start = index.start is not None             # <<<<<<<<<<<<<<
  *             have_stop = index.stop is not None
  *             have_step = index.step is not None
  */
-      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_start); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 760, __pyx_L1_error)
+      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_start); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 766, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
       __pyx_t_1 = (__pyx_t_9 != Py_None);
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       __pyx_v_have_start = __pyx_t_1;
 
-      /* "View.MemoryView":761
+      /* "View.MemoryView":767
  * 
  *             have_start = index.start is not None
  *             have_stop = index.stop is not None             # <<<<<<<<<<<<<<
  *             have_step = index.step is not None
  * 
  */
-      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_stop); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 761, __pyx_L1_error)
+      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_stop); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 767, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
       __pyx_t_1 = (__pyx_t_9 != Py_None);
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       __pyx_v_have_stop = __pyx_t_1;
 
-      /* "View.MemoryView":762
+      /* "View.MemoryView":768
  *             have_start = index.start is not None
  *             have_stop = index.stop is not None
  *             have_step = index.step is not None             # <<<<<<<<<<<<<<
  * 
  *             slice_memviewslice(
  */
-      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_step); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 762, __pyx_L1_error)
+      __pyx_t_9 = __Pyx_PyObject_GetAttrStr(__pyx_v_index, __pyx_n_s_step); if (unlikely(!__pyx_t_9)) __PYX_ERR(1, 768, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_9);
       __pyx_t_1 = (__pyx_t_9 != Py_None);
       __Pyx_DECREF(__pyx_t_9); __pyx_t_9 = 0;
       __pyx_v_have_step = __pyx_t_1;
 
-      /* "View.MemoryView":764
+      /* "View.MemoryView":770
  *             have_step = index.step is not None
  * 
  *             slice_memviewslice(             # <<<<<<<<<<<<<<
  *                 p_dst, p_src.shape[dim], p_src.strides[dim], p_src.suboffsets[dim],
  *                 dim, new_ndim, p_suboffset_dim,
  */
-      __pyx_t_11 = __pyx_memoryview_slice_memviewslice(__pyx_v_p_dst, (__pyx_v_p_src->shape[__pyx_v_dim]), (__pyx_v_p_src->strides[__pyx_v_dim]), (__pyx_v_p_src->suboffsets[__pyx_v_dim]), __pyx_v_dim, __pyx_v_new_ndim, __pyx_v_p_suboffset_dim, __pyx_v_start, __pyx_v_stop, __pyx_v_step, __pyx_v_have_start, __pyx_v_have_stop, __pyx_v_have_step, 1); if (unlikely(__pyx_t_11 == ((int)-1))) __PYX_ERR(1, 764, __pyx_L1_error)
+      __pyx_t_11 = __pyx_memoryview_slice_memviewslice(__pyx_v_p_dst, (__pyx_v_p_src->shape[__pyx_v_dim]), (__pyx_v_p_src->strides[__pyx_v_dim]), (__pyx_v_p_src->suboffsets[__pyx_v_dim]), __pyx_v_dim, __pyx_v_new_ndim, __pyx_v_p_suboffset_dim, __pyx_v_start, __pyx_v_stop, __pyx_v_step, __pyx_v_have_start, __pyx_v_have_stop, __pyx_v_have_step, 1); if (unlikely(__pyx_t_11 == ((int)-1))) __PYX_ERR(1, 770, __pyx_L1_error)
 
-      /* "View.MemoryView":770
+      /* "View.MemoryView":776
  *                 have_start, have_stop, have_step,
  *                 True)
  *             new_ndim += 1             # <<<<<<<<<<<<<<
  * 
  *     if isinstance(memview, _memoryviewslice):
  */
       __pyx_v_new_ndim = (__pyx_v_new_ndim + 1);
     }
     __pyx_L6:;
 
-    /* "View.MemoryView":742
+    /* "View.MemoryView":748
  *     cdef bint have_start, have_stop, have_step
  * 
  *     for dim, index in enumerate(indices):             # <<<<<<<<<<<<<<
  *         if PyIndex_Check(index):
  *             slice_memviewslice(
  */
   }
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "View.MemoryView":772
+  /* "View.MemoryView":778
  *             new_ndim += 1
  * 
  *     if isinstance(memview, _memoryviewslice):             # <<<<<<<<<<<<<<
  *         return memoryview_fromslice(dst, new_ndim,
  *                                     memviewsliceobj.to_object_func,
  */
   __pyx_t_1 = __Pyx_TypeCheck(((PyObject *)__pyx_v_memview), __pyx_memoryviewslice_type); 
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":773
+    /* "View.MemoryView":779
  * 
  *     if isinstance(memview, _memoryviewslice):
  *         return memoryview_fromslice(dst, new_ndim,             # <<<<<<<<<<<<<<
  *                                     memviewsliceobj.to_object_func,
  *                                     memviewsliceobj.to_dtype_func,
  */
     __Pyx_XDECREF(((PyObject *)__pyx_r));
 
-    /* "View.MemoryView":774
+    /* "View.MemoryView":780
  *     if isinstance(memview, _memoryviewslice):
  *         return memoryview_fromslice(dst, new_ndim,
  *                                     memviewsliceobj.to_object_func,             # <<<<<<<<<<<<<<
  *                                     memviewsliceobj.to_dtype_func,
  *                                     memview.dtype_is_object)
  */
-    if (unlikely(!__pyx_v_memviewsliceobj)) { __Pyx_RaiseUnboundLocalError("memviewsliceobj"); __PYX_ERR(1, 774, __pyx_L1_error) }
+    if (unlikely(!__pyx_v_memviewsliceobj)) { __Pyx_RaiseUnboundLocalError("memviewsliceobj"); __PYX_ERR(1, 780, __pyx_L1_error) }
 
-    /* "View.MemoryView":775
+    /* "View.MemoryView":781
  *         return memoryview_fromslice(dst, new_ndim,
  *                                     memviewsliceobj.to_object_func,
  *                                     memviewsliceobj.to_dtype_func,             # <<<<<<<<<<<<<<
  *                                     memview.dtype_is_object)
  *     else:
  */
-    if (unlikely(!__pyx_v_memviewsliceobj)) { __Pyx_RaiseUnboundLocalError("memviewsliceobj"); __PYX_ERR(1, 775, __pyx_L1_error) }
+    if (unlikely(!__pyx_v_memviewsliceobj)) { __Pyx_RaiseUnboundLocalError("memviewsliceobj"); __PYX_ERR(1, 781, __pyx_L1_error) }
 
-    /* "View.MemoryView":773
+    /* "View.MemoryView":779
  * 
  *     if isinstance(memview, _memoryviewslice):
  *         return memoryview_fromslice(dst, new_ndim,             # <<<<<<<<<<<<<<
  *                                     memviewsliceobj.to_object_func,
  *                                     memviewsliceobj.to_dtype_func,
  */
-    __pyx_t_3 = __pyx_memoryview_fromslice(__pyx_v_dst, __pyx_v_new_ndim, __pyx_v_memviewsliceobj->to_object_func, __pyx_v_memviewsliceobj->to_dtype_func, __pyx_v_memview->dtype_is_object); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 773, __pyx_L1_error)
+    __pyx_t_3 = __pyx_memoryview_fromslice(__pyx_v_dst, __pyx_v_new_ndim, __pyx_v_memviewsliceobj->to_object_func, __pyx_v_memviewsliceobj->to_dtype_func, __pyx_v_memview->dtype_is_object); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 779, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_memoryview_type))))) __PYX_ERR(1, 773, __pyx_L1_error)
+    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_memoryview_type))))) __PYX_ERR(1, 779, __pyx_L1_error)
     __pyx_r = ((struct __pyx_memoryview_obj *)__pyx_t_3);
     __pyx_t_3 = 0;
     goto __pyx_L0;
 
-    /* "View.MemoryView":772
+    /* "View.MemoryView":778
  *             new_ndim += 1
  * 
  *     if isinstance(memview, _memoryviewslice):             # <<<<<<<<<<<<<<
  *         return memoryview_fromslice(dst, new_ndim,
  *                                     memviewsliceobj.to_object_func,
  */
   }
 
-  /* "View.MemoryView":778
+  /* "View.MemoryView":784
  *                                     memview.dtype_is_object)
  *     else:
  *         return memoryview_fromslice(dst, new_ndim, NULL, NULL,             # <<<<<<<<<<<<<<
  *                                     memview.dtype_is_object)
  * 
  */
   /*else*/ {
     __Pyx_XDECREF(((PyObject *)__pyx_r));
 
-    /* "View.MemoryView":779
+    /* "View.MemoryView":785
  *     else:
  *         return memoryview_fromslice(dst, new_ndim, NULL, NULL,
  *                                     memview.dtype_is_object)             # <<<<<<<<<<<<<<
  * 
  * 
  */
-    __pyx_t_3 = __pyx_memoryview_fromslice(__pyx_v_dst, __pyx_v_new_ndim, NULL, NULL, __pyx_v_memview->dtype_is_object); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 778, __pyx_L1_error)
+    __pyx_t_3 = __pyx_memoryview_fromslice(__pyx_v_dst, __pyx_v_new_ndim, NULL, NULL, __pyx_v_memview->dtype_is_object); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 784, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
 
-    /* "View.MemoryView":778
+    /* "View.MemoryView":784
  *                                     memview.dtype_is_object)
  *     else:
  *         return memoryview_fromslice(dst, new_ndim, NULL, NULL,             # <<<<<<<<<<<<<<
  *                                     memview.dtype_is_object)
  * 
  */
-    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_memoryview_type))))) __PYX_ERR(1, 778, __pyx_L1_error)
+    if (!(likely(((__pyx_t_3) == Py_None) || likely(__Pyx_TypeTest(__pyx_t_3, __pyx_memoryview_type))))) __PYX_ERR(1, 784, __pyx_L1_error)
     __pyx_r = ((struct __pyx_memoryview_obj *)__pyx_t_3);
     __pyx_t_3 = 0;
     goto __pyx_L0;
   }
 
-  /* "View.MemoryView":706
+  /* "View.MemoryView":712
  * 
  * @cname('__pyx_memview_slice')
  * cdef memoryview memview_slice(memoryview memview, object indices):             # <<<<<<<<<<<<<<
  *     cdef int new_ndim = 0, suboffset_dim = -1, dim
  *     cdef bint negative_step
  */
 
@@ -26742,111 +28552,114 @@
   __Pyx_XDECREF((PyObject *)__pyx_v_memviewsliceobj);
   __Pyx_XDECREF(__pyx_v_index);
   __Pyx_XGIVEREF((PyObject *)__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":803
+/* "View.MemoryView":809
  * 
  * @cname('__pyx_memoryview_slice_memviewslice')
  * cdef int slice_memviewslice(             # <<<<<<<<<<<<<<
  *         __Pyx_memviewslice *dst,
  *         Py_ssize_t shape, Py_ssize_t stride, Py_ssize_t suboffset,
  */
 
 static int __pyx_memoryview_slice_memviewslice(__Pyx_memviewslice *__pyx_v_dst, Py_ssize_t __pyx_v_shape, Py_ssize_t __pyx_v_stride, Py_ssize_t __pyx_v_suboffset, int __pyx_v_dim, int __pyx_v_new_ndim, int *__pyx_v_suboffset_dim, Py_ssize_t __pyx_v_start, Py_ssize_t __pyx_v_stop, Py_ssize_t __pyx_v_step, int __pyx_v_have_start, int __pyx_v_have_stop, int __pyx_v_have_step, int __pyx_v_is_slice) {
   Py_ssize_t __pyx_v_new_shape;
   int __pyx_v_negative_step;
   int __pyx_r;
   int __pyx_t_1;
   int __pyx_t_2;
   int __pyx_t_3;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
 
-  /* "View.MemoryView":823
+  /* "View.MemoryView":829
  *     cdef bint negative_step
  * 
  *     if not is_slice:             # <<<<<<<<<<<<<<
  * 
  *         if start < 0:
  */
   __pyx_t_1 = ((!(__pyx_v_is_slice != 0)) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":825
+    /* "View.MemoryView":831
  *     if not is_slice:
  * 
  *         if start < 0:             # <<<<<<<<<<<<<<
  *             start += shape
  *         if not 0 <= start < shape:
  */
     __pyx_t_1 = ((__pyx_v_start < 0) != 0);
     if (__pyx_t_1) {
 
-      /* "View.MemoryView":826
+      /* "View.MemoryView":832
  * 
  *         if start < 0:
  *             start += shape             # <<<<<<<<<<<<<<
  *         if not 0 <= start < shape:
  *             _err_dim(IndexError, "Index out of bounds (axis %d)", dim)
  */
       __pyx_v_start = (__pyx_v_start + __pyx_v_shape);
 
-      /* "View.MemoryView":825
+      /* "View.MemoryView":831
  *     if not is_slice:
  * 
  *         if start < 0:             # <<<<<<<<<<<<<<
  *             start += shape
  *         if not 0 <= start < shape:
  */
     }
 
-    /* "View.MemoryView":827
+    /* "View.MemoryView":833
  *         if start < 0:
  *             start += shape
  *         if not 0 <= start < shape:             # <<<<<<<<<<<<<<
  *             _err_dim(IndexError, "Index out of bounds (axis %d)", dim)
  *     else:
  */
     __pyx_t_1 = (0 <= __pyx_v_start);
     if (__pyx_t_1) {
       __pyx_t_1 = (__pyx_v_start < __pyx_v_shape);
     }
     __pyx_t_2 = ((!(__pyx_t_1 != 0)) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":828
+      /* "View.MemoryView":834
  *             start += shape
  *         if not 0 <= start < shape:
  *             _err_dim(IndexError, "Index out of bounds (axis %d)", dim)             # <<<<<<<<<<<<<<
  *     else:
  * 
  */
-      __pyx_t_3 = __pyx_memoryview_err_dim(__pyx_builtin_IndexError, ((char *)"Index out of bounds (axis %d)"), __pyx_v_dim); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(1, 828, __pyx_L1_error)
+      __pyx_t_3 = __pyx_memoryview_err_dim(__pyx_builtin_IndexError, ((char *)"Index out of bounds (axis %d)"), __pyx_v_dim); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(1, 834, __pyx_L1_error)
 
-      /* "View.MemoryView":827
+      /* "View.MemoryView":833
  *         if start < 0:
  *             start += shape
  *         if not 0 <= start < shape:             # <<<<<<<<<<<<<<
  *             _err_dim(IndexError, "Index out of bounds (axis %d)", dim)
  *     else:
  */
     }
 
-    /* "View.MemoryView":823
+    /* "View.MemoryView":829
  *     cdef bint negative_step
  * 
  *     if not is_slice:             # <<<<<<<<<<<<<<
  * 
  *         if start < 0:
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":831
+  /* "View.MemoryView":837
  *     else:
  * 
  *         negative_step = have_step != 0 and step < 0             # <<<<<<<<<<<<<<
  * 
  *         if have_step and step == 0:
  */
   /*else*/ {
@@ -26857,15 +28670,15 @@
       goto __pyx_L6_bool_binop_done;
     }
     __pyx_t_1 = ((__pyx_v_step < 0) != 0);
     __pyx_t_2 = __pyx_t_1;
     __pyx_L6_bool_binop_done:;
     __pyx_v_negative_step = __pyx_t_2;
 
-    /* "View.MemoryView":833
+    /* "View.MemoryView":839
  *         negative_step = have_step != 0 and step < 0
  * 
  *         if have_step and step == 0:             # <<<<<<<<<<<<<<
  *             _err_dim(ValueError, "Step may not be zero (axis %d)", dim)
  * 
  */
     __pyx_t_1 = (__pyx_v_have_step != 0);
@@ -26875,639 +28688,639 @@
       goto __pyx_L9_bool_binop_done;
     }
     __pyx_t_1 = ((__pyx_v_step == 0) != 0);
     __pyx_t_2 = __pyx_t_1;
     __pyx_L9_bool_binop_done:;
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":834
+      /* "View.MemoryView":840
  * 
  *         if have_step and step == 0:
  *             _err_dim(ValueError, "Step may not be zero (axis %d)", dim)             # <<<<<<<<<<<<<<
  * 
  * 
  */
-      __pyx_t_3 = __pyx_memoryview_err_dim(__pyx_builtin_ValueError, ((char *)"Step may not be zero (axis %d)"), __pyx_v_dim); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(1, 834, __pyx_L1_error)
+      __pyx_t_3 = __pyx_memoryview_err_dim(__pyx_builtin_ValueError, ((char *)"Step may not be zero (axis %d)"), __pyx_v_dim); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(1, 840, __pyx_L1_error)
 
-      /* "View.MemoryView":833
+      /* "View.MemoryView":839
  *         negative_step = have_step != 0 and step < 0
  * 
  *         if have_step and step == 0:             # <<<<<<<<<<<<<<
  *             _err_dim(ValueError, "Step may not be zero (axis %d)", dim)
  * 
  */
     }
 
-    /* "View.MemoryView":837
+    /* "View.MemoryView":843
  * 
  * 
  *         if have_start:             # <<<<<<<<<<<<<<
  *             if start < 0:
  *                 start += shape
  */
     __pyx_t_2 = (__pyx_v_have_start != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":838
+      /* "View.MemoryView":844
  * 
  *         if have_start:
  *             if start < 0:             # <<<<<<<<<<<<<<
  *                 start += shape
  *                 if start < 0:
  */
       __pyx_t_2 = ((__pyx_v_start < 0) != 0);
       if (__pyx_t_2) {
 
-        /* "View.MemoryView":839
+        /* "View.MemoryView":845
  *         if have_start:
  *             if start < 0:
  *                 start += shape             # <<<<<<<<<<<<<<
  *                 if start < 0:
  *                     start = 0
  */
         __pyx_v_start = (__pyx_v_start + __pyx_v_shape);
 
-        /* "View.MemoryView":840
+        /* "View.MemoryView":846
  *             if start < 0:
  *                 start += shape
  *                 if start < 0:             # <<<<<<<<<<<<<<
  *                     start = 0
  *             elif start >= shape:
  */
         __pyx_t_2 = ((__pyx_v_start < 0) != 0);
         if (__pyx_t_2) {
 
-          /* "View.MemoryView":841
+          /* "View.MemoryView":847
  *                 start += shape
  *                 if start < 0:
  *                     start = 0             # <<<<<<<<<<<<<<
  *             elif start >= shape:
  *                 if negative_step:
  */
           __pyx_v_start = 0;
 
-          /* "View.MemoryView":840
+          /* "View.MemoryView":846
  *             if start < 0:
  *                 start += shape
  *                 if start < 0:             # <<<<<<<<<<<<<<
  *                     start = 0
  *             elif start >= shape:
  */
         }
 
-        /* "View.MemoryView":838
+        /* "View.MemoryView":844
  * 
  *         if have_start:
  *             if start < 0:             # <<<<<<<<<<<<<<
  *                 start += shape
  *                 if start < 0:
  */
         goto __pyx_L12;
       }
 
-      /* "View.MemoryView":842
+      /* "View.MemoryView":848
  *                 if start < 0:
  *                     start = 0
  *             elif start >= shape:             # <<<<<<<<<<<<<<
  *                 if negative_step:
  *                     start = shape - 1
  */
       __pyx_t_2 = ((__pyx_v_start >= __pyx_v_shape) != 0);
       if (__pyx_t_2) {
 
-        /* "View.MemoryView":843
+        /* "View.MemoryView":849
  *                     start = 0
  *             elif start >= shape:
  *                 if negative_step:             # <<<<<<<<<<<<<<
  *                     start = shape - 1
  *                 else:
  */
         __pyx_t_2 = (__pyx_v_negative_step != 0);
         if (__pyx_t_2) {
 
-          /* "View.MemoryView":844
+          /* "View.MemoryView":850
  *             elif start >= shape:
  *                 if negative_step:
  *                     start = shape - 1             # <<<<<<<<<<<<<<
  *                 else:
  *                     start = shape
  */
           __pyx_v_start = (__pyx_v_shape - 1);
 
-          /* "View.MemoryView":843
+          /* "View.MemoryView":849
  *                     start = 0
  *             elif start >= shape:
  *                 if negative_step:             # <<<<<<<<<<<<<<
  *                     start = shape - 1
  *                 else:
  */
           goto __pyx_L14;
         }
 
-        /* "View.MemoryView":846
+        /* "View.MemoryView":852
  *                     start = shape - 1
  *                 else:
  *                     start = shape             # <<<<<<<<<<<<<<
  *         else:
  *             if negative_step:
  */
         /*else*/ {
           __pyx_v_start = __pyx_v_shape;
         }
         __pyx_L14:;
 
-        /* "View.MemoryView":842
+        /* "View.MemoryView":848
  *                 if start < 0:
  *                     start = 0
  *             elif start >= shape:             # <<<<<<<<<<<<<<
  *                 if negative_step:
  *                     start = shape - 1
  */
       }
       __pyx_L12:;
 
-      /* "View.MemoryView":837
+      /* "View.MemoryView":843
  * 
  * 
  *         if have_start:             # <<<<<<<<<<<<<<
  *             if start < 0:
  *                 start += shape
  */
       goto __pyx_L11;
     }
 
-    /* "View.MemoryView":848
+    /* "View.MemoryView":854
  *                     start = shape
  *         else:
  *             if negative_step:             # <<<<<<<<<<<<<<
  *                 start = shape - 1
  *             else:
  */
     /*else*/ {
       __pyx_t_2 = (__pyx_v_negative_step != 0);
       if (__pyx_t_2) {
 
-        /* "View.MemoryView":849
+        /* "View.MemoryView":855
  *         else:
  *             if negative_step:
  *                 start = shape - 1             # <<<<<<<<<<<<<<
  *             else:
  *                 start = 0
  */
         __pyx_v_start = (__pyx_v_shape - 1);
 
-        /* "View.MemoryView":848
+        /* "View.MemoryView":854
  *                     start = shape
  *         else:
  *             if negative_step:             # <<<<<<<<<<<<<<
  *                 start = shape - 1
  *             else:
  */
         goto __pyx_L15;
       }
 
-      /* "View.MemoryView":851
+      /* "View.MemoryView":857
  *                 start = shape - 1
  *             else:
  *                 start = 0             # <<<<<<<<<<<<<<
  * 
  *         if have_stop:
  */
       /*else*/ {
         __pyx_v_start = 0;
       }
       __pyx_L15:;
     }
     __pyx_L11:;
 
-    /* "View.MemoryView":853
+    /* "View.MemoryView":859
  *                 start = 0
  * 
  *         if have_stop:             # <<<<<<<<<<<<<<
  *             if stop < 0:
  *                 stop += shape
  */
     __pyx_t_2 = (__pyx_v_have_stop != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":854
+      /* "View.MemoryView":860
  * 
  *         if have_stop:
  *             if stop < 0:             # <<<<<<<<<<<<<<
  *                 stop += shape
  *                 if stop < 0:
  */
       __pyx_t_2 = ((__pyx_v_stop < 0) != 0);
       if (__pyx_t_2) {
 
-        /* "View.MemoryView":855
+        /* "View.MemoryView":861
  *         if have_stop:
  *             if stop < 0:
  *                 stop += shape             # <<<<<<<<<<<<<<
  *                 if stop < 0:
  *                     stop = 0
  */
         __pyx_v_stop = (__pyx_v_stop + __pyx_v_shape);
 
-        /* "View.MemoryView":856
+        /* "View.MemoryView":862
  *             if stop < 0:
  *                 stop += shape
  *                 if stop < 0:             # <<<<<<<<<<<<<<
  *                     stop = 0
  *             elif stop > shape:
  */
         __pyx_t_2 = ((__pyx_v_stop < 0) != 0);
         if (__pyx_t_2) {
 
-          /* "View.MemoryView":857
+          /* "View.MemoryView":863
  *                 stop += shape
  *                 if stop < 0:
  *                     stop = 0             # <<<<<<<<<<<<<<
  *             elif stop > shape:
  *                 stop = shape
  */
           __pyx_v_stop = 0;
 
-          /* "View.MemoryView":856
+          /* "View.MemoryView":862
  *             if stop < 0:
  *                 stop += shape
  *                 if stop < 0:             # <<<<<<<<<<<<<<
  *                     stop = 0
  *             elif stop > shape:
  */
         }
 
-        /* "View.MemoryView":854
+        /* "View.MemoryView":860
  * 
  *         if have_stop:
  *             if stop < 0:             # <<<<<<<<<<<<<<
  *                 stop += shape
  *                 if stop < 0:
  */
         goto __pyx_L17;
       }
 
-      /* "View.MemoryView":858
+      /* "View.MemoryView":864
  *                 if stop < 0:
  *                     stop = 0
  *             elif stop > shape:             # <<<<<<<<<<<<<<
  *                 stop = shape
  *         else:
  */
       __pyx_t_2 = ((__pyx_v_stop > __pyx_v_shape) != 0);
       if (__pyx_t_2) {
 
-        /* "View.MemoryView":859
+        /* "View.MemoryView":865
  *                     stop = 0
  *             elif stop > shape:
  *                 stop = shape             # <<<<<<<<<<<<<<
  *         else:
  *             if negative_step:
  */
         __pyx_v_stop = __pyx_v_shape;
 
-        /* "View.MemoryView":858
+        /* "View.MemoryView":864
  *                 if stop < 0:
  *                     stop = 0
  *             elif stop > shape:             # <<<<<<<<<<<<<<
  *                 stop = shape
  *         else:
  */
       }
       __pyx_L17:;
 
-      /* "View.MemoryView":853
+      /* "View.MemoryView":859
  *                 start = 0
  * 
  *         if have_stop:             # <<<<<<<<<<<<<<
  *             if stop < 0:
  *                 stop += shape
  */
       goto __pyx_L16;
     }
 
-    /* "View.MemoryView":861
+    /* "View.MemoryView":867
  *                 stop = shape
  *         else:
  *             if negative_step:             # <<<<<<<<<<<<<<
  *                 stop = -1
  *             else:
  */
     /*else*/ {
       __pyx_t_2 = (__pyx_v_negative_step != 0);
       if (__pyx_t_2) {
 
-        /* "View.MemoryView":862
+        /* "View.MemoryView":868
  *         else:
  *             if negative_step:
  *                 stop = -1             # <<<<<<<<<<<<<<
  *             else:
  *                 stop = shape
  */
         __pyx_v_stop = -1L;
 
-        /* "View.MemoryView":861
+        /* "View.MemoryView":867
  *                 stop = shape
  *         else:
  *             if negative_step:             # <<<<<<<<<<<<<<
  *                 stop = -1
  *             else:
  */
         goto __pyx_L19;
       }
 
-      /* "View.MemoryView":864
+      /* "View.MemoryView":870
  *                 stop = -1
  *             else:
  *                 stop = shape             # <<<<<<<<<<<<<<
  * 
  *         if not have_step:
  */
       /*else*/ {
         __pyx_v_stop = __pyx_v_shape;
       }
       __pyx_L19:;
     }
     __pyx_L16:;
 
-    /* "View.MemoryView":866
+    /* "View.MemoryView":872
  *                 stop = shape
  * 
  *         if not have_step:             # <<<<<<<<<<<<<<
  *             step = 1
  * 
  */
     __pyx_t_2 = ((!(__pyx_v_have_step != 0)) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":867
+      /* "View.MemoryView":873
  * 
  *         if not have_step:
  *             step = 1             # <<<<<<<<<<<<<<
  * 
  * 
  */
       __pyx_v_step = 1;
 
-      /* "View.MemoryView":866
+      /* "View.MemoryView":872
  *                 stop = shape
  * 
  *         if not have_step:             # <<<<<<<<<<<<<<
  *             step = 1
  * 
  */
     }
 
-    /* "View.MemoryView":871
+    /* "View.MemoryView":877
  * 
  *         with cython.cdivision(True):
  *             new_shape = (stop - start) // step             # <<<<<<<<<<<<<<
  * 
  *             if (stop - start) - step * new_shape:
  */
     __pyx_v_new_shape = ((__pyx_v_stop - __pyx_v_start) / __pyx_v_step);
 
-    /* "View.MemoryView":873
+    /* "View.MemoryView":879
  *             new_shape = (stop - start) // step
  * 
  *             if (stop - start) - step * new_shape:             # <<<<<<<<<<<<<<
  *                 new_shape += 1
  * 
  */
     __pyx_t_2 = (((__pyx_v_stop - __pyx_v_start) - (__pyx_v_step * __pyx_v_new_shape)) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":874
+      /* "View.MemoryView":880
  * 
  *             if (stop - start) - step * new_shape:
  *                 new_shape += 1             # <<<<<<<<<<<<<<
  * 
  *         if new_shape < 0:
  */
       __pyx_v_new_shape = (__pyx_v_new_shape + 1);
 
-      /* "View.MemoryView":873
+      /* "View.MemoryView":879
  *             new_shape = (stop - start) // step
  * 
  *             if (stop - start) - step * new_shape:             # <<<<<<<<<<<<<<
  *                 new_shape += 1
  * 
  */
     }
 
-    /* "View.MemoryView":876
+    /* "View.MemoryView":882
  *                 new_shape += 1
  * 
  *         if new_shape < 0:             # <<<<<<<<<<<<<<
  *             new_shape = 0
  * 
  */
     __pyx_t_2 = ((__pyx_v_new_shape < 0) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":877
+      /* "View.MemoryView":883
  * 
  *         if new_shape < 0:
  *             new_shape = 0             # <<<<<<<<<<<<<<
  * 
  * 
  */
       __pyx_v_new_shape = 0;
 
-      /* "View.MemoryView":876
+      /* "View.MemoryView":882
  *                 new_shape += 1
  * 
  *         if new_shape < 0:             # <<<<<<<<<<<<<<
  *             new_shape = 0
  * 
  */
     }
 
-    /* "View.MemoryView":880
+    /* "View.MemoryView":886
  * 
  * 
  *         dst.strides[new_ndim] = stride * step             # <<<<<<<<<<<<<<
  *         dst.shape[new_ndim] = new_shape
  *         dst.suboffsets[new_ndim] = suboffset
  */
     (__pyx_v_dst->strides[__pyx_v_new_ndim]) = (__pyx_v_stride * __pyx_v_step);
 
-    /* "View.MemoryView":881
+    /* "View.MemoryView":887
  * 
  *         dst.strides[new_ndim] = stride * step
  *         dst.shape[new_ndim] = new_shape             # <<<<<<<<<<<<<<
  *         dst.suboffsets[new_ndim] = suboffset
  * 
  */
     (__pyx_v_dst->shape[__pyx_v_new_ndim]) = __pyx_v_new_shape;
 
-    /* "View.MemoryView":882
+    /* "View.MemoryView":888
  *         dst.strides[new_ndim] = stride * step
  *         dst.shape[new_ndim] = new_shape
  *         dst.suboffsets[new_ndim] = suboffset             # <<<<<<<<<<<<<<
  * 
  * 
  */
     (__pyx_v_dst->suboffsets[__pyx_v_new_ndim]) = __pyx_v_suboffset;
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":885
+  /* "View.MemoryView":891
  * 
  * 
  *     if suboffset_dim[0] < 0:             # <<<<<<<<<<<<<<
  *         dst.data += start * stride
  *     else:
  */
   __pyx_t_2 = (((__pyx_v_suboffset_dim[0]) < 0) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":886
+    /* "View.MemoryView":892
  * 
  *     if suboffset_dim[0] < 0:
  *         dst.data += start * stride             # <<<<<<<<<<<<<<
  *     else:
  *         dst.suboffsets[suboffset_dim[0]] += start * stride
  */
     __pyx_v_dst->data = (__pyx_v_dst->data + (__pyx_v_start * __pyx_v_stride));
 
-    /* "View.MemoryView":885
+    /* "View.MemoryView":891
  * 
  * 
  *     if suboffset_dim[0] < 0:             # <<<<<<<<<<<<<<
  *         dst.data += start * stride
  *     else:
  */
     goto __pyx_L23;
   }
 
-  /* "View.MemoryView":888
+  /* "View.MemoryView":894
  *         dst.data += start * stride
  *     else:
  *         dst.suboffsets[suboffset_dim[0]] += start * stride             # <<<<<<<<<<<<<<
  * 
  *     if suboffset >= 0:
  */
   /*else*/ {
     __pyx_t_3 = (__pyx_v_suboffset_dim[0]);
     (__pyx_v_dst->suboffsets[__pyx_t_3]) = ((__pyx_v_dst->suboffsets[__pyx_t_3]) + (__pyx_v_start * __pyx_v_stride));
   }
   __pyx_L23:;
 
-  /* "View.MemoryView":890
+  /* "View.MemoryView":896
  *         dst.suboffsets[suboffset_dim[0]] += start * stride
  * 
  *     if suboffset >= 0:             # <<<<<<<<<<<<<<
  *         if not is_slice:
  *             if new_ndim == 0:
  */
   __pyx_t_2 = ((__pyx_v_suboffset >= 0) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":891
+    /* "View.MemoryView":897
  * 
  *     if suboffset >= 0:
  *         if not is_slice:             # <<<<<<<<<<<<<<
  *             if new_ndim == 0:
  *                 dst.data = (<char **> dst.data)[0] + suboffset
  */
     __pyx_t_2 = ((!(__pyx_v_is_slice != 0)) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":892
+      /* "View.MemoryView":898
  *     if suboffset >= 0:
  *         if not is_slice:
  *             if new_ndim == 0:             # <<<<<<<<<<<<<<
  *                 dst.data = (<char **> dst.data)[0] + suboffset
  *             else:
  */
       __pyx_t_2 = ((__pyx_v_new_ndim == 0) != 0);
       if (__pyx_t_2) {
 
-        /* "View.MemoryView":893
+        /* "View.MemoryView":899
  *         if not is_slice:
  *             if new_ndim == 0:
  *                 dst.data = (<char **> dst.data)[0] + suboffset             # <<<<<<<<<<<<<<
  *             else:
  *                 _err_dim(IndexError, "All dimensions preceding dimension %d "
  */
         __pyx_v_dst->data = ((((char **)__pyx_v_dst->data)[0]) + __pyx_v_suboffset);
 
-        /* "View.MemoryView":892
+        /* "View.MemoryView":898
  *     if suboffset >= 0:
  *         if not is_slice:
  *             if new_ndim == 0:             # <<<<<<<<<<<<<<
  *                 dst.data = (<char **> dst.data)[0] + suboffset
  *             else:
  */
         goto __pyx_L26;
       }
 
-      /* "View.MemoryView":895
+      /* "View.MemoryView":901
  *                 dst.data = (<char **> dst.data)[0] + suboffset
  *             else:
  *                 _err_dim(IndexError, "All dimensions preceding dimension %d "             # <<<<<<<<<<<<<<
  *                                      "must be indexed and not sliced", dim)
  *         else:
  */
       /*else*/ {
 
-        /* "View.MemoryView":896
+        /* "View.MemoryView":902
  *             else:
  *                 _err_dim(IndexError, "All dimensions preceding dimension %d "
  *                                      "must be indexed and not sliced", dim)             # <<<<<<<<<<<<<<
  *         else:
  *             suboffset_dim[0] = new_ndim
  */
-        __pyx_t_3 = __pyx_memoryview_err_dim(__pyx_builtin_IndexError, ((char *)"All dimensions preceding dimension %d must be indexed and not sliced"), __pyx_v_dim); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(1, 895, __pyx_L1_error)
+        __pyx_t_3 = __pyx_memoryview_err_dim(__pyx_builtin_IndexError, ((char *)"All dimensions preceding dimension %d must be indexed and not sliced"), __pyx_v_dim); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(1, 901, __pyx_L1_error)
       }
       __pyx_L26:;
 
-      /* "View.MemoryView":891
+      /* "View.MemoryView":897
  * 
  *     if suboffset >= 0:
  *         if not is_slice:             # <<<<<<<<<<<<<<
  *             if new_ndim == 0:
  *                 dst.data = (<char **> dst.data)[0] + suboffset
  */
       goto __pyx_L25;
     }
 
-    /* "View.MemoryView":898
+    /* "View.MemoryView":904
  *                                      "must be indexed and not sliced", dim)
  *         else:
  *             suboffset_dim[0] = new_ndim             # <<<<<<<<<<<<<<
  * 
  *     return 0
  */
     /*else*/ {
       (__pyx_v_suboffset_dim[0]) = __pyx_v_new_ndim;
     }
     __pyx_L25:;
 
-    /* "View.MemoryView":890
+    /* "View.MemoryView":896
  *         dst.suboffsets[suboffset_dim[0]] += start * stride
  * 
  *     if suboffset >= 0:             # <<<<<<<<<<<<<<
  *         if not is_slice:
  *             if new_ndim == 0:
  */
   }
 
-  /* "View.MemoryView":900
+  /* "View.MemoryView":906
  *             suboffset_dim[0] = new_ndim
  * 
  *     return 0             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":803
+  /* "View.MemoryView":809
  * 
  * @cname('__pyx_memoryview_slice_memviewslice')
  * cdef int slice_memviewslice(             # <<<<<<<<<<<<<<
  *         __Pyx_memviewslice *dst,
  *         Py_ssize_t shape, Py_ssize_t stride, Py_ssize_t suboffset,
  */
 
@@ -27523,15 +29336,15 @@
     #endif
   }
   __pyx_r = -1;
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "View.MemoryView":906
+/* "View.MemoryView":912
  * 
  * @cname('__pyx_pybuffer_index')
  * cdef char *pybuffer_index(Py_buffer *view, char *bufp, Py_ssize_t index,             # <<<<<<<<<<<<<<
  *                           Py_ssize_t dim) except NULL:
  *     cdef Py_ssize_t shape, stride, suboffset = -1
  */
 
@@ -27543,282 +29356,285 @@
   char *__pyx_v_resultp;
   char *__pyx_r;
   __Pyx_RefNannyDeclarations
   Py_ssize_t __pyx_t_1;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("pybuffer_index", 0);
 
-  /* "View.MemoryView":908
+  /* "View.MemoryView":914
  * cdef char *pybuffer_index(Py_buffer *view, char *bufp, Py_ssize_t index,
  *                           Py_ssize_t dim) except NULL:
  *     cdef Py_ssize_t shape, stride, suboffset = -1             # <<<<<<<<<<<<<<
  *     cdef Py_ssize_t itemsize = view.itemsize
  *     cdef char *resultp
  */
   __pyx_v_suboffset = -1L;
 
-  /* "View.MemoryView":909
+  /* "View.MemoryView":915
  *                           Py_ssize_t dim) except NULL:
  *     cdef Py_ssize_t shape, stride, suboffset = -1
  *     cdef Py_ssize_t itemsize = view.itemsize             # <<<<<<<<<<<<<<
  *     cdef char *resultp
  * 
  */
   __pyx_t_1 = __pyx_v_view->itemsize;
   __pyx_v_itemsize = __pyx_t_1;
 
-  /* "View.MemoryView":912
+  /* "View.MemoryView":918
  *     cdef char *resultp
  * 
  *     if view.ndim == 0:             # <<<<<<<<<<<<<<
  *         shape = view.len / itemsize
  *         stride = itemsize
  */
   __pyx_t_2 = ((__pyx_v_view->ndim == 0) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":913
+    /* "View.MemoryView":919
  * 
  *     if view.ndim == 0:
  *         shape = view.len / itemsize             # <<<<<<<<<<<<<<
  *         stride = itemsize
  *     else:
  */
     if (unlikely(__pyx_v_itemsize == 0)) {
       PyErr_SetString(PyExc_ZeroDivisionError, "integer division or modulo by zero");
-      __PYX_ERR(1, 913, __pyx_L1_error)
+      __PYX_ERR(1, 919, __pyx_L1_error)
     }
     else if (sizeof(Py_ssize_t) == sizeof(long) && (!(((Py_ssize_t)-1) > 0)) && unlikely(__pyx_v_itemsize == (Py_ssize_t)-1)  && unlikely(UNARY_NEG_WOULD_OVERFLOW(__pyx_v_view->len))) {
       PyErr_SetString(PyExc_OverflowError, "value too large to perform division");
-      __PYX_ERR(1, 913, __pyx_L1_error)
+      __PYX_ERR(1, 919, __pyx_L1_error)
     }
     __pyx_v_shape = __Pyx_div_Py_ssize_t(__pyx_v_view->len, __pyx_v_itemsize);
 
-    /* "View.MemoryView":914
+    /* "View.MemoryView":920
  *     if view.ndim == 0:
  *         shape = view.len / itemsize
  *         stride = itemsize             # <<<<<<<<<<<<<<
  *     else:
  *         shape = view.shape[dim]
  */
     __pyx_v_stride = __pyx_v_itemsize;
 
-    /* "View.MemoryView":912
+    /* "View.MemoryView":918
  *     cdef char *resultp
  * 
  *     if view.ndim == 0:             # <<<<<<<<<<<<<<
  *         shape = view.len / itemsize
  *         stride = itemsize
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":916
+  /* "View.MemoryView":922
  *         stride = itemsize
  *     else:
  *         shape = view.shape[dim]             # <<<<<<<<<<<<<<
  *         stride = view.strides[dim]
  *         if view.suboffsets != NULL:
  */
   /*else*/ {
     __pyx_v_shape = (__pyx_v_view->shape[__pyx_v_dim]);
 
-    /* "View.MemoryView":917
+    /* "View.MemoryView":923
  *     else:
  *         shape = view.shape[dim]
  *         stride = view.strides[dim]             # <<<<<<<<<<<<<<
  *         if view.suboffsets != NULL:
  *             suboffset = view.suboffsets[dim]
  */
     __pyx_v_stride = (__pyx_v_view->strides[__pyx_v_dim]);
 
-    /* "View.MemoryView":918
+    /* "View.MemoryView":924
  *         shape = view.shape[dim]
  *         stride = view.strides[dim]
  *         if view.suboffsets != NULL:             # <<<<<<<<<<<<<<
  *             suboffset = view.suboffsets[dim]
  * 
  */
     __pyx_t_2 = ((__pyx_v_view->suboffsets != NULL) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":919
+      /* "View.MemoryView":925
  *         stride = view.strides[dim]
  *         if view.suboffsets != NULL:
  *             suboffset = view.suboffsets[dim]             # <<<<<<<<<<<<<<
  * 
  *     if index < 0:
  */
       __pyx_v_suboffset = (__pyx_v_view->suboffsets[__pyx_v_dim]);
 
-      /* "View.MemoryView":918
+      /* "View.MemoryView":924
  *         shape = view.shape[dim]
  *         stride = view.strides[dim]
  *         if view.suboffsets != NULL:             # <<<<<<<<<<<<<<
  *             suboffset = view.suboffsets[dim]
  * 
  */
     }
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":921
+  /* "View.MemoryView":927
  *             suboffset = view.suboffsets[dim]
  * 
  *     if index < 0:             # <<<<<<<<<<<<<<
  *         index += view.shape[dim]
  *         if index < 0:
  */
   __pyx_t_2 = ((__pyx_v_index < 0) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":922
+    /* "View.MemoryView":928
  * 
  *     if index < 0:
  *         index += view.shape[dim]             # <<<<<<<<<<<<<<
  *         if index < 0:
  *             raise IndexError("Out of bounds on buffer access (axis %d)" % dim)
  */
     __pyx_v_index = (__pyx_v_index + (__pyx_v_view->shape[__pyx_v_dim]));
 
-    /* "View.MemoryView":923
+    /* "View.MemoryView":929
  *     if index < 0:
  *         index += view.shape[dim]
  *         if index < 0:             # <<<<<<<<<<<<<<
  *             raise IndexError("Out of bounds on buffer access (axis %d)" % dim)
  * 
  */
     __pyx_t_2 = ((__pyx_v_index < 0) != 0);
     if (unlikely(__pyx_t_2)) {
 
-      /* "View.MemoryView":924
+      /* "View.MemoryView":930
  *         index += view.shape[dim]
  *         if index < 0:
  *             raise IndexError("Out of bounds on buffer access (axis %d)" % dim)             # <<<<<<<<<<<<<<
  * 
  *     if index >= shape:
  */
-      __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_dim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 924, __pyx_L1_error)
+      __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_dim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 930, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_4 = __Pyx_PyString_Format(__pyx_kp_s_Out_of_bounds_on_buffer_access_a, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 924, __pyx_L1_error)
+      __pyx_t_4 = __Pyx_PyString_Format(__pyx_kp_s_Out_of_bounds_on_buffer_access_a, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 930, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_4);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_builtin_IndexError, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 924, __pyx_L1_error)
+      __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_builtin_IndexError, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 930, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_3);
       __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
       __Pyx_Raise(__pyx_t_3, 0, 0, 0);
       __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __PYX_ERR(1, 924, __pyx_L1_error)
+      __PYX_ERR(1, 930, __pyx_L1_error)
 
-      /* "View.MemoryView":923
+      /* "View.MemoryView":929
  *     if index < 0:
  *         index += view.shape[dim]
  *         if index < 0:             # <<<<<<<<<<<<<<
  *             raise IndexError("Out of bounds on buffer access (axis %d)" % dim)
  * 
  */
     }
 
-    /* "View.MemoryView":921
+    /* "View.MemoryView":927
  *             suboffset = view.suboffsets[dim]
  * 
  *     if index < 0:             # <<<<<<<<<<<<<<
  *         index += view.shape[dim]
  *         if index < 0:
  */
   }
 
-  /* "View.MemoryView":926
+  /* "View.MemoryView":932
  *             raise IndexError("Out of bounds on buffer access (axis %d)" % dim)
  * 
  *     if index >= shape:             # <<<<<<<<<<<<<<
  *         raise IndexError("Out of bounds on buffer access (axis %d)" % dim)
  * 
  */
   __pyx_t_2 = ((__pyx_v_index >= __pyx_v_shape) != 0);
   if (unlikely(__pyx_t_2)) {
 
-    /* "View.MemoryView":927
+    /* "View.MemoryView":933
  * 
  *     if index >= shape:
  *         raise IndexError("Out of bounds on buffer access (axis %d)" % dim)             # <<<<<<<<<<<<<<
  * 
  *     resultp = bufp + index * stride
  */
-    __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_dim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 927, __pyx_L1_error)
+    __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_dim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 933, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
-    __pyx_t_4 = __Pyx_PyString_Format(__pyx_kp_s_Out_of_bounds_on_buffer_access_a, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 927, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyString_Format(__pyx_kp_s_Out_of_bounds_on_buffer_access_a, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 933, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_4);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_builtin_IndexError, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 927, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_PyObject_CallOneArg(__pyx_builtin_IndexError, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 933, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_Raise(__pyx_t_3, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    __PYX_ERR(1, 927, __pyx_L1_error)
+    __PYX_ERR(1, 933, __pyx_L1_error)
 
-    /* "View.MemoryView":926
+    /* "View.MemoryView":932
  *             raise IndexError("Out of bounds on buffer access (axis %d)" % dim)
  * 
  *     if index >= shape:             # <<<<<<<<<<<<<<
  *         raise IndexError("Out of bounds on buffer access (axis %d)" % dim)
  * 
  */
   }
 
-  /* "View.MemoryView":929
+  /* "View.MemoryView":935
  *         raise IndexError("Out of bounds on buffer access (axis %d)" % dim)
  * 
  *     resultp = bufp + index * stride             # <<<<<<<<<<<<<<
  *     if suboffset >= 0:
  *         resultp = (<char **> resultp)[0] + suboffset
  */
   __pyx_v_resultp = (__pyx_v_bufp + (__pyx_v_index * __pyx_v_stride));
 
-  /* "View.MemoryView":930
+  /* "View.MemoryView":936
  * 
  *     resultp = bufp + index * stride
  *     if suboffset >= 0:             # <<<<<<<<<<<<<<
  *         resultp = (<char **> resultp)[0] + suboffset
  * 
  */
   __pyx_t_2 = ((__pyx_v_suboffset >= 0) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":931
+    /* "View.MemoryView":937
  *     resultp = bufp + index * stride
  *     if suboffset >= 0:
  *         resultp = (<char **> resultp)[0] + suboffset             # <<<<<<<<<<<<<<
  * 
  *     return resultp
  */
     __pyx_v_resultp = ((((char **)__pyx_v_resultp)[0]) + __pyx_v_suboffset);
 
-    /* "View.MemoryView":930
+    /* "View.MemoryView":936
  * 
  *     resultp = bufp + index * stride
  *     if suboffset >= 0:             # <<<<<<<<<<<<<<
  *         resultp = (<char **> resultp)[0] + suboffset
  * 
  */
   }
 
-  /* "View.MemoryView":933
+  /* "View.MemoryView":939
  *         resultp = (<char **> resultp)[0] + suboffset
  * 
  *     return resultp             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = __pyx_v_resultp;
   goto __pyx_L0;
 
-  /* "View.MemoryView":906
+  /* "View.MemoryView":912
  * 
  * @cname('__pyx_pybuffer_index')
  * cdef char *pybuffer_index(Py_buffer *view, char *bufp, Py_ssize_t index,             # <<<<<<<<<<<<<<
  *                           Py_ssize_t dim) except NULL:
  *     cdef Py_ssize_t shape, stride, suboffset = -1
  */
 
@@ -27829,15 +29645,15 @@
   __Pyx_AddTraceback("View.MemoryView.pybuffer_index", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":939
+/* "View.MemoryView":945
  * 
  * @cname('__pyx_memslice_transpose')
  * cdef int transpose_memslice(__Pyx_memviewslice *memslice) nogil except 0:             # <<<<<<<<<<<<<<
  *     cdef int ndim = memslice.memview.view.ndim
  * 
  */
 
@@ -27853,91 +29669,94 @@
   long __pyx_t_3;
   long __pyx_t_4;
   Py_ssize_t __pyx_t_5;
   Py_ssize_t __pyx_t_6;
   int __pyx_t_7;
   int __pyx_t_8;
   int __pyx_t_9;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
 
-  /* "View.MemoryView":940
+  /* "View.MemoryView":946
  * @cname('__pyx_memslice_transpose')
  * cdef int transpose_memslice(__Pyx_memviewslice *memslice) nogil except 0:
  *     cdef int ndim = memslice.memview.view.ndim             # <<<<<<<<<<<<<<
  * 
  *     cdef Py_ssize_t *shape = memslice.shape
  */
   __pyx_t_1 = __pyx_v_memslice->memview->view.ndim;
   __pyx_v_ndim = __pyx_t_1;
 
-  /* "View.MemoryView":942
+  /* "View.MemoryView":948
  *     cdef int ndim = memslice.memview.view.ndim
  * 
  *     cdef Py_ssize_t *shape = memslice.shape             # <<<<<<<<<<<<<<
  *     cdef Py_ssize_t *strides = memslice.strides
  * 
  */
   __pyx_t_2 = __pyx_v_memslice->shape;
   __pyx_v_shape = __pyx_t_2;
 
-  /* "View.MemoryView":943
+  /* "View.MemoryView":949
  * 
  *     cdef Py_ssize_t *shape = memslice.shape
  *     cdef Py_ssize_t *strides = memslice.strides             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_t_2 = __pyx_v_memslice->strides;
   __pyx_v_strides = __pyx_t_2;
 
-  /* "View.MemoryView":947
+  /* "View.MemoryView":953
  * 
  *     cdef int i, j
  *     for i in range(ndim / 2):             # <<<<<<<<<<<<<<
  *         j = ndim - 1 - i
  *         strides[i], strides[j] = strides[j], strides[i]
  */
   __pyx_t_3 = __Pyx_div_long(__pyx_v_ndim, 2);
   __pyx_t_4 = __pyx_t_3;
   for (__pyx_t_1 = 0; __pyx_t_1 < __pyx_t_4; __pyx_t_1+=1) {
     __pyx_v_i = __pyx_t_1;
 
-    /* "View.MemoryView":948
+    /* "View.MemoryView":954
  *     cdef int i, j
  *     for i in range(ndim / 2):
  *         j = ndim - 1 - i             # <<<<<<<<<<<<<<
  *         strides[i], strides[j] = strides[j], strides[i]
  *         shape[i], shape[j] = shape[j], shape[i]
  */
     __pyx_v_j = ((__pyx_v_ndim - 1) - __pyx_v_i);
 
-    /* "View.MemoryView":949
+    /* "View.MemoryView":955
  *     for i in range(ndim / 2):
  *         j = ndim - 1 - i
  *         strides[i], strides[j] = strides[j], strides[i]             # <<<<<<<<<<<<<<
  *         shape[i], shape[j] = shape[j], shape[i]
  * 
  */
     __pyx_t_5 = (__pyx_v_strides[__pyx_v_j]);
     __pyx_t_6 = (__pyx_v_strides[__pyx_v_i]);
     (__pyx_v_strides[__pyx_v_i]) = __pyx_t_5;
     (__pyx_v_strides[__pyx_v_j]) = __pyx_t_6;
 
-    /* "View.MemoryView":950
+    /* "View.MemoryView":956
  *         j = ndim - 1 - i
  *         strides[i], strides[j] = strides[j], strides[i]
  *         shape[i], shape[j] = shape[j], shape[i]             # <<<<<<<<<<<<<<
  * 
  *         if memslice.suboffsets[i] >= 0 or memslice.suboffsets[j] >= 0:
  */
     __pyx_t_6 = (__pyx_v_shape[__pyx_v_j]);
     __pyx_t_5 = (__pyx_v_shape[__pyx_v_i]);
     (__pyx_v_shape[__pyx_v_i]) = __pyx_t_6;
     (__pyx_v_shape[__pyx_v_j]) = __pyx_t_5;
 
-    /* "View.MemoryView":952
+    /* "View.MemoryView":958
  *         shape[i], shape[j] = shape[j], shape[i]
  * 
  *         if memslice.suboffsets[i] >= 0 or memslice.suboffsets[j] >= 0:             # <<<<<<<<<<<<<<
  *             _err(ValueError, "Cannot transpose memoryview with indirect dimensions")
  * 
  */
     __pyx_t_8 = (((__pyx_v_memslice->suboffsets[__pyx_v_i]) >= 0) != 0);
@@ -27947,44 +29766,44 @@
       goto __pyx_L6_bool_binop_done;
     }
     __pyx_t_8 = (((__pyx_v_memslice->suboffsets[__pyx_v_j]) >= 0) != 0);
     __pyx_t_7 = __pyx_t_8;
     __pyx_L6_bool_binop_done:;
     if (__pyx_t_7) {
 
-      /* "View.MemoryView":953
+      /* "View.MemoryView":959
  * 
  *         if memslice.suboffsets[i] >= 0 or memslice.suboffsets[j] >= 0:
  *             _err(ValueError, "Cannot transpose memoryview with indirect dimensions")             # <<<<<<<<<<<<<<
  * 
  *     return 1
  */
-      __pyx_t_9 = __pyx_memoryview_err(__pyx_builtin_ValueError, ((char *)"Cannot transpose memoryview with indirect dimensions")); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 953, __pyx_L1_error)
+      __pyx_t_9 = __pyx_memoryview_err(__pyx_builtin_ValueError, ((char *)"Cannot transpose memoryview with indirect dimensions")); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(1, 959, __pyx_L1_error)
 
-      /* "View.MemoryView":952
+      /* "View.MemoryView":958
  *         shape[i], shape[j] = shape[j], shape[i]
  * 
  *         if memslice.suboffsets[i] >= 0 or memslice.suboffsets[j] >= 0:             # <<<<<<<<<<<<<<
  *             _err(ValueError, "Cannot transpose memoryview with indirect dimensions")
  * 
  */
     }
   }
 
-  /* "View.MemoryView":955
+  /* "View.MemoryView":961
  *             _err(ValueError, "Cannot transpose memoryview with indirect dimensions")
  * 
  *     return 1             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = 1;
   goto __pyx_L0;
 
-  /* "View.MemoryView":939
+  /* "View.MemoryView":945
  * 
  * @cname('__pyx_memslice_transpose')
  * cdef int transpose_memslice(__Pyx_memviewslice *memslice) nogil except 0:             # <<<<<<<<<<<<<<
  *     cdef int ndim = memslice.memview.view.ndim
  * 
  */
 
@@ -28000,15 +29819,15 @@
     #endif
   }
   __pyx_r = 0;
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "View.MemoryView":972
+/* "View.MemoryView":978
  *     cdef int (*to_dtype_func)(char *, object) except 0
  * 
  *     def __dealloc__(self):             # <<<<<<<<<<<<<<
  *         __PYX_XDEC_MEMVIEW(&self.from_slice, 1)
  * 
  */
 
@@ -28023,100 +29842,103 @@
   __Pyx_RefNannyFinishContext();
 }
 
 static void __pyx_memoryviewslice___pyx_pf_15View_dot_MemoryView_16_memoryviewslice___dealloc__(struct __pyx_memoryviewslice_obj *__pyx_v_self) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__dealloc__", 0);
 
-  /* "View.MemoryView":973
+  /* "View.MemoryView":979
  * 
  *     def __dealloc__(self):
  *         __PYX_XDEC_MEMVIEW(&self.from_slice, 1)             # <<<<<<<<<<<<<<
  * 
  *     cdef convert_item_to_object(self, char *itemp):
  */
   __PYX_XDEC_MEMVIEW((&__pyx_v_self->from_slice), 1);
 
-  /* "View.MemoryView":972
+  /* "View.MemoryView":978
  *     cdef int (*to_dtype_func)(char *, object) except 0
  * 
  *     def __dealloc__(self):             # <<<<<<<<<<<<<<
  *         __PYX_XDEC_MEMVIEW(&self.from_slice, 1)
  * 
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
 }
 
-/* "View.MemoryView":975
+/* "View.MemoryView":981
  *         __PYX_XDEC_MEMVIEW(&self.from_slice, 1)
  * 
  *     cdef convert_item_to_object(self, char *itemp):             # <<<<<<<<<<<<<<
  *         if self.to_object_func != NULL:
  *             return self.to_object_func(itemp)
  */
 
 static PyObject *__pyx_memoryviewslice_convert_item_to_object(struct __pyx_memoryviewslice_obj *__pyx_v_self, char *__pyx_v_itemp) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("convert_item_to_object", 0);
 
-  /* "View.MemoryView":976
+  /* "View.MemoryView":982
  * 
  *     cdef convert_item_to_object(self, char *itemp):
  *         if self.to_object_func != NULL:             # <<<<<<<<<<<<<<
  *             return self.to_object_func(itemp)
  *         else:
  */
   __pyx_t_1 = ((__pyx_v_self->to_object_func != NULL) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":977
+    /* "View.MemoryView":983
  *     cdef convert_item_to_object(self, char *itemp):
  *         if self.to_object_func != NULL:
  *             return self.to_object_func(itemp)             # <<<<<<<<<<<<<<
  *         else:
  *             return memoryview.convert_item_to_object(self, itemp)
  */
     __Pyx_XDECREF(__pyx_r);
-    __pyx_t_2 = __pyx_v_self->to_object_func(__pyx_v_itemp); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 977, __pyx_L1_error)
+    __pyx_t_2 = __pyx_v_self->to_object_func(__pyx_v_itemp); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 983, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __pyx_r = __pyx_t_2;
     __pyx_t_2 = 0;
     goto __pyx_L0;
 
-    /* "View.MemoryView":976
+    /* "View.MemoryView":982
  * 
  *     cdef convert_item_to_object(self, char *itemp):
  *         if self.to_object_func != NULL:             # <<<<<<<<<<<<<<
  *             return self.to_object_func(itemp)
  *         else:
  */
   }
 
-  /* "View.MemoryView":979
+  /* "View.MemoryView":985
  *             return self.to_object_func(itemp)
  *         else:
  *             return memoryview.convert_item_to_object(self, itemp)             # <<<<<<<<<<<<<<
  * 
  *     cdef assign_item_from_object(self, char *itemp, object value):
  */
   /*else*/ {
     __Pyx_XDECREF(__pyx_r);
-    __pyx_t_2 = __pyx_memoryview_convert_item_to_object(((struct __pyx_memoryview_obj *)__pyx_v_self), __pyx_v_itemp); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 979, __pyx_L1_error)
+    __pyx_t_2 = __pyx_memoryview_convert_item_to_object(((struct __pyx_memoryview_obj *)__pyx_v_self), __pyx_v_itemp); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 985, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __pyx_r = __pyx_t_2;
     __pyx_t_2 = 0;
     goto __pyx_L0;
   }
 
-  /* "View.MemoryView":975
+  /* "View.MemoryView":981
  *         __PYX_XDEC_MEMVIEW(&self.from_slice, 1)
  * 
  *     cdef convert_item_to_object(self, char *itemp):             # <<<<<<<<<<<<<<
  *         if self.to_object_func != NULL:
  *             return self.to_object_func(itemp)
  */
 
@@ -28127,74 +29949,77 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":981
+/* "View.MemoryView":987
  *             return memoryview.convert_item_to_object(self, itemp)
  * 
  *     cdef assign_item_from_object(self, char *itemp, object value):             # <<<<<<<<<<<<<<
  *         if self.to_dtype_func != NULL:
  *             self.to_dtype_func(itemp, value)
  */
 
 static PyObject *__pyx_memoryviewslice_assign_item_from_object(struct __pyx_memoryviewslice_obj *__pyx_v_self, char *__pyx_v_itemp, PyObject *__pyx_v_value) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("assign_item_from_object", 0);
 
-  /* "View.MemoryView":982
+  /* "View.MemoryView":988
  * 
  *     cdef assign_item_from_object(self, char *itemp, object value):
  *         if self.to_dtype_func != NULL:             # <<<<<<<<<<<<<<
  *             self.to_dtype_func(itemp, value)
  *         else:
  */
   __pyx_t_1 = ((__pyx_v_self->to_dtype_func != NULL) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":983
+    /* "View.MemoryView":989
  *     cdef assign_item_from_object(self, char *itemp, object value):
  *         if self.to_dtype_func != NULL:
  *             self.to_dtype_func(itemp, value)             # <<<<<<<<<<<<<<
  *         else:
  *             memoryview.assign_item_from_object(self, itemp, value)
  */
-    __pyx_t_2 = __pyx_v_self->to_dtype_func(__pyx_v_itemp, __pyx_v_value); if (unlikely(__pyx_t_2 == ((int)0))) __PYX_ERR(1, 983, __pyx_L1_error)
+    __pyx_t_2 = __pyx_v_self->to_dtype_func(__pyx_v_itemp, __pyx_v_value); if (unlikely(__pyx_t_2 == ((int)0))) __PYX_ERR(1, 989, __pyx_L1_error)
 
-    /* "View.MemoryView":982
+    /* "View.MemoryView":988
  * 
  *     cdef assign_item_from_object(self, char *itemp, object value):
  *         if self.to_dtype_func != NULL:             # <<<<<<<<<<<<<<
  *             self.to_dtype_func(itemp, value)
  *         else:
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":985
+  /* "View.MemoryView":991
  *             self.to_dtype_func(itemp, value)
  *         else:
  *             memoryview.assign_item_from_object(self, itemp, value)             # <<<<<<<<<<<<<<
  * 
  *     @property
  */
   /*else*/ {
-    __pyx_t_3 = __pyx_memoryview_assign_item_from_object(((struct __pyx_memoryview_obj *)__pyx_v_self), __pyx_v_itemp, __pyx_v_value); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 985, __pyx_L1_error)
+    __pyx_t_3 = __pyx_memoryview_assign_item_from_object(((struct __pyx_memoryview_obj *)__pyx_v_self), __pyx_v_itemp, __pyx_v_value); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 991, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":981
+  /* "View.MemoryView":987
  *             return memoryview.convert_item_to_object(self, itemp)
  * 
  *     cdef assign_item_from_object(self, char *itemp, object value):             # <<<<<<<<<<<<<<
  *         if self.to_dtype_func != NULL:
  *             self.to_dtype_func(itemp, value)
  */
 
@@ -28207,15 +30032,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":988
+/* "View.MemoryView":994
  * 
  *     @property
  *     def base(self):             # <<<<<<<<<<<<<<
  *         return self.from_object
  * 
  */
 
@@ -28233,27 +30058,27 @@
 }
 
 static PyObject *__pyx_pf_15View_dot_MemoryView_16_memoryviewslice_4base___get__(struct __pyx_memoryviewslice_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__get__", 0);
 
-  /* "View.MemoryView":989
+  /* "View.MemoryView":995
  *     @property
  *     def base(self):
  *         return self.from_object             # <<<<<<<<<<<<<<
  * 
  *     __pyx_getbuffer = capsule(<void *> &__pyx_memoryview_getbuffer, "getbuffer(obj, view, flags)")
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(__pyx_v_self->from_object);
   __pyx_r = __pyx_v_self->from_object;
   goto __pyx_L0;
 
-  /* "View.MemoryView":988
+  /* "View.MemoryView":994
  * 
  *     @property
  *     def base(self):             # <<<<<<<<<<<<<<
  *         return self.from_object
  * 
  */
 
@@ -28283,14 +30108,17 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf___pyx_memoryviewslice___reduce_cython__(CYTHON_UNUSED struct __pyx_memoryviewslice_obj *__pyx_v_self) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__reduce_cython__", 0);
 
   /* "(tree fragment)":2
  * def __reduce_cython__(self):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
@@ -28337,14 +30165,17 @@
   return __pyx_r;
 }
 
 static PyObject *__pyx_pf___pyx_memoryviewslice_2__setstate_cython__(CYTHON_UNUSED struct __pyx_memoryviewslice_obj *__pyx_v_self, CYTHON_UNUSED PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__setstate_cython__", 0);
 
   /* "(tree fragment)":4
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  */
@@ -28367,15 +30198,15 @@
   __Pyx_AddTraceback("View.MemoryView._memoryviewslice.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":995
+/* "View.MemoryView":1001
  * 
  * @cname('__pyx_memoryview_fromslice')
  * cdef memoryview_fromslice(__Pyx_memviewslice memviewslice,             # <<<<<<<<<<<<<<
  *                           int ndim,
  *                           object (*to_object_func)(char *),
  */
 
@@ -28390,353 +30221,356 @@
   PyObject *__pyx_t_3 = NULL;
   __Pyx_TypeInfo *__pyx_t_4;
   Py_buffer __pyx_t_5;
   Py_ssize_t *__pyx_t_6;
   Py_ssize_t *__pyx_t_7;
   Py_ssize_t *__pyx_t_8;
   Py_ssize_t __pyx_t_9;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("memoryview_fromslice", 0);
 
-  /* "View.MemoryView":1003
+  /* "View.MemoryView":1009
  *     cdef _memoryviewslice result
  * 
  *     if <PyObject *> memviewslice.memview == Py_None:             # <<<<<<<<<<<<<<
  *         return None
  * 
  */
   __pyx_t_1 = ((((PyObject *)__pyx_v_memviewslice.memview) == Py_None) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":1004
+    /* "View.MemoryView":1010
  * 
  *     if <PyObject *> memviewslice.memview == Py_None:
  *         return None             # <<<<<<<<<<<<<<
  * 
  * 
  */
     __Pyx_XDECREF(__pyx_r);
     __pyx_r = Py_None; __Pyx_INCREF(Py_None);
     goto __pyx_L0;
 
-    /* "View.MemoryView":1003
+    /* "View.MemoryView":1009
  *     cdef _memoryviewslice result
  * 
  *     if <PyObject *> memviewslice.memview == Py_None:             # <<<<<<<<<<<<<<
  *         return None
  * 
  */
   }
 
-  /* "View.MemoryView":1009
+  /* "View.MemoryView":1015
  * 
  * 
  *     result = _memoryviewslice(None, 0, dtype_is_object)             # <<<<<<<<<<<<<<
  * 
  *     result.from_slice = memviewslice
  */
-  __pyx_t_2 = __Pyx_PyBool_FromLong(__pyx_v_dtype_is_object); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1009, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyBool_FromLong(__pyx_v_dtype_is_object); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1015, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1009, __pyx_L1_error)
+  __pyx_t_3 = PyTuple_New(3); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1015, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_INCREF(Py_None);
   __Pyx_GIVEREF(Py_None);
   PyTuple_SET_ITEM(__pyx_t_3, 0, Py_None);
   __Pyx_INCREF(__pyx_int_0);
   __Pyx_GIVEREF(__pyx_int_0);
   PyTuple_SET_ITEM(__pyx_t_3, 1, __pyx_int_0);
   __Pyx_GIVEREF(__pyx_t_2);
   PyTuple_SET_ITEM(__pyx_t_3, 2, __pyx_t_2);
   __pyx_t_2 = 0;
-  __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)__pyx_memoryviewslice_type), __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1009, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_Call(((PyObject *)__pyx_memoryviewslice_type), __pyx_t_3, NULL); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1015, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __pyx_v_result = ((struct __pyx_memoryviewslice_obj *)__pyx_t_2);
   __pyx_t_2 = 0;
 
-  /* "View.MemoryView":1011
+  /* "View.MemoryView":1017
  *     result = _memoryviewslice(None, 0, dtype_is_object)
  * 
  *     result.from_slice = memviewslice             # <<<<<<<<<<<<<<
  *     __PYX_INC_MEMVIEW(&memviewslice, 1)
  * 
  */
   __pyx_v_result->from_slice = __pyx_v_memviewslice;
 
-  /* "View.MemoryView":1012
+  /* "View.MemoryView":1018
  * 
  *     result.from_slice = memviewslice
  *     __PYX_INC_MEMVIEW(&memviewslice, 1)             # <<<<<<<<<<<<<<
  * 
  *     result.from_object = (<memoryview> memviewslice.memview).base
  */
   __PYX_INC_MEMVIEW((&__pyx_v_memviewslice), 1);
 
-  /* "View.MemoryView":1014
+  /* "View.MemoryView":1020
  *     __PYX_INC_MEMVIEW(&memviewslice, 1)
  * 
  *     result.from_object = (<memoryview> memviewslice.memview).base             # <<<<<<<<<<<<<<
  *     result.typeinfo = memviewslice.memview.typeinfo
  * 
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_memviewslice.memview), __pyx_n_s_base); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1014, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_memviewslice.memview), __pyx_n_s_base); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1020, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_GIVEREF(__pyx_t_2);
   __Pyx_GOTREF(__pyx_v_result->from_object);
   __Pyx_DECREF(__pyx_v_result->from_object);
   __pyx_v_result->from_object = __pyx_t_2;
   __pyx_t_2 = 0;
 
-  /* "View.MemoryView":1015
+  /* "View.MemoryView":1021
  * 
  *     result.from_object = (<memoryview> memviewslice.memview).base
  *     result.typeinfo = memviewslice.memview.typeinfo             # <<<<<<<<<<<<<<
  * 
  *     result.view = memviewslice.memview.view
  */
   __pyx_t_4 = __pyx_v_memviewslice.memview->typeinfo;
   __pyx_v_result->__pyx_base.typeinfo = __pyx_t_4;
 
-  /* "View.MemoryView":1017
+  /* "View.MemoryView":1023
  *     result.typeinfo = memviewslice.memview.typeinfo
  * 
  *     result.view = memviewslice.memview.view             # <<<<<<<<<<<<<<
  *     result.view.buf = <void *> memviewslice.data
  *     result.view.ndim = ndim
  */
   __pyx_t_5 = __pyx_v_memviewslice.memview->view;
   __pyx_v_result->__pyx_base.view = __pyx_t_5;
 
-  /* "View.MemoryView":1018
+  /* "View.MemoryView":1024
  * 
  *     result.view = memviewslice.memview.view
  *     result.view.buf = <void *> memviewslice.data             # <<<<<<<<<<<<<<
  *     result.view.ndim = ndim
  *     (<__pyx_buffer *> &result.view).obj = Py_None
  */
   __pyx_v_result->__pyx_base.view.buf = ((void *)__pyx_v_memviewslice.data);
 
-  /* "View.MemoryView":1019
+  /* "View.MemoryView":1025
  *     result.view = memviewslice.memview.view
  *     result.view.buf = <void *> memviewslice.data
  *     result.view.ndim = ndim             # <<<<<<<<<<<<<<
  *     (<__pyx_buffer *> &result.view).obj = Py_None
  *     Py_INCREF(Py_None)
  */
   __pyx_v_result->__pyx_base.view.ndim = __pyx_v_ndim;
 
-  /* "View.MemoryView":1020
+  /* "View.MemoryView":1026
  *     result.view.buf = <void *> memviewslice.data
  *     result.view.ndim = ndim
  *     (<__pyx_buffer *> &result.view).obj = Py_None             # <<<<<<<<<<<<<<
  *     Py_INCREF(Py_None)
  * 
  */
   ((Py_buffer *)(&__pyx_v_result->__pyx_base.view))->obj = Py_None;
 
-  /* "View.MemoryView":1021
+  /* "View.MemoryView":1027
  *     result.view.ndim = ndim
  *     (<__pyx_buffer *> &result.view).obj = Py_None
  *     Py_INCREF(Py_None)             # <<<<<<<<<<<<<<
  * 
  *     if (<memoryview>memviewslice.memview).flags & PyBUF_WRITABLE:
  */
   Py_INCREF(Py_None);
 
-  /* "View.MemoryView":1023
+  /* "View.MemoryView":1029
  *     Py_INCREF(Py_None)
  * 
  *     if (<memoryview>memviewslice.memview).flags & PyBUF_WRITABLE:             # <<<<<<<<<<<<<<
  *         result.flags = PyBUF_RECORDS
  *     else:
  */
   __pyx_t_1 = ((((struct __pyx_memoryview_obj *)__pyx_v_memviewslice.memview)->flags & PyBUF_WRITABLE) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":1024
+    /* "View.MemoryView":1030
  * 
  *     if (<memoryview>memviewslice.memview).flags & PyBUF_WRITABLE:
  *         result.flags = PyBUF_RECORDS             # <<<<<<<<<<<<<<
  *     else:
  *         result.flags = PyBUF_RECORDS_RO
  */
     __pyx_v_result->__pyx_base.flags = PyBUF_RECORDS;
 
-    /* "View.MemoryView":1023
+    /* "View.MemoryView":1029
  *     Py_INCREF(Py_None)
  * 
  *     if (<memoryview>memviewslice.memview).flags & PyBUF_WRITABLE:             # <<<<<<<<<<<<<<
  *         result.flags = PyBUF_RECORDS
  *     else:
  */
     goto __pyx_L4;
   }
 
-  /* "View.MemoryView":1026
+  /* "View.MemoryView":1032
  *         result.flags = PyBUF_RECORDS
  *     else:
  *         result.flags = PyBUF_RECORDS_RO             # <<<<<<<<<<<<<<
  * 
  *     result.view.shape = <Py_ssize_t *> result.from_slice.shape
  */
   /*else*/ {
     __pyx_v_result->__pyx_base.flags = PyBUF_RECORDS_RO;
   }
   __pyx_L4:;
 
-  /* "View.MemoryView":1028
+  /* "View.MemoryView":1034
  *         result.flags = PyBUF_RECORDS_RO
  * 
  *     result.view.shape = <Py_ssize_t *> result.from_slice.shape             # <<<<<<<<<<<<<<
  *     result.view.strides = <Py_ssize_t *> result.from_slice.strides
  * 
  */
   __pyx_v_result->__pyx_base.view.shape = ((Py_ssize_t *)__pyx_v_result->from_slice.shape);
 
-  /* "View.MemoryView":1029
+  /* "View.MemoryView":1035
  * 
  *     result.view.shape = <Py_ssize_t *> result.from_slice.shape
  *     result.view.strides = <Py_ssize_t *> result.from_slice.strides             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_v_result->__pyx_base.view.strides = ((Py_ssize_t *)__pyx_v_result->from_slice.strides);
 
-  /* "View.MemoryView":1032
+  /* "View.MemoryView":1038
  * 
  * 
  *     result.view.suboffsets = NULL             # <<<<<<<<<<<<<<
  *     for suboffset in result.from_slice.suboffsets[:ndim]:
  *         if suboffset >= 0:
  */
   __pyx_v_result->__pyx_base.view.suboffsets = NULL;
 
-  /* "View.MemoryView":1033
+  /* "View.MemoryView":1039
  * 
  *     result.view.suboffsets = NULL
  *     for suboffset in result.from_slice.suboffsets[:ndim]:             # <<<<<<<<<<<<<<
  *         if suboffset >= 0:
  *             result.view.suboffsets = <Py_ssize_t *> result.from_slice.suboffsets
  */
   __pyx_t_7 = (__pyx_v_result->from_slice.suboffsets + __pyx_v_ndim);
   for (__pyx_t_8 = __pyx_v_result->from_slice.suboffsets; __pyx_t_8 < __pyx_t_7; __pyx_t_8++) {
     __pyx_t_6 = __pyx_t_8;
     __pyx_v_suboffset = (__pyx_t_6[0]);
 
-    /* "View.MemoryView":1034
+    /* "View.MemoryView":1040
  *     result.view.suboffsets = NULL
  *     for suboffset in result.from_slice.suboffsets[:ndim]:
  *         if suboffset >= 0:             # <<<<<<<<<<<<<<
  *             result.view.suboffsets = <Py_ssize_t *> result.from_slice.suboffsets
  *             break
  */
     __pyx_t_1 = ((__pyx_v_suboffset >= 0) != 0);
     if (__pyx_t_1) {
 
-      /* "View.MemoryView":1035
+      /* "View.MemoryView":1041
  *     for suboffset in result.from_slice.suboffsets[:ndim]:
  *         if suboffset >= 0:
  *             result.view.suboffsets = <Py_ssize_t *> result.from_slice.suboffsets             # <<<<<<<<<<<<<<
  *             break
  * 
  */
       __pyx_v_result->__pyx_base.view.suboffsets = ((Py_ssize_t *)__pyx_v_result->from_slice.suboffsets);
 
-      /* "View.MemoryView":1036
+      /* "View.MemoryView":1042
  *         if suboffset >= 0:
  *             result.view.suboffsets = <Py_ssize_t *> result.from_slice.suboffsets
  *             break             # <<<<<<<<<<<<<<
  * 
  *     result.view.len = result.view.itemsize
  */
       goto __pyx_L6_break;
 
-      /* "View.MemoryView":1034
+      /* "View.MemoryView":1040
  *     result.view.suboffsets = NULL
  *     for suboffset in result.from_slice.suboffsets[:ndim]:
  *         if suboffset >= 0:             # <<<<<<<<<<<<<<
  *             result.view.suboffsets = <Py_ssize_t *> result.from_slice.suboffsets
  *             break
  */
     }
   }
   __pyx_L6_break:;
 
-  /* "View.MemoryView":1038
+  /* "View.MemoryView":1044
  *             break
  * 
  *     result.view.len = result.view.itemsize             # <<<<<<<<<<<<<<
  *     for length in result.view.shape[:ndim]:
  *         result.view.len *= length
  */
   __pyx_t_9 = __pyx_v_result->__pyx_base.view.itemsize;
   __pyx_v_result->__pyx_base.view.len = __pyx_t_9;
 
-  /* "View.MemoryView":1039
+  /* "View.MemoryView":1045
  * 
  *     result.view.len = result.view.itemsize
  *     for length in result.view.shape[:ndim]:             # <<<<<<<<<<<<<<
  *         result.view.len *= length
  * 
  */
   __pyx_t_7 = (__pyx_v_result->__pyx_base.view.shape + __pyx_v_ndim);
   for (__pyx_t_8 = __pyx_v_result->__pyx_base.view.shape; __pyx_t_8 < __pyx_t_7; __pyx_t_8++) {
     __pyx_t_6 = __pyx_t_8;
-    __pyx_t_2 = PyInt_FromSsize_t((__pyx_t_6[0])); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1039, __pyx_L1_error)
+    __pyx_t_2 = PyInt_FromSsize_t((__pyx_t_6[0])); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1045, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_XDECREF_SET(__pyx_v_length, __pyx_t_2);
     __pyx_t_2 = 0;
 
-    /* "View.MemoryView":1040
+    /* "View.MemoryView":1046
  *     result.view.len = result.view.itemsize
  *     for length in result.view.shape[:ndim]:
  *         result.view.len *= length             # <<<<<<<<<<<<<<
  * 
  *     result.to_object_func = to_object_func
  */
-    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_result->__pyx_base.view.len); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1040, __pyx_L1_error)
+    __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_result->__pyx_base.view.len); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1046, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_3 = PyNumber_InPlaceMultiply(__pyx_t_2, __pyx_v_length); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1040, __pyx_L1_error)
+    __pyx_t_3 = PyNumber_InPlaceMultiply(__pyx_t_2, __pyx_v_length); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1046, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_9 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_9 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 1040, __pyx_L1_error)
+    __pyx_t_9 = __Pyx_PyIndex_AsSsize_t(__pyx_t_3); if (unlikely((__pyx_t_9 == (Py_ssize_t)-1) && PyErr_Occurred())) __PYX_ERR(1, 1046, __pyx_L1_error)
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __pyx_v_result->__pyx_base.view.len = __pyx_t_9;
   }
 
-  /* "View.MemoryView":1042
+  /* "View.MemoryView":1048
  *         result.view.len *= length
  * 
  *     result.to_object_func = to_object_func             # <<<<<<<<<<<<<<
  *     result.to_dtype_func = to_dtype_func
  * 
  */
   __pyx_v_result->to_object_func = __pyx_v_to_object_func;
 
-  /* "View.MemoryView":1043
+  /* "View.MemoryView":1049
  * 
  *     result.to_object_func = to_object_func
  *     result.to_dtype_func = to_dtype_func             # <<<<<<<<<<<<<<
  * 
  *     return result
  */
   __pyx_v_result->to_dtype_func = __pyx_v_to_dtype_func;
 
-  /* "View.MemoryView":1045
+  /* "View.MemoryView":1051
  *     result.to_dtype_func = to_dtype_func
  * 
  *     return result             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_get_slice_from_memoryview')
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(((PyObject *)__pyx_v_result));
   __pyx_r = ((PyObject *)__pyx_v_result);
   goto __pyx_L0;
 
-  /* "View.MemoryView":995
+  /* "View.MemoryView":1001
  * 
  * @cname('__pyx_memoryview_fromslice')
  * cdef memoryview_fromslice(__Pyx_memviewslice memviewslice,             # <<<<<<<<<<<<<<
  *                           int ndim,
  *                           object (*to_object_func)(char *),
  */
 
@@ -28750,115 +30584,118 @@
   __Pyx_XDECREF((PyObject *)__pyx_v_result);
   __Pyx_XDECREF(__pyx_v_length);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":1048
+/* "View.MemoryView":1054
  * 
  * @cname('__pyx_memoryview_get_slice_from_memoryview')
  * cdef __Pyx_memviewslice *get_slice_from_memview(memoryview memview,             # <<<<<<<<<<<<<<
- *                                                    __Pyx_memviewslice *mslice):
+ *                                                    __Pyx_memviewslice *mslice) except NULL:
  *     cdef _memoryviewslice obj
  */
 
 static __Pyx_memviewslice *__pyx_memoryview_get_slice_from_memoryview(struct __pyx_memoryview_obj *__pyx_v_memview, __Pyx_memviewslice *__pyx_v_mslice) {
   struct __pyx_memoryviewslice_obj *__pyx_v_obj = 0;
   __Pyx_memviewslice *__pyx_r;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("get_slice_from_memview", 0);
 
-  /* "View.MemoryView":1051
- *                                                    __Pyx_memviewslice *mslice):
+  /* "View.MemoryView":1057
+ *                                                    __Pyx_memviewslice *mslice) except NULL:
  *     cdef _memoryviewslice obj
  *     if isinstance(memview, _memoryviewslice):             # <<<<<<<<<<<<<<
  *         obj = memview
  *         return &obj.from_slice
  */
   __pyx_t_1 = __Pyx_TypeCheck(((PyObject *)__pyx_v_memview), __pyx_memoryviewslice_type); 
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":1052
+    /* "View.MemoryView":1058
  *     cdef _memoryviewslice obj
  *     if isinstance(memview, _memoryviewslice):
  *         obj = memview             # <<<<<<<<<<<<<<
  *         return &obj.from_slice
  *     else:
  */
-    if (!(likely(((((PyObject *)__pyx_v_memview)) == Py_None) || likely(__Pyx_TypeTest(((PyObject *)__pyx_v_memview), __pyx_memoryviewslice_type))))) __PYX_ERR(1, 1052, __pyx_L1_error)
+    if (!(likely(((((PyObject *)__pyx_v_memview)) == Py_None) || likely(__Pyx_TypeTest(((PyObject *)__pyx_v_memview), __pyx_memoryviewslice_type))))) __PYX_ERR(1, 1058, __pyx_L1_error)
     __pyx_t_3 = ((PyObject *)__pyx_v_memview);
     __Pyx_INCREF(__pyx_t_3);
     __pyx_v_obj = ((struct __pyx_memoryviewslice_obj *)__pyx_t_3);
     __pyx_t_3 = 0;
 
-    /* "View.MemoryView":1053
+    /* "View.MemoryView":1059
  *     if isinstance(memview, _memoryviewslice):
  *         obj = memview
  *         return &obj.from_slice             # <<<<<<<<<<<<<<
  *     else:
  *         slice_copy(memview, mslice)
  */
     __pyx_r = (&__pyx_v_obj->from_slice);
     goto __pyx_L0;
 
-    /* "View.MemoryView":1051
- *                                                    __Pyx_memviewslice *mslice):
+    /* "View.MemoryView":1057
+ *                                                    __Pyx_memviewslice *mslice) except NULL:
  *     cdef _memoryviewslice obj
  *     if isinstance(memview, _memoryviewslice):             # <<<<<<<<<<<<<<
  *         obj = memview
  *         return &obj.from_slice
  */
   }
 
-  /* "View.MemoryView":1055
+  /* "View.MemoryView":1061
  *         return &obj.from_slice
  *     else:
  *         slice_copy(memview, mslice)             # <<<<<<<<<<<<<<
  *         return mslice
  * 
  */
   /*else*/ {
     __pyx_memoryview_slice_copy(__pyx_v_memview, __pyx_v_mslice);
 
-    /* "View.MemoryView":1056
+    /* "View.MemoryView":1062
  *     else:
  *         slice_copy(memview, mslice)
  *         return mslice             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_slice_copy')
  */
     __pyx_r = __pyx_v_mslice;
     goto __pyx_L0;
   }
 
-  /* "View.MemoryView":1048
+  /* "View.MemoryView":1054
  * 
  * @cname('__pyx_memoryview_get_slice_from_memoryview')
  * cdef __Pyx_memviewslice *get_slice_from_memview(memoryview memview,             # <<<<<<<<<<<<<<
- *                                                    __Pyx_memviewslice *mslice):
+ *                                                    __Pyx_memviewslice *mslice) except NULL:
  *     cdef _memoryviewslice obj
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_WriteUnraisable("View.MemoryView.get_slice_from_memview", __pyx_clineno, __pyx_lineno, __pyx_filename, 1, 0);
-  __pyx_r = 0;
+  __Pyx_AddTraceback("View.MemoryView.get_slice_from_memview", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XDECREF((PyObject *)__pyx_v_obj);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":1059
+/* "View.MemoryView":1065
  * 
  * @cname('__pyx_memoryview_slice_copy')
  * cdef void slice_copy(memoryview memview, __Pyx_memviewslice *dst):             # <<<<<<<<<<<<<<
  *     cdef int dim
  *     cdef (Py_ssize_t*) shape, strides, suboffsets
  */
 
@@ -28871,158 +30708,161 @@
   Py_ssize_t *__pyx_t_1;
   int __pyx_t_2;
   int __pyx_t_3;
   int __pyx_t_4;
   Py_ssize_t __pyx_t_5;
   __Pyx_RefNannySetupContext("slice_copy", 0);
 
-  /* "View.MemoryView":1063
+  /* "View.MemoryView":1069
  *     cdef (Py_ssize_t*) shape, strides, suboffsets
  * 
  *     shape = memview.view.shape             # <<<<<<<<<<<<<<
  *     strides = memview.view.strides
  *     suboffsets = memview.view.suboffsets
  */
   __pyx_t_1 = __pyx_v_memview->view.shape;
   __pyx_v_shape = __pyx_t_1;
 
-  /* "View.MemoryView":1064
+  /* "View.MemoryView":1070
  * 
  *     shape = memview.view.shape
  *     strides = memview.view.strides             # <<<<<<<<<<<<<<
  *     suboffsets = memview.view.suboffsets
  * 
  */
   __pyx_t_1 = __pyx_v_memview->view.strides;
   __pyx_v_strides = __pyx_t_1;
 
-  /* "View.MemoryView":1065
+  /* "View.MemoryView":1071
  *     shape = memview.view.shape
  *     strides = memview.view.strides
  *     suboffsets = memview.view.suboffsets             # <<<<<<<<<<<<<<
  * 
  *     dst.memview = <__pyx_memoryview *> memview
  */
   __pyx_t_1 = __pyx_v_memview->view.suboffsets;
   __pyx_v_suboffsets = __pyx_t_1;
 
-  /* "View.MemoryView":1067
+  /* "View.MemoryView":1073
  *     suboffsets = memview.view.suboffsets
  * 
  *     dst.memview = <__pyx_memoryview *> memview             # <<<<<<<<<<<<<<
  *     dst.data = <char *> memview.view.buf
  * 
  */
   __pyx_v_dst->memview = ((struct __pyx_memoryview_obj *)__pyx_v_memview);
 
-  /* "View.MemoryView":1068
+  /* "View.MemoryView":1074
  * 
  *     dst.memview = <__pyx_memoryview *> memview
  *     dst.data = <char *> memview.view.buf             # <<<<<<<<<<<<<<
  * 
  *     for dim in range(memview.view.ndim):
  */
   __pyx_v_dst->data = ((char *)__pyx_v_memview->view.buf);
 
-  /* "View.MemoryView":1070
+  /* "View.MemoryView":1076
  *     dst.data = <char *> memview.view.buf
  * 
  *     for dim in range(memview.view.ndim):             # <<<<<<<<<<<<<<
  *         dst.shape[dim] = shape[dim]
  *         dst.strides[dim] = strides[dim]
  */
   __pyx_t_2 = __pyx_v_memview->view.ndim;
   __pyx_t_3 = __pyx_t_2;
   for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
     __pyx_v_dim = __pyx_t_4;
 
-    /* "View.MemoryView":1071
+    /* "View.MemoryView":1077
  * 
  *     for dim in range(memview.view.ndim):
  *         dst.shape[dim] = shape[dim]             # <<<<<<<<<<<<<<
  *         dst.strides[dim] = strides[dim]
  *         dst.suboffsets[dim] = suboffsets[dim] if suboffsets else -1
  */
     (__pyx_v_dst->shape[__pyx_v_dim]) = (__pyx_v_shape[__pyx_v_dim]);
 
-    /* "View.MemoryView":1072
+    /* "View.MemoryView":1078
  *     for dim in range(memview.view.ndim):
  *         dst.shape[dim] = shape[dim]
  *         dst.strides[dim] = strides[dim]             # <<<<<<<<<<<<<<
  *         dst.suboffsets[dim] = suboffsets[dim] if suboffsets else -1
  * 
  */
     (__pyx_v_dst->strides[__pyx_v_dim]) = (__pyx_v_strides[__pyx_v_dim]);
 
-    /* "View.MemoryView":1073
+    /* "View.MemoryView":1079
  *         dst.shape[dim] = shape[dim]
  *         dst.strides[dim] = strides[dim]
  *         dst.suboffsets[dim] = suboffsets[dim] if suboffsets else -1             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_copy_object')
  */
     if ((__pyx_v_suboffsets != 0)) {
       __pyx_t_5 = (__pyx_v_suboffsets[__pyx_v_dim]);
     } else {
       __pyx_t_5 = -1L;
     }
     (__pyx_v_dst->suboffsets[__pyx_v_dim]) = __pyx_t_5;
   }
 
-  /* "View.MemoryView":1059
+  /* "View.MemoryView":1065
  * 
  * @cname('__pyx_memoryview_slice_copy')
  * cdef void slice_copy(memoryview memview, __Pyx_memviewslice *dst):             # <<<<<<<<<<<<<<
  *     cdef int dim
  *     cdef (Py_ssize_t*) shape, strides, suboffsets
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
 }
 
-/* "View.MemoryView":1076
+/* "View.MemoryView":1082
  * 
  * @cname('__pyx_memoryview_copy_object')
  * cdef memoryview_copy(memoryview memview):             # <<<<<<<<<<<<<<
  *     "Create a new memoryview object"
  *     cdef __Pyx_memviewslice memviewslice
  */
 
 static PyObject *__pyx_memoryview_copy_object(struct __pyx_memoryview_obj *__pyx_v_memview) {
   __Pyx_memviewslice __pyx_v_memviewslice;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("memoryview_copy", 0);
 
-  /* "View.MemoryView":1079
+  /* "View.MemoryView":1085
  *     "Create a new memoryview object"
  *     cdef __Pyx_memviewslice memviewslice
  *     slice_copy(memview, &memviewslice)             # <<<<<<<<<<<<<<
  *     return memoryview_copy_from_slice(memview, &memviewslice)
  * 
  */
   __pyx_memoryview_slice_copy(__pyx_v_memview, (&__pyx_v_memviewslice));
 
-  /* "View.MemoryView":1080
+  /* "View.MemoryView":1086
  *     cdef __Pyx_memviewslice memviewslice
  *     slice_copy(memview, &memviewslice)
  *     return memoryview_copy_from_slice(memview, &memviewslice)             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_copy_object_from_slice')
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = __pyx_memoryview_copy_object_from_slice(__pyx_v_memview, (&__pyx_v_memviewslice)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 1080, __pyx_L1_error)
+  __pyx_t_1 = __pyx_memoryview_copy_object_from_slice(__pyx_v_memview, (&__pyx_v_memviewslice)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 1086, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":1076
+  /* "View.MemoryView":1082
  * 
  * @cname('__pyx_memoryview_copy_object')
  * cdef memoryview_copy(memoryview memview):             # <<<<<<<<<<<<<<
  *     "Create a new memoryview object"
  *     cdef __Pyx_memviewslice memviewslice
  */
 
@@ -29033,15 +30873,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":1083
+/* "View.MemoryView":1089
  * 
  * @cname('__pyx_memoryview_copy_object_from_slice')
  * cdef memoryview_copy_from_slice(memoryview memview, __Pyx_memviewslice *memviewslice):             # <<<<<<<<<<<<<<
  *     """
  *     Create a new memoryview object from a given memoryview object and slice.
  */
 
@@ -29051,101 +30891,104 @@
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   int __pyx_t_2;
   PyObject *(*__pyx_t_3)(char *);
   int (*__pyx_t_4)(char *, PyObject *);
   PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("memoryview_copy_from_slice", 0);
 
-  /* "View.MemoryView":1090
+  /* "View.MemoryView":1096
  *     cdef int (*to_dtype_func)(char *, object) except 0
  * 
  *     if isinstance(memview, _memoryviewslice):             # <<<<<<<<<<<<<<
  *         to_object_func = (<_memoryviewslice> memview).to_object_func
  *         to_dtype_func = (<_memoryviewslice> memview).to_dtype_func
  */
   __pyx_t_1 = __Pyx_TypeCheck(((PyObject *)__pyx_v_memview), __pyx_memoryviewslice_type); 
   __pyx_t_2 = (__pyx_t_1 != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":1091
+    /* "View.MemoryView":1097
  * 
  *     if isinstance(memview, _memoryviewslice):
  *         to_object_func = (<_memoryviewslice> memview).to_object_func             # <<<<<<<<<<<<<<
  *         to_dtype_func = (<_memoryviewslice> memview).to_dtype_func
  *     else:
  */
     __pyx_t_3 = ((struct __pyx_memoryviewslice_obj *)__pyx_v_memview)->to_object_func;
     __pyx_v_to_object_func = __pyx_t_3;
 
-    /* "View.MemoryView":1092
+    /* "View.MemoryView":1098
  *     if isinstance(memview, _memoryviewslice):
  *         to_object_func = (<_memoryviewslice> memview).to_object_func
  *         to_dtype_func = (<_memoryviewslice> memview).to_dtype_func             # <<<<<<<<<<<<<<
  *     else:
  *         to_object_func = NULL
  */
     __pyx_t_4 = ((struct __pyx_memoryviewslice_obj *)__pyx_v_memview)->to_dtype_func;
     __pyx_v_to_dtype_func = __pyx_t_4;
 
-    /* "View.MemoryView":1090
+    /* "View.MemoryView":1096
  *     cdef int (*to_dtype_func)(char *, object) except 0
  * 
  *     if isinstance(memview, _memoryviewslice):             # <<<<<<<<<<<<<<
  *         to_object_func = (<_memoryviewslice> memview).to_object_func
  *         to_dtype_func = (<_memoryviewslice> memview).to_dtype_func
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":1094
+  /* "View.MemoryView":1100
  *         to_dtype_func = (<_memoryviewslice> memview).to_dtype_func
  *     else:
  *         to_object_func = NULL             # <<<<<<<<<<<<<<
  *         to_dtype_func = NULL
  * 
  */
   /*else*/ {
     __pyx_v_to_object_func = NULL;
 
-    /* "View.MemoryView":1095
+    /* "View.MemoryView":1101
  *     else:
  *         to_object_func = NULL
  *         to_dtype_func = NULL             # <<<<<<<<<<<<<<
  * 
  *     return memoryview_fromslice(memviewslice[0], memview.view.ndim,
  */
     __pyx_v_to_dtype_func = NULL;
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":1097
+  /* "View.MemoryView":1103
  *         to_dtype_func = NULL
  * 
  *     return memoryview_fromslice(memviewslice[0], memview.view.ndim,             # <<<<<<<<<<<<<<
  *                                 to_object_func, to_dtype_func,
  *                                 memview.dtype_is_object)
  */
   __Pyx_XDECREF(__pyx_r);
 
-  /* "View.MemoryView":1099
+  /* "View.MemoryView":1105
  *     return memoryview_fromslice(memviewslice[0], memview.view.ndim,
  *                                 to_object_func, to_dtype_func,
  *                                 memview.dtype_is_object)             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_t_5 = __pyx_memoryview_fromslice((__pyx_v_memviewslice[0]), __pyx_v_memview->view.ndim, __pyx_v_to_object_func, __pyx_v_to_dtype_func, __pyx_v_memview->dtype_is_object); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1097, __pyx_L1_error)
+  __pyx_t_5 = __pyx_memoryview_fromslice((__pyx_v_memviewslice[0]), __pyx_v_memview->view.ndim, __pyx_v_to_object_func, __pyx_v_to_dtype_func, __pyx_v_memview->dtype_is_object); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1103, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
   __pyx_r = __pyx_t_5;
   __pyx_t_5 = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":1083
+  /* "View.MemoryView":1089
  * 
  * @cname('__pyx_memoryview_copy_object_from_slice')
  * cdef memoryview_copy_from_slice(memoryview memview, __Pyx_memviewslice *memviewslice):             # <<<<<<<<<<<<<<
  *     """
  *     Create a new memoryview object from a given memoryview object and slice.
  */
 
@@ -29156,81 +30999,81 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "View.MemoryView":1105
+/* "View.MemoryView":1111
  * 
  * 
  * cdef Py_ssize_t abs_py_ssize_t(Py_ssize_t arg) nogil:             # <<<<<<<<<<<<<<
  *     if arg < 0:
  *         return -arg
  */
 
 static Py_ssize_t abs_py_ssize_t(Py_ssize_t __pyx_v_arg) {
   Py_ssize_t __pyx_r;
   int __pyx_t_1;
 
-  /* "View.MemoryView":1106
+  /* "View.MemoryView":1112
  * 
  * cdef Py_ssize_t abs_py_ssize_t(Py_ssize_t arg) nogil:
  *     if arg < 0:             # <<<<<<<<<<<<<<
  *         return -arg
  *     else:
  */
   __pyx_t_1 = ((__pyx_v_arg < 0) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":1107
+    /* "View.MemoryView":1113
  * cdef Py_ssize_t abs_py_ssize_t(Py_ssize_t arg) nogil:
  *     if arg < 0:
  *         return -arg             # <<<<<<<<<<<<<<
  *     else:
  *         return arg
  */
     __pyx_r = (-__pyx_v_arg);
     goto __pyx_L0;
 
-    /* "View.MemoryView":1106
+    /* "View.MemoryView":1112
  * 
  * cdef Py_ssize_t abs_py_ssize_t(Py_ssize_t arg) nogil:
  *     if arg < 0:             # <<<<<<<<<<<<<<
  *         return -arg
  *     else:
  */
   }
 
-  /* "View.MemoryView":1109
+  /* "View.MemoryView":1115
  *         return -arg
  *     else:
  *         return arg             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_get_best_slice_order')
  */
   /*else*/ {
     __pyx_r = __pyx_v_arg;
     goto __pyx_L0;
   }
 
-  /* "View.MemoryView":1105
+  /* "View.MemoryView":1111
  * 
  * 
  * cdef Py_ssize_t abs_py_ssize_t(Py_ssize_t arg) nogil:             # <<<<<<<<<<<<<<
  *     if arg < 0:
  *         return -arg
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "View.MemoryView":1112
+/* "View.MemoryView":1118
  * 
  * @cname('__pyx_get_best_slice_order')
  * cdef char get_best_order(__Pyx_memviewslice *mslice, int ndim) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     Figure out the best memory access order for a given slice.
  */
 
@@ -29240,187 +31083,187 @@
   Py_ssize_t __pyx_v_f_stride;
   char __pyx_r;
   int __pyx_t_1;
   int __pyx_t_2;
   int __pyx_t_3;
   int __pyx_t_4;
 
-  /* "View.MemoryView":1117
+  /* "View.MemoryView":1123
  *     """
  *     cdef int i
  *     cdef Py_ssize_t c_stride = 0             # <<<<<<<<<<<<<<
  *     cdef Py_ssize_t f_stride = 0
  * 
  */
   __pyx_v_c_stride = 0;
 
-  /* "View.MemoryView":1118
+  /* "View.MemoryView":1124
  *     cdef int i
  *     cdef Py_ssize_t c_stride = 0
  *     cdef Py_ssize_t f_stride = 0             # <<<<<<<<<<<<<<
  * 
  *     for i in range(ndim - 1, -1, -1):
  */
   __pyx_v_f_stride = 0;
 
-  /* "View.MemoryView":1120
+  /* "View.MemoryView":1126
  *     cdef Py_ssize_t f_stride = 0
  * 
  *     for i in range(ndim - 1, -1, -1):             # <<<<<<<<<<<<<<
  *         if mslice.shape[i] > 1:
  *             c_stride = mslice.strides[i]
  */
   for (__pyx_t_1 = (__pyx_v_ndim - 1); __pyx_t_1 > -1; __pyx_t_1-=1) {
     __pyx_v_i = __pyx_t_1;
 
-    /* "View.MemoryView":1121
+    /* "View.MemoryView":1127
  * 
  *     for i in range(ndim - 1, -1, -1):
  *         if mslice.shape[i] > 1:             # <<<<<<<<<<<<<<
  *             c_stride = mslice.strides[i]
  *             break
  */
     __pyx_t_2 = (((__pyx_v_mslice->shape[__pyx_v_i]) > 1) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":1122
+      /* "View.MemoryView":1128
  *     for i in range(ndim - 1, -1, -1):
  *         if mslice.shape[i] > 1:
  *             c_stride = mslice.strides[i]             # <<<<<<<<<<<<<<
  *             break
  * 
  */
       __pyx_v_c_stride = (__pyx_v_mslice->strides[__pyx_v_i]);
 
-      /* "View.MemoryView":1123
+      /* "View.MemoryView":1129
  *         if mslice.shape[i] > 1:
  *             c_stride = mslice.strides[i]
  *             break             # <<<<<<<<<<<<<<
  * 
  *     for i in range(ndim):
  */
       goto __pyx_L4_break;
 
-      /* "View.MemoryView":1121
+      /* "View.MemoryView":1127
  * 
  *     for i in range(ndim - 1, -1, -1):
  *         if mslice.shape[i] > 1:             # <<<<<<<<<<<<<<
  *             c_stride = mslice.strides[i]
  *             break
  */
     }
   }
   __pyx_L4_break:;
 
-  /* "View.MemoryView":1125
+  /* "View.MemoryView":1131
  *             break
  * 
  *     for i in range(ndim):             # <<<<<<<<<<<<<<
  *         if mslice.shape[i] > 1:
  *             f_stride = mslice.strides[i]
  */
   __pyx_t_1 = __pyx_v_ndim;
   __pyx_t_3 = __pyx_t_1;
   for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
     __pyx_v_i = __pyx_t_4;
 
-    /* "View.MemoryView":1126
+    /* "View.MemoryView":1132
  * 
  *     for i in range(ndim):
  *         if mslice.shape[i] > 1:             # <<<<<<<<<<<<<<
  *             f_stride = mslice.strides[i]
  *             break
  */
     __pyx_t_2 = (((__pyx_v_mslice->shape[__pyx_v_i]) > 1) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":1127
+      /* "View.MemoryView":1133
  *     for i in range(ndim):
  *         if mslice.shape[i] > 1:
  *             f_stride = mslice.strides[i]             # <<<<<<<<<<<<<<
  *             break
  * 
  */
       __pyx_v_f_stride = (__pyx_v_mslice->strides[__pyx_v_i]);
 
-      /* "View.MemoryView":1128
+      /* "View.MemoryView":1134
  *         if mslice.shape[i] > 1:
  *             f_stride = mslice.strides[i]
  *             break             # <<<<<<<<<<<<<<
  * 
  *     if abs_py_ssize_t(c_stride) <= abs_py_ssize_t(f_stride):
  */
       goto __pyx_L7_break;
 
-      /* "View.MemoryView":1126
+      /* "View.MemoryView":1132
  * 
  *     for i in range(ndim):
  *         if mslice.shape[i] > 1:             # <<<<<<<<<<<<<<
  *             f_stride = mslice.strides[i]
  *             break
  */
     }
   }
   __pyx_L7_break:;
 
-  /* "View.MemoryView":1130
+  /* "View.MemoryView":1136
  *             break
  * 
  *     if abs_py_ssize_t(c_stride) <= abs_py_ssize_t(f_stride):             # <<<<<<<<<<<<<<
  *         return 'C'
  *     else:
  */
   __pyx_t_2 = ((abs_py_ssize_t(__pyx_v_c_stride) <= abs_py_ssize_t(__pyx_v_f_stride)) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":1131
+    /* "View.MemoryView":1137
  * 
  *     if abs_py_ssize_t(c_stride) <= abs_py_ssize_t(f_stride):
  *         return 'C'             # <<<<<<<<<<<<<<
  *     else:
  *         return 'F'
  */
     __pyx_r = 'C';
     goto __pyx_L0;
 
-    /* "View.MemoryView":1130
+    /* "View.MemoryView":1136
  *             break
  * 
  *     if abs_py_ssize_t(c_stride) <= abs_py_ssize_t(f_stride):             # <<<<<<<<<<<<<<
  *         return 'C'
  *     else:
  */
   }
 
-  /* "View.MemoryView":1133
+  /* "View.MemoryView":1139
  *         return 'C'
  *     else:
  *         return 'F'             # <<<<<<<<<<<<<<
  * 
  * @cython.cdivision(True)
  */
   /*else*/ {
     __pyx_r = 'F';
     goto __pyx_L0;
   }
 
-  /* "View.MemoryView":1112
+  /* "View.MemoryView":1118
  * 
  * @cname('__pyx_get_best_slice_order')
  * cdef char get_best_order(__Pyx_memviewslice *mslice, int ndim) nogil:             # <<<<<<<<<<<<<<
  *     """
  *     Figure out the best memory access order for a given slice.
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "View.MemoryView":1136
+/* "View.MemoryView":1142
  * 
  * @cython.cdivision(True)
  * cdef void _copy_strided_to_strided(char *src_data, Py_ssize_t *src_strides,             # <<<<<<<<<<<<<<
  *                                    char *dst_data, Py_ssize_t *dst_strides,
  *                                    Py_ssize_t *src_shape, Py_ssize_t *dst_shape,
  */
 
@@ -29433,61 +31276,61 @@
   int __pyx_t_1;
   int __pyx_t_2;
   int __pyx_t_3;
   Py_ssize_t __pyx_t_4;
   Py_ssize_t __pyx_t_5;
   Py_ssize_t __pyx_t_6;
 
-  /* "View.MemoryView":1143
+  /* "View.MemoryView":1149
  * 
  *     cdef Py_ssize_t i
  *     cdef Py_ssize_t src_extent = src_shape[0]             # <<<<<<<<<<<<<<
  *     cdef Py_ssize_t dst_extent = dst_shape[0]
  *     cdef Py_ssize_t src_stride = src_strides[0]
  */
   __pyx_v_src_extent = (__pyx_v_src_shape[0]);
 
-  /* "View.MemoryView":1144
+  /* "View.MemoryView":1150
  *     cdef Py_ssize_t i
  *     cdef Py_ssize_t src_extent = src_shape[0]
  *     cdef Py_ssize_t dst_extent = dst_shape[0]             # <<<<<<<<<<<<<<
  *     cdef Py_ssize_t src_stride = src_strides[0]
  *     cdef Py_ssize_t dst_stride = dst_strides[0]
  */
   __pyx_v_dst_extent = (__pyx_v_dst_shape[0]);
 
-  /* "View.MemoryView":1145
+  /* "View.MemoryView":1151
  *     cdef Py_ssize_t src_extent = src_shape[0]
  *     cdef Py_ssize_t dst_extent = dst_shape[0]
  *     cdef Py_ssize_t src_stride = src_strides[0]             # <<<<<<<<<<<<<<
  *     cdef Py_ssize_t dst_stride = dst_strides[0]
  * 
  */
   __pyx_v_src_stride = (__pyx_v_src_strides[0]);
 
-  /* "View.MemoryView":1146
+  /* "View.MemoryView":1152
  *     cdef Py_ssize_t dst_extent = dst_shape[0]
  *     cdef Py_ssize_t src_stride = src_strides[0]
  *     cdef Py_ssize_t dst_stride = dst_strides[0]             # <<<<<<<<<<<<<<
  * 
  *     if ndim == 1:
  */
   __pyx_v_dst_stride = (__pyx_v_dst_strides[0]);
 
-  /* "View.MemoryView":1148
+  /* "View.MemoryView":1154
  *     cdef Py_ssize_t dst_stride = dst_strides[0]
  * 
  *     if ndim == 1:             # <<<<<<<<<<<<<<
  *        if (src_stride > 0 and dst_stride > 0 and
  *            <size_t> src_stride == itemsize == <size_t> dst_stride):
  */
   __pyx_t_1 = ((__pyx_v_ndim == 1) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":1149
+    /* "View.MemoryView":1155
  * 
  *     if ndim == 1:
  *        if (src_stride > 0 and dst_stride > 0 and             # <<<<<<<<<<<<<<
  *            <size_t> src_stride == itemsize == <size_t> dst_stride):
  *            memcpy(dst_data, src_data, itemsize * dst_extent)
  */
     __pyx_t_2 = ((__pyx_v_src_stride > 0) != 0);
@@ -29499,267 +31342,267 @@
     __pyx_t_2 = ((__pyx_v_dst_stride > 0) != 0);
     if (__pyx_t_2) {
     } else {
       __pyx_t_1 = __pyx_t_2;
       goto __pyx_L5_bool_binop_done;
     }
 
-    /* "View.MemoryView":1150
+    /* "View.MemoryView":1156
  *     if ndim == 1:
  *        if (src_stride > 0 and dst_stride > 0 and
  *            <size_t> src_stride == itemsize == <size_t> dst_stride):             # <<<<<<<<<<<<<<
  *            memcpy(dst_data, src_data, itemsize * dst_extent)
  *        else:
  */
     __pyx_t_2 = (((size_t)__pyx_v_src_stride) == __pyx_v_itemsize);
     if (__pyx_t_2) {
       __pyx_t_2 = (__pyx_v_itemsize == ((size_t)__pyx_v_dst_stride));
     }
     __pyx_t_3 = (__pyx_t_2 != 0);
     __pyx_t_1 = __pyx_t_3;
     __pyx_L5_bool_binop_done:;
 
-    /* "View.MemoryView":1149
+    /* "View.MemoryView":1155
  * 
  *     if ndim == 1:
  *        if (src_stride > 0 and dst_stride > 0 and             # <<<<<<<<<<<<<<
  *            <size_t> src_stride == itemsize == <size_t> dst_stride):
  *            memcpy(dst_data, src_data, itemsize * dst_extent)
  */
     if (__pyx_t_1) {
 
-      /* "View.MemoryView":1151
+      /* "View.MemoryView":1157
  *        if (src_stride > 0 and dst_stride > 0 and
  *            <size_t> src_stride == itemsize == <size_t> dst_stride):
  *            memcpy(dst_data, src_data, itemsize * dst_extent)             # <<<<<<<<<<<<<<
  *        else:
  *            for i in range(dst_extent):
  */
       (void)(memcpy(__pyx_v_dst_data, __pyx_v_src_data, (__pyx_v_itemsize * __pyx_v_dst_extent)));
 
-      /* "View.MemoryView":1149
+      /* "View.MemoryView":1155
  * 
  *     if ndim == 1:
  *        if (src_stride > 0 and dst_stride > 0 and             # <<<<<<<<<<<<<<
  *            <size_t> src_stride == itemsize == <size_t> dst_stride):
  *            memcpy(dst_data, src_data, itemsize * dst_extent)
  */
       goto __pyx_L4;
     }
 
-    /* "View.MemoryView":1153
+    /* "View.MemoryView":1159
  *            memcpy(dst_data, src_data, itemsize * dst_extent)
  *        else:
  *            for i in range(dst_extent):             # <<<<<<<<<<<<<<
  *                memcpy(dst_data, src_data, itemsize)
  *                src_data += src_stride
  */
     /*else*/ {
       __pyx_t_4 = __pyx_v_dst_extent;
       __pyx_t_5 = __pyx_t_4;
       for (__pyx_t_6 = 0; __pyx_t_6 < __pyx_t_5; __pyx_t_6+=1) {
         __pyx_v_i = __pyx_t_6;
 
-        /* "View.MemoryView":1154
+        /* "View.MemoryView":1160
  *        else:
  *            for i in range(dst_extent):
  *                memcpy(dst_data, src_data, itemsize)             # <<<<<<<<<<<<<<
  *                src_data += src_stride
  *                dst_data += dst_stride
  */
         (void)(memcpy(__pyx_v_dst_data, __pyx_v_src_data, __pyx_v_itemsize));
 
-        /* "View.MemoryView":1155
+        /* "View.MemoryView":1161
  *            for i in range(dst_extent):
  *                memcpy(dst_data, src_data, itemsize)
  *                src_data += src_stride             # <<<<<<<<<<<<<<
  *                dst_data += dst_stride
  *     else:
  */
         __pyx_v_src_data = (__pyx_v_src_data + __pyx_v_src_stride);
 
-        /* "View.MemoryView":1156
+        /* "View.MemoryView":1162
  *                memcpy(dst_data, src_data, itemsize)
  *                src_data += src_stride
  *                dst_data += dst_stride             # <<<<<<<<<<<<<<
  *     else:
  *         for i in range(dst_extent):
  */
         __pyx_v_dst_data = (__pyx_v_dst_data + __pyx_v_dst_stride);
       }
     }
     __pyx_L4:;
 
-    /* "View.MemoryView":1148
+    /* "View.MemoryView":1154
  *     cdef Py_ssize_t dst_stride = dst_strides[0]
  * 
  *     if ndim == 1:             # <<<<<<<<<<<<<<
  *        if (src_stride > 0 and dst_stride > 0 and
  *            <size_t> src_stride == itemsize == <size_t> dst_stride):
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":1158
+  /* "View.MemoryView":1164
  *                dst_data += dst_stride
  *     else:
  *         for i in range(dst_extent):             # <<<<<<<<<<<<<<
  *             _copy_strided_to_strided(src_data, src_strides + 1,
  *                                      dst_data, dst_strides + 1,
  */
   /*else*/ {
     __pyx_t_4 = __pyx_v_dst_extent;
     __pyx_t_5 = __pyx_t_4;
     for (__pyx_t_6 = 0; __pyx_t_6 < __pyx_t_5; __pyx_t_6+=1) {
       __pyx_v_i = __pyx_t_6;
 
-      /* "View.MemoryView":1159
+      /* "View.MemoryView":1165
  *     else:
  *         for i in range(dst_extent):
  *             _copy_strided_to_strided(src_data, src_strides + 1,             # <<<<<<<<<<<<<<
  *                                      dst_data, dst_strides + 1,
  *                                      src_shape + 1, dst_shape + 1,
  */
       _copy_strided_to_strided(__pyx_v_src_data, (__pyx_v_src_strides + 1), __pyx_v_dst_data, (__pyx_v_dst_strides + 1), (__pyx_v_src_shape + 1), (__pyx_v_dst_shape + 1), (__pyx_v_ndim - 1), __pyx_v_itemsize);
 
-      /* "View.MemoryView":1163
+      /* "View.MemoryView":1169
  *                                      src_shape + 1, dst_shape + 1,
  *                                      ndim - 1, itemsize)
  *             src_data += src_stride             # <<<<<<<<<<<<<<
  *             dst_data += dst_stride
  * 
  */
       __pyx_v_src_data = (__pyx_v_src_data + __pyx_v_src_stride);
 
-      /* "View.MemoryView":1164
+      /* "View.MemoryView":1170
  *                                      ndim - 1, itemsize)
  *             src_data += src_stride
  *             dst_data += dst_stride             # <<<<<<<<<<<<<<
  * 
  * cdef void copy_strided_to_strided(__Pyx_memviewslice *src,
  */
       __pyx_v_dst_data = (__pyx_v_dst_data + __pyx_v_dst_stride);
     }
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":1136
+  /* "View.MemoryView":1142
  * 
  * @cython.cdivision(True)
  * cdef void _copy_strided_to_strided(char *src_data, Py_ssize_t *src_strides,             # <<<<<<<<<<<<<<
  *                                    char *dst_data, Py_ssize_t *dst_strides,
  *                                    Py_ssize_t *src_shape, Py_ssize_t *dst_shape,
  */
 
   /* function exit code */
 }
 
-/* "View.MemoryView":1166
+/* "View.MemoryView":1172
  *             dst_data += dst_stride
  * 
  * cdef void copy_strided_to_strided(__Pyx_memviewslice *src,             # <<<<<<<<<<<<<<
  *                                   __Pyx_memviewslice *dst,
  *                                   int ndim, size_t itemsize) nogil:
  */
 
 static void copy_strided_to_strided(__Pyx_memviewslice *__pyx_v_src, __Pyx_memviewslice *__pyx_v_dst, int __pyx_v_ndim, size_t __pyx_v_itemsize) {
 
-  /* "View.MemoryView":1169
+  /* "View.MemoryView":1175
  *                                   __Pyx_memviewslice *dst,
  *                                   int ndim, size_t itemsize) nogil:
  *     _copy_strided_to_strided(src.data, src.strides, dst.data, dst.strides,             # <<<<<<<<<<<<<<
  *                              src.shape, dst.shape, ndim, itemsize)
  * 
  */
   _copy_strided_to_strided(__pyx_v_src->data, __pyx_v_src->strides, __pyx_v_dst->data, __pyx_v_dst->strides, __pyx_v_src->shape, __pyx_v_dst->shape, __pyx_v_ndim, __pyx_v_itemsize);
 
-  /* "View.MemoryView":1166
+  /* "View.MemoryView":1172
  *             dst_data += dst_stride
  * 
  * cdef void copy_strided_to_strided(__Pyx_memviewslice *src,             # <<<<<<<<<<<<<<
  *                                   __Pyx_memviewslice *dst,
  *                                   int ndim, size_t itemsize) nogil:
  */
 
   /* function exit code */
 }
 
-/* "View.MemoryView":1173
+/* "View.MemoryView":1179
  * 
  * @cname('__pyx_memoryview_slice_get_size')
  * cdef Py_ssize_t slice_get_size(__Pyx_memviewslice *src, int ndim) nogil:             # <<<<<<<<<<<<<<
  *     "Return the size of the memory occupied by the slice in number of bytes"
- *     cdef int i
+ *     cdef Py_ssize_t shape, size = src.memview.view.itemsize
  */
 
 static Py_ssize_t __pyx_memoryview_slice_get_size(__Pyx_memviewslice *__pyx_v_src, int __pyx_v_ndim) {
-  int __pyx_v_i;
+  Py_ssize_t __pyx_v_shape;
   Py_ssize_t __pyx_v_size;
   Py_ssize_t __pyx_r;
   Py_ssize_t __pyx_t_1;
-  int __pyx_t_2;
-  int __pyx_t_3;
-  int __pyx_t_4;
+  Py_ssize_t *__pyx_t_2;
+  Py_ssize_t *__pyx_t_3;
+  Py_ssize_t *__pyx_t_4;
 
-  /* "View.MemoryView":1176
+  /* "View.MemoryView":1181
+ * cdef Py_ssize_t slice_get_size(__Pyx_memviewslice *src, int ndim) nogil:
  *     "Return the size of the memory occupied by the slice in number of bytes"
- *     cdef int i
- *     cdef Py_ssize_t size = src.memview.view.itemsize             # <<<<<<<<<<<<<<
+ *     cdef Py_ssize_t shape, size = src.memview.view.itemsize             # <<<<<<<<<<<<<<
  * 
- *     for i in range(ndim):
+ *     for shape in src.shape[:ndim]:
  */
   __pyx_t_1 = __pyx_v_src->memview->view.itemsize;
   __pyx_v_size = __pyx_t_1;
 
-  /* "View.MemoryView":1178
- *     cdef Py_ssize_t size = src.memview.view.itemsize
+  /* "View.MemoryView":1183
+ *     cdef Py_ssize_t shape, size = src.memview.view.itemsize
  * 
- *     for i in range(ndim):             # <<<<<<<<<<<<<<
- *         size *= src.shape[i]
+ *     for shape in src.shape[:ndim]:             # <<<<<<<<<<<<<<
+ *         size *= shape
  * 
  */
-  __pyx_t_2 = __pyx_v_ndim;
-  __pyx_t_3 = __pyx_t_2;
-  for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
-    __pyx_v_i = __pyx_t_4;
+  __pyx_t_3 = (__pyx_v_src->shape + __pyx_v_ndim);
+  for (__pyx_t_4 = __pyx_v_src->shape; __pyx_t_4 < __pyx_t_3; __pyx_t_4++) {
+    __pyx_t_2 = __pyx_t_4;
+    __pyx_v_shape = (__pyx_t_2[0]);
 
-    /* "View.MemoryView":1179
+    /* "View.MemoryView":1184
  * 
- *     for i in range(ndim):
- *         size *= src.shape[i]             # <<<<<<<<<<<<<<
+ *     for shape in src.shape[:ndim]:
+ *         size *= shape             # <<<<<<<<<<<<<<
  * 
  *     return size
  */
-    __pyx_v_size = (__pyx_v_size * (__pyx_v_src->shape[__pyx_v_i]));
+    __pyx_v_size = (__pyx_v_size * __pyx_v_shape);
   }
 
-  /* "View.MemoryView":1181
- *         size *= src.shape[i]
+  /* "View.MemoryView":1186
+ *         size *= shape
  * 
  *     return size             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_fill_contig_strides_array')
  */
   __pyx_r = __pyx_v_size;
   goto __pyx_L0;
 
-  /* "View.MemoryView":1173
+  /* "View.MemoryView":1179
  * 
  * @cname('__pyx_memoryview_slice_get_size')
  * cdef Py_ssize_t slice_get_size(__Pyx_memviewslice *src, int ndim) nogil:             # <<<<<<<<<<<<<<
  *     "Return the size of the memory occupied by the slice in number of bytes"
- *     cdef int i
+ *     cdef Py_ssize_t shape, size = src.memview.view.itemsize
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "View.MemoryView":1184
+/* "View.MemoryView":1189
  * 
  * @cname('__pyx_fill_contig_strides_array')
  * cdef Py_ssize_t fill_contig_strides_array(             # <<<<<<<<<<<<<<
  *                 Py_ssize_t *shape, Py_ssize_t *strides, Py_ssize_t stride,
  *                 int ndim, char order) nogil:
  */
 
@@ -29767,121 +31610,121 @@
   int __pyx_v_idx;
   Py_ssize_t __pyx_r;
   int __pyx_t_1;
   int __pyx_t_2;
   int __pyx_t_3;
   int __pyx_t_4;
 
-  /* "View.MemoryView":1193
+  /* "View.MemoryView":1198
  *     cdef int idx
  * 
  *     if order == 'F':             # <<<<<<<<<<<<<<
  *         for idx in range(ndim):
  *             strides[idx] = stride
  */
   __pyx_t_1 = ((__pyx_v_order == 'F') != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":1194
+    /* "View.MemoryView":1199
  * 
  *     if order == 'F':
  *         for idx in range(ndim):             # <<<<<<<<<<<<<<
  *             strides[idx] = stride
- *             stride = stride * shape[idx]
+ *             stride *= shape[idx]
  */
     __pyx_t_2 = __pyx_v_ndim;
     __pyx_t_3 = __pyx_t_2;
     for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
       __pyx_v_idx = __pyx_t_4;
 
-      /* "View.MemoryView":1195
+      /* "View.MemoryView":1200
  *     if order == 'F':
  *         for idx in range(ndim):
  *             strides[idx] = stride             # <<<<<<<<<<<<<<
- *             stride = stride * shape[idx]
+ *             stride *= shape[idx]
  *     else:
  */
       (__pyx_v_strides[__pyx_v_idx]) = __pyx_v_stride;
 
-      /* "View.MemoryView":1196
+      /* "View.MemoryView":1201
  *         for idx in range(ndim):
  *             strides[idx] = stride
- *             stride = stride * shape[idx]             # <<<<<<<<<<<<<<
+ *             stride *= shape[idx]             # <<<<<<<<<<<<<<
  *     else:
  *         for idx in range(ndim - 1, -1, -1):
  */
       __pyx_v_stride = (__pyx_v_stride * (__pyx_v_shape[__pyx_v_idx]));
     }
 
-    /* "View.MemoryView":1193
+    /* "View.MemoryView":1198
  *     cdef int idx
  * 
  *     if order == 'F':             # <<<<<<<<<<<<<<
  *         for idx in range(ndim):
  *             strides[idx] = stride
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":1198
- *             stride = stride * shape[idx]
+  /* "View.MemoryView":1203
+ *             stride *= shape[idx]
  *     else:
  *         for idx in range(ndim - 1, -1, -1):             # <<<<<<<<<<<<<<
  *             strides[idx] = stride
- *             stride = stride * shape[idx]
+ *             stride *= shape[idx]
  */
   /*else*/ {
     for (__pyx_t_2 = (__pyx_v_ndim - 1); __pyx_t_2 > -1; __pyx_t_2-=1) {
       __pyx_v_idx = __pyx_t_2;
 
-      /* "View.MemoryView":1199
+      /* "View.MemoryView":1204
  *     else:
  *         for idx in range(ndim - 1, -1, -1):
  *             strides[idx] = stride             # <<<<<<<<<<<<<<
- *             stride = stride * shape[idx]
+ *             stride *= shape[idx]
  * 
  */
       (__pyx_v_strides[__pyx_v_idx]) = __pyx_v_stride;
 
-      /* "View.MemoryView":1200
+      /* "View.MemoryView":1205
  *         for idx in range(ndim - 1, -1, -1):
  *             strides[idx] = stride
- *             stride = stride * shape[idx]             # <<<<<<<<<<<<<<
+ *             stride *= shape[idx]             # <<<<<<<<<<<<<<
  * 
  *     return stride
  */
       __pyx_v_stride = (__pyx_v_stride * (__pyx_v_shape[__pyx_v_idx]));
     }
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":1202
- *             stride = stride * shape[idx]
+  /* "View.MemoryView":1207
+ *             stride *= shape[idx]
  * 
  *     return stride             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_copy_data_to_temp')
  */
   __pyx_r = __pyx_v_stride;
   goto __pyx_L0;
 
-  /* "View.MemoryView":1184
+  /* "View.MemoryView":1189
  * 
  * @cname('__pyx_fill_contig_strides_array')
  * cdef Py_ssize_t fill_contig_strides_array(             # <<<<<<<<<<<<<<
  *                 Py_ssize_t *shape, Py_ssize_t *strides, Py_ssize_t stride,
  *                 int ndim, char order) nogil:
  */
 
   /* function exit code */
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "View.MemoryView":1205
+/* "View.MemoryView":1210
  * 
  * @cname('__pyx_memoryview_copy_data_to_temp')
  * cdef void *copy_data_to_temp(__Pyx_memviewslice *src,             # <<<<<<<<<<<<<<
  *                              __Pyx_memviewslice *tmpslice,
  *                              char order,
  */
 
@@ -29893,223 +31736,226 @@
   void *__pyx_r;
   Py_ssize_t __pyx_t_1;
   int __pyx_t_2;
   int __pyx_t_3;
   struct __pyx_memoryview_obj *__pyx_t_4;
   int __pyx_t_5;
   int __pyx_t_6;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
 
-  /* "View.MemoryView":1216
+  /* "View.MemoryView":1221
  *     cdef void *result
  * 
  *     cdef size_t itemsize = src.memview.view.itemsize             # <<<<<<<<<<<<<<
  *     cdef size_t size = slice_get_size(src, ndim)
  * 
  */
   __pyx_t_1 = __pyx_v_src->memview->view.itemsize;
   __pyx_v_itemsize = __pyx_t_1;
 
-  /* "View.MemoryView":1217
+  /* "View.MemoryView":1222
  * 
  *     cdef size_t itemsize = src.memview.view.itemsize
  *     cdef size_t size = slice_get_size(src, ndim)             # <<<<<<<<<<<<<<
  * 
  *     result = malloc(size)
  */
   __pyx_v_size = __pyx_memoryview_slice_get_size(__pyx_v_src, __pyx_v_ndim);
 
-  /* "View.MemoryView":1219
+  /* "View.MemoryView":1224
  *     cdef size_t size = slice_get_size(src, ndim)
  * 
  *     result = malloc(size)             # <<<<<<<<<<<<<<
  *     if not result:
  *         _err(MemoryError, NULL)
  */
   __pyx_v_result = malloc(__pyx_v_size);
 
-  /* "View.MemoryView":1220
+  /* "View.MemoryView":1225
  * 
  *     result = malloc(size)
  *     if not result:             # <<<<<<<<<<<<<<
  *         _err(MemoryError, NULL)
  * 
  */
   __pyx_t_2 = ((!(__pyx_v_result != 0)) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":1221
+    /* "View.MemoryView":1226
  *     result = malloc(size)
  *     if not result:
  *         _err(MemoryError, NULL)             # <<<<<<<<<<<<<<
  * 
  * 
  */
-    __pyx_t_3 = __pyx_memoryview_err(__pyx_builtin_MemoryError, NULL); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(1, 1221, __pyx_L1_error)
+    __pyx_t_3 = __pyx_memoryview_err(__pyx_builtin_MemoryError, NULL); if (unlikely(__pyx_t_3 == ((int)-1))) __PYX_ERR(1, 1226, __pyx_L1_error)
 
-    /* "View.MemoryView":1220
+    /* "View.MemoryView":1225
  * 
  *     result = malloc(size)
  *     if not result:             # <<<<<<<<<<<<<<
  *         _err(MemoryError, NULL)
  * 
  */
   }
 
-  /* "View.MemoryView":1224
+  /* "View.MemoryView":1229
  * 
  * 
  *     tmpslice.data = <char *> result             # <<<<<<<<<<<<<<
  *     tmpslice.memview = src.memview
  *     for i in range(ndim):
  */
   __pyx_v_tmpslice->data = ((char *)__pyx_v_result);
 
-  /* "View.MemoryView":1225
+  /* "View.MemoryView":1230
  * 
  *     tmpslice.data = <char *> result
  *     tmpslice.memview = src.memview             # <<<<<<<<<<<<<<
  *     for i in range(ndim):
  *         tmpslice.shape[i] = src.shape[i]
  */
   __pyx_t_4 = __pyx_v_src->memview;
   __pyx_v_tmpslice->memview = __pyx_t_4;
 
-  /* "View.MemoryView":1226
+  /* "View.MemoryView":1231
  *     tmpslice.data = <char *> result
  *     tmpslice.memview = src.memview
  *     for i in range(ndim):             # <<<<<<<<<<<<<<
  *         tmpslice.shape[i] = src.shape[i]
  *         tmpslice.suboffsets[i] = -1
  */
   __pyx_t_3 = __pyx_v_ndim;
   __pyx_t_5 = __pyx_t_3;
   for (__pyx_t_6 = 0; __pyx_t_6 < __pyx_t_5; __pyx_t_6+=1) {
     __pyx_v_i = __pyx_t_6;
 
-    /* "View.MemoryView":1227
+    /* "View.MemoryView":1232
  *     tmpslice.memview = src.memview
  *     for i in range(ndim):
  *         tmpslice.shape[i] = src.shape[i]             # <<<<<<<<<<<<<<
  *         tmpslice.suboffsets[i] = -1
  * 
  */
     (__pyx_v_tmpslice->shape[__pyx_v_i]) = (__pyx_v_src->shape[__pyx_v_i]);
 
-    /* "View.MemoryView":1228
+    /* "View.MemoryView":1233
  *     for i in range(ndim):
  *         tmpslice.shape[i] = src.shape[i]
  *         tmpslice.suboffsets[i] = -1             # <<<<<<<<<<<<<<
  * 
  *     fill_contig_strides_array(&tmpslice.shape[0], &tmpslice.strides[0], itemsize,
  */
     (__pyx_v_tmpslice->suboffsets[__pyx_v_i]) = -1L;
   }
 
-  /* "View.MemoryView":1230
+  /* "View.MemoryView":1235
  *         tmpslice.suboffsets[i] = -1
  * 
  *     fill_contig_strides_array(&tmpslice.shape[0], &tmpslice.strides[0], itemsize,             # <<<<<<<<<<<<<<
  *                               ndim, order)
  * 
  */
   (void)(__pyx_fill_contig_strides_array((&(__pyx_v_tmpslice->shape[0])), (&(__pyx_v_tmpslice->strides[0])), __pyx_v_itemsize, __pyx_v_ndim, __pyx_v_order));
 
-  /* "View.MemoryView":1234
+  /* "View.MemoryView":1239
  * 
  * 
  *     for i in range(ndim):             # <<<<<<<<<<<<<<
  *         if tmpslice.shape[i] == 1:
  *             tmpslice.strides[i] = 0
  */
   __pyx_t_3 = __pyx_v_ndim;
   __pyx_t_5 = __pyx_t_3;
   for (__pyx_t_6 = 0; __pyx_t_6 < __pyx_t_5; __pyx_t_6+=1) {
     __pyx_v_i = __pyx_t_6;
 
-    /* "View.MemoryView":1235
+    /* "View.MemoryView":1240
  * 
  *     for i in range(ndim):
  *         if tmpslice.shape[i] == 1:             # <<<<<<<<<<<<<<
  *             tmpslice.strides[i] = 0
  * 
  */
     __pyx_t_2 = (((__pyx_v_tmpslice->shape[__pyx_v_i]) == 1) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":1236
+      /* "View.MemoryView":1241
  *     for i in range(ndim):
  *         if tmpslice.shape[i] == 1:
  *             tmpslice.strides[i] = 0             # <<<<<<<<<<<<<<
  * 
  *     if slice_is_contig(src[0], order, ndim):
  */
       (__pyx_v_tmpslice->strides[__pyx_v_i]) = 0;
 
-      /* "View.MemoryView":1235
+      /* "View.MemoryView":1240
  * 
  *     for i in range(ndim):
  *         if tmpslice.shape[i] == 1:             # <<<<<<<<<<<<<<
  *             tmpslice.strides[i] = 0
  * 
  */
     }
   }
 
-  /* "View.MemoryView":1238
+  /* "View.MemoryView":1243
  *             tmpslice.strides[i] = 0
  * 
  *     if slice_is_contig(src[0], order, ndim):             # <<<<<<<<<<<<<<
  *         memcpy(result, src.data, size)
  *     else:
  */
   __pyx_t_2 = (__pyx_memviewslice_is_contig((__pyx_v_src[0]), __pyx_v_order, __pyx_v_ndim) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":1239
+    /* "View.MemoryView":1244
  * 
  *     if slice_is_contig(src[0], order, ndim):
  *         memcpy(result, src.data, size)             # <<<<<<<<<<<<<<
  *     else:
  *         copy_strided_to_strided(src, tmpslice, ndim, itemsize)
  */
     (void)(memcpy(__pyx_v_result, __pyx_v_src->data, __pyx_v_size));
 
-    /* "View.MemoryView":1238
+    /* "View.MemoryView":1243
  *             tmpslice.strides[i] = 0
  * 
  *     if slice_is_contig(src[0], order, ndim):             # <<<<<<<<<<<<<<
  *         memcpy(result, src.data, size)
  *     else:
  */
     goto __pyx_L9;
   }
 
-  /* "View.MemoryView":1241
+  /* "View.MemoryView":1246
  *         memcpy(result, src.data, size)
  *     else:
  *         copy_strided_to_strided(src, tmpslice, ndim, itemsize)             # <<<<<<<<<<<<<<
  * 
  *     return result
  */
   /*else*/ {
     copy_strided_to_strided(__pyx_v_src, __pyx_v_tmpslice, __pyx_v_ndim, __pyx_v_itemsize);
   }
   __pyx_L9:;
 
-  /* "View.MemoryView":1243
+  /* "View.MemoryView":1248
  *         copy_strided_to_strided(src, tmpslice, ndim, itemsize)
  * 
  *     return result             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_r = __pyx_v_result;
   goto __pyx_L0;
 
-  /* "View.MemoryView":1205
+  /* "View.MemoryView":1210
  * 
  * @cname('__pyx_memoryview_copy_data_to_temp')
  * cdef void *copy_data_to_temp(__Pyx_memviewslice *src,             # <<<<<<<<<<<<<<
  *                              __Pyx_memviewslice *tmpslice,
  *                              char order,
  */
 
@@ -30125,77 +31971,80 @@
     #endif
   }
   __pyx_r = NULL;
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "View.MemoryView":1248
+/* "View.MemoryView":1253
  * 
  * @cname('__pyx_memoryview_err_extents')
  * cdef int _err_extents(int i, Py_ssize_t extent1,             # <<<<<<<<<<<<<<
  *                              Py_ssize_t extent2) except -1 with gil:
  *     raise ValueError("got differing extents in dimension %d (got %d and %d)" %
  */
 
 static int __pyx_memoryview_err_extents(int __pyx_v_i, Py_ssize_t __pyx_v_extent1, Py_ssize_t __pyx_v_extent2) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   #ifdef WITH_THREAD
   PyGILState_STATE __pyx_gilstate_save = __Pyx_PyGILState_Ensure();
   #endif
   __Pyx_RefNannySetupContext("_err_extents", 0);
 
-  /* "View.MemoryView":1251
+  /* "View.MemoryView":1256
  *                              Py_ssize_t extent2) except -1 with gil:
  *     raise ValueError("got differing extents in dimension %d (got %d and %d)" %
  *                                                         (i, extent1, extent2))             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_err_dim')
  */
-  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_i); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 1251, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_i); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 1256, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_extent1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1251, __pyx_L1_error)
+  __pyx_t_2 = PyInt_FromSsize_t(__pyx_v_extent1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1256, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_extent2); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1251, __pyx_L1_error)
+  __pyx_t_3 = PyInt_FromSsize_t(__pyx_v_extent2); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1256, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_4 = PyTuple_New(3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1251, __pyx_L1_error)
+  __pyx_t_4 = PyTuple_New(3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1256, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_4, 0, __pyx_t_1);
   __Pyx_GIVEREF(__pyx_t_2);
   PyTuple_SET_ITEM(__pyx_t_4, 1, __pyx_t_2);
   __Pyx_GIVEREF(__pyx_t_3);
   PyTuple_SET_ITEM(__pyx_t_4, 2, __pyx_t_3);
   __pyx_t_1 = 0;
   __pyx_t_2 = 0;
   __pyx_t_3 = 0;
 
-  /* "View.MemoryView":1250
+  /* "View.MemoryView":1255
  * cdef int _err_extents(int i, Py_ssize_t extent1,
  *                              Py_ssize_t extent2) except -1 with gil:
  *     raise ValueError("got differing extents in dimension %d (got %d and %d)" %             # <<<<<<<<<<<<<<
  *                                                         (i, extent1, extent2))
  * 
  */
-  __pyx_t_3 = __Pyx_PyString_Format(__pyx_kp_s_got_differing_extents_in_dimensi, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1250, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyString_Format(__pyx_kp_s_got_differing_extents_in_dimensi, __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1255, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1250, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_CallOneArg(__pyx_builtin_ValueError, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1255, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_Raise(__pyx_t_4, 0, 0, 0);
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  __PYX_ERR(1, 1250, __pyx_L1_error)
+  __PYX_ERR(1, 1255, __pyx_L1_error)
 
-  /* "View.MemoryView":1248
+  /* "View.MemoryView":1253
  * 
  * @cname('__pyx_memoryview_err_extents')
  * cdef int _err_extents(int i, Py_ssize_t extent1,             # <<<<<<<<<<<<<<
  *                              Py_ssize_t extent2) except -1 with gil:
  *     raise ValueError("got differing extents in dimension %d (got %d and %d)" %
  */
 
@@ -30210,47 +32059,50 @@
   __Pyx_RefNannyFinishContext();
   #ifdef WITH_THREAD
   __Pyx_PyGILState_Release(__pyx_gilstate_save);
   #endif
   return __pyx_r;
 }
 
-/* "View.MemoryView":1254
+/* "View.MemoryView":1259
  * 
  * @cname('__pyx_memoryview_err_dim')
  * cdef int _err_dim(object error, char *msg, int dim) except -1 with gil:             # <<<<<<<<<<<<<<
  *     raise error(msg.decode('ascii') % dim)
  * 
  */
 
 static int __pyx_memoryview_err_dim(PyObject *__pyx_v_error, char *__pyx_v_msg, int __pyx_v_dim) {
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   #ifdef WITH_THREAD
   PyGILState_STATE __pyx_gilstate_save = __Pyx_PyGILState_Ensure();
   #endif
   __Pyx_RefNannySetupContext("_err_dim", 0);
   __Pyx_INCREF(__pyx_v_error);
 
-  /* "View.MemoryView":1255
+  /* "View.MemoryView":1260
  * @cname('__pyx_memoryview_err_dim')
  * cdef int _err_dim(object error, char *msg, int dim) except -1 with gil:
  *     raise error(msg.decode('ascii') % dim)             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_err')
  */
-  __pyx_t_2 = __Pyx_decode_c_string(__pyx_v_msg, 0, strlen(__pyx_v_msg), NULL, NULL, PyUnicode_DecodeASCII); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1255, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_decode_c_string(__pyx_v_msg, 0, strlen(__pyx_v_msg), NULL, NULL, PyUnicode_DecodeASCII); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1260, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_dim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1255, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyInt_From_int(__pyx_v_dim); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1260, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_4 = PyUnicode_Format(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1255, __pyx_L1_error)
+  __pyx_t_4 = PyUnicode_Format(__pyx_t_2, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1260, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_INCREF(__pyx_v_error);
   __pyx_t_3 = __pyx_v_error; __pyx_t_2 = NULL;
   if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_3))) {
     __pyx_t_2 = PyMethod_GET_SELF(__pyx_t_3);
@@ -30260,22 +32112,22 @@
       __Pyx_INCREF(function);
       __Pyx_DECREF_SET(__pyx_t_3, function);
     }
   }
   __pyx_t_1 = (__pyx_t_2) ? __Pyx_PyObject_Call2Args(__pyx_t_3, __pyx_t_2, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_3, __pyx_t_4);
   __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 1255, __pyx_L1_error)
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 1260, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_Raise(__pyx_t_1, 0, 0, 0);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __PYX_ERR(1, 1255, __pyx_L1_error)
+  __PYX_ERR(1, 1260, __pyx_L1_error)
 
-  /* "View.MemoryView":1254
+  /* "View.MemoryView":1259
  * 
  * @cname('__pyx_memoryview_err_dim')
  * cdef int _err_dim(object error, char *msg, int dim) except -1 with gil:             # <<<<<<<<<<<<<<
  *     raise error(msg.decode('ascii') % dim)
  * 
  */
 
@@ -30291,15 +32143,15 @@
   __Pyx_RefNannyFinishContext();
   #ifdef WITH_THREAD
   __Pyx_PyGILState_Release(__pyx_gilstate_save);
   #endif
   return __pyx_r;
 }
 
-/* "View.MemoryView":1258
+/* "View.MemoryView":1263
  * 
  * @cname('__pyx_memoryview_err')
  * cdef int _err(object error, char *msg) except -1 with gil:             # <<<<<<<<<<<<<<
  *     if msg != NULL:
  *         raise error(msg.decode('ascii'))
  */
 
@@ -30307,38 +32159,41 @@
   int __pyx_r;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   #ifdef WITH_THREAD
   PyGILState_STATE __pyx_gilstate_save = __Pyx_PyGILState_Ensure();
   #endif
   __Pyx_RefNannySetupContext("_err", 0);
   __Pyx_INCREF(__pyx_v_error);
 
-  /* "View.MemoryView":1259
+  /* "View.MemoryView":1264
  * @cname('__pyx_memoryview_err')
  * cdef int _err(object error, char *msg) except -1 with gil:
  *     if msg != NULL:             # <<<<<<<<<<<<<<
  *         raise error(msg.decode('ascii'))
  *     else:
  */
   __pyx_t_1 = ((__pyx_v_msg != NULL) != 0);
   if (unlikely(__pyx_t_1)) {
 
-    /* "View.MemoryView":1260
+    /* "View.MemoryView":1265
  * cdef int _err(object error, char *msg) except -1 with gil:
  *     if msg != NULL:
  *         raise error(msg.decode('ascii'))             # <<<<<<<<<<<<<<
  *     else:
  *         raise error
  */
-    __pyx_t_3 = __Pyx_decode_c_string(__pyx_v_msg, 0, strlen(__pyx_v_msg), NULL, NULL, PyUnicode_DecodeASCII); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1260, __pyx_L1_error)
+    __pyx_t_3 = __Pyx_decode_c_string(__pyx_v_msg, 0, strlen(__pyx_v_msg), NULL, NULL, PyUnicode_DecodeASCII); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1265, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_3);
     __Pyx_INCREF(__pyx_v_error);
     __pyx_t_4 = __pyx_v_error; __pyx_t_5 = NULL;
     if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_4))) {
       __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
       if (likely(__pyx_t_5)) {
         PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
@@ -30346,43 +32201,43 @@
         __Pyx_INCREF(function);
         __Pyx_DECREF_SET(__pyx_t_4, function);
       }
     }
     __pyx_t_2 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_5, __pyx_t_3) : __Pyx_PyObject_CallOneArg(__pyx_t_4, __pyx_t_3);
     __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-    if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1260, __pyx_L1_error)
+    if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1265, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_2);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_Raise(__pyx_t_2, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __PYX_ERR(1, 1260, __pyx_L1_error)
+    __PYX_ERR(1, 1265, __pyx_L1_error)
 
-    /* "View.MemoryView":1259
+    /* "View.MemoryView":1264
  * @cname('__pyx_memoryview_err')
  * cdef int _err(object error, char *msg) except -1 with gil:
  *     if msg != NULL:             # <<<<<<<<<<<<<<
  *         raise error(msg.decode('ascii'))
  *     else:
  */
   }
 
-  /* "View.MemoryView":1262
+  /* "View.MemoryView":1267
  *         raise error(msg.decode('ascii'))
  *     else:
  *         raise error             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_copy_contents')
  */
   /*else*/ {
     __Pyx_Raise(__pyx_v_error, 0, 0, 0);
-    __PYX_ERR(1, 1262, __pyx_L1_error)
+    __PYX_ERR(1, 1267, __pyx_L1_error)
   }
 
-  /* "View.MemoryView":1258
+  /* "View.MemoryView":1263
  * 
  * @cname('__pyx_memoryview_err')
  * cdef int _err(object error, char *msg) except -1 with gil:             # <<<<<<<<<<<<<<
  *     if msg != NULL:
  *         raise error(msg.decode('ascii'))
  */
 
@@ -30398,15 +32253,15 @@
   __Pyx_RefNannyFinishContext();
   #ifdef WITH_THREAD
   __Pyx_PyGILState_Release(__pyx_gilstate_save);
   #endif
   return __pyx_r;
 }
 
-/* "View.MemoryView":1265
+/* "View.MemoryView":1270
  * 
  * @cname('__pyx_memoryview_copy_contents')
  * cdef int memoryview_copy_contents(__Pyx_memviewslice src,             # <<<<<<<<<<<<<<
  *                                   __Pyx_memviewslice dst,
  *                                   int src_ndim, int dst_ndim,
  */
 
@@ -30424,120 +32279,123 @@
   int __pyx_t_2;
   int __pyx_t_3;
   int __pyx_t_4;
   int __pyx_t_5;
   int __pyx_t_6;
   void *__pyx_t_7;
   int __pyx_t_8;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
 
-  /* "View.MemoryView":1273
+  /* "View.MemoryView":1278
  *     Check for overlapping memory and verify the shapes.
  *     """
  *     cdef void *tmpdata = NULL             # <<<<<<<<<<<<<<
  *     cdef size_t itemsize = src.memview.view.itemsize
  *     cdef int i
  */
   __pyx_v_tmpdata = NULL;
 
-  /* "View.MemoryView":1274
+  /* "View.MemoryView":1279
  *     """
  *     cdef void *tmpdata = NULL
  *     cdef size_t itemsize = src.memview.view.itemsize             # <<<<<<<<<<<<<<
  *     cdef int i
  *     cdef char order = get_best_order(&src, src_ndim)
  */
   __pyx_t_1 = __pyx_v_src.memview->view.itemsize;
   __pyx_v_itemsize = __pyx_t_1;
 
-  /* "View.MemoryView":1276
+  /* "View.MemoryView":1281
  *     cdef size_t itemsize = src.memview.view.itemsize
  *     cdef int i
  *     cdef char order = get_best_order(&src, src_ndim)             # <<<<<<<<<<<<<<
  *     cdef bint broadcasting = False
  *     cdef bint direct_copy = False
  */
   __pyx_v_order = __pyx_get_best_slice_order((&__pyx_v_src), __pyx_v_src_ndim);
 
-  /* "View.MemoryView":1277
+  /* "View.MemoryView":1282
  *     cdef int i
  *     cdef char order = get_best_order(&src, src_ndim)
  *     cdef bint broadcasting = False             # <<<<<<<<<<<<<<
  *     cdef bint direct_copy = False
  *     cdef __Pyx_memviewslice tmp
  */
   __pyx_v_broadcasting = 0;
 
-  /* "View.MemoryView":1278
+  /* "View.MemoryView":1283
  *     cdef char order = get_best_order(&src, src_ndim)
  *     cdef bint broadcasting = False
  *     cdef bint direct_copy = False             # <<<<<<<<<<<<<<
  *     cdef __Pyx_memviewslice tmp
  * 
  */
   __pyx_v_direct_copy = 0;
 
-  /* "View.MemoryView":1281
+  /* "View.MemoryView":1286
  *     cdef __Pyx_memviewslice tmp
  * 
  *     if src_ndim < dst_ndim:             # <<<<<<<<<<<<<<
  *         broadcast_leading(&src, src_ndim, dst_ndim)
  *     elif dst_ndim < src_ndim:
  */
   __pyx_t_2 = ((__pyx_v_src_ndim < __pyx_v_dst_ndim) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":1282
+    /* "View.MemoryView":1287
  * 
  *     if src_ndim < dst_ndim:
  *         broadcast_leading(&src, src_ndim, dst_ndim)             # <<<<<<<<<<<<<<
  *     elif dst_ndim < src_ndim:
  *         broadcast_leading(&dst, dst_ndim, src_ndim)
  */
     __pyx_memoryview_broadcast_leading((&__pyx_v_src), __pyx_v_src_ndim, __pyx_v_dst_ndim);
 
-    /* "View.MemoryView":1281
+    /* "View.MemoryView":1286
  *     cdef __Pyx_memviewslice tmp
  * 
  *     if src_ndim < dst_ndim:             # <<<<<<<<<<<<<<
  *         broadcast_leading(&src, src_ndim, dst_ndim)
  *     elif dst_ndim < src_ndim:
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":1283
+  /* "View.MemoryView":1288
  *     if src_ndim < dst_ndim:
  *         broadcast_leading(&src, src_ndim, dst_ndim)
  *     elif dst_ndim < src_ndim:             # <<<<<<<<<<<<<<
  *         broadcast_leading(&dst, dst_ndim, src_ndim)
  * 
  */
   __pyx_t_2 = ((__pyx_v_dst_ndim < __pyx_v_src_ndim) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":1284
+    /* "View.MemoryView":1289
  *         broadcast_leading(&src, src_ndim, dst_ndim)
  *     elif dst_ndim < src_ndim:
  *         broadcast_leading(&dst, dst_ndim, src_ndim)             # <<<<<<<<<<<<<<
  * 
  *     cdef int ndim = max(src_ndim, dst_ndim)
  */
     __pyx_memoryview_broadcast_leading((&__pyx_v_dst), __pyx_v_dst_ndim, __pyx_v_src_ndim);
 
-    /* "View.MemoryView":1283
+    /* "View.MemoryView":1288
  *     if src_ndim < dst_ndim:
  *         broadcast_leading(&src, src_ndim, dst_ndim)
  *     elif dst_ndim < src_ndim:             # <<<<<<<<<<<<<<
  *         broadcast_leading(&dst, dst_ndim, src_ndim)
  * 
  */
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":1286
+  /* "View.MemoryView":1291
  *         broadcast_leading(&dst, dst_ndim, src_ndim)
  * 
  *     cdef int ndim = max(src_ndim, dst_ndim)             # <<<<<<<<<<<<<<
  * 
  *     for i in range(ndim):
  */
   __pyx_t_3 = __pyx_v_dst_ndim;
@@ -30545,420 +32403,420 @@
   if (((__pyx_t_3 > __pyx_t_4) != 0)) {
     __pyx_t_5 = __pyx_t_3;
   } else {
     __pyx_t_5 = __pyx_t_4;
   }
   __pyx_v_ndim = __pyx_t_5;
 
-  /* "View.MemoryView":1288
+  /* "View.MemoryView":1293
  *     cdef int ndim = max(src_ndim, dst_ndim)
  * 
  *     for i in range(ndim):             # <<<<<<<<<<<<<<
  *         if src.shape[i] != dst.shape[i]:
  *             if src.shape[i] == 1:
  */
   __pyx_t_5 = __pyx_v_ndim;
   __pyx_t_3 = __pyx_t_5;
   for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
     __pyx_v_i = __pyx_t_4;
 
-    /* "View.MemoryView":1289
+    /* "View.MemoryView":1294
  * 
  *     for i in range(ndim):
  *         if src.shape[i] != dst.shape[i]:             # <<<<<<<<<<<<<<
  *             if src.shape[i] == 1:
  *                 broadcasting = True
  */
     __pyx_t_2 = (((__pyx_v_src.shape[__pyx_v_i]) != (__pyx_v_dst.shape[__pyx_v_i])) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":1290
+      /* "View.MemoryView":1295
  *     for i in range(ndim):
  *         if src.shape[i] != dst.shape[i]:
  *             if src.shape[i] == 1:             # <<<<<<<<<<<<<<
  *                 broadcasting = True
  *                 src.strides[i] = 0
  */
       __pyx_t_2 = (((__pyx_v_src.shape[__pyx_v_i]) == 1) != 0);
       if (__pyx_t_2) {
 
-        /* "View.MemoryView":1291
+        /* "View.MemoryView":1296
  *         if src.shape[i] != dst.shape[i]:
  *             if src.shape[i] == 1:
  *                 broadcasting = True             # <<<<<<<<<<<<<<
  *                 src.strides[i] = 0
  *             else:
  */
         __pyx_v_broadcasting = 1;
 
-        /* "View.MemoryView":1292
+        /* "View.MemoryView":1297
  *             if src.shape[i] == 1:
  *                 broadcasting = True
  *                 src.strides[i] = 0             # <<<<<<<<<<<<<<
  *             else:
  *                 _err_extents(i, dst.shape[i], src.shape[i])
  */
         (__pyx_v_src.strides[__pyx_v_i]) = 0;
 
-        /* "View.MemoryView":1290
+        /* "View.MemoryView":1295
  *     for i in range(ndim):
  *         if src.shape[i] != dst.shape[i]:
  *             if src.shape[i] == 1:             # <<<<<<<<<<<<<<
  *                 broadcasting = True
  *                 src.strides[i] = 0
  */
         goto __pyx_L7;
       }
 
-      /* "View.MemoryView":1294
+      /* "View.MemoryView":1299
  *                 src.strides[i] = 0
  *             else:
  *                 _err_extents(i, dst.shape[i], src.shape[i])             # <<<<<<<<<<<<<<
  * 
  *         if src.suboffsets[i] >= 0:
  */
       /*else*/ {
-        __pyx_t_6 = __pyx_memoryview_err_extents(__pyx_v_i, (__pyx_v_dst.shape[__pyx_v_i]), (__pyx_v_src.shape[__pyx_v_i])); if (unlikely(__pyx_t_6 == ((int)-1))) __PYX_ERR(1, 1294, __pyx_L1_error)
+        __pyx_t_6 = __pyx_memoryview_err_extents(__pyx_v_i, (__pyx_v_dst.shape[__pyx_v_i]), (__pyx_v_src.shape[__pyx_v_i])); if (unlikely(__pyx_t_6 == ((int)-1))) __PYX_ERR(1, 1299, __pyx_L1_error)
       }
       __pyx_L7:;
 
-      /* "View.MemoryView":1289
+      /* "View.MemoryView":1294
  * 
  *     for i in range(ndim):
  *         if src.shape[i] != dst.shape[i]:             # <<<<<<<<<<<<<<
  *             if src.shape[i] == 1:
  *                 broadcasting = True
  */
     }
 
-    /* "View.MemoryView":1296
+    /* "View.MemoryView":1301
  *                 _err_extents(i, dst.shape[i], src.shape[i])
  * 
  *         if src.suboffsets[i] >= 0:             # <<<<<<<<<<<<<<
  *             _err_dim(ValueError, "Dimension %d is not direct", i)
  * 
  */
     __pyx_t_2 = (((__pyx_v_src.suboffsets[__pyx_v_i]) >= 0) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":1297
+      /* "View.MemoryView":1302
  * 
  *         if src.suboffsets[i] >= 0:
  *             _err_dim(ValueError, "Dimension %d is not direct", i)             # <<<<<<<<<<<<<<
  * 
  *     if slices_overlap(&src, &dst, ndim, itemsize):
  */
-      __pyx_t_6 = __pyx_memoryview_err_dim(__pyx_builtin_ValueError, ((char *)"Dimension %d is not direct"), __pyx_v_i); if (unlikely(__pyx_t_6 == ((int)-1))) __PYX_ERR(1, 1297, __pyx_L1_error)
+      __pyx_t_6 = __pyx_memoryview_err_dim(__pyx_builtin_ValueError, ((char *)"Dimension %d is not direct"), __pyx_v_i); if (unlikely(__pyx_t_6 == ((int)-1))) __PYX_ERR(1, 1302, __pyx_L1_error)
 
-      /* "View.MemoryView":1296
+      /* "View.MemoryView":1301
  *                 _err_extents(i, dst.shape[i], src.shape[i])
  * 
  *         if src.suboffsets[i] >= 0:             # <<<<<<<<<<<<<<
  *             _err_dim(ValueError, "Dimension %d is not direct", i)
  * 
  */
     }
   }
 
-  /* "View.MemoryView":1299
+  /* "View.MemoryView":1304
  *             _err_dim(ValueError, "Dimension %d is not direct", i)
  * 
  *     if slices_overlap(&src, &dst, ndim, itemsize):             # <<<<<<<<<<<<<<
  * 
  *         if not slice_is_contig(src, order, ndim):
  */
   __pyx_t_2 = (__pyx_slices_overlap((&__pyx_v_src), (&__pyx_v_dst), __pyx_v_ndim, __pyx_v_itemsize) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":1301
+    /* "View.MemoryView":1306
  *     if slices_overlap(&src, &dst, ndim, itemsize):
  * 
  *         if not slice_is_contig(src, order, ndim):             # <<<<<<<<<<<<<<
  *             order = get_best_order(&dst, ndim)
  * 
  */
     __pyx_t_2 = ((!(__pyx_memviewslice_is_contig(__pyx_v_src, __pyx_v_order, __pyx_v_ndim) != 0)) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":1302
+      /* "View.MemoryView":1307
  * 
  *         if not slice_is_contig(src, order, ndim):
  *             order = get_best_order(&dst, ndim)             # <<<<<<<<<<<<<<
  * 
  *         tmpdata = copy_data_to_temp(&src, &tmp, order, ndim)
  */
       __pyx_v_order = __pyx_get_best_slice_order((&__pyx_v_dst), __pyx_v_ndim);
 
-      /* "View.MemoryView":1301
+      /* "View.MemoryView":1306
  *     if slices_overlap(&src, &dst, ndim, itemsize):
  * 
  *         if not slice_is_contig(src, order, ndim):             # <<<<<<<<<<<<<<
  *             order = get_best_order(&dst, ndim)
  * 
  */
     }
 
-    /* "View.MemoryView":1304
+    /* "View.MemoryView":1309
  *             order = get_best_order(&dst, ndim)
  * 
  *         tmpdata = copy_data_to_temp(&src, &tmp, order, ndim)             # <<<<<<<<<<<<<<
  *         src = tmp
  * 
  */
-    __pyx_t_7 = __pyx_memoryview_copy_data_to_temp((&__pyx_v_src), (&__pyx_v_tmp), __pyx_v_order, __pyx_v_ndim); if (unlikely(__pyx_t_7 == ((void *)NULL))) __PYX_ERR(1, 1304, __pyx_L1_error)
+    __pyx_t_7 = __pyx_memoryview_copy_data_to_temp((&__pyx_v_src), (&__pyx_v_tmp), __pyx_v_order, __pyx_v_ndim); if (unlikely(__pyx_t_7 == ((void *)NULL))) __PYX_ERR(1, 1309, __pyx_L1_error)
     __pyx_v_tmpdata = __pyx_t_7;
 
-    /* "View.MemoryView":1305
+    /* "View.MemoryView":1310
  * 
  *         tmpdata = copy_data_to_temp(&src, &tmp, order, ndim)
  *         src = tmp             # <<<<<<<<<<<<<<
  * 
  *     if not broadcasting:
  */
     __pyx_v_src = __pyx_v_tmp;
 
-    /* "View.MemoryView":1299
+    /* "View.MemoryView":1304
  *             _err_dim(ValueError, "Dimension %d is not direct", i)
  * 
  *     if slices_overlap(&src, &dst, ndim, itemsize):             # <<<<<<<<<<<<<<
  * 
  *         if not slice_is_contig(src, order, ndim):
  */
   }
 
-  /* "View.MemoryView":1307
+  /* "View.MemoryView":1312
  *         src = tmp
  * 
  *     if not broadcasting:             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_t_2 = ((!(__pyx_v_broadcasting != 0)) != 0);
   if (__pyx_t_2) {
 
-    /* "View.MemoryView":1310
+    /* "View.MemoryView":1315
  * 
  * 
  *         if slice_is_contig(src, 'C', ndim):             # <<<<<<<<<<<<<<
  *             direct_copy = slice_is_contig(dst, 'C', ndim)
  *         elif slice_is_contig(src, 'F', ndim):
  */
     __pyx_t_2 = (__pyx_memviewslice_is_contig(__pyx_v_src, 'C', __pyx_v_ndim) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":1311
+      /* "View.MemoryView":1316
  * 
  *         if slice_is_contig(src, 'C', ndim):
  *             direct_copy = slice_is_contig(dst, 'C', ndim)             # <<<<<<<<<<<<<<
  *         elif slice_is_contig(src, 'F', ndim):
  *             direct_copy = slice_is_contig(dst, 'F', ndim)
  */
       __pyx_v_direct_copy = __pyx_memviewslice_is_contig(__pyx_v_dst, 'C', __pyx_v_ndim);
 
-      /* "View.MemoryView":1310
+      /* "View.MemoryView":1315
  * 
  * 
  *         if slice_is_contig(src, 'C', ndim):             # <<<<<<<<<<<<<<
  *             direct_copy = slice_is_contig(dst, 'C', ndim)
  *         elif slice_is_contig(src, 'F', ndim):
  */
       goto __pyx_L12;
     }
 
-    /* "View.MemoryView":1312
+    /* "View.MemoryView":1317
  *         if slice_is_contig(src, 'C', ndim):
  *             direct_copy = slice_is_contig(dst, 'C', ndim)
  *         elif slice_is_contig(src, 'F', ndim):             # <<<<<<<<<<<<<<
  *             direct_copy = slice_is_contig(dst, 'F', ndim)
  * 
  */
     __pyx_t_2 = (__pyx_memviewslice_is_contig(__pyx_v_src, 'F', __pyx_v_ndim) != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":1313
+      /* "View.MemoryView":1318
  *             direct_copy = slice_is_contig(dst, 'C', ndim)
  *         elif slice_is_contig(src, 'F', ndim):
  *             direct_copy = slice_is_contig(dst, 'F', ndim)             # <<<<<<<<<<<<<<
  * 
  *         if direct_copy:
  */
       __pyx_v_direct_copy = __pyx_memviewslice_is_contig(__pyx_v_dst, 'F', __pyx_v_ndim);
 
-      /* "View.MemoryView":1312
+      /* "View.MemoryView":1317
  *         if slice_is_contig(src, 'C', ndim):
  *             direct_copy = slice_is_contig(dst, 'C', ndim)
  *         elif slice_is_contig(src, 'F', ndim):             # <<<<<<<<<<<<<<
  *             direct_copy = slice_is_contig(dst, 'F', ndim)
  * 
  */
     }
     __pyx_L12:;
 
-    /* "View.MemoryView":1315
+    /* "View.MemoryView":1320
  *             direct_copy = slice_is_contig(dst, 'F', ndim)
  * 
  *         if direct_copy:             # <<<<<<<<<<<<<<
  * 
  *             refcount_copying(&dst, dtype_is_object, ndim, False)
  */
     __pyx_t_2 = (__pyx_v_direct_copy != 0);
     if (__pyx_t_2) {
 
-      /* "View.MemoryView":1317
+      /* "View.MemoryView":1322
  *         if direct_copy:
  * 
  *             refcount_copying(&dst, dtype_is_object, ndim, False)             # <<<<<<<<<<<<<<
  *             memcpy(dst.data, src.data, slice_get_size(&src, ndim))
  *             refcount_copying(&dst, dtype_is_object, ndim, True)
  */
       __pyx_memoryview_refcount_copying((&__pyx_v_dst), __pyx_v_dtype_is_object, __pyx_v_ndim, 0);
 
-      /* "View.MemoryView":1318
+      /* "View.MemoryView":1323
  * 
  *             refcount_copying(&dst, dtype_is_object, ndim, False)
  *             memcpy(dst.data, src.data, slice_get_size(&src, ndim))             # <<<<<<<<<<<<<<
  *             refcount_copying(&dst, dtype_is_object, ndim, True)
  *             free(tmpdata)
  */
       (void)(memcpy(__pyx_v_dst.data, __pyx_v_src.data, __pyx_memoryview_slice_get_size((&__pyx_v_src), __pyx_v_ndim)));
 
-      /* "View.MemoryView":1319
+      /* "View.MemoryView":1324
  *             refcount_copying(&dst, dtype_is_object, ndim, False)
  *             memcpy(dst.data, src.data, slice_get_size(&src, ndim))
  *             refcount_copying(&dst, dtype_is_object, ndim, True)             # <<<<<<<<<<<<<<
  *             free(tmpdata)
  *             return 0
  */
       __pyx_memoryview_refcount_copying((&__pyx_v_dst), __pyx_v_dtype_is_object, __pyx_v_ndim, 1);
 
-      /* "View.MemoryView":1320
+      /* "View.MemoryView":1325
  *             memcpy(dst.data, src.data, slice_get_size(&src, ndim))
  *             refcount_copying(&dst, dtype_is_object, ndim, True)
  *             free(tmpdata)             # <<<<<<<<<<<<<<
  *             return 0
  * 
  */
       free(__pyx_v_tmpdata);
 
-      /* "View.MemoryView":1321
+      /* "View.MemoryView":1326
  *             refcount_copying(&dst, dtype_is_object, ndim, True)
  *             free(tmpdata)
  *             return 0             # <<<<<<<<<<<<<<
  * 
  *     if order == 'F' == get_best_order(&dst, ndim):
  */
       __pyx_r = 0;
       goto __pyx_L0;
 
-      /* "View.MemoryView":1315
+      /* "View.MemoryView":1320
  *             direct_copy = slice_is_contig(dst, 'F', ndim)
  * 
  *         if direct_copy:             # <<<<<<<<<<<<<<
  * 
  *             refcount_copying(&dst, dtype_is_object, ndim, False)
  */
     }
 
-    /* "View.MemoryView":1307
+    /* "View.MemoryView":1312
  *         src = tmp
  * 
  *     if not broadcasting:             # <<<<<<<<<<<<<<
  * 
  * 
  */
   }
 
-  /* "View.MemoryView":1323
+  /* "View.MemoryView":1328
  *             return 0
  * 
  *     if order == 'F' == get_best_order(&dst, ndim):             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_t_2 = (__pyx_v_order == 'F');
   if (__pyx_t_2) {
     __pyx_t_2 = ('F' == __pyx_get_best_slice_order((&__pyx_v_dst), __pyx_v_ndim));
   }
   __pyx_t_8 = (__pyx_t_2 != 0);
   if (__pyx_t_8) {
 
-    /* "View.MemoryView":1326
+    /* "View.MemoryView":1331
  * 
  * 
  *         transpose_memslice(&src)             # <<<<<<<<<<<<<<
  *         transpose_memslice(&dst)
  * 
  */
-    __pyx_t_5 = __pyx_memslice_transpose((&__pyx_v_src)); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(1, 1326, __pyx_L1_error)
+    __pyx_t_5 = __pyx_memslice_transpose((&__pyx_v_src)); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(1, 1331, __pyx_L1_error)
 
-    /* "View.MemoryView":1327
+    /* "View.MemoryView":1332
  * 
  *         transpose_memslice(&src)
  *         transpose_memslice(&dst)             # <<<<<<<<<<<<<<
  * 
  *     refcount_copying(&dst, dtype_is_object, ndim, False)
  */
-    __pyx_t_5 = __pyx_memslice_transpose((&__pyx_v_dst)); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(1, 1327, __pyx_L1_error)
+    __pyx_t_5 = __pyx_memslice_transpose((&__pyx_v_dst)); if (unlikely(__pyx_t_5 == ((int)0))) __PYX_ERR(1, 1332, __pyx_L1_error)
 
-    /* "View.MemoryView":1323
+    /* "View.MemoryView":1328
  *             return 0
  * 
  *     if order == 'F' == get_best_order(&dst, ndim):             # <<<<<<<<<<<<<<
  * 
  * 
  */
   }
 
-  /* "View.MemoryView":1329
+  /* "View.MemoryView":1334
  *         transpose_memslice(&dst)
  * 
  *     refcount_copying(&dst, dtype_is_object, ndim, False)             # <<<<<<<<<<<<<<
  *     copy_strided_to_strided(&src, &dst, ndim, itemsize)
  *     refcount_copying(&dst, dtype_is_object, ndim, True)
  */
   __pyx_memoryview_refcount_copying((&__pyx_v_dst), __pyx_v_dtype_is_object, __pyx_v_ndim, 0);
 
-  /* "View.MemoryView":1330
+  /* "View.MemoryView":1335
  * 
  *     refcount_copying(&dst, dtype_is_object, ndim, False)
  *     copy_strided_to_strided(&src, &dst, ndim, itemsize)             # <<<<<<<<<<<<<<
  *     refcount_copying(&dst, dtype_is_object, ndim, True)
  * 
  */
   copy_strided_to_strided((&__pyx_v_src), (&__pyx_v_dst), __pyx_v_ndim, __pyx_v_itemsize);
 
-  /* "View.MemoryView":1331
+  /* "View.MemoryView":1336
  *     refcount_copying(&dst, dtype_is_object, ndim, False)
  *     copy_strided_to_strided(&src, &dst, ndim, itemsize)
  *     refcount_copying(&dst, dtype_is_object, ndim, True)             # <<<<<<<<<<<<<<
  * 
  *     free(tmpdata)
  */
   __pyx_memoryview_refcount_copying((&__pyx_v_dst), __pyx_v_dtype_is_object, __pyx_v_ndim, 1);
 
-  /* "View.MemoryView":1333
+  /* "View.MemoryView":1338
  *     refcount_copying(&dst, dtype_is_object, ndim, True)
  * 
  *     free(tmpdata)             # <<<<<<<<<<<<<<
  *     return 0
  * 
  */
   free(__pyx_v_tmpdata);
 
-  /* "View.MemoryView":1334
+  /* "View.MemoryView":1339
  * 
  *     free(tmpdata)
  *     return 0             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_broadcast_leading')
  */
   __pyx_r = 0;
   goto __pyx_L0;
 
-  /* "View.MemoryView":1265
+  /* "View.MemoryView":1270
  * 
  * @cname('__pyx_memoryview_copy_contents')
  * cdef int memoryview_copy_contents(__Pyx_memviewslice src,             # <<<<<<<<<<<<<<
  *                                   __Pyx_memviewslice dst,
  *                                   int src_ndim, int dst_ndim,
  */
 
@@ -30974,217 +32832,217 @@
     #endif
   }
   __pyx_r = -1;
   __pyx_L0:;
   return __pyx_r;
 }
 
-/* "View.MemoryView":1337
+/* "View.MemoryView":1342
  * 
  * @cname('__pyx_memoryview_broadcast_leading')
  * cdef void broadcast_leading(__Pyx_memviewslice *mslice,             # <<<<<<<<<<<<<<
  *                             int ndim,
  *                             int ndim_other) nogil:
  */
 
 static void __pyx_memoryview_broadcast_leading(__Pyx_memviewslice *__pyx_v_mslice, int __pyx_v_ndim, int __pyx_v_ndim_other) {
   int __pyx_v_i;
   int __pyx_v_offset;
   int __pyx_t_1;
   int __pyx_t_2;
   int __pyx_t_3;
 
-  /* "View.MemoryView":1341
+  /* "View.MemoryView":1346
  *                             int ndim_other) nogil:
  *     cdef int i
  *     cdef int offset = ndim_other - ndim             # <<<<<<<<<<<<<<
  * 
  *     for i in range(ndim - 1, -1, -1):
  */
   __pyx_v_offset = (__pyx_v_ndim_other - __pyx_v_ndim);
 
-  /* "View.MemoryView":1343
+  /* "View.MemoryView":1348
  *     cdef int offset = ndim_other - ndim
  * 
  *     for i in range(ndim - 1, -1, -1):             # <<<<<<<<<<<<<<
  *         mslice.shape[i + offset] = mslice.shape[i]
  *         mslice.strides[i + offset] = mslice.strides[i]
  */
   for (__pyx_t_1 = (__pyx_v_ndim - 1); __pyx_t_1 > -1; __pyx_t_1-=1) {
     __pyx_v_i = __pyx_t_1;
 
-    /* "View.MemoryView":1344
+    /* "View.MemoryView":1349
  * 
  *     for i in range(ndim - 1, -1, -1):
  *         mslice.shape[i + offset] = mslice.shape[i]             # <<<<<<<<<<<<<<
  *         mslice.strides[i + offset] = mslice.strides[i]
  *         mslice.suboffsets[i + offset] = mslice.suboffsets[i]
  */
     (__pyx_v_mslice->shape[(__pyx_v_i + __pyx_v_offset)]) = (__pyx_v_mslice->shape[__pyx_v_i]);
 
-    /* "View.MemoryView":1345
+    /* "View.MemoryView":1350
  *     for i in range(ndim - 1, -1, -1):
  *         mslice.shape[i + offset] = mslice.shape[i]
  *         mslice.strides[i + offset] = mslice.strides[i]             # <<<<<<<<<<<<<<
  *         mslice.suboffsets[i + offset] = mslice.suboffsets[i]
  * 
  */
     (__pyx_v_mslice->strides[(__pyx_v_i + __pyx_v_offset)]) = (__pyx_v_mslice->strides[__pyx_v_i]);
 
-    /* "View.MemoryView":1346
+    /* "View.MemoryView":1351
  *         mslice.shape[i + offset] = mslice.shape[i]
  *         mslice.strides[i + offset] = mslice.strides[i]
  *         mslice.suboffsets[i + offset] = mslice.suboffsets[i]             # <<<<<<<<<<<<<<
  * 
  *     for i in range(offset):
  */
     (__pyx_v_mslice->suboffsets[(__pyx_v_i + __pyx_v_offset)]) = (__pyx_v_mslice->suboffsets[__pyx_v_i]);
   }
 
-  /* "View.MemoryView":1348
+  /* "View.MemoryView":1353
  *         mslice.suboffsets[i + offset] = mslice.suboffsets[i]
  * 
  *     for i in range(offset):             # <<<<<<<<<<<<<<
  *         mslice.shape[i] = 1
  *         mslice.strides[i] = mslice.strides[0]
  */
   __pyx_t_1 = __pyx_v_offset;
   __pyx_t_2 = __pyx_t_1;
   for (__pyx_t_3 = 0; __pyx_t_3 < __pyx_t_2; __pyx_t_3+=1) {
     __pyx_v_i = __pyx_t_3;
 
-    /* "View.MemoryView":1349
+    /* "View.MemoryView":1354
  * 
  *     for i in range(offset):
  *         mslice.shape[i] = 1             # <<<<<<<<<<<<<<
  *         mslice.strides[i] = mslice.strides[0]
  *         mslice.suboffsets[i] = -1
  */
     (__pyx_v_mslice->shape[__pyx_v_i]) = 1;
 
-    /* "View.MemoryView":1350
+    /* "View.MemoryView":1355
  *     for i in range(offset):
  *         mslice.shape[i] = 1
  *         mslice.strides[i] = mslice.strides[0]             # <<<<<<<<<<<<<<
  *         mslice.suboffsets[i] = -1
  * 
  */
     (__pyx_v_mslice->strides[__pyx_v_i]) = (__pyx_v_mslice->strides[0]);
 
-    /* "View.MemoryView":1351
+    /* "View.MemoryView":1356
  *         mslice.shape[i] = 1
  *         mslice.strides[i] = mslice.strides[0]
  *         mslice.suboffsets[i] = -1             # <<<<<<<<<<<<<<
  * 
  * 
  */
     (__pyx_v_mslice->suboffsets[__pyx_v_i]) = -1L;
   }
 
-  /* "View.MemoryView":1337
+  /* "View.MemoryView":1342
  * 
  * @cname('__pyx_memoryview_broadcast_leading')
  * cdef void broadcast_leading(__Pyx_memviewslice *mslice,             # <<<<<<<<<<<<<<
  *                             int ndim,
  *                             int ndim_other) nogil:
  */
 
   /* function exit code */
 }
 
-/* "View.MemoryView":1359
+/* "View.MemoryView":1364
  * 
  * @cname('__pyx_memoryview_refcount_copying')
  * cdef void refcount_copying(__Pyx_memviewslice *dst, bint dtype_is_object,             # <<<<<<<<<<<<<<
  *                            int ndim, bint inc) nogil:
  * 
  */
 
 static void __pyx_memoryview_refcount_copying(__Pyx_memviewslice *__pyx_v_dst, int __pyx_v_dtype_is_object, int __pyx_v_ndim, int __pyx_v_inc) {
   int __pyx_t_1;
 
-  /* "View.MemoryView":1363
+  /* "View.MemoryView":1368
  * 
  * 
  *     if dtype_is_object:             # <<<<<<<<<<<<<<
  *         refcount_objects_in_slice_with_gil(dst.data, dst.shape,
  *                                            dst.strides, ndim, inc)
  */
   __pyx_t_1 = (__pyx_v_dtype_is_object != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":1364
+    /* "View.MemoryView":1369
  * 
  *     if dtype_is_object:
  *         refcount_objects_in_slice_with_gil(dst.data, dst.shape,             # <<<<<<<<<<<<<<
  *                                            dst.strides, ndim, inc)
  * 
  */
     __pyx_memoryview_refcount_objects_in_slice_with_gil(__pyx_v_dst->data, __pyx_v_dst->shape, __pyx_v_dst->strides, __pyx_v_ndim, __pyx_v_inc);
 
-    /* "View.MemoryView":1363
+    /* "View.MemoryView":1368
  * 
  * 
  *     if dtype_is_object:             # <<<<<<<<<<<<<<
  *         refcount_objects_in_slice_with_gil(dst.data, dst.shape,
  *                                            dst.strides, ndim, inc)
  */
   }
 
-  /* "View.MemoryView":1359
+  /* "View.MemoryView":1364
  * 
  * @cname('__pyx_memoryview_refcount_copying')
  * cdef void refcount_copying(__Pyx_memviewslice *dst, bint dtype_is_object,             # <<<<<<<<<<<<<<
  *                            int ndim, bint inc) nogil:
  * 
  */
 
   /* function exit code */
 }
 
-/* "View.MemoryView":1368
+/* "View.MemoryView":1373
  * 
  * @cname('__pyx_memoryview_refcount_objects_in_slice_with_gil')
  * cdef void refcount_objects_in_slice_with_gil(char *data, Py_ssize_t *shape,             # <<<<<<<<<<<<<<
  *                                              Py_ssize_t *strides, int ndim,
  *                                              bint inc) with gil:
  */
 
 static void __pyx_memoryview_refcount_objects_in_slice_with_gil(char *__pyx_v_data, Py_ssize_t *__pyx_v_shape, Py_ssize_t *__pyx_v_strides, int __pyx_v_ndim, int __pyx_v_inc) {
   __Pyx_RefNannyDeclarations
   #ifdef WITH_THREAD
   PyGILState_STATE __pyx_gilstate_save = __Pyx_PyGILState_Ensure();
   #endif
   __Pyx_RefNannySetupContext("refcount_objects_in_slice_with_gil", 0);
 
-  /* "View.MemoryView":1371
+  /* "View.MemoryView":1376
  *                                              Py_ssize_t *strides, int ndim,
  *                                              bint inc) with gil:
  *     refcount_objects_in_slice(data, shape, strides, ndim, inc)             # <<<<<<<<<<<<<<
  * 
  * @cname('__pyx_memoryview_refcount_objects_in_slice')
  */
   __pyx_memoryview_refcount_objects_in_slice(__pyx_v_data, __pyx_v_shape, __pyx_v_strides, __pyx_v_ndim, __pyx_v_inc);
 
-  /* "View.MemoryView":1368
+  /* "View.MemoryView":1373
  * 
  * @cname('__pyx_memoryview_refcount_objects_in_slice_with_gil')
  * cdef void refcount_objects_in_slice_with_gil(char *data, Py_ssize_t *shape,             # <<<<<<<<<<<<<<
  *                                              Py_ssize_t *strides, int ndim,
  *                                              bint inc) with gil:
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   #ifdef WITH_THREAD
   __Pyx_PyGILState_Release(__pyx_gilstate_save);
   #endif
 }
 
-/* "View.MemoryView":1374
+/* "View.MemoryView":1379
  * 
  * @cname('__pyx_memoryview_refcount_objects_in_slice')
  * cdef void refcount_objects_in_slice(char *data, Py_ssize_t *shape,             # <<<<<<<<<<<<<<
  *                                     Py_ssize_t *strides, int ndim, bint inc):
  *     cdef Py_ssize_t i
  */
 
@@ -31193,178 +33051,178 @@
   __Pyx_RefNannyDeclarations
   Py_ssize_t __pyx_t_1;
   Py_ssize_t __pyx_t_2;
   Py_ssize_t __pyx_t_3;
   int __pyx_t_4;
   __Pyx_RefNannySetupContext("refcount_objects_in_slice", 0);
 
-  /* "View.MemoryView":1378
+  /* "View.MemoryView":1383
  *     cdef Py_ssize_t i
  * 
  *     for i in range(shape[0]):             # <<<<<<<<<<<<<<
  *         if ndim == 1:
  *             if inc:
  */
   __pyx_t_1 = (__pyx_v_shape[0]);
   __pyx_t_2 = __pyx_t_1;
   for (__pyx_t_3 = 0; __pyx_t_3 < __pyx_t_2; __pyx_t_3+=1) {
     __pyx_v_i = __pyx_t_3;
 
-    /* "View.MemoryView":1379
+    /* "View.MemoryView":1384
  * 
  *     for i in range(shape[0]):
  *         if ndim == 1:             # <<<<<<<<<<<<<<
  *             if inc:
  *                 Py_INCREF((<PyObject **> data)[0])
  */
     __pyx_t_4 = ((__pyx_v_ndim == 1) != 0);
     if (__pyx_t_4) {
 
-      /* "View.MemoryView":1380
+      /* "View.MemoryView":1385
  *     for i in range(shape[0]):
  *         if ndim == 1:
  *             if inc:             # <<<<<<<<<<<<<<
  *                 Py_INCREF((<PyObject **> data)[0])
  *             else:
  */
       __pyx_t_4 = (__pyx_v_inc != 0);
       if (__pyx_t_4) {
 
-        /* "View.MemoryView":1381
+        /* "View.MemoryView":1386
  *         if ndim == 1:
  *             if inc:
  *                 Py_INCREF((<PyObject **> data)[0])             # <<<<<<<<<<<<<<
  *             else:
  *                 Py_DECREF((<PyObject **> data)[0])
  */
         Py_INCREF((((PyObject **)__pyx_v_data)[0]));
 
-        /* "View.MemoryView":1380
+        /* "View.MemoryView":1385
  *     for i in range(shape[0]):
  *         if ndim == 1:
  *             if inc:             # <<<<<<<<<<<<<<
  *                 Py_INCREF((<PyObject **> data)[0])
  *             else:
  */
         goto __pyx_L6;
       }
 
-      /* "View.MemoryView":1383
+      /* "View.MemoryView":1388
  *                 Py_INCREF((<PyObject **> data)[0])
  *             else:
  *                 Py_DECREF((<PyObject **> data)[0])             # <<<<<<<<<<<<<<
  *         else:
  *             refcount_objects_in_slice(data, shape + 1, strides + 1,
  */
       /*else*/ {
         Py_DECREF((((PyObject **)__pyx_v_data)[0]));
       }
       __pyx_L6:;
 
-      /* "View.MemoryView":1379
+      /* "View.MemoryView":1384
  * 
  *     for i in range(shape[0]):
  *         if ndim == 1:             # <<<<<<<<<<<<<<
  *             if inc:
  *                 Py_INCREF((<PyObject **> data)[0])
  */
       goto __pyx_L5;
     }
 
-    /* "View.MemoryView":1385
+    /* "View.MemoryView":1390
  *                 Py_DECREF((<PyObject **> data)[0])
  *         else:
  *             refcount_objects_in_slice(data, shape + 1, strides + 1,             # <<<<<<<<<<<<<<
  *                                       ndim - 1, inc)
  * 
  */
     /*else*/ {
 
-      /* "View.MemoryView":1386
+      /* "View.MemoryView":1391
  *         else:
  *             refcount_objects_in_slice(data, shape + 1, strides + 1,
  *                                       ndim - 1, inc)             # <<<<<<<<<<<<<<
  * 
  *         data += strides[0]
  */
       __pyx_memoryview_refcount_objects_in_slice(__pyx_v_data, (__pyx_v_shape + 1), (__pyx_v_strides + 1), (__pyx_v_ndim - 1), __pyx_v_inc);
     }
     __pyx_L5:;
 
-    /* "View.MemoryView":1388
+    /* "View.MemoryView":1393
  *                                       ndim - 1, inc)
  * 
  *         data += strides[0]             # <<<<<<<<<<<<<<
  * 
  * 
  */
     __pyx_v_data = (__pyx_v_data + (__pyx_v_strides[0]));
   }
 
-  /* "View.MemoryView":1374
+  /* "View.MemoryView":1379
  * 
  * @cname('__pyx_memoryview_refcount_objects_in_slice')
  * cdef void refcount_objects_in_slice(char *data, Py_ssize_t *shape,             # <<<<<<<<<<<<<<
  *                                     Py_ssize_t *strides, int ndim, bint inc):
  *     cdef Py_ssize_t i
  */
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
 }
 
-/* "View.MemoryView":1394
+/* "View.MemoryView":1399
  * 
  * @cname('__pyx_memoryview_slice_assign_scalar')
  * cdef void slice_assign_scalar(__Pyx_memviewslice *dst, int ndim,             # <<<<<<<<<<<<<<
  *                               size_t itemsize, void *item,
  *                               bint dtype_is_object) nogil:
  */
 
 static void __pyx_memoryview_slice_assign_scalar(__Pyx_memviewslice *__pyx_v_dst, int __pyx_v_ndim, size_t __pyx_v_itemsize, void *__pyx_v_item, int __pyx_v_dtype_is_object) {
 
-  /* "View.MemoryView":1397
+  /* "View.MemoryView":1402
  *                               size_t itemsize, void *item,
  *                               bint dtype_is_object) nogil:
  *     refcount_copying(dst, dtype_is_object, ndim, False)             # <<<<<<<<<<<<<<
  *     _slice_assign_scalar(dst.data, dst.shape, dst.strides, ndim,
  *                          itemsize, item)
  */
   __pyx_memoryview_refcount_copying(__pyx_v_dst, __pyx_v_dtype_is_object, __pyx_v_ndim, 0);
 
-  /* "View.MemoryView":1398
+  /* "View.MemoryView":1403
  *                               bint dtype_is_object) nogil:
  *     refcount_copying(dst, dtype_is_object, ndim, False)
  *     _slice_assign_scalar(dst.data, dst.shape, dst.strides, ndim,             # <<<<<<<<<<<<<<
  *                          itemsize, item)
  *     refcount_copying(dst, dtype_is_object, ndim, True)
  */
   __pyx_memoryview__slice_assign_scalar(__pyx_v_dst->data, __pyx_v_dst->shape, __pyx_v_dst->strides, __pyx_v_ndim, __pyx_v_itemsize, __pyx_v_item);
 
-  /* "View.MemoryView":1400
+  /* "View.MemoryView":1405
  *     _slice_assign_scalar(dst.data, dst.shape, dst.strides, ndim,
  *                          itemsize, item)
  *     refcount_copying(dst, dtype_is_object, ndim, True)             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_memoryview_refcount_copying(__pyx_v_dst, __pyx_v_dtype_is_object, __pyx_v_ndim, 1);
 
-  /* "View.MemoryView":1394
+  /* "View.MemoryView":1399
  * 
  * @cname('__pyx_memoryview_slice_assign_scalar')
  * cdef void slice_assign_scalar(__Pyx_memviewslice *dst, int ndim,             # <<<<<<<<<<<<<<
  *                               size_t itemsize, void *item,
  *                               bint dtype_is_object) nogil:
  */
 
   /* function exit code */
 }
 
-/* "View.MemoryView":1404
+/* "View.MemoryView":1409
  * 
  * @cname('__pyx_memoryview__slice_assign_scalar')
  * cdef void _slice_assign_scalar(char *data, Py_ssize_t *shape,             # <<<<<<<<<<<<<<
  *                               Py_ssize_t *strides, int ndim,
  *                               size_t itemsize, void *item) nogil:
  */
 
@@ -31373,118 +33231,118 @@
   Py_ssize_t __pyx_v_stride;
   Py_ssize_t __pyx_v_extent;
   int __pyx_t_1;
   Py_ssize_t __pyx_t_2;
   Py_ssize_t __pyx_t_3;
   Py_ssize_t __pyx_t_4;
 
-  /* "View.MemoryView":1408
+  /* "View.MemoryView":1413
  *                               size_t itemsize, void *item) nogil:
  *     cdef Py_ssize_t i
  *     cdef Py_ssize_t stride = strides[0]             # <<<<<<<<<<<<<<
  *     cdef Py_ssize_t extent = shape[0]
  * 
  */
   __pyx_v_stride = (__pyx_v_strides[0]);
 
-  /* "View.MemoryView":1409
+  /* "View.MemoryView":1414
  *     cdef Py_ssize_t i
  *     cdef Py_ssize_t stride = strides[0]
  *     cdef Py_ssize_t extent = shape[0]             # <<<<<<<<<<<<<<
  * 
  *     if ndim == 1:
  */
   __pyx_v_extent = (__pyx_v_shape[0]);
 
-  /* "View.MemoryView":1411
+  /* "View.MemoryView":1416
  *     cdef Py_ssize_t extent = shape[0]
  * 
  *     if ndim == 1:             # <<<<<<<<<<<<<<
  *         for i in range(extent):
  *             memcpy(data, item, itemsize)
  */
   __pyx_t_1 = ((__pyx_v_ndim == 1) != 0);
   if (__pyx_t_1) {
 
-    /* "View.MemoryView":1412
+    /* "View.MemoryView":1417
  * 
  *     if ndim == 1:
  *         for i in range(extent):             # <<<<<<<<<<<<<<
  *             memcpy(data, item, itemsize)
  *             data += stride
  */
     __pyx_t_2 = __pyx_v_extent;
     __pyx_t_3 = __pyx_t_2;
     for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
       __pyx_v_i = __pyx_t_4;
 
-      /* "View.MemoryView":1413
+      /* "View.MemoryView":1418
  *     if ndim == 1:
  *         for i in range(extent):
  *             memcpy(data, item, itemsize)             # <<<<<<<<<<<<<<
  *             data += stride
  *     else:
  */
       (void)(memcpy(__pyx_v_data, __pyx_v_item, __pyx_v_itemsize));
 
-      /* "View.MemoryView":1414
+      /* "View.MemoryView":1419
  *         for i in range(extent):
  *             memcpy(data, item, itemsize)
  *             data += stride             # <<<<<<<<<<<<<<
  *     else:
  *         for i in range(extent):
  */
       __pyx_v_data = (__pyx_v_data + __pyx_v_stride);
     }
 
-    /* "View.MemoryView":1411
+    /* "View.MemoryView":1416
  *     cdef Py_ssize_t extent = shape[0]
  * 
  *     if ndim == 1:             # <<<<<<<<<<<<<<
  *         for i in range(extent):
  *             memcpy(data, item, itemsize)
  */
     goto __pyx_L3;
   }
 
-  /* "View.MemoryView":1416
+  /* "View.MemoryView":1421
  *             data += stride
  *     else:
  *         for i in range(extent):             # <<<<<<<<<<<<<<
  *             _slice_assign_scalar(data, shape + 1, strides + 1,
  *                                 ndim - 1, itemsize, item)
  */
   /*else*/ {
     __pyx_t_2 = __pyx_v_extent;
     __pyx_t_3 = __pyx_t_2;
     for (__pyx_t_4 = 0; __pyx_t_4 < __pyx_t_3; __pyx_t_4+=1) {
       __pyx_v_i = __pyx_t_4;
 
-      /* "View.MemoryView":1417
+      /* "View.MemoryView":1422
  *     else:
  *         for i in range(extent):
  *             _slice_assign_scalar(data, shape + 1, strides + 1,             # <<<<<<<<<<<<<<
  *                                 ndim - 1, itemsize, item)
  *             data += stride
  */
       __pyx_memoryview__slice_assign_scalar(__pyx_v_data, (__pyx_v_shape + 1), (__pyx_v_strides + 1), (__pyx_v_ndim - 1), __pyx_v_itemsize, __pyx_v_item);
 
-      /* "View.MemoryView":1419
+      /* "View.MemoryView":1424
  *             _slice_assign_scalar(data, shape + 1, strides + 1,
  *                                 ndim - 1, itemsize, item)
  *             data += stride             # <<<<<<<<<<<<<<
  * 
  * 
  */
       __pyx_v_data = (__pyx_v_data + __pyx_v_stride);
     }
   }
   __pyx_L3:;
 
-  /* "View.MemoryView":1404
+  /* "View.MemoryView":1409
  * 
  * @cname('__pyx_memoryview__slice_assign_scalar')
  * cdef void _slice_assign_scalar(char *data, Py_ssize_t *shape,             # <<<<<<<<<<<<<<
  *                               Py_ssize_t *strides, int ndim,
  *                               size_t itemsize, void *item) nogil:
  */
 
@@ -31500,14 +33358,17 @@
 /* Python wrapper */
 static PyObject *__pyx_pw_15View_dot_MemoryView_1__pyx_unpickle_Enum(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
 static PyMethodDef __pyx_mdef_15View_dot_MemoryView_1__pyx_unpickle_Enum = {"__pyx_unpickle_Enum", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_15View_dot_MemoryView_1__pyx_unpickle_Enum, METH_VARARGS|METH_KEYWORDS, 0};
 static PyObject *__pyx_pw_15View_dot_MemoryView_1__pyx_unpickle_Enum(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v___pyx_type = 0;
   long __pyx_v___pyx_checksum;
   PyObject *__pyx_v___pyx_state = 0;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__pyx_unpickle_Enum (wrapper)", 0);
   {
     static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_type,&__pyx_n_s_pyx_checksum,&__pyx_n_s_pyx_state,0};
     PyObject* values[3] = {0,0,0};
     if (unlikely(__pyx_kwds)) {
@@ -31571,148 +33432,155 @@
 }
 
 static PyObject *__pyx_pf_15View_dot_MemoryView___pyx_unpickle_Enum(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
   PyObject *__pyx_v___pyx_PickleError = 0;
   PyObject *__pyx_v___pyx_result = 0;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
-  int __pyx_t_1;
-  PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_t_2;
+  int __pyx_t_3;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
-  int __pyx_t_6;
+  PyObject *__pyx_t_6 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_Enum", 0);
 
   /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0xb068931:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum not in (0xb068931, 0x82a3537, 0x6ae9995):             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xb068931 = (name))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xb068931, 0x82a3537, 0x6ae9995) = (name))" % __pyx_checksum)
  */
-  __pyx_t_1 = ((__pyx_v___pyx_checksum != 0xb068931) != 0);
-  if (__pyx_t_1) {
+  __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = (__Pyx_PySequence_ContainsTF(__pyx_t_1, __pyx_tuple__31, Py_NE)); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_3 = (__pyx_t_2 != 0);
+  if (__pyx_t_3) {
 
     /* "(tree fragment)":5
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0xb068931:
+ *     if __pyx_checksum not in (0xb068931, 0x82a3537, 0x6ae9995):
  *         from pickle import PickleError as __pyx_PickleError             # <<<<<<<<<<<<<<
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xb068931 = (name))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xb068931, 0x82a3537, 0x6ae9995) = (name))" % __pyx_checksum)
  *     __pyx_result = Enum.__new__(__pyx_type)
  */
-    __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_1 = PyList_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
     __Pyx_INCREF(__pyx_n_s_PickleError);
     __Pyx_GIVEREF(__pyx_n_s_PickleError);
-    PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_PickleError);
-    __pyx_t_3 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_2, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __Pyx_INCREF(__pyx_t_2);
-    __pyx_v___pyx_PickleError = __pyx_t_2;
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_s_PickleError);
+    __pyx_t_4 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_1, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __pyx_t_1 = __Pyx_ImportFrom(__pyx_t_4, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_INCREF(__pyx_t_1);
+    __pyx_v___pyx_PickleError = __pyx_t_1;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
     /* "(tree fragment)":6
- *     if __pyx_checksum != 0xb068931:
+ *     if __pyx_checksum not in (0xb068931, 0x82a3537, 0x6ae9995):
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xb068931 = (name))" % __pyx_checksum)             # <<<<<<<<<<<<<<
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xb068931, 0x82a3537, 0x6ae9995) = (name))" % __pyx_checksum)             # <<<<<<<<<<<<<<
  *     __pyx_result = Enum.__new__(__pyx_type)
  *     if __pyx_state is not None:
  */
-    __pyx_t_2 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_2);
-    __pyx_t_4 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_s_vs_0xb0, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_1 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_5 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_5, __pyx_t_1); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_5);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __Pyx_INCREF(__pyx_v___pyx_PickleError);
-    __pyx_t_2 = __pyx_v___pyx_PickleError; __pyx_t_5 = NULL;
-    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
-      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
-      if (likely(__pyx_t_5)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-        __Pyx_INCREF(__pyx_t_5);
+    __pyx_t_1 = __pyx_v___pyx_PickleError; __pyx_t_6 = NULL;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_1))) {
+      __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
+      if (likely(__pyx_t_6)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+        __Pyx_INCREF(__pyx_t_6);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_2, function);
+        __Pyx_DECREF_SET(__pyx_t_1, function);
       }
     }
-    __pyx_t_3 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_5, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4);
-    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __pyx_t_4 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_6, __pyx_t_5) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_t_5);
+    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+    if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_Raise(__pyx_t_4, 0, 0, 0);
     __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-    if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 6, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
     __PYX_ERR(1, 6, __pyx_L1_error)
 
     /* "(tree fragment)":4
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
- *     if __pyx_checksum != 0xb068931:             # <<<<<<<<<<<<<<
+ *     if __pyx_checksum not in (0xb068931, 0x82a3537, 0x6ae9995):             # <<<<<<<<<<<<<<
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xb068931 = (name))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xb068931, 0x82a3537, 0x6ae9995) = (name))" % __pyx_checksum)
  */
   }
 
   /* "(tree fragment)":7
  *         from pickle import PickleError as __pyx_PickleError
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xb068931 = (name))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xb068931, 0x82a3537, 0x6ae9995) = (name))" % __pyx_checksum)
  *     __pyx_result = Enum.__new__(__pyx_type)             # <<<<<<<<<<<<<<
  *     if __pyx_state is not None:
  *         __pyx_unpickle_Enum__set_state(<Enum> __pyx_result, __pyx_state)
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_MemviewEnum_type), __pyx_n_s_new); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 7, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_4 = NULL;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
-    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
-    if (likely(__pyx_t_4)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
-      __Pyx_INCREF(__pyx_t_4);
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_MemviewEnum_type), __pyx_n_s_new); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_5 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_1))) {
+    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_1);
+    if (likely(__pyx_t_5)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
+      __Pyx_INCREF(__pyx_t_5);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_2, function);
+      __Pyx_DECREF_SET(__pyx_t_1, function);
     }
   }
-  __pyx_t_3 = (__pyx_t_4) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_4, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_v___pyx_type);
-  __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-  if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 7, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_v___pyx_result = __pyx_t_3;
-  __pyx_t_3 = 0;
+  __pyx_t_4 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_5, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_1, __pyx_v___pyx_type);
+  __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+  if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result = __pyx_t_4;
+  __pyx_t_4 = 0;
 
   /* "(tree fragment)":8
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xb068931 = (name))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xb068931, 0x82a3537, 0x6ae9995) = (name))" % __pyx_checksum)
  *     __pyx_result = Enum.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_Enum__set_state(<Enum> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
-  __pyx_t_1 = (__pyx_v___pyx_state != Py_None);
-  __pyx_t_6 = (__pyx_t_1 != 0);
-  if (__pyx_t_6) {
+  __pyx_t_3 = (__pyx_v___pyx_state != Py_None);
+  __pyx_t_2 = (__pyx_t_3 != 0);
+  if (__pyx_t_2) {
 
     /* "(tree fragment)":9
  *     __pyx_result = Enum.__new__(__pyx_type)
  *     if __pyx_state is not None:
  *         __pyx_unpickle_Enum__set_state(<Enum> __pyx_result, __pyx_state)             # <<<<<<<<<<<<<<
  *     return __pyx_result
  * cdef __pyx_unpickle_Enum__set_state(Enum __pyx_result, tuple __pyx_state):
  */
-    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
-    __pyx_t_3 = __pyx_unpickle_Enum__set_state(((struct __pyx_MemviewEnum_obj *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 9, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
+    __pyx_t_4 = __pyx_unpickle_Enum__set_state(((struct __pyx_MemviewEnum_obj *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 9, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
     /* "(tree fragment)":8
- *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xb068931 = (name))" % __pyx_checksum)
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0xb068931, 0x82a3537, 0x6ae9995) = (name))" % __pyx_checksum)
  *     __pyx_result = Enum.__new__(__pyx_type)
  *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
  *         __pyx_unpickle_Enum__set_state(<Enum> __pyx_result, __pyx_state)
  *     return __pyx_result
  */
   }
 
@@ -31732,18 +33600,18 @@
  * def __pyx_unpickle_Enum(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_XDECREF(__pyx_t_6);
   __Pyx_AddTraceback("View.MemoryView.__pyx_unpickle_Enum", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v___pyx_PickleError);
   __Pyx_XDECREF(__pyx_v___pyx_result);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
@@ -31765,14 +33633,17 @@
   int __pyx_t_2;
   Py_ssize_t __pyx_t_3;
   int __pyx_t_4;
   int __pyx_t_5;
   PyObject *__pyx_t_6 = NULL;
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__pyx_unpickle_Enum__set_state", 0);
 
   /* "(tree fragment)":12
  *     return __pyx_result
  * cdef __pyx_unpickle_Enum__set_state(Enum __pyx_result, tuple __pyx_state):
  *     __pyx_result.name = __pyx_state[0]             # <<<<<<<<<<<<<<
  *     if len(__pyx_state) > 1 and hasattr(__pyx_result, '__dict__'):
@@ -31875,15 +33746,15 @@
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "BufferFormatFromTypeInfo":1460
+/* "BufferFormatFromTypeInfo":1465
  * 
  * @cname('__pyx_format_from_typeinfo')
  * cdef bytes format_from_typeinfo(__Pyx_TypeInfo *type):             # <<<<<<<<<<<<<<
  *     cdef __Pyx_StructField *field
  *     cdef __pyx_typeinfo_string fmt
  */
 
@@ -31895,327 +33766,336 @@
   PyObject *__pyx_v_alignment = NULL;
   PyObject *__pyx_v_parts = NULL;
   PyObject *__pyx_v_extents = NULL;
   int __pyx_v_i;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   int __pyx_t_1;
-  int __pyx_t_2;
-  PyObject *__pyx_t_3 = NULL;
-  __Pyx_StructField *__pyx_t_4;
+  PyObject *__pyx_t_2 = NULL;
+  __Pyx_StructField *__pyx_t_3;
+  PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
-  PyObject *__pyx_t_6 = NULL;
+  int __pyx_t_6;
   int __pyx_t_7;
   int __pyx_t_8;
   int __pyx_t_9;
-  int __pyx_t_10;
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("format_from_typeinfo", 0);
 
-  /* "BufferFormatFromTypeInfo":1465
+  /* "BufferFormatFromTypeInfo":1470
  *     cdef bytes part, result
  * 
  *     if type.typegroup == 'S':             # <<<<<<<<<<<<<<
- *         assert type.fields != NULL and type.fields.type != NULL
- * 
+ *         assert type.fields != NULL
+ *         assert type.fields.type != NULL
  */
   __pyx_t_1 = ((__pyx_v_type->typegroup == 'S') != 0);
   if (__pyx_t_1) {
 
-    /* "BufferFormatFromTypeInfo":1466
+    /* "BufferFormatFromTypeInfo":1471
  * 
  *     if type.typegroup == 'S':
- *         assert type.fields != NULL and type.fields.type != NULL             # <<<<<<<<<<<<<<
+ *         assert type.fields != NULL             # <<<<<<<<<<<<<<
+ *         assert type.fields.type != NULL
  * 
- *         if type.flags & __PYX_BUF_FLAGS_PACKED_STRUCT:
  */
     #ifndef CYTHON_WITHOUT_ASSERTIONS
     if (unlikely(!Py_OptimizeFlag)) {
-      __pyx_t_2 = ((__pyx_v_type->fields != NULL) != 0);
-      if (__pyx_t_2) {
-      } else {
-        __pyx_t_1 = __pyx_t_2;
-        goto __pyx_L4_bool_binop_done;
+      if (unlikely(!((__pyx_v_type->fields != NULL) != 0))) {
+        PyErr_SetNone(PyExc_AssertionError);
+        __PYX_ERR(1, 1471, __pyx_L1_error)
       }
-      __pyx_t_2 = ((__pyx_v_type->fields->type != NULL) != 0);
-      __pyx_t_1 = __pyx_t_2;
-      __pyx_L4_bool_binop_done:;
-      if (unlikely(!__pyx_t_1)) {
+    }
+    #endif
+
+    /* "BufferFormatFromTypeInfo":1472
+ *     if type.typegroup == 'S':
+ *         assert type.fields != NULL
+ *         assert type.fields.type != NULL             # <<<<<<<<<<<<<<
+ * 
+ *         if type.flags & __PYX_BUF_FLAGS_PACKED_STRUCT:
+ */
+    #ifndef CYTHON_WITHOUT_ASSERTIONS
+    if (unlikely(!Py_OptimizeFlag)) {
+      if (unlikely(!((__pyx_v_type->fields->type != NULL) != 0))) {
         PyErr_SetNone(PyExc_AssertionError);
-        __PYX_ERR(1, 1466, __pyx_L1_error)
+        __PYX_ERR(1, 1472, __pyx_L1_error)
       }
     }
     #endif
 
-    /* "BufferFormatFromTypeInfo":1468
- *         assert type.fields != NULL and type.fields.type != NULL
+    /* "BufferFormatFromTypeInfo":1474
+ *         assert type.fields.type != NULL
  * 
  *         if type.flags & __PYX_BUF_FLAGS_PACKED_STRUCT:             # <<<<<<<<<<<<<<
  *             alignment = b'^'
  *         else:
  */
     __pyx_t_1 = ((__pyx_v_type->flags & __PYX_BUF_FLAGS_PACKED_STRUCT) != 0);
     if (__pyx_t_1) {
 
-      /* "BufferFormatFromTypeInfo":1469
+      /* "BufferFormatFromTypeInfo":1475
  * 
  *         if type.flags & __PYX_BUF_FLAGS_PACKED_STRUCT:
  *             alignment = b'^'             # <<<<<<<<<<<<<<
  *         else:
  *             alignment = b''
  */
-      __Pyx_INCREF(__pyx_kp_b__31);
-      __pyx_v_alignment = __pyx_kp_b__31;
+      __Pyx_INCREF(__pyx_kp_b__32);
+      __pyx_v_alignment = __pyx_kp_b__32;
 
-      /* "BufferFormatFromTypeInfo":1468
- *         assert type.fields != NULL and type.fields.type != NULL
+      /* "BufferFormatFromTypeInfo":1474
+ *         assert type.fields.type != NULL
  * 
  *         if type.flags & __PYX_BUF_FLAGS_PACKED_STRUCT:             # <<<<<<<<<<<<<<
  *             alignment = b'^'
  *         else:
  */
-      goto __pyx_L6;
+      goto __pyx_L4;
     }
 
-    /* "BufferFormatFromTypeInfo":1471
+    /* "BufferFormatFromTypeInfo":1477
  *             alignment = b'^'
  *         else:
  *             alignment = b''             # <<<<<<<<<<<<<<
  * 
  *         parts = [b"T{"]
  */
     /*else*/ {
-      __Pyx_INCREF(__pyx_kp_b__32);
-      __pyx_v_alignment = __pyx_kp_b__32;
+      __Pyx_INCREF(__pyx_kp_b__33);
+      __pyx_v_alignment = __pyx_kp_b__33;
     }
-    __pyx_L6:;
+    __pyx_L4:;
 
-    /* "BufferFormatFromTypeInfo":1473
+    /* "BufferFormatFromTypeInfo":1479
  *             alignment = b''
  * 
  *         parts = [b"T{"]             # <<<<<<<<<<<<<<
  *         field = type.fields
  * 
  */
-    __pyx_t_3 = PyList_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1473, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1479, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
     __Pyx_INCREF(__pyx_kp_b_T);
     __Pyx_GIVEREF(__pyx_kp_b_T);
-    PyList_SET_ITEM(__pyx_t_3, 0, __pyx_kp_b_T);
-    __pyx_v_parts = ((PyObject*)__pyx_t_3);
-    __pyx_t_3 = 0;
+    PyList_SET_ITEM(__pyx_t_2, 0, __pyx_kp_b_T);
+    __pyx_v_parts = ((PyObject*)__pyx_t_2);
+    __pyx_t_2 = 0;
 
-    /* "BufferFormatFromTypeInfo":1474
+    /* "BufferFormatFromTypeInfo":1480
  * 
  *         parts = [b"T{"]
  *         field = type.fields             # <<<<<<<<<<<<<<
  * 
  *         while field.type:
  */
-    __pyx_t_4 = __pyx_v_type->fields;
-    __pyx_v_field = __pyx_t_4;
+    __pyx_t_3 = __pyx_v_type->fields;
+    __pyx_v_field = __pyx_t_3;
 
-    /* "BufferFormatFromTypeInfo":1476
+    /* "BufferFormatFromTypeInfo":1482
  *         field = type.fields
  * 
  *         while field.type:             # <<<<<<<<<<<<<<
  *             part = format_from_typeinfo(field.type)
  *             parts.append(part + b':' + field.name + b':')
  */
     while (1) {
       __pyx_t_1 = (__pyx_v_field->type != 0);
       if (!__pyx_t_1) break;
 
-      /* "BufferFormatFromTypeInfo":1477
+      /* "BufferFormatFromTypeInfo":1483
  * 
  *         while field.type:
  *             part = format_from_typeinfo(field.type)             # <<<<<<<<<<<<<<
  *             parts.append(part + b':' + field.name + b':')
  *             field += 1
  */
-      __pyx_t_3 = __pyx_format_from_typeinfo(__pyx_v_field->type); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1477, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_XDECREF_SET(__pyx_v_part, ((PyObject*)__pyx_t_3));
-      __pyx_t_3 = 0;
+      __pyx_t_2 = __pyx_format_from_typeinfo(__pyx_v_field->type); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1483, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_XDECREF_SET(__pyx_v_part, ((PyObject*)__pyx_t_2));
+      __pyx_t_2 = 0;
 
-      /* "BufferFormatFromTypeInfo":1478
+      /* "BufferFormatFromTypeInfo":1484
  *         while field.type:
  *             part = format_from_typeinfo(field.type)
  *             parts.append(part + b':' + field.name + b':')             # <<<<<<<<<<<<<<
  *             field += 1
  * 
  */
-      __pyx_t_3 = PyNumber_Add(__pyx_v_part, __pyx_kp_b__33); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1478, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = __Pyx_PyBytes_FromString(__pyx_v_field->name); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1478, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_t_6 = PyNumber_Add(__pyx_t_3, __pyx_t_5); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 1478, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_6);
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-      __pyx_t_5 = PyNumber_Add(__pyx_t_6, __pyx_kp_b__33); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1478, __pyx_L1_error)
+      __pyx_t_2 = PyNumber_Add(__pyx_v_part, __pyx_kp_b__34); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1484, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_4 = __Pyx_PyBytes_FromString(__pyx_v_field->name); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1484, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_t_5 = PyNumber_Add(__pyx_t_2, __pyx_t_4); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1484, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
-      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __pyx_t_7 = __Pyx_PyList_Append(__pyx_v_parts, __pyx_t_5); if (unlikely(__pyx_t_7 == ((int)-1))) __PYX_ERR(1, 1478, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+      __pyx_t_4 = PyNumber_Add(__pyx_t_5, __pyx_kp_b__34); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1484, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
       __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_6 = __Pyx_PyList_Append(__pyx_v_parts, __pyx_t_4); if (unlikely(__pyx_t_6 == ((int)-1))) __PYX_ERR(1, 1484, __pyx_L1_error)
+      __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
 
-      /* "BufferFormatFromTypeInfo":1479
+      /* "BufferFormatFromTypeInfo":1485
  *             part = format_from_typeinfo(field.type)
  *             parts.append(part + b':' + field.name + b':')
  *             field += 1             # <<<<<<<<<<<<<<
  * 
  *         result = alignment.join(parts) + b'}'
  */
       __pyx_v_field = (__pyx_v_field + 1);
     }
 
-    /* "BufferFormatFromTypeInfo":1481
+    /* "BufferFormatFromTypeInfo":1487
  *             field += 1
  * 
  *         result = alignment.join(parts) + b'}'             # <<<<<<<<<<<<<<
  *     else:
  *         fmt = __Pyx_TypeInfoToFormat(type)
  */
-    __pyx_t_5 = __Pyx_PyBytes_Join(__pyx_v_alignment, __pyx_v_parts); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1481, __pyx_L1_error)
+    __pyx_t_4 = __Pyx_PyBytes_Join(__pyx_v_alignment, __pyx_v_parts); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1487, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __pyx_t_5 = PyNumber_Add(__pyx_t_4, __pyx_kp_b__35); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1487, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_5);
-    __pyx_t_6 = PyNumber_Add(__pyx_t_5, __pyx_kp_b__34); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 1481, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_6);
-    __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-    if (!(likely(PyBytes_CheckExact(__pyx_t_6))||((__pyx_t_6) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_t_6)->tp_name), 0))) __PYX_ERR(1, 1481, __pyx_L1_error)
-    __pyx_v_result = ((PyObject*)__pyx_t_6);
-    __pyx_t_6 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    if (!(likely(PyBytes_CheckExact(__pyx_t_5))||((__pyx_t_5) == Py_None)||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_t_5)->tp_name), 0))) __PYX_ERR(1, 1487, __pyx_L1_error)
+    __pyx_v_result = ((PyObject*)__pyx_t_5);
+    __pyx_t_5 = 0;
 
-    /* "BufferFormatFromTypeInfo":1465
+    /* "BufferFormatFromTypeInfo":1470
  *     cdef bytes part, result
  * 
  *     if type.typegroup == 'S':             # <<<<<<<<<<<<<<
- *         assert type.fields != NULL and type.fields.type != NULL
- * 
+ *         assert type.fields != NULL
+ *         assert type.fields.type != NULL
  */
     goto __pyx_L3;
   }
 
-  /* "BufferFormatFromTypeInfo":1483
+  /* "BufferFormatFromTypeInfo":1489
  *         result = alignment.join(parts) + b'}'
  *     else:
  *         fmt = __Pyx_TypeInfoToFormat(type)             # <<<<<<<<<<<<<<
  *         if type.arraysize[0]:
  *             extents = [unicode(type.arraysize[i]) for i in range(type.ndim)]
  */
   /*else*/ {
     __pyx_v_fmt = __Pyx_TypeInfoToFormat(__pyx_v_type);
 
-    /* "BufferFormatFromTypeInfo":1484
+    /* "BufferFormatFromTypeInfo":1490
  *     else:
  *         fmt = __Pyx_TypeInfoToFormat(type)
  *         if type.arraysize[0]:             # <<<<<<<<<<<<<<
  *             extents = [unicode(type.arraysize[i]) for i in range(type.ndim)]
  *             result = (u"(%s)" % u','.join(extents)).encode('ascii') + fmt.string
  */
     __pyx_t_1 = ((__pyx_v_type->arraysize[0]) != 0);
     if (__pyx_t_1) {
 
-      /* "BufferFormatFromTypeInfo":1485
+      /* "BufferFormatFromTypeInfo":1491
  *         fmt = __Pyx_TypeInfoToFormat(type)
  *         if type.arraysize[0]:
  *             extents = [unicode(type.arraysize[i]) for i in range(type.ndim)]             # <<<<<<<<<<<<<<
  *             result = (u"(%s)" % u','.join(extents)).encode('ascii') + fmt.string
  *         else:
  */
-      __pyx_t_6 = PyList_New(0); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 1485, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_6);
-      __pyx_t_8 = __pyx_v_type->ndim;
-      __pyx_t_9 = __pyx_t_8;
-      for (__pyx_t_10 = 0; __pyx_t_10 < __pyx_t_9; __pyx_t_10+=1) {
-        __pyx_v_i = __pyx_t_10;
-        __pyx_t_5 = __Pyx_PyInt_FromSize_t((__pyx_v_type->arraysize[__pyx_v_i])); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1485, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_5);
-        __pyx_t_3 = __Pyx_PyObject_Unicode(__pyx_t_5); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1485, __pyx_L1_error)
-        __Pyx_GOTREF(__pyx_t_3);
-        __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-        if (unlikely(__Pyx_ListComp_Append(__pyx_t_6, (PyObject*)__pyx_t_3))) __PYX_ERR(1, 1485, __pyx_L1_error)
-        __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __pyx_t_5 = PyList_New(0); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1491, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __pyx_t_7 = __pyx_v_type->ndim;
+      __pyx_t_8 = __pyx_t_7;
+      for (__pyx_t_9 = 0; __pyx_t_9 < __pyx_t_8; __pyx_t_9+=1) {
+        __pyx_v_i = __pyx_t_9;
+        __pyx_t_4 = __Pyx_PyInt_FromSize_t((__pyx_v_type->arraysize[__pyx_v_i])); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1491, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_4);
+        __pyx_t_2 = __Pyx_PyObject_Unicode(__pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1491, __pyx_L1_error)
+        __Pyx_GOTREF(__pyx_t_2);
+        __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+        if (unlikely(__Pyx_ListComp_Append(__pyx_t_5, (PyObject*)__pyx_t_2))) __PYX_ERR(1, 1491, __pyx_L1_error)
+        __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
       }
-      __pyx_v_extents = ((PyObject*)__pyx_t_6);
-      __pyx_t_6 = 0;
+      __pyx_v_extents = ((PyObject*)__pyx_t_5);
+      __pyx_t_5 = 0;
 
-      /* "BufferFormatFromTypeInfo":1486
+      /* "BufferFormatFromTypeInfo":1492
  *         if type.arraysize[0]:
  *             extents = [unicode(type.arraysize[i]) for i in range(type.ndim)]
  *             result = (u"(%s)" % u','.join(extents)).encode('ascii') + fmt.string             # <<<<<<<<<<<<<<
  *         else:
  *             result = fmt.string
  */
-      __pyx_t_6 = PyUnicode_Join(__pyx_kp_u__35, __pyx_v_extents); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 1486, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_6);
-      __pyx_t_3 = PyUnicode_Format(__pyx_kp_u_s, __pyx_t_6); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1486, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __pyx_t_6 = PyUnicode_AsASCIIString(((PyObject*)__pyx_t_3)); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 1486, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_6);
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      __pyx_t_3 = __Pyx_PyObject_FromString(__pyx_v_fmt.string); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1486, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_3);
-      __pyx_t_5 = PyNumber_Add(__pyx_t_6, __pyx_t_3); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1486, __pyx_L1_error)
+      __pyx_t_5 = PyUnicode_Join(__pyx_kp_u__36, __pyx_v_extents); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1492, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_5);
-      __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
-      __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-      if (!(likely(PyBytes_CheckExact(__pyx_t_5))||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_t_5)->tp_name), 0))) __PYX_ERR(1, 1486, __pyx_L1_error)
-      __pyx_v_result = ((PyObject*)__pyx_t_5);
-      __pyx_t_5 = 0;
+      __pyx_t_2 = PyUnicode_Format(__pyx_kp_u_s, __pyx_t_5); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1492, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __pyx_t_5 = PyUnicode_AsASCIIString(((PyObject*)__pyx_t_2)); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1492, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_5);
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      __pyx_t_2 = __Pyx_PyObject_FromString(__pyx_v_fmt.string); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1492, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_2);
+      __pyx_t_4 = PyNumber_Add(__pyx_t_5, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1492, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
+      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+      if (!(likely(PyBytes_CheckExact(__pyx_t_4))||((void)PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "bytes", Py_TYPE(__pyx_t_4)->tp_name), 0))) __PYX_ERR(1, 1492, __pyx_L1_error)
+      __pyx_v_result = ((PyObject*)__pyx_t_4);
+      __pyx_t_4 = 0;
 
-      /* "BufferFormatFromTypeInfo":1484
+      /* "BufferFormatFromTypeInfo":1490
  *     else:
  *         fmt = __Pyx_TypeInfoToFormat(type)
  *         if type.arraysize[0]:             # <<<<<<<<<<<<<<
  *             extents = [unicode(type.arraysize[i]) for i in range(type.ndim)]
  *             result = (u"(%s)" % u','.join(extents)).encode('ascii') + fmt.string
  */
-      goto __pyx_L9;
+      goto __pyx_L7;
     }
 
-    /* "BufferFormatFromTypeInfo":1488
+    /* "BufferFormatFromTypeInfo":1494
  *             result = (u"(%s)" % u','.join(extents)).encode('ascii') + fmt.string
  *         else:
  *             result = fmt.string             # <<<<<<<<<<<<<<
  * 
  *     return result
  */
     /*else*/ {
-      __pyx_t_5 = __Pyx_PyObject_FromString(__pyx_v_fmt.string); if (unlikely(!__pyx_t_5)) __PYX_ERR(1, 1488, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_5);
-      __pyx_v_result = ((PyObject*)__pyx_t_5);
-      __pyx_t_5 = 0;
+      __pyx_t_4 = __Pyx_PyObject_FromString(__pyx_v_fmt.string); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1494, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_4);
+      __pyx_v_result = ((PyObject*)__pyx_t_4);
+      __pyx_t_4 = 0;
     }
-    __pyx_L9:;
+    __pyx_L7:;
   }
   __pyx_L3:;
 
-  /* "BufferFormatFromTypeInfo":1490
+  /* "BufferFormatFromTypeInfo":1496
  *             result = fmt.string
  * 
  *     return result             # <<<<<<<<<<<<<<
  */
   __Pyx_XDECREF(__pyx_r);
   __Pyx_INCREF(__pyx_v_result);
   __pyx_r = __pyx_v_result;
   goto __pyx_L0;
 
-  /* "BufferFormatFromTypeInfo":1460
+  /* "BufferFormatFromTypeInfo":1465
  * 
  * @cname('__pyx_format_from_typeinfo')
  * cdef bytes format_from_typeinfo(__Pyx_TypeInfo *type):             # <<<<<<<<<<<<<<
  *     cdef __Pyx_StructField *field
  *     cdef __pyx_typeinfo_string fmt
  */
 
   /* function exit code */
   __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_4);
   __Pyx_XDECREF(__pyx_t_5);
-  __Pyx_XDECREF(__pyx_t_6);
   __Pyx_AddTraceback("BufferFormatFromTypeInfo.format_from_typeinfo", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = 0;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v_part);
   __Pyx_XDECREF(__pyx_v_result);
   __Pyx_XDECREF(__pyx_v_alignment);
   __Pyx_XDECREF(__pyx_v_parts);
@@ -32270,18 +34150,17 @@
   else {
     PyErr_SetString(PyExc_NotImplementedError, "__del__");
     return -1;
   }
 }
 
 static PyMethodDef __pyx_methods_6tkwant_7onebody_7kernels_Kernel[] = {
-  {"set_params", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_3set_params, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_2set_params},
-  {"rhs", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_5rhs, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_4rhs},
-  {"__reduce_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_7__reduce_cython__, METH_NOARGS, __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_6__reduce_cython__},
-  {"__setstate_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_9__setstate_cython__, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_8__setstate_cython__},
+  {"rhs", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_3rhs, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_2rhs},
+  {"__reduce_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_5__reduce_cython__, METH_NOARGS, __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_4__reduce_cython__},
+  {"__setstate_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Kernel_7__setstate_cython__, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_6Kernel_6__setstate_cython__},
   {0, 0, 0, 0}
 };
 
 static struct PyGetSetDef __pyx_getsets_6tkwant_7onebody_7kernels_Kernel[] = {
   {(char *)"size", __pyx_getprop_6tkwant_7onebody_7kernels_6Kernel_size, __pyx_setprop_6tkwant_7onebody_7kernels_6Kernel_size, (char *)"size: 'int'", 0},
   {(char *)"nevals", __pyx_getprop_6tkwant_7onebody_7kernels_6Kernel_nevals, __pyx_setprop_6tkwant_7onebody_7kernels_6Kernel_nevals, (char *)"nevals: 'int'", 0},
   {0, 0, 0, 0, 0}
@@ -32289,15 +34168,20 @@
 
 static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels_Kernel = {
   PyVarObject_HEAD_INIT(0, 0)
   "tkwant.onebody.kernels.Kernel", /*tp_name*/
   sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel), /*tp_basicsize*/
   0, /*tp_itemsize*/
   __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Kernel, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
@@ -32309,15 +34193,15 @@
   0, /*tp_hash*/
   0, /*tp_call*/
   0, /*tp_str*/
   0, /*tp_getattro*/
   0, /*tp_setattro*/
   0, /*tp_as_buffer*/
   Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE, /*tp_flags*/
-  "Kernel(H0, W, params, double complex[:] psi_st=None)\nABC for right-hand side of the time-dependent Schr\303\266dinger equation.\n\n    Attributes\n    ----------\n    size : int\n        The size of the time-independent part of the Hamiltonian. This\n        also sets the size of the solution vector.\n    nevals : int\n        The number of times this kernel has been evaluated since its creation.\n    ", /*tp_doc*/
+  "Kernel(H0, W, double complex[:] psi_st=None, double complex[:] work=None)\nABC for right-hand side of the time-dependent Schr\303\266dinger equation.\n\n    Attributes\n    ----------\n    size : int\n        The size of the time-independent part of the Hamiltonian. This\n        also sets the size of the solution vector.\n    ", /*tp_doc*/
   0, /*tp_traverse*/
   0, /*tp_clear*/
   0, /*tp_richcompare*/
   0, /*tp_weaklistoffset*/
   0, /*tp_iter*/
   0, /*tp_iternext*/
   __pyx_methods_6tkwant_7onebody_7kernels_Kernel, /*tp_methods*/
@@ -32339,131 +34223,154 @@
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
-};
-
-static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_CKernel(PyTypeObject *t, PyObject *a, PyObject *k) {
-  PyObject *o = __pyx_tp_new_6tkwant_7onebody_7kernels_Kernel(t, a, k);
-  if (unlikely(!o)) return 0;
-  return o;
-}
-
-static PyMethodDef __pyx_methods_6tkwant_7onebody_7kernels_CKernel[] = {
-  {"rhs", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_7CKernel_1rhs, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_7CKernel_rhs},
-  {"__reduce_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_7CKernel_3__reduce_cython__, METH_NOARGS, __pyx_doc_6tkwant_7onebody_7kernels_7CKernel_2__reduce_cython__},
-  {"__setstate_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_7CKernel_5__setstate_cython__, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_7CKernel_4__setstate_cython__},
-  {0, 0, 0, 0}
-};
-
-static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels_CKernel = {
-  PyVarObject_HEAD_INIT(0, 0)
-  "tkwant.onebody.kernels.CKernel", /*tp_name*/
-  sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel), /*tp_basicsize*/
-  0, /*tp_itemsize*/
-  __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Kernel, /*tp_dealloc*/
-  0, /*tp_print*/
-  0, /*tp_getattr*/
-  0, /*tp_setattr*/
-  #if PY_MAJOR_VERSION < 3
-  0, /*tp_compare*/
-  #endif
-  #if PY_MAJOR_VERSION >= 3
-  0, /*tp_as_async*/
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
   #endif
-  0, /*tp_repr*/
-  0, /*tp_as_number*/
-  0, /*tp_as_sequence*/
-  0, /*tp_as_mapping*/
-  0, /*tp_hash*/
-  0, /*tp_call*/
-  0, /*tp_str*/
-  0, /*tp_getattro*/
-  0, /*tp_setattro*/
-  0, /*tp_as_buffer*/
-  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE, /*tp_flags*/
-  "Base class for kernels that directly provide a C-level interface.\n\n    Attributes\n    ----------\n    c_self : void*\n        Pointer to a C struct that provides extra context (e.g. H0 and W)\n        to the kernel.\n    c_rhs : void (*)(const void* c_self, const complex* psi, complex* dpsidt,\n                     double time)\n        A C function that evaluates the right-hand side of the Schr\303\266dinger\n        equation, and stores the result in 'dpsidt'.\n    ", /*tp_doc*/
-  0, /*tp_traverse*/
-  0, /*tp_clear*/
-  0, /*tp_richcompare*/
-  0, /*tp_weaklistoffset*/
-  0, /*tp_iter*/
-  0, /*tp_iternext*/
-  __pyx_methods_6tkwant_7onebody_7kernels_CKernel, /*tp_methods*/
-  0, /*tp_members*/
-  0, /*tp_getset*/
-  0, /*tp_base*/
-  0, /*tp_dict*/
-  0, /*tp_descr_get*/
-  0, /*tp_descr_set*/
-  0, /*tp_dictoffset*/
-  #if CYTHON_COMPILING_IN_PYPY
-  __pyx_pw_6tkwant_7onebody_7kernels_6Kernel_1__init__, /*tp_init*/
-  #else
-  0, /*tp_init*/
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
   #endif
-  0, /*tp_alloc*/
-  __pyx_tp_new_6tkwant_7onebody_7kernels_CKernel, /*tp_new*/
-  0, /*tp_free*/
-  0, /*tp_is_gc*/
-  0, /*tp_bases*/
-  0, /*tp_mro*/
-  0, /*tp_cache*/
-  0, /*tp_subclasses*/
-  0, /*tp_weaklist*/
-  0, /*tp_del*/
-  0, /*tp_version_tag*/
-  #if PY_VERSION_HEX >= 0x030400a1
-  0, /*tp_finalize*/
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
   #endif
 };
 
-static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_PyCKernel(PyTypeObject *t, PyObject *a, PyObject *k) {
-  PyObject *o = __pyx_tp_new_6tkwant_7onebody_7kernels_CKernel(t, a, k);
+static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_Interpolation(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
+  struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *p;
+  PyObject *o;
+  if (likely((t->tp_flags & Py_TPFLAGS_IS_ABSTRACT) == 0)) {
+    o = (*t->tp_alloc)(t, 0);
+  } else {
+    o = (PyObject *) PyBaseObject_Type.tp_new(t, __pyx_empty_tuple, 0);
+  }
   if (unlikely(!o)) return 0;
-  if (unlikely(__pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_3__cinit__(o, a, k) < 0)) goto bad;
+  p = ((struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)o);
+  p->Ht0 = Py_None; Py_INCREF(Py_None);
+  p->Ht1 = Py_None; Py_INCREF(Py_None);
+  p->Ht2 = Py_None; Py_INCREF(Py_None);
+  p->Ht3 = Py_None; Py_INCREF(Py_None);
+  p->Ht4 = Py_None; Py_INCREF(Py_None);
+  p->d2Ht0 = Py_None; Py_INCREF(Py_None);
+  p->d2Ht1 = Py_None; Py_INCREF(Py_None);
+  p->d2Ht2 = Py_None; Py_INCREF(Py_None);
+  p->func = Py_None; Py_INCREF(Py_None);
   return o;
-  bad:
-  Py_DECREF(o); o = 0;
-  return NULL;
 }
 
-static void __pyx_tp_dealloc_6tkwant_7onebody_7kernels_PyCKernel(PyObject *o) {
+static void __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Interpolation(PyObject *o) {
+  struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)o;
   #if CYTHON_USE_TP_FINALIZE
-  if (unlikely(PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE) && Py_TYPE(o)->tp_finalize) && (!PyType_IS_GC(Py_TYPE(o)) || !_PyGC_FINALIZED(o))) {
+  if (unlikely(PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE) && Py_TYPE(o)->tp_finalize) && !_PyGC_FINALIZED(o)) {
     if (PyObject_CallFinalizerFromDealloc(o)) return;
   }
   #endif
-  {
-    PyObject *etype, *eval, *etb;
-    PyErr_Fetch(&etype, &eval, &etb);
-    ++Py_REFCNT(o);
-    __pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_5__dealloc__(o);
-    --Py_REFCNT(o);
-    PyErr_Restore(etype, eval, etb);
+  PyObject_GC_UnTrack(o);
+  Py_CLEAR(p->Ht0);
+  Py_CLEAR(p->Ht1);
+  Py_CLEAR(p->Ht2);
+  Py_CLEAR(p->Ht3);
+  Py_CLEAR(p->Ht4);
+  Py_CLEAR(p->d2Ht0);
+  Py_CLEAR(p->d2Ht1);
+  Py_CLEAR(p->d2Ht2);
+  Py_CLEAR(p->func);
+  (*Py_TYPE(o)->tp_free)(o);
+}
+
+static int __pyx_tp_traverse_6tkwant_7onebody_7kernels_Interpolation(PyObject *o, visitproc v, void *a) {
+  int e;
+  struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)o;
+  if (p->Ht0) {
+    e = (*v)(p->Ht0, a); if (e) return e;
   }
-  __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Kernel(o);
+  if (p->Ht1) {
+    e = (*v)(p->Ht1, a); if (e) return e;
+  }
+  if (p->Ht2) {
+    e = (*v)(p->Ht2, a); if (e) return e;
+  }
+  if (p->Ht3) {
+    e = (*v)(p->Ht3, a); if (e) return e;
+  }
+  if (p->Ht4) {
+    e = (*v)(p->Ht4, a); if (e) return e;
+  }
+  if (p->d2Ht0) {
+    e = (*v)(p->d2Ht0, a); if (e) return e;
+  }
+  if (p->d2Ht1) {
+    e = (*v)(p->d2Ht1, a); if (e) return e;
+  }
+  if (p->d2Ht2) {
+    e = (*v)(p->d2Ht2, a); if (e) return e;
+  }
+  if (p->func) {
+    e = (*v)(p->func, a); if (e) return e;
+  }
+  return 0;
+}
+
+static int __pyx_tp_clear_6tkwant_7onebody_7kernels_Interpolation(PyObject *o) {
+  PyObject* tmp;
+  struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation *)o;
+  tmp = ((PyObject*)p->Ht0);
+  p->Ht0 = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->Ht1);
+  p->Ht1 = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->Ht2);
+  p->Ht2 = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->Ht3);
+  p->Ht3 = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->Ht4);
+  p->Ht4 = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->d2Ht0);
+  p->d2Ht0 = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->d2Ht1);
+  p->d2Ht1 = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->d2Ht2);
+  p->d2Ht2 = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->func);
+  p->func = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  return 0;
 }
 
-static PyMethodDef __pyx_methods_6tkwant_7onebody_7kernels_PyCKernel[] = {
-  {"__reduce_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_7__reduce_cython__, METH_NOARGS, __pyx_doc_6tkwant_7onebody_7kernels_9PyCKernel_6__reduce_cython__},
-  {"__setstate_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_9__setstate_cython__, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_9PyCKernel_8__setstate_cython__},
+static PyMethodDef __pyx_methods_6tkwant_7onebody_7kernels_Interpolation[] = {
+  {"eval", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_3eval, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_2eval},
+  {"_estimate_error", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_5_estimate_error, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_4_estimate_error},
+  {"_estimate_stepsize", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_7_estimate_stepsize, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_6_estimate_stepsize},
+  {"__reduce_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_9__reduce_cython__, METH_NOARGS, __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_8__reduce_cython__},
+  {"__setstate_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_11__setstate_cython__, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_13Interpolation_10__setstate_cython__},
   {0, 0, 0, 0}
 };
 
-static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels_PyCKernel = {
+static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels_Interpolation = {
   PyVarObject_HEAD_INIT(0, 0)
-  "tkwant.onebody.kernels.PyCKernel", /*tp_name*/
-  sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_PyCKernel), /*tp_basicsize*/
+  "tkwant.onebody.kernels.Interpolation", /*tp_name*/
+  sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_Interpolation), /*tp_basicsize*/
   0, /*tp_itemsize*/
-  __pyx_tp_dealloc_6tkwant_7onebody_7kernels_PyCKernel, /*tp_dealloc*/
+  __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Interpolation, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
@@ -32474,45 +34381,54 @@
   0, /*tp_as_mapping*/
   0, /*tp_hash*/
   0, /*tp_call*/
   0, /*tp_str*/
   0, /*tp_getattro*/
   0, /*tp_setattro*/
   0, /*tp_as_buffer*/
-  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE, /*tp_flags*/
-  "PyCKernel(py_kernel)\nC interface to python-implemented kernels.", /*tp_doc*/
-  0, /*tp_traverse*/
-  0, /*tp_clear*/
+  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC, /*tp_flags*/
+  "Interpolation(func, t0, dt_init=0.001, atol=1E-10, rtol=1E-10, dt_min=1E-6, fac=0.9, facmin=0.1, facmax=3)", /*tp_doc*/
+  __pyx_tp_traverse_6tkwant_7onebody_7kernels_Interpolation, /*tp_traverse*/
+  __pyx_tp_clear_6tkwant_7onebody_7kernels_Interpolation, /*tp_clear*/
   0, /*tp_richcompare*/
   0, /*tp_weaklistoffset*/
   0, /*tp_iter*/
   0, /*tp_iternext*/
-  __pyx_methods_6tkwant_7onebody_7kernels_PyCKernel, /*tp_methods*/
+  __pyx_methods_6tkwant_7onebody_7kernels_Interpolation, /*tp_methods*/
   0, /*tp_members*/
   0, /*tp_getset*/
   0, /*tp_base*/
   0, /*tp_dict*/
   0, /*tp_descr_get*/
   0, /*tp_descr_set*/
   0, /*tp_dictoffset*/
-  __pyx_pw_6tkwant_7onebody_7kernels_9PyCKernel_1__init__, /*tp_init*/
+  __pyx_pw_6tkwant_7onebody_7kernels_13Interpolation_1__init__, /*tp_init*/
   0, /*tp_alloc*/
-  __pyx_tp_new_6tkwant_7onebody_7kernels_PyCKernel, /*tp_new*/
+  __pyx_tp_new_6tkwant_7onebody_7kernels_Interpolation, /*tp_new*/
   0, /*tp_free*/
   0, /*tp_is_gc*/
   0, /*tp_bases*/
   0, /*tp_mro*/
   0, /*tp_cache*/
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
+  #endif
 };
 
 static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_PerturbationExtractor(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
   struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor *p;
   PyObject *o;
   if (likely((t->tp_flags & Py_TPFLAGS_IS_ABSTRACT) == 0)) {
     o = (*t->tp_alloc)(t, 0);
@@ -32606,15 +34522,20 @@
 
 static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor = {
   PyVarObject_HEAD_INIT(0, 0)
   "tkwant.onebody.kernels.PerturbationExtractor", /*tp_name*/
   sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationExtractor), /*tp_basicsize*/
   0, /*tp_itemsize*/
   __pyx_tp_dealloc_6tkwant_7onebody_7kernels_PerturbationExtractor, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
@@ -32656,177 +34577,82 @@
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
+  #endif
 };
 
 static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_PerturbationInterpolator(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
   struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *p;
   PyObject *o;
   if (likely((t->tp_flags & Py_TPFLAGS_IS_ABSTRACT) == 0)) {
     o = (*t->tp_alloc)(t, 0);
   } else {
     o = (PyObject *) PyBaseObject_Type.tp_new(t, __pyx_empty_tuple, 0);
   }
   if (unlikely(!o)) return 0;
   p = ((struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)o);
-  p->Ht0 = Py_None; Py_INCREF(Py_None);
-  p->time_name = Py_None; Py_INCREF(Py_None);
-  p->tterms = Py_None; Py_INCREF(Py_None);
-  p->Ht1 = Py_None; Py_INCREF(Py_None);
-  p->Ht2 = Py_None; Py_INCREF(Py_None);
-  p->Ht3 = Py_None; Py_INCREF(Py_None);
-  p->Ht4 = Py_None; Py_INCREF(Py_None);
-  p->d2Ht0 = Py_None; Py_INCREF(Py_None);
-  p->d2Ht1 = Py_None; Py_INCREF(Py_None);
-  p->d2Ht2 = Py_None; Py_INCREF(Py_None);
-  p->y0 = Py_None; Py_INCREF(Py_None);
-  p->y1 = Py_None; Py_INCREF(Py_None);
-  p->d2y0 = Py_None; Py_INCREF(Py_None);
-  p->d2y1 = Py_None; Py_INCREF(Py_None);
   p->wt = Py_None; Py_INCREF(Py_None);
   p->wfunc = Py_None; Py_INCREF(Py_None);
+  p->intfunc = Py_None; Py_INCREF(Py_None);
   return o;
 }
 
 static void __pyx_tp_dealloc_6tkwant_7onebody_7kernels_PerturbationInterpolator(PyObject *o) {
   struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)o;
   #if CYTHON_USE_TP_FINALIZE
   if (unlikely(PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE) && Py_TYPE(o)->tp_finalize) && !_PyGC_FINALIZED(o)) {
     if (PyObject_CallFinalizerFromDealloc(o)) return;
   }
   #endif
   PyObject_GC_UnTrack(o);
-  Py_CLEAR(p->Ht0);
-  Py_CLEAR(p->time_name);
-  Py_CLEAR(p->tterms);
-  Py_CLEAR(p->Ht1);
-  Py_CLEAR(p->Ht2);
-  Py_CLEAR(p->Ht3);
-  Py_CLEAR(p->Ht4);
-  Py_CLEAR(p->d2Ht0);
-  Py_CLEAR(p->d2Ht1);
-  Py_CLEAR(p->d2Ht2);
-  Py_CLEAR(p->y0);
-  Py_CLEAR(p->y1);
-  Py_CLEAR(p->d2y0);
-  Py_CLEAR(p->d2y1);
   Py_CLEAR(p->wt);
   Py_CLEAR(p->wfunc);
+  Py_CLEAR(p->intfunc);
   (*Py_TYPE(o)->tp_free)(o);
 }
 
 static int __pyx_tp_traverse_6tkwant_7onebody_7kernels_PerturbationInterpolator(PyObject *o, visitproc v, void *a) {
   int e;
   struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)o;
-  if (p->Ht0) {
-    e = (*v)(p->Ht0, a); if (e) return e;
-  }
-  if (p->time_name) {
-    e = (*v)(p->time_name, a); if (e) return e;
-  }
-  if (p->tterms) {
-    e = (*v)(p->tterms, a); if (e) return e;
-  }
-  if (p->Ht1) {
-    e = (*v)(p->Ht1, a); if (e) return e;
-  }
-  if (p->Ht2) {
-    e = (*v)(p->Ht2, a); if (e) return e;
-  }
-  if (p->Ht3) {
-    e = (*v)(p->Ht3, a); if (e) return e;
-  }
-  if (p->Ht4) {
-    e = (*v)(p->Ht4, a); if (e) return e;
-  }
-  if (p->d2Ht0) {
-    e = (*v)(p->d2Ht0, a); if (e) return e;
-  }
-  if (p->d2Ht1) {
-    e = (*v)(p->d2Ht1, a); if (e) return e;
-  }
-  if (p->d2Ht2) {
-    e = (*v)(p->d2Ht2, a); if (e) return e;
-  }
-  if (p->y0) {
-    e = (*v)(p->y0, a); if (e) return e;
-  }
-  if (p->y1) {
-    e = (*v)(p->y1, a); if (e) return e;
-  }
-  if (p->d2y0) {
-    e = (*v)(p->d2y0, a); if (e) return e;
-  }
-  if (p->d2y1) {
-    e = (*v)(p->d2y1, a); if (e) return e;
-  }
   if (p->wt) {
     e = (*v)(p->wt, a); if (e) return e;
   }
   if (p->wfunc) {
     e = (*v)(p->wfunc, a); if (e) return e;
   }
+  if (p->intfunc) {
+    e = (*v)(p->intfunc, a); if (e) return e;
+  }
   return 0;
 }
 
 static int __pyx_tp_clear_6tkwant_7onebody_7kernels_PerturbationInterpolator(PyObject *o) {
   PyObject* tmp;
   struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator *)o;
-  tmp = ((PyObject*)p->Ht0);
-  p->Ht0 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->time_name);
-  p->time_name = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->tterms);
-  p->tterms = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->Ht1);
-  p->Ht1 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->Ht2);
-  p->Ht2 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->Ht3);
-  p->Ht3 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->Ht4);
-  p->Ht4 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->d2Ht0);
-  p->d2Ht0 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->d2Ht1);
-  p->d2Ht1 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->d2Ht2);
-  p->d2Ht2 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->y0);
-  p->y0 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->y1);
-  p->y1 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->d2y0);
-  p->d2y0 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->d2y1);
-  p->d2y1 = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
   tmp = ((PyObject*)p->wt);
   p->wt = Py_None; Py_INCREF(Py_None);
   Py_XDECREF(tmp);
   tmp = ((PyObject*)p->wfunc);
   p->wfunc = Py_None; Py_INCREF(Py_None);
   Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->intfunc);
+  p->intfunc = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
   return 0;
 }
 
 static PyObject *__pyx_getprop_6tkwant_7onebody_7kernels_24PerturbationInterpolator_size(PyObject *o, CYTHON_UNUSED void *x) {
   return __pyx_pw_6tkwant_7onebody_7kernels_24PerturbationInterpolator_4size_1__get__(o);
 }
 
@@ -32850,15 +34676,20 @@
 
 static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator = {
   PyVarObject_HEAD_INIT(0, 0)
   "tkwant.onebody.kernels.PerturbationInterpolator", /*tp_name*/
   sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_PerturbationInterpolator), /*tp_basicsize*/
   0, /*tp_itemsize*/
   __pyx_tp_dealloc_6tkwant_7onebody_7kernels_PerturbationInterpolator, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
@@ -32870,15 +34701,15 @@
   0, /*tp_hash*/
   0, /*tp_call*/
   0, /*tp_str*/
   0, /*tp_getattro*/
   0, /*tp_setattro*/
   0, /*tp_as_buffer*/
   Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC, /*tp_flags*/
-  "PerturbationInterpolator(syst, time_name, time_start, params=None, dt=1)\nA class to extract and interpolate W(t).\n\n    This class can be used like `tkwant.onebody.kernel.PerturbationExtractor`,\n    to calculate W(t) and the matrix-vector product W(t) * ket.\n    Interpolation is done only for performance reasons, as W(t) from\n    Kwant is slow to evaluate.\n\n    Parameters\n    ----------\n    syst : `kwant.builder.FiniteSystem`\n        The system from which to extract the time-dependent perturbation.\n    time_name : str\n        The name of the time argument. Only sites with Hamiltonian value\n        functions with the argument name `time_name` are extracted into W(t).\n    time_start : float\n        The initial time.\n    params : dict, optional\n        Extra arguments to pass to the Hamiltonian of ``syst``, excluding time.\n    dt : float\n        Discretization timestep for the Spline. Must be => 0.\n        For dt = 0, no interpolation is performed, but the result is\n        identical to `tkwant.onebody.kernel.PerturbationExtractor`.\n\n    Notes\n    -----\n    By definition the perturbation is defined with respect to the initial time.\n    The perturbation should be therefore zero for times t < `time_start`. This\n    is not inforced by this routine however, but W(t) is always evaluated\n    with the time argument it gets.\n    ", /*tp_doc*/
+  "PerturbationInterpolator(syst, time_name, time_start, params=None, interpolation_type=Interpolation)\nA class to extract and interpolate W(t).\n\n    This class can be used like `tkwant.onebody.kernel.PerturbationExtractor`,\n    to calculate W(t) and the matrix-vector product W(t) * ket.\n    Interpolation is done only for performance reasons, as W(t) from\n    Kwant is slow to evaluate.\n\n    Parameters\n    ----------\n    syst : `kwant.builder.FiniteSystem`\n        The system from which to extract the time-dependent perturbation.\n    time_name : str\n        The name of the time argument. Only sites with Hamiltonian value\n        functions with the argument name `time_name` are extracted into W(t).\n    time_start : float\n        The initial time.\n    params : dict, optional\n        Extra arguments to pass to the Hamiltonian of ``syst``, excluding time.\n    interpolation_type : optional\n        The interpolator class\n\n    Notes\n    -----\n    By definition the perturbation is defined with respect to the initial time.\n    The perturbation should be therefore zero for times t < `time_start`. This\n    is not inforced by this routine however, but W(t) is always evaluated\n    with the time argument it gets.\n    ", /*tp_doc*/
   __pyx_tp_traverse_6tkwant_7onebody_7kernels_PerturbationInterpolator, /*tp_traverse*/
   __pyx_tp_clear_6tkwant_7onebody_7kernels_PerturbationInterpolator, /*tp_clear*/
   0, /*tp_richcompare*/
   0, /*tp_weaklistoffset*/
   0, /*tp_iter*/
   0, /*tp_iternext*/
   __pyx_methods_6tkwant_7onebody_7kernels_PerturbationInterpolator, /*tp_methods*/
@@ -32900,65 +34731,122 @@
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
+  #endif
 };
 
-static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels__CSRMatrix(PyTypeObject *t, PyObject *a, PyObject *k) {
-  struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *p;
-  PyObject *o;
-  if (likely((t->tp_flags & Py_TPFLAGS_IS_ABSTRACT) == 0)) {
-    o = (*t->tp_alloc)(t, 0);
-  } else {
-    o = (PyObject *) PyBaseObject_Type.tp_new(t, __pyx_empty_tuple, 0);
-  }
+static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_Simple(PyTypeObject *t, PyObject *a, PyObject *k) {
+  struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *p;
+  PyObject *o = __pyx_tp_new_6tkwant_7onebody_7kernels_Kernel(t, a, k);
   if (unlikely(!o)) return 0;
-  p = ((struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *)o);
-  p->data.data = NULL;
-  p->data.memview = NULL;
-  p->indices.data = NULL;
-  p->indices.memview = NULL;
-  p->indptr.data = NULL;
-  p->indptr.memview = NULL;
-  if (unlikely(__pyx_pw_6tkwant_7onebody_7kernels_10_CSRMatrix_1__cinit__(o, a, k) < 0)) goto bad;
+  p = ((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)o);
+  p->H0 = Py_None; Py_INCREF(Py_None);
+  p->W = Py_None; Py_INCREF(Py_None);
+  p->_temp = Py_None; Py_INCREF(Py_None);
+  p->psi_st.data = NULL;
+  p->psi_st.memview = NULL;
+  if (unlikely(__pyx_pw_6tkwant_7onebody_7kernels_6Simple_3__cinit__(o, a, k) < 0)) goto bad;
   return o;
   bad:
   Py_DECREF(o); o = 0;
   return NULL;
 }
 
-static void __pyx_tp_dealloc_6tkwant_7onebody_7kernels__CSRMatrix(PyObject *o) {
-  struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *p = (struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *)o;
+static void __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Simple(PyObject *o) {
+  struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)o;
   #if CYTHON_USE_TP_FINALIZE
-  if (unlikely(PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE) && Py_TYPE(o)->tp_finalize) && (!PyType_IS_GC(Py_TYPE(o)) || !_PyGC_FINALIZED(o))) {
+  if (unlikely(PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE) && Py_TYPE(o)->tp_finalize) && !_PyGC_FINALIZED(o)) {
     if (PyObject_CallFinalizerFromDealloc(o)) return;
   }
   #endif
-  __PYX_XDEC_MEMVIEW(&p->data, 1);
-  __PYX_XDEC_MEMVIEW(&p->indices, 1);
-  __PYX_XDEC_MEMVIEW(&p->indptr, 1);
-  (*Py_TYPE(o)->tp_free)(o);
+  PyObject_GC_UnTrack(o);
+  Py_CLEAR(p->H0);
+  Py_CLEAR(p->W);
+  Py_CLEAR(p->_temp);
+  __PYX_XDEC_MEMVIEW(&p->psi_st, 1);
+  #if CYTHON_USE_TYPE_SLOTS
+  if (PyType_IS_GC(Py_TYPE(o)->tp_base))
+  #endif
+  PyObject_GC_Track(o);
+  __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Kernel(o);
+}
+
+static int __pyx_tp_traverse_6tkwant_7onebody_7kernels_Simple(PyObject *o, visitproc v, void *a) {
+  int e;
+  struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)o;
+  e = ((likely(__pyx_ptype_6tkwant_7onebody_7kernels_Kernel)) ? ((__pyx_ptype_6tkwant_7onebody_7kernels_Kernel->tp_traverse) ? __pyx_ptype_6tkwant_7onebody_7kernels_Kernel->tp_traverse(o, v, a) : 0) : __Pyx_call_next_tp_traverse(o, v, a, __pyx_tp_traverse_6tkwant_7onebody_7kernels_Simple)); if (e) return e;
+  if (p->H0) {
+    e = (*v)(p->H0, a); if (e) return e;
+  }
+  if (p->W) {
+    e = (*v)(p->W, a); if (e) return e;
+  }
+  if (p->_temp) {
+    e = (*v)(p->_temp, a); if (e) return e;
+  }
+  return 0;
+}
+
+static int __pyx_tp_clear_6tkwant_7onebody_7kernels_Simple(PyObject *o) {
+  PyObject* tmp;
+  struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)o;
+  if (likely(__pyx_ptype_6tkwant_7onebody_7kernels_Kernel)) { if (__pyx_ptype_6tkwant_7onebody_7kernels_Kernel->tp_clear) __pyx_ptype_6tkwant_7onebody_7kernels_Kernel->tp_clear(o); } else __Pyx_call_next_tp_clear(o, __pyx_tp_clear_6tkwant_7onebody_7kernels_Simple);
+  tmp = ((PyObject*)p->H0);
+  p->H0 = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->W);
+  p->W = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->_temp);
+  p->_temp = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  return 0;
+}
+
+static PyObject *__pyx_getprop_6tkwant_7onebody_7kernels_6Simple_W(PyObject *o, CYTHON_UNUSED void *x) {
+  return __pyx_pw_6tkwant_7onebody_7kernels_6Simple_1W_1__get__(o);
 }
 
-static PyMethodDef __pyx_methods_6tkwant_7onebody_7kernels__CSRMatrix[] = {
-  {"__reduce_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_10_CSRMatrix_3__reduce_cython__, METH_NOARGS, __pyx_doc_6tkwant_7onebody_7kernels_10_CSRMatrix_2__reduce_cython__},
-  {"__setstate_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_10_CSRMatrix_5__setstate_cython__, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_10_CSRMatrix_4__setstate_cython__},
+static PyMethodDef __pyx_methods_6tkwant_7onebody_7kernels_Simple[] = {
+  {"rhs", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7kernels_6Simple_5rhs, METH_VARARGS|METH_KEYWORDS, __pyx_doc_6tkwant_7onebody_7kernels_6Simple_4rhs},
+  {"set_W", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Simple_7set_W, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_6Simple_6set_W},
+  {"__reduce_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Simple_9__reduce_cython__, METH_NOARGS, __pyx_doc_6tkwant_7onebody_7kernels_6Simple_8__reduce_cython__},
+  {"__setstate_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Simple_11__setstate_cython__, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_6Simple_10__setstate_cython__},
   {0, 0, 0, 0}
 };
 
-static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels__CSRMatrix = {
+static struct PyGetSetDef __pyx_getsets_6tkwant_7onebody_7kernels_Simple[] = {
+  {(char *)"W", __pyx_getprop_6tkwant_7onebody_7kernels_6Simple_W, 0, (char *)"The time dependent perturbation W(t)", 0},
+  {0, 0, 0, 0, 0}
+};
+
+static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels_Simple = {
   PyVarObject_HEAD_INIT(0, 0)
-  "tkwant.onebody.kernels._CSRMatrix", /*tp_name*/
-  sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix), /*tp_basicsize*/
+  "tkwant.onebody.kernels.Simple", /*tp_name*/
+  sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple), /*tp_basicsize*/
   0, /*tp_itemsize*/
-  __pyx_tp_dealloc_6tkwant_7onebody_7kernels__CSRMatrix, /*tp_dealloc*/
+  __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Simple, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
@@ -32969,183 +34857,188 @@
   0, /*tp_as_mapping*/
   0, /*tp_hash*/
   0, /*tp_call*/
   0, /*tp_str*/
   0, /*tp_getattro*/
   0, /*tp_setattro*/
   0, /*tp_as_buffer*/
-  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE, /*tp_flags*/
-  0, /*tp_doc*/
-  0, /*tp_traverse*/
-  0, /*tp_clear*/
+  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC, /*tp_flags*/
+  "Simple(H0, W, double complex[:] psi_st=None, work=None)\nA C-implemented kernel using naive CSR matvec.", /*tp_doc*/
+  __pyx_tp_traverse_6tkwant_7onebody_7kernels_Simple, /*tp_traverse*/
+  __pyx_tp_clear_6tkwant_7onebody_7kernels_Simple, /*tp_clear*/
   0, /*tp_richcompare*/
   0, /*tp_weaklistoffset*/
   0, /*tp_iter*/
   0, /*tp_iternext*/
-  __pyx_methods_6tkwant_7onebody_7kernels__CSRMatrix, /*tp_methods*/
+  __pyx_methods_6tkwant_7onebody_7kernels_Simple, /*tp_methods*/
   0, /*tp_members*/
-  0, /*tp_getset*/
+  __pyx_getsets_6tkwant_7onebody_7kernels_Simple, /*tp_getset*/
   0, /*tp_base*/
   0, /*tp_dict*/
   0, /*tp_descr_get*/
   0, /*tp_descr_set*/
   0, /*tp_dictoffset*/
-  0, /*tp_init*/
+  __pyx_pw_6tkwant_7onebody_7kernels_6Simple_1__init__, /*tp_init*/
   0, /*tp_alloc*/
-  __pyx_tp_new_6tkwant_7onebody_7kernels__CSRMatrix, /*tp_new*/
+  __pyx_tp_new_6tkwant_7onebody_7kernels_Simple, /*tp_new*/
   0, /*tp_free*/
   0, /*tp_is_gc*/
   0, /*tp_bases*/
   0, /*tp_mro*/
   0, /*tp_cache*/
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
+  #endif
 };
-static struct __pyx_vtabstruct_6tkwant_7onebody_7kernels_Simple __pyx_vtable_6tkwant_7onebody_7kernels_Simple;
 
-static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels_Simple(PyTypeObject *t, PyObject *a, PyObject *k) {
-  struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *p;
-  PyObject *o = __pyx_tp_new_6tkwant_7onebody_7kernels_CKernel(t, a, k);
+static PyObject *__pyx_tp_new_6tkwant_7onebody_7kernels__CalcRHSc(PyTypeObject *t, PyObject *a, PyObject *k) {
+  struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *p;
+  PyObject *o;
+  if (likely((t->tp_flags & Py_TPFLAGS_IS_ABSTRACT) == 0)) {
+    o = (*t->tp_alloc)(t, 0);
+  } else {
+    o = (PyObject *) PyBaseObject_Type.tp_new(t, __pyx_empty_tuple, 0);
+  }
   if (unlikely(!o)) return 0;
-  p = ((struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)o);
-  p->__pyx_vtab = __pyx_vtabptr_6tkwant_7onebody_7kernels_Simple;
+  p = ((struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *)o);
   p->W = Py_None; Py_INCREF(Py_None);
-  p->params = Py_None; Py_INCREF(Py_None);
-  p->H0 = ((struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *)Py_None); Py_INCREF(Py_None);
-  p->_psi_st.data = NULL;
-  p->_psi_st.memview = NULL;
-  p->_temp.data = NULL;
-  p->_temp.memview = NULL;
-  if (unlikely(__pyx_pw_6tkwant_7onebody_7kernels_6Simple_5__cinit__(o, a, k) < 0)) goto bad;
+  p->_data.data = NULL;
+  p->_data.memview = NULL;
+  p->_indices.data = NULL;
+  p->_indices.memview = NULL;
+  p->_indptr.data = NULL;
+  p->_indptr.memview = NULL;
+  if (unlikely(__pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_3__cinit__(o, a, k) < 0)) goto bad;
   return o;
   bad:
   Py_DECREF(o); o = 0;
   return NULL;
 }
 
-static void __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Simple(PyObject *o) {
-  struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)o;
+static void __pyx_tp_dealloc_6tkwant_7onebody_7kernels__CalcRHSc(PyObject *o) {
+  struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *p = (struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *)o;
   #if CYTHON_USE_TP_FINALIZE
   if (unlikely(PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE) && Py_TYPE(o)->tp_finalize) && !_PyGC_FINALIZED(o)) {
     if (PyObject_CallFinalizerFromDealloc(o)) return;
   }
   #endif
   PyObject_GC_UnTrack(o);
   Py_CLEAR(p->W);
-  Py_CLEAR(p->params);
-  Py_CLEAR(p->H0);
-  __PYX_XDEC_MEMVIEW(&p->_psi_st, 1);
-  __PYX_XDEC_MEMVIEW(&p->_temp, 1);
-  #if CYTHON_USE_TYPE_SLOTS
-  if (PyType_IS_GC(Py_TYPE(o)->tp_base))
-  #endif
-  PyObject_GC_Track(o);
-  __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Kernel(o);
+  __PYX_XDEC_MEMVIEW(&p->_data, 1);
+  __PYX_XDEC_MEMVIEW(&p->_indices, 1);
+  __PYX_XDEC_MEMVIEW(&p->_indptr, 1);
+  (*Py_TYPE(o)->tp_free)(o);
 }
 
-static int __pyx_tp_traverse_6tkwant_7onebody_7kernels_Simple(PyObject *o, visitproc v, void *a) {
+static int __pyx_tp_traverse_6tkwant_7onebody_7kernels__CalcRHSc(PyObject *o, visitproc v, void *a) {
   int e;
-  struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)o;
-  e = ((likely(__pyx_ptype_6tkwant_7onebody_7kernels_CKernel)) ? ((__pyx_ptype_6tkwant_7onebody_7kernels_CKernel->tp_traverse) ? __pyx_ptype_6tkwant_7onebody_7kernels_CKernel->tp_traverse(o, v, a) : 0) : __Pyx_call_next_tp_traverse(o, v, a, __pyx_tp_traverse_6tkwant_7onebody_7kernels_Simple)); if (e) return e;
+  struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *p = (struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *)o;
   if (p->W) {
     e = (*v)(p->W, a); if (e) return e;
   }
-  if (p->params) {
-    e = (*v)(p->params, a); if (e) return e;
-  }
-  if (p->H0) {
-    e = (*v)(((PyObject *)p->H0), a); if (e) return e;
-  }
   return 0;
 }
 
-static int __pyx_tp_clear_6tkwant_7onebody_7kernels_Simple(PyObject *o) {
+static int __pyx_tp_clear_6tkwant_7onebody_7kernels__CalcRHSc(PyObject *o) {
   PyObject* tmp;
-  struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *p = (struct __pyx_obj_6tkwant_7onebody_7kernels_Simple *)o;
-  if (likely(__pyx_ptype_6tkwant_7onebody_7kernels_CKernel)) { if (__pyx_ptype_6tkwant_7onebody_7kernels_CKernel->tp_clear) __pyx_ptype_6tkwant_7onebody_7kernels_CKernel->tp_clear(o); } else __Pyx_call_next_tp_clear(o, __pyx_tp_clear_6tkwant_7onebody_7kernels_Simple);
+  struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *p = (struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc *)o;
   tmp = ((PyObject*)p->W);
   p->W = Py_None; Py_INCREF(Py_None);
   Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->params);
-  p->params = Py_None; Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
-  tmp = ((PyObject*)p->H0);
-  p->H0 = ((struct __pyx_obj_6tkwant_7onebody_7kernels__CSRMatrix *)Py_None); Py_INCREF(Py_None);
-  Py_XDECREF(tmp);
   return 0;
 }
 
-static PyMethodDef __pyx_methods_6tkwant_7onebody_7kernels_Simple[] = {
-  {"set_params", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Simple_3set_params, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_6Simple_2set_params},
-  {"__reduce_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Simple_7__reduce_cython__, METH_NOARGS, __pyx_doc_6tkwant_7onebody_7kernels_6Simple_6__reduce_cython__},
-  {"__setstate_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_6Simple_9__setstate_cython__, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_6Simple_8__setstate_cython__},
+static PyMethodDef __pyx_methods_6tkwant_7onebody_7kernels__CalcRHSc[] = {
+  {"__reduce__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_7__reduce__, METH_NOARGS, __pyx_doc_6tkwant_7onebody_7kernels_9_CalcRHSc_6__reduce__},
   {0, 0, 0, 0}
 };
 
-static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels_Simple = {
+static PyTypeObject __pyx_type_6tkwant_7onebody_7kernels__CalcRHSc = {
   PyVarObject_HEAD_INIT(0, 0)
-  "tkwant.onebody.kernels.Simple", /*tp_name*/
-  sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_Simple), /*tp_basicsize*/
+  "tkwant.onebody.kernels._CalcRHSc", /*tp_name*/
+  sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels__CalcRHSc), /*tp_basicsize*/
   0, /*tp_itemsize*/
-  __pyx_tp_dealloc_6tkwant_7onebody_7kernels_Simple, /*tp_dealloc*/
+  __pyx_tp_dealloc_6tkwant_7onebody_7kernels__CalcRHSc, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
   #endif
   0, /*tp_repr*/
   0, /*tp_as_number*/
   0, /*tp_as_sequence*/
   0, /*tp_as_mapping*/
   0, /*tp_hash*/
-  0, /*tp_call*/
+  __pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_5__call__, /*tp_call*/
   0, /*tp_str*/
   0, /*tp_getattro*/
   0, /*tp_setattro*/
   0, /*tp_as_buffer*/
   Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC, /*tp_flags*/
-  "Simple(H0, W, params, double complex[:] psi_st=None)\nA C-implemented kernel using naive CSR matvec.", /*tp_doc*/
-  __pyx_tp_traverse_6tkwant_7onebody_7kernels_Simple, /*tp_traverse*/
-  __pyx_tp_clear_6tkwant_7onebody_7kernels_Simple, /*tp_clear*/
+  "_CalcRHSc(int[:] indptr, int[:] indices, double complex[:] data, W, double complex[:] psi_st, int size, int center_size, double complex[:] temp)", /*tp_doc*/
+  __pyx_tp_traverse_6tkwant_7onebody_7kernels__CalcRHSc, /*tp_traverse*/
+  __pyx_tp_clear_6tkwant_7onebody_7kernels__CalcRHSc, /*tp_clear*/
   0, /*tp_richcompare*/
   0, /*tp_weaklistoffset*/
   0, /*tp_iter*/
   0, /*tp_iternext*/
-  __pyx_methods_6tkwant_7onebody_7kernels_Simple, /*tp_methods*/
+  __pyx_methods_6tkwant_7onebody_7kernels__CalcRHSc, /*tp_methods*/
   0, /*tp_members*/
   0, /*tp_getset*/
   0, /*tp_base*/
   0, /*tp_dict*/
   0, /*tp_descr_get*/
   0, /*tp_descr_set*/
   0, /*tp_dictoffset*/
-  __pyx_pw_6tkwant_7onebody_7kernels_6Simple_1__init__, /*tp_init*/
+  __pyx_pw_6tkwant_7onebody_7kernels_9_CalcRHSc_1__init__, /*tp_init*/
   0, /*tp_alloc*/
-  __pyx_tp_new_6tkwant_7onebody_7kernels_Simple, /*tp_new*/
+  __pyx_tp_new_6tkwant_7onebody_7kernels__CalcRHSc, /*tp_new*/
   0, /*tp_free*/
   0, /*tp_is_gc*/
   0, /*tp_bases*/
   0, /*tp_mro*/
   0, /*tp_cache*/
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
+  #endif
 };
 static struct __pyx_vtabstruct_array __pyx_vtable_array;
 
 static PyObject *__pyx_tp_new_array(PyTypeObject *t, PyObject *a, PyObject *k) {
   struct __pyx_array_obj *p;
   PyObject *o;
   if (likely((t->tp_flags & Py_TPFLAGS_IS_ABSTRACT) == 0)) {
@@ -33171,17 +35064,17 @@
   if (unlikely(PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE) && Py_TYPE(o)->tp_finalize) && (!PyType_IS_GC(Py_TYPE(o)) || !_PyGC_FINALIZED(o))) {
     if (PyObject_CallFinalizerFromDealloc(o)) return;
   }
   #endif
   {
     PyObject *etype, *eval, *etb;
     PyErr_Fetch(&etype, &eval, &etb);
-    ++Py_REFCNT(o);
+    __Pyx_SET_REFCNT(o, Py_REFCNT(o) + 1);
     __pyx_array___dealloc__(o);
-    --Py_REFCNT(o);
+    __Pyx_SET_REFCNT(o, Py_REFCNT(o) - 1);
     PyErr_Restore(etype, eval, etb);
   }
   Py_CLEAR(p->mode);
   Py_CLEAR(p->_format);
   (*Py_TYPE(o)->tp_free)(o);
 }
 static PyObject *__pyx_sq_item_array(PyObject *o, Py_ssize_t i) {
@@ -33266,15 +35159,20 @@
 
 static PyTypeObject __pyx_type___pyx_array = {
   PyVarObject_HEAD_INIT(0, 0)
   "tkwant.onebody.kernels.array", /*tp_name*/
   sizeof(struct __pyx_array_obj), /*tp_basicsize*/
   0, /*tp_itemsize*/
   __pyx_tp_dealloc_array, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
@@ -33316,14 +35214,23 @@
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
+  #endif
 };
 
 static PyObject *__pyx_tp_new_Enum(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
   struct __pyx_MemviewEnum_obj *p;
   PyObject *o;
   if (likely((t->tp_flags & Py_TPFLAGS_IS_ABSTRACT) == 0)) {
     o = (*t->tp_alloc)(t, 0);
@@ -33374,15 +35281,20 @@
 
 static PyTypeObject __pyx_type___pyx_MemviewEnum = {
   PyVarObject_HEAD_INIT(0, 0)
   "tkwant.onebody.kernels.Enum", /*tp_name*/
   sizeof(struct __pyx_MemviewEnum_obj), /*tp_basicsize*/
   0, /*tp_itemsize*/
   __pyx_tp_dealloc_Enum, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
@@ -33424,14 +35336,23 @@
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
+  #endif
 };
 static struct __pyx_vtabstruct_memoryview __pyx_vtable_memoryview;
 
 static PyObject *__pyx_tp_new_memoryview(PyTypeObject *t, PyObject *a, PyObject *k) {
   struct __pyx_memoryview_obj *p;
   PyObject *o;
   if (likely((t->tp_flags & Py_TPFLAGS_IS_ABSTRACT) == 0)) {
@@ -33460,17 +35381,17 @@
     if (PyObject_CallFinalizerFromDealloc(o)) return;
   }
   #endif
   PyObject_GC_UnTrack(o);
   {
     PyObject *etype, *eval, *etb;
     PyErr_Fetch(&etype, &eval, &etb);
-    ++Py_REFCNT(o);
+    __Pyx_SET_REFCNT(o, Py_REFCNT(o) + 1);
     __pyx_memoryview___dealloc__(o);
-    --Py_REFCNT(o);
+    __Pyx_SET_REFCNT(o, Py_REFCNT(o) - 1);
     PyErr_Restore(etype, eval, etb);
   }
   Py_CLEAR(p->obj);
   Py_CLEAR(p->_size);
   Py_CLEAR(p->_array_interface);
   (*Py_TYPE(o)->tp_free)(o);
 }
@@ -33624,15 +35545,20 @@
 
 static PyTypeObject __pyx_type___pyx_memoryview = {
   PyVarObject_HEAD_INIT(0, 0)
   "tkwant.onebody.kernels.memoryview", /*tp_name*/
   sizeof(struct __pyx_memoryview_obj), /*tp_basicsize*/
   0, /*tp_itemsize*/
   __pyx_tp_dealloc_memoryview, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
@@ -33674,14 +35600,23 @@
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
+  #endif
 };
 static struct __pyx_vtabstruct__memoryviewslice __pyx_vtable__memoryviewslice;
 
 static PyObject *__pyx_tp_new__memoryviewslice(PyTypeObject *t, PyObject *a, PyObject *k) {
   struct __pyx_memoryviewslice_obj *p;
   PyObject *o = __pyx_tp_new_memoryview(t, a, k);
   if (unlikely(!o)) return 0;
@@ -33699,17 +35634,17 @@
     if (PyObject_CallFinalizerFromDealloc(o)) return;
   }
   #endif
   PyObject_GC_UnTrack(o);
   {
     PyObject *etype, *eval, *etb;
     PyErr_Fetch(&etype, &eval, &etb);
-    ++Py_REFCNT(o);
+    __Pyx_SET_REFCNT(o, Py_REFCNT(o) + 1);
     __pyx_memoryviewslice___dealloc__(o);
-    --Py_REFCNT(o);
+    __Pyx_SET_REFCNT(o, Py_REFCNT(o) - 1);
     PyErr_Restore(etype, eval, etb);
   }
   Py_CLEAR(p->from_object);
   PyObject_GC_Track(o);
   __pyx_tp_dealloc_memoryview(o);
 }
 
@@ -33751,15 +35686,20 @@
 
 static PyTypeObject __pyx_type___pyx_memoryviewslice = {
   PyVarObject_HEAD_INIT(0, 0)
   "tkwant.onebody.kernels._memoryviewslice", /*tp_name*/
   sizeof(struct __pyx_memoryviewslice_obj), /*tp_basicsize*/
   0, /*tp_itemsize*/
   __pyx_tp_dealloc__memoryviewslice, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
   0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
   0, /*tp_getattr*/
   0, /*tp_setattr*/
   #if PY_MAJOR_VERSION < 3
   0, /*tp_compare*/
   #endif
   #if PY_MAJOR_VERSION >= 3
   0, /*tp_as_async*/
@@ -33809,18 +35749,26 @@
   0, /*tp_subclasses*/
   0, /*tp_weaklist*/
   0, /*tp_del*/
   0, /*tp_version_tag*/
   #if PY_VERSION_HEX >= 0x030400a1
   0, /*tp_finalize*/
   #endif
+  #if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+  #if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+  0, /*tp_pypy_flags*/
+  #endif
 };
 
 static PyMethodDef __pyx_methods[] = {
-  {"extract_c_kernel", (PyCFunction)__pyx_pw_6tkwant_7onebody_7kernels_1extract_c_kernel, METH_O, __pyx_doc_6tkwant_7onebody_7kernels_extract_c_kernel},
   {0, 0, 0, 0}
 };
 
 #if PY_MAJOR_VERSION >= 3
 #if CYTHON_PEP489_MULTI_PHASE_INIT
 static PyObject* __pyx_pymod_create(PyObject *spec, PyModuleDef *def); /*proto*/
 static int __pyx_pymod_exec_kernels(PyObject* module); /*proto*/
@@ -33861,147 +35809,161 @@
 #endif
 #endif
 
 static __Pyx_StringTabEntry __pyx_string_tab[] = {
   {&__pyx_kp_u_0_vector_has_length_1_but_the_s, __pyx_k_0_vector_has_length_1_but_the_s, sizeof(__pyx_k_0_vector_has_length_1_but_the_s), 0, 1, 0, 0},
   {&__pyx_n_s_ASCII, __pyx_k_ASCII, sizeof(__pyx_k_ASCII), 0, 0, 1, 1},
   {&__pyx_kp_s_Buffer_view_does_not_expose_stri, __pyx_k_Buffer_view_does_not_expose_stri, sizeof(__pyx_k_Buffer_view_does_not_expose_stri), 0, 0, 1, 0},
-  {&__pyx_n_s_CKernel, __pyx_k_CKernel, sizeof(__pyx_k_CKernel), 0, 0, 1, 1},
-  {&__pyx_n_u_CKernel, __pyx_k_CKernel, sizeof(__pyx_k_CKernel), 0, 1, 0, 1},
-  {&__pyx_n_s_CSRMatrix, __pyx_k_CSRMatrix, sizeof(__pyx_k_CSRMatrix), 0, 0, 1, 1},
+  {&__pyx_n_s_CalcRHS, __pyx_k_CalcRHS, sizeof(__pyx_k_CalcRHS), 0, 0, 1, 1},
+  {&__pyx_n_s_CalcRHS___call, __pyx_k_CalcRHS___call, sizeof(__pyx_k_CalcRHS___call), 0, 0, 1, 1},
+  {&__pyx_n_s_CalcRHS___init, __pyx_k_CalcRHS___init, sizeof(__pyx_k_CalcRHS___init), 0, 0, 1, 1},
+  {&__pyx_n_s_CalcRHSc, __pyx_k_CalcRHSc, sizeof(__pyx_k_CalcRHSc), 0, 0, 1, 1},
+  {&__pyx_kp_s_Calculate_the_right_hand_side_of, __pyx_k_Calculate_the_right_hand_side_of, sizeof(__pyx_k_Calculate_the_right_hand_side_of), 0, 0, 1, 0},
   {&__pyx_kp_s_Can_only_create_a_buffer_that_is, __pyx_k_Can_only_create_a_buffer_that_is, sizeof(__pyx_k_Can_only_create_a_buffer_that_is), 0, 0, 1, 0},
   {&__pyx_kp_s_Cannot_assign_to_read_only_memor, __pyx_k_Cannot_assign_to_read_only_memor, sizeof(__pyx_k_Cannot_assign_to_read_only_memor), 0, 0, 1, 0},
   {&__pyx_kp_s_Cannot_create_writable_memory_vi, __pyx_k_Cannot_create_writable_memory_vi, sizeof(__pyx_k_Cannot_create_writable_memory_vi), 0, 0, 1, 0},
   {&__pyx_kp_s_Cannot_index_with_type_s, __pyx_k_Cannot_index_with_type_s, sizeof(__pyx_k_Cannot_index_with_type_s), 0, 0, 1, 0},
   {&__pyx_n_s_Ellipsis, __pyx_k_Ellipsis, sizeof(__pyx_k_Ellipsis), 0, 0, 1, 1},
   {&__pyx_kp_s_Empty_shape_tuple_for_cython_arr, __pyx_k_Empty_shape_tuple_for_cython_arr, sizeof(__pyx_k_Empty_shape_tuple_for_cython_arr), 0, 0, 1, 0},
   {&__pyx_kp_s_Evaluate_the_RHS_of_the_Schrding, __pyx_k_Evaluate_the_RHS_of_the_Schrding, sizeof(__pyx_k_Evaluate_the_RHS_of_the_Schrding), 0, 0, 1, 0},
   {&__pyx_n_s_H0, __pyx_k_H0, sizeof(__pyx_k_H0), 0, 0, 1, 1},
-  {&__pyx_n_s_ImportError, __pyx_k_ImportError, sizeof(__pyx_k_ImportError), 0, 0, 1, 1},
-  {&__pyx_kp_s_Incompatible_checksums_s_vs_0x1a, __pyx_k_Incompatible_checksums_s_vs_0x1a, sizeof(__pyx_k_Incompatible_checksums_s_vs_0x1a), 0, 0, 1, 0},
-  {&__pyx_kp_s_Incompatible_checksums_s_vs_0x26, __pyx_k_Incompatible_checksums_s_vs_0x26, sizeof(__pyx_k_Incompatible_checksums_s_vs_0x26), 0, 0, 1, 0},
-  {&__pyx_kp_s_Incompatible_checksums_s_vs_0x4d, __pyx_k_Incompatible_checksums_s_vs_0x4d, sizeof(__pyx_k_Incompatible_checksums_s_vs_0x4d), 0, 0, 1, 0},
-  {&__pyx_kp_s_Incompatible_checksums_s_vs_0xb0, __pyx_k_Incompatible_checksums_s_vs_0xb0, sizeof(__pyx_k_Incompatible_checksums_s_vs_0xb0), 0, 0, 1, 0},
+  {&__pyx_kp_s_Incompatible_checksums_0x_x_vs_0, __pyx_k_Incompatible_checksums_0x_x_vs_0, sizeof(__pyx_k_Incompatible_checksums_0x_x_vs_0), 0, 0, 1, 0},
+  {&__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_2, __pyx_k_Incompatible_checksums_0x_x_vs_0_2, sizeof(__pyx_k_Incompatible_checksums_0x_x_vs_0_2), 0, 0, 1, 0},
+  {&__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_3, __pyx_k_Incompatible_checksums_0x_x_vs_0_3, sizeof(__pyx_k_Incompatible_checksums_0x_x_vs_0_3), 0, 0, 1, 0},
+  {&__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_4, __pyx_k_Incompatible_checksums_0x_x_vs_0_4, sizeof(__pyx_k_Incompatible_checksums_0x_x_vs_0_4), 0, 0, 1, 0},
+  {&__pyx_kp_s_Incompatible_checksums_0x_x_vs_0_5, __pyx_k_Incompatible_checksums_0x_x_vs_0_5, sizeof(__pyx_k_Incompatible_checksums_0x_x_vs_0_5), 0, 0, 1, 0},
   {&__pyx_n_s_IndexError, __pyx_k_IndexError, sizeof(__pyx_k_IndexError), 0, 0, 1, 1},
   {&__pyx_kp_s_Indirect_dimensions_not_supporte, __pyx_k_Indirect_dimensions_not_supporte, sizeof(__pyx_k_Indirect_dimensions_not_supporte), 0, 0, 1, 0},
+  {&__pyx_n_s_Interpolation, __pyx_k_Interpolation, sizeof(__pyx_k_Interpolation), 0, 0, 1, 1},
   {&__pyx_kp_s_Invalid_mode_expected_c_or_fortr, __pyx_k_Invalid_mode_expected_c_or_fortr, sizeof(__pyx_k_Invalid_mode_expected_c_or_fortr), 0, 0, 1, 0},
   {&__pyx_kp_s_Invalid_shape_in_axis_d_d, __pyx_k_Invalid_shape_in_axis_d_d, sizeof(__pyx_k_Invalid_shape_in_axis_d_d), 0, 0, 1, 0},
   {&__pyx_n_s_Kernel, __pyx_k_Kernel, sizeof(__pyx_k_Kernel), 0, 0, 1, 1},
   {&__pyx_n_u_Kernel, __pyx_k_Kernel, sizeof(__pyx_k_Kernel), 0, 1, 0, 1},
-  {&__pyx_kp_u_Kernel_must_have_a_rhs_method, __pyx_k_Kernel_must_have_a_rhs_method, sizeof(__pyx_k_Kernel_must_have_a_rhs_method), 0, 1, 0, 0},
   {&__pyx_n_u_Ket, __pyx_k_Ket, sizeof(__pyx_k_Ket), 0, 1, 0, 1},
   {&__pyx_n_s_MemoryError, __pyx_k_MemoryError, sizeof(__pyx_k_MemoryError), 0, 0, 1, 1},
   {&__pyx_kp_s_MemoryView_of_r_at_0x_x, __pyx_k_MemoryView_of_r_at_0x_x, sizeof(__pyx_k_MemoryView_of_r_at_0x_x), 0, 0, 1, 0},
   {&__pyx_kp_s_MemoryView_of_r_object, __pyx_k_MemoryView_of_r_object, sizeof(__pyx_k_MemoryView_of_r_object), 0, 0, 1, 0},
   {&__pyx_n_s_NotImplementedError, __pyx_k_NotImplementedError, sizeof(__pyx_k_NotImplementedError), 0, 0, 1, 1},
   {&__pyx_n_b_O, __pyx_k_O, sizeof(__pyx_k_O), 0, 0, 0, 1},
   {&__pyx_kp_s_Out_of_bounds_on_buffer_access_a, __pyx_k_Out_of_bounds_on_buffer_access_a, sizeof(__pyx_k_Out_of_bounds_on_buffer_access_a), 0, 0, 1, 0},
   {&__pyx_n_s_PerturbationExtractor, __pyx_k_PerturbationExtractor, sizeof(__pyx_k_PerturbationExtractor), 0, 0, 1, 1},
   {&__pyx_n_u_PerturbationExtractor, __pyx_k_PerturbationExtractor, sizeof(__pyx_k_PerturbationExtractor), 0, 1, 0, 1},
   {&__pyx_n_s_PerturbationInterpolator, __pyx_k_PerturbationInterpolator, sizeof(__pyx_k_PerturbationInterpolator), 0, 0, 1, 1},
   {&__pyx_n_u_PerturbationInterpolator, __pyx_k_PerturbationInterpolator, sizeof(__pyx_k_PerturbationInterpolator), 0, 1, 0, 1},
   {&__pyx_n_s_PickleError, __pyx_k_PickleError, sizeof(__pyx_k_PickleError), 0, 0, 1, 1},
-  {&__pyx_n_s_PyCKernel, __pyx_k_PyCKernel, sizeof(__pyx_k_PyCKernel), 0, 0, 1, 1},
   {&__pyx_n_s_Scipy, __pyx_k_Scipy, sizeof(__pyx_k_Scipy), 0, 0, 1, 1},
   {&__pyx_n_u_Scipy, __pyx_k_Scipy, sizeof(__pyx_k_Scipy), 0, 1, 0, 1},
   {&__pyx_n_s_Scipy___init, __pyx_k_Scipy___init, sizeof(__pyx_k_Scipy___init), 0, 0, 1, 1},
   {&__pyx_n_s_Scipy_rhs, __pyx_k_Scipy_rhs, sizeof(__pyx_k_Scipy_rhs), 0, 0, 1, 1},
-  {&__pyx_n_s_Scipy_set_params, __pyx_k_Scipy_set_params, sizeof(__pyx_k_Scipy_set_params), 0, 0, 1, 1},
+  {&__pyx_n_s_Scipy_set_W, __pyx_k_Scipy_set_W, sizeof(__pyx_k_Scipy_set_W), 0, 0, 1, 1},
   {&__pyx_n_s_Simple, __pyx_k_Simple, sizeof(__pyx_k_Simple), 0, 0, 1, 1},
   {&__pyx_n_u_Simple, __pyx_k_Simple, sizeof(__pyx_k_Simple), 0, 1, 0, 1},
-  {&__pyx_n_s_SparseBlas, __pyx_k_SparseBlas, sizeof(__pyx_k_SparseBlas), 0, 0, 1, 1},
-  {&__pyx_n_u_SparseBlas, __pyx_k_SparseBlas, sizeof(__pyx_k_SparseBlas), 0, 1, 0, 1},
   {&__pyx_kp_b_T, __pyx_k_T, sizeof(__pyx_k_T), 0, 0, 0, 0},
   {&__pyx_n_s_TypeError, __pyx_k_TypeError, sizeof(__pyx_k_TypeError), 0, 0, 1, 1},
   {&__pyx_kp_s_Unable_to_convert_item_to_object, __pyx_k_Unable_to_convert_item_to_object, sizeof(__pyx_k_Unable_to_convert_item_to_object), 0, 0, 1, 0},
   {&__pyx_n_s_ValueError, __pyx_k_ValueError, sizeof(__pyx_k_ValueError), 0, 0, 1, 1},
   {&__pyx_n_s_View_MemoryView, __pyx_k_View_MemoryView, sizeof(__pyx_k_View_MemoryView), 0, 0, 1, 1},
   {&__pyx_n_s_W, __pyx_k_W, sizeof(__pyx_k_W), 0, 0, 1, 1},
-  {&__pyx_kp_b__31, __pyx_k__31, sizeof(__pyx_k__31), 0, 0, 0, 0},
-  {&__pyx_n_s__32, __pyx_k__32, sizeof(__pyx_k__32), 0, 0, 1, 1},
   {&__pyx_kp_b__32, __pyx_k__32, sizeof(__pyx_k__32), 0, 0, 0, 0},
+  {&__pyx_n_s__33, __pyx_k__33, sizeof(__pyx_k__33), 0, 0, 1, 1},
   {&__pyx_kp_b__33, __pyx_k__33, sizeof(__pyx_k__33), 0, 0, 0, 0},
   {&__pyx_kp_b__34, __pyx_k__34, sizeof(__pyx_k__34), 0, 0, 0, 0},
-  {&__pyx_kp_u__35, __pyx_k__35, sizeof(__pyx_k__35), 0, 1, 0, 0},
-  {&__pyx_n_s__36, __pyx_k__36, sizeof(__pyx_k__36), 0, 0, 1, 1},
+  {&__pyx_kp_b__35, __pyx_k__35, sizeof(__pyx_k__35), 0, 0, 0, 0},
+  {&__pyx_kp_u__36, __pyx_k__36, sizeof(__pyx_k__36), 0, 1, 0, 0},
+  {&__pyx_n_s__37, __pyx_k__37, sizeof(__pyx_k__37), 0, 0, 1, 1},
+  {&__pyx_n_s_abs, __pyx_k_abs, sizeof(__pyx_k_abs), 0, 0, 1, 1},
   {&__pyx_n_s_add_time_to_params, __pyx_k_add_time_to_params, sizeof(__pyx_k_add_time_to_params), 0, 0, 1, 1},
   {&__pyx_n_s_all, __pyx_k_all, sizeof(__pyx_k_all), 0, 0, 1, 1},
   {&__pyx_n_s_allocate_buffer, __pyx_k_allocate_buffer, sizeof(__pyx_k_allocate_buffer), 0, 0, 1, 1},
-  {&__pyx_n_s_append, __pyx_k_append, sizeof(__pyx_k_append), 0, 0, 1, 1},
   {&__pyx_n_s_apply, __pyx_k_apply, sizeof(__pyx_k_apply), 0, 0, 1, 1},
   {&__pyx_n_s_asarray, __pyx_k_asarray, sizeof(__pyx_k_asarray), 0, 0, 1, 1},
+  {&__pyx_n_s_atol, __pyx_k_atol, sizeof(__pyx_k_atol), 0, 0, 1, 1},
   {&__pyx_n_s_base, __pyx_k_base, sizeof(__pyx_k_base), 0, 0, 1, 1},
   {&__pyx_n_s_c, __pyx_k_c, sizeof(__pyx_k_c), 0, 0, 1, 1},
   {&__pyx_n_u_c, __pyx_k_c, sizeof(__pyx_k_c), 0, 1, 0, 1},
+  {&__pyx_n_s_call, __pyx_k_call, sizeof(__pyx_k_call), 0, 0, 1, 1},
   {&__pyx_n_s_center_size, __pyx_k_center_size, sizeof(__pyx_k_center_size), 0, 0, 1, 1},
   {&__pyx_n_s_class, __pyx_k_class, sizeof(__pyx_k_class), 0, 0, 1, 1},
   {&__pyx_n_s_cline_in_traceback, __pyx_k_cline_in_traceback, sizeof(__pyx_k_cline_in_traceback), 0, 0, 1, 1},
   {&__pyx_n_s_col, __pyx_k_col, sizeof(__pyx_k_col), 0, 0, 1, 1},
   {&__pyx_n_s_common, __pyx_k_common, sizeof(__pyx_k_common), 0, 0, 1, 1},
-  {&__pyx_n_s_complex, __pyx_k_complex, sizeof(__pyx_k_complex), 0, 0, 1, 1},
   {&__pyx_n_s_conjugate, __pyx_k_conjugate, sizeof(__pyx_k_conjugate), 0, 0, 1, 1},
   {&__pyx_n_u_conjugate, __pyx_k_conjugate, sizeof(__pyx_k_conjugate), 0, 1, 0, 1},
   {&__pyx_kp_s_contiguous_and_direct, __pyx_k_contiguous_and_direct, sizeof(__pyx_k_contiguous_and_direct), 0, 0, 1, 0},
   {&__pyx_kp_s_contiguous_and_indirect, __pyx_k_contiguous_and_indirect, sizeof(__pyx_k_contiguous_and_indirect), 0, 0, 1, 0},
   {&__pyx_n_s_coo_matrix, __pyx_k_coo_matrix, sizeof(__pyx_k_coo_matrix), 0, 0, 1, 1},
   {&__pyx_n_s_coo_matvec, __pyx_k_coo_matvec, sizeof(__pyx_k_coo_matvec), 0, 0, 1, 1},
+  {&__pyx_n_s_csr, __pyx_k_csr, sizeof(__pyx_k_csr), 0, 0, 1, 1},
+  {&__pyx_n_s_csr_matrix, __pyx_k_csr_matrix, sizeof(__pyx_k_csr_matrix), 0, 0, 1, 1},
   {&__pyx_n_s_csr_matvec, __pyx_k_csr_matvec, sizeof(__pyx_k_csr_matvec), 0, 0, 1, 1},
   {&__pyx_n_s_data, __pyx_k_data, sizeof(__pyx_k_data), 0, 0, 1, 1},
   {&__pyx_n_s_default, __pyx_k_default, sizeof(__pyx_k_default), 0, 0, 1, 1},
   {&__pyx_n_u_default, __pyx_k_default, sizeof(__pyx_k_default), 0, 1, 0, 1},
   {&__pyx_n_s_dict, __pyx_k_dict, sizeof(__pyx_k_dict), 0, 0, 1, 1},
   {&__pyx_n_s_doc, __pyx_k_doc, sizeof(__pyx_k_doc), 0, 0, 1, 1},
   {&__pyx_n_s_dot, __pyx_k_dot, sizeof(__pyx_k_dot), 0, 0, 1, 1},
   {&__pyx_n_s_dpsidt, __pyx_k_dpsidt, sizeof(__pyx_k_dpsidt), 0, 0, 1, 1},
   {&__pyx_n_s_dt, __pyx_k_dt, sizeof(__pyx_k_dt), 0, 0, 1, 1},
+  {&__pyx_n_s_dt_init, __pyx_k_dt_init, sizeof(__pyx_k_dt_init), 0, 0, 1, 1},
+  {&__pyx_n_s_dt_min, __pyx_k_dt_min, sizeof(__pyx_k_dt_min), 0, 0, 1, 1},
   {&__pyx_n_s_dtype, __pyx_k_dtype, sizeof(__pyx_k_dtype), 0, 0, 1, 1},
   {&__pyx_n_s_dtype_is_object, __pyx_k_dtype_is_object, sizeof(__pyx_k_dtype_is_object), 0, 0, 1, 1},
-  {&__pyx_n_s_e, __pyx_k_e, sizeof(__pyx_k_e), 0, 0, 1, 1},
   {&__pyx_n_s_empty, __pyx_k_empty, sizeof(__pyx_k_empty), 0, 0, 1, 1},
   {&__pyx_n_s_encode, __pyx_k_encode, sizeof(__pyx_k_encode), 0, 0, 1, 1},
+  {&__pyx_n_s_energy, __pyx_k_energy, sizeof(__pyx_k_energy), 0, 0, 1, 1},
   {&__pyx_n_s_enumerate, __pyx_k_enumerate, sizeof(__pyx_k_enumerate), 0, 0, 1, 1},
   {&__pyx_n_s_error, __pyx_k_error, sizeof(__pyx_k_error), 0, 0, 1, 1},
   {&__pyx_n_s_errormsg, __pyx_k_errormsg, sizeof(__pyx_k_errormsg), 0, 0, 1, 1},
+  {&__pyx_n_s_estimate_error, __pyx_k_estimate_error, sizeof(__pyx_k_estimate_error), 0, 0, 1, 1},
+  {&__pyx_n_s_estimate_stepsize, __pyx_k_estimate_stepsize, sizeof(__pyx_k_estimate_stepsize), 0, 0, 1, 1},
+  {&__pyx_n_s_eval, __pyx_k_eval, sizeof(__pyx_k_eval), 0, 0, 1, 1},
   {&__pyx_n_s_evaluate, __pyx_k_evaluate, sizeof(__pyx_k_evaluate), 0, 0, 1, 1},
   {&__pyx_n_s_exept, __pyx_k_exept, sizeof(__pyx_k_exept), 0, 0, 1, 1},
-  {&__pyx_n_u_extract_c_kernel, __pyx_k_extract_c_kernel, sizeof(__pyx_k_extract_c_kernel), 0, 1, 0, 1},
+  {&__pyx_n_s_eye, __pyx_k_eye, sizeof(__pyx_k_eye), 0, 0, 1, 1},
+  {&__pyx_n_s_fac, __pyx_k_fac, sizeof(__pyx_k_fac), 0, 0, 1, 1},
+  {&__pyx_n_s_facmax, __pyx_k_facmax, sizeof(__pyx_k_facmax), 0, 0, 1, 1},
+  {&__pyx_n_s_facmin, __pyx_k_facmin, sizeof(__pyx_k_facmin), 0, 0, 1, 1},
   {&__pyx_n_s_flags, __pyx_k_flags, sizeof(__pyx_k_flags), 0, 0, 1, 1},
   {&__pyx_n_s_flatten, __pyx_k_flatten, sizeof(__pyx_k_flatten), 0, 0, 1, 1},
   {&__pyx_n_s_format, __pyx_k_format, sizeof(__pyx_k_format), 0, 0, 1, 1},
   {&__pyx_n_s_fortran, __pyx_k_fortran, sizeof(__pyx_k_fortran), 0, 0, 1, 1},
   {&__pyx_n_u_fortran, __pyx_k_fortran, sizeof(__pyx_k_fortran), 0, 1, 0, 1},
+  {&__pyx_n_s_func, __pyx_k_func, sizeof(__pyx_k_func), 0, 0, 1, 1},
   {&__pyx_n_s_getstate, __pyx_k_getstate, sizeof(__pyx_k_getstate), 0, 0, 1, 1},
   {&__pyx_kp_s_got_differing_extents_in_dimensi, __pyx_k_got_differing_extents_in_dimensi, sizeof(__pyx_k_got_differing_extents_in_dimensi), 0, 0, 1, 0},
   {&__pyx_n_s_graph, __pyx_k_graph, sizeof(__pyx_k_graph), 0, 0, 1, 1},
   {&__pyx_n_s_hamiltonian, __pyx_k_hamiltonian, sizeof(__pyx_k_hamiltonian), 0, 0, 1, 1},
   {&__pyx_n_s_herm_conj, __pyx_k_herm_conj, sizeof(__pyx_k_herm_conj), 0, 0, 1, 1},
   {&__pyx_n_s_hoppings, __pyx_k_hoppings, sizeof(__pyx_k_hoppings), 0, 0, 1, 1},
   {&__pyx_n_s_i, __pyx_k_i, sizeof(__pyx_k_i), 0, 0, 1, 1},
   {&__pyx_n_s_id, __pyx_k_id, sizeof(__pyx_k_id), 0, 0, 1, 1},
   {&__pyx_n_s_import, __pyx_k_import, sizeof(__pyx_k_import), 0, 0, 1, 1},
   {&__pyx_n_s_indices, __pyx_k_indices, sizeof(__pyx_k_indices), 0, 0, 1, 1},
   {&__pyx_n_s_indptr, __pyx_k_indptr, sizeof(__pyx_k_indptr), 0, 0, 1, 1},
   {&__pyx_n_s_init, __pyx_k_init, sizeof(__pyx_k_init), 0, 0, 1, 1},
   {&__pyx_n_s_int32, __pyx_k_int32, sizeof(__pyx_k_int32), 0, 0, 1, 1},
+  {&__pyx_n_s_interpolation_type, __pyx_k_interpolation_type, sizeof(__pyx_k_interpolation_type), 0, 0, 1, 1},
   {&__pyx_n_s_is_time_dependent_function, __pyx_k_is_time_dependent_function, sizeof(__pyx_k_is_time_dependent_function), 0, 0, 1, 1},
-  {&__pyx_n_s_isclose, __pyx_k_isclose, sizeof(__pyx_k_isclose), 0, 0, 1, 1},
   {&__pyx_n_s_itemsize, __pyx_k_itemsize, sizeof(__pyx_k_itemsize), 0, 0, 1, 1},
   {&__pyx_kp_s_itemsize_0_for_cython_array, __pyx_k_itemsize_0_for_cython_array, sizeof(__pyx_k_itemsize_0_for_cython_array), 0, 0, 1, 0},
   {&__pyx_n_s_join, __pyx_k_join, sizeof(__pyx_k_join), 0, 0, 1, 1},
   {&__pyx_n_s_ket, __pyx_k_ket, sizeof(__pyx_k_ket), 0, 0, 1, 1},
+  {&__pyx_n_s_logger, __pyx_k_logger, sizeof(__pyx_k_logger), 0, 0, 1, 1},
+  {&__pyx_n_s_logging, __pyx_k_logging, sizeof(__pyx_k_logging), 0, 0, 1, 1},
   {&__pyx_n_s_main, __pyx_k_main, sizeof(__pyx_k_main), 0, 0, 1, 1},
-  {&__pyx_n_s_mat, __pyx_k_mat, sizeof(__pyx_k_mat), 0, 0, 1, 1},
+  {&__pyx_n_s_make_logger, __pyx_k_make_logger, sizeof(__pyx_k_make_logger), 0, 0, 1, 1},
+  {&__pyx_n_s_max, __pyx_k_max, sizeof(__pyx_k_max), 0, 0, 1, 1},
   {&__pyx_n_s_memview, __pyx_k_memview, sizeof(__pyx_k_memview), 0, 0, 1, 1},
   {&__pyx_n_s_metaclass, __pyx_k_metaclass, sizeof(__pyx_k_metaclass), 0, 0, 1, 1},
+  {&__pyx_kp_u_minimal_W_t_stepsize_dt_min_reac, __pyx_k_minimal_W_t_stepsize_dt_min_reac, sizeof(__pyx_k_minimal_W_t_stepsize_dt_min_reac), 0, 1, 0, 0},
   {&__pyx_n_s_mode, __pyx_k_mode, sizeof(__pyx_k_mode), 0, 0, 1, 1},
   {&__pyx_n_s_module, __pyx_k_module, sizeof(__pyx_k_module), 0, 0, 1, 1},
   {&__pyx_n_s_name, __pyx_k_name, sizeof(__pyx_k_name), 0, 0, 1, 1},
   {&__pyx_n_s_name_2, __pyx_k_name_2, sizeof(__pyx_k_name_2), 0, 0, 1, 1},
   {&__pyx_n_s_ndim, __pyx_k_ndim, sizeof(__pyx_k_ndim), 0, 0, 1, 1},
-  {&__pyx_n_s_nevals, __pyx_k_nevals, sizeof(__pyx_k_nevals), 0, 0, 1, 1},
   {&__pyx_n_s_new, __pyx_k_new, sizeof(__pyx_k_new), 0, 0, 1, 1},
   {&__pyx_n_s_nnz, __pyx_k_nnz, sizeof(__pyx_k_nnz), 0, 0, 1, 1},
   {&__pyx_kp_s_no_default___reduce___due_to_non, __pyx_k_no_default___reduce___due_to_non, sizeof(__pyx_k_no_default___reduce___due_to_non), 0, 0, 1, 0},
   {&__pyx_n_s_np, __pyx_k_np, sizeof(__pyx_k_np), 0, 0, 1, 1},
   {&__pyx_n_s_numpy, __pyx_k_numpy, sizeof(__pyx_k_numpy), 0, 0, 1, 1},
   {&__pyx_n_s_obj, __pyx_k_obj, sizeof(__pyx_k_obj), 0, 0, 1, 1},
   {&__pyx_n_s_onsites, __pyx_k_onsites, sizeof(__pyx_k_onsites), 0, 0, 1, 1},
@@ -34012,238 +35974,204 @@
   {&__pyx_n_s_pack, __pyx_k_pack, sizeof(__pyx_k_pack), 0, 0, 1, 1},
   {&__pyx_n_s_params, __pyx_k_params, sizeof(__pyx_k_params), 0, 0, 1, 1},
   {&__pyx_n_s_pickle, __pyx_k_pickle, sizeof(__pyx_k_pickle), 0, 0, 1, 1},
   {&__pyx_n_s_prepare, __pyx_k_prepare, sizeof(__pyx_k_prepare), 0, 0, 1, 1},
   {&__pyx_n_s_psi, __pyx_k_psi, sizeof(__pyx_k_psi), 0, 0, 1, 1},
   {&__pyx_n_s_psi_centre, __pyx_k_psi_centre, sizeof(__pyx_k_psi_centre), 0, 0, 1, 1},
   {&__pyx_n_s_psi_st, __pyx_k_psi_st, sizeof(__pyx_k_psi_st), 0, 0, 1, 1},
-  {&__pyx_n_s_py_kernel, __pyx_k_py_kernel, sizeof(__pyx_k_py_kernel), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_PickleError, __pyx_k_pyx_PickleError, sizeof(__pyx_k_pyx_PickleError), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_checksum, __pyx_k_pyx_checksum, sizeof(__pyx_k_pyx_checksum), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_getbuffer, __pyx_k_pyx_getbuffer, sizeof(__pyx_k_pyx_getbuffer), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_result, __pyx_k_pyx_result, sizeof(__pyx_k_pyx_result), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_state, __pyx_k_pyx_state, sizeof(__pyx_k_pyx_state), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_type, __pyx_k_pyx_type, sizeof(__pyx_k_pyx_type), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_unpickle_Enum, __pyx_k_pyx_unpickle_Enum, sizeof(__pyx_k_pyx_unpickle_Enum), 0, 0, 1, 1},
+  {&__pyx_n_s_pyx_unpickle_Interpolation, __pyx_k_pyx_unpickle_Interpolation, sizeof(__pyx_k_pyx_unpickle_Interpolation), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_unpickle_Kernel, __pyx_k_pyx_unpickle_Kernel, sizeof(__pyx_k_pyx_unpickle_Kernel), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_unpickle_PerturbationExtra, __pyx_k_pyx_unpickle_PerturbationExtra, sizeof(__pyx_k_pyx_unpickle_PerturbationExtra), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_unpickle_PerturbationInter, __pyx_k_pyx_unpickle_PerturbationInter, sizeof(__pyx_k_pyx_unpickle_PerturbationInter), 0, 0, 1, 1},
   {&__pyx_n_s_pyx_vtable, __pyx_k_pyx_vtable, sizeof(__pyx_k_pyx_vtable), 0, 0, 1, 1},
   {&__pyx_n_s_qualname, __pyx_k_qualname, sizeof(__pyx_k_qualname), 0, 0, 1, 1},
   {&__pyx_n_s_range, __pyx_k_range, sizeof(__pyx_k_range), 0, 0, 1, 1},
   {&__pyx_n_s_reduce, __pyx_k_reduce, sizeof(__pyx_k_reduce), 0, 0, 1, 1},
   {&__pyx_n_s_reduce_cython, __pyx_k_reduce_cython, sizeof(__pyx_k_reduce_cython), 0, 0, 1, 1},
   {&__pyx_n_s_reduce_ex, __pyx_k_reduce_ex, sizeof(__pyx_k_reduce_ex), 0, 0, 1, 1},
   {&__pyx_n_s_rhs, __pyx_k_rhs, sizeof(__pyx_k_rhs), 0, 0, 1, 1},
   {&__pyx_n_s_round, __pyx_k_round, sizeof(__pyx_k_round), 0, 0, 1, 1},
   {&__pyx_n_s_row, __pyx_k_row, sizeof(__pyx_k_row), 0, 0, 1, 1},
   {&__pyx_n_s_row_col, __pyx_k_row_col, sizeof(__pyx_k_row_col), 0, 0, 1, 1},
+  {&__pyx_n_s_rtol, __pyx_k_rtol, sizeof(__pyx_k_rtol), 0, 0, 1, 1},
   {&__pyx_kp_u_s, __pyx_k_s, sizeof(__pyx_k_s), 0, 1, 0, 0},
   {&__pyx_n_s_scipy_sparse, __pyx_k_scipy_sparse, sizeof(__pyx_k_scipy_sparse), 0, 0, 1, 1},
   {&__pyx_n_s_scipy_sparse__sparsetools, __pyx_k_scipy_sparse__sparsetools, sizeof(__pyx_k_scipy_sparse__sparsetools), 0, 0, 1, 1},
   {&__pyx_n_s_self, __pyx_k_self, sizeof(__pyx_k_self), 0, 0, 1, 1},
-  {&__pyx_kp_s_self_c_rhs_self_c_self_cannot_be, __pyx_k_self_c_rhs_self_c_self_cannot_be, sizeof(__pyx_k_self_c_rhs_self_c_self_cannot_be), 0, 0, 1, 0},
-  {&__pyx_n_s_set_params, __pyx_k_set_params, sizeof(__pyx_k_set_params), 0, 0, 1, 1},
+  {&__pyx_n_s_set_W, __pyx_k_set_W, sizeof(__pyx_k_set_W), 0, 0, 1, 1},
   {&__pyx_n_s_setstate, __pyx_k_setstate, sizeof(__pyx_k_setstate), 0, 0, 1, 1},
   {&__pyx_n_s_setstate_cython, __pyx_k_setstate_cython, sizeof(__pyx_k_setstate_cython), 0, 0, 1, 1},
   {&__pyx_n_s_shape, __pyx_k_shape, sizeof(__pyx_k_shape), 0, 0, 1, 1},
   {&__pyx_n_s_site_ranges, __pyx_k_site_ranges, sizeof(__pyx_k_site_ranges), 0, 0, 1, 1},
   {&__pyx_n_s_size, __pyx_k_size, sizeof(__pyx_k_size), 0, 0, 1, 1},
   {&__pyx_n_s_sp, __pyx_k_sp, sizeof(__pyx_k_sp), 0, 0, 1, 1},
-  {&__pyx_n_s_sparse_blas_kernel, __pyx_k_sparse_blas_kernel, sizeof(__pyx_k_sparse_blas_kernel), 0, 0, 1, 1},
   {&__pyx_n_s_start, __pyx_k_start, sizeof(__pyx_k_start), 0, 0, 1, 1},
   {&__pyx_n_s_step, __pyx_k_step, sizeof(__pyx_k_step), 0, 0, 1, 1},
   {&__pyx_n_s_stop, __pyx_k_stop, sizeof(__pyx_k_stop), 0, 0, 1, 1},
   {&__pyx_kp_s_strided_and_direct, __pyx_k_strided_and_direct, sizeof(__pyx_k_strided_and_direct), 0, 0, 1, 0},
   {&__pyx_kp_s_strided_and_direct_or_indirect, __pyx_k_strided_and_direct_or_indirect, sizeof(__pyx_k_strided_and_direct_or_indirect), 0, 0, 1, 0},
   {&__pyx_kp_s_strided_and_indirect, __pyx_k_strided_and_indirect, sizeof(__pyx_k_strided_and_indirect), 0, 0, 1, 0},
   {&__pyx_kp_s_stringsource, __pyx_k_stringsource, sizeof(__pyx_k_stringsource), 0, 0, 1, 0},
   {&__pyx_n_s_struct, __pyx_k_struct, sizeof(__pyx_k_struct), 0, 0, 1, 1},
   {&__pyx_n_s_syst, __pyx_k_syst, sizeof(__pyx_k_syst), 0, 0, 1, 1},
   {&__pyx_n_s_system, __pyx_k_system, sizeof(__pyx_k_system), 0, 0, 1, 1},
+  {&__pyx_n_s_t0, __pyx_k_t0, sizeof(__pyx_k_t0), 0, 0, 1, 1},
+  {&__pyx_n_s_temp, __pyx_k_temp, sizeof(__pyx_k_temp), 0, 0, 1, 1},
   {&__pyx_n_s_test, __pyx_k_test, sizeof(__pyx_k_test), 0, 0, 1, 1},
   {&__pyx_n_s_time, __pyx_k_time, sizeof(__pyx_k_time), 0, 0, 1, 1},
   {&__pyx_n_s_time_name, __pyx_k_time_name, sizeof(__pyx_k_time_name), 0, 0, 1, 1},
   {&__pyx_n_s_time_start, __pyx_k_time_start, sizeof(__pyx_k_time_start), 0, 0, 1, 1},
-  {&__pyx_kp_u_time_t_must_be_greater_equal_t0, __pyx_k_time_t_must_be_greater_equal_t0, sizeof(__pyx_k_time_t_must_be_greater_equal_t0), 0, 1, 0, 0},
   {&__pyx_n_s_tkwant_onebody_kernels, __pyx_k_tkwant_onebody_kernels, sizeof(__pyx_k_tkwant_onebody_kernels), 0, 0, 1, 1},
   {&__pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_k_tkwant_onebody_kernels_pyx, sizeof(__pyx_k_tkwant_onebody_kernels_pyx), 0, 0, 1, 0},
   {&__pyx_n_s_tmp, __pyx_k_tmp, sizeof(__pyx_k_tmp), 0, 0, 1, 1},
   {&__pyx_n_s_tmp_2, __pyx_k_tmp_2, sizeof(__pyx_k_tmp_2), 0, 0, 1, 1},
   {&__pyx_n_s_tocsr, __pyx_k_tocsr, sizeof(__pyx_k_tocsr), 0, 0, 1, 1},
   {&__pyx_n_s_transpose, __pyx_k_transpose, sizeof(__pyx_k_transpose), 0, 0, 1, 1},
   {&__pyx_n_u_transpose, __pyx_k_transpose, sizeof(__pyx_k_transpose), 0, 1, 0, 1},
   {&__pyx_kp_s_unable_to_allocate_array_data, __pyx_k_unable_to_allocate_array_data, sizeof(__pyx_k_unable_to_allocate_array_data), 0, 0, 1, 0},
   {&__pyx_kp_s_unable_to_allocate_shape_and_str, __pyx_k_unable_to_allocate_shape_and_str, sizeof(__pyx_k_unable_to_allocate_shape_and_str), 0, 0, 1, 0},
   {&__pyx_n_s_unpack, __pyx_k_unpack, sizeof(__pyx_k_unpack), 0, 0, 1, 1},
   {&__pyx_n_s_update, __pyx_k_update, sizeof(__pyx_k_update), 0, 0, 1, 1},
+  {&__pyx_kp_u_use_the_scipy_kernel_for_seriali, __pyx_k_use_the_scipy_kernel_for_seriali, sizeof(__pyx_k_use_the_scipy_kernel_for_seriali), 0, 1, 0, 0},
   {&__pyx_n_s_value, __pyx_k_value, sizeof(__pyx_k_value), 0, 0, 1, 1},
+  {&__pyx_n_s_warning, __pyx_k_warning, sizeof(__pyx_k_warning), 0, 0, 1, 1},
+  {&__pyx_n_s_work, __pyx_k_work, sizeof(__pyx_k_work), 0, 0, 1, 1},
+  {&__pyx_kp_u_work_array_size_must_be_at_least, __pyx_k_work_array_size_must_be_at_least, sizeof(__pyx_k_work_array_size_must_be_at_least), 0, 1, 0, 0},
   {&__pyx_n_s_zeros, __pyx_k_zeros, sizeof(__pyx_k_zeros), 0, 0, 1, 1},
   {0, 0, 0, 0, 0, 0, 0}
 };
 static CYTHON_SMALL_CODE int __Pyx_InitCachedBuiltins(void) {
-  __pyx_builtin_ImportError = __Pyx_GetBuiltinName(__pyx_n_s_ImportError); if (!__pyx_builtin_ImportError) __PYX_ERR(0, 937, __pyx_L1_error)
-  __pyx_builtin_NotImplementedError = __Pyx_GetBuiltinName(__pyx_n_s_NotImplementedError); if (!__pyx_builtin_NotImplementedError) __PYX_ERR(0, 60, __pyx_L1_error)
+  __pyx_builtin_NotImplementedError = __Pyx_GetBuiltinName(__pyx_n_s_NotImplementedError); if (!__pyx_builtin_NotImplementedError) __PYX_ERR(0, 61, __pyx_L1_error)
+  __pyx_builtin_ValueError = __Pyx_GetBuiltinName(__pyx_n_s_ValueError); if (!__pyx_builtin_ValueError) __PYX_ERR(0, 125, __pyx_L1_error)
+  __pyx_builtin_range = __Pyx_GetBuiltinName(__pyx_n_s_range); if (!__pyx_builtin_range) __PYX_ERR(0, 193, __pyx_L1_error)
+  __pyx_builtin_round = __Pyx_GetBuiltinName(__pyx_n_s_round); if (!__pyx_builtin_round) __PYX_ERR(0, 204, __pyx_L1_error)
+  __pyx_builtin_enumerate = __Pyx_GetBuiltinName(__pyx_n_s_enumerate); if (!__pyx_builtin_enumerate) __PYX_ERR(0, 473, __pyx_L1_error)
   __pyx_builtin_TypeError = __Pyx_GetBuiltinName(__pyx_n_s_TypeError); if (!__pyx_builtin_TypeError) __PYX_ERR(1, 2, __pyx_L1_error)
-  __pyx_builtin_range = __Pyx_GetBuiltinName(__pyx_n_s_range); if (!__pyx_builtin_range) __PYX_ERR(0, 207, __pyx_L1_error)
-  __pyx_builtin_ValueError = __Pyx_GetBuiltinName(__pyx_n_s_ValueError); if (!__pyx_builtin_ValueError) __PYX_ERR(0, 221, __pyx_L1_error)
-  __pyx_builtin_round = __Pyx_GetBuiltinName(__pyx_n_s_round); if (!__pyx_builtin_round) __PYX_ERR(0, 223, __pyx_L1_error)
-  __pyx_builtin_enumerate = __Pyx_GetBuiltinName(__pyx_n_s_enumerate); if (!__pyx_builtin_enumerate) __PYX_ERR(0, 308, __pyx_L1_error)
-  __pyx_builtin_MemoryError = __Pyx_GetBuiltinName(__pyx_n_s_MemoryError); if (!__pyx_builtin_MemoryError) __PYX_ERR(1, 148, __pyx_L1_error)
-  __pyx_builtin_Ellipsis = __Pyx_GetBuiltinName(__pyx_n_s_Ellipsis); if (!__pyx_builtin_Ellipsis) __PYX_ERR(1, 400, __pyx_L1_error)
-  __pyx_builtin_id = __Pyx_GetBuiltinName(__pyx_n_s_id); if (!__pyx_builtin_id) __PYX_ERR(1, 609, __pyx_L1_error)
-  __pyx_builtin_IndexError = __Pyx_GetBuiltinName(__pyx_n_s_IndexError); if (!__pyx_builtin_IndexError) __PYX_ERR(1, 828, __pyx_L1_error)
+  __pyx_builtin_MemoryError = __Pyx_GetBuiltinName(__pyx_n_s_MemoryError); if (!__pyx_builtin_MemoryError) __PYX_ERR(1, 149, __pyx_L1_error)
+  __pyx_builtin_Ellipsis = __Pyx_GetBuiltinName(__pyx_n_s_Ellipsis); if (!__pyx_builtin_Ellipsis) __PYX_ERR(1, 406, __pyx_L1_error)
+  __pyx_builtin_id = __Pyx_GetBuiltinName(__pyx_n_s_id); if (!__pyx_builtin_id) __PYX_ERR(1, 615, __pyx_L1_error)
+  __pyx_builtin_IndexError = __Pyx_GetBuiltinName(__pyx_n_s_IndexError); if (!__pyx_builtin_IndexError) __PYX_ERR(1, 834, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 
 static CYTHON_SMALL_CODE int __Pyx_InitCachedConstants(void) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__Pyx_InitCachedConstants", 0);
 
   /* "(tree fragment)":2
  * def __reduce_cython__(self):
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")             # <<<<<<<<<<<<<<
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
- */
-  __pyx_tuple__2 = PyTuple_Pack(1, __pyx_kp_s_self_c_rhs_self_c_self_cannot_be); if (unlikely(!__pyx_tuple__2)) __PYX_ERR(1, 2, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__2);
-  __Pyx_GIVEREF(__pyx_tuple__2);
-
-  /* "(tree fragment)":4
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("self.c_rhs,self.c_self cannot be converted to a Python object for pickling")             # <<<<<<<<<<<<<<
- */
-  __pyx_tuple__3 = PyTuple_Pack(1, __pyx_kp_s_self_c_rhs_self_c_self_cannot_be); if (unlikely(!__pyx_tuple__3)) __PYX_ERR(1, 4, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__3);
-  __Pyx_GIVEREF(__pyx_tuple__3);
-
-  /* "(tree fragment)":2
- * def __reduce_cython__(self):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
  */
-  __pyx_tuple__4 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__4)) __PYX_ERR(1, 2, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__4);
-  __Pyx_GIVEREF(__pyx_tuple__4);
+  __pyx_tuple__6 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__6)) __PYX_ERR(1, 2, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__6);
+  __Pyx_GIVEREF(__pyx_tuple__6);
 
   /* "(tree fragment)":4
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  */
-  __pyx_tuple__5 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__5)) __PYX_ERR(1, 4, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__5);
-  __Pyx_GIVEREF(__pyx_tuple__5);
-
-  /* "tkwant/onebody/kernels.pyx":125
- *         return py_kernel
- *     elif not callable(py_kernel.rhs):
- *         raise TypeError('Kernel must have a `rhs` method.')             # <<<<<<<<<<<<<<
- *     return PyCKernel(py_kernel)
- * 
- */
-  __pyx_tuple__6 = PyTuple_Pack(1, __pyx_kp_u_Kernel_must_have_a_rhs_method); if (unlikely(!__pyx_tuple__6)) __PYX_ERR(0, 125, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__6);
-  __Pyx_GIVEREF(__pyx_tuple__6);
-
-  /* "(tree fragment)":2
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- */
-  __pyx_tuple__7 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__7)) __PYX_ERR(1, 2, __pyx_L1_error)
+  __pyx_tuple__7 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__7)) __PYX_ERR(1, 4, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__7);
   __Pyx_GIVEREF(__pyx_tuple__7);
 
-  /* "(tree fragment)":4
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
+  /* "tkwant/onebody/kernels.pyx":987
+ * 
+ *     def __reduce__(self):
+ *         raise NotImplementedError("use the scipy kernel for serialization")             # <<<<<<<<<<<<<<
+ * 
+ * default = Simple
  */
-  __pyx_tuple__8 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__8)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __pyx_tuple__8 = PyTuple_Pack(1, __pyx_kp_u_use_the_scipy_kernel_for_seriali); if (unlikely(!__pyx_tuple__8)) __PYX_ERR(0, 987, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__8);
   __Pyx_GIVEREF(__pyx_tuple__8);
 
-  /* "(tree fragment)":2
- * def __reduce_cython__(self):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
+  /* "(tree fragment)":4
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
+ *     if __pyx_checksum not in (0x4d5deb3, 0x498303b, 0x82e3adb):             # <<<<<<<<<<<<<<
+ *         from pickle import PickleError as __pyx_PickleError
+ *         raise __pyx_PickleError("Incompatible checksums (0x%x vs (0x4d5deb3, 0x498303b, 0x82e3adb) = (nevals, size))" % __pyx_checksum)
  */
-  __pyx_tuple__11 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__11)) __PYX_ERR(1, 2, __pyx_L1_error)
+  __pyx_tuple__9 = PyTuple_Pack(3, __pyx_int_81125043, __pyx_int_77082683, __pyx_int_137247451); if (unlikely(!__pyx_tuple__9)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__9);
+  __Pyx_GIVEREF(__pyx_tuple__9);
+  __pyx_tuple__10 = PyTuple_Pack(3, __pyx_int_172575680, __pyx_int_51357075, __pyx_int_65594335); if (unlikely(!__pyx_tuple__10)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__10);
+  __Pyx_GIVEREF(__pyx_tuple__10);
+  __pyx_tuple__11 = PyTuple_Pack(3, __pyx_int_40710769, __pyx_int_186858192, __pyx_int_107924309); if (unlikely(!__pyx_tuple__11)) __PYX_ERR(1, 4, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__11);
   __Pyx_GIVEREF(__pyx_tuple__11);
-
-  /* "(tree fragment)":4
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
- * def __setstate_cython__(self, __pyx_state):
- *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
- */
-  __pyx_tuple__12 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__12)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __pyx_tuple__12 = PyTuple_Pack(3, __pyx_int_47058919, __pyx_int_219249325, __pyx_int_157128468); if (unlikely(!__pyx_tuple__12)) __PYX_ERR(1, 4, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__12);
   __Pyx_GIVEREF(__pyx_tuple__12);
 
-  /* "View.MemoryView":133
+  /* "View.MemoryView":134
  * 
  *         if not self.ndim:
  *             raise ValueError("Empty shape tuple for cython.array")             # <<<<<<<<<<<<<<
  * 
  *         if itemsize <= 0:
  */
-  __pyx_tuple__13 = PyTuple_Pack(1, __pyx_kp_s_Empty_shape_tuple_for_cython_arr); if (unlikely(!__pyx_tuple__13)) __PYX_ERR(1, 133, __pyx_L1_error)
+  __pyx_tuple__13 = PyTuple_Pack(1, __pyx_kp_s_Empty_shape_tuple_for_cython_arr); if (unlikely(!__pyx_tuple__13)) __PYX_ERR(1, 134, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__13);
   __Pyx_GIVEREF(__pyx_tuple__13);
 
-  /* "View.MemoryView":136
+  /* "View.MemoryView":137
  * 
  *         if itemsize <= 0:
  *             raise ValueError("itemsize <= 0 for cython.array")             # <<<<<<<<<<<<<<
  * 
  *         if not isinstance(format, bytes):
  */
-  __pyx_tuple__14 = PyTuple_Pack(1, __pyx_kp_s_itemsize_0_for_cython_array); if (unlikely(!__pyx_tuple__14)) __PYX_ERR(1, 136, __pyx_L1_error)
+  __pyx_tuple__14 = PyTuple_Pack(1, __pyx_kp_s_itemsize_0_for_cython_array); if (unlikely(!__pyx_tuple__14)) __PYX_ERR(1, 137, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__14);
   __Pyx_GIVEREF(__pyx_tuple__14);
 
-  /* "View.MemoryView":148
+  /* "View.MemoryView":149
  * 
  *         if not self._shape:
  *             raise MemoryError("unable to allocate shape and strides.")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_tuple__15 = PyTuple_Pack(1, __pyx_kp_s_unable_to_allocate_shape_and_str); if (unlikely(!__pyx_tuple__15)) __PYX_ERR(1, 148, __pyx_L1_error)
+  __pyx_tuple__15 = PyTuple_Pack(1, __pyx_kp_s_unable_to_allocate_shape_and_str); if (unlikely(!__pyx_tuple__15)) __PYX_ERR(1, 149, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__15);
   __Pyx_GIVEREF(__pyx_tuple__15);
 
-  /* "View.MemoryView":176
+  /* "View.MemoryView":177
  *             self.data = <char *>malloc(self.len)
  *             if not self.data:
  *                 raise MemoryError("unable to allocate array data.")             # <<<<<<<<<<<<<<
  * 
  *             if self.dtype_is_object:
  */
-  __pyx_tuple__16 = PyTuple_Pack(1, __pyx_kp_s_unable_to_allocate_array_data); if (unlikely(!__pyx_tuple__16)) __PYX_ERR(1, 176, __pyx_L1_error)
+  __pyx_tuple__16 = PyTuple_Pack(1, __pyx_kp_s_unable_to_allocate_array_data); if (unlikely(!__pyx_tuple__16)) __PYX_ERR(1, 177, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__16);
   __Pyx_GIVEREF(__pyx_tuple__16);
 
-  /* "View.MemoryView":192
+  /* "View.MemoryView":193
  *             bufmode = PyBUF_F_CONTIGUOUS | PyBUF_ANY_CONTIGUOUS
  *         if not (flags & bufmode):
  *             raise ValueError("Can only create a buffer that is contiguous in memory.")             # <<<<<<<<<<<<<<
  *         info.buf = self.data
  *         info.len = self.len
  */
-  __pyx_tuple__17 = PyTuple_Pack(1, __pyx_kp_s_Can_only_create_a_buffer_that_is); if (unlikely(!__pyx_tuple__17)) __PYX_ERR(1, 192, __pyx_L1_error)
+  __pyx_tuple__17 = PyTuple_Pack(1, __pyx_kp_s_Can_only_create_a_buffer_that_is); if (unlikely(!__pyx_tuple__17)) __PYX_ERR(1, 193, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__17);
   __Pyx_GIVEREF(__pyx_tuple__17);
 
   /* "(tree fragment)":2
  * def __reduce_cython__(self):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  * def __setstate_cython__(self, __pyx_state):
@@ -34258,66 +36186,66 @@
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  */
   __pyx_tuple__19 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__19)) __PYX_ERR(1, 4, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__19);
   __Pyx_GIVEREF(__pyx_tuple__19);
 
-  /* "View.MemoryView":414
+  /* "View.MemoryView":420
  *     def __setitem__(memoryview self, object index, object value):
  *         if self.view.readonly:
  *             raise TypeError("Cannot assign to read-only memoryview")             # <<<<<<<<<<<<<<
  * 
  *         have_slices, index = _unellipsify(index, self.view.ndim)
  */
-  __pyx_tuple__20 = PyTuple_Pack(1, __pyx_kp_s_Cannot_assign_to_read_only_memor); if (unlikely(!__pyx_tuple__20)) __PYX_ERR(1, 414, __pyx_L1_error)
+  __pyx_tuple__20 = PyTuple_Pack(1, __pyx_kp_s_Cannot_assign_to_read_only_memor); if (unlikely(!__pyx_tuple__20)) __PYX_ERR(1, 420, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__20);
   __Pyx_GIVEREF(__pyx_tuple__20);
 
-  /* "View.MemoryView":491
+  /* "View.MemoryView":497
  *             result = struct.unpack(self.view.format, bytesitem)
  *         except struct.error:
  *             raise ValueError("Unable to convert item to object")             # <<<<<<<<<<<<<<
  *         else:
  *             if len(self.view.format) == 1:
  */
-  __pyx_tuple__21 = PyTuple_Pack(1, __pyx_kp_s_Unable_to_convert_item_to_object); if (unlikely(!__pyx_tuple__21)) __PYX_ERR(1, 491, __pyx_L1_error)
+  __pyx_tuple__21 = PyTuple_Pack(1, __pyx_kp_s_Unable_to_convert_item_to_object); if (unlikely(!__pyx_tuple__21)) __PYX_ERR(1, 497, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__21);
   __Pyx_GIVEREF(__pyx_tuple__21);
 
-  /* "View.MemoryView":516
+  /* "View.MemoryView":522
  *     def __getbuffer__(self, Py_buffer *info, int flags):
  *         if flags & PyBUF_WRITABLE and self.view.readonly:
  *             raise ValueError("Cannot create writable memory view from read-only memoryview")             # <<<<<<<<<<<<<<
  * 
  *         if flags & PyBUF_ND:
  */
-  __pyx_tuple__22 = PyTuple_Pack(1, __pyx_kp_s_Cannot_create_writable_memory_vi); if (unlikely(!__pyx_tuple__22)) __PYX_ERR(1, 516, __pyx_L1_error)
+  __pyx_tuple__22 = PyTuple_Pack(1, __pyx_kp_s_Cannot_create_writable_memory_vi); if (unlikely(!__pyx_tuple__22)) __PYX_ERR(1, 522, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__22);
   __Pyx_GIVEREF(__pyx_tuple__22);
 
-  /* "View.MemoryView":566
+  /* "View.MemoryView":572
  *         if self.view.strides == NULL:
  * 
  *             raise ValueError("Buffer view does not expose strides")             # <<<<<<<<<<<<<<
  * 
  *         return tuple([stride for stride in self.view.strides[:self.view.ndim]])
  */
-  __pyx_tuple__23 = PyTuple_Pack(1, __pyx_kp_s_Buffer_view_does_not_expose_stri); if (unlikely(!__pyx_tuple__23)) __PYX_ERR(1, 566, __pyx_L1_error)
+  __pyx_tuple__23 = PyTuple_Pack(1, __pyx_kp_s_Buffer_view_does_not_expose_stri); if (unlikely(!__pyx_tuple__23)) __PYX_ERR(1, 572, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__23);
   __Pyx_GIVEREF(__pyx_tuple__23);
 
-  /* "View.MemoryView":573
+  /* "View.MemoryView":579
  *     def suboffsets(self):
  *         if self.view.suboffsets == NULL:
  *             return (-1,) * self.view.ndim             # <<<<<<<<<<<<<<
  * 
  *         return tuple([suboffset for suboffset in self.view.suboffsets[:self.view.ndim]])
  */
-  __pyx_tuple__24 = PyTuple_New(1); if (unlikely(!__pyx_tuple__24)) __PYX_ERR(1, 573, __pyx_L1_error)
+  __pyx_tuple__24 = PyTuple_New(1); if (unlikely(!__pyx_tuple__24)) __PYX_ERR(1, 579, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__24);
   __Pyx_INCREF(__pyx_int_neg_1);
   __Pyx_GIVEREF(__pyx_int_neg_1);
   PyTuple_SET_ITEM(__pyx_tuple__24, 0, __pyx_int_neg_1);
   __Pyx_GIVEREF(__pyx_tuple__24);
 
   /* "(tree fragment)":2
@@ -34335,33 +36263,33 @@
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  */
   __pyx_tuple__26 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__26)) __PYX_ERR(1, 4, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__26);
   __Pyx_GIVEREF(__pyx_tuple__26);
 
-  /* "View.MemoryView":678
+  /* "View.MemoryView":684
  *         if item is Ellipsis:
  *             if not seen_ellipsis:
  *                 result.extend([slice(None)] * (ndim - len(tup) + 1))             # <<<<<<<<<<<<<<
  *                 seen_ellipsis = True
  *             else:
  */
-  __pyx_slice__27 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__27)) __PYX_ERR(1, 678, __pyx_L1_error)
+  __pyx_slice__27 = PySlice_New(Py_None, Py_None, Py_None); if (unlikely(!__pyx_slice__27)) __PYX_ERR(1, 684, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_slice__27);
   __Pyx_GIVEREF(__pyx_slice__27);
 
-  /* "View.MemoryView":699
+  /* "View.MemoryView":705
  *     for suboffset in suboffsets[:ndim]:
  *         if suboffset >= 0:
  *             raise ValueError("Indirect dimensions not supported")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_tuple__28 = PyTuple_Pack(1, __pyx_kp_s_Indirect_dimensions_not_supporte); if (unlikely(!__pyx_tuple__28)) __PYX_ERR(1, 699, __pyx_L1_error)
+  __pyx_tuple__28 = PyTuple_Pack(1, __pyx_kp_s_Indirect_dimensions_not_supporte); if (unlikely(!__pyx_tuple__28)) __PYX_ERR(1, 705, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__28);
   __Pyx_GIVEREF(__pyx_tuple__28);
 
   /* "(tree fragment)":2
  * def __reduce_cython__(self):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  * def __setstate_cython__(self, __pyx_state):
@@ -34375,166 +36303,217 @@
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")
  * def __setstate_cython__(self, __pyx_state):
  *     raise TypeError("no default __reduce__ due to non-trivial __cinit__")             # <<<<<<<<<<<<<<
  */
   __pyx_tuple__30 = PyTuple_Pack(1, __pyx_kp_s_no_default___reduce___due_to_non); if (unlikely(!__pyx_tuple__30)) __PYX_ERR(1, 4, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__30);
   __Pyx_GIVEREF(__pyx_tuple__30);
+  __pyx_tuple__31 = PyTuple_Pack(3, __pyx_int_184977713, __pyx_int_136983863, __pyx_int_112105877); if (unlikely(!__pyx_tuple__31)) __PYX_ERR(1, 4, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__31);
+  __Pyx_GIVEREF(__pyx_tuple__31);
 
-  /* "tkwant/onebody/kernels.pyx":167
+  /* "tkwant/onebody/kernels.pyx":103
  *     """
  * 
- *     def __init__(self, H0, W, params, psi_st=None):             # <<<<<<<<<<<<<<
- *         self.H0 = H0.tocsr()
- *         self.W = W
+ *     def __init__(self, H0, W, psi_st=None, work=None):             # <<<<<<<<<<<<<<
+ * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):
  */
-  __pyx_tuple__37 = PyTuple_Pack(5, __pyx_n_s_self, __pyx_n_s_H0, __pyx_n_s_W, __pyx_n_s_params, __pyx_n_s_psi_st); if (unlikely(!__pyx_tuple__37)) __PYX_ERR(0, 167, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__37);
-  __Pyx_GIVEREF(__pyx_tuple__37);
-  __pyx_codeobj__38 = (PyObject*)__Pyx_PyCode_New(5, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__37, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_init, 167, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__38)) __PYX_ERR(0, 167, __pyx_L1_error)
-  __pyx_tuple__39 = PyTuple_Pack(1, ((PyObject *)Py_None)); if (unlikely(!__pyx_tuple__39)) __PYX_ERR(0, 167, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__39);
-  __Pyx_GIVEREF(__pyx_tuple__39);
+  __pyx_tuple__38 = PyTuple_Pack(5, __pyx_n_s_self, __pyx_n_s_H0, __pyx_n_s_W, __pyx_n_s_psi_st, __pyx_n_s_work); if (unlikely(!__pyx_tuple__38)) __PYX_ERR(0, 103, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__38);
+  __Pyx_GIVEREF(__pyx_tuple__38);
+  __pyx_codeobj__39 = (PyObject*)__Pyx_PyCode_New(5, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__38, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_init, 103, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__39)) __PYX_ERR(0, 103, __pyx_L1_error)
+  __pyx_tuple__40 = PyTuple_Pack(2, ((PyObject *)Py_None), ((PyObject *)Py_None)); if (unlikely(!__pyx_tuple__40)) __PYX_ERR(0, 103, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__40);
+  __Pyx_GIVEREF(__pyx_tuple__40);
 
-  /* "tkwant/onebody/kernels.pyx":180
- *         self._tmp = np.zeros((self.size,), dtype=complex)
+  /* "tkwant/onebody/kernels.pyx":130
+ *             self._tmp = work
  * 
- *     def set_params(self, params):             # <<<<<<<<<<<<<<
- *         self.params = params
+ *     def rhs(self, energy=None):             # <<<<<<<<<<<<<<
  * 
+ *         if energy is None:
  */
-  __pyx_tuple__40 = PyTuple_Pack(2, __pyx_n_s_self, __pyx_n_s_params); if (unlikely(!__pyx_tuple__40)) __PYX_ERR(0, 180, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__40);
-  __Pyx_GIVEREF(__pyx_tuple__40);
-  __pyx_codeobj__41 = (PyObject*)__Pyx_PyCode_New(2, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__40, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_set_params, 180, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__41)) __PYX_ERR(0, 180, __pyx_L1_error)
+  __pyx_tuple__41 = PyTuple_Pack(3, __pyx_n_s_self, __pyx_n_s_energy, __pyx_n_s_H0); if (unlikely(!__pyx_tuple__41)) __PYX_ERR(0, 130, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__41);
+  __Pyx_GIVEREF(__pyx_tuple__41);
+  __pyx_codeobj__42 = (PyObject*)__Pyx_PyCode_New(2, 0, 3, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__41, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_rhs, 130, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__42)) __PYX_ERR(0, 130, __pyx_L1_error)
+  __pyx_tuple__43 = PyTuple_Pack(1, ((PyObject *)Py_None)); if (unlikely(!__pyx_tuple__43)) __PYX_ERR(0, 130, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__43);
+  __Pyx_GIVEREF(__pyx_tuple__43);
 
-  /* "tkwant/onebody/kernels.pyx":183
- *         self.params = params
+  /* "tkwant/onebody/kernels.pyx":152
+ *         return _CalcRHS(H0, self.W, self.psi_st, self.size, self.center_size, self._tmp)
  * 
- *     def rhs(self, const complex[:] psi, complex[:] dpsidt, double time):             # <<<<<<<<<<<<<<
- *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
- *         psi_centre = np.asarray(psi[:self.center_size])
+ *     def set_W(self, W):             # <<<<<<<<<<<<<<
+ *         '''Set the time dependent perturbation W(t)'''
+ *         self.W = W
+ */
+  __pyx_tuple__44 = PyTuple_Pack(2, __pyx_n_s_self, __pyx_n_s_W); if (unlikely(!__pyx_tuple__44)) __PYX_ERR(0, 152, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__44);
+  __Pyx_GIVEREF(__pyx_tuple__44);
+  __pyx_codeobj__45 = (PyObject*)__Pyx_PyCode_New(2, 0, 2, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__44, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_set_W, 152, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__45)) __PYX_ERR(0, 152, __pyx_L1_error)
+
+  /* "tkwant/onebody/kernels.pyx":159
+ * class _CalcRHS:
+ *     """Calculate the right-hand-side of the time-dependent Schrdinger equation."""
+ *     def __init__(self, H0, W, psi_st, size, center_size, tmp):             # <<<<<<<<<<<<<<
+ * 
+ *         self.H0 = H0
+ */
+  __pyx_tuple__46 = PyTuple_Pack(7, __pyx_n_s_self, __pyx_n_s_H0, __pyx_n_s_W, __pyx_n_s_psi_st, __pyx_n_s_size, __pyx_n_s_center_size, __pyx_n_s_tmp_2); if (unlikely(!__pyx_tuple__46)) __PYX_ERR(0, 159, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__46);
+  __Pyx_GIVEREF(__pyx_tuple__46);
+  __pyx_codeobj__47 = (PyObject*)__Pyx_PyCode_New(7, 0, 7, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__46, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_init, 159, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__47)) __PYX_ERR(0, 159, __pyx_L1_error)
+
+  /* "tkwant/onebody/kernels.pyx":170
+ *     @cython.boundscheck(False)
+ *     @cython.wraparound(False)
+ *     def __call__(self, const complex[:] psi, complex[:] dpsidt, const double time):             # <<<<<<<<<<<<<<
+ * 
+ *         # H0 @ psi -> tmp
  */
-  __pyx_tuple__42 = PyTuple_Pack(8, __pyx_n_s_self, __pyx_n_s_psi, __pyx_n_s_dpsidt, __pyx_n_s_time, __pyx_n_s_psi_centre, __pyx_n_s_tmp_2, __pyx_n_s_exept, __pyx_n_s_i); if (unlikely(!__pyx_tuple__42)) __PYX_ERR(0, 183, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__42);
-  __Pyx_GIVEREF(__pyx_tuple__42);
-  __pyx_codeobj__43 = (PyObject*)__Pyx_PyCode_New(4, 0, 8, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__42, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_rhs, 183, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__43)) __PYX_ERR(0, 183, __pyx_L1_error)
+  __pyx_tuple__48 = PyTuple_Pack(8, __pyx_n_s_self, __pyx_n_s_psi, __pyx_n_s_dpsidt, __pyx_n_s_time, __pyx_n_s_tmp_2, __pyx_n_s_psi_centre, __pyx_n_s_exept, __pyx_n_s_i); if (unlikely(!__pyx_tuple__48)) __PYX_ERR(0, 170, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__48);
+  __Pyx_GIVEREF(__pyx_tuple__48);
+  __pyx_codeobj__49 = (PyObject*)__Pyx_PyCode_New(4, 0, 8, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__48, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_call, 170, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__49)) __PYX_ERR(0, 170, __pyx_L1_error)
 
-  /* "tkwant/onebody/kernels.pyx":247
+  /* "tkwant/onebody/kernels.pyx":228
  * 
  * 
  * def _herm_conj(value):             # <<<<<<<<<<<<<<
  *     if hasattr(value, 'conjugate'):
  *         value = value.conjugate()
  */
-  __pyx_tuple__44 = PyTuple_Pack(1, __pyx_n_s_value); if (unlikely(!__pyx_tuple__44)) __PYX_ERR(0, 247, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__44);
-  __Pyx_GIVEREF(__pyx_tuple__44);
-  __pyx_codeobj__45 = (PyObject*)__Pyx_PyCode_New(1, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__44, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_herm_conj, 247, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__45)) __PYX_ERR(0, 247, __pyx_L1_error)
+  __pyx_tuple__50 = PyTuple_Pack(1, __pyx_n_s_value); if (unlikely(!__pyx_tuple__50)) __PYX_ERR(0, 228, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__50);
+  __Pyx_GIVEREF(__pyx_tuple__50);
+  __pyx_codeobj__51 = (PyObject*)__Pyx_PyCode_New(1, 0, 1, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__50, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_kernels_pyx, __pyx_n_s_herm_conj, 228, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__51)) __PYX_ERR(0, 228, __pyx_L1_error)
 
   /* "(tree fragment)":1
  * def __pyx_unpickle_Kernel(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
-  __pyx_tuple__46 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__46)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__46);
-  __Pyx_GIVEREF(__pyx_tuple__46);
-  __pyx_codeobj__47 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__46, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_Kernel, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__47)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_tuple__48 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__48)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__48);
-  __Pyx_GIVEREF(__pyx_tuple__48);
-  __pyx_codeobj__49 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__48, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_PerturbationExtra, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__49)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __pyx_tuple__50 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__50)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__50);
-  __Pyx_GIVEREF(__pyx_tuple__50);
-  __pyx_codeobj__51 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__50, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_PerturbationInter, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__51)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_tuple__52 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__52)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__52);
+  __Pyx_GIVEREF(__pyx_tuple__52);
+  __pyx_codeobj__53 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__52, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_Kernel, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__53)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_tuple__54 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__54)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__54);
+  __Pyx_GIVEREF(__pyx_tuple__54);
+  __pyx_codeobj__55 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__54, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_Interpolation, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__55)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_tuple__56 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__56)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__56);
+  __Pyx_GIVEREF(__pyx_tuple__56);
+  __pyx_codeobj__57 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__56, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_PerturbationExtra, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__57)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_tuple__58 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__58)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__58);
+  __Pyx_GIVEREF(__pyx_tuple__58);
+  __pyx_codeobj__59 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__58, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_PerturbationInter, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__59)) __PYX_ERR(1, 1, __pyx_L1_error)
 
-  /* "View.MemoryView":286
+  /* "View.MemoryView":287
  *         return self.name
  * 
  * cdef generic = Enum("<strided and direct or indirect>")             # <<<<<<<<<<<<<<
  * cdef strided = Enum("<strided and direct>") # default
  * cdef indirect = Enum("<strided and indirect>")
  */
-  __pyx_tuple__52 = PyTuple_Pack(1, __pyx_kp_s_strided_and_direct_or_indirect); if (unlikely(!__pyx_tuple__52)) __PYX_ERR(1, 286, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__52);
-  __Pyx_GIVEREF(__pyx_tuple__52);
+  __pyx_tuple__60 = PyTuple_Pack(1, __pyx_kp_s_strided_and_direct_or_indirect); if (unlikely(!__pyx_tuple__60)) __PYX_ERR(1, 287, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__60);
+  __Pyx_GIVEREF(__pyx_tuple__60);
 
-  /* "View.MemoryView":287
+  /* "View.MemoryView":288
  * 
  * cdef generic = Enum("<strided and direct or indirect>")
  * cdef strided = Enum("<strided and direct>") # default             # <<<<<<<<<<<<<<
  * cdef indirect = Enum("<strided and indirect>")
  * 
  */
-  __pyx_tuple__53 = PyTuple_Pack(1, __pyx_kp_s_strided_and_direct); if (unlikely(!__pyx_tuple__53)) __PYX_ERR(1, 287, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__53);
-  __Pyx_GIVEREF(__pyx_tuple__53);
+  __pyx_tuple__61 = PyTuple_Pack(1, __pyx_kp_s_strided_and_direct); if (unlikely(!__pyx_tuple__61)) __PYX_ERR(1, 288, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__61);
+  __Pyx_GIVEREF(__pyx_tuple__61);
 
-  /* "View.MemoryView":288
+  /* "View.MemoryView":289
  * cdef generic = Enum("<strided and direct or indirect>")
  * cdef strided = Enum("<strided and direct>") # default
  * cdef indirect = Enum("<strided and indirect>")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_tuple__54 = PyTuple_Pack(1, __pyx_kp_s_strided_and_indirect); if (unlikely(!__pyx_tuple__54)) __PYX_ERR(1, 288, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__54);
-  __Pyx_GIVEREF(__pyx_tuple__54);
+  __pyx_tuple__62 = PyTuple_Pack(1, __pyx_kp_s_strided_and_indirect); if (unlikely(!__pyx_tuple__62)) __PYX_ERR(1, 289, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__62);
+  __Pyx_GIVEREF(__pyx_tuple__62);
 
-  /* "View.MemoryView":291
+  /* "View.MemoryView":292
  * 
  * 
  * cdef contiguous = Enum("<contiguous and direct>")             # <<<<<<<<<<<<<<
  * cdef indirect_contiguous = Enum("<contiguous and indirect>")
  * 
  */
-  __pyx_tuple__55 = PyTuple_Pack(1, __pyx_kp_s_contiguous_and_direct); if (unlikely(!__pyx_tuple__55)) __PYX_ERR(1, 291, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__55);
-  __Pyx_GIVEREF(__pyx_tuple__55);
+  __pyx_tuple__63 = PyTuple_Pack(1, __pyx_kp_s_contiguous_and_direct); if (unlikely(!__pyx_tuple__63)) __PYX_ERR(1, 292, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__63);
+  __Pyx_GIVEREF(__pyx_tuple__63);
 
-  /* "View.MemoryView":292
+  /* "View.MemoryView":293
  * 
  * cdef contiguous = Enum("<contiguous and direct>")
  * cdef indirect_contiguous = Enum("<contiguous and indirect>")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_tuple__56 = PyTuple_Pack(1, __pyx_kp_s_contiguous_and_indirect); if (unlikely(!__pyx_tuple__56)) __PYX_ERR(1, 292, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__56);
-  __Pyx_GIVEREF(__pyx_tuple__56);
+  __pyx_tuple__64 = PyTuple_Pack(1, __pyx_kp_s_contiguous_and_indirect); if (unlikely(!__pyx_tuple__64)) __PYX_ERR(1, 293, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__64);
+  __Pyx_GIVEREF(__pyx_tuple__64);
 
   /* "(tree fragment)":1
  * def __pyx_unpickle_Enum(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
-  __pyx_tuple__57 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__57)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__57);
-  __Pyx_GIVEREF(__pyx_tuple__57);
-  __pyx_codeobj__58 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__57, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_Enum, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__58)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __pyx_tuple__65 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__65)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_tuple__65);
+  __Pyx_GIVEREF(__pyx_tuple__65);
+  __pyx_codeobj__66 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__65, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_Enum, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__66)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_RefNannyFinishContext();
   return -1;
 }
 
 static CYTHON_SMALL_CODE int __Pyx_InitGlobals(void) {
-  if (__Pyx_InitStrings(__pyx_string_tab) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  if (__Pyx_InitStrings(__pyx_string_tab) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_float_0_1 = PyFloat_FromDouble(0.1); if (unlikely(!__pyx_float_0_1)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_float_0_9 = PyFloat_FromDouble(0.9); if (unlikely(!__pyx_float_0_9)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_float_0_25 = PyFloat_FromDouble(0.25); if (unlikely(!__pyx_float_0_25)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_float_1Eneg_6 = PyFloat_FromDouble(1E-6); if (unlikely(!__pyx_float_1Eneg_6)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_float_0_001 = PyFloat_FromDouble(0.001); if (unlikely(!__pyx_float_0_001)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_float_1Eneg_10 = PyFloat_FromDouble(1E-10); if (unlikely(!__pyx_float_1Eneg_10)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_0 = PyInt_FromLong(0); if (unlikely(!__pyx_int_0)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_1 = PyInt_FromLong(1); if (unlikely(!__pyx_int_1)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_2 = PyInt_FromLong(2); if (unlikely(!__pyx_int_2)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_3 = PyInt_FromLong(3); if (unlikely(!__pyx_int_3)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_10 = PyInt_FromLong(10); if (unlikely(!__pyx_int_10)) __PYX_ERR(0, 1, __pyx_L1_error)
-  __pyx_int_27919597 = PyInt_FromLong(27919597L); if (unlikely(!__pyx_int_27919597)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_40710769 = PyInt_FromLong(40710769L); if (unlikely(!__pyx_int_40710769)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_47058919 = PyInt_FromLong(47058919L); if (unlikely(!__pyx_int_47058919)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_51357075 = PyInt_FromLong(51357075L); if (unlikely(!__pyx_int_51357075)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_65594335 = PyInt_FromLong(65594335L); if (unlikely(!__pyx_int_65594335)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_77082683 = PyInt_FromLong(77082683L); if (unlikely(!__pyx_int_77082683)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_81125043 = PyInt_FromLong(81125043L); if (unlikely(!__pyx_int_81125043)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_107924309 = PyInt_FromLong(107924309L); if (unlikely(!__pyx_int_107924309)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_112105877 = PyInt_FromLong(112105877L); if (unlikely(!__pyx_int_112105877)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_136983863 = PyInt_FromLong(136983863L); if (unlikely(!__pyx_int_136983863)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_137247451 = PyInt_FromLong(137247451L); if (unlikely(!__pyx_int_137247451)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_157128468 = PyInt_FromLong(157128468L); if (unlikely(!__pyx_int_157128468)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_172575680 = PyInt_FromLong(172575680L); if (unlikely(!__pyx_int_172575680)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_184977713 = PyInt_FromLong(184977713L); if (unlikely(!__pyx_int_184977713)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_186858192 = PyInt_FromLong(186858192L); if (unlikely(!__pyx_int_186858192)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_219249325 = PyInt_FromLong(219249325L); if (unlikely(!__pyx_int_219249325)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_neg_1 = PyInt_FromLong(-1); if (unlikely(!__pyx_int_neg_1)) __PYX_ERR(0, 1, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 
 static CYTHON_SMALL_CODE int __Pyx_modinit_global_init_code(void); /*proto*/
@@ -34572,150 +36551,143 @@
   /*--- Function export code ---*/
   __Pyx_RefNannyFinishContext();
   return 0;
 }
 
 static int __Pyx_modinit_type_init_code(void) {
   __Pyx_RefNannyDeclarations
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_init_code", 0);
   /*--- Type init code ---*/
-  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_Kernel) < 0) __PYX_ERR(0, 47, __pyx_L1_error)
+  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_Kernel) < 0) __PYX_ERR(0, 50, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
   __pyx_type_6tkwant_7onebody_7kernels_Kernel.tp_print = 0;
+  #endif
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7kernels_Kernel.tp_dictoffset && __pyx_type_6tkwant_7onebody_7kernels_Kernel.tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_type_6tkwant_7onebody_7kernels_Kernel.tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_Kernel, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_Kernel) < 0) __PYX_ERR(0, 47, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_Kernel) < 0) __PYX_ERR(0, 47, __pyx_L1_error)
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_Kernel, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_Kernel) < 0) __PYX_ERR(0, 50, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_Kernel) < 0) __PYX_ERR(0, 50, __pyx_L1_error)
   __pyx_ptype_6tkwant_7onebody_7kernels_Kernel = &__pyx_type_6tkwant_7onebody_7kernels_Kernel;
-  __pyx_type_6tkwant_7onebody_7kernels_CKernel.tp_base = __pyx_ptype_6tkwant_7onebody_7kernels_Kernel;
-  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_CKernel) < 0) __PYX_ERR(0, 73, __pyx_L1_error)
-  __pyx_type_6tkwant_7onebody_7kernels_CKernel.tp_print = 0;
-  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7kernels_CKernel.tp_dictoffset && __pyx_type_6tkwant_7onebody_7kernels_CKernel.tp_getattro == PyObject_GenericGetAttr)) {
-    __pyx_type_6tkwant_7onebody_7kernels_CKernel.tp_getattro = __Pyx_PyObject_GenericGetAttr;
-  }
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_CKernel, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_CKernel) < 0) __PYX_ERR(0, 73, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_CKernel) < 0) __PYX_ERR(0, 73, __pyx_L1_error)
-  __pyx_ptype_6tkwant_7onebody_7kernels_CKernel = &__pyx_type_6tkwant_7onebody_7kernels_CKernel;
-  __pyx_type_6tkwant_7onebody_7kernels_PyCKernel.tp_base = __pyx_ptype_6tkwant_7onebody_7kernels_CKernel;
-  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_PyCKernel) < 0) __PYX_ERR(0, 102, __pyx_L1_error)
-  __pyx_type_6tkwant_7onebody_7kernels_PyCKernel.tp_print = 0;
-  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7kernels_PyCKernel.tp_dictoffset && __pyx_type_6tkwant_7onebody_7kernels_PyCKernel.tp_getattro == PyObject_GenericGetAttr)) {
-    __pyx_type_6tkwant_7onebody_7kernels_PyCKernel.tp_getattro = __Pyx_PyObject_GenericGetAttr;
-  }
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_PyCKernel, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_PyCKernel) < 0) __PYX_ERR(0, 102, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_PyCKernel) < 0) __PYX_ERR(0, 102, __pyx_L1_error)
-  __pyx_ptype_6tkwant_7onebody_7kernels_PyCKernel = &__pyx_type_6tkwant_7onebody_7kernels_PyCKernel;
-  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor) < 0) __PYX_ERR(0, 262, __pyx_L1_error)
+  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_Interpolation) < 0) __PYX_ERR(0, 240, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
+  __pyx_type_6tkwant_7onebody_7kernels_Interpolation.tp_print = 0;
+  #endif
+  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7kernels_Interpolation.tp_dictoffset && __pyx_type_6tkwant_7onebody_7kernels_Interpolation.tp_getattro == PyObject_GenericGetAttr)) {
+    __pyx_type_6tkwant_7onebody_7kernels_Interpolation.tp_getattro = __Pyx_PyObject_GenericGetAttr;
+  }
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_Interpolation, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_Interpolation) < 0) __PYX_ERR(0, 240, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_Interpolation) < 0) __PYX_ERR(0, 240, __pyx_L1_error)
+  __pyx_ptype_6tkwant_7onebody_7kernels_Interpolation = &__pyx_type_6tkwant_7onebody_7kernels_Interpolation;
+  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor) < 0) __PYX_ERR(0, 427, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
   __pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor.tp_print = 0;
+  #endif
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor.tp_dictoffset && __pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor.tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor.tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_PerturbationExtractor, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor) < 0) __PYX_ERR(0, 262, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor) < 0) __PYX_ERR(0, 262, __pyx_L1_error)
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_PerturbationExtractor, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor) < 0) __PYX_ERR(0, 427, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor) < 0) __PYX_ERR(0, 427, __pyx_L1_error)
   __pyx_ptype_6tkwant_7onebody_7kernels_PerturbationExtractor = &__pyx_type_6tkwant_7onebody_7kernels_PerturbationExtractor;
-  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator) < 0) __PYX_ERR(0, 495, __pyx_L1_error)
+  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator) < 0) __PYX_ERR(0, 663, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
   __pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator.tp_print = 0;
+  #endif
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator.tp_dictoffset && __pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator.tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator.tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_PerturbationInterpolator, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator) < 0) __PYX_ERR(0, 495, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator) < 0) __PYX_ERR(0, 495, __pyx_L1_error)
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_PerturbationInterpolator, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator) < 0) __PYX_ERR(0, 663, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator) < 0) __PYX_ERR(0, 663, __pyx_L1_error)
   __pyx_ptype_6tkwant_7onebody_7kernels_PerturbationInterpolator = &__pyx_type_6tkwant_7onebody_7kernels_PerturbationInterpolator;
-  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels__CSRMatrix) < 0) __PYX_ERR(0, 827, __pyx_L1_error)
-  __pyx_type_6tkwant_7onebody_7kernels__CSRMatrix.tp_print = 0;
-  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7kernels__CSRMatrix.tp_dictoffset && __pyx_type_6tkwant_7onebody_7kernels__CSRMatrix.tp_getattro == PyObject_GenericGetAttr)) {
-    __pyx_type_6tkwant_7onebody_7kernels__CSRMatrix.tp_getattro = __Pyx_PyObject_GenericGetAttr;
-  }
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_CSRMatrix, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels__CSRMatrix) < 0) __PYX_ERR(0, 827, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels__CSRMatrix) < 0) __PYX_ERR(0, 827, __pyx_L1_error)
-  __pyx_ptype_6tkwant_7onebody_7kernels__CSRMatrix = &__pyx_type_6tkwant_7onebody_7kernels__CSRMatrix;
-  __pyx_vtabptr_6tkwant_7onebody_7kernels_Simple = &__pyx_vtable_6tkwant_7onebody_7kernels_Simple;
-  __pyx_vtable_6tkwant_7onebody_7kernels_Simple._rhs = (void (*)(void const *, __pyx_t_double_complex const *, __pyx_t_double_complex *, double))__pyx_f_6tkwant_7onebody_7kernels_6Simple__rhs;
-  __pyx_type_6tkwant_7onebody_7kernels_Simple.tp_base = __pyx_ptype_6tkwant_7onebody_7kernels_CKernel;
-  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_Simple) < 0) __PYX_ERR(0, 857, __pyx_L1_error)
+  __pyx_type_6tkwant_7onebody_7kernels_Simple.tp_base = __pyx_ptype_6tkwant_7onebody_7kernels_Kernel;
+  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels_Simple) < 0) __PYX_ERR(0, 829, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
   __pyx_type_6tkwant_7onebody_7kernels_Simple.tp_print = 0;
+  #endif
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7kernels_Simple.tp_dictoffset && __pyx_type_6tkwant_7onebody_7kernels_Simple.tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_type_6tkwant_7onebody_7kernels_Simple.tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
-  if (__Pyx_SetVtable(__pyx_type_6tkwant_7onebody_7kernels_Simple.tp_dict, __pyx_vtabptr_6tkwant_7onebody_7kernels_Simple) < 0) __PYX_ERR(0, 857, __pyx_L1_error)
-  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_Simple, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_Simple) < 0) __PYX_ERR(0, 857, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_Simple) < 0) __PYX_ERR(0, 857, __pyx_L1_error)
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_Simple, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels_Simple) < 0) __PYX_ERR(0, 829, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7kernels_Simple) < 0) __PYX_ERR(0, 829, __pyx_L1_error)
   __pyx_ptype_6tkwant_7onebody_7kernels_Simple = &__pyx_type_6tkwant_7onebody_7kernels_Simple;
+  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7kernels__CalcRHSc) < 0) __PYX_ERR(0, 901, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
+  __pyx_type_6tkwant_7onebody_7kernels__CalcRHSc.tp_print = 0;
+  #endif
+  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7kernels__CalcRHSc.tp_dictoffset && __pyx_type_6tkwant_7onebody_7kernels__CalcRHSc.tp_getattro == PyObject_GenericGetAttr)) {
+    __pyx_type_6tkwant_7onebody_7kernels__CalcRHSc.tp_getattro = __Pyx_PyObject_GenericGetAttr;
+  }
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_CalcRHSc, (PyObject *)&__pyx_type_6tkwant_7onebody_7kernels__CalcRHSc) < 0) __PYX_ERR(0, 901, __pyx_L1_error)
+  __pyx_ptype_6tkwant_7onebody_7kernels__CalcRHSc = &__pyx_type_6tkwant_7onebody_7kernels__CalcRHSc;
   __pyx_vtabptr_array = &__pyx_vtable_array;
   __pyx_vtable_array.get_memview = (PyObject *(*)(struct __pyx_array_obj *))__pyx_array_get_memview;
-  if (PyType_Ready(&__pyx_type___pyx_array) < 0) __PYX_ERR(1, 105, __pyx_L1_error)
+  if (PyType_Ready(&__pyx_type___pyx_array) < 0) __PYX_ERR(1, 106, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
   __pyx_type___pyx_array.tp_print = 0;
-  if (__Pyx_SetVtable(__pyx_type___pyx_array.tp_dict, __pyx_vtabptr_array) < 0) __PYX_ERR(1, 105, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type___pyx_array) < 0) __PYX_ERR(1, 105, __pyx_L1_error)
+  #endif
+  if (__Pyx_SetVtable(__pyx_type___pyx_array.tp_dict, __pyx_vtabptr_array) < 0) __PYX_ERR(1, 106, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type___pyx_array) < 0) __PYX_ERR(1, 106, __pyx_L1_error)
   __pyx_array_type = &__pyx_type___pyx_array;
-  if (PyType_Ready(&__pyx_type___pyx_MemviewEnum) < 0) __PYX_ERR(1, 279, __pyx_L1_error)
+  if (PyType_Ready(&__pyx_type___pyx_MemviewEnum) < 0) __PYX_ERR(1, 280, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
   __pyx_type___pyx_MemviewEnum.tp_print = 0;
+  #endif
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type___pyx_MemviewEnum.tp_dictoffset && __pyx_type___pyx_MemviewEnum.tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_type___pyx_MemviewEnum.tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type___pyx_MemviewEnum) < 0) __PYX_ERR(1, 279, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type___pyx_MemviewEnum) < 0) __PYX_ERR(1, 280, __pyx_L1_error)
   __pyx_MemviewEnum_type = &__pyx_type___pyx_MemviewEnum;
   __pyx_vtabptr_memoryview = &__pyx_vtable_memoryview;
   __pyx_vtable_memoryview.get_item_pointer = (char *(*)(struct __pyx_memoryview_obj *, PyObject *))__pyx_memoryview_get_item_pointer;
   __pyx_vtable_memoryview.is_slice = (PyObject *(*)(struct __pyx_memoryview_obj *, PyObject *))__pyx_memoryview_is_slice;
   __pyx_vtable_memoryview.setitem_slice_assignment = (PyObject *(*)(struct __pyx_memoryview_obj *, PyObject *, PyObject *))__pyx_memoryview_setitem_slice_assignment;
   __pyx_vtable_memoryview.setitem_slice_assign_scalar = (PyObject *(*)(struct __pyx_memoryview_obj *, struct __pyx_memoryview_obj *, PyObject *))__pyx_memoryview_setitem_slice_assign_scalar;
   __pyx_vtable_memoryview.setitem_indexed = (PyObject *(*)(struct __pyx_memoryview_obj *, PyObject *, PyObject *))__pyx_memoryview_setitem_indexed;
   __pyx_vtable_memoryview.convert_item_to_object = (PyObject *(*)(struct __pyx_memoryview_obj *, char *))__pyx_memoryview_convert_item_to_object;
   __pyx_vtable_memoryview.assign_item_from_object = (PyObject *(*)(struct __pyx_memoryview_obj *, char *, PyObject *))__pyx_memoryview_assign_item_from_object;
-  if (PyType_Ready(&__pyx_type___pyx_memoryview) < 0) __PYX_ERR(1, 330, __pyx_L1_error)
+  if (PyType_Ready(&__pyx_type___pyx_memoryview) < 0) __PYX_ERR(1, 331, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
   __pyx_type___pyx_memoryview.tp_print = 0;
+  #endif
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type___pyx_memoryview.tp_dictoffset && __pyx_type___pyx_memoryview.tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_type___pyx_memoryview.tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
-  if (__Pyx_SetVtable(__pyx_type___pyx_memoryview.tp_dict, __pyx_vtabptr_memoryview) < 0) __PYX_ERR(1, 330, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type___pyx_memoryview) < 0) __PYX_ERR(1, 330, __pyx_L1_error)
+  if (__Pyx_SetVtable(__pyx_type___pyx_memoryview.tp_dict, __pyx_vtabptr_memoryview) < 0) __PYX_ERR(1, 331, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type___pyx_memoryview) < 0) __PYX_ERR(1, 331, __pyx_L1_error)
   __pyx_memoryview_type = &__pyx_type___pyx_memoryview;
   __pyx_vtabptr__memoryviewslice = &__pyx_vtable__memoryviewslice;
   __pyx_vtable__memoryviewslice.__pyx_base = *__pyx_vtabptr_memoryview;
   __pyx_vtable__memoryviewslice.__pyx_base.convert_item_to_object = (PyObject *(*)(struct __pyx_memoryview_obj *, char *))__pyx_memoryviewslice_convert_item_to_object;
   __pyx_vtable__memoryviewslice.__pyx_base.assign_item_from_object = (PyObject *(*)(struct __pyx_memoryview_obj *, char *, PyObject *))__pyx_memoryviewslice_assign_item_from_object;
   __pyx_type___pyx_memoryviewslice.tp_base = __pyx_memoryview_type;
-  if (PyType_Ready(&__pyx_type___pyx_memoryviewslice) < 0) __PYX_ERR(1, 961, __pyx_L1_error)
+  if (PyType_Ready(&__pyx_type___pyx_memoryviewslice) < 0) __PYX_ERR(1, 967, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
   __pyx_type___pyx_memoryviewslice.tp_print = 0;
+  #endif
   if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type___pyx_memoryviewslice.tp_dictoffset && __pyx_type___pyx_memoryviewslice.tp_getattro == PyObject_GenericGetAttr)) {
     __pyx_type___pyx_memoryviewslice.tp_getattro = __Pyx_PyObject_GenericGetAttr;
   }
-  if (__Pyx_SetVtable(__pyx_type___pyx_memoryviewslice.tp_dict, __pyx_vtabptr__memoryviewslice) < 0) __PYX_ERR(1, 961, __pyx_L1_error)
-  if (__Pyx_setup_reduce((PyObject*)&__pyx_type___pyx_memoryviewslice) < 0) __PYX_ERR(1, 961, __pyx_L1_error)
+  if (__Pyx_SetVtable(__pyx_type___pyx_memoryviewslice.tp_dict, __pyx_vtabptr__memoryviewslice) < 0) __PYX_ERR(1, 967, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type___pyx_memoryviewslice) < 0) __PYX_ERR(1, 967, __pyx_L1_error)
   __pyx_memoryviewslice_type = &__pyx_type___pyx_memoryviewslice;
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_RefNannyFinishContext();
   return -1;
 }
 
 static int __Pyx_modinit_type_import_code(void) {
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_import_code", 0);
   /*--- Type import code ---*/
-  __pyx_t_1 = PyImport_ImportModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_t_1)) __PYX_ERR(3, 9, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_ptype_7cpython_4type_type = __Pyx_ImportType(__pyx_t_1, __Pyx_BUILTIN_MODULE_NAME, "type", 
-  #if defined(PYPY_VERSION_NUM) && PYPY_VERSION_NUM < 0x050B0000
-  sizeof(PyTypeObject),
-  #else
-  sizeof(PyHeapTypeObject),
-  #endif
-  __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_7cpython_4type_type) __PYX_ERR(3, 9, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_RefNannyFinishContext();
   return 0;
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_RefNannyFinishContext();
-  return -1;
 }
 
 static int __Pyx_modinit_variable_import_code(void) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__Pyx_modinit_variable_import_code", 0);
   /*--- Variable import code ---*/
   __Pyx_RefNannyFinishContext();
@@ -34727,25 +36699,27 @@
   __Pyx_RefNannySetupContext("__Pyx_modinit_function_import_code", 0);
   /*--- Function import code ---*/
   __Pyx_RefNannyFinishContext();
   return 0;
 }
 
 
-#if PY_MAJOR_VERSION < 3
-#ifdef CYTHON_NO_PYINIT_EXPORT
-#define __Pyx_PyMODINIT_FUNC void
-#else
+#ifndef CYTHON_NO_PYINIT_EXPORT
 #define __Pyx_PyMODINIT_FUNC PyMODINIT_FUNC
+#elif PY_MAJOR_VERSION < 3
+#ifdef __cplusplus
+#define __Pyx_PyMODINIT_FUNC extern "C" void
+#else
+#define __Pyx_PyMODINIT_FUNC void
 #endif
 #else
-#ifdef CYTHON_NO_PYINIT_EXPORT
-#define __Pyx_PyMODINIT_FUNC PyObject *
+#ifdef __cplusplus
+#define __Pyx_PyMODINIT_FUNC extern "C" PyObject *
 #else
-#define __Pyx_PyMODINIT_FUNC PyMODINIT_FUNC
+#define __Pyx_PyMODINIT_FUNC PyObject *
 #endif
 #endif
 
 
 #if PY_MAJOR_VERSION < 3
 __Pyx_PyMODINIT_FUNC initkernels(void) CYTHON_SMALL_CODE; /*proto*/
 __Pyx_PyMODINIT_FUNC initkernels(void)
@@ -34820,23 +36794,21 @@
 
 static CYTHON_SMALL_CODE int __pyx_pymod_exec_kernels(PyObject *__pyx_pyinit_module)
 #endif
 #endif
 {
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
-  __Pyx_memviewslice __pyx_t_3 = { 0, 0, { 0 }, { 0 }, { 0 } };
-  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_3 = NULL;
+  __Pyx_memviewslice __pyx_t_4 = { 0, 0, { 0 }, { 0 }, { 0 } };
   PyObject *__pyx_t_5 = NULL;
-  PyObject *__pyx_t_6 = NULL;
-  PyObject *__pyx_t_7 = NULL;
-  PyObject *__pyx_t_8 = NULL;
-  int __pyx_t_9;
-  int __pyx_t_10;
-  static PyThread_type_lock __pyx_t_11[8];
+  static PyThread_type_lock __pyx_t_6[8];
+  int __pyx_lineno = 0;
+  const char *__pyx_filename = NULL;
+  int __pyx_clineno = 0;
   __Pyx_RefNannyDeclarations
   #if CYTHON_PEP489_MULTI_PHASE_INIT
   if (__pyx_m) {
     if (__pyx_m == __pyx_pyinit_module) return 0;
     PyErr_SetString(PyExc_RuntimeError, "Module 'kernels' has already been imported. Re-initialisation is not supported.");
     return -1;
   }
@@ -34876,19 +36848,17 @@
   if (__pyx_AsyncGen_init() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   #ifdef __Pyx_StopAsyncIteration_USED
   if (__pyx_StopAsyncIteration_init() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   /*--- Library function declarations ---*/
   /*--- Threads initialization code ---*/
-  #if defined(__PYX_FORCE_INIT_THREADS) && __PYX_FORCE_INIT_THREADS
-  #ifdef WITH_THREAD /* Python build with threading support? */
+  #if defined(WITH_THREAD) && PY_VERSION_HEX < 0x030700F0 && defined(__PYX_FORCE_INIT_THREADS) && __PYX_FORCE_INIT_THREADS
   PyEval_InitThreads();
   #endif
-  #endif
   /*--- Module creation code ---*/
   #if CYTHON_PEP489_MULTI_PHASE_INIT
   __pyx_m = __pyx_pyinit_module;
   Py_INCREF(__pyx_m);
   #else
   #if PY_MAJOR_VERSION < 3
   __pyx_m = Py_InitModule4("kernels", __pyx_methods, __pyx_k_Calculating_the_right_hand_side, 0, PYTHON_API_VERSION); Py_XINCREF(__pyx_m);
@@ -34896,19 +36866,18 @@
   __pyx_m = PyModule_Create(&__pyx_moduledef);
   #endif
   if (unlikely(!__pyx_m)) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   __pyx_d = PyModule_GetDict(__pyx_m); if (unlikely(!__pyx_d)) __PYX_ERR(0, 1, __pyx_L1_error)
   Py_INCREF(__pyx_d);
   __pyx_b = PyImport_AddModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_b)) __PYX_ERR(0, 1, __pyx_L1_error)
-  __pyx_cython_runtime = PyImport_AddModule((char *) "cython_runtime"); if (unlikely(!__pyx_cython_runtime)) __PYX_ERR(0, 1, __pyx_L1_error)
-  #if CYTHON_COMPILING_IN_PYPY
   Py_INCREF(__pyx_b);
-  #endif
-  if (PyObject_SetAttrString(__pyx_m, "__builtins__", __pyx_b) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
+  __pyx_cython_runtime = PyImport_AddModule((char *) "cython_runtime"); if (unlikely(!__pyx_cython_runtime)) __PYX_ERR(0, 1, __pyx_L1_error)
+  Py_INCREF(__pyx_cython_runtime);
+  if (PyObject_SetAttrString(__pyx_m, "__builtins__", __pyx_b) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   /*--- Initialize various global constants etc. ---*/
   if (__Pyx_InitGlobals() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #if PY_MAJOR_VERSION < 3 && (__PYX_DEFAULT_STRING_ENCODING_IS_ASCII || __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT)
   if (__Pyx_init_sys_getdefaultencoding_params() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   if (__pyx_module_is_main_tkwant__onebody__kernels) {
     if (PyObject_SetAttr(__pyx_m, __pyx_n_s_name_2, __pyx_n_s_main) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
@@ -34925,102 +36894,103 @@
   if (__Pyx_InitCachedBuiltins() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   /*--- Constants init code ---*/
   if (__Pyx_InitCachedConstants() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   /*--- Global type/function init code ---*/
   (void)__Pyx_modinit_global_init_code();
   (void)__Pyx_modinit_variable_export_code();
   (void)__Pyx_modinit_function_export_code();
-  if (unlikely(__Pyx_modinit_type_init_code() != 0)) goto __pyx_L1_error;
-  if (unlikely(__Pyx_modinit_type_import_code() != 0)) goto __pyx_L1_error;
+  if (unlikely(__Pyx_modinit_type_init_code() < 0)) __PYX_ERR(0, 1, __pyx_L1_error)
+  (void)__Pyx_modinit_type_import_code();
   (void)__Pyx_modinit_variable_import_code();
   (void)__Pyx_modinit_function_import_code();
   /*--- Execution code ---*/
   #if defined(__Pyx_Generator_USED) || defined(__Pyx_Coroutine_USED)
   if (__Pyx_patch_abc() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
 
-  /* "tkwant/onebody/kernels.pyx":33
+  /* "tkwant/onebody/kernels.pyx":34
  * """
  * 
- * __all__ = ['Kernel', 'CKernel', 'Scipy', 'Simple',             # <<<<<<<<<<<<<<
- *            'extract_c_kernel', 'default', 'PerturbationExtractor',
+ * __all__ = ['Kernel', 'Scipy', 'Simple',             # <<<<<<<<<<<<<<
+ *            'default', 'PerturbationExtractor',
  *            'PerturbationInterpolator']
  */
-  __pyx_t_1 = PyList_New(8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 33, __pyx_L1_error)
+  __pyx_t_1 = PyList_New(6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 34, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_INCREF(__pyx_n_u_Kernel);
   __Pyx_GIVEREF(__pyx_n_u_Kernel);
   PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_u_Kernel);
-  __Pyx_INCREF(__pyx_n_u_CKernel);
-  __Pyx_GIVEREF(__pyx_n_u_CKernel);
-  PyList_SET_ITEM(__pyx_t_1, 1, __pyx_n_u_CKernel);
   __Pyx_INCREF(__pyx_n_u_Scipy);
   __Pyx_GIVEREF(__pyx_n_u_Scipy);
-  PyList_SET_ITEM(__pyx_t_1, 2, __pyx_n_u_Scipy);
+  PyList_SET_ITEM(__pyx_t_1, 1, __pyx_n_u_Scipy);
   __Pyx_INCREF(__pyx_n_u_Simple);
   __Pyx_GIVEREF(__pyx_n_u_Simple);
-  PyList_SET_ITEM(__pyx_t_1, 3, __pyx_n_u_Simple);
-  __Pyx_INCREF(__pyx_n_u_extract_c_kernel);
-  __Pyx_GIVEREF(__pyx_n_u_extract_c_kernel);
-  PyList_SET_ITEM(__pyx_t_1, 4, __pyx_n_u_extract_c_kernel);
+  PyList_SET_ITEM(__pyx_t_1, 2, __pyx_n_u_Simple);
   __Pyx_INCREF(__pyx_n_u_default);
   __Pyx_GIVEREF(__pyx_n_u_default);
-  PyList_SET_ITEM(__pyx_t_1, 5, __pyx_n_u_default);
+  PyList_SET_ITEM(__pyx_t_1, 3, __pyx_n_u_default);
   __Pyx_INCREF(__pyx_n_u_PerturbationExtractor);
   __Pyx_GIVEREF(__pyx_n_u_PerturbationExtractor);
-  PyList_SET_ITEM(__pyx_t_1, 6, __pyx_n_u_PerturbationExtractor);
+  PyList_SET_ITEM(__pyx_t_1, 4, __pyx_n_u_PerturbationExtractor);
   __Pyx_INCREF(__pyx_n_u_PerturbationInterpolator);
   __Pyx_GIVEREF(__pyx_n_u_PerturbationInterpolator);
-  PyList_SET_ITEM(__pyx_t_1, 7, __pyx_n_u_PerturbationInterpolator);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_all, __pyx_t_1) < 0) __PYX_ERR(0, 33, __pyx_L1_error)
+  PyList_SET_ITEM(__pyx_t_1, 5, __pyx_n_u_PerturbationInterpolator);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_all, __pyx_t_1) < 0) __PYX_ERR(0, 34, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":37
+  /* "tkwant/onebody/kernels.pyx":38
  *            'PerturbationInterpolator']
  * 
  * import numpy as np             # <<<<<<<<<<<<<<
  * import cython
- * from cpython.ref cimport Py_INCREF, Py_DECREF
+ * from .. import _common, system, _logging
  */
-  __pyx_t_1 = __Pyx_Import(__pyx_n_s_numpy, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 37, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_Import(__pyx_n_s_numpy, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 38, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_1) < 0) __PYX_ERR(0, 37, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_1) < 0) __PYX_ERR(0, 38, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
   /* "tkwant/onebody/kernels.pyx":40
+ * import numpy as np
  * import cython
- * from cpython.ref cimport Py_INCREF, Py_DECREF
- * from .. import _common, system             # <<<<<<<<<<<<<<
+ * from .. import _common, system, _logging             # <<<<<<<<<<<<<<
  * from scipy.sparse._sparsetools import coo_matvec, csr_matvec
  * import scipy.sparse as sp
  */
-  __pyx_t_1 = PyList_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 40, __pyx_L1_error)
+  __pyx_t_1 = PyList_New(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 40, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   __Pyx_INCREF(__pyx_n_s_common);
   __Pyx_GIVEREF(__pyx_n_s_common);
   PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_s_common);
   __Pyx_INCREF(__pyx_n_s_system);
   __Pyx_GIVEREF(__pyx_n_s_system);
   PyList_SET_ITEM(__pyx_t_1, 1, __pyx_n_s_system);
-  __pyx_t_2 = __Pyx_Import(__pyx_n_s__32, __pyx_t_1, 2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 40, __pyx_L1_error)
+  __Pyx_INCREF(__pyx_n_s_logging);
+  __Pyx_GIVEREF(__pyx_n_s_logging);
+  PyList_SET_ITEM(__pyx_t_1, 2, __pyx_n_s_logging);
+  __pyx_t_2 = __Pyx_Import(__pyx_n_s__33, __pyx_t_1, 2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 40, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_t_1 = __Pyx_ImportFrom(__pyx_t_2, __pyx_n_s_common); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 40, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_common, __pyx_t_1) < 0) __PYX_ERR(0, 40, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __pyx_t_1 = __Pyx_ImportFrom(__pyx_t_2, __pyx_n_s_system); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 40, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_system, __pyx_t_1) < 0) __PYX_ERR(0, 40, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_t_1 = __Pyx_ImportFrom(__pyx_t_2, __pyx_n_s_logging); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 40, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_logging, __pyx_t_1) < 0) __PYX_ERR(0, 40, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /* "tkwant/onebody/kernels.pyx":41
- * from cpython.ref cimport Py_INCREF, Py_DECREF
- * from .. import _common, system
+ * import cython
+ * from .. import _common, system, _logging
  * from scipy.sparse._sparsetools import coo_matvec, csr_matvec             # <<<<<<<<<<<<<<
  * import scipy.sparse as sp
  * 
  */
   __pyx_t_2 = PyList_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 41, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_INCREF(__pyx_n_s_coo_matvec);
@@ -35039,490 +37009,467 @@
   __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_1, __pyx_n_s_csr_matvec); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 41, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_csr_matvec, __pyx_t_2) < 0) __PYX_ERR(0, 41, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
   /* "tkwant/onebody/kernels.pyx":42
- * from .. import _common, system
+ * from .. import _common, system, _logging
  * from scipy.sparse._sparsetools import coo_matvec, csr_matvec
  * import scipy.sparse as sp             # <<<<<<<<<<<<<<
  * 
  * 
  */
   __pyx_t_1 = PyList_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 42, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_INCREF(__pyx_n_s__36);
-  __Pyx_GIVEREF(__pyx_n_s__36);
-  PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_s__36);
+  __Pyx_INCREF(__pyx_n_s__37);
+  __Pyx_GIVEREF(__pyx_n_s__37);
+  PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_s__37);
   __pyx_t_2 = __Pyx_Import(__pyx_n_s_scipy_sparse, __pyx_t_1, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 42, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_sp, __pyx_t_2) < 0) __PYX_ERR(0, 42, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":59
+  /* "tkwant/onebody/kernels.pyx":46
+ * 
+ * # set module logger
+ * logger = _logging.make_logger(name=__name__)             # <<<<<<<<<<<<<<
+ * 
+ * ########## Abstract Base Classes for kernels
+ */
+  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_logging); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_make_logger); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_t_2 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_name_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_t_2, __pyx_n_s_name, __pyx_t_3) < 0) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_3 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_empty_tuple, __pyx_t_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_logger, __pyx_t_3) < 0) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+
+  /* "tkwant/onebody/kernels.pyx":60
  *     """
  * 
- *     def __init__(self, H0, W, params, complex[:] psi_st=None):             # <<<<<<<<<<<<<<
+ *     def __init__(self, H0, W, complex[:] psi_st=None, complex[:] work=None):             # <<<<<<<<<<<<<<
  *         raise NotImplementedError()
  * 
  */
-  __pyx_t_3 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(Py_None, PyBUF_WRITABLE); if (unlikely(!__pyx_t_3.memview)) __PYX_ERR(0, 59, __pyx_L1_error)
-  __pyx_k_ = __pyx_t_3;
-  __pyx_t_3.memview = NULL;
-  __pyx_t_3.data = NULL;
+  __pyx_t_4 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(Py_None, PyBUF_WRITABLE); if (unlikely(!__pyx_t_4.memview)) __PYX_ERR(0, 60, __pyx_L1_error)
+  __pyx_k_ = __pyx_t_4;
+  __pyx_t_4.memview = NULL;
+  __pyx_t_4.data = NULL;
+  __pyx_t_4 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(Py_None, PyBUF_WRITABLE); if (unlikely(!__pyx_t_4.memview)) __PYX_ERR(0, 60, __pyx_L1_error)
+  __pyx_k__2 = __pyx_t_4;
+  __pyx_t_4.memview = NULL;
+  __pyx_t_4.data = NULL;
 
-  /* "tkwant/onebody/kernels.pyx":131
+  /* "tkwant/onebody/kernels.pyx":75
  * ########## Concrete kernel implementations
  * 
  * class Scipy(Kernel):             # <<<<<<<<<<<<<<
  *     """Evaluate the RHS of the Schrdinger equation using scipy sparse.
  * 
  */
-  __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 131, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 75, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
   __Pyx_INCREF(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Kernel));
   __Pyx_GIVEREF(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Kernel));
-  PyTuple_SET_ITEM(__pyx_t_2, 0, ((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Kernel));
-  __pyx_t_1 = __Pyx_CalculateMetaclass(NULL, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 131, __pyx_L1_error)
+  PyTuple_SET_ITEM(__pyx_t_3, 0, ((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Kernel));
+  __pyx_t_2 = __Pyx_CalculateMetaclass(NULL, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 75, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_1 = __Pyx_Py3MetaclassPrepare(__pyx_t_2, __pyx_t_3, __pyx_n_s_Scipy, __pyx_n_s_Scipy, (PyObject *) NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_kp_s_Evaluate_the_RHS_of_the_Schrding); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 75, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_4 = __Pyx_Py3MetaclassPrepare(__pyx_t_1, __pyx_t_2, __pyx_n_s_Scipy, __pyx_n_s_Scipy, (PyObject *) NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_kp_s_Evaluate_the_RHS_of_the_Schrding); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 131, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
 
-  /* "tkwant/onebody/kernels.pyx":167
+  /* "tkwant/onebody/kernels.pyx":103
  *     """
  * 
- *     def __init__(self, H0, W, params, psi_st=None):             # <<<<<<<<<<<<<<
- *         self.H0 = H0.tocsr()
- *         self.W = W
+ *     def __init__(self, H0, W, psi_st=None, work=None):             # <<<<<<<<<<<<<<
+ * 
+ *         if not isinstance(H0, sp.csr.csr_matrix):
  */
-  __pyx_t_5 = __Pyx_CyFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_1__init__, 0, __pyx_n_s_Scipy___init, NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_d, ((PyObject *)__pyx_codeobj__38)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 167, __pyx_L1_error)
+  __pyx_t_5 = __Pyx_CyFunction_New(&__pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_1__init__, 0, __pyx_n_s_Scipy___init, NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_d, ((PyObject *)__pyx_codeobj__39)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 103, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_5, __pyx_tuple__39);
-  if (__Pyx_SetNameInClass(__pyx_t_4, __pyx_n_s_init, __pyx_t_5) < 0) __PYX_ERR(0, 167, __pyx_L1_error)
+  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_5, __pyx_tuple__40);
+  if (__Pyx_SetNameInClass(__pyx_t_1, __pyx_n_s_init, __pyx_t_5) < 0) __PYX_ERR(0, 103, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":180
- *         self._tmp = np.zeros((self.size,), dtype=complex)
+  /* "tkwant/onebody/kernels.pyx":130
+ *             self._tmp = work
  * 
- *     def set_params(self, params):             # <<<<<<<<<<<<<<
- *         self.params = params
+ *     def rhs(self, energy=None):             # <<<<<<<<<<<<<<
  * 
+ *         if energy is None:
  */
-  __pyx_t_5 = __Pyx_CyFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_3set_params, 0, __pyx_n_s_Scipy_set_params, NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_d, ((PyObject *)__pyx_codeobj__41)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 180, __pyx_L1_error)
+  __pyx_t_5 = __Pyx_CyFunction_New(&__pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_3rhs, 0, __pyx_n_s_Scipy_rhs, NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_d, ((PyObject *)__pyx_codeobj__42)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 130, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  if (__Pyx_SetNameInClass(__pyx_t_4, __pyx_n_s_set_params, __pyx_t_5) < 0) __PYX_ERR(0, 180, __pyx_L1_error)
+  __Pyx_CyFunction_SetDefaultsTuple(__pyx_t_5, __pyx_tuple__43);
+  if (__Pyx_SetNameInClass(__pyx_t_1, __pyx_n_s_rhs, __pyx_t_5) < 0) __PYX_ERR(0, 130, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":183
- *         self.params = params
+  /* "tkwant/onebody/kernels.pyx":152
+ *         return _CalcRHS(H0, self.W, self.psi_st, self.size, self.center_size, self._tmp)
  * 
- *     def rhs(self, const complex[:] psi, complex[:] dpsidt, double time):             # <<<<<<<<<<<<<<
- *         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
- *         psi_centre = np.asarray(psi[:self.center_size])
+ *     def set_W(self, W):             # <<<<<<<<<<<<<<
+ *         '''Set the time dependent perturbation W(t)'''
+ *         self.W = W
  */
-  __pyx_t_5 = __Pyx_CyFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_5rhs, 0, __pyx_n_s_Scipy_rhs, NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_d, ((PyObject *)__pyx_codeobj__43)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 183, __pyx_L1_error)
+  __pyx_t_5 = __Pyx_CyFunction_New(&__pyx_mdef_6tkwant_7onebody_7kernels_5Scipy_5set_W, 0, __pyx_n_s_Scipy_set_W, NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_d, ((PyObject *)__pyx_codeobj__45)); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 152, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  if (__Pyx_SetNameInClass(__pyx_t_4, __pyx_n_s_rhs, __pyx_t_5) < 0) __PYX_ERR(0, 183, __pyx_L1_error)
+  if (__Pyx_SetNameInClass(__pyx_t_1, __pyx_n_s_set_W, __pyx_t_5) < 0) __PYX_ERR(0, 152, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":131
+  /* "tkwant/onebody/kernels.pyx":75
  * ########## Concrete kernel implementations
  * 
  * class Scipy(Kernel):             # <<<<<<<<<<<<<<
  *     """Evaluate the RHS of the Schrdinger equation using scipy sparse.
  * 
  */
-  __pyx_t_5 = __Pyx_Py3ClassCreate(__pyx_t_1, __pyx_n_s_Scipy, __pyx_t_2, __pyx_t_4, NULL, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 131, __pyx_L1_error)
+  __pyx_t_5 = __Pyx_Py3ClassCreate(__pyx_t_2, __pyx_n_s_Scipy, __pyx_t_3, __pyx_t_1, NULL, 0, 0); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 75, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_Scipy, __pyx_t_5) < 0) __PYX_ERR(0, 131, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_Scipy, __pyx_t_5) < 0) __PYX_ERR(0, 75, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":247
+  /* "tkwant/onebody/kernels.pyx":157
  * 
  * 
- * def _herm_conj(value):             # <<<<<<<<<<<<<<
- *     if hasattr(value, 'conjugate'):
- *         value = value.conjugate()
+ * class _CalcRHS:             # <<<<<<<<<<<<<<
+ *     """Calculate the right-hand-side of the time-dependent Schrdinger equation."""
+ *     def __init__(self, H0, W, psi_st, size, center_size, tmp):
+ */
+  __pyx_t_3 = __Pyx_Py3MetaclassPrepare((PyObject *) NULL, __pyx_empty_tuple, __pyx_n_s_CalcRHS, __pyx_n_s_CalcRHS, (PyObject *) NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_kp_s_Calculate_the_right_hand_side_of); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 157, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+
+  /* "tkwant/onebody/kernels.pyx":159
+ * class _CalcRHS:
+ *     """Calculate the right-hand-side of the time-dependent Schrdinger equation."""
+ *     def __init__(self, H0, W, psi_st, size, center_size, tmp):             # <<<<<<<<<<<<<<
+ * 
+ *         self.H0 = H0
  */
-  __pyx_t_2 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_3_herm_conj, NULL, __pyx_n_s_tkwant_onebody_kernels); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 247, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_6tkwant_7onebody_7kernels_8_CalcRHS_1__init__, 0, __pyx_n_s_CalcRHS___init, NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_d, ((PyObject *)__pyx_codeobj__47)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 159, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_herm_conj, __pyx_t_2) < 0) __PYX_ERR(0, 247, __pyx_L1_error)
+  if (__Pyx_SetNameInClass(__pyx_t_3, __pyx_n_s_init, __pyx_t_2) < 0) __PYX_ERR(0, 159, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":255
- * 
- * 
- * _errormsg = ('{0} vector has length {1}, but the system '             # <<<<<<<<<<<<<<
- *              'contains {2} orbitals')
+  /* "tkwant/onebody/kernels.pyx":170
+ *     @cython.boundscheck(False)
+ *     @cython.wraparound(False)
+ *     def __call__(self, const complex[:] psi, complex[:] dpsidt, const double time):             # <<<<<<<<<<<<<<
  * 
+ *         # H0 @ psi -> tmp
  */
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_errormsg, __pyx_kp_u_0_vector_has_length_1_but_the_s) < 0) __PYX_ERR(0, 255, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_CyFunction_New(&__pyx_mdef_6tkwant_7onebody_7kernels_8_CalcRHS_3__call__, 0, __pyx_n_s_CalcRHS___call, NULL, __pyx_n_s_tkwant_onebody_kernels, __pyx_d, ((PyObject *)__pyx_codeobj__49)); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 170, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (__Pyx_SetNameInClass(__pyx_t_3, __pyx_n_s_call, __pyx_t_2) < 0) __PYX_ERR(0, 170, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":869
- *         _CSRMatrix H0
+  /* "tkwant/onebody/kernels.pyx":157
  * 
- *     def __init__(self, H0, W, params, complex[:] psi_st=None):             # <<<<<<<<<<<<<<
- *         pass
  * 
+ * class _CalcRHS:             # <<<<<<<<<<<<<<
+ *     """Calculate the right-hand-side of the time-dependent Schrdinger equation."""
+ *     def __init__(self, H0, W, psi_st, size, center_size, tmp):
  */
-  __pyx_t_3 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(Py_None, PyBUF_WRITABLE); if (unlikely(!__pyx_t_3.memview)) __PYX_ERR(0, 869, __pyx_L1_error)
-  __pyx_k__9 = __pyx_t_3;
-  __pyx_t_3.memview = NULL;
-  __pyx_t_3.data = NULL;
+  __pyx_t_2 = __Pyx_Py3ClassCreate(((PyObject*)&__Pyx_DefaultClassType), __pyx_n_s_CalcRHS, __pyx_empty_tuple, __pyx_t_3, NULL, 0, 0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 157, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_CalcRHS, __pyx_t_2) < 0) __PYX_ERR(0, 157, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":875
- *         self.params = params
+  /* "tkwant/onebody/kernels.pyx":228
  * 
- *     def __cinit__(self, H0, W, params, complex[:] psi_st=None):             # <<<<<<<<<<<<<<
- *         self.c_self = <void*> self
- *         self.params = params
+ * 
+ * def _herm_conj(value):             # <<<<<<<<<<<<<<
+ *     if hasattr(value, 'conjugate'):
+ *         value = value.conjugate()
  */
-  __pyx_t_3 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(Py_None, PyBUF_WRITABLE); if (unlikely(!__pyx_t_3.memview)) __PYX_ERR(0, 875, __pyx_L1_error)
-  __pyx_k__10 = __pyx_t_3;
-  __pyx_t_3.memview = NULL;
-  __pyx_t_3.data = NULL;
+  __pyx_t_3 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_1_herm_conj, NULL, __pyx_n_s_tkwant_onebody_kernels); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 228, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_herm_conj, __pyx_t_3) < 0) __PYX_ERR(0, 228, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "tkwant/onebody/kernels.pyx":934
+  /* "tkwant/onebody/kernels.pyx":236
  * 
  * 
- * try:             # <<<<<<<<<<<<<<
- *     from ._sparse_blas_kernel import SparseBlas
- *     __all__.append('SparseBlas')
- */
-  {
-    __Pyx_PyThreadState_declare
-    __Pyx_PyThreadState_assign
-    __Pyx_ExceptionSave(&__pyx_t_6, &__pyx_t_7, &__pyx_t_8);
-    __Pyx_XGOTREF(__pyx_t_6);
-    __Pyx_XGOTREF(__pyx_t_7);
-    __Pyx_XGOTREF(__pyx_t_8);
-    /*try:*/ {
-
-      /* "tkwant/onebody/kernels.pyx":935
+ * _errormsg = ('{0} vector has length {1}, but the system '             # <<<<<<<<<<<<<<
+ *              'contains {2} orbitals')
  * 
- * try:
- *     from ._sparse_blas_kernel import SparseBlas             # <<<<<<<<<<<<<<
- *     __all__.append('SparseBlas')
- * except ImportError as e:
  */
-      __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 935, __pyx_L2_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_INCREF(__pyx_n_s_SparseBlas);
-      __Pyx_GIVEREF(__pyx_n_s_SparseBlas);
-      PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_SparseBlas);
-      __pyx_t_1 = __Pyx_Import(__pyx_n_s_sparse_blas_kernel, __pyx_t_2, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 935, __pyx_L2_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_1, __pyx_n_s_SparseBlas); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 935, __pyx_L2_error)
-      __Pyx_GOTREF(__pyx_t_2);
-      if (PyDict_SetItem(__pyx_d, __pyx_n_s_SparseBlas, __pyx_t_2) < 0) __PYX_ERR(0, 935, __pyx_L2_error)
-      __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-      /* "tkwant/onebody/kernels.pyx":936
- * try:
- *     from ._sparse_blas_kernel import SparseBlas
- *     __all__.append('SparseBlas')             # <<<<<<<<<<<<<<
- * except ImportError as e:
- *     pass
- */
-      __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_all); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 936, __pyx_L2_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __pyx_t_9 = __Pyx_PyObject_Append(__pyx_t_1, __pyx_n_u_SparseBlas); if (unlikely(__pyx_t_9 == ((int)-1))) __PYX_ERR(0, 936, __pyx_L2_error)
-      __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_errormsg, __pyx_kp_u_0_vector_has_length_1_but_the_s) < 0) __PYX_ERR(0, 236, __pyx_L1_error)
 
-      /* "tkwant/onebody/kernels.pyx":934
+  /* "tkwant/onebody/kernels.pyx":701
+ *         object intfunc
  * 
+ *     def __init__(self, syst, time_name, time_start, params=None, interpolation_type=Interpolation):             # <<<<<<<<<<<<<<
  * 
- * try:             # <<<<<<<<<<<<<<
- *     from ._sparse_blas_kernel import SparseBlas
- *     __all__.append('SparseBlas')
+ *         self.wfunc = PerturbationExtractor(syst, time_name, time_start, params)
  */
-    }
-    __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-    __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
-    __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
-    goto __pyx_L7_try_end;
-    __pyx_L2_error:;
-    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-    __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __PYX_XDEC_MEMVIEW(&__pyx_t_3, 1);
+  __Pyx_INCREF(((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Interpolation));
+  __pyx_k__3 = ((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Interpolation);
+  __Pyx_GIVEREF(__pyx_ptype_6tkwant_7onebody_7kernels_Interpolation);
 
-    /* "tkwant/onebody/kernels.pyx":937
- *     from ._sparse_blas_kernel import SparseBlas
- *     __all__.append('SparseBlas')
- * except ImportError as e:             # <<<<<<<<<<<<<<
- *     pass
+  /* "tkwant/onebody/kernels.pyx":840
+ *         object _temp
+ * 
+ *     def __init__(self, H0, W, complex[:] psi_st=None, work=None):             # <<<<<<<<<<<<<<
+ *         pass
  * 
  */
-    __pyx_t_10 = __Pyx_PyErr_ExceptionMatches(__pyx_builtin_ImportError);
-    if (__pyx_t_10) {
-      __Pyx_AddTraceback("tkwant.onebody.kernels", __pyx_clineno, __pyx_lineno, __pyx_filename);
-      if (__Pyx_GetException(&__pyx_t_1, &__pyx_t_2, &__pyx_t_4) < 0) __PYX_ERR(0, 937, __pyx_L4_except_error)
-      __Pyx_GOTREF(__pyx_t_1);
-      __Pyx_GOTREF(__pyx_t_2);
-      __Pyx_GOTREF(__pyx_t_4);
-      if (PyDict_SetItem(__pyx_d, __pyx_n_s_e, __pyx_t_2) < 0) __PYX_ERR(0, 937, __pyx_L4_except_error)
-      /*try:*/ {
-      }
-      /*finally:*/ {
-        /*normal exit:*/{
-          if (unlikely(__Pyx_PyObject_DelAttrStr(__pyx_m, __pyx_n_s_e) < 0)) { if (likely(PyErr_ExceptionMatches(PyExc_AttributeError))) PyErr_Clear(); else __PYX_ERR(0, 937, __pyx_L4_except_error) }
-          goto __pyx_L14;
-        }
-        __pyx_L14:;
-      }
-      __Pyx_XDECREF(__pyx_t_1); __pyx_t_1 = 0;
-      __Pyx_XDECREF(__pyx_t_2); __pyx_t_2 = 0;
-      __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-      goto __pyx_L3_exception_handled;
-    }
-    goto __pyx_L4_except_error;
-    __pyx_L4_except_error:;
+  __pyx_t_4 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(Py_None, PyBUF_WRITABLE); if (unlikely(!__pyx_t_4.memview)) __PYX_ERR(0, 840, __pyx_L1_error)
+  __pyx_k__4 = __pyx_t_4;
+  __pyx_t_4.memview = NULL;
+  __pyx_t_4.data = NULL;
 
-    /* "tkwant/onebody/kernels.pyx":934
+  /* "tkwant/onebody/kernels.pyx":843
+ *         pass
  * 
+ *     def __cinit__(self, H0, W, complex[:] psi_st=None, work=None):             # <<<<<<<<<<<<<<
  * 
- * try:             # <<<<<<<<<<<<<<
- *     from ._sparse_blas_kernel import SparseBlas
- *     __all__.append('SparseBlas')
+ *         if not isinstance(H0, sp.csr.csr_matrix):
  */
-    __Pyx_XGIVEREF(__pyx_t_6);
-    __Pyx_XGIVEREF(__pyx_t_7);
-    __Pyx_XGIVEREF(__pyx_t_8);
-    __Pyx_ExceptionReset(__pyx_t_6, __pyx_t_7, __pyx_t_8);
-    goto __pyx_L1_error;
-    __pyx_L3_exception_handled:;
-    __Pyx_XGIVEREF(__pyx_t_6);
-    __Pyx_XGIVEREF(__pyx_t_7);
-    __Pyx_XGIVEREF(__pyx_t_8);
-    __Pyx_ExceptionReset(__pyx_t_6, __pyx_t_7, __pyx_t_8);
-    __pyx_L7_try_end:;
-  }
+  __pyx_t_4 = __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex(Py_None, PyBUF_WRITABLE); if (unlikely(!__pyx_t_4.memview)) __PYX_ERR(0, 843, __pyx_L1_error)
+  __pyx_k__5 = __pyx_t_4;
+  __pyx_t_4.memview = NULL;
+  __pyx_t_4.data = NULL;
 
-  /* "tkwant/onebody/kernels.pyx":940
- *     pass
+  /* "tkwant/onebody/kernels.pyx":989
+ *         raise NotImplementedError("use the scipy kernel for serialization")
  * 
- * default = Scipy             # <<<<<<<<<<<<<<
+ * default = Simple             # <<<<<<<<<<<<<<
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_4, __pyx_n_s_Scipy); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 940, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_default, __pyx_t_4) < 0) __PYX_ERR(0, 940, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_default, ((PyObject *)__pyx_ptype_6tkwant_7onebody_7kernels_Simple)) < 0) __PYX_ERR(0, 989, __pyx_L1_error)
 
   /* "(tree fragment)":1
  * def __pyx_unpickle_Kernel(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
-  __pyx_t_4 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_5__pyx_unpickle_Kernel, NULL, __pyx_n_s_tkwant_onebody_kernels); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_Kernel, __pyx_t_4) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_3 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_3__pyx_unpickle_Kernel, NULL, __pyx_n_s_tkwant_onebody_kernels); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_Kernel, __pyx_t_3) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
   /* "(tree fragment)":11
  *         __pyx_unpickle_Kernel__set_state(<Kernel> __pyx_result, __pyx_state)
  *     return __pyx_result
  * cdef __pyx_unpickle_Kernel__set_state(Kernel __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
  *     __pyx_result.nevals = __pyx_state[0]; __pyx_result.size = __pyx_state[1]
  *     if len(__pyx_state) > 2 and hasattr(__pyx_result, '__dict__'):
  */
-  __pyx_t_4 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_7__pyx_unpickle_PerturbationExtractor, NULL, __pyx_n_s_tkwant_onebody_kernels); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_PerturbationExtra, __pyx_t_4) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_3 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_5__pyx_unpickle_Interpolation, NULL, __pyx_n_s_tkwant_onebody_kernels); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_Interpolation, __pyx_t_3) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
   /* "(tree fragment)":1
- * def __pyx_unpickle_PerturbationInterpolator(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
+ * def __pyx_unpickle_PerturbationExtractor(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
-  __pyx_t_4 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_9__pyx_unpickle_PerturbationInterpolator, NULL, __pyx_n_s_tkwant_onebody_kernels); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_PerturbationInter, __pyx_t_4) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_3 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_7__pyx_unpickle_PerturbationExtractor, NULL, __pyx_n_s_tkwant_onebody_kernels); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_PerturbationExtra, __pyx_t_3) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+
+  /* "(tree fragment)":11
+ *         __pyx_unpickle_PerturbationExtractor__set_state(<PerturbationExtractor> __pyx_result, __pyx_state)
+ *     return __pyx_result
+ * cdef __pyx_unpickle_PerturbationExtractor__set_state(PerturbationExtractor __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
+ *     __pyx_result.H = __pyx_state[0]; __pyx_result.nnz = __pyx_state[1]; __pyx_result.size = __pyx_state[2]; __pyx_result.td_hamiltonian = __pyx_state[3]; __pyx_result.time_name = __pyx_state[4]; __pyx_result.tparams = __pyx_state[5]
+ *     if len(__pyx_state) > 6 and hasattr(__pyx_result, '__dict__'):
+ */
+  __pyx_t_3 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7kernels_9__pyx_unpickle_PerturbationInterpolator, NULL, __pyx_n_s_tkwant_onebody_kernels); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_PerturbationInter, __pyx_t_3) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
   /* "tkwant/onebody/kernels.pyx":1
  * # -*- coding: utf-8 -*-             # <<<<<<<<<<<<<<
  * # cython: embedsignature=True
  * #
  */
-  __pyx_t_4 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_4) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_3 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_3) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "View.MemoryView":209
+  /* "View.MemoryView":210
  *         info.obj = self
  * 
  *     __pyx_getbuffer = capsule(<void *> &__pyx_array_getbuffer, "getbuffer(obj, view, flags)")             # <<<<<<<<<<<<<<
  * 
  *     def __dealloc__(array self):
  */
-  __pyx_t_4 = __pyx_capsule_create(((void *)(&__pyx_array_getbuffer)), ((char *)"getbuffer(obj, view, flags)")); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 209, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  if (PyDict_SetItem((PyObject *)__pyx_array_type->tp_dict, __pyx_n_s_pyx_getbuffer, __pyx_t_4) < 0) __PYX_ERR(1, 209, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_3 = __pyx_capsule_create(((void *)(&__pyx_array_getbuffer)), ((char *)"getbuffer(obj, view, flags)")); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 210, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem((PyObject *)__pyx_array_type->tp_dict, __pyx_n_s_pyx_getbuffer, __pyx_t_3) < 0) __PYX_ERR(1, 210, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   PyType_Modified(__pyx_array_type);
 
-  /* "View.MemoryView":286
+  /* "View.MemoryView":287
  *         return self.name
  * 
  * cdef generic = Enum("<strided and direct or indirect>")             # <<<<<<<<<<<<<<
  * cdef strided = Enum("<strided and direct>") # default
  * cdef indirect = Enum("<strided and indirect>")
  */
-  __pyx_t_4 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__52, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 286, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_3 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__60, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 287, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
   __Pyx_XGOTREF(generic);
-  __Pyx_DECREF_SET(generic, __pyx_t_4);
-  __Pyx_GIVEREF(__pyx_t_4);
-  __pyx_t_4 = 0;
+  __Pyx_DECREF_SET(generic, __pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_3);
+  __pyx_t_3 = 0;
 
-  /* "View.MemoryView":287
+  /* "View.MemoryView":288
  * 
  * cdef generic = Enum("<strided and direct or indirect>")
  * cdef strided = Enum("<strided and direct>") # default             # <<<<<<<<<<<<<<
  * cdef indirect = Enum("<strided and indirect>")
  * 
  */
-  __pyx_t_4 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__53, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 287, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_3 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__61, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 288, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
   __Pyx_XGOTREF(strided);
-  __Pyx_DECREF_SET(strided, __pyx_t_4);
-  __Pyx_GIVEREF(__pyx_t_4);
-  __pyx_t_4 = 0;
+  __Pyx_DECREF_SET(strided, __pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_3);
+  __pyx_t_3 = 0;
 
-  /* "View.MemoryView":288
+  /* "View.MemoryView":289
  * cdef generic = Enum("<strided and direct or indirect>")
  * cdef strided = Enum("<strided and direct>") # default
  * cdef indirect = Enum("<strided and indirect>")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_t_4 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__54, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 288, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_3 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__62, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 289, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
   __Pyx_XGOTREF(indirect);
-  __Pyx_DECREF_SET(indirect, __pyx_t_4);
-  __Pyx_GIVEREF(__pyx_t_4);
-  __pyx_t_4 = 0;
+  __Pyx_DECREF_SET(indirect, __pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_3);
+  __pyx_t_3 = 0;
 
-  /* "View.MemoryView":291
+  /* "View.MemoryView":292
  * 
  * 
  * cdef contiguous = Enum("<contiguous and direct>")             # <<<<<<<<<<<<<<
  * cdef indirect_contiguous = Enum("<contiguous and indirect>")
  * 
  */
-  __pyx_t_4 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__55, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 291, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_3 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__63, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 292, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
   __Pyx_XGOTREF(contiguous);
-  __Pyx_DECREF_SET(contiguous, __pyx_t_4);
-  __Pyx_GIVEREF(__pyx_t_4);
-  __pyx_t_4 = 0;
+  __Pyx_DECREF_SET(contiguous, __pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_3);
+  __pyx_t_3 = 0;
 
-  /* "View.MemoryView":292
+  /* "View.MemoryView":293
  * 
  * cdef contiguous = Enum("<contiguous and direct>")
  * cdef indirect_contiguous = Enum("<contiguous and indirect>")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_t_4 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__56, NULL); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 292, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_3 = __Pyx_PyObject_Call(((PyObject *)__pyx_MemviewEnum_type), __pyx_tuple__64, NULL); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 293, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
   __Pyx_XGOTREF(indirect_contiguous);
-  __Pyx_DECREF_SET(indirect_contiguous, __pyx_t_4);
-  __Pyx_GIVEREF(__pyx_t_4);
-  __pyx_t_4 = 0;
+  __Pyx_DECREF_SET(indirect_contiguous, __pyx_t_3);
+  __Pyx_GIVEREF(__pyx_t_3);
+  __pyx_t_3 = 0;
 
-  /* "View.MemoryView":316
+  /* "View.MemoryView":317
  * 
  * DEF THREAD_LOCKS_PREALLOCATED = 8
  * cdef int __pyx_memoryview_thread_locks_used = 0             # <<<<<<<<<<<<<<
  * cdef PyThread_type_lock[THREAD_LOCKS_PREALLOCATED] __pyx_memoryview_thread_locks = [
  *     PyThread_allocate_lock(),
  */
   __pyx_memoryview_thread_locks_used = 0;
 
-  /* "View.MemoryView":317
+  /* "View.MemoryView":318
  * DEF THREAD_LOCKS_PREALLOCATED = 8
  * cdef int __pyx_memoryview_thread_locks_used = 0
  * cdef PyThread_type_lock[THREAD_LOCKS_PREALLOCATED] __pyx_memoryview_thread_locks = [             # <<<<<<<<<<<<<<
  *     PyThread_allocate_lock(),
  *     PyThread_allocate_lock(),
  */
-  __pyx_t_11[0] = PyThread_allocate_lock();
-  __pyx_t_11[1] = PyThread_allocate_lock();
-  __pyx_t_11[2] = PyThread_allocate_lock();
-  __pyx_t_11[3] = PyThread_allocate_lock();
-  __pyx_t_11[4] = PyThread_allocate_lock();
-  __pyx_t_11[5] = PyThread_allocate_lock();
-  __pyx_t_11[6] = PyThread_allocate_lock();
-  __pyx_t_11[7] = PyThread_allocate_lock();
-  memcpy(&(__pyx_memoryview_thread_locks[0]), __pyx_t_11, sizeof(__pyx_memoryview_thread_locks[0]) * (8));
+  __pyx_t_6[0] = PyThread_allocate_lock();
+  __pyx_t_6[1] = PyThread_allocate_lock();
+  __pyx_t_6[2] = PyThread_allocate_lock();
+  __pyx_t_6[3] = PyThread_allocate_lock();
+  __pyx_t_6[4] = PyThread_allocate_lock();
+  __pyx_t_6[5] = PyThread_allocate_lock();
+  __pyx_t_6[6] = PyThread_allocate_lock();
+  __pyx_t_6[7] = PyThread_allocate_lock();
+  memcpy(&(__pyx_memoryview_thread_locks[0]), __pyx_t_6, sizeof(__pyx_memoryview_thread_locks[0]) * (8));
 
-  /* "View.MemoryView":545
+  /* "View.MemoryView":551
  *         info.obj = self
  * 
  *     __pyx_getbuffer = capsule(<void *> &__pyx_memoryview_getbuffer, "getbuffer(obj, view, flags)")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_t_4 = __pyx_capsule_create(((void *)(&__pyx_memoryview_getbuffer)), ((char *)"getbuffer(obj, view, flags)")); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 545, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  if (PyDict_SetItem((PyObject *)__pyx_memoryview_type->tp_dict, __pyx_n_s_pyx_getbuffer, __pyx_t_4) < 0) __PYX_ERR(1, 545, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_3 = __pyx_capsule_create(((void *)(&__pyx_memoryview_getbuffer)), ((char *)"getbuffer(obj, view, flags)")); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 551, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem((PyObject *)__pyx_memoryview_type->tp_dict, __pyx_n_s_pyx_getbuffer, __pyx_t_3) < 0) __PYX_ERR(1, 551, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   PyType_Modified(__pyx_memoryview_type);
 
-  /* "View.MemoryView":991
+  /* "View.MemoryView":997
  *         return self.from_object
  * 
  *     __pyx_getbuffer = capsule(<void *> &__pyx_memoryview_getbuffer, "getbuffer(obj, view, flags)")             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_t_4 = __pyx_capsule_create(((void *)(&__pyx_memoryview_getbuffer)), ((char *)"getbuffer(obj, view, flags)")); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 991, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  if (PyDict_SetItem((PyObject *)__pyx_memoryviewslice_type->tp_dict, __pyx_n_s_pyx_getbuffer, __pyx_t_4) < 0) __PYX_ERR(1, 991, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_3 = __pyx_capsule_create(((void *)(&__pyx_memoryview_getbuffer)), ((char *)"getbuffer(obj, view, flags)")); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 997, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem((PyObject *)__pyx_memoryviewslice_type->tp_dict, __pyx_n_s_pyx_getbuffer, __pyx_t_3) < 0) __PYX_ERR(1, 997, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   PyType_Modified(__pyx_memoryviewslice_type);
 
   /* "(tree fragment)":1
  * def __pyx_unpickle_Enum(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
  *     cdef object __pyx_PickleError
  *     cdef object __pyx_result
  */
-  __pyx_t_4 = PyCFunction_NewEx(&__pyx_mdef_15View_dot_MemoryView_1__pyx_unpickle_Enum, NULL, __pyx_n_s_View_MemoryView); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_Enum, __pyx_t_4) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __pyx_t_3 = PyCFunction_NewEx(&__pyx_mdef_15View_dot_MemoryView_1__pyx_unpickle_Enum, NULL, __pyx_n_s_View_MemoryView); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_Enum, __pyx_t_3) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "BufferFormatFromTypeInfo":1460
+  /* "BufferFormatFromTypeInfo":1465
  * 
  * @cname('__pyx_format_from_typeinfo')
  * cdef bytes format_from_typeinfo(__Pyx_TypeInfo *type):             # <<<<<<<<<<<<<<
  *     cdef __Pyx_StructField *field
  *     cdef __pyx_typeinfo_string fmt
  */
 
   /*--- Wrapped vars code ---*/
 
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
-  __PYX_XDEC_MEMVIEW(&__pyx_t_3, 1);
-  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_3);
+  __PYX_XDEC_MEMVIEW(&__pyx_t_4, 1);
   __Pyx_XDECREF(__pyx_t_5);
   if (__pyx_m) {
     if (__pyx_d) {
       __Pyx_AddTraceback("init tkwant.onebody.kernels", __pyx_clineno, __pyx_lineno, __pyx_filename);
     }
     Py_CLEAR(__pyx_m);
   } else if (!PyErr_Occurred()) {
@@ -35643,15 +37590,15 @@
         while (*name && (**name != key)) name++;
         if (*name) {
             values[name-argnames] = value;
             continue;
         }
         name = first_kw_arg;
         #if PY_MAJOR_VERSION < 3
-        if (likely(PyString_CheckExact(key)) || likely(PyString_Check(key))) {
+        if (likely(PyString_Check(key))) {
             while (*name) {
                 if ((CYTHON_COMPILING_IN_PYPY || PyString_GET_SIZE(**name) == PyString_GET_SIZE(key))
                         && _PyString_Eq(**name, key)) {
                     values[name-argnames] = value;
                     break;
                 }
                 name++;
@@ -35670,15 +37617,15 @@
             }
         } else
         #endif
         if (likely(PyUnicode_Check(key))) {
             while (*name) {
                 int cmp = (**name == key) ? 0 :
                 #if !CYTHON_COMPILING_IN_PYPY && PY_MAJOR_VERSION >= 3
-                    (PyUnicode_GET_SIZE(**name) != PyUnicode_GET_SIZE(key)) ? 1 :
+                    (__Pyx_PyUnicode_GET_LENGTH(**name) != __Pyx_PyUnicode_GET_LENGTH(key)) ? 1 :
                 #endif
                     PyUnicode_Compare(**name, key);
                 if (cmp < 0 && unlikely(PyErr_Occurred())) goto bad;
                 if (cmp == 0) {
                     values[name-argnames] = value;
                     break;
                 }
@@ -35686,15 +37633,15 @@
             }
             if (*name) continue;
             else {
                 PyObject*** argname = argnames;
                 while (argname != first_kw_arg) {
                     int cmp = (**argname == key) ? 0 :
                     #if !CYTHON_COMPILING_IN_PYPY && PY_MAJOR_VERSION >= 3
-                        (PyUnicode_GET_SIZE(**argname) != PyUnicode_GET_SIZE(key)) ? 1 :
+                        (__Pyx_PyUnicode_GET_LENGTH(**argname) != __Pyx_PyUnicode_GET_LENGTH(key)) ? 1 :
                     #endif
                         PyUnicode_Compare(**argname, key);
                     if (cmp < 0 && unlikely(PyErr_Occurred())) goto bad;
                     if (cmp == 0) goto arg_passed_twice;
                     argname++;
                 }
             }
@@ -35734,19 +37681,15 @@
                         __Pyx_memviewslice *memviewslice,
                         int memview_is_new_reference)
 {
     __Pyx_RefNannyDeclarations
     int i, retval=-1;
     Py_buffer *buf = &memview->view;
     __Pyx_RefNannySetupContext("init_memviewslice", 0);
-    if (!buf) {
-        PyErr_SetString(PyExc_ValueError,
-            "buf is NULL.");
-        goto fail;
-    } else if (memviewslice->memview || memviewslice->data) {
+    if (unlikely(memviewslice->memview || memviewslice->data)) {
         PyErr_SetString(PyExc_ValueError,
             "memviewslice is already initialized!");
         goto fail;
     }
     if (buf->strides) {
         for (i = 0; i < ndim; i++) {
             memviewslice->strides[i] = buf->strides[i];
@@ -35783,15 +37726,15 @@
 }
 #ifndef Py_NO_RETURN
 #define Py_NO_RETURN
 #endif
 static void __pyx_fatalerror(const char *fmt, ...) Py_NO_RETURN {
     va_list vargs;
     char msg[200];
-#ifdef HAVE_STDARG_PROTOTYPES
+#if PY_VERSION_HEX >= 0x030A0000 || defined(HAVE_STDARG_PROTOTYPES)
     va_start(vargs, fmt);
 #else
     va_start(vargs);
 #endif
     vsnprintf(msg, 200, fmt, vargs);
     va_end(vargs);
     Py_FatalError(msg);
@@ -35817,46 +37760,44 @@
     return result;
 }
 static CYTHON_INLINE void
 __Pyx_INC_MEMVIEW(__Pyx_memviewslice *memslice, int have_gil, int lineno)
 {
     int first_time;
     struct __pyx_memoryview_obj *memview = memslice->memview;
-    if (!memview || (PyObject *) memview == Py_None)
+    if (unlikely(!memview || (PyObject *) memview == Py_None))
         return;
-    if (__pyx_get_slice_count(memview) < 0)
+    if (unlikely(__pyx_get_slice_count(memview) < 0))
         __pyx_fatalerror("Acquisition count is %d (line %d)",
                          __pyx_get_slice_count(memview), lineno);
     first_time = __pyx_add_acquisition_count(memview) == 0;
-    if (first_time) {
+    if (unlikely(first_time)) {
         if (have_gil) {
             Py_INCREF((PyObject *) memview);
         } else {
             PyGILState_STATE _gilstate = PyGILState_Ensure();
             Py_INCREF((PyObject *) memview);
             PyGILState_Release(_gilstate);
         }
     }
 }
 static CYTHON_INLINE void __Pyx_XDEC_MEMVIEW(__Pyx_memviewslice *memslice,
                                              int have_gil, int lineno) {
     int last_time;
     struct __pyx_memoryview_obj *memview = memslice->memview;
-    if (!memview ) {
-        return;
-    } else if ((PyObject *) memview == Py_None) {
+    if (unlikely(!memview || (PyObject *) memview == Py_None)) {
         memslice->memview = NULL;
         return;
     }
-    if (__pyx_get_slice_count(memview) <= 0)
+    if (unlikely(__pyx_get_slice_count(memview) <= 0))
         __pyx_fatalerror("Acquisition count is %d (line %d)",
                          __pyx_get_slice_count(memview), lineno);
     last_time = __pyx_sub_acquisition_count(memview) == 1;
     memslice->data = NULL;
-    if (last_time) {
+    if (unlikely(last_time)) {
         if (have_gil) {
             Py_CLEAR(memslice->memview);
         } else {
             PyGILState_STATE _gilstate = PyGILState_Ensure();
             Py_CLEAR(memslice->memview);
             PyGILState_Release(_gilstate);
         }
@@ -35892,15 +37833,15 @@
     result = PyEval_EvalFrameEx(f,0);
     ++tstate->recursion_depth;
     Py_DECREF(f);
     --tstate->recursion_depth;
     return result;
 }
 #if 1 || PY_VERSION_HEX < 0x030600B1
-static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, int nargs, PyObject *kwargs) {
+static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs) {
     PyCodeObject *co = (PyCodeObject *)PyFunction_GET_CODE(func);
     PyObject *globals = PyFunction_GET_GLOBALS(func);
     PyObject *argdefs = PyFunction_GET_DEFAULTS(func);
     PyObject *closure;
 #if PY_MAJOR_VERSION >= 3
     PyObject *kwdefs;
 #endif
@@ -35963,20 +37904,20 @@
     }
     else {
         d = NULL;
         nd = 0;
     }
 #if PY_MAJOR_VERSION >= 3
     result = PyEval_EvalCodeEx((PyObject*)co, globals, (PyObject *)NULL,
-                               args, nargs,
+                               args, (int)nargs,
                                k, (int)nk,
                                d, (int)nd, kwdefs, closure);
 #else
     result = PyEval_EvalCodeEx(co, globals, (PyObject *)NULL,
-                               args, nargs,
+                               args, (int)nargs,
                                k, (int)nk,
                                d, (int)nd, closure);
 #endif
     Py_XDECREF(kwtuple);
 done:
     Py_LeaveRecursiveCall();
     return result;
@@ -35984,15 +37925,15 @@
 #endif
 #endif
 
 /* PyObjectCall */
 #if CYTHON_COMPILING_IN_CPYTHON
 static CYTHON_INLINE PyObject* __Pyx_PyObject_Call(PyObject *func, PyObject *arg, PyObject *kw) {
     PyObject *result;
-    ternaryfunc call = func->ob_type->tp_call;
+    ternaryfunc call = Py_TYPE(func)->tp_call;
     if (unlikely(!call))
         return PyObject_Call(func, arg, kw);
     if (unlikely(Py_EnterRecursiveCall((char*)" while calling a Python object")))
         return NULL;
     result = (*call)(func, arg, kw);
     Py_LeaveRecursiveCall();
     if (unlikely(!result) && unlikely(!PyErr_Occurred())) {
@@ -36028,15 +37969,15 @@
 #if CYTHON_COMPILING_IN_CPYTHON
 static CYTHON_INLINE PyObject* __Pyx_PyObject_CallNoArg(PyObject *func) {
 #if CYTHON_FAST_PYCALL
     if (PyFunction_Check(func)) {
         return __Pyx_PyFunction_FastCall(func, NULL, 0);
     }
 #endif
-#ifdef __Pyx_CyFunction_USED
+#if defined(__Pyx_CyFunction_USED) && defined(NDEBUG)
     if (likely(PyCFunction_Check(func) || __Pyx_CyFunction_Check(func)))
 #else
     if (likely(PyCFunction_Check(func)))
 #endif
     {
         if (likely(PyCFunction_GET_FLAGS(func) & METH_NOARGS)) {
             return __Pyx_PyObject_CallMethO(func, NULL);
@@ -36203,28 +38144,28 @@
                             "BaseException");
             goto bad;
         }
         PyException_SetCause(value, fixed_cause);
     }
     PyErr_SetObject(type, value);
     if (tb) {
-#if CYTHON_COMPILING_IN_PYPY
-        PyObject *tmp_type, *tmp_value, *tmp_tb;
-        PyErr_Fetch(&tmp_type, &tmp_value, &tmp_tb);
-        Py_INCREF(tb);
-        PyErr_Restore(tmp_type, tmp_value, tb);
-        Py_XDECREF(tmp_tb);
-#else
+#if CYTHON_FAST_THREAD_STATE
         PyThreadState *tstate = __Pyx_PyThreadState_Current;
         PyObject* tmp_tb = tstate->curexc_traceback;
         if (tb != tmp_tb) {
             Py_INCREF(tb);
             tstate->curexc_traceback = tb;
             Py_XDECREF(tmp_tb);
         }
+#else
+        PyObject *tmp_type, *tmp_value, *tmp_tb;
+        PyErr_Fetch(&tmp_type, &tmp_value, &tmp_tb);
+        Py_INCREF(tb);
+        PyErr_Restore(tmp_type, tmp_value, tb);
+        Py_XDECREF(tmp_tb);
 #endif
     }
 bad:
     Py_XDECREF(owned_instance);
     return;
 }
 #endif
@@ -36278,14 +38219,40 @@
     return d;
 }
 static CYTHON_INLINE PyObject *__Pyx_GetAttr3(PyObject *o, PyObject *n, PyObject *d) {
     PyObject *r = __Pyx_GetAttr(o, n);
     return (likely(r)) ? r : __Pyx_GetAttr3Default(d);
 }
 
+/* PyDictVersioning */
+#if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_tp_dict_version(PyObject *obj) {
+    PyObject *dict = Py_TYPE(obj)->tp_dict;
+    return likely(dict) ? __PYX_GET_DICT_VERSION(dict) : 0;
+}
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_object_dict_version(PyObject *obj) {
+    PyObject **dictptr = NULL;
+    Py_ssize_t offset = Py_TYPE(obj)->tp_dictoffset;
+    if (offset) {
+#if CYTHON_COMPILING_IN_CPYTHON
+        dictptr = (likely(offset > 0)) ? (PyObject **) ((char *)obj + offset) : _PyObject_GetDictPtr(obj);
+#else
+        dictptr = _PyObject_GetDictPtr(obj);
+#endif
+    }
+    return (dictptr && *dictptr) ? __PYX_GET_DICT_VERSION(*dictptr) : 0;
+}
+static CYTHON_INLINE int __Pyx_object_dict_version_matches(PyObject* obj, PY_UINT64_T tp_dict_version, PY_UINT64_T obj_dict_version) {
+    PyObject *dict = Py_TYPE(obj)->tp_dict;
+    if (unlikely(!dict) || unlikely(tp_dict_version != __PYX_GET_DICT_VERSION(dict)))
+        return 0;
+    return obj_dict_version == __Pyx_get_object_dict_version(obj);
+}
+#endif
+
 /* GetModuleGlobalName */
 #if CYTHON_USE_DICT_VERSIONS
 static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value)
 #else
 static CYTHON_INLINE PyObject *__Pyx__GetModuleGlobalName(PyObject *name)
 #endif
 {
@@ -36336,27 +38303,14 @@
         return (*((__Pyx_PyCFunctionFastWithKeywords)(void*)meth)) (self, args, nargs, NULL);
     } else {
         return (*((__Pyx_PyCFunctionFast)(void*)meth)) (self, args, nargs);
     }
 }
 #endif
 
-/* ExtTypeTest */
-static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type) {
-    if (unlikely(!type)) {
-        PyErr_SetString(PyExc_SystemError, "Missing type object");
-        return 0;
-    }
-    if (likely(__Pyx_TypeCheck(obj, type)))
-        return 1;
-    PyErr_Format(PyExc_TypeError, "Cannot convert %.200s to %.200s",
-                 Py_TYPE(obj)->tp_name, type->tp_name);
-    return 0;
-}
-
 /* PyObjectCallOneArg */
 #if CYTHON_COMPILING_IN_CPYTHON
 static PyObject* __Pyx__PyObject_CallOneArg(PyObject *func, PyObject *arg) {
     PyObject *result;
     PyObject *args = PyTuple_New(1);
     if (unlikely(!args)) return NULL;
     Py_INCREF(arg);
@@ -36371,15 +38325,15 @@
         return __Pyx_PyFunction_FastCall(func, &arg, 1);
     }
 #endif
     if (likely(PyCFunction_Check(func))) {
         if (likely(PyCFunction_GET_FLAGS(func) & METH_O)) {
             return __Pyx_PyObject_CallMethO(func, arg);
 #if CYTHON_FAST_PYCCALL
-        } else if (PyCFunction_GET_FLAGS(func) & METH_FASTCALL) {
+        } else if (__Pyx_PyFastCFunction_Check(func)) {
             return __Pyx_PyCFunction_FastCall(func, &arg, 1);
 #endif
         }
     }
     return __Pyx__PyObject_CallOneArg(func, arg);
 }
 #else
@@ -36389,35 +38343,14 @@
     if (unlikely(!args)) return NULL;
     result = __Pyx_PyObject_Call(func, args, NULL);
     Py_DECREF(args);
     return result;
 }
 #endif
 
-/* ArgTypeTest */
-static int __Pyx__ArgTypeTest(PyObject *obj, PyTypeObject *type, const char *name, int exact)
-{
-    if (unlikely(!type)) {
-        PyErr_SetString(PyExc_SystemError, "Missing type object");
-        return 0;
-    }
-    else if (exact) {
-        #if PY_MAJOR_VERSION == 2
-        if ((type == &PyBaseString_Type) && likely(__Pyx_PyBaseString_CheckExact(obj))) return 1;
-        #endif
-    }
-    else {
-        if (likely(__Pyx_TypeCheck(obj, type))) return 1;
-    }
-    PyErr_Format(PyExc_TypeError,
-        "Argument '%.200s' has incorrect type (expected %.200s, got %.200s)",
-        name, type->tp_name, Py_TYPE(obj)->tp_name);
-    return 0;
-}
-
 /* PyObjectSetAttrStr */
 #if CYTHON_USE_TYPE_SLOTS
 static CYTHON_INLINE int __Pyx_PyObject_SetAttrStr(PyObject* obj, PyObject* attr_name, PyObject* value) {
     PyTypeObject* tp = Py_TYPE(obj);
     if (likely(tp->tp_setattro))
         return tp->tp_setattro(obj, attr_name, value);
 #if PY_MAJOR_VERSION < 3
@@ -36802,23 +38735,184 @@
     PyErr_SetExcInfo(*type, *value, *tb);
     *type = tmp_type;
     *value = tmp_value;
     *tb = tmp_tb;
 }
 #endif
 
-/* BufferIndexError */
-static void __Pyx_RaiseBufferIndexError(int axis) {
-  PyErr_Format(PyExc_IndexError,
-     "Out of bounds on buffer access (axis %d)", axis);
+/* WriteUnraisableException */
+static void __Pyx_WriteUnraisable(const char *name, CYTHON_UNUSED int clineno,
+                                  CYTHON_UNUSED int lineno, CYTHON_UNUSED const char *filename,
+                                  int full_traceback, CYTHON_UNUSED int nogil) {
+    PyObject *old_exc, *old_val, *old_tb;
+    PyObject *ctx;
+    __Pyx_PyThreadState_declare
+#ifdef WITH_THREAD
+    PyGILState_STATE state;
+    if (nogil)
+        state = PyGILState_Ensure();
+    else state = (PyGILState_STATE)0;
+#endif
+    __Pyx_PyThreadState_assign
+    __Pyx_ErrFetch(&old_exc, &old_val, &old_tb);
+    if (full_traceback) {
+        Py_XINCREF(old_exc);
+        Py_XINCREF(old_val);
+        Py_XINCREF(old_tb);
+        __Pyx_ErrRestore(old_exc, old_val, old_tb);
+        PyErr_PrintEx(1);
+    }
+    #if PY_MAJOR_VERSION < 3
+    ctx = PyString_FromString(name);
+    #else
+    ctx = PyUnicode_FromString(name);
+    #endif
+    __Pyx_ErrRestore(old_exc, old_val, old_tb);
+    if (!ctx) {
+        PyErr_WriteUnraisable(Py_None);
+    } else {
+        PyErr_WriteUnraisable(ctx);
+        Py_DECREF(ctx);
+    }
+#ifdef WITH_THREAD
+    if (nogil)
+        PyGILState_Release(state);
+#endif
+}
+
+/* HasAttr */
+static CYTHON_INLINE int __Pyx_HasAttr(PyObject *o, PyObject *n) {
+    PyObject *r;
+    if (unlikely(!__Pyx_PyBaseString_Check(n))) {
+        PyErr_SetString(PyExc_TypeError,
+                        "hasattr(): attribute name must be string");
+        return -1;
+    }
+    r = __Pyx_GetAttr(o, n);
+    if (unlikely(!r)) {
+        PyErr_Clear();
+        return 0;
+    } else {
+        Py_DECREF(r);
+        return 1;
+    }
+}
+
+/* SetItemInt */
+static int __Pyx_SetItemInt_Generic(PyObject *o, PyObject *j, PyObject *v) {
+    int r;
+    if (!j) return -1;
+    r = PyObject_SetItem(o, j, v);
+    Py_DECREF(j);
+    return r;
+}
+static CYTHON_INLINE int __Pyx_SetItemInt_Fast(PyObject *o, Py_ssize_t i, PyObject *v, int is_list,
+                                               CYTHON_NCP_UNUSED int wraparound, CYTHON_NCP_UNUSED int boundscheck) {
+#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS && CYTHON_USE_TYPE_SLOTS
+    if (is_list || PyList_CheckExact(o)) {
+        Py_ssize_t n = (!wraparound) ? i : ((likely(i >= 0)) ? i : i + PyList_GET_SIZE(o));
+        if ((!boundscheck) || likely(__Pyx_is_valid_index(n, PyList_GET_SIZE(o)))) {
+            PyObject* old = PyList_GET_ITEM(o, n);
+            Py_INCREF(v);
+            PyList_SET_ITEM(o, n, v);
+            Py_DECREF(old);
+            return 1;
+        }
+    } else {
+        PySequenceMethods *m = Py_TYPE(o)->tp_as_sequence;
+        if (likely(m && m->sq_ass_item)) {
+            if (wraparound && unlikely(i < 0) && likely(m->sq_length)) {
+                Py_ssize_t l = m->sq_length(o);
+                if (likely(l >= 0)) {
+                    i += l;
+                } else {
+                    if (!PyErr_ExceptionMatches(PyExc_OverflowError))
+                        return -1;
+                    PyErr_Clear();
+                }
+            }
+            return m->sq_ass_item(o, i, v);
+        }
+    }
+#else
+#if CYTHON_COMPILING_IN_PYPY
+    if (is_list || (PySequence_Check(o) && !PyDict_Check(o)))
+#else
+    if (is_list || PySequence_Check(o))
+#endif
+    {
+        return PySequence_SetItem(o, i, v);
+    }
+#endif
+    return __Pyx_SetItemInt_Generic(o, PyInt_FromSsize_t(i), v);
+}
+
+/* RaiseTooManyValuesToUnpack */
+static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected) {
+    PyErr_Format(PyExc_ValueError,
+                 "too many values to unpack (expected %" CYTHON_FORMAT_SSIZE_T "d)", expected);
+}
+
+/* RaiseNeedMoreValuesToUnpack */
+static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index) {
+    PyErr_Format(PyExc_ValueError,
+                 "need more than %" CYTHON_FORMAT_SSIZE_T "d value%.1s to unpack",
+                 index, (index == 1) ? "" : "s");
+}
+
+/* IterFinish */
+static CYTHON_INLINE int __Pyx_IterFinish(void) {
+#if CYTHON_FAST_THREAD_STATE
+    PyThreadState *tstate = __Pyx_PyThreadState_Current;
+    PyObject* exc_type = tstate->curexc_type;
+    if (unlikely(exc_type)) {
+        if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) {
+            PyObject *exc_value, *exc_tb;
+            exc_value = tstate->curexc_value;
+            exc_tb = tstate->curexc_traceback;
+            tstate->curexc_type = 0;
+            tstate->curexc_value = 0;
+            tstate->curexc_traceback = 0;
+            Py_DECREF(exc_type);
+            Py_XDECREF(exc_value);
+            Py_XDECREF(exc_tb);
+            return 0;
+        } else {
+            return -1;
+        }
+    }
+    return 0;
+#else
+    if (unlikely(PyErr_Occurred())) {
+        if (likely(PyErr_ExceptionMatches(PyExc_StopIteration))) {
+            PyErr_Clear();
+            return 0;
+        } else {
+            return -1;
+        }
+    }
+    return 0;
+#endif
+}
+
+/* UnpackItemEndCheck */
+static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected) {
+    if (unlikely(retval)) {
+        Py_DECREF(retval);
+        __Pyx_RaiseTooManyValuesError(expected);
+        return -1;
+    }
+    return __Pyx_IterFinish();
 }
 
 /* PyIntBinop */
 #if !CYTHON_COMPILING_IN_PYPY
-static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, CYTHON_UNUSED long intval, CYTHON_UNUSED int inplace) {
+static PyObject* __Pyx_PyInt_AddObjC(PyObject *op1, PyObject *op2, CYTHON_UNUSED long intval, int inplace, int zerodivision_check) {
+    (void)inplace;
+    (void)zerodivision_check;
     #if PY_MAJOR_VERSION < 3
     if (likely(PyInt_CheckExact(op1))) {
         const long b = intval;
         long x;
         long a = PyInt_AS_LONG(op1);
             x = (long)((unsigned long)a + b);
             if (likely((x^a) >= 0 || (x^b) >= 0))
@@ -36930,138 +39024,18 @@
             PyFPE_END_PROTECT(result)
             return PyFloat_FromDouble(result);
     }
     return (inplace ? PyNumber_InPlaceAdd : PyNumber_Add)(op1, op2);
 }
 #endif
 
-/* WriteUnraisableException */
-static void __Pyx_WriteUnraisable(const char *name, CYTHON_UNUSED int clineno,
-                                  CYTHON_UNUSED int lineno, CYTHON_UNUSED const char *filename,
-                                  int full_traceback, CYTHON_UNUSED int nogil) {
-    PyObject *old_exc, *old_val, *old_tb;
-    PyObject *ctx;
-    __Pyx_PyThreadState_declare
-#ifdef WITH_THREAD
-    PyGILState_STATE state;
-    if (nogil)
-        state = PyGILState_Ensure();
-#ifdef _MSC_VER
-    else state = (PyGILState_STATE)-1;
-#endif
-#endif
-    __Pyx_PyThreadState_assign
-    __Pyx_ErrFetch(&old_exc, &old_val, &old_tb);
-    if (full_traceback) {
-        Py_XINCREF(old_exc);
-        Py_XINCREF(old_val);
-        Py_XINCREF(old_tb);
-        __Pyx_ErrRestore(old_exc, old_val, old_tb);
-        PyErr_PrintEx(1);
-    }
-    #if PY_MAJOR_VERSION < 3
-    ctx = PyString_FromString(name);
-    #else
-    ctx = PyUnicode_FromString(name);
-    #endif
-    __Pyx_ErrRestore(old_exc, old_val, old_tb);
-    if (!ctx) {
-        PyErr_WriteUnraisable(Py_None);
-    } else {
-        PyErr_WriteUnraisable(ctx);
-        Py_DECREF(ctx);
-    }
-#ifdef WITH_THREAD
-    if (nogil)
-        PyGILState_Release(state);
-#endif
-}
-
-/* HasAttr */
-static CYTHON_INLINE int __Pyx_HasAttr(PyObject *o, PyObject *n) {
-    PyObject *r;
-    if (unlikely(!__Pyx_PyBaseString_Check(n))) {
-        PyErr_SetString(PyExc_TypeError,
-                        "hasattr(): attribute name must be string");
-        return -1;
-    }
-    r = __Pyx_GetAttr(o, n);
-    if (unlikely(!r)) {
-        PyErr_Clear();
-        return 0;
-    } else {
-        Py_DECREF(r);
-        return 1;
-    }
-}
-
-/* RaiseTooManyValuesToUnpack */
-static CYTHON_INLINE void __Pyx_RaiseTooManyValuesError(Py_ssize_t expected) {
-    PyErr_Format(PyExc_ValueError,
-                 "too many values to unpack (expected %" CYTHON_FORMAT_SSIZE_T "d)", expected);
-}
-
-/* RaiseNeedMoreValuesToUnpack */
-static CYTHON_INLINE void __Pyx_RaiseNeedMoreValuesError(Py_ssize_t index) {
-    PyErr_Format(PyExc_ValueError,
-                 "need more than %" CYTHON_FORMAT_SSIZE_T "d value%.1s to unpack",
-                 index, (index == 1) ? "" : "s");
-}
-
-/* IterFinish */
-static CYTHON_INLINE int __Pyx_IterFinish(void) {
-#if CYTHON_FAST_THREAD_STATE
-    PyThreadState *tstate = __Pyx_PyThreadState_Current;
-    PyObject* exc_type = tstate->curexc_type;
-    if (unlikely(exc_type)) {
-        if (likely(__Pyx_PyErr_GivenExceptionMatches(exc_type, PyExc_StopIteration))) {
-            PyObject *exc_value, *exc_tb;
-            exc_value = tstate->curexc_value;
-            exc_tb = tstate->curexc_traceback;
-            tstate->curexc_type = 0;
-            tstate->curexc_value = 0;
-            tstate->curexc_traceback = 0;
-            Py_DECREF(exc_type);
-            Py_XDECREF(exc_value);
-            Py_XDECREF(exc_tb);
-            return 0;
-        } else {
-            return -1;
-        }
-    }
-    return 0;
-#else
-    if (unlikely(PyErr_Occurred())) {
-        if (likely(PyErr_ExceptionMatches(PyExc_StopIteration))) {
-            PyErr_Clear();
-            return 0;
-        } else {
-            return -1;
-        }
-    }
-    return 0;
-#endif
-}
-
-/* UnpackItemEndCheck */
-static int __Pyx_IternextUnpackEndCheck(PyObject *retval, Py_ssize_t expected) {
-    if (unlikely(retval)) {
-        Py_DECREF(retval);
-        __Pyx_RaiseTooManyValuesError(expected);
-        return -1;
-    } else {
-        return __Pyx_IterFinish();
-    }
-    return 0;
-}
-
 /* ObjectGetItem */
 #if CYTHON_USE_TYPE_SLOTS
 static PyObject *__Pyx_PyObject_GetIndex(PyObject *obj, PyObject* index) {
-    PyObject *runerr;
+    PyObject *runerr = NULL;
     Py_ssize_t key_value;
     PySequenceMethods *m = Py_TYPE(obj)->tp_as_sequence;
     if (unlikely(!(m && m->sq_item))) {
         PyErr_Format(PyExc_TypeError, "'%.200s' object is not subscriptable", Py_TYPE(obj)->tp_name);
         return NULL;
     }
     key_value = __Pyx_PyIndex_AsSsize_t(index);
@@ -37079,66 +39053,18 @@
     if (likely(m && m->mp_subscript)) {
         return m->mp_subscript(obj, key);
     }
     return __Pyx_PyObject_GetIndex(obj, key);
 }
 #endif
 
-/* SetItemInt */
-static int __Pyx_SetItemInt_Generic(PyObject *o, PyObject *j, PyObject *v) {
-    int r;
-    if (!j) return -1;
-    r = PyObject_SetItem(o, j, v);
-    Py_DECREF(j);
-    return r;
-}
-static CYTHON_INLINE int __Pyx_SetItemInt_Fast(PyObject *o, Py_ssize_t i, PyObject *v, int is_list,
-                                               CYTHON_NCP_UNUSED int wraparound, CYTHON_NCP_UNUSED int boundscheck) {
-#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS && CYTHON_USE_TYPE_SLOTS
-    if (is_list || PyList_CheckExact(o)) {
-        Py_ssize_t n = (!wraparound) ? i : ((likely(i >= 0)) ? i : i + PyList_GET_SIZE(o));
-        if ((!boundscheck) || likely(__Pyx_is_valid_index(n, PyList_GET_SIZE(o)))) {
-            PyObject* old = PyList_GET_ITEM(o, n);
-            Py_INCREF(v);
-            PyList_SET_ITEM(o, n, v);
-            Py_DECREF(old);
-            return 1;
-        }
-    } else {
-        PySequenceMethods *m = Py_TYPE(o)->tp_as_sequence;
-        if (likely(m && m->sq_ass_item)) {
-            if (wraparound && unlikely(i < 0) && likely(m->sq_length)) {
-                Py_ssize_t l = m->sq_length(o);
-                if (likely(l >= 0)) {
-                    i += l;
-                } else {
-                    if (!PyErr_ExceptionMatches(PyExc_OverflowError))
-                        return -1;
-                    PyErr_Clear();
-                }
-            }
-            return m->sq_ass_item(o, i, v);
-        }
-    }
-#else
-#if CYTHON_COMPILING_IN_PYPY
-    if (is_list || (PySequence_Check(o) && !PyDict_Check(o)))
-#else
-    if (is_list || PySequence_Check(o))
-#endif
-    {
-        return PySequence_SetItem(o, i, v);
-    }
-#endif
-    return __Pyx_SetItemInt_Generic(o, PyInt_FromSsize_t(i), v);
-}
-
-/* None */
-static CYTHON_INLINE void __Pyx_RaiseUnboundLocalError(const char *varname) {
-    PyErr_Format(PyExc_UnboundLocalError, "local variable '%s' referenced before assignment", varname);
+/* BufferIndexError */
+static void __Pyx_RaiseBufferIndexError(int axis) {
+  PyErr_Format(PyExc_IndexError,
+     "Out of bounds on buffer access (axis %d)", axis);
 }
 
 /* Import */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level) {
     PyObject *empty_list = 0;
     PyObject *module = 0;
     PyObject *global_dict = 0;
@@ -37163,15 +39089,15 @@
         goto bad;
     empty_dict = PyDict_New();
     if (!empty_dict)
         goto bad;
     {
         #if PY_MAJOR_VERSION >= 3
         if (level == -1) {
-            if (strchr(__Pyx_MODULE_NAME, '.')) {
+            if ((1) && (strchr(__Pyx_MODULE_NAME, '.'))) {
                 module = PyImport_ImportModuleLevelObject(
                     name, global_dict, empty_dict, list, 1);
                 if (!module) {
                     if (!PyErr_ExceptionMatches(PyExc_ImportError))
                         goto bad;
                     PyErr_Clear();
                 }
@@ -37212,14 +39138,35 @@
         #else
             "cannot import name %S", name);
         #endif
     }
     return value;
 }
 
+/* ArgTypeTest */
+static int __Pyx__ArgTypeTest(PyObject *obj, PyTypeObject *type, const char *name, int exact)
+{
+    if (unlikely(!type)) {
+        PyErr_SetString(PyExc_SystemError, "Missing type object");
+        return 0;
+    }
+    else if (exact) {
+        #if PY_MAJOR_VERSION == 2
+        if ((type == &PyBaseString_Type) && likely(__Pyx_PyBaseString_CheckExact(obj))) return 1;
+        #endif
+    }
+    else {
+        if (likely(__Pyx_TypeCheck(obj, type))) return 1;
+    }
+    PyErr_Format(PyExc_TypeError,
+        "Argument '%.200s' has incorrect type (expected %.200s, got %.200s)",
+        name, type->tp_name, Py_TYPE(obj)->tp_name);
+    return 0;
+}
+
 /* BytesEquals */
 static CYTHON_INLINE int __Pyx_PyBytes_Equals(PyObject* s1, PyObject* s2, int equals) {
 #if CYTHON_COMPILING_IN_PYPY
     return PyObject_RichCompareBool(s1, s2, equals);
 #else
     if (s1 == s2) {
         return (equals == Py_EQ);
@@ -37232,15 +39179,15 @@
         ps2 = PyBytes_AS_STRING(s2);
         if (ps1[0] != ps2[0]) {
             return (equals == Py_NE);
         } else if (length == 1) {
             return (equals == Py_EQ);
         } else {
             int result;
-#if CYTHON_USE_UNICODE_INTERNALS
+#if CYTHON_USE_UNICODE_INTERNALS && (PY_VERSION_HEX < 0x030B0000)
             Py_hash_t hash1, hash2;
             hash1 = ((PyBytesObject*)s1)->ob_shash;
             hash2 = ((PyBytesObject*)s2)->ob_shash;
             if (hash1 != hash2 && hash1 != -1 && hash2 != -1) {
                 return (equals == Py_NE);
             }
 #endif
@@ -37361,15 +39308,15 @@
     #if PY_MAJOR_VERSION < 3
     Py_XDECREF(owned_ref);
     #endif
     return (equals == Py_NE);
 #endif
 }
 
-/* None */
+/* DivInt[Py_ssize_t] */
 static CYTHON_INLINE Py_ssize_t __Pyx_div_Py_ssize_t(Py_ssize_t a, Py_ssize_t b) {
     Py_ssize_t q = a / b;
     Py_ssize_t r = a - q*b;
     q -= ((r != 0) & ((r ^ b) < 0));
     return q;
 }
 
@@ -37391,30 +39338,43 @@
             start += length;
             if (start < 0)
                 start = 0;
         }
         if (stop < 0)
             stop += length;
     }
+    if (unlikely(stop <= start))
+        return __Pyx_NewRef(__pyx_empty_unicode);
     length = stop - start;
-    if (unlikely(length <= 0))
-        return PyUnicode_FromUnicode(NULL, 0);
     cstring += start;
     if (decode_func) {
         return decode_func(cstring, length, errors);
     } else {
         return PyUnicode_Decode(cstring, length, encoding, errors);
     }
 }
 
 /* RaiseNoneIterError */
 static CYTHON_INLINE void __Pyx_RaiseNoneNotIterableError(void) {
     PyErr_SetString(PyExc_TypeError, "'NoneType' object is not iterable");
 }
 
+/* ExtTypeTest */
+static CYTHON_INLINE int __Pyx_TypeTest(PyObject *obj, PyTypeObject *type) {
+    if (unlikely(!type)) {
+        PyErr_SetString(PyExc_SystemError, "Missing type object");
+        return 0;
+    }
+    if (likely(__Pyx_TypeCheck(obj, type)))
+        return 1;
+    PyErr_Format(PyExc_TypeError, "Cannot convert %.200s to %.200s",
+                 Py_TYPE(obj)->tp_name, type->tp_name);
+    return 0;
+}
+
 /* FastTypeChecks */
 #if CYTHON_COMPILING_IN_CPYTHON
 static int __Pyx_InBases(PyTypeObject *a, PyTypeObject *b) {
     while (a) {
         a = a->tp_base;
         if (a == b)
             return 1;
@@ -37508,14 +39468,19 @@
         return __Pyx_inner_PyErr_GivenExceptionMatches2(err, exc_type1, exc_type2);
     }
     return (PyErr_GivenExceptionMatches(err, exc_type1) || PyErr_GivenExceptionMatches(err, exc_type2));
 }
 #endif
 
 /* None */
+static CYTHON_INLINE void __Pyx_RaiseUnboundLocalError(const char *varname) {
+    PyErr_Format(PyExc_UnboundLocalError, "local variable '%s' referenced before assignment", varname);
+}
+
+/* DivInt[long] */
 static CYTHON_INLINE long __Pyx_div_long(long a, long b) {
     long q = a / b;
     long r = a - q*b;
     q -= ((r != 0) & ((r ^ b) < 0));
     return q;
 }
 
@@ -37595,14 +39560,36 @@
     if (unlikely(Py_TYPE(obj)->tp_dictoffset)) {
         return PyObject_GenericGetAttr(obj, attr_name);
     }
     return __Pyx_PyObject_GenericGetAttrNoDict(obj, attr_name);
 }
 #endif
 
+/* PyObjectGetAttrStrNoError */
+static void __Pyx_PyObject_GetAttrStr_ClearAttributeError(void) {
+    __Pyx_PyThreadState_declare
+    __Pyx_PyThreadState_assign
+    if (likely(__Pyx_PyErr_ExceptionMatches(PyExc_AttributeError)))
+        __Pyx_PyErr_Clear();
+}
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GetAttrStrNoError(PyObject* obj, PyObject* attr_name) {
+    PyObject *result;
+#if CYTHON_COMPILING_IN_CPYTHON && CYTHON_USE_TYPE_SLOTS && PY_VERSION_HEX >= 0x030700B1
+    PyTypeObject* tp = Py_TYPE(obj);
+    if (likely(tp->tp_getattro == PyObject_GenericGetAttr)) {
+        return _PyObject_GenericGetAttrWithDict(obj, attr_name, NULL, 1);
+    }
+#endif
+    result = __Pyx_PyObject_GetAttrStr(obj, attr_name);
+    if (unlikely(!result)) {
+        __Pyx_PyObject_GetAttrStr_ClearAttributeError();
+    }
+    return result;
+}
+
 /* SetupReduce */
 static int __Pyx_setup_reduce_is_named(PyObject* meth, PyObject* name) {
   int ret;
   PyObject *name_attr;
   name_attr = __Pyx_PyObject_GetAttrStr(meth, __pyx_n_s_name_2);
   if (likely(name_attr)) {
       ret = PyObject_RichCompareBool(name_attr, name, Py_EQ);
@@ -37615,61 +39602,89 @@
   }
   Py_XDECREF(name_attr);
   return ret;
 }
 static int __Pyx_setup_reduce(PyObject* type_obj) {
     int ret = 0;
     PyObject *object_reduce = NULL;
+    PyObject *object_getstate = NULL;
     PyObject *object_reduce_ex = NULL;
     PyObject *reduce = NULL;
     PyObject *reduce_ex = NULL;
     PyObject *reduce_cython = NULL;
     PyObject *setstate = NULL;
     PyObject *setstate_cython = NULL;
+    PyObject *getstate = NULL;
+#if CYTHON_USE_PYTYPE_LOOKUP
+    getstate = _PyType_Lookup((PyTypeObject*)type_obj, __pyx_n_s_getstate);
+#else
+    getstate = __Pyx_PyObject_GetAttrStrNoError(type_obj, __pyx_n_s_getstate);
+    if (!getstate && PyErr_Occurred()) {
+        goto __PYX_BAD;
+    }
+#endif
+    if (getstate) {
 #if CYTHON_USE_PYTYPE_LOOKUP
-    if (_PyType_Lookup((PyTypeObject*)type_obj, __pyx_n_s_getstate)) goto GOOD;
+        object_getstate = _PyType_Lookup(&PyBaseObject_Type, __pyx_n_s_getstate);
 #else
-    if (PyObject_HasAttr(type_obj, __pyx_n_s_getstate)) goto GOOD;
+        object_getstate = __Pyx_PyObject_GetAttrStrNoError((PyObject*)&PyBaseObject_Type, __pyx_n_s_getstate);
+        if (!object_getstate && PyErr_Occurred()) {
+            goto __PYX_BAD;
+        }
 #endif
+        if (object_getstate != getstate) {
+            goto __PYX_GOOD;
+        }
+    }
 #if CYTHON_USE_PYTYPE_LOOKUP
-    object_reduce_ex = _PyType_Lookup(&PyBaseObject_Type, __pyx_n_s_reduce_ex); if (!object_reduce_ex) goto BAD;
+    object_reduce_ex = _PyType_Lookup(&PyBaseObject_Type, __pyx_n_s_reduce_ex); if (!object_reduce_ex) goto __PYX_BAD;
 #else
-    object_reduce_ex = __Pyx_PyObject_GetAttrStr((PyObject*)&PyBaseObject_Type, __pyx_n_s_reduce_ex); if (!object_reduce_ex) goto BAD;
+    object_reduce_ex = __Pyx_PyObject_GetAttrStr((PyObject*)&PyBaseObject_Type, __pyx_n_s_reduce_ex); if (!object_reduce_ex) goto __PYX_BAD;
 #endif
-    reduce_ex = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce_ex); if (unlikely(!reduce_ex)) goto BAD;
+    reduce_ex = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce_ex); if (unlikely(!reduce_ex)) goto __PYX_BAD;
     if (reduce_ex == object_reduce_ex) {
 #if CYTHON_USE_PYTYPE_LOOKUP
-        object_reduce = _PyType_Lookup(&PyBaseObject_Type, __pyx_n_s_reduce); if (!object_reduce) goto BAD;
+        object_reduce = _PyType_Lookup(&PyBaseObject_Type, __pyx_n_s_reduce); if (!object_reduce) goto __PYX_BAD;
 #else
-        object_reduce = __Pyx_PyObject_GetAttrStr((PyObject*)&PyBaseObject_Type, __pyx_n_s_reduce); if (!object_reduce) goto BAD;
+        object_reduce = __Pyx_PyObject_GetAttrStr((PyObject*)&PyBaseObject_Type, __pyx_n_s_reduce); if (!object_reduce) goto __PYX_BAD;
 #endif
-        reduce = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce); if (unlikely(!reduce)) goto BAD;
+        reduce = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce); if (unlikely(!reduce)) goto __PYX_BAD;
         if (reduce == object_reduce || __Pyx_setup_reduce_is_named(reduce, __pyx_n_s_reduce_cython)) {
-            reduce_cython = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce_cython); if (unlikely(!reduce_cython)) goto BAD;
-            ret = PyDict_SetItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_reduce, reduce_cython); if (unlikely(ret < 0)) goto BAD;
-            ret = PyDict_DelItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_reduce_cython); if (unlikely(ret < 0)) goto BAD;
+            reduce_cython = __Pyx_PyObject_GetAttrStrNoError(type_obj, __pyx_n_s_reduce_cython);
+            if (likely(reduce_cython)) {
+                ret = PyDict_SetItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_reduce, reduce_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
+                ret = PyDict_DelItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_reduce_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
+            } else if (reduce == object_reduce || PyErr_Occurred()) {
+                goto __PYX_BAD;
+            }
             setstate = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_setstate);
             if (!setstate) PyErr_Clear();
             if (!setstate || __Pyx_setup_reduce_is_named(setstate, __pyx_n_s_setstate_cython)) {
-                setstate_cython = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_setstate_cython); if (unlikely(!setstate_cython)) goto BAD;
-                ret = PyDict_SetItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_setstate, setstate_cython); if (unlikely(ret < 0)) goto BAD;
-                ret = PyDict_DelItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_setstate_cython); if (unlikely(ret < 0)) goto BAD;
+                setstate_cython = __Pyx_PyObject_GetAttrStrNoError(type_obj, __pyx_n_s_setstate_cython);
+                if (likely(setstate_cython)) {
+                    ret = PyDict_SetItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_setstate, setstate_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
+                    ret = PyDict_DelItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_setstate_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
+                } else if (!setstate || PyErr_Occurred()) {
+                    goto __PYX_BAD;
+                }
             }
             PyType_Modified((PyTypeObject*)type_obj);
         }
     }
-    goto GOOD;
-BAD:
+    goto __PYX_GOOD;
+__PYX_BAD:
     if (!PyErr_Occurred())
         PyErr_Format(PyExc_RuntimeError, "Unable to initialize pickling for %s", ((PyTypeObject*)type_obj)->tp_name);
     ret = -1;
-GOOD:
+__PYX_GOOD:
 #if !CYTHON_USE_PYTYPE_LOOKUP
     Py_XDECREF(object_reduce);
     Py_XDECREF(object_reduce_ex);
+    Py_XDECREF(object_getstate);
+    Py_XDECREF(getstate);
 #endif
     Py_XDECREF(reduce);
     Py_XDECREF(reduce_ex);
     Py_XDECREF(reduce_cython);
     Py_XDECREF(setstate);
     Py_XDECREF(setstate_cython);
     return ret;
@@ -37689,75 +39704,14 @@
     Py_DECREF(ob);
     return 0;
 bad:
     Py_XDECREF(ob);
     return -1;
 }
 
-/* TypeImport */
-#ifndef __PYX_HAVE_RT_ImportType
-#define __PYX_HAVE_RT_ImportType
-static PyTypeObject *__Pyx_ImportType(PyObject *module, const char *module_name, const char *class_name,
-    size_t size, enum __Pyx_ImportType_CheckSize check_size)
-{
-    PyObject *result = 0;
-    char warning[200];
-    Py_ssize_t basicsize;
-#ifdef Py_LIMITED_API
-    PyObject *py_basicsize;
-#endif
-    result = PyObject_GetAttrString(module, class_name);
-    if (!result)
-        goto bad;
-    if (!PyType_Check(result)) {
-        PyErr_Format(PyExc_TypeError,
-            "%.200s.%.200s is not a type object",
-            module_name, class_name);
-        goto bad;
-    }
-#ifndef Py_LIMITED_API
-    basicsize = ((PyTypeObject *)result)->tp_basicsize;
-#else
-    py_basicsize = PyObject_GetAttrString(result, "__basicsize__");
-    if (!py_basicsize)
-        goto bad;
-    basicsize = PyLong_AsSsize_t(py_basicsize);
-    Py_DECREF(py_basicsize);
-    py_basicsize = 0;
-    if (basicsize == (Py_ssize_t)-1 && PyErr_Occurred())
-        goto bad;
-#endif
-    if ((size_t)basicsize < size) {
-        PyErr_Format(PyExc_ValueError,
-            "%.200s.%.200s size changed, may indicate binary incompatibility. "
-            "Expected %zd from C header, got %zd from PyObject",
-            module_name, class_name, size, basicsize);
-        goto bad;
-    }
-    if (check_size == __Pyx_ImportType_CheckSize_Error && (size_t)basicsize != size) {
-        PyErr_Format(PyExc_ValueError,
-            "%.200s.%.200s size changed, may indicate binary incompatibility. "
-            "Expected %zd from C header, got %zd from PyObject",
-            module_name, class_name, size, basicsize);
-        goto bad;
-    }
-    else if (check_size == __Pyx_ImportType_CheckSize_Warn && (size_t)basicsize > size) {
-        PyOS_snprintf(warning, sizeof(warning),
-            "%s.%s size changed, may indicate binary incompatibility. "
-            "Expected %zd from C header, got %zd from PyObject",
-            module_name, class_name, size, basicsize);
-        if (PyErr_WarnEx(NULL, warning, 0) < 0) goto bad;
-    }
-    return (PyTypeObject *)result;
-bad:
-    Py_XDECREF(result);
-    return NULL;
-}
-#endif
-
 /* CalculateMetaclass */
 static PyObject *__Pyx_CalculateMetaclass(PyTypeObject *metaclass, PyObject *bases) {
     Py_ssize_t i, nbases = PyTuple_GET_SIZE(bases);
     for (i=0; i < nbases; i++) {
         PyTypeObject *tmptype;
         PyObject *tmp = PyTuple_GET_ITEM(bases, i);
         tmptype = Py_TYPE(tmp);
@@ -37828,15 +39782,15 @@
     return cached_type;
 bad:
     Py_XDECREF(cached_type);
     cached_type = NULL;
     goto done;
 }
 
-/* CythonFunction */
+/* CythonFunctionShared */
 #include <structmember.h>
 static PyObject *
 __Pyx_CyFunction_get_doc(__pyx_CyFunctionObject *op, CYTHON_UNUSED void *closure)
 {
     if (unlikely(op->func_doc == NULL)) {
         if (op->func.m_ml->ml_doc) {
 #if PY_MAJOR_VERSION >= 3
@@ -38121,32 +40075,32 @@
     {(char *) "__module__", T_OBJECT, offsetof(PyCFunctionObject, m_module), PY_WRITE_RESTRICTED, 0},
     {0, 0, 0,  0, 0}
 };
 static PyObject *
 __Pyx_CyFunction_reduce(__pyx_CyFunctionObject *m, CYTHON_UNUSED PyObject *args)
 {
 #if PY_MAJOR_VERSION >= 3
-    return PyUnicode_FromString(m->func.m_ml->ml_name);
+    Py_INCREF(m->func_qualname);
+    return m->func_qualname;
 #else
     return PyString_FromString(m->func.m_ml->ml_name);
 #endif
 }
 static PyMethodDef __pyx_CyFunction_methods[] = {
     {"__reduce__", (PyCFunction)__Pyx_CyFunction_reduce, METH_VARARGS, 0},
     {0, 0, 0, 0}
 };
 #if PY_VERSION_HEX < 0x030500A0
 #define __Pyx_CyFunction_weakreflist(cyfunc) ((cyfunc)->func_weakreflist)
 #else
 #define __Pyx_CyFunction_weakreflist(cyfunc) ((cyfunc)->func.m_weakreflist)
 #endif
-static PyObject *__Pyx_CyFunction_New(PyTypeObject *type, PyMethodDef *ml, int flags, PyObject* qualname,
-                                      PyObject *closure, PyObject *module, PyObject* globals, PyObject* code) {
-    __pyx_CyFunctionObject *op = PyObject_GC_New(__pyx_CyFunctionObject, type);
-    if (op == NULL)
+static PyObject *__Pyx_CyFunction_Init(__pyx_CyFunctionObject *op, PyMethodDef *ml, int flags, PyObject* qualname,
+                                       PyObject *closure, PyObject *module, PyObject* globals, PyObject* code) {
+    if (unlikely(op == NULL))
         return NULL;
     op->flags = flags;
     __Pyx_CyFunction_weakreflist(op) = NULL;
     op->func.m_ml = ml;
     op->func.m_self = (PyObject *) op;
     Py_XINCREF(closure);
     op->func_closure = closure;
@@ -38159,20 +40113,20 @@
     op->func_doc = NULL;
     op->func_classobj = NULL;
     op->func_globals = globals;
     Py_INCREF(op->func_globals);
     Py_XINCREF(code);
     op->func_code = code;
     op->defaults_pyobjects = 0;
+    op->defaults_size = 0;
     op->defaults = NULL;
     op->defaults_tuple = NULL;
     op->defaults_kwdict = NULL;
     op->defaults_getter = NULL;
     op->func_annotations = NULL;
-    PyObject_GC_Track(op);
     return (PyObject *) op;
 }
 static int
 __Pyx_CyFunction_clear(__pyx_CyFunctionObject *m)
 {
     Py_CLEAR(m->func_closure);
     Py_CLEAR(m->func.m_module);
@@ -38227,26 +40181,28 @@
         for (i = 0; i < m->defaults_pyobjects; i++)
             Py_VISIT(pydefaults[i]);
     }
     return 0;
 }
 static PyObject *__Pyx_CyFunction_descr_get(PyObject *func, PyObject *obj, PyObject *type)
 {
+#if PY_MAJOR_VERSION < 3
     __pyx_CyFunctionObject *m = (__pyx_CyFunctionObject *) func;
     if (m->flags & __Pyx_CYFUNCTION_STATICMETHOD) {
         Py_INCREF(func);
         return func;
     }
     if (m->flags & __Pyx_CYFUNCTION_CLASSMETHOD) {
         if (type == NULL)
             type = (PyObject *)(Py_TYPE(obj));
         return __Pyx_PyMethod_New(func, type, (PyObject *)(Py_TYPE(type)));
     }
     if (obj == Py_None)
         obj = NULL;
+#endif
     return __Pyx_PyMethod_New(func, obj, type);
 }
 static PyObject*
 __Pyx_CyFunction_repr(__pyx_CyFunctionObject *op)
 {
 #if PY_MAJOR_VERSION >= 3
     return PyUnicode_FromFormat("<cyfunction %U at %p>",
@@ -38323,14 +40279,22 @@
         argc = PyTuple_GET_SIZE(args);
         new_args = PyTuple_GetSlice(args, 1, argc);
         if (unlikely(!new_args))
             return NULL;
         self = PyTuple_GetItem(args, 0);
         if (unlikely(!self)) {
             Py_DECREF(new_args);
+#if PY_MAJOR_VERSION > 2
+            PyErr_Format(PyExc_TypeError,
+                         "unbound method %.200S() needs an argument",
+                         cyfunc->func_qualname);
+#else
+            PyErr_SetString(PyExc_TypeError,
+                            "unbound method needs an argument");
+#endif
             return NULL;
         }
         result = __Pyx_CyFunction_CallMethod(func, self, new_args, kw);
         Py_DECREF(new_args);
     } else {
         result = __Pyx_CyFunction_Call(func, args, kw);
     }
@@ -38391,14 +40355,23 @@
     0,
     0,
     0,
     0,
 #if PY_VERSION_HEX >= 0x030400a1
     0,
 #endif
+#if PY_VERSION_HEX >= 0x030800b1 && (!CYTHON_COMPILING_IN_PYPY || PYPY_VERSION_NUM >= 0x07030800)
+    0,
+#endif
+#if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+    0,
+#endif
+#if CYTHON_COMPILING_IN_PYPY && PY_VERSION_HEX >= 0x03090000
+    0,
+#endif
 };
 static int __pyx_CyFunction_init(void) {
     __pyx_CyFunctionType = __Pyx_FetchCommonType(&__pyx_CyFunctionType_type);
     if (unlikely(__pyx_CyFunctionType == NULL)) {
         return -1;
     }
     return 0;
@@ -38406,14 +40379,15 @@
 static CYTHON_INLINE void *__Pyx_CyFunction_InitDefaults(PyObject *func, size_t size, int pyobjects) {
     __pyx_CyFunctionObject *m = (__pyx_CyFunctionObject *) func;
     m->defaults = PyObject_Malloc(size);
     if (unlikely(!m->defaults))
         return PyErr_NoMemory();
     memset(m->defaults, 0, size);
     m->defaults_pyobjects = pyobjects;
+    m->defaults_size = size;
     return m->defaults;
 }
 static CYTHON_INLINE void __Pyx_CyFunction_SetDefaultsTuple(PyObject *func, PyObject *tuple) {
     __pyx_CyFunctionObject *m = (__pyx_CyFunctionObject *) func;
     m->defaults_tuple = tuple;
     Py_INCREF(tuple);
 }
@@ -38424,14 +40398,27 @@
 }
 static CYTHON_INLINE void __Pyx_CyFunction_SetAnnotationsDict(PyObject *func, PyObject *dict) {
     __pyx_CyFunctionObject *m = (__pyx_CyFunctionObject *) func;
     m->func_annotations = dict;
     Py_INCREF(dict);
 }
 
+/* CythonFunction */
+static PyObject *__Pyx_CyFunction_New(PyMethodDef *ml, int flags, PyObject* qualname,
+                                      PyObject *closure, PyObject *module, PyObject* globals, PyObject* code) {
+    PyObject *op = __Pyx_CyFunction_Init(
+        PyObject_GC_New(__pyx_CyFunctionObject, __pyx_CyFunctionType),
+        ml, flags, qualname, closure, module, globals, code
+    );
+    if (likely(op)) {
+        PyObject_GC_Track(op);
+    }
+    return op;
+}
+
 /* Py3ClassCreate */
 static PyObject *__Pyx_Py3MetaclassPrepare(PyObject *metaclass, PyObject *bases, PyObject *name,
                                            PyObject *qualname, PyObject *mkw, PyObject *modname, PyObject *doc) {
     PyObject *ns;
     if (metaclass) {
         PyObject *prep = __Pyx_PyObject_GetAttrStr(metaclass, __pyx_n_s_prepare);
         if (prep) {
@@ -38491,144 +40478,17 @@
         result = PyObject_Call(metaclass, margs, mkw);
         Py_DECREF(margs);
     }
     Py_XDECREF(owned_metaclass);
     return result;
 }
 
-/* PyObjectGetMethod */
-static int __Pyx_PyObject_GetMethod(PyObject *obj, PyObject *name, PyObject **method) {
-    PyObject *attr;
-#if CYTHON_UNPACK_METHODS && CYTHON_COMPILING_IN_CPYTHON && CYTHON_USE_PYTYPE_LOOKUP
-    PyTypeObject *tp = Py_TYPE(obj);
-    PyObject *descr;
-    descrgetfunc f = NULL;
-    PyObject **dictptr, *dict;
-    int meth_found = 0;
-    assert (*method == NULL);
-    if (unlikely(tp->tp_getattro != PyObject_GenericGetAttr)) {
-        attr = __Pyx_PyObject_GetAttrStr(obj, name);
-        goto try_unpack;
-    }
-    if (unlikely(tp->tp_dict == NULL) && unlikely(PyType_Ready(tp) < 0)) {
-        return 0;
-    }
-    descr = _PyType_Lookup(tp, name);
-    if (likely(descr != NULL)) {
-        Py_INCREF(descr);
-#if PY_MAJOR_VERSION >= 3
-        #ifdef __Pyx_CyFunction_USED
-        if (likely(PyFunction_Check(descr) || (Py_TYPE(descr) == &PyMethodDescr_Type) || __Pyx_CyFunction_Check(descr)))
-        #else
-        if (likely(PyFunction_Check(descr) || (Py_TYPE(descr) == &PyMethodDescr_Type)))
-        #endif
-#else
-        #ifdef __Pyx_CyFunction_USED
-        if (likely(PyFunction_Check(descr) || __Pyx_CyFunction_Check(descr)))
-        #else
-        if (likely(PyFunction_Check(descr)))
-        #endif
-#endif
-        {
-            meth_found = 1;
-        } else {
-            f = Py_TYPE(descr)->tp_descr_get;
-            if (f != NULL && PyDescr_IsData(descr)) {
-                attr = f(descr, obj, (PyObject *)Py_TYPE(obj));
-                Py_DECREF(descr);
-                goto try_unpack;
-            }
-        }
-    }
-    dictptr = _PyObject_GetDictPtr(obj);
-    if (dictptr != NULL && (dict = *dictptr) != NULL) {
-        Py_INCREF(dict);
-        attr = __Pyx_PyDict_GetItemStr(dict, name);
-        if (attr != NULL) {
-            Py_INCREF(attr);
-            Py_DECREF(dict);
-            Py_XDECREF(descr);
-            goto try_unpack;
-        }
-        Py_DECREF(dict);
-    }
-    if (meth_found) {
-        *method = descr;
-        return 1;
-    }
-    if (f != NULL) {
-        attr = f(descr, obj, (PyObject *)Py_TYPE(obj));
-        Py_DECREF(descr);
-        goto try_unpack;
-    }
-    if (descr != NULL) {
-        *method = descr;
-        return 0;
-    }
-    PyErr_Format(PyExc_AttributeError,
-#if PY_MAJOR_VERSION >= 3
-                 "'%.50s' object has no attribute '%U'",
-                 tp->tp_name, name);
-#else
-                 "'%.50s' object has no attribute '%.400s'",
-                 tp->tp_name, PyString_AS_STRING(name));
-#endif
-    return 0;
-#else
-    attr = __Pyx_PyObject_GetAttrStr(obj, name);
-    goto try_unpack;
-#endif
-try_unpack:
-#if CYTHON_UNPACK_METHODS
-    if (likely(attr) && PyMethod_Check(attr) && likely(PyMethod_GET_SELF(attr) == obj)) {
-        PyObject *function = PyMethod_GET_FUNCTION(attr);
-        Py_INCREF(function);
-        Py_DECREF(attr);
-        *method = function;
-        return 1;
-    }
-#endif
-    *method = attr;
-    return 0;
-}
-
-/* PyObjectCallMethod1 */
-static PyObject* __Pyx__PyObject_CallMethod1(PyObject* method, PyObject* arg) {
-    PyObject *result = __Pyx_PyObject_CallOneArg(method, arg);
-    Py_DECREF(method);
-    return result;
-}
-static PyObject* __Pyx_PyObject_CallMethod1(PyObject* obj, PyObject* method_name, PyObject* arg) {
-    PyObject *method = NULL, *result;
-    int is_method = __Pyx_PyObject_GetMethod(obj, method_name, &method);
-    if (likely(is_method)) {
-        result = __Pyx_PyObject_Call2Args(method, obj, arg);
-        Py_DECREF(method);
-        return result;
-    }
-    if (unlikely(!method)) return NULL;
-    return __Pyx__PyObject_CallMethod1(method, arg);
-}
-
-/* append */
-static CYTHON_INLINE int __Pyx_PyObject_Append(PyObject* L, PyObject* x) {
-    if (likely(PyList_CheckExact(L))) {
-        if (unlikely(__Pyx_PyList_Append(L, x) < 0)) return -1;
-    } else {
-        PyObject* retval = __Pyx_PyObject_CallMethod1(L, __pyx_n_s_append, x);
-        if (unlikely(!retval))
-            return -1;
-        Py_DECREF(retval);
-    }
-    return 0;
-}
-
 /* CLineInTraceback */
 #ifndef CYTHON_CLINE_IN_TRACEBACK
-static int __Pyx_CLineForTraceback(PyThreadState *tstate, int c_line) {
+static int __Pyx_CLineForTraceback(CYTHON_UNUSED PyThreadState *tstate, int c_line) {
     PyObject *use_cline;
     PyObject *ptype, *pvalue, *ptraceback;
 #if CYTHON_COMPILING_IN_CPYTHON
     PyObject **cython_runtime_dict;
 #endif
     if (unlikely(!__pyx_cython_runtime)) {
         return c_line;
@@ -38650,15 +40510,15 @@
       } else {
         PyErr_Clear();
         use_cline = NULL;
       }
     }
     if (!use_cline) {
         c_line = 0;
-        PyObject_SetAttr(__pyx_cython_runtime, __pyx_n_s_cline_in_traceback, Py_False);
+        (void) PyObject_SetAttr(__pyx_cython_runtime, __pyx_n_s_cline_in_traceback, Py_False);
     }
     else if (use_cline == Py_False || (use_cline != Py_True && PyObject_Not(use_cline) != 0)) {
         c_line = 0;
     }
     __Pyx_ErrRestoreInState(tstate, ptype, pvalue, ptraceback);
     return c_line;
 }
@@ -38724,15 +40584,15 @@
         entries[pos].code_object = code_object;
         Py_DECREF(tmp);
         return;
     }
     if (__pyx_code_cache.count == __pyx_code_cache.max_count) {
         int new_max = __pyx_code_cache.max_count + 64;
         entries = (__Pyx_CodeObjectCacheEntry*)PyMem_Realloc(
-            __pyx_code_cache.entries, (size_t)new_max*sizeof(__Pyx_CodeObjectCacheEntry));
+            __pyx_code_cache.entries, ((size_t)new_max) * sizeof(__Pyx_CodeObjectCacheEntry));
         if (unlikely(!entries)) {
             return;
         }
         __pyx_code_cache.entries = entries;
         __pyx_code_cache.max_count = new_max;
     }
     for (i=__pyx_code_cache.count; i>pos; i--) {
@@ -38744,41 +40604,48 @@
     Py_INCREF(code_object);
 }
 
 /* AddTraceback */
 #include "compile.h"
 #include "frameobject.h"
 #include "traceback.h"
+#if PY_VERSION_HEX >= 0x030b00a6
+  #ifndef Py_BUILD_CORE
+    #define Py_BUILD_CORE 1
+  #endif
+  #include "internal/pycore_frame.h"
+#endif
 static PyCodeObject* __Pyx_CreateCodeObjectForTraceback(
             const char *funcname, int c_line,
             int py_line, const char *filename) {
-    PyCodeObject *py_code = 0;
-    PyObject *py_srcfile = 0;
-    PyObject *py_funcname = 0;
+    PyCodeObject *py_code = NULL;
+    PyObject *py_funcname = NULL;
     #if PY_MAJOR_VERSION < 3
+    PyObject *py_srcfile = NULL;
     py_srcfile = PyString_FromString(filename);
-    #else
-    py_srcfile = PyUnicode_FromString(filename);
-    #endif
     if (!py_srcfile) goto bad;
+    #endif
     if (c_line) {
         #if PY_MAJOR_VERSION < 3
         py_funcname = PyString_FromFormat( "%s (%s:%d)", funcname, __pyx_cfilenm, c_line);
+        if (!py_funcname) goto bad;
         #else
         py_funcname = PyUnicode_FromFormat( "%s (%s:%d)", funcname, __pyx_cfilenm, c_line);
+        if (!py_funcname) goto bad;
+        funcname = PyUnicode_AsUTF8(py_funcname);
+        if (!funcname) goto bad;
         #endif
     }
     else {
         #if PY_MAJOR_VERSION < 3
         py_funcname = PyString_FromString(funcname);
-        #else
-        py_funcname = PyUnicode_FromString(funcname);
+        if (!py_funcname) goto bad;
         #endif
     }
-    if (!py_funcname) goto bad;
+    #if PY_MAJOR_VERSION < 3
     py_code = __Pyx_PyCode_New(
         0,
         0,
         0,
         0,
         0,
         __pyx_empty_bytes, /*PyObject *code,*/
@@ -38789,34 +40656,49 @@
         __pyx_empty_tuple, /*PyObject *cellvars,*/
         py_srcfile,   /*PyObject *filename,*/
         py_funcname,  /*PyObject *name,*/
         py_line,
         __pyx_empty_bytes  /*PyObject *lnotab*/
     );
     Py_DECREF(py_srcfile);
-    Py_DECREF(py_funcname);
+    #else
+    py_code = PyCode_NewEmpty(filename, funcname, py_line);
+    #endif
+    Py_XDECREF(py_funcname);  // XDECREF since it's only set on Py3 if cline
     return py_code;
 bad:
-    Py_XDECREF(py_srcfile);
     Py_XDECREF(py_funcname);
+    #if PY_MAJOR_VERSION < 3
+    Py_XDECREF(py_srcfile);
+    #endif
     return NULL;
 }
 static void __Pyx_AddTraceback(const char *funcname, int c_line,
                                int py_line, const char *filename) {
     PyCodeObject *py_code = 0;
     PyFrameObject *py_frame = 0;
     PyThreadState *tstate = __Pyx_PyThreadState_Current;
+    PyObject *ptype, *pvalue, *ptraceback;
     if (c_line) {
         c_line = __Pyx_CLineForTraceback(tstate, c_line);
     }
     py_code = __pyx_find_code_object(c_line ? -c_line : py_line);
     if (!py_code) {
+        __Pyx_ErrFetchInState(tstate, &ptype, &pvalue, &ptraceback);
         py_code = __Pyx_CreateCodeObjectForTraceback(
             funcname, c_line, py_line, filename);
-        if (!py_code) goto bad;
+        if (!py_code) {
+            /* If the code object creation fails, then we should clear the
+               fetched exception references and propagate the new exception */
+            Py_XDECREF(ptype);
+            Py_XDECREF(pvalue);
+            Py_XDECREF(ptraceback);
+            goto bad;
+        }
+        __Pyx_ErrRestoreInState(tstate, ptype, pvalue, ptraceback);
         __pyx_insert_code_object(c_line ? -c_line : py_line, py_code);
     }
     py_frame = PyFrame_New(
         tstate,            /*PyThreadState *tstate,*/
         py_code,           /*PyCodeObject *code,*/
         __pyx_d,    /*PyObject *globals,*/
         0                  /*PyObject *locals*/
@@ -38878,21 +40760,21 @@
         if (b.imag == 0) {
             return __pyx_t_double_complex_from_parts(a.real / b.real, a.imag / b.real);
         } else if (fabs(b.real) >= fabs(b.imag)) {
             if (b.real == 0 && b.imag == 0) {
                 return __pyx_t_double_complex_from_parts(a.real / b.real, a.imag / b.imag);
             } else {
                 double r = b.imag / b.real;
-                double s = 1.0 / (b.real + b.imag * r);
+                double s = (double)(1.0) / (b.real + b.imag * r);
                 return __pyx_t_double_complex_from_parts(
                     (a.real + a.imag * r) * s, (a.imag - a.real * r) * s);
             }
         } else {
             double r = b.real / b.imag;
-            double s = 1.0 / (b.imag + b.real * r);
+            double s = (double)(1.0) / (b.imag + b.real * r);
             return __pyx_t_double_complex_from_parts(
                 (a.real * r + a.imag) * s, (a.imag * r - a.real) * s);
         }
     }
     #else
     static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_quot_double(__pyx_t_double_complex a, __pyx_t_double_complex b) {
         if (b.imag == 0) {
@@ -38942,37 +40824,36 @@
                     case 0:
                         z.real = 1;
                         z.imag = 0;
                         return z;
                     case 1:
                         return a;
                     case 2:
-                        z = __Pyx_c_prod_double(a, a);
                         return __Pyx_c_prod_double(a, a);
                     case 3:
                         z = __Pyx_c_prod_double(a, a);
                         return __Pyx_c_prod_double(z, a);
                     case 4:
                         z = __Pyx_c_prod_double(a, a);
                         return __Pyx_c_prod_double(z, z);
                 }
             }
             if (a.imag == 0) {
                 if (a.real == 0) {
                     return a;
-                } else if (b.imag == 0) {
+                } else if ((b.imag == 0) && (a.real >= 0)) {
                     z.real = pow(a.real, b.real);
                     z.imag = 0;
                     return z;
                 } else if (a.real > 0) {
                     r = a.real;
                     theta = 0;
                 } else {
                     r = -a.real;
-                    theta = atan2(0, -1);
+                    theta = atan2(0.0, -1.0);
                 }
             } else {
                 r = __Pyx_c_abs_double(a);
                 theta = atan2(a.imag, a.real);
             }
             lnr = log(r);
             z_r = exp(lnr * b.real - theta * b.imag);
@@ -39073,45 +40954,14 @@
     cobj = PyCapsule_New(p, sig, NULL);
 #else
     cobj = PyCObject_FromVoidPtr(p, NULL);
 #endif
     return cobj;
 }
 
-/* CIntToPy */
-static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value) {
-    const int neg_one = (int) ((int) 0 - (int) 1), const_zero = (int) 0;
-    const int is_unsigned = neg_one > const_zero;
-    if (is_unsigned) {
-        if (sizeof(int) < sizeof(long)) {
-            return PyInt_FromLong((long) value);
-        } else if (sizeof(int) <= sizeof(unsigned long)) {
-            return PyLong_FromUnsignedLong((unsigned long) value);
-#ifdef HAVE_LONG_LONG
-        } else if (sizeof(int) <= sizeof(unsigned PY_LONG_LONG)) {
-            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
-#endif
-        }
-    } else {
-        if (sizeof(int) <= sizeof(long)) {
-            return PyInt_FromLong((long) value);
-#ifdef HAVE_LONG_LONG
-        } else if (sizeof(int) <= sizeof(PY_LONG_LONG)) {
-            return PyLong_FromLongLong((PY_LONG_LONG) value);
-#endif
-        }
-    }
-    {
-        int one = 1; int little = (int)*(unsigned char *)&one;
-        unsigned char *bytes = (unsigned char *)&value;
-        return _PyLong_FromByteArray(bytes, sizeof(int),
-                                     little, !is_unsigned);
-    }
-}
-
 /* CIntFromPyVerify */
 #define __PYX_VERIFY_RETURN_INT(target_type, func_type, func_value)\
     __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, 0)
 #define __PYX_VERIFY_RETURN_INT_EXC(target_type, func_type, func_value)\
     __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, 1)
 #define __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, exc)\
     {\
@@ -39126,45 +40976,14 @@
                 else\
                     goto raise_overflow;\
             }\
         }\
         return (target_type) value;\
     }
 
-/* CIntToPy */
-static CYTHON_INLINE PyObject* __Pyx_PyInt_From_unsigned_int(unsigned int value) {
-    const unsigned int neg_one = (unsigned int) ((unsigned int) 0 - (unsigned int) 1), const_zero = (unsigned int) 0;
-    const int is_unsigned = neg_one > const_zero;
-    if (is_unsigned) {
-        if (sizeof(unsigned int) < sizeof(long)) {
-            return PyInt_FromLong((long) value);
-        } else if (sizeof(unsigned int) <= sizeof(unsigned long)) {
-            return PyLong_FromUnsignedLong((unsigned long) value);
-#ifdef HAVE_LONG_LONG
-        } else if (sizeof(unsigned int) <= sizeof(unsigned PY_LONG_LONG)) {
-            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
-#endif
-        }
-    } else {
-        if (sizeof(unsigned int) <= sizeof(long)) {
-            return PyInt_FromLong((long) value);
-#ifdef HAVE_LONG_LONG
-        } else if (sizeof(unsigned int) <= sizeof(PY_LONG_LONG)) {
-            return PyLong_FromLongLong((PY_LONG_LONG) value);
-#endif
-        }
-    }
-    {
-        int one = 1; int little = (int)*(unsigned char *)&one;
-        unsigned char *bytes = (unsigned char *)&value;
-        return _PyLong_FromByteArray(bytes, sizeof(unsigned int),
-                                     little, !is_unsigned);
-    }
-}
-
 /* IsLittleEndian */
 static CYTHON_INLINE int __Pyx_Is_Little_Endian(void)
 {
   union {
     uint32_t u32;
     uint8_t u8[4];
   } S;
@@ -39203,15 +41022,15 @@
 static int __Pyx_BufFmt_ParseNumber(const char** ts) {
     int count;
     const char* t = *ts;
     if (*t < '0' || *t > '9') {
       return -1;
     } else {
         count = *t++ - '0';
-        while (*t >= '0' && *t < '9') {
+        while (*t >= '0' && *t <= '9') {
             count *= 10;
             count += *t++ - '0';
         }
     }
     *ts = t;
     return count;
 }
@@ -39224,14 +41043,15 @@
 }
 static void __Pyx_BufFmt_RaiseUnexpectedChar(char ch) {
   PyErr_Format(PyExc_ValueError,
                "Unexpected format string character: '%c'", ch);
 }
 static const char* __Pyx_BufFmt_DescribeTypeChar(char ch, int is_complex) {
   switch (ch) {
+    case '?': return "'bool'";
     case 'c': return "'char'";
     case 'b': return "'signed char'";
     case 'B': return "'unsigned char'";
     case 'h': return "'short'";
     case 'H': return "'unsigned short'";
     case 'i': return "'int'";
     case 'I': return "'unsigned int'";
@@ -39266,15 +41086,15 @@
     default:
       __Pyx_BufFmt_RaiseUnexpectedChar(ch);
       return 0;
     }
 }
 static size_t __Pyx_BufFmt_TypeCharToNativeSize(char ch, int is_complex) {
   switch (ch) {
-    case 'c': case 'b': case 'B': case 's': case 'p': return 1;
+    case '?': case 'c': case 'b': case 'B': case 's': case 'p': return 1;
     case 'h': case 'H': return sizeof(short);
     case 'i': case 'I': return sizeof(int);
     case 'l': case 'L': return sizeof(long);
     #ifdef HAVE_LONG_LONG
     case 'q': case 'Q': return sizeof(PY_LONG_LONG);
     #endif
     case 'f': return sizeof(float) * (is_complex ? 2 : 1);
@@ -39350,15 +41170,15 @@
 static char __Pyx_BufFmt_TypeCharToGroup(char ch, int is_complex) {
   switch (ch) {
     case 'c':
         return 'H';
     case 'b': case 'h': case 'i':
     case 'l': case 'q': case 's': case 'p':
         return 'I';
-    case 'B': case 'H': case 'I': case 'L': case 'Q':
+    case '?': case 'B': case 'H': case 'I': case 'L': case 'Q':
         return 'U';
     case 'f': case 'd': case 'g':
         return (is_complex ? 'C' : 'R');
     case 'O':
         return 'O';
     case 'P':
         return 'P';
@@ -39494,24 +41314,23 @@
   ctx->is_complex = 0;
   return 0;
 }
 static PyObject *
 __pyx_buffmt_parse_array(__Pyx_BufFmt_Context* ctx, const char** tsp)
 {
     const char *ts = *tsp;
-    int i = 0, number;
-    int ndim = ctx->head->field->type->ndim;
-;
+    int i = 0, number, ndim;
     ++ts;
     if (ctx->new_count != 1) {
         PyErr_SetString(PyExc_ValueError,
                         "Cannot handle repeated arrays in format string");
         return NULL;
     }
     if (__Pyx_BufFmt_ProcessTypeChunk(ctx) == -1) return NULL;
+    ndim = ctx->head->field->type->ndim;
     while (*ts && *ts != ')') {
         switch (*ts) {
             case ' ': case '\f': case '\r': case '\n': case '\t': case '\v':  continue;
             default:  break;
         }
         number = __Pyx_BufFmt_ExpectNumber(&ts);
         if (number == -1) return NULL;
@@ -39629,20 +41448,20 @@
         got_Z = 1;
         ++ts;
         if (*ts != 'f' && *ts != 'd' && *ts != 'g') {
           __Pyx_BufFmt_RaiseUnexpectedChar('Z');
           return NULL;
         }
         CYTHON_FALLTHROUGH;
-      case 'c': case 'b': case 'B': case 'h': case 'H': case 'i': case 'I':
+      case '?': case 'c': case 'b': case 'B': case 'h': case 'H': case 'i': case 'I':
       case 'l': case 'L': case 'q': case 'Q':
       case 'f': case 'd': case 'g':
       case 'O': case 'p':
-        if (ctx->enc_type == *ts && got_Z == ctx->is_complex &&
-            ctx->enc_packmode == ctx->new_packmode) {
+        if ((ctx->enc_type == *ts) && (got_Z == ctx->is_complex) &&
+            (ctx->enc_packmode == ctx->new_packmode) && (!ctx->is_valid_array)) {
           ctx->enc_count += ctx->new_count;
           ctx->new_count = 1;
           got_Z = 0;
           ++ts;
           break;
         }
         CYTHON_FALLTHROUGH;
@@ -39720,72 +41539,72 @@
 __pyx_check_strides(Py_buffer *buf, int dim, int ndim, int spec)
 {
     if (buf->shape[dim] <= 1)
         return 1;
     if (buf->strides) {
         if (spec & __Pyx_MEMVIEW_CONTIG) {
             if (spec & (__Pyx_MEMVIEW_PTR|__Pyx_MEMVIEW_FULL)) {
-                if (buf->strides[dim] != sizeof(void *)) {
+                if (unlikely(buf->strides[dim] != sizeof(void *))) {
                     PyErr_Format(PyExc_ValueError,
                                  "Buffer is not indirectly contiguous "
                                  "in dimension %d.", dim);
                     goto fail;
                 }
-            } else if (buf->strides[dim] != buf->itemsize) {
+            } else if (unlikely(buf->strides[dim] != buf->itemsize)) {
                 PyErr_SetString(PyExc_ValueError,
                                 "Buffer and memoryview are not contiguous "
                                 "in the same dimension.");
                 goto fail;
             }
         }
         if (spec & __Pyx_MEMVIEW_FOLLOW) {
             Py_ssize_t stride = buf->strides[dim];
             if (stride < 0)
                 stride = -stride;
-            if (stride < buf->itemsize) {
+            if (unlikely(stride < buf->itemsize)) {
                 PyErr_SetString(PyExc_ValueError,
                                 "Buffer and memoryview are not contiguous "
                                 "in the same dimension.");
                 goto fail;
             }
         }
     } else {
-        if (spec & __Pyx_MEMVIEW_CONTIG && dim != ndim - 1) {
+        if (unlikely(spec & __Pyx_MEMVIEW_CONTIG && dim != ndim - 1)) {
             PyErr_Format(PyExc_ValueError,
                          "C-contiguous buffer is not contiguous in "
                          "dimension %d", dim);
             goto fail;
-        } else if (spec & (__Pyx_MEMVIEW_PTR)) {
+        } else if (unlikely(spec & (__Pyx_MEMVIEW_PTR))) {
             PyErr_Format(PyExc_ValueError,
                          "C-contiguous buffer is not indirect in "
                          "dimension %d", dim);
             goto fail;
-        } else if (buf->suboffsets) {
+        } else if (unlikely(buf->suboffsets)) {
             PyErr_SetString(PyExc_ValueError,
                             "Buffer exposes suboffsets but no strides");
             goto fail;
         }
     }
     return 1;
 fail:
     return 0;
 }
 static int
 __pyx_check_suboffsets(Py_buffer *buf, int dim, CYTHON_UNUSED int ndim, int spec)
 {
     if (spec & __Pyx_MEMVIEW_DIRECT) {
-        if (buf->suboffsets && buf->suboffsets[dim] >= 0) {
+        if (unlikely(buf->suboffsets && buf->suboffsets[dim] >= 0)) {
             PyErr_Format(PyExc_ValueError,
                          "Buffer not compatible with direct access "
                          "in dimension %d.", dim);
             goto fail;
         }
     }
     if (spec & __Pyx_MEMVIEW_PTR) {
-        if (!buf->suboffsets || (buf->suboffsets && buf->suboffsets[dim] < 0)) {
+        if (unlikely(!buf->suboffsets || (buf->suboffsets[dim] < 0))) {
             PyErr_Format(PyExc_ValueError,
                          "Buffer is not indirectly accessible "
                          "in dimension %d.", dim);
             goto fail;
         }
     }
     return 1;
@@ -39795,28 +41614,25 @@
 static int
 __pyx_verify_contig(Py_buffer *buf, int ndim, int c_or_f_flag)
 {
     int i;
     if (c_or_f_flag & __Pyx_IS_F_CONTIG) {
         Py_ssize_t stride = 1;
         for (i = 0; i < ndim; i++) {
-            if (stride * buf->itemsize != buf->strides[i] &&
-                    buf->shape[i] > 1)
-            {
+            if (unlikely(stride * buf->itemsize != buf->strides[i]  &&  buf->shape[i] > 1)) {
                 PyErr_SetString(PyExc_ValueError,
                     "Buffer not fortran contiguous.");
                 goto fail;
             }
             stride = stride * buf->shape[i];
         }
     } else if (c_or_f_flag & __Pyx_IS_C_CONTIG) {
         Py_ssize_t stride = 1;
         for (i = ndim - 1; i >- 1; i--) {
-            if (stride * buf->itemsize != buf->strides[i] &&
-                    buf->shape[i] > 1) {
+            if (unlikely(stride * buf->itemsize != buf->strides[i]  &&  buf->shape[i] > 1)) {
                 PyErr_SetString(PyExc_ValueError,
                     "Buffer not C contiguous.");
                 goto fail;
             }
             stride = stride * buf->shape[i];
         }
     }
@@ -39849,44 +41665,46 @@
         memview = (struct __pyx_memoryview_obj *) __pyx_memoryview_new(
                                             original_obj, buf_flags, 0, dtype);
         new_memview = memview;
         if (unlikely(!memview))
             goto fail;
     }
     buf = &memview->view;
-    if (buf->ndim != ndim) {
+    if (unlikely(buf->ndim != ndim)) {
         PyErr_Format(PyExc_ValueError,
                 "Buffer has wrong number of dimensions (expected %d, got %d)",
                 ndim, buf->ndim);
         goto fail;
     }
     if (new_memview) {
         __Pyx_BufFmt_Init(&ctx, stack, dtype);
-        if (!__Pyx_BufFmt_CheckString(&ctx, buf->format)) goto fail;
+        if (unlikely(!__Pyx_BufFmt_CheckString(&ctx, buf->format))) goto fail;
     }
-    if ((unsigned) buf->itemsize != dtype->size) {
+    if (unlikely((unsigned) buf->itemsize != dtype->size)) {
         PyErr_Format(PyExc_ValueError,
                      "Item size of buffer (%" CYTHON_FORMAT_SSIZE_T "u byte%s) "
                      "does not match size of '%s' (%" CYTHON_FORMAT_SSIZE_T "u byte%s)",
                      buf->itemsize,
                      (buf->itemsize > 1) ? "s" : "",
                      dtype->name,
                      dtype->size,
                      (dtype->size > 1) ? "s" : "");
         goto fail;
     }
-    for (i = 0; i < ndim; i++) {
-        spec = axes_specs[i];
-        if (!__pyx_check_strides(buf, i, ndim, spec))
-            goto fail;
-        if (!__pyx_check_suboffsets(buf, i, ndim, spec))
+    if (buf->len > 0) {
+        for (i = 0; i < ndim; i++) {
+            spec = axes_specs[i];
+            if (unlikely(!__pyx_check_strides(buf, i, ndim, spec)))
+                goto fail;
+            if (unlikely(!__pyx_check_suboffsets(buf, i, ndim, spec)))
+                goto fail;
+        }
+        if (unlikely(buf->strides && !__pyx_verify_contig(buf, ndim, c_or_f_flag)))
             goto fail;
     }
-    if (buf->strides && !__pyx_verify_contig(buf, ndim, c_or_f_flag))
-        goto fail;
     if (unlikely(__Pyx_init_memviewslice(memview, ndim, memviewslice,
                                          new_memview != NULL) == -1)) {
         goto fail;
     }
     retval = 0;
     goto no_fail;
 fail:
@@ -39917,82 +41735,110 @@
 __pyx_fail:
     result.memview = NULL;
     result.data = NULL;
     return result;
 }
 
 /* ObjectToMemviewSlice */
-  static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex__const__(PyObject *obj, int writable_flag) {
+  static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex__const__(PyObject *obj, int writable_flag) {
     __Pyx_memviewslice result = { 0, 0, { 0 }, { 0 }, { 0 } };
     __Pyx_BufFmt_StackElem stack[1];
-    int axes_specs[] = { (__Pyx_MEMVIEW_DIRECT | __Pyx_MEMVIEW_CONTIG) };
+    int axes_specs[] = { (__Pyx_MEMVIEW_DIRECT | __Pyx_MEMVIEW_STRIDED) };
     int retcode;
     if (obj == Py_None) {
         result.memview = (struct __pyx_memoryview_obj *) Py_None;
         return result;
     }
-    retcode = __Pyx_ValidateAndInit_memviewslice(axes_specs, __Pyx_IS_C_CONTIG,
-                                                 (PyBUF_C_CONTIGUOUS | PyBUF_FORMAT) | writable_flag, 1,
+    retcode = __Pyx_ValidateAndInit_memviewslice(axes_specs, 0,
+                                                 PyBUF_RECORDS_RO | writable_flag, 1,
                                                  &__Pyx_TypeInfo___pyx_t_double_complex__const__, stack,
                                                  &result, obj);
     if (unlikely(retcode == -1))
         goto __pyx_fail;
     return result;
 __pyx_fail:
     result.memview = NULL;
     result.data = NULL;
     return result;
 }
 
 /* ObjectToMemviewSlice */
-  static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex(PyObject *obj, int writable_flag) {
+  static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_ds_int(PyObject *obj, int writable_flag) {
+    __Pyx_memviewslice result = { 0, 0, { 0 }, { 0 }, { 0 } };
+    __Pyx_BufFmt_StackElem stack[1];
+    int axes_specs[] = { (__Pyx_MEMVIEW_DIRECT | __Pyx_MEMVIEW_STRIDED) };
+    int retcode;
+    if (obj == Py_None) {
+        result.memview = (struct __pyx_memoryview_obj *) Py_None;
+        return result;
+    }
+    retcode = __Pyx_ValidateAndInit_memviewslice(axes_specs, 0,
+                                                 PyBUF_RECORDS_RO | writable_flag, 1,
+                                                 &__Pyx_TypeInfo_int, stack,
+                                                 &result, obj);
+    if (unlikely(retcode == -1))
+        goto __pyx_fail;
+    return result;
+__pyx_fail:
+    result.memview = NULL;
+    result.data = NULL;
+    return result;
+}
+
+/* ObjectToMemviewSlice */
+  static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex__const__(PyObject *obj, int writable_flag) {
     __Pyx_memviewslice result = { 0, 0, { 0 }, { 0 }, { 0 } };
     __Pyx_BufFmt_StackElem stack[1];
     int axes_specs[] = { (__Pyx_MEMVIEW_DIRECT | __Pyx_MEMVIEW_CONTIG) };
     int retcode;
     if (obj == Py_None) {
         result.memview = (struct __pyx_memoryview_obj *) Py_None;
         return result;
     }
     retcode = __Pyx_ValidateAndInit_memviewslice(axes_specs, __Pyx_IS_C_CONTIG,
                                                  (PyBUF_C_CONTIGUOUS | PyBUF_FORMAT) | writable_flag, 1,
-                                                 &__Pyx_TypeInfo___pyx_t_double_complex, stack,
+                                                 &__Pyx_TypeInfo___pyx_t_double_complex__const__, stack,
                                                  &result, obj);
     if (unlikely(retcode == -1))
         goto __pyx_fail;
     return result;
 __pyx_fail:
     result.memview = NULL;
     result.data = NULL;
     return result;
 }
 
 /* ObjectToMemviewSlice */
-  static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_ds___pyx_t_double_complex__const__(PyObject *obj, int writable_flag) {
+  static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_dc___pyx_t_double_complex(PyObject *obj, int writable_flag) {
     __Pyx_memviewslice result = { 0, 0, { 0 }, { 0 }, { 0 } };
     __Pyx_BufFmt_StackElem stack[1];
-    int axes_specs[] = { (__Pyx_MEMVIEW_DIRECT | __Pyx_MEMVIEW_STRIDED) };
+    int axes_specs[] = { (__Pyx_MEMVIEW_DIRECT | __Pyx_MEMVIEW_CONTIG) };
     int retcode;
     if (obj == Py_None) {
         result.memview = (struct __pyx_memoryview_obj *) Py_None;
         return result;
     }
-    retcode = __Pyx_ValidateAndInit_memviewslice(axes_specs, 0,
-                                                 PyBUF_RECORDS_RO | writable_flag, 1,
-                                                 &__Pyx_TypeInfo___pyx_t_double_complex__const__, stack,
+    retcode = __Pyx_ValidateAndInit_memviewslice(axes_specs, __Pyx_IS_C_CONTIG,
+                                                 (PyBUF_C_CONTIGUOUS | PyBUF_FORMAT) | writable_flag, 1,
+                                                 &__Pyx_TypeInfo___pyx_t_double_complex, stack,
                                                  &result, obj);
     if (unlikely(retcode == -1))
         goto __pyx_fail;
     return result;
 __pyx_fail:
     result.memview = NULL;
     result.data = NULL;
     return result;
 }
 
+/* MemviewDtypeToObject */
+  static CYTHON_INLINE PyObject *__pyx_memview_get___pyx_t_double_complex__const__(const char *itemp) {
+    return (PyObject *) __pyx_PyComplex_FromComplex(*(__pyx_t_double_complex const  *) itemp);
+}
+
 /* FromPy */
   static __pyx_t_double_complex __Pyx_PyComplex_As___pyx_t_double_complex(PyObject* o) {
     Py_complex cval;
 #if !CYTHON_COMPILING_IN_PYPY
     if (PyComplex_CheckExact(o))
         cval = ((PyComplexObject *)o)->cval;
     else
@@ -40011,50 +41857,14 @@
     __pyx_t_double_complex value = __Pyx_PyComplex_As___pyx_t_double_complex(obj);
     if (PyErr_Occurred())
         return 0;
     *(__pyx_t_double_complex *) itemp = value;
     return 1;
 }
 
-/* CIntToPy */
-  static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value) {
-    const long neg_one = (long) ((long) 0 - (long) 1), const_zero = (long) 0;
-    const int is_unsigned = neg_one > const_zero;
-    if (is_unsigned) {
-        if (sizeof(long) < sizeof(long)) {
-            return PyInt_FromLong((long) value);
-        } else if (sizeof(long) <= sizeof(unsigned long)) {
-            return PyLong_FromUnsignedLong((unsigned long) value);
-#ifdef HAVE_LONG_LONG
-        } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
-            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
-#endif
-        }
-    } else {
-        if (sizeof(long) <= sizeof(long)) {
-            return PyInt_FromLong((long) value);
-#ifdef HAVE_LONG_LONG
-        } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
-            return PyLong_FromLongLong((PY_LONG_LONG) value);
-#endif
-        }
-    }
-    {
-        int one = 1; int little = (int)*(unsigned char *)&one;
-        unsigned char *bytes = (unsigned char *)&value;
-        return _PyLong_FromByteArray(bytes, sizeof(long),
-                                     little, !is_unsigned);
-    }
-}
-
-/* MemviewDtypeToObject */
-  static CYTHON_INLINE PyObject *__pyx_memview_get___pyx_t_double_complex__const__(const char *itemp) {
-    return (PyObject *) __pyx_PyComplex_FromComplex(*(__pyx_t_double_complex const  *) itemp);
-}
-
 /* MemviewSliceCopyTemplate */
   static __Pyx_memviewslice
 __pyx_memoryview_copy_new_contig(const __Pyx_memviewslice *from_mvs,
                                  const char *mode, int ndim,
                                  size_t sizeof_dtype, int contig_flag,
                                  int dtype_is_object)
 {
@@ -40065,15 +41875,15 @@
     Py_buffer *buf = &from_memview->view;
     PyObject *shape_tuple = NULL;
     PyObject *temp_int = NULL;
     struct __pyx_array_obj *array_obj = NULL;
     struct __pyx_memoryview_obj *memview_obj = NULL;
     __Pyx_RefNannySetupContext("__pyx_memoryview_copy_new_contig", 0);
     for (i = 0; i < ndim; i++) {
-        if (from_mvs->suboffsets[i] >= 0) {
+        if (unlikely(from_mvs->suboffsets[i] >= 0)) {
             PyErr_Format(PyExc_ValueError, "Cannot copy memoryview slice with "
                                            "indirect dimensions (axis %d)", i);
             goto fail;
         }
     }
     shape_tuple = PyTuple_New(ndim);
     if (unlikely(!shape_tuple)) {
@@ -40114,17 +41924,62 @@
     __Pyx_XDECREF(shape_tuple);
     __Pyx_XDECREF(temp_int);
     __Pyx_XDECREF(array_obj);
     __Pyx_RefNannyFinishContext();
     return new_mvs;
 }
 
+/* CIntToPy */
+  static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value) {
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wconversion"
+#endif
+    const int neg_one = (int) -1, const_zero = (int) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic pop
+#endif
+    const int is_unsigned = neg_one > const_zero;
+    if (is_unsigned) {
+        if (sizeof(int) < sizeof(long)) {
+            return PyInt_FromLong((long) value);
+        } else if (sizeof(int) <= sizeof(unsigned long)) {
+            return PyLong_FromUnsignedLong((unsigned long) value);
+#ifdef HAVE_LONG_LONG
+        } else if (sizeof(int) <= sizeof(unsigned PY_LONG_LONG)) {
+            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
+#endif
+        }
+    } else {
+        if (sizeof(int) <= sizeof(long)) {
+            return PyInt_FromLong((long) value);
+#ifdef HAVE_LONG_LONG
+        } else if (sizeof(int) <= sizeof(PY_LONG_LONG)) {
+            return PyLong_FromLongLong((PY_LONG_LONG) value);
+#endif
+        }
+    }
+    {
+        int one = 1; int little = (int)*(unsigned char *)&one;
+        unsigned char *bytes = (unsigned char *)&value;
+        return _PyLong_FromByteArray(bytes, sizeof(int),
+                                     little, !is_unsigned);
+    }
+}
+
 /* CIntFromPy */
   static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *x) {
-    const int neg_one = (int) ((int) 0 - (int) 1), const_zero = (int) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wconversion"
+#endif
+    const int neg_one = (int) -1, const_zero = (int) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic pop
+#endif
     const int is_unsigned = neg_one > const_zero;
 #if PY_MAJOR_VERSION < 3
     if (likely(PyInt_Check(x))) {
         if (sizeof(int) < sizeof(long)) {
             __PYX_VERIFY_RETURN_INT(int, long, PyInt_AS_LONG(x))
         } else {
             long val = PyInt_AS_LONG(x);
@@ -40303,17 +42158,62 @@
     return (int) -1;
 raise_neg_overflow:
     PyErr_SetString(PyExc_OverflowError,
         "can't convert negative value to int");
     return (int) -1;
 }
 
+/* CIntToPy */
+  static CYTHON_INLINE PyObject* __Pyx_PyInt_From_unsigned_int(unsigned int value) {
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wconversion"
+#endif
+    const unsigned int neg_one = (unsigned int) -1, const_zero = (unsigned int) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic pop
+#endif
+    const int is_unsigned = neg_one > const_zero;
+    if (is_unsigned) {
+        if (sizeof(unsigned int) < sizeof(long)) {
+            return PyInt_FromLong((long) value);
+        } else if (sizeof(unsigned int) <= sizeof(unsigned long)) {
+            return PyLong_FromUnsignedLong((unsigned long) value);
+#ifdef HAVE_LONG_LONG
+        } else if (sizeof(unsigned int) <= sizeof(unsigned PY_LONG_LONG)) {
+            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
+#endif
+        }
+    } else {
+        if (sizeof(unsigned int) <= sizeof(long)) {
+            return PyInt_FromLong((long) value);
+#ifdef HAVE_LONG_LONG
+        } else if (sizeof(unsigned int) <= sizeof(PY_LONG_LONG)) {
+            return PyLong_FromLongLong((PY_LONG_LONG) value);
+#endif
+        }
+    }
+    {
+        int one = 1; int little = (int)*(unsigned char *)&one;
+        unsigned char *bytes = (unsigned char *)&value;
+        return _PyLong_FromByteArray(bytes, sizeof(unsigned int),
+                                     little, !is_unsigned);
+    }
+}
+
 /* CIntFromPy */
   static CYTHON_INLINE unsigned int __Pyx_PyInt_As_unsigned_int(PyObject *x) {
-    const unsigned int neg_one = (unsigned int) ((unsigned int) 0 - (unsigned int) 1), const_zero = (unsigned int) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wconversion"
+#endif
+    const unsigned int neg_one = (unsigned int) -1, const_zero = (unsigned int) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic pop
+#endif
     const int is_unsigned = neg_one > const_zero;
 #if PY_MAJOR_VERSION < 3
     if (likely(PyInt_Check(x))) {
         if (sizeof(unsigned int) < sizeof(long)) {
             __PYX_VERIFY_RETURN_INT(unsigned int, long, PyInt_AS_LONG(x))
         } else {
             long val = PyInt_AS_LONG(x);
@@ -40538,15 +42438,22 @@
             break;
     }
     return result;
 }
 
 /* CIntFromPy */
   static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *x) {
-    const long neg_one = (long) ((long) 0 - (long) 1), const_zero = (long) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wconversion"
+#endif
+    const long neg_one = (long) -1, const_zero = (long) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic pop
+#endif
     const int is_unsigned = neg_one > const_zero;
 #if PY_MAJOR_VERSION < 3
     if (likely(PyInt_Check(x))) {
         if (sizeof(long) < sizeof(long)) {
             __PYX_VERIFY_RETURN_INT(long, long, PyInt_AS_LONG(x))
         } else {
             long val = PyInt_AS_LONG(x);
@@ -40725,206 +42632,62 @@
     return (long) -1;
 raise_neg_overflow:
     PyErr_SetString(PyExc_OverflowError,
         "can't convert negative value to long");
     return (long) -1;
 }
 
-/* CIntFromPy */
-  static CYTHON_INLINE size_t __Pyx_PyInt_As_size_t(PyObject *x) {
-    const size_t neg_one = (size_t) ((size_t) 0 - (size_t) 1), const_zero = (size_t) 0;
-    const int is_unsigned = neg_one > const_zero;
-#if PY_MAJOR_VERSION < 3
-    if (likely(PyInt_Check(x))) {
-        if (sizeof(size_t) < sizeof(long)) {
-            __PYX_VERIFY_RETURN_INT(size_t, long, PyInt_AS_LONG(x))
-        } else {
-            long val = PyInt_AS_LONG(x);
-            if (is_unsigned && unlikely(val < 0)) {
-                goto raise_neg_overflow;
-            }
-            return (size_t) val;
-        }
-    } else
-#endif
-    if (likely(PyLong_Check(x))) {
-        if (is_unsigned) {
-#if CYTHON_USE_PYLONG_INTERNALS
-            const digit* digits = ((PyLongObject*)x)->ob_digit;
-            switch (Py_SIZE(x)) {
-                case  0: return (size_t) 0;
-                case  1: __PYX_VERIFY_RETURN_INT(size_t, digit, digits[0])
-                case 2:
-                    if (8 * sizeof(size_t) > 1 * PyLong_SHIFT) {
-                        if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(size_t, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(size_t) >= 2 * PyLong_SHIFT) {
-                            return (size_t) (((((size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0]));
-                        }
-                    }
-                    break;
-                case 3:
-                    if (8 * sizeof(size_t) > 2 * PyLong_SHIFT) {
-                        if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(size_t, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(size_t) >= 3 * PyLong_SHIFT) {
-                            return (size_t) (((((((size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0]));
-                        }
-                    }
-                    break;
-                case 4:
-                    if (8 * sizeof(size_t) > 3 * PyLong_SHIFT) {
-                        if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(size_t, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(size_t) >= 4 * PyLong_SHIFT) {
-                            return (size_t) (((((((((size_t)digits[3]) << PyLong_SHIFT) | (size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0]));
-                        }
-                    }
-                    break;
-            }
-#endif
-#if CYTHON_COMPILING_IN_CPYTHON
-            if (unlikely(Py_SIZE(x) < 0)) {
-                goto raise_neg_overflow;
-            }
-#else
-            {
-                int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
-                if (unlikely(result < 0))
-                    return (size_t) -1;
-                if (unlikely(result == 1))
-                    goto raise_neg_overflow;
-            }
-#endif
-            if (sizeof(size_t) <= sizeof(unsigned long)) {
-                __PYX_VERIFY_RETURN_INT_EXC(size_t, unsigned long, PyLong_AsUnsignedLong(x))
-#ifdef HAVE_LONG_LONG
-            } else if (sizeof(size_t) <= sizeof(unsigned PY_LONG_LONG)) {
-                __PYX_VERIFY_RETURN_INT_EXC(size_t, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
-#endif
-            }
-        } else {
-#if CYTHON_USE_PYLONG_INTERNALS
-            const digit* digits = ((PyLongObject*)x)->ob_digit;
-            switch (Py_SIZE(x)) {
-                case  0: return (size_t) 0;
-                case -1: __PYX_VERIFY_RETURN_INT(size_t, sdigit, (sdigit) (-(sdigit)digits[0]))
-                case  1: __PYX_VERIFY_RETURN_INT(size_t,  digit, +digits[0])
-                case -2:
-                    if (8 * sizeof(size_t) - 1 > 1 * PyLong_SHIFT) {
-                        if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(size_t, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(size_t) - 1 > 2 * PyLong_SHIFT) {
-                            return (size_t) (((size_t)-1)*(((((size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0])));
-                        }
-                    }
-                    break;
-                case 2:
-                    if (8 * sizeof(size_t) > 1 * PyLong_SHIFT) {
-                        if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(size_t, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(size_t) - 1 > 2 * PyLong_SHIFT) {
-                            return (size_t) ((((((size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0])));
-                        }
-                    }
-                    break;
-                case -3:
-                    if (8 * sizeof(size_t) - 1 > 2 * PyLong_SHIFT) {
-                        if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(size_t, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(size_t) - 1 > 3 * PyLong_SHIFT) {
-                            return (size_t) (((size_t)-1)*(((((((size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0])));
-                        }
-                    }
-                    break;
-                case 3:
-                    if (8 * sizeof(size_t) > 2 * PyLong_SHIFT) {
-                        if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(size_t, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(size_t) - 1 > 3 * PyLong_SHIFT) {
-                            return (size_t) ((((((((size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0])));
-                        }
-                    }
-                    break;
-                case -4:
-                    if (8 * sizeof(size_t) - 1 > 3 * PyLong_SHIFT) {
-                        if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(size_t, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(size_t) - 1 > 4 * PyLong_SHIFT) {
-                            return (size_t) (((size_t)-1)*(((((((((size_t)digits[3]) << PyLong_SHIFT) | (size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0])));
-                        }
-                    }
-                    break;
-                case 4:
-                    if (8 * sizeof(size_t) > 3 * PyLong_SHIFT) {
-                        if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(size_t, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(size_t) - 1 > 4 * PyLong_SHIFT) {
-                            return (size_t) ((((((((((size_t)digits[3]) << PyLong_SHIFT) | (size_t)digits[2]) << PyLong_SHIFT) | (size_t)digits[1]) << PyLong_SHIFT) | (size_t)digits[0])));
-                        }
-                    }
-                    break;
-            }
+/* CIntToPy */
+  static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value) {
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wconversion"
+#endif
+    const long neg_one = (long) -1, const_zero = (long) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic pop
 #endif
-            if (sizeof(size_t) <= sizeof(long)) {
-                __PYX_VERIFY_RETURN_INT_EXC(size_t, long, PyLong_AsLong(x))
+    const int is_unsigned = neg_one > const_zero;
+    if (is_unsigned) {
+        if (sizeof(long) < sizeof(long)) {
+            return PyInt_FromLong((long) value);
+        } else if (sizeof(long) <= sizeof(unsigned long)) {
+            return PyLong_FromUnsignedLong((unsigned long) value);
 #ifdef HAVE_LONG_LONG
-            } else if (sizeof(size_t) <= sizeof(PY_LONG_LONG)) {
-                __PYX_VERIFY_RETURN_INT_EXC(size_t, PY_LONG_LONG, PyLong_AsLongLong(x))
+        } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
+            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
 #endif
-            }
         }
-        {
-#if CYTHON_COMPILING_IN_PYPY && !defined(_PyLong_AsByteArray)
-            PyErr_SetString(PyExc_RuntimeError,
-                            "_PyLong_AsByteArray() not available in PyPy, cannot convert large numbers");
-#else
-            size_t val;
-            PyObject *v = __Pyx_PyNumber_IntOrLong(x);
- #if PY_MAJOR_VERSION < 3
-            if (likely(v) && !PyLong_Check(v)) {
-                PyObject *tmp = v;
-                v = PyNumber_Long(tmp);
-                Py_DECREF(tmp);
-            }
- #endif
-            if (likely(v)) {
-                int one = 1; int is_little = (int)*(unsigned char *)&one;
-                unsigned char *bytes = (unsigned char *)&val;
-                int ret = _PyLong_AsByteArray((PyLongObject *)v,
-                                              bytes, sizeof(val),
-                                              is_little, !is_unsigned);
-                Py_DECREF(v);
-                if (likely(!ret))
-                    return val;
-            }
+    } else {
+        if (sizeof(long) <= sizeof(long)) {
+            return PyInt_FromLong((long) value);
+#ifdef HAVE_LONG_LONG
+        } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
+            return PyLong_FromLongLong((PY_LONG_LONG) value);
 #endif
-            return (size_t) -1;
         }
-    } else {
-        size_t val;
-        PyObject *tmp = __Pyx_PyNumber_IntOrLong(x);
-        if (!tmp) return (size_t) -1;
-        val = __Pyx_PyInt_As_size_t(tmp);
-        Py_DECREF(tmp);
-        return val;
     }
-raise_overflow:
-    PyErr_SetString(PyExc_OverflowError,
-        "value too large to convert to size_t");
-    return (size_t) -1;
-raise_neg_overflow:
-    PyErr_SetString(PyExc_OverflowError,
-        "can't convert negative value to size_t");
-    return (size_t) -1;
+    {
+        int one = 1; int little = (int)*(unsigned char *)&one;
+        unsigned char *bytes = (unsigned char *)&value;
+        return _PyLong_FromByteArray(bytes, sizeof(long),
+                                     little, !is_unsigned);
+    }
 }
 
 /* CIntFromPy */
   static CYTHON_INLINE char __Pyx_PyInt_As_char(PyObject *x) {
-    const char neg_one = (char) ((char) 0 - (char) 1), const_zero = (char) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic push
+#pragma GCC diagnostic ignored "-Wconversion"
+#endif
+    const char neg_one = (char) -1, const_zero = (char) 0;
+#ifdef __Pyx_HAS_GCC_DIAGNOSTIC
+#pragma GCC diagnostic pop
+#endif
     const int is_unsigned = neg_one > const_zero;
 #if PY_MAJOR_VERSION < 3
     if (likely(PyInt_Check(x))) {
         if (sizeof(char) < sizeof(long)) {
             __PYX_VERIFY_RETURN_INT(char, long, PyInt_AS_LONG(x))
         } else {
             long val = PyInt_AS_LONG(x);
@@ -41103,44 +42866,43 @@
     return (char) -1;
 raise_neg_overflow:
     PyErr_SetString(PyExc_OverflowError,
         "can't convert negative value to char");
     return (char) -1;
 }
 
-/* ObjectToMemviewSlice */
-  static CYTHON_INLINE __Pyx_memviewslice __Pyx_PyObject_to_MemoryviewSlice_ds_int(PyObject *obj, int writable_flag) {
-    __Pyx_memviewslice result = { 0, 0, { 0 }, { 0 }, { 0 } };
-    __Pyx_BufFmt_StackElem stack[1];
-    int axes_specs[] = { (__Pyx_MEMVIEW_DIRECT | __Pyx_MEMVIEW_STRIDED) };
-    int retcode;
-    if (obj == Py_None) {
-        result.memview = (struct __pyx_memoryview_obj *) Py_None;
-        return result;
-    }
-    retcode = __Pyx_ValidateAndInit_memviewslice(axes_specs, 0,
-                                                 PyBUF_RECORDS_RO | writable_flag, 1,
-                                                 &__Pyx_TypeInfo_int, stack,
-                                                 &result, obj);
-    if (unlikely(retcode == -1))
-        goto __pyx_fail;
-    return result;
-__pyx_fail:
-    result.memview = NULL;
-    result.data = NULL;
-    return result;
-}
-
 /* CheckBinaryVersion */
   static int __Pyx_check_binary_version(void) {
-    char ctversion[4], rtversion[4];
-    PyOS_snprintf(ctversion, 4, "%d.%d", PY_MAJOR_VERSION, PY_MINOR_VERSION);
-    PyOS_snprintf(rtversion, 4, "%s", Py_GetVersion());
-    if (ctversion[0] != rtversion[0] || ctversion[2] != rtversion[2]) {
+    char ctversion[5];
+    int same=1, i, found_dot;
+    const char* rt_from_call = Py_GetVersion();
+    PyOS_snprintf(ctversion, 5, "%d.%d", PY_MAJOR_VERSION, PY_MINOR_VERSION);
+    found_dot = 0;
+    for (i = 0; i < 4; i++) {
+        if (!ctversion[i]) {
+            same = (rt_from_call[i] < '0' || rt_from_call[i] > '9');
+            break;
+        }
+        if (rt_from_call[i] != ctversion[i]) {
+            same = 0;
+            break;
+        }
+    }
+    if (!same) {
+        char rtversion[5] = {'\0'};
         char message[200];
+        for (i=0; i<4; ++i) {
+            if (rt_from_call[i] == '.') {
+                if (found_dot) break;
+                found_dot = 1;
+            } else if (rt_from_call[i] < '0' || rt_from_call[i] > '9') {
+                break;
+            }
+            rtversion[i] = rt_from_call[i];
+        }
         PyOS_snprintf(message, sizeof(message),
                       "compiletime version %s of module '%.100s' "
                       "does not match runtime version %s",
                       ctversion, __Pyx_MODULE_NAME, rtversion);
         return PyErr_WarnEx(NULL, message, 1);
     }
     return 0;
@@ -41390,14 +43152,31 @@
   }
   x = PyNumber_Index(b);
   if (!x) return -1;
   ival = PyInt_AsSsize_t(x);
   Py_DECREF(x);
   return ival;
 }
+static CYTHON_INLINE Py_hash_t __Pyx_PyIndex_AsHash_t(PyObject* o) {
+  if (sizeof(Py_hash_t) == sizeof(Py_ssize_t)) {
+    return (Py_hash_t) __Pyx_PyIndex_AsSsize_t(o);
+#if PY_MAJOR_VERSION < 3
+  } else if (likely(PyInt_CheckExact(o))) {
+    return PyInt_AS_LONG(o);
+#endif
+  } else {
+    Py_ssize_t ival;
+    PyObject *x;
+    x = PyNumber_Index(o);
+    if (!x) return -1;
+    ival = PyInt_AsLong(x);
+    Py_DECREF(x);
+    return ival;
+  }
+}
 static CYTHON_INLINE PyObject * __Pyx_PyBool_FromLong(long b) {
   return b ? __Pyx_NewRef(Py_True) : __Pyx_NewRef(Py_False);
 }
 static CYTHON_INLINE PyObject * __Pyx_PyInt_FromSize_t(size_t ival) {
     return PyInt_FromSize_t(ival);
 }
```

### Comparing `tkwant-1.0.1/tkwant/onebody/kernels.pyx` & `tkwant-1.1.0rc2/tkwant/onebody/kernels.pyx`

 * *Files 7% similar despite different names*

```diff
@@ -1,17 +1,18 @@
 # -*- coding: utf-8 -*-
 # cython: embedsignature=True
 #
-# Copyright 2016-2020 tkwant authors.
+# Copyright 2016-2022 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Calculating the right-hand side of the time-dependent Schrödinger equation.
 
 This module is mainly for internal use.
 
 The classes in this module are used for calculating the following expression:
 
     ..math:: -i(H_0 ψ + W(t) ψ)
@@ -26,206 +27,186 @@
 TDSE on infinite domains, or starting the evolution from an eigenstate.  All
 the forms of TDSE that we will need to handle these cases are encompassed by
 the above formula. This module is only concerned with calculating expressions
 of the above form, not performing the mapping from the various problems. For
 more details on the mapping, see `tkwant/onebody/solver.py`.
 """
 
-__all__ = ['Kernel', 'CKernel', 'Scipy', 'Simple',
-           'extract_c_kernel', 'default', 'PerturbationExtractor',
+__all__ = ['Kernel', 'Scipy', 'Simple',
+           'default', 'PerturbationExtractor',
            'PerturbationInterpolator']
 
 import numpy as np
 import cython
-from cpython.ref cimport Py_INCREF, Py_DECREF
-from .. import _common, system
+from .. import _common, system, _logging
 from scipy.sparse._sparsetools import coo_matvec, csr_matvec
 import scipy.sparse as sp
 
-
+
+# set module logger
+logger = _logging.make_logger(name=__name__)
+
 ########## Abstract Base Classes for kernels
 
 cdef class Kernel:
     """ABC for right-hand side of the time-dependent Schrödinger equation.
 
     Attributes
     ----------
     size : int
         The size of the time-independent part of the Hamiltonian. This
         also sets the size of the solution vector.
-    nevals : int
-        The number of times this kernel has been evaluated since its creation.
     """
 
-    def __init__(self, H0, W, params, complex[:] psi_st=None):
+    def __init__(self, H0, W, complex[:] psi_st=None, complex[:] work=None):
         raise NotImplementedError()
 
-    def set_params(self, params):
-        raise NotImplementedError()
-
-    def rhs(self, complex[:] psi, complex[:] dpsidt, double time):
+    def rhs(self, energy=None):
         """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
         raise NotImplementedError()
 
 
 ### C-level interface to Kernels (needed for C-implemented solvers)
 
 
-cdef class CKernel(Kernel):
-    """Base class for kernels that directly provide a C-level interface.
-
-    Attributes
-    ----------
-    c_self : void*
-        Pointer to a C struct that provides extra context (e.g. H0 and W)
-        to the kernel.
-    c_rhs : void (*)(const void* c_self, const complex* psi, complex* dpsidt,
-                     double time)
-        A C function that evaluates the right-hand side of the Schrödinger
-        equation, and stores the result in 'dpsidt'.
-    """
-
-    @cython.boundscheck(False)
-    @cython.wraparound(False)
-    def rhs(self, const complex[::1] psi, complex[::1] dpsidt, double time):
-        """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
-        self.c_rhs(self.c_self, &psi[0], &dpsidt[0], time)
-        self.nevals += 1
-
-
-# C wrapped to access pure Python Kernel implementation
-cdef void _wrapped_rhs(const void *self, const complex *psi, complex *dpsidt,
-                       double time) except *:
-    cdef size_t size = (<object>self).size
-    (<object>self).rhs(<complex[:size]>psi, <complex[:size]>dpsidt, time)
-
-
-cdef class PyCKernel(CKernel):
-    """C interface to python-implemented kernels."""
-
-    def __init__(self, py_kernel):
-        pass
-
-    def __cinit__(self, py_kernel):
-        self.size = py_kernel.size
-        self.nevals = py_kernel.nevals
-        self.c_rhs = _wrapped_rhs
-        self.c_self = <void*>py_kernel
-        # increment the reference count to prevent garbage collection
-        Py_INCREF(<object>self.c_self)
-
-    def __dealloc__(self):
-        Py_DECREF(<object>self.c_self)
-
-
-cpdef CKernel extract_c_kernel(Kernel py_kernel):
-    """Extract a C-level interface from a (possibly pure-python) Kernel."""
-    if isinstance(py_kernel, CKernel):
-        return py_kernel
-    elif not callable(py_kernel.rhs):
-        raise TypeError('Kernel must have a `rhs` method.')
-    return PyCKernel(py_kernel)
 
 
 ########## Concrete kernel implementations
 
 class Scipy(Kernel):
     """Evaluate the RHS of the Schrödinger equation using scipy sparse.
 
     Parameters
     ----------
     H0 : `scipy.sparse.base`
         Hamiltonian at ``t=0`` (including any boundary conditions).
     W : callable
         Time-dependent part of the Hamiltonian. Typically the object returned
         by `tkwant.system.extract_perturbation`.
-    params : dict
-        Extra arguments to pass to the system Hamiltonian excluding time.
     psi_st : array of complex, optional
         The wavefunction of the initial eigenstate defined over the central
         system (if starting in an initial eigenstate).
+    work : `~numpy.ndarray` of complex, optional
+        Workarray of size ``H0.shape[0]`` for performance and memory optimization.
 
     Attributes
     ----------
     H0 : `scipy.sparse.csr_matrix`
         Hamiltonian at ``t=0`` (including any boundary conditions).
     W : callable
         Time-dependent part of the Hamiltonian. Typically the object returned
         by `tkwant.system.extract_perturbation`.
-    params : dict
-        Extra arguments to pass to the system Hamiltonian excluding the ``time``
-        argument.
     psi_st : array of complex or `None`
         The wavefunction of the initial eigenstate defined over the central
         system (if starting in an initial eigenstate).
-    size : int
-        The size of the time-independent part of the Hamiltonian. This
-        also sets the size of the solution vector.
-    nevals : int
-        The number of times this kernel has been evaluated since its creation.
     """
 
-    def __init__(self, H0, W, params, psi_st=None):
-        self.H0 = H0.tocsr()
+    def __init__(self, H0, W, psi_st=None, work=None):
+
+        if not isinstance(H0, sp.csr.csr_matrix):
+            self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case
+        else:
+            self.H0 = H0
+
         self.W = W
         self.psi_st = psi_st
+        # The size of the time-independent part of the Hamiltonian. This
+        # also sets the size of the solution vector.
         self.size = self.H0.shape[0]
+
         if W is not None:
             self.center_size = self.W.size
         else:
             self.center_size = self.size
-        self.nevals = 0
-        self.params = params
-        self._tmp = np.zeros((self.size,), dtype=complex)
 
-    def set_params(self, params):
-        self.params = params
+        if work is None:
+            self._tmp = np.zeros((self.size,), dtype=complex)
+        else:
+            if work.size < self.center_size:
+                raise ValueError('work array size={} must be at least '
+                     'the size of the central system={}'
+                     .format(work.size, self.center_size))
+            self._tmp = work
+
+    def rhs(self, energy=None):
+
+        if energy is None:
+            H0 = self.H0
+        else:
+            H0 = self.H0 - energy * sp.eye(self.size)
+
+        # The approach with a separated class ``_CalcRHS`` to calculate the r.h.s.
+        # seems more complicated, but it allows to store the static Hamiltonian
+        # as a reference in class ``Scipy(Kernel)`` in ``self.H0``
+        # (for manybody calculations there is onle reference per rank).
+        # Moreover, the calculation ``H = H0 - E`` is done inplace,
+        # and only once when the Scipy(Kernel).rhs() method is called.
+        # It is important to precalculate H0 - E at this stage
+        # (typically when ``WaveFunction.evolve()`` is called) and not
+        # to do the inplace calculation in ``_CalcRHS.__call__()``,
+        # as the later method is called very often (by the DGL solver).
+        # The implace calculation generates only a temporary object ``H``
+        # which not stored in the ``onebody.WaveFunction``, such
+        # that it is cleaned by the garbage collector.
+        return _CalcRHS(H0, self.W, self.psi_st, self.size, self.center_size, self._tmp)
+
+    def set_W(self, W):
+        '''Set the time dependent perturbation W(t)'''
+        self.W = W
+
+
+class _CalcRHS:
+    """Calculate the right-hand-side of the time-dependent Schrödinger equation."""
+    def __init__(self, H0, W, psi_st, size, center_size, tmp):
+
+        self.H0 = H0
+        self.W = W
+        self.psi_st = psi_st
+        self.size = size
+        self.center_size = center_size
+        self._tmp = tmp
+
+    @cython.boundscheck(False)
+    @cython.wraparound(False)
+    def __call__(self, const complex[:] psi, complex[:] dpsidt, const double time):
 
-    def rhs(self, const complex[:] psi, complex[:] dpsidt, double time):
-        """Evaluate the RHS of the TDSE and store the result in `dpsidt`."""
-        psi_centre = np.asarray(psi[:self.center_size])
         # H0 @ psi -> tmp
         cdef complex[:] tmp = self._tmp
-        tmp[:] = 0
+        tmp[:] = 0    
         csr_matvec(
-            self.H0.shape[0], self.H0.shape[1], self.H0.indptr, self.H0.indices, self.H0.data,
-            psi, tmp)
-#         cdef complex[:] tmp = self.H0.dot(psi)
+            self.H0.shape[0], self.H0.shape[1], self.H0.indptr,
+            self.H0.indices, self.H0.data, psi, tmp)
+
         # W(t) @ (psi + psi_st) + tmp -> tmp
+        psi_centre = np.asarray(psi[:self.center_size])
         if self.psi_st is not None:
             psi_centre = psi_centre + self.psi_st
-
         try:
             self.W.apply(time, psi_centre[:self.center_size], out=tmp[:self.center_size])
         except Exception as exept:
             if self.W is None:
                 pass
             else:
                 raise exept
 
         # dpsidt = -1j * tmp
         cdef int i
         for i in range(self.size):
             dpsidt[i] = -1j * tmp[i]
 
-        self.nevals += 1
-
 
 @cython.boundscheck(False)
 @cython.wraparound(False)
 cdef(double, double, double, double, double) update_times(double t, double t0, double dt):
     '''Return new update times for the Hamiltonian matrix.
     '''
     assert dt > 0
     cdef int quotient
-    if t < t0:
-        raise ValueError('time t={} must be greater equal t0={}'.format(t, t0))
-    if t >= t0 + dt + dt:
-        quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics
-        t0 = t0 + quotient * dt
+    quotient = int(round((t - t0) / dt, 10))  # integer division // has problems with the numerics
+    t0 = t0 + quotient * dt
     # adding dt up we get inaccurate routings
     cdef double t1 = t0 + dt
     cdef double t2 = t0 + 2 * dt
     cdef double t3 = t0 + 3 * dt
     cdef double t4 = t0 + 4 * dt
     return t0, t1, t2, t3, t4
 
@@ -252,14 +233,198 @@
     return value
 
 
 _errormsg = ('{0} vector has length {1}, but the system '
              'contains {2} orbitals')
 
 
+cdef class Interpolation:
+
+    cdef:
+        double dt
+        double t0, t1, t2, t3, t4
+        double atol, rtol
+        double fac, facmin, facmax
+        double dt_min
+        object Ht0, Ht1, Ht2, Ht3, Ht4
+        object d2Ht0, d2Ht1, d2Ht2
+        object func
+        unsigned nnz
+
+    def __init__(self, func, t0, dt_init=0.001, atol=1E-10, rtol=1E-10, dt_min=1E-6, fac=0.9, facmin=0.1, facmax=3):
+
+        # The spline interpolation in this routine is done "on the fly".
+        # Quite generally, for a cubic spline, the cubic function f(t) is defined
+        # on two neighboring intervals [t0, t1] and [t1, t2],
+        # t1 - t0 = t2 - t1 = dt. One needs to know
+        # f(t) on t0, t1, and t2, and f''(t) on the endpoints t0, t2.
+        # As the Schrödinger equation which calls the interpolant propagates only
+        # foreward in time, we do a stepwise interpolation and assume, at least
+        # for the optimization, that the time argument monontonically increases
+        # when the interpolation function is called. The idea is to reuse the
+        # evaluated function and derivative values, and don't calculate them twice.
+        # Therefore, one always need to keep 5. timesteps in memory, t0, t1 .. t4.
+        # Interpolation is always done between t0, t1 and t2.
+        # The points t3 and t4 are used to estimate the 2. derivative on t2
+        # using a central finite difference scheme with 5 points. The second
+        # derivative on point t0 is known from the step before.
+        # Only when this routine is initialized, we have to estimate f''(t0).
+        # We use a foreward derivative in this case.
+
+        assert dt_init > 0
+        assert dt_min > 0
+        assert atol >= 0
+        assert rtol >= 0
+
+        self.dt = dt_init
+        self.func = func
+
+        self.atol = atol
+        self.rtol = rtol
+
+        self.fac = fac
+        self.facmin = facmin
+        self.facmax = facmax
+
+        self.dt_min = dt_min
+
+        self.t0 = t0
+        self.t1 = self.t0 + self.dt
+        self.t2 = self.t1 + self.dt
+        self.t3 = self.t2 + self.dt
+        self.t4 = self.t3 + self.dt
+
+        self.Ht0 = self.func(self.t0)
+        self.Ht1 = self.func(self.t1)
+        self.Ht2 = self.func(self.t2)
+        self.Ht3 = self.func(self.t3)
+        self.Ht4 = self.func(self.t4)
+
+        self.nnz = self.Ht0.shape[0]
+
+        Ht02 = self.func(self.t0 + 0.5 * self.dt)
+        Ht12 = self.func(self.t0 + 1.5 * self.dt)
+        Ht22 = self.func(self.t0 + 2.5 * self.dt)
+
+        rdt2 = 1 / (self.dt * self.dt)
+        rdt2h = 4 * rdt2
+
+        # w''(t0), forward finite difference scheme (4. order)
+        # on the half interval dt / 2
+        cl0 = 15 / 4 * rdt2h
+        cl1 = -77 / 6 * rdt2h
+        cl2 = 107 / 6 * rdt2h
+        cl3 = -13 * rdt2h
+        cl4 = 61 / 12 * rdt2h
+        cl5 = -5 / 6 * rdt2h
+        self.d2Ht0 = np.zeros((self.nnz,), dtype=complex)
+        for i in range(self.nnz):
+            self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \
+                + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]
+
+        # w''(t2), central finite difference scheme (4. order)
+        cc2 = - rdt2 / 12
+        cc1 = rdt2 * 4 / 3
+        cc0 = - 2.5 * rdt2
+        self.d2Ht2 = np.zeros((self.nnz,), dtype=complex)
+        for i in range(self.nnz):
+            self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+                + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+                + cc0 * self.Ht2[i]
+
+        # w''(t1), spline formula
+        self.d2Ht1 = np.zeros((self.nnz,), dtype=complex)
+        for i in range(self.nnz):
+            self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \
+                - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
+
+    @cython.boundscheck(False)
+    @cython.wraparound(False)
+    def eval(self, double time, complex[:] out):
+
+        if self.nnz == 0: return
+
+        cdef double c0, c1, c2, rdt2
+        cdef double a, b, c, d
+        cdef unsigned i
+
+        # update matrices
+        time_larger = time >= self.t2
+        time_smaller = time < self.t0
+
+        if time_larger or time_smaller:
+
+            if time_larger:
+                error = self._estimate_error(self.t1 + 0.5 * self.dt)
+            else:
+                error = self._estimate_error(self.t0 + 0.5 * self.dt)
+
+            self.dt = self._estimate_stepsize(self.dt, error)
+
+            t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)
+            rdt2 = 1 / (self.dt * self.dt)
+            cc2 = - rdt2 / 12
+            cc1 = rdt2 * 4 / 3
+            cc0 = - 2.5 * rdt2
+
+            Htm2 = self.func(t0_new - 2 * self.dt)
+            Htm1 = self.func(t0_new - self.dt)
+            self.func(t0_new, self.Ht0)
+            self.func(t1_new, self.Ht1)
+            self.func(t2_new, self.Ht2)
+            self.func(t3_new, self.Ht3)
+            self.func(t4_new, self.Ht4)
+
+            for i in range(self.nnz):
+                # w''(t) on t0 and t2, central finite difference scheme
+                self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \
+                    + cc1 * (Htm1[i] + self.Ht1[i]) \
+                    + cc0 * self.Ht0[i]
+                self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
+                    + cc1 * (self.Ht1[i] + self.Ht3[i]) \
+                    + cc0 * self.Ht2[i]
+                # w''(t) on t1, spline formula
+                self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\
+                    - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
+
+            self.t0, self.t1, self.t2, self.t3, self.t4 = t0_new, t1_new, t2_new, t3_new, t4_new
+
+        # construct the spline, either on [t0, t1] or on [t1, t2] interval.
+        if time < self.t1:
+            a, b, c, d = _get_polynome_coeffs(time, self.t0, self.t1, self.dt)
+            for i in range(self.nnz):
+                out[i] = a * self.Ht0[i] + b * self.Ht1[i] + c * self.d2Ht0[i] + d * self.d2Ht1[i]
+        else:
+            a, b, c, d = _get_polynome_coeffs(time, self.t1, self.t2, self.dt)
+            for i in range(self.nnz):
+                out[i] = a * self.Ht1[i] + b * self.Ht2[i] + c * self.d2Ht1[i] + d * self.d2Ht2[i]
+
+    def _estimate_error(self, double time):
+        fx = self.func(time)
+        fapp = np.zeros((self.nnz,), dtype=complex)
+        self.eval(time, fapp)
+        scale = self.atol + self.rtol * np.abs(fx)
+        return np.max(np.abs(fx - fapp) / scale)
+
+    def _estimate_stepsize(self, double dt, double error):
+        # Eq. (4.13), page 168 in book:
+        # E. Hairer, S. Nørsett, and G. Wanner, Solving Ordinary Differential Equations,
+        # I: Nonstiff Problems, Second  revised edition (Springer, Berlin, Heidelberg, 2008).
+        assert dt > 0
+        assert error >= 0
+        a = - 1 / 4  # cubic order p = 3
+        dt_new = dt * min(self.facmax, max(self.facmin, self.fac * error**a))
+        if dt_new < self.dt_min:
+            logger.warning('minimal W(t) stepsize dt_min={} reached.'
+                           .format(self.dt_min))
+            dt_new = self.dt_min
+        return dt_new
+
+
+
 # TODO: this only works for finalized builders so far -- how to extend
 #       this to something more general?
 # TODO: change this routine when kwant supports vectorized systems
 cdef class PerturbationExtractor:
     """Extract the time-dependent perturbation to the Hamiltonian.
 
     The total Hamiltonian can be split into two parts: the stationary
@@ -372,20 +537,22 @@
             do_return = False
             assert out.shape[0] == self.nnz, _errormsg.format('output',
                                                               out.shape[0],
                                                               self.nnz)
         index = 0
         self.tparams[self.time_name] = time
         for i, j, _, _, H_0 in self.td_hamiltonian:
-            mat_el = np.asarray(self.H(i, j, params=self.tparams) - H_0)
-            for val in mat_el.flatten():
+            H = self.H(i, j, params=self.tparams)
+            mat_els = np.asarray(H - H_0).flatten()
+            for val in mat_els:
                 out[index] = val
                 index += 1
             if i != j:
-                for val in _herm_conj(mat_el).flatten():
+                mat_els = mat_els.conjugate()
+                for val in mat_els:
                     out[index] = val
                     index += 1
         return out if do_return else None
 
     def row_col(self):
         '''Return the row and column vectors of the W(t) matrix.
 
@@ -419,15 +586,15 @@
         '''Return an empty W(t) matrix with correct shape and indices.
 
         Returns
         -------
         out : `~scipy.sparse.coo_matrix`
             An "empty" W(t) matrix filled with zeros.
         '''
-        data = np.zeros((self.nnz,), dtype=np.complex)
+        data = np.zeros((self.nnz,), dtype=complex)
         row_col = self.row_col()
         return sp.coo_matrix((data, row_col), (self.size, self.size))
 
     def evaluate(self, double time, object out=None):
         '''Evaluate the W(t) matrix for the given time t.
 
         Parameters
@@ -460,26 +627,27 @@
 
         Parameters
         ----------
         time : int or float
             Time argument, must be equal or larger than `time_start`.
         out : `numpy.ndarray`, optional
             Sparse matrix with to perform the operation in-place.
+            If provided, array must be zero on input.
 
         Returns
         -------
         out : `numpy.ndarray` or `None`
             The product W(t) @ ket. If an ``out`` argument is given,
             the operation is performed in-place and the routine returns `None`.
         '''
         assert ket.shape[0] == self.size, _errormsg.format('Ket', ket.shape[0],
                                                            self.size)
         if out is None:
             do_return = True
-            out = np.zeros((self.size,), dtype=np.complex)
+            out = np.zeros((self.size,), dtype=complex)
         else:
             do_return = False
             assert out.shape[0] == self.size, _errormsg.format('output',
                                                                out.shape[0],
                                                                self.size)
         self.tparams[self.time_name] = time
         for i, j, to, frm, H_0 in self.td_hamiltonian:
@@ -507,133 +675,44 @@
     time_name : str
         The name of the time argument. Only sites with Hamiltonian value
         functions with the argument name `time_name` are extracted into W(t).
     time_start : float
         The initial time.
     params : dict, optional
         Extra arguments to pass to the Hamiltonian of ``syst``, excluding time.
-    dt : float
-        Discretization timestep for the Spline. Must be => 0.
-        For dt = 0, no interpolation is performed, but the result is
-        identical to `tkwant.onebody.kernel.PerturbationExtractor`.
+    interpolation_type : optional
+        The interpolator class
 
     Notes
     -----
     By definition the perturbation is defined with respect to the initial time.
     The perturbation should be therefore zero for times t < `time_start`. This
     is not inforced by this routine however, but W(t) is always evaluated
     with the time argument it gets.
     """
 
-    cdef double dt
-    cdef double t0, t1, t2, t3, t4
     cdef:
-        object Ht0
+        double dt
         unsigned size
-        double time_start
-        object time_name
-        object tterms
-        object Ht1, Ht2, Ht3, Ht4
-        object d2Ht0, d2Ht1, d2Ht2
-        double x0, x1
-        object y0, y1
-        object d2y0, d2y1
-        int _do_update
+        unsigned nnz
         object wt
         object wfunc
-    cdef unsigned nnz
+        object intfunc
 
-    def __init__(self, syst, time_name, time_start, params=None, dt=1):
-
-        # The spline interpolation in this routine is done "on the fly".
-        # Quite generally, for a cubic spline, the cubic function f(t) is defined
-        # on two neighboring intervals [t0, t1] and [t1, t2],
-        # t1 - t0 = t2 - t1 = dt. One needs to know
-        # f(t) on t0, t1, and t2, and f''(t) on the endpoints t0, t2.
-        # As the Schrödinger equation which calls the interpolant propagates only
-        # foreward in time, we do a stepwise interpolation and assume, at least
-        # for the optimization, that the time argument monontonically increases
-        # when the interpolation function is called. The idea is to reuse the
-        # evaluated function and derivative values, and don't calculate them twice.
-        # Therefore, one always need to keep 5. timesteps in memory, t0, t1 .. t4.
-        # Interpolation is always done between t0, t1 and t2.
-        # The points t3 and t4 are used to estimate the 2. derivative on t2
-        # using a central finite difference scheme with 5 points. The second
-        # derivative on point t0 is known from the step before.
-        # Only when this routine is initialized, we have to estimate f''(t0).
-        # We use a foreward derivative in this case.
+    def __init__(self, syst, time_name, time_start, params=None, interpolation_type=Interpolation):
 
         self.wfunc = PerturbationExtractor(syst, time_name, time_start, params)
 
         # for non-vectorized systems
         _, _, norbs = syst.site_ranges[-1]
         self.size = norbs
         self.nnz = self.wfunc.nnz
-        self.time_start = time_start
-        self.time_name = time_name
-        self.dt = dt
-
-        if dt > 0:
-
-            self.t0 = time_start
-            self.t1 = self.t0 + self.dt
-            self.t2 = self.t1 + self.dt
-            self.t3 = self.t2 + self.dt
-            self.t4 = self.t3 + self.dt
-
-            self.Ht0 = self.wfunc.data(self.t0)
-            self.Ht1 = self.wfunc.data(self.t1)
-            self.Ht2 = self.wfunc.data(self.t2)
-            self.Ht3 = self.wfunc.data(self.t3)
-            self.Ht4 = self.wfunc.data(self.t4)
-
-            Ht02 = self.wfunc.data(self.t0 + 0.5 * self.dt)
-            Ht12 = self.wfunc.data(self.t0 + 1.5 * self.dt)
-            Ht22 = self.wfunc.data(self.t0 + 2.5 * self.dt)
-
-            rdt2 = 1 / (self.dt * self.dt)
-            rdt2h = 4 * rdt2
-
-            # w''(t0), forward finite difference scheme (4. order)
-            # on the half interval dt / 2
-            cl0 = 15 / 4 * rdt2h
-            cl1 = -77 / 6 * rdt2h
-            cl2 = 107 / 6 * rdt2h
-            cl3 = -13 * rdt2h
-            cl4 = 61 / 12 * rdt2h
-            cl5 = -5 / 6 * rdt2h
-            self.d2Ht0 = np.zeros((self.nnz,), dtype=np.complex)
-            for i in range(self.nnz):
-                self.d2Ht0[i] = cl0 * self.Ht0[i] + cl1 * Ht02[i] + cl2 * self.Ht1[i] \
-                    + cl3 * Ht12[i] + cl4 * self.Ht2[i] + cl5 * Ht22[i]
-
-            # w''(t2), central finite difference scheme (4. order)
-            cc2 = - rdt2 / 12
-            cc1 = rdt2 * 4 / 3
-            cc0 = - 2.5 * rdt2
-            self.d2Ht2 = np.zeros((self.nnz,), dtype=np.complex)
-            for i in range(self.nnz):
-                self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
-                    + cc1 * (self.Ht1[i] + self.Ht3[i]) \
-                    + cc0 * self.Ht2[i]
-
-            # w''(t1), spline formula
-            self.d2Ht1 = np.zeros((self.nnz,), dtype=np.complex)
-            for i in range(self.nnz):
-                self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i]) \
-                    - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
 
-            self.x0, self.x1 = self.t0, self.t1
-            self.y0 = self.Ht0
-            self.y1 = self.Ht1
-            self.d2y0 = self.d2Ht0
-            self.d2y1 = self.d2Ht1
-            self._do_update = True
-
-            self.wt = self.wfunc.empty()
+        self.intfunc = interpolation_type(self.wfunc.data, time_start)
+        self.wt = self.wfunc.empty()
 
     @property
     def size(self):
         '''The size of the W(t) matrix.
 
         Returns
         -------
@@ -671,111 +750,25 @@
         out : `~scipy.sparse.coo_matrix` or `None`
             The matrix W(t).
             The size of the W(t) matrix is ``size`` x ``size``, containing
             ``nnz`` complex entries. If an ``out`` argument is given,
             the operation is performed in-place and the routine returns `None`.
         '''
 
-        cdef double c0, c1, c2, rdt2
-        cdef double a, b, c, d
-        cdef unsigned i
-
-        if out is not None:
+        if out is None:
+            self.intfunc.eval(time, self.wt.data)
+            return self.wt
+        else:
             assert out.shape[0] == self.size, _errormsg.format('output',
                                                                out.shape[0],
                                                                self.size)
             assert out.data.shape[0] == self.nnz, _errormsg.format('output.dat',
                                                                    out.data.shape[0],
                                                                    self.nnz)
-
-        if self.dt > 0:
-
-            # update matrices
-            if time >= self.t2:
-                t0_new, t1_new, t2_new, t3_new, t4_new = update_times(time, self.t0, self.dt)
-                rdt2 = 1 / (self.dt * self.dt)
-                cc2 = - rdt2 / 12
-                cc1 = rdt2 * 4 / 3
-                cc0 = - 2.5 * rdt2
-                # update matrices H0t, H1t, H2t, try to reuse stuff from last step
-                if np.isclose(t0_new, self.t2):
-                    for i in range(self.nnz):
-                        self.Ht0[i] = self.Ht2[i]
-                        self.Ht1[i] = self.Ht3[i]
-                        self.Ht2[i] = self.Ht4[i]
-                    self.wfunc.data(t3_new, self.Ht3)
-                    self.wfunc.data(t4_new, self.Ht4)
-                    for i in range(self.nnz):
-                        self.d2Ht0[i] = self.d2Ht2[i]
-                        # w''(t2), central finite difference scheme
-                        self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
-                            + cc1 * (self.Ht1[i] + self.Ht3[i]) \
-                            + cc0 * self.Ht2[i]
-                else:
-                    Htm2 = self.wfunc.data(t0_new - 2 * self.dt)
-                    Htm1 = self.wfunc.data(t0_new - self.dt)
-                    self.wfunc.data(t0_new, self.Ht0)
-                    self.wfunc.data(t1_new, self.Ht1)
-                    self.wfunc.data(t2_new, self.Ht2)
-                    self.wfunc.data(t3_new, self.Ht3)
-                    self.wfunc.data(t4_new, self.Ht4)
-                    # w''(t) on t0 and t2, central finite difference scheme
-                    for i in range(self.nnz):
-                        self.d2Ht0[i] = cc2 * (Htm2[i] + self.Ht2[i]) \
-                            + cc1 * (Htm1[i] + self.Ht1[i]) \
-                            + cc0 * self.Ht0[i]
-                        self.d2Ht2[i] = cc2 * (self.Ht0[i] + self.Ht4[i]) \
-                            + cc1 * (self.Ht1[i] + self.Ht3[i]) \
-                            + cc0 * self.Ht2[i]
-
-                for i in range(self.nnz):
-                    # w''(t) on t1, spline formula
-                    self.d2Ht1[i] = 1.5 * rdt2 * (self.Ht0[i] + self.Ht2[i] - 2 * self.Ht1[i])\
-                        - 0.25 * (self.d2Ht0[i] + self.d2Ht2[i])
-                    self.y0[i] = self.Ht0[i]
-                    self.y1[i] = self.Ht1[i]
-                    self.d2y0[i] = self.d2Ht0[i]
-                    self.d2y1[i] = self.d2Ht1[i]
-                self.t0, self.t1, self.t2, self.t3, self.t4 = t0_new, t1_new, t2_new, t3_new, t4_new
-                self.x0, self.x1 = self.t0, self.t1
-                self._do_update = True
-
-            # to construct the spline, we need f and f''
-            # on the two intervals [t0, t1] and [t1, t2].
-            # the spline is then evaluated first on the left, then on the right
-            # interval. again f and f'' are shifted from left to right interval.
-            if self._do_update and time > self.t1:
-                for i in range(self.nnz):
-                    self.y0[i] = self.Ht1[i]
-                    self.y1[i] = self.Ht2[i]
-                    self.d2y0[i] = self.d2Ht1[i]
-                    self.d2y1[i] = self.d2Ht2[i]
-                self.x0, self.x1 = self.t1, self.t2
-                self._do_update = False
-
-            a, b, c, d = _get_polynome_coeffs(time, self.x0, self.x1, self.dt)
-
-            if out is None:
-                for i in range(self.nnz):
-                    self.wt.data[i] = a * self.y0[i] + b * self.y1[i] \
-                        + c * self.d2y0[i] + d * self.d2y1[i]
-                return self.wt
-            else:
-                for i in range(self.nnz):
-                    out.data[i] = a * self.y0[i] + b * self.y1[i] \
-                        + c * self.d2y0[i] + d * self.d2y1[i]
-
-        else:
-            if out is None:
-                do_return = True
-                out = self.wfunc.evaluate(time)
-            else:
-                do_return = False
-                self.wfunc.evaluate(time, out)
-            return out if do_return else None
+            self.intfunc.eval(time, out.data)
 
     @cython.boundscheck(False)
     @cython.wraparound(False)
     def apply(self, double time, const complex[:] ket, object out=None):
         '''Evaluate the matrix-vector product W(t) @ ket for the given time.
 
         Parameters
@@ -788,153 +781,209 @@
         Returns
         -------
         out : `numpy.ndarray` or `None`
             The product W(t) @ ket. If an ``out`` argument is given,
             the operation is performed in-place and the routine returns `None`.
         '''
 
-        do_return = out is None
-
-        if self.dt > 0:
-
-            assert ket.shape[0] == self.size, _errormsg.format('Ket',
-                                                               ket.shape[0],
+        assert ket.shape[0] == self.size, _errormsg.format('Ket',
+                                                           ket.shape[0],
+                                                           self.size)
+        if out is None:
+            do_return = True
+            out = np.zeros((self.size,), dtype=complex)
+        else:
+            assert out.shape[0] == self.size, _errormsg.format('output',
+                                                               out.shape[0],
                                                                self.size)
-            if out is None:
-                out = np.zeros((self.size,), dtype=np.complex)
-            else:
-                assert out.shape[0] == self.size, _errormsg.format('output',
-                                                                   out.shape[0],
-                                                                   self.size)
-
-            self.wt = self.evaluate(time)
 
-            coo_matvec(
-                self.wt.nnz, self.wt.row, self.wt.col, self.wt.data,
-                ket, out)
+        self.evaluate(time, self.wt)
 
-        else:
-            if out is None:
-                do_return = True
-                out = self.wfunc.apply(time, ket)
-            else:
-                do_return = False
-                self.wfunc.apply(time, ket, out)
+        coo_matvec(
+            self.wt.nnz, self.wt.row, self.wt.col, self.wt.data,
+            ket, out)
 
         return out if do_return else None
 
-# Example Kernel implementation in C
-
-cdef class _CSRMatrix:
-    cdef complex[:] data
-    cdef int nrows, ncols
-    cdef int[:] indices, indptr
-
-    def __cinit__(self, mat):
-        mat = mat.tocsr()
-        self.nrows, self.ncols = mat.shape
-        self.data = mat.data
-        self.indices, self.indptr = mat.indices, mat.indptr
 
+# Example Kernel implementation in C
 
 @cython.boundscheck(False)
 @cython.wraparound(False)
 @cython.initializedcheck(False)
-cdef _csr_spmv(_CSRMatrix A, const complex *X, complex *Y):
+cdef _csr_spmv_ptr(const int size, const int *indptr, const int *indices,
+                   const complex *data,  const complex *X, complex *Y):
     """Naive implementation of CSR-format matrix-vector multiplication.
 
     This is taken almost verbatim from scipy.sparse.
     """
     cdef complex sum
     cdef unsigned i, jj
 
-    for i in range(A.nrows):
+    for i in range(size):
        sum = Y[i]
-       for jj in range(A.indptr[i], A.indptr[i+1]):
-           sum += A.data[jj] * X[A.indices[jj]]
+       for jj in range(indptr[i], indptr[i+1]):
+           sum += data[jj] * X[indices[jj]]
        Y[i] = sum
 
 
-cdef class Simple(CKernel):
+cdef class Simple(Kernel):
     """A C-implemented kernel using naive CSR matvec."""
 
     cdef:
+        object H0
         object W
-        object params
+#        PerturbationExtractor W
         int center_size
-        complex[:] _psi_st, _temp
-        complex *temp,
-        complex *psi_st
-        _CSRMatrix H0
+        complex[:] psi_st
+        object _temp
 
-    def __init__(self, H0, W, params, complex[:] psi_st=None):
+    def __init__(self, H0, W, complex[:] psi_st=None, work=None):
         pass
 
-    def set_params(self, params):
-        self.params = params
+    def __cinit__(self, H0, W, complex[:] psi_st=None, work=None):
+
+        if not isinstance(H0, sp.csr.csr_matrix):
+            self.H0 = H0.tocsr()  # self.H0 is no reference any more in that case
+        else:
+            self.H0 = H0
 
-    def __cinit__(self, H0, W, params, complex[:] psi_st=None):
-        self.c_self = <void*> self
-        self.params = params
-        self.c_rhs = self._rhs
         self.W = W
         self.size = H0.shape[0]
-        self._psi_st = psi_st
-        if psi_st is None:
-            self.psi_st = NULL
-        else:
-            self.psi_st = &psi_st[0]
+
         if W is not None:
             self.center_size = self.W.size
         else:
             self.center_size = self.size
-        self.H0 = _CSRMatrix(H0)
-        self._temp = np.empty((self.center_size,), dtype=complex)
-        self.temp = &self._temp[0]
+        self.psi_st = psi_st
+        if work is None:
+            self._temp = np.empty((self.center_size,), dtype=complex)
+        else:
+            if work.size < self.center_size:
+                raise ValueError('work array size={} must be at least '
+                     'the size of the central system={}'
+                     .format(work.size, self.center_size))
+            self._temp = work
+
+
+    def rhs(self, energy=None):
+
+        if energy is None:
+            H0 = self.H0
+        else:
+            H0 = self.H0 - energy * sp.eye(self.size)
+
+        # The approach with a separated class ``_CalcRHS`` to calculate the r.h.s.
+        # seems more complicated, but it allows to store the static Hamiltonian
+        # as a reference in class ``Scipy(Kernel)`` in ``self.H0``
+        # (for manybody calculations there is onle reference per rank).
+        # Moreover, the calculation ``H = H0 - E`` is done inplace,
+        # and only once when the Scipy(Kernel).rhs() method is called.
+        # It is important to precalculate H0 - E at this stage
+        # (typically when ``WaveFunction.evolve()`` is called) and not
+        # to do the inplace calculation in ``_CalcRHS.__call__()``,
+        # as the later method is called very often (by the DGL solver).
+        # The implace calculation generates only a temporary object ``H``
+        # which not stored in the ``onebody.WaveFunction``, such
+        # that it is cleaned by the garbage collector.
+        return _CalcRHSc(H0.indptr, H0.indices, H0.data, self.W, self.psi_st, 
+                         self.size, self.center_size, self._temp)
+
+    @property
+    def W(self):
+        '''The time dependent perturbation W(t)'''
+        return self.W
+
+    def set_W(self, W):
+        '''Set the time dependent perturbation W(t)'''
+        self.W = W
+
+
+cdef class _CalcRHSc:
+
+    cdef:
+        object W
+        #PerturbationExtractor W
+        int center_size, size
+        complex *psi_st
+        complex *temp
+        complex[:] _data
+        int[:] _indices, _indptr
+
+    def __init__(self, int[:] indptr, int[:] indices, complex[:] data, W, complex[:] psi_st, 
+                 int size, int center_size, complex[:] temp):
+        pass
+
+    """Calculate the right-hand-side of the time-dependent Schrödinger equation."""
+    def __cinit__(self, int[:] indptr, int[:] indices, complex[:] data, W, complex[:] psi_st, 
+                  int size, int center_size, complex[:] temp):
+
+        self._data = data
+        self._indices = indices
+        self._indptr = indptr
+        self.W = W
+        if psi_st is None:
+            self.psi_st = NULL
+        else:
+            self.psi_st = &psi_st[0]
+        self.size = size
+        self.center_size = center_size
+
+        # the id of the temp array is not the same any more due to argument complex[:] temp
+        #print('simple kernel work', id(temp))
+        #exit(0)
+
+        self.temp = &temp[0]
+
 
     # RHS implemented as a static method to conform to the solver interface.
-    @staticmethod
     @cython.boundscheck(False)
     @cython.wraparound(False)
-    cdef void _rhs(const void *_self, const complex *psi, complex *dpsidt,
-                   double time) except *:
-        cdef Simple self = <Simple>_self
+    def __call__(self, const complex[::1] psi, complex[::1] dpsidt, double time):
+
+        cdef int *indptr
+        cdef int *indices
+        cdef complex *data
+
+        data = &self._data[0]
+        indices = &self._indices[0]
+        indptr = &self._indptr[0]
+
         cdef unsigned i
         for i in range(self.size):
             dpsidt[i] = 0
+
         ### H0 @ psi -> dpsidt
-        _csr_spmv(self.H0, psi, dpsidt)
+        _csr_spmv_ptr(self.size, indptr, indices, data, &psi[0], &dpsidt[0])
+
+
         ### W(t) @ psi + dpsidt -> dpsidt
         if self.psi_st == NULL:
             try:
-                self.W.apply(time, <complex[:self.center_size]>psi,
-                             out=<complex[:self.center_size]>dpsidt)
+                self.W.apply(time, <complex[:self.center_size]>&psi[0],
+                             out=<complex[:self.center_size]>&dpsidt[0])
             except Exception as exept:
                 if self.W is None:
                     pass
                 else:
                     raise exept
         else:
             # we need to act on `temp = psi + psi_st`
             # use pre-allocated storage
             for i in range(self.center_size):
                 self.temp[i] = psi[i] + self.psi_st[i]
             try:
                 self.W.apply(time, <complex[:self.center_size]>self.temp,
-                             out=<complex[:self.center_size]>dpsidt)
+                             out=<complex[:self.center_size]>&dpsidt[0])
             except Exception as exept:
                 if self.W is None:
                     pass
                 else:
                     raise exept
         ### dpsidt = -1j * dpsidt
         for i in range(self.size):
             dpsidt[i] = -1j * dpsidt[i]
 
+    def __reduce__(self):
+        raise NotImplementedError("use the scipy kernel for serialization")
 
-try:
-    from ._sparse_blas_kernel import SparseBlas
-    __all__.append('SparseBlas')
-except ImportError as e:
-    pass
-
-default = Scipy
+default = Simple
```

### Comparing `tkwant-1.0.1/tkwant/onebody/onebody.py` & `tkwant-1.1.0rc2/tkwant/onebody/onebody.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,30 +1,31 @@
-# Copyright 2016-2020 tkwant authors.
+# Copyright 2016-2022 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Tools for solving the one-body time-dependent Schrödinger equation."""
 
 import collections.abc
 import functools
 from cmath import exp
 import numpy as np
 import scipy.sparse as sp
 
 import kwant
 import kwantspectrum
 
-from .. import leads, _common, _logging
-from ..system import hamiltonian_with_boundaries, add_time_to_params
+from .. import leads, _common, _logging, system
 from . import kernels, solvers
 
-__all__ = ['WaveFunction', 'ScatteringStates', 'Task']
+__all__ = ['WaveFunction', 'ScatteringStates', 'Task', 'make_extended_system',
+           '_get_time_name_from_wavefunction']
 
 
 # set module logger
 logger = _logging.make_logger(name=__name__)
 log_func = _logging.log_func(logger)
 
 
@@ -89,14 +90,100 @@
         if hasattr(operator, '_bound_onsite'):
             return bool(operator._bound_onsite)
         if hasattr(operator, '_bound_hamiltonian'):
             return bool(operator._bound_hamiltonian)
         return False
 
 
+def _get_time_name_from_wavefunction(wavefunction_type=None, derived_type=None):
+    """Return name, initial time and onebody wave function type"""
+    default_arg = _common.get_default_function_argument
+    try:
+        if wavefunction_type is None:
+            wavefunction_type = default_arg(derived_type, 'wavefunction_type')
+        time_name = default_arg(wavefunction_type, 'time_name')
+        time_start = default_arg(wavefunction_type, 'time_start')
+    except Exception:
+        time_name = _common.time_name
+        time_start = _common.time_start
+        wavefunction_type = None
+        logger.warning('retrieving initial time and time argument name from',
+                       'the onebody wavefunction failed, use default values: ',
+                       '"time_name"={}, "time_start"={}'.format(time_name,
+                                                                time_start))
+    return time_name, time_start, wavefunction_type
+
+class _PerturbationWrap:
+    def __init__(self, wt):
+        self.wt = wt
+        self.qt = None  # this will hold the interaction
+        self._perturb_set = False
+
+    def size(self):
+        return wt.size
+
+    def set(self, qt):
+        self.qt = qt
+        self._perturb_set = True
+
+    def evaluate(self, time):
+        wt = self.wt.evaluate(time)
+        try:
+            qt = self.qt(time)
+            return wt + qt
+        except Exception:
+            return wt
+
+    def apply(self, time, ket, out):
+        try:
+            self.wt.apply(time, ket, out)
+        except Exception as exept:
+            if self.wt is None:
+                pass
+            else:
+                raise exept
+        if self._perturb_set:
+            qt = self.qt(time)
+            out[:] += qt * ket
+        else:
+            return
+
+
+
+def make_extended_system(syst, solver_type, boundaries=None, tparams=None):
+
+    tmax = None
+    if syst.leads:
+        if not boundaries:
+            raise ValueError('Must provide boundary conditions for '
+                             'systems with leads.')
+        H0, boundary_slices = system._hamiltonian_with_boundaries(syst, boundaries,
+                                                                  tparams)
+        # if any boundary has a tmax, then take it. if the tmax are different,
+        # we will always take the lowest for safety
+        for bdr in boundaries:
+            if bdr.tmax is not None:
+                if tmax is not None:
+                    tmax = min(tmax, bdr.tmax)
+                else:
+                    tmax = bdr.tmax
+    else:
+        if boundaries is not None:
+            logger.warning('boundaries will not be used for extended system')
+        H0 = syst.hamiltonian_submatrix(params=tparams, sparse=True)
+        boundary_slices = None
+
+    size = H0.shape[0]
+    assert _common.is_type(size, 'integer')
+    solver = solver_type(size)
+    work = np.zeros((size,), dtype=complex)
+
+    return system.ExtendedSystem(syst, H0, boundary_slices, solver, work, tmax)
+
+
 class WaveFunction:
     r"""A class to solve the time-dependent single-particle wavefunction.
 
     The time-dependent single-particle Schrödinger equation is
 
         :math:`i \partial_t \psi = (H_0 + W(t)) \psi`,
 
@@ -122,17 +209,17 @@
 
         :math:`\psi = (\bar{\psi} - \psi_{st}) e^{-i E (t - t_0)}`.
 
     See `J. Weston and X. Waintal, Phys. Rev. B 93, 134506 (2016)
     <https://arxiv.org/abs/1510.05967>`_.
     """
     def __init__(self, H0, W, psi_init, energy=None, params=None,
-                 solution_is_valid=None, time_is_valid=None,
                  time_start=_common.time_start, time_name=_common.time_name,
-                 kernel_type=kernels.default, solver_type=solvers.default):
+                 kernel_type=kernels.default, solver_type=solvers.default,
+                 work=None, inplace=False, tmax=None):
         r"""
         Parameters
         ----------
         H0 : array-like
             The static part of the Hamiltonian matrix, :math:`H_0`.
         W : callable or `None`
             Time-dependent part of the Hamiltonian matrix, :math:`W(t)`. Typically
@@ -145,29 +232,31 @@
             of energy :math:`E`. If the Hamiltonian represents an open
             quantum system with leads, then ``psi_init`` is
             assumed to be the projection of a scattering state at energy :math:`E`
             on to the central part of the system.
         params : dict, optional
             Extra arguments to pass to the time-dependent Hamiltonian
             function :math:`W(t)`, excluding time.
-        solution_is_valid : callable, optional
-            Function to detect spurious reflections for a system with leads.
-            See `tkwant.leads.EvaluatedBoundary`.
-        time_is_valid : callable, optional
-            Function to check if boundary conditions are valid at a given time.
-            See `tkwant.leads.EvaluatedBoundary`.
         time_start : float, optional
             The initial time :math:`t_0`. Default value is zero.
         time_name : str, optional
             The name of the time argument :math:`t`. Default name: *time*.
         kernel_type : `tkwant.onebody.solvers.default`, optional
             The kernel to calculate the right-hand-site of the
             Schrödinger equation.
         solver_type : `tkwant.onebody.solvers.default`, optional
             The solver used to evolve the wavefunction forward in time.
+        work : `~numpy.ndarray` of complex, optional
+            Workarray of size ``H0.shape[0]`` for performance and memory optimization.
+        inplace : bool, optional
+            If true and ``energy`` is not None,
+            the term ``H0 - E`` is calculated inplace in order to save memory.
+            If ``energy`` is None, ``inplace`` has no effect.
+        tmax : float, optional
+            Optional maximal time until when the boundary is valid.
         """
 
         # The size of the central scattering region. The central scattering
         # region can be smaller as the total size (kernel.size) of the system
         # in case of boundary conditions.
         syst_size = psi_init.size
         hamiltonian_size = H0.shape[0]
@@ -181,55 +270,66 @@
         # central scattering region. The true leads are never time dependent.
         if W is not None:
             if not W.size == syst_size:
                 raise ValueError('initial condition size={} must be equal '
                                  'to the perturbation W size={}'
                                  .format(syst_size, W.size))
 
-        # add initial time to the params dict
-        tparams = add_time_to_params(params, time_name=time_name,
-                                     time=time_start, check_numeric_type=True)
+        if work is not None:
+            if not work.size == hamiltonian_size:
+                raise ValueError('work array size={} must be equal '
+                                 'Hamiltonian matrix H0 size={}'
+                                 .format(work.size, hamiltonian_size))
+
+        # transform initial psi to psibar and psi_st
+        # note that the dgl is always solved in the variable psibar
+        psibar = np.zeros((hamiltonian_size,), complex)
 
-        if energy is None:
+        if energy is not None:
             # starting from an arbitrary state, so we need
             # to be solving: H0 @ psi + W(t) @ psi
-            kernel = kernel_type(H0, W, params=tparams)
-
+            psi_st = np.array(psi_init, complex)
         else:
             # we are starting from an eigenstate, so we need to
             # be solving: (H0 - E) @ psibar + W(t) @ (psibar + psi_st)
             # and psi = (psibar + psi_st) * exp(-1j * energy * time)
-            kernel = kernel_type(H0 - energy * sp.eye(hamiltonian_size),
-                                 W, tparams, np.asarray(psi_init))
+            psi_st = None
+            psibar[:syst_size] = psi_init
 
         # get the object that will actually do the time stepping
-        self.solver = solver_type(kernel)
+        try:
+            self.solver = solver_type(hamiltonian_size)
+        except Exception:
+            self.solver = solver_type
+        if not self.solver.size == hamiltonian_size:
+            raise ValueError('solver size={} must be equal to '
+                             'Hamiltonian matrix H0 size={}'
+                             .format(self.solver.size, hamiltonian_size))
 
-        # transform initial psi to psibar and psi_st
-        # note that the dgl is always solved in the variable psibar
-        psibar = np.zeros((kernel.size,), complex)
-        if energy is not None:
-            psi_st = np.array(psi_init, complex)
+        # kernel to evaluate the r.h.s. of the Schödinger eq.
+        if not inplace and energy is not None:
+            self.kernel = kernel_type(H0 - energy * sp.eye(hamiltonian_size),
+                                      W, psi_st, work)
         else:
-            psi_st = None
-            psibar[:syst_size] = psi_init
+            self.kernel = kernel_type(H0, W, psi_st, work)
+        self._inplace = True if (inplace and energy is not None) else False
 
         self.psibar = psibar
         self.psi_st = psi_st
 
         self._syst_size = syst_size
-        self._solution_is_valid = solution_is_valid
-        self._time_is_valid = time_is_valid
 
         self.time_name = time_name
         self.time_start = time_start
 
         self.time = time_start
         self.params = params
         self.energy = energy
+        self.tmax = tmax
+        self._perturb = None
 
     @classmethod
     def from_kwant(cls, syst, psi_init, boundaries=None, energy=None, params=None,
                    time_start=_common.time_start, time_name=_common.time_name,
                    kernel_type=kernels.default, solver_type=solvers.default,
                    perturbation_type=kernels.PerturbationInterpolator):
         """Set up a time-dependent onebody wavefunction from a kwant system.
@@ -265,54 +365,45 @@
             out of ``syst``.
 
         Returns
         -------
         wave_function : `tkwant.onebody.WaveFunction`
             A time-dependent onebody wavefunction at the initial time.
         """
+        # add initial time to the params dict
+        tparams = system.add_time_to_params(params, time_name=time_name,
+                                            time=time_start, check_numeric_type=True)
 
-        if not isinstance(syst, kwant.system.System):
-            raise TypeError('"syst" must be a finalized kwant system')
+        if isinstance(syst, kwant.system.System):
+            extended_syst = make_extended_system(syst, solver_type, boundaries, tparams)
+        elif isinstance(syst, system.ExtendedSystem):
+            extended_syst = syst
+            syst = extended_syst.syst
+        else:
+            raise TypeError('"syst" must be a finalized kwant system '
+                            'or a "tkwant.system.ExtendedSystem"')
 
-        syst_size = syst.site_ranges[-1][2]
+        syst_size = extended_syst.syst.site_ranges[-1][2]
         if not psi_init.size == syst_size:
             raise ValueError('Size of the initial condition={} does not match '
                              'the total number of orbitals in the central '
                              'system ={}'.format(psi_init.size, syst_size))
 
-        # add initial time to the params dict
-        tparams = add_time_to_params(params, time_name=time_name,
-                                     time=time_start, check_numeric_type=True)
+        H0 = extended_syst.H0
+        work = extended_syst.work
+        solver = extended_syst.solver
+        tmax = extended_syst.tmax
 
-        if syst.leads:
-            # need to add boundary conditions
-            if not boundaries:
-                raise ValueError('Must provide boundary conditions for systems '
-                                 'with leads.')
-            # get static part of Hamiltonian for central system + boundary conditions
-            # TODO: Make this work with arbitrary kwant.system.FiniteSystem.
-            extended_system = hamiltonian_with_boundaries(syst, boundaries,
-                                                          params=tparams)
-            H0 = extended_system.hamiltonian
-            solution_is_valid = extended_system.solution_is_valid
-            time_is_valid = extended_system.time_is_valid
-        else:
-            # true finite systems (no leads) so no need for boundary conditions
-            if boundaries is not None:
-                raise ValueError('No boundary conditions must be provided '
-                                 'for a system without leads.')
-            H0 = syst.hamiltonian_submatrix(params=tparams, sparse=True)
-            solution_is_valid = None
-            time_is_valid = None
-
-        W = perturbation_type(syst, time_name, time_start, params=params)
+        try:
+            W = syst.time_dependent_perturbation(time_name, time_start, params)
+        except AttributeError:
+            W = perturbation_type(syst, time_name, time_start, params=params)
 
         return cls(H0, W, psi_init, energy, params,
-                   solution_is_valid, time_is_valid,
-                   time_start, time_name, kernel_type, solver_type)
+                   time_start, time_name, kernel_type, solver, work, tmax=tmax)
 
     def psi(self):
         r"""Return the wavefunction :math:`\psi(t)` at the current time *t*.
 
         psi : `~numpy.ndarray`
             The wavefunction at ``time``. If this wavefunction is
             for a system with leads, then the wavefunction projected
@@ -320,42 +411,41 @@
         """
         if self.energy is None:  # psi = psibar
             return self.psibar[:self._syst_size].copy()
         # else : psi = (psibar + psi_st) * exp(-i E (t - t0))
         return ((self.psibar[:self._syst_size] + self.psi_st) *
                 exp(-1j * self.energy * (self.time - self.time_start)))
 
-    def evolve(self, time, params=None):
+    def evolve(self, time):
         r"""
         Evolve the wavefunction :math:`\psi(t)` foreward in time up to
         :math:`t =` ``time``.
 
         Parameters
         ----------
         time : int or float
             time argument up to which the solver should be evolved
         """
         # `time` corresponds to the future time, to which we will evolve
         if time < self.time:
             raise ValueError('Cannot evolve backwards in time')
         if time == self.time:
             return
-        if self._time_is_valid is not None:
-            if not self._time_is_valid(time):
-                raise RuntimeError('Cannot evolve up to {} with the given '
-                                   'boundary conditions'.format(time))
+        if self.tmax is not None:
+            if time > self.tmax:
+                logger.warning('time > tmax; time= {}, tmax= {}'. format(time, self.tmax))
 
         # evolve forward in time
-        next_psibar = self.solver(self.psibar, self.time, time)
+        if self._inplace:
+            next_psibar = self.solver(self.psibar, self.time, time,
+                                      self.kernel.rhs(self.energy))
+        else:
+            next_psibar = self.solver(self.psibar, self.time, time,
+                                      self.kernel.rhs())
 
-        if self._solution_is_valid is not None:
-            if not self._solution_is_valid(next_psibar):
-                raise RuntimeError('Evolving between {} and {} resulted in an '
-                                   'unphysical result due to the boundary '
-                                   'conditions'.format(self.time, time))
         # update internal state and return
         self.psibar, self.time = next_psibar, time
 
     def evaluate(self, observable):
         r"""
         Evaluate the expectation value of an operator at the current time *t*.
 
@@ -372,18 +462,32 @@
         -------
         result : numpy array
             The expectation value :math:`O(t)` of ``observable``.
         """
         if _operator_bound(observable):
             raise ValueError("Operator must not use pre-bind values")
 
-        tparams = add_time_to_params(self.params, time_name=self.time_name,
-                                     time=self.time)
+        tparams = system.add_time_to_params(self.params, time_name=self.time_name,
+                                            time=self.time)
         return observable(self.psi(), params=tparams)
 
+    def add_perturbation(self, qt):
+        """Add a time-dependent perturbation to the Hamiltonian
+
+         H(t) = H_0 + W(t)
+
+         it is modified to
+
+         H(t) = H_0 + W(t) + Q(t)
+        """
+        if self._perturb is None:
+            self._perturb = _PerturbationWrap(self.kernel.W)
+        self._perturb.set(qt)
+        self.kernel.set_W(self._perturb)
+
 
 class ScatteringStates(collections.abc.Iterable):
     """Calculate time-dependent wavefunctions starting in an equilibrium scattering state"""
 
     def __init__(self, syst, energy, lead, tmax=None, params=None, spectra=None,
                  boundaries=None, equilibrium_solver=kwant.wave_function,
                  wavefunction_type=WaveFunction.from_kwant):
@@ -424,54 +528,55 @@
         instances. The index in the sequence corresponds to the scattering mode.
         The name of the time argument (`time_name`) and the initial time
         of the evolution (`time_start`) are taken from the default
         values of the `WaveFunction.__init__` method. Changing the default
         values by partial prebind (e.g. via functools) is possible.
         """
 
-        if not isinstance(syst, kwant.system.System):
-            raise TypeError('"syst" must be a finalized kwant system')
+        if isinstance(syst, kwant.system.System):
+            extended_syst = None
+        elif isinstance(syst, system.ExtendedSystem):
+            if boundaries is not None:
+                logger.warning('boundaries will not be used for extended system')
+            extended_syst = syst
+            syst = extended_syst.syst
+        else:
+            raise TypeError('"syst" must be a finalized kwant system '
+                            'or a "tkwant.system.ExtendedSystem"')
         if not syst.leads:
             raise AttributeError("system has no leads.")
         if tmax is not None and boundaries is not None:
             raise ValueError("'boundaries' and 'tmax' are mutually exclusive.")
         if not _common.is_type(energy, 'real_number'):
             raise TypeError('energy must be a real number')
         if not _common.is_type(lead, 'integer'):
             raise TypeError('lead index must be an integer')
         if lead >= len(syst.leads):
             raise ValueError("lead index must be smaller than {}.".format(len(syst.leads)))
 
         # get initial time and time argument name from the onebody wavefunction
-        try:
-            time_name = _common.get_default_function_argument(wavefunction_type,
-                                                              'time_name')
-            time_start = _common.get_default_function_argument(wavefunction_type,
-                                                               'time_start')
-        except Exception:
-            time_name = _common.time_name
-            time_start = _common.time_start
-            logger.warning('retrieving initial time and time argument name from',
-                           'the onebody wavefunction failed, use default values: ',
-                           '"time_name"={}, "time_start"={}'.format(time_name,
-                                                                    time_start))
+        time_name, time_start, _ = _get_time_name_from_wavefunction(wavefunction_type)
 
         # add initial time to the params dict
-        tparams = add_time_to_params(params, time_name=time_name,
-                                     time=time_start, check_numeric_type=True)
+        tparams = system.add_time_to_params(params, time_name=time_name,
+                                            time=time_start, check_numeric_type=True)
 
-        if boundaries is None:
-            if spectra is None:
-                spectra = kwantspectrum.spectra(syst.leads, params=tparams)
-            boundaries = leads.automatic_boundary(spectra, tmax)
+        if extended_syst is None:
+            solver_type = _common.get_default_function_argument(wavefunction_type,
+                                                                'solver_type')
+            if boundaries is None:
+                if spectra is None:
+                    spectra = kwantspectrum.spectra(syst.leads, params=tparams)
+                boundaries = leads.automatic_boundary(spectra, tmax)
+            extended_syst = make_extended_system(syst, solver_type, boundaries, tparams)
 
         scattering_states = equilibrium_solver(syst, energy=energy, params=tparams)
         self._psi_st = scattering_states(lead)
-        self._wavefunction = functools.partial(wavefunction_type, syst=syst,
-                                               boundaries=boundaries, params=params)
+        self._wavefunction = functools.partial(wavefunction_type,
+                                               syst=extended_syst, params=params)
         self.energy = energy
         self.lead = lead
 
     def __getitem__(self, mode):
         """Return a time-dependent wavefunction for the corresponding scattering mode.
 
         Parameters
```

### Comparing `tkwant-1.0.1/tkwant/onebody/solvers.c` & `tkwant-1.1.0rc2/tkwant/onebody/solvers.c`

 * *Files 14% similar despite different names*

```diff
@@ -1,8 +1,8 @@
-/* Generated by Cython 0.29.2 */
+/* Generated by Cython 0.29.15 */
 
 /* BEGIN: Cython Metadata
 {
     "distutils": {
         "depends": [
             "tkwant/onebody/kernels.pxd"
         ],
@@ -18,16 +18,16 @@
 #define PY_SSIZE_T_CLEAN
 #include "Python.h"
 #ifndef Py_PYTHON_H
     #error Python headers needed to compile C extensions, please install development version of Python.
 #elif PY_VERSION_HEX < 0x02060000 || (0x03000000 <= PY_VERSION_HEX && PY_VERSION_HEX < 0x03030000)
     #error Cython requires Python 2.6+ or Python 3.3+.
 #else
-#define CYTHON_ABI "0_29_2"
-#define CYTHON_HEX_VERSION 0x001D02F0
+#define CYTHON_ABI "0_29_15"
+#define CYTHON_HEX_VERSION 0x001D0FF0
 #define CYTHON_FUTURE_DIVISION 1
 #include <stddef.h>
 #ifndef offsetof
   #define offsetof(type, member) ( (size_t) & ((type*)0) -> member )
 #endif
 #if !defined(WIN32) && !defined(MS_WINDOWS)
   #ifndef __stdcall
@@ -321,16 +321,21 @@
 #if PY_MAJOR_VERSION < 3
   #define __Pyx_BUILTIN_MODULE_NAME "__builtin__"
   #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
           PyCode_New(a+k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
   #define __Pyx_DefaultClassType PyClass_Type
 #else
   #define __Pyx_BUILTIN_MODULE_NAME "builtins"
+#if PY_VERSION_HEX >= 0x030800A4 && PY_VERSION_HEX < 0x030800B2
+  #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
+          PyCode_New(a, 0, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
+#else
   #define __Pyx_PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)\
           PyCode_New(a, k, l, s, f, code, c, n, v, fv, cell, fn, name, fline, lnos)
+#endif
   #define __Pyx_DefaultClassType PyType_Type
 #endif
 #ifndef Py_TPFLAGS_CHECKTYPES
   #define Py_TPFLAGS_CHECKTYPES 0
 #endif
 #ifndef Py_TPFLAGS_HAVE_INDEX
   #define Py_TPFLAGS_HAVE_INDEX 0
@@ -357,34 +362,14 @@
 #endif
 #if CYTHON_FAST_PYCCALL
 #define __Pyx_PyFastCFunction_Check(func)\
     ((PyCFunction_Check(func) && (METH_FASTCALL == (PyCFunction_GET_FLAGS(func) & ~(METH_CLASS | METH_STATIC | METH_COEXIST | METH_KEYWORDS | METH_STACKLESS)))))
 #else
 #define __Pyx_PyFastCFunction_Check(func) 0
 #endif
-#if CYTHON_USE_DICT_VERSIONS
-#define __PYX_GET_DICT_VERSION(dict)  (((PyDictObject*)(dict))->ma_version_tag)
-#define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)\
-    (version_var) = __PYX_GET_DICT_VERSION(dict);\
-    (cache_var) = (value);
-#define __PYX_PY_DICT_LOOKUP_IF_MODIFIED(VAR, DICT, LOOKUP) {\
-        static PY_UINT64_T __pyx_dict_version = 0;\
-        static PyObject *__pyx_dict_cached_value = NULL;\
-        if (likely(__PYX_GET_DICT_VERSION(DICT) == __pyx_dict_version)) {\
-            (VAR) = __pyx_dict_cached_value;\
-        } else {\
-            (VAR) = __pyx_dict_cached_value = (LOOKUP);\
-            __pyx_dict_version = __PYX_GET_DICT_VERSION(DICT);\
-        }\
-    }
-#else
-#define __PYX_GET_DICT_VERSION(dict)  (0)
-#define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)
-#define __PYX_PY_DICT_LOOKUP_IF_MODIFIED(VAR, DICT, LOOKUP)  (VAR) = (LOOKUP);
-#endif
 #if CYTHON_COMPILING_IN_PYPY && !defined(PyObject_Malloc)
   #define PyObject_Malloc(s)   PyMem_Malloc(s)
   #define PyObject_Free(p)     PyMem_Free(p)
   #define PyObject_Realloc(p)  PyMem_Realloc(p)
 #endif
 #if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX < 0x030400A1
   #define PyMem_RawMalloc(n)           PyMem_Malloc(n)
@@ -409,15 +394,15 @@
 #endif
 #if PY_VERSION_HEX < 0x030700A2 && !defined(PyThread_tss_create) && !defined(Py_tss_NEEDS_INIT)
 #include "pythread.h"
 #define Py_tss_NEEDS_INIT 0
 typedef int Py_tss_t;
 static CYTHON_INLINE int PyThread_tss_create(Py_tss_t *key) {
   *key = PyThread_create_key();
-  return 0; // PyThread_create_key reports success always
+  return 0;
 }
 static CYTHON_INLINE Py_tss_t * PyThread_tss_alloc(void) {
   Py_tss_t *key = (Py_tss_t *)PyObject_Malloc(sizeof(Py_tss_t));
   *key = Py_tss_NEEDS_INIT;
   return key;
 }
 static CYTHON_INLINE void PyThread_tss_free(Py_tss_t *key) {
@@ -432,15 +417,15 @@
 }
 static CYTHON_INLINE int PyThread_tss_set(Py_tss_t *key, void *value) {
   return PyThread_set_key_value(*key, value);
 }
 static CYTHON_INLINE void * PyThread_tss_get(Py_tss_t *key) {
   return PyThread_get_key_value(*key);
 }
-#endif // TSS (Thread Specific Storage) API
+#endif
 #if CYTHON_COMPILING_IN_CPYTHON || defined(_PyDict_NewPresized)
 #define __Pyx_PyDict_NewPresized(n)  ((n <= 8) ? PyDict_New() : _PyDict_NewPresized(n))
 #else
 #define __Pyx_PyDict_NewPresized(n)  PyDict_New()
 #endif
 #if PY_MAJOR_VERSION >= 3 || CYTHON_FUTURE_DIVISION
   #define __Pyx_PyNumber_Divide(x,y)         PyNumber_TrueDivide(x,y)
@@ -631,15 +616,16 @@
 #define CYTHON_WITHOUT_ASSERTIONS
 #endif
 
 typedef struct {PyObject **p; const char *s; const Py_ssize_t n; const char* encoding;
                 const char is_unicode; const char is_str; const char intern; } __Pyx_StringTabEntry;
 
 #define __PYX_DEFAULT_STRING_ENCODING_IS_ASCII 0
-#define __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT 0
+#define __PYX_DEFAULT_STRING_ENCODING_IS_UTF8 0
+#define __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT (PY_MAJOR_VERSION >= 3 && __PYX_DEFAULT_STRING_ENCODING_IS_UTF8)
 #define __PYX_DEFAULT_STRING_ENCODING ""
 #define __Pyx_PyObject_FromString __Pyx_PyBytes_FromString
 #define __Pyx_PyObject_FromStringAndSize __Pyx_PyBytes_FromStringAndSize
 #define __Pyx_uchar_cast(c) ((unsigned char)c)
 #define __Pyx_long_cast(x) ((long)x)
 #define __Pyx_fits_Py_ssize_t(v, type, is_signed)  (\
     (sizeof(type) < sizeof(Py_ssize_t))  ||\
@@ -824,97 +810,36 @@
 static PyObject *__pyx_empty_bytes;
 static PyObject *__pyx_empty_unicode;
 static int __pyx_lineno;
 static int __pyx_clineno = 0;
 static const char * __pyx_cfilenm= __FILE__;
 static const char *__pyx_filename;
 
-/* Header.proto */
-#if !defined(CYTHON_CCOMPLEX)
-  #if defined(__cplusplus)
-    #define CYTHON_CCOMPLEX 1
-  #elif defined(_Complex_I)
-    #define CYTHON_CCOMPLEX 1
-  #else
-    #define CYTHON_CCOMPLEX 0
-  #endif
-#endif
-#if CYTHON_CCOMPLEX
-  #ifdef __cplusplus
-    #include <complex>
-  #else
-    #include <complex.h>
-  #endif
-#endif
-#if CYTHON_CCOMPLEX && !defined(__cplusplus) && defined(__sun__) && defined(__GNUC__)
-  #undef _Complex_I
-  #define _Complex_I 1.0fj
-#endif
-
 
 static const char *__pyx_f[] = {
   "tkwant/onebody/solvers.pyx",
-  "tkwant/onebody/kernels.pxd",
+  "stringsource",
 };
-/* Declarations.proto */
-#if CYTHON_CCOMPLEX
-  #ifdef __cplusplus
-    typedef ::std::complex< double > __pyx_t_double_complex;
-  #else
-    typedef double _Complex __pyx_t_double_complex;
-  #endif
-#else
-    typedef struct { double real, imag; } __pyx_t_double_complex;
-#endif
-static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double, double);
-
 
 /*--- Type declarations ---*/
-struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel;
-struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel;
-
-/* "kernels.pxd":18
- * 
- * 
- * ctypedef void (*rhs_t)(const void *self, const complex *psi_bar, complex *dpsidt,             # <<<<<<<<<<<<<<
- *                        double time) except *
- * 
- */
-typedef void (*__pyx_t_6tkwant_7onebody_7kernels_rhs_t)(void const *, __pyx_t_double_complex const *, __pyx_t_double_complex *, double);
-struct __pyx_defaults;
-typedef struct __pyx_defaults __pyx_defaults;
-struct __pyx_defaults {
-  PyObject *__pyx_arg_integrator;
-};
+struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy;
 
-/* "kernels.pxd":14
+/* "tkwant/onebody/solvers.pyx":20
  * 
  * 
- * cdef class Kernel:             # <<<<<<<<<<<<<<
- *     cdef public int size, nevals
+ * cdef class Scipy:             # <<<<<<<<<<<<<<
+ *     """Solve the time-dependent Schrdinger equation using `scipy.integrate`.
  * 
  */
-struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel {
+struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy {
   PyObject_HEAD
+  PyObject *_integrator;
+  PyObject *_rhs_out;
+  PyObject *rhs;
   int size;
-  int nevals;
-};
-
-
-/* "kernels.pxd":22
- * 
- * 
- * cdef class CKernel(Kernel):             # <<<<<<<<<<<<<<
- *     cdef void *c_self
- *     cdef rhs_t c_rhs
- */
-struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel {
-  struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel __pyx_base;
-  void *c_self;
-  __pyx_t_6tkwant_7onebody_7kernels_rhs_t c_rhs;
 };
 
 
 /* --- Runtime support code (head) --- */
 /* Refnanny.proto */
 #ifndef CYTHON_REFNANNY
   #define CYTHON_REFNANNY 0
@@ -984,33 +909,50 @@
 #else
 #define __Pyx_PyObject_GetAttrStr(o,n) PyObject_GetAttr(o,n)
 #endif
 
 /* GetBuiltinName.proto */
 static PyObject *__Pyx_GetBuiltinName(PyObject *name);
 
-/* RaiseArgTupleInvalid.proto */
-static void __Pyx_RaiseArgtupleInvalid(const char* func_name, int exact,
-    Py_ssize_t num_min, Py_ssize_t num_max, Py_ssize_t num_found);
-
 /* RaiseDoubleKeywords.proto */
 static void __Pyx_RaiseDoubleKeywordsError(const char* func_name, PyObject* kw_name);
 
 /* ParseKeywords.proto */
 static int __Pyx_ParseOptionalKeywords(PyObject *kwds, PyObject **argnames[],\
     PyObject *kwds2, PyObject *values[], Py_ssize_t num_pos_args,\
     const char* function_name);
 
-/* PyObjectSetAttrStr.proto */
-#if CYTHON_USE_TYPE_SLOTS
-#define __Pyx_PyObject_DelAttrStr(o,n) __Pyx_PyObject_SetAttrStr(o, n, NULL)
-static CYTHON_INLINE int __Pyx_PyObject_SetAttrStr(PyObject* obj, PyObject* attr_name, PyObject* value);
+/* RaiseArgTupleInvalid.proto */
+static void __Pyx_RaiseArgtupleInvalid(const char* func_name, int exact,
+    Py_ssize_t num_min, Py_ssize_t num_max, Py_ssize_t num_found);
+
+/* PyDictVersioning.proto */
+#if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
+#define __PYX_DICT_VERSION_INIT  ((PY_UINT64_T) -1)
+#define __PYX_GET_DICT_VERSION(dict)  (((PyDictObject*)(dict))->ma_version_tag)
+#define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)\
+    (version_var) = __PYX_GET_DICT_VERSION(dict);\
+    (cache_var) = (value);
+#define __PYX_PY_DICT_LOOKUP_IF_MODIFIED(VAR, DICT, LOOKUP) {\
+    static PY_UINT64_T __pyx_dict_version = 0;\
+    static PyObject *__pyx_dict_cached_value = NULL;\
+    if (likely(__PYX_GET_DICT_VERSION(DICT) == __pyx_dict_version)) {\
+        (VAR) = __pyx_dict_cached_value;\
+    } else {\
+        (VAR) = __pyx_dict_cached_value = (LOOKUP);\
+        __pyx_dict_version = __PYX_GET_DICT_VERSION(DICT);\
+    }\
+}
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_tp_dict_version(PyObject *obj);
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_object_dict_version(PyObject *obj);
+static CYTHON_INLINE int __Pyx_object_dict_version_matches(PyObject* obj, PY_UINT64_T tp_dict_version, PY_UINT64_T obj_dict_version);
 #else
-#define __Pyx_PyObject_DelAttrStr(o,n)   PyObject_DelAttr(o,n)
-#define __Pyx_PyObject_SetAttrStr(o,n,v) PyObject_SetAttr(o,n,v)
+#define __PYX_GET_DICT_VERSION(dict)  (0)
+#define __PYX_UPDATE_DICT_CACHE(dict, value, cache_var, version_var)
+#define __PYX_PY_DICT_LOOKUP_IF_MODIFIED(VAR, DICT, LOOKUP)  (VAR) = (LOOKUP);
 #endif
 
 /* GetModuleGlobalName.proto */
 #if CYTHON_USE_DICT_VERSIONS
 #define __Pyx_GetModuleGlobalName(var, name)  {\
     static PY_UINT64_T __pyx_dict_version = 0;\
     static PyObject *__pyx_dict_cached_value = NULL;\
@@ -1045,15 +987,15 @@
 #endif
 
 /* PyFunctionFastCall.proto */
 #if CYTHON_FAST_PYCALL
 #define __Pyx_PyFunction_FastCall(func, args, nargs)\
     __Pyx_PyFunction_FastCallDict((func), (args), (nargs), NULL)
 #if 1 || PY_VERSION_HEX < 0x030600B1
-static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, int nargs, PyObject *kwargs);
+static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs);
 #else
 #define __Pyx_PyFunction_FastCallDict(func, args, nargs, kwargs) _PyFunction_FastCallDict(func, args, nargs, kwargs)
 #endif
 #define __Pyx_BUILD_ASSERT_EXPR(cond)\
     (sizeof(char [1 - 2*!(cond)]) - 1)
 #ifndef Py_MEMBER_SIZE
 #define Py_MEMBER_SIZE(type, member) sizeof(((type *)0)->member)
@@ -1199,50 +1141,75 @@
 #define __Pyx_ErrRestore(type, value, tb)  PyErr_Restore(type, value, tb)
 #define __Pyx_ErrFetch(type, value, tb)  PyErr_Fetch(type, value, tb)
 #endif
 
 /* RaiseException.proto */
 static void __Pyx_Raise(PyObject *type, PyObject *value, PyObject *tb, PyObject *cause);
 
-/* TypeImport.proto */
-#ifndef __PYX_HAVE_RT_ImportType_proto
-#define __PYX_HAVE_RT_ImportType_proto
-enum __Pyx_ImportType_CheckSize {
-   __Pyx_ImportType_CheckSize_Error = 0,
-   __Pyx_ImportType_CheckSize_Warn = 1,
-   __Pyx_ImportType_CheckSize_Ignore = 2
-};
-static PyTypeObject *__Pyx_ImportType(PyObject* module, const char *module_name, const char *class_name, size_t size, enum __Pyx_ImportType_CheckSize check_size);
+/* PyErrExceptionMatches.proto */
+#if CYTHON_FAST_THREAD_STATE
+#define __Pyx_PyErr_ExceptionMatches(err) __Pyx_PyErr_ExceptionMatchesInState(__pyx_tstate, err)
+static CYTHON_INLINE int __Pyx_PyErr_ExceptionMatchesInState(PyThreadState* tstate, PyObject* err);
+#else
+#define __Pyx_PyErr_ExceptionMatches(err)  PyErr_ExceptionMatches(err)
 #endif
 
+/* GetAttr.proto */
+static CYTHON_INLINE PyObject *__Pyx_GetAttr(PyObject *, PyObject *);
+
+/* GetAttr3.proto */
+static CYTHON_INLINE PyObject *__Pyx_GetAttr3(PyObject *, PyObject *, PyObject *);
+
 /* Import.proto */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level);
 
 /* ImportFrom.proto */
 static PyObject* __Pyx_ImportFrom(PyObject* module, PyObject* name);
 
-/* SetNameInClass.proto */
-#if CYTHON_COMPILING_IN_CPYTHON && PY_VERSION_HEX >= 0x030500A1
-#define __Pyx_SetNameInClass(ns, name, value)\
-    (likely(PyDict_CheckExact(ns)) ? _PyDict_SetItem_KnownHash(ns, name, value, ((PyASCIIObject *) name)->hash) : PyObject_SetItem(ns, name, value))
-#elif CYTHON_COMPILING_IN_CPYTHON
-#define __Pyx_SetNameInClass(ns, name, value)\
-    (likely(PyDict_CheckExact(ns)) ? PyDict_SetItem(ns, name, value) : PyObject_SetItem(ns, name, value))
-#else
-#define __Pyx_SetNameInClass(ns, name, value)  PyObject_SetItem(ns, name, value)
-#endif
-
-/* CalculateMetaclass.proto */
-static PyObject *__Pyx_CalculateMetaclass(PyTypeObject *metaclass, PyObject *bases);
-
-/* Py3ClassCreate.proto */
-static PyObject *__Pyx_Py3MetaclassPrepare(PyObject *metaclass, PyObject *bases, PyObject *name, PyObject *qualname,
-                                           PyObject *mkw, PyObject *modname, PyObject *doc);
-static PyObject *__Pyx_Py3ClassCreate(PyObject *metaclass, PyObject *name, PyObject *bases, PyObject *dict,
-                                      PyObject *mkw, int calculate_metaclass, int allow_py2_metaclass);
+/* GetItemInt.proto */
+#define __Pyx_GetItemInt(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
+    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
+    __Pyx_GetItemInt_Fast(o, (Py_ssize_t)i, is_list, wraparound, boundscheck) :\
+    (is_list ? (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL) :\
+               __Pyx_GetItemInt_Generic(o, to_py_func(i))))
+#define __Pyx_GetItemInt_List(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
+    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
+    __Pyx_GetItemInt_List_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
+    (PyErr_SetString(PyExc_IndexError, "list index out of range"), (PyObject*)NULL))
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
+                                                              int wraparound, int boundscheck);
+#define __Pyx_GetItemInt_Tuple(o, i, type, is_signed, to_py_func, is_list, wraparound, boundscheck)\
+    (__Pyx_fits_Py_ssize_t(i, type, is_signed) ?\
+    __Pyx_GetItemInt_Tuple_Fast(o, (Py_ssize_t)i, wraparound, boundscheck) :\
+    (PyErr_SetString(PyExc_IndexError, "tuple index out of range"), (PyObject*)NULL))
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
+                                                              int wraparound, int boundscheck);
+static PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j);
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i,
+                                                     int is_list, int wraparound, int boundscheck);
+
+/* HasAttr.proto */
+static CYTHON_INLINE int __Pyx_HasAttr(PyObject *, PyObject *);
+
+/* PyObject_GenericGetAttrNoDict.proto */
+#if CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP && PY_VERSION_HEX < 0x03070000
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GenericGetAttrNoDict(PyObject* obj, PyObject* attr_name);
+#else
+#define __Pyx_PyObject_GenericGetAttrNoDict PyObject_GenericGetAttr
+#endif
+
+/* PyObject_GenericGetAttr.proto */
+#if CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP && PY_VERSION_HEX < 0x03070000
+static PyObject* __Pyx_PyObject_GenericGetAttr(PyObject* obj, PyObject* attr_name);
+#else
+#define __Pyx_PyObject_GenericGetAttr PyObject_GenericGetAttr
+#endif
+
+/* SetupReduce.proto */
+static int __Pyx_setup_reduce(PyObject* type_obj);
 
 /* CLineInTraceback.proto */
 #ifdef CYTHON_CLINE_IN_TRACEBACK
 #define __Pyx_CLineForTraceback(tstate, c_line)  (((CYTHON_CLINE_IN_TRACEBACK)) ? c_line : 0)
 #else
 static int __Pyx_CLineForTraceback(PyThreadState *tstate, int c_line);
 #endif
@@ -1262,82 +1229,25 @@
 static PyCodeObject *__pyx_find_code_object(int code_line);
 static void __pyx_insert_code_object(int code_line, PyCodeObject* code_object);
 
 /* AddTraceback.proto */
 static void __Pyx_AddTraceback(const char *funcname, int c_line,
                                int py_line, const char *filename);
 
-/* RealImag.proto */
-#if CYTHON_CCOMPLEX
-  #ifdef __cplusplus
-    #define __Pyx_CREAL(z) ((z).real())
-    #define __Pyx_CIMAG(z) ((z).imag())
-  #else
-    #define __Pyx_CREAL(z) (__real__(z))
-    #define __Pyx_CIMAG(z) (__imag__(z))
-  #endif
-#else
-    #define __Pyx_CREAL(z) ((z).real)
-    #define __Pyx_CIMAG(z) ((z).imag)
-#endif
-#if defined(__cplusplus) && CYTHON_CCOMPLEX\
-        && (defined(_WIN32) || defined(__clang__) || (defined(__GNUC__) && (__GNUC__ >= 5 || __GNUC__ == 4 && __GNUC_MINOR__ >= 4 )) || __cplusplus >= 201103)
-    #define __Pyx_SET_CREAL(z,x) ((z).real(x))
-    #define __Pyx_SET_CIMAG(z,y) ((z).imag(y))
-#else
-    #define __Pyx_SET_CREAL(z,x) __Pyx_CREAL(z) = (x)
-    #define __Pyx_SET_CIMAG(z,y) __Pyx_CIMAG(z) = (y)
-#endif
-
-/* Arithmetic.proto */
-#if CYTHON_CCOMPLEX
-    #define __Pyx_c_eq_double(a, b)   ((a)==(b))
-    #define __Pyx_c_sum_double(a, b)  ((a)+(b))
-    #define __Pyx_c_diff_double(a, b) ((a)-(b))
-    #define __Pyx_c_prod_double(a, b) ((a)*(b))
-    #define __Pyx_c_quot_double(a, b) ((a)/(b))
-    #define __Pyx_c_neg_double(a)     (-(a))
-  #ifdef __cplusplus
-    #define __Pyx_c_is_zero_double(z) ((z)==(double)0)
-    #define __Pyx_c_conj_double(z)    (::std::conj(z))
-    #if 1
-        #define __Pyx_c_abs_double(z)     (::std::abs(z))
-        #define __Pyx_c_pow_double(a, b)  (::std::pow(a, b))
-    #endif
-  #else
-    #define __Pyx_c_is_zero_double(z) ((z)==0)
-    #define __Pyx_c_conj_double(z)    (conj(z))
-    #if 1
-        #define __Pyx_c_abs_double(z)     (cabs(z))
-        #define __Pyx_c_pow_double(a, b)  (cpow(a, b))
-    #endif
- #endif
-#else
-    static CYTHON_INLINE int __Pyx_c_eq_double(__pyx_t_double_complex, __pyx_t_double_complex);
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_sum_double(__pyx_t_double_complex, __pyx_t_double_complex);
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_diff_double(__pyx_t_double_complex, __pyx_t_double_complex);
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_prod_double(__pyx_t_double_complex, __pyx_t_double_complex);
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_quot_double(__pyx_t_double_complex, __pyx_t_double_complex);
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_neg_double(__pyx_t_double_complex);
-    static CYTHON_INLINE int __Pyx_c_is_zero_double(__pyx_t_double_complex);
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_conj_double(__pyx_t_double_complex);
-    #if 1
-        static CYTHON_INLINE double __Pyx_c_abs_double(__pyx_t_double_complex);
-        static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_pow_double(__pyx_t_double_complex, __pyx_t_double_complex);
-    #endif
-#endif
+/* CIntToPy.proto */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value);
 
 /* CIntToPy.proto */
 static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value);
 
 /* CIntFromPy.proto */
-static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *);
+static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *);
 
 /* CIntFromPy.proto */
-static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *);
+static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *);
 
 /* FastTypeChecks.proto */
 #if CYTHON_COMPILING_IN_CPYTHON
 #define __Pyx_TypeCheck(obj, type) __Pyx_IsSubtype(Py_TYPE(obj), (PyTypeObject *)type)
 static CYTHON_INLINE int __Pyx_IsSubtype(PyTypeObject *a, PyTypeObject *b);
 static CYTHON_INLINE int __Pyx_PyErr_GivenExceptionMatches(PyObject *err, PyObject *type);
 static CYTHON_INLINE int __Pyx_PyErr_GivenExceptionMatches2(PyObject *err, PyObject *type1, PyObject *type2);
@@ -1351,706 +1261,617 @@
 /* CheckBinaryVersion.proto */
 static int __Pyx_check_binary_version(void);
 
 /* InitStrings.proto */
 static int __Pyx_InitStrings(__Pyx_StringTabEntry *t);
 
 
-/* Module declarations from 'tkwant.onebody' */
-
-/* Module declarations from 'tkwant.onebody.kernels' */
-static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels_Kernel = 0;
-static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7kernels_CKernel = 0;
-
 /* Module declarations from 'tkwant.onebody.solvers' */
+static PyTypeObject *__pyx_ptype_6tkwant_7onebody_7solvers_Scipy = 0;
+static PyObject *__pyx_f_6tkwant_7onebody_7solvers___pyx_unpickle_Scipy__set_state(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *, PyObject *); /*proto*/
 #define __Pyx_MODULE_NAME "tkwant.onebody.solvers"
 extern int __pyx_module_is_main_tkwant__onebody__solvers;
 int __pyx_module_is_main_tkwant__onebody__solvers = 0;
 
 /* Implementation of 'tkwant.onebody.solvers' */
 static PyObject *__pyx_builtin_RuntimeError;
-static const char __pyx_k_[] = "";
 static const char __pyx_k_t[] = "t";
 static const char __pyx_k_y[] = "y";
 static const char __pyx_k_np[] = "np";
 static const char __pyx_k_all[] = "__all__";
-static const char __pyx_k_doc[] = "__doc__";
+static const char __pyx_k_new[] = "__new__";
 static const char __pyx_k_ode[] = "_ode";
 static const char __pyx_k_psi[] = "psi";
 static const char __pyx_k_rhs[] = "rhs";
 static const char __pyx_k_run[] = "run";
 static const char __pyx_k_atol[] = "atol";
-static const char __pyx_k_call[] = "__call__";
-static const char __pyx_k_init[] = "__init__";
+static const char __pyx_k_dict[] = "__dict__";
 static const char __pyx_k_main[] = "__main__";
 static const char __pyx_k_name[] = "__name__";
 static const char __pyx_k_rtol[] = "rtol";
-static const char __pyx_k_self[] = "self";
 static const char __pyx_k_size[] = "size";
 static const char __pyx_k_test[] = "__test__";
 static const char __pyx_k_time[] = "time";
 static const char __pyx_k_view[] = "view";
 static const char __pyx_k_Scipy[] = "Scipy";
 static const char __pyx_k_dtype[] = "dtype";
 static const char __pyx_k_empty[] = "empty";
 static const char __pyx_k_numpy[] = "numpy";
 static const char __pyx_k_reset[] = "reset";
 static const char __pyx_k_rhs_2[] = "_rhs";
 static const char __pyx_k_scipy[] = "scipy";
 static const char __pyx_k_dopri5[] = "dopri5";
 static const char __pyx_k_format[] = "format";
 static const char __pyx_k_import[] = "__import__";
-static const char __pyx_k_kernel[] = "kernel";
-static const char __pyx_k_module[] = "__module__";
 static const char __pyx_k_nsteps[] = "nsteps";
+static const char __pyx_k_pickle[] = "pickle";
+static const char __pyx_k_reduce[] = "__reduce__";
 static const char __pyx_k_update[] = "update";
 static const char __pyx_k_default[] = "default";
 static const char __pyx_k_has_jac[] = "has_jac";
-static const char __pyx_k_kernels[] = "kernels";
-static const char __pyx_k_options[] = "options";
-static const char __pyx_k_prepare[] = "__prepare__";
-static const char __pyx_k_rhs_out[] = "_rhs_out";
 static const char __pyx_k_success[] = "success";
-static const char __pyx_k_next_psi[] = "next_psi";
-static const char __pyx_k_qualname[] = "__qualname__";
+static const char __pyx_k_getstate[] = "__getstate__";
+static const char __pyx_k_pyx_type[] = "__pyx_type";
+static const char __pyx_k_setstate[] = "__setstate__";
 static const char __pyx_k_integrate[] = "integrate";
-static const char __pyx_k_metaclass[] = "__metaclass__";
 static const char __pyx_k_next_time[] = "next_time";
-static const char __pyx_k_Scipy__rhs[] = "Scipy._rhs";
-static const char __pyx_k_final_time[] = "final_time";
+static const char __pyx_k_pyx_state[] = "__pyx_state";
+static const char __pyx_k_reduce_ex[] = "__reduce_ex__";
 static const char __pyx_k_integrator[] = "integrator";
+static const char __pyx_k_pyx_result[] = "__pyx_result";
+static const char __pyx_k_PickleError[] = "PickleError";
 static const char __pyx_k_RuntimeError[] = "RuntimeError";
-static const char __pyx_k_Scipy___call[] = "Scipy.__call__";
-static const char __pyx_k_Scipy___init[] = "Scipy.__init__";
-static const char __pyx_k_integrator_2[] = "_integrator";
+static const char __pyx_k_pyx_checksum[] = "__pyx_checksum";
+static const char __pyx_k_stringsource[] = "stringsource";
+static const char __pyx_k_reduce_cython[] = "__reduce_cython__";
 static const char __pyx_k_default_options[] = "_default_options";
+static const char __pyx_k_pyx_PickleError[] = "__pyx_PickleError";
 static const char __pyx_k_scipy_integrate[] = "scipy.integrate";
+static const char __pyx_k_setstate_cython[] = "__setstate_cython__";
 static const char __pyx_k_cline_in_traceback[] = "cline_in_traceback";
-static const char __pyx_k_integrator_options[] = "integrator_options";
+static const char __pyx_k_pyx_unpickle_Scipy[] = "__pyx_unpickle_Scipy";
+static const char __pyx_k_call___locals_lambda[] = "__call__.<locals>.<lambda>";
 static const char __pyx_k_tkwant_onebody_solvers[] = "tkwant.onebody.solvers";
-static const char __pyx_k_tkwant_onebody_solvers_pyx[] = "tkwant/onebody/solvers.pyx";
-static const char __pyx_k_Scipy___call___locals_lambda[] = "Scipy.__call__.<locals>.<lambda>";
 static const char __pyx_k_Integration_failed_between_and[] = "Integration failed between {} and {}";
 static const char __pyx_k_Classes_for_solving_the_time_dep[] = "Classes for solving the time-dependent Schr\303\266dinger equation.";
-static const char __pyx_k_Solve_the_time_dependent_Schrdin[] = "Solve the time-dependent Schr\303\266dinger equation using `scipy.integrate`.\n\n    This solver will currently only work with the 'dopri5' and 'dop853'\n    integrators, as these are the only re-entrant ones.\n\n    Parameters\n    ----------\n    kernel : `tkwant.onebody.kernels.Kernel`\n    integrator : `scipy.integrate._ode.IntegratorBase`, default: dopri5\n        The integrator to use with this solver.\n    **integrator_options\n        Options to pass when instantiating the integrator.\n\n    See Also\n    --------\n    scipy.integrate.ode\n    ";
-static PyObject *__pyx_n_s_;
+static const char __pyx_k_Incompatible_checksums_s_vs_0xdb[] = "Incompatible checksums (%s vs 0xdb28404 = (_integrator, _rhs_out, rhs, size))";
+static PyObject *__pyx_kp_s_Incompatible_checksums_s_vs_0xdb;
 static PyObject *__pyx_kp_u_Integration_failed_between_and;
+static PyObject *__pyx_n_s_PickleError;
 static PyObject *__pyx_n_s_RuntimeError;
 static PyObject *__pyx_n_s_Scipy;
 static PyObject *__pyx_n_u_Scipy;
-static PyObject *__pyx_n_s_Scipy___call;
-static PyObject *__pyx_n_s_Scipy___call___locals_lambda;
-static PyObject *__pyx_n_s_Scipy___init;
-static PyObject *__pyx_n_s_Scipy__rhs;
-static PyObject *__pyx_kp_s_Solve_the_time_dependent_Schrdin;
 static PyObject *__pyx_n_s_all;
 static PyObject *__pyx_n_u_atol;
-static PyObject *__pyx_n_s_call;
+static PyObject *__pyx_n_s_call___locals_lambda;
 static PyObject *__pyx_n_s_cline_in_traceback;
 static PyObject *__pyx_n_s_default;
 static PyObject *__pyx_n_s_default_options;
-static PyObject *__pyx_n_s_doc;
+static PyObject *__pyx_n_s_dict;
 static PyObject *__pyx_n_s_dopri5;
 static PyObject *__pyx_n_s_dtype;
 static PyObject *__pyx_n_s_empty;
-static PyObject *__pyx_n_s_final_time;
 static PyObject *__pyx_n_s_format;
+static PyObject *__pyx_n_s_getstate;
 static PyObject *__pyx_n_s_has_jac;
 static PyObject *__pyx_n_s_import;
-static PyObject *__pyx_n_s_init;
 static PyObject *__pyx_n_s_integrate;
 static PyObject *__pyx_n_s_integrator;
-static PyObject *__pyx_n_s_integrator_2;
-static PyObject *__pyx_n_s_integrator_options;
-static PyObject *__pyx_n_s_kernel;
-static PyObject *__pyx_n_s_kernels;
 static PyObject *__pyx_n_s_main;
-static PyObject *__pyx_n_s_metaclass;
-static PyObject *__pyx_n_s_module;
 static PyObject *__pyx_n_s_name;
-static PyObject *__pyx_n_s_next_psi;
+static PyObject *__pyx_n_s_new;
 static PyObject *__pyx_n_s_next_time;
 static PyObject *__pyx_n_s_np;
 static PyObject *__pyx_n_u_nsteps;
 static PyObject *__pyx_n_s_numpy;
 static PyObject *__pyx_n_s_ode;
-static PyObject *__pyx_n_s_options;
-static PyObject *__pyx_n_s_prepare;
+static PyObject *__pyx_n_s_pickle;
 static PyObject *__pyx_n_s_psi;
-static PyObject *__pyx_n_s_qualname;
+static PyObject *__pyx_n_s_pyx_PickleError;
+static PyObject *__pyx_n_s_pyx_checksum;
+static PyObject *__pyx_n_s_pyx_result;
+static PyObject *__pyx_n_s_pyx_state;
+static PyObject *__pyx_n_s_pyx_type;
+static PyObject *__pyx_n_s_pyx_unpickle_Scipy;
+static PyObject *__pyx_n_s_reduce;
+static PyObject *__pyx_n_s_reduce_cython;
+static PyObject *__pyx_n_s_reduce_ex;
 static PyObject *__pyx_n_s_reset;
 static PyObject *__pyx_n_s_rhs;
 static PyObject *__pyx_n_s_rhs_2;
-static PyObject *__pyx_n_s_rhs_out;
 static PyObject *__pyx_n_u_rtol;
 static PyObject *__pyx_n_s_run;
 static PyObject *__pyx_n_s_scipy;
 static PyObject *__pyx_n_s_scipy_integrate;
-static PyObject *__pyx_n_s_self;
+static PyObject *__pyx_n_s_setstate;
+static PyObject *__pyx_n_s_setstate_cython;
 static PyObject *__pyx_n_s_size;
+static PyObject *__pyx_kp_s_stringsource;
 static PyObject *__pyx_n_s_success;
 static PyObject *__pyx_n_s_t;
 static PyObject *__pyx_n_s_test;
 static PyObject *__pyx_n_s_time;
 static PyObject *__pyx_n_s_tkwant_onebody_solvers;
-static PyObject *__pyx_kp_s_tkwant_onebody_solvers_pyx;
 static PyObject *__pyx_n_s_update;
 static PyObject *__pyx_n_s_view;
 static PyObject *__pyx_n_s_y;
-static PyObject *__pyx_pf_6tkwant_7onebody_7solvers___defaults__(CYTHON_UNUSED PyObject *__pyx_self); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy___init__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_kernel, PyObject *__pyx_v_integrator, PyObject *__pyx_v_integrator_options); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_2_rhs(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_t, PyObject *__pyx_v_y); /* proto */
+static int __pyx_pf_6tkwant_7onebody_7solvers_5Scipy___init__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self, PyObject *__pyx_v_size, PyObject *__pyx_v_integrator, PyObject *__pyx_v_integrator_options); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_2_rhs(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self, PyObject *__pyx_v_t, PyObject *__pyx_v_y); /* proto */
 static PyObject *__pyx_lambda_funcdef_lambda(CYTHON_UNUSED PyObject *__pyx_self); /* proto */
-static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_4__call__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_psi, PyObject *__pyx_v_time, PyObject *__pyx_v_next_time); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_4__call__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self, PyObject *__pyx_v_psi, PyObject *__pyx_v_time, PyObject *__pyx_v_next_time, PyObject *__pyx_v_rhs); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_4size___get__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_6__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_8__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self, PyObject *__pyx_v___pyx_state); /* proto */
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers___pyx_unpickle_Scipy(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state); /* proto */
+static PyObject *__pyx_tp_new_6tkwant_7onebody_7solvers_Scipy(PyTypeObject *t, PyObject *a, PyObject *k); /*proto*/
 static __Pyx_CachedCFunction __pyx_umethod_PyDict_Type_update = {0, &__pyx_n_s_update, 0, 0, 0};
 static PyObject *__pyx_float_1E9;
 static PyObject *__pyx_float_1Eneg_9;
 static PyObject *__pyx_int_2;
+static PyObject *__pyx_int_229803012;
+static PyObject *__pyx_k_;
 static PyObject *__pyx_tuple__2;
-static PyObject *__pyx_tuple__4;
-static PyObject *__pyx_tuple__6;
 static PyObject *__pyx_codeobj__3;
-static PyObject *__pyx_codeobj__5;
-static PyObject *__pyx_codeobj__7;
 /* Late includes */
 
-/* "tkwant/onebody/solvers.pyx":43
+/* "tkwant/onebody/solvers.pyx":48
  *     _default_options = {'atol': 1E-9, 'rtol': 1E-9, 'nsteps': int(1E9)}
  * 
- *     def __init__(self, kernel, integrator=scipy.integrate._ode.dopri5, **integrator_options):             # <<<<<<<<<<<<<<
- *         self.kernel = kernel
+ *     def __init__(self, size, integrator=scipy.integrate._ode.dopri5, **integrator_options):             # <<<<<<<<<<<<<<
  *         # allocate storage for kernel output
+ *         self._rhs_out = np.empty((size,), dtype=complex)
  */
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7solvers___defaults__(CYTHON_UNUSED PyObject *__pyx_self) {
-  PyObject *__pyx_r = NULL;
-  __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
-  PyObject *__pyx_t_2 = NULL;
-  __Pyx_RefNannySetupContext("__defaults__", 0);
-  __Pyx_XDECREF(__pyx_r);
-  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 43, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_INCREF(__Pyx_CyFunction_Defaults(__pyx_defaults, __pyx_self)->__pyx_arg_integrator);
-  __Pyx_GIVEREF(__Pyx_CyFunction_Defaults(__pyx_defaults, __pyx_self)->__pyx_arg_integrator);
-  PyTuple_SET_ITEM(__pyx_t_1, 0, __Pyx_CyFunction_Defaults(__pyx_defaults, __pyx_self)->__pyx_arg_integrator);
-  __pyx_t_2 = PyTuple_New(2); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 43, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_GIVEREF(__pyx_t_1);
-  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_t_1);
-  __Pyx_INCREF(Py_None);
-  __Pyx_GIVEREF(Py_None);
-  PyTuple_SET_ITEM(__pyx_t_2, 1, Py_None);
-  __pyx_t_1 = 0;
-  __pyx_r = __pyx_t_2;
-  __pyx_t_2 = 0;
-  goto __pyx_L0;
-
-  /* function exit code */
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_AddTraceback("tkwant.onebody.solvers.__defaults__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
-  __pyx_L0:;
-  __Pyx_XGIVEREF(__pyx_r);
-  __Pyx_RefNannyFinishContext();
-  return __pyx_r;
-}
-
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_1__init__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static PyMethodDef __pyx_mdef_6tkwant_7onebody_7solvers_5Scipy_1__init__ = {"__init__", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_1__init__, METH_VARARGS|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_1__init__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  PyObject *__pyx_v_self = 0;
-  PyObject *__pyx_v_kernel = 0;
+static int __pyx_pw_6tkwant_7onebody_7solvers_5Scipy_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static int __pyx_pw_6tkwant_7onebody_7solvers_5Scipy_1__init__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  PyObject *__pyx_v_size = 0;
   PyObject *__pyx_v_integrator = 0;
   PyObject *__pyx_v_integrator_options = 0;
-  PyObject *__pyx_r = 0;
+  int __pyx_r;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__init__ (wrapper)", 0);
-  __pyx_v_integrator_options = PyDict_New(); if (unlikely(!__pyx_v_integrator_options)) return NULL;
+  __pyx_v_integrator_options = PyDict_New(); if (unlikely(!__pyx_v_integrator_options)) return -1;
   __Pyx_GOTREF(__pyx_v_integrator_options);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_kernel,&__pyx_n_s_integrator,0};
-    PyObject* values[3] = {0,0,0};
-    __pyx_defaults *__pyx_dynamic_args = __Pyx_CyFunction_Defaults(__pyx_defaults, __pyx_self);
-    values[2] = __pyx_dynamic_args->__pyx_arg_integrator;
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_size,&__pyx_n_s_integrator,0};
+    PyObject* values[2] = {0,0};
+    values[1] = __pyx_k_;
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
-        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
-        CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_size)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
-        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_kernel)) != 0)) kw_args--;
-        else {
-          __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 3, 1); __PYX_ERR(0, 43, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  2:
         if (kw_args > 0) {
           PyObject* value = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_integrator);
-          if (value) { values[2] = value; kw_args--; }
+          if (value) { values[1] = value; kw_args--; }
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, __pyx_v_integrator_options, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 43, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, __pyx_v_integrator_options, values, pos_args, "__init__") < 0)) __PYX_ERR(0, 48, __pyx_L3_error)
       }
     } else {
       switch (PyTuple_GET_SIZE(__pyx_args)) {
-        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
-        CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
-        values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         break;
         default: goto __pyx_L5_argtuple_error;
       }
     }
-    __pyx_v_self = values[0];
-    __pyx_v_kernel = values[1];
-    __pyx_v_integrator = values[2];
+    __pyx_v_size = values[0];
+    __pyx_v_integrator = values[1];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__init__", 0, 2, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 43, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__init__", 0, 1, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 48, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_DECREF(__pyx_v_integrator_options); __pyx_v_integrator_options = 0;
   __Pyx_AddTraceback("tkwant.onebody.solvers.Scipy.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
-  return NULL;
+  return -1;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers_5Scipy___init__(__pyx_self, __pyx_v_self, __pyx_v_kernel, __pyx_v_integrator, __pyx_v_integrator_options);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers_5Scipy___init__(((struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)__pyx_v_self), __pyx_v_size, __pyx_v_integrator, __pyx_v_integrator_options);
 
   /* function exit code */
   __Pyx_XDECREF(__pyx_v_integrator_options);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy___init__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_kernel, PyObject *__pyx_v_integrator, PyObject *__pyx_v_integrator_options) {
+static int __pyx_pf_6tkwant_7onebody_7solvers_5Scipy___init__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self, PyObject *__pyx_v_size, PyObject *__pyx_v_integrator, PyObject *__pyx_v_integrator_options) {
   PyObject *__pyx_v_options = NULL;
-  PyObject *__pyx_r = NULL;
+  int __pyx_r;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
+  int __pyx_t_5;
   __Pyx_RefNannySetupContext("__init__", 0);
 
-  /* "tkwant/onebody/solvers.pyx":44
- * 
- *     def __init__(self, kernel, integrator=scipy.integrate._ode.dopri5, **integrator_options):
- *         self.kernel = kernel             # <<<<<<<<<<<<<<
- *         # allocate storage for kernel output
- *         self._rhs_out = np.empty((kernel.size,), dtype=complex)
- */
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_kernel, __pyx_v_kernel) < 0) __PYX_ERR(0, 44, __pyx_L1_error)
-
-  /* "tkwant/onebody/solvers.pyx":46
- *         self.kernel = kernel
+  /* "tkwant/onebody/solvers.pyx":50
+ *     def __init__(self, size, integrator=scipy.integrate._ode.dopri5, **integrator_options):
  *         # allocate storage for kernel output
- *         self._rhs_out = np.empty((kernel.size,), dtype=complex)             # <<<<<<<<<<<<<<
- * 
+ *         self._rhs_out = np.empty((size,), dtype=complex)             # <<<<<<<<<<<<<<
  *         options = dict(self._default_options)
+ *         options.update(integrator_options)
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_np); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 50, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_empty); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 50, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_kernel, __pyx_n_s_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 50, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_INCREF(__pyx_v_size);
+  __Pyx_GIVEREF(__pyx_v_size);
+  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_v_size);
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 50, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
   __Pyx_GIVEREF(__pyx_t_1);
   PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_1);
   __pyx_t_1 = 0;
-  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 50, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_3);
-  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_3);
-  __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 46, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 46, __pyx_L1_error)
-  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 46, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_s_dtype, ((PyObject *)(&PyComplex_Type))) < 0) __PYX_ERR(0, 50, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_Call(__pyx_t_2, __pyx_t_3, __pyx_t_1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 50, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_rhs_out, __pyx_t_4) < 0) __PYX_ERR(0, 46, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __Pyx_GIVEREF(__pyx_t_4);
+  __Pyx_GOTREF(__pyx_v_self->_rhs_out);
+  __Pyx_DECREF(__pyx_v_self->_rhs_out);
+  __pyx_v_self->_rhs_out = __pyx_t_4;
+  __pyx_t_4 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":48
- *         self._rhs_out = np.empty((kernel.size,), dtype=complex)
- * 
+  /* "tkwant/onebody/solvers.pyx":51
+ *         # allocate storage for kernel output
+ *         self._rhs_out = np.empty((size,), dtype=complex)
  *         options = dict(self._default_options)             # <<<<<<<<<<<<<<
  *         options.update(integrator_options)
  *         self._integrator = integrator(**options)
  */
-  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_default_options); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 48, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_default_options); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 51, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_3 = __Pyx_PyObject_CallOneArg(((PyObject *)(&PyDict_Type)), __pyx_t_4); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 48, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
+  __pyx_t_1 = __Pyx_PyObject_CallOneArg(((PyObject *)(&PyDict_Type)), __pyx_t_4); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 51, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
   __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  __pyx_v_options = ((PyObject*)__pyx_t_3);
-  __pyx_t_3 = 0;
+  __pyx_v_options = ((PyObject*)__pyx_t_1);
+  __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":49
- * 
+  /* "tkwant/onebody/solvers.pyx":52
+ *         self._rhs_out = np.empty((size,), dtype=complex)
  *         options = dict(self._default_options)
  *         options.update(integrator_options)             # <<<<<<<<<<<<<<
  *         self._integrator = integrator(**options)
  *         # Factor 2 because Scipy integrators expect real arrays
  */
-  __pyx_t_3 = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PyDict_Type_update, __pyx_v_options, __pyx_v_integrator_options); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 49, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_1 = __Pyx_CallUnboundCMethod1(&__pyx_umethod_PyDict_Type_update, __pyx_v_options, __pyx_v_integrator_options); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 52, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":50
+  /* "tkwant/onebody/solvers.pyx":53
  *         options = dict(self._default_options)
  *         options.update(integrator_options)
  *         self._integrator = integrator(**options)             # <<<<<<<<<<<<<<
  *         # Factor 2 because Scipy integrators expect real arrays
- *         self._integrator.reset(2 * self.kernel.size, has_jac=False)
+ *         self._integrator.reset(2 * size, has_jac=False)
  */
-  __pyx_t_3 = __Pyx_PyObject_Call(__pyx_v_integrator, __pyx_empty_tuple, __pyx_v_options); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 50, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  if (__Pyx_PyObject_SetAttrStr(__pyx_v_self, __pyx_n_s_integrator_2, __pyx_t_3) < 0) __PYX_ERR(0, 50, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __pyx_t_1 = __Pyx_PyObject_Call(__pyx_v_integrator, __pyx_empty_tuple, __pyx_v_options); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 53, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v_self->_integrator);
+  __Pyx_DECREF(__pyx_v_self->_integrator);
+  __pyx_v_self->_integrator = __pyx_t_1;
+  __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":52
+  /* "tkwant/onebody/solvers.pyx":55
  *         self._integrator = integrator(**options)
  *         # Factor 2 because Scipy integrators expect real arrays
- *         self._integrator.reset(2 * self.kernel.size, has_jac=False)             # <<<<<<<<<<<<<<
+ *         self._integrator.reset(2 * size, has_jac=False)             # <<<<<<<<<<<<<<
+ *         self.size = size
  * 
- *     def _rhs(self, t, y):
  */
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_integrator_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 52, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_reset); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 52, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_kernel); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 52, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 52, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->_integrator, __pyx_n_s_reset); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = PyNumber_Multiply(__pyx_int_2, __pyx_t_1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 52, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = PyTuple_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 52, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_GIVEREF(__pyx_t_3);
-  PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_3);
-  __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 52, __pyx_L1_error)
+  __pyx_t_4 = PyNumber_Multiply(__pyx_int_2, __pyx_v_size); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 55, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_3 = PyTuple_New(1); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  if (PyDict_SetItem(__pyx_t_3, __pyx_n_s_has_jac, Py_False) < 0) __PYX_ERR(0, 52, __pyx_L1_error)
-  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_1, __pyx_t_3); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 52, __pyx_L1_error)
+  __Pyx_GIVEREF(__pyx_t_4);
+  PyTuple_SET_ITEM(__pyx_t_3, 0, __pyx_t_4);
+  __pyx_t_4 = 0;
+  __pyx_t_4 = __Pyx_PyDict_NewPresized(1); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 55, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  if (PyDict_SetItem(__pyx_t_4, __pyx_n_s_has_jac, Py_False) < 0) __PYX_ERR(0, 55, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_3, __pyx_t_4); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 55, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":43
+  /* "tkwant/onebody/solvers.pyx":56
+ *         # Factor 2 because Scipy integrators expect real arrays
+ *         self._integrator.reset(2 * size, has_jac=False)
+ *         self.size = size             # <<<<<<<<<<<<<<
+ * 
+ *     def _rhs(self, t, y):
+ */
+  __pyx_t_5 = __Pyx_PyInt_As_int(__pyx_v_size); if (unlikely((__pyx_t_5 == (int)-1) && PyErr_Occurred())) __PYX_ERR(0, 56, __pyx_L1_error)
+  __pyx_v_self->size = __pyx_t_5;
+
+  /* "tkwant/onebody/solvers.pyx":48
  *     _default_options = {'atol': 1E-9, 'rtol': 1E-9, 'nsteps': int(1E9)}
  * 
- *     def __init__(self, kernel, integrator=scipy.integrate._ode.dopri5, **integrator_options):             # <<<<<<<<<<<<<<
- *         self.kernel = kernel
+ *     def __init__(self, size, integrator=scipy.integrate._ode.dopri5, **integrator_options):             # <<<<<<<<<<<<<<
  *         # allocate storage for kernel output
+ *         self._rhs_out = np.empty((size,), dtype=complex)
  */
 
   /* function exit code */
-  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  __pyx_r = 0;
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_4);
   __Pyx_AddTraceback("tkwant.onebody.solvers.Scipy.__init__", __pyx_clineno, __pyx_lineno, __pyx_filename);
-  __pyx_r = NULL;
+  __pyx_r = -1;
   __pyx_L0:;
   __Pyx_XDECREF(__pyx_v_options);
-  __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/solvers.pyx":54
- *         self._integrator.reset(2 * self.kernel.size, has_jac=False)
+/* "tkwant/onebody/solvers.pyx":58
+ *         self.size = size
  * 
  *     def _rhs(self, t, y):             # <<<<<<<<<<<<<<
  *         # Kernel expects complex, Scipy expects real
- *         self.kernel.rhs(y.view(complex), self._rhs_out, t)
+ *         self.rhs(y.view(complex), self._rhs_out, t)
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_3_rhs(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static PyMethodDef __pyx_mdef_6tkwant_7onebody_7solvers_5Scipy_3_rhs = {"_rhs", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_3_rhs, METH_VARARGS|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_3_rhs(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  PyObject *__pyx_v_self = 0;
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_3_rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_3_rhs(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_t = 0;
   PyObject *__pyx_v_y = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("_rhs (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_t,&__pyx_n_s_y,0};
-    PyObject* values[3] = {0,0,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_t,&__pyx_n_s_y,0};
+    PyObject* values[2] = {0,0};
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
-        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
-        CYTHON_FALLTHROUGH;
         case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
         CYTHON_FALLTHROUGH;
         case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_t)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
-        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_t)) != 0)) kw_args--;
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_y)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("_rhs", 1, 3, 3, 1); __PYX_ERR(0, 54, __pyx_L3_error)
-        }
-        CYTHON_FALLTHROUGH;
-        case  2:
-        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_y)) != 0)) kw_args--;
-        else {
-          __Pyx_RaiseArgtupleInvalid("_rhs", 1, 3, 3, 2); __PYX_ERR(0, 54, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("_rhs", 1, 2, 2, 1); __PYX_ERR(0, 58, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "_rhs") < 0)) __PYX_ERR(0, 54, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "_rhs") < 0)) __PYX_ERR(0, 58, __pyx_L3_error)
       }
-    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 2) {
       goto __pyx_L5_argtuple_error;
     } else {
       values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
       values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
-      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
     }
-    __pyx_v_self = values[0];
-    __pyx_v_t = values[1];
-    __pyx_v_y = values[2];
+    __pyx_v_t = values[0];
+    __pyx_v_y = values[1];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("_rhs", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 54, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("_rhs", 1, 2, 2, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 58, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.solvers.Scipy._rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers_5Scipy_2_rhs(__pyx_self, __pyx_v_self, __pyx_v_t, __pyx_v_y);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers_5Scipy_2_rhs(((struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)__pyx_v_self), __pyx_v_t, __pyx_v_y);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_2_rhs(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_t, PyObject *__pyx_v_y) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_2_rhs(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self, PyObject *__pyx_v_t, PyObject *__pyx_v_y) {
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
-  PyObject *__pyx_t_5 = NULL;
-  int __pyx_t_6;
-  PyObject *__pyx_t_7 = NULL;
+  int __pyx_t_5;
+  PyObject *__pyx_t_6 = NULL;
   __Pyx_RefNannySetupContext("_rhs", 0);
 
-  /* "tkwant/onebody/solvers.pyx":56
+  /* "tkwant/onebody/solvers.pyx":60
  *     def _rhs(self, t, y):
  *         # Kernel expects complex, Scipy expects real
- *         self.kernel.rhs(y.view(complex), self._rhs_out, t)             # <<<<<<<<<<<<<<
+ *         self.rhs(y.view(complex), self._rhs_out, t)             # <<<<<<<<<<<<<<
  *         return self._rhs_out.view(float)
  * 
  */
-  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_kernel); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 56, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_rhs); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 56, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_y, __pyx_n_s_view); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 60, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_y, __pyx_n_s_view); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 56, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_5 = NULL;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_4);
-    if (likely(__pyx_t_5)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
-      __Pyx_INCREF(__pyx_t_5);
+  __pyx_t_4 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_4)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_4);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_4, function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
     }
   }
-  __pyx_t_2 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_4, __pyx_t_5, ((PyObject *)(&PyComplex_Type))) : __Pyx_PyObject_CallOneArg(__pyx_t_4, ((PyObject *)(&PyComplex_Type)));
-  __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
-  if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 56, __pyx_L1_error)
+  __pyx_t_2 = (__pyx_t_4) ? __Pyx_PyObject_Call2Args(__pyx_t_3, __pyx_t_4, ((PyObject *)(&PyComplex_Type))) : __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)(&PyComplex_Type)));
+  __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 60, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_rhs_out); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 56, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __pyx_t_5 = NULL;
-  __pyx_t_6 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+  __Pyx_INCREF(__pyx_v_self->rhs);
+  __pyx_t_3 = __pyx_v_self->rhs; __pyx_t_4 = NULL;
+  __pyx_t_5 = 0;
   if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
-    __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_3);
-    if (likely(__pyx_t_5)) {
+    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_4)) {
       PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
-      __Pyx_INCREF(__pyx_t_5);
+      __Pyx_INCREF(__pyx_t_4);
       __Pyx_INCREF(function);
       __Pyx_DECREF_SET(__pyx_t_3, function);
-      __pyx_t_6 = 1;
+      __pyx_t_5 = 1;
     }
   }
   #if CYTHON_FAST_PYCALL
   if (PyFunction_Check(__pyx_t_3)) {
-    PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_t_2, __pyx_t_4, __pyx_v_t};
-    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 3+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 56, __pyx_L1_error)
-    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    PyObject *__pyx_temp[4] = {__pyx_t_4, __pyx_t_2, __pyx_v_self->_rhs_out, __pyx_v_t};
+    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_5, 3+__pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 60, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   } else
   #endif
   #if CYTHON_FAST_PYCCALL
   if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
-    PyObject *__pyx_temp[4] = {__pyx_t_5, __pyx_t_2, __pyx_t_4, __pyx_v_t};
-    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_6, 3+__pyx_t_6); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 56, __pyx_L1_error)
-    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    PyObject *__pyx_temp[4] = {__pyx_t_4, __pyx_t_2, __pyx_v_self->_rhs_out, __pyx_v_t};
+    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_5, 3+__pyx_t_5); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 60, __pyx_L1_error)
+    __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
   } else
   #endif
   {
-    __pyx_t_7 = PyTuple_New(3+__pyx_t_6); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 56, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_7);
-    if (__pyx_t_5) {
-      __Pyx_GIVEREF(__pyx_t_5); PyTuple_SET_ITEM(__pyx_t_7, 0, __pyx_t_5); __pyx_t_5 = NULL;
+    __pyx_t_6 = PyTuple_New(3+__pyx_t_5); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 60, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    if (__pyx_t_4) {
+      __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_4); __pyx_t_4 = NULL;
     }
     __Pyx_GIVEREF(__pyx_t_2);
-    PyTuple_SET_ITEM(__pyx_t_7, 0+__pyx_t_6, __pyx_t_2);
-    __Pyx_GIVEREF(__pyx_t_4);
-    PyTuple_SET_ITEM(__pyx_t_7, 1+__pyx_t_6, __pyx_t_4);
+    PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_5, __pyx_t_2);
+    __Pyx_INCREF(__pyx_v_self->_rhs_out);
+    __Pyx_GIVEREF(__pyx_v_self->_rhs_out);
+    PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_5, __pyx_v_self->_rhs_out);
     __Pyx_INCREF(__pyx_v_t);
     __Pyx_GIVEREF(__pyx_v_t);
-    PyTuple_SET_ITEM(__pyx_t_7, 2+__pyx_t_6, __pyx_v_t);
+    PyTuple_SET_ITEM(__pyx_t_6, 2+__pyx_t_5, __pyx_v_t);
     __pyx_t_2 = 0;
-    __pyx_t_4 = 0;
-    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_7, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 56, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_6, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 60, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
   }
   __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":57
+  /* "tkwant/onebody/solvers.pyx":61
  *         # Kernel expects complex, Scipy expects real
- *         self.kernel.rhs(y.view(complex), self._rhs_out, t)
+ *         self.rhs(y.view(complex), self._rhs_out, t)
  *         return self._rhs_out.view(float)             # <<<<<<<<<<<<<<
  * 
- *     def __call__(self, psi, time, next_time):
+ *     def __call__(self, psi, time, next_time, rhs):
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_rhs_out); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 57, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->_rhs_out, __pyx_n_s_view); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 61, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_view); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 57, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_7);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = NULL;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_7))) {
-    __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_7);
-    if (likely(__pyx_t_3)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
-      __Pyx_INCREF(__pyx_t_3);
+  __pyx_t_6 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_3);
+    if (likely(__pyx_t_6)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
+      __Pyx_INCREF(__pyx_t_6);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_7, function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
     }
   }
-  __pyx_t_1 = (__pyx_t_3) ? __Pyx_PyObject_Call2Args(__pyx_t_7, __pyx_t_3, ((PyObject *)(&PyFloat_Type))) : __Pyx_PyObject_CallOneArg(__pyx_t_7, ((PyObject *)(&PyFloat_Type)));
-  __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
-  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 57, __pyx_L1_error)
+  __pyx_t_1 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_3, __pyx_t_6, ((PyObject *)(&PyFloat_Type))) : __Pyx_PyObject_CallOneArg(__pyx_t_3, ((PyObject *)(&PyFloat_Type)));
+  __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
+  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 61, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   __pyx_r = __pyx_t_1;
   __pyx_t_1 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/solvers.pyx":54
- *         self._integrator.reset(2 * self.kernel.size, has_jac=False)
+  /* "tkwant/onebody/solvers.pyx":58
+ *         self.size = size
  * 
  *     def _rhs(self, t, y):             # <<<<<<<<<<<<<<
  *         # Kernel expects complex, Scipy expects real
- *         self.kernel.rhs(y.view(complex), self._rhs_out, t)
+ *         self.rhs(y.view(complex), self._rhs_out, t)
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
   __Pyx_XDECREF(__pyx_t_3);
   __Pyx_XDECREF(__pyx_t_4);
-  __Pyx_XDECREF(__pyx_t_5);
-  __Pyx_XDECREF(__pyx_t_7);
+  __Pyx_XDECREF(__pyx_t_6);
   __Pyx_AddTraceback("tkwant.onebody.solvers.Scipy._rhs", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __pyx_r = NULL;
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/solvers.pyx":59
+/* "tkwant/onebody/solvers.pyx":63
  *         return self._rhs_out.view(float)
  * 
- *     def __call__(self, psi, time, next_time):             # <<<<<<<<<<<<<<
+ *     def __call__(self, psi, time, next_time, rhs):             # <<<<<<<<<<<<<<
  *         if time == next_time:
  *             return psi
  */
 
 /* Python wrapper */
-static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_5__call__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
-static PyMethodDef __pyx_mdef_6tkwant_7onebody_7solvers_5Scipy_5__call__ = {"__call__", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_5__call__, METH_VARARGS|METH_KEYWORDS, 0};
-static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_5__call__(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
-  PyObject *__pyx_v_self = 0;
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_5__call__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_5__call__(PyObject *__pyx_v_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
   PyObject *__pyx_v_psi = 0;
   PyObject *__pyx_v_time = 0;
   PyObject *__pyx_v_next_time = 0;
+  PyObject *__pyx_v_rhs = 0;
   PyObject *__pyx_r = 0;
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__call__ (wrapper)", 0);
   {
-    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_self,&__pyx_n_s_psi,&__pyx_n_s_time,&__pyx_n_s_next_time,0};
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_psi,&__pyx_n_s_time,&__pyx_n_s_next_time,&__pyx_n_s_rhs,0};
     PyObject* values[4] = {0,0,0,0};
     if (unlikely(__pyx_kwds)) {
       Py_ssize_t kw_args;
       const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
       switch (pos_args) {
         case  4: values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
         CYTHON_FALLTHROUGH;
@@ -2062,67 +1883,67 @@
         CYTHON_FALLTHROUGH;
         case  0: break;
         default: goto __pyx_L5_argtuple_error;
       }
       kw_args = PyDict_Size(__pyx_kwds);
       switch (pos_args) {
         case  0:
-        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_self)) != 0)) kw_args--;
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi)) != 0)) kw_args--;
         else goto __pyx_L5_argtuple_error;
         CYTHON_FALLTHROUGH;
         case  1:
-        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_psi)) != 0)) kw_args--;
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, 1); __PYX_ERR(0, 59, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, 1); __PYX_ERR(0, 63, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  2:
-        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_time)) != 0)) kw_args--;
+        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_next_time)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, 2); __PYX_ERR(0, 59, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, 2); __PYX_ERR(0, 63, __pyx_L3_error)
         }
         CYTHON_FALLTHROUGH;
         case  3:
-        if (likely((values[3] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_next_time)) != 0)) kw_args--;
+        if (likely((values[3] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_rhs)) != 0)) kw_args--;
         else {
-          __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, 3); __PYX_ERR(0, 59, __pyx_L3_error)
+          __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, 3); __PYX_ERR(0, 63, __pyx_L3_error)
         }
       }
       if (unlikely(kw_args > 0)) {
-        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__call__") < 0)) __PYX_ERR(0, 59, __pyx_L3_error)
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__call__") < 0)) __PYX_ERR(0, 63, __pyx_L3_error)
       }
     } else if (PyTuple_GET_SIZE(__pyx_args) != 4) {
       goto __pyx_L5_argtuple_error;
     } else {
       values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
       values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
       values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
       values[3] = PyTuple_GET_ITEM(__pyx_args, 3);
     }
-    __pyx_v_self = values[0];
-    __pyx_v_psi = values[1];
-    __pyx_v_time = values[2];
-    __pyx_v_next_time = values[3];
+    __pyx_v_psi = values[0];
+    __pyx_v_time = values[1];
+    __pyx_v_next_time = values[2];
+    __pyx_v_rhs = values[3];
   }
   goto __pyx_L4_argument_unpacking_done;
   __pyx_L5_argtuple_error:;
-  __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 59, __pyx_L3_error)
+  __Pyx_RaiseArgtupleInvalid("__call__", 1, 4, 4, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(0, 63, __pyx_L3_error)
   __pyx_L3_error:;
   __Pyx_AddTraceback("tkwant.onebody.solvers.Scipy.__call__", __pyx_clineno, __pyx_lineno, __pyx_filename);
   __Pyx_RefNannyFinishContext();
   return NULL;
   __pyx_L4_argument_unpacking_done:;
-  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers_5Scipy_4__call__(__pyx_self, __pyx_v_self, __pyx_v_psi, __pyx_v_time, __pyx_v_next_time);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers_5Scipy_4__call__(((struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)__pyx_v_self), __pyx_v_psi, __pyx_v_time, __pyx_v_next_time, __pyx_v_rhs);
 
   /* function exit code */
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/solvers.pyx":64
+/* "tkwant/onebody/solvers.pyx":70
  *         # psi is complex, Scipy expects real
  *         next_psi, final_time = self._integrator.run(
  *             self._rhs, lambda: None, psi.view(float), time, next_time, (), ())             # <<<<<<<<<<<<<<
  *         if not self._integrator.success:
  *             raise RuntimeError('Integration failed between {} and {}'
  */
 
@@ -2151,25 +1972,25 @@
   /* function exit code */
   __pyx_L0:;
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
-/* "tkwant/onebody/solvers.pyx":59
+/* "tkwant/onebody/solvers.pyx":63
  *         return self._rhs_out.view(float)
  * 
- *     def __call__(self, psi, time, next_time):             # <<<<<<<<<<<<<<
+ *     def __call__(self, psi, time, next_time, rhs):             # <<<<<<<<<<<<<<
  *         if time == next_time:
  *             return psi
  */
 
-static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_4__call__(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v_self, PyObject *__pyx_v_psi, PyObject *__pyx_v_time, PyObject *__pyx_v_next_time) {
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_4__call__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self, PyObject *__pyx_v_psi, PyObject *__pyx_v_time, PyObject *__pyx_v_next_time, PyObject *__pyx_v_rhs) {
   PyObject *__pyx_v_next_psi = NULL;
-  PyObject *__pyx_v_final_time = NULL;
+  CYTHON_UNUSED PyObject *__pyx_v_final_time = NULL;
   PyObject *__pyx_r = NULL;
   __Pyx_RefNannyDeclarations
   PyObject *__pyx_t_1 = NULL;
   int __pyx_t_2;
   PyObject *__pyx_t_3 = NULL;
   PyObject *__pyx_t_4 = NULL;
   PyObject *__pyx_t_5 = NULL;
@@ -2177,130 +1998,140 @@
   PyObject *__pyx_t_7 = NULL;
   PyObject *__pyx_t_8 = NULL;
   int __pyx_t_9;
   PyObject *(*__pyx_t_10)(PyObject *);
   int __pyx_t_11;
   __Pyx_RefNannySetupContext("__call__", 0);
 
-  /* "tkwant/onebody/solvers.pyx":60
+  /* "tkwant/onebody/solvers.pyx":64
  * 
- *     def __call__(self, psi, time, next_time):
+ *     def __call__(self, psi, time, next_time, rhs):
  *         if time == next_time:             # <<<<<<<<<<<<<<
  *             return psi
- *         # psi is complex, Scipy expects real
+ *         self.rhs = rhs
  */
-  __pyx_t_1 = PyObject_RichCompare(__pyx_v_time, __pyx_v_next_time, Py_EQ); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 60, __pyx_L1_error)
-  __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 60, __pyx_L1_error)
+  __pyx_t_1 = PyObject_RichCompare(__pyx_v_time, __pyx_v_next_time, Py_EQ); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 64, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 64, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   if (__pyx_t_2) {
 
-    /* "tkwant/onebody/solvers.pyx":61
- *     def __call__(self, psi, time, next_time):
+    /* "tkwant/onebody/solvers.pyx":65
+ *     def __call__(self, psi, time, next_time, rhs):
  *         if time == next_time:
  *             return psi             # <<<<<<<<<<<<<<
- *         # psi is complex, Scipy expects real
- *         next_psi, final_time = self._integrator.run(
+ *         self.rhs = rhs
+ *         # self._integrator.reset(2 * self.size, has_jac=False) ## RESET TO BE RE-ENTRANT
  */
     __Pyx_XDECREF(__pyx_r);
     __Pyx_INCREF(__pyx_v_psi);
     __pyx_r = __pyx_v_psi;
     goto __pyx_L0;
 
-    /* "tkwant/onebody/solvers.pyx":60
+    /* "tkwant/onebody/solvers.pyx":64
  * 
- *     def __call__(self, psi, time, next_time):
+ *     def __call__(self, psi, time, next_time, rhs):
  *         if time == next_time:             # <<<<<<<<<<<<<<
  *             return psi
- *         # psi is complex, Scipy expects real
+ *         self.rhs = rhs
  */
   }
 
-  /* "tkwant/onebody/solvers.pyx":63
+  /* "tkwant/onebody/solvers.pyx":66
+ *         if time == next_time:
  *             return psi
+ *         self.rhs = rhs             # <<<<<<<<<<<<<<
+ *         # self._integrator.reset(2 * self.size, has_jac=False) ## RESET TO BE RE-ENTRANT
+ *         # psi is complex, Scipy expects real
+ */
+  __Pyx_INCREF(__pyx_v_rhs);
+  __Pyx_GIVEREF(__pyx_v_rhs);
+  __Pyx_GOTREF(__pyx_v_self->rhs);
+  __Pyx_DECREF(__pyx_v_self->rhs);
+  __pyx_v_self->rhs = __pyx_v_rhs;
+
+  /* "tkwant/onebody/solvers.pyx":69
+ *         # self._integrator.reset(2 * self.size, has_jac=False) ## RESET TO BE RE-ENTRANT
  *         # psi is complex, Scipy expects real
  *         next_psi, final_time = self._integrator.run(             # <<<<<<<<<<<<<<
  *             self._rhs, lambda: None, psi.view(float), time, next_time, (), ())
  *         if not self._integrator.success:
  */
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_integrator_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 63, __pyx_L1_error)
+  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->_integrator, __pyx_n_s_run); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 69, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_run); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 63, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":64
+  /* "tkwant/onebody/solvers.pyx":70
  *         # psi is complex, Scipy expects real
  *         next_psi, final_time = self._integrator.run(
  *             self._rhs, lambda: None, psi.view(float), time, next_time, (), ())             # <<<<<<<<<<<<<<
  *         if not self._integrator.success:
  *             raise RuntimeError('Integration failed between {} and {}'
  */
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_rhs_2); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 64, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_5 = __Pyx_CyFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7solvers_5Scipy_8__call___lambda, 0, __pyx_n_s_Scipy___call___locals_lambda, NULL, __pyx_n_s_tkwant_onebody_solvers, __pyx_d, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 64, __pyx_L1_error)
+  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v_self), __pyx_n_s_rhs_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 70, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_4);
+  __pyx_t_5 = __Pyx_CyFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7solvers_5Scipy_8__call___lambda, 0, __pyx_n_s_call___locals_lambda, NULL, __pyx_n_s_tkwant_onebody_solvers, __pyx_d, NULL); if (unlikely(!__pyx_t_5)) __PYX_ERR(0, 70, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_5);
-  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_psi, __pyx_n_s_view); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 64, __pyx_L1_error)
+  __pyx_t_7 = __Pyx_PyObject_GetAttrStr(__pyx_v_psi, __pyx_n_s_view); if (unlikely(!__pyx_t_7)) __PYX_ERR(0, 70, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_7);
   __pyx_t_8 = NULL;
   if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_7))) {
     __pyx_t_8 = PyMethod_GET_SELF(__pyx_t_7);
     if (likely(__pyx_t_8)) {
       PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_7);
       __Pyx_INCREF(__pyx_t_8);
       __Pyx_INCREF(function);
       __Pyx_DECREF_SET(__pyx_t_7, function);
     }
   }
   __pyx_t_6 = (__pyx_t_8) ? __Pyx_PyObject_Call2Args(__pyx_t_7, __pyx_t_8, ((PyObject *)(&PyFloat_Type))) : __Pyx_PyObject_CallOneArg(__pyx_t_7, ((PyObject *)(&PyFloat_Type)));
   __Pyx_XDECREF(__pyx_t_8); __pyx_t_8 = 0;
-  if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 64, __pyx_L1_error)
+  if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 70, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_6);
   __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
   __pyx_t_7 = NULL;
   __pyx_t_9 = 0;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_4))) {
-    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_4);
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_3))) {
+    __pyx_t_7 = PyMethod_GET_SELF(__pyx_t_3);
     if (likely(__pyx_t_7)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_4);
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_3);
       __Pyx_INCREF(__pyx_t_7);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_4, function);
+      __Pyx_DECREF_SET(__pyx_t_3, function);
       __pyx_t_9 = 1;
     }
   }
   #if CYTHON_FAST_PYCALL
-  if (PyFunction_Check(__pyx_t_4)) {
-    PyObject *__pyx_temp[8] = {__pyx_t_7, __pyx_t_3, __pyx_t_5, __pyx_t_6, __pyx_v_time, __pyx_v_next_time, __pyx_empty_tuple, __pyx_empty_tuple};
-    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_9, 7+__pyx_t_9); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 63, __pyx_L1_error)
+  if (PyFunction_Check(__pyx_t_3)) {
+    PyObject *__pyx_temp[8] = {__pyx_t_7, __pyx_t_4, __pyx_t_5, __pyx_t_6, __pyx_v_time, __pyx_v_next_time, __pyx_empty_tuple, __pyx_empty_tuple};
+    __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_9, 7+__pyx_t_9); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 69, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
     __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
   } else
   #endif
   #if CYTHON_FAST_PYCCALL
-  if (__Pyx_PyFastCFunction_Check(__pyx_t_4)) {
-    PyObject *__pyx_temp[8] = {__pyx_t_7, __pyx_t_3, __pyx_t_5, __pyx_t_6, __pyx_v_time, __pyx_v_next_time, __pyx_empty_tuple, __pyx_empty_tuple};
-    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_4, __pyx_temp+1-__pyx_t_9, 7+__pyx_t_9); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 63, __pyx_L1_error)
+  if (__Pyx_PyFastCFunction_Check(__pyx_t_3)) {
+    PyObject *__pyx_temp[8] = {__pyx_t_7, __pyx_t_4, __pyx_t_5, __pyx_t_6, __pyx_v_time, __pyx_v_next_time, __pyx_empty_tuple, __pyx_empty_tuple};
+    __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_3, __pyx_temp+1-__pyx_t_9, 7+__pyx_t_9); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 69, __pyx_L1_error)
     __Pyx_XDECREF(__pyx_t_7); __pyx_t_7 = 0;
     __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
     __Pyx_DECREF(__pyx_t_5); __pyx_t_5 = 0;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
   } else
   #endif
   {
-    __pyx_t_8 = PyTuple_New(7+__pyx_t_9); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 63, __pyx_L1_error)
+    __pyx_t_8 = PyTuple_New(7+__pyx_t_9); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 69, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
     if (__pyx_t_7) {
       __Pyx_GIVEREF(__pyx_t_7); PyTuple_SET_ITEM(__pyx_t_8, 0, __pyx_t_7); __pyx_t_7 = NULL;
     }
-    __Pyx_GIVEREF(__pyx_t_3);
-    PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_9, __pyx_t_3);
+    __Pyx_GIVEREF(__pyx_t_4);
+    PyTuple_SET_ITEM(__pyx_t_8, 0+__pyx_t_9, __pyx_t_4);
     __Pyx_GIVEREF(__pyx_t_5);
     PyTuple_SET_ITEM(__pyx_t_8, 1+__pyx_t_9, __pyx_t_5);
     __Pyx_GIVEREF(__pyx_t_6);
     PyTuple_SET_ITEM(__pyx_t_8, 2+__pyx_t_9, __pyx_t_6);
     __Pyx_INCREF(__pyx_v_time);
     __Pyx_GIVEREF(__pyx_v_time);
     PyTuple_SET_ITEM(__pyx_t_8, 3+__pyx_t_9, __pyx_v_time);
@@ -2309,228 +2140,206 @@
     PyTuple_SET_ITEM(__pyx_t_8, 4+__pyx_t_9, __pyx_v_next_time);
     __Pyx_INCREF(__pyx_empty_tuple);
     __Pyx_GIVEREF(__pyx_empty_tuple);
     PyTuple_SET_ITEM(__pyx_t_8, 5+__pyx_t_9, __pyx_empty_tuple);
     __Pyx_INCREF(__pyx_empty_tuple);
     __Pyx_GIVEREF(__pyx_empty_tuple);
     PyTuple_SET_ITEM(__pyx_t_8, 6+__pyx_t_9, __pyx_empty_tuple);
-    __pyx_t_3 = 0;
+    __pyx_t_4 = 0;
     __pyx_t_5 = 0;
     __pyx_t_6 = 0;
-    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_4, __pyx_t_8, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 63, __pyx_L1_error)
+    __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_3, __pyx_t_8, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 69, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_1);
     __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
   }
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
   if ((likely(PyTuple_CheckExact(__pyx_t_1))) || (PyList_CheckExact(__pyx_t_1))) {
     PyObject* sequence = __pyx_t_1;
     Py_ssize_t size = __Pyx_PySequence_SIZE(sequence);
     if (unlikely(size != 2)) {
       if (size > 2) __Pyx_RaiseTooManyValuesError(2);
       else if (size >= 0) __Pyx_RaiseNeedMoreValuesError(size);
-      __PYX_ERR(0, 63, __pyx_L1_error)
+      __PYX_ERR(0, 69, __pyx_L1_error)
     }
     #if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
     if (likely(PyTuple_CheckExact(sequence))) {
-      __pyx_t_4 = PyTuple_GET_ITEM(sequence, 0); 
+      __pyx_t_3 = PyTuple_GET_ITEM(sequence, 0); 
       __pyx_t_8 = PyTuple_GET_ITEM(sequence, 1); 
     } else {
-      __pyx_t_4 = PyList_GET_ITEM(sequence, 0); 
+      __pyx_t_3 = PyList_GET_ITEM(sequence, 0); 
       __pyx_t_8 = PyList_GET_ITEM(sequence, 1); 
     }
-    __Pyx_INCREF(__pyx_t_4);
+    __Pyx_INCREF(__pyx_t_3);
     __Pyx_INCREF(__pyx_t_8);
     #else
-    __pyx_t_4 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 63, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_4);
-    __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 63, __pyx_L1_error)
+    __pyx_t_3 = PySequence_ITEM(sequence, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 69, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __pyx_t_8 = PySequence_ITEM(sequence, 1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 69, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_8);
     #endif
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   } else {
     Py_ssize_t index = -1;
-    __pyx_t_6 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 63, __pyx_L1_error)
+    __pyx_t_6 = PyObject_GetIter(__pyx_t_1); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 69, __pyx_L1_error)
     __Pyx_GOTREF(__pyx_t_6);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
     __pyx_t_10 = Py_TYPE(__pyx_t_6)->tp_iternext;
-    index = 0; __pyx_t_4 = __pyx_t_10(__pyx_t_6); if (unlikely(!__pyx_t_4)) goto __pyx_L4_unpacking_failed;
-    __Pyx_GOTREF(__pyx_t_4);
+    index = 0; __pyx_t_3 = __pyx_t_10(__pyx_t_6); if (unlikely(!__pyx_t_3)) goto __pyx_L4_unpacking_failed;
+    __Pyx_GOTREF(__pyx_t_3);
     index = 1; __pyx_t_8 = __pyx_t_10(__pyx_t_6); if (unlikely(!__pyx_t_8)) goto __pyx_L4_unpacking_failed;
     __Pyx_GOTREF(__pyx_t_8);
-    if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_6), 2) < 0) __PYX_ERR(0, 63, __pyx_L1_error)
+    if (__Pyx_IternextUnpackEndCheck(__pyx_t_10(__pyx_t_6), 2) < 0) __PYX_ERR(0, 69, __pyx_L1_error)
     __pyx_t_10 = NULL;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     goto __pyx_L5_unpacking_done;
     __pyx_L4_unpacking_failed:;
     __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     __pyx_t_10 = NULL;
     if (__Pyx_IterFinish() == 0) __Pyx_RaiseNeedMoreValuesError(index);
-    __PYX_ERR(0, 63, __pyx_L1_error)
+    __PYX_ERR(0, 69, __pyx_L1_error)
     __pyx_L5_unpacking_done:;
   }
 
-  /* "tkwant/onebody/solvers.pyx":63
- *             return psi
+  /* "tkwant/onebody/solvers.pyx":69
+ *         # self._integrator.reset(2 * self.size, has_jac=False) ## RESET TO BE RE-ENTRANT
  *         # psi is complex, Scipy expects real
  *         next_psi, final_time = self._integrator.run(             # <<<<<<<<<<<<<<
  *             self._rhs, lambda: None, psi.view(float), time, next_time, (), ())
  *         if not self._integrator.success:
  */
-  __pyx_v_next_psi = __pyx_t_4;
-  __pyx_t_4 = 0;
+  __pyx_v_next_psi = __pyx_t_3;
+  __pyx_t_3 = 0;
   __pyx_v_final_time = __pyx_t_8;
   __pyx_t_8 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":65
+  /* "tkwant/onebody/solvers.pyx":71
  *         next_psi, final_time = self._integrator.run(
  *             self._rhs, lambda: None, psi.view(float), time, next_time, (), ())
  *         if not self._integrator.success:             # <<<<<<<<<<<<<<
  *             raise RuntimeError('Integration failed between {} and {}'
  *                                .format(time, next_time))
  */
-  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self, __pyx_n_s_integrator_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 65, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_self->_integrator, __pyx_n_s_success); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 71, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_success); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 65, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_8);
+  __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 71, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_2 = __Pyx_PyObject_IsTrue(__pyx_t_8); if (unlikely(__pyx_t_2 < 0)) __PYX_ERR(0, 65, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
   __pyx_t_11 = ((!__pyx_t_2) != 0);
   if (unlikely(__pyx_t_11)) {
 
-    /* "tkwant/onebody/solvers.pyx":67
+    /* "tkwant/onebody/solvers.pyx":73
  *         if not self._integrator.success:
  *             raise RuntimeError('Integration failed between {} and {}'
  *                                .format(time, next_time))             # <<<<<<<<<<<<<<
- *         assert final_time == next_time
  *         return next_psi.view(complex)
+ * 
  */
-    __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_kp_u_Integration_failed_between_and, __pyx_n_s_format); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 67, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __pyx_t_4 = NULL;
+    __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_kp_u_Integration_failed_between_and, __pyx_n_s_format); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 73, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __pyx_t_3 = NULL;
     __pyx_t_9 = 0;
-    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_1))) {
-      __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_1);
-      if (likely(__pyx_t_4)) {
-        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
-        __Pyx_INCREF(__pyx_t_4);
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_8))) {
+      __pyx_t_3 = PyMethod_GET_SELF(__pyx_t_8);
+      if (likely(__pyx_t_3)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
+        __Pyx_INCREF(__pyx_t_3);
         __Pyx_INCREF(function);
-        __Pyx_DECREF_SET(__pyx_t_1, function);
+        __Pyx_DECREF_SET(__pyx_t_8, function);
         __pyx_t_9 = 1;
       }
     }
     #if CYTHON_FAST_PYCALL
-    if (PyFunction_Check(__pyx_t_1)) {
-      PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_v_time, __pyx_v_next_time};
-      __pyx_t_8 = __Pyx_PyFunction_FastCall(__pyx_t_1, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 67, __pyx_L1_error)
-      __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_GOTREF(__pyx_t_8);
+    if (PyFunction_Check(__pyx_t_8)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_time, __pyx_v_next_time};
+      __pyx_t_1 = __Pyx_PyFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 73, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __Pyx_GOTREF(__pyx_t_1);
     } else
     #endif
     #if CYTHON_FAST_PYCCALL
-    if (__Pyx_PyFastCFunction_Check(__pyx_t_1)) {
-      PyObject *__pyx_temp[3] = {__pyx_t_4, __pyx_v_time, __pyx_v_next_time};
-      __pyx_t_8 = __Pyx_PyCFunction_FastCall(__pyx_t_1, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 67, __pyx_L1_error)
-      __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
-      __Pyx_GOTREF(__pyx_t_8);
+    if (__Pyx_PyFastCFunction_Check(__pyx_t_8)) {
+      PyObject *__pyx_temp[3] = {__pyx_t_3, __pyx_v_time, __pyx_v_next_time};
+      __pyx_t_1 = __Pyx_PyCFunction_FastCall(__pyx_t_8, __pyx_temp+1-__pyx_t_9, 2+__pyx_t_9); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 73, __pyx_L1_error)
+      __Pyx_XDECREF(__pyx_t_3); __pyx_t_3 = 0;
+      __Pyx_GOTREF(__pyx_t_1);
     } else
     #endif
     {
-      __pyx_t_6 = PyTuple_New(2+__pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 67, __pyx_L1_error)
+      __pyx_t_6 = PyTuple_New(2+__pyx_t_9); if (unlikely(!__pyx_t_6)) __PYX_ERR(0, 73, __pyx_L1_error)
       __Pyx_GOTREF(__pyx_t_6);
-      if (__pyx_t_4) {
-        __Pyx_GIVEREF(__pyx_t_4); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_4); __pyx_t_4 = NULL;
+      if (__pyx_t_3) {
+        __Pyx_GIVEREF(__pyx_t_3); PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_3); __pyx_t_3 = NULL;
       }
       __Pyx_INCREF(__pyx_v_time);
       __Pyx_GIVEREF(__pyx_v_time);
       PyTuple_SET_ITEM(__pyx_t_6, 0+__pyx_t_9, __pyx_v_time);
       __Pyx_INCREF(__pyx_v_next_time);
       __Pyx_GIVEREF(__pyx_v_next_time);
       PyTuple_SET_ITEM(__pyx_t_6, 1+__pyx_t_9, __pyx_v_next_time);
-      __pyx_t_8 = __Pyx_PyObject_Call(__pyx_t_1, __pyx_t_6, NULL); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 67, __pyx_L1_error)
-      __Pyx_GOTREF(__pyx_t_8);
+      __pyx_t_1 = __Pyx_PyObject_Call(__pyx_t_8, __pyx_t_6, NULL); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 73, __pyx_L1_error)
+      __Pyx_GOTREF(__pyx_t_1);
       __Pyx_DECREF(__pyx_t_6); __pyx_t_6 = 0;
     }
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
 
-    /* "tkwant/onebody/solvers.pyx":66
+    /* "tkwant/onebody/solvers.pyx":72
  *             self._rhs, lambda: None, psi.view(float), time, next_time, (), ())
  *         if not self._integrator.success:
  *             raise RuntimeError('Integration failed between {} and {}'             # <<<<<<<<<<<<<<
  *                                .format(time, next_time))
- *         assert final_time == next_time
+ *         return next_psi.view(complex)
  */
-    __pyx_t_1 = __Pyx_PyObject_CallOneArg(__pyx_builtin_RuntimeError, __pyx_t_8); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 66, __pyx_L1_error)
-    __Pyx_GOTREF(__pyx_t_1);
-    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-    __Pyx_Raise(__pyx_t_1, 0, 0, 0);
+    __pyx_t_8 = __Pyx_PyObject_CallOneArg(__pyx_builtin_RuntimeError, __pyx_t_1); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 72, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
     __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    __PYX_ERR(0, 66, __pyx_L1_error)
+    __Pyx_Raise(__pyx_t_8, 0, 0, 0);
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __PYX_ERR(0, 72, __pyx_L1_error)
 
-    /* "tkwant/onebody/solvers.pyx":65
+    /* "tkwant/onebody/solvers.pyx":71
  *         next_psi, final_time = self._integrator.run(
  *             self._rhs, lambda: None, psi.view(float), time, next_time, (), ())
  *         if not self._integrator.success:             # <<<<<<<<<<<<<<
  *             raise RuntimeError('Integration failed between {} and {}'
  *                                .format(time, next_time))
  */
   }
 
-  /* "tkwant/onebody/solvers.pyx":68
+  /* "tkwant/onebody/solvers.pyx":74
  *             raise RuntimeError('Integration failed between {} and {}'
  *                                .format(time, next_time))
- *         assert final_time == next_time             # <<<<<<<<<<<<<<
- *         return next_psi.view(complex)
- * 
- */
-  #ifndef CYTHON_WITHOUT_ASSERTIONS
-  if (unlikely(!Py_OptimizeFlag)) {
-    __pyx_t_1 = PyObject_RichCompare(__pyx_v_final_time, __pyx_v_next_time, Py_EQ); __Pyx_XGOTREF(__pyx_t_1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 68, __pyx_L1_error)
-    __pyx_t_11 = __Pyx_PyObject_IsTrue(__pyx_t_1); if (unlikely(__pyx_t_11 < 0)) __PYX_ERR(0, 68, __pyx_L1_error)
-    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-    if (unlikely(!__pyx_t_11)) {
-      PyErr_SetNone(PyExc_AssertionError);
-      __PYX_ERR(0, 68, __pyx_L1_error)
-    }
-  }
-  #endif
-
-  /* "tkwant/onebody/solvers.pyx":69
- *                                .format(time, next_time))
- *         assert final_time == next_time
  *         return next_psi.view(complex)             # <<<<<<<<<<<<<<
  * 
- * 
+ *     @property
  */
   __Pyx_XDECREF(__pyx_r);
-  __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_v_next_psi, __pyx_n_s_view); if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 69, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_8);
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_v_next_psi, __pyx_n_s_view); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 74, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
   __pyx_t_6 = NULL;
-  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_8))) {
-    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_8);
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_1))) {
+    __pyx_t_6 = PyMethod_GET_SELF(__pyx_t_1);
     if (likely(__pyx_t_6)) {
-      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_1);
       __Pyx_INCREF(__pyx_t_6);
       __Pyx_INCREF(function);
-      __Pyx_DECREF_SET(__pyx_t_8, function);
+      __Pyx_DECREF_SET(__pyx_t_1, function);
     }
   }
-  __pyx_t_1 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_8, __pyx_t_6, ((PyObject *)(&PyComplex_Type))) : __Pyx_PyObject_CallOneArg(__pyx_t_8, ((PyObject *)(&PyComplex_Type)));
+  __pyx_t_8 = (__pyx_t_6) ? __Pyx_PyObject_Call2Args(__pyx_t_1, __pyx_t_6, ((PyObject *)(&PyComplex_Type))) : __Pyx_PyObject_CallOneArg(__pyx_t_1, ((PyObject *)(&PyComplex_Type)));
   __Pyx_XDECREF(__pyx_t_6); __pyx_t_6 = 0;
-  if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 69, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
-  __pyx_r = __pyx_t_1;
-  __pyx_t_1 = 0;
+  if (unlikely(!__pyx_t_8)) __PYX_ERR(0, 74, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_8);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_r = __pyx_t_8;
+  __pyx_t_8 = 0;
   goto __pyx_L0;
 
-  /* "tkwant/onebody/solvers.pyx":59
+  /* "tkwant/onebody/solvers.pyx":63
  *         return self._rhs_out.view(float)
  * 
- *     def __call__(self, psi, time, next_time):             # <<<<<<<<<<<<<<
+ *     def __call__(self, psi, time, next_time, rhs):             # <<<<<<<<<<<<<<
  *         if time == next_time:
  *             return psi
  */
 
   /* function exit code */
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
@@ -2546,14 +2355,955 @@
   __Pyx_XDECREF(__pyx_v_next_psi);
   __Pyx_XDECREF(__pyx_v_final_time);
   __Pyx_XGIVEREF(__pyx_r);
   __Pyx_RefNannyFinishContext();
   return __pyx_r;
 }
 
+/* "tkwant/onebody/solvers.pyx":77
+ * 
+ *     @property
+ *     def size(self):             # <<<<<<<<<<<<<<
+ *         return self.size
+ * 
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_4size_1__get__(PyObject *__pyx_v_self); /*proto*/
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_4size_1__get__(PyObject *__pyx_v_self) {
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__get__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers_5Scipy_4size___get__(((struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)__pyx_v_self));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_4size___get__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  __Pyx_RefNannySetupContext("__get__", 0);
+
+  /* "tkwant/onebody/solvers.pyx":78
+ *     @property
+ *     def size(self):
+ *         return self.size             # <<<<<<<<<<<<<<
+ * 
+ * 
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 78, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_r = __pyx_t_1;
+  __pyx_t_1 = 0;
+  goto __pyx_L0;
+
+  /* "tkwant/onebody/solvers.pyx":77
+ * 
+ *     @property
+ *     def size(self):             # <<<<<<<<<<<<<<
+ *         return self.size
+ * 
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_AddTraceback("tkwant.onebody.solvers.Scipy.size.__get__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":1
+ * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
+ *     cdef tuple state
+ *     cdef object _dict
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_7__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused); /*proto*/
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_7__reduce_cython__(PyObject *__pyx_v_self, CYTHON_UNUSED PyObject *unused) {
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__reduce_cython__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers_5Scipy_6__reduce_cython__(((struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)__pyx_v_self));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_6__reduce_cython__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self) {
+  PyObject *__pyx_v_state = 0;
+  PyObject *__pyx_v__dict = 0;
+  int __pyx_v_use_setstate;
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  PyObject *__pyx_t_2 = NULL;
+  int __pyx_t_3;
+  int __pyx_t_4;
+  int __pyx_t_5;
+  PyObject *__pyx_t_6 = NULL;
+  __Pyx_RefNannySetupContext("__reduce_cython__", 0);
+
+  /* "(tree fragment)":5
+ *     cdef object _dict
+ *     cdef bint use_setstate
+ *     state = (self._integrator, self._rhs_out, self.rhs, self.size)             # <<<<<<<<<<<<<<
+ *     _dict = getattr(self, '__dict__', None)
+ *     if _dict is not None:
+ */
+  __pyx_t_1 = __Pyx_PyInt_From_int(__pyx_v_self->size); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = PyTuple_New(4); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __Pyx_INCREF(__pyx_v_self->_integrator);
+  __Pyx_GIVEREF(__pyx_v_self->_integrator);
+  PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_v_self->_integrator);
+  __Pyx_INCREF(__pyx_v_self->_rhs_out);
+  __Pyx_GIVEREF(__pyx_v_self->_rhs_out);
+  PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_v_self->_rhs_out);
+  __Pyx_INCREF(__pyx_v_self->rhs);
+  __Pyx_GIVEREF(__pyx_v_self->rhs);
+  PyTuple_SET_ITEM(__pyx_t_2, 2, __pyx_v_self->rhs);
+  __Pyx_GIVEREF(__pyx_t_1);
+  PyTuple_SET_ITEM(__pyx_t_2, 3, __pyx_t_1);
+  __pyx_t_1 = 0;
+  __pyx_v_state = ((PyObject*)__pyx_t_2);
+  __pyx_t_2 = 0;
+
+  /* "(tree fragment)":6
+ *     cdef bint use_setstate
+ *     state = (self._integrator, self._rhs_out, self.rhs, self.size)
+ *     _dict = getattr(self, '__dict__', None)             # <<<<<<<<<<<<<<
+ *     if _dict is not None:
+ *         state += (_dict,)
+ */
+  __pyx_t_2 = __Pyx_GetAttr3(((PyObject *)__pyx_v_self), __pyx_n_s_dict, Py_None); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 6, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_v__dict = __pyx_t_2;
+  __pyx_t_2 = 0;
+
+  /* "(tree fragment)":7
+ *     state = (self._integrator, self._rhs_out, self.rhs, self.size)
+ *     _dict = getattr(self, '__dict__', None)
+ *     if _dict is not None:             # <<<<<<<<<<<<<<
+ *         state += (_dict,)
+ *         use_setstate = True
+ */
+  __pyx_t_3 = (__pyx_v__dict != Py_None);
+  __pyx_t_4 = (__pyx_t_3 != 0);
+  if (__pyx_t_4) {
+
+    /* "(tree fragment)":8
+ *     _dict = getattr(self, '__dict__', None)
+ *     if _dict is not None:
+ *         state += (_dict,)             # <<<<<<<<<<<<<<
+ *         use_setstate = True
+ *     else:
+ */
+    __pyx_t_2 = PyTuple_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 8, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_INCREF(__pyx_v__dict);
+    __Pyx_GIVEREF(__pyx_v__dict);
+    PyTuple_SET_ITEM(__pyx_t_2, 0, __pyx_v__dict);
+    __pyx_t_1 = PyNumber_InPlaceAdd(__pyx_v_state, __pyx_t_2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 8, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_DECREF_SET(__pyx_v_state, ((PyObject*)__pyx_t_1));
+    __pyx_t_1 = 0;
+
+    /* "(tree fragment)":9
+ *     if _dict is not None:
+ *         state += (_dict,)
+ *         use_setstate = True             # <<<<<<<<<<<<<<
+ *     else:
+ *         use_setstate = self._integrator is not None or self._rhs_out is not None or self.rhs is not None
+ */
+    __pyx_v_use_setstate = 1;
+
+    /* "(tree fragment)":7
+ *     state = (self._integrator, self._rhs_out, self.rhs, self.size)
+ *     _dict = getattr(self, '__dict__', None)
+ *     if _dict is not None:             # <<<<<<<<<<<<<<
+ *         state += (_dict,)
+ *         use_setstate = True
+ */
+    goto __pyx_L3;
+  }
+
+  /* "(tree fragment)":11
+ *         use_setstate = True
+ *     else:
+ *         use_setstate = self._integrator is not None or self._rhs_out is not None or self.rhs is not None             # <<<<<<<<<<<<<<
+ *     if use_setstate:
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, None), state
+ */
+  /*else*/ {
+    __pyx_t_3 = (__pyx_v_self->_integrator != Py_None);
+    __pyx_t_5 = (__pyx_t_3 != 0);
+    if (!__pyx_t_5) {
+    } else {
+      __pyx_t_4 = __pyx_t_5;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_5 = (__pyx_v_self->_rhs_out != Py_None);
+    __pyx_t_3 = (__pyx_t_5 != 0);
+    if (!__pyx_t_3) {
+    } else {
+      __pyx_t_4 = __pyx_t_3;
+      goto __pyx_L4_bool_binop_done;
+    }
+    __pyx_t_3 = (__pyx_v_self->rhs != Py_None);
+    __pyx_t_5 = (__pyx_t_3 != 0);
+    __pyx_t_4 = __pyx_t_5;
+    __pyx_L4_bool_binop_done:;
+    __pyx_v_use_setstate = __pyx_t_4;
+  }
+  __pyx_L3:;
+
+  /* "(tree fragment)":12
+ *     else:
+ *         use_setstate = self._integrator is not None or self._rhs_out is not None or self.rhs is not None
+ *     if use_setstate:             # <<<<<<<<<<<<<<
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, None), state
+ *     else:
+ */
+  __pyx_t_4 = (__pyx_v_use_setstate != 0);
+  if (__pyx_t_4) {
+
+    /* "(tree fragment)":13
+ *         use_setstate = self._integrator is not None or self._rhs_out is not None or self.rhs is not None
+ *     if use_setstate:
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, None), state             # <<<<<<<<<<<<<<
+ *     else:
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, state)
+ */
+    __Pyx_XDECREF(__pyx_r);
+    __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_pyx_unpickle_Scipy); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 13, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __pyx_t_2 = PyTuple_New(3); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 13, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    PyTuple_SET_ITEM(__pyx_t_2, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_INCREF(__pyx_int_229803012);
+    __Pyx_GIVEREF(__pyx_int_229803012);
+    PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_int_229803012);
+    __Pyx_INCREF(Py_None);
+    __Pyx_GIVEREF(Py_None);
+    PyTuple_SET_ITEM(__pyx_t_2, 2, Py_None);
+    __pyx_t_6 = PyTuple_New(3); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 13, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __Pyx_GIVEREF(__pyx_t_1);
+    PyTuple_SET_ITEM(__pyx_t_6, 0, __pyx_t_1);
+    __Pyx_GIVEREF(__pyx_t_2);
+    PyTuple_SET_ITEM(__pyx_t_6, 1, __pyx_t_2);
+    __Pyx_INCREF(__pyx_v_state);
+    __Pyx_GIVEREF(__pyx_v_state);
+    PyTuple_SET_ITEM(__pyx_t_6, 2, __pyx_v_state);
+    __pyx_t_1 = 0;
+    __pyx_t_2 = 0;
+    __pyx_r = __pyx_t_6;
+    __pyx_t_6 = 0;
+    goto __pyx_L0;
+
+    /* "(tree fragment)":12
+ *     else:
+ *         use_setstate = self._integrator is not None or self._rhs_out is not None or self.rhs is not None
+ *     if use_setstate:             # <<<<<<<<<<<<<<
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, None), state
+ *     else:
+ */
+  }
+
+  /* "(tree fragment)":15
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, None), state
+ *     else:
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, state)             # <<<<<<<<<<<<<<
+ * def __setstate_cython__(self, __pyx_state):
+ *     __pyx_unpickle_Scipy__set_state(self, __pyx_state)
+ */
+  /*else*/ {
+    __Pyx_XDECREF(__pyx_r);
+    __Pyx_GetModuleGlobalName(__pyx_t_6, __pyx_n_s_pyx_unpickle_Scipy); if (unlikely(!__pyx_t_6)) __PYX_ERR(1, 15, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_6);
+    __pyx_t_2 = PyTuple_New(3); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 15, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_INCREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_GIVEREF(((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    PyTuple_SET_ITEM(__pyx_t_2, 0, ((PyObject *)Py_TYPE(((PyObject *)__pyx_v_self))));
+    __Pyx_INCREF(__pyx_int_229803012);
+    __Pyx_GIVEREF(__pyx_int_229803012);
+    PyTuple_SET_ITEM(__pyx_t_2, 1, __pyx_int_229803012);
+    __Pyx_INCREF(__pyx_v_state);
+    __Pyx_GIVEREF(__pyx_v_state);
+    PyTuple_SET_ITEM(__pyx_t_2, 2, __pyx_v_state);
+    __pyx_t_1 = PyTuple_New(2); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 15, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_GIVEREF(__pyx_t_6);
+    PyTuple_SET_ITEM(__pyx_t_1, 0, __pyx_t_6);
+    __Pyx_GIVEREF(__pyx_t_2);
+    PyTuple_SET_ITEM(__pyx_t_1, 1, __pyx_t_2);
+    __pyx_t_6 = 0;
+    __pyx_t_2 = 0;
+    __pyx_r = __pyx_t_1;
+    __pyx_t_1 = 0;
+    goto __pyx_L0;
+  }
+
+  /* "(tree fragment)":1
+ * def __reduce_cython__(self):             # <<<<<<<<<<<<<<
+ *     cdef tuple state
+ *     cdef object _dict
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_6);
+  __Pyx_AddTraceback("tkwant.onebody.solvers.Scipy.__reduce_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v_state);
+  __Pyx_XDECREF(__pyx_v__dict);
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":16
+ *     else:
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, state)
+ * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
+ *     __pyx_unpickle_Scipy__set_state(self, __pyx_state)
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_9__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state); /*proto*/
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_9__setstate_cython__(PyObject *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__setstate_cython__ (wrapper)", 0);
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers_5Scipy_8__setstate_cython__(((struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)__pyx_v_self), ((PyObject *)__pyx_v___pyx_state));
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers_5Scipy_8__setstate_cython__(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v_self, PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  __Pyx_RefNannySetupContext("__setstate_cython__", 0);
+
+  /* "(tree fragment)":17
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, state)
+ * def __setstate_cython__(self, __pyx_state):
+ *     __pyx_unpickle_Scipy__set_state(self, __pyx_state)             # <<<<<<<<<<<<<<
+ */
+  if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 17, __pyx_L1_error)
+  __pyx_t_1 = __pyx_f_6tkwant_7onebody_7solvers___pyx_unpickle_Scipy__set_state(__pyx_v_self, ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+
+  /* "(tree fragment)":16
+ *     else:
+ *         return __pyx_unpickle_Scipy, (type(self), 0xdb28404, state)
+ * def __setstate_cython__(self, __pyx_state):             # <<<<<<<<<<<<<<
+ *     __pyx_unpickle_Scipy__set_state(self, __pyx_state)
+ */
+
+  /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  goto __pyx_L0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_AddTraceback("tkwant.onebody.solvers.Scipy.__setstate_cython__", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":1
+ * def __pyx_unpickle_Scipy(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
+ */
+
+/* Python wrapper */
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_1__pyx_unpickle_Scipy(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds); /*proto*/
+static PyMethodDef __pyx_mdef_6tkwant_7onebody_7solvers_1__pyx_unpickle_Scipy = {"__pyx_unpickle_Scipy", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7solvers_1__pyx_unpickle_Scipy, METH_VARARGS|METH_KEYWORDS, 0};
+static PyObject *__pyx_pw_6tkwant_7onebody_7solvers_1__pyx_unpickle_Scipy(PyObject *__pyx_self, PyObject *__pyx_args, PyObject *__pyx_kwds) {
+  PyObject *__pyx_v___pyx_type = 0;
+  long __pyx_v___pyx_checksum;
+  PyObject *__pyx_v___pyx_state = 0;
+  PyObject *__pyx_r = 0;
+  __Pyx_RefNannyDeclarations
+  __Pyx_RefNannySetupContext("__pyx_unpickle_Scipy (wrapper)", 0);
+  {
+    static PyObject **__pyx_pyargnames[] = {&__pyx_n_s_pyx_type,&__pyx_n_s_pyx_checksum,&__pyx_n_s_pyx_state,0};
+    PyObject* values[3] = {0,0,0};
+    if (unlikely(__pyx_kwds)) {
+      Py_ssize_t kw_args;
+      const Py_ssize_t pos_args = PyTuple_GET_SIZE(__pyx_args);
+      switch (pos_args) {
+        case  3: values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+        CYTHON_FALLTHROUGH;
+        case  2: values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+        CYTHON_FALLTHROUGH;
+        case  1: values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+        CYTHON_FALLTHROUGH;
+        case  0: break;
+        default: goto __pyx_L5_argtuple_error;
+      }
+      kw_args = PyDict_Size(__pyx_kwds);
+      switch (pos_args) {
+        case  0:
+        if (likely((values[0] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_pyx_type)) != 0)) kw_args--;
+        else goto __pyx_L5_argtuple_error;
+        CYTHON_FALLTHROUGH;
+        case  1:
+        if (likely((values[1] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_pyx_checksum)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Scipy", 1, 3, 3, 1); __PYX_ERR(1, 1, __pyx_L3_error)
+        }
+        CYTHON_FALLTHROUGH;
+        case  2:
+        if (likely((values[2] = __Pyx_PyDict_GetItemStr(__pyx_kwds, __pyx_n_s_pyx_state)) != 0)) kw_args--;
+        else {
+          __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Scipy", 1, 3, 3, 2); __PYX_ERR(1, 1, __pyx_L3_error)
+        }
+      }
+      if (unlikely(kw_args > 0)) {
+        if (unlikely(__Pyx_ParseOptionalKeywords(__pyx_kwds, __pyx_pyargnames, 0, values, pos_args, "__pyx_unpickle_Scipy") < 0)) __PYX_ERR(1, 1, __pyx_L3_error)
+      }
+    } else if (PyTuple_GET_SIZE(__pyx_args) != 3) {
+      goto __pyx_L5_argtuple_error;
+    } else {
+      values[0] = PyTuple_GET_ITEM(__pyx_args, 0);
+      values[1] = PyTuple_GET_ITEM(__pyx_args, 1);
+      values[2] = PyTuple_GET_ITEM(__pyx_args, 2);
+    }
+    __pyx_v___pyx_type = values[0];
+    __pyx_v___pyx_checksum = __Pyx_PyInt_As_long(values[1]); if (unlikely((__pyx_v___pyx_checksum == (long)-1) && PyErr_Occurred())) __PYX_ERR(1, 1, __pyx_L3_error)
+    __pyx_v___pyx_state = values[2];
+  }
+  goto __pyx_L4_argument_unpacking_done;
+  __pyx_L5_argtuple_error:;
+  __Pyx_RaiseArgtupleInvalid("__pyx_unpickle_Scipy", 1, 3, 3, PyTuple_GET_SIZE(__pyx_args)); __PYX_ERR(1, 1, __pyx_L3_error)
+  __pyx_L3_error:;
+  __Pyx_AddTraceback("tkwant.onebody.solvers.__pyx_unpickle_Scipy", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __Pyx_RefNannyFinishContext();
+  return NULL;
+  __pyx_L4_argument_unpacking_done:;
+  __pyx_r = __pyx_pf_6tkwant_7onebody_7solvers___pyx_unpickle_Scipy(__pyx_self, __pyx_v___pyx_type, __pyx_v___pyx_checksum, __pyx_v___pyx_state);
+
+  /* function exit code */
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_pf_6tkwant_7onebody_7solvers___pyx_unpickle_Scipy(CYTHON_UNUSED PyObject *__pyx_self, PyObject *__pyx_v___pyx_type, long __pyx_v___pyx_checksum, PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_v___pyx_PickleError = 0;
+  PyObject *__pyx_v___pyx_result = 0;
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  int __pyx_t_1;
+  PyObject *__pyx_t_2 = NULL;
+  PyObject *__pyx_t_3 = NULL;
+  PyObject *__pyx_t_4 = NULL;
+  PyObject *__pyx_t_5 = NULL;
+  int __pyx_t_6;
+  __Pyx_RefNannySetupContext("__pyx_unpickle_Scipy", 0);
+
+  /* "(tree fragment)":4
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
+ *     if __pyx_checksum != 0xdb28404:             # <<<<<<<<<<<<<<
+ *         from pickle import PickleError as __pyx_PickleError
+ *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xdb28404 = (_integrator, _rhs_out, rhs, size))" % __pyx_checksum)
+ */
+  __pyx_t_1 = ((__pyx_v___pyx_checksum != 0xdb28404) != 0);
+  if (__pyx_t_1) {
+
+    /* "(tree fragment)":5
+ *     cdef object __pyx_result
+ *     if __pyx_checksum != 0xdb28404:
+ *         from pickle import PickleError as __pyx_PickleError             # <<<<<<<<<<<<<<
+ *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xdb28404 = (_integrator, _rhs_out, rhs, size))" % __pyx_checksum)
+ *     __pyx_result = Scipy.__new__(__pyx_type)
+ */
+    __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_INCREF(__pyx_n_s_PickleError);
+    __Pyx_GIVEREF(__pyx_n_s_PickleError);
+    PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_s_PickleError);
+    __pyx_t_3 = __Pyx_Import(__pyx_n_s_pickle, __pyx_t_2, 0); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __pyx_t_2 = __Pyx_ImportFrom(__pyx_t_3, __pyx_n_s_PickleError); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 5, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __Pyx_INCREF(__pyx_t_2);
+    __pyx_v___pyx_PickleError = __pyx_t_2;
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+
+    /* "(tree fragment)":6
+ *     if __pyx_checksum != 0xdb28404:
+ *         from pickle import PickleError as __pyx_PickleError
+ *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xdb28404 = (_integrator, _rhs_out, rhs, size))" % __pyx_checksum)             # <<<<<<<<<<<<<<
+ *     __pyx_result = Scipy.__new__(__pyx_type)
+ *     if __pyx_state is not None:
+ */
+    __pyx_t_2 = __Pyx_PyInt_From_long(__pyx_v___pyx_checksum); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_2);
+    __pyx_t_4 = __Pyx_PyString_Format(__pyx_kp_s_Incompatible_checksums_s_vs_0xdb, __pyx_t_2); if (unlikely(!__pyx_t_4)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_4);
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_INCREF(__pyx_v___pyx_PickleError);
+    __pyx_t_2 = __pyx_v___pyx_PickleError; __pyx_t_5 = NULL;
+    if (CYTHON_UNPACK_METHODS && unlikely(PyMethod_Check(__pyx_t_2))) {
+      __pyx_t_5 = PyMethod_GET_SELF(__pyx_t_2);
+      if (likely(__pyx_t_5)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
+        __Pyx_INCREF(__pyx_t_5);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_2, function);
+      }
+    }
+    __pyx_t_3 = (__pyx_t_5) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_5, __pyx_t_4) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_t_4);
+    __Pyx_XDECREF(__pyx_t_5); __pyx_t_5 = 0;
+    __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
+    if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 6, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+    __Pyx_Raise(__pyx_t_3, 0, 0, 0);
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+    __PYX_ERR(1, 6, __pyx_L1_error)
+
+    /* "(tree fragment)":4
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
+ *     if __pyx_checksum != 0xdb28404:             # <<<<<<<<<<<<<<
+ *         from pickle import PickleError as __pyx_PickleError
+ *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xdb28404 = (_integrator, _rhs_out, rhs, size))" % __pyx_checksum)
+ */
+  }
+
+  /* "(tree fragment)":7
+ *         from pickle import PickleError as __pyx_PickleError
+ *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xdb28404 = (_integrator, _rhs_out, rhs, size))" % __pyx_checksum)
+ *     __pyx_result = Scipy.__new__(__pyx_type)             # <<<<<<<<<<<<<<
+ *     if __pyx_state is not None:
+ *         __pyx_unpickle_Scipy__set_state(<Scipy> __pyx_result, __pyx_state)
+ */
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_ptype_6tkwant_7onebody_7solvers_Scipy), __pyx_n_s_new); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_4 = NULL;
+  if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_2))) {
+    __pyx_t_4 = PyMethod_GET_SELF(__pyx_t_2);
+    if (likely(__pyx_t_4)) {
+      PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_2);
+      __Pyx_INCREF(__pyx_t_4);
+      __Pyx_INCREF(function);
+      __Pyx_DECREF_SET(__pyx_t_2, function);
+    }
+  }
+  __pyx_t_3 = (__pyx_t_4) ? __Pyx_PyObject_Call2Args(__pyx_t_2, __pyx_t_4, __pyx_v___pyx_type) : __Pyx_PyObject_CallOneArg(__pyx_t_2, __pyx_v___pyx_type);
+  __Pyx_XDECREF(__pyx_t_4); __pyx_t_4 = 0;
+  if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 7, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_3);
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_v___pyx_result = __pyx_t_3;
+  __pyx_t_3 = 0;
+
+  /* "(tree fragment)":8
+ *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xdb28404 = (_integrator, _rhs_out, rhs, size))" % __pyx_checksum)
+ *     __pyx_result = Scipy.__new__(__pyx_type)
+ *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
+ *         __pyx_unpickle_Scipy__set_state(<Scipy> __pyx_result, __pyx_state)
+ *     return __pyx_result
+ */
+  __pyx_t_1 = (__pyx_v___pyx_state != Py_None);
+  __pyx_t_6 = (__pyx_t_1 != 0);
+  if (__pyx_t_6) {
+
+    /* "(tree fragment)":9
+ *     __pyx_result = Scipy.__new__(__pyx_type)
+ *     if __pyx_state is not None:
+ *         __pyx_unpickle_Scipy__set_state(<Scipy> __pyx_result, __pyx_state)             # <<<<<<<<<<<<<<
+ *     return __pyx_result
+ * cdef __pyx_unpickle_Scipy__set_state(Scipy __pyx_result, tuple __pyx_state):
+ */
+    if (!(likely(PyTuple_CheckExact(__pyx_v___pyx_state))||((__pyx_v___pyx_state) == Py_None)||(PyErr_Format(PyExc_TypeError, "Expected %.16s, got %.200s", "tuple", Py_TYPE(__pyx_v___pyx_state)->tp_name), 0))) __PYX_ERR(1, 9, __pyx_L1_error)
+    __pyx_t_3 = __pyx_f_6tkwant_7onebody_7solvers___pyx_unpickle_Scipy__set_state(((struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)__pyx_v___pyx_result), ((PyObject*)__pyx_v___pyx_state)); if (unlikely(!__pyx_t_3)) __PYX_ERR(1, 9, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_3);
+    __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
+
+    /* "(tree fragment)":8
+ *         raise __pyx_PickleError("Incompatible checksums (%s vs 0xdb28404 = (_integrator, _rhs_out, rhs, size))" % __pyx_checksum)
+ *     __pyx_result = Scipy.__new__(__pyx_type)
+ *     if __pyx_state is not None:             # <<<<<<<<<<<<<<
+ *         __pyx_unpickle_Scipy__set_state(<Scipy> __pyx_result, __pyx_state)
+ *     return __pyx_result
+ */
+  }
+
+  /* "(tree fragment)":10
+ *     if __pyx_state is not None:
+ *         __pyx_unpickle_Scipy__set_state(<Scipy> __pyx_result, __pyx_state)
+ *     return __pyx_result             # <<<<<<<<<<<<<<
+ * cdef __pyx_unpickle_Scipy__set_state(Scipy __pyx_result, tuple __pyx_state):
+ *     __pyx_result._integrator = __pyx_state[0]; __pyx_result._rhs_out = __pyx_state[1]; __pyx_result.rhs = __pyx_state[2]; __pyx_result.size = __pyx_state[3]
+ */
+  __Pyx_XDECREF(__pyx_r);
+  __Pyx_INCREF(__pyx_v___pyx_result);
+  __pyx_r = __pyx_v___pyx_result;
+  goto __pyx_L0;
+
+  /* "(tree fragment)":1
+ * def __pyx_unpickle_Scipy(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
+ */
+
+  /* function exit code */
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_2);
+  __Pyx_XDECREF(__pyx_t_3);
+  __Pyx_XDECREF(__pyx_t_4);
+  __Pyx_XDECREF(__pyx_t_5);
+  __Pyx_AddTraceback("tkwant.onebody.solvers.__pyx_unpickle_Scipy", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = NULL;
+  __pyx_L0:;
+  __Pyx_XDECREF(__pyx_v___pyx_PickleError);
+  __Pyx_XDECREF(__pyx_v___pyx_result);
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+/* "(tree fragment)":11
+ *         __pyx_unpickle_Scipy__set_state(<Scipy> __pyx_result, __pyx_state)
+ *     return __pyx_result
+ * cdef __pyx_unpickle_Scipy__set_state(Scipy __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
+ *     __pyx_result._integrator = __pyx_state[0]; __pyx_result._rhs_out = __pyx_state[1]; __pyx_result.rhs = __pyx_state[2]; __pyx_result.size = __pyx_state[3]
+ *     if len(__pyx_state) > 4 and hasattr(__pyx_result, '__dict__'):
+ */
+
+static PyObject *__pyx_f_6tkwant_7onebody_7solvers___pyx_unpickle_Scipy__set_state(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *__pyx_v___pyx_result, PyObject *__pyx_v___pyx_state) {
+  PyObject *__pyx_r = NULL;
+  __Pyx_RefNannyDeclarations
+  PyObject *__pyx_t_1 = NULL;
+  int __pyx_t_2;
+  int __pyx_t_3;
+  Py_ssize_t __pyx_t_4;
+  int __pyx_t_5;
+  int __pyx_t_6;
+  PyObject *__pyx_t_7 = NULL;
+  PyObject *__pyx_t_8 = NULL;
+  PyObject *__pyx_t_9 = NULL;
+  __Pyx_RefNannySetupContext("__pyx_unpickle_Scipy__set_state", 0);
+
+  /* "(tree fragment)":12
+ *     return __pyx_result
+ * cdef __pyx_unpickle_Scipy__set_state(Scipy __pyx_result, tuple __pyx_state):
+ *     __pyx_result._integrator = __pyx_state[0]; __pyx_result._rhs_out = __pyx_state[1]; __pyx_result.rhs = __pyx_state[2]; __pyx_result.size = __pyx_state[3]             # <<<<<<<<<<<<<<
+ *     if len(__pyx_state) > 4 and hasattr(__pyx_result, '__dict__'):
+ *         __pyx_result.__dict__.update(__pyx_state[4])
+ */
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 0, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->_integrator);
+  __Pyx_DECREF(__pyx_v___pyx_result->_integrator);
+  __pyx_v___pyx_result->_integrator = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 1, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->_rhs_out);
+  __Pyx_DECREF(__pyx_v___pyx_result->_rhs_out);
+  __pyx_v___pyx_result->_rhs_out = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 2, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __Pyx_GIVEREF(__pyx_t_1);
+  __Pyx_GOTREF(__pyx_v___pyx_result->rhs);
+  __Pyx_DECREF(__pyx_v___pyx_result->rhs);
+  __pyx_v___pyx_result->rhs = __pyx_t_1;
+  __pyx_t_1 = 0;
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+    __PYX_ERR(1, 12, __pyx_L1_error)
+  }
+  __pyx_t_1 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 3, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
+  __pyx_t_2 = __Pyx_PyInt_As_int(__pyx_t_1); if (unlikely((__pyx_t_2 == (int)-1) && PyErr_Occurred())) __PYX_ERR(1, 12, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_v___pyx_result->size = __pyx_t_2;
+
+  /* "(tree fragment)":13
+ * cdef __pyx_unpickle_Scipy__set_state(Scipy __pyx_result, tuple __pyx_state):
+ *     __pyx_result._integrator = __pyx_state[0]; __pyx_result._rhs_out = __pyx_state[1]; __pyx_result.rhs = __pyx_state[2]; __pyx_result.size = __pyx_state[3]
+ *     if len(__pyx_state) > 4 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
+ *         __pyx_result.__dict__.update(__pyx_state[4])
+ */
+  if (unlikely(__pyx_v___pyx_state == Py_None)) {
+    PyErr_SetString(PyExc_TypeError, "object of type 'NoneType' has no len()");
+    __PYX_ERR(1, 13, __pyx_L1_error)
+  }
+  __pyx_t_4 = PyTuple_GET_SIZE(__pyx_v___pyx_state); if (unlikely(__pyx_t_4 == ((Py_ssize_t)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
+  __pyx_t_5 = ((__pyx_t_4 > 4) != 0);
+  if (__pyx_t_5) {
+  } else {
+    __pyx_t_3 = __pyx_t_5;
+    goto __pyx_L4_bool_binop_done;
+  }
+  __pyx_t_5 = __Pyx_HasAttr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(__pyx_t_5 == ((int)-1))) __PYX_ERR(1, 13, __pyx_L1_error)
+  __pyx_t_6 = (__pyx_t_5 != 0);
+  __pyx_t_3 = __pyx_t_6;
+  __pyx_L4_bool_binop_done:;
+  if (__pyx_t_3) {
+
+    /* "(tree fragment)":14
+ *     __pyx_result._integrator = __pyx_state[0]; __pyx_result._rhs_out = __pyx_state[1]; __pyx_result.rhs = __pyx_state[2]; __pyx_result.size = __pyx_state[3]
+ *     if len(__pyx_state) > 4 and hasattr(__pyx_result, '__dict__'):
+ *         __pyx_result.__dict__.update(__pyx_state[4])             # <<<<<<<<<<<<<<
+ */
+    __pyx_t_7 = __Pyx_PyObject_GetAttrStr(((PyObject *)__pyx_v___pyx_result), __pyx_n_s_dict); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    __pyx_t_8 = __Pyx_PyObject_GetAttrStr(__pyx_t_7, __pyx_n_s_update); if (unlikely(!__pyx_t_8)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_8);
+    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    if (unlikely(__pyx_v___pyx_state == Py_None)) {
+      PyErr_SetString(PyExc_TypeError, "'NoneType' object is not subscriptable");
+      __PYX_ERR(1, 14, __pyx_L1_error)
+    }
+    __pyx_t_7 = __Pyx_GetItemInt_Tuple(__pyx_v___pyx_state, 4, long, 1, __Pyx_PyInt_From_long, 0, 0, 1); if (unlikely(!__pyx_t_7)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_7);
+    __pyx_t_9 = NULL;
+    if (CYTHON_UNPACK_METHODS && likely(PyMethod_Check(__pyx_t_8))) {
+      __pyx_t_9 = PyMethod_GET_SELF(__pyx_t_8);
+      if (likely(__pyx_t_9)) {
+        PyObject* function = PyMethod_GET_FUNCTION(__pyx_t_8);
+        __Pyx_INCREF(__pyx_t_9);
+        __Pyx_INCREF(function);
+        __Pyx_DECREF_SET(__pyx_t_8, function);
+      }
+    }
+    __pyx_t_1 = (__pyx_t_9) ? __Pyx_PyObject_Call2Args(__pyx_t_8, __pyx_t_9, __pyx_t_7) : __Pyx_PyObject_CallOneArg(__pyx_t_8, __pyx_t_7);
+    __Pyx_XDECREF(__pyx_t_9); __pyx_t_9 = 0;
+    __Pyx_DECREF(__pyx_t_7); __pyx_t_7 = 0;
+    if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 14, __pyx_L1_error)
+    __Pyx_GOTREF(__pyx_t_1);
+    __Pyx_DECREF(__pyx_t_8); __pyx_t_8 = 0;
+    __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+
+    /* "(tree fragment)":13
+ * cdef __pyx_unpickle_Scipy__set_state(Scipy __pyx_result, tuple __pyx_state):
+ *     __pyx_result._integrator = __pyx_state[0]; __pyx_result._rhs_out = __pyx_state[1]; __pyx_result.rhs = __pyx_state[2]; __pyx_result.size = __pyx_state[3]
+ *     if len(__pyx_state) > 4 and hasattr(__pyx_result, '__dict__'):             # <<<<<<<<<<<<<<
+ *         __pyx_result.__dict__.update(__pyx_state[4])
+ */
+  }
+
+  /* "(tree fragment)":11
+ *         __pyx_unpickle_Scipy__set_state(<Scipy> __pyx_result, __pyx_state)
+ *     return __pyx_result
+ * cdef __pyx_unpickle_Scipy__set_state(Scipy __pyx_result, tuple __pyx_state):             # <<<<<<<<<<<<<<
+ *     __pyx_result._integrator = __pyx_state[0]; __pyx_result._rhs_out = __pyx_state[1]; __pyx_result.rhs = __pyx_state[2]; __pyx_result.size = __pyx_state[3]
+ *     if len(__pyx_state) > 4 and hasattr(__pyx_result, '__dict__'):
+ */
+
+  /* function exit code */
+  __pyx_r = Py_None; __Pyx_INCREF(Py_None);
+  goto __pyx_L0;
+  __pyx_L1_error:;
+  __Pyx_XDECREF(__pyx_t_1);
+  __Pyx_XDECREF(__pyx_t_7);
+  __Pyx_XDECREF(__pyx_t_8);
+  __Pyx_XDECREF(__pyx_t_9);
+  __Pyx_AddTraceback("tkwant.onebody.solvers.__pyx_unpickle_Scipy__set_state", __pyx_clineno, __pyx_lineno, __pyx_filename);
+  __pyx_r = 0;
+  __pyx_L0:;
+  __Pyx_XGIVEREF(__pyx_r);
+  __Pyx_RefNannyFinishContext();
+  return __pyx_r;
+}
+
+static PyObject *__pyx_tp_new_6tkwant_7onebody_7solvers_Scipy(PyTypeObject *t, CYTHON_UNUSED PyObject *a, CYTHON_UNUSED PyObject *k) {
+  struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *p;
+  PyObject *o;
+  if (likely((t->tp_flags & Py_TPFLAGS_IS_ABSTRACT) == 0)) {
+    o = (*t->tp_alloc)(t, 0);
+  } else {
+    o = (PyObject *) PyBaseObject_Type.tp_new(t, __pyx_empty_tuple, 0);
+  }
+  if (unlikely(!o)) return 0;
+  p = ((struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)o);
+  p->_integrator = Py_None; Py_INCREF(Py_None);
+  p->_rhs_out = Py_None; Py_INCREF(Py_None);
+  p->rhs = Py_None; Py_INCREF(Py_None);
+  return o;
+}
+
+static void __pyx_tp_dealloc_6tkwant_7onebody_7solvers_Scipy(PyObject *o) {
+  struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *p = (struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)o;
+  #if CYTHON_USE_TP_FINALIZE
+  if (unlikely(PyType_HasFeature(Py_TYPE(o), Py_TPFLAGS_HAVE_FINALIZE) && Py_TYPE(o)->tp_finalize) && !_PyGC_FINALIZED(o)) {
+    if (PyObject_CallFinalizerFromDealloc(o)) return;
+  }
+  #endif
+  PyObject_GC_UnTrack(o);
+  Py_CLEAR(p->_integrator);
+  Py_CLEAR(p->_rhs_out);
+  Py_CLEAR(p->rhs);
+  (*Py_TYPE(o)->tp_free)(o);
+}
+
+static int __pyx_tp_traverse_6tkwant_7onebody_7solvers_Scipy(PyObject *o, visitproc v, void *a) {
+  int e;
+  struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *p = (struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)o;
+  if (p->_integrator) {
+    e = (*v)(p->_integrator, a); if (e) return e;
+  }
+  if (p->_rhs_out) {
+    e = (*v)(p->_rhs_out, a); if (e) return e;
+  }
+  if (p->rhs) {
+    e = (*v)(p->rhs, a); if (e) return e;
+  }
+  return 0;
+}
+
+static int __pyx_tp_clear_6tkwant_7onebody_7solvers_Scipy(PyObject *o) {
+  PyObject* tmp;
+  struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *p = (struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy *)o;
+  tmp = ((PyObject*)p->_integrator);
+  p->_integrator = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->_rhs_out);
+  p->_rhs_out = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  tmp = ((PyObject*)p->rhs);
+  p->rhs = Py_None; Py_INCREF(Py_None);
+  Py_XDECREF(tmp);
+  return 0;
+}
+
+static PyObject *__pyx_getprop_6tkwant_7onebody_7solvers_5Scipy_size(PyObject *o, CYTHON_UNUSED void *x) {
+  return __pyx_pw_6tkwant_7onebody_7solvers_5Scipy_4size_1__get__(o);
+}
+
+static PyMethodDef __pyx_methods_6tkwant_7onebody_7solvers_Scipy[] = {
+  {"_rhs", (PyCFunction)(void*)(PyCFunctionWithKeywords)__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_3_rhs, METH_VARARGS|METH_KEYWORDS, 0},
+  {"__reduce_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_7__reduce_cython__, METH_NOARGS, 0},
+  {"__setstate_cython__", (PyCFunction)__pyx_pw_6tkwant_7onebody_7solvers_5Scipy_9__setstate_cython__, METH_O, 0},
+  {0, 0, 0, 0}
+};
+
+static struct PyGetSetDef __pyx_getsets_6tkwant_7onebody_7solvers_Scipy[] = {
+  {(char *)"size", __pyx_getprop_6tkwant_7onebody_7solvers_5Scipy_size, 0, (char *)0, 0},
+  {0, 0, 0, 0, 0}
+};
+
+static PyTypeObject __pyx_type_6tkwant_7onebody_7solvers_Scipy = {
+  PyVarObject_HEAD_INIT(0, 0)
+  "tkwant.onebody.solvers.Scipy", /*tp_name*/
+  sizeof(struct __pyx_obj_6tkwant_7onebody_7solvers_Scipy), /*tp_basicsize*/
+  0, /*tp_itemsize*/
+  __pyx_tp_dealloc_6tkwant_7onebody_7solvers_Scipy, /*tp_dealloc*/
+  #if PY_VERSION_HEX < 0x030800b4
+  0, /*tp_print*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4
+  0, /*tp_vectorcall_offset*/
+  #endif
+  0, /*tp_getattr*/
+  0, /*tp_setattr*/
+  #if PY_MAJOR_VERSION < 3
+  0, /*tp_compare*/
+  #endif
+  #if PY_MAJOR_VERSION >= 3
+  0, /*tp_as_async*/
+  #endif
+  0, /*tp_repr*/
+  0, /*tp_as_number*/
+  0, /*tp_as_sequence*/
+  0, /*tp_as_mapping*/
+  0, /*tp_hash*/
+  __pyx_pw_6tkwant_7onebody_7solvers_5Scipy_5__call__, /*tp_call*/
+  0, /*tp_str*/
+  0, /*tp_getattro*/
+  0, /*tp_setattro*/
+  0, /*tp_as_buffer*/
+  Py_TPFLAGS_DEFAULT|Py_TPFLAGS_HAVE_VERSION_TAG|Py_TPFLAGS_CHECKTYPES|Py_TPFLAGS_HAVE_NEWBUFFER|Py_TPFLAGS_BASETYPE|Py_TPFLAGS_HAVE_GC, /*tp_flags*/
+  "Solve the time-dependent Schr\303\266dinger equation using `scipy.integrate`.\n\n    This solver will currently only work with the 'dopri5' and 'dop853'\n    integrators, as these are the only re-entrant ones.\n\n    Parameters\n    ----------\n    size : int\n        The size of the ``psi`` vector.\n    integrator : `scipy.integrate._ode.IntegratorBase`, default: dopri5\n        The integrator to use with this solver.\n    **integrator_options\n        Options to pass when instantiating the integrator.\n\n    See Also\n    --------\n    scipy.integrate.ode\n    ", /*tp_doc*/
+  __pyx_tp_traverse_6tkwant_7onebody_7solvers_Scipy, /*tp_traverse*/
+  __pyx_tp_clear_6tkwant_7onebody_7solvers_Scipy, /*tp_clear*/
+  0, /*tp_richcompare*/
+  0, /*tp_weaklistoffset*/
+  0, /*tp_iter*/
+  0, /*tp_iternext*/
+  __pyx_methods_6tkwant_7onebody_7solvers_Scipy, /*tp_methods*/
+  0, /*tp_members*/
+  __pyx_getsets_6tkwant_7onebody_7solvers_Scipy, /*tp_getset*/
+  0, /*tp_base*/
+  0, /*tp_dict*/
+  0, /*tp_descr_get*/
+  0, /*tp_descr_set*/
+  0, /*tp_dictoffset*/
+  __pyx_pw_6tkwant_7onebody_7solvers_5Scipy_1__init__, /*tp_init*/
+  0, /*tp_alloc*/
+  __pyx_tp_new_6tkwant_7onebody_7solvers_Scipy, /*tp_new*/
+  0, /*tp_free*/
+  0, /*tp_is_gc*/
+  0, /*tp_bases*/
+  0, /*tp_mro*/
+  0, /*tp_cache*/
+  0, /*tp_subclasses*/
+  0, /*tp_weaklist*/
+  0, /*tp_del*/
+  0, /*tp_version_tag*/
+  #if PY_VERSION_HEX >= 0x030400a1
+  0, /*tp_finalize*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b1
+  0, /*tp_vectorcall*/
+  #endif
+  #if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+  0, /*tp_print*/
+  #endif
+};
+
 static PyMethodDef __pyx_methods[] = {
   {0, 0, 0, 0}
 };
 
 #if PY_MAJOR_VERSION >= 3
 #if CYTHON_PEP489_MULTI_PHASE_INIT
 static PyObject* __pyx_pymod_create(PyObject *spec, PyModuleDef *def); /*proto*/
@@ -2592,139 +3342,110 @@
     #define CYTHON_SMALL_CODE __attribute__((cold))
 #else
     #define CYTHON_SMALL_CODE
 #endif
 #endif
 
 static __Pyx_StringTabEntry __pyx_string_tab[] = {
-  {&__pyx_n_s_, __pyx_k_, sizeof(__pyx_k_), 0, 0, 1, 1},
+  {&__pyx_kp_s_Incompatible_checksums_s_vs_0xdb, __pyx_k_Incompatible_checksums_s_vs_0xdb, sizeof(__pyx_k_Incompatible_checksums_s_vs_0xdb), 0, 0, 1, 0},
   {&__pyx_kp_u_Integration_failed_between_and, __pyx_k_Integration_failed_between_and, sizeof(__pyx_k_Integration_failed_between_and), 0, 1, 0, 0},
+  {&__pyx_n_s_PickleError, __pyx_k_PickleError, sizeof(__pyx_k_PickleError), 0, 0, 1, 1},
   {&__pyx_n_s_RuntimeError, __pyx_k_RuntimeError, sizeof(__pyx_k_RuntimeError), 0, 0, 1, 1},
   {&__pyx_n_s_Scipy, __pyx_k_Scipy, sizeof(__pyx_k_Scipy), 0, 0, 1, 1},
   {&__pyx_n_u_Scipy, __pyx_k_Scipy, sizeof(__pyx_k_Scipy), 0, 1, 0, 1},
-  {&__pyx_n_s_Scipy___call, __pyx_k_Scipy___call, sizeof(__pyx_k_Scipy___call), 0, 0, 1, 1},
-  {&__pyx_n_s_Scipy___call___locals_lambda, __pyx_k_Scipy___call___locals_lambda, sizeof(__pyx_k_Scipy___call___locals_lambda), 0, 0, 1, 1},
-  {&__pyx_n_s_Scipy___init, __pyx_k_Scipy___init, sizeof(__pyx_k_Scipy___init), 0, 0, 1, 1},
-  {&__pyx_n_s_Scipy__rhs, __pyx_k_Scipy__rhs, sizeof(__pyx_k_Scipy__rhs), 0, 0, 1, 1},
-  {&__pyx_kp_s_Solve_the_time_dependent_Schrdin, __pyx_k_Solve_the_time_dependent_Schrdin, sizeof(__pyx_k_Solve_the_time_dependent_Schrdin), 0, 0, 1, 0},
   {&__pyx_n_s_all, __pyx_k_all, sizeof(__pyx_k_all), 0, 0, 1, 1},
   {&__pyx_n_u_atol, __pyx_k_atol, sizeof(__pyx_k_atol), 0, 1, 0, 1},
-  {&__pyx_n_s_call, __pyx_k_call, sizeof(__pyx_k_call), 0, 0, 1, 1},
+  {&__pyx_n_s_call___locals_lambda, __pyx_k_call___locals_lambda, sizeof(__pyx_k_call___locals_lambda), 0, 0, 1, 1},
   {&__pyx_n_s_cline_in_traceback, __pyx_k_cline_in_traceback, sizeof(__pyx_k_cline_in_traceback), 0, 0, 1, 1},
   {&__pyx_n_s_default, __pyx_k_default, sizeof(__pyx_k_default), 0, 0, 1, 1},
   {&__pyx_n_s_default_options, __pyx_k_default_options, sizeof(__pyx_k_default_options), 0, 0, 1, 1},
-  {&__pyx_n_s_doc, __pyx_k_doc, sizeof(__pyx_k_doc), 0, 0, 1, 1},
+  {&__pyx_n_s_dict, __pyx_k_dict, sizeof(__pyx_k_dict), 0, 0, 1, 1},
   {&__pyx_n_s_dopri5, __pyx_k_dopri5, sizeof(__pyx_k_dopri5), 0, 0, 1, 1},
   {&__pyx_n_s_dtype, __pyx_k_dtype, sizeof(__pyx_k_dtype), 0, 0, 1, 1},
   {&__pyx_n_s_empty, __pyx_k_empty, sizeof(__pyx_k_empty), 0, 0, 1, 1},
-  {&__pyx_n_s_final_time, __pyx_k_final_time, sizeof(__pyx_k_final_time), 0, 0, 1, 1},
   {&__pyx_n_s_format, __pyx_k_format, sizeof(__pyx_k_format), 0, 0, 1, 1},
+  {&__pyx_n_s_getstate, __pyx_k_getstate, sizeof(__pyx_k_getstate), 0, 0, 1, 1},
   {&__pyx_n_s_has_jac, __pyx_k_has_jac, sizeof(__pyx_k_has_jac), 0, 0, 1, 1},
   {&__pyx_n_s_import, __pyx_k_import, sizeof(__pyx_k_import), 0, 0, 1, 1},
-  {&__pyx_n_s_init, __pyx_k_init, sizeof(__pyx_k_init), 0, 0, 1, 1},
   {&__pyx_n_s_integrate, __pyx_k_integrate, sizeof(__pyx_k_integrate), 0, 0, 1, 1},
   {&__pyx_n_s_integrator, __pyx_k_integrator, sizeof(__pyx_k_integrator), 0, 0, 1, 1},
-  {&__pyx_n_s_integrator_2, __pyx_k_integrator_2, sizeof(__pyx_k_integrator_2), 0, 0, 1, 1},
-  {&__pyx_n_s_integrator_options, __pyx_k_integrator_options, sizeof(__pyx_k_integrator_options), 0, 0, 1, 1},
-  {&__pyx_n_s_kernel, __pyx_k_kernel, sizeof(__pyx_k_kernel), 0, 0, 1, 1},
-  {&__pyx_n_s_kernels, __pyx_k_kernels, sizeof(__pyx_k_kernels), 0, 0, 1, 1},
   {&__pyx_n_s_main, __pyx_k_main, sizeof(__pyx_k_main), 0, 0, 1, 1},
-  {&__pyx_n_s_metaclass, __pyx_k_metaclass, sizeof(__pyx_k_metaclass), 0, 0, 1, 1},
-  {&__pyx_n_s_module, __pyx_k_module, sizeof(__pyx_k_module), 0, 0, 1, 1},
   {&__pyx_n_s_name, __pyx_k_name, sizeof(__pyx_k_name), 0, 0, 1, 1},
-  {&__pyx_n_s_next_psi, __pyx_k_next_psi, sizeof(__pyx_k_next_psi), 0, 0, 1, 1},
+  {&__pyx_n_s_new, __pyx_k_new, sizeof(__pyx_k_new), 0, 0, 1, 1},
   {&__pyx_n_s_next_time, __pyx_k_next_time, sizeof(__pyx_k_next_time), 0, 0, 1, 1},
   {&__pyx_n_s_np, __pyx_k_np, sizeof(__pyx_k_np), 0, 0, 1, 1},
   {&__pyx_n_u_nsteps, __pyx_k_nsteps, sizeof(__pyx_k_nsteps), 0, 1, 0, 1},
   {&__pyx_n_s_numpy, __pyx_k_numpy, sizeof(__pyx_k_numpy), 0, 0, 1, 1},
   {&__pyx_n_s_ode, __pyx_k_ode, sizeof(__pyx_k_ode), 0, 0, 1, 1},
-  {&__pyx_n_s_options, __pyx_k_options, sizeof(__pyx_k_options), 0, 0, 1, 1},
-  {&__pyx_n_s_prepare, __pyx_k_prepare, sizeof(__pyx_k_prepare), 0, 0, 1, 1},
+  {&__pyx_n_s_pickle, __pyx_k_pickle, sizeof(__pyx_k_pickle), 0, 0, 1, 1},
   {&__pyx_n_s_psi, __pyx_k_psi, sizeof(__pyx_k_psi), 0, 0, 1, 1},
-  {&__pyx_n_s_qualname, __pyx_k_qualname, sizeof(__pyx_k_qualname), 0, 0, 1, 1},
+  {&__pyx_n_s_pyx_PickleError, __pyx_k_pyx_PickleError, sizeof(__pyx_k_pyx_PickleError), 0, 0, 1, 1},
+  {&__pyx_n_s_pyx_checksum, __pyx_k_pyx_checksum, sizeof(__pyx_k_pyx_checksum), 0, 0, 1, 1},
+  {&__pyx_n_s_pyx_result, __pyx_k_pyx_result, sizeof(__pyx_k_pyx_result), 0, 0, 1, 1},
+  {&__pyx_n_s_pyx_state, __pyx_k_pyx_state, sizeof(__pyx_k_pyx_state), 0, 0, 1, 1},
+  {&__pyx_n_s_pyx_type, __pyx_k_pyx_type, sizeof(__pyx_k_pyx_type), 0, 0, 1, 1},
+  {&__pyx_n_s_pyx_unpickle_Scipy, __pyx_k_pyx_unpickle_Scipy, sizeof(__pyx_k_pyx_unpickle_Scipy), 0, 0, 1, 1},
+  {&__pyx_n_s_reduce, __pyx_k_reduce, sizeof(__pyx_k_reduce), 0, 0, 1, 1},
+  {&__pyx_n_s_reduce_cython, __pyx_k_reduce_cython, sizeof(__pyx_k_reduce_cython), 0, 0, 1, 1},
+  {&__pyx_n_s_reduce_ex, __pyx_k_reduce_ex, sizeof(__pyx_k_reduce_ex), 0, 0, 1, 1},
   {&__pyx_n_s_reset, __pyx_k_reset, sizeof(__pyx_k_reset), 0, 0, 1, 1},
   {&__pyx_n_s_rhs, __pyx_k_rhs, sizeof(__pyx_k_rhs), 0, 0, 1, 1},
   {&__pyx_n_s_rhs_2, __pyx_k_rhs_2, sizeof(__pyx_k_rhs_2), 0, 0, 1, 1},
-  {&__pyx_n_s_rhs_out, __pyx_k_rhs_out, sizeof(__pyx_k_rhs_out), 0, 0, 1, 1},
   {&__pyx_n_u_rtol, __pyx_k_rtol, sizeof(__pyx_k_rtol), 0, 1, 0, 1},
   {&__pyx_n_s_run, __pyx_k_run, sizeof(__pyx_k_run), 0, 0, 1, 1},
   {&__pyx_n_s_scipy, __pyx_k_scipy, sizeof(__pyx_k_scipy), 0, 0, 1, 1},
   {&__pyx_n_s_scipy_integrate, __pyx_k_scipy_integrate, sizeof(__pyx_k_scipy_integrate), 0, 0, 1, 1},
-  {&__pyx_n_s_self, __pyx_k_self, sizeof(__pyx_k_self), 0, 0, 1, 1},
+  {&__pyx_n_s_setstate, __pyx_k_setstate, sizeof(__pyx_k_setstate), 0, 0, 1, 1},
+  {&__pyx_n_s_setstate_cython, __pyx_k_setstate_cython, sizeof(__pyx_k_setstate_cython), 0, 0, 1, 1},
   {&__pyx_n_s_size, __pyx_k_size, sizeof(__pyx_k_size), 0, 0, 1, 1},
+  {&__pyx_kp_s_stringsource, __pyx_k_stringsource, sizeof(__pyx_k_stringsource), 0, 0, 1, 0},
   {&__pyx_n_s_success, __pyx_k_success, sizeof(__pyx_k_success), 0, 0, 1, 1},
   {&__pyx_n_s_t, __pyx_k_t, sizeof(__pyx_k_t), 0, 0, 1, 1},
   {&__pyx_n_s_test, __pyx_k_test, sizeof(__pyx_k_test), 0, 0, 1, 1},
   {&__pyx_n_s_time, __pyx_k_time, sizeof(__pyx_k_time), 0, 0, 1, 1},
   {&__pyx_n_s_tkwant_onebody_solvers, __pyx_k_tkwant_onebody_solvers, sizeof(__pyx_k_tkwant_onebody_solvers), 0, 0, 1, 1},
-  {&__pyx_kp_s_tkwant_onebody_solvers_pyx, __pyx_k_tkwant_onebody_solvers_pyx, sizeof(__pyx_k_tkwant_onebody_solvers_pyx), 0, 0, 1, 0},
   {&__pyx_n_s_update, __pyx_k_update, sizeof(__pyx_k_update), 0, 0, 1, 1},
   {&__pyx_n_s_view, __pyx_k_view, sizeof(__pyx_k_view), 0, 0, 1, 1},
   {&__pyx_n_s_y, __pyx_k_y, sizeof(__pyx_k_y), 0, 0, 1, 1},
   {0, 0, 0, 0, 0, 0, 0}
 };
 static CYTHON_SMALL_CODE int __Pyx_InitCachedBuiltins(void) {
-  __pyx_builtin_RuntimeError = __Pyx_GetBuiltinName(__pyx_n_s_RuntimeError); if (!__pyx_builtin_RuntimeError) __PYX_ERR(0, 66, __pyx_L1_error)
+  __pyx_builtin_RuntimeError = __Pyx_GetBuiltinName(__pyx_n_s_RuntimeError); if (!__pyx_builtin_RuntimeError) __PYX_ERR(0, 72, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 
 static CYTHON_SMALL_CODE int __Pyx_InitCachedConstants(void) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__Pyx_InitCachedConstants", 0);
 
-  /* "tkwant/onebody/solvers.pyx":43
- *     _default_options = {'atol': 1E-9, 'rtol': 1E-9, 'nsteps': int(1E9)}
- * 
- *     def __init__(self, kernel, integrator=scipy.integrate._ode.dopri5, **integrator_options):             # <<<<<<<<<<<<<<
- *         self.kernel = kernel
- *         # allocate storage for kernel output
+  /* "(tree fragment)":1
+ * def __pyx_unpickle_Scipy(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
  */
-  __pyx_tuple__2 = PyTuple_Pack(5, __pyx_n_s_self, __pyx_n_s_kernel, __pyx_n_s_integrator, __pyx_n_s_integrator_options, __pyx_n_s_options); if (unlikely(!__pyx_tuple__2)) __PYX_ERR(0, 43, __pyx_L1_error)
+  __pyx_tuple__2 = PyTuple_Pack(5, __pyx_n_s_pyx_type, __pyx_n_s_pyx_checksum, __pyx_n_s_pyx_state, __pyx_n_s_pyx_PickleError, __pyx_n_s_pyx_result); if (unlikely(!__pyx_tuple__2)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_tuple__2);
   __Pyx_GIVEREF(__pyx_tuple__2);
-  __pyx_codeobj__3 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS|CO_VARKEYWORDS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__2, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_solvers_pyx, __pyx_n_s_init, 43, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__3)) __PYX_ERR(0, 43, __pyx_L1_error)
-
-  /* "tkwant/onebody/solvers.pyx":54
- *         self._integrator.reset(2 * self.kernel.size, has_jac=False)
- * 
- *     def _rhs(self, t, y):             # <<<<<<<<<<<<<<
- *         # Kernel expects complex, Scipy expects real
- *         self.kernel.rhs(y.view(complex), self._rhs_out, t)
- */
-  __pyx_tuple__4 = PyTuple_Pack(3, __pyx_n_s_self, __pyx_n_s_t, __pyx_n_s_y); if (unlikely(!__pyx_tuple__4)) __PYX_ERR(0, 54, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__4);
-  __Pyx_GIVEREF(__pyx_tuple__4);
-  __pyx_codeobj__5 = (PyObject*)__Pyx_PyCode_New(3, 0, 3, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__4, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_solvers_pyx, __pyx_n_s_rhs_2, 54, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__5)) __PYX_ERR(0, 54, __pyx_L1_error)
-
-  /* "tkwant/onebody/solvers.pyx":59
- *         return self._rhs_out.view(float)
- * 
- *     def __call__(self, psi, time, next_time):             # <<<<<<<<<<<<<<
- *         if time == next_time:
- *             return psi
- */
-  __pyx_tuple__6 = PyTuple_Pack(6, __pyx_n_s_self, __pyx_n_s_psi, __pyx_n_s_time, __pyx_n_s_next_time, __pyx_n_s_next_psi, __pyx_n_s_final_time); if (unlikely(!__pyx_tuple__6)) __PYX_ERR(0, 59, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_tuple__6);
-  __Pyx_GIVEREF(__pyx_tuple__6);
-  __pyx_codeobj__7 = (PyObject*)__Pyx_PyCode_New(4, 0, 6, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__6, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_tkwant_onebody_solvers_pyx, __pyx_n_s_call, 59, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__7)) __PYX_ERR(0, 59, __pyx_L1_error)
+  __pyx_codeobj__3 = (PyObject*)__Pyx_PyCode_New(3, 0, 5, 0, CO_OPTIMIZED|CO_NEWLOCALS, __pyx_empty_bytes, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_tuple__2, __pyx_empty_tuple, __pyx_empty_tuple, __pyx_kp_s_stringsource, __pyx_n_s_pyx_unpickle_Scipy, 1, __pyx_empty_bytes); if (unlikely(!__pyx_codeobj__3)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_RefNannyFinishContext();
   return 0;
   __pyx_L1_error:;
   __Pyx_RefNannyFinishContext();
   return -1;
 }
 
 static CYTHON_SMALL_CODE int __Pyx_InitGlobals(void) {
   __pyx_umethod_PyDict_Type_update.type = (PyObject*)&PyDict_Type;
   if (__Pyx_InitStrings(__pyx_string_tab) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   __pyx_float_1E9 = PyFloat_FromDouble(1E9); if (unlikely(!__pyx_float_1E9)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_float_1Eneg_9 = PyFloat_FromDouble(1E-9); if (unlikely(!__pyx_float_1Eneg_9)) __PYX_ERR(0, 1, __pyx_L1_error)
   __pyx_int_2 = PyInt_FromLong(2); if (unlikely(!__pyx_int_2)) __PYX_ERR(0, 1, __pyx_L1_error)
+  __pyx_int_229803012 = PyInt_FromLong(229803012L); if (unlikely(!__pyx_int_229803012)) __PYX_ERR(0, 1, __pyx_L1_error)
   return 0;
   __pyx_L1_error:;
   return -1;
 }
 
 static CYTHON_SMALL_CODE int __Pyx_modinit_global_init_code(void); /*proto*/
 static CYTHON_SMALL_CODE int __Pyx_modinit_variable_export_code(void); /*proto*/
@@ -2758,36 +3479,37 @@
   return 0;
 }
 
 static int __Pyx_modinit_type_init_code(void) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_init_code", 0);
   /*--- Type init code ---*/
+  if (PyType_Ready(&__pyx_type_6tkwant_7onebody_7solvers_Scipy) < 0) __PYX_ERR(0, 20, __pyx_L1_error)
+  #if PY_VERSION_HEX < 0x030800B1
+  __pyx_type_6tkwant_7onebody_7solvers_Scipy.tp_print = 0;
+  #endif
+  if ((CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP) && likely(!__pyx_type_6tkwant_7onebody_7solvers_Scipy.tp_dictoffset && __pyx_type_6tkwant_7onebody_7solvers_Scipy.tp_getattro == PyObject_GenericGetAttr)) {
+    __pyx_type_6tkwant_7onebody_7solvers_Scipy.tp_getattro = __Pyx_PyObject_GenericGetAttr;
+  }
+  if (PyObject_SetAttr(__pyx_m, __pyx_n_s_Scipy, (PyObject *)&__pyx_type_6tkwant_7onebody_7solvers_Scipy) < 0) __PYX_ERR(0, 20, __pyx_L1_error)
+  if (__Pyx_setup_reduce((PyObject*)&__pyx_type_6tkwant_7onebody_7solvers_Scipy) < 0) __PYX_ERR(0, 20, __pyx_L1_error)
+  __pyx_ptype_6tkwant_7onebody_7solvers_Scipy = &__pyx_type_6tkwant_7onebody_7solvers_Scipy;
   __Pyx_RefNannyFinishContext();
   return 0;
+  __pyx_L1_error:;
+  __Pyx_RefNannyFinishContext();
+  return -1;
 }
 
 static int __Pyx_modinit_type_import_code(void) {
   __Pyx_RefNannyDeclarations
-  PyObject *__pyx_t_1 = NULL;
   __Pyx_RefNannySetupContext("__Pyx_modinit_type_import_code", 0);
   /*--- Type import code ---*/
-  __pyx_t_1 = PyImport_ImportModule("tkwant.onebody.kernels"); if (unlikely(!__pyx_t_1)) __PYX_ERR(1, 14, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  __pyx_ptype_6tkwant_7onebody_7kernels_Kernel = __Pyx_ImportType(__pyx_t_1, "tkwant.onebody.kernels", "Kernel", sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_Kernel), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_6tkwant_7onebody_7kernels_Kernel) __PYX_ERR(1, 14, __pyx_L1_error)
-  __pyx_ptype_6tkwant_7onebody_7kernels_CKernel = __Pyx_ImportType(__pyx_t_1, "tkwant.onebody.kernels", "CKernel", sizeof(struct __pyx_obj_6tkwant_7onebody_7kernels_CKernel), __Pyx_ImportType_CheckSize_Warn);
-   if (!__pyx_ptype_6tkwant_7onebody_7kernels_CKernel) __PYX_ERR(1, 22, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
   __Pyx_RefNannyFinishContext();
   return 0;
-  __pyx_L1_error:;
-  __Pyx_XDECREF(__pyx_t_1);
-  __Pyx_RefNannyFinishContext();
-  return -1;
 }
 
 static int __Pyx_modinit_variable_import_code(void) {
   __Pyx_RefNannyDeclarations
   __Pyx_RefNannySetupContext("__Pyx_modinit_variable_import_code", 0);
   /*--- Variable import code ---*/
   __Pyx_RefNannyFinishContext();
@@ -2892,16 +3614,14 @@
 
 static CYTHON_SMALL_CODE int __pyx_pymod_exec_solvers(PyObject *__pyx_pyinit_module)
 #endif
 #endif
 {
   PyObject *__pyx_t_1 = NULL;
   PyObject *__pyx_t_2 = NULL;
-  PyObject *__pyx_t_3 = NULL;
-  PyObject *__pyx_t_4 = NULL;
   __Pyx_RefNannyDeclarations
   #if CYTHON_PEP489_MULTI_PHASE_INIT
   if (__pyx_m) {
     if (__pyx_m == __pyx_pyinit_module) return 0;
     PyErr_SetString(PyExc_RuntimeError, "Module 'solvers' has already been imported. Re-initialisation is not supported.");
     return -1;
   }
@@ -2961,18 +3681,17 @@
   __pyx_m = PyModule_Create(&__pyx_moduledef);
   #endif
   if (unlikely(!__pyx_m)) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   __pyx_d = PyModule_GetDict(__pyx_m); if (unlikely(!__pyx_d)) __PYX_ERR(0, 1, __pyx_L1_error)
   Py_INCREF(__pyx_d);
   __pyx_b = PyImport_AddModule(__Pyx_BUILTIN_MODULE_NAME); if (unlikely(!__pyx_b)) __PYX_ERR(0, 1, __pyx_L1_error)
-  __pyx_cython_runtime = PyImport_AddModule((char *) "cython_runtime"); if (unlikely(!__pyx_cython_runtime)) __PYX_ERR(0, 1, __pyx_L1_error)
-  #if CYTHON_COMPILING_IN_PYPY
   Py_INCREF(__pyx_b);
-  #endif
+  __pyx_cython_runtime = PyImport_AddModule((char *) "cython_runtime"); if (unlikely(!__pyx_cython_runtime)) __PYX_ERR(0, 1, __pyx_L1_error)
+  Py_INCREF(__pyx_cython_runtime);
   if (PyObject_SetAttrString(__pyx_m, "__builtins__", __pyx_b) < 0) __PYX_ERR(0, 1, __pyx_L1_error);
   /*--- Initialize various global constants etc. ---*/
   if (__Pyx_InitGlobals() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #if PY_MAJOR_VERSION < 3 && (__PYX_DEFAULT_STRING_ENCODING_IS_ASCII || __PYX_DEFAULT_STRING_ENCODING_IS_DEFAULT)
   if (__Pyx_init_sys_getdefaultencoding_params() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
   if (__pyx_module_is_main_tkwant__onebody__solvers) {
@@ -2983,211 +3702,143 @@
     PyObject *modules = PyImport_GetModuleDict(); if (unlikely(!modules)) __PYX_ERR(0, 1, __pyx_L1_error)
     if (!PyDict_GetItemString(modules, "tkwant.onebody.solvers")) {
       if (unlikely(PyDict_SetItemString(modules, "tkwant.onebody.solvers", __pyx_m) < 0)) __PYX_ERR(0, 1, __pyx_L1_error)
     }
   }
   #endif
   /*--- Builtin init code ---*/
-  if (__Pyx_InitCachedBuiltins() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
+  if (__Pyx_InitCachedBuiltins() < 0) goto __pyx_L1_error;
   /*--- Constants init code ---*/
-  if (__Pyx_InitCachedConstants() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
+  if (__Pyx_InitCachedConstants() < 0) goto __pyx_L1_error;
   /*--- Global type/function init code ---*/
   (void)__Pyx_modinit_global_init_code();
   (void)__Pyx_modinit_variable_export_code();
   (void)__Pyx_modinit_function_export_code();
-  (void)__Pyx_modinit_type_init_code();
-  if (unlikely(__Pyx_modinit_type_import_code() != 0)) goto __pyx_L1_error;
+  if (unlikely(__Pyx_modinit_type_init_code() != 0)) goto __pyx_L1_error;
+  (void)__Pyx_modinit_type_import_code();
   (void)__Pyx_modinit_variable_import_code();
   (void)__Pyx_modinit_function_import_code();
   /*--- Execution code ---*/
   #if defined(__Pyx_Generator_USED) || defined(__Pyx_Coroutine_USED)
   if (__Pyx_patch_abc() < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   #endif
 
-  /* "tkwant/onebody/solvers.pyx":12
+  /* "tkwant/onebody/solvers.pyx":13
  * """Classes for solving the time-dependent Schrdinger equation."""
  * 
  * import numpy as np             # <<<<<<<<<<<<<<
  * import scipy.integrate
  * 
  */
-  __pyx_t_1 = __Pyx_Import(__pyx_n_s_numpy, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 12, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_Import(__pyx_n_s_numpy, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 13, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_1) < 0) __PYX_ERR(0, 12, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_np, __pyx_t_1) < 0) __PYX_ERR(0, 13, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":13
+  /* "tkwant/onebody/solvers.pyx":14
  * 
  * import numpy as np
  * import scipy.integrate             # <<<<<<<<<<<<<<
  * 
- * from . cimport kernels
- */
-  __pyx_t_1 = __Pyx_Import(__pyx_n_s_scipy_integrate, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 13, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_scipy, __pyx_t_1) < 0) __PYX_ERR(0, 13, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-  /* "tkwant/onebody/solvers.pyx":16
- * 
- * from . cimport kernels
- * from . import kernels             # <<<<<<<<<<<<<<
- * 
  * 
  */
-  __pyx_t_1 = PyList_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 16, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_Import(__pyx_n_s_scipy_integrate, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 14, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  __Pyx_INCREF(__pyx_n_s_kernels);
-  __Pyx_GIVEREF(__pyx_n_s_kernels);
-  PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_s_kernels);
-  __pyx_t_2 = __Pyx_Import(__pyx_n_s_, __pyx_t_1, 1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 16, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_scipy, __pyx_t_1) < 0) __PYX_ERR(0, 14, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __pyx_t_1 = __Pyx_ImportFrom(__pyx_t_2, __pyx_n_s_kernels); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 16, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_kernels, __pyx_t_1) < 0) __PYX_ERR(0, 16, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":19
+  /* "tkwant/onebody/solvers.pyx":17
  * 
  * 
  * __all__ = ['Scipy']             # <<<<<<<<<<<<<<
  * 
  * 
  */
-  __pyx_t_2 = PyList_New(1); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 19, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
+  __pyx_t_1 = PyList_New(1); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_1);
   __Pyx_INCREF(__pyx_n_u_Scipy);
   __Pyx_GIVEREF(__pyx_n_u_Scipy);
-  PyList_SET_ITEM(__pyx_t_2, 0, __pyx_n_u_Scipy);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_all, __pyx_t_2) < 0) __PYX_ERR(0, 19, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
-
-  /* "tkwant/onebody/solvers.pyx":22
- * 
- * 
- * class Scipy:             # <<<<<<<<<<<<<<
- *     """Solve the time-dependent Schrdinger equation using `scipy.integrate`.
- * 
- */
-  __pyx_t_2 = __Pyx_Py3MetaclassPrepare((PyObject *) NULL, __pyx_empty_tuple, __pyx_n_s_Scipy, __pyx_n_s_Scipy, (PyObject *) NULL, __pyx_n_s_tkwant_onebody_solvers, __pyx_kp_s_Solve_the_time_dependent_Schrdin); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 22, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_2);
+  PyList_SET_ITEM(__pyx_t_1, 0, __pyx_n_u_Scipy);
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_all, __pyx_t_1) < 0) __PYX_ERR(0, 17, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":41
- *     """
+  /* "tkwant/onebody/solvers.pyx":46
+ *         int size
  * 
  *     _default_options = {'atol': 1E-9, 'rtol': 1E-9, 'nsteps': int(1E9)}             # <<<<<<<<<<<<<<
  * 
- *     def __init__(self, kernel, integrator=scipy.integrate._ode.dopri5, **integrator_options):
+ *     def __init__(self, size, integrator=scipy.integrate._ode.dopri5, **integrator_options):
  */
-  __pyx_t_1 = __Pyx_PyDict_NewPresized(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 41, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyDict_NewPresized(3); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 46, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  if (PyDict_SetItem(__pyx_t_1, __pyx_n_u_atol, __pyx_float_1Eneg_9) < 0) __PYX_ERR(0, 41, __pyx_L1_error)
-  if (PyDict_SetItem(__pyx_t_1, __pyx_n_u_rtol, __pyx_float_1Eneg_9) < 0) __PYX_ERR(0, 41, __pyx_L1_error)
-  __pyx_t_3 = __Pyx_PyNumber_Int(__pyx_float_1E9); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 41, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  if (PyDict_SetItem(__pyx_t_1, __pyx_n_u_nsteps, __pyx_t_3) < 0) __PYX_ERR(0, 41, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  if (__Pyx_SetNameInClass(__pyx_t_2, __pyx_n_s_default_options, __pyx_t_1) < 0) __PYX_ERR(0, 41, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_u_atol, __pyx_float_1Eneg_9) < 0) __PYX_ERR(0, 46, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_u_rtol, __pyx_float_1Eneg_9) < 0) __PYX_ERR(0, 46, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyNumber_Int(__pyx_float_1E9); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
+  if (PyDict_SetItem(__pyx_t_1, __pyx_n_u_nsteps, __pyx_t_2) < 0) __PYX_ERR(0, 46, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  if (PyDict_SetItem((PyObject *)__pyx_ptype_6tkwant_7onebody_7solvers_Scipy->tp_dict, __pyx_n_s_default_options, __pyx_t_1) < 0) __PYX_ERR(0, 46, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  PyType_Modified(__pyx_ptype_6tkwant_7onebody_7solvers_Scipy);
 
-  /* "tkwant/onebody/solvers.pyx":43
+  /* "tkwant/onebody/solvers.pyx":48
  *     _default_options = {'atol': 1E-9, 'rtol': 1E-9, 'nsteps': int(1E9)}
  * 
- *     def __init__(self, kernel, integrator=scipy.integrate._ode.dopri5, **integrator_options):             # <<<<<<<<<<<<<<
- *         self.kernel = kernel
+ *     def __init__(self, size, integrator=scipy.integrate._ode.dopri5, **integrator_options):             # <<<<<<<<<<<<<<
  *         # allocate storage for kernel output
+ *         self._rhs_out = np.empty((size,), dtype=complex)
  */
-  __pyx_t_1 = __Pyx_CyFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7solvers_5Scipy_1__init__, 0, __pyx_n_s_Scipy___init, NULL, __pyx_n_s_tkwant_onebody_solvers, __pyx_d, ((PyObject *)__pyx_codeobj__3)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 43, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  if (!__Pyx_CyFunction_InitDefaults(__pyx_t_1, sizeof(__pyx_defaults), 1)) __PYX_ERR(0, 43, __pyx_L1_error)
-  __Pyx_GetModuleGlobalName(__pyx_t_3, __pyx_n_s_scipy); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 43, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_integrate); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 43, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __pyx_t_3 = __Pyx_PyObject_GetAttrStr(__pyx_t_4, __pyx_n_s_ode); if (unlikely(!__pyx_t_3)) __PYX_ERR(0, 43, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_3);
-  __Pyx_DECREF(__pyx_t_4); __pyx_t_4 = 0;
-  __pyx_t_4 = __Pyx_PyObject_GetAttrStr(__pyx_t_3, __pyx_n_s_dopri5); if (unlikely(!__pyx_t_4)) __PYX_ERR(0, 43, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_4);
-  __Pyx_DECREF(__pyx_t_3); __pyx_t_3 = 0;
-  __Pyx_CyFunction_Defaults(__pyx_defaults, __pyx_t_1)->__pyx_arg_integrator = __pyx_t_4;
-  __Pyx_GIVEREF(__pyx_t_4);
-  __pyx_t_4 = 0;
-  __Pyx_CyFunction_SetDefaultsGetter(__pyx_t_1, __pyx_pf_6tkwant_7onebody_7solvers___defaults__);
-  if (__Pyx_SetNameInClass(__pyx_t_2, __pyx_n_s_init, __pyx_t_1) < 0) __PYX_ERR(0, 43, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-  /* "tkwant/onebody/solvers.pyx":54
- *         self._integrator.reset(2 * self.kernel.size, has_jac=False)
- * 
- *     def _rhs(self, t, y):             # <<<<<<<<<<<<<<
- *         # Kernel expects complex, Scipy expects real
- *         self.kernel.rhs(y.view(complex), self._rhs_out, t)
- */
-  __pyx_t_1 = __Pyx_CyFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7solvers_5Scipy_3_rhs, 0, __pyx_n_s_Scipy__rhs, NULL, __pyx_n_s_tkwant_onebody_solvers, __pyx_d, ((PyObject *)__pyx_codeobj__5)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 54, __pyx_L1_error)
+  __Pyx_GetModuleGlobalName(__pyx_t_1, __pyx_n_s_scipy); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 48, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  if (__Pyx_SetNameInClass(__pyx_t_2, __pyx_n_s_rhs_2, __pyx_t_1) < 0) __PYX_ERR(0, 54, __pyx_L1_error)
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_integrate); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 48, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-
-  /* "tkwant/onebody/solvers.pyx":59
- *         return self._rhs_out.view(float)
- * 
- *     def __call__(self, psi, time, next_time):             # <<<<<<<<<<<<<<
- *         if time == next_time:
- *             return psi
- */
-  __pyx_t_1 = __Pyx_CyFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7solvers_5Scipy_5__call__, 0, __pyx_n_s_Scipy___call, NULL, __pyx_n_s_tkwant_onebody_solvers, __pyx_d, ((PyObject *)__pyx_codeobj__7)); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 59, __pyx_L1_error)
+  __pyx_t_1 = __Pyx_PyObject_GetAttrStr(__pyx_t_2, __pyx_n_s_ode); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 48, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_1);
-  if (__Pyx_SetNameInClass(__pyx_t_2, __pyx_n_s_call, __pyx_t_1) < 0) __PYX_ERR(0, 59, __pyx_L1_error)
+  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  __pyx_t_2 = __Pyx_PyObject_GetAttrStr(__pyx_t_1, __pyx_n_s_dopri5); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 48, __pyx_L1_error)
+  __Pyx_GOTREF(__pyx_t_2);
   __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
+  __pyx_k_ = __pyx_t_2;
+  __Pyx_GIVEREF(__pyx_t_2);
+  __pyx_t_2 = 0;
 
-  /* "tkwant/onebody/solvers.pyx":22
+  /* "tkwant/onebody/solvers.pyx":81
  * 
  * 
- * class Scipy:             # <<<<<<<<<<<<<<
- *     """Solve the time-dependent Schrdinger equation using `scipy.integrate`.
- * 
+ * default = Scipy             # <<<<<<<<<<<<<<
  */
-  __pyx_t_1 = __Pyx_Py3ClassCreate(((PyObject*)&__Pyx_DefaultClassType), __pyx_n_s_Scipy, __pyx_empty_tuple, __pyx_t_2, NULL, 0, 0); if (unlikely(!__pyx_t_1)) __PYX_ERR(0, 22, __pyx_L1_error)
-  __Pyx_GOTREF(__pyx_t_1);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_Scipy, __pyx_t_1) < 0) __PYX_ERR(0, 22, __pyx_L1_error)
-  __Pyx_DECREF(__pyx_t_1); __pyx_t_1 = 0;
-  __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_default, ((PyObject *)__pyx_ptype_6tkwant_7onebody_7solvers_Scipy)) < 0) __PYX_ERR(0, 81, __pyx_L1_error)
 
-  /* "tkwant/onebody/solvers.pyx":72
- * 
- * 
- * default = Scipy             # <<<<<<<<<<<<<<
+  /* "(tree fragment)":1
+ * def __pyx_unpickle_Scipy(__pyx_type, long __pyx_checksum, __pyx_state):             # <<<<<<<<<<<<<<
+ *     cdef object __pyx_PickleError
+ *     cdef object __pyx_result
  */
-  __Pyx_GetModuleGlobalName(__pyx_t_2, __pyx_n_s_Scipy); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 72, __pyx_L1_error)
+  __pyx_t_2 = PyCFunction_NewEx(&__pyx_mdef_6tkwant_7onebody_7solvers_1__pyx_unpickle_Scipy, NULL, __pyx_n_s_tkwant_onebody_solvers); if (unlikely(!__pyx_t_2)) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
-  if (PyDict_SetItem(__pyx_d, __pyx_n_s_default, __pyx_t_2) < 0) __PYX_ERR(0, 72, __pyx_L1_error)
+  if (PyDict_SetItem(__pyx_d, __pyx_n_s_pyx_unpickle_Scipy, __pyx_t_2) < 0) __PYX_ERR(1, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /* "tkwant/onebody/solvers.pyx":1
  * # -*- coding: utf-8 -*-             # <<<<<<<<<<<<<<
  * #
- * # Copyright 2016 - 2020 tkwant authors.
+ * # Copyright 2016 - 2022 tkwant authors.
  */
   __pyx_t_2 = __Pyx_PyDict_NewPresized(0); if (unlikely(!__pyx_t_2)) __PYX_ERR(0, 1, __pyx_L1_error)
   __Pyx_GOTREF(__pyx_t_2);
   if (PyDict_SetItem(__pyx_d, __pyx_n_s_test, __pyx_t_2) < 0) __PYX_ERR(0, 1, __pyx_L1_error)
   __Pyx_DECREF(__pyx_t_2); __pyx_t_2 = 0;
 
   /*--- Wrapped vars code ---*/
 
   goto __pyx_L0;
   __pyx_L1_error:;
   __Pyx_XDECREF(__pyx_t_1);
   __Pyx_XDECREF(__pyx_t_2);
-  __Pyx_XDECREF(__pyx_t_3);
-  __Pyx_XDECREF(__pyx_t_4);
   if (__pyx_m) {
     if (__pyx_d) {
       __Pyx_AddTraceback("init tkwant.onebody.solvers", __pyx_clineno, __pyx_lineno, __pyx_filename);
     }
     Py_CLEAR(__pyx_m);
   } else if (!PyErr_Occurred()) {
     PyErr_SetString(PyExc_ImportError, "init tkwant.onebody.solvers");
@@ -3245,40 +3896,14 @@
 #else
             "name '%.200s' is not defined", PyString_AS_STRING(name));
 #endif
     }
     return result;
 }
 
-/* RaiseArgTupleInvalid */
-static void __Pyx_RaiseArgtupleInvalid(
-    const char* func_name,
-    int exact,
-    Py_ssize_t num_min,
-    Py_ssize_t num_max,
-    Py_ssize_t num_found)
-{
-    Py_ssize_t num_expected;
-    const char *more_or_less;
-    if (num_found < num_min) {
-        num_expected = num_min;
-        more_or_less = "at least";
-    } else {
-        num_expected = num_max;
-        more_or_less = "at most";
-    }
-    if (exact) {
-        more_or_less = "exactly";
-    }
-    PyErr_Format(PyExc_TypeError,
-                 "%.200s() takes %.8s %" CYTHON_FORMAT_SSIZE_T "d positional argument%.1s (%" CYTHON_FORMAT_SSIZE_T "d given)",
-                 func_name, more_or_less, num_expected,
-                 (num_expected == 1) ? "" : "s", num_found);
-}
-
 /* RaiseDoubleKeywords */
 static void __Pyx_RaiseDoubleKeywordsError(
     const char* func_name,
     PyObject* kw_name)
 {
     PyErr_Format(PyExc_TypeError,
         #if PY_MAJOR_VERSION >= 3
@@ -3387,25 +4012,63 @@
         "%s() got an unexpected keyword argument '%U'",
         function_name, key);
     #endif
 bad:
     return -1;
 }
 
-/* PyObjectSetAttrStr */
-#if CYTHON_USE_TYPE_SLOTS
-static CYTHON_INLINE int __Pyx_PyObject_SetAttrStr(PyObject* obj, PyObject* attr_name, PyObject* value) {
-    PyTypeObject* tp = Py_TYPE(obj);
-    if (likely(tp->tp_setattro))
-        return tp->tp_setattro(obj, attr_name, value);
-#if PY_MAJOR_VERSION < 3
-    if (likely(tp->tp_setattr))
-        return tp->tp_setattr(obj, PyString_AS_STRING(attr_name), value);
+/* RaiseArgTupleInvalid */
+static void __Pyx_RaiseArgtupleInvalid(
+    const char* func_name,
+    int exact,
+    Py_ssize_t num_min,
+    Py_ssize_t num_max,
+    Py_ssize_t num_found)
+{
+    Py_ssize_t num_expected;
+    const char *more_or_less;
+    if (num_found < num_min) {
+        num_expected = num_min;
+        more_or_less = "at least";
+    } else {
+        num_expected = num_max;
+        more_or_less = "at most";
+    }
+    if (exact) {
+        more_or_less = "exactly";
+    }
+    PyErr_Format(PyExc_TypeError,
+                 "%.200s() takes %.8s %" CYTHON_FORMAT_SSIZE_T "d positional argument%.1s (%" CYTHON_FORMAT_SSIZE_T "d given)",
+                 func_name, more_or_less, num_expected,
+                 (num_expected == 1) ? "" : "s", num_found);
+}
+
+/* PyDictVersioning */
+#if CYTHON_USE_DICT_VERSIONS && CYTHON_USE_TYPE_SLOTS
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_tp_dict_version(PyObject *obj) {
+    PyObject *dict = Py_TYPE(obj)->tp_dict;
+    return likely(dict) ? __PYX_GET_DICT_VERSION(dict) : 0;
+}
+static CYTHON_INLINE PY_UINT64_T __Pyx_get_object_dict_version(PyObject *obj) {
+    PyObject **dictptr = NULL;
+    Py_ssize_t offset = Py_TYPE(obj)->tp_dictoffset;
+    if (offset) {
+#if CYTHON_COMPILING_IN_CPYTHON
+        dictptr = (likely(offset > 0)) ? (PyObject **) ((char *)obj + offset) : _PyObject_GetDictPtr(obj);
+#else
+        dictptr = _PyObject_GetDictPtr(obj);
 #endif
-    return PyObject_SetAttr(obj, attr_name, value);
+    }
+    return (dictptr && *dictptr) ? __PYX_GET_DICT_VERSION(*dictptr) : 0;
+}
+static CYTHON_INLINE int __Pyx_object_dict_version_matches(PyObject* obj, PY_UINT64_T tp_dict_version, PY_UINT64_T obj_dict_version) {
+    PyObject *dict = Py_TYPE(obj)->tp_dict;
+    if (unlikely(!dict) || unlikely(tp_dict_version != __PYX_GET_DICT_VERSION(dict)))
+        return 0;
+    return obj_dict_version == __Pyx_get_object_dict_version(obj);
 }
 #endif
 
 /* GetModuleGlobalName */
 #if CYTHON_USE_DICT_VERSIONS
 static PyObject *__Pyx__GetModuleGlobalName(PyObject *name, PY_UINT64_T *dict_version, PyObject **dict_cached_value)
 #else
@@ -3510,15 +4173,15 @@
     result = PyEval_EvalFrameEx(f,0);
     ++tstate->recursion_depth;
     Py_DECREF(f);
     --tstate->recursion_depth;
     return result;
 }
 #if 1 || PY_VERSION_HEX < 0x030600B1
-static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, int nargs, PyObject *kwargs) {
+static PyObject *__Pyx_PyFunction_FastCallDict(PyObject *func, PyObject **args, Py_ssize_t nargs, PyObject *kwargs) {
     PyCodeObject *co = (PyCodeObject *)PyFunction_GET_CODE(func);
     PyObject *globals = PyFunction_GET_GLOBALS(func);
     PyObject *argdefs = PyFunction_GET_DEFAULTS(func);
     PyObject *closure;
 #if PY_MAJOR_VERSION >= 3
     PyObject *kwdefs;
 #endif
@@ -3581,20 +4244,20 @@
     }
     else {
         d = NULL;
         nd = 0;
     }
 #if PY_MAJOR_VERSION >= 3
     result = PyEval_EvalCodeEx((PyObject*)co, globals, (PyObject *)NULL,
-                               args, nargs,
+                               args, (int)nargs,
                                k, (int)nk,
                                d, (int)nd, kwdefs, closure);
 #else
     result = PyEval_EvalCodeEx(co, globals, (PyObject *)NULL,
-                               args, nargs,
+                               args, (int)nargs,
                                k, (int)nk,
                                d, (int)nd, closure);
 #endif
     Py_XDECREF(kwtuple);
 done:
     Py_LeaveRecursiveCall();
     return result;
@@ -4361,14 +5024,20 @@
     0,
     0,
     0,
     0,
 #if PY_VERSION_HEX >= 0x030400a1
     0,
 #endif
+#if PY_VERSION_HEX >= 0x030800b1
+    0,
+#endif
+#if PY_VERSION_HEX >= 0x030800b4 && PY_VERSION_HEX < 0x03090000
+    0,
+#endif
 };
 static int __pyx_CyFunction_init(void) {
     __pyx_CyFunctionType = __Pyx_FetchCommonType(&__pyx_CyFunctionType_type);
     if (unlikely(__pyx_CyFunctionType == NULL)) {
         return -1;
     }
     return 0;
@@ -4637,75 +5306,67 @@
     }
 bad:
     Py_XDECREF(owned_instance);
     return;
 }
 #endif
 
-/* TypeImport */
-#ifndef __PYX_HAVE_RT_ImportType
-#define __PYX_HAVE_RT_ImportType
-static PyTypeObject *__Pyx_ImportType(PyObject *module, const char *module_name, const char *class_name,
-    size_t size, enum __Pyx_ImportType_CheckSize check_size)
-{
-    PyObject *result = 0;
-    char warning[200];
-    Py_ssize_t basicsize;
-#ifdef Py_LIMITED_API
-    PyObject *py_basicsize;
-#endif
-    result = PyObject_GetAttrString(module, class_name);
-    if (!result)
-        goto bad;
-    if (!PyType_Check(result)) {
-        PyErr_Format(PyExc_TypeError,
-            "%.200s.%.200s is not a type object",
-            module_name, class_name);
-        goto bad;
+/* PyErrExceptionMatches */
+#if CYTHON_FAST_THREAD_STATE
+static int __Pyx_PyErr_ExceptionMatchesTuple(PyObject *exc_type, PyObject *tuple) {
+    Py_ssize_t i, n;
+    n = PyTuple_GET_SIZE(tuple);
+#if PY_MAJOR_VERSION >= 3
+    for (i=0; i<n; i++) {
+        if (exc_type == PyTuple_GET_ITEM(tuple, i)) return 1;
     }
-#ifndef Py_LIMITED_API
-    basicsize = ((PyTypeObject *)result)->tp_basicsize;
-#else
-    py_basicsize = PyObject_GetAttrString(result, "__basicsize__");
-    if (!py_basicsize)
-        goto bad;
-    basicsize = PyLong_AsSsize_t(py_basicsize);
-    Py_DECREF(py_basicsize);
-    py_basicsize = 0;
-    if (basicsize == (Py_ssize_t)-1 && PyErr_Occurred())
-        goto bad;
 #endif
-    if ((size_t)basicsize < size) {
-        PyErr_Format(PyExc_ValueError,
-            "%.200s.%.200s size changed, may indicate binary incompatibility. "
-            "Expected %zd from C header, got %zd from PyObject",
-            module_name, class_name, size, basicsize);
-        goto bad;
+    for (i=0; i<n; i++) {
+        if (__Pyx_PyErr_GivenExceptionMatches(exc_type, PyTuple_GET_ITEM(tuple, i))) return 1;
     }
-    if (check_size == __Pyx_ImportType_CheckSize_Error && (size_t)basicsize != size) {
-        PyErr_Format(PyExc_ValueError,
-            "%.200s.%.200s size changed, may indicate binary incompatibility. "
-            "Expected %zd from C header, got %zd from PyObject",
-            module_name, class_name, size, basicsize);
-        goto bad;
-    }
-    else if (check_size == __Pyx_ImportType_CheckSize_Warn && (size_t)basicsize > size) {
-        PyOS_snprintf(warning, sizeof(warning),
-            "%s.%s size changed, may indicate binary incompatibility. "
-            "Expected %zd from C header, got %zd from PyObject",
-            module_name, class_name, size, basicsize);
-        if (PyErr_WarnEx(NULL, warning, 0) < 0) goto bad;
-    }
-    return (PyTypeObject *)result;
-bad:
-    Py_XDECREF(result);
-    return NULL;
+    return 0;
+}
+static CYTHON_INLINE int __Pyx_PyErr_ExceptionMatchesInState(PyThreadState* tstate, PyObject* err) {
+    PyObject *exc_type = tstate->curexc_type;
+    if (exc_type == err) return 1;
+    if (unlikely(!exc_type)) return 0;
+    if (unlikely(PyTuple_Check(err)))
+        return __Pyx_PyErr_ExceptionMatchesTuple(exc_type, err);
+    return __Pyx_PyErr_GivenExceptionMatches(exc_type, err);
 }
 #endif
 
+/* GetAttr */
+static CYTHON_INLINE PyObject *__Pyx_GetAttr(PyObject *o, PyObject *n) {
+#if CYTHON_USE_TYPE_SLOTS
+#if PY_MAJOR_VERSION >= 3
+    if (likely(PyUnicode_Check(n)))
+#else
+    if (likely(PyString_Check(n)))
+#endif
+        return __Pyx_PyObject_GetAttrStr(o, n);
+#endif
+    return PyObject_GetAttr(o, n);
+}
+
+/* GetAttr3 */
+static PyObject *__Pyx_GetAttr3Default(PyObject *d) {
+    __Pyx_PyThreadState_declare
+    __Pyx_PyThreadState_assign
+    if (unlikely(!__Pyx_PyErr_ExceptionMatches(PyExc_AttributeError)))
+        return NULL;
+    __Pyx_PyErr_Clear();
+    Py_INCREF(d);
+    return d;
+}
+static CYTHON_INLINE PyObject *__Pyx_GetAttr3(PyObject *o, PyObject *n, PyObject *d) {
+    PyObject *r = __Pyx_GetAttr(o, n);
+    return (likely(r)) ? r : __Pyx_GetAttr3Default(d);
+}
+
 /* Import */
 static PyObject *__Pyx_Import(PyObject *name, PyObject *from_list, int level) {
     PyObject *empty_list = 0;
     PyObject *module = 0;
     PyObject *global_dict = 0;
     PyObject *empty_dict = 0;
     PyObject *list;
@@ -4777,118 +5438,243 @@
         #else
             "cannot import name %S", name);
         #endif
     }
     return value;
 }
 
-/* CalculateMetaclass */
-static PyObject *__Pyx_CalculateMetaclass(PyTypeObject *metaclass, PyObject *bases) {
-    Py_ssize_t i, nbases = PyTuple_GET_SIZE(bases);
-    for (i=0; i < nbases; i++) {
-        PyTypeObject *tmptype;
-        PyObject *tmp = PyTuple_GET_ITEM(bases, i);
-        tmptype = Py_TYPE(tmp);
-#if PY_MAJOR_VERSION < 3
-        if (tmptype == &PyClass_Type)
-            continue;
-#endif
-        if (!metaclass) {
-            metaclass = tmptype;
-            continue;
+/* GetItemInt */
+static PyObject *__Pyx_GetItemInt_Generic(PyObject *o, PyObject* j) {
+    PyObject *r;
+    if (!j) return NULL;
+    r = PyObject_GetItem(o, j);
+    Py_DECREF(j);
+    return r;
+}
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_List_Fast(PyObject *o, Py_ssize_t i,
+                                                              CYTHON_NCP_UNUSED int wraparound,
+                                                              CYTHON_NCP_UNUSED int boundscheck) {
+#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
+    Py_ssize_t wrapped_i = i;
+    if (wraparound & unlikely(i < 0)) {
+        wrapped_i += PyList_GET_SIZE(o);
+    }
+    if ((!boundscheck) || likely(__Pyx_is_valid_index(wrapped_i, PyList_GET_SIZE(o)))) {
+        PyObject *r = PyList_GET_ITEM(o, wrapped_i);
+        Py_INCREF(r);
+        return r;
+    }
+    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
+#else
+    return PySequence_GetItem(o, i);
+#endif
+}
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Tuple_Fast(PyObject *o, Py_ssize_t i,
+                                                              CYTHON_NCP_UNUSED int wraparound,
+                                                              CYTHON_NCP_UNUSED int boundscheck) {
+#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS
+    Py_ssize_t wrapped_i = i;
+    if (wraparound & unlikely(i < 0)) {
+        wrapped_i += PyTuple_GET_SIZE(o);
+    }
+    if ((!boundscheck) || likely(__Pyx_is_valid_index(wrapped_i, PyTuple_GET_SIZE(o)))) {
+        PyObject *r = PyTuple_GET_ITEM(o, wrapped_i);
+        Py_INCREF(r);
+        return r;
+    }
+    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
+#else
+    return PySequence_GetItem(o, i);
+#endif
+}
+static CYTHON_INLINE PyObject *__Pyx_GetItemInt_Fast(PyObject *o, Py_ssize_t i, int is_list,
+                                                     CYTHON_NCP_UNUSED int wraparound,
+                                                     CYTHON_NCP_UNUSED int boundscheck) {
+#if CYTHON_ASSUME_SAFE_MACROS && !CYTHON_AVOID_BORROWED_REFS && CYTHON_USE_TYPE_SLOTS
+    if (is_list || PyList_CheckExact(o)) {
+        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyList_GET_SIZE(o);
+        if ((!boundscheck) || (likely(__Pyx_is_valid_index(n, PyList_GET_SIZE(o))))) {
+            PyObject *r = PyList_GET_ITEM(o, n);
+            Py_INCREF(r);
+            return r;
+        }
+    }
+    else if (PyTuple_CheckExact(o)) {
+        Py_ssize_t n = ((!wraparound) | likely(i >= 0)) ? i : i + PyTuple_GET_SIZE(o);
+        if ((!boundscheck) || likely(__Pyx_is_valid_index(n, PyTuple_GET_SIZE(o)))) {
+            PyObject *r = PyTuple_GET_ITEM(o, n);
+            Py_INCREF(r);
+            return r;
         }
-        if (PyType_IsSubtype(metaclass, tmptype))
-            continue;
-        if (PyType_IsSubtype(tmptype, metaclass)) {
-            metaclass = tmptype;
-            continue;
+    } else {
+        PySequenceMethods *m = Py_TYPE(o)->tp_as_sequence;
+        if (likely(m && m->sq_item)) {
+            if (wraparound && unlikely(i < 0) && likely(m->sq_length)) {
+                Py_ssize_t l = m->sq_length(o);
+                if (likely(l >= 0)) {
+                    i += l;
+                } else {
+                    if (!PyErr_ExceptionMatches(PyExc_OverflowError))
+                        return NULL;
+                    PyErr_Clear();
+                }
+            }
+            return m->sq_item(o, i);
         }
-        PyErr_SetString(PyExc_TypeError,
-                        "metaclass conflict: "
-                        "the metaclass of a derived class "
-                        "must be a (non-strict) subclass "
-                        "of the metaclasses of all its bases");
-        return NULL;
     }
-    if (!metaclass) {
-#if PY_MAJOR_VERSION < 3
-        metaclass = &PyClass_Type;
 #else
-        metaclass = &PyType_Type;
-#endif
+    if (is_list || PySequence_Check(o)) {
+        return PySequence_GetItem(o, i);
     }
-    Py_INCREF((PyObject*) metaclass);
-    return (PyObject*) metaclass;
+#endif
+    return __Pyx_GetItemInt_Generic(o, PyInt_FromSsize_t(i));
 }
 
-/* Py3ClassCreate */
-static PyObject *__Pyx_Py3MetaclassPrepare(PyObject *metaclass, PyObject *bases, PyObject *name,
-                                           PyObject *qualname, PyObject *mkw, PyObject *modname, PyObject *doc) {
-    PyObject *ns;
-    if (metaclass) {
-        PyObject *prep = __Pyx_PyObject_GetAttrStr(metaclass, __pyx_n_s_prepare);
-        if (prep) {
-            PyObject *pargs = PyTuple_Pack(2, name, bases);
-            if (unlikely(!pargs)) {
-                Py_DECREF(prep);
-                return NULL;
-            }
-            ns = PyObject_Call(prep, pargs, mkw);
-            Py_DECREF(prep);
-            Py_DECREF(pargs);
-        } else {
-            if (unlikely(!PyErr_ExceptionMatches(PyExc_AttributeError)))
-                return NULL;
-            PyErr_Clear();
-            ns = PyDict_New();
-        }
+/* HasAttr */
+static CYTHON_INLINE int __Pyx_HasAttr(PyObject *o, PyObject *n) {
+    PyObject *r;
+    if (unlikely(!__Pyx_PyBaseString_Check(n))) {
+        PyErr_SetString(PyExc_TypeError,
+                        "hasattr(): attribute name must be string");
+        return -1;
+    }
+    r = __Pyx_GetAttr(o, n);
+    if (unlikely(!r)) {
+        PyErr_Clear();
+        return 0;
     } else {
-        ns = PyDict_New();
+        Py_DECREF(r);
+        return 1;
     }
-    if (unlikely(!ns))
-        return NULL;
-    if (unlikely(PyObject_SetItem(ns, __pyx_n_s_module, modname) < 0)) goto bad;
-    if (unlikely(PyObject_SetItem(ns, __pyx_n_s_qualname, qualname) < 0)) goto bad;
-    if (unlikely(doc && PyObject_SetItem(ns, __pyx_n_s_doc, doc) < 0)) goto bad;
-    return ns;
-bad:
-    Py_DECREF(ns);
+}
+
+/* PyObject_GenericGetAttrNoDict */
+#if CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP && PY_VERSION_HEX < 0x03070000
+static PyObject *__Pyx_RaiseGenericGetAttributeError(PyTypeObject *tp, PyObject *attr_name) {
+    PyErr_Format(PyExc_AttributeError,
+#if PY_MAJOR_VERSION >= 3
+                 "'%.50s' object has no attribute '%U'",
+                 tp->tp_name, attr_name);
+#else
+                 "'%.50s' object has no attribute '%.400s'",
+                 tp->tp_name, PyString_AS_STRING(attr_name));
+#endif
     return NULL;
 }
-static PyObject *__Pyx_Py3ClassCreate(PyObject *metaclass, PyObject *name, PyObject *bases,
-                                      PyObject *dict, PyObject *mkw,
-                                      int calculate_metaclass, int allow_py2_metaclass) {
-    PyObject *result, *margs;
-    PyObject *owned_metaclass = NULL;
-    if (allow_py2_metaclass) {
-        owned_metaclass = PyObject_GetItem(dict, __pyx_n_s_metaclass);
-        if (owned_metaclass) {
-            metaclass = owned_metaclass;
-        } else if (likely(PyErr_ExceptionMatches(PyExc_KeyError))) {
-            PyErr_Clear();
-        } else {
-            return NULL;
+static CYTHON_INLINE PyObject* __Pyx_PyObject_GenericGetAttrNoDict(PyObject* obj, PyObject* attr_name) {
+    PyObject *descr;
+    PyTypeObject *tp = Py_TYPE(obj);
+    if (unlikely(!PyString_Check(attr_name))) {
+        return PyObject_GenericGetAttr(obj, attr_name);
+    }
+    assert(!tp->tp_dictoffset);
+    descr = _PyType_Lookup(tp, attr_name);
+    if (unlikely(!descr)) {
+        return __Pyx_RaiseGenericGetAttributeError(tp, attr_name);
+    }
+    Py_INCREF(descr);
+    #if PY_MAJOR_VERSION < 3
+    if (likely(PyType_HasFeature(Py_TYPE(descr), Py_TPFLAGS_HAVE_CLASS)))
+    #endif
+    {
+        descrgetfunc f = Py_TYPE(descr)->tp_descr_get;
+        if (unlikely(f)) {
+            PyObject *res = f(descr, obj, (PyObject *)tp);
+            Py_DECREF(descr);
+            return res;
         }
     }
-    if (calculate_metaclass && (!metaclass || PyType_Check(metaclass))) {
-        metaclass = __Pyx_CalculateMetaclass((PyTypeObject*) metaclass, bases);
-        Py_XDECREF(owned_metaclass);
-        if (unlikely(!metaclass))
-            return NULL;
-        owned_metaclass = metaclass;
+    return descr;
+}
+#endif
+
+/* PyObject_GenericGetAttr */
+#if CYTHON_USE_TYPE_SLOTS && CYTHON_USE_PYTYPE_LOOKUP && PY_VERSION_HEX < 0x03070000
+static PyObject* __Pyx_PyObject_GenericGetAttr(PyObject* obj, PyObject* attr_name) {
+    if (unlikely(Py_TYPE(obj)->tp_dictoffset)) {
+        return PyObject_GenericGetAttr(obj, attr_name);
     }
-    margs = PyTuple_Pack(3, name, bases, dict);
-    if (unlikely(!margs)) {
-        result = NULL;
-    } else {
-        result = PyObject_Call(metaclass, margs, mkw);
-        Py_DECREF(margs);
+    return __Pyx_PyObject_GenericGetAttrNoDict(obj, attr_name);
+}
+#endif
+
+/* SetupReduce */
+static int __Pyx_setup_reduce_is_named(PyObject* meth, PyObject* name) {
+  int ret;
+  PyObject *name_attr;
+  name_attr = __Pyx_PyObject_GetAttrStr(meth, __pyx_n_s_name);
+  if (likely(name_attr)) {
+      ret = PyObject_RichCompareBool(name_attr, name, Py_EQ);
+  } else {
+      ret = -1;
+  }
+  if (unlikely(ret < 0)) {
+      PyErr_Clear();
+      ret = 0;
+  }
+  Py_XDECREF(name_attr);
+  return ret;
+}
+static int __Pyx_setup_reduce(PyObject* type_obj) {
+    int ret = 0;
+    PyObject *object_reduce = NULL;
+    PyObject *object_reduce_ex = NULL;
+    PyObject *reduce = NULL;
+    PyObject *reduce_ex = NULL;
+    PyObject *reduce_cython = NULL;
+    PyObject *setstate = NULL;
+    PyObject *setstate_cython = NULL;
+#if CYTHON_USE_PYTYPE_LOOKUP
+    if (_PyType_Lookup((PyTypeObject*)type_obj, __pyx_n_s_getstate)) goto __PYX_GOOD;
+#else
+    if (PyObject_HasAttr(type_obj, __pyx_n_s_getstate)) goto __PYX_GOOD;
+#endif
+#if CYTHON_USE_PYTYPE_LOOKUP
+    object_reduce_ex = _PyType_Lookup(&PyBaseObject_Type, __pyx_n_s_reduce_ex); if (!object_reduce_ex) goto __PYX_BAD;
+#else
+    object_reduce_ex = __Pyx_PyObject_GetAttrStr((PyObject*)&PyBaseObject_Type, __pyx_n_s_reduce_ex); if (!object_reduce_ex) goto __PYX_BAD;
+#endif
+    reduce_ex = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce_ex); if (unlikely(!reduce_ex)) goto __PYX_BAD;
+    if (reduce_ex == object_reduce_ex) {
+#if CYTHON_USE_PYTYPE_LOOKUP
+        object_reduce = _PyType_Lookup(&PyBaseObject_Type, __pyx_n_s_reduce); if (!object_reduce) goto __PYX_BAD;
+#else
+        object_reduce = __Pyx_PyObject_GetAttrStr((PyObject*)&PyBaseObject_Type, __pyx_n_s_reduce); if (!object_reduce) goto __PYX_BAD;
+#endif
+        reduce = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce); if (unlikely(!reduce)) goto __PYX_BAD;
+        if (reduce == object_reduce || __Pyx_setup_reduce_is_named(reduce, __pyx_n_s_reduce_cython)) {
+            reduce_cython = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_reduce_cython); if (unlikely(!reduce_cython)) goto __PYX_BAD;
+            ret = PyDict_SetItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_reduce, reduce_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
+            ret = PyDict_DelItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_reduce_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
+            setstate = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_setstate);
+            if (!setstate) PyErr_Clear();
+            if (!setstate || __Pyx_setup_reduce_is_named(setstate, __pyx_n_s_setstate_cython)) {
+                setstate_cython = __Pyx_PyObject_GetAttrStr(type_obj, __pyx_n_s_setstate_cython); if (unlikely(!setstate_cython)) goto __PYX_BAD;
+                ret = PyDict_SetItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_setstate, setstate_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
+                ret = PyDict_DelItem(((PyTypeObject*)type_obj)->tp_dict, __pyx_n_s_setstate_cython); if (unlikely(ret < 0)) goto __PYX_BAD;
+            }
+            PyType_Modified((PyTypeObject*)type_obj);
+        }
     }
-    Py_XDECREF(owned_metaclass);
-    return result;
+    goto __PYX_GOOD;
+__PYX_BAD:
+    if (!PyErr_Occurred())
+        PyErr_Format(PyExc_RuntimeError, "Unable to initialize pickling for %s", ((PyTypeObject*)type_obj)->tp_name);
+    ret = -1;
+__PYX_GOOD:
+#if !CYTHON_USE_PYTYPE_LOOKUP
+    Py_XDECREF(object_reduce);
+    Py_XDECREF(object_reduce_ex);
+#endif
+    Py_XDECREF(reduce);
+    Py_XDECREF(reduce_ex);
+    Py_XDECREF(reduce_cython);
+    Py_XDECREF(setstate);
+    Py_XDECREF(setstate_cython);
+    return ret;
 }
 
 /* CLineInTraceback */
 #ifndef CYTHON_CLINE_IN_TRACEBACK
 static int __Pyx_CLineForTraceback(PyThreadState *tstate, int c_line) {
     PyObject *use_cline;
     PyObject *ptype, *pvalue, *ptraceback;
@@ -5090,196 +5876,41 @@
     __Pyx_PyFrame_SetLineNumber(py_frame, py_line);
     PyTraceBack_Here(py_frame);
 bad:
     Py_XDECREF(py_code);
     Py_XDECREF(py_frame);
 }
 
-/* Declarations */
-#if CYTHON_CCOMPLEX
-  #ifdef __cplusplus
-    static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double x, double y) {
-      return ::std::complex< double >(x, y);
-    }
-  #else
-    static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double x, double y) {
-      return x + y*(__pyx_t_double_complex)_Complex_I;
-    }
-  #endif
-#else
-    static CYTHON_INLINE __pyx_t_double_complex __pyx_t_double_complex_from_parts(double x, double y) {
-      __pyx_t_double_complex z;
-      z.real = x;
-      z.imag = y;
-      return z;
-    }
-#endif
-
-/* Arithmetic */
-#if CYTHON_CCOMPLEX
-#else
-    static CYTHON_INLINE int __Pyx_c_eq_double(__pyx_t_double_complex a, __pyx_t_double_complex b) {
-       return (a.real == b.real) && (a.imag == b.imag);
-    }
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_sum_double(__pyx_t_double_complex a, __pyx_t_double_complex b) {
-        __pyx_t_double_complex z;
-        z.real = a.real + b.real;
-        z.imag = a.imag + b.imag;
-        return z;
-    }
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_diff_double(__pyx_t_double_complex a, __pyx_t_double_complex b) {
-        __pyx_t_double_complex z;
-        z.real = a.real - b.real;
-        z.imag = a.imag - b.imag;
-        return z;
-    }
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_prod_double(__pyx_t_double_complex a, __pyx_t_double_complex b) {
-        __pyx_t_double_complex z;
-        z.real = a.real * b.real - a.imag * b.imag;
-        z.imag = a.real * b.imag + a.imag * b.real;
-        return z;
-    }
-    #if 1
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_quot_double(__pyx_t_double_complex a, __pyx_t_double_complex b) {
-        if (b.imag == 0) {
-            return __pyx_t_double_complex_from_parts(a.real / b.real, a.imag / b.real);
-        } else if (fabs(b.real) >= fabs(b.imag)) {
-            if (b.real == 0 && b.imag == 0) {
-                return __pyx_t_double_complex_from_parts(a.real / b.real, a.imag / b.imag);
-            } else {
-                double r = b.imag / b.real;
-                double s = 1.0 / (b.real + b.imag * r);
-                return __pyx_t_double_complex_from_parts(
-                    (a.real + a.imag * r) * s, (a.imag - a.real * r) * s);
-            }
-        } else {
-            double r = b.real / b.imag;
-            double s = 1.0 / (b.imag + b.real * r);
-            return __pyx_t_double_complex_from_parts(
-                (a.real * r + a.imag) * s, (a.imag * r - a.real) * s);
-        }
-    }
-    #else
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_quot_double(__pyx_t_double_complex a, __pyx_t_double_complex b) {
-        if (b.imag == 0) {
-            return __pyx_t_double_complex_from_parts(a.real / b.real, a.imag / b.real);
-        } else {
-            double denom = b.real * b.real + b.imag * b.imag;
-            return __pyx_t_double_complex_from_parts(
-                (a.real * b.real + a.imag * b.imag) / denom,
-                (a.imag * b.real - a.real * b.imag) / denom);
-        }
-    }
-    #endif
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_neg_double(__pyx_t_double_complex a) {
-        __pyx_t_double_complex z;
-        z.real = -a.real;
-        z.imag = -a.imag;
-        return z;
-    }
-    static CYTHON_INLINE int __Pyx_c_is_zero_double(__pyx_t_double_complex a) {
-       return (a.real == 0) && (a.imag == 0);
-    }
-    static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_conj_double(__pyx_t_double_complex a) {
-        __pyx_t_double_complex z;
-        z.real =  a.real;
-        z.imag = -a.imag;
-        return z;
-    }
-    #if 1
-        static CYTHON_INLINE double __Pyx_c_abs_double(__pyx_t_double_complex z) {
-          #if !defined(HAVE_HYPOT) || defined(_MSC_VER)
-            return sqrt(z.real*z.real + z.imag*z.imag);
-          #else
-            return hypot(z.real, z.imag);
-          #endif
-        }
-        static CYTHON_INLINE __pyx_t_double_complex __Pyx_c_pow_double(__pyx_t_double_complex a, __pyx_t_double_complex b) {
-            __pyx_t_double_complex z;
-            double r, lnr, theta, z_r, z_theta;
-            if (b.imag == 0 && b.real == (int)b.real) {
-                if (b.real < 0) {
-                    double denom = a.real * a.real + a.imag * a.imag;
-                    a.real = a.real / denom;
-                    a.imag = -a.imag / denom;
-                    b.real = -b.real;
-                }
-                switch ((int)b.real) {
-                    case 0:
-                        z.real = 1;
-                        z.imag = 0;
-                        return z;
-                    case 1:
-                        return a;
-                    case 2:
-                        z = __Pyx_c_prod_double(a, a);
-                        return __Pyx_c_prod_double(a, a);
-                    case 3:
-                        z = __Pyx_c_prod_double(a, a);
-                        return __Pyx_c_prod_double(z, a);
-                    case 4:
-                        z = __Pyx_c_prod_double(a, a);
-                        return __Pyx_c_prod_double(z, z);
-                }
-            }
-            if (a.imag == 0) {
-                if (a.real == 0) {
-                    return a;
-                } else if (b.imag == 0) {
-                    z.real = pow(a.real, b.real);
-                    z.imag = 0;
-                    return z;
-                } else if (a.real > 0) {
-                    r = a.real;
-                    theta = 0;
-                } else {
-                    r = -a.real;
-                    theta = atan2(0, -1);
-                }
-            } else {
-                r = __Pyx_c_abs_double(a);
-                theta = atan2(a.imag, a.real);
-            }
-            lnr = log(r);
-            z_r = exp(lnr * b.real - theta * b.imag);
-            z_theta = theta * b.real + lnr * b.imag;
-            z.real = z_r * cos(z_theta);
-            z.imag = z_r * sin(z_theta);
-            return z;
-        }
-    #endif
-#endif
-
 /* CIntToPy */
-static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value) {
-    const long neg_one = (long) ((long) 0 - (long) 1), const_zero = (long) 0;
+static CYTHON_INLINE PyObject* __Pyx_PyInt_From_int(int value) {
+    const int neg_one = (int) ((int) 0 - (int) 1), const_zero = (int) 0;
     const int is_unsigned = neg_one > const_zero;
     if (is_unsigned) {
-        if (sizeof(long) < sizeof(long)) {
+        if (sizeof(int) < sizeof(long)) {
             return PyInt_FromLong((long) value);
-        } else if (sizeof(long) <= sizeof(unsigned long)) {
+        } else if (sizeof(int) <= sizeof(unsigned long)) {
             return PyLong_FromUnsignedLong((unsigned long) value);
 #ifdef HAVE_LONG_LONG
-        } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
+        } else if (sizeof(int) <= sizeof(unsigned PY_LONG_LONG)) {
             return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
 #endif
         }
     } else {
-        if (sizeof(long) <= sizeof(long)) {
+        if (sizeof(int) <= sizeof(long)) {
             return PyInt_FromLong((long) value);
 #ifdef HAVE_LONG_LONG
-        } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
+        } else if (sizeof(int) <= sizeof(PY_LONG_LONG)) {
             return PyLong_FromLongLong((PY_LONG_LONG) value);
 #endif
         }
     }
     {
         int one = 1; int little = (int)*(unsigned char *)&one;
         unsigned char *bytes = (unsigned char *)&value;
-        return _PyLong_FromByteArray(bytes, sizeof(long),
+        return _PyLong_FromByteArray(bytes, sizeof(int),
                                      little, !is_unsigned);
     }
 }
 
 /* CIntFromPyVerify */
 #define __PYX_VERIFY_RETURN_INT(target_type, func_type, func_value)\
     __PYX__VERIFY_RETURN_INT(target_type, func_type, func_value, 0)
@@ -5298,164 +5929,195 @@
                 else\
                     goto raise_overflow;\
             }\
         }\
         return (target_type) value;\
     }
 
-/* CIntFromPy */
-static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *x) {
+/* CIntToPy */
+static CYTHON_INLINE PyObject* __Pyx_PyInt_From_long(long value) {
     const long neg_one = (long) ((long) 0 - (long) 1), const_zero = (long) 0;
     const int is_unsigned = neg_one > const_zero;
+    if (is_unsigned) {
+        if (sizeof(long) < sizeof(long)) {
+            return PyInt_FromLong((long) value);
+        } else if (sizeof(long) <= sizeof(unsigned long)) {
+            return PyLong_FromUnsignedLong((unsigned long) value);
+#ifdef HAVE_LONG_LONG
+        } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
+            return PyLong_FromUnsignedLongLong((unsigned PY_LONG_LONG) value);
+#endif
+        }
+    } else {
+        if (sizeof(long) <= sizeof(long)) {
+            return PyInt_FromLong((long) value);
+#ifdef HAVE_LONG_LONG
+        } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
+            return PyLong_FromLongLong((PY_LONG_LONG) value);
+#endif
+        }
+    }
+    {
+        int one = 1; int little = (int)*(unsigned char *)&one;
+        unsigned char *bytes = (unsigned char *)&value;
+        return _PyLong_FromByteArray(bytes, sizeof(long),
+                                     little, !is_unsigned);
+    }
+}
+
+/* CIntFromPy */
+static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *x) {
+    const int neg_one = (int) ((int) 0 - (int) 1), const_zero = (int) 0;
+    const int is_unsigned = neg_one > const_zero;
 #if PY_MAJOR_VERSION < 3
     if (likely(PyInt_Check(x))) {
-        if (sizeof(long) < sizeof(long)) {
-            __PYX_VERIFY_RETURN_INT(long, long, PyInt_AS_LONG(x))
+        if (sizeof(int) < sizeof(long)) {
+            __PYX_VERIFY_RETURN_INT(int, long, PyInt_AS_LONG(x))
         } else {
             long val = PyInt_AS_LONG(x);
             if (is_unsigned && unlikely(val < 0)) {
                 goto raise_neg_overflow;
             }
-            return (long) val;
+            return (int) val;
         }
     } else
 #endif
     if (likely(PyLong_Check(x))) {
         if (is_unsigned) {
 #if CYTHON_USE_PYLONG_INTERNALS
             const digit* digits = ((PyLongObject*)x)->ob_digit;
             switch (Py_SIZE(x)) {
-                case  0: return (long) 0;
-                case  1: __PYX_VERIFY_RETURN_INT(long, digit, digits[0])
+                case  0: return (int) 0;
+                case  1: __PYX_VERIFY_RETURN_INT(int, digit, digits[0])
                 case 2:
-                    if (8 * sizeof(long) > 1 * PyLong_SHIFT) {
+                    if (8 * sizeof(int) > 1 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(long) >= 2 * PyLong_SHIFT) {
-                            return (long) (((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(int) >= 2 * PyLong_SHIFT) {
+                            return (int) (((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                         }
                     }
                     break;
                 case 3:
-                    if (8 * sizeof(long) > 2 * PyLong_SHIFT) {
+                    if (8 * sizeof(int) > 2 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(long) >= 3 * PyLong_SHIFT) {
-                            return (long) (((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(int) >= 3 * PyLong_SHIFT) {
+                            return (int) (((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                         }
                     }
                     break;
                 case 4:
-                    if (8 * sizeof(long) > 3 * PyLong_SHIFT) {
+                    if (8 * sizeof(int) > 3 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(long) >= 4 * PyLong_SHIFT) {
-                            return (long) (((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(int) >= 4 * PyLong_SHIFT) {
+                            return (int) (((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
                         }
                     }
                     break;
             }
 #endif
 #if CYTHON_COMPILING_IN_CPYTHON
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
-                    return (long) -1;
+                    return (int) -1;
                 if (unlikely(result == 1))
                     goto raise_neg_overflow;
             }
 #endif
-            if (sizeof(long) <= sizeof(unsigned long)) {
-                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned long, PyLong_AsUnsignedLong(x))
+            if (sizeof(int) <= sizeof(unsigned long)) {
+                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned long, PyLong_AsUnsignedLong(x))
 #ifdef HAVE_LONG_LONG
-            } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
-                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
+            } else if (sizeof(int) <= sizeof(unsigned PY_LONG_LONG)) {
+                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
 #endif
             }
         } else {
 #if CYTHON_USE_PYLONG_INTERNALS
             const digit* digits = ((PyLongObject*)x)->ob_digit;
             switch (Py_SIZE(x)) {
-                case  0: return (long) 0;
-                case -1: __PYX_VERIFY_RETURN_INT(long, sdigit, (sdigit) (-(sdigit)digits[0]))
-                case  1: __PYX_VERIFY_RETURN_INT(long,  digit, +digits[0])
+                case  0: return (int) 0;
+                case -1: __PYX_VERIFY_RETURN_INT(int, sdigit, (sdigit) (-(sdigit)digits[0]))
+                case  1: __PYX_VERIFY_RETURN_INT(int,  digit, +digits[0])
                 case -2:
-                    if (8 * sizeof(long) - 1 > 1 * PyLong_SHIFT) {
+                    if (8 * sizeof(int) - 1 > 1 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
-                            return (long) (((long)-1)*(((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(int) - 1 > 2 * PyLong_SHIFT) {
+                            return (int) (((int)-1)*(((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case 2:
-                    if (8 * sizeof(long) > 1 * PyLong_SHIFT) {
+                    if (8 * sizeof(int) > 1 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
-                            return (long) ((((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(int) - 1 > 2 * PyLong_SHIFT) {
+                            return (int) ((((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case -3:
-                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
+                    if (8 * sizeof(int) - 1 > 2 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
-                            return (long) (((long)-1)*(((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(int) - 1 > 3 * PyLong_SHIFT) {
+                            return (int) (((int)-1)*(((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case 3:
-                    if (8 * sizeof(long) > 2 * PyLong_SHIFT) {
+                    if (8 * sizeof(int) > 2 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
-                            return (long) ((((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(int) - 1 > 3 * PyLong_SHIFT) {
+                            return (int) ((((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case -4:
-                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
+                    if (8 * sizeof(int) - 1 > 3 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
-                            return (long) (((long)-1)*(((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(int) - 1 > 4 * PyLong_SHIFT) {
+                            return (int) (((int)-1)*(((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
                 case 4:
-                    if (8 * sizeof(long) > 3 * PyLong_SHIFT) {
+                    if (8 * sizeof(int) > 3 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
-                            return (long) ((((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(int) - 1 > 4 * PyLong_SHIFT) {
+                            return (int) ((((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
                         }
                     }
                     break;
             }
 #endif
-            if (sizeof(long) <= sizeof(long)) {
-                __PYX_VERIFY_RETURN_INT_EXC(long, long, PyLong_AsLong(x))
+            if (sizeof(int) <= sizeof(long)) {
+                __PYX_VERIFY_RETURN_INT_EXC(int, long, PyLong_AsLong(x))
 #ifdef HAVE_LONG_LONG
-            } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
-                __PYX_VERIFY_RETURN_INT_EXC(long, PY_LONG_LONG, PyLong_AsLongLong(x))
+            } else if (sizeof(int) <= sizeof(PY_LONG_LONG)) {
+                __PYX_VERIFY_RETURN_INT_EXC(int, PY_LONG_LONG, PyLong_AsLongLong(x))
 #endif
             }
         }
         {
 #if CYTHON_COMPILING_IN_PYPY && !defined(_PyLong_AsByteArray)
             PyErr_SetString(PyExc_RuntimeError,
                             "_PyLong_AsByteArray() not available in PyPy, cannot convert large numbers");
 #else
-            long val;
+            int val;
             PyObject *v = __Pyx_PyNumber_IntOrLong(x);
  #if PY_MAJOR_VERSION < 3
             if (likely(v) && !PyLong_Check(v)) {
                 PyObject *tmp = v;
                 v = PyNumber_Long(tmp);
                 Py_DECREF(tmp);
             }
@@ -5467,184 +6129,184 @@
                                               bytes, sizeof(val),
                                               is_little, !is_unsigned);
                 Py_DECREF(v);
                 if (likely(!ret))
                     return val;
             }
 #endif
-            return (long) -1;
+            return (int) -1;
         }
     } else {
-        long val;
+        int val;
         PyObject *tmp = __Pyx_PyNumber_IntOrLong(x);
-        if (!tmp) return (long) -1;
-        val = __Pyx_PyInt_As_long(tmp);
+        if (!tmp) return (int) -1;
+        val = __Pyx_PyInt_As_int(tmp);
         Py_DECREF(tmp);
         return val;
     }
 raise_overflow:
     PyErr_SetString(PyExc_OverflowError,
-        "value too large to convert to long");
-    return (long) -1;
+        "value too large to convert to int");
+    return (int) -1;
 raise_neg_overflow:
     PyErr_SetString(PyExc_OverflowError,
-        "can't convert negative value to long");
-    return (long) -1;
+        "can't convert negative value to int");
+    return (int) -1;
 }
 
 /* CIntFromPy */
-static CYTHON_INLINE int __Pyx_PyInt_As_int(PyObject *x) {
-    const int neg_one = (int) ((int) 0 - (int) 1), const_zero = (int) 0;
+static CYTHON_INLINE long __Pyx_PyInt_As_long(PyObject *x) {
+    const long neg_one = (long) ((long) 0 - (long) 1), const_zero = (long) 0;
     const int is_unsigned = neg_one > const_zero;
 #if PY_MAJOR_VERSION < 3
     if (likely(PyInt_Check(x))) {
-        if (sizeof(int) < sizeof(long)) {
-            __PYX_VERIFY_RETURN_INT(int, long, PyInt_AS_LONG(x))
+        if (sizeof(long) < sizeof(long)) {
+            __PYX_VERIFY_RETURN_INT(long, long, PyInt_AS_LONG(x))
         } else {
             long val = PyInt_AS_LONG(x);
             if (is_unsigned && unlikely(val < 0)) {
                 goto raise_neg_overflow;
             }
-            return (int) val;
+            return (long) val;
         }
     } else
 #endif
     if (likely(PyLong_Check(x))) {
         if (is_unsigned) {
 #if CYTHON_USE_PYLONG_INTERNALS
             const digit* digits = ((PyLongObject*)x)->ob_digit;
             switch (Py_SIZE(x)) {
-                case  0: return (int) 0;
-                case  1: __PYX_VERIFY_RETURN_INT(int, digit, digits[0])
+                case  0: return (long) 0;
+                case  1: __PYX_VERIFY_RETURN_INT(long, digit, digits[0])
                 case 2:
-                    if (8 * sizeof(int) > 1 * PyLong_SHIFT) {
+                    if (8 * sizeof(long) > 1 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(int) >= 2 * PyLong_SHIFT) {
-                            return (int) (((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(long) >= 2 * PyLong_SHIFT) {
+                            return (long) (((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                         }
                     }
                     break;
                 case 3:
-                    if (8 * sizeof(int) > 2 * PyLong_SHIFT) {
+                    if (8 * sizeof(long) > 2 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(int) >= 3 * PyLong_SHIFT) {
-                            return (int) (((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(long) >= 3 * PyLong_SHIFT) {
+                            return (long) (((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                         }
                     }
                     break;
                 case 4:
-                    if (8 * sizeof(int) > 3 * PyLong_SHIFT) {
+                    if (8 * sizeof(long) > 3 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(int) >= 4 * PyLong_SHIFT) {
-                            return (int) (((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0]));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(long) >= 4 * PyLong_SHIFT) {
+                            return (long) (((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0]));
                         }
                     }
                     break;
             }
 #endif
 #if CYTHON_COMPILING_IN_CPYTHON
             if (unlikely(Py_SIZE(x) < 0)) {
                 goto raise_neg_overflow;
             }
 #else
             {
                 int result = PyObject_RichCompareBool(x, Py_False, Py_LT);
                 if (unlikely(result < 0))
-                    return (int) -1;
+                    return (long) -1;
                 if (unlikely(result == 1))
                     goto raise_neg_overflow;
             }
 #endif
-            if (sizeof(int) <= sizeof(unsigned long)) {
-                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned long, PyLong_AsUnsignedLong(x))
+            if (sizeof(long) <= sizeof(unsigned long)) {
+                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned long, PyLong_AsUnsignedLong(x))
 #ifdef HAVE_LONG_LONG
-            } else if (sizeof(int) <= sizeof(unsigned PY_LONG_LONG)) {
-                __PYX_VERIFY_RETURN_INT_EXC(int, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
+            } else if (sizeof(long) <= sizeof(unsigned PY_LONG_LONG)) {
+                __PYX_VERIFY_RETURN_INT_EXC(long, unsigned PY_LONG_LONG, PyLong_AsUnsignedLongLong(x))
 #endif
             }
         } else {
 #if CYTHON_USE_PYLONG_INTERNALS
             const digit* digits = ((PyLongObject*)x)->ob_digit;
             switch (Py_SIZE(x)) {
-                case  0: return (int) 0;
-                case -1: __PYX_VERIFY_RETURN_INT(int, sdigit, (sdigit) (-(sdigit)digits[0]))
-                case  1: __PYX_VERIFY_RETURN_INT(int,  digit, +digits[0])
+                case  0: return (long) 0;
+                case -1: __PYX_VERIFY_RETURN_INT(long, sdigit, (sdigit) (-(sdigit)digits[0]))
+                case  1: __PYX_VERIFY_RETURN_INT(long,  digit, +digits[0])
                 case -2:
-                    if (8 * sizeof(int) - 1 > 1 * PyLong_SHIFT) {
+                    if (8 * sizeof(long) - 1 > 1 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(int) - 1 > 2 * PyLong_SHIFT) {
-                            return (int) (((int)-1)*(((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
+                            return (long) (((long)-1)*(((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case 2:
-                    if (8 * sizeof(int) > 1 * PyLong_SHIFT) {
+                    if (8 * sizeof(long) > 1 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 2 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(int) - 1 > 2 * PyLong_SHIFT) {
-                            return (int) ((((((int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
+                            return (long) ((((((long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case -3:
-                    if (8 * sizeof(int) - 1 > 2 * PyLong_SHIFT) {
+                    if (8 * sizeof(long) - 1 > 2 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(int) - 1 > 3 * PyLong_SHIFT) {
-                            return (int) (((int)-1)*(((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
+                            return (long) (((long)-1)*(((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case 3:
-                    if (8 * sizeof(int) > 2 * PyLong_SHIFT) {
+                    if (8 * sizeof(long) > 2 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 3 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(int) - 1 > 3 * PyLong_SHIFT) {
-                            return (int) ((((((((int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
+                            return (long) ((((((((long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case -4:
-                    if (8 * sizeof(int) - 1 > 3 * PyLong_SHIFT) {
+                    if (8 * sizeof(long) - 1 > 3 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(int, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(int) - 1 > 4 * PyLong_SHIFT) {
-                            return (int) (((int)-1)*(((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, long, -(long) (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
+                            return (long) (((long)-1)*(((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
                 case 4:
-                    if (8 * sizeof(int) > 3 * PyLong_SHIFT) {
+                    if (8 * sizeof(long) > 3 * PyLong_SHIFT) {
                         if (8 * sizeof(unsigned long) > 4 * PyLong_SHIFT) {
-                            __PYX_VERIFY_RETURN_INT(int, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
-                        } else if (8 * sizeof(int) - 1 > 4 * PyLong_SHIFT) {
-                            return (int) ((((((((((int)digits[3]) << PyLong_SHIFT) | (int)digits[2]) << PyLong_SHIFT) | (int)digits[1]) << PyLong_SHIFT) | (int)digits[0])));
+                            __PYX_VERIFY_RETURN_INT(long, unsigned long, (((((((((unsigned long)digits[3]) << PyLong_SHIFT) | (unsigned long)digits[2]) << PyLong_SHIFT) | (unsigned long)digits[1]) << PyLong_SHIFT) | (unsigned long)digits[0])))
+                        } else if (8 * sizeof(long) - 1 > 4 * PyLong_SHIFT) {
+                            return (long) ((((((((((long)digits[3]) << PyLong_SHIFT) | (long)digits[2]) << PyLong_SHIFT) | (long)digits[1]) << PyLong_SHIFT) | (long)digits[0])));
                         }
                     }
                     break;
             }
 #endif
-            if (sizeof(int) <= sizeof(long)) {
-                __PYX_VERIFY_RETURN_INT_EXC(int, long, PyLong_AsLong(x))
+            if (sizeof(long) <= sizeof(long)) {
+                __PYX_VERIFY_RETURN_INT_EXC(long, long, PyLong_AsLong(x))
 #ifdef HAVE_LONG_LONG
-            } else if (sizeof(int) <= sizeof(PY_LONG_LONG)) {
-                __PYX_VERIFY_RETURN_INT_EXC(int, PY_LONG_LONG, PyLong_AsLongLong(x))
+            } else if (sizeof(long) <= sizeof(PY_LONG_LONG)) {
+                __PYX_VERIFY_RETURN_INT_EXC(long, PY_LONG_LONG, PyLong_AsLongLong(x))
 #endif
             }
         }
         {
 #if CYTHON_COMPILING_IN_PYPY && !defined(_PyLong_AsByteArray)
             PyErr_SetString(PyExc_RuntimeError,
                             "_PyLong_AsByteArray() not available in PyPy, cannot convert large numbers");
 #else
-            int val;
+            long val;
             PyObject *v = __Pyx_PyNumber_IntOrLong(x);
  #if PY_MAJOR_VERSION < 3
             if (likely(v) && !PyLong_Check(v)) {
                 PyObject *tmp = v;
                 v = PyNumber_Long(tmp);
                 Py_DECREF(tmp);
             }
@@ -5656,32 +6318,32 @@
                                               bytes, sizeof(val),
                                               is_little, !is_unsigned);
                 Py_DECREF(v);
                 if (likely(!ret))
                     return val;
             }
 #endif
-            return (int) -1;
+            return (long) -1;
         }
     } else {
-        int val;
+        long val;
         PyObject *tmp = __Pyx_PyNumber_IntOrLong(x);
-        if (!tmp) return (int) -1;
-        val = __Pyx_PyInt_As_int(tmp);
+        if (!tmp) return (long) -1;
+        val = __Pyx_PyInt_As_long(tmp);
         Py_DECREF(tmp);
         return val;
     }
 raise_overflow:
     PyErr_SetString(PyExc_OverflowError,
-        "value too large to convert to int");
-    return (int) -1;
+        "value too large to convert to long");
+    return (long) -1;
 raise_neg_overflow:
     PyErr_SetString(PyExc_OverflowError,
-        "can't convert negative value to int");
-    return (int) -1;
+        "can't convert negative value to long");
+    return (long) -1;
 }
 
 /* FastTypeChecks */
 #if CYTHON_COMPILING_IN_CPYTHON
 static int __Pyx_InBases(PyTypeObject *a, PyTypeObject *b) {
     while (a) {
         a = a->tp_base;
```

### Comparing `tkwant-1.0.1/tkwant/onebody/solvers.pyx` & `tkwant-1.1.0rc2/tkwant/onebody/solvers.pyx`

 * *Files 19% similar despite different names*

```diff
@@ -1,72 +1,81 @@
 # -*- coding: utf-8 -*-
 #
-# Copyright 2016 - 2020 tkwant authors.
+# Copyright 2016 - 2022 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Classes for solving the time-dependent Schrödinger equation."""
 
 import numpy as np
 import scipy.integrate
 
-from . cimport kernels
-from . import kernels
-
 
 __all__ = ['Scipy']
 
 
-class Scipy:
+cdef class Scipy:
     """Solve the time-dependent Schrödinger equation using `scipy.integrate`.
 
     This solver will currently only work with the 'dopri5' and 'dop853'
     integrators, as these are the only re-entrant ones.
 
     Parameters
     ----------
-    kernel : `tkwant.onebody.kernels.Kernel`
+    size : int
+        The size of the ``psi`` vector.
     integrator : `scipy.integrate._ode.IntegratorBase`, default: dopri5
         The integrator to use with this solver.
     **integrator_options
         Options to pass when instantiating the integrator.
 
     See Also
     --------
     scipy.integrate.ode
     """
 
+    cdef:
+        object _integrator
+        object _rhs_out
+        object rhs
+        int size
+
     _default_options = {'atol': 1E-9, 'rtol': 1E-9, 'nsteps': int(1E9)}
 
-    def __init__(self, kernel, integrator=scipy.integrate._ode.dopri5, **integrator_options):
-        self.kernel = kernel
+    def __init__(self, size, integrator=scipy.integrate._ode.dopri5, **integrator_options):
         # allocate storage for kernel output
-        self._rhs_out = np.empty((kernel.size,), dtype=complex)
-
+        self._rhs_out = np.empty((size,), dtype=complex)
         options = dict(self._default_options)
         options.update(integrator_options)
         self._integrator = integrator(**options)
         # Factor 2 because Scipy integrators expect real arrays
-        self._integrator.reset(2 * self.kernel.size, has_jac=False)
+        self._integrator.reset(2 * size, has_jac=False)
+        self.size = size
 
     def _rhs(self, t, y):
         # Kernel expects complex, Scipy expects real
-        self.kernel.rhs(y.view(complex), self._rhs_out, t)
+        self.rhs(y.view(complex), self._rhs_out, t)
         return self._rhs_out.view(float)
 
-    def __call__(self, psi, time, next_time):
+    def __call__(self, psi, time, next_time, rhs):
         if time == next_time:
             return psi
+        self.rhs = rhs
+        # self._integrator.reset(2 * self.size, has_jac=False) ## RESET TO BE RE-ENTRANT
         # psi is complex, Scipy expects real
         next_psi, final_time = self._integrator.run(
             self._rhs, lambda: None, psi.view(float), time, next_time, (), ())
         if not self._integrator.success:
             raise RuntimeError('Integration failed between {} and {}'
                                .format(time, next_time))
-        assert final_time == next_time
         return next_psi.view(complex)
 
+    @property
+    def size(self):
+        return self.size
+
 
 default = Scipy
```

### Comparing `tkwant-1.0.1/tkwant/onebody/tests/test_kernels.py` & `tkwant-1.1.0rc2/tkwant/onebody/tests/test_kernels.py`

 * *Files 13% similar despite different names*

```diff
@@ -1,40 +1,37 @@
 # -*- coding: utf-8 -*-
 # Copyright 2016, 2017 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 import pytest
 import numpy as np
 import itertools as it
 import functools
 import scipy.sparse as sp
 import tinyarray as ta
-from numpy.testing import assert_array_almost_equal, assert_almost_equal
+from numpy.testing import assert_array_almost_equal, assert_almost_equal, assert_array_equal
 import kwant
 
 from .. import kernels
 from ... import _common
 
-no_sparse_blas = pytest.mark.skipif(not hasattr(kernels, 'SparseBlas'),
-                                    reason='No sparse BLAS available.')
-
 
 def random_vector(N):
     return np.random.rand(N) + 1j * np.random.rand(N)
 
 
 @pytest.mark.parametrize(('kernel_type',), [
     (kernels.Scipy,),
-    (kernels.Simple,),
-    pytest.param(getattr(kernels, 'SparseBlas', None), marks=no_sparse_blas)
+    (kernels.Simple,)
 ])
 def test_kernel(kernel_type):
     N = 1000
 
     H_simple = sp.eye(N, dtype=complex, format='csr')
     H_rand = sp.rand(N, N, format='csr') + 1j * sp.rand(N, N, format='csr')
 
@@ -56,21 +53,18 @@
 
             w_func = W_func(N, W)
 
             psi = random_vector(N)
             nonstatic = psi if psi_st is None else psi + psi_st
             should_be = -1j * (H.dot(psi) + W.dot(nonstatic))
 
-            py_kern = kernel_type(H, w_func, (), psi_st=psi_st)
-            c_kern = kernels.extract_c_kernel(py_kern)
-            for kern in (py_kern, c_kern):
+            py_kern = kernel_type(H, w_func, psi_st=psi_st)
+            for kern in (py_kern, ):
                 dpsidt = random_vector(N)  # this will be overwritten anyway
-                nevals = kern.nevals
-                kern.rhs(psi, dpsidt, 0)
-                assert kern.nevals == nevals + 1
+                kern.rhs()(psi, dpsidt, 0)
                 assert np.allclose(should_be, dpsidt)
 
             # now test with psi_st smaller than the total size; this will be
             # the case when we have a system with added boundary conditions.
 
             central_norbs = N // 2
             W_part = W.tolil()[:central_norbs, :central_norbs].tocsr()
@@ -85,19 +79,18 @@
             central_psi = psi[:central_norbs]
             should_be = H.dot(psi)
             nonstatic = (central_psi if psi_st is None else
                          central_psi + psi_st_part)
             should_be[:central_norbs] += W_part.dot(nonstatic)
             should_be *= -1j
 
-            py_kern = kernel_type(H, w_func, (), psi_st=psi_st_part)
-            c_kern = kernels.extract_c_kernel(py_kern)
-            for kern in (py_kern, c_kern):
+            py_kern = kernel_type(H, w_func, psi_st=psi_st_part)
+            for kern in (py_kern, ):
                 dpsidt = random_vector(N)  # this will be overwritten anyway
-                kern.rhs(psi, dpsidt, 0)
+                kern.rhs()(psi, dpsidt, 0)
                 assert np.allclose(should_be, dpsidt)
 
 
 def test_perturbation_extractor():
 
     def td_hopping(i, j, time):
         ab = ta.array(sorted((i.tag, j.tag)))
@@ -153,28 +146,96 @@
 
     assert W.nnz == 6
     assert isinstance(W.nnz, int)
 
     wt = W.evaluate(time)
     assert wt.shape == (N, N)
     assert isinstance(wt, sp.coo_matrix)
-    assert np.all(wt.data == wdat)
+    assert_array_almost_equal(wt.data, wdat)
 
     ket = np.random.rand(N) + 1j * np.random.rand(N)
     out = W.apply(time, ket)
     assert isinstance(out, np.ndarray)
     assert len(out) == N
     assert _common.is_type_array(out, 'complex').all()
 
 
+def test_perturbation_extractor_norbs_larger_one():
+
+    # Extract the time dependent perturbation W(t).
+    # Definition: H(t) = H_0 + W(t), W(t) = 0 for t <= 0
+
+    def make_system(n, a=1):
+
+        # central region
+
+        sigma0 = ta.array([[1, 0], [0, 1]])
+        sigmax = ta.array([[0, 1], [1 ,0]])
+        sigmay = ta.array([[0, -1j], [1j, 0]])
+        sigmaz = ta.array([[1, 0], [0, -1]])
+
+        def coupling(site1, site2, time):
+            return - sigma0 - 1j * 0.5 * time * (sigmax + sigmay)
+
+        lat = kwant.lattice.square(a=a, norbs=2)
+        syst = kwant.Builder()
+
+        syst[(lat(i, 0) for i in range(n))]= - sigmaz - 0.5 * (sigmax + sigmaz)
+        syst[((lat(i+1, 0), lat(i, 0)) for i in range(n-1))] = coupling
+
+        lead=kwant.Builder(kwant.TranslationalSymmetry((-a, 0)))
+        lead[lat(0, 0)]= - sigmaz
+        lead[lat.neighbors()] = - sigma0
+        syst.attach_lead(lead)
+        syst.attach_lead(lead.reversed())
+
+        return syst
+
+    syst = make_system(n=4).finalized()
+
+    time = 10
+
+    # W(t) = H(t) - H(0)
+    h0 = syst.hamiltonian_submatrix(params={"time": 0})
+    h10 = syst.hamiltonian_submatrix(params={"time": time})
+    wt_ref = h10 - h0
+
+
+    # extract matrix with evaluate
+    W = kernels.PerturbationExtractor(syst, time_name='time', time_start=0)
+
+    # by return from evaluate
+    wt = W.evaluate(time)
+    assert_array_equal(wt.todense(), wt_ref)
+
+    # by inplace modification from evaluate
+    wt_1 = W.empty()
+    W.evaluate(time, wt_1)
+    assert_array_equal(wt_1.todense(), wt_ref)
+
+    # by return from apply, multiply with unit vectors to get all columns of W
+    for i in range(wt_ref.shape[0]):
+        unit_vec = np.zeros(wt_ref.shape[0], dtype=complex)
+        unit_vec[i] = 1
+        wt_column_i = W.apply(time, unit_vec)
+        assert_array_equal(wt_column_i, wt_ref[:, i])
+
+    # by inplace modification from apply, multiply with unit vectors to get all columns of W
+    for i in range(wt_ref.shape[0]):
+        unit_vec = np.zeros(wt_ref.shape[0], dtype=complex)
+        unit_vec[i] = 1
+        wt_column_i_inplace = np.zeros(wt_ref.shape[0], dtype=complex)
+        W.apply(time, unit_vec, wt_column_i_inplace)
+        assert_array_equal(wt_column_i_inplace, wt_ref[:, i])
+
+
 def test_extract_perturbation():
 
     perturb_types = [kernels.PerturbationExtractor,
-                     kernels.PerturbationInterpolator,
-                     functools.partial(kernels.PerturbationInterpolator, dt=0)]
+                     kernels.PerturbationInterpolator]
 
     def inner_test(fsyst, N):
         for i, perturb in enumerate(perturb_types):
             W = perturb(fsyst, time_name='time', time_start=0)
             H0 = fsyst.hamiltonian_submatrix(params={'time': 0})
             H1 = fsyst.hamiltonian_submatrix(params={'time': 1})
             ket = np.random.rand(N) + 1j * np.random.rand(N)
@@ -182,40 +243,40 @@
             # check return and in-place modification
             if i == 1:  # numerical tolerance for interpolated W(t)
                 assert_array_almost_equal(W.evaluate(1) - (H1 - H0), 0)
             else:
                 assert np.all(W.evaluate(1) == (H1 - H0))
 
             wmat = W.evaluate(1)  # get matrix shape
-            for i in range(len(wmat.data)):
-                wmat.data[i] = 0
+            for j in range(len(wmat.data)):
+                wmat.data[j] = 0
             W.evaluate(1, wmat)    # in-place
             if i == 1:  # numerical tolerance for interpolated W(t)
                 assert_array_almost_equal(wmat - (H1 - H0), 0)
             else:
                 assert np.all(wmat == (H1 - H0))
             # check with wrong size for in-place modification
-            pytest.raises(AssertionError, W.evaluate, 1, sp.coo_matrix((N - 1, N - 1), dtype=np.complex))
-            pytest.raises(AssertionError, W.evaluate, 1, sp.coo_matrix((N + 1, N + 1), dtype=np.complex))
+            pytest.raises(AssertionError, W.evaluate, 1, sp.coo_matrix((N - 1, N - 1), dtype=complex))
+            pytest.raises(AssertionError, W.evaluate, 1, sp.coo_matrix((N + 1, N + 1), dtype=complex))
             # data array attribute of coo matrix has wrong size
-            pytest.raises(AssertionError, W.evaluate, 1, sp.coo_matrix((N, N), dtype=np.complex))
+            pytest.raises(AssertionError, W.evaluate, 1, sp.coo_matrix((N, N), dtype=complex))
 
             assert isinstance(W.evaluate(1), sp.coo_matrix)
 
             # calulate W(t) @ ket
             # calculations not done in same order, only check if close
             # check return and in-place modification
             assert isinstance(W.apply(1, ket), np.ndarray)
             assert np.allclose(W.apply(1, ket), np.dot(H1 - H0, ket))  # return
-            out = np.zeros(N, dtype=np.complex)
+            out = np.zeros(N, dtype=complex)
             W.apply(1, ket, out)  # in-place
             assert np.allclose(out, np.dot(H1 - H0, ket))
             # check with wrong size for in-place modification
-            pytest.raises(AssertionError, W.apply, 1, np.zeros((N - 1), dtype=np.complex))
-            pytest.raises(AssertionError, W.apply, 1, np.zeros((N + 1), dtype=np.complex))
+            pytest.raises(AssertionError, W.apply, 1, np.zeros((N - 1), dtype=complex))
+            pytest.raises(AssertionError, W.apply, 1, np.zeros((N + 1), dtype=complex))
 
     def td_onsite(i, time):
         return 2 + time * kwant.digest.uniform(i.tag)
 
     def td_hopping(i, j, time):
         ab = ta.array(sorted((i.tag, j.tag)))
         return -1 + time * kwant.digest.uniform(ab)
@@ -305,17 +366,14 @@
     syst[(lat2(i) for i in range(N))] = td_onsite2
     syst[lat.neighbors()] = td_hopping
     syst[lat2.neighbors()] = td_hopping2
     syst[kwant.builder.HoppingKind((0,), lat, lat2)] = td_interhopping
 
     fsyst = syst.finalized()
 
-    dt = 2.0
-
     w = kernels.PerturbationExtractor(fsyst, time_name='time', time_start=0)
-    wi = kernels.PerturbationInterpolator(fsyst, time_name='time', time_start=0, dt=dt)
+    wi = kernels.PerturbationInterpolator(fsyst, time_name='time', time_start=0)
 
     for time in [0.4, 0.5, 0.7, 1, 1.6, 2, 2.1, 8.5, 19.8]:
-        time *= dt
         wt = w.evaluate(time)
         wti = wi.evaluate(time)
-        assert_almost_equal(np.max(np.abs(wt - wti)), 0, decimal=5)
+        assert_almost_equal(np.max(np.abs(wt - wti)), 0, decimal=4)
```

### Comparing `tkwant-1.0.1/tkwant/onebody/tests/test_solvers.py` & `tkwant-1.1.0rc2/tkwant/onebody/tests/test_solvers.py`

 * *Files 2% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
 # Copyright 2016-2018 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 import pytest
 from math import cos, sin
 import itertools as it
 import functools as ft
 import numpy as np
 from numpy.testing import assert_array_almost_equal
@@ -257,59 +258,66 @@
 
 
 @pytest.mark.integtest  # run only as integration test
 @all_solvers_kernels()
 def test_infinite_time_independent(solver_type, kernel_type):
     N = 10
     tmax = 5
-    eps = 1.1  # 1E-8  # boundary valid up to time = tmax + 1 instead tmax
     salt = '1'
     E = 1.
     lat = kwant.lattice.square(norbs=2)
     syst = make_system_with_leads(lat, N, make_simple_lead)
     fsyst = syst.finalized()
     norbs = fsyst.site_ranges[-1][-1]
 
-    boundaries = [leads.SimpleBoundary(tmax=tmax)] * 2
+    # naively, one would expect that num_buffer_cells = tmax * vmax / 2
+    # where the factor 2 accounts for the forth and back travel of the pulse
+    # in the lead. due to the non-trivial vacuum in terms of the fermi see,
+    # the pulse "feels" the the border of the lead boundary, even before.
+    # this is why we estimate num_buffer_cells much larger (here by a factor four of above length),
+    # in order to have small reflections with simple boundaries.
+    vmax = 2 * np.linalg.norm(fsyst.leads[0].inter_cell_hopping(), ord=2)
+    num_buffer_cells = 2 * int(vmax * tmax)
+
+    boundaries = [leads.SimpleBoundary(num_buffer_cells)] * 2
 
     ### Starting from the trivial state
     # solution should be zero everywhere
     zeros = np.zeros((norbs,), complex)
     psi = WaveFunction.from_kwant(fsyst, zeros, params={'salt': salt}, boundaries=boundaries,
                                   solver_type=solver_type, kernel_type=kernel_type)
-    for time in (0., tmax / 4, tmax / 2, tmax - eps):
+    for time in (0., tmax / 4, tmax / 2, tmax):
         psi.evolve(time)
         assert np.allclose(psi.psi(), np.zeros((norbs,)))
-    pytest.raises(RuntimeError, psi.evolve, tmax + eps)
 
     ### Start from eigenstate
     # No time dependence and starting from an eigenstate
     # φ means that we should evolve to φ * exp(-1j * E * t).
     # The actual ODE that we solve is 0=0, as W(t) = 0 for this system.
     # Call to Kwant requires time arg to be passed explicitly
     psi_st = kwant.wave_function(fsyst, energy=E, params={'time': 0, 'salt': salt})(0)[0]
     psi = WaveFunction.from_kwant(fsyst, psi_st, params={'salt': salt},
                                   boundaries=boundaries, energy=E,
                                   solver_type=solver_type, kernel_type=kernel_type)
-    for time in (0., tmax / 4, tmax / 2, tmax - eps):
+    for time in (0., tmax / 4, tmax / 2, tmax):
         psi.evolve(time)
         assert np.allclose(psi.psi(), psi_st * np.exp(-1j * E * time))
 
     norbs = fsyst.site_ranges[-1][-1]
     psi_random = np.random.random((norbs,)) + 1j * np.random.random((norbs,))
 
     ### test that boundary conditions are OK by testing that solutions
     ### match when the boundary conditions are extended
-    extended_boundaries = [leads.SimpleBoundary(tmax=2 * tmax)] * 2
+    extended_boundaries = [leads.SimpleBoundary(2 * num_buffer_cells)] * 2
     psi = WaveFunction.from_kwant(fsyst, psi_random, boundaries=boundaries, params={'salt': salt},
                                   solver_type=solver_type, kernel_type=kernel_type)
     psi_ext = WaveFunction.from_kwant(fsyst, psi_random, boundaries=extended_boundaries, params={'salt': salt},
                                       solver_type=solver_type, kernel_type=kernel_type)
     size = psi.psibar.shape[0]  # largest subset of psi_ext and psi
-    for time in (0., tmax / 4, tmax / 2, tmax - eps):
+    for time in (0., tmax / 4, tmax / 2, tmax):
         psi.evolve(time)
         psi_ext.evolve(time)
         assert np.allclose(psi_ext.psi()[:size], psi.psi()[:size])
 
 
 # TODO: pickle works only with the python kernel for the moment.
 # Make it working for all kernels such that the test runs with
@@ -323,15 +331,15 @@
     salt = '1'
     E = 1.
     lat = kwant.lattice.square(norbs=2)
     syst = make_system_with_leads(lat, N, make_simple_lead)
     fsyst = syst.finalized()
     norbs = fsyst.site_ranges[-1][-1]
 
-    boundaries = [leads.SimpleBoundary(tmax=tmax)] * 2
+    boundaries = leads.automatic_boundary(fsyst.leads, tmax, params={'salt': salt})
     psi_st = kwant.wave_function(fsyst, energy=E, params={'time': 0, 'salt': salt})(0)[0]
 
     norbs = fsyst.site_ranges[-1][-1]
     psi_random = np.random.random((norbs,)) + 1j * np.random.random((norbs,))
 
     ### test restarting a calculation
     for psi_k, E in [(psi_random, None), (psi_st, E)]:
@@ -369,15 +377,15 @@
     leads.add_voltage(syst, 0, phi_t)
     leads.add_voltage(syst, 1, phi_t)
     # finalize
     fsyst = syst.finalized()
     nsites, _, norbs = fsyst.site_ranges[-1]
 
     sz_op = kwant.operator.Density(fsyst, SZ)
-    boundaries = [leads.SimpleBoundary(tmax=11.)] * 2
+    boundaries = leads.automatic_boundary(fsyst.leads, tmax=11, params={'salt': salt})
     E = 1.
 
     # same time-dependent voltage everywhere, there should
     # be no change in the observables
     scattering_states = kwant.wave_function(fsyst, energy=E, params={'time': 0, 'salt': salt})
     psi_st = scattering_states(0)[0]
     perturbation_type = kernels.PerturbationExtractor
@@ -439,19 +447,14 @@
         return pytest.mark.parametrize('syst, energy, nb_open_modes',
                                        [(syst, 3, 1)])
     # return open and closed modes
     return pytest.mark.parametrize('syst, energy, nb_open_modes',
                                    [(syst, 3, 1), (syst, 0, 0)])
 
 
-def make_boundaries(nb_leads, tmax=50):
-    boundaries = [leads.SimpleBoundary(tmax=tmax)] * nb_leads
-    return boundaries, tmax
-
-
 def closed_sytem():
     def make_system(a=1, t=1.0, r=10, r_time_dep=3):
         # Start with an empty tight-binding system and a single square lattice.
         # `a` is the lattice constant (by default set to 1 for simplicity).
 
         lat = kwant.lattice.square(a, norbs=1)
 
@@ -564,15 +567,15 @@
     assert params_copy == params
 
 
 @open_sytem()
 def test_WaveFunction_open_system_params_copied(psi_init, syst, energy, params):
 
     params_copy = params.copy()
-    boundaries, tmax = make_boundaries(nb_leads=len(syst.leads))
+    boundaries = leads.automatic_boundary(syst.leads, tmax=50, params=params)
 
     wave_function = WaveFunction.from_kwant(psi_init=psi_init, syst=syst, energy=energy,
                                             boundaries=boundaries, params=params_copy)
 
     assert wave_function.params == params_copy
     wave_function.params = None
     assert params_copy == params
@@ -612,15 +615,16 @@
 
 
 @open_sytem()
 @pytest.mark.integtest
 def test_WaveFunction_open_system_default(psi_init, syst, energy, params):
 
     density_operator = kwant.operator.Density(syst)
-    boundaries, tmax = make_boundaries(nb_leads=len(syst.leads))
+    tmax = 50
+    boundaries = leads.automatic_boundary(syst.leads, tmax, params=params)
 
     wave_function = WaveFunction.from_kwant(psi_init=psi_init, syst=syst, energy=energy,
                                             boundaries=boundaries, params=params)
 
     assert wave_function.time == 0
     if energy is None:
         assert wave_function.energy is None
@@ -647,15 +651,15 @@
 @open_sytem()
 def test_WaveFunction_open_system__init__raises(psi_init, syst, energy, params):
 
     # open system without boundaries
     pytest.raises(ValueError, WaveFunction.from_kwant, psi_init=psi_init, syst=syst,
                   energy=energy, params=params)
 
-    boundaries, tmax = make_boundaries(nb_leads=len(syst.leads), tmax=6)
+    boundaries = leads.automatic_boundary(syst.leads, tmax=6, params=params)
 
     params_with_time = params.copy()
     params_with_time['time'] = 0
     with pytest.raises(KeyError) as exc:
         WaveFunction.from_kwant(psi_init=psi_init, syst=syst, boundaries=boundaries,
                                 energy=energy, params=params_with_time)
     error_string = str(exc.value).strip('\"')  # remove etra quotes
@@ -673,22 +677,14 @@
                                 energy=energy, params=params_not_matching)
     assert str(exc.value) == 'System is missing required arguments: "b"'
 
 
 @closed_sytem()
 def test_WaveFunction_closed_system__init__raises(psi_init, syst, energy, params):
 
-    # provide boundaries to a closed system
-    boundaries, tmax = make_boundaries(nb_leads=len(syst.leads), tmax=6)
-    with pytest.raises(ValueError) as exc:
-        WaveFunction.from_kwant(psi_init=psi_init, syst=syst, boundaries=boundaries,
-                                energy=energy, params=params)
-    msg = 'No boundary conditions must be provided for a system without leads.'
-    assert msg in str(exc.value)
-
     params_with_time = params.copy()
     params_with_time['time'] = 0
     with pytest.raises(KeyError) as exc:
         WaveFunction.from_kwant(psi_init=psi_init, syst=syst,
                                 energy=energy, params=params_with_time)
     error_string = str(exc.value).strip('\"')  # remove etra quotes
     assert error_string == "'params' must not contain time"
@@ -705,27 +701,23 @@
     assert str(exc.value) == 'System is missing required arguments: "B"'
 
 
 @open_sytem()
 @pytest.mark.integtest
 def test_WaveFunction_open_system_evolve_raises(psi_init, syst, energy, params):
 
-    boundaries, tmax = make_boundaries(nb_leads=len(syst.leads), tmax=6)
+    boundaries = leads.automatic_boundary(syst.leads, tmax=6, params=params)
     wave_function = WaveFunction.from_kwant(psi_init=psi_init, syst=syst, energy=energy,
                                             boundaries=boundaries, params=params)
     wave_function.evolve(time=5)
 
     # evolve back in time
     backward_time = wave_function.time - 0.5
     pytest.raises(ValueError, wave_function.evolve, time=backward_time)
 
-    # max evolution time
-    time_larger_tmax = tmax + 2
-    pytest.raises(RuntimeError, wave_function.evolve, time=time_larger_tmax)
-
 
 @closed_sytem()
 @pytest.mark.integtest
 def test_WaveFunction_closed_system_evolve_raises(psi_init, syst, energy, params):
 
     wave_function = WaveFunction.from_kwant(psi_init=psi_init, syst=syst,
                                             energy=energy, params=params)
@@ -735,15 +727,15 @@
     backward_time = wave_function.time - 0.5
     pytest.raises(ValueError, wave_function.evolve, time=backward_time)
 
 
 @open_sytem()
 def test_WaveFunction_open_system_evaluate_raises(psi_init, syst, energy, params):
 
-    boundaries, tmax = make_boundaries(nb_leads=len(syst.leads), tmax=6)
+    boundaries = leads.automatic_boundary(syst.leads, tmax=6, params=params)
     wave_function = WaveFunction.from_kwant(psi_init=psi_init, syst=syst,
                                             energy=energy, boundaries=boundaries, params=params)
 
     # bind should fail
     def radius(site):
         x, y = site.pos
         return np.sqrt(x**2 + y**2)
@@ -792,22 +784,23 @@
             assert state.mode == mode
 
 
 @one_level_system()
 @pytest.mark.parametrize('time', TIMESTEPS)
 def test_scattering_states_against_reference(syst, energy, nb_open_modes, time):
 
-    boundaries, tmax = make_boundaries(nb_leads=len(syst.leads))
-    assert time <= tmax
-
     # test only for one lead/mode pair, as calculations are expensive
     lead = 0
     mode = 0
     params = {'t0': 0, 'A': 0.00157, 'sigma': 24}
 
+    tmax = 50
+    boundaries = leads.automatic_boundary(syst.leads, tmax, params=params)
+    assert time <= tmax
+
     states = ScatteringStates(syst, energy, lead, tmax, params=params)
     state = states[mode]
     state.evolve(time)
 
     # reference result
     tparams = params.copy()
     tparams['time'] = 0
@@ -819,16 +812,17 @@
     assert np.allclose(state.psi(), psi_ref.psi())
 
 
 @one_level_system()
 def test_scattering_states__init__raises(syst, energy, nb_open_modes):
 
     lead = 0
-    boundaries, tmax = make_boundaries(nb_leads=len(syst.leads))
     params = {'t0': 0, 'A': 0.00157, 'sigma': 24}
+    tmax = 50
+    boundaries = leads.automatic_boundary(syst.leads, tmax, params=params)
 
     # system has no leads
     system_without_leads = copy.deepcopy(syst)
     delattr(system_without_leads, 'leads')
     pytest.raises(AttributeError, ScatteringStates, syst=system_without_leads,
                   energy=energy, lead=lead, tmax=tmax, params=params)
     # energy is not a float
@@ -1067,15 +1061,15 @@
     k = np.pi / 6
     psi_init = np.exp(- 0.001 * (xi - 100)**2 + 1j * k * xi)
 
     # hamiltonian matrix
     diag = np.ones(len(xi))
     offdiag = - np.ones(len(xi) - 1)
     H0 = scipy.sparse.diags([diag, offdiag, offdiag],
-                            [0, 1, -1])
+                            [0, 1, -1], dtype=complex)
 
     H0_kwant = syst.hamiltonian_submatrix(params={'time': 0}, sparse=True)
 
     assert_array_almost_equal(H0.todense(), H0_kwant.todense())
 
     wave_func = WaveFunction(H0, W=None, psi_init=psi_init)
```

### Comparing `tkwant-1.0.1/tkwant/system.py` & `tkwant-1.1.0rc2/tkwant/system.py`

 * *Files 22% similar despite different names*

```diff
@@ -1,31 +1,27 @@
 # -*- coding: utf-8 -*-
-# Copyright 2016-2020 tkwant authors.
+# Copyright 2016-2022 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Tools for extracting time-dependent parts of Kwant systems."""
 
-from collections import namedtuple
 import numpy as np
 import inspect
-import warnings
-
-with warnings.catch_warnings():
-    warnings.simplefilter('ignore')
-    import scipy.sparse as sps
+import scipy.sparse as sp
+import kwant
 
 from .import _common
 
-
-__all__ = ['hamiltonian_with_boundaries', 'add_time_to_params',
-           'is_time_dependent_function', 'orb_range', 'EvaluatedSystem']
+__all__ = ['add_time_to_params', 'ExtendedSystem',
+           'is_time_dependent_function', 'orb_range', 'siteId', 'Hamiltonian']
 
 
 def add_time_to_params(params, time_name, time, check_numeric_type=False):
     """Add a ``time_name: time`` key-value pair to a ``params`` dict.
 
     Parameters
     ----------
@@ -56,51 +52,39 @@
         if time_name in params:
             raise KeyError("'params' must not contain {}".format(time_name))
         tparams = params.copy()
     tparams[time_name] = time
     return tparams
 
 
-def is_time_dependent_function(obj, time_name):
-    """Return `True` if `obj` is callable and has a time argument"""
-    return callable(obj) and time_name in str(inspect.signature(obj))
-
-
-class EvaluatedSystem(namedtuple('_EvaluatedSystem',
-                                 ['hamiltonian', 'boundary_slices',
-                                  'solution_validators', 'time_validators'])):
-
+class ExtendedSystem:
     """Hamiltonian matrix of central system + boundary conditions.
 
     Parameters
     ----------
     hamiltonian : `~scipy.sparse.coo_matrix`
         The Hamiltonian matrix of the central system + boundary conditions.
     boundary_slices : sequence of `slice`
         Slices into ``hamiltonian`` that project onto the boundary conditions.
-    solution_validators : sequence of callable
-        One callable per boundary condition. Each callable takes a single
-        argument, an array representing a solution *inside the boundary
-        conditions*, and returns True if the solution is valid, and False
-        otherwise.
-    time_validators : sequence of callable
-        One callable per boundary condition. Each callable has signature
-        ``(next_time)`` and return True if the given boundary condition
-        can be used up to the time ``next_time``, otherwise returns False.
-    """
-
-    def solution_is_valid(self, solution):
-        return all(is_valid(solution[boundary]) for is_valid, boundary
-                   in zip(self.solution_validators, self.boundary_slices))
+    syst : `~kwant.system.FiniteSystem`
+        The original kwant system.
+    tmax : float, optional
+        Optional maximal time until when the boundary is valid.
+    """
+    def __init__(self, syst, H0, boundary_slices, solver, work, tmax=None):
 
-    def time_is_valid(self, time):
-        return all(is_valid(time) for is_valid in self.time_validators)
+        self.syst = syst
+        self.H0 = H0
+        self.boundary_slices = boundary_slices
+        self.solver = solver
+        self.work = work
+        self.tmax = tmax
 
 
-def hamiltonian_with_boundaries(syst, boundaries, params):
+def _hamiltonian_with_boundaries(syst, boundaries, params):
     r"""Generate the Hamiltonian with boundary conditions attached.
 
     Only generate the time-independent part of the Hamiltonian.
     The boundary conditions are represented by matrices :math:`h_n`
     (one per lead) that will form a direct sum with the Hamiltonian
     of the central system, :math:`H_S`:
 
@@ -120,30 +104,28 @@
     params : dict, optional
         Extra arguments to pass to the Hamiltonian of ``syst`` at the
         initial time. Must include the time argument explicitly if
         Hamiltonian is time dependent.
 
     Returns
     -------
-    `EvaluatedSystem`
-        The Hamiltonian of the central system, evaluated at t=0,
-        with boundary conditions attached, and accompanying metadata.
+    Hamiltonian H0 and first boundary slice to the lead.
     """
 
     if not len(syst.leads) == len(boundaries):
         raise ValueError('Number of leads= {} does not match '
                          'the number of boundaries provided= {}'
                          .format(len(syst.leads), len(boundaries)))
 
     # generate time-independent Hamiltonian and boundary condition
     # matrices and glue them together
     boundaries = [bc(lead, params) for lead, bc in zip(syst.leads, boundaries)]
     h_0 = syst.hamiltonian_submatrix(params=params, sparse=True)
-    h_tot = sps.block_diag([h_0] + [bdy.hamiltonian for bdy in boundaries],
-                           format='lil')
+    h_tot = sp.block_diag([h_0] + [bdy.hamiltonian for bdy in boundaries],
+                          format='lil')
 
     boundary_slices = []
 
     # couple central system to boundary conditions and vice versa
     orb_offset = h_0.shape[0]
     for lead, lead_iface, boundary in zip(syst.leads, syst.lead_interfaces,
                                           boundaries):
@@ -171,19 +153,20 @@
 
         # remember which orbitals correspond to this boundary condition
         boundary_slices.append(slice(orb_offset,
                                      orb_offset + boundary.hamiltonian.shape[0]))
         # now point to the start of the next boundary condition block
         orb_offset += boundary.hamiltonian.shape[0]
 
-    solution_is_valid = [bdy.solution_is_valid for bdy in boundaries]
-    time_is_valid = [bdy.time_is_valid for bdy in boundaries]
+    return h_tot.tocsr(), boundary_slices
 
-    return EvaluatedSystem(h_tot, boundary_slices,
-                           solution_is_valid, time_is_valid)
+
+def is_time_dependent_function(obj, time_name):
+    """Return `True` if `obj` is callable and has a time argument"""
+    return callable(obj) and time_name in str(inspect.signature(obj))
 
 
 def orb_range(syst, site):
     """Return the first orbital of this and the next site.
 
     Parameters
     ----------
@@ -202,7 +185,127 @@
     # Calculate the index of the run that contains the site.
     column = np.asarray(syst.site_ranges)[:, 0]
     run_idx = np.searchsorted(column, site, 'right') - 1
     # calculate the slice
     first_site, norbs, orb_offset = syst.site_ranges[run_idx]
     orb = orb_offset + (site - first_site) * norbs
     return orb, orb + norbs
+
+
+class siteId:
+    """Get the site index from the lattice position
+
+    For instance, building a kwant system with:
+        lat = kwant.lattice.square(a=1)
+        syst = kwant.Builder()
+        syst[lat(3, 4)] = 42
+        syst = syst.finalized()
+    the second line of:
+        idx = siteId(syst, lat)
+        idx(3, 4)
+    will return the index of the site (whose onsite
+    element has been set to 42 in the lines above) in kwant ordering.
+    """
+
+    def __init__(self, syst, lat):
+
+        if not isinstance(syst, kwant.system.System):
+            raise TypeError("'syst' must be an instance of 'kwant.system.System'")
+
+        self._syst = syst
+        self._lat = lat
+
+    def __call__(self, *lat_coord, orbital=0):
+        """Return the site index for a given lattice index.
+
+        Parameters
+        ----------
+        lat_coord : tuple of int
+            Lattice coordinates to refer to a lattice positions.
+        orbital: int
+            Orbital index
+
+        Returns
+        -------
+        site_id : int
+            The site index in kwant ordering.
+        """
+        site = self._lat(*lat_coord)
+        site_id = self._syst.id_by_site[site]
+        group = None
+        for elem, (xx, _, _) in enumerate(self._syst.site_ranges):
+            if xx > site_id:
+                group = elem - 1
+                break
+        try:
+            first_site, norbs, orb_offset = self._syst.site_ranges[group]
+        except TypeError:
+            raise ValueError('Group position not found')
+        if not 0 <= orbital < norbs:
+            raise ValueError("'0 <= orbital < norbs'; orbital={}, norbs={}"
+                             .format(orbital, norbs))
+        return (site_id - orb_offset) * norbs + orb_offset + orbital
+
+
+def _site_to_matpos(syst, site):
+    pos = syst.id_by_site[site]
+    group = None
+    for elem, (xx, _, _) in enumerate(syst.site_ranges):
+        if xx > pos:
+            group = elem - 1
+            break
+    try:
+        first_site, norbs, orb_offset = syst.site_ranges[group]
+    except TypeError:
+        raise ValueError('Group position not found')
+    return (pos - orb_offset) * norbs + orb_offset, norbs
+
+
+class Hamiltonian:
+    """Construct a Hamiltonian matrix for a single site or hopping.
+
+    Constructing a kwant system with builder is simple.
+    However, once a system is finalized, Kwant has put onsite elements and
+    hoppings in some ordering and it is not evident to get the positions correctly.
+    This routine constructs a Hamiltonian matrix given directly the site,
+    or the hopping position. On initialization, the Hamiltonian matrix is
+    construced. Calling the get method, one needs to provide the matrix
+    subblock, which is inserted at the site or hopping position in
+    the full Hamiltonian matrix.
+    """
+    def __init__(self, syst, site=None, hopping=None):
+        if site is None and hopping is None:
+            raise ValueError('either a site or a hopping must be present')
+        if site is not None and hopping is not None:
+            raise ValueError('site and hopping are mutually exclusive')
+        if site is not None:
+            pos1, norbs1 = _site_to_matpos(syst, site)
+            pos2, norbs2 = pos1, norbs1
+            self._is_hopping = False
+        else:
+            assert len(hopping) == 2
+            pos1, norbs1 = _site_to_matpos(syst, hopping[0])
+            pos2, norbs2 = _site_to_matpos(syst, hopping[1])
+            self._is_hopping = True
+        self._size = syst.site_ranges[-1][2]  # total hamiltonian size
+        row = []
+        col = []
+        for i in range(norbs1):
+            for j in range(norbs2):
+                row.append(pos1 + i)
+                col.append(pos2 + j)
+        if self._is_hopping:
+            self._row = np.asarray(row + col)
+            self._col = np.asarray(col + row)
+        else:
+            self._row = np.asarray(row)
+            self._col = np.asarray(col)
+        return
+
+    def get(self, submat):
+        data = np.asarray(submat).flatten()
+        if self._is_hopping:
+            data = np.append(data, np.asarray(submat).T.conjugate().flatten())
+        qt = sp.coo_matrix((data, (self._row, self._col)), dtype=complex,
+                           shape=(self._size, self._size))
+        qt.eliminate_zeros()
+        return qt
```

### Comparing `tkwant-1.0.1/tkwant/tests/common.py` & `tkwant-1.1.0rc2/tkwant/tests/common.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
 # Copyright 2016 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Common utilities for testing"""
 
 import numpy as np
 import tinyarray as ta
 import kwant
```

### Comparing `tkwant-1.0.1/tkwant/tests/mpi_testdriver.py` & `tkwant-1.1.0rc2/tkwant/tests/mpi_testdriver.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
 # Copyright 2016-2019 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 """Tools for testing parallel code."""
 
 import os
 import inspect
 import subprocess
 
 __all__ = ["wrap"]
```

### Comparing `tkwant-1.0.1/tkwant/tests/test_common.py` & `tkwant-1.1.0rc2/tkwant/tests/test_common.py`

 * *Files 7% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
 # Copyright 2019 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 """Test module for `tkwant._common`"""
 
 import functools
 import pytest
 
 from .._common import get_default_function_argument
```

### Comparing `tkwant-1.0.1/tkwant/tests/test_integration.py` & `tkwant-1.1.0rc2/tkwant/tests/test_integration.py`

 * *Files 5% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
 # Copyright 2016-2019 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 """Test module for `tkwant.integration`"""
 
 import math
 import numpy as np
 from numpy.testing import assert_almost_equal, assert_array_almost_equal
 import pytest
```

### Comparing `tkwant-1.0.1/tkwant/tests/test_leads.py` & `tkwant-1.1.0rc2/tkwant/tests/test_leads.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
-# Copyright 2016-2019 tkwant authors.
+# Copyright 2016-2020 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 """Test module for `tkwant.leads`"""
 
 import pytest
 from pytest import raises
 import cmath
 import tinyarray as ta
@@ -232,40 +233,30 @@
 
 @pytest.mark.parametrize('lead_maker', [make_simple_lead, make_complex_lead])
 def test_free_boundary(lead_maker):
 
     # test invalid construction
     pytest.raises(ValueError, leads.SimpleBoundary, 0)
     pytest.raises(ValueError, leads.SimpleBoundary, -1)
-    pytest.raises(ValueError, leads.SimpleBoundary, num_cells=0)
-    pytest.raises(ValueError, leads.SimpleBoundary, num_cells=-1)
-    pytest.raises(ValueError, leads.SimpleBoundary, tmax=0)
-    pytest.raises(ValueError, leads.SimpleBoundary, tmax=-1)
+    pytest.raises(ValueError, leads.SimpleBoundary, num_buffer_cells=0)
+    pytest.raises(ValueError, leads.SimpleBoundary, num_buffer_cells=-1)
     pytest.raises(TypeError, leads.SimpleBoundary)
-    pytest.raises(TypeError, leads.SimpleBoundary, num_cells=2, tmax=2)
 
     ncells = 10
     lead = lead_maker(kwant.lattice.square(norbs=1)).finalized()
     norbs = lead.cell_size  # 1 orbital per site
     norbs_iface = lead.graph.num_nodes - lead.cell_size  # 1 orbital per site
-    # ord=2 gives us the spectral norm
-    tmax = ncells / (2 * np.linalg.norm(lead.inter_cell_hopping(), ord=2))
-    eps = 1.1  # 1E-8  # boundary valid up to time = tmax + 1 instead tmax
 
-    bdies = [((ncells,), {}), ((), dict(num_cells=ncells)),
-             ((), dict(tmax=tmax))]
+    bdies = [((ncells,), {}), ((), dict(num_buffer_cells=ncells))]
 
     for bdy in (leads.SimpleBoundary(*args, **kwargs) for args, kwargs in bdies):
         evald_bdy = bdy(lead)
         # check format of return arguments
         assert evald_bdy.from_slices == [ta.array([0, norbs])]
         assert evald_bdy.to_slices == [ta.array([0, norbs])]
-        assert evald_bdy.solution_is_valid(None)
-        assert evald_bdy.time_is_valid(tmax - eps)
-        assert not evald_bdy.time_is_valid(tmax + eps)
         # check produced Hamiltonian
         check_boundary_hamiltonian(
             evald_bdy.hamiltonian, norbs, norbs_iface,
             lambda i: lead.cell_hamiltonian(),
             lambda i: lead.inter_cell_hopping())
 
 
@@ -292,16 +283,14 @@
                                               num_buffer_cells=nbuffer_cells)
 
     evald_bdy = bdy(lead)
 
     # check format of return arguments
     assert evald_bdy.from_slices == [ta.array([0, norbs])]
     assert evald_bdy.to_slices == [ta.array([0, norbs])]
-    assert evald_bdy.solution_is_valid(None)
-    assert evald_bdy.time_is_valid(float('inf'))
 
     # check produced Hamiltonian
 
     def absorbing(i):
         if i < nbuffer_cells:
             return 0
         else:
@@ -319,25 +308,74 @@
 
 
 def test_generic_absorbing_boundary():
     # test that hamiltonian is the same, if we construct our generic
     # boundary condition with the same monomial function that is
     # implemented in MonomialAbsorbingBoundary
     lead = make_simple_lead(kwant.lattice.square(norbs=1)).finalized()
-    num_cells, buffer_cells, strength, degree = 100, 40, 14.5, 6
+    num_absorb_cells, num_buffer_cells, strength, degree = 100, 40, 14.5, 6
 
     sigma = leads._monomial_absorbing_potential(strength, degree)
-    boundary_1 = leads.GenericAbsorbingBoundary(num_cells, sigma, buffer_cells)
-    boundary_2 = leads.MonomialAbsorbingBoundary(num_cells, strength, degree, buffer_cells)
+    boundary_1 = leads.GenericAbsorbingBoundary(num_absorb_cells, sigma, num_buffer_cells)
+    boundary_2 = leads.MonomialAbsorbingBoundary(num_absorb_cells, strength, degree, num_buffer_cells)
 
     h1 = boundary_1(lead).hamiltonian
     h2 = boundary_2(lead).hamiltonian
     assert np.allclose(h1.A, h2.A)
 
 
+def test_boundary_condition_attributes():
+
+    num_buffer_cells = 10
+    num_absorb_cells = 20
+
+    simple_boundary = leads.SimpleBoundary(num_buffer_cells)
+
+    assert simple_boundary.num_buffer_cells == num_buffer_cells
+    assert simple_boundary.num_absorb_cells == 0
+    assert simple_boundary.num_total_cells == num_buffer_cells
+
+    strength = 7.
+    degree = 4
+    absorb_boundary = leads.MonomialAbsorbingBoundary(num_absorb_cells,
+                                                      strength, degree,
+                                                      num_buffer_cells)
+
+    assert absorb_boundary.num_buffer_cells == num_buffer_cells
+    assert absorb_boundary.num_absorb_cells == num_absorb_cells
+    assert absorb_boundary.num_total_cells == num_buffer_cells + num_absorb_cells
+
+    # -- with default num_buffer_cells
+    absorb_boundary = leads.MonomialAbsorbingBoundary(num_absorb_cells,
+                                                      strength, degree)
+
+    assert absorb_boundary.num_buffer_cells == 0
+    assert absorb_boundary.num_absorb_cells == num_absorb_cells
+    assert absorb_boundary.num_total_cells == num_absorb_cells
+
+    def imaginary_potential(*args, **kwargs):
+        pass
+
+    absorb_boundary = leads.GenericAbsorbingBoundary(num_absorb_cells,
+                                                     imaginary_potential,
+                                                     num_buffer_cells)
+
+    assert absorb_boundary.num_buffer_cells == num_buffer_cells
+    assert absorb_boundary.num_absorb_cells == num_absorb_cells
+    assert absorb_boundary.num_total_cells == num_buffer_cells + num_absorb_cells
+
+    # -- with default num_buffer_cells
+    absorb_boundary = leads.GenericAbsorbingBoundary(num_absorb_cells,
+                                                     imaginary_potential)
+
+    assert absorb_boundary.num_buffer_cells == 0
+    assert absorb_boundary.num_absorb_cells == num_absorb_cells
+    assert absorb_boundary.num_total_cells == num_absorb_cells
+
+
 def test_absorbing_reflection_solver():
     # create explicitly a system with an imaginary monomial potential
     # and check that this gives the same reflection as by the reflection
     # solver that takes only a lead
 
     def create_system(L, W=1, a=1):
         gamma = 1 / a**2
@@ -395,25 +433,25 @@
     raises(ValueError, leads.AbsorbingReflectionSolver, lead, L, not_callable)
 
 
 def test_reflection_calculation():
 
     lead = make_simple_lead(kwant.lattice.square(norbs=1)).finalized()
     bands = kwant.physics.Bands(lead)
-    num_cells, strength, degree = 100, 14.5, 6
+    num_absorb_cells, strength, degree = 100, 14.5, 6
     imaginary_potential = leads._monomial_absorbing_potential(strength, degree)
 
     not_callable = 1
     not_a_lead = []
     non_existing_band = 5  # band index too high
 
     # -------------------------------------------------------------------
     # --- reflection from energy with AbsorbingReflectionSolver
     # -------------------------------------------------------------------
-    refl_solver = leads.AbsorbingReflectionSolver(lead, num_cells, imaginary_potential)
+    refl_solver = leads.AbsorbingReflectionSolver(lead, num_absorb_cells, imaginary_potential)
 
     # check for scalar energy value
     momenta, mode = 2., 0
     energies, velocities = bands(momenta, derivative_order=1)
     energies = energies[mode]
     velocities = velocities[mode]
 
@@ -449,22 +487,22 @@
     refl, k, vel = refl_solver(energies)
     number_pos_modes = [len(lead.modes(energy=e)[0].momenta) // 2 for e in energies]
     assert np.array([r.size == i for r, i in zip(refl, number_pos_modes)]).all()
     assert np.array([r.size == i for r, i in zip(k, number_pos_modes)]).all()
     assert np.array([r.size == i for r, i in zip(vel, number_pos_modes)]).all()
 
     # check exeptions
-    raises(TypeError, leads.AbsorbingReflectionSolver, not_a_lead, num_cells, imaginary_potential)
-    raises(ValueError, leads.AbsorbingReflectionSolver, lead, - num_cells, imaginary_potential)
-    raises(ValueError, leads.AbsorbingReflectionSolver, lead, num_cells, not_callable)
+    raises(TypeError, leads.AbsorbingReflectionSolver, not_a_lead, num_absorb_cells, imaginary_potential)
+    raises(ValueError, leads.AbsorbingReflectionSolver, lead, - num_absorb_cells, imaginary_potential)
+    raises(ValueError, leads.AbsorbingReflectionSolver, lead, num_absorb_cells, not_callable)
 
     # -------------------------------------------------------------------
     # --- reflection from momentum with AnalyzeReflection
     # -------------------------------------------------------------------
-    analyze_reflection = leads.AnalyzeReflection(lead, num_cells, imaginary_potential)
+    analyze_reflection = leads.AnalyzeReflection(lead, num_absorb_cells, imaginary_potential)
     band = 1
 
     # check for scalar momentum value
     k = 1
     refl, ener, vel = analyze_reflection(k, band)
     energies, velocities = bands(k, derivative_order=1)
     assert_array_almost_equal(refl, [0.80014401727])  # precalculated value
@@ -485,43 +523,43 @@
     refl, ener, vel, k, e0, k0 = analyze_reflection.around_extremum(kmin, kmax, band, nq=2)
     assert_array_almost_equal(refl, [0.74827915, 0.99892086, 0.99892086, 0.64908466])  # precalculated value
     assert_array_almost_equal(ener, [bands(kk)[band] for kk in k])
     assert_array_almost_equal(vel, np.abs([bands(kk, derivative_order=1)[1][band] for kk in k]))
     assert_almost_equal(e0, bands(k0)[band])
 
     # check exeptions
-    raises(TypeError, leads.AnalyzeReflection, not_a_lead, num_cells, imaginary_potential)
-    raises(ValueError, leads.AnalyzeReflection, lead, - num_cells, imaginary_potential)
-    raises(ValueError, leads.AnalyzeReflection, lead, num_cells, not_callable)
+    raises(TypeError, leads.AnalyzeReflection, not_a_lead, num_absorb_cells, imaginary_potential)
+    raises(ValueError, leads.AnalyzeReflection, lead, - num_absorb_cells, imaginary_potential)
+    raises(ValueError, leads.AnalyzeReflection, lead, num_absorb_cells, not_callable)
 
     raises(AssertionError, analyze_reflection, k, non_existing_band)  # band does not exists
 
     raises(ValueError, analyze_reflection.around_extremum, 1, 2, band, nq=2)  # no minima inside [1,2]
     raises(AssertionError, analyze_reflection.around_extremum, kmax, kmin, band, nq=2)  # left/right swapped
     raises(AssertionError, analyze_reflection.around_extremum, 0.5, 2, non_existing_band, nq=2)  # band does not exists
     raises(ValueError, analyze_reflection.around_extremum, kmin, kmax, band, nq=-2)  # neg. nb of points
     raises(ValueError, analyze_reflection.around_extremum, kmin, kmax, band, nq=0)  # no points
 
     # -------------------------------------------------------------------
     # --- reflection from momentum with AnalyzeReflectionMonomial
     # -------------------------------------------------------------------
-    analyze_reflection = leads.AnalyzeReflectionMonomial(lead, num_cells, strength, degree)
+    analyze_reflection = leads.AnalyzeReflectionMonomial(lead, num_absorb_cells, strength, degree)
 
     # calc reflection around minimum
     kmin, kmax = 0.5, 2
     refl, ener, vel, k, e0, k0 = analyze_reflection.around_extremum(kmin, kmax, band, nq=2)
 
     assert_array_almost_equal(refl, [4.617257e-08, 1.000000e+00, 1.000000e+00, 7.045444e-05])  # precalculated value
     assert_array_almost_equal(ener, [bands(kk)[band] for kk in k])
     assert_array_almost_equal(vel, [bands(kk, derivative_order=1)[1][band] for kk in k])
     assert_almost_equal(e0, bands(k0)[band])
 
     # check exeptions
-#    raises(TypeError, leads.AnalyzeReflectionMonomial, not_a_lead, num_cells, strength, degree) # TODO
-    raises(ValueError, leads.AnalyzeReflectionMonomial, lead, - num_cells, strength, degree)
+#    raises(TypeError, leads.AnalyzeReflectionMonomial, not_a_lead, num_absorb_cells, strength, degree) # TODO
+    raises(ValueError, leads.AnalyzeReflectionMonomial, lead, - num_absorb_cells, strength, degree)
 
     raises(ValueError, analyze_reflection.around_extremum, 1, 2, band, nq=2)  # no minima inside
     raises(AssertionError, analyze_reflection.around_extremum, kmax, kmin, band, nq=2)  # left/right swapped
     raises(AssertionError, analyze_reflection.around_extremum, 0.5, 2, non_existing_band, nq=2)  # band does not exists
     raises(ValueError, analyze_reflection.around_extremum, kmin, kmax, band, nq=-2)  # neg. nb of points
     raises(ValueError, analyze_reflection.around_extremum, kmin, kmax, band, nq=0)  # no points
```

### Comparing `tkwant-1.0.1/tkwant/tests/test_logging.py` & `tkwant-1.1.0rc2/tkwant/tests/test_logging.py`

 * *Files 6% similar despite different names*

```diff
@@ -1,15 +1,16 @@
 # -*- coding: utf-8 -*-
 # Copyright 2020 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 """Test module for `tkwant._logging`"""
 
 import logging
 
 from .. import _logging
 
@@ -20,18 +21,14 @@
 
 def test_logging_handler():
     assert isinstance(_logging.handler, logging.Handler)
     assert isinstance(_logging.debug_handler, logging.Handler)
     assert isinstance(_logging.simple_handler, logging.Handler)
 
 
-def test_logging_filter():
-    assert _logging.filter is None
-
-
 def test_logger(caplog):
 
     # make a logger and test that it is working if we use a predefined handler
     logger = _logging.make_logger(name=__name__)
     _logging.handler = _logging.simple_handler
     # no log events for info
     logger.info('this is a logger info')
@@ -47,7 +44,8 @@
     # an event must be logged now at log-level info
     logger.info('this is a logger info')
     assert "this is a logger info" in caplog.text
 
     # we could do the same tests also for the handler and the filter
     # but the caplog fixture catches the logging events even when the handler
     # is the nullhandler or the messages are filtered.
+    _logging.handler = logging.NullHandler()  # turn off logging after this test
```

### Comparing `tkwant-1.0.1/tkwant/tests/test_manybody.py` & `tkwant-1.1.0rc2/tkwant/tests/test_manybody.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,4945 +1,4662 @@
 00000000: 2320 2d2a 2d20 636f 6469 6e67 3a20 7574  # -*- coding: ut
 00000010: 662d 3820 2d2a 2d0a 2320 436f 7079 7269  f-8 -*-.# Copyri
-00000020: 6768 7420 3230 3136 2d32 3032 3020 746b  ght 2016-2020 tk
+00000020: 6768 7420 3230 3136 2d32 3032 3320 746b  ght 2016-2023 tk
 00000030: 7761 6e74 2061 7574 686f 7273 2e0a 230a  want authors..#.
 00000040: 2320 5468 6973 2066 696c 6520 6973 2070  # This file is p
 00000050: 6172 7420 6f66 2074 6b77 616e 742e 2020  art of tkwant.  
 00000060: 4974 2069 7320 7375 626a 6563 7420 746f  It is subject to
 00000070: 2074 6865 206c 6963 656e 7365 2074 6572   the license ter
 00000080: 6d73 2069 6e20 7468 6520 6669 6c65 0a23  ms in the file.#
 00000090: 204c 4943 454e 5345 2e72 7374 2066 6f75   LICENSE.rst fou
 000000a0: 6e64 2069 6e20 7468 6520 746f 702d 6c65  nd in the top-le
 000000b0: 7665 6c20 6469 7265 6374 6f72 7920 6f66  vel directory of
 000000c0: 2074 6869 7320 6469 7374 7269 6275 7469   this distributi
 000000d0: 6f6e 2061 6e64 2061 740a 2320 6874 7470  on and at.# http
-000000e0: 3a2f 2f6b 7761 6e74 2d70 726f 6a65 6374  ://kwant-project
-000000f0: 2e6f 7267 2f6c 6963 656e 7365 2e20 2041  .org/license.  A
-00000100: 206c 6973 7420 6f66 2074 6b77 616e 7420   list of tkwant 
-00000110: 6175 7468 6f72 7320 6361 6e20 6265 2066  authors can be f
-00000120: 6f75 6e64 2069 6e0a 2320 7468 6520 6669  ound in.# the fi
-00000130: 6c65 2041 5554 484f 5253 2e72 7374 2061  le AUTHORS.rst a
-00000140: 7420 7468 6520 746f 702d 6c65 7665 6c20  t the top-level 
-00000150: 6469 7265 6374 6f72 7920 6f66 2074 6869  directory of thi
-00000160: 7320 6469 7374 7269 6275 7469 6f6e 2061  s distribution a
-00000170: 6e64 2061 740a 2320 6874 7470 3a2f 2f6b  nd at.# http://k
-00000180: 7761 6e74 2d70 726f 6a65 6374 2e6f 7267  want-project.org
-00000190: 2f61 7574 686f 7273 2e0a 0a22 2222 5465  /authors..."""Te
-000001a0: 7374 206d 6f64 756c 6520 666f 7220 6074  st module for `t
-000001b0: 6b77 616e 742e 6d61 6e79 626f 6479 6022  kwant.manybody`"
-000001c0: 2222 0a0a 696d 706f 7274 2070 7974 6573  ""..import pytes
-000001d0: 740a 6672 6f6d 2070 7974 6573 7420 696d  t.from pytest im
-000001e0: 706f 7274 2072 6169 7365 730a 696d 706f  port raises.impo
-000001f0: 7274 2063 6d61 7468 0a69 6d70 6f72 7420  rt cmath.import 
-00000200: 6e75 6d70 7920 6173 206e 700a 696d 706f  numpy as np.impo
-00000210: 7274 206b 7761 6e74 0a66 726f 6d20 6e75  rt kwant.from nu
-00000220: 6d70 792e 7465 7374 696e 6720 696d 706f  mpy.testing impo
-00000230: 7274 2028 6173 7365 7274 5f61 7272 6179  rt (assert_array
-00000240: 5f61 6c6d 6f73 745f 6571 7561 6c2c 2061  _almost_equal, a
-00000250: 7373 6572 745f 616c 6d6f 7374 5f65 7175  ssert_almost_equ
-00000260: 616c 290a 6672 6f6d 2073 6369 7079 2e73  al).from scipy.s
-00000270: 7065 6369 616c 2069 6d70 6f72 7420 6572  pecial import er
-00000280: 660a 696d 706f 7274 2066 756e 6374 6f6f  f.import functoo
-00000290: 6c73 0a69 6d70 6f72 7420 6974 6572 746f  ls.import iterto
-000002a0: 6f6c 730a 696d 706f 7274 2063 6f70 790a  ols.import copy.
-000002b0: 696d 706f 7274 2074 696e 7961 7272 6179  import tinyarray
-000002c0: 2061 7320 7461 0a66 726f 6d20 6d61 7468   as ta.from math
-000002d0: 2069 6d70 6f72 7420 636f 732c 2073 696e   import cos, sin
-000002e0: 2c20 6578 700a 0a0a 6672 6f6d 202e 2e20  , exp...from .. 
-000002f0: 696d 706f 7274 206f 6e65 626f 6479 2c20  import onebody, 
-00000300: 6d61 6e79 626f 6479 2c20 6c65 6164 730a  manybody, leads.
-00000310: 2320 6672 6f6d 2074 6b77 616e 742e 7465  # from tkwant.te
-00000320: 7374 732e 636f 6d6d 6f6e 2069 6d70 6f72  sts.common impor
-00000330: 7420 286d 616b 655f 7371 7561 7265 2c20  t (make_square, 
-00000340: 6d61 6b65 5f73 7175 6172 655f 7769 7468  make_square_with
-00000350: 5f6c 6561 6473 2c20 6d61 6b65 5f73 696d  _leads, make_sim
-00000360: 706c 655f 6c65 6164 2c0a 2320 2020 2020  ple_lead,.#     
-00000370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00000380: 2020 2020 2020 2020 2020 2020 206d 616b               mak
-00000390: 655f 636f 6d70 6c65 785f 6c65 6164 2c20  e_complex_lead, 
-000003a0: 6368 6563 6b5f 626f 756e 6461 7279 5f68  check_boundary_h
-000003b0: 616d 696c 746f 6e69 616e 290a 0a69 6d70  amiltonian)..imp
-000003c0: 6f72 7420 6b77 616e 7473 7065 6374 7275  ort kwantspectru
-000003d0: 6d0a 0a69 6d70 6f72 7420 7761 726e 696e  m..import warnin
-000003e0: 6773 0a77 6172 6e69 6e67 732e 6669 6c74  gs.warnings.filt
-000003f0: 6572 7761 726e 696e 6773 2822 6967 6e6f  erwarnings("igno
-00000400: 7265 222c 2063 6174 6567 6f72 793d 4465  re", category=De
-00000410: 7072 6563 6174 696f 6e57 6172 6e69 6e67  precationWarning
-00000420: 290a 0a0a 6465 6620 6d61 6b65 5f73 696d  )...def make_sim
-00000430: 706c 655f 6c65 6164 2857 3d33 293a 0a20  ple_lead(W=3):. 
-00000440: 2020 206c 6174 203d 206b 7761 6e74 2e6c     lat = kwant.l
-00000450: 6174 7469 6365 2e73 7175 6172 6528 312c  attice.square(1,
-00000460: 206e 6f72 6273 3d31 290a 2020 2020 7379   norbs=1).    sy
-00000470: 6d20 3d20 6b77 616e 742e 5472 616e 736c  m = kwant.Transl
-00000480: 6174 696f 6e61 6c53 796d 6d65 7472 7928  ationalSymmetry(
-00000490: 282d 312c 2030 2929 0a20 2020 2048 203d  (-1, 0)).    H =
-000004a0: 206b 7761 6e74 2e42 7569 6c64 6572 2873   kwant.Builder(s
-000004b0: 796d 290a 2020 2020 485b 286c 6174 2830  ym).    H[(lat(0
-000004c0: 2c20 7929 2066 6f72 2079 2069 6e20 7261  , y) for y in ra
-000004d0: 6e67 6528 5729 295d 203d 2030 0a20 2020  nge(W))] = 0.   
-000004e0: 2048 5b6c 6174 2e6e 6569 6768 626f 7273   H[lat.neighbors
-000004f0: 2829 5d20 3d20 2d31 0a20 2020 2072 6574  ()] = -1.    ret
-00000500: 7572 6e20 480a 0a0a 6465 6620 6f6e 7369  urn H...def onsi
-00000510: 7465 5f70 6f74 656e 7469 616c 2873 6974  te_potential(sit
-00000520: 652c 2074 696d 652c 2076 293a 0a20 2020  e, time, v):.   
-00000530: 2072 6574 7572 6e20 3420 2a20 2831 202b   return 4 * (1 +
-00000540: 2076 202a 2063 6d61 7468 2e65 7870 282d   v * cmath.exp(-
-00000550: 2031 6a20 2a20 7469 6d65 2929 0a0a 0a64   1j * time))...d
-00000560: 6566 2067 6175 7373 6961 6e28 7469 6d65  ef gaussian(time
-00000570: 2c20 7430 2c20 412c 2073 6967 6d61 293a  , t0, A, sigma):
-00000580: 0a20 2020 2072 6574 7572 6e20 4120 2a20  .    return A * 
-00000590: 2831 202b 2065 7266 2828 7469 6d65 202d  (1 + erf((time -
-000005a0: 2074 3029 202f 2073 6967 6d61 2929 0a0a   t0) / sigma))..
-000005b0: 0a23 2074 696d 6520 6465 7065 6e64 656e  .# time dependen
-000005c0: 7420 636f 7570 6c69 6e67 2077 6974 6820  t coupling with 
-000005d0: 6761 7573 7369 616e 2070 756c 7365 0a64  gaussian pulse.d
-000005e0: 6566 2063 6f75 706c 696e 675f 6e6e 2873  ef coupling_nn(s
-000005f0: 6974 6531 2c20 7369 7465 322c 2074 696d  ite1, site2, tim
-00000600: 652c 2074 302c 2041 2c20 7369 676d 6129  e, t0, A, sigma)
-00000610: 3a0a 2020 2020 7265 7475 726e 202d 2063  :.    return - c
-00000620: 6d61 7468 2e65 7870 282d 2031 6a20 2a20  math.exp(- 1j * 
-00000630: 6761 7573 7369 616e 2874 696d 652c 2074  gaussian(time, t
-00000640: 302c 2041 2c20 7369 676d 6129 290a 0a0a  0, A, sigma))...
-00000650: 6465 6620 6d61 6b65 5f73 7973 7465 6d28  def make_system(
-00000660: 613d 312c 2067 616d 6d61 3d31 2e30 2c20  a=1, gamma=1.0, 
-00000670: 573d 312c 204c 3d33 3029 3a0a 0a20 2020  W=1, L=30):..   
-00000680: 206c 6174 203d 206b 7761 6e74 2e6c 6174   lat = kwant.lat
-00000690: 7469 6365 2e73 7175 6172 6528 613d 612c  tice.square(a=a,
-000006a0: 206e 6f72 6273 3d31 290a 2020 2020 7379   norbs=1).    sy
-000006b0: 7374 203d 206b 7761 6e74 2e42 7569 6c64  st = kwant.Build
-000006c0: 6572 2829 0a0a 2020 2020 2320 4465 6669  er()..    # Defi
-000006d0: 6e65 2074 6865 2073 6361 7474 6572 696e  ne the scatterin
-000006e0: 6720 7265 6769 6f6e 2e0a 2020 2020 7379  g region..    sy
-000006f0: 7374 5b28 6c61 7428 782c 2079 2920 666f  st[(lat(x, y) fo
-00000700: 7220 7820 696e 2072 616e 6765 284c 2920  r x in range(L) 
-00000710: 666f 7220 7920 696e 2072 616e 6765 2857  for y in range(W
-00000720: 2929 5d20 3d20 6f6e 7369 7465 5f70 6f74  ))] = onsite_pot
-00000730: 656e 7469 616c 0a20 2020 2073 7973 745b  ential.    syst[
-00000740: 6c61 742e 6e65 6967 6862 6f72 7328 295d  lat.neighbors()]
-00000750: 203d 202d 6761 6d6d 610a 2020 2020 2320   = -gamma.    # 
-00000760: 7469 6d65 2064 6570 656e 6465 6e74 2063  time dependent c
-00000770: 6f75 706c 696e 6720 6265 7477 6565 6e20  oupling between 
-00000780: 7477 6f20 7369 7465 7320 3020 616e 6420  two sites 0 and 
-00000790: 310a 2020 2020 666f 7220 7920 696e 2072  1.    for y in r
-000007a0: 616e 6765 2857 293a 0a20 2020 2020 2020  ange(W):.       
-000007b0: 2073 7973 745b 6c61 7428 302c 2079 292c   syst[lat(0, y),
-000007c0: 206c 6174 2831 2c20 7929 5d20 3d20 636f   lat(1, y)] = co
-000007d0: 7570 6c69 6e67 5f6e 6e0a 0a20 2020 2023  upling_nn..    #
-000007e0: 2044 6566 696e 6520 616e 6420 6174 7461   Define and atta
-000007f0: 6368 2074 6865 206c 6561 6473 2e0a 2020  ch the leads..  
-00000800: 2020 2320 436f 6e73 7472 7563 7420 7468    # Construct th
-00000810: 6520 6c65 6674 206c 6561 642e 0a20 2020  e left lead..   
-00000820: 206c 6561 6420 3d20 6b77 616e 742e 4275   lead = kwant.Bu
-00000830: 696c 6465 7228 6b77 616e 742e 5472 616e  ilder(kwant.Tran
-00000840: 736c 6174 696f 6e61 6c53 796d 6d65 7472  slationalSymmetr
-00000850: 7928 282d 612c 2030 2929 290a 2020 2020  y((-a, 0))).    
-00000860: 6c65 6164 5b28 6c61 7428 302c 206a 2920  lead[(lat(0, j) 
-00000870: 666f 7220 6a20 696e 2072 616e 6765 2857  for j in range(W
-00000880: 2929 5d20 3d20 3420 2a20 6761 6d6d 610a  ))] = 4 * gamma.
-00000890: 2020 2020 6c65 6164 5b6c 6174 2e6e 6569      lead[lat.nei
-000008a0: 6768 626f 7273 2829 5d20 3d20 2d67 616d  ghbors()] = -gam
-000008b0: 6d61 0a0a 2020 2020 2320 4174 7461 6368  ma..    # Attach
-000008c0: 2074 6865 206c 6566 7420 6c65 6164 2061   the left lead a
-000008d0: 6e64 2069 7473 2072 6576 6572 7365 6420  nd its reversed 
-000008e0: 636f 7079 2e0a 2020 2020 7379 7374 2e61  copy..    syst.a
-000008f0: 7474 6163 685f 6c65 6164 286c 6561 6429  ttach_lead(lead)
-00000900: 0a20 2020 2073 7973 742e 6174 7461 6368  .    syst.attach
-00000910: 5f6c 6561 6428 6c65 6164 2e72 6576 6572  _lead(lead.rever
-00000920: 7365 6428 2929 0a0a 2020 2020 7265 7475  sed())..    retu
-00000930: 726e 2073 7973 740a 0a0a 6465 6620 6d61  rn syst...def ma
-00000940: 6b65 5f74 645f 7379 7374 656d 286c 6174  ke_td_system(lat
-00000950: 2c20 4e2c 2074 645f 6f6e 7369 7465 293a  , N, td_onsite):
-00000960: 0a20 2020 2049 3020 3d20 7461 2e69 6465  .    I0 = ta.ide
-00000970: 6e74 6974 7928 3229 0a20 2020 2073 7973  ntity(2).    sys
-00000980: 7420 3d20 6b77 616e 742e 4275 696c 6465  t = kwant.Builde
-00000990: 7228 290a 2020 2020 7371 7561 7265 203d  r().    square =
-000009a0: 2069 7465 7274 6f6f 6c73 2e70 726f 6475   itertools.produ
-000009b0: 6374 2872 616e 6765 284e 292c 2072 616e  ct(range(N), ran
-000009c0: 6765 284e 2929 0a20 2020 2073 7973 745b  ge(N)).    syst[
-000009d0: 286c 6174 2869 2c20 6a29 2066 6f72 2069  (lat(i, j) for i
-000009e0: 2c20 6a20 696e 2073 7175 6172 6529 5d20  , j in square)] 
-000009f0: 3d20 7464 5f6f 6e73 6974 650a 2020 2020  = td_onsite.    
-00000a00: 7379 7374 5b6c 6174 2e6e 6569 6768 626f  syst[lat.neighbo
-00000a10: 7273 2829 5d20 3d20 2d31 202a 2049 300a  rs()] = -1 * I0.
-00000a20: 2020 2020 7265 7475 726e 2073 7973 740a      return syst.
-00000a30: 0a0a 6465 6620 6d61 6b65 5f74 645f 7379  ..def make_td_sy
-00000a40: 7374 656d 5f77 6974 685f 6c65 6164 7328  stem_with_leads(
-00000a50: 6c61 742c 204e 2c20 6c65 6164 5f6d 616b  lat, N, lead_mak
-00000a60: 6572 2c20 7464 5f6f 6e73 6974 6529 3a0a  er, td_onsite):.
-00000a70: 2020 2020 7379 7374 203d 206d 616b 655f      syst = make_
-00000a80: 7464 5f73 7973 7465 6d28 6c61 742c 204e  td_system(lat, N
-00000a90: 2c20 7464 5f6f 6e73 6974 6529 0a20 2020  , td_onsite).   
-00000aa0: 2073 7973 742e 6174 7461 6368 5f6c 6561   syst.attach_lea
-00000ab0: 6428 6c65 6164 5f6d 616b 6572 286c 6174  d(lead_maker(lat
-00000ac0: 2c20 4e29 290a 2020 2020 7379 7374 2e61  , N)).    syst.a
-00000ad0: 7474 6163 685f 6c65 6164 286c 6561 645f  ttach_lead(lead_
-00000ae0: 6d61 6b65 7228 6c61 742c 204e 292e 7265  maker(lat, N).re
-00000af0: 7665 7273 6564 2829 290a 2020 2020 7265  versed()).    re
-00000b00: 7475 726e 2073 7973 740a 0a0a 4070 7974  turn syst...@pyt
-00000b10: 6573 742e 6669 7874 7572 650a 6465 6620  est.fixture.def 
-00000b20: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
-00000b30: 6d28 293a 0a20 2020 206c 6561 6420 3d20  m():.    lead = 
-00000b40: 6d61 6b65 5f73 696d 706c 655f 6c65 6164  make_simple_lead
-00000b50: 2857 3d32 292e 6669 6e61 6c69 7a65 6428  (W=2).finalized(
-00000b60: 290a 2020 2020 7265 7475 726e 206b 7761  ).    return kwa
-00000b70: 6e74 7370 6563 7472 756d 2e73 7065 6374  ntspectrum.spect
-00000b80: 7275 6d28 6c65 6164 290a 0a0a 4070 7974  rum(lead)...@pyt
-00000b90: 6573 742e 6669 7874 7572 650a 6465 6620  est.fixture.def 
-00000ba0: 666c 6174 5f62 616e 645f 7370 6563 7472  flat_band_spectr
-00000bb0: 756d 2829 3a0a 0a20 2020 2064 6566 206d  um():..    def m
-00000bc0: 616b 655f 6c65 6164 5f77 6974 685f 666c  ake_lead_with_fl
-00000bd0: 6174 5f62 616e 6428 6c6c 3d33 293a 0a20  at_band(ll=3):. 
-00000be0: 2020 2020 2020 206c 6174 203d 206b 7761         lat = kwa
-00000bf0: 6e74 2e6c 6174 7469 6365 2e73 7175 6172  nt.lattice.squar
-00000c00: 6528 6e6f 7262 733d 3129 0a20 2020 2020  e(norbs=1).     
-00000c10: 2020 206c 6561 6420 3d20 6b77 616e 742e     lead = kwant.
-00000c20: 4275 696c 6465 7228 6b77 616e 742e 5472  Builder(kwant.Tr
-00000c30: 616e 736c 6174 696f 6e61 6c53 796d 6d65  anslationalSymme
-00000c40: 7472 7928 282d 312c 2031 2929 290a 2020  try((-1, 1))).  
-00000c50: 2020 2020 2020 6c65 6164 5b5b 6c61 7428        lead[[lat(
-00000c60: 302c 206a 2920 666f 7220 6a20 696e 2072  0, j) for j in r
-00000c70: 616e 6765 286c 6c29 5d5d 203d 2030 0a20  ange(ll)]] = 0. 
-00000c80: 2020 2020 2020 206c 6561 645b 6c61 742e         lead[lat.
-00000c90: 6e65 6967 6862 6f72 7328 295d 203d 202d  neighbors()] = -
-00000ca0: 310a 2020 2020 2020 2020 7265 7475 726e  1.        return
-00000cb0: 206c 6561 640a 0a20 2020 206c 6561 6420   lead..    lead 
-00000cc0: 3d20 6d61 6b65 5f6c 6561 645f 7769 7468  = make_lead_with
-00000cd0: 5f66 6c61 745f 6261 6e64 2829 2e66 696e  _flat_band().fin
-00000ce0: 616c 697a 6564 2829 0a20 2020 2072 6574  alized().    ret
-00000cf0: 7572 6e20 6b77 616e 7473 7065 6374 7275  urn kwantspectru
-00000d00: 6d2e 7370 6563 7472 756d 286c 6561 6429  m.spectrum(lead)
-00000d10: 0a0a 0a40 7079 7465 7374 2e66 6978 7475  ...@pytest.fixtu
-00000d20: 7265 0a64 6566 2075 6e69 666f 726d 5f6f  re.def uniform_o
-00000d30: 6363 7570 6174 696f 6e28 293a 0a20 2020  ccupation():.   
-00000d40: 2064 6566 2075 6e69 666f 726d 5f64 6973   def uniform_dis
-00000d50: 7472 6962 7574 696f 6e28 7829 3a0a 2020  tribution(x):.  
-00000d60: 2020 2020 2020 7265 7475 726e 206e 702e        return np.
-00000d70: 6f6e 6573 286c 656e 2878 2929 0a0a 2020  ones(len(x))..  
-00000d80: 2020 636c 6173 7320 556e 6966 6f72 6d4f    class UniformO
-00000d90: 6363 7570 6174 696f 6e3a 0a20 2020 2020  ccupation:.     
-00000da0: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00000db0: 7365 6c66 293a 0a20 2020 2020 2020 2020  self):.         
-00000dc0: 2020 2073 656c 662e 6469 7374 7269 6275     self.distribu
-00000dd0: 7469 6f6e 203d 2075 6e69 666f 726d 5f64  tion = uniform_d
-00000de0: 6973 7472 6962 7574 696f 6e0a 2020 2020  istribution.    
-00000df0: 2020 2020 2020 2020 7365 6c66 2e62 616e          self.ban
-00000e00: 6473 203d 204e 6f6e 650a 2020 2020 2020  ds = None.      
-00000e10: 2020 2020 2020 7365 6c66 2e65 6e65 7267        self.energ
-00000e20: 795f 7261 6e67 6520 3d20 4e6f 6e65 0a20  y_range = None. 
-00000e30: 2020 2072 6574 7572 6e20 556e 6966 6f72     return Unifor
-00000e40: 6d4f 6363 7570 6174 696f 6e28 290a 0a0a  mOccupation()...
-00000e50: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
-00000e60: 6465 6620 5369 6d70 6c65 496e 7465 7276  def SimpleInterv
-00000e70: 616c 2829 3a0a 0a20 2020 2063 6c61 7373  al():..    class
-00000e80: 2049 6e74 6572 7661 6c3a 0a20 2020 2020   Interval:.     
-00000e90: 2020 2064 6566 205f 5f69 6e69 745f 5f28     def __init__(
-00000ea0: 7365 6c66 2c20 6b6d 696e 2c20 6b6d 6178  self, kmin, kmax
-00000eb0: 293a 0a20 2020 2020 2020 2020 2020 2073  ):.            s
-00000ec0: 656c 662e 6b6d 696e 203d 206b 6d69 6e0a  elf.kmin = kmin.
-00000ed0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00000ee0: 2e6b 6d61 7820 3d20 6b6d 6178 0a20 2020  .kmax = kmax.   
-00000ef0: 2020 2020 2020 2020 2073 656c 662e 6368           self.ch
-00000f00: 6563 6b61 7474 7269 6275 7465 203d 2027  eckattribute = '
-00000f10: 6368 6563 6b27 2020 2320 6475 6d6d 7920  check'  # dummy 
-00000f20: 6174 7472 6962 7574 6520 746f 2063 6865  attribute to che
-00000f30: 636b 2069 6620 6974 2069 7320 636f 7069  ck if it is copi
-00000f40: 6564 0a0a 2020 2020 2020 2020 6465 6620  ed..        def 
-00000f50: 5f5f 6571 5f5f 2873 656c 662c 206f 7468  __eq__(self, oth
-00000f60: 6572 293a 0a20 2020 2020 2020 2020 2020  er):.           
-00000f70: 2072 6574 7572 6e20 2873 656c 662e 6b6d   return (self.km
-00000f80: 696e 203d 3d20 6f74 6865 722e 6b6d 696e  in == other.kmin
-00000f90: 2061 6e64 2073 656c 662e 6b6d 6178 203d   and self.kmax =
-00000fa0: 3d20 6f74 6865 722e 6b6d 6178 2061 6e64  = other.kmax and
-00000fb0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00000fc0: 2020 2020 2073 656c 662e 6368 6563 6b61       self.checka
-00000fd0: 7474 7269 6275 7465 203d 3d20 6f74 6865  ttribute == othe
-00000fe0: 722e 6368 6563 6b61 7474 7269 6275 7465  r.checkattribute
-00000ff0: 290a 0a20 2020 2020 2020 2064 6566 205f  )..        def _
-00001000: 5f6e 655f 5f28 7365 6c66 2c20 6f74 6865  _ne__(self, othe
-00001010: 7229 3a0a 2020 2020 2020 2020 2020 2020  r):.            
-00001020: 7265 7475 726e 206e 6f74 2073 656c 662e  return not self.
-00001030: 5f5f 6571 5f5f 286f 7468 6572 290a 2020  __eq__(other).  
-00001040: 2020 7265 7475 726e 2049 6e74 6572 7661    return Interva
-00001050: 6c0a 0a0a 4070 7974 6573 742e 6669 7874  l...@pytest.fixt
-00001060: 7572 650a 6465 6620 7175 6164 7261 7475  ure.def quadratu
-00001070: 7265 5f69 6e74 6572 7661 6c28 293a 0a20  re_interval():. 
-00001080: 2020 2072 6574 7572 6e20 6d61 6e79 626f     return manybo
-00001090: 6479 2e49 6e74 6572 7661 6c28 6c65 6164  dy.Interval(lead
-000010a0: 3d30 2c20 6261 6e64 3d30 2c20 6b6d 696e  =0, band=0, kmin
-000010b0: 3d30 2c20 6b6d 6178 3d6e 702e 7069 202f  =0, kmax=np.pi /
-000010c0: 2032 290a 0a0a 5641 4c49 445f 4348 454d   2)...VALID_CHEM
-000010d0: 4943 414c 5f50 4f54 454e 5449 414c 5320  ICAL_POTENTIALS 
-000010e0: 3d20 5b2d 666c 6f61 7428 2269 6e66 2229  = [-float("inf")
-000010f0: 2c20 2d31 2e2c 202d 312c 2030 2c20 302e  , -1., -1, 0, 0.
-00001100: 2c20 312c 2031 2e2c 2066 6c6f 6174 2822  , 1, 1., float("
-00001110: 696e 6622 295d 0a56 414c 4944 5f54 454d  inf")].VALID_TEM
-00001120: 5045 5241 5455 5245 5320 3d20 5b30 2c20  PERATURES = [0, 
-00001130: 302e 2c20 312c 2031 2e2c 2066 6c6f 6174  0., 1, 1., float
-00001140: 2822 696e 6622 295d 0a56 414c 4944 5f45  ("inf")].VALID_E
-00001150: 4e45 5247 595f 4355 544f 4646 5320 3d20  NERGY_CUTOFFS = 
-00001160: 5b2d 666c 6f61 7428 2269 6e66 2229 2c20  [-float("inf"), 
-00001170: 2d31 2e2c 202d 312c 2030 2c20 302e 2c20  -1., -1, 0, 0., 
-00001180: 312c 2031 2e2c 2066 6c6f 6174 2822 696e  1, 1., float("in
-00001190: 6622 295d 0a0a 5641 4c49 445f 5155 4144  f")]..VALID_QUAD
-000011a0: 5241 5455 5245 5320 3d20 5b22 6761 7573  RATURES = ["gaus
-000011b0: 736c 6567 656e 6472 6522 2c20 226b 726f  slegendre", "kro
-000011c0: 6e72 6f64 225d 0a56 414c 4944 5f49 4e54  nrod"].VALID_INT
-000011d0: 4547 5241 5449 4f4e 5f56 4152 4941 424c  EGRATION_VARIABL
-000011e0: 4553 203d 205b 2265 6e65 7267 7922 2c20  ES = ["energy", 
-000011f0: 226d 6f6d 656e 7475 6d22 5d0a 0a0a 6465  "momentum"]...de
-00001200: 6620 756e 6b6e 6f77 6e5f 6469 7374 7269  f unknown_distri
-00001210: 6275 7469 6f6e 5f66 756e 6374 696f 6e28  bution_function(
-00001220: 6368 656d 6963 616c 5f70 6f74 656e 7469  chemical_potenti
-00001230: 616c 2c20 7465 6d70 6572 6174 7572 652c  al, temperature,
-00001240: 2065 6e65 7267 7929 3a0a 2020 2020 2222   energy):.    ""
-00001250: 2261 6e20 6172 6269 7472 6172 7920 6469  "an arbitrary di
-00001260: 7374 7269 6275 7469 6f6e 2066 756e 6374  stribution funct
-00001270: 696f 6e20 2868 6572 6520 7468 6520 6665  ion (here the fe
-00001280: 726d 6920 6675 6e63 7469 6f6e 2922 2222  rmi function)"""
-00001290: 0a20 2020 2072 6574 7572 6e20 3120 2f20  .    return 1 / 
-000012a0: 286e 702e 6578 7028 2865 6e65 7267 7920  (np.exp((energy 
-000012b0: 2d20 6368 656d 6963 616c 5f70 6f74 656e  - chemical_poten
-000012c0: 7469 616c 2920 2f20 7465 6d70 6572 6174  tial) / temperat
-000012d0: 7572 6529 202d 2031 290a 0a0a 6465 6620  ure) - 1)...def 
-000012e0: 7465 7374 5f6c 6561 645f 6f63 6375 7061  test_lead_occupa
-000012f0: 7469 6f6e 5f64 6566 6175 6c74 2829 3a0a  tion_default():.
-00001300: 2020 2020 6f63 6375 7061 7469 6f6e 203d      occupation =
-00001310: 206d 616e 7962 6f64 792e 6c65 6164 5f6f   manybody.lead_o
-00001320: 6363 7570 6174 696f 6e28 290a 2020 2020  ccupation().    
-00001330: 6173 7365 7274 2063 616c 6c61 626c 6528  assert callable(
-00001340: 6f63 6375 7061 7469 6f6e 2e64 6973 7472  occupation.distr
-00001350: 6962 7574 696f 6e29 0a20 2020 2061 7373  ibution).    ass
-00001360: 6572 7420 6f63 6375 7061 7469 6f6e 2e64  ert occupation.d
-00001370: 6973 7472 6962 7574 696f 6e28 2d31 2920  istribution(-1) 
-00001380: 3d3d 2031 0a20 2020 2061 7373 6572 7420  == 1.    assert 
-00001390: 6f63 6375 7061 7469 6f6e 2e64 6973 7472  occupation.distr
-000013a0: 6962 7574 696f 6e28 3129 203d 3d20 300a  ibution(1) == 0.
-000013b0: 2020 2020 6173 7365 7274 206c 656e 286f      assert len(o
-000013c0: 6363 7570 6174 696f 6e2e 656e 6572 6779  ccupation.energy
-000013d0: 5f72 616e 6765 2920 3d3d 2031 0a20 2020  _range) == 1.   
-000013e0: 2065 6d69 6e2c 2065 6d61 7820 3d20 6f63   emin, emax = oc
-000013f0: 6375 7061 7469 6f6e 2e65 6e65 7267 795f  cupation.energy_
-00001400: 7261 6e67 655b 305d 0a20 2020 2061 7373  range[0].    ass
-00001410: 6572 7420 656d 696e 2069 7320 4e6f 6e65  ert emin is None
-00001420: 0a20 2020 2061 7373 6572 7420 656d 6178  .    assert emax
-00001430: 203d 3d20 300a 2020 2020 6173 7365 7274   == 0.    assert
-00001440: 206f 6363 7570 6174 696f 6e2e 6261 6e64   occupation.band
-00001450: 7320 6973 204e 6f6e 650a 0a0a 6465 6620  s is None...def 
-00001460: 6d6f 6465 6c5f 7461 736b 7328 293a 0a0a  model_tasks():..
-00001470: 2020 2020 2320 7765 2074 616b 6520 6120      # we take a 
-00001480: 7369 6d70 6c65 2073 7065 6374 7275 6d20  simple spectrum 
-00001490: 7769 7468 206f 6e6c 7920 7477 6f20 6261  with only two ba
-000014a0: 6e64 732e 0a20 2020 2023 2069 7420 6861  nds..    # it ha
-000014b0: 7320 7468 6520 6469 7370 6572 7369 6f6e  s the dispersion
-000014c0: 2045 5f6e 286b 292c 2077 6865 7265 206e   E_n(k), where n
-000014d0: 2069 7320 7468 6520 6261 6e64 2069 6e64   is the band ind
-000014e0: 6578 2061 6e64 206b 2074 6865 206d 6f6d  ex and k the mom
-000014f0: 656e 7475 6d3a 0a20 2020 2023 2045 5f30  entum:.    # E_0
-00001500: 286b 2920 3d20 2d20 2832 2063 6f73 286b  (k) = - (2 cos(k
-00001510: 2920 2b20 3129 0a20 2020 2023 2045 5f31  ) + 1).    # E_1
-00001520: 286b 2920 3d20 2d20 2832 2063 6f73 286b  (k) = - (2 cos(k
-00001530: 2920 2d20 3129 0a0a 2020 2020 6465 6620  ) - 1)..    def 
-00001540: 656e 6572 6779 5f66 756e 6328 6d6f 6d65  energy_func(mome
-00001550: 6e74 756d 293a 0a20 2020 2020 2020 2072  ntum):.        r
-00001560: 6574 7572 6e20 2d20 2832 202a 206e 702e  eturn - (2 * np.
-00001570: 636f 7328 6d6f 6d65 6e74 756d 2920 2b20  cos(momentum) + 
-00001580: 3129 0a0a 2020 2020 6465 6620 7665 6c6f  1)..    def velo
-00001590: 6369 7479 5f66 756e 6328 6d6f 6d65 6e74  city_func(moment
-000015a0: 756d 293a 0a20 2020 2020 2020 2072 6574  um):.        ret
-000015b0: 7572 6e20 3220 2a20 6e70 2e73 696e 286d  urn 2 * np.sin(m
-000015c0: 6f6d 656e 7475 6d29 0a0a 2020 2020 6465  omentum)..    de
-000015d0: 6620 6469 7374 7269 6275 7469 6f6e 5f66  f distribution_f
-000015e0: 756e 6328 656e 6572 6779 293a 0a20 2020  unc(energy):.   
-000015f0: 2020 2020 2072 6574 7572 6e20 3120 2f20       return 1 / 
-00001600: 286e 702e 6578 7028 2865 6e65 7267 7920  (np.exp((energy 
-00001610: 2d20 3129 202f 2030 2e35 2920 2d20 3129  - 1) / 0.5) - 1)
-00001620: 0a0a 2020 2020 696e 7465 7276 616c 5f31  ..    interval_1
-00001630: 203d 206d 616e 7962 6f64 792e 496e 7465   = manybody.Inte
-00001640: 7276 616c 286c 6561 643d 302c 2062 616e  rval(lead=0, ban
-00001650: 643d 302c 206b 6d69 6e3d 302c 206b 6d61  d=0, kmin=0, kma
-00001660: 783d 6e70 2e70 6920 2f20 322c 0a20 2020  x=np.pi / 2,.   
-00001670: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001690: 696e 7465 6772 6174 696f 6e5f 7661 7269  integration_vari
-000016a0: 6162 6c65 3d27 6d6f 6d65 6e74 756d 272c  able='momentum',
-000016b0: 206f 7264 6572 3d34 2c0a 2020 2020 2020   order=4,.      
-000016c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000016d0: 2020 2020 2020 2020 2020 2020 2071 7561               qua
-000016e0: 6472 6174 7572 653d 2767 6175 7373 6c65  drature='gaussle
-000016f0: 6765 6e64 7265 2729 0a0a 2020 2020 2320  gendre')..    # 
-00001700: 6761 7573 7320 6c65 6765 6e64 7265 2061  gauss legendre a
-00001710: 6273 6369 7373 6173 2062 6574 7765 656e  bscissas between
-00001720: 206b 6d69 6e20 3d20 3020 616e 6420 6b6d   kmin = 0 and km
-00001730: 6178 203d 2070 692f 320a 2020 2020 6d6f  ax = pi/2.    mo
-00001740: 6d65 6e74 6120 3d20 5b30 2e31 3039 3036  menta = [0.10906
-00001750: 3332 392c 2030 2e35 3138 3337 3736 382c  329, 0.51837768,
-00001760: 2031 2e30 3532 3431 3836 352c 2031 2e34   1.05241865, 1.4
-00001770: 3631 3733 3330 345d 0a20 2020 2077 6569  6173304].    wei
-00001780: 6768 7473 5f31 203d 205b 302e 3237 3332  ghts_1 = [0.2732
-00001790: 3034 3536 2c20 302e 3531 3231 3933 3631  0456, 0.51219361
-000017a0: 2c20 302e 3531 3231 3933 3631 2c20 302e  , 0.51219361, 0.
-000017b0: 3237 3332 3034 3536 5d0a 0a20 2020 2069  27320456]..    i
-000017c0: 6e74 6572 7661 6c5f 3220 3d20 6d61 6e79  nterval_2 = many
-000017d0: 626f 6479 2e49 6e74 6572 7661 6c28 6c65  body.Interval(le
-000017e0: 6164 3d30 2c20 6261 6e64 3d30 2c20 6b6d  ad=0, band=0, km
-000017f0: 696e 3d30 2c20 6b6d 6178 3d6e 702e 7069  in=0, kmax=np.pi
-00001800: 202f 2032 2c0a 2020 2020 2020 2020 2020   / 2,.          
-00001810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001820: 2020 2020 2020 2020 2069 6e74 6567 7261           integra
-00001830: 7469 6f6e 5f76 6172 6961 626c 653d 2765  tion_variable='e
-00001840: 6e65 7267 7927 2c20 6f72 6465 723d 342c  nergy', order=4,
-00001850: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00001860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001870: 2020 2020 7175 6164 7261 7475 7265 3d27      quadrature='
-00001880: 6761 7573 736c 6567 656e 6472 6527 290a  gausslegendre').
-00001890: 0a20 2020 2023 2067 6175 7373 206c 6567  .    # gauss leg
-000018a0: 656e 6472 6520 6162 7363 6973 7361 7320  endre abscissas 
-000018b0: 6265 7477 6565 6e20 455f 3028 6b6d 696e  between E_0(kmin
-000018c0: 2920 3d20 2d33 2061 6e64 2045 5f30 286b  ) = -3 and E_0(k
-000018d0: 6d61 7829 203d 202d 310a 2020 2020 656e  max) = -1.    en
-000018e0: 6572 6769 6573 203d 205b 2d32 2e38 3631  ergies = [-2.861
-000018f0: 3133 3633 312c 202d 322e 3333 3939 3831  13631, -2.339981
-00001900: 3034 2c20 2d31 2e36 3630 3031 3839 362c  04, -1.66001896,
-00001910: 202d 312e 3133 3838 3633 3639 5d0a 2020   -1.13886369].  
-00001920: 2020 7765 6967 6874 735f 3220 3d20 5b30    weights_2 = [0
-00001930: 2e33 3437 3835 3438 352c 2030 2e36 3532  .34785485, 0.652
-00001940: 3134 3531 352c 2030 2e36 3532 3134 3531  14515, 0.6521451
-00001950: 352c 2030 2e33 3437 3835 3438 355d 0a0a  5, 0.34785485]..
-00001960: 2020 2020 7661 7269 6162 6c65 7320 3d20      variables = 
-00001970: 2827 656e 6572 6779 5f66 756e 632c 2076  ('energy_func, v
-00001980: 656c 6f63 6974 795f 6675 6e63 2c20 6469  elocity_func, di
-00001990: 7374 7269 6275 7469 6f6e 5f66 756e 632c  stribution_func,
-000019a0: 270a 2020 2020 2020 2020 2020 2020 2020  '.              
-000019b0: 2020 2027 696e 7465 7276 616c 2c20 7765     'interval, we
-000019c0: 6967 6874 732c 2078 2c20 785f 7479 7065  ights, x, x_type
-000019d0: 2729 0a20 2020 206d 6f64 656c 203d 205b  ').    model = [
-000019e0: 5d0a 2020 2020 6d6f 6465 6c2e 6170 7065  ].    model.appe
-000019f0: 6e64 2828 656e 6572 6779 5f66 756e 632c  nd((energy_func,
-00001a00: 2076 656c 6f63 6974 795f 6675 6e63 2c20   velocity_func, 
-00001a10: 6469 7374 7269 6275 7469 6f6e 5f66 756e  distribution_fun
-00001a20: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
-00001a30: 2020 2020 2069 6e74 6572 7661 6c5f 312c       interval_1,
-00001a40: 2077 6569 6768 7473 5f31 2c20 6d6f 6d65   weights_1, mome
-00001a50: 6e74 612c 2027 6d6f 6d65 6e74 756d 2729  nta, 'momentum')
-00001a60: 290a 2020 2020 6d6f 6465 6c2e 6170 7065  ).    model.appe
-00001a70: 6e64 2828 656e 6572 6779 5f66 756e 632c  nd((energy_func,
-00001a80: 2076 656c 6f63 6974 795f 6675 6e63 2c20   velocity_func, 
-00001a90: 6469 7374 7269 6275 7469 6f6e 5f66 756e  distribution_fun
-00001aa0: 632c 0a20 2020 2020 2020 2020 2020 2020  c,.             
-00001ab0: 2020 2020 2069 6e74 6572 7661 6c5f 322c       interval_2,
-00001ac0: 2077 6569 6768 7473 5f32 2c20 656e 6572   weights_2, ener
-00001ad0: 6769 6573 2c20 2765 6e65 7267 7927 2929  gies, 'energy'))
-00001ae0: 0a0a 2020 2020 7265 7475 726e 2070 7974  ..    return pyt
-00001af0: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-00001b00: 7269 7a65 2876 6172 6961 626c 6573 2c20  rize(variables, 
-00001b10: 6d6f 6465 6c29 0a0a 0a40 7079 7465 7374  model)...@pytest
-00001b20: 2e6d 6172 6b2e 7061 7261 6d65 7472 697a  .mark.parametriz
-00001b30: 6528 2763 6865 6d69 6361 6c5f 706f 7465  e('chemical_pote
-00001b40: 6e74 6961 6c27 2c20 5641 4c49 445f 4348  ntial', VALID_CH
-00001b50: 454d 4943 414c 5f50 4f54 454e 5449 414c  EMICAL_POTENTIAL
-00001b60: 5329 0a64 6566 2074 6573 745f 6c65 6164  S).def test_lead
-00001b70: 5f6f 6363 7570 6174 696f 6e5f 7661 7279  _occupation_vary
-00001b80: 5f63 6865 6d69 6361 6c5f 706f 7465 6e74  _chemical_potent
-00001b90: 6961 6c28 6368 656d 6963 616c 5f70 6f74  ial(chemical_pot
-00001ba0: 656e 7469 616c 293a 0a20 2020 2023 207a  ential):.    # z
-00001bb0: 6572 6f20 7465 6d70 6572 6174 7572 652c  ero temperature,
-00001bc0: 2066 6572 6d69 2d64 6972 6163 2064 6973   fermi-dirac dis
-00001bd0: 7472 6962 7574 696f 6e0a 2020 2020 6f63  tribution.    oc
-00001be0: 6375 7061 7469 6f6e 203d 206d 616e 7962  cupation = manyb
-00001bf0: 6f64 792e 6c65 6164 5f6f 6363 7570 6174  ody.lead_occupat
-00001c00: 696f 6e28 6368 656d 6963 616c 5f70 6f74  ion(chemical_pot
-00001c10: 656e 7469 616c 3d63 6865 6d69 6361 6c5f  ential=chemical_
-00001c20: 706f 7465 6e74 6961 6c29 0a20 2020 2061  potential).    a
-00001c30: 7373 6572 7420 6c65 6e28 6f63 6375 7061  ssert len(occupa
-00001c40: 7469 6f6e 2e65 6e65 7267 795f 7261 6e67  tion.energy_rang
-00001c50: 6529 203d 3d20 310a 2020 2020 656d 696e  e) == 1.    emin
-00001c60: 2c20 656d 6178 203d 206f 6363 7570 6174  , emax = occupat
-00001c70: 696f 6e2e 656e 6572 6779 5f72 616e 6765  ion.energy_range
-00001c80: 5b30 5d0a 2020 2020 6173 7365 7274 2065  [0].    assert e
-00001c90: 6d69 6e20 6973 204e 6f6e 650a 2020 2020  min is None.    
-00001ca0: 6173 7365 7274 2065 6d61 7820 6973 2063  assert emax is c
-00001cb0: 6865 6d69 6361 6c5f 706f 7465 6e74 6961  hemical_potentia
-00001cc0: 6c0a 0a20 2020 2023 207a 6572 6f20 7465  l..    # zero te
-00001cd0: 6d70 6572 6174 7572 652c 2075 6e6b 6e6f  mperature, unkno
-00001ce0: 776e 2064 6973 7472 6962 7574 696f 6e20  wn distribution 
-00001cf0: 6675 6e63 7469 6f6e 0a20 2020 206f 6363  function.    occ
-00001d00: 7570 6174 696f 6e20 3d20 6d61 6e79 626f  upation = manybo
-00001d10: 6479 2e6c 6561 645f 6f63 6375 7061 7469  dy.lead_occupati
-00001d20: 6f6e 2863 6865 6d69 6361 6c5f 706f 7465  on(chemical_pote
-00001d30: 6e74 6961 6c3d 6368 656d 6963 616c 5f70  ntial=chemical_p
-00001d40: 6f74 656e 7469 616c 2c20 6469 7374 7269  otential, distri
-00001d50: 6275 7469 6f6e 3d75 6e6b 6e6f 776e 5f64  bution=unknown_d
-00001d60: 6973 7472 6962 7574 696f 6e5f 6675 6e63  istribution_func
-00001d70: 7469 6f6e 290a 2020 2020 6173 7365 7274  tion).    assert
-00001d80: 206c 656e 286f 6363 7570 6174 696f 6e2e   len(occupation.
-00001d90: 656e 6572 6779 5f72 616e 6765 2920 3d3d  energy_range) ==
-00001da0: 2031 0a20 2020 2065 6d69 6e2c 2065 6d61   1.    emin, ema
-00001db0: 7820 3d20 6f63 6375 7061 7469 6f6e 2e65  x = occupation.e
-00001dc0: 6e65 7267 795f 7261 6e67 655b 305d 0a20  nergy_range[0]. 
-00001dd0: 2020 2061 7373 6572 7420 656d 696e 2069     assert emin i
-00001de0: 7320 4e6f 6e65 0a20 2020 2061 7373 6572  s None.    asser
-00001df0: 7420 656d 6178 2069 7320 4e6f 6e65 0a0a  t emax is None..
-00001e00: 2020 2020 2320 6669 6e69 7465 2074 656d      # finite tem
-00001e10: 7065 7261 7475 7265 2c20 6665 726d 692d  perature, fermi-
-00001e20: 6469 7261 6320 6469 7374 7269 6275 7469  dirac distributi
-00001e30: 6f6e 0a20 2020 206f 6363 7570 6174 696f  on.    occupatio
-00001e40: 6e20 3d20 6d61 6e79 626f 6479 2e6c 6561  n = manybody.lea
-00001e50: 645f 6f63 6375 7061 7469 6f6e 2863 6865  d_occupation(che
-00001e60: 6d69 6361 6c5f 706f 7465 6e74 6961 6c3d  mical_potential=
-00001e70: 6368 656d 6963 616c 5f70 6f74 656e 7469  chemical_potenti
-00001e80: 616c 2c20 7465 6d70 6572 6174 7572 653d  al, temperature=
-00001e90: 3129 0a20 2020 2065 6666 6563 7469 7665  1).    effective
-00001ea0: 5f65 6d61 7820 3d20 6368 656d 6963 616c  _emax = chemical
-00001eb0: 5f70 6f74 656e 7469 616c 202b 206d 616e  _potential + man
-00001ec0: 7962 6f64 792e 5f66 6572 6d69 5f66 756e  ybody._fermi_fun
-00001ed0: 6374 696f 6e5f 6265 6c6f 775f 6570 7369  ction_below_epsi
-00001ee0: 6c6f 6e28 7465 6d70 6572 6174 7572 653d  lon(temperature=
-00001ef0: 3129 0a20 2020 2061 7373 6572 7420 6c65  1).    assert le
-00001f00: 6e28 6f63 6375 7061 7469 6f6e 2e65 6e65  n(occupation.ene
-00001f10: 7267 795f 7261 6e67 6529 203d 3d20 310a  rgy_range) == 1.
-00001f20: 2020 2020 656d 696e 2c20 656d 6178 203d      emin, emax =
-00001f30: 206f 6363 7570 6174 696f 6e2e 656e 6572   occupation.ener
-00001f40: 6779 5f72 616e 6765 5b30 5d0a 2020 2020  gy_range[0].    
-00001f50: 6173 7365 7274 2065 6d69 6e20 6973 204e  assert emin is N
-00001f60: 6f6e 650a 2020 2020 6173 7365 7274 2065  one.    assert e
-00001f70: 6d61 7820 3d3d 2065 6666 6563 7469 7665  max == effective
-00001f80: 5f65 6d61 780a 0a0a 4070 7974 6573 742e  _emax...@pytest.
-00001f90: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
-00001fa0: 2827 7465 6d70 6572 6174 7572 6527 2c20  ('temperature', 
-00001fb0: 5641 4c49 445f 5445 4d50 4552 4154 5552  VALID_TEMPERATUR
-00001fc0: 4553 290a 6465 6620 7465 7374 5f6c 6561  ES).def test_lea
-00001fd0: 645f 6f63 6375 7061 7469 6f6e 5f76 6172  d_occupation_var
-00001fe0: 795f 7465 6d70 6572 6174 7572 6528 7465  y_temperature(te
-00001ff0: 6d70 6572 6174 7572 6529 3a0a 2020 2020  mperature):.    
-00002000: 2320 544f 444f 3a20 6e6f 2067 6f6f 6420  # TODO: no good 
-00002010: 7465 7374 2066 6f72 2070 7265 6269 6e64  test for prebind
-00002020: 2074 656d 7065 7261 7475 7265 2076 616c   temperature val
-00002030: 7565 2061 7420 7468 6520 6d6f 6d65 6e74  ue at the moment
-00002040: 0a0a 2020 2020 2320 6665 726d 692d 6469  ..    # fermi-di
-00002050: 7261 6320 6469 7374 7269 6275 7469 6f6e  rac distribution
-00002060: 0a20 2020 206f 6363 7570 6174 696f 6e20  .    occupation 
-00002070: 3d20 6d61 6e79 626f 6479 2e6c 6561 645f  = manybody.lead_
-00002080: 6f63 6375 7061 7469 6f6e 2874 656d 7065  occupation(tempe
-00002090: 7261 7475 7265 3d74 656d 7065 7261 7475  rature=temperatu
-000020a0: 7265 290a 2020 2020 6173 7365 7274 206c  re).    assert l
-000020b0: 656e 286f 6363 7570 6174 696f 6e2e 656e  en(occupation.en
-000020c0: 6572 6779 5f72 616e 6765 2920 3d3d 2031  ergy_range) == 1
-000020d0: 0a20 2020 2065 6d69 6e2c 2065 6d61 7820  .    emin, emax 
-000020e0: 3d20 6f63 6375 7061 7469 6f6e 2e65 6e65  = occupation.ene
-000020f0: 7267 795f 7261 6e67 655b 305d 0a20 2020  rgy_range[0].   
-00002100: 2069 6620 7465 6d70 6572 6174 7572 6520   if temperature 
-00002110: 3e20 303a 0a20 2020 2020 2020 2023 2054  > 0:.        # T
-00002120: 4f44 4f3a 2063 6865 636b 0a20 2020 2020  ODO: check.     
-00002130: 2020 2061 7373 6572 7420 656d 6178 203d     assert emax =
-00002140: 3d20 6d61 6e79 626f 6479 2e5f 6665 726d  = manybody._ferm
-00002150: 695f 6675 6e63 7469 6f6e 5f62 656c 6f77  i_function_below
-00002160: 5f65 7073 696c 6f6e 2874 656d 7065 7261  _epsilon(tempera
-00002170: 7475 7265 3d74 656d 7065 7261 7475 7265  ture=temperature
-00002180: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
-00002190: 2020 2020 6173 7365 7274 2065 6d61 7820      assert emax 
-000021a0: 3d3d 2030 0a20 2020 2061 7373 6572 7420  == 0.    assert 
-000021b0: 656d 696e 2069 7320 4e6f 6e65 0a20 2020  emin is None.   
-000021c0: 2061 7373 6572 7420 6361 6c6c 6162 6c65   assert callable
-000021d0: 286f 6363 7570 6174 696f 6e2e 6469 7374  (occupation.dist
-000021e0: 7269 6275 7469 6f6e 290a 0a20 2020 2023  ribution)..    #
-000021f0: 2075 6e6b 6e6f 776e 2064 6973 7472 6962   unknown distrib
-00002200: 7574 696f 6e20 6675 6e63 7469 6f6e 0a20  ution function. 
-00002210: 2020 206f 6363 7570 6174 696f 6e20 3d20     occupation = 
-00002220: 6d61 6e79 626f 6479 2e6c 6561 645f 6f63  manybody.lead_oc
-00002230: 6375 7061 7469 6f6e 2874 656d 7065 7261  cupation(tempera
-00002240: 7475 7265 3d74 656d 7065 7261 7475 7265  ture=temperature
-00002250: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00002260: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002270: 2020 2020 2020 2020 2020 2020 6469 7374              dist
-00002280: 7269 6275 7469 6f6e 3d75 6e6b 6e6f 776e  ribution=unknown
-00002290: 5f64 6973 7472 6962 7574 696f 6e5f 6675  _distribution_fu
-000022a0: 6e63 7469 6f6e 290a 2020 2020 6173 7365  nction).    asse
-000022b0: 7274 206c 656e 286f 6363 7570 6174 696f  rt len(occupatio
-000022c0: 6e2e 656e 6572 6779 5f72 616e 6765 2920  n.energy_range) 
-000022d0: 3d3d 2031 0a20 2020 2065 6d69 6e2c 2065  == 1.    emin, e
-000022e0: 6d61 7820 3d20 6f63 6375 7061 7469 6f6e  max = occupation
-000022f0: 2e65 6e65 7267 795f 7261 6e67 655b 305d  .energy_range[0]
-00002300: 0a20 2020 2061 7373 6572 7420 656d 696e  .    assert emin
-00002310: 2069 7320 4e6f 6e65 0a20 2020 2061 7373   is None.    ass
-00002320: 6572 7420 656d 6178 2069 7320 4e6f 6e65  ert emax is None
-00002330: 0a20 2020 2061 7373 6572 7420 6361 6c6c  .    assert call
-00002340: 6162 6c65 286f 6363 7570 6174 696f 6e2e  able(occupation.
-00002350: 6469 7374 7269 6275 7469 6f6e 290a 0a0a  distribution)...
-00002360: 4070 7974 6573 742e 6d61 726b 2e70 6172  @pytest.mark.par
-00002370: 616d 6574 7269 7a65 2827 656d 6178 272c  ametrize('emax',
-00002380: 2056 414c 4944 5f45 4e45 5247 595f 4355   VALID_ENERGY_CU
-00002390: 544f 4646 5329 0a64 6566 2074 6573 745f  TOFFS).def test_
-000023a0: 6c65 6164 5f6f 6363 7570 6174 696f 6e5f  lead_occupation_
-000023b0: 7661 7279 5f65 6d61 7828 656d 6178 293a  vary_emax(emax):
-000023c0: 0a0a 2020 2020 656e 6572 6779 5f72 616e  ..    energy_ran
-000023d0: 6765 203d 205b 284e 6f6e 652c 2065 6d61  ge = [(None, ema
-000023e0: 7829 5d0a 0a20 2020 2023 207a 6572 6f20  x)]..    # zero 
-000023f0: 7465 6d70 6572 6174 7572 652c 2066 6572  temperature, fer
-00002400: 6d69 2d64 6972 6163 2064 6973 7472 6962  mi-dirac distrib
-00002410: 7574 696f 6e2c 2064 6566 6175 6c74 2065  ution, default e
-00002420: 6d61 7820 6765 7473 206e 6f74 206f 7665  max gets not ove
-00002430: 7277 7269 7474 656e 0a20 2020 206f 6363  rwritten.    occ
-00002440: 7570 6174 696f 6e20 3d20 6d61 6e79 626f  upation = manybo
-00002450: 6479 2e6c 6561 645f 6f63 6375 7061 7469  dy.lead_occupati
-00002460: 6f6e 2865 6e65 7267 795f 7261 6e67 653d  on(energy_range=
-00002470: 656e 6572 6779 5f72 616e 6765 290a 2020  energy_range).  
-00002480: 2020 6173 7365 7274 206c 656e 286f 6363    assert len(occ
-00002490: 7570 6174 696f 6e2e 656e 6572 6779 5f72  upation.energy_r
-000024a0: 616e 6765 2920 3d3d 2031 0a20 2020 205f  ange) == 1.    _
-000024b0: 656d 696e 2c20 5f65 6d61 7820 3d20 6f63  emin, _emax = oc
-000024c0: 6375 7061 7469 6f6e 2e65 6e65 7267 795f  cupation.energy_
-000024d0: 7261 6e67 655b 305d 0a20 2020 2069 6620  range[0].    if 
-000024e0: 656d 6178 203c 3d20 303a 0a20 2020 2020  emax <= 0:.     
-000024f0: 2020 2061 7373 6572 7420 5f65 6d61 7820     assert _emax 
-00002500: 3d3d 2065 6d61 780a 2020 2020 656c 7365  == emax.    else
-00002510: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00002520: 205f 656d 6178 203d 3d20 300a 2020 2020   _emax == 0.    
-00002530: 6173 7365 7274 205f 656d 696e 2069 7320  assert _emin is 
-00002540: 4e6f 6e65 0a0a 2020 2020 2320 7a65 726f  None..    # zero
-00002550: 2074 656d 7065 7261 7475 7265 2c20 6665   temperature, fe
-00002560: 726d 692d 6469 7261 6320 6469 7374 7269  rmi-dirac distri
-00002570: 6275 7469 6f6e 2c20 736f 6d65 2063 6865  bution, some che
-00002580: 6d69 6361 6c20 706f 7465 6e74 6961 6c2c  mical potential,
-00002590: 2064 6566 6175 6c74 2065 6d61 7820 6765   default emax ge
-000025a0: 7473 206e 6f74 206f 7665 7277 7269 7474  ts not overwritt
-000025b0: 656e 0a20 2020 206f 6363 7570 6174 696f  en.    occupatio
-000025c0: 6e20 3d20 6d61 6e79 626f 6479 2e6c 6561  n = manybody.lea
-000025d0: 645f 6f63 6375 7061 7469 6f6e 2865 6e65  d_occupation(ene
-000025e0: 7267 795f 7261 6e67 653d 656e 6572 6779  rgy_range=energy
-000025f0: 5f72 616e 6765 2c20 6368 656d 6963 616c  _range, chemical
-00002600: 5f70 6f74 656e 7469 616c 3d30 2e35 290a  _potential=0.5).
-00002610: 2020 2020 6173 7365 7274 206c 656e 286f      assert len(o
-00002620: 6363 7570 6174 696f 6e2e 656e 6572 6779  ccupation.energy
-00002630: 5f72 616e 6765 2920 3d3d 2031 0a20 2020  _range) == 1.   
-00002640: 205f 656d 696e 2c20 5f65 6d61 7820 3d20   _emin, _emax = 
-00002650: 6f63 6375 7061 7469 6f6e 2e65 6e65 7267  occupation.energ
-00002660: 795f 7261 6e67 655b 305d 0a20 2020 2069  y_range[0].    i
-00002670: 6620 656d 6178 203c 3d20 302e 353a 0a20  f emax <= 0.5:. 
-00002680: 2020 2020 2020 2061 7373 6572 7420 5f65         assert _e
-00002690: 6d61 7820 3d3d 2065 6d61 780a 2020 2020  max == emax.    
-000026a0: 656c 7365 3a0a 2020 2020 2020 2020 6173  else:.        as
-000026b0: 7365 7274 205f 656d 6178 203d 3d20 302e  sert _emax == 0.
-000026c0: 350a 2020 2020 6173 7365 7274 205f 656d  5.    assert _em
-000026d0: 696e 2069 7320 4e6f 6e65 0a0a 2020 2020  in is None..    
-000026e0: 2320 7a65 726f 2074 656d 7065 7261 7475  # zero temperatu
-000026f0: 7265 2c20 756e 6b6e 6f77 6e20 6469 7374  re, unknown dist
-00002700: 7269 6275 7469 6f6e 2066 756e 6374 696f  ribution functio
-00002710: 6e2c 2064 6566 6175 6c74 2065 6d61 7820  n, default emax 
-00002720: 6765 7473 206f 7665 7277 7269 7474 656e  gets overwritten
-00002730: 0a20 2020 206f 6363 7570 6174 696f 6e20  .    occupation 
-00002740: 3d20 6d61 6e79 626f 6479 2e6c 6561 645f  = manybody.lead_
-00002750: 6f63 6375 7061 7469 6f6e 2865 6e65 7267  occupation(energ
-00002760: 795f 7261 6e67 653d 656e 6572 6779 5f72  y_range=energy_r
-00002770: 616e 6765 2c20 6469 7374 7269 6275 7469  ange, distributi
-00002780: 6f6e 3d75 6e6b 6e6f 776e 5f64 6973 7472  on=unknown_distr
-00002790: 6962 7574 696f 6e5f 6675 6e63 7469 6f6e  ibution_function
-000027a0: 290a 2020 2020 6173 7365 7274 206c 656e  ).    assert len
-000027b0: 286f 6363 7570 6174 696f 6e2e 656e 6572  (occupation.ener
-000027c0: 6779 5f72 616e 6765 2920 3d3d 2031 0a20  gy_range) == 1. 
-000027d0: 2020 205f 656d 696e 2c20 5f65 6d61 7820     _emin, _emax 
-000027e0: 3d20 6f63 6375 7061 7469 6f6e 2e65 6e65  = occupation.ene
-000027f0: 7267 795f 7261 6e67 655b 305d 0a20 2020  rgy_range[0].   
-00002800: 2061 7373 6572 7420 5f65 6d61 7820 3d3d   assert _emax ==
-00002810: 2065 6d61 780a 2020 2020 6173 7365 7274   emax.    assert
-00002820: 205f 656d 696e 2069 7320 4e6f 6e65 0a0a   _emin is None..
-00002830: 2020 2020 2320 7a65 726f 2074 656d 7065      # zero tempe
-00002840: 7261 7475 7265 2c20 756e 6b6e 6f77 6e20  rature, unknown 
-00002850: 6469 7374 7269 6275 7469 6f6e 2066 756e  distribution fun
-00002860: 6374 696f 6e2c 2073 6f6d 6520 6368 656d  ction, some chem
-00002870: 6963 616c 2070 6f74 656e 7469 616c 2c20  ical potential, 
-00002880: 6465 6661 756c 7420 656d 6178 2067 6574  default emax get
-00002890: 7320 6f76 6572 7772 6974 7465 6e0a 2020  s overwritten.  
-000028a0: 2020 6f63 6375 7061 7469 6f6e 203d 206d    occupation = m
-000028b0: 616e 7962 6f64 792e 6c65 6164 5f6f 6363  anybody.lead_occ
-000028c0: 7570 6174 696f 6e28 656e 6572 6779 5f72  upation(energy_r
-000028d0: 616e 6765 3d65 6e65 7267 795f 7261 6e67  ange=energy_rang
-000028e0: 652c 0a20 2020 2020 2020 2020 2020 2020  e,.             
-000028f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002900: 2020 2020 2020 2020 2020 2020 2064 6973               dis
-00002910: 7472 6962 7574 696f 6e3d 756e 6b6e 6f77  tribution=unknow
-00002920: 6e5f 6469 7374 7269 6275 7469 6f6e 5f66  n_distribution_f
-00002930: 756e 6374 696f 6e2c 0a20 2020 2020 2020  unction,.       
-00002940: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002960: 2020 2063 6865 6d69 6361 6c5f 706f 7465     chemical_pote
-00002970: 6e74 6961 6c3d 302e 3529 0a20 2020 2061  ntial=0.5).    a
-00002980: 7373 6572 7420 6c65 6e28 6f63 6375 7061  ssert len(occupa
-00002990: 7469 6f6e 2e65 6e65 7267 795f 7261 6e67  tion.energy_rang
-000029a0: 6529 203d 3d20 310a 2020 2020 5f65 6d69  e) == 1.    _emi
-000029b0: 6e2c 205f 656d 6178 203d 206f 6363 7570  n, _emax = occup
-000029c0: 6174 696f 6e2e 656e 6572 6779 5f72 616e  ation.energy_ran
-000029d0: 6765 5b30 5d0a 2020 2020 6173 7365 7274  ge[0].    assert
-000029e0: 205f 656d 6178 203d 3d20 656d 6178 0a20   _emax == emax. 
-000029f0: 2020 2061 7373 6572 7420 5f65 6d69 6e20     assert _emin 
-00002a00: 6973 204e 6f6e 650a 0a20 2020 2023 2066  is None..    # f
-00002a10: 696e 6974 6520 7465 6d70 6572 6174 7572  inite temperatur
-00002a20: 652c 2066 6572 6d69 2d64 6972 6163 2064  e, fermi-dirac d
-00002a30: 6973 7472 6962 7574 696f 6e2c 2064 6566  istribution, def
-00002a40: 6175 6c74 2065 6d61 7820 6765 7473 206f  ault emax gets o
-00002a50: 7665 7277 7269 7474 656e 0a20 2020 206f  verwritten.    o
-00002a60: 6363 7570 6174 696f 6e20 3d20 6d61 6e79  ccupation = many
-00002a70: 626f 6479 2e6c 6561 645f 6f63 6375 7061  body.lead_occupa
-00002a80: 7469 6f6e 2865 6e65 7267 795f 7261 6e67  tion(energy_rang
-00002a90: 653d 656e 6572 6779 5f72 616e 6765 2c20  e=energy_range, 
-00002aa0: 7465 6d70 6572 6174 7572 653d 3129 0a20  temperature=1). 
-00002ab0: 2020 2061 7373 6572 7420 6c65 6e28 6f63     assert len(oc
-00002ac0: 6375 7061 7469 6f6e 2e65 6e65 7267 795f  cupation.energy_
-00002ad0: 7261 6e67 6529 203d 3d20 310a 2020 2020  range) == 1.    
-00002ae0: 5f65 6d69 6e2c 205f 656d 6178 203d 206f  _emin, _emax = o
-00002af0: 6363 7570 6174 696f 6e2e 656e 6572 6779  ccupation.energy
-00002b00: 5f72 616e 6765 5b30 5d0a 2020 2020 6173  _range[0].    as
-00002b10: 7365 7274 205f 656d 6178 203d 3d20 656d  sert _emax == em
-00002b20: 6178 0a20 2020 2061 7373 6572 7420 5f65  ax.    assert _e
-00002b30: 6d69 6e20 6973 204e 6f6e 650a 0a20 2020  min is None..   
-00002b40: 2023 2066 696e 6974 6520 7465 6d70 6572   # finite temper
-00002b50: 6174 7572 652c 2066 6572 6d69 2d64 6972  ature, fermi-dir
-00002b60: 6163 2064 6973 7472 6962 7574 696f 6e2c  ac distribution,
-00002b70: 2073 6f6d 6520 6368 656d 6963 616c 2070   some chemical p
-00002b80: 6f74 656e 7469 616c 2c20 6465 6661 756c  otential, defaul
-00002b90: 7420 656d 6178 2067 6574 7320 6f76 6572  t emax gets over
-00002ba0: 7772 6974 7465 6e0a 2020 2020 6f63 6375  written.    occu
-00002bb0: 7061 7469 6f6e 203d 206d 616e 7962 6f64  pation = manybod
-00002bc0: 792e 6c65 6164 5f6f 6363 7570 6174 696f  y.lead_occupatio
-00002bd0: 6e28 656e 6572 6779 5f72 616e 6765 3d65  n(energy_range=e
-00002be0: 6e65 7267 795f 7261 6e67 652c 0a20 2020  nergy_range,.   
-00002bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002c10: 2020 2020 2020 2074 656d 7065 7261 7475         temperatu
-00002c20: 7265 3d31 2c20 6368 656d 6963 616c 5f70  re=1, chemical_p
-00002c30: 6f74 656e 7469 616c 3d30 2e35 290a 2020  otential=0.5).  
-00002c40: 2020 6173 7365 7274 206c 656e 286f 6363    assert len(occ
-00002c50: 7570 6174 696f 6e2e 656e 6572 6779 5f72  upation.energy_r
-00002c60: 616e 6765 2920 3d3d 2031 0a20 2020 205f  ange) == 1.    _
-00002c70: 656d 696e 2c20 5f65 6d61 7820 3d20 6f63  emin, _emax = oc
-00002c80: 6375 7061 7469 6f6e 2e65 6e65 7267 795f  cupation.energy_
-00002c90: 7261 6e67 655b 305d 0a20 2020 2061 7373  range[0].    ass
-00002ca0: 6572 7420 5f65 6d61 7820 3d3d 2065 6d61  ert _emax == ema
-00002cb0: 780a 2020 2020 6173 7365 7274 205f 656d  x.    assert _em
-00002cc0: 696e 2069 7320 4e6f 6e65 0a0a 0a40 7079  in is None...@py
-00002cd0: 7465 7374 2e6d 6172 6b2e 7061 7261 6d65  test.mark.parame
-00002ce0: 7472 697a 6528 2765 6d69 6e27 2c20 5641  trize('emin', VA
-00002cf0: 4c49 445f 454e 4552 4759 5f43 5554 4f46  LID_ENERGY_CUTOF
-00002d00: 4653 290a 6465 6620 7465 7374 5f6c 6561  FS).def test_lea
-00002d10: 645f 6f63 6375 7061 7469 6f6e 5f76 6172  d_occupation_var
-00002d20: 795f 656d 696e 2865 6d69 6e29 3a0a 0a20  y_emin(emin):.. 
-00002d30: 2020 2065 6e65 7267 795f 7261 6e67 6520     energy_range 
-00002d40: 3d20 5b28 656d 696e 2c20 4e6f 6e65 295d  = [(emin, None)]
-00002d50: 0a0a 2020 2020 2320 7a65 726f 2074 656d  ..    # zero tem
-00002d60: 7065 7261 7475 7265 2c20 6665 726d 692d  perature, fermi-
-00002d70: 6469 7261 6320 6469 7374 7269 6275 7469  dirac distributi
-00002d80: 6f6e 0a20 2020 206f 6363 7570 6174 696f  on.    occupatio
-00002d90: 6e20 3d20 6d61 6e79 626f 6479 2e6c 6561  n = manybody.lea
-00002da0: 645f 6f63 6375 7061 7469 6f6e 2865 6e65  d_occupation(ene
-00002db0: 7267 795f 7261 6e67 653d 656e 6572 6779  rgy_range=energy
-00002dc0: 5f72 616e 6765 290a 2020 2020 6966 2065  _range).    if e
-00002dd0: 6d69 6e20 3c20 303a 2020 2320 7468 6520  min < 0:  # the 
-00002de0: 696e 7465 7276 616c 2069 7320 2861 7420  interval is (at 
-00002df0: 6c65 7374 2070 6172 7469 616c 6c79 2920  lest partially) 
-00002e00: 6265 6c6f 7720 7a65 726f 0a20 2020 2020  below zero.     
-00002e10: 2020 2061 7373 6572 7420 6c65 6e28 6f63     assert len(oc
-00002e20: 6375 7061 7469 6f6e 2e65 6e65 7267 795f  cupation.energy_
-00002e30: 7261 6e67 6529 203d 3d20 310a 2020 2020  range) == 1.    
-00002e40: 2020 2020 5f65 6d69 6e2c 205f 656d 6178      _emin, _emax
-00002e50: 203d 206f 6363 7570 6174 696f 6e2e 656e   = occupation.en
-00002e60: 6572 6779 5f72 616e 6765 5b30 5d0a 2020  ergy_range[0].  
-00002e70: 2020 2020 2020 6173 7365 7274 205f 656d        assert _em
-00002e80: 6178 203d 3d20 300a 2020 2020 2020 2020  ax == 0.        
-00002e90: 6173 7365 7274 205f 656d 696e 203d 3d20  assert _emin == 
-00002ea0: 656d 696e 0a20 2020 2065 6c73 653a 2020  emin.    else:  
-00002eb0: 2320 7468 6520 7768 6f6c 6520 696e 7465  # the whole inte
-00002ec0: 7276 616c 2069 7320 6162 6f76 6520 302c  rval is above 0,
-00002ed0: 2064 6f65 7320 6e6f 7420 636f 6e74 7269   does not contri
-00002ee0: 6275 7465 0a20 2020 2020 2020 2061 7373  bute.        ass
-00002ef0: 6572 7420 6f63 6375 7061 7469 6f6e 2069  ert occupation i
-00002f00: 7320 4e6f 6e65 0a0a 2020 2020 2320 7a65  s None..    # ze
-00002f10: 726f 2074 656d 7065 7261 7475 7265 2c20  ro temperature, 
-00002f20: 6665 726d 692d 6469 7261 6320 6469 7374  fermi-dirac dist
-00002f30: 7269 6275 7469 6f6e 2c20 736f 6d65 2063  ribution, some c
-00002f40: 6865 6d69 6361 6c20 706f 7465 6e74 6961  hemical potentia
-00002f50: 6c0a 2020 2020 6f63 6375 7061 7469 6f6e  l.    occupation
-00002f60: 203d 206d 616e 7962 6f64 792e 6c65 6164   = manybody.lead
-00002f70: 5f6f 6363 7570 6174 696f 6e28 656e 6572  _occupation(ener
-00002f80: 6779 5f72 616e 6765 3d65 6e65 7267 795f  gy_range=energy_
-00002f90: 7261 6e67 652c 2063 6865 6d69 6361 6c5f  range, chemical_
-00002fa0: 706f 7465 6e74 6961 6c3d 3229 0a20 2020  potential=2).   
-00002fb0: 2069 6620 656d 696e 203c 2032 3a20 2023   if emin < 2:  #
-00002fc0: 2074 6865 2069 6e74 6572 7661 6c20 6973   the interval is
-00002fd0: 2028 6174 206c 6573 7420 7061 7274 6961   (at lest partia
-00002fe0: 6c6c 7929 2062 656c 6f77 207a 6572 6f0a  lly) below zero.
-00002ff0: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
-00003000: 656e 286f 6363 7570 6174 696f 6e2e 656e  en(occupation.en
-00003010: 6572 6779 5f72 616e 6765 2920 3d3d 2031  ergy_range) == 1
-00003020: 0a20 2020 2020 2020 205f 656d 696e 2c20  .        _emin, 
-00003030: 5f65 6d61 7820 3d20 6f63 6375 7061 7469  _emax = occupati
-00003040: 6f6e 2e65 6e65 7267 795f 7261 6e67 655b  on.energy_range[
-00003050: 305d 0a20 2020 2020 2020 2061 7373 6572  0].        asser
-00003060: 7420 5f65 6d61 7820 3d3d 2032 0a20 2020  t _emax == 2.   
-00003070: 2020 2020 2061 7373 6572 7420 5f65 6d69       assert _emi
-00003080: 6e20 3d3d 2065 6d69 6e0a 2020 2020 656c  n == emin.    el
-00003090: 7365 3a20 2023 2074 6865 2077 686f 6c65  se:  # the whole
-000030a0: 2069 6e74 6572 7661 6c20 6973 2061 626f   interval is abo
-000030b0: 7665 2030 2c20 646f 6573 206e 6f74 2063  ve 0, does not c
-000030c0: 6f6e 7472 6962 7574 650a 2020 2020 2020  ontribute.      
-000030d0: 2020 6173 7365 7274 206f 6363 7570 6174    assert occupat
-000030e0: 696f 6e20 6973 204e 6f6e 650a 0a20 2020  ion is None..   
-000030f0: 2023 207a 6572 6f20 7465 6d70 6572 6174   # zero temperat
-00003100: 7572 652c 2075 6e6b 6e6f 776e 2064 6973  ure, unknown dis
-00003110: 7472 6962 7574 696f 6e20 6675 6e63 7469  tribution functi
-00003120: 6f6e 0a20 2020 206f 6363 7570 6174 696f  on.    occupatio
-00003130: 6e20 3d20 6d61 6e79 626f 6479 2e6c 6561  n = manybody.lea
-00003140: 645f 6f63 6375 7061 7469 6f6e 2865 6e65  d_occupation(ene
-00003150: 7267 795f 7261 6e67 653d 656e 6572 6779  rgy_range=energy
-00003160: 5f72 616e 6765 2c20 6469 7374 7269 6275  _range, distribu
-00003170: 7469 6f6e 3d75 6e6b 6e6f 776e 5f64 6973  tion=unknown_dis
-00003180: 7472 6962 7574 696f 6e5f 6675 6e63 7469  tribution_functi
-00003190: 6f6e 290a 2020 2020 6173 7365 7274 206c  on).    assert l
-000031a0: 656e 286f 6363 7570 6174 696f 6e2e 656e  en(occupation.en
-000031b0: 6572 6779 5f72 616e 6765 2920 3d3d 2031  ergy_range) == 1
-000031c0: 0a20 2020 205f 656d 696e 2c20 5f65 6d61  .    _emin, _ema
-000031d0: 7820 3d20 6f63 6375 7061 7469 6f6e 2e65  x = occupation.e
-000031e0: 6e65 7267 795f 7261 6e67 655b 305d 0a20  nergy_range[0]. 
-000031f0: 2020 2061 7373 6572 7420 5f65 6d61 7820     assert _emax 
-00003200: 6973 204e 6f6e 650a 2020 2020 6173 7365  is None.    asse
-00003210: 7274 205f 656d 696e 203d 3d20 656d 696e  rt _emin == emin
-00003220: 0a0a 2020 2020 2320 7a65 726f 2074 656d  ..    # zero tem
-00003230: 7065 7261 7475 7265 2c20 756e 6b6e 6f77  perature, unknow
-00003240: 6e20 6469 7374 7269 6275 7469 6f6e 2066  n distribution f
-00003250: 756e 6374 696f 6e2c 2073 6f6d 6520 6368  unction, some ch
-00003260: 656d 6963 616c 2070 6f74 656e 7469 616c  emical potential
-00003270: 0a20 2020 206f 6363 7570 6174 696f 6e20  .    occupation 
-00003280: 3d20 6d61 6e79 626f 6479 2e6c 6561 645f  = manybody.lead_
-00003290: 6f63 6375 7061 7469 6f6e 2865 6e65 7267  occupation(energ
-000032a0: 795f 7261 6e67 653d 656e 6572 6779 5f72  y_range=energy_r
-000032b0: 616e 6765 2c0a 2020 2020 2020 2020 2020  ange,.          
-000032c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000032d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000032e0: 6469 7374 7269 6275 7469 6f6e 3d75 6e6b  distribution=unk
-000032f0: 6e6f 776e 5f64 6973 7472 6962 7574 696f  nown_distributio
-00003300: 6e5f 6675 6e63 7469 6f6e 2c0a 2020 2020  n_function,.    
-00003310: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003320: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003330: 2020 2020 2020 6368 656d 6963 616c 5f70        chemical_p
-00003340: 6f74 656e 7469 616c 3d32 290a 2020 2020  otential=2).    
-00003350: 6173 7365 7274 206c 656e 286f 6363 7570  assert len(occup
-00003360: 6174 696f 6e2e 656e 6572 6779 5f72 616e  ation.energy_ran
-00003370: 6765 2920 3d3d 2031 0a20 2020 205f 656d  ge) == 1.    _em
-00003380: 696e 2c20 5f65 6d61 7820 3d20 6f63 6375  in, _emax = occu
-00003390: 7061 7469 6f6e 2e65 6e65 7267 795f 7261  pation.energy_ra
-000033a0: 6e67 655b 305d 0a20 2020 2061 7373 6572  nge[0].    asser
-000033b0: 7420 5f65 6d61 7820 6973 204e 6f6e 650a  t _emax is None.
-000033c0: 2020 2020 6173 7365 7274 205f 656d 696e      assert _emin
-000033d0: 203d 3d20 656d 696e 0a0a 2020 2020 2320   == emin..    # 
-000033e0: 6669 6e69 7465 2074 656d 7065 7261 7475  finite temperatu
-000033f0: 7265 2c20 6665 726d 692d 6469 7261 6320  re, fermi-dirac 
-00003400: 6469 7374 7269 6275 7469 6f6e 0a20 2020  distribution.   
-00003410: 206f 6363 7570 6174 696f 6e20 3d20 6d61   occupation = ma
-00003420: 6e79 626f 6479 2e6c 6561 645f 6f63 6375  nybody.lead_occu
-00003430: 7061 7469 6f6e 2865 6e65 7267 795f 7261  pation(energy_ra
-00003440: 6e67 653d 656e 6572 6779 5f72 616e 6765  nge=energy_range
-00003450: 2c20 7465 6d70 6572 6174 7572 653d 3129  , temperature=1)
-00003460: 0a20 2020 2065 6566 6620 3d20 6d61 6e79  .    eeff = many
-00003470: 626f 6479 2e5f 6665 726d 695f 6675 6e63  body._fermi_func
-00003480: 7469 6f6e 5f62 656c 6f77 5f65 7073 696c  tion_below_epsil
-00003490: 6f6e 2874 656d 7065 7261 7475 7265 3d31  on(temperature=1
-000034a0: 290a 2020 2020 6966 2065 6d69 6e20 3c20  ).    if emin < 
-000034b0: 6565 6666 3a0a 2020 2020 2020 2020 6173  eeff:.        as
-000034c0: 7365 7274 206c 656e 286f 6363 7570 6174  sert len(occupat
-000034d0: 696f 6e2e 656e 6572 6779 5f72 616e 6765  ion.energy_range
-000034e0: 2920 3d3d 2031 0a20 2020 2020 2020 205f  ) == 1.        _
-000034f0: 656d 696e 2c20 5f65 6d61 7820 3d20 6f63  emin, _emax = oc
-00003500: 6375 7061 7469 6f6e 2e65 6e65 7267 795f  cupation.energy_
-00003510: 7261 6e67 655b 305d 0a20 2020 2020 2020  range[0].       
-00003520: 2061 7373 6572 7420 5f65 6d61 7820 3d3d   assert _emax ==
-00003530: 2065 6566 660a 2020 2020 2020 2020 6173   eeff.        as
-00003540: 7365 7274 205f 656d 696e 203d 3d20 656d  sert _emin == em
-00003550: 696e 0a20 2020 2065 6c73 653a 0a20 2020  in.    else:.   
-00003560: 2020 2020 2061 7373 6572 7420 6f63 6375       assert occu
-00003570: 7061 7469 6f6e 2069 7320 4e6f 6e65 0a0a  pation is None..
-00003580: 2020 2020 2320 6669 6e69 7465 2074 656d      # finite tem
-00003590: 7065 7261 7475 7265 2c20 6665 726d 692d  perature, fermi-
-000035a0: 6469 7261 6320 6469 7374 7269 6275 7469  dirac distributi
-000035b0: 6f6e 2c20 736f 6d65 2063 6865 6d69 6361  on, some chemica
-000035c0: 6c20 706f 7465 6e74 6961 6c0a 2020 2020  l potential.    
-000035d0: 6f63 6375 7061 7469 6f6e 203d 206d 616e  occupation = man
-000035e0: 7962 6f64 792e 6c65 6164 5f6f 6363 7570  ybody.lead_occup
-000035f0: 6174 696f 6e28 656e 6572 6779 5f72 616e  ation(energy_ran
-00003600: 6765 3d65 6e65 7267 795f 7261 6e67 652c  ge=energy_range,
-00003610: 2074 656d 7065 7261 7475 7265 3d31 2c0a   temperature=1,.
-00003620: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003630: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003640: 2020 2020 2020 2020 2020 6368 656d 6963            chemic
-00003650: 616c 5f70 6f74 656e 7469 616c 3d32 290a  al_potential=2).
-00003660: 2020 2020 6565 6666 203d 2032 202b 206d      eeff = 2 + m
-00003670: 616e 7962 6f64 792e 5f66 6572 6d69 5f66  anybody._fermi_f
-00003680: 756e 6374 696f 6e5f 6265 6c6f 775f 6570  unction_below_ep
-00003690: 7369 6c6f 6e28 7465 6d70 6572 6174 7572  silon(temperatur
-000036a0: 653d 3129 0a20 2020 2069 6620 656d 696e  e=1).    if emin
-000036b0: 203c 2065 6566 663a 0a20 2020 2020 2020   < eeff:.       
-000036c0: 2061 7373 6572 7420 6c65 6e28 6f63 6375   assert len(occu
-000036d0: 7061 7469 6f6e 2e65 6e65 7267 795f 7261  pation.energy_ra
-000036e0: 6e67 6529 203d 3d20 310a 2020 2020 2020  nge) == 1.      
-000036f0: 2020 5f65 6d69 6e2c 205f 656d 6178 203d    _emin, _emax =
-00003700: 206f 6363 7570 6174 696f 6e2e 656e 6572   occupation.ener
-00003710: 6779 5f72 616e 6765 5b30 5d0a 2020 2020  gy_range[0].    
-00003720: 2020 2020 6173 7365 7274 205f 656d 6178      assert _emax
-00003730: 203d 3d20 6565 6666 0a20 2020 2020 2020   == eeff.       
-00003740: 2061 7373 6572 7420 5f65 6d69 6e20 3d3d   assert _emin ==
-00003750: 2065 6d69 6e0a 2020 2020 656c 7365 3a0a   emin.    else:.
-00003760: 2020 2020 2020 2020 6173 7365 7274 206f          assert o
-00003770: 6363 7570 6174 696f 6e20 6973 204e 6f6e  ccupation is Non
-00003780: 650a 0a0a 6465 6620 7465 7374 5f6c 6561  e...def test_lea
-00003790: 645f 6f63 6375 7061 7469 6f6e 5f65 6e65  d_occupation_ene
-000037a0: 7267 795f 7261 6e67 6528 293a 0a20 2020  rgy_range():.   
-000037b0: 2023 207a 6572 6f20 7465 6d70 6572 6174   # zero temperat
-000037c0: 7572 652c 2066 6572 6d69 2d64 6972 6163  ure, fermi-dirac
-000037d0: 2064 6973 7472 6962 7574 696f 6e0a 2020   distribution.  
-000037e0: 2020 2320 6669 7273 7420 696e 7465 7276    # first interv
-000037f0: 616c 2062 656c 6f77 2063 6865 6d69 6361  al below chemica
-00003800: 6c20 706f 7465 6e74 6961 6c20 2877 6869  l potential (whi
-00003810: 6368 2069 7320 7a65 726f 292c 2073 6563  ch is zero), sec
-00003820: 6f6e 6420 696e 7465 7276 616c 206f 6e6c  ond interval onl
-00003830: 7920 7061 7274 6c79 2062 656c 6f77 0a20  y partly below. 
-00003840: 2020 2065 6e65 7267 795f 7261 6e67 6520     energy_range 
-00003850: 3d20 5b28 4e6f 6e65 2c20 2d30 2e35 292c  = [(None, -0.5),
-00003860: 2028 2d30 2e34 2c20 3229 5d0a 2020 2020   (-0.4, 2)].    
-00003870: 6f63 6375 7061 7469 6f6e 203d 206d 616e  occupation = man
-00003880: 7962 6f64 792e 6c65 6164 5f6f 6363 7570  ybody.lead_occup
-00003890: 6174 696f 6e28 656e 6572 6779 5f72 616e  ation(energy_ran
-000038a0: 6765 3d65 6e65 7267 795f 7261 6e67 6529  ge=energy_range)
-000038b0: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
-000038c0: 6f63 6375 7061 7469 6f6e 2e65 6e65 7267  occupation.energ
-000038d0: 795f 7261 6e67 6529 203d 3d20 320a 2020  y_range) == 2.  
-000038e0: 2020 656d 696e 2c20 656d 6178 203d 206f    emin, emax = o
-000038f0: 6363 7570 6174 696f 6e2e 656e 6572 6779  ccupation.energy
-00003900: 5f72 616e 6765 5b30 5d0a 2020 2020 6173  _range[0].    as
-00003910: 7365 7274 2065 6d69 6e20 6973 204e 6f6e  sert emin is Non
-00003920: 650a 2020 2020 6173 7365 7274 2065 6d61  e.    assert ema
-00003930: 7820 3d3d 202d 302e 350a 2020 2020 656d  x == -0.5.    em
-00003940: 696e 2c20 656d 6178 203d 206f 6363 7570  in, emax = occup
-00003950: 6174 696f 6e2e 656e 6572 6779 5f72 616e  ation.energy_ran
-00003960: 6765 5b31 5d0a 2020 2020 6173 7365 7274  ge[1].    assert
-00003970: 2065 6d69 6e20 3d3d 202d 302e 340a 2020   emin == -0.4.  
-00003980: 2020 6173 7365 7274 2065 6d61 7820 3d3d    assert emax ==
-00003990: 2030 0a0a 2020 2020 2320 6669 7273 7420   0..    # first 
-000039a0: 696e 7465 7276 616c 2062 656c 6f77 2063  interval below c
-000039b0: 6865 6d69 6361 6c20 706f 7465 6e74 6961  hemical potentia
-000039c0: 6c20 2877 6869 6368 2069 7320 7a65 726f  l (which is zero
-000039d0: 292c 2073 6563 6f6e 6420 696e 7465 7276  ), second interv
-000039e0: 616c 2069 7320 6162 6f76 650a 2020 2020  al is above.    
-000039f0: 656e 6572 6779 5f72 616e 6765 203d 205b  energy_range = [
-00003a00: 284e 6f6e 652c 202d 302e 3529 2c20 2830  (None, -0.5), (0
-00003a10: 2c20 3229 5d0a 2020 2020 6f63 6375 7061  , 2)].    occupa
-00003a20: 7469 6f6e 203d 206d 616e 7962 6f64 792e  tion = manybody.
-00003a30: 6c65 6164 5f6f 6363 7570 6174 696f 6e28  lead_occupation(
-00003a40: 656e 6572 6779 5f72 616e 6765 3d65 6e65  energy_range=ene
-00003a50: 7267 795f 7261 6e67 6529 0a20 2020 2061  rgy_range).    a
-00003a60: 7373 6572 7420 6c65 6e28 6f63 6375 7061  ssert len(occupa
-00003a70: 7469 6f6e 2e65 6e65 7267 795f 7261 6e67  tion.energy_rang
-00003a80: 6529 203d 3d20 310a 2020 2020 656d 696e  e) == 1.    emin
-00003a90: 2c20 656d 6178 203d 206f 6363 7570 6174  , emax = occupat
-00003aa0: 696f 6e2e 656e 6572 6779 5f72 616e 6765  ion.energy_range
-00003ab0: 5b30 5d0a 2020 2020 6173 7365 7274 2065  [0].    assert e
-00003ac0: 6d69 6e20 6973 204e 6f6e 650a 2020 2020  min is None.    
-00003ad0: 6173 7365 7274 2065 6d61 7820 3d3d 202d  assert emax == -
-00003ae0: 302e 350a 0a20 2020 2023 2074 776f 2069  0.5..    # two i
-00003af0: 6e74 6572 6772 616c 7320 6162 6f76 6520  ntergrals above 
-00003b00: 6368 656d 6963 616c 2070 6f74 656e 7469  chemical potenti
-00003b10: 616c 0a20 2020 2065 6e65 7267 795f 7261  al.    energy_ra
-00003b20: 6e67 6520 3d20 5b28 302c 2032 292c 2028  nge = [(0, 2), (
-00003b30: 342c 2035 295d 0a20 2020 206f 6363 7570  4, 5)].    occup
-00003b40: 6174 696f 6e20 3d20 6d61 6e79 626f 6479  ation = manybody
-00003b50: 2e6c 6561 645f 6f63 6375 7061 7469 6f6e  .lead_occupation
-00003b60: 2865 6e65 7267 795f 7261 6e67 653d 656e  (energy_range=en
-00003b70: 6572 6779 5f72 616e 6765 290a 2020 2020  ergy_range).    
-00003b80: 6173 7365 7274 206f 6363 7570 6174 696f  assert occupatio
-00003b90: 6e20 6973 204e 6f6e 650a 0a0a 4070 7974  n is None...@pyt
-00003ba0: 6573 742e 6d61 726b 2e70 6172 616d 6574  est.mark.paramet
-00003bb0: 7269 7a65 2827 6368 656d 6963 616c 5f70  rize('chemical_p
-00003bc0: 6f74 656e 7469 616c 272c 2056 414c 4944  otential', VALID
-00003bd0: 5f43 4845 4d49 4341 4c5f 504f 5445 4e54  _CHEMICAL_POTENT
-00003be0: 4941 4c53 290a 4070 7974 6573 742e 6d61  IALS).@pytest.ma
-00003bf0: 726b 2e70 6172 616d 6574 7269 7a65 2827  rk.parametrize('
-00003c00: 656d 6178 272c 2056 414c 4944 5f45 4e45  emax', VALID_ENE
-00003c10: 5247 595f 4355 544f 4646 5329 0a64 6566  RGY_CUTOFFS).def
-00003c20: 2074 6573 745f 6c65 6164 5f6f 6363 7570   test_lead_occup
-00003c30: 6174 696f 6e5f 7661 7279 5f63 6865 6d69  ation_vary_chemi
-00003c40: 6361 6c5f 706f 7465 6e74 6961 6c5f 616e  cal_potential_an
-00003c50: 645f 656d 6178 2863 6865 6d69 6361 6c5f  d_emax(chemical_
-00003c60: 706f 7465 6e74 6961 6c2c 2065 6d61 7829  potential, emax)
-00003c70: 3a0a 2020 2020 656e 6572 6779 5f72 616e  :.    energy_ran
-00003c80: 6765 203d 205b 284e 6f6e 652c 2065 6d61  ge = [(None, ema
-00003c90: 7829 5d0a 2020 2020 2320 7a65 726f 2074  x)].    # zero t
-00003ca0: 656d 7065 7261 7475 7265 2c20 6665 726d  emperature, ferm
-00003cb0: 692d 6469 7261 6320 6469 7374 7269 6275  i-dirac distribu
-00003cc0: 7469 6f6e 0a20 2020 206f 6363 7570 6174  tion.    occupat
-00003cd0: 696f 6e20 3d20 6d61 6e79 626f 6479 2e6c  ion = manybody.l
-00003ce0: 6561 645f 6f63 6375 7061 7469 6f6e 2863  ead_occupation(c
-00003cf0: 6865 6d69 6361 6c5f 706f 7465 6e74 6961  hemical_potentia
-00003d00: 6c3d 6368 656d 6963 616c 5f70 6f74 656e  l=chemical_poten
-00003d10: 7469 616c 2c20 656e 6572 6779 5f72 616e  tial, energy_ran
-00003d20: 6765 3d65 6e65 7267 795f 7261 6e67 6529  ge=energy_range)
-00003d30: 0a20 2020 205f 656d 696e 2c20 5f65 6d61  .    _emin, _ema
-00003d40: 7820 3d20 6f63 6375 7061 7469 6f6e 2e65  x = occupation.e
-00003d50: 6e65 7267 795f 7261 6e67 655b 305d 0a20  nergy_range[0]. 
-00003d60: 2020 2069 6620 6368 656d 6963 616c 5f70     if chemical_p
-00003d70: 6f74 656e 7469 616c 203c 3d20 656d 6178  otential <= emax
-00003d80: 3a0a 2020 2020 2020 2020 6173 7365 7274  :.        assert
-00003d90: 205f 656d 6178 203d 3d20 6368 656d 6963   _emax == chemic
-00003da0: 616c 5f70 6f74 656e 7469 616c 0a20 2020  al_potential.   
-00003db0: 2065 6c73 653a 0a20 2020 2020 2020 2061   else:.        a
-00003dc0: 7373 6572 7420 5f65 6d61 7820 3d3d 2065  ssert _emax == e
-00003dd0: 6d61 780a 2020 2020 6173 7365 7274 205f  max.    assert _
-00003de0: 656d 696e 2069 7320 4e6f 6e65 0a0a 2020  emin is None..  
-00003df0: 2020 2320 7a65 726f 2074 656d 7065 7261    # zero tempera
-00003e00: 7475 7265 2c20 756e 6b6e 6f77 6e20 6469  ture, unknown di
-00003e10: 7374 7269 6275 7469 6f6e 2066 756e 6374  stribution funct
-00003e20: 696f 6e0a 2020 2020 6f63 6375 7061 7469  ion.    occupati
-00003e30: 6f6e 203d 206d 616e 7962 6f64 792e 6c65  on = manybody.le
-00003e40: 6164 5f6f 6363 7570 6174 696f 6e28 6368  ad_occupation(ch
-00003e50: 656d 6963 616c 5f70 6f74 656e 7469 616c  emical_potential
-00003e60: 3d63 6865 6d69 6361 6c5f 706f 7465 6e74  =chemical_potent
-00003e70: 6961 6c2c 0a20 2020 2020 2020 2020 2020  ial,.           
-00003e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003e90: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00003ea0: 6e65 7267 795f 7261 6e67 653d 656e 6572  nergy_range=ener
-00003eb0: 6779 5f72 616e 6765 2c20 6469 7374 7269  gy_range, distri
-00003ec0: 6275 7469 6f6e 3d75 6e6b 6e6f 776e 5f64  bution=unknown_d
-00003ed0: 6973 7472 6962 7574 696f 6e5f 6675 6e63  istribution_func
-00003ee0: 7469 6f6e 290a 2020 2020 5f65 6d69 6e2c  tion).    _emin,
-00003ef0: 205f 656d 6178 203d 206f 6363 7570 6174   _emax = occupat
-00003f00: 696f 6e2e 656e 6572 6779 5f72 616e 6765  ion.energy_range
-00003f10: 5b30 5d0a 2020 2020 6173 7365 7274 205f  [0].    assert _
-00003f20: 656d 6178 203d 3d20 656d 6178 0a20 2020  emax == emax.   
-00003f30: 2061 7373 6572 7420 5f65 6d69 6e20 6973   assert _emin is
-00003f40: 204e 6f6e 650a 0a20 2020 2023 2066 696e   None..    # fin
-00003f50: 6974 6520 7465 6d70 6572 6174 7572 652c  ite temperature,
-00003f60: 2066 6572 6d69 2d64 6972 6163 2064 6973   fermi-dirac dis
-00003f70: 7472 6962 7574 696f 6e0a 2020 2020 6f63  tribution.    oc
-00003f80: 6375 7061 7469 6f6e 203d 206d 616e 7962  cupation = manyb
-00003f90: 6f64 792e 6c65 6164 5f6f 6363 7570 6174  ody.lead_occupat
-00003fa0: 696f 6e28 6368 656d 6963 616c 5f70 6f74  ion(chemical_pot
-00003fb0: 656e 7469 616c 3d63 6865 6d69 6361 6c5f  ential=chemical_
-00003fc0: 706f 7465 6e74 6961 6c2c 0a20 2020 2020  potential,.     
-00003fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00003ff0: 2020 2020 2065 6e65 7267 795f 7261 6e67       energy_rang
-00004000: 653d 656e 6572 6779 5f72 616e 6765 2c20  e=energy_range, 
-00004010: 7465 6d70 6572 6174 7572 653d 3129 0a20  temperature=1). 
-00004020: 2020 205f 656d 696e 2c20 5f65 6d61 7820     _emin, _emax 
-00004030: 3d20 6f63 6375 7061 7469 6f6e 2e65 6e65  = occupation.ene
-00004040: 7267 795f 7261 6e67 655b 305d 0a20 2020  rgy_range[0].   
-00004050: 2061 7373 6572 7420 5f65 6d61 7820 3d3d   assert _emax ==
-00004060: 2065 6d61 780a 2020 2020 6173 7365 7274   emax.    assert
-00004070: 205f 656d 696e 2069 7320 4e6f 6e65 0a0a   _emin is None..
-00004080: 0a64 6566 2074 6573 745f 6c65 6164 5f6f  .def test_lead_o
-00004090: 6363 7570 6174 696f 6e5f 6665 726d 695f  ccupation_fermi_
-000040a0: 6469 7261 6374 5f7a 6572 6f5f 7465 6d70  diract_zero_temp
-000040b0: 6572 6174 7572 6528 293a 0a20 2020 2023  erature():.    #
-000040c0: 2063 6865 636b 2064 6566 6175 6c74 2076   check default v
-000040d0: 616c 7565 732c 2066 696e 6974 6520 7465  alues, finite te
-000040e0: 6d70 6572 6174 7572 650a 2020 2020 6d75  mperature.    mu
-000040f0: 203d 2032 0a20 2020 2065 7073 696c 6f6e   = 2.    epsilon
-00004100: 203d 2031 452d 3620 2023 2073 6f6d 6520   = 1E-6  # some 
-00004110: 736d 616c 6c20 6e75 6d62 6572 0a20 2020  small number.   
-00004120: 206f 6363 7570 6174 696f 6e20 3d20 6d61   occupation = ma
-00004130: 6e79 626f 6479 2e6c 6561 645f 6f63 6375  nybody.lead_occu
-00004140: 7061 7469 6f6e 2863 6865 6d69 6361 6c5f  pation(chemical_
-00004150: 706f 7465 6e74 6961 6c3d 6d75 290a 2020  potential=mu).  
-00004160: 2020 5f65 6d69 6e2c 205f 656d 6178 203d    _emin, _emax =
-00004170: 206f 6363 7570 6174 696f 6e2e 656e 6572   occupation.ener
-00004180: 6779 5f72 616e 6765 5b30 5d0a 2020 2020  gy_range[0].    
-00004190: 6173 7365 7274 206f 6363 7570 6174 696f  assert occupatio
-000041a0: 6e2e 6469 7374 7269 6275 7469 6f6e 2865  n.distribution(e
-000041b0: 6e65 7267 793d 6d75 202d 2065 7073 696c  nergy=mu - epsil
-000041c0: 6f6e 2920 3d3d 2031 0a20 2020 2061 7373  on) == 1.    ass
-000041d0: 6572 7420 6f63 6375 7061 7469 6f6e 2e64  ert occupation.d
-000041e0: 6973 7472 6962 7574 696f 6e28 656e 6572  istribution(ener
-000041f0: 6779 3d6d 7520 2b20 6570 7369 6c6f 6e29  gy=mu + epsilon)
-00004200: 203d 3d20 300a 2020 2020 6173 7365 7274   == 0.    assert
-00004210: 205f 656d 696e 2069 7320 4e6f 6e65 0a20   _emin is None. 
-00004220: 2020 2061 7373 6572 7420 5f65 6d61 7820     assert _emax 
-00004230: 3d3d 206d 750a 2020 2020 6173 7365 7274  == mu.    assert
-00004240: 206f 6363 7570 6174 696f 6e2e 6261 6e64   occupation.band
-00004250: 7320 6973 204e 6f6e 650a 0a0a 6465 6620  s is None...def 
-00004260: 7465 7374 5f6c 6561 645f 6f63 6375 7061  test_lead_occupa
-00004270: 7469 6f6e 5f66 6572 6d69 5f64 6972 6163  tion_fermi_dirac
-00004280: 745f 6669 6e69 7465 5f74 656d 7065 7261  t_finite_tempera
-00004290: 7475 7265 2829 3a0a 2020 2020 2320 6368  ture():.    # ch
-000042a0: 6563 6b20 6465 6661 756c 7420 7661 6c75  eck default valu
-000042b0: 6573 2c20 6669 6e69 7465 2074 656d 7065  es, finite tempe
-000042c0: 7261 7475 7265 0a20 2020 2064 6566 2066  rature.    def f
-000042d0: 6572 6d69 5f66 756e 6374 696f 6e28 6368  ermi_function(ch
-000042e0: 656d 6963 616c 5f70 6f74 656e 7469 616c  emical_potential
-000042f0: 2c20 7465 6d70 6572 6174 7572 652c 2065  , temperature, e
-00004300: 6e65 7267 7929 3a0a 2020 2020 2020 2020  nergy):.        
-00004310: 7265 7475 726e 2031 202f 2028 6e70 2e65  return 1 / (np.e
-00004320: 7870 2828 656e 6572 6779 202d 2063 6865  xp((energy - che
-00004330: 6d69 6361 6c5f 706f 7465 6e74 6961 6c29  mical_potential)
-00004340: 202f 2074 656d 7065 7261 7475 7265 2920   / temperature) 
-00004350: 2b20 3129 0a0a 2020 2020 6d75 203d 2032  + 1)..    mu = 2
-00004360: 0a20 2020 2074 656d 7020 3d20 330a 2020  .    temp = 3.  
-00004370: 2020 6f63 6375 7061 7469 6f6e 203d 206d    occupation = m
-00004380: 616e 7962 6f64 792e 6c65 6164 5f6f 6363  anybody.lead_occ
-00004390: 7570 6174 696f 6e28 6368 656d 6963 616c  upation(chemical
-000043a0: 5f70 6f74 656e 7469 616c 3d6d 752c 2074  _potential=mu, t
-000043b0: 656d 7065 7261 7475 7265 3d74 656d 7029  emperature=temp)
-000043c0: 0a20 2020 205f 656d 696e 2c20 5f65 6d61  .    _emin, _ema
-000043d0: 7820 3d20 6f63 6375 7061 7469 6f6e 2e65  x = occupation.e
-000043e0: 6e65 7267 795f 7261 6e67 655b 305d 0a20  nergy_range[0]. 
-000043f0: 2020 2061 7373 6572 7420 6f63 6375 7061     assert occupa
-00004400: 7469 6f6e 2e64 6973 7472 6962 7574 696f  tion.distributio
-00004410: 6e28 656e 6572 6779 3d31 2920 3d3d 2066  n(energy=1) == f
-00004420: 6572 6d69 5f66 756e 6374 696f 6e28 6d75  ermi_function(mu
-00004430: 2c20 7465 6d70 2c20 656e 6572 6779 3d31  , temp, energy=1
-00004440: 290a 2020 2020 6173 7365 7274 206f 6363  ).    assert occ
-00004450: 7570 6174 696f 6e2e 6469 7374 7269 6275  upation.distribu
-00004460: 7469 6f6e 2865 6e65 7267 793d 3329 203d  tion(energy=3) =
-00004470: 3d20 6665 726d 695f 6675 6e63 7469 6f6e  = fermi_function
-00004480: 286d 752c 2074 656d 702c 2065 6e65 7267  (mu, temp, energ
-00004490: 793d 3329 0a20 2020 2061 7373 6572 7420  y=3).    assert 
-000044a0: 5f65 6d69 6e20 6973 204e 6f6e 650a 2020  _emin is None.  
-000044b0: 2020 6173 7365 7274 205f 656d 6178 203d    assert _emax =
-000044c0: 3d20 6d75 202b 206d 616e 7962 6f64 792e  = mu + manybody.
-000044d0: 5f66 6572 6d69 5f66 756e 6374 696f 6e5f  _fermi_function_
-000044e0: 6265 6c6f 775f 6570 7369 6c6f 6e28 7465  below_epsilon(te
-000044f0: 6d70 6572 6174 7572 653d 7465 6d70 290a  mperature=temp).
-00004500: 2020 2020 6173 7365 7274 206f 6363 7570      assert occup
-00004510: 6174 696f 6e2e 6261 6e64 7320 6973 204e  ation.bands is N
-00004520: 6f6e 650a 0a0a 6465 6620 7465 7374 5f6c  one...def test_l
-00004530: 6561 645f 6f63 6375 7061 7469 6f6e 5f62  ead_occupation_b
-00004540: 6f73 655f 6469 7374 7269 6275 7469 6f6e  ose_distribution
-00004550: 2829 3a0a 2020 2020 2320 6368 6563 6b20  ():.    # check 
-00004560: 6120 6469 6666 6572 656e 7420 6469 7374  a different dist
-00004570: 7269 6275 7469 6f6e 2061 7420 6669 6e69  ribution at fini
-00004580: 7465 2074 656d 7065 7261 7475 7265 0a20  te temperature. 
-00004590: 2020 2064 6566 2062 6f73 655f 6675 6e63     def bose_func
-000045a0: 7469 6f6e 2863 6865 6d69 6361 6c5f 706f  tion(chemical_po
-000045b0: 7465 6e74 6961 6c2c 2074 656d 7065 7261  tential, tempera
-000045c0: 7475 7265 2c20 656e 6572 6779 293a 0a20  ture, energy):. 
-000045d0: 2020 2020 2020 2072 6574 7572 6e20 3120         return 1 
-000045e0: 2f20 286e 702e 6578 7028 2865 6e65 7267  / (np.exp((energ
-000045f0: 7920 2d20 6368 656d 6963 616c 5f70 6f74  y - chemical_pot
-00004600: 656e 7469 616c 2920 2f20 7465 6d70 6572  ential) / temper
-00004610: 6174 7572 6529 202d 2031 290a 0a20 2020  ature) - 1)..   
-00004620: 206d 7520 3d20 320a 2020 2020 7465 6d70   mu = 2.    temp
-00004630: 203d 2033 0a20 2020 206f 6363 7570 6174   = 3.    occupat
-00004640: 696f 6e20 3d20 6d61 6e79 626f 6479 2e6c  ion = manybody.l
-00004650: 6561 645f 6f63 6375 7061 7469 6f6e 2863  ead_occupation(c
-00004660: 6865 6d69 6361 6c5f 706f 7465 6e74 6961  hemical_potentia
-00004670: 6c3d 6d75 2c20 7465 6d70 6572 6174 7572  l=mu, temperatur
-00004680: 653d 7465 6d70 2c20 6469 7374 7269 6275  e=temp, distribu
-00004690: 7469 6f6e 3d62 6f73 655f 6675 6e63 7469  tion=bose_functi
-000046a0: 6f6e 290a 2020 2020 6173 7365 7274 206f  on).    assert o
-000046b0: 6363 7570 6174 696f 6e2e 6469 7374 7269  ccupation.distri
-000046c0: 6275 7469 6f6e 2831 2920 3d3d 2062 6f73  bution(1) == bos
-000046d0: 655f 6675 6e63 7469 6f6e 2863 6865 6d69  e_function(chemi
-000046e0: 6361 6c5f 706f 7465 6e74 6961 6c3d 6d75  cal_potential=mu
-000046f0: 2c20 7465 6d70 6572 6174 7572 653d 7465  , temperature=te
-00004700: 6d70 2c20 656e 6572 6779 3d31 290a 2020  mp, energy=1).  
-00004710: 2020 6173 7365 7274 206f 6363 7570 6174    assert occupat
-00004720: 696f 6e2e 6469 7374 7269 6275 7469 6f6e  ion.distribution
-00004730: 2833 2920 3d3d 2062 6f73 655f 6675 6e63  (3) == bose_func
-00004740: 7469 6f6e 2863 6865 6d69 6361 6c5f 706f  tion(chemical_po
-00004750: 7465 6e74 6961 6c3d 6d75 2c20 7465 6d70  tential=mu, temp
-00004760: 6572 6174 7572 653d 7465 6d70 2c20 656e  erature=temp, en
-00004770: 6572 6779 3d33 290a 2020 2020 6173 7365  ergy=3).    asse
-00004780: 7274 206c 656e 286f 6363 7570 6174 696f  rt len(occupatio
-00004790: 6e2e 656e 6572 6779 5f72 616e 6765 2920  n.energy_range) 
-000047a0: 3d3d 2031 0a20 2020 2065 6d69 6e2c 2065  == 1.    emin, e
-000047b0: 6d61 7820 3d20 6f63 6375 7061 7469 6f6e  max = occupation
-000047c0: 2e65 6e65 7267 795f 7261 6e67 655b 305d  .energy_range[0]
-000047d0: 0a20 2020 2061 7373 6572 7420 656d 696e  .    assert emin
-000047e0: 2069 7320 4e6f 6e65 0a20 2020 2061 7373   is None.    ass
-000047f0: 6572 7420 656d 6178 2069 7320 4e6f 6e65  ert emax is None
-00004800: 0a20 2020 2061 7373 6572 7420 6f63 6375  .    assert occu
-00004810: 7061 7469 6f6e 2e62 616e 6473 2069 7320  pation.bands is 
-00004820: 4e6f 6e65 0a0a 0a64 6566 2074 6573 745f  None...def test_
-00004830: 6c65 6164 5f6f 6363 7570 6174 696f 6e5f  lead_occupation_
-00004840: 6261 6e64 5f73 656c 6563 7469 6f6e 2829  band_selection()
-00004850: 3a0a 2020 2020 2320 6368 6563 6b20 6261  :.    # check ba
-00004860: 6e64 2073 656c 6563 7469 6f6e 0a20 2020  nd selection.   
-00004870: 206f 6363 7570 6174 696f 6e20 3d20 6d61   occupation = ma
-00004880: 6e79 626f 6479 2e6c 6561 645f 6f63 6375  nybody.lead_occu
-00004890: 7061 7469 6f6e 2862 616e 6473 3d33 290a  pation(bands=3).
-000048a0: 2020 2020 6173 7365 7274 206f 6363 7570      assert occup
-000048b0: 6174 696f 6e2e 6261 6e64 7320 3d3d 205b  ation.bands == [
-000048c0: 335d 0a20 2020 206f 6363 7570 6174 696f  3].    occupatio
-000048d0: 6e20 3d20 6d61 6e79 626f 6479 2e6c 6561  n = manybody.lea
-000048e0: 645f 6f63 6375 7061 7469 6f6e 2862 616e  d_occupation(ban
-000048f0: 6473 3d5b 335d 290a 2020 2020 6173 7365  ds=[3]).    asse
-00004900: 7274 206f 6363 7570 6174 696f 6e2e 6261  rt occupation.ba
-00004910: 6e64 7320 3d3d 205b 335d 0a20 2020 2023  nds == [3].    #
-00004920: 2062 616e 6473 2061 6c77 6179 7320 736f   bands always so
-00004930: 7274 6564 2061 6e64 2077 6974 686f 7574  rted and without
-00004940: 2064 7562 6c69 6361 7465 730a 2020 2020   dublicates.    
-00004950: 6f63 6375 7061 7469 6f6e 203d 206d 616e  occupation = man
-00004960: 7962 6f64 792e 6c65 6164 5f6f 6363 7570  ybody.lead_occup
-00004970: 6174 696f 6e28 6261 6e64 733d 5b33 2c20  ation(bands=[3, 
-00004980: 322c 2035 2c20 352c 202d 315d 290a 2020  2, 5, 5, -1]).  
-00004990: 2020 6173 7365 7274 206f 6363 7570 6174    assert occupat
-000049a0: 696f 6e2e 6261 6e64 7320 3d3d 205b 2d31  ion.bands == [-1
-000049b0: 2c20 322c 2033 2c20 355d 0a0a 0a64 6566  , 2, 3, 5]...def
-000049c0: 2074 6573 745f 6c65 6164 5f6f 6363 7570   test_lead_occup
-000049d0: 6174 696f 6e5f 6f77 6e5f 6461 7461 7479  ation_own_dataty
-000049e0: 7065 2829 3a0a 2020 2020 636c 6173 7320  pe():.    class 
-000049f0: 4d79 4f63 6375 7061 7469 6f6e 3a0a 2020  MyOccupation:.  
-00004a00: 2020 2020 2020 6465 6620 5f5f 696e 6974        def __init
-00004a10: 5f5f 2873 656c 662c 2064 6973 7472 6962  __(self, distrib
-00004a20: 7574 696f 6e2c 2065 6e65 7267 795f 7261  ution, energy_ra
-00004a30: 6e67 652c 2062 616e 6473 293a 0a20 2020  nge, bands):.   
-00004a40: 2020 2020 2020 2020 2073 656c 662e 6469           self.di
-00004a50: 7374 7269 6275 7469 6f6e 203d 2064 6973  stribution = dis
-00004a60: 7472 6962 7574 696f 6e0a 2020 2020 2020  tribution.      
-00004a70: 2020 2020 2020 7365 6c66 2e62 616e 6473        self.bands
-00004a80: 203d 2062 616e 6473 0a20 2020 2020 2020   = bands.       
-00004a90: 2020 2020 2073 656c 662e 656e 6572 6779       self.energy
-00004aa0: 5f72 616e 6765 203d 2065 6e65 7267 795f  _range = energy_
-00004ab0: 7261 6e67 650a 2020 2020 2020 2020 2020  range.          
-00004ac0: 2020 7365 6c66 2e73 6f6d 6566 6965 6c64    self.somefield
-00004ad0: 203d 2034 320a 2020 2020 6f63 6375 7061   = 42.    occupa
-00004ae0: 7469 6f6e 203d 206d 616e 7962 6f64 792e  tion = manybody.
-00004af0: 6c65 6164 5f6f 6363 7570 6174 696f 6e28  lead_occupation(
-00004b00: 6f63 6375 7061 7469 6f6e 5f74 7970 653d  occupation_type=
-00004b10: 4d79 4f63 6375 7061 7469 6f6e 290a 2020  MyOccupation).  
-00004b20: 2020 6173 7365 7274 2063 616c 6c61 626c    assert callabl
-00004b30: 6528 6f63 6375 7061 7469 6f6e 2e64 6973  e(occupation.dis
-00004b40: 7472 6962 7574 696f 6e29 0a20 2020 2061  tribution).    a
-00004b50: 7373 6572 7420 6f63 6375 7061 7469 6f6e  ssert occupation
-00004b60: 2e62 616e 6473 2069 7320 4e6f 6e65 0a20  .bands is None. 
-00004b70: 2020 2061 7373 6572 7420 6f63 6375 7061     assert occupa
-00004b80: 7469 6f6e 2e65 6e65 7267 795f 7261 6e67  tion.energy_rang
-00004b90: 6520 3d3d 205b 284e 6f6e 652c 2030 295d  e == [(None, 0)]
-00004ba0: 0a20 2020 2061 7373 6572 7420 6f63 6375  .    assert occu
-00004bb0: 7061 7469 6f6e 2e73 6f6d 6566 6965 6c64  pation.somefield
-00004bc0: 203d 3d20 3432 0a0a 0a64 6566 2074 6573   == 42...def tes
-00004bd0: 745f 6c65 6164 5f6f 6363 7570 6174 696f  t_lead_occupatio
-00004be0: 6e5f 7261 6973 6573 2829 3a0a 2020 2020  n_raises():.    
-00004bf0: 2320 6e65 6761 7469 7665 2074 656d 7065  # negative tempe
-00004c00: 7261 7475 7265 0a20 2020 2072 6169 7365  rature.    raise
-00004c10: 7328 5661 6c75 6545 7272 6f72 2c20 6d61  s(ValueError, ma
-00004c20: 6e79 626f 6479 2e6c 6561 645f 6f63 6375  nybody.lead_occu
-00004c30: 7061 7469 6f6e 2c20 7465 6d70 6572 6174  pation, temperat
-00004c40: 7572 653d 2d31 290a 2020 2020 2320 6e6f  ure=-1).    # no
-00004c50: 7420 7265 616c 206e 756d 6265 7273 0a20  t real numbers. 
-00004c60: 2020 2072 6169 7365 7328 5479 7065 4572     raises(TypeEr
-00004c70: 726f 722c 206d 616e 7962 6f64 792e 6c65  ror, manybody.le
-00004c80: 6164 5f6f 6363 7570 6174 696f 6e2c 2063  ad_occupation, c
-00004c90: 6865 6d69 6361 6c5f 706f 7465 6e74 6961  hemical_potentia
-00004ca0: 6c3d 3120 2b20 316a 290a 2020 2020 7261  l=1 + 1j).    ra
-00004cb0: 6973 6573 2854 7970 6545 7272 6f72 2c20  ises(TypeError, 
-00004cc0: 6d61 6e79 626f 6479 2e6c 6561 645f 6f63  manybody.lead_oc
-00004cd0: 6375 7061 7469 6f6e 2c20 7465 6d70 6572  cupation, temper
-00004ce0: 6174 7572 653d 3120 2b20 316a 290a 2020  ature=1 + 1j).  
-00004cf0: 2020 2320 6e6f 6e20 6361 6c6c 6162 6c65    # non callable
-00004d00: 2064 6973 7472 6962 7574 696f 6e0a 2020   distribution.  
-00004d10: 2020 7261 6973 6573 2854 7970 6545 7272    raises(TypeErr
-00004d20: 6f72 2c20 6d61 6e79 626f 6479 2e6c 6561  or, manybody.lea
-00004d30: 645f 6f63 6375 7061 7469 6f6e 2c20 6469  d_occupation, di
-00004d40: 7374 7269 6275 7469 6f6e 3d27 6e6f 745f  stribution='not_
-00004d50: 6361 6c6c 6162 6c65 2729 0a0a 0a64 6566  callable')...def
-00004d60: 2074 6573 745f 6d61 6b65 5f69 6e74 6572   test_make_inter
-00004d70: 7661 6c73 5f64 6566 6175 6c74 2874 776f  vals_default(two
-00004d80: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
-00004d90: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-00004da0: 6f6e 293a 0a20 2020 2069 6e74 6572 7661  on):.    interva
-00004db0: 6c73 203d 206d 616e 7962 6f64 792e 6361  ls = manybody.ca
-00004dc0: 6c63 5f69 6e74 6572 7661 6c73 2874 776f  lc_intervals(two
-00004dd0: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
-00004de0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-00004df0: 6f6e 290a 0a20 2020 2023 2063 6865 636b  on)..    # check
-00004e00: 2061 6c6c 2074 7970 6573 206f 6620 7468   all types of th
-00004e10: 6520 7265 7475 726e 6564 2065 6c65 6d65  e returned eleme
-00004e20: 6e74 730a 2020 2020 6173 7365 7274 2069  nts.    assert i
-00004e30: 7369 6e73 7461 6e63 6528 696e 7465 7276  sinstance(interv
-00004e40: 616c 732c 206c 6973 7429 0a20 2020 2061  als, list).    a
-00004e50: 7373 6572 7420 6c65 6e28 696e 7465 7276  ssert len(interv
-00004e60: 616c 7329 203d 3d20 7477 6f5f 6261 6e64  als) == two_band
-00004e70: 5f73 7065 6374 7275 6d2e 6e62 616e 6473  _spectrum.nbands
-00004e80: 0a20 2020 2066 6f72 2069 6e74 6572 7661  .    for interva
-00004e90: 6c20 696e 2069 6e74 6572 7661 6c73 3a0a  l in intervals:.
-00004ea0: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-00004eb0: 7369 6e73 7461 6e63 6528 696e 7465 7276  sinstance(interv
-00004ec0: 616c 2c20 6d61 6e79 626f 6479 2e49 6e74  al, manybody.Int
-00004ed0: 6572 7661 6c29 0a20 2020 2020 2020 2061  erval).        a
-00004ee0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-00004ef0: 2869 6e74 6572 7661 6c2e 6c65 6164 2c20  (interval.lead, 
-00004f00: 696e 7429 0a20 2020 2020 2020 2061 7373  int).        ass
-00004f10: 6572 7420 6973 696e 7374 616e 6365 2869  ert isinstance(i
-00004f20: 6e74 6572 7661 6c2e 6261 6e64 2c20 696e  nterval.band, in
-00004f30: 7429 0a20 2020 2020 2020 2061 7373 6572  t).        asser
-00004f40: 7420 6973 696e 7374 616e 6365 2869 6e74  t isinstance(int
-00004f50: 6572 7661 6c2e 6b6d 696e 2c20 666c 6f61  erval.kmin, floa
-00004f60: 7429 0a20 2020 2020 2020 2061 7373 6572  t).        asser
-00004f70: 7420 6973 696e 7374 616e 6365 2869 6e74  t isinstance(int
-00004f80: 6572 7661 6c2e 6b6d 6178 2c20 666c 6f61  erval.kmax, floa
-00004f90: 7429 0a20 2020 2020 2020 2061 7373 6572  t).        asser
-00004fa0: 7420 6973 696e 7374 616e 6365 2869 6e74  t isinstance(int
-00004fb0: 6572 7661 6c2e 6f72 6465 722c 2069 6e74  erval.order, int
-00004fc0: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
-00004fd0: 2069 7369 6e73 7461 6e63 6528 696e 7465   isinstance(inte
-00004fe0: 7276 616c 2e69 6e74 6567 7261 7469 6f6e  rval.integration
-00004ff0: 5f76 6172 6961 626c 652c 2073 7472 290a  _variable, str).
-00005000: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-00005010: 7369 6e73 7461 6e63 6528 696e 7465 7276  sinstance(interv
-00005020: 616c 2e71 7561 6472 6174 7572 652c 2073  al.quadrature, s
-00005030: 7472 290a 0a20 2020 2023 2063 6865 636b  tr)..    # check
-00005040: 2065 7870 6c69 6369 7420 7265 7475 726e   explicit return
-00005050: 6564 2076 616c 7565 730a 2020 2020 2320  ed values.    # 
-00005060: 696e 7465 7276 616c 7320 666f 7220 616c  intervals for al
-00005070: 6c20 6261 6e64 7320 6f66 2074 6865 2073  l bands of the s
-00005080: 7065 6374 7275 6d0a 2020 2020 2320 696e  pectrum.    # in
-00005090: 7465 7276 616c 7320 636f 6e74 6169 6e73  tervals contains
-000050a0: 2074 6865 206d 6f6d 656e 7475 6d20 286b   the momentum (k
-000050b0: 2920 696e 7465 7276 616c 7320 7768 6572  ) intervals wher
-000050c0: 6520 6420 455f 6e20 2f20 646b 203e 2030  e d E_n / dk > 0
-000050d0: 0a20 2020 2023 2066 726f 6d20 6162 6f76  .    # from abov
-000050e0: 6520 6469 7370 6572 7369 6f6e 2066 6f6c  e dispersion fol
-000050f0: 6c6f 7773 2074 6861 7420 7468 6973 2069  lows that this i
-00005100: 7320 7468 6520 6361 7365 2066 6f72 206b  s the case for k
-00005110: 2069 6e20 5b30 2c20 7069 5d0a 2020 2020   in [0, pi].    
-00005120: 666f 7220 692c 2069 6e74 6572 7661 6c20  for i, interval 
-00005130: 696e 2065 6e75 6d65 7261 7465 2869 6e74  in enumerate(int
-00005140: 6572 7661 6c73 293a 0a20 2020 2020 2020  ervals):.       
-00005150: 2061 7373 6572 7420 696e 7465 7276 616c   assert interval
-00005160: 2e6c 6561 6420 3d3d 2030 2020 2320 6f6e  .lead == 0  # on
-00005170: 6c79 206f 6e65 206c 6561 640a 2020 2020  ly one lead.    
-00005180: 2020 2020 6173 7365 7274 2069 6e74 6572      assert inter
-00005190: 7661 6c2e 6261 6e64 203d 3d20 690a 2020  val.band == i.  
-000051a0: 2020 2020 2020 6173 7365 7274 5f61 6c6d        assert_alm
-000051b0: 6f73 745f 6571 7561 6c28 696e 7465 7276  ost_equal(interv
-000051c0: 616c 2e6b 6d69 6e2c 2030 290a 2020 2020  al.kmin, 0).    
-000051d0: 2020 2020 6173 7365 7274 5f61 6c6d 6f73      assert_almos
-000051e0: 745f 6571 7561 6c28 696e 7465 7276 616c  t_equal(interval
-000051f0: 2e6b 6d61 782c 206e 702e 7069 290a 2020  .kmax, np.pi).  
-00005200: 2020 2020 2020 6173 7365 7274 2069 6e74        assert int
-00005210: 6572 7661 6c2e 6f72 6465 7220 3d3d 2031  erval.order == 1
-00005220: 300a 2020 2020 2020 2020 6173 7365 7274  0.        assert
-00005230: 2069 6e74 6572 7661 6c2e 696e 7465 6772   interval.integr
-00005240: 6174 696f 6e5f 7661 7269 6162 6c65 203d  ation_variable =
-00005250: 3d20 276d 6f6d 656e 7475 6d27 0a20 2020  = 'momentum'.   
-00005260: 2020 2020 2061 7373 6572 7420 696e 7465       assert inte
-00005270: 7276 616c 2e71 7561 6472 6174 7572 6520  rval.quadrature 
-00005280: 3d3d 2027 6b72 6f6e 726f 6427 0a0a 0a64  == 'kronrod'...d
-00005290: 6566 2074 6573 745f 6d61 6b65 5f69 6e74  ef test_make_int
-000052a0: 6572 7661 6c73 5f77 6974 685f 756e 6f63  ervals_with_unoc
-000052b0: 6375 7069 6564 5f6c 6561 6473 2874 776f  cupied_leads(two
-000052c0: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
-000052d0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-000052e0: 6f6e 293a 0a20 2020 2023 2063 6865 636b  on):.    # check
-000052f0: 2074 6861 7420 696e 7465 7276 616c 7320   that intervals 
-00005300: 7769 7468 2061 6464 6974 696f 6e61 6c20  with additional 
-00005310: 756e 6f63 6375 7069 6564 206c 6561 6473  unoccupied leads
-00005320: 2069 7320 7369 6d69 6c61 720a 2020 2020   is similar.    
-00005330: 696e 7465 7276 616c 7320 3d20 6d61 6e79  intervals = many
-00005340: 626f 6479 2e63 616c 635f 696e 7465 7276  body.calc_interv
-00005350: 616c 7328 7477 6f5f 6261 6e64 5f73 7065  als(two_band_spe
-00005360: 6374 7275 6d2c 2075 6e69 666f 726d 5f6f  ctrum, uniform_o
-00005370: 6363 7570 6174 696f 6e29 0a0a 2020 2020  ccupation)..    
-00005380: 666f 7220 6e62 5f6c 6561 6473 2069 6e20  for nb_leads in 
-00005390: 7261 6e67 6528 312c 2035 293a 0a20 2020  range(1, 5):.   
-000053a0: 2020 2020 2073 7065 6374 7261 203d 205b       spectra = [
-000053b0: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
-000053c0: 6d5d 202a 206e 625f 6c65 6164 730a 2020  m] * nb_leads.  
-000053d0: 2020 2020 2020 6f63 6375 7061 7469 6f6e        occupation
-000053e0: 7320 3d20 5b75 6e69 666f 726d 5f6f 6363  s = [uniform_occ
-000053f0: 7570 6174 696f 6e5d 202b 205b 4e6f 6e65  upation] + [None
-00005400: 5d20 2a20 286e 625f 6c65 6164 7320 2d20  ] * (nb_leads - 
-00005410: 3129 0a20 2020 2020 2020 2069 6e74 6572  1).        inter
-00005420: 7661 6c73 5f75 6e6f 6363 203d 206d 616e  vals_unocc = man
-00005430: 7962 6f64 792e 6361 6c63 5f69 6e74 6572  ybody.calc_inter
-00005440: 7661 6c73 2873 7065 6374 7261 2c20 6f63  vals(spectra, oc
-00005450: 6375 7061 7469 6f6e 7329 0a20 2020 2020  cupations).     
-00005460: 2020 2061 7373 6572 7420 696e 7465 7276     assert interv
-00005470: 616c 735f 756e 6f63 6320 3d3d 2069 6e74  als_unocc == int
-00005480: 6572 7661 6c73 0a0a 0a64 6566 2074 6573  ervals...def tes
-00005490: 745f 6d61 6b65 5f69 6e74 6572 7661 6c73  t_make_intervals
-000054a0: 5f6c 6561 645f 696e 6465 7828 7477 6f5f  _lead_index(two_
-000054b0: 6261 6e64 5f73 7065 6374 7275 6d2c 2075  band_spectrum, u
-000054c0: 6e69 666f 726d 5f6f 6363 7570 6174 696f  niform_occupatio
-000054d0: 6e29 3a0a 2020 2020 2320 6368 6563 6b20  n):.    # check 
-000054e0: 7468 6174 2074 6865 2070 6f73 6974 696f  that the positio
-000054f0: 6e20 6f66 2074 6865 206f 6363 7570 6174  n of the occupat
-00005500: 696f 6e20 6465 7465 726d 696e 6573 2074  ion determines t
-00005510: 6865 206c 6561 6420 696e 6465 780a 2020  he lead index.  
-00005520: 2020 746f 7461 6c5f 6e62 5f6c 6561 6473    total_nb_leads
-00005530: 203d 2035 0a20 2020 2066 6f72 2069 2069   = 5.    for i i
-00005540: 6e20 7261 6e67 6528 302c 2074 6f74 616c  n range(0, total
-00005550: 5f6e 625f 6c65 6164 7329 3a0a 2020 2020  _nb_leads):.    
-00005560: 2020 2020 7370 6563 7472 6120 3d20 5b74      spectra = [t
-00005570: 776f 5f62 616e 645f 7370 6563 7472 756d  wo_band_spectrum
-00005580: 5d20 2a20 746f 7461 6c5f 6e62 5f6c 6561  ] * total_nb_lea
-00005590: 6473 0a20 2020 2020 2020 206f 6363 7570  ds.        occup
-000055a0: 6174 696f 6e73 203d 205b 4e6f 6e65 5d20  ations = [None] 
-000055b0: 2a20 6920 2b20 5b75 6e69 666f 726d 5f6f  * i + [uniform_o
-000055c0: 6363 7570 6174 696f 6e5d 202b 205b 4e6f  ccupation] + [No
-000055d0: 6e65 5d20 2a20 2874 6f74 616c 5f6e 625f  ne] * (total_nb_
-000055e0: 6c65 6164 7320 2d20 6920 2d20 3129 0a20  leads - i - 1). 
-000055f0: 2020 2020 2020 2069 6e74 6572 7661 6c73         intervals
-00005600: 203d 206d 616e 7962 6f64 792e 6361 6c63   = manybody.calc
-00005610: 5f69 6e74 6572 7661 6c73 2873 7065 6374  _intervals(spect
-00005620: 7261 2c20 6f63 6375 7061 7469 6f6e 7329  ra, occupations)
-00005630: 0a20 2020 2020 2020 2066 6f72 2069 6e74  .        for int
-00005640: 6572 7661 6c20 696e 2069 6e74 6572 7661  erval in interva
-00005650: 6c73 3a0a 2020 2020 2020 2020 2020 2020  ls:.            
-00005660: 6173 7365 7274 2069 6e74 6572 7661 6c2e  assert interval.
-00005670: 6c65 6164 203d 3d20 690a 0a0a 6465 6620  lead == i...def 
-00005680: 7465 7374 5f6d 616b 655f 696e 7465 7276  test_make_interv
-00005690: 616c 735f 7769 7468 5f65 6e65 7267 795f  als_with_energy_
-000056a0: 636f 6e73 7472 6169 6e74 2874 776f 5f62  constraint(two_b
-000056b0: 616e 645f 7370 6563 7472 756d 2c20 756e  and_spectrum, un
-000056c0: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-000056d0: 293a 0a0a 2020 2020 2320 7365 6c65 6374  ):..    # select
-000056e0: 206f 6e6c 7920 6261 6e64 7320 696e 2065   only bands in e
-000056f0: 6e65 7267 7920 7261 6e67 6520 656d 696e  nergy range emin
-00005700: 203c 2045 5f6e 286b 2920 3c20 656d 6178   < E_n(k) < emax
-00005710: 0a20 2020 2023 2069 6e74 6572 7661 6c73  .    # intervals
-00005720: 2063 6f6e 7461 696e 7320 7468 6520 6d6f   contains the mo
-00005730: 6d65 6e74 756d 2028 6b29 2069 6e74 6572  mentum (k) inter
-00005740: 7661 6c73 2077 6865 7265 2064 2045 5f6e  vals where d E_n
-00005750: 202f 2064 6b20 3e20 300a 2020 2020 2320   / dk > 0.    # 
-00005760: 7769 7468 2074 6865 2061 6464 6974 696f  with the additio
-00005770: 6e61 6c20 636f 6e73 7472 6169 6e74 2065  nal constraint e
-00005780: 6d69 6e20 3c20 455f 6e28 6b29 203c 2065  min < E_n(k) < e
-00005790: 6d61 780a 2020 2020 756e 6966 6f72 6d5f  max.    uniform_
-000057a0: 6f63 6375 7061 7469 6f6e 2e65 6e65 7267  occupation.energ
-000057b0: 795f 7261 6e67 6520 3d20 5b28 2d31 2c20  y_range = [(-1, 
-000057c0: 3129 5d0a 2020 2020 696e 7465 7276 616c  1)].    interval
-000057d0: 7320 3d20 6d61 6e79 626f 6479 2e63 616c  s = manybody.cal
-000057e0: 635f 696e 7465 7276 616c 7328 7477 6f5f  c_intervals(two_
-000057f0: 6261 6e64 5f73 7065 6374 7275 6d2c 2075  band_spectrum, u
-00005800: 6e69 666f 726d 5f6f 6363 7570 6174 696f  niform_occupatio
-00005810: 6e29 0a0a 2020 2020 6173 7365 7274 206c  n)..    assert l
-00005820: 656e 2869 6e74 6572 7661 6c73 2920 3d3d  en(intervals) ==
-00005830: 2074 776f 5f62 616e 645f 7370 6563 7472   two_band_spectr
-00005840: 756d 2e6e 6261 6e64 730a 2020 2020 666f  um.nbands.    fo
-00005850: 7220 692c 2069 6e74 6572 7661 6c20 696e  r i, interval in
-00005860: 2065 6e75 6d65 7261 7465 2869 6e74 6572   enumerate(inter
-00005870: 7661 6c73 293a 0a20 2020 2020 2020 2061  vals):.        a
-00005880: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-00005890: 2869 6e74 6572 7661 6c2c 206d 616e 7962  (interval, manyb
-000058a0: 6f64 792e 496e 7465 7276 616c 290a 2020  ody.Interval).  
-000058b0: 2020 2020 2020 6173 7365 7274 2069 6e74        assert int
-000058c0: 6572 7661 6c2e 6c65 6164 203d 3d20 3020  erval.lead == 0 
-000058d0: 2023 206f 6e6c 7920 6f6e 6520 6c65 6164   # only one lead
-000058e0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-000058f0: 696e 7465 7276 616c 2e62 616e 6420 3d3d  interval.band ==
-00005900: 2069 0a20 2020 2020 2020 2069 6620 696e   i.        if in
-00005910: 7465 7276 616c 2e62 616e 6420 3d3d 2030  terval.band == 0
-00005920: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-00005930: 7365 7274 5f61 6c6d 6f73 745f 6571 7561  sert_almost_equa
-00005940: 6c28 696e 7465 7276 616c 2e6b 6d69 6e2c  l(interval.kmin,
-00005950: 2030 2e35 202a 206e 702e 7069 290a 2020   0.5 * np.pi).  
-00005960: 2020 2020 2020 2020 2020 6173 7365 7274            assert
-00005970: 5f61 6c6d 6f73 745f 6571 7561 6c28 696e  _almost_equal(in
-00005980: 7465 7276 616c 2e6b 6d61 782c 206e 702e  terval.kmax, np.
-00005990: 7069 290a 2020 2020 2020 2020 656c 7365  pi).        else
-000059a0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
-000059b0: 7365 7274 5f61 6c6d 6f73 745f 6571 7561  sert_almost_equa
-000059c0: 6c28 696e 7465 7276 616c 2e6b 6d69 6e2c  l(interval.kmin,
-000059d0: 2030 290a 2020 2020 2020 2020 2020 2020   0).            
-000059e0: 6173 7365 7274 5f61 6c6d 6f73 745f 6571  assert_almost_eq
-000059f0: 7561 6c28 696e 7465 7276 616c 2e6b 6d61  ual(interval.kma
-00005a00: 782c 2030 2e35 202a 206e 702e 7069 290a  x, 0.5 * np.pi).
-00005a10: 0a0a 6465 6620 7465 7374 5f6d 616b 655f  ..def test_make_
-00005a20: 696e 7465 7276 616c 735f 7769 7468 5f65  intervals_with_e
-00005a30: 6e65 7267 795f 616e 645f 6261 6e64 5f63  nergy_and_band_c
-00005a40: 6f6e 7374 7261 696e 7428 7477 6f5f 6261  onstraint(two_ba
-00005a50: 6e64 5f73 7065 6374 7275 6d2c 2075 6e69  nd_spectrum, uni
-00005a60: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
-00005a70: 3a0a 0a20 2020 2023 2073 656c 6563 7420  :..    # select 
-00005a80: 6f6e 6c79 2062 616e 6473 2069 6e20 656e  only bands in en
-00005a90: 6572 6779 2072 616e 6765 2061 6e64 2074  ergy range and t
-00005aa0: 616b 6520 6f6e 6c79 206c 6f77 6573 7420  ake only lowest 
-00005ab0: 6261 6e64 2077 6974 6820 696e 6465 7820  band with index 
-00005ac0: 300a 2020 2020 2320 696e 7465 7276 616c  0.    # interval
-00005ad0: 7320 636f 6e74 6169 6e73 2074 6865 206d  s contains the m
-00005ae0: 6f6d 656e 7475 6d20 286b 2920 696e 7465  omentum (k) inte
-00005af0: 7276 616c 7320 7768 6572 6520 6420 455f  rvals where d E_
-00005b00: 3020 2f20 646b 203e 2030 0a20 2020 2023  0 / dk > 0.    #
-00005b10: 2077 6974 6820 7468 6520 6164 6469 7469   with the additi
-00005b20: 6f6e 616c 2063 6f6e 7374 7261 696e 7420  onal constraint 
-00005b30: 656d 696e 203c 2045 5f30 286b 2920 3c20  emin < E_0(k) < 
-00005b40: 656d 6178 0a20 2020 2023 2028 6e6f 7465  emax.    # (note
-00005b50: 2074 6861 7420 7765 2068 6176 6520 7365   that we have se
-00005b60: 7420 6e20 746f 2030 290a 2020 2020 756e  t n to 0).    un
-00005b70: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-00005b80: 2e65 6e65 7267 795f 7261 6e67 6520 3d20  .energy_range = 
-00005b90: 5b28 2d31 2c20 3129 5d0a 2020 2020 756e  [(-1, 1)].    un
-00005ba0: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-00005bb0: 2e62 616e 6473 203d 205b 305d 0a20 2020  .bands = [0].   
-00005bc0: 2069 6e74 6572 7661 6c73 203d 206d 616e   intervals = man
-00005bd0: 7962 6f64 792e 6361 6c63 5f69 6e74 6572  ybody.calc_inter
-00005be0: 7661 6c73 2874 776f 5f62 616e 645f 7370  vals(two_band_sp
-00005bf0: 6563 7472 756d 2c20 756e 6966 6f72 6d5f  ectrum, uniform_
-00005c00: 6f63 6375 7061 7469 6f6e 290a 0a20 2020  occupation)..   
-00005c10: 2061 7373 6572 7420 6c65 6e28 696e 7465   assert len(inte
-00005c20: 7276 616c 7329 203d 3d20 310a 2020 2020  rvals) == 1.    
-00005c30: 666f 7220 692c 2069 6e74 6572 7661 6c20  for i, interval 
-00005c40: 696e 2065 6e75 6d65 7261 7465 2869 6e74  in enumerate(int
-00005c50: 6572 7661 6c73 293a 0a20 2020 2020 2020  ervals):.       
-00005c60: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00005c70: 6365 2869 6e74 6572 7661 6c2c 206d 616e  ce(interval, man
-00005c80: 7962 6f64 792e 496e 7465 7276 616c 290a  ybody.Interval).
-00005c90: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
-00005ca0: 6e74 6572 7661 6c2e 6c65 6164 203d 3d20  nterval.lead == 
-00005cb0: 3020 2023 206f 6e6c 7920 6f6e 6520 6c65  0  # only one le
-00005cc0: 6164 0a20 2020 2020 2020 2061 7373 6572  ad.        asser
-00005cd0: 7420 696e 7465 7276 616c 2e62 616e 6420  t interval.band 
-00005ce0: 3d3d 2069 0a20 2020 2020 2020 2061 7373  == i.        ass
-00005cf0: 6572 745f 616c 6d6f 7374 5f65 7175 616c  ert_almost_equal
-00005d00: 2869 6e74 6572 7661 6c2e 6b6d 696e 2c20  (interval.kmin, 
-00005d10: 302e 3520 2a20 6e70 2e70 6929 0a20 2020  0.5 * np.pi).   
-00005d20: 2020 2020 2061 7373 6572 745f 616c 6d6f       assert_almo
-00005d30: 7374 5f65 7175 616c 2869 6e74 6572 7661  st_equal(interva
-00005d40: 6c2e 6b6d 6178 2c20 6e70 2e70 6929 0a0a  l.kmax, np.pi)..
-00005d50: 0a64 6566 2074 6573 745f 6d61 6b65 5f69  .def test_make_i
-00005d60: 6e74 6572 7661 6c73 5f77 6869 6368 5f61  ntervals_which_a
-00005d70: 7265 5f65 6d70 7479 2874 776f 5f62 616e  re_empty(two_ban
-00005d80: 645f 7370 6563 7472 756d 2c20 756e 6966  d_spectrum, unif
-00005d90: 6f72 6d5f 6f63 6375 7061 7469 6f6e 293a  orm_occupation):
-00005da0: 0a20 2020 2023 2063 6173 6520 7768 6572  .    # case wher
-00005db0: 6520 6e6f 2069 6e74 6572 7661 6c73 2061  e no intervals a
-00005dc0: 7265 2066 6f75 6e64 0a20 2020 2075 6e69  re found.    uni
-00005dd0: 666f 726d 5f6f 6363 7570 6174 696f 6e2e  form_occupation.
-00005de0: 656e 6572 6779 5f72 616e 6765 203d 205b  energy_range = [
-00005df0: 2835 2c20 3629 5d0a 2020 2020 696e 7465  (5, 6)].    inte
-00005e00: 7276 616c 7320 3d20 6d61 6e79 626f 6479  rvals = manybody
-00005e10: 2e63 616c 635f 696e 7465 7276 616c 7328  .calc_intervals(
-00005e20: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
-00005e30: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
-00005e40: 6174 696f 6e29 0a20 2020 2061 7373 6572  ation).    asser
-00005e50: 7420 6973 696e 7374 616e 6365 2869 6e74  t isinstance(int
-00005e60: 6572 7661 6c73 2c20 6c69 7374 290a 2020  ervals, list).  
-00005e70: 2020 6173 7365 7274 206c 656e 2869 6e74    assert len(int
-00005e80: 6572 7661 6c73 2920 3d3d 2030 0a0a 0a64  ervals) == 0...d
-00005e90: 6566 2074 6573 745f 6d61 6b65 5f69 6e74  ef test_make_int
-00005ea0: 6572 7661 6c73 5f77 6974 685f 7477 6f5f  ervals_with_two_
-00005eb0: 7369 6d69 6c61 725f 6f63 6375 7069 6564  similar_occupied
-00005ec0: 5f6c 6561 6473 2874 776f 5f62 616e 645f  _leads(two_band_
-00005ed0: 7370 6563 7472 756d 2c20 756e 6966 6f72  spectrum, unifor
-00005ee0: 6d5f 6f63 6375 7061 7469 6f6e 293a 0a20  m_occupation):. 
-00005ef0: 2020 2023 2074 776f 206c 6561 6473 2077     # two leads w
-00005f00: 6974 6820 6571 7561 6c20 6f63 6375 7061  ith equal occupa
-00005f10: 7469 6f6e 0a20 2020 206e 756d 5f6c 6561  tion.    num_lea
-00005f20: 6473 203d 2032 0a20 2020 2069 6e74 6572  ds = 2.    inter
-00005f30: 7661 6c73 203d 206d 616e 7962 6f64 792e  vals = manybody.
-00005f40: 6361 6c63 5f69 6e74 6572 7661 6c73 285b  calc_intervals([
-00005f50: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
-00005f60: 6d5d 202a 206e 756d 5f6c 6561 6473 2c20  m] * num_leads, 
-00005f70: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-00005f80: 6f6e 290a 2020 2020 6173 7365 7274 206c  on).    assert l
-00005f90: 656e 2869 6e74 6572 7661 6c73 2920 3d3d  en(intervals) ==
-00005fa0: 2074 776f 5f62 616e 645f 7370 6563 7472   two_band_spectr
-00005fb0: 756d 2e6e 6261 6e64 7320 2a20 6e75 6d5f  um.nbands * num_
-00005fc0: 6c65 6164 730a 2020 2020 666f 7220 692c  leads.    for i,
-00005fd0: 2069 6e74 6572 7661 6c20 696e 2065 6e75   interval in enu
-00005fe0: 6d65 7261 7465 2869 6e74 6572 7661 6c73  merate(intervals
-00005ff0: 293a 0a20 2020 2020 2020 2061 7373 6572  ):.        asser
-00006000: 7420 6973 696e 7374 616e 6365 2869 6e74  t isinstance(int
-00006010: 6572 7661 6c2c 206d 616e 7962 6f64 792e  erval, manybody.
-00006020: 496e 7465 7276 616c 290a 2020 2020 2020  Interval).      
-00006030: 2020 6173 7365 7274 2069 6e74 6572 7661    assert interva
-00006040: 6c2e 6c65 6164 2069 6e20 7261 6e67 6528  l.lead in range(
-00006050: 6e75 6d5f 6c65 6164 7329 0a20 2020 2020  num_leads).     
-00006060: 2020 2061 7373 6572 745f 616c 6d6f 7374     assert_almost
-00006070: 5f65 7175 616c 2869 6e74 6572 7661 6c2e  _equal(interval.
-00006080: 6b6d 696e 2c20 3029 0a20 2020 2020 2020  kmin, 0).       
-00006090: 2061 7373 6572 745f 616c 6d6f 7374 5f65   assert_almost_e
-000060a0: 7175 616c 2869 6e74 6572 7661 6c2e 6b6d  qual(interval.km
-000060b0: 6178 2c20 6e70 2e70 6929 0a0a 0a64 6566  ax, np.pi)...def
-000060c0: 2074 6573 745f 6d61 6b65 5f69 6e74 6572   test_make_inter
-000060d0: 7661 6c73 5f77 6974 685f 7477 6f5f 6469  vals_with_two_di
-000060e0: 6666 6572 656e 746c 795f 6f63 6375 7069  fferently_occupi
-000060f0: 6564 5f6c 6561 6473 2874 776f 5f62 616e  ed_leads(two_ban
-00006100: 645f 7370 6563 7472 756d 2c20 756e 6966  d_spectrum, unif
-00006110: 6f72 6d5f 6f63 6375 7061 7469 6f6e 293a  orm_occupation):
-00006120: 0a20 2020 2023 2074 776f 206c 6561 6473  .    # two leads
-00006130: 2077 6974 6820 6469 6666 6572 656e 7420   with different 
-00006140: 6f63 6375 7061 7469 6f6e 730a 2020 2020  occupations.    
-00006150: 6e75 6d5f 6c65 6164 7320 3d20 320a 2020  num_leads = 2.  
-00006160: 2020 6f63 6375 7061 7469 6f6e 5f31 203d    occupation_1 =
-00006170: 2063 6f70 792e 6465 6570 636f 7079 2875   copy.deepcopy(u
-00006180: 6e69 666f 726d 5f6f 6363 7570 6174 696f  niform_occupatio
-00006190: 6e29 0a20 2020 206f 6363 7570 6174 696f  n).    occupatio
-000061a0: 6e5f 312e 6261 6e64 7320 3d20 5b30 5d0a  n_1.bands = [0].
-000061b0: 2020 2020 6f63 6375 7061 7469 6f6e 5f32      occupation_2
-000061c0: 203d 2063 6f70 792e 6465 6570 636f 7079   = copy.deepcopy
-000061d0: 2875 6e69 666f 726d 5f6f 6363 7570 6174  (uniform_occupat
-000061e0: 696f 6e29 0a20 2020 206f 6363 7570 6174  ion).    occupat
-000061f0: 696f 6e5f 322e 656e 6572 6779 5f72 616e  ion_2.energy_ran
-00006200: 6765 203d 205b 282d 312c 2031 295d 0a20  ge = [(-1, 1)]. 
-00006210: 2020 206f 6363 7570 6174 696f 6e5f 322e     occupation_2.
-00006220: 6261 6e64 7320 3d20 5b30 5d0a 2020 2020  bands = [0].    
-00006230: 696e 7465 7276 616c 7320 3d20 6d61 6e79  intervals = many
-00006240: 626f 6479 2e63 616c 635f 696e 7465 7276  body.calc_interv
-00006250: 616c 7328 5b74 776f 5f62 616e 645f 7370  als([two_band_sp
-00006260: 6563 7472 756d 5d20 2a20 6e75 6d5f 6c65  ectrum] * num_le
-00006270: 6164 732c 205b 6f63 6375 7061 7469 6f6e  ads, [occupation
-00006280: 5f31 2c20 6f63 6375 7061 7469 6f6e 5f32  _1, occupation_2
-00006290: 5d29 0a20 2020 2061 7373 6572 7420 6c65  ]).    assert le
-000062a0: 6e28 696e 7465 7276 616c 7329 203d 3d20  n(intervals) == 
-000062b0: 6e75 6d5f 6c65 6164 7320 2023 206f 6e6c  num_leads  # onl
-000062c0: 7920 6f6e 6520 6261 6e64 2070 6572 206c  y one band per l
-000062d0: 6561 640a 2020 2020 666f 7220 692c 2069  ead.    for i, i
-000062e0: 6e74 6572 7661 6c20 696e 2065 6e75 6d65  nterval in enume
-000062f0: 7261 7465 2869 6e74 6572 7661 6c73 293a  rate(intervals):
-00006300: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00006310: 6973 696e 7374 616e 6365 2869 6e74 6572  isinstance(inter
-00006320: 7661 6c2c 206d 616e 7962 6f64 792e 496e  val, manybody.In
-00006330: 7465 7276 616c 290a 2020 2020 2020 2020  terval).        
-00006340: 6966 2069 6e74 6572 7661 6c2e 6c65 6164  if interval.lead
-00006350: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00006360: 2020 2061 7373 6572 745f 616c 6d6f 7374     assert_almost
-00006370: 5f65 7175 616c 2869 6e74 6572 7661 6c2e  _equal(interval.
-00006380: 6b6d 696e 2c20 3029 0a20 2020 2020 2020  kmin, 0).       
-00006390: 2020 2020 2061 7373 6572 745f 616c 6d6f       assert_almo
-000063a0: 7374 5f65 7175 616c 2869 6e74 6572 7661  st_equal(interva
-000063b0: 6c2e 6b6d 6178 2c20 6e70 2e70 6929 0a20  l.kmax, np.pi). 
-000063c0: 2020 2020 2020 2065 6c69 6620 696e 7465         elif inte
-000063d0: 7276 616c 2e6c 6561 6420 3d3d 2031 3a0a  rval.lead == 1:.
-000063e0: 2020 2020 2020 2020 2020 2020 6173 7365              asse
-000063f0: 7274 5f61 6c6d 6f73 745f 6571 7561 6c28  rt_almost_equal(
-00006400: 696e 7465 7276 616c 2e6b 6d69 6e2c 2030  interval.kmin, 0
-00006410: 2e35 202a 206e 702e 7069 290a 2020 2020  .5 * np.pi).    
-00006420: 2020 2020 2020 2020 6173 7365 7274 5f61          assert_a
-00006430: 6c6d 6f73 745f 6571 7561 6c28 696e 7465  lmost_equal(inte
-00006440: 7276 616c 2e6b 6d61 782c 206e 702e 7069  rval.kmax, np.pi
-00006450: 290a 0a0a 6465 6620 7465 7374 5f6d 616b  )...def test_mak
-00006460: 655f 696e 7465 7276 616c 735f 696e 7465  e_intervals_inte
-00006470: 7266 6163 6528 7477 6f5f 6261 6e64 5f73  rface(two_band_s
-00006480: 7065 6374 7275 6d2c 2075 6e69 666f 726d  pectrum, uniform
-00006490: 5f6f 6363 7570 6174 696f 6e29 3a0a 2020  _occupation):.  
-000064a0: 2020 2320 6368 6563 6b20 666f 7220 726f    # check for ro
-000064b0: 6275 7374 6e65 7373 206f 6620 696e 7465  bustness of inte
-000064c0: 7266 6163 7420 666f 7220 7365 7175 656e  rfact for sequen
-000064d0: 6365 7320 696e 7075 740a 2020 2020 696e  ces input.    in
-000064e0: 7465 7276 616c 735f 3120 3d20 6d61 6e79  tervals_1 = many
-000064f0: 626f 6479 2e63 616c 635f 696e 7465 7276  body.calc_interv
-00006500: 616c 7328 7477 6f5f 6261 6e64 5f73 7065  als(two_band_spe
-00006510: 6374 7275 6d2c 2075 6e69 666f 726d 5f6f  ctrum, uniform_o
-00006520: 6363 7570 6174 696f 6e29 0a20 2020 2069  ccupation).    i
-00006530: 6e74 6572 7661 6c73 5f32 203d 206d 616e  ntervals_2 = man
-00006540: 7962 6f64 792e 6361 6c63 5f69 6e74 6572  ybody.calc_inter
-00006550: 7661 6c73 285b 7477 6f5f 6261 6e64 5f73  vals([two_band_s
-00006560: 7065 6374 7275 6d5d 2c20 756e 6966 6f72  pectrum], unifor
-00006570: 6d5f 6f63 6375 7061 7469 6f6e 290a 2020  m_occupation).  
-00006580: 2020 696e 7465 7276 616c 735f 3320 3d20    intervals_3 = 
-00006590: 6d61 6e79 626f 6479 2e63 616c 635f 696e  manybody.calc_in
-000065a0: 7465 7276 616c 7328 7477 6f5f 6261 6e64  tervals(two_band
-000065b0: 5f73 7065 6374 7275 6d2c 205b 756e 6966  _spectrum, [unif
-000065c0: 6f72 6d5f 6f63 6375 7061 7469 6f6e 5d29  orm_occupation])
-000065d0: 0a20 2020 2069 6e74 6572 7661 6c73 5f34  .    intervals_4
-000065e0: 203d 206d 616e 7962 6f64 792e 6361 6c63   = manybody.calc
-000065f0: 5f69 6e74 6572 7661 6c73 285b 7477 6f5f  _intervals([two_
-00006600: 6261 6e64 5f73 7065 6374 7275 6d5d 2c20  band_spectrum], 
-00006610: 5b75 6e69 666f 726d 5f6f 6363 7570 6174  [uniform_occupat
-00006620: 696f 6e5d 290a 2020 2020 6173 7365 7274  ion]).    assert
-00006630: 2069 6e74 6572 7661 6c73 5f31 203d 3d20   intervals_1 == 
-00006640: 696e 7465 7276 616c 735f 3220 3d3d 2069  intervals_2 == i
-00006650: 6e74 6572 7661 6c73 5f33 203d 3d20 696e  ntervals_3 == in
-00006660: 7465 7276 616c 735f 340a 2020 2020 696e  tervals_4.    in
-00006670: 7465 7276 616c 735f 3120 3d20 6d61 6e79  tervals_1 = many
-00006680: 626f 6479 2e63 616c 635f 696e 7465 7276  body.calc_interv
-00006690: 616c 7328 5b74 776f 5f62 616e 645f 7370  als([two_band_sp
-000066a0: 6563 7472 756d 5d20 2a20 322c 205b 756e  ectrum] * 2, [un
-000066b0: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-000066c0: 5d20 2a20 3229 0a20 2020 2069 6e74 6572  ] * 2).    inter
-000066d0: 7661 6c73 5f32 203d 206d 616e 7962 6f64  vals_2 = manybod
-000066e0: 792e 6361 6c63 5f69 6e74 6572 7661 6c73  y.calc_intervals
-000066f0: 2828 7477 6f5f 6261 6e64 5f73 7065 6374  ((two_band_spect
-00006700: 7275 6d2c 2074 776f 5f62 616e 645f 7370  rum, two_band_sp
-00006710: 6563 7472 756d 292c 2075 6e69 666f 726d  ectrum), uniform
-00006720: 5f6f 6363 7570 6174 696f 6e29 0a20 2020  _occupation).   
-00006730: 2061 7373 6572 7420 696e 7465 7276 616c   assert interval
-00006740: 735f 3120 3d3d 2069 6e74 6572 7661 6c73  s_1 == intervals
-00006750: 5f32 2020 2320 6f6e 6c79 2074 7275 6520  _2  # only true 
-00006760: 696e 2065 7175 616c 206f 6363 7570 6174  in equal occupat
-00006770: 696f 6e0a 0a0a 6465 6620 7465 7374 5f6d  ion...def test_m
-00006780: 616b 655f 696e 7465 7276 616c 735f 6261  ake_intervals_ba
-00006790: 6e64 5f69 6e64 6578 5f6f 7574 5f6f 665f  nd_index_out_of_
-000067a0: 7261 6e67 6528 7477 6f5f 6261 6e64 5f73  range(two_band_s
-000067b0: 7065 6374 7275 6d2c 2075 6e69 666f 726d  pectrum, uniform
-000067c0: 5f6f 6363 7570 6174 696f 6e29 3a0a 2020  _occupation):.  
-000067d0: 2020 756e 6966 6f72 6d5f 6f63 6375 7061    uniform_occupa
-000067e0: 7469 6f6e 2e62 616e 6473 203d 205b 7477  tion.bands = [tw
-000067f0: 6f5f 6261 6e64 5f73 7065 6374 7275 6d2e  o_band_spectrum.
-00006800: 6e62 616e 6473 5d0a 2020 2020 7261 6973  nbands].    rais
-00006810: 6573 2841 7373 6572 7469 6f6e 4572 726f  es(AssertionErro
-00006820: 722c 206d 616e 7962 6f64 792e 6361 6c63  r, manybody.calc
-00006830: 5f69 6e74 6572 7661 6c73 2c20 7477 6f5f  _intervals, two_
-00006840: 6261 6e64 5f73 7065 6374 7275 6d2c 2075  band_spectrum, u
-00006850: 6e69 666f 726d 5f6f 6363 7570 6174 696f  niform_occupatio
-00006860: 6e29 0a0a 0a64 6566 2074 6573 745f 6d61  n)...def test_ma
-00006870: 6b65 5f69 6e74 6572 7661 6c73 5f62 616e  ke_intervals_ban
-00006880: 645f 696e 6465 785f 6e6f 745f 696e 7465  d_index_not_inte
-00006890: 6765 7228 7477 6f5f 6261 6e64 5f73 7065  ger(two_band_spe
-000068a0: 6374 7275 6d2c 2075 6e69 666f 726d 5f6f  ctrum, uniform_o
-000068b0: 6363 7570 6174 696f 6e29 3a0a 2020 2020  ccupation):.    
-000068c0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-000068d0: 6f6e 2e62 616e 6473 203d 205b 302e 5d0a  on.bands = [0.].
-000068e0: 2020 2020 7261 6973 6573 2841 7373 6572      raises(Asser
-000068f0: 7469 6f6e 4572 726f 722c 206d 616e 7962  tionError, manyb
-00006900: 6f64 792e 6361 6c63 5f69 6e74 6572 7661  ody.calc_interva
-00006910: 6c73 2c20 7477 6f5f 6261 6e64 5f73 7065  ls, two_band_spe
-00006920: 6374 7275 6d2c 2075 6e69 666f 726d 5f6f  ctrum, uniform_o
-00006930: 6363 7570 6174 696f 6e29 0a0a 0a64 6566  ccupation)...def
-00006940: 2074 6573 745f 6d61 6b65 5f69 6e74 6572   test_make_inter
-00006950: 7661 6c73 5f65 6e65 7267 6965 735f 696e  vals_energies_in
-00006960: 7465 7263 6861 6e67 6564 2874 776f 5f62  terchanged(two_b
-00006970: 616e 645f 7370 6563 7472 756d 2c20 756e  and_spectrum, un
-00006980: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-00006990: 293a 0a20 2020 2075 6e69 666f 726d 5f6f  ):.    uniform_o
-000069a0: 6363 7570 6174 696f 6e2e 656e 6572 6779  ccupation.energy
-000069b0: 5f72 616e 6765 203d 205b 2831 2c20 3029  _range = [(1, 0)
-000069c0: 5d0a 2020 2020 7261 6973 6573 2841 7373  ].    raises(Ass
-000069d0: 6572 7469 6f6e 4572 726f 722c 206d 616e  ertionError, man
-000069e0: 7962 6f64 792e 6361 6c63 5f69 6e74 6572  ybody.calc_inter
-000069f0: 7661 6c73 2c20 7477 6f5f 6261 6e64 5f73  vals, two_band_s
-00006a00: 7065 6374 7275 6d2c 2075 6e69 666f 726d  pectrum, uniform
-00006a10: 5f6f 6363 7570 6174 696f 6e29 0a0a 0a64  _occupation)...d
-00006a20: 6566 2074 6573 745f 6d61 6b65 5f69 6e74  ef test_make_int
-00006a30: 6572 7661 6c73 5f65 6d69 6e5f 6e6f 745f  ervals_emin_not_
-00006a40: 7265 616c 2874 776f 5f62 616e 645f 7370  real(two_band_sp
-00006a50: 6563 7472 756d 2c20 756e 6966 6f72 6d5f  ectrum, uniform_
-00006a60: 6f63 6375 7061 7469 6f6e 293a 0a20 2020  occupation):.   
-00006a70: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
-00006a80: 696f 6e2e 656e 6572 6779 5f72 616e 6765  ion.energy_range
-00006a90: 203d 205b 2831 202b 2031 6a2c 204e 6f6e   = [(1 + 1j, Non
-00006aa0: 6529 5d0a 2020 2020 2320 746f 646f 0a20  e)].    # todo. 
-00006ab0: 2020 2023 2072 6169 7365 7328 5479 7065     # raises(Type
-00006ac0: 4572 726f 722c 206d 616e 7962 6f64 792e  Error, manybody.
-00006ad0: 6361 6c63 5f69 6e74 6572 7661 6c73 2c20  calc_intervals, 
-00006ae0: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
-00006af0: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
-00006b00: 6174 696f 6e29 0a0a 0a64 6566 2074 6573  ation)...def tes
-00006b10: 745f 6d61 6b65 5f69 6e74 6572 7661 6c73  t_make_intervals
-00006b20: 5f65 6d61 785f 6e6f 745f 7265 616c 2874  _emax_not_real(t
-00006b30: 776f 5f62 616e 645f 7370 6563 7472 756d  wo_band_spectrum
-00006b40: 2c20 756e 6966 6f72 6d5f 6f63 6375 7061  , uniform_occupa
-00006b50: 7469 6f6e 293a 0a20 2020 2075 6e69 666f  tion):.    unifo
-00006b60: 726d 5f6f 6363 7570 6174 696f 6e2e 656e  rm_occupation.en
-00006b70: 6572 6779 5f72 616e 6765 203d 205b 284e  ergy_range = [(N
-00006b80: 6f6e 652c 2031 202b 2031 6a29 5d0a 2020  one, 1 + 1j)].  
-00006b90: 2020 2320 746f 646f 0a20 2020 2023 2072    # todo.    # r
-00006ba0: 6169 7365 7328 5479 7065 4572 726f 722c  aises(TypeError,
-00006bb0: 206d 616e 7962 6f64 792e 6361 6c63 5f69   manybody.calc_i
-00006bc0: 6e74 6572 7661 6c73 2c20 7477 6f5f 6261  ntervals, two_ba
-00006bd0: 6e64 5f73 7065 6374 7275 6d2c 2075 6e69  nd_spectrum, uni
-00006be0: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
-00006bf0: 0a0a 0a64 6566 2074 6573 745f 6d61 6b65  ...def test_make
-00006c00: 5f69 6e74 6572 7661 6c73 5f69 6e63 6f6e  _intervals_incon
-00006c10: 7369 7465 6e74 5f69 6e70 7574 2874 776f  sitent_input(two
-00006c20: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
-00006c30: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-00006c40: 6f6e 293a 0a20 2020 2023 2069 6e68 6f6d  on):.    # inhom
-00006c50: 6f67 656e 656f 7573 206f 6363 7570 6174  ogeneous occupat
-00006c60: 696f 6e2c 2074 6861 7420 646f 6573 206e  ion, that does n
-00006c70: 6f74 2066 6974 2074 6865 206e 756d 6265  ot fit the numbe
-00006c80: 7220 6f66 206c 6561 6473 0a20 2020 2072  r of leads.    r
-00006c90: 6169 7365 7328 5661 6c75 6545 7272 6f72  aises(ValueError
-00006ca0: 2c20 6d61 6e79 626f 6479 2e63 616c 635f  , manybody.calc_
-00006cb0: 696e 7465 7276 616c 732c 2074 776f 5f62  intervals, two_b
-00006cc0: 616e 645f 7370 6563 7472 756d 2c20 5b75  and_spectrum, [u
-00006cd0: 6e69 666f 726d 5f6f 6363 7570 6174 696f  niform_occupatio
-00006ce0: 6e5d 202a 2032 290a 2020 2020 7261 6973  n] * 2).    rais
-00006cf0: 6573 2856 616c 7565 4572 726f 722c 206d  es(ValueError, m
-00006d00: 616e 7962 6f64 792e 6361 6c63 5f69 6e74  anybody.calc_int
-00006d10: 6572 7661 6c73 2c20 5b74 776f 5f62 616e  ervals, [two_ban
-00006d20: 645f 7370 6563 7472 756d 5d2c 205b 756e  d_spectrum], [un
-00006d30: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-00006d40: 5d20 2a20 3229 0a20 2020 2072 6169 7365  ] * 2).    raise
-00006d50: 7328 5661 6c75 6545 7272 6f72 2c20 6d61  s(ValueError, ma
-00006d60: 6e79 626f 6479 2e63 616c 635f 696e 7465  nybody.calc_inte
-00006d70: 7276 616c 732c 205b 7477 6f5f 6261 6e64  rvals, [two_band
-00006d80: 5f73 7065 6374 7275 6d5d 202a 2033 2c20  _spectrum] * 3, 
-00006d90: 5b75 6e69 666f 726d 5f6f 6363 7570 6174  [uniform_occupat
-00006da0: 696f 6e5d 202a 2032 290a 0a0a 6465 6620  ion] * 2)...def 
-00006db0: 7465 7374 5f6d 616b 655f 696e 7465 7276  test_make_interv
-00006dc0: 616c 735f 6d69 7373 696e 675f 656e 6572  als_missing_ener
-00006dd0: 6779 5f72 616e 6765 5f61 7474 7269 6275  gy_range_attribu
-00006de0: 7465 2874 776f 5f62 616e 645f 7370 6563  te(two_band_spec
-00006df0: 7472 756d 2c20 756e 6966 6f72 6d5f 6f63  trum, uniform_oc
-00006e00: 6375 7061 7469 6f6e 293a 0a20 2020 2064  cupation):.    d
-00006e10: 656c 2075 6e69 666f 726d 5f6f 6363 7570  el uniform_occup
-00006e20: 6174 696f 6e2e 656e 6572 6779 5f72 616e  ation.energy_ran
-00006e30: 6765 0a20 2020 2072 6169 7365 7328 4174  ge.    raises(At
-00006e40: 7472 6962 7574 6545 7272 6f72 2c20 6d61  tributeError, ma
-00006e50: 6e79 626f 6479 2e63 616c 635f 696e 7465  nybody.calc_inte
-00006e60: 7276 616c 732c 2074 776f 5f62 616e 645f  rvals, two_band_
-00006e70: 7370 6563 7472 756d 2c20 756e 6966 6f72  spectrum, unifor
-00006e80: 6d5f 6f63 6375 7061 7469 6f6e 290a 0a0a  m_occupation)...
-00006e90: 6465 6620 7465 7374 5f6d 616b 655f 696e  def test_make_in
-00006ea0: 7465 7276 616c 735f 6d69 7373 696e 675f  tervals_missing_
-00006eb0: 6261 6e64 735f 6174 7472 6962 7574 6528  bands_attribute(
-00006ec0: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
-00006ed0: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
-00006ee0: 6174 696f 6e29 3a0a 2020 2020 6465 6c20  ation):.    del 
-00006ef0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-00006f00: 6f6e 2e62 616e 6473 0a20 2020 2072 6169  on.bands.    rai
-00006f10: 7365 7328 4174 7472 6962 7574 6545 7272  ses(AttributeErr
-00006f20: 6f72 2c20 6d61 6e79 626f 6479 2e63 616c  or, manybody.cal
-00006f30: 635f 696e 7465 7276 616c 732c 2074 776f  c_intervals, two
-00006f40: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
-00006f50: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-00006f60: 6f6e 290a 0a0a 6465 6620 7465 7374 5f6d  on)...def test_m
-00006f70: 616b 655f 696e 7465 7276 616c 735f 6d69  ake_intervals_mi
-00006f80: 7373 696e 675f 6469 7374 7269 6275 7469  ssing_distributi
-00006f90: 6f6e 5f61 7474 7269 6275 7465 2874 776f  on_attribute(two
-00006fa0: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
-00006fb0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-00006fc0: 6f6e 293a 0a20 2020 2064 656c 2075 6e69  on):.    del uni
-00006fd0: 666f 726d 5f6f 6363 7570 6174 696f 6e2e  form_occupation.
-00006fe0: 6469 7374 7269 6275 7469 6f6e 0a20 2020  distribution.   
-00006ff0: 2023 2074 6f64 6f0a 2320 2020 2072 6169   # todo.#    rai
-00007000: 7365 7328 4174 7472 6962 7574 6545 7272  ses(AttributeErr
-00007010: 6f72 2c20 6d61 6e79 626f 6479 2e63 616c  or, manybody.cal
-00007020: 635f 696e 7465 7276 616c 732c 2074 776f  c_intervals, two
-00007030: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
-00007040: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-00007050: 6f6e 290a 0a0a 6465 6620 7465 7374 5f73  on)...def test_s
-00007060: 706c 6974 5f69 6e74 6572 7661 6c5f 696e  plit_interval_in
-00007070: 746f 5f74 776f 2853 696d 706c 6549 6e74  to_two(SimpleInt
-00007080: 6572 7661 6c29 3a0a 0a20 2020 206e 696e  erval):..    nin
-00007090: 7420 3d20 3120 2023 206e 756d 6265 7220  t = 1  # number 
-000070a0: 6f66 2072 6574 7572 6e65 6420 696e 7465  of returned inte
-000070b0: 7276 616c 730a 2020 2020 696e 7465 7276  rvals.    interv
-000070c0: 616c 7320 3d20 6d61 6e79 626f 6479 2e5f  als = manybody._
-000070d0: 7370 6c69 745f 696e 7465 7276 616c 2869  split_interval(i
-000070e0: 6e74 6572 7661 6c3d 5369 6d70 6c65 496e  nterval=SimpleIn
-000070f0: 7465 7276 616c 286b 6d69 6e3d 302c 206b  terval(kmin=0, k
-00007100: 6d61 783d 3129 2c0a 2020 2020 2020 2020  max=1),.        
-00007110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007130: 206e 756d 6265 725f 7375 6269 6e74 6572   number_subinter
-00007140: 7661 6c73 3d6e 696e 7429 0a20 2020 2061  vals=nint).    a
-00007150: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-00007160: 2869 6e74 6572 7661 6c73 2c20 6c69 7374  (intervals, list
-00007170: 290a 2020 2020 6173 7365 7274 206c 656e  ).    assert len
-00007180: 2869 6e74 6572 7661 6c73 2920 3d3d 206e  (intervals) == n
-00007190: 696e 740a 2020 2020 6173 7365 7274 2069  int.    assert i
-000071a0: 6e74 6572 7661 6c73 203d 3d20 5b53 696d  ntervals == [Sim
-000071b0: 706c 6549 6e74 6572 7661 6c28 6b6d 696e  pleInterval(kmin
-000071c0: 3d30 2c20 6b6d 6178 3d31 295d 0a0a 0a64  =0, kmax=1)]...d
-000071d0: 6566 2074 6573 745f 7370 6c69 745f 696e  ef test_split_in
-000071e0: 7465 7276 616c 5f69 6e74 6f5f 7468 7265  terval_into_thre
-000071f0: 6528 5369 6d70 6c65 496e 7465 7276 616c  e(SimpleInterval
-00007200: 293a 0a0a 2020 2020 6e69 6e74 203d 2032  ):..    nint = 2
-00007210: 2020 2320 6e75 6d62 6572 206f 6620 7265    # number of re
-00007220: 7475 726e 6564 2069 6e74 6572 7661 6c73  turned intervals
-00007230: 0a20 2020 2069 6e74 6572 7661 6c73 203d  .    intervals =
-00007240: 206d 616e 7962 6f64 792e 5f73 706c 6974   manybody._split
-00007250: 5f69 6e74 6572 7661 6c28 696e 7465 7276  _interval(interv
-00007260: 616c 3d53 696d 706c 6549 6e74 6572 7661  al=SimpleInterva
-00007270: 6c28 6b6d 696e 3d30 2c20 6b6d 6178 3d31  l(kmin=0, kmax=1
-00007280: 292c 0a20 2020 2020 2020 2020 2020 2020  ),.             
-00007290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000072a0: 2020 2020 2020 2020 2020 2020 6e75 6d62              numb
-000072b0: 6572 5f73 7562 696e 7465 7276 616c 733d  er_subintervals=
-000072c0: 6e69 6e74 290a 2020 2020 6173 7365 7274  nint).    assert
-000072d0: 2069 7369 6e73 7461 6e63 6528 696e 7465   isinstance(inte
-000072e0: 7276 616c 732c 206c 6973 7429 0a20 2020  rvals, list).   
-000072f0: 2061 7373 6572 7420 6c65 6e28 696e 7465   assert len(inte
-00007300: 7276 616c 7329 203d 3d20 6e69 6e74 0a20  rvals) == nint. 
-00007310: 2020 2061 7373 6572 7420 696e 7465 7276     assert interv
-00007320: 616c 7320 3d3d 205b 5369 6d70 6c65 496e  als == [SimpleIn
-00007330: 7465 7276 616c 286b 6d69 6e3d 302c 206b  terval(kmin=0, k
-00007340: 6d61 783d 302e 3529 2c0a 2020 2020 2020  max=0.5),.      
-00007350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007360: 2020 2053 696d 706c 6549 6e74 6572 7661     SimpleInterva
-00007370: 6c28 6b6d 696e 3d30 2e35 2c20 6b6d 6178  l(kmin=0.5, kmax
-00007380: 3d31 295d 0a0a 0a64 6566 2074 6573 745f  =1)]...def test_
-00007390: 7370 6c69 745f 696e 7465 7276 616c 5f77  split_interval_w
-000073a0: 726f 6e67 5f69 6e70 7574 2853 696d 706c  rong_input(Simpl
-000073b0: 6549 6e74 6572 7661 6c29 3a0a 2020 2020  eInterval):.    
-000073c0: 7261 6973 6573 2856 616c 7565 4572 726f  raises(ValueErro
-000073d0: 722c 206d 616e 7962 6f64 792e 5f73 706c  r, manybody._spl
-000073e0: 6974 5f69 6e74 6572 7661 6c2c 2053 696d  it_interval, Sim
-000073f0: 706c 6549 6e74 6572 7661 6c28 6b6d 696e  pleInterval(kmin
-00007400: 3d30 2c20 6b6d 6178 3d31 292c 206e 756d  =0, kmax=1), num
-00007410: 6265 725f 7375 6269 6e74 6572 7661 6c73  ber_subintervals
-00007420: 3d30 290a 2020 2020 7261 6973 6573 2841  =0).    raises(A
-00007430: 7373 6572 7469 6f6e 4572 726f 722c 206d  ssertionError, m
-00007440: 616e 7962 6f64 792e 5f73 706c 6974 5f69  anybody._split_i
-00007450: 6e74 6572 7661 6c2c 2053 696d 706c 6549  nterval, SimpleI
-00007460: 6e74 6572 7661 6c28 6b6d 696e 3d30 2c20  nterval(kmin=0, 
-00007470: 6b6d 6178 3d31 292c 206e 756d 6265 725f  kmax=1), number_
-00007480: 7375 6269 6e74 6572 7661 6c73 3d31 2e29  subintervals=1.)
-00007490: 0a0a 0a64 6566 2074 6573 745f 7370 6c69  ...def test_spli
-000074a0: 745f 696e 7465 7276 616c 5f6b 6d69 6e5f  t_interval_kmin_
-000074b0: 6174 7472 6962 7574 655f 6d69 7373 696e  attribute_missin
-000074c0: 6728 5369 6d70 6c65 496e 7465 7276 616c  g(SimpleInterval
-000074d0: 293a 0a20 2020 2069 6e74 6572 7661 6c20  ):.    interval 
-000074e0: 3d20 5369 6d70 6c65 496e 7465 7276 616c  = SimpleInterval
-000074f0: 2830 2c20 3129 0a20 2020 2064 656c 2069  (0, 1).    del i
-00007500: 6e74 6572 7661 6c2e 6b6d 696e 0a20 2020  nterval.kmin.   
-00007510: 2072 6169 7365 7328 4174 7472 6962 7574   raises(Attribut
-00007520: 6545 7272 6f72 2c20 6d61 6e79 626f 6479  eError, manybody
-00007530: 2e5f 7370 6c69 745f 696e 7465 7276 616c  ._split_interval
-00007540: 2c20 696e 7465 7276 616c 2c20 3229 0a0a  , interval, 2)..
-00007550: 0a64 6566 2074 6573 745f 7370 6c69 745f  .def test_split_
-00007560: 696e 7465 7276 616c 5f6b 6d61 785f 6174  interval_kmax_at
-00007570: 7472 6962 7574 655f 6d69 7373 696e 6728  tribute_missing(
-00007580: 5369 6d70 6c65 496e 7465 7276 616c 293a  SimpleInterval):
-00007590: 0a20 2020 2069 6e74 6572 7661 6c20 3d20  .    interval = 
-000075a0: 5369 6d70 6c65 496e 7465 7276 616c 2830  SimpleInterval(0
-000075b0: 2c20 3129 0a20 2020 2064 656c 2069 6e74  , 1).    del int
-000075c0: 6572 7661 6c2e 6b6d 6178 0a20 2020 2072  erval.kmax.    r
-000075d0: 6169 7365 7328 4174 7472 6962 7574 6545  aises(AttributeE
-000075e0: 7272 6f72 2c20 6d61 6e79 626f 6479 2e5f  rror, manybody._
-000075f0: 7370 6c69 745f 696e 7465 7276 616c 2c20  split_interval, 
-00007600: 696e 7465 7276 616c 2c20 3229 0a0a 0a64  interval, 2)...d
-00007610: 6566 2074 6573 745f 7370 6c69 745f 696e  ef test_split_in
-00007620: 7465 7276 616c 735f 6e6f 5f73 706c 6974  tervals_no_split
-00007630: 2853 696d 706c 6549 6e74 6572 7661 6c29  (SimpleInterval)
-00007640: 3a0a 2020 2020 6e69 6e74 203d 2031 2020  :.    nint = 1  
-00007650: 2320 6e75 6d62 6572 206f 6620 7265 7475  # number of retu
-00007660: 726e 6564 2069 6e74 6572 7661 6c73 2070  rned intervals p
-00007670: 6572 2069 6e70 7574 2069 6e74 6572 7661  er input interva
-00007680: 6c0a 2020 2020 696e 7075 745f 696e 7465  l.    input_inte
-00007690: 7276 616c 7320 3d20 5b53 696d 706c 6549  rvals = [SimpleI
-000076a0: 6e74 6572 7661 6c28 6b6d 696e 3d30 2c20  nterval(kmin=0, 
-000076b0: 6b6d 6178 3d31 292c 2053 696d 706c 6549  kmax=1), SimpleI
-000076c0: 6e74 6572 7661 6c28 6b6d 696e 3d2d 342e  nterval(kmin=-4.
-000076d0: 302c 206b 6d61 783d 3229 5d0a 2020 2020  0, kmax=2)].    
-000076e0: 696e 7465 7276 616c 7320 3d20 6d61 6e79  intervals = many
-000076f0: 626f 6479 2e73 706c 6974 5f69 6e74 6572  body.split_inter
-00007700: 7661 6c73 2869 6e70 7574 5f69 6e74 6572  vals(input_inter
-00007710: 7661 6c73 2c20 6e75 6d62 6572 5f73 7562  vals, number_sub
-00007720: 696e 7465 7276 616c 733d 6e69 6e74 290a  intervals=nint).
-00007730: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00007740: 7461 6e63 6528 696e 7465 7276 616c 732c  tance(intervals,
-00007750: 206c 6973 7429 0a20 2020 2061 7373 6572   list).    asser
-00007760: 7420 6c65 6e28 696e 7465 7276 616c 7329  t len(intervals)
-00007770: 203d 3d20 6e69 6e74 202a 206c 656e 2869   == nint * len(i
-00007780: 6e70 7574 5f69 6e74 6572 7661 6c73 290a  nput_intervals).
-00007790: 2020 2020 6173 7365 7274 2069 6e74 6572      assert inter
-000077a0: 7661 6c73 203d 3d20 5b53 696d 706c 6549  vals == [SimpleI
-000077b0: 6e74 6572 7661 6c28 6b6d 696e 3d30 2c20  nterval(kmin=0, 
-000077c0: 6b6d 6178 3d31 292c 2053 696d 706c 6549  kmax=1), SimpleI
-000077d0: 6e74 6572 7661 6c28 6b6d 696e 3d2d 342e  nterval(kmin=-4.
-000077e0: 302c 206b 6d61 783d 3229 5d0a 0a0a 6465  0, kmax=2)]...de
-000077f0: 6620 7465 7374 5f73 706c 6974 5f69 6e74  f test_split_int
-00007800: 6572 7661 6c73 5f69 6e74 6f5f 7477 6f28  ervals_into_two(
-00007810: 5369 6d70 6c65 496e 7465 7276 616c 293a  SimpleInterval):
-00007820: 0a20 2020 206e 696e 7420 3d20 3220 2023  .    nint = 2  #
-00007830: 206e 756d 6265 7220 6f66 2072 6574 7572   number of retur
-00007840: 6e65 6420 696e 7465 7276 616c 7320 7065  ned intervals pe
-00007850: 7220 696e 7075 7420 696e 7465 7276 616c  r input interval
-00007860: 0a20 2020 2069 6e70 7574 5f69 6e74 6572  .    input_inter
-00007870: 7661 6c73 203d 205b 5369 6d70 6c65 496e  vals = [SimpleIn
-00007880: 7465 7276 616c 286b 6d69 6e3d 302c 206b  terval(kmin=0, k
-00007890: 6d61 783d 3129 2c20 5369 6d70 6c65 496e  max=1), SimpleIn
-000078a0: 7465 7276 616c 286b 6d69 6e3d 2d34 2e30  terval(kmin=-4.0
-000078b0: 2c20 6b6d 6178 3d32 295d 0a20 2020 2069  , kmax=2)].    i
-000078c0: 6e74 6572 7661 6c73 203d 206d 616e 7962  ntervals = manyb
-000078d0: 6f64 792e 7370 6c69 745f 696e 7465 7276  ody.split_interv
-000078e0: 616c 7328 696e 7075 745f 696e 7465 7276  als(input_interv
-000078f0: 616c 732c 206e 756d 6265 725f 7375 6269  als, number_subi
-00007900: 6e74 6572 7661 6c73 3d6e 696e 7429 0a20  ntervals=nint). 
-00007910: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-00007920: 616e 6365 2869 6e74 6572 7661 6c73 2c20  ance(intervals, 
-00007930: 6c69 7374 290a 2020 2020 6173 7365 7274  list).    assert
-00007940: 206c 656e 2869 6e74 6572 7661 6c73 2920   len(intervals) 
-00007950: 3d3d 206e 696e 7420 2a20 6c65 6e28 696e  == nint * len(in
-00007960: 7075 745f 696e 7465 7276 616c 7329 0a20  put_intervals). 
-00007970: 2020 2061 7373 6572 7420 696e 7465 7276     assert interv
-00007980: 616c 7320 3d3d 205b 5369 6d70 6c65 496e  als == [SimpleIn
-00007990: 7465 7276 616c 286b 6d69 6e3d 302c 206b  terval(kmin=0, k
-000079a0: 6d61 783d 302e 3529 2c20 5369 6d70 6c65  max=0.5), Simple
-000079b0: 496e 7465 7276 616c 286b 6d69 6e3d 302e  Interval(kmin=0.
-000079c0: 352c 206b 6d61 783d 3129 2c0a 2020 2020  5, kmax=1),.    
-000079d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000079e0: 2020 2020 2053 696d 706c 6549 6e74 6572       SimpleInter
-000079f0: 7661 6c28 6b6d 696e 3d2d 342e 302c 206b  val(kmin=-4.0, k
-00007a00: 6d61 783d 2d31 2e30 292c 2053 696d 706c  max=-1.0), Simpl
-00007a10: 6549 6e74 6572 7661 6c28 6b6d 696e 3d2d  eInterval(kmin=-
-00007a20: 312e 302c 206b 6d61 783d 3229 5d0a 0a0a  1.0, kmax=2)]...
-00007a30: 6465 6620 7465 7374 5f73 706c 6974 5f69  def test_split_i
-00007a40: 6e74 6572 7661 6c73 5f77 726f 6e67 5f69  ntervals_wrong_i
-00007a50: 6e70 7574 2853 696d 706c 6549 6e74 6572  nput(SimpleInter
-00007a60: 7661 6c29 3a0a 2020 2020 696e 7075 745f  val):.    input_
-00007a70: 696e 7465 7276 616c 7320 3d20 5b53 696d  intervals = [Sim
-00007a80: 706c 6549 6e74 6572 7661 6c28 6b6d 696e  pleInterval(kmin
-00007a90: 3d30 2c20 6b6d 6178 3d31 295d 0a20 2020  =0, kmax=1)].   
-00007aa0: 2072 6169 7365 7328 5661 6c75 6545 7272   raises(ValueErr
-00007ab0: 6f72 2c20 6d61 6e79 626f 6479 2e73 706c  or, manybody.spl
-00007ac0: 6974 5f69 6e74 6572 7661 6c73 2c20 696e  it_intervals, in
-00007ad0: 7075 745f 696e 7465 7276 616c 732c 206e  put_intervals, n
-00007ae0: 756d 6265 725f 7375 6269 6e74 6572 7661  umber_subinterva
-00007af0: 6c73 3d30 290a 2020 2020 7261 6973 6573  ls=0).    raises
-00007b00: 2841 7373 6572 7469 6f6e 4572 726f 722c  (AssertionError,
-00007b10: 206d 616e 7962 6f64 792e 7370 6c69 745f   manybody.split_
-00007b20: 696e 7465 7276 616c 732c 2069 6e70 7574  intervals, input
-00007b30: 5f69 6e74 6572 7661 6c73 2c20 6e75 6d62  _intervals, numb
-00007b40: 6572 5f73 7562 696e 7465 7276 616c 733d  er_subintervals=
-00007b50: 312e 290a 2020 2020 2320 696e 7465 7276  1.).    # interv
-00007b60: 616c 206e 6f74 2061 206c 6973 740a 2020  al not a list.  
-00007b70: 2020 696e 7075 745f 696e 7465 7276 616c    input_interval
-00007b80: 7320 3d20 5369 6d70 6c65 496e 7465 7276  s = SimpleInterv
-00007b90: 616c 286b 6d69 6e3d 302c 206b 6d61 783d  al(kmin=0, kmax=
-00007ba0: 3129 0a20 2020 2072 6169 7365 7328 5479  1).    raises(Ty
-00007bb0: 7065 4572 726f 722c 206d 616e 7962 6f64  peError, manybod
-00007bc0: 792e 7370 6c69 745f 696e 7465 7276 616c  y.split_interval
-00007bd0: 732c 2069 6e70 7574 5f69 6e74 6572 7661  s, input_interva
-00007be0: 6c73 2c20 6e75 6d62 6572 5f73 7562 696e  ls, number_subin
-00007bf0: 7465 7276 616c 733d 3229 0a0a 0a64 6566  tervals=2)...def
-00007c00: 2074 6573 745f 6174 7472 6962 7574 6573   test_attributes
-00007c10: 5f73 696d 696c 6172 2829 3a0a 0a20 2020  _similar():..   
-00007c20: 2023 2075 7365 2074 6865 206d 616e 7962   # use the manyb
-00007c30: 6f64 7920 696e 7465 7276 616c 2063 6c61  ody interval cla
-00007c40: 7373 2074 6f20 7465 7374 2066 6f72 2073  ss to test for s
-00007c50: 696d 696c 6172 6974 790a 2020 2020 696e  imilarity.    in
-00007c60: 7430 203d 206d 616e 7962 6f64 792e 496e  t0 = manybody.In
-00007c70: 7465 7276 616c 286c 6561 643d 302c 2062  terval(lead=0, b
-00007c80: 616e 643d 312c 206b 6d69 6e3d 302c 206b  and=1, kmin=0, k
-00007c90: 6d61 783d 312e 290a 2020 2020 696e 7431  max=1.).    int1
-00007ca0: 203d 206d 616e 7962 6f64 792e 496e 7465   = manybody.Inte
-00007cb0: 7276 616c 286c 6561 643d 312c 2062 616e  rval(lead=1, ban
-00007cc0: 643d 312c 206b 6d69 6e3d 3145 2d31 322c  d=1, kmin=1E-12,
-00007cd0: 206b 6d61 783d 312e 290a 0a20 2020 2023   kmax=1.)..    #
-00007ce0: 2063 6865 636b 2074 7970 650a 2020 2020   check type.    
-00007cf0: 7265 7320 3d20 6d61 6e79 626f 6479 2e5f  res = manybody._
-00007d00: 6174 7472 6962 7574 6573 5f73 696d 696c  attributes_simil
-00007d10: 6172 2869 6e74 302c 2069 6e74 312c 205b  ar(int0, int1, [
-00007d20: 2762 616e 6427 2c20 276b 6d69 6e27 2c20  'band', 'kmin', 
-00007d30: 276b 6d61 7827 5d29 0a20 2020 2061 7373  'kmax']).    ass
-00007d40: 6572 7420 6973 696e 7374 616e 6365 2872  ert isinstance(r
-00007d50: 6573 2c20 626f 6f6c 290a 0a20 2020 2023  es, bool)..    #
-00007d60: 2063 6f6d 7061 7265 2066 6c6f 6174 2061   compare float a
-00007d70: 7474 7269 6275 7465 730a 2020 2020 6173  ttributes.    as
-00007d80: 7365 7274 206d 616e 7962 6f64 792e 5f61  sert manybody._a
-00007d90: 7474 7269 6275 7465 735f 7369 6d69 6c61  ttributes_simila
-00007da0: 7228 696e 7430 2c20 696e 7431 2c20 5b27  r(int0, int1, ['
-00007db0: 6261 6e64 272c 2027 6b6d 696e 272c 2027  band', 'kmin', '
-00007dc0: 6b6d 6178 275d 290a 2020 2020 6173 7365  kmax']).    asse
-00007dd0: 7274 206e 6f74 206d 616e 7962 6f64 792e  rt not manybody.
-00007de0: 5f61 7474 7269 6275 7465 735f 7369 6d69  _attributes_simi
-00007df0: 6c61 7228 696e 7430 2c20 696e 7431 2c20  lar(int0, int1, 
-00007e00: 5b27 6261 6e64 272c 2027 6b6d 696e 272c  ['band', 'kmin',
-00007e10: 2027 6b6d 6178 275d 2c0a 2020 2020 2020   'kmax'],.      
-00007e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007e40: 2020 2020 2020 7274 6f6c 3d30 2c20 6174        rtol=0, at
-00007e50: 6f6c 3d31 452d 3135 290a 0a20 2020 2023  ol=1E-15)..    #
-00007e60: 2063 6f6d 7061 7265 2069 6e74 6567 6572   compare integer
-00007e70: 2061 7474 7269 6275 7465 730a 2020 2020   attributes.    
-00007e80: 6173 7365 7274 206e 6f74 206d 616e 7962  assert not manyb
-00007e90: 6f64 792e 5f61 7474 7269 6275 7465 735f  ody._attributes_
-00007ea0: 7369 6d69 6c61 7228 696e 7430 2c20 696e  similar(int0, in
-00007eb0: 7431 2c20 5b27 6c65 6164 272c 2027 6261  t1, ['lead', 'ba
-00007ec0: 6e64 272c 2027 6b6d 696e 272c 2027 6b6d  nd', 'kmin', 'km
-00007ed0: 6178 275d 290a 0a20 2020 2023 2063 6f6d  ax'])..    # com
-00007ee0: 7061 7265 206e 6f6e 6578 6973 7469 6e67  pare nonexisting
-00007ef0: 2061 7474 7269 6275 7465 730a 2020 2020   attributes.    
-00007f00: 6173 7365 7274 206d 616e 7962 6f64 792e  assert manybody.
-00007f10: 5f61 7474 7269 6275 7465 735f 7369 6d69  _attributes_simi
-00007f20: 6c61 7228 696e 7430 2c20 696e 7431 2c20  lar(int0, int1, 
-00007f30: 5b27 626c 6127 5d29 0a0a 2020 2020 2320  ['bla'])..    # 
-00007f40: 636f 6d70 6172 6520 6578 6973 7469 6e67  compare existing
-00007f50: 2061 6e64 206e 6f6e 6578 6973 7469 6e67   and nonexisting
-00007f60: 2061 7474 7269 6275 7465 730a 2020 2020   attributes.    
-00007f70: 696e 7432 203d 206d 616e 7962 6f64 792e  int2 = manybody.
-00007f80: 496e 7465 7276 616c 286c 6561 643d 312c  Interval(lead=1,
-00007f90: 2062 616e 643d 312c 206b 6d69 6e3d 3145   band=1, kmin=1E
-00007fa0: 2d31 322c 206b 6d61 783d 312e 290a 2020  -12, kmax=1.).  
-00007fb0: 2020 696e 7432 2e62 6c61 203d 2034 320a    int2.bla = 42.
-00007fc0: 2020 2020 6173 7365 7274 206e 6f74 206d      assert not m
-00007fd0: 616e 7962 6f64 792e 5f61 7474 7269 6275  anybody._attribu
-00007fe0: 7465 735f 7369 6d69 6c61 7228 696e 7430  tes_similar(int0
-00007ff0: 2c20 696e 7432 2c20 5b27 626c 6127 5d29  , int2, ['bla'])
-00008000: 0a0a 2020 2020 2320 636f 6d70 6172 6520  ..    # compare 
-00008010: 666c 6f61 7420 616e 6420 6e75 6d70 7920  float and numpy 
-00008020: 6174 7472 6962 7574 6573 0a20 2020 2069  attributes.    i
-00008030: 6e74 3320 3d20 6d61 6e79 626f 6479 2e49  nt3 = manybody.I
-00008040: 6e74 6572 7661 6c28 6c65 6164 3d30 2c20  nterval(lead=0, 
-00008050: 6261 6e64 3d31 2c20 6b6d 696e 3d6e 702e  band=1, kmin=np.
-00008060: 6172 7261 7928 5b30 2e5d 292c 206b 6d61  array([0.]), kma
-00008070: 783d 312e 290a 2020 2020 6173 7365 7274  x=1.).    assert
-00008080: 206d 616e 7962 6f64 792e 5f61 7474 7269   manybody._attri
-00008090: 6275 7465 735f 7369 6d69 6c61 7228 696e  butes_similar(in
-000080a0: 7431 2c20 696e 7433 2c20 5b27 6261 6e64  t1, int3, ['band
-000080b0: 272c 2027 6b6d 696e 272c 2027 6b6d 6178  ', 'kmin', 'kmax
-000080c0: 275d 290a 2020 2020 6173 7365 7274 206e  ']).    assert n
-000080d0: 6f74 206d 616e 7962 6f64 792e 5f61 7474  ot manybody._att
-000080e0: 7269 6275 7465 735f 7369 6d69 6c61 7228  ributes_similar(
-000080f0: 696e 7431 2c20 696e 7433 2c20 5b27 6261  int1, int3, ['ba
-00008100: 6e64 272c 2027 6b6d 696e 272c 2027 6b6d  nd', 'kmin', 'km
-00008110: 6178 275d 2c0a 2020 2020 2020 2020 2020  ax'],.          
-00008120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008130: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008140: 2020 7274 6f6c 3d30 2c20 6174 6f6c 3d31    rtol=0, atol=1
-00008150: 452d 3135 290a 0a20 2020 2023 2063 6f6d  E-15)..    # com
-00008160: 7061 7265 206e 756d 7079 2061 7474 7269  pare numpy attri
-00008170: 6275 7465 730a 2020 2020 696e 7434 203d  butes.    int4 =
-00008180: 206d 616e 7962 6f64 792e 496e 7465 7276   manybody.Interv
-00008190: 616c 286c 6561 643d 302c 2062 616e 643d  al(lead=0, band=
-000081a0: 312c 206b 6d69 6e3d 6e70 2e61 7272 6179  1, kmin=np.array
-000081b0: 285b 3145 2d31 325d 292c 206b 6d61 783d  ([1E-12]), kmax=
-000081c0: 312e 290a 2020 2020 6173 7365 7274 206d  1.).    assert m
-000081d0: 616e 7962 6f64 792e 5f61 7474 7269 6275  anybody._attribu
-000081e0: 7465 735f 7369 6d69 6c61 7228 696e 7433  tes_similar(int3
-000081f0: 2c20 696e 7434 2c20 5b27 6261 6e64 272c  , int4, ['band',
-00008200: 2027 6b6d 696e 272c 2027 6b6d 6178 275d   'kmin', 'kmax']
-00008210: 290a 2020 2020 6173 7365 7274 206e 6f74  ).    assert not
-00008220: 206d 616e 7962 6f64 792e 5f61 7474 7269   manybody._attri
-00008230: 6275 7465 735f 7369 6d69 6c61 7228 696e  butes_similar(in
-00008240: 7433 2c20 696e 7434 2c20 5b27 6261 6e64  t3, int4, ['band
-00008250: 272c 2027 6b6d 696e 272c 2027 6b6d 6178  ', 'kmin', 'kmax
-00008260: 275d 2c0a 2020 2020 2020 2020 2020 2020  '],.            
-00008270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008290: 7274 6f6c 3d30 2c20 6174 6f6c 3d31 452d  rtol=0, atol=1E-
-000082a0: 3135 290a 0a20 2020 2023 2063 6f6d 7061  15)..    # compa
-000082b0: 7265 206e 756d 7079 2061 7474 7269 6275  re numpy attribu
-000082c0: 7465 7320 7769 7468 2064 6966 6665 7265  tes with differe
-000082d0: 6e74 2073 697a 6573 0a20 2020 2069 6e74  nt sizes.    int
-000082e0: 3520 3d20 6d61 6e79 626f 6479 2e49 6e74  5 = manybody.Int
-000082f0: 6572 7661 6c28 6c65 6164 3d30 2c20 6261  erval(lead=0, ba
-00008300: 6e64 3d31 2c20 6b6d 696e 3d6e 702e 6172  nd=1, kmin=np.ar
-00008310: 7261 7928 5b30 2c20 3145 2d31 325d 292c  ray([0, 1E-12]),
-00008320: 206b 6d61 783d 312e 290a 2020 2020 6173   kmax=1.).    as
-00008330: 7365 7274 206d 616e 7962 6f64 792e 5f61  sert manybody._a
-00008340: 7474 7269 6275 7465 735f 7369 6d69 6c61  ttributes_simila
-00008350: 7228 696e 7434 2c20 696e 7435 2c20 5b27  r(int4, int5, ['
-00008360: 6261 6e64 272c 2027 6b6d 696e 272c 2027  band', 'kmin', '
-00008370: 6b6d 6178 275d 290a 0a0a 6465 6620 7465  kmax'])...def te
-00008380: 7374 5f63 6f6d 6269 6e65 5f69 6e74 6572  st_combine_inter
-00008390: 7661 6c73 2829 3a0a 0a20 2020 2069 6e74  vals():..    int
-000083a0: 3020 3d20 6d61 6e79 626f 6479 2e49 6e74  0 = manybody.Int
-000083b0: 6572 7661 6c28 6c65 6164 3d33 2c20 6261  erval(lead=3, ba
-000083c0: 6e64 3d31 2c20 6b6d 696e 3d30 2c20 6b6d  nd=1, kmin=0, km
-000083d0: 6178 3d31 2e29 0a20 2020 2069 6e74 3120  ax=1.).    int1 
-000083e0: 3d20 6d61 6e79 626f 6479 2e49 6e74 6572  = manybody.Inter
-000083f0: 7661 6c28 6c65 6164 3d35 2c20 6261 6e64  val(lead=5, band
-00008400: 3d31 2c20 6b6d 696e 3d31 452d 3132 2c20  =1, kmin=1E-12, 
-00008410: 6b6d 6178 3d31 2e29 0a20 2020 2069 6e74  kmax=1.).    int
-00008420: 3220 3d20 6d61 6e79 626f 6479 2e49 6e74  2 = manybody.Int
-00008430: 6572 7661 6c28 6c65 6164 3d36 2c20 6261  erval(lead=6, ba
-00008440: 6e64 3d31 2c20 6b6d 696e 3d31 452d 3132  nd=1, kmin=1E-12
-00008450: 2c20 6b6d 6178 3d31 2e29 0a20 2020 2069  , kmax=1.).    i
-00008460: 6e74 3320 3d20 6d61 6e79 626f 6479 2e49  nt3 = manybody.I
-00008470: 6e74 6572 7661 6c28 6c65 6164 3d37 2c20  nterval(lead=7, 
-00008480: 6261 6e64 3d31 2c20 6b6d 696e 3d30 2e31  band=1, kmin=0.1
-00008490: 2c20 6b6d 6178 3d31 2e29 0a20 2020 2069  , kmax=1.).    i
-000084a0: 6e74 3420 3d20 6d61 6e79 626f 6479 2e49  nt4 = manybody.I
-000084b0: 6e74 6572 7661 6c28 6c65 6164 3d28 312c  nterval(lead=(1,
-000084c0: 2032 292c 2062 616e 643d 312c 206b 6d69   2), band=1, kmi
-000084d0: 6e3d 302c 206b 6d61 783d 312e 290a 0a20  n=0, kmax=1.).. 
-000084e0: 2020 2023 2063 6f6d 6269 6e65 2074 776f     # combine two
-000084f0: 2069 6e74 6572 7661 6c73 0a20 2020 2063   intervals.    c
-00008500: 6f6d 6269 6e65 6420 3d20 6d61 6e79 626f  ombined = manybo
-00008510: 6479 2e63 6f6d 6269 6e65 5f69 6e74 6572  dy.combine_inter
-00008520: 7661 6c73 285b 696e 7430 2c20 696e 7431  vals([int0, int1
-00008530: 5d29 0a20 2020 2061 7373 6572 7420 6973  ]).    assert is
-00008540: 696e 7374 616e 6365 2863 6f6d 6269 6e65  instance(combine
-00008550: 642c 206c 6973 7429 0a20 2020 2061 7373  d, list).    ass
-00008560: 6572 7420 6c65 6e28 636f 6d62 696e 6564  ert len(combined
-00008570: 2920 3d3d 2031 0a20 2020 2061 7373 6572  ) == 1.    asser
-00008580: 7420 636f 6d62 696e 6564 5b30 5d2e 6c65  t combined[0].le
-00008590: 6164 203d 3d20 2833 2c20 3529 0a20 2020  ad == (3, 5).   
-000085a0: 2061 7373 6572 7420 636f 6d62 696e 6564   assert combined
-000085b0: 5b30 5d2e 6261 6e64 203d 3d20 696e 7430  [0].band == int0
-000085c0: 2e62 616e 640a 2020 2020 6173 7365 7274  .band.    assert
-000085d0: 2063 6f6d 6269 6e65 645b 305d 2e6b 6d69   combined[0].kmi
-000085e0: 6e20 3d3d 2069 6e74 302e 6b6d 696e 0a20  n == int0.kmin. 
-000085f0: 2020 2061 7373 6572 7420 636f 6d62 696e     assert combin
-00008600: 6564 5b30 5d2e 6b6d 6178 203d 3d20 696e  ed[0].kmax == in
-00008610: 7430 2e6b 6d61 780a 2020 2020 6173 7365  t0.kmax.    asse
-00008620: 7274 2069 6e74 302e 6c65 6164 203d 3d20  rt int0.lead == 
-00008630: 330a 2020 2020 6173 7365 7274 2069 6e74  3.    assert int
-00008640: 312e 6c65 6164 203d 3d20 350a 0a20 2020  1.lead == 5..   
-00008650: 2023 2064 6f20 6e6f 7420 636f 6d62 696e   # do not combin
-00008660: 6520 696e 7465 7276 616c 730a 2020 2020  e intervals.    
-00008670: 636f 6d62 696e 6564 203d 206d 616e 7962  combined = manyb
-00008680: 6f64 792e 636f 6d62 696e 655f 696e 7465  ody.combine_inte
-00008690: 7276 616c 7328 5b69 6e74 302c 2069 6e74  rvals([int0, int
-000086a0: 335d 290a 2020 2020 6173 7365 7274 2069  3]).    assert i
-000086b0: 7369 6e73 7461 6e63 6528 636f 6d62 696e  sinstance(combin
-000086c0: 6564 2c20 6c69 7374 290a 2020 2020 6173  ed, list).    as
-000086d0: 7365 7274 206c 656e 2863 6f6d 6269 6e65  sert len(combine
-000086e0: 6429 203d 3d20 320a 2020 2020 6173 7365  d) == 2.    asse
-000086f0: 7274 2063 6f6d 6269 6e65 645b 305d 2e6c  rt combined[0].l
-00008700: 6561 6420 3d3d 2033 0a20 2020 2061 7373  ead == 3.    ass
-00008710: 6572 7420 636f 6d62 696e 6564 5b31 5d2e  ert combined[1].
-00008720: 6c65 6164 203d 3d20 370a 0a20 2020 2023  lead == 7..    #
-00008730: 2063 6f6d 6269 6e65 2061 6e20 696e 7465   combine an inte
-00008740: 7276 616c 2077 6974 6820 6c65 6164 2069  rval with lead i
-00008750: 6e74 6567 6572 2061 6e64 206c 6561 6420  nteger and lead 
-00008760: 7475 706c 650a 2020 2020 636f 6d62 696e  tuple.    combin
-00008770: 6564 203d 206d 616e 7962 6f64 792e 636f  ed = manybody.co
-00008780: 6d62 696e 655f 696e 7465 7276 616c 7328  mbine_intervals(
-00008790: 5b69 6e74 302c 2069 6e74 345d 290a 2020  [int0, int4]).  
-000087a0: 2020 6173 7365 7274 206c 656e 2863 6f6d    assert len(com
-000087b0: 6269 6e65 6429 203d 3d20 310a 2020 2020  bined) == 1.    
-000087c0: 6173 7365 7274 2063 6f6d 6269 6e65 645b  assert combined[
-000087d0: 305d 2e6c 6561 6420 3d3d 2028 312c 2032  0].lead == (1, 2
-000087e0: 2c20 3329 0a0a 2020 2020 2320 636f 6d62  , 3)..    # comb
-000087f0: 696e 6520 6f6e 2061 6e20 656d 7074 7920  ine on an empty 
-00008800: 6c69 7374 0a20 2020 2063 6f6d 6269 6e65  list.    combine
-00008810: 6420 3d20 6d61 6e79 626f 6479 2e63 6f6d  d = manybody.com
-00008820: 6269 6e65 5f69 6e74 6572 7661 6c73 285b  bine_intervals([
-00008830: 5d29 0a20 2020 2061 7373 6572 7420 6973  ]).    assert is
-00008840: 696e 7374 616e 6365 2863 6f6d 6269 6e65  instance(combine
-00008850: 642c 206c 6973 7429 0a20 2020 2061 7373  d, list).    ass
-00008860: 6572 7420 6c65 6e28 636f 6d62 696e 6564  ert len(combined
-00008870: 2920 3d3d 2030 0a0a 2020 2020 2320 636f  ) == 0..    # co
-00008880: 6d62 696e 6520 6f6e 2061 206c 6973 7420  mbine on a list 
-00008890: 7769 7468 206f 6e6c 7920 6f6e 6520 696e  with only one in
-000088a0: 7465 7276 616c 0a20 2020 2063 6f6d 6269  terval.    combi
-000088b0: 6e65 6420 3d20 6d61 6e79 626f 6479 2e63  ned = manybody.c
-000088c0: 6f6d 6269 6e65 5f69 6e74 6572 7661 6c73  ombine_intervals
-000088d0: 285b 696e 7430 5d29 0a20 2020 2061 7373  ([int0]).    ass
-000088e0: 6572 7420 6973 696e 7374 616e 6365 2863  ert isinstance(c
-000088f0: 6f6d 6269 6e65 642c 206c 6973 7429 0a20  ombined, list). 
-00008900: 2020 2061 7373 6572 7420 6c65 6e28 636f     assert len(co
-00008910: 6d62 696e 6564 2920 3d3d 2031 0a20 2020  mbined) == 1.   
-00008920: 2061 7373 6572 7420 636f 6d62 696e 6564   assert combined
-00008930: 5b30 5d2e 6c65 6164 203d 3d20 330a 0a20  [0].lead == 3.. 
-00008940: 2020 2023 2063 6f6d 6269 6e65 2074 6872     # combine thr
-00008950: 6565 2069 6e74 6572 7661 6c73 0a20 2020  ee intervals.   
-00008960: 2063 6f6d 6269 6e65 6420 3d20 6d61 6e79   combined = many
-00008970: 626f 6479 2e63 6f6d 6269 6e65 5f69 6e74  body.combine_int
-00008980: 6572 7661 6c73 285b 696e 7430 2c20 696e  ervals([int0, in
-00008990: 7431 2c20 696e 7432 5d29 0a20 2020 2061  t1, int2]).    a
-000089a0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
-000089b0: 2863 6f6d 6269 6e65 642c 206c 6973 7429  (combined, list)
-000089c0: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
-000089d0: 636f 6d62 696e 6564 2920 3d3d 2031 0a20  combined) == 1. 
-000089e0: 2020 2061 7373 6572 7420 636f 6d62 696e     assert combin
-000089f0: 6564 5b30 5d2e 6c65 6164 203d 3d20 2833  ed[0].lead == (3
-00008a00: 2c20 352c 2036 290a 0a20 2020 2023 2063  , 5, 6)..    # c
-00008a10: 6f6d 6269 6e65 2074 776f 206f 7574 206f  ombine two out o
-00008a20: 6620 7468 7265 6520 696e 7465 7276 616c  f three interval
-00008a30: 730a 2020 2020 636f 6d62 696e 6564 203d  s.    combined =
-00008a40: 206d 616e 7962 6f64 792e 636f 6d62 696e   manybody.combin
-00008a50: 655f 696e 7465 7276 616c 7328 5b69 6e74  e_intervals([int
-00008a60: 302c 2069 6e74 312c 2069 6e74 335d 290a  0, int1, int3]).
-00008a70: 2020 2020 6173 7365 7274 206c 656e 2863      assert len(c
-00008a80: 6f6d 6269 6e65 6429 203d 3d20 320a 2020  ombined) == 2.  
-00008a90: 2020 6173 7365 7274 2063 6f6d 6269 6e65    assert combine
-00008aa0: 645b 305d 2e6c 6561 6420 3d3d 2028 332c  d[0].lead == (3,
-00008ab0: 2035 290a 2020 2020 6173 7365 7274 2063   5).    assert c
-00008ac0: 6f6d 6269 6e65 645b 315d 2e6c 6561 6420  ombined[1].lead 
-00008ad0: 3d3d 2037 0a0a 2020 2020 636f 6d62 696e  == 7..    combin
-00008ae0: 6564 203d 206d 616e 7962 6f64 792e 636f  ed = manybody.co
-00008af0: 6d62 696e 655f 696e 7465 7276 616c 7328  mbine_intervals(
-00008b00: 5b69 6e74 332c 2069 6e74 312c 2069 6e74  [int3, int1, int
-00008b10: 305d 290a 2020 2020 6173 7365 7274 206c  0]).    assert l
-00008b20: 656e 2863 6f6d 6269 6e65 6429 203d 3d20  en(combined) == 
-00008b30: 320a 2020 2020 6173 7365 7274 2063 6f6d  2.    assert com
-00008b40: 6269 6e65 645b 305d 2e6c 6561 6420 3d3d  bined[0].lead ==
-00008b50: 2037 0a20 2020 2061 7373 6572 7420 636f   7.    assert co
-00008b60: 6d62 696e 6564 5b31 5d2e 6c65 6164 203d  mbined[1].lead =
-00008b70: 3d20 2833 2c20 3529 0a0a 2020 2020 636f  = (3, 5)..    co
-00008b80: 6d62 696e 6564 203d 206d 616e 7962 6f64  mbined = manybod
-00008b90: 792e 636f 6d62 696e 655f 696e 7465 7276  y.combine_interv
-00008ba0: 616c 7328 5b69 6e74 312c 2069 6e74 332c  als([int1, int3,
-00008bb0: 2069 6e74 305d 290a 2020 2020 6173 7365   int0]).    asse
-00008bc0: 7274 206c 656e 2863 6f6d 6269 6e65 6429  rt len(combined)
-00008bd0: 203d 3d20 320a 2020 2020 6173 7365 7274   == 2.    assert
-00008be0: 2063 6f6d 6269 6e65 645b 305d 2e6c 6561   combined[0].lea
-00008bf0: 6420 3d3d 2028 332c 2035 290a 2020 2020  d == (3, 5).    
-00008c00: 6173 7365 7274 2063 6f6d 6269 6e65 645b  assert combined[
-00008c10: 315d 2e6c 6561 6420 3d3d 2037 0a0a 2020  1].lead == 7..  
-00008c20: 2020 2320 696e 7075 7420 6c69 7374 2068    # input list h
-00008c30: 6173 2073 6f6d 6520 656c 656d 656e 7473  as some elements
-00008c40: 2077 6974 686f 7574 206c 6561 6420 6174   without lead at
-00008c50: 7472 6962 7574 650a 2020 2020 2320 6966  tribute.    # if
-00008c60: 2062 6c61 2069 7320 7468 6520 6c61 7374   bla is the last
-00008c70: 2061 7267 7565 6d65 6e74 2c20 6e6f 7468   arguement, noth
-00008c80: 696e 6720 7769 6c6c 2062 6520 636f 6d62  ing will be comb
-00008c90: 696e 6564 0a20 2020 2077 6974 6820 7079  ined.    with py
-00008ca0: 7465 7374 2e72 6169 7365 7328 4174 7472  test.raises(Attr
-00008cb0: 6962 7574 6545 7272 6f72 2920 6173 2065  ibuteError) as e
-00008cc0: 7863 3a0a 2020 2020 2020 2020 6d61 6e79  xc:.        many
-00008cd0: 626f 6479 2e63 6f6d 6269 6e65 5f69 6e74  body.combine_int
-00008ce0: 6572 7661 6c73 285b 2762 6c61 272c 2069  ervals(['bla', i
-00008cf0: 6e74 305d 290a 2020 2020 6173 7365 7274  nt0]).    assert
-00008d00: 2027 6174 7472 6962 7574 6520 226c 6561   'attribute "lea
-00008d10: 6422 206d 6973 7369 6e67 2069 6e20 696e  d" missing in in
-00008d20: 7465 7276 616c 2720 696e 2073 7472 2865  terval' in str(e
-00008d30: 7863 2e76 616c 7565 290a 0a20 2020 2077  xc.value)..    w
-00008d40: 6974 6820 7079 7465 7374 2e72 6169 7365  ith pytest.raise
-00008d50: 7328 4174 7472 6962 7574 6545 7272 6f72  s(AttributeError
-00008d60: 2920 6173 2065 7863 3a0a 2020 2020 2020  ) as exc:.      
-00008d70: 2020 6d61 6e79 626f 6479 2e63 6f6d 6269    manybody.combi
-00008d80: 6e65 5f69 6e74 6572 7661 6c73 285b 696e  ne_intervals([in
-00008d90: 7430 2c20 2762 6c61 272c 2069 6e74 315d  t0, 'bla', int1]
-00008da0: 290a 2020 2020 6173 7365 7274 2027 6174  ).    assert 'at
-00008db0: 7472 6962 7574 6520 226c 6561 6422 206d  tribute "lead" m
-00008dc0: 6973 7369 6e67 2069 6e20 696e 7465 7276  issing in interv
-00008dd0: 616c 2720 696e 2073 7472 2865 7863 2e76  al' in str(exc.v
-00008de0: 616c 7565 290a 0a0a 6465 6620 7465 7374  alue)...def test
-00008df0: 5f63 616c 635f 6d6f 6465 735f 616e 645f  _calc_modes_and_
-00008e00: 7765 6967 6874 7328 7477 6f5f 6261 6e64  weights(two_band
-00008e10: 5f73 7065 6374 7275 6d2c 2071 7561 6472  _spectrum, quadr
-00008e20: 6174 7572 655f 696e 7465 7276 616c 293a  ature_interval):
-00008e30: 0a0a 2020 2020 2320 6368 6563 6b20 616c  ..    # check al
-00008e40: 6c20 7479 7065 7320 6f66 2074 6865 2072  l types of the r
-00008e50: 6574 7572 6e65 6420 656c 656d 656e 7473  eturned elements
-00008e60: 0a20 2020 2064 6566 2064 6973 7472 6962  .    def distrib
-00008e70: 7574 696f 6e28 656e 6572 6779 293a 0a20  ution(energy):. 
-00008e80: 2020 2020 2020 2072 6574 7572 6e20 6e70         return np
-00008e90: 2e6f 6e65 7328 6c65 6e28 656e 6572 6779  .ones(len(energy
-00008ea0: 2929 0a0a 2020 2020 7175 6164 7261 7475  ))..    quadratu
-00008eb0: 7265 5f69 6e74 6572 7661 6c2e 7175 6164  re_interval.quad
-00008ec0: 7261 7475 7265 203d 2027 6761 7573 736c  rature = 'gaussl
-00008ed0: 6567 656e 6472 6527 0a0a 2020 2020 746d  egendre'..    tm
-00008ee0: 7020 3d20 6d61 6e79 626f 6479 2e5f 6361  p = manybody._ca
-00008ef0: 6c63 5f6d 6f64 6573 5f61 6e64 5f77 6569  lc_modes_and_wei
-00008f00: 6768 7473 2871 7561 6472 6174 7572 655f  ghts(quadrature_
-00008f10: 696e 7465 7276 616c 2c20 6469 7374 7269  interval, distri
-00008f20: 6275 7469 6f6e 2c20 7477 6f5f 6261 6e64  bution, two_band
-00008f30: 5f73 7065 6374 7275 6d29 0a20 2020 206d  _spectrum).    m
-00008f40: 6f64 6573 2c20 656e 6572 6769 6573 2c20  odes, energies, 
-00008f50: 6d6f 6d65 6e74 612c 2077 6569 6768 7473  momenta, weights
-00008f60: 2c20 6d61 7468 5f77 6569 6768 7473 2c20  , math_weights, 
-00008f70: 7068 7973 5f77 6569 6768 7473 203d 2074  phys_weights = t
-00008f80: 6d70 0a0a 2020 2020 6f72 6465 7220 3d20  mp..    order = 
-00008f90: 7175 6164 7261 7475 7265 5f69 6e74 6572  quadrature_inter
-00008fa0: 7661 6c2e 6f72 6465 720a 0a20 2020 2023  val.order..    #
-00008fb0: 2074 6573 7420 7368 6170 6573 206f 6620   test shapes of 
-00008fc0: 7468 6520 7265 7475 726e 2065 6c65 6d65  the return eleme
-00008fd0: 6e74 730a 0a20 2020 2061 7373 6572 7420  nts..    assert 
-00008fe0: 6973 696e 7374 616e 6365 286d 6f64 6573  isinstance(modes
-00008ff0: 2c20 6e70 2e6e 6461 7272 6179 290a 2020  , np.ndarray).  
-00009000: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00009010: 6e63 6528 656e 6572 6769 6573 2c20 6e70  nce(energies, np
-00009020: 2e6e 6461 7272 6179 290a 2020 2020 6173  .ndarray).    as
-00009030: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-00009040: 6d6f 6d65 6e74 612c 206e 702e 6e64 6172  momenta, np.ndar
-00009050: 7261 7929 0a20 2020 2061 7373 6572 7420  ray).    assert 
-00009060: 6973 696e 7374 616e 6365 2877 6569 6768  isinstance(weigh
-00009070: 7473 2c20 6e70 2e6e 6461 7272 6179 290a  ts, np.ndarray).
-00009080: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-00009090: 7461 6e63 6528 6d61 7468 5f77 6569 6768  tance(math_weigh
-000090a0: 7473 2c20 6e70 2e6e 6461 7272 6179 290a  ts, np.ndarray).
-000090b0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-000090c0: 7461 6e63 6528 7068 7973 5f77 6569 6768  tance(phys_weigh
-000090d0: 7473 2c20 6e70 2e6e 6461 7272 6179 290a  ts, np.ndarray).
-000090e0: 0a20 2020 2061 7373 6572 7420 6d6f 6465  .    assert mode
-000090f0: 732e 7368 6170 6520 3d3d 2028 6f72 6465  s.shape == (orde
-00009100: 722c 290a 2020 2020 6173 7365 7274 2065  r,).    assert e
-00009110: 6e65 7267 6965 732e 7368 6170 6520 3d3d  nergies.shape ==
-00009120: 2028 6f72 6465 722c 290a 2020 2020 6173   (order,).    as
-00009130: 7365 7274 206d 6f6d 656e 7461 2e73 6861  sert momenta.sha
-00009140: 7065 203d 3d20 286f 7264 6572 2c29 0a20  pe == (order,). 
-00009150: 2020 2061 7373 6572 7420 7068 7973 5f77     assert phys_w
-00009160: 6569 6768 7473 2e73 6861 7065 203d 3d20  eights.shape == 
-00009170: 286f 7264 6572 2c29 0a0a 2020 2020 6173  (order,)..    as
-00009180: 7365 7274 2077 6569 6768 7473 2e73 6861  sert weights.sha
-00009190: 7065 203d 3d20 286f 7264 6572 2c29 0a20  pe == (order,). 
-000091a0: 2020 2061 7373 6572 7420 6d61 7468 5f77     assert math_w
-000091b0: 6569 6768 7473 2e73 6861 7065 203d 3d20  eights.shape == 
-000091c0: 286f 7264 6572 2c29 0a0a 2020 2020 7175  (order,)..    qu
-000091d0: 6164 7261 7475 7265 5f69 6e74 6572 7661  adrature_interva
-000091e0: 6c2e 7175 6164 7261 7475 7265 203d 2027  l.quadrature = '
-000091f0: 6b72 6f6e 726f 6427 0a0a 2020 2020 746d  kronrod'..    tm
-00009200: 7020 3d20 6d61 6e79 626f 6479 2e5f 6361  p = manybody._ca
-00009210: 6c63 5f6d 6f64 6573 5f61 6e64 5f77 6569  lc_modes_and_wei
-00009220: 6768 7473 2871 7561 6472 6174 7572 655f  ghts(quadrature_
-00009230: 696e 7465 7276 616c 2c20 6469 7374 7269  interval, distri
-00009240: 6275 7469 6f6e 2c20 7477 6f5f 6261 6e64  bution, two_band
-00009250: 5f73 7065 6374 7275 6d29 0a20 2020 206d  _spectrum).    m
-00009260: 6f64 6573 2c20 656e 6572 6769 6573 2c20  odes, energies, 
-00009270: 6d6f 6d65 6e74 612c 2077 6569 6768 7473  momenta, weights
-00009280: 2c20 6d61 7468 5f77 6569 6768 7473 2c20  , math_weights, 
-00009290: 7068 7973 5f77 6569 6768 7473 203d 2074  phys_weights = t
-000092a0: 6d70 0a0a 2020 2020 2320 7465 7374 2073  mp..    # test s
-000092b0: 6861 7065 7320 6f66 2074 6865 2072 6574  hapes of the ret
-000092c0: 7572 6e20 656c 656d 656e 7473 0a0a 2020  urn elements..  
-000092d0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-000092e0: 6e63 6528 6d6f 6465 732c 206e 702e 6e64  nce(modes, np.nd
-000092f0: 6172 7261 7929 0a20 2020 2061 7373 6572  array).    asser
-00009300: 7420 6973 696e 7374 616e 6365 2865 6e65  t isinstance(ene
-00009310: 7267 6965 732c 206e 702e 6e64 6172 7261  rgies, np.ndarra
-00009320: 7929 0a20 2020 2061 7373 6572 7420 6973  y).    assert is
-00009330: 696e 7374 616e 6365 286d 6f6d 656e 7461  instance(momenta
-00009340: 2c20 6e70 2e6e 6461 7272 6179 290a 2020  , np.ndarray).  
-00009350: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-00009360: 6e63 6528 7765 6967 6874 732c 206e 702e  nce(weights, np.
-00009370: 6e64 6172 7261 7929 0a20 2020 2061 7373  ndarray).    ass
-00009380: 6572 7420 6973 696e 7374 616e 6365 286d  ert isinstance(m
-00009390: 6174 685f 7765 6967 6874 732c 206e 702e  ath_weights, np.
-000093a0: 6e64 6172 7261 7929 0a20 2020 2061 7373  ndarray).    ass
-000093b0: 6572 7420 6973 696e 7374 616e 6365 2870  ert isinstance(p
-000093c0: 6879 735f 7765 6967 6874 732c 206e 702e  hys_weights, np.
-000093d0: 6e64 6172 7261 7929 0a0a 2020 2020 6173  ndarray)..    as
-000093e0: 7365 7274 206d 6f64 6573 2e73 6861 7065  sert modes.shape
-000093f0: 203d 3d20 2832 202a 206f 7264 6572 202b   == (2 * order +
-00009400: 2031 2c29 0a20 2020 2061 7373 6572 7420   1,).    assert 
-00009410: 656e 6572 6769 6573 2e73 6861 7065 203d  energies.shape =
-00009420: 3d20 2832 202a 206f 7264 6572 202b 2031  = (2 * order + 1
-00009430: 2c29 0a20 2020 2061 7373 6572 7420 6d6f  ,).    assert mo
-00009440: 6d65 6e74 612e 7368 6170 6520 3d3d 2028  menta.shape == (
-00009450: 3220 2a20 6f72 6465 7220 2b20 312c 290a  2 * order + 1,).
-00009460: 2020 2020 6173 7365 7274 2070 6879 735f      assert phys_
-00009470: 7765 6967 6874 732e 7368 6170 6520 3d3d  weights.shape ==
-00009480: 2028 3220 2a20 6f72 6465 7220 2b20 312c   (2 * order + 1,
-00009490: 290a 0a20 2020 2061 7373 6572 7420 7765  )..    assert we
-000094a0: 6967 6874 732e 7368 6170 6520 3d3d 2028  ights.shape == (
-000094b0: 3220 2a20 6f72 6465 7220 2b20 312c 2032  2 * order + 1, 2
-000094c0: 290a 2020 2020 6173 7365 7274 206d 6174  ).    assert mat
-000094d0: 685f 7765 6967 6874 732e 7368 6170 6520  h_weights.shape 
-000094e0: 3d3d 2028 3220 2a20 6f72 6465 7220 2b20  == (2 * order + 
-000094f0: 312c 2032 290a 0a20 2020 2023 206e 6f20  1, 2)..    # no 
-00009500: 7665 6374 6f72 2066 756e 6374 696f 6e20  vector function 
-00009510: 6469 7374 7269 6275 7469 6f6e 0a0a 2020  distribution..  
-00009520: 2020 6465 6620 6665 726d 695f 6469 7261    def fermi_dira
-00009530: 635f 6469 7374 7269 6275 7469 6f6e 2865  c_distribution(e
-00009540: 6e65 7267 7929 3a0a 2020 2020 2020 2020  nergy):.        
-00009550: 2222 2246 6572 6d69 2064 6972 6163 7420  """Fermi diract 
-00009560: 6469 7374 7269 6275 7469 6f6e 2066 756e  distribution fun
-00009570: 6374 696f 6e22 2222 0a20 2020 2020 2020  ction""".       
-00009580: 2072 6574 7572 6e20 312e 202f 2028 3120   return 1. / (1 
-00009590: 2b20 6578 7028 2865 6e65 7267 7920 2d20  + exp((energy - 
-000095a0: 302e 3529 202f 2030 2e31 2929 0a20 2020  0.5) / 0.1)).   
-000095b0: 2064 6973 7472 6962 7574 696f 6e20 3d20   distribution = 
-000095c0: 6665 726d 695f 6469 7261 635f 6469 7374  fermi_dirac_dist
-000095d0: 7269 6275 7469 6f6e 0a20 2020 2074 6d70  ribution.    tmp
-000095e0: 203d 206d 616e 7962 6f64 792e 5f63 616c   = manybody._cal
-000095f0: 635f 6d6f 6465 735f 616e 645f 7765 6967  c_modes_and_weig
-00009600: 6874 7328 7175 6164 7261 7475 7265 5f69  hts(quadrature_i
-00009610: 6e74 6572 7661 6c2c 2064 6973 7472 6962  nterval, distrib
-00009620: 7574 696f 6e2c 2074 776f 5f62 616e 645f  ution, two_band_
-00009630: 7370 6563 7472 756d 290a 0a0a 406d 6f64  spectrum)...@mod
-00009640: 656c 5f74 6173 6b73 2829 0a64 6566 2074  el_tasks().def t
-00009650: 6573 745f 6361 6c63 5f74 6173 6b73 5f76  est_calc_tasks_v
-00009660: 616c 7565 7328 7477 6f5f 6261 6e64 5f73  alues(two_band_s
-00009670: 7065 6374 7275 6d2c 2075 6e69 666f 726d  pectrum, uniform
-00009680: 5f6f 6363 7570 6174 696f 6e2c 2065 6e65  _occupation, ene
-00009690: 7267 795f 6675 6e63 2c0a 2020 2020 2020  rgy_func,.      
-000096a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096b0: 2020 2020 2076 656c 6f63 6974 795f 6675       velocity_fu
-000096c0: 6e63 2c20 6469 7374 7269 6275 7469 6f6e  nc, distribution
-000096d0: 5f66 756e 632c 0a20 2020 2020 2020 2020  _func,.         
-000096e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000096f0: 2020 696e 7465 7276 616c 2c20 7765 6967    interval, weig
-00009700: 6874 732c 2078 2c20 785f 7479 7065 293a  hts, x, x_type):
-00009710: 0a0a 2020 2020 756e 6966 6f72 6d5f 6f63  ..    uniform_oc
-00009720: 6375 7061 7469 6f6e 2e64 6973 7472 6962  cupation.distrib
-00009730: 7574 696f 6e20 3d20 6469 7374 7269 6275  ution = distribu
-00009740: 7469 6f6e 5f66 756e 630a 0a20 2020 2074  tion_func..    t
-00009750: 6173 6b73 203d 206d 616e 7962 6f64 792e  asks = manybody.
-00009760: 6361 6c63 5f74 6173 6b73 2869 6e74 6572  calc_tasks(inter
-00009770: 7661 6c2c 2074 776f 5f62 616e 645f 7370  val, two_band_sp
-00009780: 6563 7472 756d 2c20 756e 6966 6f72 6d5f  ectrum, uniform_
-00009790: 6f63 6375 7061 7469 6f6e 290a 0a20 2020  occupation)..   
-000097a0: 2069 6620 785f 7479 7065 203d 3d20 276d   if x_type == 'm
-000097b0: 6f6d 656e 7475 6d27 3a0a 2020 2020 2020  omentum':.      
-000097c0: 2020 666f 7220 692c 206b 2069 6e20 656e    for i, k in en
-000097d0: 756d 6572 6174 6528 7829 3a0a 2020 2020  umerate(x):.    
-000097e0: 2020 2020 2020 2020 656e 6572 6779 203d          energy =
-000097f0: 2065 6e65 7267 795f 6675 6e63 286b 290a   energy_func(k).
-00009800: 2020 2020 2020 2020 2020 2020 7765 6967              weig
-00009810: 6874 203d 2064 6973 7472 6962 7574 696f  ht = distributio
-00009820: 6e5f 6675 6e63 2865 6e65 7267 7929 202a  n_func(energy) *
-00009830: 2076 656c 6f63 6974 795f 6675 6e63 286b   velocity_func(k
-00009840: 2920 2a20 7765 6967 6874 735b 695d 202f  ) * weights[i] /
-00009850: 2028 3220 2a20 6e70 2e70 6929 0a20 2020   (2 * np.pi).   
-00009860: 2020 2020 2020 2020 2061 7373 6572 745f           assert_
-00009870: 616c 6d6f 7374 5f65 7175 616c 2865 6e65  almost_equal(ene
-00009880: 7267 792c 2074 6173 6b73 5b69 5d2e 656e  rgy, tasks[i].en
-00009890: 6572 6779 290a 2020 2020 2020 2020 2020  ergy).          
-000098a0: 2020 6173 7365 7274 5f61 6c6d 6f73 745f    assert_almost_
-000098b0: 6571 7561 6c28 7765 6967 6874 2c20 7461  equal(weight, ta
-000098c0: 736b 735b 695d 2e77 6569 6768 7429 0a20  sks[i].weight). 
-000098d0: 2020 2065 6c69 6620 785f 7479 7065 203d     elif x_type =
-000098e0: 3d20 2765 6e65 7267 7927 3a0a 2020 2020  = 'energy':.    
-000098f0: 2020 2020 666f 7220 692c 2065 6e65 7267      for i, energ
-00009900: 7920 696e 2065 6e75 6d65 7261 7465 2878  y in enumerate(x
-00009910: 293a 0a20 2020 2020 2020 2020 2020 2077  ):.            w
-00009920: 6569 6768 7420 3d20 6469 7374 7269 6275  eight = distribu
-00009930: 7469 6f6e 5f66 756e 6328 656e 6572 6779  tion_func(energy
-00009940: 2920 2a20 7765 6967 6874 735b 695d 202f  ) * weights[i] /
-00009950: 2028 3220 2a20 6e70 2e70 6929 0a20 2020   (2 * np.pi).   
-00009960: 2020 2020 2020 2020 2061 7373 6572 745f           assert_
-00009970: 616c 6d6f 7374 5f65 7175 616c 2865 6e65  almost_equal(ene
-00009980: 7267 792c 2074 6173 6b73 5b69 5d2e 656e  rgy, tasks[i].en
-00009990: 6572 6779 290a 2020 2020 2020 2020 2020  ergy).          
-000099a0: 2020 6173 7365 7274 5f61 6c6d 6f73 745f    assert_almost_
-000099b0: 6571 7561 6c28 7765 6967 6874 2c20 7461  equal(weight, ta
-000099c0: 736b 735b 695d 2e77 6569 6768 7429 0a20  sks[i].weight). 
-000099d0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000099e0: 2072 6169 7365 204e 6f74 496d 706c 656d   raise NotImplem
-000099f0: 656e 7465 6445 7272 6f72 2827 7479 7065  entedError('type
-00009a00: 3d7b 7d20 756e 6b6e 6f77 6e27 2e66 6f72  ={} unknown'.for
-00009a10: 6d61 7428 785f 7479 7065 2929 0a0a 0a64  mat(x_type))...d
-00009a20: 6566 2074 6573 745f 6361 6c63 5f74 6173  ef test_calc_tas
-00009a30: 6b73 5f64 6566 6175 6c74 2874 776f 5f62  ks_default(two_b
-00009a40: 616e 645f 7370 6563 7472 756d 2c20 756e  and_spectrum, un
-00009a50: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-00009a60: 2c20 7175 6164 7261 7475 7265 5f69 6e74  , quadrature_int
-00009a70: 6572 7661 6c29 3a0a 0a20 2020 2023 2063  erval):..    # c
-00009a80: 6865 636b 2061 6c6c 2074 7970 6573 206f  heck all types o
-00009a90: 6620 7468 6520 7265 7475 726e 6564 2065  f the returned e
-00009aa0: 6c65 6d65 6e74 730a 2020 2020 7461 736b  lements.    task
-00009ab0: 7320 3d20 6d61 6e79 626f 6479 2e63 616c  s = manybody.cal
-00009ac0: 635f 7461 736b 7328 7175 6164 7261 7475  c_tasks(quadratu
-00009ad0: 7265 5f69 6e74 6572 7661 6c2c 2074 776f  re_interval, two
-00009ae0: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
-00009af0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-00009b00: 6f6e 290a 0a20 2020 2061 7373 6572 7420  on)..    assert 
-00009b10: 6973 696e 7374 616e 6365 2874 6173 6b73  isinstance(tasks
-00009b20: 2c20 6469 6374 290a 2020 2020 6173 7365  , dict).    asse
-00009b30: 7274 206c 656e 2874 6173 6b73 2920 3d3d  rt len(tasks) ==
-00009b40: 2071 7561 6472 6174 7572 655f 696e 7465   quadrature_inte
-00009b50: 7276 616c 2e6f 7264 6572 202a 2032 202b  rval.order * 2 +
-00009b60: 2031 0a20 2020 2066 6f72 2069 2c20 286b   1.    for i, (k
-00009b70: 6579 2c20 7661 6c75 6529 2069 6e20 656e  ey, value) in en
-00009b80: 756d 6572 6174 6528 7461 736b 732e 6974  umerate(tasks.it
-00009b90: 656d 7328 2929 3a0a 0a20 2020 2020 2020  ems()):..       
-00009ba0: 2061 7373 6572 7420 6b65 7920 3d3d 2069   assert key == i
-00009bb0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-00009bc0: 6973 696e 7374 616e 6365 2876 616c 7565  isinstance(value
-00009bd0: 2e6c 6561 642c 2069 6e74 290a 2020 2020  .lead, int).    
-00009be0: 2020 2020 2320 6173 7365 7274 2069 7369      # assert isi
-00009bf0: 6e73 7461 6e63 6528 7661 6c75 652e 6d6f  nstance(value.mo
-00009c00: 6465 2c20 696e 7429 2023 2073 6f6d 6520  de, int) # some 
-00009c10: 6e75 6d70 7920 6e75 6d62 6572 2c20 544f  numpy number, TO
-00009c20: 444f 0a20 2020 2020 2020 2061 7373 6572  DO.        asser
-00009c30: 7420 6973 696e 7374 616e 6365 2876 616c  t isinstance(val
-00009c40: 7565 2e65 6e65 7267 792c 2066 6c6f 6174  ue.energy, float
-00009c50: 290a 2020 2020 2020 2020 2320 6173 7365  ).        # asse
-00009c60: 7274 2069 7369 6e73 7461 6e63 6528 7661  rt isinstance(va
-00009c70: 6c75 652e 7765 6967 6874 2c20 666c 6f61  lue.weight, floa
-00009c80: 7429 2023 2066 6f72 2067 6175 7373 6c65  t) # for gaussle
-00009c90: 6765 6e64 7265 0a20 2020 2020 2020 2023  gendre.        #
-00009ca0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00009cb0: 6365 2876 616c 7565 2e77 6569 6768 742c  ce(value.weight,
-00009cc0: 206e 702e 6e64 6172 7261 7929 2023 2066   np.ndarray) # f
-00009cd0: 6f72 206b 726f 6e72 6f64 0a20 2020 2020  or kronrod.     
-00009ce0: 2020 2023 2054 4f44 4f2c 206d 616b 6520     # TODO, make 
-00009cf0: 7765 6967 6874 2074 7970 6520 7369 6d69  weight type simi
-00009d00: 6c61 720a 0a0a 6465 6620 7465 7374 5f63  lar...def test_c
-00009d10: 616c 635f 7461 736b 735f 7769 7468 5f66  alc_tasks_with_f
-00009d20: 6c61 745f 6261 6e64 2866 6c61 745f 6261  lat_band(flat_ba
-00009d30: 6e64 5f73 7065 6374 7275 6d2c 2075 6e69  nd_spectrum, uni
-00009d40: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
-00009d50: 3a0a 0a20 2020 2023 2074 6869 7320 6973  :..    # this is
-00009d60: 2074 6865 2069 6e74 6572 7661 6c20 7769   the interval wi
-00009d70: 7468 2074 6865 2066 6c61 7420 6261 6e64  th the flat band
-00009d80: 2028 7665 6c6f 6369 7479 207a 6572 6f29   (velocity zero)
-00009d90: 0a20 2020 2069 6e74 6572 7661 6c20 3d20  .    interval = 
-00009da0: 6d61 6e79 626f 6479 2e49 6e74 6572 7661  manybody.Interva
-00009db0: 6c28 6c65 6164 3d30 2c20 6261 6e64 3d31  l(lead=0, band=1
-00009dc0: 2c20 6b6d 696e 3d2d 6e70 2e70 692c 206b  , kmin=-np.pi, k
-00009dd0: 6d61 783d 6e70 2e70 6929 0a0a 2020 2020  max=np.pi)..    
-00009de0: 2320 6368 6563 6b20 7468 6174 206e 6f20  # check that no 
-00009df0: 7461 736b 7320 6172 6520 6361 6c63 756c  tasks are calcul
-00009e00: 6174 6564 2061 7320 7765 6967 6874 7320  ated as weights 
-00009e10: 6172 6520 7a65 726f 0a20 2020 2074 6173  are zero.    tas
-00009e20: 6b73 203d 206d 616e 7962 6f64 792e 6361  ks = manybody.ca
-00009e30: 6c63 5f74 6173 6b73 2869 6e74 6572 7661  lc_tasks(interva
-00009e40: 6c2c 2066 6c61 745f 6261 6e64 5f73 7065  l, flat_band_spe
-00009e50: 6374 7275 6d2c 2075 6e69 666f 726d 5f6f  ctrum, uniform_o
-00009e60: 6363 7570 6174 696f 6e29 0a0a 2020 2020  ccupation)..    
-00009e70: 6173 7365 7274 206c 656e 2874 6173 6b73  assert len(tasks
-00009e80: 2920 3d3d 2030 0a0a 2020 2020 2320 6368  ) == 0..    # ch
-00009e90: 6563 6b20 7468 6174 2077 6520 6361 6e20  eck that we can 
-00009ea0: 7475 6e65 2074 6865 2074 6f6c 6572 616e  tune the toleran
-00009eb0: 6365 2074 6f20 6765 7420 616c 6c20 7461  ce to get all ta
-00009ec0: 736b 7320 6167 6169 6e0a 2020 2020 7461  sks again.    ta
-00009ed0: 736b 7320 3d20 6d61 6e79 626f 6479 2e63  sks = manybody.c
-00009ee0: 616c 635f 7461 736b 7328 696e 7465 7276  alc_tasks(interv
-00009ef0: 616c 2c20 666c 6174 5f62 616e 645f 7370  al, flat_band_sp
-00009f00: 6563 7472 756d 2c20 756e 6966 6f72 6d5f  ectrum, uniform_
-00009f10: 6f63 6375 7061 7469 6f6e 2c20 746f 6c3d  occupation, tol=
-00009f20: 3145 2d33 3029 0a0a 2020 2020 6173 7365  1E-30)..    asse
-00009f30: 7274 206c 656e 2874 6173 6b73 2920 3d3d  rt len(tasks) ==
-00009f40: 2032 202a 2069 6e74 6572 7661 6c2e 6f72   2 * interval.or
-00009f50: 6465 7220 2b20 310a 0a0a 6465 6620 7465  der + 1...def te
-00009f60: 7374 5f63 616c 635f 7461 736b 735f 6b65  st_calc_tasks_ke
-00009f70: 7973 2874 776f 5f62 616e 645f 7370 6563  ys(two_band_spec
-00009f80: 7472 756d 2c20 756e 6966 6f72 6d5f 6f63  trum, uniform_oc
-00009f90: 6375 7061 7469 6f6e 2c20 7175 6164 7261  cupation, quadra
-00009fa0: 7475 7265 5f69 6e74 6572 7661 6c29 3a0a  ture_interval):.
-00009fb0: 0a20 2020 2074 6173 6b73 203d 206d 616e  .    tasks = man
-00009fc0: 7962 6f64 792e 6361 6c63 5f74 6173 6b73  ybody.calc_tasks
-00009fd0: 2871 7561 6472 6174 7572 655f 696e 7465  (quadrature_inte
-00009fe0: 7276 616c 2c20 7477 6f5f 6261 6e64 5f73  rval, two_band_s
-00009ff0: 7065 6374 7275 6d2c 2075 6e69 666f 726d  pectrum, uniform
-0000a000: 5f6f 6363 7570 6174 696f 6e2c 206b 6579  _occupation, key
-0000a010: 733d 6974 6572 746f 6f6c 732e 636f 756e  s=itertools.coun
-0000a020: 7428 3529 290a 0a20 2020 2066 6f72 2069  t(5))..    for i
-0000a030: 2c20 286b 6579 2c20 7461 736b 2920 696e  , (key, task) in
-0000a040: 2065 6e75 6d65 7261 7465 2874 6173 6b73   enumerate(tasks
-0000a050: 2e69 7465 6d73 2829 293a 0a20 2020 2020  .items()):.     
-0000a060: 2020 2061 7373 6572 7420 6b65 7920 3d3d     assert key ==
-0000a070: 2069 202b 2035 2020 2320 616c 6c20 6b65   i + 5  # all ke
-0000a080: 7973 2073 6869 6674 6564 2062 7920 6f66  ys shifted by of
-0000a090: 6673 6574 0a0a 0a64 6566 2074 6573 745f  fset...def test_
-0000a0a0: 6361 6c63 5f74 6173 6b73 5f6c 6561 645f  calc_tasks_lead_
-0000a0b0: 696e 6465 7828 7477 6f5f 6261 6e64 5f73  index(two_band_s
-0000a0c0: 7065 6374 7275 6d2c 2075 6e69 666f 726d  pectrum, uniform
-0000a0d0: 5f6f 6363 7570 6174 696f 6e2c 2071 7561  _occupation, qua
-0000a0e0: 6472 6174 7572 655f 696e 7465 7276 616c  drature_interval
-0000a0f0: 293a 0a0a 2020 2020 7175 6164 7261 7475  ):..    quadratu
-0000a100: 7265 5f69 6e74 6572 7661 6c2e 6c65 6164  re_interval.lead
-0000a110: 203d 2030 0a20 2020 2074 6173 6b73 203d   = 0.    tasks =
-0000a120: 206d 616e 7962 6f64 792e 6361 6c63 5f74   manybody.calc_t
-0000a130: 6173 6b73 2871 7561 6472 6174 7572 655f  asks(quadrature_
-0000a140: 696e 7465 7276 616c 2c20 7477 6f5f 6261  interval, two_ba
-0000a150: 6e64 5f73 7065 6374 7275 6d2c 2075 6e69  nd_spectrum, uni
-0000a160: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
-0000a170: 0a0a 2020 2020 666f 7220 692c 2028 6b65  ..    for i, (ke
-0000a180: 792c 2074 6173 6b29 2069 6e20 656e 756d  y, task) in enum
-0000a190: 6572 6174 6528 7461 736b 732e 6974 656d  erate(tasks.item
-0000a1a0: 7328 2929 3a0a 2020 2020 2020 2020 6173  s()):.        as
-0000a1b0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
-0000a1c0: 7461 736b 2e6c 6561 642c 2069 6e74 290a  task.lead, int).
-0000a1d0: 2020 2020 2020 2020 6173 7365 7274 2074          assert t
-0000a1e0: 6173 6b2e 6c65 6164 203d 3d20 300a 0a0a  ask.lead == 0...
-0000a1f0: 6465 6620 7465 7374 5f63 616c 635f 7461  def test_calc_ta
-0000a200: 736b 735f 6c65 6164 5f69 6e64 6578 5f74  sks_lead_index_t
-0000a210: 7570 6c65 2874 776f 5f62 616e 645f 7370  uple(two_band_sp
-0000a220: 6563 7472 756d 2c20 756e 6966 6f72 6d5f  ectrum, uniform_
-0000a230: 6f63 6375 7061 7469 6f6e 293a 0a0a 2020  occupation):..  
-0000a240: 2020 2320 6361 6c63 756c 6174 6520 7461    # calculate ta
-0000a250: 736b 7320 7769 7468 2061 2073 6571 7565  sks with a seque
-0000a260: 6e63 6520 6f66 2069 6e74 6572 7661 6c73  nce of intervals
-0000a270: 0a20 2020 2069 6e74 6572 3020 3d20 6d61  .    inter0 = ma
-0000a280: 6e79 626f 6479 2e49 6e74 6572 7661 6c28  nybody.Interval(
-0000a290: 6c65 6164 3d30 2c20 6261 6e64 3d30 2c20  lead=0, band=0, 
-0000a2a0: 6b6d 696e 3d30 2c20 6b6d 6178 3d6e 702e  kmin=0, kmax=np.
-0000a2b0: 7069 202f 2032 290a 2020 2020 696e 7465  pi / 2).    inte
-0000a2c0: 7231 203d 206d 616e 7962 6f64 792e 496e  r1 = manybody.In
-0000a2d0: 7465 7276 616c 286c 6561 643d 312c 2062  terval(lead=1, b
-0000a2e0: 616e 643d 302c 206b 6d69 6e3d 302c 206b  and=0, kmin=0, k
-0000a2f0: 6d61 783d 6e70 2e70 6920 2f20 3229 0a20  max=np.pi / 2). 
-0000a300: 2020 2069 6e74 6572 7661 6c73 5f73 6570     intervals_sep
-0000a310: 203d 205b 696e 7465 7230 2c20 696e 7465   = [inter0, inte
-0000a320: 7231 5d0a 2020 2020 7370 6563 7472 6120  r1].    spectra 
-0000a330: 3d20 5b74 776f 5f62 616e 645f 7370 6563  = [two_band_spec
-0000a340: 7472 756d 2c20 7477 6f5f 6261 6e64 5f73  trum, two_band_s
-0000a350: 7065 6374 7275 6d5d 0a0a 2020 2020 7461  pectrum]..    ta
-0000a360: 736b 735f 7365 7020 3d20 6d61 6e79 626f  sks_sep = manybo
-0000a370: 6479 2e63 616c 635f 7461 736b 7328 696e  dy.calc_tasks(in
-0000a380: 7465 7276 616c 735f 7365 702c 2073 7065  tervals_sep, spe
-0000a390: 6374 7261 2c20 756e 6966 6f72 6d5f 6f63  ctra, uniform_oc
-0000a3a0: 6375 7061 7469 6f6e 290a 0a20 2020 2023  cupation)..    #
-0000a3b0: 2063 616c 6375 6c61 7465 2074 6173 6b73   calculate tasks
-0000a3c0: 2077 6974 6820 6f6e 6c79 206f 6e65 2069   with only one i
-0000a3d0: 6e74 6572 7661 6c20 696e 636c 7564 696e  nterval includin
-0000a3e0: 6720 626f 7468 206c 6561 6473 0a20 2020  g both leads.   
-0000a3f0: 2069 6e74 6572 7661 6c73 5f67 7270 203d   intervals_grp =
-0000a400: 206d 616e 7962 6f64 792e 496e 7465 7276   manybody.Interv
-0000a410: 616c 286c 6561 643d 2830 2c20 3129 2c20  al(lead=(0, 1), 
-0000a420: 6261 6e64 3d30 2c20 6b6d 696e 3d30 2c20  band=0, kmin=0, 
-0000a430: 6b6d 6178 3d6e 702e 7069 202f 2032 290a  kmax=np.pi / 2).
-0000a440: 2020 2020 7461 736b 735f 6772 7020 3d20      tasks_grp = 
-0000a450: 6d61 6e79 626f 6479 2e63 616c 635f 7461  manybody.calc_ta
-0000a460: 736b 7328 696e 7465 7276 616c 735f 6772  sks(intervals_gr
-0000a470: 702c 2073 7065 6374 7261 2c20 756e 6966  p, spectra, unif
-0000a480: 6f72 6d5f 6f63 6375 7061 7469 6f6e 290a  orm_occupation).
-0000a490: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
-0000a4a0: 7461 736b 735f 7365 7029 203d 3d20 6c65  tasks_sep) == le
-0000a4b0: 6e28 7461 736b 735f 6772 7029 0a20 2020  n(tasks_grp).   
-0000a4c0: 2066 6f72 206b 6579 2c20 7661 6c75 6520   for key, value 
-0000a4d0: 696e 2074 6173 6b73 5f73 6570 2e69 7465  in tasks_sep.ite
-0000a4e0: 6d73 2829 3a0a 2020 2020 2020 2020 6173  ms():.        as
-0000a4f0: 7365 7274 2074 6173 6b73 5f67 7270 5b6b  sert tasks_grp[k
-0000a500: 6579 5d2e 6c65 6164 203d 3d20 7661 6c75  ey].lead == valu
-0000a510: 652e 6c65 6164 0a20 2020 2020 2020 2061  e.lead.        a
-0000a520: 7373 6572 7420 7461 736b 735f 6772 705b  ssert tasks_grp[
-0000a530: 6b65 795d 2e6d 6f64 6520 3d3d 2076 616c  key].mode == val
-0000a540: 7565 2e6d 6f64 650a 2020 2020 2020 2020  ue.mode.        
-0000a550: 6173 7365 7274 5f61 6c6d 6f73 745f 6571  assert_almost_eq
-0000a560: 7561 6c28 7461 736b 735f 6772 705b 6b65  ual(tasks_grp[ke
-0000a570: 795d 2e65 6e65 7267 792c 2076 616c 7565  y].energy, value
-0000a580: 2e65 6e65 7267 7929 0a20 2020 2020 2020  .energy).       
-0000a590: 2061 7373 6572 745f 616c 6d6f 7374 5f65   assert_almost_e
-0000a5a0: 7175 616c 2874 6173 6b73 5f67 7270 5b6b  qual(tasks_grp[k
-0000a5b0: 6579 5d2e 6d6f 6d65 6e74 756d 2c20 7661  ey].momentum, va
-0000a5c0: 6c75 652e 6d6f 6d65 6e74 756d 290a 2020  lue.momentum).  
-0000a5d0: 2020 2020 2020 6173 7365 7274 5f61 7272        assert_arr
-0000a5e0: 6179 5f61 6c6d 6f73 745f 6571 7561 6c28  ay_almost_equal(
-0000a5f0: 7461 736b 735f 6772 705b 6b65 795d 2e77  tasks_grp[key].w
-0000a600: 6569 6768 742c 2076 616c 7565 2e77 6569  eight, value.wei
-0000a610: 6768 7429 0a20 2020 2020 2020 2061 7373  ght).        ass
-0000a620: 6572 745f 6172 7261 795f 616c 6d6f 7374  ert_array_almost
-0000a630: 5f65 7175 616c 2874 6173 6b73 5f67 7270  _equal(tasks_grp
-0000a640: 5b6b 6579 5d2e 6d61 7468 5f77 6569 6768  [key].math_weigh
-0000a650: 742c 2076 616c 7565 2e6d 6174 685f 7765  t, value.math_we
-0000a660: 6967 6874 290a 2020 2020 2020 2020 6173  ight).        as
-0000a670: 7365 7274 5f61 7272 6179 5f61 6c6d 6f73  sert_array_almos
-0000a680: 745f 6571 7561 6c28 7461 736b 735f 6772  t_equal(tasks_gr
-0000a690: 705b 6b65 795d 2e70 6879 735f 7765 6967  p[key].phys_weig
-0000a6a0: 6874 2c20 7661 6c75 652e 7068 7973 5f77  ht, value.phys_w
-0000a6b0: 6569 6768 7429 0a0a 0a64 6566 2074 6573  eight)...def tes
-0000a6c0: 745f 6361 6c63 5f74 6173 6b73 5f62 616e  t_calc_tasks_ban
-0000a6d0: 645f 696e 6465 7828 7477 6f5f 6261 6e64  d_index(two_band
-0000a6e0: 5f73 7065 6374 7275 6d2c 2075 6e69 666f  _spectrum, unifo
-0000a6f0: 726d 5f6f 6363 7570 6174 696f 6e2c 2071  rm_occupation, q
-0000a700: 7561 6472 6174 7572 655f 696e 7465 7276  uadrature_interv
-0000a710: 616c 293a 0a0a 2020 2020 666f 7220 6261  al):..    for ba
-0000a720: 6e64 2069 6e20 7261 6e67 6528 7477 6f5f  nd in range(two_
-0000a730: 6261 6e64 5f73 7065 6374 7275 6d2e 6e62  band_spectrum.nb
-0000a740: 616e 6473 293a 0a20 2020 2020 2020 2071  ands):.        q
-0000a750: 7561 6472 6174 7572 655f 696e 7465 7276  uadrature_interv
-0000a760: 616c 2e62 616e 6420 3d20 6261 6e64 0a20  al.band = band. 
-0000a770: 2020 2020 2020 2074 6173 6b73 203d 206d         tasks = m
-0000a780: 616e 7962 6f64 792e 6361 6c63 5f74 6173  anybody.calc_tas
-0000a790: 6b73 2871 7561 6472 6174 7572 655f 696e  ks(quadrature_in
-0000a7a0: 7465 7276 616c 2c20 7477 6f5f 6261 6e64  terval, two_band
-0000a7b0: 5f73 7065 6374 7275 6d2c 2075 6e69 666f  _spectrum, unifo
-0000a7c0: 726d 5f6f 6363 7570 6174 696f 6e29 0a20  rm_occupation). 
-0000a7d0: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0000a7e0: 696e 7374 616e 6365 2874 6173 6b73 2c20  instance(tasks, 
-0000a7f0: 6469 6374 290a 2020 2020 2320 6e6f 2073  dict).    # no s
-0000a800: 7065 6369 6669 6320 7465 7374 2073 6f20  pecific test so 
-0000a810: 6661 722c 2061 7320 6f6e 6c79 206e 756d  far, as only num
-0000a820: 6572 6963 616c 2076 616c 7565 7320 6368  erical values ch
-0000a830: 616e 6765 0a0a 0a40 7079 7465 7374 2e6d  ange...@pytest.m
-0000a840: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
-0000a850: 2771 7561 6472 6174 7572 6527 2c20 5641  'quadrature', VA
-0000a860: 4c49 445f 5155 4144 5241 5455 5245 5329  LID_QUADRATURES)
-0000a870: 0a64 6566 2074 6573 745f 6361 6c63 5f74  .def test_calc_t
-0000a880: 6173 6b73 5f71 7561 6472 6174 7572 6528  asks_quadrature(
-0000a890: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
-0000a8a0: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
-0000a8b0: 6174 696f 6e2c 2071 7561 6472 6174 7572  ation, quadratur
-0000a8c0: 655f 696e 7465 7276 616c 2c20 7175 6164  e_interval, quad
-0000a8d0: 7261 7475 7265 293a 0a0a 2020 2020 7175  rature):..    qu
-0000a8e0: 6164 7261 7475 7265 5f69 6e74 6572 7661  adrature_interva
-0000a8f0: 6c2e 7175 6164 7261 7475 7265 203d 2071  l.quadrature = q
-0000a900: 7561 6472 6174 7572 650a 2020 2020 7461  uadrature.    ta
-0000a910: 736b 7320 3d20 6d61 6e79 626f 6479 2e63  sks = manybody.c
-0000a920: 616c 635f 7461 736b 7328 7175 6164 7261  alc_tasks(quadra
-0000a930: 7475 7265 5f69 6e74 6572 7661 6c2c 2074  ture_interval, t
-0000a940: 776f 5f62 616e 645f 7370 6563 7472 756d  wo_band_spectrum
-0000a950: 2c20 756e 6966 6f72 6d5f 6f63 6375 7061  , uniform_occupa
-0000a960: 7469 6f6e 290a 0a20 2020 2023 2074 6f64  tion)..    # tod
-0000a970: 6f3a 206d 616b 6520 7765 6967 6874 2074  o: make weight t
-0000a980: 7970 6520 7369 6d69 6c61 7220 286e 756d  ype similar (num
-0000a990: 7079 2061 7272 6179 290a 2020 2020 6966  py array).    if
-0000a9a0: 2071 7561 6472 6174 7572 6520 3d3d 2027   quadrature == '
-0000a9b0: 6761 7573 736c 6567 656e 6472 6527 3a0a  gausslegendre':.
-0000a9c0: 2020 2020 2020 2020 6173 7365 7274 206c          assert l
-0000a9d0: 656e 2874 6173 6b73 2920 3d3d 2071 7561  en(tasks) == qua
-0000a9e0: 6472 6174 7572 655f 696e 7465 7276 616c  drature_interval
-0000a9f0: 2e6f 7264 6572 0a20 2020 2020 2020 2066  .order.        f
-0000aa00: 6f72 2069 2c20 286b 6579 2c20 7461 736b  or i, (key, task
-0000aa10: 2920 696e 2065 6e75 6d65 7261 7465 2874  ) in enumerate(t
-0000aa20: 6173 6b73 2e69 7465 6d73 2829 293a 0a20  asks.items()):. 
-0000aa30: 2020 2020 2020 2020 2020 2061 7373 6572             asser
-0000aa40: 7420 6973 696e 7374 616e 6365 2874 6173  t isinstance(tas
-0000aa50: 6b2e 6c65 6164 2c20 696e 7429 0a20 2020  k.lead, int).   
-0000aa60: 2020 2020 2020 2020 2061 7373 6572 7420           assert 
-0000aa70: 6973 696e 7374 616e 6365 2874 6173 6b2e  isinstance(task.
-0000aa80: 7765 6967 6874 2c20 666c 6f61 7429 0a20  weight, float). 
-0000aa90: 2020 2065 6c69 6620 7175 6164 7261 7475     elif quadratu
-0000aaa0: 7265 203d 3d20 276b 726f 6e72 6f64 273a  re == 'kronrod':
-0000aab0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0000aac0: 6c65 6e28 7461 736b 7329 203d 3d20 3220  len(tasks) == 2 
-0000aad0: 2a20 7175 6164 7261 7475 7265 5f69 6e74  * quadrature_int
-0000aae0: 6572 7661 6c2e 6f72 6465 7220 2b20 310a  erval.order + 1.
-0000aaf0: 2020 2020 2020 2020 666f 7220 692c 2028          for i, (
-0000ab00: 6b65 792c 2074 6173 6b29 2069 6e20 656e  key, task) in en
-0000ab10: 756d 6572 6174 6528 7461 736b 732e 6974  umerate(tasks.it
-0000ab20: 656d 7328 2929 3a0a 2020 2020 2020 2020  ems()):.        
-0000ab30: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
-0000ab40: 7461 6e63 6528 7461 736b 2e6c 6561 642c  tance(task.lead,
-0000ab50: 2069 6e74 290a 2020 2020 2020 2020 2020   int).          
-0000ab60: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
-0000ab70: 6e63 6528 7461 736b 2e77 6569 6768 742c  nce(task.weight,
-0000ab80: 206e 702e 6e64 6172 7261 7929 0a20 2020   np.ndarray).   
-0000ab90: 2065 6c73 653a 0a20 2020 2020 2020 2072   else:.        r
-0000aba0: 6169 7365 204e 6f74 496d 706c 656d 656e  aise NotImplemen
-0000abb0: 7465 6445 7272 6f72 2827 7175 6164 7261  tedError('quadra
-0000abc0: 7475 7265 3d7b 7d20 756e 6b6e 6f77 6e27  ture={} unknown'
-0000abd0: 2e66 6f72 6d61 7428 7175 6164 7261 7475  .format(quadratu
-0000abe0: 7265 2929 0a0a 0a64 6566 2074 6573 745f  re))...def test_
-0000abf0: 6361 6c63 5f74 6173 6b73 5f61 7474 7269  calc_tasks_attri
-0000ac00: 6275 7465 5f63 6f70 7928 7477 6f5f 6261  bute_copy(two_ba
-0000ac10: 6e64 5f73 7065 6374 7275 6d2c 2075 6e69  nd_spectrum, uni
-0000ac20: 666f 726d 5f6f 6363 7570 6174 696f 6e2c  form_occupation,
-0000ac30: 2071 7561 6472 6174 7572 655f 696e 7465   quadrature_inte
-0000ac40: 7276 616c 293a 0a0a 2020 2020 636c 6173  rval):..    clas
-0000ac50: 7320 4d79 5461 736b 3a0a 2020 2020 2020  s MyTask:.      
-0000ac60: 2020 6465 6620 5f5f 696e 6974 5f5f 2873    def __init__(s
-0000ac70: 656c 662c 2077 6569 6768 742c 2070 6879  elf, weight, phy
-0000ac80: 735f 7765 6967 6874 2c20 6d61 7468 5f77  s_weight, math_w
-0000ac90: 6569 6768 742c 2065 6e65 7267 792c 206d  eight, energy, m
-0000aca0: 6f6d 656e 7475 6d2c 206d 6f64 652c 206c  omentum, mode, l
-0000acb0: 6561 6429 3a0a 2020 2020 2020 2020 2020  ead):.          
-0000acc0: 2020 7365 6c66 2e77 6569 6768 7420 3d20    self.weight = 
-0000acd0: 7765 6967 6874 0a20 2020 2020 2020 2020  weight.         
-0000ace0: 2020 2073 656c 662e 7068 7973 5f77 6569     self.phys_wei
-0000acf0: 6768 7420 3d20 7068 7973 5f77 6569 6768  ght = phys_weigh
-0000ad00: 740a 2020 2020 2020 2020 2020 2020 7365  t.            se
-0000ad10: 6c66 2e6d 6174 685f 7765 6967 6874 203d  lf.math_weight =
-0000ad20: 206d 6174 685f 7765 6967 6874 0a20 2020   math_weight.   
-0000ad30: 2020 2020 2020 2020 2073 656c 662e 656e           self.en
-0000ad40: 6572 6779 203d 2065 6e65 7267 790a 2020  ergy = energy.  
-0000ad50: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
-0000ad60: 6f6d 656e 7475 6d20 3d20 6d6f 6d65 6e74  omentum = moment
-0000ad70: 756d 0a20 2020 2020 2020 2020 2020 2073  um.            s
-0000ad80: 656c 662e 6d6f 6465 203d 206d 6f64 650a  elf.mode = mode.
-0000ad90: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-0000ada0: 2e6c 6561 6420 3d20 6c65 6164 0a20 2020  .lead = lead.   
-0000adb0: 2020 2020 2020 2020 2073 656c 662e 6368           self.ch
-0000adc0: 6563 6b61 7474 7269 6275 7465 203d 2027  eckattribute = '
-0000add0: 6368 6563 6b5f 7461 736b 2720 2023 2064  check_task'  # d
-0000ade0: 756d 6d79 2061 7474 7269 6275 7465 2074  ummy attribute t
-0000adf0: 6f20 6368 6563 6b20 6966 2069 7420 6973  o check if it is
-0000ae00: 2063 6f70 6965 640a 0a20 2020 2074 6173   copied..    tas
-0000ae10: 6b73 203d 206d 616e 7962 6f64 792e 6361  ks = manybody.ca
-0000ae20: 6c63 5f74 6173 6b73 2871 7561 6472 6174  lc_tasks(quadrat
-0000ae30: 7572 655f 696e 7465 7276 616c 2c20 7477  ure_interval, tw
-0000ae40: 6f5f 6261 6e64 5f73 7065 6374 7275 6d2c  o_band_spectrum,
-0000ae50: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
-0000ae60: 696f 6e2c 2074 6173 6b5f 7479 7065 3d4d  ion, task_type=M
-0000ae70: 7954 6173 6b29 0a0a 2020 2020 666f 7220  yTask)..    for 
-0000ae80: 692c 2028 6b65 792c 2074 6173 6b29 2069  i, (key, task) i
-0000ae90: 6e20 656e 756d 6572 6174 6528 7461 736b  n enumerate(task
-0000aea0: 732e 6974 656d 7328 2929 3a0a 2020 2020  s.items()):.    
-0000aeb0: 2020 2020 6173 7365 7274 2074 6173 6b2e      assert task.
-0000aec0: 6368 6563 6b61 7474 7269 6275 7465 203d  checkattribute =
-0000aed0: 3d20 2763 6865 636b 5f74 6173 6b27 0a0a  = 'check_task'..
-0000aee0: 0a40 7079 7465 7374 2e6d 6172 6b2e 7061  .@pytest.mark.pa
-0000aef0: 7261 6d65 7472 697a 6528 2769 6e74 6567  rametrize('integ
-0000af00: 7261 7469 6f6e 5f76 6172 6961 626c 6527  ration_variable'
-0000af10: 2c20 5641 4c49 445f 494e 5445 4752 4154  , VALID_INTEGRAT
-0000af20: 494f 4e5f 5641 5249 4142 4c45 5329 0a64  ION_VARIABLES).d
-0000af30: 6566 2074 6573 745f 6361 6c63 5f74 6173  ef test_calc_tas
-0000af40: 6b73 5f69 6e74 6567 7261 7469 6f6e 5f76  ks_integration_v
-0000af50: 6172 6961 626c 6528 7477 6f5f 6261 6e64  ariable(two_band
-0000af60: 5f73 7065 6374 7275 6d2c 2075 6e69 666f  _spectrum, unifo
-0000af70: 726d 5f6f 6363 7570 6174 696f 6e2c 2071  rm_occupation, q
-0000af80: 7561 6472 6174 7572 655f 696e 7465 7276  uadrature_interv
-0000af90: 616c 2c20 696e 7465 6772 6174 696f 6e5f  al, integration_
-0000afa0: 7661 7269 6162 6c65 293a 0a0a 2020 2020  variable):..    
-0000afb0: 7175 6164 7261 7475 7265 5f69 6e74 6572  quadrature_inter
-0000afc0: 7661 6c2e 696e 7465 6772 6174 696f 6e5f  val.integration_
-0000afd0: 7661 7269 6162 6c65 203d 2069 6e74 6567  variable = integ
-0000afe0: 7261 7469 6f6e 5f76 6172 6961 626c 650a  ration_variable.
-0000aff0: 2020 2020 7461 736b 7320 3d20 6d61 6e79      tasks = many
-0000b000: 626f 6479 2e63 616c 635f 7461 736b 7328  body.calc_tasks(
-0000b010: 7175 6164 7261 7475 7265 5f69 6e74 6572  quadrature_inter
-0000b020: 7661 6c2c 2074 776f 5f62 616e 645f 7370  val, two_band_sp
-0000b030: 6563 7472 756d 2c20 756e 6966 6f72 6d5f  ectrum, uniform_
-0000b040: 6f63 6375 7061 7469 6f6e 290a 2020 2020  occupation).    
-0000b050: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
-0000b060: 6528 7461 736b 732c 2064 6963 7429 0a20  e(tasks, dict). 
-0000b070: 2020 2023 206e 6f20 7370 6563 6966 6963     # no specific
-0000b080: 2074 6573 7420 736f 2066 6172 2c20 6173   test so far, as
-0000b090: 206f 6e6c 7920 6e75 6d65 7269 6361 6c20   only numerical 
-0000b0a0: 7661 6c75 6573 2063 6861 6e67 650a 0a0a  values change...
-0000b0b0: 6465 6620 7465 7374 5f63 616c 635f 7461  def test_calc_ta
-0000b0c0: 736b 735f 6c65 6164 5f69 6e64 6578 5f6f  sks_lead_index_o
-0000b0d0: 7574 5f6f 665f 7261 6e67 6528 7175 6164  ut_of_range(quad
-0000b0e0: 7261 7475 7265 5f69 6e74 6572 7661 6c2c  rature_interval,
-0000b0f0: 2074 776f 5f62 616e 645f 7370 6563 7472   two_band_spectr
-0000b100: 756d 2c0a 2020 2020 2020 2020 2020 2020  um,.            
-0000b110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b120: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b130: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-0000b140: 6f6e 293a 0a20 2020 2071 7561 6472 6174  on):.    quadrat
-0000b150: 7572 655f 696e 7465 7276 616c 2e6c 6561  ure_interval.lea
-0000b160: 6420 3d20 310a 2020 2020 7261 6973 6573  d = 1.    raises
-0000b170: 2849 6e64 6578 4572 726f 722c 206d 616e  (IndexError, man
-0000b180: 7962 6f64 792e 6361 6c63 5f74 6173 6b73  ybody.calc_tasks
-0000b190: 2c20 7175 6164 7261 7475 7265 5f69 6e74  , quadrature_int
-0000b1a0: 6572 7661 6c2c 2074 776f 5f62 616e 645f  erval, two_band_
-0000b1b0: 7370 6563 7472 756d 2c20 756e 6966 6f72  spectrum, unifor
-0000b1c0: 6d5f 6f63 6375 7061 7469 6f6e 290a 0a0a  m_occupation)...
-0000b1d0: 6465 6620 7465 7374 5f63 616c 635f 7461  def test_calc_ta
-0000b1e0: 736b 735f 6261 6e64 5f69 6e64 6578 5f6f  sks_band_index_o
-0000b1f0: 7574 5f6f 665f 7261 6e67 6528 7175 6164  ut_of_range(quad
-0000b200: 7261 7475 7265 5f69 6e74 6572 7661 6c2c  rature_interval,
-0000b210: 2074 776f 5f62 616e 645f 7370 6563 7472   two_band_spectr
-0000b220: 756d 2c0a 2020 2020 2020 2020 2020 2020  um,.            
-0000b230: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b240: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b250: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
-0000b260: 6f6e 293a 0a20 2020 2071 7561 6472 6174  on):.    quadrat
-0000b270: 7572 655f 696e 7465 7276 616c 2e62 616e  ure_interval.ban
-0000b280: 6420 3d20 320a 2020 2020 7261 6973 6573  d = 2.    raises
-0000b290: 2841 7373 6572 7469 6f6e 4572 726f 722c  (AssertionError,
-0000b2a0: 206d 616e 7962 6f64 792e 6361 6c63 5f74   manybody.calc_t
-0000b2b0: 6173 6b73 2c20 7175 6164 7261 7475 7265  asks, quadrature
-0000b2c0: 5f69 6e74 6572 7661 6c2c 2074 776f 5f62  _interval, two_b
-0000b2d0: 616e 645f 7370 6563 7472 756d 2c20 756e  and_spectrum, un
-0000b2e0: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-0000b2f0: 290a 0a0a 6465 6620 7465 7374 5f63 616c  )...def test_cal
-0000b300: 635f 7461 736b 735f 6b6d 696e 5f6b 6d61  c_tasks_kmin_kma
-0000b310: 785f 696e 7465 7263 6861 6e67 6564 2871  x_interchanged(q
-0000b320: 7561 6472 6174 7572 655f 696e 7465 7276  uadrature_interv
-0000b330: 616c 2c20 7477 6f5f 6261 6e64 5f73 7065  al, two_band_spe
-0000b340: 6374 7275 6d2c 0a20 2020 2020 2020 2020  ctrum,.         
-0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b370: 2020 756e 6966 6f72 6d5f 6f63 6375 7061    uniform_occupa
-0000b380: 7469 6f6e 293a 0a20 2020 2071 7561 6472  tion):.    quadr
-0000b390: 6174 7572 655f 696e 7465 7276 616c 2e6b  ature_interval.k
-0000b3a0: 6d69 6e20 3d20 310a 2020 2020 7175 6164  min = 1.    quad
-0000b3b0: 7261 7475 7265 5f69 6e74 6572 7661 6c2e  rature_interval.
-0000b3c0: 6b6d 6178 203d 2030 0a20 2020 2072 6169  kmax = 0.    rai
-0000b3d0: 7365 7328 5661 6c75 6545 7272 6f72 2c20  ses(ValueError, 
-0000b3e0: 6d61 6e79 626f 6479 2e63 616c 635f 7461  manybody.calc_ta
-0000b3f0: 736b 732c 2071 7561 6472 6174 7572 655f  sks, quadrature_
-0000b400: 696e 7465 7276 616c 2c20 7477 6f5f 6261  interval, two_ba
-0000b410: 6e64 5f73 7065 6374 7275 6d2c 2075 6e69  nd_spectrum, uni
-0000b420: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
-0000b430: 0a0a 0a64 6566 2074 6573 745f 6361 6c63  ...def test_calc
-0000b440: 5f74 6173 6b73 5f6f 7264 6572 5f6f 7574  _tasks_order_out
-0000b450: 5f6f 665f 7261 6e67 6528 7175 6164 7261  _of_range(quadra
-0000b460: 7475 7265 5f69 6e74 6572 7661 6c2c 2074  ture_interval, t
-0000b470: 776f 5f62 616e 645f 7370 6563 7472 756d  wo_band_spectrum
-0000b480: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-0000b490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b4a0: 2020 2020 2020 2020 2075 6e69 666f 726d           uniform
-0000b4b0: 5f6f 6363 7570 6174 696f 6e29 3a0a 2020  _occupation):.  
-0000b4c0: 2020 7175 6164 7261 7475 7265 5f69 6e74    quadrature_int
-0000b4d0: 6572 7661 6c2e 6f72 6465 7220 3d20 300a  erval.order = 0.
-0000b4e0: 2020 2020 7261 6973 6573 2856 616c 7565      raises(Value
-0000b4f0: 4572 726f 722c 206d 616e 7962 6f64 792e  Error, manybody.
-0000b500: 6361 6c63 5f74 6173 6b73 2c20 7175 6164  calc_tasks, quad
-0000b510: 7261 7475 7265 5f69 6e74 6572 7661 6c2c  rature_interval,
-0000b520: 2074 776f 5f62 616e 645f 7370 6563 7472   two_band_spectr
-0000b530: 756d 2c20 756e 6966 6f72 6d5f 6f63 6375  um, uniform_occu
-0000b540: 7061 7469 6f6e 290a 0a0a 6465 6620 7465  pation)...def te
-0000b550: 7374 5f63 616c 635f 7461 736b 735f 6e6f  st_calc_tasks_no
-0000b560: 6e65 7869 7374 696e 675f 7175 6164 7261  nexisting_quadra
-0000b570: 7475 7265 2871 7561 6472 6174 7572 655f  ture(quadrature_
-0000b580: 696e 7465 7276 616c 2c20 7477 6f5f 6261  interval, two_ba
-0000b590: 6e64 5f73 7065 6374 7275 6d2c 0a20 2020  nd_spectrum,.   
-0000b5a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b5c0: 2020 2020 2020 2020 756e 6966 6f72 6d5f          uniform_
-0000b5d0: 6f63 6375 7061 7469 6f6e 293a 0a20 2020  occupation):.   
-0000b5e0: 2071 7561 6472 6174 7572 655f 696e 7465   quadrature_inte
-0000b5f0: 7276 616c 2e71 7561 6472 6174 7572 6520  rval.quadrature 
-0000b600: 3d20 2762 6c61 270a 2020 2020 7261 6973  = 'bla'.    rais
-0000b610: 6573 284e 6f74 496d 706c 656d 656e 7465  es(NotImplemente
-0000b620: 6445 7272 6f72 2c20 6d61 6e79 626f 6479  dError, manybody
-0000b630: 2e63 616c 635f 7461 736b 732c 2071 7561  .calc_tasks, qua
-0000b640: 6472 6174 7572 655f 696e 7465 7276 616c  drature_interval
-0000b650: 2c20 7477 6f5f 6261 6e64 5f73 7065 6374  , two_band_spect
-0000b660: 7275 6d2c 2075 6e69 666f 726d 5f6f 6363  rum, uniform_occ
-0000b670: 7570 6174 696f 6e29 0a0a 0a64 6566 2074  upation)...def t
-0000b680: 6573 745f 6361 6c63 5f74 6173 6b73 5f6e  est_calc_tasks_n
-0000b690: 6f6e 6578 6973 7469 6e67 5f69 6e74 6567  onexisting_integ
-0000b6a0: 7261 7469 6f6e 5f76 6172 6961 626c 6528  ration_variable(
-0000b6b0: 7175 6164 7261 7475 7265 5f69 6e74 6572  quadrature_inter
-0000b6c0: 7661 6c2c 2074 776f 5f62 616e 645f 7370  val, two_band_sp
-0000b6d0: 6563 7472 756d 2c0a 2020 2020 2020 2020  ectrum,.        
-0000b6e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b6f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b700: 2020 2020 2020 2020 2020 2020 2075 6e69               uni
-0000b710: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
-0000b720: 3a0a 2020 2020 7175 6164 7261 7475 7265  :.    quadrature
-0000b730: 5f69 6e74 6572 7661 6c2e 696e 7465 6772  _interval.integr
-0000b740: 6174 696f 6e5f 7661 7269 6162 6c65 203d  ation_variable =
-0000b750: 2027 626c 6127 0a20 2020 2072 6169 7365   'bla'.    raise
-0000b760: 7328 4e6f 7449 6d70 6c65 6d65 6e74 6564  s(NotImplemented
-0000b770: 4572 726f 722c 206d 616e 7962 6f64 792e  Error, manybody.
-0000b780: 6361 6c63 5f74 6173 6b73 2c20 7175 6164  calc_tasks, quad
-0000b790: 7261 7475 7265 5f69 6e74 6572 7661 6c2c  rature_interval,
-0000b7a0: 2074 776f 5f62 616e 645f 7370 6563 7472   two_band_spectr
-0000b7b0: 756d 2c20 756e 6966 6f72 6d5f 6f63 6375  um, uniform_occu
-0000b7c0: 7061 7469 6f6e 290a 0a0a 6465 6620 7465  pation)...def te
-0000b7d0: 7374 5f63 616c 635f 7461 736b 735f 6469  st_calc_tasks_di
-0000b7e0: 7374 7269 6275 7469 6f6e 5f6e 6f74 5f63  stribution_not_c
-0000b7f0: 616c 6c61 626c 6528 7175 6164 7261 7475  allable(quadratu
-0000b800: 7265 5f69 6e74 6572 7661 6c2c 2074 776f  re_interval, two
-0000b810: 5f62 616e 645f 7370 6563 7472 756d 2c0a  _band_spectrum,.
-0000b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b840: 2020 2020 2020 2020 2020 2020 2020 756e                un
-0000b850: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-0000b860: 293a 0a20 2020 2075 6e69 666f 726d 5f6f  ):.    uniform_o
-0000b870: 6363 7570 6174 696f 6e2e 6469 7374 7269  ccupation.distri
-0000b880: 6275 7469 6f6e 203d 2031 0a20 2020 2072  bution = 1.    r
-0000b890: 6169 7365 7328 5479 7065 4572 726f 722c  aises(TypeError,
-0000b8a0: 206d 616e 7962 6f64 792e 6361 6c63 5f74   manybody.calc_t
-0000b8b0: 6173 6b73 2c20 7175 6164 7261 7475 7265  asks, quadrature
-0000b8c0: 5f69 6e74 6572 7661 6c2c 2074 776f 5f62  _interval, two_b
-0000b8d0: 616e 645f 7370 6563 7472 756d 2c20 756e  and_spectrum, un
-0000b8e0: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
-0000b8f0: 290a 0a0a 4070 7974 6573 742e 6d61 726b  )...@pytest.mark
-0000b900: 2e69 6e74 6567 7465 7374 2020 2320 6d61  .integtest  # ma
-0000b910: 726b 6572 2066 6f72 2069 6e74 6567 7261  rker for integra
-0000b920: 7469 6f6e 2074 6573 7473 0a64 6566 2074  tion tests.def t
-0000b930: 6573 745f 6361 6c63 5f69 6e69 7469 616c  est_calc_initial
-0000b940: 5f73 7461 7465 2829 3a0a 0a20 2020 2023  _state():..    #
-0000b950: 202d 2d2d 2d20 6368 6563 6b20 696e 6974   ---- check init
-0000b960: 6961 6c20 7374 6174 650a 2020 2020 6368  ial state.    ch
-0000b970: 656d 6963 616c 5f70 6f74 656e 7469 616c  emical_potential
-0000b980: 203d 2033 0a20 2020 2074 6d61 7820 3d20   = 3.    tmax = 
-0000b990: 3530 300a 2020 2020 7061 7261 6d73 203d  500.    params =
-0000b9a0: 207b 2776 273a 2030 2e31 2c20 2774 3027   {'v': 0.1, 't0'
-0000b9b0: 3a20 302c 2027 4127 3a20 302e 3030 3135  : 0, 'A': 0.0015
-0000b9c0: 372c 2027 7369 676d 6127 3a20 3234 7d0a  7, 'sigma': 24}.
-0000b9d0: 2020 2020 7379 7374 203d 206d 616b 655f      syst = make_
-0000b9e0: 7379 7374 656d 2829 2e66 696e 616c 697a  system().finaliz
-0000b9f0: 6564 2829 0a20 2020 206f 6363 7570 6174  ed().    occupat
-0000ba00: 696f 6e20 3d20 6d61 6e79 626f 6479 2e6c  ion = manybody.l
-0000ba10: 6561 645f 6f63 6375 7061 7469 6f6e 2863  ead_occupation(c
-0000ba20: 6865 6d69 6361 6c5f 706f 7465 6e74 6961  hemical_potentia
-0000ba30: 6c29 0a20 2020 2073 7065 6374 7275 6d20  l).    spectrum 
-0000ba40: 3d20 6b77 616e 7473 7065 6374 7275 6d2e  = kwantspectrum.
-0000ba50: 7370 6563 7472 6128 7379 7374 2e6c 6561  spectra(syst.lea
-0000ba60: 6473 290a 2020 2020 696e 7465 7276 616c  ds).    interval
-0000ba70: 7320 3d20 6d61 6e79 626f 6479 2e63 616c  s = manybody.cal
-0000ba80: 635f 696e 7465 7276 616c 7328 7370 6563  c_intervals(spec
-0000ba90: 7472 756d 2c20 6f63 6375 7061 7469 6f6e  trum, occupation
-0000baa0: 290a 2020 2020 696e 7465 7276 616c 735b  ).    intervals[
-0000bab0: 305d 2e6f 7264 6572 203d 2031 300a 2020  0].order = 10.  
-0000bac0: 2020 696e 7465 7276 616c 735b 315d 2e6f    intervals[1].o
-0000bad0: 7264 6572 203d 2038 0a20 2020 2066 6f72  rder = 8.    for
-0000bae0: 2069 6e74 6572 7661 6c20 696e 2069 6e74   interval in int
-0000baf0: 6572 7661 6c73 3a20 2023 2075 7365 2073  ervals:  # use s
-0000bb00: 696d 706c 6520 7175 6164 7261 7475 7265  imple quadrature
-0000bb10: 0a20 2020 2020 2020 2069 6e74 6572 7661  .        interva
-0000bb20: 6c2e 7175 6164 7261 7475 7265 203d 2027  l.quadrature = '
-0000bb30: 6761 7573 736c 6567 656e 6472 6527 0a20  gausslegendre'. 
-0000bb40: 2020 2074 6173 6b73 203d 206d 616e 7962     tasks = manyb
-0000bb50: 6f64 792e 6361 6c63 5f74 6173 6b73 2869  ody.calc_tasks(i
-0000bb60: 6e74 6572 7661 6c73 2c20 7370 6563 7472  ntervals, spectr
-0000bb70: 756d 2c20 6f63 6375 7061 7469 6f6e 290a  um, occupation).
-0000bb80: 2020 2020 626f 756e 6461 7269 6573 203d      boundaries =
-0000bb90: 206c 6561 6473 2e61 7574 6f6d 6174 6963   leads.automatic
-0000bba0: 5f62 6f75 6e64 6172 7928 7370 6563 7472  _boundary(spectr
-0000bbb0: 756d 2c20 746d 6178 290a 2020 2020 7073  um, tmax).    ps
-0000bbc0: 695f 696e 6974 203d 206d 616e 7962 6f64  i_init = manybod
-0000bbd0: 792e 6361 6c63 5f69 6e69 7469 616c 5f73  y.calc_initial_s
-0000bbe0: 7461 7465 2873 7973 742c 2074 6173 6b73  tate(syst, tasks
-0000bbf0: 2c20 626f 756e 6461 7269 6573 2c0a 2020  , boundaries,.  
-0000bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc20: 2020 2020 2020 2020 2070 6172 616d 733d           params=
-0000bc30: 7061 7261 6d73 290a 0a20 2020 2023 2063  params)..    # c
-0000bc40: 6865 636b 2061 6c6c 2074 7970 6573 206f  heck all types o
-0000bc50: 6620 7468 6520 7265 7475 726e 6564 2065  f the returned e
-0000bc60: 6c65 6d65 6e74 730a 2020 2020 6173 7365  lements.    asse
-0000bc70: 7274 2069 7369 6e73 7461 6e63 6528 7073  rt isinstance(ps
-0000bc80: 695f 696e 6974 2c20 6469 6374 290a 2020  i_init, dict).  
-0000bc90: 2020 6173 7365 7274 206c 656e 2870 7369    assert len(psi
-0000bca0: 5f69 6e69 7429 203d 3d20 696e 7465 7276  _init) == interv
-0000bcb0: 616c 735b 305d 2e6f 7264 6572 202b 2069  als[0].order + i
-0000bcc0: 6e74 6572 7661 6c73 5b31 5d2e 6f72 6465  ntervals[1].orde
-0000bcd0: 720a 2020 2020 666f 7220 692c 2028 6b65  r.    for i, (ke
-0000bce0: 792c 2076 616c 7565 2920 696e 2065 6e75  y, value) in enu
-0000bcf0: 6d65 7261 7465 2870 7369 5f69 6e69 742e  merate(psi_init.
-0000bd00: 6974 656d 7328 2929 3a0a 2020 2020 2020  items()):.      
-0000bd10: 2020 6173 7365 7274 2069 203d 3d20 6b65    assert i == ke
-0000bd20: 790a 2020 2020 2020 2020 6173 7365 7274  y.        assert
-0000bd30: 2069 7369 6e73 7461 6e63 6528 7661 6c75   isinstance(valu
-0000bd40: 652c 206f 6e65 626f 6479 2e57 6176 6546  e, onebody.WaveF
-0000bd50: 756e 6374 696f 6e29 0a0a 0a40 7079 7465  unction)...@pyte
-0000bd60: 7374 2e6d 6172 6b2e 696e 7465 6774 6573  st.mark.integtes
-0000bd70: 740a 6465 6620 7465 7374 5f63 616c 635f  t.def test_calc_
-0000bd80: 696e 6974 6961 6c5f 7374 6174 655f 7769  initial_state_wi
-0000bd90: 7468 5f6b 7761 6e74 5f66 6169 6c69 6e67  th_kwant_failing
-0000bda0: 2829 3a0a 0a20 2020 2073 7973 7420 3d20  ():..    syst = 
-0000bdb0: 6d61 6b65 5f73 7973 7465 6d28 292e 6669  make_system().fi
-0000bdc0: 6e61 6c69 7a65 6428 290a 2020 2020 6f63  nalized().    oc
-0000bdd0: 6375 7061 7469 6f6e 203d 206d 616e 7962  cupation = manyb
-0000bde0: 6f64 792e 6c65 6164 5f6f 6363 7570 6174  ody.lead_occupat
-0000bdf0: 696f 6e28 6368 656d 6963 616c 5f70 6f74  ion(chemical_pot
-0000be00: 656e 7469 616c 3d33 290a 2020 2020 7370  ential=3).    sp
-0000be10: 6563 7472 756d 203d 206b 7761 6e74 7370  ectrum = kwantsp
-0000be20: 6563 7472 756d 2e73 7065 6374 7261 2873  ectrum.spectra(s
-0000be30: 7973 742e 6c65 6164 7329 0a20 2020 2069  yst.leads).    i
-0000be40: 6e74 6572 7661 6c73 203d 206d 616e 7962  ntervals = manyb
-0000be50: 6f64 792e 6361 6c63 5f69 6e74 6572 7661  ody.calc_interva
-0000be60: 6c73 2873 7065 6374 7275 6d2c 206f 6363  ls(spectrum, occ
-0000be70: 7570 6174 696f 6e29 0a20 2020 2074 6173  upation).    tas
-0000be80: 6b73 203d 206d 616e 7962 6f64 792e 6361  ks = manybody.ca
-0000be90: 6c63 5f74 6173 6b73 2869 6e74 6572 7661  lc_tasks(interva
-0000bea0: 6c73 2c20 7370 6563 7472 756d 2c20 6f63  ls, spectrum, oc
-0000beb0: 6375 7061 7469 6f6e 290a 2020 2020 626f  cupation).    bo
-0000bec0: 756e 6461 7269 6573 203d 205b 6c65 6164  undaries = [lead
-0000bed0: 732e 5369 6d70 6c65 426f 756e 6461 7279  s.SimpleBoundary
-0000bee0: 2874 6d61 783d 3129 5d20 2a20 6c65 6e28  (tmax=1)] * len(
-0000bef0: 7379 7374 2e6c 6561 6473 290a 0a20 2020  syst.leads)..   
-0000bf00: 2063 6c61 7373 2053 6361 7474 6572 696e   class Scatterin
-0000bf10: 6753 7461 7465 7352 6169 7365 3a0a 2020  gStatesRaise:.  
-0000bf20: 2020 2020 2020 2222 2272 6169 7365 2077        """raise w
-0000bf30: 6974 6820 6120 7275 6e74 696d 6520 6572  ith a runtime er
-0000bf40: 726f 7222 2222 0a20 2020 2020 2020 2064  ror""".        d
-0000bf50: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-0000bf60: 2c20 2a61 7267 732c 202a 2a6b 7761 7267  , *args, **kwarg
-0000bf70: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-0000bf80: 7261 6973 6520 5275 6e74 696d 6545 7272  raise RuntimeErr
-0000bf90: 6f72 2829 0a0a 2020 2020 2320 7765 206a  or()..    # we j
-0000bfa0: 7573 7420 6d6f 636b 2074 6861 7420 7374  ust mock that st
-0000bfb0: 6174 6520 6361 6c63 756c 6174 696f 6e20  ate calculation 
-0000bfc0: 6661 696c 730a 2020 2020 7769 7468 2070  fails.    with p
-0000bfd0: 7974 6573 742e 7261 6973 6573 2852 756e  ytest.raises(Run
-0000bfe0: 7469 6d65 4572 726f 7229 2061 7320 6578  timeError) as ex
-0000bff0: 633a 0a20 2020 2020 2020 206d 616e 7962  c:.        manyb
-0000c000: 6f64 792e 6361 6c63 5f69 6e69 7469 616c  ody.calc_initial
-0000c010: 5f73 7461 7465 2873 7973 742c 2074 6173  _state(syst, tas
-0000c020: 6b73 2c20 626f 756e 6461 7269 6573 2c0a  ks, boundaries,.
-0000c030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000c050: 2020 2020 7363 6174 7465 7269 6e67 5f73      scattering_s
-0000c060: 7461 7465 5f74 7970 653d 5363 6174 7465  tate_type=Scatte
-0000c070: 7269 6e67 5374 6174 6573 5261 6973 6529  ringStatesRaise)
-0000c080: 0a20 2020 2023 2077 6520 646f 206e 6f74  .    # we do not
-0000c090: 2063 6865 636b 2066 6f72 2074 6865 2065   check for the e
-0000c0a0: 7861 6374 2065 6e65 7267 7920 7661 6c75  xact energy valu
-0000c0b0: 6520 6173 2074 6869 7320 6361 6e20 6368  e as this can ch
-0000c0c0: 616e 6765 0a20 2020 2061 7373 6572 7420  ange.    assert 
-0000c0d0: 2773 6361 7474 6572 696e 6720 7374 6174  'scattering stat
-0000c0e0: 6520 6361 6c63 756c 6174 696f 6e20 6661  e calculation fa
-0000c0f0: 696c 6564 2066 6f72 2065 6e65 7267 793d  iled for energy=
-0000c100: 2720 696e 2073 7472 2865 7863 2e76 616c  ' in str(exc.val
-0000c110: 7565 290a 0a0a 4070 7974 6573 742e 6d61  ue)...@pytest.ma
-0000c120: 726b 2e69 6e74 6567 7465 7374 2020 2320  rk.integtest  # 
-0000c130: 6d61 726b 6572 2066 6f72 2069 6e74 6567  marker for integ
-0000c140: 7261 7469 6f6e 2074 6573 7473 0a64 6566  ration tests.def
-0000c150: 2074 6573 745f 6d61 6e79 626f 6479 5f77   test_manybody_w
-0000c160: 6176 6566 756e 6374 696f 6e28 293a 0a20  avefunction():. 
-0000c170: 2020 2073 7973 7420 3d20 6d61 6b65 5f73     syst = make_s
-0000c180: 7973 7465 6d28 292e 6669 6e61 6c69 7a65  ystem().finalize
-0000c190: 6428 290a 0a20 2020 2064 656e 7369 7479  d()..    density
-0000c1a0: 5f6f 7065 7261 746f 7220 3d20 6b77 616e  _operator = kwan
-0000c1b0: 742e 6f70 6572 6174 6f72 2e44 656e 7369  t.operator.Densi
-0000c1c0: 7479 2873 7973 7429 2020 2320 6172 7261  ty(syst)  # arra
-0000c1d0: 790a 2020 2020 7375 6d5f 6465 6e73 6974  y.    sum_densit
-0000c1e0: 795f 6f70 6572 6174 6f72 203d 206b 7761  y_operator = kwa
-0000c1f0: 6e74 2e6f 7065 7261 746f 722e 4465 6e73  nt.operator.Dens
-0000c200: 6974 7928 7379 7374 2c20 7375 6d3d 5472  ity(syst, sum=Tr
-0000c210: 7565 2920 2023 206f 6e6c 7920 6f6e 6520  ue)  # only one 
-0000c220: 656c 656d 656e 7420 696e 2061 7272 6179  element in array
-0000c230: 0a0a 2020 2020 6368 656d 6963 616c 5f70  ..    chemical_p
-0000c240: 6f74 656e 7469 616c 203d 2033 0a20 2020  otential = 3.   
-0000c250: 2074 6d61 7820 3d20 3530 300a 2020 2020   tmax = 500.    
-0000c260: 7469 6d65 203d 2035 0a20 2020 2070 6172  time = 5.    par
-0000c270: 616d 7320 3d20 7b27 7627 3a20 302e 312c  ams = {'v': 0.1,
-0000c280: 2027 7430 273a 2030 2c20 2741 273a 2030   't0': 0, 'A': 0
-0000c290: 2e30 3031 3537 2c20 2773 6967 6d61 273a  .00157, 'sigma':
-0000c2a0: 2032 347d 0a0a 2020 2020 6f63 6375 7061   24}..    occupa
-0000c2b0: 7469 6f6e 203d 206d 616e 7962 6f64 792e  tion = manybody.
-0000c2c0: 6c65 6164 5f6f 6363 7570 6174 696f 6e28  lead_occupation(
-0000c2d0: 6368 656d 6963 616c 5f70 6f74 656e 7469  chemical_potenti
-0000c2e0: 616c 290a 2020 2020 7370 6563 7472 756d  al).    spectrum
-0000c2f0: 203d 206b 7761 6e74 7370 6563 7472 756d   = kwantspectrum
-0000c300: 2e73 7065 6374 7261 2873 7973 742e 6c65  .spectra(syst.le
-0000c310: 6164 7329 0a20 2020 2069 6e74 6572 7661  ads).    interva
-0000c320: 6c73 203d 206d 616e 7962 6f64 792e 6361  ls = manybody.ca
-0000c330: 6c63 5f69 6e74 6572 7661 6c73 2873 7065  lc_intervals(spe
-0000c340: 6374 7275 6d2c 206f 6363 7570 6174 696f  ctrum, occupatio
-0000c350: 6e29 0a20 2020 2066 6f72 2069 6e74 6572  n).    for inter
-0000c360: 7661 6c20 696e 2069 6e74 6572 7661 6c73  val in intervals
-0000c370: 3a20 2023 2075 7365 2073 696d 706c 6520  :  # use simple 
-0000c380: 7175 6164 7261 7475 7265 0a20 2020 2020  quadrature.     
-0000c390: 2020 2069 6e74 6572 7661 6c2e 7175 6164     interval.quad
-0000c3a0: 7261 7475 7265 203d 2027 6761 7573 736c  rature = 'gaussl
-0000c3b0: 6567 656e 6472 6527 0a20 2020 2074 6173  egendre'.    tas
-0000c3c0: 6b73 203d 206d 616e 7962 6f64 792e 6361  ks = manybody.ca
-0000c3d0: 6c63 5f74 6173 6b73 2869 6e74 6572 7661  lc_tasks(interva
-0000c3e0: 6c73 2c20 7370 6563 7472 756d 2c20 6f63  ls, spectrum, oc
-0000c3f0: 6375 7061 7469 6f6e 290a 2020 2020 626f  cupation).    bo
-0000c400: 756e 6461 7269 6573 203d 206c 6561 6473  undaries = leads
-0000c410: 2e61 7574 6f6d 6174 6963 5f62 6f75 6e64  .automatic_bound
-0000c420: 6172 7928 7370 6563 7472 756d 2c20 746d  ary(spectrum, tm
-0000c430: 6178 290a 2020 2020 7073 695f 696e 6974  ax).    psi_init
-0000c440: 203d 206d 616e 7962 6f64 792e 6361 6c63   = manybody.calc
-0000c450: 5f69 6e69 7469 616c 5f73 7461 7465 2873  _initial_state(s
-0000c460: 7973 742c 2074 6173 6b73 2c20 626f 756e  yst, tasks, boun
-0000c470: 6461 7269 6573 2c20 7061 7261 6d73 3d70  daries, params=p
-0000c480: 6172 616d 7329 0a0a 2020 2020 7374 6174  arams)..    stat
-0000c490: 6520 3d20 6d61 6e79 626f 6479 2e57 6176  e = manybody.Wav
-0000c4a0: 6546 756e 6374 696f 6e28 7073 695f 696e  eFunction(psi_in
-0000c4b0: 6974 2c20 7461 736b 7329 0a20 2020 2073  it, tasks).    s
-0000c4c0: 7461 7465 2e65 766f 6c76 6528 7469 6d65  tate.evolve(time
-0000c4d0: 290a 2020 2020 6173 7365 7274 2073 7461  ).    assert sta
-0000c4e0: 7465 2e74 696d 6520 3d3d 2074 696d 650a  te.time == time.
-0000c4f0: 2020 2020 666f 7220 5f2c 2070 7369 2069      for _, psi i
-0000c500: 6e20 7374 6174 652e 7073 692e 5f64 6174  n state.psi._dat
-0000c510: 612e 6974 656d 7328 293a 0a20 2020 2020  a.items():.     
-0000c520: 2020 2061 7373 6572 7420 7073 692e 7469     assert psi.ti
-0000c530: 6d65 203d 3d20 7469 6d65 0a20 2020 2020  me == time.     
-0000c540: 2020 2061 7373 6572 7420 7073 692e 7061     assert psi.pa
-0000c550: 7261 6d73 203d 3d20 7b27 7627 3a20 302e  rams == {'v': 0.
-0000c560: 312c 2027 7430 273a 2030 2c20 2741 273a  1, 't0': 0, 'A':
-0000c570: 2030 2e30 3031 3537 2c20 2773 6967 6d61   0.00157, 'sigma
-0000c580: 273a 2032 347d 0a0a 2020 2020 2320 6368  ': 24}..    # ch
-0000c590: 6563 6b20 7265 7475 726e 2074 7970 652c  eck return type,
-0000c5a0: 2077 6520 6578 7065 6374 2061 6e20 6172   we expect an ar
-0000c5b0: 7261 7920 7275 6e6e 696e 6720 6f76 6572  ray running over
-0000c5c0: 2061 6c6c 2073 6974 6573 206f 7220 6a75   all sites or ju
-0000c5d0: 7374 2061 2073 696e 676c 6520 6e75 6d62  st a single numb
-0000c5e0: 6572 0a20 2020 2064 656e 7369 7479 203d  er.    density =
-0000c5f0: 2073 7461 7465 2e65 7661 6c75 6174 6528   state.evaluate(
-0000c600: 6465 6e73 6974 795f 6f70 6572 6174 6f72  density_operator
-0000c610: 290a 2020 2020 7375 6d5f 6465 6e73 6974  ).    sum_densit
-0000c620: 7920 3d20 7374 6174 652e 6576 616c 7561  y = state.evalua
-0000c630: 7465 2873 756d 5f64 656e 7369 7479 5f6f  te(sum_density_o
-0000c640: 7065 7261 746f 7229 0a20 2020 2061 7373  perator).    ass
-0000c650: 6572 7420 6973 696e 7374 616e 6365 2864  ert isinstance(d
-0000c660: 656e 7369 7479 2c20 6e70 2e6e 6461 7272  ensity, np.ndarr
-0000c670: 6179 290a 2020 2020 6173 7365 7274 2064  ay).    assert d
-0000c680: 656e 7369 7479 2e73 6861 7065 203d 3d20  ensity.shape == 
-0000c690: 286c 656e 2873 7973 742e 7369 7465 7329  (len(syst.sites)
-0000c6a0: 2c20 290a 2020 2020 6173 7365 7274 2069  , ).    assert i
-0000c6b0: 7369 6e73 7461 6e63 6528 7375 6d5f 6465  sinstance(sum_de
-0000c6c0: 6e73 6974 792c 206e 702e 6e64 6172 7261  nsity, np.ndarra
-0000c6d0: 7929 0a20 2020 2061 7373 6572 7420 7375  y).    assert su
-0000c6e0: 6d5f 6465 6e73 6974 792e 7368 6170 6520  m_density.shape 
-0000c6f0: 3d3d 2028 290a 0a20 2020 2023 2063 6865  == ()..    # che
-0000c700: 636b 2074 6861 7420 6578 7065 6374 6174  ck that expectat
-0000c710: 696f 6e20 7661 6c75 6520 666f 7220 6f6e  ion value for on
-0000c720: 6562 6f64 792f 6d61 6e79 626f 6479 2077  ebody/manybody w
-0000c730: 6176 6566 756e 6374 696f 6e20 6172 6520  avefunction are 
-0000c740: 7369 6d69 6c61 720a 2020 2020 6f6e 6562  similar.    oneb
-0000c750: 6f64 795f 6465 6e73 6974 7920 3d20 7374  ody_density = st
-0000c760: 6174 652e 6765 745f 6f6e 6562 6f64 795f  ate.get_onebody_
-0000c770: 7374 6174 6528 6b65 793d 3029 2e65 7661  state(key=0).eva
-0000c780: 6c75 6174 6528 6465 6e73 6974 795f 6f70  luate(density_op
-0000c790: 6572 6174 6f72 290a 2020 2020 6f6e 6562  erator).    oneb
-0000c7a0: 6f64 795f 7375 6d5f 6465 6e73 6974 7920  ody_sum_density 
-0000c7b0: 3d20 7374 6174 652e 6765 745f 6f6e 6562  = state.get_oneb
-0000c7c0: 6f64 795f 7374 6174 6528 6b65 793d 3029  ody_state(key=0)
-0000c7d0: 2e65 7661 6c75 6174 6528 7375 6d5f 6465  .evaluate(sum_de
-0000c7e0: 6e73 6974 795f 6f70 6572 6174 6f72 290a  nsity_operator).
-0000c7f0: 0a20 2020 2061 7373 6572 7420 6465 6e73  .    assert dens
-0000c800: 6974 792e 7368 6170 6520 3d3d 206f 6e65  ity.shape == one
-0000c810: 626f 6479 5f64 656e 7369 7479 2e73 6861  body_density.sha
-0000c820: 7065 0a20 2020 2061 7373 6572 7420 7375  pe.    assert su
-0000c830: 6d5f 6465 6e73 6974 792e 7368 6170 6520  m_density.shape 
-0000c840: 3d3d 206f 6e65 626f 6479 5f73 756d 5f64  == onebody_sum_d
-0000c850: 656e 7369 7479 2e73 6861 7065 0a0a 2020  ensity.shape..  
-0000c860: 2020 2320 544f 444f 3a20 6368 6563 6b20    # TODO: check 
-0000c870: 7175 6164 7261 7475 7265 2061 6c73 6f20  quadrature also 
-0000c880: 666f 7220 6b72 6f6e 726f 6420 6c69 6b65  for kronrod like
-0000c890: 2072 756c 6573 0a0a 2020 2020 2320 6765   rules..    # ge
-0000c8a0: 7420 616c 6c20 6b65 7973 0a20 2020 206b  t all keys.    k
-0000c8b0: 6579 7320 3d20 7374 6174 652e 6765 745f  eys = state.get_
-0000c8c0: 6b65 7973 2829 0a20 2020 2061 7373 6572  keys().    asser
-0000c8d0: 7420 6973 696e 7374 616e 6365 286b 6579  t isinstance(key
-0000c8e0: 732c 206c 6973 7429 0a20 2020 2061 7373  s, list).    ass
-0000c8f0: 6572 7420 6c65 6e28 6b65 7973 2920 3d3d  ert len(keys) ==
-0000c900: 206c 656e 2874 6173 6b73 290a 2020 2020   len(tasks).    
-0000c910: 6173 7365 7274 206e 702e 6172 7261 7928  assert np.array(
-0000c920: 5b69 7369 6e73 7461 6e63 6528 782c 2069  [isinstance(x, i
-0000c930: 6e74 2920 666f 7220 7820 696e 206b 6579  nt) for x in key
-0000c940: 735d 292e 616c 6c28 290a 0a20 2020 2023  s]).all()..    #
-0000c950: 2067 6574 2061 206e 6577 2066 7265 6520   get a new free 
-0000c960: 6b65 790a 2020 2020 6b65 7920 3d20 7374  key.    key = st
-0000c970: 6174 652e 6765 745f 6672 6565 5f6b 6579  ate.get_free_key
-0000c980: 2829 0a20 2020 2061 7373 6572 7420 6973  ().    assert is
-0000c990: 696e 7374 616e 6365 286b 6579 2c20 696e  instance(key, in
-0000c9a0: 7429 0a20 2020 2061 7373 6572 7420 6b65  t).    assert ke
-0000c9b0: 7920 6e6f 7420 696e 2073 7461 7465 2e67  y not in state.g
-0000c9c0: 6574 5f6b 6579 7328 290a 0a20 2020 2023  et_keys()..    #
-0000c9d0: 2061 6464 2061 206e 6577 206f 6e65 626f   add a new onebo
-0000c9e0: 6479 2073 7461 7465 0a20 2020 2063 6c61  dy state.    cla
-0000c9f0: 7373 2054 6173 6b3a 0a20 2020 2020 2020  ss Task:.       
-0000ca00: 2077 6569 6768 7420 3d20 302e 350a 2020   weight = 0.5.  
-0000ca10: 2020 7461 736b 203d 2054 6173 6b28 290a    task = Task().
-0000ca20: 2020 2020 7073 6920 3d20 6f6e 6562 6f64      psi = onebod
-0000ca30: 792e 5363 6174 7465 7269 6e67 5374 6174  y.ScatteringStat
-0000ca40: 6573 2873 7973 742c 206c 6561 643d 302c  es(syst, lead=0,
-0000ca50: 2065 6e65 7267 793d 322e 342c 2074 6d61   energy=2.4, tma
-0000ca60: 783d 746d 6178 2c20 7061 7261 6d73 3d70  x=tmax, params=p
-0000ca70: 6172 616d 7329 5b30 5d0a 2020 2020 2320  arams)[0].    # 
-0000ca80: 7072 696e 7428 6c65 6e28 7461 736b 7329  print(len(tasks)
-0000ca90: 290a 2020 2020 2320 7072 696e 7428 6c65  ).    # print(le
-0000caa0: 6e28 7374 6174 652e 6765 745f 6b65 7973  n(state.get_keys
-0000cab0: 2829 2929 0a20 2020 206e 6577 5f6b 6579  ())).    new_key
-0000cac0: 203d 2073 7461 7465 2e61 6464 5f6f 6e65   = state.add_one
-0000cad0: 626f 6479 5f73 7461 7465 2873 7461 7465  body_state(state
-0000cae0: 3d70 7369 2c20 7461 736b 3d74 6173 6b29  =psi, task=task)
-0000caf0: 0a20 2020 2023 2070 7269 6e74 286c 656e  .    # print(len
-0000cb00: 2874 6173 6b73 2929 0a20 2020 2023 2070  (tasks)).    # p
-0000cb10: 7269 6e74 286c 656e 2873 7461 7465 2e67  rint(len(state.g
-0000cb20: 6574 5f6b 6579 7328 2929 2920 2320 7468  et_keys())) # th
-0000cb30: 6572 6520 6973 2061 2070 726f 626c 656d  ere is a problem
-0000cb40: 2077 6974 6820 7468 6520 6c65 6e67 7468   with the length
-0000cb50: 206f 6620 7461 736b 730a 2020 2020 2320   of tasks.    # 
-0000cb60: 544f 444f 3a20 7368 6f75 6c64 2077 6520  TODO: should we 
-0000cb70: 6d61 6b65 2061 2064 6565 7020 636f 7079  make a deep copy
-0000cb80: 206f 6620 7468 6520 7461 736b 7320 6469   of the tasks di
-0000cb90: 6374 0a0a 2020 2020 2320 6164 6420 7365  ct..    # add se
-0000cba0: 7665 7261 6c20 7374 6174 6573 2061 7320  veral states as 
-0000cbb0: 6120 6469 6374 0a20 2020 206e 6577 5f74  a dict.    new_t
-0000cbc0: 6173 6b73 203d 206d 616e 7962 6f64 792e  asks = manybody.
-0000cbd0: 6361 6c63 5f74 6173 6b73 2869 6e74 6572  calc_tasks(inter
-0000cbe0: 7661 6c73 2c20 7370 6563 7472 756d 2c20  vals, spectrum, 
-0000cbf0: 6f63 6375 7061 7469 6f6e 2c20 6b65 7973  occupation, keys
-0000cc00: 3d69 7465 7274 6f6f 6c73 2e63 6f75 6e74  =itertools.count
-0000cc10: 2835 3029 290a 2020 2020 6e65 775f 7073  (50)).    new_ps
-0000cc20: 6920 3d20 6d61 6e79 626f 6479 2e63 616c  i = manybody.cal
-0000cc30: 635f 696e 6974 6961 6c5f 7374 6174 6528  c_initial_state(
-0000cc40: 7379 7374 2c20 6e65 775f 7461 736b 732c  syst, new_tasks,
-0000cc50: 2062 6f75 6e64 6172 6965 732c 2070 6172   boundaries, par
-0000cc60: 616d 733d 7061 7261 6d73 290a 2020 2020  ams=params).    
-0000cc70: 6f6c 645f 6b65 7973 203d 2073 7461 7465  old_keys = state
-0000cc80: 2e67 6574 5f6b 6579 7328 290a 2020 2020  .get_keys().    
-0000cc90: 7374 6174 652e 6164 645f 6469 7374 7269  state.add_distri
-0000cca0: 6275 7465 645f 6f6e 6562 6f64 795f 7374  buted_onebody_st
-0000ccb0: 6174 6573 2873 7461 7465 733d 6e65 775f  ates(states=new_
-0000ccc0: 7073 692c 2074 6173 6b73 3d6e 6577 5f74  psi, tasks=new_t
-0000ccd0: 6173 6b73 290a 2020 2020 6173 7365 7274  asks).    assert
-0000cce0: 206c 656e 2873 7461 7465 2e67 6574 5f6b   len(state.get_k
-0000ccf0: 6579 7328 2929 203d 3d20 6c65 6e28 6f6c  eys()) == len(ol
-0000cd00: 645f 6b65 7973 2920 2b20 6c65 6e28 6e65  d_keys) + len(ne
-0000cd10: 775f 7461 736b 7329 0a20 2020 2023 2054  w_tasks).    # T
-0000cd20: 4f44 4f3a 206d 6179 6265 2074 6872 6f77  ODO: maybe throw
-0000cd30: 2061 6e20 6572 726f 7220 6966 206b 6579   an error if key
-0000cd40: 7320 616c 7265 6164 7920 7072 6573 656e  s already presen
-0000cd50: 742c 206f 7220 6174 206c 6561 7374 2077  t, or at least w
-0000cd60: 6974 6820 666c 6167 0a0a 2020 2020 2320  ith flag..    # 
-0000cd70: 6164 6420 6120 7374 6174 6520 7769 7468  add a state with
-0000cd80: 2075 7365 7220 7072 6f76 6964 6564 206b   user provided k
-0000cd90: 6579 0a20 2020 206d 795f 6e65 775f 6b65  ey.    my_new_ke
-0000cda0: 7920 3d20 3830 0a20 2020 206e 6577 5f6b  y = 80.    new_k
-0000cdb0: 6579 203d 2073 7461 7465 2e61 6464 5f6f  ey = state.add_o
-0000cdc0: 6e65 626f 6479 5f73 7461 7465 2873 7461  nebody_state(sta
-0000cdd0: 7465 3d70 7369 2c20 7461 736b 3d74 6173  te=psi, task=tas
-0000cde0: 6b2c 206b 6579 3d6d 795f 6e65 775f 6b65  k, key=my_new_ke
-0000cdf0: 7929 0a20 2020 2061 7373 6572 7420 6e65  y).    assert ne
-0000ce00: 775f 6b65 7920 3d3d 206d 795f 6e65 775f  w_key == my_new_
-0000ce10: 6b65 790a 2020 2020 2320 7472 7920 746f  key.    # try to
-0000ce20: 2061 6464 2074 7769 6365 2077 6974 6820   add twice with 
-0000ce30: 7468 6520 7361 6d65 206b 6579 0a20 2020  the same key.   
-0000ce40: 2072 6169 7365 7328 5661 6c75 6545 7272   raises(ValueErr
-0000ce50: 6f72 2c20 7374 6174 652e 6164 645f 6f6e  or, state.add_on
-0000ce60: 6562 6f64 795f 7374 6174 652c 2073 7461  ebody_state, sta
-0000ce70: 7465 3d70 7369 2c20 7461 736b 3d74 6173  te=psi, task=tas
-0000ce80: 6b2c 206b 6579 3d6d 795f 6e65 775f 6b65  k, key=my_new_ke
-0000ce90: 7929 0a0a 2020 2020 2320 7265 7472 6965  y)..    # retrie
-0000cea0: 7665 2061 206f 6e65 626f 6479 2073 7461  ve a onebody sta
-0000ceb0: 7465 0a20 2020 206b 6579 203d 2031 0a20  te.    key = 1. 
-0000cec0: 2020 2070 7369 5f72 6574 7269 6576 6564     psi_retrieved
-0000ced0: 203d 2073 7461 7465 2e67 6574 5f6f 6e65   = state.get_one
-0000cee0: 626f 6479 5f73 7461 7465 286b 6579 3d6b  body_state(key=k
-0000cef0: 6579 290a 2020 2020 6173 7365 7274 2069  ey).    assert i
-0000cf00: 7369 6e73 7461 6e63 6528 7073 695f 7265  sinstance(psi_re
-0000cf10: 7472 6965 7665 642c 206f 6e65 626f 6479  trieved, onebody
-0000cf20: 2e57 6176 6546 756e 6374 696f 6e29 0a20  .WaveFunction). 
-0000cf30: 2020 2061 7373 6572 7420 7073 695f 7265     assert psi_re
-0000cf40: 7472 6965 7665 642e 656e 6572 6779 203d  trieved.energy =
-0000cf50: 3d20 7461 736b 735b 6b65 795d 2e65 6e65  = tasks[key].ene
-0000cf60: 7267 790a 2020 2020 2320 7472 7920 746f  rgy.    # try to
-0000cf70: 2067 6574 2061 2073 7461 7465 2074 6861   get a state tha
-0000cf80: 7420 646f 6573 206e 6f74 2065 7869 7374  t does not exist
-0000cf90: 0a20 2020 206e 6577 5f6b 6579 203d 2073  .    new_key = s
-0000cfa0: 7461 7465 2e67 6574 5f66 7265 655f 6b65  tate.get_free_ke
-0000cfb0: 7928 290a 2020 2020 7261 6973 6573 2856  y().    raises(V
-0000cfc0: 616c 7565 4572 726f 722c 2073 7461 7465  alueError, state
-0000cfd0: 2e67 6574 5f6f 6e65 626f 6479 5f73 7461  .get_onebody_sta
-0000cfe0: 7465 2c20 6b65 793d 6e65 775f 6b65 7929  te, key=new_key)
-0000cff0: 0a0a 2020 2020 2320 6465 6c65 7465 2061  ..    # delete a
-0000d000: 206f 6e65 626f 6479 2073 7461 7465 0a20   onebody state. 
-0000d010: 2020 206b 6579 203d 2034 0a20 2020 206b     key = 4.    k
-0000d020: 6579 7320 3d20 7374 6174 652e 6765 745f  eys = state.get_
-0000d030: 6b65 7973 2829 0a20 2020 2061 7373 6572  keys().    asser
-0000d040: 7420 6b65 7920 696e 206b 6579 730a 2020  t key in keys.  
-0000d050: 2020 7374 6174 652e 6465 6c65 7465 5f6f    state.delete_o
-0000d060: 6e65 626f 6479 5f73 7461 7465 286b 6579  nebody_state(key
-0000d070: 3d6b 6579 290a 2020 2020 6173 7365 7274  =key).    assert
-0000d080: 206b 6579 206e 6f74 2069 6e20 7374 6174   key not in stat
-0000d090: 652e 6765 745f 6b65 7973 2829 0a20 2020  e.get_keys().   
-0000d0a0: 2072 6169 7365 7328 5661 6c75 6545 7272   raises(ValueErr
-0000d0b0: 6f72 2c20 7374 6174 652e 6465 6c65 7465  or, state.delete
-0000d0c0: 5f6f 6e65 626f 6479 5f73 7461 7465 2c20  _onebody_state, 
-0000d0d0: 6b65 7929 2020 2320 544f 444f 3a20 7368  key)  # TODO: sh
-0000d0e0: 6f75 6c64 2077 6520 7261 6973 6520 6120  ould we raise a 
-0000d0f0: 6b65 7920 6572 726f 7220 6865 7265 3f0a  key error here?.
-0000d100: 2020 2020 6173 7365 7274 206c 656e 2873      assert len(s
-0000d110: 7461 7465 2e67 6574 5f6b 6579 7328 2929  tate.get_keys())
-0000d120: 203d 3d20 6c65 6e28 6b65 7973 2920 2d20   == len(keys) - 
-0000d130: 310a 0a20 2020 2023 2065 7661 6c75 6174  1..    # evaluat
-0000d140: 6520 616e 206f 7065 7261 746f 7220 6f6e  e an operator on
-0000d150: 6c79 206f 6e20 6120 7375 6273 6574 206f  ly on a subset o
-0000d160: 6620 7761 7665 6675 6e63 7469 6f6e 730a  f wavefunctions.
-0000d170: 2020 2020 7374 6174 652e 6576 6f6c 7665      state.evolve
-0000d180: 2874 696d 653d 3130 290a 2020 2020 6465  (time=10).    de
-0000d190: 6e73 6974 7920 3d20 7374 6174 652e 6576  nsity = state.ev
-0000d1a0: 616c 7561 7465 2864 656e 7369 7479 5f6f  aluate(density_o
-0000d1b0: 7065 7261 746f 7229 0a20 2020 2065 7665  perator).    eve
-0000d1c0: 6e5f 6b65 7973 203d 205b 6b65 7920 666f  n_keys = [key fo
-0000d1d0: 7220 6b65 7920 696e 2073 7461 7465 2e67  r key in state.g
-0000d1e0: 6574 5f6b 6579 7328 2920 6966 206e 6f74  et_keys() if not
-0000d1f0: 206b 6579 2025 2032 5d0a 2020 2020 6f64   key % 2].    od
-0000d200: 645f 6b65 7973 203d 205b 6b65 7920 666f  d_keys = [key fo
-0000d210: 7220 6b65 7920 696e 2073 7461 7465 2e67  r key in state.g
-0000d220: 6574 5f6b 6579 7328 2920 6966 206b 6579  et_keys() if key
-0000d230: 2025 2032 5d0a 0a20 2020 2064 656e 735f   % 2]..    dens_
-0000d240: 6576 656e 203d 2073 7461 7465 2e5f 6361  even = state._ca
-0000d250: 6c63 5f65 7870 6563 7461 7469 6f6e 5f76  lc_expectation_v
-0000d260: 616c 7565 2864 656e 7369 7479 5f6f 7065  alue(density_ope
-0000d270: 7261 746f 722c 206b 6579 733d 6576 656e  rator, keys=even
-0000d280: 5f6b 6579 7329 0a20 2020 2064 656e 735f  _keys).    dens_
-0000d290: 6f64 6420 3d20 7374 6174 652e 5f63 616c  odd = state._cal
-0000d2a0: 635f 6578 7065 6374 6174 696f 6e5f 7661  c_expectation_va
-0000d2b0: 6c75 6528 6465 6e73 6974 795f 6f70 6572  lue(density_oper
-0000d2c0: 6174 6f72 2c20 6b65 7973 3d6f 6464 5f6b  ator, keys=odd_k
-0000d2d0: 6579 7329 0a20 2020 2064 656e 7320 3d20  eys).    dens = 
-0000d2e0: 7374 6174 652e 5f63 616c 635f 6578 7065  state._calc_expe
-0000d2f0: 6374 6174 696f 6e5f 7661 6c75 6528 6465  ctation_value(de
-0000d300: 6e73 6974 795f 6f70 6572 6174 6f72 290a  nsity_operator).
-0000d310: 2020 2020 6173 7365 7274 5f61 7272 6179      assert_array
-0000d320: 5f61 6c6d 6f73 745f 6571 7561 6c28 6465  _almost_equal(de
-0000d330: 6e73 5f65 7665 6e20 2b20 6465 6e73 5f6f  ns_even + dens_o
-0000d340: 6464 2c20 6465 6e73 290a 2020 2020 6173  dd, dens).    as
-0000d350: 7365 7274 5f61 7272 6179 5f61 6c6d 6f73  sert_array_almos
-0000d360: 745f 6571 7561 6c28 6465 6e73 2c20 6465  t_equal(dens, de
-0000d370: 6e73 6974 7929 0a0a 2020 2020 2320 6765  nsity)..    # ge
-0000d380: 7420 7468 6520 7368 6170 6520 6f66 2074  t the shape of t
-0000d390: 6865 2077 6569 6768 7469 6e67 2066 6163  he weighting fac
-0000d3a0: 746f 720a 2020 2020 6173 7365 7274 2073  tor.    assert s
-0000d3b0: 7461 7465 2e77 6569 6768 745f 7368 6170  tate.weight_shap
-0000d3c0: 6528 2920 3d3d 2074 6173 6b73 5b30 5d2e  e() == tasks[0].
-0000d3d0: 7765 6967 6874 2e73 6861 7065 0a0a 2020  weight.shape..  
-0000d3e0: 2020 2320 6368 6563 6b20 636f 6e73 6973    # check consis
-0000d3f0: 7465 6e63 790a 2020 2020 6173 7365 7274  tency.    assert
-0000d400: 2073 7461 7465 2e5f 6368 6563 6b5f 636f   state._check_co
-0000d410: 6e73 6973 7465 6e63 7928 290a 2020 2020  nsistency().    
-0000d420: 6465 6c20 7374 6174 652e 7461 736b 735b  del state.tasks[
-0000d430: 355d 2020 2320 6d61 6b65 2073 7461 7465  5]  # make state
-0000d440: 2069 6e63 6f6e 7369 7374 656e 740a 2020   inconsistent.  
-0000d450: 2020 6173 7365 7274 2073 7461 7465 2e5f    assert state._
-0000d460: 6368 6563 6b5f 636f 6e73 6973 7465 6e63  check_consistenc
-0000d470: 7928 2920 6973 2046 616c 7365 0a0a 2020  y() is False..  
-0000d480: 2020 2320 6368 6563 6b20 7761 7665 6675    # check wavefu
-0000d490: 6e63 7469 6f6e 2077 6974 6820 7468 6520  nction with the 
-0000d4a0: 6761 7573 732d 6b72 6f6e 726f 6420 7175  gauss-kronrod qu
-0000d4b0: 6164 7261 7475 7265 0a20 2020 2066 6f72  adrature.    for
-0000d4c0: 2069 6e74 6572 7661 6c20 696e 2069 6e74   interval in int
-0000d4d0: 6572 7661 6c73 3a0a 2020 2020 2020 2020  ervals:.        
-0000d4e0: 696e 7465 7276 616c 2e71 7561 6472 6174  interval.quadrat
-0000d4f0: 7572 6520 3d20 276b 726f 6e72 6f64 270a  ure = 'kronrod'.
-0000d500: 2020 2020 7461 736b 7320 3d20 6d61 6e79      tasks = many
-0000d510: 626f 6479 2e63 616c 635f 7461 736b 7328  body.calc_tasks(
-0000d520: 696e 7465 7276 616c 732c 2073 7065 6374  intervals, spect
-0000d530: 7275 6d2c 206f 6363 7570 6174 696f 6e29  rum, occupation)
-0000d540: 0a20 2020 2062 6f75 6e64 6172 6965 7320  .    boundaries 
-0000d550: 3d20 6c65 6164 732e 6175 746f 6d61 7469  = leads.automati
-0000d560: 635f 626f 756e 6461 7279 2873 7065 6374  c_boundary(spect
-0000d570: 7275 6d2c 2074 6d61 7829 0a20 2020 2070  rum, tmax).    p
-0000d580: 7369 5f69 6e69 7420 3d20 6d61 6e79 626f  si_init = manybo
-0000d590: 6479 2e63 616c 635f 696e 6974 6961 6c5f  dy.calc_initial_
-0000d5a0: 7374 6174 6528 7379 7374 2c20 7461 736b  state(syst, task
-0000d5b0: 732c 2062 6f75 6e64 6172 6965 732c 0a20  s, boundaries,. 
-0000d5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d5e0: 2020 2020 2020 2020 2020 7061 7261 6d73            params
-0000d5f0: 3d70 6172 616d 7329 0a0a 2020 2020 7374  =params)..    st
-0000d600: 6174 6520 3d20 6d61 6e79 626f 6479 2e57  ate = manybody.W
-0000d610: 6176 6546 756e 6374 696f 6e28 7073 695f  aveFunction(psi_
-0000d620: 696e 6974 2c20 7461 736b 7329 0a20 2020  init, tasks).   
-0000d630: 2073 7461 7465 2e65 766f 6c76 6528 7469   state.evolve(ti
-0000d640: 6d65 290a 0a20 2020 2023 2063 6865 636b  me)..    # check
-0000d650: 2072 6574 7572 6e20 7479 7065 2c20 7765   return type, we
-0000d660: 2065 7870 6563 7420 616e 2061 7272 6179   expect an array
-0000d670: 2072 756e 6e69 6e67 206f 7665 7220 616c   running over al
-0000d680: 6c20 7369 7465 7320 6f72 206a 7573 7420  l sites or just 
-0000d690: 6120 7369 6e67 6c65 206e 756d 6265 720a  a single number.
-0000d6a0: 2020 2020 6465 6e73 6974 7920 3d20 7374      density = st
-0000d6b0: 6174 652e 6576 616c 7561 7465 2864 656e  ate.evaluate(den
-0000d6c0: 7369 7479 5f6f 7065 7261 746f 7229 0a20  sity_operator). 
-0000d6d0: 2020 2073 756d 5f64 656e 7369 7479 203d     sum_density =
-0000d6e0: 2073 7461 7465 2e65 7661 6c75 6174 6528   state.evaluate(
-0000d6f0: 7375 6d5f 6465 6e73 6974 795f 6f70 6572  sum_density_oper
-0000d700: 6174 6f72 290a 0a20 2020 2061 7373 6572  ator)..    asser
-0000d710: 7420 6973 696e 7374 616e 6365 2864 656e  t isinstance(den
-0000d720: 7369 7479 2c20 6e70 2e6e 6461 7272 6179  sity, np.ndarray
-0000d730: 290a 2020 2020 6173 7365 7274 2064 656e  ).    assert den
-0000d740: 7369 7479 2e73 6861 7065 203d 3d20 2832  sity.shape == (2
-0000d750: 2c20 6c65 6e28 7379 7374 2e73 6974 6573  , len(syst.sites
-0000d760: 2929 0a20 2020 2061 7373 6572 7420 6973  )).    assert is
-0000d770: 696e 7374 616e 6365 2873 756d 5f64 656e  instance(sum_den
-0000d780: 7369 7479 2c20 6e70 2e6e 6461 7272 6179  sity, np.ndarray
-0000d790: 290a 2020 2020 6173 7365 7274 2073 756d  ).    assert sum
-0000d7a0: 5f64 656e 7369 7479 2e73 6861 7065 203d  _density.shape =
-0000d7b0: 3d20 2832 2c29 0a0a 2020 2020 2320 6368  = (2,)..    # ch
-0000d7c0: 6563 6b20 7468 6174 2069 6620 7765 2061  eck that if we a
-0000d7d0: 6464 2061 2073 7461 7465 2077 6974 6820  dd a state with 
-0000d7e0: 6120 7765 6967 6874 2073 6861 7065 206d  a weight shape m
-0000d7f0: 6973 6d61 7463 682c 2074 6861 7420 6974  ismatch, that it
-0000d800: 2063 7261 7368 6573 0a20 2020 2023 2054   crashes.    # T
-0000d810: 4f44 4f3a 2074 6869 7320 7368 6f75 6c64  ODO: this should
-0000d820: 2066 6169 6c2c 206d 6179 6265 206f 6e65   fail, maybe one
-0000d830: 2073 686f 756c 6420 6769 7665 2061 2063   should give a c
-0000d840: 6c65 6172 2065 7272 6f72 206d 6573 7361  lear error messa
-0000d850: 6765 2061 6e64 2063 6865 636b 2066 6f72  ge and check for
-0000d860: 2074 6861 7420 6361 7365 0a20 2020 2063   that case.    c
-0000d870: 6c61 7373 2054 6173 6b3a 0a20 2020 2020  lass Task:.     
-0000d880: 2020 2077 6569 6768 7420 3d20 302e 3520     weight = 0.5 
-0000d890: 2023 206e 6f74 2063 6f6d 7061 7469 626c   # not compatibl
-0000d8a0: 6520 746f 206b 726f 6e72 6f64 2077 6569  e to kronrod wei
-0000d8b0: 6768 7420 6172 7261 790a 2020 2020 7461  ght array.    ta
-0000d8c0: 736b 203d 2054 6173 6b28 290a 2020 2020  sk = Task().    
-0000d8d0: 7073 6920 3d20 6f6e 6562 6f64 792e 5363  psi = onebody.Sc
-0000d8e0: 6174 7465 7269 6e67 5374 6174 6573 2873  atteringStates(s
-0000d8f0: 7973 742c 206c 6561 643d 302c 2065 6e65  yst, lead=0, ene
-0000d900: 7267 793d 322e 342c 2074 6d61 783d 746d  rgy=2.4, tmax=tm
-0000d910: 6178 2c20 7061 7261 6d73 3d70 6172 616d  ax, params=param
-0000d920: 7329 5b30 5d0a 2020 2020 6e65 775f 6b65  s)[0].    new_ke
-0000d930: 7920 3d20 7374 6174 652e 6164 645f 6f6e  y = state.add_on
-0000d940: 6562 6f64 795f 7374 6174 6528 7374 6174  ebody_state(stat
-0000d950: 653d 7073 692c 2074 6173 6b3d 7461 736b  e=psi, task=task
-0000d960: 290a 2020 2020 6465 6e73 6974 7920 3d20  ).    density = 
-0000d970: 7374 6174 652e 6576 616c 7561 7465 2864  state.evaluate(d
-0000d980: 656e 7369 7479 5f6f 7065 7261 746f 7229  ensity_operator)
-0000d990: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
-0000d9a0: 696e 7465 6774 6573 740a 6465 6620 7465  integtest.def te
-0000d9b0: 7374 5f6d 616e 7962 6f64 795f 6e6f 726d  st_manybody_norm
-0000d9c0: 616c 697a 6174 696f 6e28 293a 0a0a 2020  alization():..  
-0000d9d0: 2020 2320 696e 7465 6772 6174 696e 6720    # integrating 
-0000d9e0: 6f76 6572 2061 6c6c 2065 6e65 7267 6965  over all energie
-0000d9f0: 7320 616e 6420 6c65 6164 732c 2074 6865  s and leads, the
-0000da00: 2064 656e 7369 7479 0a20 2020 2023 2073   density.    # s
-0000da10: 686f 756c 6420 6265 2031 206f 6e20 616c  hould be 1 on al
-0000da20: 6c20 7369 7465 7320 616e 6420 666f 7220  l sites and for 
-0000da30: 616c 6c20 7469 6d65 730a 0a20 2020 2073  all times..    s
-0000da40: 7973 7420 3d20 6d61 6b65 5f73 7973 7465  yst = make_syste
-0000da50: 6d28 573d 3329 2e66 696e 616c 697a 6564  m(W=3).finalized
-0000da60: 2829 0a20 2020 2064 656e 7369 7479 5f6f  ().    density_o
-0000da70: 7065 7261 746f 7220 3d20 6b77 616e 742e  perator = kwant.
-0000da80: 6f70 6572 6174 6f72 2e44 656e 7369 7479  operator.Density
-0000da90: 2873 7973 7429 0a0a 2020 2020 6368 656d  (syst)..    chem
-0000daa0: 6963 616c 5f70 6f74 656e 7469 616c 203d  ical_potential =
-0000dab0: 2031 3030 2020 2320 736f 6d65 2076 616c   100  # some val
-0000dac0: 7565 206c 6172 6765 7220 7468 616e 2061  ue larger than a
-0000dad0: 6e79 2062 616e 6420 656e 6572 6779 0a20  ny band energy. 
-0000dae0: 2020 2074 6d61 7820 3d20 3130 0a20 2020     tmax = 10.   
-0000daf0: 2070 6172 616d 7320 3d20 7b27 7627 3a20   params = {'v': 
-0000db00: 302e 3030 3031 2c20 2774 3027 3a20 302c  0.0001, 't0': 0,
-0000db10: 2027 4127 3a20 302e 3030 3135 372c 2027   'A': 0.00157, '
-0000db20: 7369 676d 6127 3a20 3234 7d0a 0a20 2020  sigma': 24}..   
-0000db30: 206f 6363 7570 6174 696f 6e20 3d20 6d61   occupation = ma
-0000db40: 6e79 626f 6479 2e6c 6561 645f 6f63 6375  nybody.lead_occu
-0000db50: 7061 7469 6f6e 2863 6865 6d69 6361 6c5f  pation(chemical_
-0000db60: 706f 7465 6e74 6961 6c29 0a0a 2020 2020  potential)..    
-0000db70: 7370 6563 7472 756d 203d 206b 7761 6e74  spectrum = kwant
-0000db80: 7370 6563 7472 756d 2e73 7065 6374 7261  spectrum.spectra
-0000db90: 2873 7973 742e 6c65 6164 7329 0a20 2020  (syst.leads).   
-0000dba0: 2069 6e74 6572 7661 6c73 203d 206d 616e   intervals = man
-0000dbb0: 7962 6f64 792e 6361 6c63 5f69 6e74 6572  ybody.calc_inter
-0000dbc0: 7661 6c73 2873 7065 6374 7275 6d2c 206f  vals(spectrum, o
-0000dbd0: 6363 7570 6174 696f 6e29 0a20 2020 2074  ccupation).    t
-0000dbe0: 6173 6b73 203d 206d 616e 7962 6f64 792e  asks = manybody.
-0000dbf0: 6361 6c63 5f74 6173 6b73 2869 6e74 6572  calc_tasks(inter
-0000dc00: 7661 6c73 2c20 7370 6563 7472 756d 2c20  vals, spectrum, 
-0000dc10: 6f63 6375 7061 7469 6f6e 290a 2020 2020  occupation).    
-0000dc20: 626f 756e 6461 7269 6573 203d 206c 6561  boundaries = lea
-0000dc30: 6473 2e61 7574 6f6d 6174 6963 5f62 6f75  ds.automatic_bou
-0000dc40: 6e64 6172 7928 7370 6563 7472 756d 2c20  ndary(spectrum, 
-0000dc50: 746d 6178 290a 2020 2020 7073 695f 696e  tmax).    psi_in
-0000dc60: 6974 203d 206d 616e 7962 6f64 792e 6361  it = manybody.ca
-0000dc70: 6c63 5f69 6e69 7469 616c 5f73 7461 7465  lc_initial_state
-0000dc80: 2873 7973 742c 2074 6173 6b73 2c20 626f  (syst, tasks, bo
-0000dc90: 756e 6461 7269 6573 2c20 7061 7261 6d73  undaries, params
-0000dca0: 3d70 6172 616d 7329 0a20 2020 2077 6620  =params).    wf 
-0000dcb0: 3d20 6d61 6e79 626f 6479 2e57 6176 6546  = manybody.WaveF
-0000dcc0: 756e 6374 696f 6e28 7073 695f 696e 6974  unction(psi_init
-0000dcd0: 2c20 7461 736b 7329 0a0a 2020 2020 666f  , tasks)..    fo
-0000dce0: 7220 7469 6d65 2069 6e20 5b30 2c20 352c  r time in [0, 5,
-0000dcf0: 2031 305d 3a0a 2020 2020 2020 2020 7766   10]:.        wf
-0000dd00: 2e65 766f 6c76 6528 7469 6d65 290a 2020  .evolve(time).  
-0000dd10: 2020 2020 2020 6465 6e73 6974 7920 3d20        density = 
-0000dd20: 7766 2e65 7661 6c75 6174 6528 6465 6e73  wf.evaluate(dens
-0000dd30: 6974 795f 6f70 6572 6174 6f72 290a 2020  ity_operator).  
-0000dd40: 2020 2020 2020 6173 7365 7274 5f61 7272        assert_arr
-0000dd50: 6179 5f61 6c6d 6f73 745f 6571 7561 6c28  ay_almost_equal(
-0000dd60: 6465 6e73 6974 792c 2031 2c20 6465 6369  density, 1, deci
-0000dd70: 6d61 6c3d 3229 0a0a 0a40 7079 7465 7374  mal=2)...@pytest
-0000dd80: 2e6d 6172 6b2e 696e 7465 6774 6573 740a  .mark.integtest.
-0000dd90: 6465 6620 7465 7374 5f73 696d 706c 655f  def test_simple_
-0000dda0: 6d61 6e79 626f 6479 5f72 6567 7265 7373  manybody_regress
-0000ddb0: 696f 6e28 293a 0a0a 2020 2020 2320 6120  ion():..    # a 
-0000ddc0: 7369 6d70 6c65 2072 6567 7265 7373 696f  simple regressio
-0000ddd0: 6e20 7465 7374 2074 6f20 6d61 6b65 2073  n test to make s
-0000dde0: 7572 6520 7468 6174 2074 6865 2072 6573  ure that the res
-0000ddf0: 756c 7420 646f 6573 206e 6f74 2063 6861  ult does not cha
-0000de00: 6e67 650a 2020 2020 2320 6f76 6572 2074  nge.    # over t
-0000de10: 6865 2074 696d 650a 0a20 2020 2073 7973  he time..    sys
-0000de20: 7420 3d20 6d61 6b65 5f73 7973 7465 6d28  t = make_system(
-0000de30: 573d 3329 2e66 696e 616c 697a 6564 2829  W=3).finalized()
-0000de40: 0a20 2020 2064 656e 7369 7479 5f6f 7065  .    density_ope
-0000de50: 7261 746f 7220 3d20 6b77 616e 742e 6f70  rator = kwant.op
-0000de60: 6572 6174 6f72 2e44 656e 7369 7479 2873  erator.Density(s
-0000de70: 7973 742c 2073 756d 3d54 7275 6529 0a0a  yst, sum=True)..
-0000de80: 2020 2020 6368 656d 6963 616c 5f70 6f74      chemical_pot
-0000de90: 656e 7469 616c 203d 2035 0a20 2020 2074  ential = 5.    t
-0000dea0: 6d61 7820 3d20 3230 0a20 2020 2070 6172  max = 20.    par
-0000deb0: 616d 7320 3d20 7b27 7627 3a20 302e 312c  ams = {'v': 0.1,
-0000dec0: 2027 7430 273a 2030 2c20 2741 273a 2030   't0': 0, 'A': 0
-0000ded0: 2e31 3537 2c20 2773 6967 6d61 273a 2032  .157, 'sigma': 2
-0000dee0: 347d 0a0a 2020 2020 6f63 6375 7061 7469  4}..    occupati
-0000def0: 6f6e 203d 206d 616e 7962 6f64 792e 6c65  on = manybody.le
-0000df00: 6164 5f6f 6363 7570 6174 696f 6e28 6368  ad_occupation(ch
-0000df10: 656d 6963 616c 5f70 6f74 656e 7469 616c  emical_potential
-0000df20: 290a 0a20 2020 2073 7065 6374 7275 6d20  )..    spectrum 
-0000df30: 3d20 6b77 616e 7473 7065 6374 7275 6d2e  = kwantspectrum.
-0000df40: 7370 6563 7472 6128 7379 7374 2e6c 6561  spectra(syst.lea
-0000df50: 6473 290a 2020 2020 696e 7465 7276 616c  ds).    interval
-0000df60: 7320 3d20 6d61 6e79 626f 6479 2e63 616c  s = manybody.cal
-0000df70: 635f 696e 7465 7276 616c 7328 7370 6563  c_intervals(spec
-0000df80: 7472 756d 2c20 6f63 6375 7061 7469 6f6e  trum, occupation
-0000df90: 290a 2020 2020 7461 736b 7320 3d20 6d61  ).    tasks = ma
-0000dfa0: 6e79 626f 6479 2e63 616c 635f 7461 736b  nybody.calc_task
-0000dfb0: 7328 696e 7465 7276 616c 732c 2073 7065  s(intervals, spe
-0000dfc0: 6374 7275 6d2c 206f 6363 7570 6174 696f  ctrum, occupatio
-0000dfd0: 6e29 0a20 2020 2062 6f75 6e64 6172 6965  n).    boundarie
-0000dfe0: 7320 3d20 6c65 6164 732e 6175 746f 6d61  s = leads.automa
-0000dff0: 7469 635f 626f 756e 6461 7279 2873 7065  tic_boundary(spe
-0000e000: 6374 7275 6d2c 2074 6d61 7829 0a20 2020  ctrum, tmax).   
-0000e010: 2070 7369 5f69 6e69 7420 3d20 6d61 6e79   psi_init = many
-0000e020: 626f 6479 2e63 616c 635f 696e 6974 6961  body.calc_initia
-0000e030: 6c5f 7374 6174 6528 7379 7374 2c20 7461  l_state(syst, ta
-0000e040: 736b 732c 2062 6f75 6e64 6172 6965 732c  sks, boundaries,
-0000e050: 2070 6172 616d 733d 7061 7261 6d73 290a   params=params).
-0000e060: 2020 2020 7766 203d 206d 616e 7962 6f64      wf = manybod
-0000e070: 792e 5761 7665 4675 6e63 7469 6f6e 2870  y.WaveFunction(p
-0000e080: 7369 5f69 6e69 742c 2074 6173 6b73 290a  si_init, tasks).
-0000e090: 0a20 2020 2072 6566 5f64 656e 7369 7469  .    ref_densiti
-0000e0a0: 6573 203d 205b 3533 2e33 3230 3036 3737  es = [53.3200677
-0000e0b0: 3930 3632 3834 3634 2c20 3234 2e33 3132  90628464, 24.312
-0000e0c0: 3435 3436 3036 3531 3530 3735 2c20 3831  454606515075, 81
-0000e0d0: 2e30 3431 3439 3832 3138 3236 3333 385d  .04149821826338]
-0000e0e0: 0a20 2020 2066 6f72 2069 2c20 7469 6d65  .    for i, time
-0000e0f0: 2069 6e20 656e 756d 6572 6174 6528 5b30   in enumerate([0
-0000e100: 2c20 3130 2c20 3230 5d29 3a0a 2020 2020  , 10, 20]):.    
-0000e110: 2020 2020 7766 2e65 766f 6c76 6528 7469      wf.evolve(ti
-0000e120: 6d65 290a 2020 2020 2020 2020 6465 6e73  me).        dens
-0000e130: 6974 7920 3d20 7766 2e65 7661 6c75 6174  ity = wf.evaluat
-0000e140: 6528 6465 6e73 6974 795f 6f70 6572 6174  e(density_operat
-0000e150: 6f72 295b 315d 0a20 2020 2020 2020 2061  or)[1].        a
-0000e160: 7373 6572 745f 616c 6d6f 7374 5f65 7175  ssert_almost_equ
-0000e170: 616c 2864 656e 7369 7479 2c20 7265 665f  al(density, ref_
-0000e180: 6465 6e73 6974 6965 735b 695d 2c20 6465  densities[i], de
-0000e190: 6369 6d61 6c3d 3629 0a0a 0a23 202d 2d2d  cimal=6)...# ---
-0000e1a0: 2d20 6368 6563 6b20 7374 6174 650a 4070  - check state.@p
-0000e1b0: 7974 6573 742e 6d61 726b 2e69 6e74 6567  ytest.mark.integ
-0000e1c0: 7465 7374 2020 2320 6d61 726b 6572 2066  test  # marker f
-0000e1d0: 6f72 2069 6e74 6567 7261 7469 6f6e 2074  or integration t
-0000e1e0: 6573 7473 0a64 6566 2074 6573 745f 6d61  ests.def test_ma
-0000e1f0: 6e79 626f 6479 5f73 7461 7465 2829 3a0a  nybody_state():.
-0000e200: 0a20 2020 2073 7973 7420 3d20 6d61 6b65  .    syst = make
-0000e210: 5f73 7973 7465 6d28 292e 6669 6e61 6c69  _system().finali
-0000e220: 7a65 6428 290a 2020 2020 6465 6e73 6974  zed().    densit
-0000e230: 795f 6f70 6572 6174 6f72 203d 206b 7761  y_operator = kwa
-0000e240: 6e74 2e6f 7065 7261 746f 722e 4465 6e73  nt.operator.Dens
-0000e250: 6974 7928 7379 7374 290a 0a20 2020 2063  ity(syst)..    c
-0000e260: 6865 6d69 6361 6c5f 706f 7465 6e74 6961  hemical_potentia
-0000e270: 6c20 3d20 330a 2020 2020 746d 6178 203d  l = 3.    tmax =
-0000e280: 2035 3030 0a20 2020 2074 696d 6520 3d20   500.    time = 
-0000e290: 350a 2020 2020 7061 7261 6d73 203d 207b  5.    params = {
-0000e2a0: 2776 273a 2030 2e30 3030 312c 2027 7430  'v': 0.0001, 't0
-0000e2b0: 273a 2030 2c20 2741 273a 2030 2e30 3031  ': 0, 'A': 0.001
-0000e2c0: 3537 2c20 2773 6967 6d61 273a 2032 347d  57, 'sigma': 24}
-0000e2d0: 0a0a 2020 2020 6f63 6375 7061 7469 6f6e  ..    occupation
-0000e2e0: 203d 206d 616e 7962 6f64 792e 6c65 6164   = manybody.lead
-0000e2f0: 5f6f 6363 7570 6174 696f 6e28 6368 656d  _occupation(chem
-0000e300: 6963 616c 5f70 6f74 656e 7469 616c 290a  ical_potential).
-0000e310: 0a20 2020 2023 2072 6566 6572 656e 6365  .    # reference
-0000e320: 2072 6573 756c 7420 7769 7468 2074 6865   result with the
-0000e330: 206d 616e 7962 6f64 7920 7761 7665 6675   manybody wavefu
-0000e340: 6e63 7469 6f6e 0a20 2020 2073 7065 6374  nction.    spect
-0000e350: 7275 6d20 3d20 6b77 616e 7473 7065 6374  rum = kwantspect
-0000e360: 7275 6d2e 7370 6563 7472 6128 7379 7374  rum.spectra(syst
-0000e370: 2e6c 6561 6473 290a 2020 2020 696e 7465  .leads).    inte
-0000e380: 7276 616c 7320 3d20 6d61 6e79 626f 6479  rvals = manybody
-0000e390: 2e63 616c 635f 696e 7465 7276 616c 7328  .calc_intervals(
-0000e3a0: 7370 6563 7472 756d 2c20 6f63 6375 7061  spectrum, occupa
-0000e3b0: 7469 6f6e 290a 2020 2020 7461 736b 7320  tion).    tasks 
-0000e3c0: 3d20 6d61 6e79 626f 6479 2e63 616c 635f  = manybody.calc_
-0000e3d0: 7461 736b 7328 696e 7465 7276 616c 732c  tasks(intervals,
-0000e3e0: 2073 7065 6374 7275 6d2c 206f 6363 7570   spectrum, occup
-0000e3f0: 6174 696f 6e29 0a20 2020 2062 6f75 6e64  ation).    bound
-0000e400: 6172 6965 7320 3d20 6c65 6164 732e 6175  aries = leads.au
-0000e410: 746f 6d61 7469 635f 626f 756e 6461 7279  tomatic_boundary
-0000e420: 2873 7065 6374 7275 6d2c 2074 6d61 7829  (spectrum, tmax)
-0000e430: 0a20 2020 2070 7369 5f69 6e69 7420 3d20  .    psi_init = 
-0000e440: 6d61 6e79 626f 6479 2e63 616c 635f 696e  manybody.calc_in
-0000e450: 6974 6961 6c5f 7374 6174 6528 7379 7374  itial_state(syst
-0000e460: 2c20 7461 736b 732c 2062 6f75 6e64 6172  , tasks, boundar
-0000e470: 6965 732c 2070 6172 616d 733d 7061 7261  ies, params=para
-0000e480: 6d73 290a 2020 2020 7766 203d 206d 616e  ms).    wf = man
-0000e490: 7962 6f64 792e 5761 7665 4675 6e63 7469  ybody.WaveFuncti
-0000e4a0: 6f6e 2870 7369 5f69 6e69 742c 2074 6173  on(psi_init, tas
-0000e4b0: 6b73 290a 2020 2020 7766 2e65 766f 6c76  ks).    wf.evolv
-0000e4c0: 6528 7469 6d65 290a 2020 2020 6465 6e73  e(time).    dens
-0000e4d0: 6974 795f 7766 203d 2077 662e 6576 616c  ity_wf = wf.eval
-0000e4e0: 7561 7465 2864 656e 7369 7479 5f6f 7065  uate(density_ope
-0000e4f0: 7261 746f 7229 5b31 5d0a 0a20 2020 2023  rator)[1]..    #
-0000e500: 206d 616e 7962 6f64 7920 7374 6174 650a   manybody state.
-0000e510: 2020 2020 7374 6174 6520 3d20 6d61 6e79      state = many
-0000e520: 626f 6479 2e53 7461 7465 2873 7973 742c  body.State(syst,
-0000e530: 2074 6d61 782c 206f 6363 7570 6174 696f   tmax, occupatio
-0000e540: 6e2c 2070 6172 616d 733d 7061 7261 6d73  n, params=params
-0000e550: 2c20 7265 6669 6e65 3d46 616c 7365 290a  , refine=False).
-0000e560: 0a20 2020 2073 7461 7465 2e65 766f 6c76  .    state.evolv
-0000e570: 6528 7469 6d65 290a 2020 2020 6173 7365  e(time).    asse
-0000e580: 7274 2073 7461 7465 2e74 696d 6520 3d3d  rt state.time ==
-0000e590: 2074 696d 650a 2020 2020 2320 7468 6520   time.    # the 
-0000e5a0: 6d61 6e79 626f 6479 2073 7461 7465 2068  manybody state h
-0000e5b0: 6173 206e 6f20 7075 626c 6963 2070 6172  as no public par
-0000e5c0: 616d 7320 7374 6f72 6564 2c20 6f6e 6c79  ams stored, only
-0000e5d0: 2065 6163 6820 6f6e 6562 6f64 7920 7374   each onebody st
-0000e5e0: 6174 650a 2020 2020 2320 6861 7320 6120  ate.    # has a 
-0000e5f0: 7075 626c 6963 2070 6172 616d 7320 6469  public params di
-0000e600: 6374 696f 6e61 7279 0a20 2020 2066 6f72  ctionary.    for
-0000e610: 205f 2c20 7073 6920 696e 2073 7461 7465   _, psi in state
-0000e620: 2e6d 616e 7962 6f64 795f 7761 7665 6675  .manybody_wavefu
-0000e630: 6e63 7469 6f6e 2e70 7369 2e5f 6461 7461  nction.psi._data
-0000e640: 2e69 7465 6d73 2829 3a0a 2020 2020 2020  .items():.      
-0000e650: 2020 6173 7365 7274 2070 7369 2e74 696d    assert psi.tim
-0000e660: 6520 3d3d 2074 696d 650a 2020 2020 2020  e == time.      
-0000e670: 2020 6173 7365 7274 2070 7369 2e70 6172    assert psi.par
-0000e680: 616d 7320 3d3d 207b 2776 273a 2030 2e30  ams == {'v': 0.0
-0000e690: 3030 312c 2027 7430 273a 2030 2c20 2741  001, 't0': 0, 'A
-0000e6a0: 273a 2030 2e30 3031 3537 2c20 2773 6967  ': 0.00157, 'sig
-0000e6b0: 6d61 273a 2032 347d 0a0a 2020 2020 2320  ma': 24}..    # 
-0000e6c0: 6368 6563 6b20 7468 6174 2072 6573 756c  check that resul
-0000e6d0: 7420 6973 2073 696d 696c 6172 2074 6f20  t is similar to 
-0000e6e0: 7265 6665 7265 6e63 6520 7265 7375 6c74  reference result
-0000e6f0: 0a20 2020 2064 656e 7369 7479 203d 2073  .    density = s
-0000e700: 7461 7465 2e65 7661 6c75 6174 6528 6465  tate.evaluate(de
-0000e710: 6e73 6974 795f 6f70 6572 6174 6f72 290a  nsity_operator).
-0000e720: 2020 2020 6173 7365 7274 5f61 7272 6179      assert_array
-0000e730: 5f61 6c6d 6f73 745f 6571 7561 6c28 6465  _almost_equal(de
-0000e740: 6e73 6974 792c 2064 656e 7369 7479 5f77  nsity, density_w
-0000e750: 6629 0a0a 2020 2020 2320 2d2d 2074 6573  f)..    # -- tes
-0000e760: 7420 6765 745f 696e 7465 7276 616c 730a  t get_intervals.
-0000e770: 2020 2020 696e 7465 7276 616c 7320 3d20      intervals = 
-0000e780: 7374 6174 652e 6765 745f 696e 7465 7276  state.get_interv
-0000e790: 616c 7328 290a 2020 2020 6173 7365 7274  als().    assert
-0000e7a0: 2069 7369 6e73 7461 6e63 6528 696e 7465   isinstance(inte
-0000e7b0: 7276 616c 732c 206c 6973 7429 0a20 2020  rvals, list).   
-0000e7c0: 2061 7373 6572 7420 6e70 2e61 7272 6179   assert np.array
-0000e7d0: 285b 6973 696e 7374 616e 6365 2878 2c20  ([isinstance(x, 
-0000e7e0: 6d61 6e79 626f 6479 2e49 6e74 6572 7661  manybody.Interva
-0000e7f0: 6c29 2066 6f72 2078 2069 6e20 696e 7465  l) for x in inte
-0000e800: 7276 616c 735d 292e 616c 6c28 290a 0a20  rvals]).all().. 
-0000e810: 2020 2023 202d 2d20 7465 7374 2065 7374     # -- test est
-0000e820: 696d 6174 655f 6572 726f 720a 2020 2020  imate_error.    
-0000e830: 6572 726f 725f 7065 725f 696e 7465 7276  error_per_interv
-0000e840: 616c 203d 2073 7461 7465 2e65 7374 696d  al = state.estim
-0000e850: 6174 655f 6572 726f 7228 696e 7465 7276  ate_error(interv
-0000e860: 616c 733d 696e 7465 7276 616c 7329 0a20  als=intervals). 
-0000e870: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
-0000e880: 616e 6365 2865 7272 6f72 5f70 6572 5f69  ance(error_per_i
-0000e890: 6e74 6572 7661 6c2c 206e 702e 6e64 6172  nterval, np.ndar
-0000e8a0: 7261 7929 0a20 2020 2061 7373 6572 7420  ray).    assert 
-0000e8b0: 6c65 6e28 6572 726f 725f 7065 725f 696e  len(error_per_in
-0000e8c0: 7465 7276 616c 2920 3d3d 206c 656e 2869  terval) == len(i
-0000e8d0: 6e74 6572 7661 6c73 290a 2020 2020 6173  ntervals).    as
-0000e8e0: 7365 7274 206e 702e 6172 7261 7928 5b69  sert np.array([i
-0000e8f0: 7369 6e73 7461 6e63 6528 782c 2066 6c6f  sinstance(x, flo
-0000e900: 6174 2920 666f 7220 7820 696e 2065 7272  at) for x in err
-0000e910: 6f72 5f70 6572 5f69 6e74 6572 7661 6c5d  or_per_interval]
-0000e920: 292e 616c 6c28 290a 0a20 2020 2065 7272  ).all()..    err
-0000e930: 5f73 756d 203d 2030 0a20 2020 2066 6f72  _sum = 0.    for
-0000e940: 2069 2c20 696e 7465 7276 616c 2069 6e20   i, interval in 
-0000e950: 656e 756d 6572 6174 6528 696e 7465 7276  enumerate(interv
-0000e960: 616c 7329 3a0a 2020 2020 2020 2020 6572  als):.        er
-0000e970: 726f 7220 3d20 7374 6174 652e 6573 7469  ror = state.esti
-0000e980: 6d61 7465 5f65 7272 6f72 2869 6e74 6572  mate_error(inter
-0000e990: 7661 6c73 3d69 6e74 6572 7661 6c29 0a20  vals=interval). 
-0000e9a0: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
-0000e9b0: 696e 7374 616e 6365 2865 7272 6f72 2c20  instance(error, 
-0000e9c0: 666c 6f61 7429 0a20 2020 2020 2020 2061  float).        a
-0000e9d0: 7373 6572 7420 6572 726f 7220 3d3d 2065  ssert error == e
-0000e9e0: 7272 6f72 5f70 6572 5f69 6e74 6572 7661  rror_per_interva
-0000e9f0: 6c5b 695d 0a20 2020 2020 2020 2065 7272  l[i].        err
-0000ea00: 5f73 756d 202b 3d20 7374 6174 652e 6573  _sum += state.es
-0000ea10: 7469 6d61 7465 5f65 7272 6f72 2869 6e74  timate_error(int
-0000ea20: 6572 7661 6c73 3d69 6e74 6572 7661 6c2c  ervals=interval,
-0000ea30: 2066 756c 6c5f 6f75 7470 7574 3d54 7275   full_output=Tru
-0000ea40: 6529 0a20 2020 2020 2020 2061 7373 6572  e).        asser
-0000ea50: 7420 6973 696e 7374 616e 6365 2865 7272  t isinstance(err
-0000ea60: 5f73 756d 2c20 6e70 2e6e 6461 7272 6179  _sum, np.ndarray
-0000ea70: 290a 0a20 2020 2023 2074 6865 2074 6f74  )..    # the tot
-0000ea80: 616c 2065 7272 6f72 2069 7320 4e4f 5420  al error is NOT 
-0000ea90: 7468 6520 7375 6d20 6f66 2069 6e74 6572  the sum of inter
-0000eaa0: 7661 6c20 6572 726f 7273 2028 7472 6961  val errors (tria
-0000eab0: 6e67 6c65 2069 6e65 7175 616c 6974 7929  ngle inequality)
-0000eac0: 0a20 2020 2074 6f74 616c 5f65 7272 6f72  .    total_error
-0000ead0: 203d 2073 7461 7465 2e65 7374 696d 6174   = state.estimat
-0000eae0: 655f 6572 726f 7228 290a 2020 2020 6173  e_error().    as
-0000eaf0: 7365 7274 206e 702e 616c 6c63 6c6f 7365  sert np.allclose
-0000eb00: 2874 6f74 616c 5f65 7272 6f72 2c20 6e70  (total_error, np
-0000eb10: 2e6d 6178 2865 7272 5f73 756d 2929 0a0a  .max(err_sum))..
-0000eb20: 2020 2020 2320 2d2d 2075 6e6b 6e6f 776e      # -- unknown
-0000eb30: 2069 6e74 6572 7661 6c20 7368 6f75 6c64   interval should
-0000eb40: 2072 6169 7365 2061 6e20 6572 726f 720a   raise an error.
-0000eb50: 2020 2020 696e 7465 7276 616c 203d 2069      interval = i
-0000eb60: 6e74 6572 7661 6c73 5b30 5d0a 2020 2020  ntervals[0].    
-0000eb70: 696e 7465 7276 616c 2e6b 6d69 6e20 2b3d  interval.kmin +=
-0000eb80: 2030 2e35 202a 2028 696e 7465 7276 616c   0.5 * (interval
-0000eb90: 2e6b 6d61 7820 2d20 696e 7465 7276 616c  .kmax - interval
-0000eba0: 2e6b 6d69 6e29 0a20 2020 2072 6169 7365  .kmin).    raise
-0000ebb0: 7328 4b65 7945 7272 6f72 2c20 7374 6174  s(KeyError, stat
-0000ebc0: 652e 6573 7469 6d61 7465 5f65 7272 6f72  e.estimate_error
-0000ebd0: 2c20 696e 7465 7276 616c 733d 696e 7465  , intervals=inte
-0000ebe0: 7276 616c 290a 0a20 2020 2023 202d 2d20  rval)..    # -- 
-0000ebf0: 7465 7374 2072 6566 696e 655f 696e 7465  test refine_inte
-0000ec00: 7276 616c 730a 2020 2020 2320 2d2d 2074  rvals.    # -- t
-0000ec10: 6573 7420 7469 6d65 2062 6566 6f72 6520  est time before 
-0000ec20: 7265 6669 6e69 6e67 2074 6865 2069 6e74  refining the int
-0000ec30: 6572 7661 6c73 0a20 2020 2066 6f72 206b  ervals.    for k
-0000ec40: 6579 2069 6e20 7374 6174 652e 6d61 6e79  ey in state.many
-0000ec50: 626f 6479 5f77 6176 6566 756e 6374 696f  body_wavefunctio
-0000ec60: 6e2e 6765 745f 6b65 7973 2829 3a0a 2020  n.get_keys():.  
-0000ec70: 2020 2020 2020 7073 6920 3d20 7374 6174        psi = stat
-0000ec80: 652e 6d61 6e79 626f 6479 5f77 6176 6566  e.manybody_wavef
-0000ec90: 756e 6374 696f 6e2e 6765 745f 6f6e 6562  unction.get_oneb
-0000eca0: 6f64 795f 7374 6174 6528 6b65 7929 0a20  ody_state(key). 
-0000ecb0: 2020 2020 2020 2061 7373 6572 7420 7073         assert ps
-0000ecc0: 692e 7469 6d65 203d 3d20 7374 6174 652e  i.time == state.
-0000ecd0: 7469 6d65 0a20 2020 2023 202d 2d20 7265  time.    # -- re
-0000ece0: 6669 6e65 5f69 6e74 6572 7661 6c73 0a20  fine_intervals. 
-0000ecf0: 2020 2065 7272 6f72 5f62 6566 6f72 6520     error_before 
-0000ed00: 3d20 7374 6174 652e 6573 7469 6d61 7465  = state.estimate
-0000ed10: 5f65 7272 6f72 2829 0a20 2020 2073 7461  _error().    sta
-0000ed20: 7465 2e72 6566 696e 655f 696e 7465 7276  te.refine_interv
-0000ed30: 616c 7328 6174 6f6c 3d31 452d 332c 2072  als(atol=1E-3, r
-0000ed40: 746f 6c3d 3145 2d33 290a 2020 2020 6572  tol=1E-3).    er
-0000ed50: 726f 725f 6166 7465 7220 3d20 7374 6174  ror_after = stat
-0000ed60: 652e 6573 7469 6d61 7465 5f65 7272 6f72  e.estimate_error
-0000ed70: 2829 0a20 2020 2061 7373 6572 7420 6572  ().    assert er
-0000ed80: 726f 725f 6166 7465 7220 3c20 6572 726f  ror_after < erro
-0000ed90: 725f 6265 666f 7265 0a20 2020 2023 202d  r_before.    # -
-0000eda0: 2d20 7465 7374 2074 696d 6520 6166 7465  - test time afte
-0000edb0: 7220 7265 6669 6e69 6e67 2074 6865 2069  r refining the i
-0000edc0: 6e74 6572 7661 6c73 0a20 2020 2066 6f72  ntervals.    for
-0000edd0: 206b 6579 2069 6e20 7374 6174 652e 6d61   key in state.ma
-0000ede0: 6e79 626f 6479 5f77 6176 6566 756e 6374  nybody_wavefunct
-0000edf0: 696f 6e2e 6765 745f 6b65 7973 2829 3a0a  ion.get_keys():.
-0000ee00: 2020 2020 2020 2020 7073 6920 3d20 7374          psi = st
-0000ee10: 6174 652e 6d61 6e79 626f 6479 5f77 6176  ate.manybody_wav
-0000ee20: 6566 756e 6374 696f 6e2e 6765 745f 6f6e  efunction.get_on
-0000ee30: 6562 6f64 795f 7374 6174 6528 6b65 7929  ebody_state(key)
-0000ee40: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
-0000ee50: 7073 692e 7469 6d65 203d 3d20 7374 6174  psi.time == stat
-0000ee60: 652e 7469 6d65 0a0a 2020 2020 2320 6164  e.time..    # ad
-0000ee70: 6420 626f 756e 6473 7461 7465 732e 0a20  d boundstates.. 
-0000ee80: 2020 2023 2065 6d75 6c61 7465 2074 6865     # emulate the
-0000ee90: 2062 6f75 6e64 7374 6174 6573 2062 7920   boundstates by 
-0000eea0: 736f 6d65 2061 7262 6974 7261 7279 206f  some arbitrary o
-0000eeb0: 6e65 626f 6479 2073 7461 7465 730a 2020  nebody states.  
-0000eec0: 2020 2320 6173 2074 6865 2062 6f75 6e64    # as the bound
-0000eed0: 7374 6174 6573 2068 6176 6520 7a65 726f  states have zero
-0000eee0: 2077 6569 6768 742c 2074 6865 2072 6573   weight, the res
-0000eef0: 756c 7420 6d75 7374 2062 6520 696e 6465  ult must be inde
-0000ef00: 6e74 6963 616c 0a20 2020 2023 2074 6f20  ntical.    # to 
-0000ef10: 7468 6520 7265 7375 6c74 2077 6974 686f  the result witho
-0000ef20: 7574 2062 6f75 6e64 7374 6174 6573 0a20  ut boundstates. 
-0000ef30: 2020 2064 6566 206d 616b 655f 7073 6928     def make_psi(
-0000ef40: 656e 6572 6779 293a 0a20 2020 2020 2020  energy):.       
-0000ef50: 2072 6574 7572 6e20 6f6e 6562 6f64 792e   return onebody.
-0000ef60: 5363 6174 7465 7269 6e67 5374 6174 6573  ScatteringStates
-0000ef70: 2873 7973 742c 206c 6561 643d 302c 2065  (syst, lead=0, e
-0000ef80: 6e65 7267 793d 656e 6572 6779 2c0a 2020  nergy=energy,.  
-0000ef90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000efb0: 2020 2020 2020 746d 6178 3d74 6d61 782c        tmax=tmax,
-0000efc0: 2070 6172 616d 733d 7061 7261 6d73 295b   params=params)[
-0000efd0: 305d 0a20 2020 2062 6f75 6e64 7374 6174  0].    boundstat
-0000efe0: 655f 7461 736b 7320 3d20 7b27 6231 273a  e_tasks = {'b1':
-0000eff0: 206f 6e65 626f 6479 2e54 6173 6b28 7765   onebody.Task(we
-0000f000: 6967 6874 3d30 2c20 656e 6572 6779 3d32  ight=0, energy=2
-0000f010: 2e31 2c20 6c65 6164 3d4e 6f6e 652c 206d  .1, lead=None, m
-0000f020: 6f64 653d 4e6f 6e65 292c 0a20 2020 2020  ode=None),.     
-0000f030: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f040: 2020 2027 6232 273a 206f 6e65 626f 6479     'b2': onebody
-0000f050: 2e54 6173 6b28 7765 6967 6874 3d30 2c20  .Task(weight=0, 
-0000f060: 656e 6572 6779 3d32 2e33 2c20 6c65 6164  energy=2.3, lead
-0000f070: 3d4e 6f6e 652c 206d 6f64 653d 4e6f 6e65  =None, mode=None
-0000f080: 297d 0a20 2020 2062 6f75 6e64 7374 6174  )}.    boundstat
-0000f090: 655f 7073 6920 3d20 7b6b 6579 3a20 6d61  e_psi = {key: ma
-0000f0a0: 6b65 5f70 7369 2874 6173 6b2e 656e 6572  ke_psi(task.ener
-0000f0b0: 6779 2920 666f 7220 6b65 792c 2074 6173  gy) for key, tas
-0000f0c0: 6b20 696e 2062 6f75 6e64 7374 6174 655f  k in boundstate_
-0000f0d0: 7461 736b 732e 6974 656d 7328 297d 0a0a  tasks.items()}..
-0000f0e0: 2020 2020 2320 2d2d 2063 6865 636b 2074      # -- check t
-0000f0f0: 6861 7420 6164 6469 6e67 2062 6f75 6e64  hat adding bound
-0000f100: 7374 6174 6573 2064 6f20 6e6f 7420 6368  states do not ch
-0000f110: 616e 6765 2065 7272 6f72 2c20 696e 7465  ange error, inte
-0000f120: 7276 616c 7320 616e 6420 6f62 7365 7276  rvals and observ
-0000f130: 6162 6c65 0a20 2020 2069 6e74 6572 7661  able.    interva
-0000f140: 6c73 5f62 6566 6f72 6520 3d20 7374 6174  ls_before = stat
-0000f150: 652e 6765 745f 696e 7465 7276 616c 7328  e.get_intervals(
-0000f160: 290a 2020 2020 6572 726f 725f 7065 725f  ).    error_per_
-0000f170: 696e 7465 7276 616c 5f62 6566 6f72 6520  interval_before 
-0000f180: 3d20 7374 6174 652e 6573 7469 6d61 7465  = state.estimate
-0000f190: 5f65 7272 6f72 2869 6e74 6572 7661 6c73  _error(intervals
-0000f1a0: 3d69 6e74 6572 7661 6c73 5f62 6566 6f72  =intervals_befor
-0000f1b0: 6529 0a20 2020 2074 6f74 616c 5f65 7272  e).    total_err
-0000f1c0: 6f72 5f62 6566 6f72 6520 3d20 7374 6174  or_before = stat
-0000f1d0: 652e 6573 7469 6d61 7465 5f65 7272 6f72  e.estimate_error
-0000f1e0: 2829 0a20 2020 2064 656e 7369 7479 5f62  ().    density_b
-0000f1f0: 6566 6f72 6520 3d20 7374 6174 652e 6576  efore = state.ev
-0000f200: 616c 7561 7465 2864 656e 7369 7479 5f6f  aluate(density_o
-0000f210: 7065 7261 746f 7229 0a20 2020 206b 6579  perator).    key
-0000f220: 735f 6265 666f 7265 203d 2073 7461 7465  s_before = state
-0000f230: 2e6d 616e 7962 6f64 795f 7761 7665 6675  .manybody_wavefu
-0000f240: 6e63 7469 6f6e 2e67 6574 5f6b 6579 7328  nction.get_keys(
-0000f250: 290a 0a20 2020 2073 7461 7465 2e61 6464  )..    state.add
-0000f260: 5f62 6f75 6e64 7374 6174 6573 2862 6f75  _boundstates(bou
-0000f270: 6e64 7374 6174 655f 7073 692c 2062 6f75  ndstate_psi, bou
-0000f280: 6e64 7374 6174 655f 7461 736b 7329 0a0a  ndstate_tasks)..
-0000f290: 2020 2020 696e 7465 7276 616c 735f 6166      intervals_af
-0000f2a0: 7465 7220 3d20 7374 6174 652e 6765 745f  ter = state.get_
-0000f2b0: 696e 7465 7276 616c 7328 290a 2020 2020  intervals().    
-0000f2c0: 6572 726f 725f 7065 725f 696e 7465 7276  error_per_interv
-0000f2d0: 616c 5f61 6674 6572 203d 2073 7461 7465  al_after = state
-0000f2e0: 2e65 7374 696d 6174 655f 6572 726f 7228  .estimate_error(
-0000f2f0: 696e 7465 7276 616c 733d 696e 7465 7276  intervals=interv
-0000f300: 616c 735f 6166 7465 7229 0a20 2020 2074  als_after).    t
-0000f310: 6f74 616c 5f65 7272 6f72 5f61 6674 6572  otal_error_after
-0000f320: 203d 2073 7461 7465 2e65 7374 696d 6174   = state.estimat
-0000f330: 655f 6572 726f 7228 290a 2020 2020 6465  e_error().    de
-0000f340: 6e73 6974 795f 6166 7465 7220 3d20 7374  nsity_after = st
-0000f350: 6174 652e 6576 616c 7561 7465 2864 656e  ate.evaluate(den
-0000f360: 7369 7479 5f6f 7065 7261 746f 7229 0a20  sity_operator). 
-0000f370: 2020 206b 6579 735f 6166 7465 7220 3d20     keys_after = 
-0000f380: 7374 6174 652e 6d61 6e79 626f 6479 5f77  state.manybody_w
-0000f390: 6176 6566 756e 6374 696f 6e2e 6765 745f  avefunction.get_
-0000f3a0: 6b65 7973 2829 0a0a 2020 2020 666f 7220  keys()..    for 
-0000f3b0: 696e 7465 7276 616c 5f62 6566 6f72 652c  interval_before,
-0000f3c0: 2069 6e74 6572 7661 6c5f 6166 7465 7220   interval_after 
-0000f3d0: 696e 207a 6970 2869 6e74 6572 7661 6c73  in zip(intervals
-0000f3e0: 5f62 6566 6f72 652c 2069 6e74 6572 7661  _before, interva
-0000f3f0: 6c73 5f61 6674 6572 293a 0a20 2020 2020  ls_after):.     
-0000f400: 2020 2061 7373 6572 7420 696e 7465 7276     assert interv
-0000f410: 616c 5f62 6566 6f72 6520 3d3d 2069 6e74  al_before == int
-0000f420: 6572 7661 6c5f 6166 7465 720a 2020 2020  erval_after.    
-0000f430: 6173 7365 7274 2074 6f74 616c 5f65 7272  assert total_err
-0000f440: 6f72 5f62 6566 6f72 6520 3d3d 2074 6f74  or_before == tot
-0000f450: 616c 5f65 7272 6f72 5f61 6674 6572 0a20  al_error_after. 
-0000f460: 2020 2061 7373 6572 745f 6172 7261 795f     assert_array_
-0000f470: 616c 6d6f 7374 5f65 7175 616c 2865 7272  almost_equal(err
-0000f480: 6f72 5f70 6572 5f69 6e74 6572 7661 6c5f  or_per_interval_
-0000f490: 6265 666f 7265 2c20 6572 726f 725f 7065  before, error_pe
-0000f4a0: 725f 696e 7465 7276 616c 5f61 6674 6572  r_interval_after
-0000f4b0: 290a 2020 2020 6173 7365 7274 5f61 7272  ).    assert_arr
-0000f4c0: 6179 5f61 6c6d 6f73 745f 6571 7561 6c28  ay_almost_equal(
-0000f4d0: 6465 6e73 6974 795f 6265 666f 7265 2c20  density_before, 
-0000f4e0: 6465 6e73 6974 795f 6166 7465 7229 0a0a  density_after)..
-0000f4f0: 2020 2020 6173 7365 7274 206b 6579 735f      assert keys_
-0000f500: 6265 666f 7265 202b 206c 6973 7428 626f  before + list(bo
-0000f510: 756e 6473 7461 7465 5f74 6173 6b73 2e6b  undstate_tasks.k
-0000f520: 6579 7328 2929 203d 3d20 6b65 7973 5f61  eys()) == keys_a
-0000f530: 6674 6572 0a0a 2020 2020 2320 2d2d 2063  fter..    # -- c
-0000f540: 6865 636b 2074 6861 7420 7468 6520 7374  heck that the st
-0000f550: 6174 6520 6361 6e20 7374 696c 6c20 6265  ate can still be
-0000f560: 2065 766f 6c76 6564 2061 6e64 2067 6976   evolved and giv
-0000f570: 6573 2074 6865 2073 616d 6520 7265 7375  es the same resu
-0000f580: 6c74 2061 7320 7761 7665 6675 6e63 7469  lt as wavefuncti
-0000f590: 6f6e 0a20 2020 2074 696d 6520 2b3d 2035  on.    time += 5
-0000f5a0: 0a20 2020 2073 7461 7465 2e65 766f 6c76  .    state.evolv
-0000f5b0: 6528 7469 6d65 290a 2020 2020 6465 6e73  e(time).    dens
-0000f5c0: 6974 7920 3d20 7374 6174 652e 6576 616c  ity = state.eval
-0000f5d0: 7561 7465 2864 656e 7369 7479 5f6f 7065  uate(density_ope
-0000f5e0: 7261 746f 7229 0a0a 2020 2020 7766 2e65  rator)..    wf.e
-0000f5f0: 766f 6c76 6528 7469 6d65 290a 2020 2020  volve(time).    
-0000f600: 6465 6e73 6974 795f 7766 203d 2073 7461  density_wf = sta
-0000f610: 7465 2e65 7661 6c75 6174 6528 6465 6e73  te.evaluate(dens
-0000f620: 6974 795f 6f70 6572 6174 6f72 290a 0a20  ity_operator).. 
-0000f630: 2020 2061 7373 6572 745f 6172 7261 795f     assert_array_
-0000f640: 616c 6d6f 7374 5f65 7175 616c 2864 656e  almost_equal(den
-0000f650: 7369 7479 2c20 6465 6e73 6974 795f 7766  sity, density_wf
-0000f660: 290a 0a20 2020 2023 202d 2d20 6368 6563  )..    # -- chec
-0000f670: 6b20 7468 6174 2072 6566 696e 655f 696e  k that refine_in
-0000f680: 7465 7276 616c 7320 7374 696c 6c20 776f  tervals still wo
-0000f690: 726b 730a 2020 2020 6572 726f 725f 6265  rks.    error_be
-0000f6a0: 666f 7265 203d 2073 7461 7465 2e65 7374  fore = state.est
-0000f6b0: 696d 6174 655f 6572 726f 7228 290a 2020  imate_error().  
-0000f6c0: 2020 7374 6174 652e 7265 6669 6e65 5f69    state.refine_i
-0000f6d0: 6e74 6572 7661 6c73 2861 746f 6c3d 3145  ntervals(atol=1E
-0000f6e0: 2d34 2c20 7274 6f6c 3d31 452d 3429 0a20  -4, rtol=1E-4). 
-0000f6f0: 2020 2065 7272 6f72 5f61 6674 6572 203d     error_after =
-0000f700: 2073 7461 7465 2e65 7374 696d 6174 655f   state.estimate_
-0000f710: 6572 726f 7228 290a 2020 2020 6173 7365  error().    asse
-0000f720: 7274 2065 7272 6f72 5f61 6674 6572 203c  rt error_after <
-0000f730: 2065 7272 6f72 5f62 6566 6f72 650a 0a20   error_before.. 
-0000f740: 2020 2023 202d 2d20 6368 6563 6b20 746f     # -- check to
-0000f750: 2061 6464 2075 7365 7220 6769 7665 6e20   add user given 
-0000f760: 696e 7465 7276 616c 732c 2070 7265 6361  intervals, preca
-0000f770: 6c63 756c 6174 650a 2020 2020 4d6f 6449  lculate.    ModI
-0000f780: 6e74 6572 7661 6c20 3d20 6675 6e63 746f  nterval = functo
-0000f790: 6f6c 732e 7061 7274 6961 6c28 6d61 6e79  ols.partial(many
-0000f7a0: 626f 6479 2e49 6e74 6572 7661 6c2c 206f  body.Interval, o
-0000f7b0: 7264 6572 3d33 2c20 696e 7465 6772 6174  rder=3, integrat
-0000f7c0: 696f 6e5f 7661 7269 6162 6c65 3d27 656e  ion_variable='en
-0000f7d0: 6572 6779 2729 0a20 2020 2069 6e74 6572  ergy').    inter
-0000f7e0: 7661 6c73 203d 206d 616e 7962 6f64 792e  vals = manybody.
-0000f7f0: 6361 6c63 5f69 6e74 6572 7661 6c73 2873  calc_intervals(s
-0000f800: 7065 6374 7275 6d2c 206f 6363 7570 6174  pectrum, occupat
-0000f810: 696f 6e2c 2069 6e74 6572 7661 6c5f 7479  ion, interval_ty
-0000f820: 7065 3d4d 6f64 496e 7465 7276 616c 290a  pe=ModInterval).
-0000f830: 2020 2020 7374 6174 6520 3d20 6d61 6e79      state = many
-0000f840: 626f 6479 2e53 7461 7465 2873 7973 742c  body.State(syst,
-0000f850: 2074 6d61 782c 206f 6363 7570 6174 696f   tmax, occupatio
-0000f860: 6e2c 2070 6172 616d 733d 7061 7261 6d73  n, params=params
-0000f870: 2c20 696e 7465 7276 616c 733d 696e 7465  , intervals=inte
-0000f880: 7276 616c 732c 2072 6566 696e 653d 4661  rvals, refine=Fa
-0000f890: 6c73 6529 0a20 2020 2069 6e74 6572 7661  lse).    interva
-0000f8a0: 6c73 203d 2073 7461 7465 2e67 6574 5f69  ls = state.get_i
-0000f8b0: 6e74 6572 7661 6c73 2829 0a20 2020 2066  ntervals().    f
-0000f8c0: 6f72 2069 6e74 6572 7661 6c20 696e 2069  or interval in i
-0000f8d0: 6e74 6572 7661 6c73 3a0a 2020 2020 2020  ntervals:.      
-0000f8e0: 2020 6173 7365 7274 2069 6e74 6572 7661    assert interva
-0000f8f0: 6c2e 6f72 6465 7220 3d3d 2033 0a20 2020  l.order == 3.   
-0000f900: 2020 2020 2061 7373 6572 7420 696e 7465       assert inte
-0000f910: 7276 616c 2e69 6e74 6567 7261 7469 6f6e  rval.integration
-0000f920: 5f76 6172 6961 626c 6520 3d3d 2027 656e  _variable == 'en
-0000f930: 6572 6779 270a 0a20 2020 2023 202d 2d20  ergy'..    # -- 
-0000f940: 6368 6563 6b20 746f 2061 6464 2075 7365  check to add use
-0000f950: 7220 6769 7665 6e20 696e 7465 7276 616c  r given interval
-0000f960: 732c 206e 6577 2064 6566 6175 6c74 0a20  s, new default. 
-0000f970: 2020 204d 6f64 496e 7465 7276 616c 203d     ModInterval =
-0000f980: 2066 756e 6374 6f6f 6c73 2e70 6172 7469   functools.parti
-0000f990: 616c 286d 616e 7962 6f64 792e 496e 7465  al(manybody.Inte
-0000f9a0: 7276 616c 2c20 6f72 6465 723d 332c 2069  rval, order=3, i
-0000f9b0: 6e74 6567 7261 7469 6f6e 5f76 6172 6961  ntegration_varia
-0000f9c0: 626c 653d 2765 6e65 7267 7927 290a 2020  ble='energy').  
-0000f9d0: 2020 7374 6174 6520 3d20 6d61 6e79 626f    state = manybo
-0000f9e0: 6479 2e53 7461 7465 2873 7973 742c 2074  dy.State(syst, t
-0000f9f0: 6d61 782c 206f 6363 7570 6174 696f 6e2c  max, occupation,
-0000fa00: 2070 6172 616d 733d 7061 7261 6d73 2c20   params=params, 
-0000fa10: 696e 7465 7276 616c 733d 4d6f 6449 6e74  intervals=ModInt
-0000fa20: 6572 7661 6c2c 2072 6566 696e 653d 4661  erval, refine=Fa
-0000fa30: 6c73 6529 0a20 2020 2069 6e74 6572 7661  lse).    interva
-0000fa40: 6c73 203d 2073 7461 7465 2e67 6574 5f69  ls = state.get_i
-0000fa50: 6e74 6572 7661 6c73 2829 0a20 2020 2066  ntervals().    f
-0000fa60: 6f72 2069 6e74 6572 7661 6c20 696e 2069  or interval in i
-0000fa70: 6e74 6572 7661 6c73 3a0a 2020 2020 2020  ntervals:.      
-0000fa80: 2020 6173 7365 7274 2069 6e74 6572 7661    assert interva
-0000fa90: 6c2e 6f72 6465 7220 3d3d 2033 0a20 2020  l.order == 3.   
-0000faa0: 2020 2020 2061 7373 6572 7420 696e 7465       assert inte
-0000fab0: 7276 616c 2e69 6e74 6567 7261 7469 6f6e  rval.integration
-0000fac0: 5f76 6172 6961 626c 6520 3d3d 2027 656e  _variable == 'en
-0000fad0: 6572 6779 270a 0a20 2020 2023 202d 2d20  ergy'..    # -- 
-0000fae0: 6368 6563 6b20 7374 6174 6520 7769 7468  check state with
-0000faf0: 2064 6566 6175 6c74 206f 6363 7570 6174   default occupat
-0000fb00: 696f 6e0a 2020 2020 6f63 6375 7061 7469  ion.    occupati
-0000fb10: 6f6e 5f6d 755f 3020 3d20 6d61 6e79 626f  on_mu_0 = manybo
-0000fb20: 6479 2e6c 6561 645f 6f63 6375 7061 7469  dy.lead_occupati
-0000fb30: 6f6e 2863 6865 6d69 6361 6c5f 706f 7465  on(chemical_pote
-0000fb40: 6e74 6961 6c3d 3029 0a20 2020 2073 7461  ntial=0).    sta
-0000fb50: 7465 5f6d 755f 3020 3d20 6d61 6e79 626f  te_mu_0 = manybo
-0000fb60: 6479 2e53 7461 7465 2873 7973 742c 2074  dy.State(syst, t
-0000fb70: 6d61 782c 206f 6363 7570 6174 696f 6e5f  max, occupation_
-0000fb80: 6d75 5f30 2c20 7061 7261 6d73 3d70 6172  mu_0, params=par
-0000fb90: 616d 732c 2072 6566 696e 653d 4661 6c73  ams, refine=Fals
-0000fba0: 6529 0a20 2020 2073 7461 7465 5f64 6566  e).    state_def
-0000fbb0: 6175 6c74 203d 206d 616e 7962 6f64 792e  ault = manybody.
-0000fbc0: 5374 6174 6528 7379 7374 2c20 746d 6178  State(syst, tmax
-0000fbd0: 3d74 6d61 782c 2070 6172 616d 733d 7061  =tmax, params=pa
-0000fbe0: 7261 6d73 2c20 7265 6669 6e65 3d46 616c  rams, refine=Fal
-0000fbf0: 7365 290a 2020 2020 6173 7365 7274 2073  se).    assert s
-0000fc00: 7461 7465 5f6d 755f 302e 6f63 6375 7061  tate_mu_0.occupa
-0000fc10: 7469 6f6e 735b 305d 2e65 6e65 7267 795f  tions[0].energy_
-0000fc20: 7261 6e67 6520 3d3d 2073 7461 7465 5f64  range == state_d
-0000fc30: 6566 6175 6c74 2e6f 6363 7570 6174 696f  efault.occupatio
-0000fc40: 6e73 5b30 5d2e 656e 6572 6779 5f72 616e  ns[0].energy_ran
-0000fc50: 6765 0a0a 2020 2020 2320 7465 7374 2066  ge..    # test f
-0000fc60: 6f72 206d 6973 7369 6e67 2069 6e70 7574  or missing input
-0000fc70: 0a20 2020 2072 6169 7365 7328 5661 6c75  .    raises(Valu
-0000fc80: 6545 7272 6f72 2c20 6d61 6e79 626f 6479  eError, manybody
-0000fc90: 2e53 7461 7465 2c20 7379 7374 3d73 7973  .State, syst=sys
-0000fca0: 742c 2070 6172 616d 733d 7061 7261 6d73  t, params=params
-0000fcb0: 290a 2020 2020 2320 7465 7374 2066 6f72  ).    # test for
-0000fcc0: 2073 7973 7465 6d20 6e6f 7420 6669 6e61   system not fina
-0000fcd0: 6c69 7a65 640a 2020 2020 7261 6973 6573  lized.    raises
-0000fce0: 2854 7970 6545 7272 6f72 2c20 6d61 6e79  (TypeError, many
-0000fcf0: 626f 6479 2e53 7461 7465 2c20 7379 7374  body.State, syst
-0000fd00: 3d6d 616b 655f 7379 7374 656d 2829 2c20  =make_system(), 
-0000fd10: 746d 6178 3d35 2c20 7061 7261 6d73 3d70  tmax=5, params=p
-0000fd20: 6172 616d 7329 0a20 2020 2023 2074 6573  arams).    # tes
-0000fd30: 7420 666f 7220 6d75 7475 616c 2065 7863  t for mutual exc
-0000fd40: 6c75 7369 7665 2061 7267 756d 656e 7473  lusive arguments
-0000fd50: 0a20 2020 2072 6169 7365 7328 5661 6c75  .    raises(Valu
-0000fd60: 6545 7272 6f72 2c20 6d61 6e79 626f 6479  eError, manybody
-0000fd70: 2e53 7461 7465 2c20 7379 7374 2c20 746d  .State, syst, tm
-0000fd80: 6178 2c20 626f 756e 6461 7269 6573 3d62  ax, boundaries=b
-0000fd90: 6f75 6e64 6172 6965 732c 2070 6172 616d  oundaries, param
-0000fda0: 733d 7061 7261 6d73 290a 0a20 2020 2070  s=params)..    p
-0000fdb0: 6172 616d 735f 7769 7468 5f74 696d 6520  arams_with_time 
-0000fdc0: 3d20 7b27 7627 3a20 302e 312c 2027 7430  = {'v': 0.1, 't0
-0000fdd0: 273a 2030 2c20 2741 273a 2030 2e30 3031  ': 0, 'A': 0.001
-0000fde0: 3537 2c20 2773 6967 6d61 273a 2032 342c  57, 'sigma': 24,
-0000fdf0: 2027 7469 6d65 273a 2030 7d0a 2020 2020   'time': 0}.    
-0000fe00: 7769 7468 2070 7974 6573 742e 7261 6973  with pytest.rais
-0000fe10: 6573 284b 6579 4572 726f 7229 2061 7320  es(KeyError) as 
-0000fe20: 6578 633a 0a20 2020 2020 2020 206d 616e  exc:.        man
-0000fe30: 7962 6f64 792e 5374 6174 6528 7379 7374  ybody.State(syst
-0000fe40: 2c20 746d 6178 2c20 7061 7261 6d73 3d70  , tmax, params=p
-0000fe50: 6172 616d 735f 7769 7468 5f74 696d 6529  arams_with_time)
-0000fe60: 0a20 2020 2065 7272 6f72 5f73 7472 696e  .    error_strin
-0000fe70: 6720 3d20 7374 7228 6578 632e 7661 6c75  g = str(exc.valu
-0000fe80: 6529 2e73 7472 6970 2827 5c22 2729 2020  e).strip('\"')  
-0000fe90: 2320 7265 6d6f 7665 2065 7472 6120 7175  # remove etra qu
-0000fea0: 6f74 6573 0a20 2020 2061 7373 6572 7420  otes.    assert 
-0000feb0: 6572 726f 725f 7374 7269 6e67 203d 3d20  error_string == 
-0000fec0: 2227 7061 7261 6d73 2720 6d75 7374 206e  "'params' must n
-0000fed0: 6f74 2063 6f6e 7461 696e 2074 696d 6522  ot contain time"
-0000fee0: 0a0a 2020 2020 2320 544f 444f 2c20 6368  ..    # TODO, ch
-0000fef0: 6563 6b20 6765 6e65 7261 6c20 7061 7261  eck general para
-0000ff00: 6d65 7465 7220 6861 6e64 6c69 6e67 2069  meter handling i
-0000ff10: 6e20 6d61 6e79 626f 6479 2e53 7461 7465  n manybody.State
-0000ff20: 0a20 2020 2023 206e 6f20 7061 7261 6d73  .    # no params
-0000ff30: 2070 6173 7365 6420 6174 2061 6c6c 0a20   passed at all. 
-0000ff40: 2020 2023 2077 6974 6820 7079 7465 7374     # with pytest
-0000ff50: 2e72 6169 7365 7328 5479 7065 4572 726f  .raises(TypeErro
-0000ff60: 7229 2061 7320 6578 633a 0a20 2020 2023  r) as exc:.    #
-0000ff70: 206d 616e 7962 6f64 792e 5374 6174 6528   manybody.State(
-0000ff80: 7379 7374 2c20 746d 6178 290a 2020 2020  syst, tmax).    
-0000ff90: 2320 6173 7365 7274 2073 7472 2865 7863  # assert str(exc
-0000ffa0: 2e76 616c 7565 2920 3d3d 2027 5379 7374  .value) == 'Syst
-0000ffb0: 656d 2069 7320 6d69 7373 696e 6720 7265  em is missing re
-0000ffc0: 7175 6972 6564 2061 7267 756d 656e 7473  quired arguments
-0000ffd0: 3a20 2276 2227 0a0a 2020 2020 2320 7061  : "v"'..    # pa
-0000ffe0: 7261 6d73 5f77 6974 686f 7574 5f73 6967  rams_without_sig
-0000fff0: 6d61 203d 207b 2776 273a 2030 2e31 2c20  ma = {'v': 0.1, 
-00010000: 2774 3027 3a20 302c 2027 4127 3a30 2e30  't0': 0, 'A':0.0
-00010010: 3031 3537 7d0a 2020 2020 2320 7769 7468  0157}.    # with
-00010020: 2070 7974 6573 742e 7261 6973 6573 2854   pytest.raises(T
-00010030: 7970 6545 7272 6f72 2920 6173 2065 7863  ypeError) as exc
-00010040: 3a0a 2020 2020 2320 2020 206d 616e 7962  :.    #    manyb
-00010050: 6f64 792e 5374 6174 6528 7379 7374 2c20  ody.State(syst, 
-00010060: 746d 6178 2c20 7061 7261 6d73 3d70 6172  tmax, params=par
-00010070: 616d 735f 7769 7468 6f75 745f 7369 676d  ams_without_sigm
-00010080: 6129 0a20 2020 2023 2061 7373 6572 7420  a).    # assert 
-00010090: 7374 7228 6578 632e 7661 6c75 6529 203d  str(exc.value) =
-000100a0: 3d20 2753 7973 7465 6d20 6973 206d 6973  = 'System is mis
-000100b0: 7369 6e67 2072 6571 7569 7265 6420 6172  sing required ar
-000100c0: 6775 6d65 6e74 733a 2022 7369 676d 6122  guments: "sigma"
-000100d0: 270a 0a0a 4070 7974 6573 742e 6d61 726b  '...@pytest.mark
-000100e0: 2e69 6e74 6567 7465 7374 2020 2320 6d61  .integtest  # ma
-000100f0: 726b 6572 2066 6f72 2069 6e74 6567 7261  rker for integra
-00010100: 7469 6f6e 2074 6573 7473 0a64 6566 2074  tion tests.def t
-00010110: 6573 745f 6d61 6e79 626f 6479 5f73 7461  est_manybody_sta
-00010120: 7465 5f69 6e69 7469 616c 5f72 6566 696e  te_initial_refin
-00010130: 6528 293a 0a0a 2020 2020 7379 7374 203d  e():..    syst =
-00010140: 206d 616b 655f 7379 7374 656d 2829 2e66   make_system().f
-00010150: 696e 616c 697a 6564 2829 0a0a 2020 2020  inalized()..    
-00010160: 746d 6178 203d 2035 3030 0a20 2020 2070  tmax = 500.    p
-00010170: 6172 616d 7320 3d20 7b27 7627 3a20 302e  arams = {'v': 0.
-00010180: 3030 3031 2c20 2774 3027 3a20 302c 2027  0001, 't0': 0, '
-00010190: 4127 3a20 302e 3030 3135 372c 2027 7369  A': 0.00157, 'si
-000101a0: 676d 6127 3a20 3234 7d0a 0a20 2020 206f  gma': 24}..    o
-000101b0: 6363 7570 6174 696f 6e20 3d20 6d61 6e79  ccupation = many
-000101c0: 626f 6479 2e6c 6561 645f 6f63 6375 7061  body.lead_occupa
-000101d0: 7469 6f6e 2863 6865 6d69 6361 6c5f 706f  tion(chemical_po
-000101e0: 7465 6e74 6961 6c3d 3329 0a0a 2020 2020  tential=3)..    
-000101f0: 7374 6174 6520 3d20 6d61 6e79 626f 6479  state = manybody
-00010200: 2e53 7461 7465 2873 7973 742c 2074 6d61  .State(syst, tma
-00010210: 782c 206f 6363 7570 6174 696f 6e2c 2070  x, occupation, p
-00010220: 6172 616d 733d 7061 7261 6d73 2c20 7265  arams=params, re
-00010230: 6669 6e65 3d46 616c 7365 290a 2020 2020  fine=False).    
-00010240: 696e 7465 7276 616c 7320 3d20 7374 6174  intervals = stat
-00010250: 652e 6765 745f 696e 7465 7276 616c 7328  e.get_intervals(
-00010260: 290a 2020 2020 6173 7365 7274 206c 656e  ).    assert len
-00010270: 2869 6e74 6572 7661 6c73 2920 3d3d 2032  (intervals) == 2
-00010280: 0a0a 2020 2020 7374 6174 6520 3d20 6d61  ..    state = ma
-00010290: 6e79 626f 6479 2e53 7461 7465 2873 7973  nybody.State(sys
-000102a0: 742c 2074 6d61 782c 206f 6363 7570 6174  t, tmax, occupat
-000102b0: 696f 6e2c 2070 6172 616d 733d 7061 7261  ion, params=para
-000102c0: 6d73 290a 2020 2020 696e 7465 7276 616c  ms).    interval
-000102d0: 7320 3d20 7374 6174 652e 6765 745f 696e  s = state.get_in
-000102e0: 7465 7276 616c 7328 290a 2020 2020 6173  tervals().    as
-000102f0: 7365 7274 206c 656e 2869 6e74 6572 7661  sert len(interva
-00010300: 6c73 2920 3d3d 2031 330a 0a0a 4070 7974  ls) == 13...@pyt
-00010310: 6573 742e 6d61 726b 2e69 6e74 6567 7465  est.mark.integte
-00010320: 7374 2020 2320 6d61 726b 6572 2066 6f72  st  # marker for
-00010330: 2069 6e74 6567 7261 7469 6f6e 2074 6573   integration tes
-00010340: 7473 0a64 6566 2074 6573 745f 6d61 6e79  ts.def test_many
-00010350: 626f 6479 5f73 7461 7465 5f72 6566 696e  body_state_refin
-00010360: 655f 6e6f 6e5f 6b72 6f6e 726f 6428 293a  e_non_kronrod():
-00010370: 0a0a 2020 2020 2320 7465 7374 2074 6861  ..    # test tha
-00010380: 7420 7265 6669 6e65 6d65 6e74 2061 6374  t refinement act
-00010390: 7320 6f6e 6c79 206f 6e20 7468 6520 6761  s only on the ga
-000103a0: 7573 732d 6b72 6f6e 726f 6420 696e 7465  uss-kronrod inte
-000103b0: 7276 616c 730a 2020 2020 2320 616e 6420  rvals.    # and 
-000103c0: 7468 6174 2061 6464 6974 696f 6e61 6c20  that additional 
-000103d0: 6f74 6865 7220 696e 7465 7276 616c 7320  other intervals 
-000103e0: 2868 6572 6520 6761 7573 732d 6c65 6765  (here gauss-lege
-000103f0: 6e64 7265 2069 6e20 7468 6520 6578 616d  ndre in the exam
-00010400: 706c 6529 0a20 2020 2023 2061 7265 206e  ple).    # are n
-00010410: 6f74 2074 6f75 6368 6564 2062 7920 7265  ot touched by re
-00010420: 6669 6e65 5f69 6e74 6572 7661 6c73 2829  fine_intervals()
-00010430: 0a0a 2020 2020 7379 7374 203d 206d 616b  ..    syst = mak
-00010440: 655f 7379 7374 656d 2829 2e66 696e 616c  e_system().final
-00010450: 697a 6564 2829 0a0a 2020 2020 746d 6178  ized()..    tmax
-00010460: 203d 2035 3030 0a20 2020 2070 6172 616d   = 500.    param
-00010470: 7320 3d20 7b27 7627 3a20 302e 3030 3031  s = {'v': 0.0001
-00010480: 2c20 2774 3027 3a20 302c 2027 4127 3a20  , 't0': 0, 'A': 
-00010490: 302e 3030 3135 372c 2027 7369 676d 6127  0.00157, 'sigma'
-000104a0: 3a20 3234 7d0a 0a20 2020 206f 6363 7570  : 24}..    occup
-000104b0: 6174 696f 6e20 3d20 6d61 6e79 626f 6479  ation = manybody
-000104c0: 2e6c 6561 645f 6f63 6375 7061 7469 6f6e  .lead_occupation
-000104d0: 2863 6865 6d69 6361 6c5f 706f 7465 6e74  (chemical_potent
-000104e0: 6961 6c3d 3329 0a0a 2020 2020 7374 6174  ial=3)..    stat
-000104f0: 6520 3d20 6d61 6e79 626f 6479 2e53 7461  e = manybody.Sta
-00010500: 7465 2873 7973 742c 2074 6d61 782c 206f  te(syst, tmax, o
-00010510: 6363 7570 6174 696f 6e2c 2070 6172 616d  ccupation, param
-00010520: 733d 7061 7261 6d73 2c20 7265 6669 6e65  s=params, refine
-00010530: 3d46 616c 7365 290a 2020 2020 696e 7465  =False).    inte
-00010540: 7276 616c 7320 3d20 7374 6174 652e 6765  rvals = state.ge
-00010550: 745f 696e 7465 7276 616c 7328 290a 2020  t_intervals().  
-00010560: 2020 6173 7365 7274 206c 656e 2869 6e74    assert len(int
-00010570: 6572 7661 6c73 2920 3d3d 2032 0a0a 2020  ervals) == 2..  
-00010580: 2020 666f 7220 696e 7465 7276 616c 2069    for interval i
-00010590: 6e20 696e 7465 7276 616c 733a 0a20 2020  n intervals:.   
-000105a0: 2020 2020 2069 6e74 6572 7661 6c2e 7175       interval.qu
-000105b0: 6164 7261 7475 7265 203d 2027 6761 7573  adrature = 'gaus
-000105c0: 736c 6567 656e 6472 6527 0a20 2020 2020  slegendre'.     
-000105d0: 2020 2073 7461 7465 2e5f 6164 645f 696e     state._add_in
-000105e0: 7465 7276 616c 2869 6e74 6572 7661 6c29  terval(interval)
-000105f0: 0a0a 2020 2020 696e 7465 7276 616c 7320  ..    intervals 
-00010600: 3d20 7374 6174 652e 6765 745f 696e 7465  = state.get_inte
-00010610: 7276 616c 7328 290a 2020 2020 6173 7365  rvals().    asse
-00010620: 7274 206c 656e 2869 6e74 6572 7661 6c73  rt len(intervals
-00010630: 2920 3d3d 2034 2020 2320 3220 2b20 3220  ) == 4  # 2 + 2 
-00010640: 696e 7465 7276 616c 730a 0a20 2020 2073  intervals..    s
-00010650: 7461 7465 2e72 6566 696e 655f 696e 7465  tate.refine_inte
-00010660: 7276 616c 7328 290a 2020 2020 696e 7465  rvals().    inte
-00010670: 7276 616c 7320 3d20 7374 6174 652e 6765  rvals = state.ge
-00010680: 745f 696e 7465 7276 616c 7328 290a 2020  t_intervals().  
-00010690: 2020 6173 7365 7274 206c 656e 2869 6e74    assert len(int
-000106a0: 6572 7661 6c73 2920 3d3d 2031 3520 2023  ervals) == 15  #
-000106b0: 2031 3320 2b20 3220 696e 7465 7276 616c   13 + 2 interval
-000106c0: 730a 0a0a 4070 7974 6573 742e 6d61 726b  s...@pytest.mark
-000106d0: 2e69 6e74 6567 7465 7374 0a64 6566 2074  .integtest.def t
-000106e0: 6573 745f 7374 6174 655f 6573 7469 6d61  est_state_estima
-000106f0: 7465 5f65 7272 6f72 2829 3a0a 0a20 2020  te_error():..   
-00010700: 2073 7973 7420 3d20 6d61 6b65 5f73 7973   syst = make_sys
-00010710: 7465 6d28 292e 6669 6e61 6c69 7a65 6428  tem().finalized(
-00010720: 290a 2020 2020 6465 6e73 6974 795f 7375  ).    density_su
-00010730: 6d20 3d20 6b77 616e 742e 6f70 6572 6174  m = kwant.operat
-00010740: 6f72 2e44 656e 7369 7479 2873 7973 742c  or.Density(syst,
-00010750: 2073 756d 3d54 7275 6529 0a20 2020 2064   sum=True).    d
-00010760: 656e 7369 7479 5f6f 7065 7261 746f 7220  ensity_operator 
-00010770: 3d20 6b77 616e 742e 6f70 6572 6174 6f72  = kwant.operator
-00010780: 2e44 656e 7369 7479 2873 7973 7429 0a20  .Density(syst). 
-00010790: 2020 2063 7572 7265 6e74 5f6f 7065 7261     current_opera
-000107a0: 746f 7220 3d20 6b77 616e 742e 6f70 6572  tor = kwant.oper
-000107b0: 6174 6f72 2e43 7572 7265 6e74 2873 7973  ator.Current(sys
-000107c0: 7429 0a0a 2020 2020 6368 656d 6963 616c  t)..    chemical
-000107d0: 5f70 6f74 656e 7469 616c 203d 2033 0a20  _potential = 3. 
-000107e0: 2020 2074 6d61 7820 3d20 3530 300a 2020     tmax = 500.  
-000107f0: 2020 7061 7261 6d73 203d 207b 2776 273a    params = {'v':
-00010800: 2030 2e30 3030 312c 2027 7430 273a 2030   0.0001, 't0': 0
-00010810: 2c20 2741 273a 2030 2e30 3031 3537 2c20  , 'A': 0.00157, 
-00010820: 2773 6967 6d61 273a 2032 347d 0a0a 2020  'sigma': 24}..  
-00010830: 2020 6f63 6375 7061 7469 6f6e 203d 206d    occupation = m
-00010840: 616e 7962 6f64 792e 6c65 6164 5f6f 6363  anybody.lead_occ
-00010850: 7570 6174 696f 6e28 6368 656d 6963 616c  upation(chemical
-00010860: 5f70 6f74 656e 7469 616c 290a 2020 2020  _potential).    
-00010870: 7374 6174 6520 3d20 6d61 6e79 626f 6479  state = manybody
-00010880: 2e53 7461 7465 2873 7973 742c 2074 6d61  .State(syst, tma
-00010890: 782c 206f 6363 7570 6174 696f 6e2c 2070  x, occupation, p
-000108a0: 6172 616d 733d 7061 7261 6d73 2c20 7265  arams=params, re
-000108b0: 6669 6e65 3d46 616c 7365 290a 0a20 2020  fine=False)..   
-000108c0: 2073 6861 7065 5f64 656e 7369 7479 5f73   shape_density_s
-000108d0: 756d 203d 2073 7461 7465 2e65 7661 6c75  um = state.evalu
-000108e0: 6174 6528 6465 6e73 6974 795f 7375 6d29  ate(density_sum)
-000108f0: 2e73 6861 7065 0a20 2020 2073 6861 7065  .shape.    shape
-00010900: 5f64 656e 7369 7479 203d 2073 7461 7465  _density = state
-00010910: 2e65 7661 6c75 6174 6528 6465 6e73 6974  .evaluate(densit
-00010920: 795f 6f70 6572 6174 6f72 292e 7368 6170  y_operator).shap
-00010930: 650a 2020 2020 7368 6170 655f 6375 7272  e.    shape_curr
-00010940: 656e 7420 3d20 7374 6174 652e 6576 616c  ent = state.eval
-00010950: 7561 7465 2863 7572 7265 6e74 5f6f 7065  uate(current_ope
-00010960: 7261 746f 7229 2e73 6861 7065 0a0a 2020  rator).shape..  
-00010970: 2020 6173 7365 7274 2073 6861 7065 5f64    assert shape_d
-00010980: 656e 7369 7479 5f73 756d 203d 3d20 2829  ensity_sum == ()
-00010990: 0a20 2020 2061 7373 6572 7420 7368 6170  .    assert shap
-000109a0: 655f 6465 6e73 6974 795f 7375 6d20 213d  e_density_sum !=
-000109b0: 2073 6861 7065 5f64 656e 7369 7479 2020   shape_density  
-000109c0: 2320 6d61 6b65 2073 7572 6520 746f 206d  # make sure to m
-000109d0: 6561 7375 7265 206e 6f74 2074 6865 2073  easure not the s
-000109e0: 616d 650a 2020 2020 6173 7365 7274 2073  ame.    assert s
-000109f0: 6861 7065 5f64 656e 7369 7479 5f73 756d  hape_density_sum
-00010a00: 2021 3d20 7368 6170 655f 6375 7272 656e   != shape_curren
-00010a10: 7420 2023 206d 616b 6520 7375 7265 2074  t  # make sure t
-00010a20: 6f20 6d65 6173 7572 6520 6e6f 7420 7468  o measure not th
-00010a30: 6520 7361 6d65 0a20 2020 2061 7373 6572  e same.    asser
-00010a40: 7420 7368 6170 655f 6465 6e73 6974 7920  t shape_density 
-00010a50: 213d 2073 6861 7065 5f63 7572 7265 6e74  != shape_current
-00010a60: 2020 2320 6d61 6b65 2073 7572 6520 746f    # make sure to
-00010a70: 206d 6561 7375 7265 206e 6f74 2074 6865   measure not the
-00010a80: 2073 616d 650a 0a20 2020 2069 6e74 6572   same..    inter
-00010a90: 7661 6c73 203d 2073 7461 7465 2e67 6574  vals = state.get
-00010aa0: 5f69 6e74 6572 7661 6c73 2829 0a0a 2020  _intervals()..  
-00010ab0: 2020 2320 2d2d 2d20 6465 6e73 6974 7920    # --- density 
-00010ac0: 6973 2074 6865 2064 6566 6175 6c74 206f  is the default o
-00010ad0: 7065 7261 746f 7220 746f 206d 6561 7375  perator to measu
-00010ae0: 7265 2074 6865 2065 7272 6f72 0a0a 2020  re the error..  
-00010af0: 2020 2320 6d61 7869 6d75 6d20 6572 726f    # maximum erro
-00010b00: 722c 2073 756d 6d65 6420 6f76 6572 2061  r, summed over a
-00010b10: 6c6c 2069 6e74 6572 7661 6c73 0a20 2020  ll intervals.   
-00010b20: 2065 7272 6f72 7320 3d20 7374 6174 652e   errors = state.
-00010b30: 6573 7469 6d61 7465 5f65 7272 6f72 2829  estimate_error()
-00010b40: 0a20 2020 2061 7373 6572 7420 6572 726f  .    assert erro
-00010b50: 7273 2e73 6861 7065 203d 3d20 2829 0a0a  rs.shape == ()..
-00010b60: 2020 2020 2320 6572 726f 7220 6f76 6572      # error over
-00010b70: 2061 7272 6179 2c20 7375 6d6d 6564 206f   array, summed o
-00010b80: 7665 7220 616c 6c20 696e 7465 7276 616c  ver all interval
-00010b90: 730a 2020 2020 6572 726f 7273 203d 2073  s.    errors = s
-00010ba0: 7461 7465 2e65 7374 696d 6174 655f 6572  tate.estimate_er
-00010bb0: 726f 7228 6675 6c6c 5f6f 7574 7075 743d  ror(full_output=
-00010bc0: 5472 7565 290a 2020 2020 6173 7365 7274  True).    assert
-00010bd0: 2065 7272 6f72 732e 7368 6170 6520 3d3d   errors.shape ==
-00010be0: 2073 6861 7065 5f64 656e 7369 7479 0a0a   shape_density..
-00010bf0: 2020 2020 2320 6d61 7869 6d75 6d20 6572      # maximum er
-00010c00: 726f 7220 7065 7220 696e 7465 7276 616c  ror per interval
-00010c10: 0a20 2020 2065 7272 6f72 7320 3d20 7374  .    errors = st
-00010c20: 6174 652e 6573 7469 6d61 7465 5f65 7272  ate.estimate_err
-00010c30: 6f72 2869 6e74 6572 7661 6c73 3d69 6e74  or(intervals=int
-00010c40: 6572 7661 6c73 290a 2020 2020 6173 7365  ervals).    asse
-00010c50: 7274 2065 7272 6f72 732e 7368 6170 6520  rt errors.shape 
-00010c60: 3d3d 2028 6c65 6e28 696e 7465 7276 616c  == (len(interval
-00010c70: 7329 2c29 0a0a 2020 2020 2320 6572 726f  s),)..    # erro
-00010c80: 7220 6f76 6572 2061 7272 6179 2070 6572  r over array per
-00010c90: 2069 6e74 6572 7661 6c0a 2020 2020 6572   interval.    er
-00010ca0: 726f 7273 203d 2073 7461 7465 2e65 7374  rors = state.est
-00010cb0: 696d 6174 655f 6572 726f 7228 696e 7465  imate_error(inte
-00010cc0: 7276 616c 733d 696e 7465 7276 616c 732c  rvals=intervals,
-00010cd0: 2066 756c 6c5f 6f75 7470 7574 3d54 7275   full_output=Tru
-00010ce0: 6529 0a20 2020 2061 7373 6572 7420 6572  e).    assert er
-00010cf0: 726f 7273 2e73 6861 7065 203d 3d20 286c  rors.shape == (l
-00010d00: 656e 2869 6e74 6572 7661 6c73 292c 2920  en(intervals),) 
-00010d10: 2b20 7368 6170 655f 6465 6e73 6974 790a  + shape_density.
-00010d20: 0a20 2020 2023 206d 6178 696d 756d 2065  .    # maximum e
-00010d30: 7272 6f72 206f 6620 6120 7369 6e67 6c65  rror of a single
-00010d40: 2069 6e74 6572 7661 6c0a 2020 2020 6572   interval.    er
-00010d50: 726f 7273 203d 2073 7461 7465 2e65 7374  rors = state.est
-00010d60: 696d 6174 655f 6572 726f 7228 696e 7465  imate_error(inte
-00010d70: 7276 616c 733d 696e 7465 7276 616c 735b  rvals=intervals[
-00010d80: 305d 290a 2020 2020 6173 7365 7274 2065  0]).    assert e
-00010d90: 7272 6f72 732e 7368 6170 6520 3d3d 2028  rrors.shape == (
-00010da0: 290a 0a20 2020 2023 2065 7272 6f72 206f  )..    # error o
-00010db0: 7665 7220 6172 7261 7920 6f66 2061 2073  ver array of a s
-00010dc0: 696e 676c 6520 696e 7465 7276 616c 0a20  ingle interval. 
-00010dd0: 2020 2065 7272 6f72 7320 3d20 7374 6174     errors = stat
-00010de0: 652e 6573 7469 6d61 7465 5f65 7272 6f72  e.estimate_error
-00010df0: 2869 6e74 6572 7661 6c73 3d69 6e74 6572  (intervals=inter
-00010e00: 7661 6c73 5b30 5d2c 2066 756c 6c5f 6f75  vals[0], full_ou
-00010e10: 7470 7574 3d54 7275 6529 0a20 2020 2061  tput=True).    a
-00010e20: 7373 6572 7420 6572 726f 7273 2e73 6861  ssert errors.sha
-00010e30: 7065 203d 3d20 7368 6170 655f 6465 6e73  pe == shape_dens
-00010e40: 6974 790a 0a20 2020 2023 202d 2d2d 206d  ity..    # --- m
-00010e50: 6561 7375 7265 2074 6865 2065 7272 6f72  easure the error
-00010e60: 2077 6974 6820 7468 6520 6375 7272 656e   with the curren
-00010e70: 7420 6f70 6572 6174 6f72 0a0a 2020 2020  t operator..    
-00010e80: 2320 6d61 7869 6d75 6d20 6572 726f 722c  # maximum error,
-00010e90: 2073 756d 6d65 6420 6f76 6572 2061 6c6c   summed over all
-00010ea0: 2069 6e74 6572 7661 6c73 0a20 2020 2065   intervals.    e
-00010eb0: 7272 6f72 7320 3d20 7374 6174 652e 6573  rrors = state.es
-00010ec0: 7469 6d61 7465 5f65 7272 6f72 2865 7272  timate_error(err
-00010ed0: 6f72 5f6f 703d 6375 7272 656e 745f 6f70  or_op=current_op
-00010ee0: 6572 6174 6f72 290a 2020 2020 6173 7365  erator).    asse
-00010ef0: 7274 2065 7272 6f72 732e 7368 6170 6520  rt errors.shape 
-00010f00: 3d3d 2028 290a 0a20 2020 2023 2065 7272  == ()..    # err
-00010f10: 6f72 206f 7665 7220 6172 7261 792c 2073  or over array, s
-00010f20: 756d 6d65 6420 6f76 6572 2061 6c6c 2069  ummed over all i
-00010f30: 6e74 6572 7661 6c73 0a20 2020 2065 7272  ntervals.    err
-00010f40: 6f72 7320 3d20 7374 6174 652e 6573 7469  ors = state.esti
-00010f50: 6d61 7465 5f65 7272 6f72 2865 7272 6f72  mate_error(error
-00010f60: 5f6f 703d 6375 7272 656e 745f 6f70 6572  _op=current_oper
-00010f70: 6174 6f72 2c20 6675 6c6c 5f6f 7574 7075  ator, full_outpu
-00010f80: 743d 5472 7565 290a 2020 2020 6173 7365  t=True).    asse
-00010f90: 7274 2065 7272 6f72 732e 7368 6170 6520  rt errors.shape 
-00010fa0: 3d3d 2073 6861 7065 5f63 7572 7265 6e74  == shape_current
-00010fb0: 0a0a 2020 2020 2320 6d61 7869 6d75 6d20  ..    # maximum 
-00010fc0: 6572 726f 7220 7065 7220 696e 7465 7276  error per interv
-00010fd0: 616c 0a20 2020 2065 7272 6f72 7320 3d20  al.    errors = 
-00010fe0: 7374 6174 652e 6573 7469 6d61 7465 5f65  state.estimate_e
-00010ff0: 7272 6f72 2865 7272 6f72 5f6f 703d 6375  rror(error_op=cu
-00011000: 7272 656e 745f 6f70 6572 6174 6f72 2c20  rrent_operator, 
-00011010: 696e 7465 7276 616c 733d 696e 7465 7276  intervals=interv
-00011020: 616c 7329 0a20 2020 2061 7373 6572 7420  als).    assert 
-00011030: 6572 726f 7273 2e73 6861 7065 203d 3d20  errors.shape == 
-00011040: 286c 656e 2869 6e74 6572 7661 6c73 292c  (len(intervals),
-00011050: 290a 0a20 2020 2023 2065 7272 6f72 206f  )..    # error o
-00011060: 7665 7220 6172 7261 7920 7065 7220 696e  ver array per in
-00011070: 7465 7276 616c 0a20 2020 2065 7272 6f72  terval.    error
-00011080: 7320 3d20 7374 6174 652e 6573 7469 6d61  s = state.estima
-00011090: 7465 5f65 7272 6f72 2865 7272 6f72 5f6f  te_error(error_o
-000110a0: 703d 6375 7272 656e 745f 6f70 6572 6174  p=current_operat
-000110b0: 6f72 2c20 696e 7465 7276 616c 733d 696e  or, intervals=in
-000110c0: 7465 7276 616c 732c 2066 756c 6c5f 6f75  tervals, full_ou
-000110d0: 7470 7574 3d54 7275 6529 0a20 2020 2061  tput=True).    a
-000110e0: 7373 6572 7420 6572 726f 7273 2e73 6861  ssert errors.sha
-000110f0: 7065 203d 3d20 286c 656e 2869 6e74 6572  pe == (len(inter
-00011100: 7661 6c73 292c 2920 2b20 7368 6170 655f  vals),) + shape_
-00011110: 6375 7272 656e 740a 0a20 2020 2023 202d  current..    # -
-00011120: 2d20 616e 206f 7065 7261 746f 7220 7769  - an operator wi
-00011130: 7468 2061 2073 6361 6c61 7220 6f75 7470  th a scalar outp
-00011140: 7574 0a0a 2020 2020 2320 6d61 7869 6d75  ut..    # maximu
-00011150: 6d20 6572 726f 722c 2073 756d 6d65 6420  m error, summed 
-00011160: 6f76 6572 2061 6c6c 2069 6e74 6572 7661  over all interva
-00011170: 6c73 0a20 2020 2065 7272 6f72 7320 3d20  ls.    errors = 
-00011180: 7374 6174 652e 6573 7469 6d61 7465 5f65  state.estimate_e
-00011190: 7272 6f72 2865 7272 6f72 5f6f 703d 6465  rror(error_op=de
-000111a0: 6e73 6974 795f 7375 6d29 0a20 2020 2061  nsity_sum).    a
-000111b0: 7373 6572 7420 6572 726f 7273 2e73 6861  ssert errors.sha
-000111c0: 7065 203d 3d20 2829 0a0a 2020 2020 2320  pe == ()..    # 
-000111d0: 6572 726f 7220 6f76 6572 2061 7272 6179  error over array
-000111e0: 2c20 7375 6d6d 6564 206f 7665 7220 616c  , summed over al
-000111f0: 6c20 696e 7465 7276 616c 730a 2020 2020  l intervals.    
-00011200: 6572 726f 7273 203d 2073 7461 7465 2e65  errors = state.e
-00011210: 7374 696d 6174 655f 6572 726f 7228 6572  stimate_error(er
-00011220: 726f 725f 6f70 3d64 656e 7369 7479 5f73  ror_op=density_s
-00011230: 756d 2c20 6675 6c6c 5f6f 7574 7075 743d  um, full_output=
-00011240: 5472 7565 290a 2020 2020 6173 7365 7274  True).    assert
-00011250: 2065 7272 6f72 732e 7368 6170 6520 3d3d   errors.shape ==
-00011260: 2073 6861 7065 5f64 656e 7369 7479 5f73   shape_density_s
-00011270: 756d 0a0a 2020 2020 2320 6d61 7869 6d75  um..    # maximu
-00011280: 6d20 6572 726f 7220 7065 7220 696e 7465  m error per inte
-00011290: 7276 616c 0a20 2020 2065 7272 6f72 7320  rval.    errors 
-000112a0: 3d20 7374 6174 652e 6573 7469 6d61 7465  = state.estimate
-000112b0: 5f65 7272 6f72 2865 7272 6f72 5f6f 703d  _error(error_op=
-000112c0: 6465 6e73 6974 795f 7375 6d2c 2069 6e74  density_sum, int
-000112d0: 6572 7661 6c73 3d69 6e74 6572 7661 6c73  ervals=intervals
-000112e0: 290a 2020 2020 6173 7365 7274 2065 7272  ).    assert err
-000112f0: 6f72 732e 7368 6170 6520 3d3d 2028 6c65  ors.shape == (le
-00011300: 6e28 696e 7465 7276 616c 7329 2c29 0a0a  n(intervals),)..
-00011310: 2020 2020 2320 6572 726f 7220 6f76 6572      # error over
-00011320: 2061 7272 6179 2070 6572 2069 6e74 6572   array per inter
-00011330: 7661 6c0a 2020 2020 6572 726f 7273 203d  val.    errors =
-00011340: 2073 7461 7465 2e65 7374 696d 6174 655f   state.estimate_
-00011350: 6572 726f 7228 6572 726f 725f 6f70 3d64  error(error_op=d
-00011360: 656e 7369 7479 5f73 756d 2c20 696e 7465  ensity_sum, inte
-00011370: 7276 616c 733d 696e 7465 7276 616c 732c  rvals=intervals,
-00011380: 2066 756c 6c5f 6f75 7470 7574 3d54 7275   full_output=Tru
-00011390: 6529 0a20 2020 2061 7373 6572 7420 6572  e).    assert er
-000113a0: 726f 7273 2e73 6861 7065 203d 3d20 286c  rors.shape == (l
-000113b0: 656e 2869 6e74 6572 7661 6c73 292c 2920  en(intervals),) 
-000113c0: 2b20 7368 6170 655f 6465 6e73 6974 795f  + shape_density_
-000113d0: 7375 6d0a 0a20 2020 2023 202d 2d2d 2073  sum..    # --- s
-000113e0: 6574 2063 7572 7265 6e74 206f 7065 7261  et current opera
-000113f0: 746f 7220 6173 2064 6566 6175 6c74 2066  tor as default f
-00011400: 726f 6d20 7468 6520 6265 6769 6e6e 696e  rom the beginnin
-00011410: 670a 0a20 2020 2073 7461 7465 203d 206d  g..    state = m
-00011420: 616e 7962 6f64 792e 5374 6174 6528 7379  anybody.State(sy
-00011430: 7374 2c20 746d 6178 2c20 6f63 6375 7061  st, tmax, occupa
-00011440: 7469 6f6e 2c20 7061 7261 6d73 3d70 6172  tion, params=par
-00011450: 616d 732c 0a20 2020 2020 2020 2020 2020  ams,.           
-00011460: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011470: 6572 726f 725f 6f70 3d63 7572 7265 6e74  error_op=current
-00011480: 5f6f 7065 7261 746f 722c 2072 6566 696e  _operator, refin
-00011490: 653d 4661 6c73 6529 0a0a 2020 2020 6572  e=False)..    er
-000114a0: 726f 7273 203d 2073 7461 7465 2e65 7374  rors = state.est
-000114b0: 696d 6174 655f 6572 726f 7228 290a 2020  imate_error().  
-000114c0: 2020 6173 7365 7274 2065 7272 6f72 732e    assert errors.
-000114d0: 7368 6170 6520 3d3d 2028 290a 0a20 2020  shape == ()..   
-000114e0: 2023 2065 7272 6f72 206f 7665 7220 6172   # error over ar
-000114f0: 7261 792c 2073 756d 6d65 6420 6f76 6572  ray, summed over
-00011500: 2061 6c6c 2069 6e74 6572 7661 6c73 0a20   all intervals. 
-00011510: 2020 2065 7272 6f72 7320 3d20 7374 6174     errors = stat
-00011520: 652e 6573 7469 6d61 7465 5f65 7272 6f72  e.estimate_error
-00011530: 2866 756c 6c5f 6f75 7470 7574 3d54 7275  (full_output=Tru
-00011540: 6529 0a20 2020 2061 7373 6572 7420 6572  e).    assert er
-00011550: 726f 7273 2e73 6861 7065 203d 3d20 7368  rors.shape == sh
-00011560: 6170 655f 6375 7272 656e 740a 0a20 2020  ape_current..   
-00011570: 2023 206d 6178 696d 756d 2065 7272 6f72   # maximum error
-00011580: 2070 6572 2069 6e74 6572 7661 6c0a 2020   per interval.  
-00011590: 2020 6572 726f 7273 203d 2073 7461 7465    errors = state
-000115a0: 2e65 7374 696d 6174 655f 6572 726f 7228  .estimate_error(
-000115b0: 696e 7465 7276 616c 733d 696e 7465 7276  intervals=interv
-000115c0: 616c 7329 0a20 2020 2061 7373 6572 7420  als).    assert 
-000115d0: 6572 726f 7273 2e73 6861 7065 203d 3d20  errors.shape == 
-000115e0: 286c 656e 2869 6e74 6572 7661 6c73 292c  (len(intervals),
-000115f0: 290a 0a20 2020 2023 2065 7272 6f72 206f  )..    # error o
-00011600: 7665 7220 6172 7261 7920 7065 7220 696e  ver array per in
-00011610: 7465 7276 616c 0a20 2020 2065 7272 6f72  terval.    error
-00011620: 7320 3d20 7374 6174 652e 6573 7469 6d61  s = state.estima
-00011630: 7465 5f65 7272 6f72 2869 6e74 6572 7661  te_error(interva
-00011640: 6c73 3d69 6e74 6572 7661 6c73 2c20 6675  ls=intervals, fu
-00011650: 6c6c 5f6f 7574 7075 743d 5472 7565 290a  ll_output=True).
-00011660: 2020 2020 6173 7365 7274 2065 7272 6f72      assert error
-00011670: 732e 7368 6170 6520 3d3d 2028 6c65 6e28  s.shape == (len(
-00011680: 696e 7465 7276 616c 7329 2c29 202b 2073  intervals),) + s
-00011690: 6861 7065 5f63 7572 7265 6e74 0a0a 0a40  hape_current...@
-000116a0: 7079 7465 7374 2e6d 6172 6b2e 696e 7465  pytest.mark.inte
-000116b0: 6774 6573 7420 2023 206d 6172 6b65 7220  gtest  # marker 
-000116c0: 666f 7220 696e 7465 6772 6174 696f 6e20  for integration 
-000116d0: 7465 7374 730a 6465 6620 7465 7374 5f6d  tests.def test_m
-000116e0: 616e 7962 6f64 795f 7374 6174 655f 6573  anybody_state_es
-000116f0: 7469 6d61 7465 5f65 7272 6f72 5f6e 6f6e  timate_error_non
-00011700: 5f6b 726f 6e72 6f64 2829 3a0a 0a20 2020  _kronrod():..   
-00011710: 2073 7973 7420 3d20 6d61 6b65 5f73 7973   syst = make_sys
-00011720: 7465 6d28 292e 6669 6e61 6c69 7a65 6428  tem().finalized(
-00011730: 290a 0a20 2020 2074 6d61 7820 3d20 3530  )..    tmax = 50
-00011740: 300a 2020 2020 7061 7261 6d73 203d 207b  0.    params = {
-00011750: 2776 273a 2030 2e30 3030 312c 2027 7430  'v': 0.0001, 't0
-00011760: 273a 2030 2c20 2741 273a 2030 2e30 3031  ': 0, 'A': 0.001
-00011770: 3537 2c20 2773 6967 6d61 273a 2032 347d  57, 'sigma': 24}
-00011780: 0a0a 2020 2020 6f63 6375 7061 7469 6f6e  ..    occupation
-00011790: 203d 206d 616e 7962 6f64 792e 6c65 6164   = manybody.lead
-000117a0: 5f6f 6363 7570 6174 696f 6e28 6368 656d  _occupation(chem
-000117b0: 6963 616c 5f70 6f74 656e 7469 616c 3d33  ical_potential=3
-000117c0: 290a 0a20 2020 2073 7461 7465 203d 206d  )..    state = m
-000117d0: 616e 7962 6f64 792e 5374 6174 6528 7379  anybody.State(sy
-000117e0: 7374 2c20 746d 6178 2c20 6f63 6375 7061  st, tmax, occupa
-000117f0: 7469 6f6e 2c20 7061 7261 6d73 3d70 6172  tion, params=par
-00011800: 616d 732c 2072 6566 696e 653d 4661 6c73  ams, refine=Fals
-00011810: 6529 0a20 2020 2069 6e74 6572 7661 6c73  e).    intervals
-00011820: 203d 2073 7461 7465 2e67 6574 5f69 6e74   = state.get_int
-00011830: 6572 7661 6c73 2829 0a20 2020 2067 6175  ervals().    gau
-00011840: 7373 5f69 6e74 6572 7661 6c20 3d20 696e  ss_interval = in
-00011850: 7465 7276 616c 735b 305d 0a20 2020 2067  tervals[0].    g
-00011860: 6175 7373 5f69 6e74 6572 7661 6c2e 7175  auss_interval.qu
-00011870: 6164 7261 7475 7265 203d 2027 6761 7573  adrature = 'gaus
-00011880: 736c 6567 656e 6472 6527 0a0a 2020 2020  slegendre'..    
-00011890: 7769 7468 2070 7974 6573 742e 7261 6973  with pytest.rais
-000118a0: 6573 2856 616c 7565 4572 726f 7229 2061  es(ValueError) a
-000118b0: 7320 6578 633a 0a20 2020 2020 2020 2073  s exc:.        s
-000118c0: 7461 7465 2e65 7374 696d 6174 655f 6572  tate.estimate_er
-000118d0: 726f 7228 696e 7465 7276 616c 733d 6761  ror(intervals=ga
-000118e0: 7573 735f 696e 7465 7276 616c 290a 2020  uss_interval).  
-000118f0: 2020 6173 7365 7274 2073 7472 2865 7863    assert str(exc
-00011900: 2e76 616c 7565 2920 696e 2022 7175 6164  .value) in "quad
-00011910: 7061 636b 2065 7272 6f72 2065 7374 696d  pack error estim
-00011920: 6174 6520 776f 726b 7320 6f6e 6c79 206f  ate works only o
-00011930: 6e20 4761 7573 732d 4b72 6f6e 726f 6420  n Gauss-Kronrod 
-00011940: 7175 6164 7261 7475 7265 2069 6e74 6572  quadrature inter
-00011950: 7661 6c73 220a 0a0a 4070 7974 6573 742e  vals"...@pytest.
-00011960: 6d61 726b 2e69 6e74 6567 7465 7374 2020  mark.integtest  
-00011970: 2320 6d61 726b 6572 2066 6f72 2069 6e74  # marker for int
-00011980: 6567 7261 7469 6f6e 2074 6573 7473 0a64  egration tests.d
-00011990: 6566 2074 6573 745f 7469 6d65 5f6e 616d  ef test_time_nam
-000119a0: 655f 616e 645f 7374 6172 745f 6465 6661  e_and_start_defa
-000119b0: 756c 745f 6368 616e 6765 5f6d 616e 7962  ult_change_manyb
-000119c0: 6f64 795f 7374 6174 6528 293a 0a0a 2020  ody_state():..  
-000119d0: 2020 4e20 3d20 330a 2020 2020 6c61 7420    N = 3.    lat 
-000119e0: 3d20 6b77 616e 742e 6c61 7474 6963 652e  = kwant.lattice.
-000119f0: 7371 7561 7265 286e 6f72 6273 3d32 290a  square(norbs=2).
-00011a00: 2020 2020 4930 203d 2074 612e 6964 656e      I0 = ta.iden
-00011a10: 7469 7479 2832 290a 2020 2020 535a 203d  tity(2).    SZ =
-00011a20: 2074 612e 6172 7261 7928 5b5b 312c 2030   ta.array([[1, 0
-00011a30: 5d2c 205b 302c 202d 315d 5d29 0a20 2020  ], [0, -1]]).   
-00011a40: 2075 6e69 666f 726d 203d 206b 7761 6e74   uniform = kwant
-00011a50: 2e64 6967 6573 742e 756e 6966 6f72 6d0a  .digest.uniform.
-00011a60: 0a20 2020 2074 6d61 7820 3d20 3130 300a  .    tmax = 100.
-00011a70: 2020 2020 7061 7261 6d73 203d 207b 2773      params = {'s
-00011a80: 616c 7427 3a20 2731 277d 0a20 2020 206f  alt': '1'}.    o
-00011a90: 6363 7570 6174 696f 6e20 3d20 6d61 6e79  ccupation = many
-00011aa0: 626f 6479 2e6c 6561 645f 6f63 6375 7061  body.lead_occupa
-00011ab0: 7469 6f6e 2863 6865 6d69 6361 6c5f 706f  tion(chemical_po
-00011ac0: 7465 6e74 6961 6c3d 3129 0a0a 2020 2020  tential=1)..    
-00011ad0: 6465 6620 6d61 6b65 5f73 696d 706c 655f  def make_simple_
-00011ae0: 6c65 6164 286c 6174 2c20 4e29 3a0a 2020  lead(lat, N):.  
-00011af0: 2020 2020 2020 4930 203d 2074 612e 6964        I0 = ta.id
-00011b00: 656e 7469 7479 286c 6174 2e6e 6f72 6273  entity(lat.norbs
-00011b10: 290a 2020 2020 2020 2020 7379 7374 203d  ).        syst =
-00011b20: 206b 7761 6e74 2e42 7569 6c64 6572 286b   kwant.Builder(k
-00011b30: 7761 6e74 2e54 7261 6e73 6c61 7469 6f6e  want.Translation
-00011b40: 616c 5379 6d6d 6574 7279 2828 2d31 2c20  alSymmetry((-1, 
-00011b50: 3029 2929 0a20 2020 2020 2020 2073 7973  0))).        sys
-00011b60: 745b 286c 6174 2830 2c20 6a29 2066 6f72  t[(lat(0, j) for
-00011b70: 206a 2069 6e20 7261 6e67 6528 4e29 295d   j in range(N))]
-00011b80: 203d 2034 202a 2049 300a 2020 2020 2020   = 4 * I0.      
-00011b90: 2020 7379 7374 5b6c 6174 2e6e 6569 6768    syst[lat.neigh
-00011ba0: 626f 7273 2829 5d20 3d20 2d31 202a 2049  bors()] = -1 * I
-00011bb0: 300a 2020 2020 2020 2020 7265 7475 726e  0.        return
-00011bc0: 2073 7973 740a 0a20 2020 2064 6566 2074   syst..    def t
-00011bd0: 645f 6f6e 7369 7465 5f74 696d 6528 7369  d_onsite_time(si
-00011be0: 7465 2c20 7469 6d65 2c20 7361 6c74 293a  te, time, salt):
-00011bf0: 0a20 2020 2020 2020 2073 7461 7469 635f  .        static_
-00011c00: 7061 7274 203d 2028 3420 2b20 756e 6966  part = (4 + unif
-00011c10: 6f72 6d28 7369 7465 2e74 6167 2c20 7361  orm(site.tag, sa
-00011c20: 6c74 3d73 616c 7429 2920 2a20 4930 0a20  lt=salt)) * I0. 
-00011c30: 2020 2020 2020 2074 645f 7061 7274 203d         td_part =
-00011c40: 2053 5a20 2a20 7369 6e28 7469 6d65 290a   SZ * sin(time).
-00011c50: 2020 2020 2020 2020 7265 7475 726e 2073          return s
-00011c60: 7461 7469 635f 7061 7274 202b 2074 645f  tatic_part + td_
-00011c70: 7061 7274 0a0a 2020 2020 6465 6620 7068  part..    def ph
-00011c80: 695f 7469 6d65 2874 696d 652c 2073 616c  i_time(time, sal
-00011c90: 7429 3a0a 2020 2020 2020 2020 7265 7475  t):.        retu
-00011ca0: 726e 2028 3120 2d20 636f 7328 7469 6d65  rn (1 - cos(time
-00011cb0: 2929 202a 2074 612e 6172 7261 7928 5b31  )) * ta.array([1
-00011cc0: 2c20 2d31 5d29 2020 2320 6469 6167 6f6e  , -1])  # diagon
-00011cd0: 616c 2070 6172 740a 0a20 2020 207a 6569  al part..    zei
-00011ce0: 745f 6f66 6673 6574 203d 2034 3220 2023  t_offset = 42  #
-00011cf0: 2074 6865 2069 6e69 7469 616c 2074 696d   the initial tim
-00011d00: 650a 0a20 2020 2064 6566 2074 645f 6f6e  e..    def td_on
-00011d10: 7369 7465 5f7a 6569 7428 7369 7465 2c20  site_zeit(site, 
-00011d20: 7a65 6974 2c20 7361 6c74 293a 0a20 2020  zeit, salt):.   
-00011d30: 2020 2020 2074 696d 6520 3d20 7a65 6974       time = zeit
-00011d40: 202d 207a 6569 745f 6f66 6673 6574 0a20   - zeit_offset. 
-00011d50: 2020 2020 2020 2073 7461 7469 635f 7061         static_pa
-00011d60: 7274 203d 2028 3420 2b20 756e 6966 6f72  rt = (4 + unifor
-00011d70: 6d28 7369 7465 2e74 6167 2c20 7361 6c74  m(site.tag, salt
-00011d80: 3d73 616c 7429 2920 2a20 4930 0a20 2020  =salt)) * I0.   
-00011d90: 2020 2020 2074 645f 7061 7274 203d 2053       td_part = S
-00011da0: 5a20 2a20 7369 6e28 7469 6d65 290a 2020  Z * sin(time).  
-00011db0: 2020 2020 2020 7265 7475 726e 2073 7461        return sta
-00011dc0: 7469 635f 7061 7274 202b 2074 645f 7061  tic_part + td_pa
-00011dd0: 7274 0a0a 2020 2020 6465 6620 7068 695f  rt..    def phi_
-00011de0: 7a65 6974 287a 6569 742c 2073 616c 7429  zeit(zeit, salt)
-00011df0: 3a0a 2020 2020 2020 2020 7469 6d65 203d  :.        time =
-00011e00: 207a 6569 7420 2d20 7a65 6974 5f6f 6666   zeit - zeit_off
-00011e10: 7365 740a 2020 2020 2020 2020 7265 7475  set.        retu
-00011e20: 726e 2028 3120 2d20 636f 7328 7469 6d65  rn (1 - cos(time
-00011e30: 2929 202a 2074 612e 6172 7261 7928 5b31  )) * ta.array([1
-00011e40: 2c20 2d31 5d29 2020 2320 6469 6167 6f6e  , -1])  # diagon
-00011e50: 616c 2070 6172 740a 0a20 2020 2023 2323  al part..    ###
-00011e60: 2074 6573 7420 7768 656e 2061 6464 696e   test when addin
-00011e70: 6720 7469 6d65 2d64 6570 656e 6465 6e74  g time-dependent
-00011e80: 2076 6f6c 7461 6765 2065 7665 7279 7768   voltage everywh
-00011e90: 6572 650a 2020 2020 7379 7374 203d 206d  ere.    syst = m
-00011ea0: 616b 655f 7464 5f73 7973 7465 6d5f 7769  ake_td_system_wi
-00011eb0: 7468 5f6c 6561 6473 286c 6174 2c20 4e2c  th_leads(lat, N,
-00011ec0: 206d 616b 655f 7369 6d70 6c65 5f6c 6561   make_simple_lea
-00011ed0: 642c 2074 645f 6f6e 7369 7465 5f74 696d  d, td_onsite_tim
-00011ee0: 6529 0a20 2020 206c 6561 6473 2e61 6464  e).    leads.add
-00011ef0: 5f76 6f6c 7461 6765 2873 7973 742c 2030  _voltage(syst, 0
-00011f00: 2c20 7068 695f 7469 6d65 290a 2020 2020  , phi_time).    
-00011f10: 6c65 6164 732e 6164 645f 766f 6c74 6167  leads.add_voltag
-00011f20: 6528 7379 7374 2c20 312c 2070 6869 5f74  e(syst, 1, phi_t
-00011f30: 696d 6529 0a20 2020 2066 7379 7374 5f74  ime).    fsyst_t
-00011f40: 696d 6520 3d20 7379 7374 2e66 696e 616c  ime = syst.final
-00011f50: 697a 6564 2829 0a0a 2020 2020 7379 7374  ized()..    syst
-00011f60: 203d 206d 616b 655f 7464 5f73 7973 7465   = make_td_syste
-00011f70: 6d5f 7769 7468 5f6c 6561 6473 286c 6174  m_with_leads(lat
-00011f80: 2c20 4e2c 206d 616b 655f 7369 6d70 6c65  , N, make_simple
-00011f90: 5f6c 6561 642c 2074 645f 6f6e 7369 7465  _lead, td_onsite
-00011fa0: 5f7a 6569 7429 0a20 2020 206c 6561 6473  _zeit).    leads
-00011fb0: 2e61 6464 5f76 6f6c 7461 6765 2873 7973  .add_voltage(sys
-00011fc0: 742c 2030 2c20 7068 695f 7a65 6974 290a  t, 0, phi_zeit).
-00011fd0: 2020 2020 6c65 6164 732e 6164 645f 766f      leads.add_vo
-00011fe0: 6c74 6167 6528 7379 7374 2c20 312c 2070  ltage(syst, 1, p
-00011ff0: 6869 5f7a 6569 7429 0a20 2020 2066 7379  hi_zeit).    fsy
-00012000: 7374 5f7a 6569 7420 3d20 7379 7374 2e66  st_zeit = syst.f
-00012010: 696e 616c 697a 6564 2829 0a0a 2020 2020  inalized()..    
-00012020: 6465 6e73 6974 795f 6f70 6572 6174 6f72  density_operator
-00012030: 5f74 696d 6520 3d20 6b77 616e 742e 6f70  _time = kwant.op
-00012040: 6572 6174 6f72 2e44 656e 7369 7479 2866  erator.Density(f
-00012050: 7379 7374 5f74 696d 6529 0a20 2020 2064  syst_time).    d
-00012060: 656e 7369 7479 5f6f 7065 7261 746f 725f  ensity_operator_
-00012070: 7a65 6974 203d 206b 7761 6e74 2e6f 7065  zeit = kwant.ope
-00012080: 7261 746f 722e 4465 6e73 6974 7928 6673  rator.Density(fs
-00012090: 7973 745f 7a65 6974 290a 0a20 2020 2023  yst_zeit)..    #
-000120a0: 2064 6566 6175 6c74 0a20 2020 2073 7461   default.    sta
-000120b0: 7465 5f74 696d 6520 3d20 6d61 6e79 626f  te_time = manybo
-000120c0: 6479 2e53 7461 7465 2866 7379 7374 5f74  dy.State(fsyst_t
-000120d0: 696d 652c 2074 6d61 782c 206f 6363 7570  ime, tmax, occup
-000120e0: 6174 696f 6e2c 2070 6172 616d 733d 7061  ation, params=pa
-000120f0: 7261 6d73 2c20 7265 6669 6e65 3d46 616c  rams, refine=Fal
-00012100: 7365 290a 0a20 2020 2023 2064 6566 6175  se)..    # defau
-00012110: 6c74 2063 6861 6e67 6564 0a20 2020 2057  lt changed.    W
-00012120: 6176 6546 756e 6374 696f 6e5f 7a65 6974  aveFunction_zeit
-00012130: 203d 2066 756e 6374 6f6f 6c73 2e70 6172   = functools.par
-00012140: 7469 616c 286f 6e65 626f 6479 2e57 6176  tial(onebody.Wav
-00012150: 6546 756e 6374 696f 6e2e 6672 6f6d 5f6b  eFunction.from_k
-00012160: 7761 6e74 2c20 7469 6d65 5f6e 616d 653d  want, time_name=
-00012170: 277a 6569 7427 2c0a 2020 2020 2020 2020  'zeit',.        
-00012180: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000121a0: 2020 7469 6d65 5f73 7461 7274 3d7a 6569    time_start=zei
-000121b0: 745f 6f66 6673 6574 290a 2020 2020 7363  t_offset).    sc
-000121c0: 6174 7465 7269 6e67 5f73 7461 7465 5f7a  attering_state_z
-000121d0: 6569 7420 3d20 6675 6e63 746f 6f6c 732e  eit = functools.
-000121e0: 7061 7274 6961 6c28 6f6e 6562 6f64 792e  partial(onebody.
-000121f0: 5363 6174 7465 7269 6e67 5374 6174 6573  ScatteringStates
-00012200: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-00012210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012230: 7761 7665 6675 6e63 7469 6f6e 5f74 7970  wavefunction_typ
-00012240: 653d 5761 7665 4675 6e63 7469 6f6e 5f7a  e=WaveFunction_z
-00012250: 6569 7429 0a20 2020 2073 7461 7465 5f7a  eit).    state_z
-00012260: 6569 7420 3d20 6d61 6e79 626f 6479 2e53  eit = manybody.S
-00012270: 7461 7465 2866 7379 7374 5f7a 6569 742c  tate(fsyst_zeit,
-00012280: 2074 6d61 782c 206f 6363 7570 6174 696f   tmax, occupatio
-00012290: 6e2c 2070 6172 616d 733d 7061 7261 6d73  n, params=params
-000122a0: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
-000122b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000122c0: 2020 7363 6174 7465 7269 6e67 5f73 7461    scattering_sta
-000122d0: 7465 5f74 7970 653d 7363 6174 7465 7269  te_type=scatteri
-000122e0: 6e67 5f73 7461 7465 5f7a 6569 742c 2072  ng_state_zeit, r
-000122f0: 6566 696e 653d 4661 6c73 6529 0a0a 2020  efine=False)..  
-00012300: 2020 666f 7220 7469 6d65 2069 6e20 2830    for time in (0
-00012310: 2e2c 2031 2e2c 2035 2e29 3a0a 0a20 2020  ., 1., 5.):..   
-00012320: 2020 2020 2073 7461 7465 5f74 696d 652e       state_time.
-00012330: 6576 6f6c 7665 2874 696d 6529 0a20 2020  evolve(time).   
-00012340: 2020 2020 2073 7461 7465 5f7a 6569 742e       state_zeit.
-00012350: 6576 6f6c 7665 2874 696d 6520 2b20 7a65  evolve(time + ze
-00012360: 6974 5f6f 6666 7365 7429 0a0a 2020 2020  it_offset)..    
-00012370: 2020 2020 666f 7220 5f2c 2070 7369 2069      for _, psi i
-00012380: 6e20 7374 6174 655f 7469 6d65 2e6d 616e  n state_time.man
-00012390: 7962 6f64 795f 7761 7665 6675 6e63 7469  ybody_wavefuncti
-000123a0: 6f6e 2e70 7369 2e5f 6461 7461 2e69 7465  on.psi._data.ite
-000123b0: 6d73 2829 3a0a 2020 2020 2020 2020 2020  ms():.          
-000123c0: 2020 6173 7365 7274 2070 7369 2e74 696d    assert psi.tim
-000123d0: 6520 3d3d 2074 696d 650a 2020 2020 2020  e == time.      
-000123e0: 2020 2020 2020 6173 7365 7274 2070 7369        assert psi
-000123f0: 2e74 696d 655f 7374 6172 7420 3d3d 2030  .time_start == 0
-00012400: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
-00012410: 6572 7420 7073 692e 7469 6d65 5f6e 616d  ert psi.time_nam
-00012420: 6520 3d3d 2027 7469 6d65 270a 0a20 2020  e == 'time'..   
-00012430: 2020 2020 2066 6f72 205f 2c20 7073 6920       for _, psi 
-00012440: 696e 2073 7461 7465 5f7a 6569 742e 6d61  in state_zeit.ma
-00012450: 6e79 626f 6479 5f77 6176 6566 756e 6374  nybody_wavefunct
-00012460: 696f 6e2e 7073 692e 5f64 6174 612e 6974  ion.psi._data.it
-00012470: 656d 7328 293a 0a20 2020 2020 2020 2020  ems():.         
-00012480: 2020 2061 7373 6572 7420 7073 692e 7469     assert psi.ti
-00012490: 6d65 203d 3d20 7469 6d65 202b 207a 6569  me == time + zei
-000124a0: 745f 6f66 6673 6574 0a20 2020 2020 2020  t_offset.       
-000124b0: 2020 2020 2061 7373 6572 7420 7073 692e       assert psi.
-000124c0: 7469 6d65 5f73 7461 7274 203d 3d20 7a65  time_start == ze
-000124d0: 6974 5f6f 6666 7365 740a 2020 2020 2020  it_offset.      
-000124e0: 2020 2020 2020 6173 7365 7274 2070 7369        assert psi
-000124f0: 2e74 696d 655f 6e61 6d65 203d 3d20 277a  .time_name == 'z
-00012500: 6569 7427 0a0a 2020 2020 2020 2020 2320  eit'..        # 
-00012510: 6368 6563 6b20 7468 6174 2072 6573 756c  check that resul
-00012520: 7420 6973 2073 696d 696c 6172 2074 6f20  t is similar to 
-00012530: 6465 6661 756c 7420 7265 7375 6c74 0a20  default result. 
-00012540: 2020 2020 2020 2064 656e 7369 7479 5f74         density_t
-00012550: 696d 6520 3d20 7374 6174 655f 7469 6d65  ime = state_time
-00012560: 2e65 7661 6c75 6174 6528 6465 6e73 6974  .evaluate(densit
-00012570: 795f 6f70 6572 6174 6f72 5f74 696d 6529  y_operator_time)
-00012580: 0a20 2020 2020 2020 2064 656e 7369 7479  .        density
-00012590: 5f7a 6569 7420 3d20 7374 6174 655f 7469  _zeit = state_ti
-000125a0: 6d65 2e65 7661 6c75 6174 6528 6465 6e73  me.evaluate(dens
-000125b0: 6974 795f 6f70 6572 6174 6f72 5f7a 6569  ity_operator_zei
-000125c0: 7429 0a20 2020 2020 2020 2061 7373 6572  t).        asser
-000125d0: 745f 6172 7261 795f 616c 6d6f 7374 5f65  t_array_almost_e
-000125e0: 7175 616c 2864 656e 7369 7479 5f74 696d  qual(density_tim
-000125f0: 652c 2064 656e 7369 7479 5f7a 6569 7429  e, density_zeit)
-00012600: 0a0a 2020 2020 666f 7220 7430 2069 6e20  ..    for t0 in 
-00012610: 5b31 202b 2031 6a2c 2027 6127 2c20 4e6f  [1 + 1j, 'a', No
-00012620: 6e65 2c20 2d66 6c6f 6174 2827 696e 6627  ne, -float('inf'
-00012630: 292c 2066 6c6f 6174 2827 696e 6627 295d  ), float('inf')]
-00012640: 3a0a 2020 2020 2020 2020 5761 7665 4675  :.        WaveFu
-00012650: 6e63 7469 6f6e 5f7a 6569 7420 3d20 6675  nction_zeit = fu
-00012660: 6e63 746f 6f6c 732e 7061 7274 6961 6c28  nctools.partial(
-00012670: 6f6e 6562 6f64 792e 5761 7665 4675 6e63  onebody.WaveFunc
-00012680: 7469 6f6e 2e66 726f 6d5f 6b77 616e 742c  tion.from_kwant,
-00012690: 2074 696d 655f 6e61 6d65 3d27 7a65 6974   time_name='zeit
-000126a0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
-000126b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000126d0: 2074 696d 655f 7374 6172 743d 7430 290a   time_start=t0).
-000126e0: 2020 2020 2020 2020 7363 6174 7465 7269          scatteri
-000126f0: 6e67 5f73 7461 7465 5f7a 6569 7420 3d20  ng_state_zeit = 
-00012700: 6675 6e63 746f 6f6c 732e 7061 7274 6961  functools.partia
-00012710: 6c28 6f6e 6562 6f64 792e 5363 6174 7465  l(onebody.Scatte
-00012720: 7269 6e67 5374 6174 6573 2c0a 2020 2020  ringStates,.    
-00012730: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012750: 2020 2020 2020 2020 2020 2020 2020 7761                wa
-00012760: 7665 6675 6e63 7469 6f6e 5f74 7970 653d  vefunction_type=
-00012770: 5761 7665 4675 6e63 7469 6f6e 5f7a 6569  WaveFunction_zei
-00012780: 7429 0a20 2020 2020 2020 2077 6974 6820  t).        with 
-00012790: 7079 7465 7374 2e72 6169 7365 7328 5479  pytest.raises(Ty
-000127a0: 7065 4572 726f 7229 2061 7320 6578 633a  peError) as exc:
-000127b0: 0a20 2020 2020 2020 2020 2020 206d 616e  .            man
-000127c0: 7962 6f64 792e 5374 6174 6528 6673 7973  ybody.State(fsys
-000127d0: 745f 7a65 6974 2c20 746d 6178 2c20 6f63  t_zeit, tmax, oc
-000127e0: 6375 7061 7469 6f6e 2c20 7061 7261 6d73  cupation, params
-000127f0: 3d70 6172 616d 732c 0a20 2020 2020 2020  =params,.       
-00012800: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012810: 2020 2020 7363 6174 7465 7269 6e67 5f73      scattering_s
-00012820: 7461 7465 5f74 7970 653d 7363 6174 7465  tate_type=scatte
-00012830: 7269 6e67 5f73 7461 7465 5f7a 6569 742c  ring_state_zeit,
-00012840: 2072 6566 696e 653d 4661 6c73 6529 0a20   refine=False). 
-00012850: 2020 2020 2020 2061 7373 6572 7420 7374         assert st
-00012860: 7228 6578 632e 7661 6c75 6529 203d 3d20  r(exc.value) == 
-00012870: 2274 696d 6520 6d75 7374 2062 6520 6120  "time must be a 
-00012880: 6669 6e69 7465 2072 6561 6c20 6e75 6d62  finite real numb
-00012890: 6572 220a 0a0a 4070 7974 6573 742e 6d61  er"...@pytest.ma
-000128a0: 726b 2e69 6e74 6567 7465 7374 0a64 6566  rk.integtest.def
-000128b0: 2074 6573 745f 6576 616c 7561 7465 5f69   test_evaluate_i
-000128c0: 6e74 6567 7261 6e64 2829 3a0a 0a20 2020  ntegrand():..   
-000128d0: 2073 7973 7420 3d20 6d61 6b65 5f73 7973   syst = make_sys
-000128e0: 7465 6d28 292e 6669 6e61 6c69 7a65 6428  tem().finalized(
-000128f0: 290a 2020 2020 6465 6e73 6974 795f 6f70  ).    density_op
-00012900: 6572 6174 6f72 203d 206b 7761 6e74 2e6f  erator = kwant.o
-00012910: 7065 7261 746f 722e 4465 6e73 6974 7928  perator.Density(
-00012920: 7379 7374 290a 0a20 2020 2074 6d61 7820  syst)..    tmax 
-00012930: 3d20 3130 0a20 2020 2074 696d 6520 3d20  = 10.    time = 
-00012940: 3120 2023 2074 696d 6573 7465 7020 7765  1  # timestep we
-00012950: 206c 696b 6520 746f 2065 7661 6c75 6174   like to evaluat
-00012960: 6520 7468 6520 696e 7465 6772 616e 640a  e the integrand.
-00012970: 2020 2020 7061 7261 6d73 203d 207b 2776      params = {'v
-00012980: 273a 2030 2e30 3030 312c 2027 7430 273a  ': 0.0001, 't0':
-00012990: 2030 2c20 2741 273a 2030 2e30 3031 3537   0, 'A': 0.00157
-000129a0: 2c20 2773 6967 6d61 273a 2032 347d 0a0a  , 'sigma': 24}..
-000129b0: 2020 2020 6f63 6375 7061 7469 6f6e 203d      occupation =
-000129c0: 206d 616e 7962 6f64 792e 6c65 6164 5f6f   manybody.lead_o
-000129d0: 6363 7570 6174 696f 6e28 6368 656d 6963  ccupation(chemic
-000129e0: 616c 5f70 6f74 656e 7469 616c 3d33 290a  al_potential=3).
-000129f0: 2020 2020 7374 6174 6520 3d20 6d61 6e79      state = many
-00012a00: 626f 6479 2e53 7461 7465 2873 7973 742c  body.State(syst,
-00012a10: 2074 6d61 782c 206f 6363 7570 6174 696f   tmax, occupatio
-00012a20: 6e2c 2070 6172 616d 733d 7061 7261 6d73  n, params=params
-00012a30: 2c20 7265 6669 6e65 3d46 616c 7365 290a  , refine=False).
-00012a40: 2020 2020 7374 6174 652e 6576 6f6c 7665      state.evolve
-00012a50: 2874 696d 6529 0a0a 2020 2020 2320 6361  (time)..    # ca
-00012a60: 6c63 756c 6174 6520 7468 6520 696e 7465  lculate the inte
-00012a70: 6772 616e 6420 6f6e 2061 6e20 696e 7465  grand on an inte
-00012a80: 6772 616c 2077 6974 6820 7468 6520 7374  gral with the st
-00012a90: 6174 650a 2020 2020 696e 7465 7276 616c  ate.    interval
-00012aa0: 203d 206d 616e 7962 6f64 792e 496e 7465   = manybody.Inte
-00012ab0: 7276 616c 286c 6561 643d 302c 2062 616e  rval(lead=0, ban
-00012ac0: 643d 302c 206b 6d69 6e3d 302e 3032 2c20  d=0, kmin=0.02, 
-00012ad0: 6b6d 6178 3d30 2e31 290a 2020 2020 7374  kmax=0.1).    st
-00012ae0: 6174 652e 5f61 6464 5f69 6e74 6572 7661  ate._add_interva
-00012af0: 6c28 696e 7465 7276 616c 290a 2020 2020  l(interval).    
-00012b00: 6465 6e73 6974 795f 7368 6170 6520 3d20  density_shape = 
-00012b10: 7374 6174 652e 6576 616c 7561 7465 2864  state.evaluate(d
-00012b20: 656e 7369 7479 5f6f 7065 7261 746f 7229  ensity_operator)
-00012b30: 2e73 6861 7065 0a20 2020 2061 6263 6973  .shape.    abcis
-00012b40: 7361 2c20 696e 7465 6772 616e 6420 3d20  sa, integrand = 
-00012b50: 7374 6174 652e 5f63 616c 635f 696e 7465  state._calc_inte
-00012b60: 6772 616e 6428 696e 7465 7276 616c 2c20  grand(interval, 
-00012b70: 6465 6e73 6974 795f 6f70 6572 6174 6f72  density_operator
-00012b80: 290a 0a20 2020 2023 2074 6573 7420 7479  )..    # test ty
-00012b90: 7065 2061 6e64 2073 6861 7065 0a20 2020  pe and shape.   
-00012ba0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
-00012bb0: 6365 2861 6263 6973 7361 2c20 6e70 2e6e  ce(abcissa, np.n
-00012bc0: 6461 7272 6179 290a 2020 2020 6173 7365  darray).    asse
-00012bd0: 7274 2069 7369 6e73 7461 6e63 6528 696e  rt isinstance(in
-00012be0: 7465 6772 616e 642c 206e 702e 6e64 6172  tegrand, np.ndar
-00012bf0: 7261 7929 0a20 2020 2061 7373 6572 7420  ray).    assert 
-00012c00: 6162 6369 7373 612e 7368 6170 6520 3d3d  abcissa.shape ==
-00012c10: 2028 3220 2a20 696e 7465 7276 616c 2e6f   (2 * interval.o
-00012c20: 7264 6572 202b 2031 2c29 0a20 2020 2061  rder + 1,).    a
-00012c30: 7373 6572 7420 696e 7465 6772 616e 642e  ssert integrand.
-00012c40: 7368 6170 6520 3d3d 2028 3220 2a20 696e  shape == (2 * in
-00012c50: 7465 7276 616c 2e6f 7264 6572 202b 2031  terval.order + 1
-00012c60: 2c29 202b 2064 656e 7369 7479 5f73 6861  ,) + density_sha
-00012c70: 7065 0a0a 2020 2020 2320 6576 616c 7561  pe..    # evalua
-00012c80: 7465 2074 6865 2069 6e74 6567 7261 6e64  te the integrand
-00012c90: 2077 6974 6820 7468 6520 7365 7061 7261   with the separa
-00012ca0: 7465 2064 6562 7567 2072 6f75 7469 6e65  te debug routine
-00012cb0: 206f 6e20 616c 6c20 6162 6369 7373 6120   on all abcissa 
-00012cc0: 706f 696e 740a 2020 2020 2320 616e 6420  point.    # and 
-00012cd0: 6368 6563 6b20 6966 2077 6520 6f62 7461  check if we obta
-00012ce0: 696e 2069 6465 6e74 6963 616c 2072 6573  in identical res
-00012cf0: 756c 7473 0a20 2020 206d 616e 7962 6f64  ults.    manybod
-00012d00: 795f 696e 7465 6772 616e 6420 3d20 6d61  y_integrand = ma
-00012d10: 6e79 626f 6479 2e4d 616e 7962 6f64 7949  nybody.ManybodyI
-00012d20: 6e74 6567 7261 6e64 2873 7973 742c 2069  ntegrand(syst, i
-00012d30: 6e74 6572 7661 6c2c 2064 656e 7369 7479  nterval, density
-00012d40: 5f6f 7065 7261 746f 722c 0a20 2020 2020  _operator,.     
-00012d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012d70: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-00012d80: 696d 653d 7469 6d65 2c20 7061 7261 6d73  ime=time, params
-00012d90: 3d70 6172 616d 7329 0a20 2020 2069 6e74  =params).    int
-00012da0: 6567 203d 206e 702e 6172 7261 7928 5b6d  eg = np.array([m
-00012db0: 616e 7962 6f64 795f 696e 7465 6772 616e  anybody_integran
-00012dc0: 642e 6675 6e63 286b 2920 666f 7220 6b20  d.func(k) for k 
-00012dd0: 696e 2061 6263 6973 7361 5d29 0a0a 2020  in abcissa])..  
-00012de0: 2020 6173 7365 7274 206d 616e 7962 6f64    assert manybod
-00012df0: 795f 696e 7465 6772 616e 642e 6675 6e63  y_integrand.func
-00012e00: 2830 2e30 3529 2e73 6861 7065 203d 3d20  (0.05).shape == 
-00012e10: 6465 6e73 6974 795f 7368 6170 650a 2020  density_shape.  
-00012e20: 2020 6173 7365 7274 5f61 7272 6179 5f61    assert_array_a
-00012e30: 6c6d 6f73 745f 6571 7561 6c28 696e 7465  lmost_equal(inte
-00012e40: 672c 2069 6e74 6567 7261 6e64 290a 0a0a  g, integrand)...
-00012e50: 6465 6620 7465 7374 5f63 616c 635f 656e  def test_calc_en
-00012e60: 6572 6779 5f63 7574 6f66 6673 2829 3a0a  ergy_cutoffs():.
-00012e70: 0a20 2020 2063 6c61 7373 204f 6363 7570  .    class Occup
-00012e80: 6174 696f 6e3a 0a20 2020 2020 2020 2064  ation:.        d
-00012e90: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
-00012ea0: 2c20 656e 6572 6779 5f72 616e 6765 293a  , energy_range):
-00012eb0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-00012ec0: 662e 656e 6572 6779 5f72 616e 6765 203d  f.energy_range =
-00012ed0: 2065 6e65 7267 795f 7261 6e67 650a 0a20   energy_range.. 
-00012ee0: 2020 2023 202d 2d2d 2d2d 206a 7573 7420     # ----- just 
-00012ef0: 6f6e 6520 6c65 6164 0a0a 2020 2020 6f63  one lead..    oc
-00012f00: 6375 7061 7469 6f6e 203d 204f 6363 7570  cupation = Occup
-00012f10: 6174 696f 6e28 656e 6572 6779 5f72 616e  ation(energy_ran
-00012f20: 6765 3d5b 282d 352c 2031 292c 2028 322c  ge=[(-5, 1), (2,
-00012f30: 2033 295d 290a 2020 2020 656d 696e 2c20   3)]).    emin, 
-00012f40: 656d 6178 203d 206d 616e 7962 6f64 792e  emax = manybody.
-00012f50: 6361 6c63 5f65 6e65 7267 795f 6375 746f  calc_energy_cuto
-00012f60: 6666 7328 6f63 6375 7061 7469 6f6e 290a  ffs(occupation).
-00012f70: 0a20 2020 2061 7373 6572 7420 656d 696e  .    assert emin
-00012f80: 203d 3d20 2d35 0a20 2020 2061 7373 6572   == -5.    asser
-00012f90: 7420 656d 6178 203d 3d20 330a 0a20 2020  t emax == 3..   
-00012fa0: 206f 6363 7570 6174 696f 6e20 3d20 4f63   occupation = Oc
-00012fb0: 6375 7061 7469 6f6e 2865 6e65 7267 795f  cupation(energy_
-00012fc0: 7261 6e67 653d 5b28 4e6f 6e65 2c20 3129  range=[(None, 1)
-00012fd0: 2c20 2832 2c20 3329 5d29 0a20 2020 2065  , (2, 3)]).    e
-00012fe0: 6d69 6e2c 2065 6d61 7820 3d20 6d61 6e79  min, emax = many
-00012ff0: 626f 6479 2e63 616c 635f 656e 6572 6779  body.calc_energy
-00013000: 5f63 7574 6f66 6673 286f 6363 7570 6174  _cutoffs(occupat
-00013010: 696f 6e29 0a0a 2020 2020 6173 7365 7274  ion)..    assert
-00013020: 2065 6d69 6e20 6973 204e 6f6e 650a 2020   emin is None.  
-00013030: 2020 6173 7365 7274 2065 6d61 7820 3d3d    assert emax ==
-00013040: 2033 0a0a 2020 2020 6f63 6375 7061 7469   3..    occupati
-00013050: 6f6e 203d 204f 6363 7570 6174 696f 6e28  on = Occupation(
-00013060: 656e 6572 6779 5f72 616e 6765 3d5b 282d  energy_range=[(-
-00013070: 352c 2031 292c 2028 322c 204e 6f6e 6529  5, 1), (2, None)
-00013080: 5d29 0a20 2020 2065 6d69 6e2c 2065 6d61  ]).    emin, ema
-00013090: 7820 3d20 6d61 6e79 626f 6479 2e63 616c  x = manybody.cal
-000130a0: 635f 656e 6572 6779 5f63 7574 6f66 6673  c_energy_cutoffs
-000130b0: 286f 6363 7570 6174 696f 6e29 0a0a 2020  (occupation)..  
-000130c0: 2020 6173 7365 7274 2065 6d69 6e20 3d3d    assert emin ==
-000130d0: 202d 350a 2020 2020 6173 7365 7274 2065   -5.    assert e
-000130e0: 6d61 7820 6973 204e 6f6e 650a 0a20 2020  max is None..   
-000130f0: 206f 6363 7570 6174 696f 6e20 3d20 4f63   occupation = Oc
-00013100: 6375 7061 7469 6f6e 2865 6e65 7267 795f  cupation(energy_
-00013110: 7261 6e67 653d 5b28 4e6f 6e65 2c20 3129  range=[(None, 1)
-00013120: 2c20 2832 2c20 4e6f 6e65 295d 290a 2020  , (2, None)]).  
-00013130: 2020 656d 696e 2c20 656d 6178 203d 206d    emin, emax = m
-00013140: 616e 7962 6f64 792e 6361 6c63 5f65 6e65  anybody.calc_ene
-00013150: 7267 795f 6375 746f 6666 7328 6f63 6375  rgy_cutoffs(occu
-00013160: 7061 7469 6f6e 290a 0a20 2020 2061 7373  pation)..    ass
-00013170: 6572 7420 656d 696e 2069 7320 4e6f 6e65  ert emin is None
-00013180: 0a20 2020 2061 7373 6572 7420 656d 6178  .    assert emax
-00013190: 2069 7320 4e6f 6e65 0a0a 2020 2020 2320   is None..    # 
-000131a0: 2d2d 2d2d 2d20 7365 7665 7261 6c20 6c65  ----- several le
-000131b0: 6164 730a 0a20 2020 206f 6363 7570 3120  ads..    occup1 
-000131c0: 3d20 4f63 6375 7061 7469 6f6e 2865 6e65  = Occupation(ene
-000131d0: 7267 795f 7261 6e67 653d 5b28 2d35 2c20  rgy_range=[(-5, 
-000131e0: 3129 5d29 0a20 2020 206f 6363 7570 3220  1)]).    occup2 
-000131f0: 3d20 4f63 6375 7061 7469 6f6e 2865 6e65  = Occupation(ene
-00013200: 7267 795f 7261 6e67 653d 5b28 2d34 2c20  rgy_range=[(-4, 
-00013210: 312e 3529 2c20 2832 2c20 3329 5d29 0a20  1.5), (2, 3)]). 
-00013220: 2020 2065 6d69 6e2c 2065 6d61 7820 3d20     emin, emax = 
-00013230: 6d61 6e79 626f 6479 2e63 616c 635f 656e  manybody.calc_en
-00013240: 6572 6779 5f63 7574 6f66 6673 285b 6f63  ergy_cutoffs([oc
-00013250: 6375 7031 2c20 6f63 6375 7032 5d29 0a0a  cup1, occup2])..
-00013260: 2020 2020 6173 7365 7274 2065 6d69 6e20      assert emin 
-00013270: 3d3d 202d 350a 2020 2020 6173 7365 7274  == -5.    assert
-00013280: 2065 6d61 7820 3d3d 2033 0a0a 2020 2020   emax == 3..    
-00013290: 6f63 6375 7031 203d 204f 6363 7570 6174  occup1 = Occupat
-000132a0: 696f 6e28 656e 6572 6779 5f72 616e 6765  ion(energy_range
-000132b0: 3d5b 282d 352c 204e 6f6e 6529 5d29 0a20  =[(-5, None)]). 
-000132c0: 2020 206f 6363 7570 3220 3d20 4f63 6375     occup2 = Occu
-000132d0: 7061 7469 6f6e 2865 6e65 7267 795f 7261  pation(energy_ra
-000132e0: 6e67 653d 5b28 4e6f 6e65 2c20 312e 3529  nge=[(None, 1.5)
-000132f0: 2c20 2832 2c20 3329 5d29 0a20 2020 2065  , (2, 3)]).    e
-00013300: 6d69 6e2c 2065 6d61 7820 3d20 6d61 6e79  min, emax = many
-00013310: 626f 6479 2e63 616c 635f 656e 6572 6779  body.calc_energy
-00013320: 5f63 7574 6f66 6673 285b 6f63 6375 7031  _cutoffs([occup1
-00013330: 2c20 6f63 6375 7032 5d29 0a0a 2020 2020  , occup2])..    
-00013340: 6173 7365 7274 2065 6d69 6e20 6973 204e  assert emin is N
-00013350: 6f6e 650a 2020 2020 6173 7365 7274 2065  one.    assert e
-00013360: 6d61 7820 6973 204e 6f6e 650a 0a20 2020  max is None..   
-00013370: 2023 202d 2d2d 2d2d 2073 6576 6572 616c   # ----- several
-00013380: 206c 6561 6473 2c20 6f6e 6520 6c65 6164   leads, one lead
-00013390: 206e 6f74 206f 6363 7570 6965 640a 0a20   not occupied.. 
-000133a0: 2020 206f 6363 7570 3120 3d20 4f63 6375     occup1 = Occu
-000133b0: 7061 7469 6f6e 2865 6e65 7267 795f 7261  pation(energy_ra
-000133c0: 6e67 653d 5b28 2d35 2c20 3129 5d29 0a20  nge=[(-5, 1)]). 
-000133d0: 2020 206f 6363 7570 3220 3d20 4f63 6375     occup2 = Occu
-000133e0: 7061 7469 6f6e 2865 6e65 7267 795f 7261  pation(energy_ra
-000133f0: 6e67 653d 5b28 2d34 2c20 312e 3529 2c20  nge=[(-4, 1.5), 
-00013400: 2832 2c20 3329 5d29 0a0a 2020 2020 656d  (2, 3)])..    em
-00013410: 696e 2c20 656d 6178 203d 206d 616e 7962  in, emax = manyb
-00013420: 6f64 792e 6361 6c63 5f65 6e65 7267 795f  ody.calc_energy_
-00013430: 6375 746f 6666 7328 5b6f 6363 7570 312c  cutoffs([occup1,
-00013440: 206f 6363 7570 322c 204e 6f6e 655d 290a   occup2, None]).
-00013450: 0a20 2020 2061 7373 6572 7420 656d 696e  .    assert emin
-00013460: 203d 3d20 2d35 0a20 2020 2061 7373 6572   == -5.    asser
-00013470: 7420 656d 6178 203d 3d20 330a 0a20 2020  t emax == 3..   
-00013480: 2023 202d 2d2d 2d2d 206e 6f20 6c65 6164   # ----- no lead
-00013490: 2069 7320 6f63 6375 7069 6564 0a20 2020   is occupied.   
-000134a0: 2065 6d69 6e2c 2065 6d61 7820 3d20 6d61   emin, emax = ma
-000134b0: 6e79 626f 6479 2e63 616c 635f 656e 6572  nybody.calc_ener
-000134c0: 6779 5f63 7574 6f66 6673 284e 6f6e 6529  gy_cutoffs(None)
-000134d0: 0a0a 2020 2020 6173 7365 7274 2065 6d69  ..    assert emi
-000134e0: 6e20 6973 204e 6f6e 650a 2020 2020 6173  n is None.    as
-000134f0: 7365 7274 2065 6d61 7820 6973 204e 6f6e  sert emax is Non
-00013500: 650a                                     e.
+000000e0: 733a 2f2f 746b 7761 6e74 2e6b 7761 6e74  s://tkwant.kwant
+000000f0: 2d70 726f 6a65 6374 2e6f 7267 2f64 6f63  -project.org/doc
+00000100: 2f73 7461 626c 652f 7072 652f 6c69 6365  /stable/pre/lice
+00000110: 6e73 652e 6874 6d6c 2e0a 2320 4120 6c69  nse.html..# A li
+00000120: 7374 206f 6620 746b 7761 6e74 2061 7574  st of tkwant aut
+00000130: 686f 7273 2063 616e 2062 6520 666f 756e  hors can be foun
+00000140: 6420 696e 0a23 2074 6865 2066 696c 6520  d in.# the file 
+00000150: 4155 5448 4f52 532e 7273 7420 6174 2074  AUTHORS.rst at t
+00000160: 6865 2074 6f70 2d6c 6576 656c 2064 6972  he top-level dir
+00000170: 6563 746f 7279 206f 6620 7468 6973 2064  ectory of this d
+00000180: 6973 7472 6962 7574 696f 6e20 616e 6420  istribution and 
+00000190: 6174 0a23 2068 7474 7073 3a2f 2f74 6b77  at.# https://tkw
+000001a0: 616e 742e 6b77 616e 742d 7072 6f6a 6563  ant.kwant-projec
+000001b0: 742e 6f72 672f 646f 632f 7374 6162 6c65  t.org/doc/stable
+000001c0: 2f70 7265 2f61 7574 686f 7273 2e68 746d  /pre/authors.htm
+000001d0: 6c2e 0a0a 2222 2254 6573 7420 6d6f 6475  l..."""Test modu
+000001e0: 6c65 2066 6f72 2060 746b 7761 6e74 2e6d  le for `tkwant.m
+000001f0: 616e 7962 6f64 7960 2222 220a 0a69 6d70  anybody`"""..imp
+00000200: 6f72 7420 7079 7465 7374 0a66 726f 6d20  ort pytest.from 
+00000210: 7079 7465 7374 2069 6d70 6f72 7420 7261  pytest import ra
+00000220: 6973 6573 0a69 6d70 6f72 7420 636d 6174  ises.import cmat
+00000230: 680a 696d 706f 7274 206e 756d 7079 2061  h.import numpy a
+00000240: 7320 6e70 0a69 6d70 6f72 7420 6b77 616e  s np.import kwan
+00000250: 740a 6672 6f6d 206e 756d 7079 2e74 6573  t.from numpy.tes
+00000260: 7469 6e67 2069 6d70 6f72 7420 2861 7373  ting import (ass
+00000270: 6572 745f 6172 7261 795f 616c 6d6f 7374  ert_array_almost
+00000280: 5f65 7175 616c 2c20 6173 7365 7274 5f61  _equal, assert_a
+00000290: 6c6d 6f73 745f 6571 7561 6c29 0a66 726f  lmost_equal).fro
+000002a0: 6d20 7363 6970 792e 7370 6563 6961 6c20  m scipy.special 
+000002b0: 696d 706f 7274 2065 7266 0a69 6d70 6f72  import erf.impor
+000002c0: 7420 6675 6e63 746f 6f6c 730a 696d 706f  t functools.impo
+000002d0: 7274 2069 7465 7274 6f6f 6c73 0a69 6d70  rt itertools.imp
+000002e0: 6f72 7420 636f 7079 0a69 6d70 6f72 7420  ort copy.import 
+000002f0: 7469 6e79 6172 7261 7920 6173 2074 610a  tinyarray as ta.
+00000300: 6672 6f6d 206d 6174 6820 696d 706f 7274  from math import
+00000310: 2063 6f73 2c20 7369 6e2c 2065 7870 0a0a   cos, sin, exp..
+00000320: 0a66 726f 6d20 2e2e 2069 6d70 6f72 7420  .from .. import 
+00000330: 6f6e 6562 6f64 792c 206d 616e 7962 6f64  onebody, manybod
+00000340: 792c 206c 6561 6473 0a23 2066 726f 6d20  y, leads.# from 
+00000350: 746b 7761 6e74 2e74 6573 7473 2e63 6f6d  tkwant.tests.com
+00000360: 6d6f 6e20 696d 706f 7274 2028 6d61 6b65  mon import (make
+00000370: 5f73 7175 6172 652c 206d 616b 655f 7371  _square, make_sq
+00000380: 7561 7265 5f77 6974 685f 6c65 6164 732c  uare_with_leads,
+00000390: 206d 616b 655f 7369 6d70 6c65 5f6c 6561   make_simple_lea
+000003a0: 642c 0a23 2020 2020 2020 2020 2020 2020  d,.#            
+000003b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000003c0: 2020 2020 2020 6d61 6b65 5f63 6f6d 706c        make_compl
+000003d0: 6578 5f6c 6561 642c 2063 6865 636b 5f62  ex_lead, check_b
+000003e0: 6f75 6e64 6172 795f 6861 6d69 6c74 6f6e  oundary_hamilton
+000003f0: 6961 6e29 0a0a 696d 706f 7274 206b 7761  ian)..import kwa
+00000400: 6e74 7370 6563 7472 756d 0a0a 696d 706f  ntspectrum..impo
+00000410: 7274 2077 6172 6e69 6e67 730a 7761 726e  rt warnings.warn
+00000420: 696e 6773 2e66 696c 7465 7277 6172 6e69  ings.filterwarni
+00000430: 6e67 7328 2269 676e 6f72 6522 2c20 6361  ngs("ignore", ca
+00000440: 7465 676f 7279 3d44 6570 7265 6361 7469  tegory=Deprecati
+00000450: 6f6e 5761 726e 696e 6729 0a0a 0a64 6566  onWarning)...def
+00000460: 206d 616b 655f 7369 6d70 6c65 5f6c 6561   make_simple_lea
+00000470: 6428 573d 3329 3a0a 2020 2020 6c61 7420  d(W=3):.    lat 
+00000480: 3d20 6b77 616e 742e 6c61 7474 6963 652e  = kwant.lattice.
+00000490: 7371 7561 7265 2831 2c20 6e6f 7262 733d  square(1, norbs=
+000004a0: 3129 0a20 2020 2073 796d 203d 206b 7761  1).    sym = kwa
+000004b0: 6e74 2e54 7261 6e73 6c61 7469 6f6e 616c  nt.Translational
+000004c0: 5379 6d6d 6574 7279 2828 2d31 2c20 3029  Symmetry((-1, 0)
+000004d0: 290a 2020 2020 4820 3d20 6b77 616e 742e  ).    H = kwant.
+000004e0: 4275 696c 6465 7228 7379 6d29 0a20 2020  Builder(sym).   
+000004f0: 2048 5b28 6c61 7428 302c 2079 2920 666f   H[(lat(0, y) fo
+00000500: 7220 7920 696e 2072 616e 6765 2857 2929  r y in range(W))
+00000510: 5d20 3d20 300a 2020 2020 485b 6c61 742e  ] = 0.    H[lat.
+00000520: 6e65 6967 6862 6f72 7328 295d 203d 202d  neighbors()] = -
+00000530: 310a 2020 2020 7265 7475 726e 2048 0a0a  1.    return H..
+00000540: 0a64 6566 206f 6e73 6974 655f 706f 7465  .def onsite_pote
+00000550: 6e74 6961 6c28 7369 7465 2c20 7469 6d65  ntial(site, time
+00000560: 2c20 7629 3a0a 2020 2020 7265 7475 726e  , v):.    return
+00000570: 2034 202a 2028 3120 2b20 7620 2a20 636d   4 * (1 + v * cm
+00000580: 6174 682e 6578 7028 2d20 316a 202a 2074  ath.exp(- 1j * t
+00000590: 696d 6529 290a 0a0a 6465 6620 6761 7573  ime))...def gaus
+000005a0: 7369 616e 2874 696d 652c 2074 302c 2041  sian(time, t0, A
+000005b0: 2c20 7369 676d 6129 3a0a 2020 2020 7265  , sigma):.    re
+000005c0: 7475 726e 2041 202a 2028 3120 2b20 6572  turn A * (1 + er
+000005d0: 6628 2874 696d 6520 2d20 7430 2920 2f20  f((time - t0) / 
+000005e0: 7369 676d 6129 290a 0a0a 2320 7469 6d65  sigma))...# time
+000005f0: 2064 6570 656e 6465 6e74 2063 6f75 706c   dependent coupl
+00000600: 696e 6720 7769 7468 2067 6175 7373 6961  ing with gaussia
+00000610: 6e20 7075 6c73 650a 6465 6620 636f 7570  n pulse.def coup
+00000620: 6c69 6e67 5f6e 6e28 7369 7465 312c 2073  ling_nn(site1, s
+00000630: 6974 6532 2c20 7469 6d65 2c20 7430 2c20  ite2, time, t0, 
+00000640: 412c 2073 6967 6d61 293a 0a20 2020 2072  A, sigma):.    r
+00000650: 6574 7572 6e20 2d20 636d 6174 682e 6578  eturn - cmath.ex
+00000660: 7028 2d20 316a 202a 2067 6175 7373 6961  p(- 1j * gaussia
+00000670: 6e28 7469 6d65 2c20 7430 2c20 412c 2073  n(time, t0, A, s
+00000680: 6967 6d61 2929 0a0a 0a64 6566 206d 616b  igma))...def mak
+00000690: 655f 7379 7374 656d 2861 3d31 2c20 6761  e_system(a=1, ga
+000006a0: 6d6d 613d 312e 302c 2057 3d31 2c20 4c3d  mma=1.0, W=1, L=
+000006b0: 3330 293a 0a0a 2020 2020 6c61 7420 3d20  30):..    lat = 
+000006c0: 6b77 616e 742e 6c61 7474 6963 652e 7371  kwant.lattice.sq
+000006d0: 7561 7265 2861 3d61 2c20 6e6f 7262 733d  uare(a=a, norbs=
+000006e0: 3129 0a20 2020 2073 7973 7420 3d20 6b77  1).    syst = kw
+000006f0: 616e 742e 4275 696c 6465 7228 290a 0a20  ant.Builder().. 
+00000700: 2020 2023 2044 6566 696e 6520 7468 6520     # Define the 
+00000710: 7363 6174 7465 7269 6e67 2072 6567 696f  scattering regio
+00000720: 6e2e 0a20 2020 2073 7973 745b 286c 6174  n..    syst[(lat
+00000730: 2878 2c20 7929 2066 6f72 2078 2069 6e20  (x, y) for x in 
+00000740: 7261 6e67 6528 4c29 2066 6f72 2079 2069  range(L) for y i
+00000750: 6e20 7261 6e67 6528 5729 295d 203d 206f  n range(W))] = o
+00000760: 6e73 6974 655f 706f 7465 6e74 6961 6c0a  nsite_potential.
+00000770: 2020 2020 7379 7374 5b6c 6174 2e6e 6569      syst[lat.nei
+00000780: 6768 626f 7273 2829 5d20 3d20 2d67 616d  ghbors()] = -gam
+00000790: 6d61 0a20 2020 2023 2074 696d 6520 6465  ma.    # time de
+000007a0: 7065 6e64 656e 7420 636f 7570 6c69 6e67  pendent coupling
+000007b0: 2062 6574 7765 656e 2074 776f 2073 6974   between two sit
+000007c0: 6573 2030 2061 6e64 2031 0a20 2020 2066  es 0 and 1.    f
+000007d0: 6f72 2079 2069 6e20 7261 6e67 6528 5729  or y in range(W)
+000007e0: 3a0a 2020 2020 2020 2020 7379 7374 5b6c  :.        syst[l
+000007f0: 6174 2830 2c20 7929 2c20 6c61 7428 312c  at(0, y), lat(1,
+00000800: 2079 295d 203d 2063 6f75 706c 696e 675f   y)] = coupling_
+00000810: 6e6e 0a0a 2020 2020 2320 4465 6669 6e65  nn..    # Define
+00000820: 2061 6e64 2061 7474 6163 6820 7468 6520   and attach the 
+00000830: 6c65 6164 732e 0a20 2020 2023 2043 6f6e  leads..    # Con
+00000840: 7374 7275 6374 2074 6865 206c 6566 7420  struct the left 
+00000850: 6c65 6164 2e0a 2020 2020 6c65 6164 203d  lead..    lead =
+00000860: 206b 7761 6e74 2e42 7569 6c64 6572 286b   kwant.Builder(k
+00000870: 7761 6e74 2e54 7261 6e73 6c61 7469 6f6e  want.Translation
+00000880: 616c 5379 6d6d 6574 7279 2828 2d61 2c20  alSymmetry((-a, 
+00000890: 3029 2929 0a20 2020 206c 6561 645b 286c  0))).    lead[(l
+000008a0: 6174 2830 2c20 6a29 2066 6f72 206a 2069  at(0, j) for j i
+000008b0: 6e20 7261 6e67 6528 5729 295d 203d 2034  n range(W))] = 4
+000008c0: 202a 2067 616d 6d61 0a20 2020 206c 6561   * gamma.    lea
+000008d0: 645b 6c61 742e 6e65 6967 6862 6f72 7328  d[lat.neighbors(
+000008e0: 295d 203d 202d 6761 6d6d 610a 0a20 2020  )] = -gamma..   
+000008f0: 2023 2041 7474 6163 6820 7468 6520 6c65   # Attach the le
+00000900: 6674 206c 6561 6420 616e 6420 6974 7320  ft lead and its 
+00000910: 7265 7665 7273 6564 2063 6f70 792e 0a20  reversed copy.. 
+00000920: 2020 2073 7973 742e 6174 7461 6368 5f6c     syst.attach_l
+00000930: 6561 6428 6c65 6164 290a 2020 2020 7379  ead(lead).    sy
+00000940: 7374 2e61 7474 6163 685f 6c65 6164 286c  st.attach_lead(l
+00000950: 6561 642e 7265 7665 7273 6564 2829 290a  ead.reversed()).
+00000960: 0a20 2020 2072 6574 7572 6e20 7379 7374  .    return syst
+00000970: 0a0a 0a64 6566 206d 616b 655f 7464 5f73  ...def make_td_s
+00000980: 7973 7465 6d28 6c61 742c 204e 2c20 7464  ystem(lat, N, td
+00000990: 5f6f 6e73 6974 6529 3a0a 2020 2020 4930  _onsite):.    I0
+000009a0: 203d 2074 612e 6964 656e 7469 7479 2832   = ta.identity(2
+000009b0: 290a 2020 2020 7379 7374 203d 206b 7761  ).    syst = kwa
+000009c0: 6e74 2e42 7569 6c64 6572 2829 0a20 2020  nt.Builder().   
+000009d0: 2073 7175 6172 6520 3d20 6974 6572 746f   square = iterto
+000009e0: 6f6c 732e 7072 6f64 7563 7428 7261 6e67  ols.product(rang
+000009f0: 6528 4e29 2c20 7261 6e67 6528 4e29 290a  e(N), range(N)).
+00000a00: 2020 2020 7379 7374 5b28 6c61 7428 692c      syst[(lat(i,
+00000a10: 206a 2920 666f 7220 692c 206a 2069 6e20   j) for i, j in 
+00000a20: 7371 7561 7265 295d 203d 2074 645f 6f6e  square)] = td_on
+00000a30: 7369 7465 0a20 2020 2073 7973 745b 6c61  site.    syst[la
+00000a40: 742e 6e65 6967 6862 6f72 7328 295d 203d  t.neighbors()] =
+00000a50: 202d 3120 2a20 4930 0a20 2020 2072 6574   -1 * I0.    ret
+00000a60: 7572 6e20 7379 7374 0a0a 0a64 6566 206d  urn syst...def m
+00000a70: 616b 655f 7464 5f73 7973 7465 6d5f 7769  ake_td_system_wi
+00000a80: 7468 5f6c 6561 6473 286c 6174 2c20 4e2c  th_leads(lat, N,
+00000a90: 206c 6561 645f 6d61 6b65 722c 2074 645f   lead_maker, td_
+00000aa0: 6f6e 7369 7465 293a 0a20 2020 2073 7973  onsite):.    sys
+00000ab0: 7420 3d20 6d61 6b65 5f74 645f 7379 7374  t = make_td_syst
+00000ac0: 656d 286c 6174 2c20 4e2c 2074 645f 6f6e  em(lat, N, td_on
+00000ad0: 7369 7465 290a 2020 2020 7379 7374 2e61  site).    syst.a
+00000ae0: 7474 6163 685f 6c65 6164 286c 6561 645f  ttach_lead(lead_
+00000af0: 6d61 6b65 7228 6c61 742c 204e 2929 0a20  maker(lat, N)). 
+00000b00: 2020 2073 7973 742e 6174 7461 6368 5f6c     syst.attach_l
+00000b10: 6561 6428 6c65 6164 5f6d 616b 6572 286c  ead(lead_maker(l
+00000b20: 6174 2c20 4e29 2e72 6576 6572 7365 6428  at, N).reversed(
+00000b30: 2929 0a20 2020 2072 6574 7572 6e20 7379  )).    return sy
+00000b40: 7374 0a0a 0a64 6566 206d 616b 655f 7379  st...def make_sy
+00000b50: 7374 656d 5f77 6974 685f 626f 756e 6473  stem_with_bounds
+00000b60: 7461 7465 2856 2c20 4c3d 3230 2c20 613d  tate(V, L=20, a=
+00000b70: 3129 3a20 2023 2062 6f75 6e64 7374 6174  1):  # boundstat
+00000b80: 6520 7072 6573 656e 7420 666f 7220 5620  e present for V 
+00000b90: 3c20 300a 0a20 2020 206c 6174 203d 206b  < 0..    lat = k
+00000ba0: 7761 6e74 2e6c 6174 7469 6365 2e73 7175  want.lattice.squ
+00000bb0: 6172 6528 613d 612c 206e 6f72 6273 3d31  are(a=a, norbs=1
+00000bc0: 290a 2020 2020 7379 7374 203d 206b 7761  ).    syst = kwa
+00000bd0: 6e74 2e42 7569 6c64 6572 2829 0a0a 2020  nt.Builder()..  
+00000be0: 2020 2320 6365 6e74 7261 6c20 7379 7374    # central syst
+00000bf0: 656d 0a20 2020 2073 7973 745b 286c 6174  em.    syst[(lat
+00000c00: 2869 2c20 3029 2066 6f72 2069 2069 6e20  (i, 0) for i in 
+00000c10: 7261 6e67 6528 2d4c 2c20 4c29 295d 203d  range(-L, L))] =
+00000c20: 2030 0a20 2020 2073 7973 745b 6c61 7428   0.    syst[lat(
+00000c30: 302c 2030 295d 203d 2056 0a20 2020 2073  0, 0)] = V.    s
+00000c40: 7973 745b 6c61 742e 6e65 6967 6862 6f72  yst[lat.neighbor
+00000c50: 7328 295d 203d 202d 310a 0a20 2020 2023  s()] = -1..    #
+00000c60: 206c 6561 6473 0a20 2020 206c 6561 6420   leads.    lead 
+00000c70: 3d20 6b77 616e 742e 4275 696c 6465 7228  = kwant.Builder(
+00000c80: 6b77 616e 742e 5472 616e 736c 6174 696f  kwant.Translatio
+00000c90: 6e61 6c53 796d 6d65 7472 7928 282d 612c  nalSymmetry((-a,
+00000ca0: 2030 2929 290a 2020 2020 6c65 6164 5b6c   0))).    lead[l
+00000cb0: 6174 2830 2c20 3029 5d20 3d20 300a 2020  at(0, 0)] = 0.  
+00000cc0: 2020 6c65 6164 5b6c 6174 2e6e 6569 6768    lead[lat.neigh
+00000cd0: 626f 7273 2829 5d20 3d20 2d31 0a20 2020  bors()] = -1.   
+00000ce0: 2073 7973 742e 6174 7461 6368 5f6c 6561   syst.attach_lea
+00000cf0: 6428 6c65 6164 290a 2020 2020 7379 7374  d(lead).    syst
+00000d00: 2e61 7474 6163 685f 6c65 6164 286c 6561  .attach_lead(lea
+00000d10: 642e 7265 7665 7273 6564 2829 290a 0a20  d.reversed()).. 
+00000d20: 2020 2072 6574 7572 6e20 7379 7374 0a0a     return syst..
+00000d30: 0a64 6566 206d 616b 655f 7369 6e67 6c65  .def make_single
+00000d40: 5f73 7069 6e5f 726f 7461 7469 6e67 5f62  _spin_rotating_b
+00000d50: 6173 6973 2861 2c20 4a2c 2077 2c20 7468  asis(a, J, w, th
+00000d60: 6574 6129 3a0a 0a20 2020 2023 2064 6566  eta):..    # def
+00000d70: 696e 6520 7061 756c 6920 6d61 7472 6963  ine pauli matric
+00000d80: 6573 0a20 2020 2073 6967 6d61 5f30 203d  es.    sigma_0 =
+00000d90: 2074 612e 6172 7261 7928 5b5b 312c 2030   ta.array([[1, 0
+00000da0: 5d2c 205b 302c 2031 5d5d 290a 2020 2020  ], [0, 1]]).    
+00000db0: 7369 676d 615f 7820 3d20 7461 2e61 7272  sigma_x = ta.arr
+00000dc0: 6179 285b 5b30 2c20 315d 2c20 5b31 202c  ay([[0, 1], [1 ,
+00000dd0: 305d 5d29 0a20 2020 2073 6967 6d61 5f7a  0]]).    sigma_z
+00000de0: 203d 2074 612e 6172 7261 7928 5b5b 312c   = ta.array([[1,
+00000df0: 305d 2c20 5b30 2c20 2d31 5d5d 290a 0a20  0], [0, -1]]).. 
+00000e00: 2020 2023 2063 656e 7472 616c 2072 6567     # central reg
+00000e10: 696f 6e0a 2020 2020 6c61 7420 3d20 6b77  ion.    lat = kw
+00000e20: 616e 742e 6c61 7474 6963 652e 7371 7561  ant.lattice.squa
+00000e30: 7265 2861 3d61 2c20 6e6f 7262 733d 3229  re(a=a, norbs=2)
+00000e40: 2020 2020 2320 7477 6f20 6f72 6269 7461      # two orbita
+00000e50: 6c73 2066 6f72 2075 7020 616e 6420 646f  ls for up and do
+00000e60: 776e 2073 7069 6e0a 2020 2020 7379 7374  wn spin.    syst
+00000e70: 203d 206b 7761 6e74 2e42 7569 6c64 6572   = kwant.Builder
+00000e80: 2829 0a0a 2020 2020 7379 7374 5b6c 6174  ()..    syst[lat
+00000e90: 2830 2c20 3029 5d20 203d 202d 2028 7720  (0, 0)]  = - (w 
+00000ea0: 2f20 3229 202a 2073 6967 6d61 5f7a 202d  / 2) * sigma_z -
+00000eb0: 2028 4a20 2f20 3229 202a 2028 6e70 2e73   (J / 2) * (np.s
+00000ec0: 696e 2874 6865 7461 2920 2a20 7369 676d  in(theta) * sigm
+00000ed0: 615f 7820 2b20 6e70 2e63 6f73 2874 6865  a_x + np.cos(the
+00000ee0: 7461 2920 2a20 7369 676d 615f 7a29 0a20  ta) * sigma_z). 
+00000ef0: 2020 2073 7973 745b 6c61 7428 2d31 2c20     syst[lat(-1, 
+00000f00: 3029 5d20 3d20 2d20 2877 202f 2032 2920  0)] = - (w / 2) 
+00000f10: 2a20 7369 676d 615f 7a20 2023 2061 6464  * sigma_z  # add
+00000f20: 2065 7874 7261 2073 6974 6520 746f 206d   extra site to m
+00000f30: 6561 7375 7265 2063 7572 7265 6e74 0a20  easure current. 
+00000f40: 2020 200a 2020 2020 7379 7374 5b6c 6174     .    syst[lat
+00000f50: 2e6e 6569 6768 626f 7273 2829 5d20 3d20  .neighbors()] = 
+00000f60: 2d20 7369 676d 615f 300a 0a20 2020 2023  - sigma_0..    #
+00000f70: 206c 6561 6473 0a20 2020 206c 6561 643d   leads.    lead=
+00000f80: 6b77 616e 742e 4275 696c 6465 7228 6b77  kwant.Builder(kw
+00000f90: 616e 742e 5472 616e 736c 6174 696f 6e61  ant.Translationa
+00000fa0: 6c53 796d 6d65 7472 7928 282d 612c 2030  lSymmetry((-a, 0
+00000fb0: 2929 290a 2020 2020 6c65 6164 5b6c 6174  ))).    lead[lat
+00000fc0: 2830 2c20 3029 5d20 3d20 2d20 2877 202f  (0, 0)] = - (w /
+00000fd0: 2032 2920 2a20 7369 676d 615f 7a0a 2020   2) * sigma_z.  
+00000fe0: 2020 6c65 6164 5b6c 6174 2e6e 6569 6768    lead[lat.neigh
+00000ff0: 626f 7273 2829 5d20 3d20 2d20 7369 676d  bors()] = - sigm
+00001000: 615f 300a 2020 2020 7379 7374 2e61 7474  a_0.    syst.att
+00001010: 6163 685f 6c65 6164 286c 6561 6429 0a20  ach_lead(lead). 
+00001020: 2020 2073 7973 742e 6174 7461 6368 5f6c     syst.attach_l
+00001030: 6561 6428 6c65 6164 2e72 6576 6572 7365  ead(lead.reverse
+00001040: 6428 2929 0a20 2020 200a 2020 2020 7265  d()).    .    re
+00001050: 7475 726e 2073 7973 742c 206c 6174 0a0a  turn syst, lat..
+00001060: 0a0a 4070 7974 6573 742e 6669 7874 7572  ..@pytest.fixtur
+00001070: 650a 6465 6620 7477 6f5f 6261 6e64 5f73  e.def two_band_s
+00001080: 7065 6374 7275 6d28 293a 0a20 2020 206c  pectrum():.    l
+00001090: 6561 6420 3d20 6d61 6b65 5f73 696d 706c  ead = make_simpl
+000010a0: 655f 6c65 6164 2857 3d32 292e 6669 6e61  e_lead(W=2).fina
+000010b0: 6c69 7a65 6428 290a 2020 2020 7265 7475  lized().    retu
+000010c0: 726e 206b 7761 6e74 7370 6563 7472 756d  rn kwantspectrum
+000010d0: 2e73 7065 6374 7275 6d28 6c65 6164 290a  .spectrum(lead).
+000010e0: 0a0a 4070 7974 6573 742e 6669 7874 7572  ..@pytest.fixtur
+000010f0: 650a 6465 6620 666c 6174 5f62 616e 645f  e.def flat_band_
+00001100: 7370 6563 7472 756d 2829 3a0a 0a20 2020  spectrum():..   
+00001110: 2064 6566 206d 616b 655f 6c65 6164 5f77   def make_lead_w
+00001120: 6974 685f 666c 6174 5f62 616e 6428 6c6c  ith_flat_band(ll
+00001130: 3d33 293a 0a20 2020 2020 2020 206c 6174  =3):.        lat
+00001140: 203d 206b 7761 6e74 2e6c 6174 7469 6365   = kwant.lattice
+00001150: 2e73 7175 6172 6528 6e6f 7262 733d 3129  .square(norbs=1)
+00001160: 0a20 2020 2020 2020 206c 6561 6420 3d20  .        lead = 
+00001170: 6b77 616e 742e 4275 696c 6465 7228 6b77  kwant.Builder(kw
+00001180: 616e 742e 5472 616e 736c 6174 696f 6e61  ant.Translationa
+00001190: 6c53 796d 6d65 7472 7928 282d 312c 2031  lSymmetry((-1, 1
+000011a0: 2929 290a 2020 2020 2020 2020 6c65 6164  ))).        lead
+000011b0: 5b5b 6c61 7428 302c 206a 2920 666f 7220  [[lat(0, j) for 
+000011c0: 6a20 696e 2072 616e 6765 286c 6c29 5d5d  j in range(ll)]]
+000011d0: 203d 2030 0a20 2020 2020 2020 206c 6561   = 0.        lea
+000011e0: 645b 6c61 742e 6e65 6967 6862 6f72 7328  d[lat.neighbors(
+000011f0: 295d 203d 202d 310a 2020 2020 2020 2020  )] = -1.        
+00001200: 7265 7475 726e 206c 6561 640a 0a20 2020  return lead..   
+00001210: 206c 6561 6420 3d20 6d61 6b65 5f6c 6561   lead = make_lea
+00001220: 645f 7769 7468 5f66 6c61 745f 6261 6e64  d_with_flat_band
+00001230: 2829 2e66 696e 616c 697a 6564 2829 0a20  ().finalized(). 
+00001240: 2020 2072 6574 7572 6e20 6b77 616e 7473     return kwants
+00001250: 7065 6374 7275 6d2e 7370 6563 7472 756d  pectrum.spectrum
+00001260: 286c 6561 6429 0a0a 0a40 7079 7465 7374  (lead)...@pytest
+00001270: 2e66 6978 7475 7265 0a64 6566 2075 6e69  .fixture.def uni
+00001280: 666f 726d 5f6f 6363 7570 6174 696f 6e28  form_occupation(
+00001290: 293a 0a20 2020 2064 6566 2075 6e69 666f  ):.    def unifo
+000012a0: 726d 5f64 6973 7472 6962 7574 696f 6e28  rm_distribution(
+000012b0: 7829 3a0a 2020 2020 2020 2020 7265 7475  x):.        retu
+000012c0: 726e 206e 702e 6f6e 6573 286c 656e 2878  rn np.ones(len(x
+000012d0: 2929 0a0a 2020 2020 636c 6173 7320 556e  ))..    class Un
+000012e0: 6966 6f72 6d4f 6363 7570 6174 696f 6e3a  iformOccupation:
+000012f0: 0a20 2020 2020 2020 2064 6566 205f 5f69  .        def __i
+00001300: 6e69 745f 5f28 7365 6c66 293a 0a20 2020  nit__(self):.   
+00001310: 2020 2020 2020 2020 2073 656c 662e 6469           self.di
+00001320: 7374 7269 6275 7469 6f6e 203d 2075 6e69  stribution = uni
+00001330: 666f 726d 5f64 6973 7472 6962 7574 696f  form_distributio
+00001340: 6e0a 2020 2020 2020 2020 2020 2020 7365  n.            se
+00001350: 6c66 2e62 616e 6473 203d 204e 6f6e 650a  lf.bands = None.
+00001360: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00001370: 2e65 6e65 7267 795f 7261 6e67 6520 3d20  .energy_range = 
+00001380: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00001390: 2073 656c 662e 6d75 6c74 6976 6172 6961   self.multivaria
+000013a0: 7465 203d 2046 616c 7365 0a20 2020 2072  te = False.    r
+000013b0: 6574 7572 6e20 556e 6966 6f72 6d4f 6363  eturn UniformOcc
+000013c0: 7570 6174 696f 6e28 290a 0a0a 4070 7974  upation()...@pyt
+000013d0: 6573 742e 6669 7874 7572 650a 6465 6620  est.fixture.def 
+000013e0: 5369 6d70 6c65 496e 7465 7276 616c 2829  SimpleInterval()
+000013f0: 3a0a 0a20 2020 2063 6c61 7373 2049 6e74  :..    class Int
+00001400: 6572 7661 6c3a 0a20 2020 2020 2020 2064  erval:.        d
+00001410: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00001420: 2c20 6b6d 696e 2c20 6b6d 6178 293a 0a20  , kmin, kmax):. 
+00001430: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+00001440: 6b6d 696e 203d 206b 6d69 6e0a 2020 2020  kmin = kmin.    
+00001450: 2020 2020 2020 2020 7365 6c66 2e6b 6d61          self.kma
+00001460: 7820 3d20 6b6d 6178 0a20 2020 2020 2020  x = kmax.       
+00001470: 2020 2020 2073 656c 662e 6368 6563 6b61       self.checka
+00001480: 7474 7269 6275 7465 203d 2027 6368 6563  ttribute = 'chec
+00001490: 6b27 2020 2320 6475 6d6d 7920 6174 7472  k'  # dummy attr
+000014a0: 6962 7574 6520 746f 2063 6865 636b 2069  ibute to check i
+000014b0: 6620 6974 2069 7320 636f 7069 6564 0a0a  f it is copied..
+000014c0: 2020 2020 2020 2020 6465 6620 5f5f 6571          def __eq
+000014d0: 5f5f 2873 656c 662c 206f 7468 6572 293a  __(self, other):
+000014e0: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
+000014f0: 7572 6e20 2873 656c 662e 6b6d 696e 203d  urn (self.kmin =
+00001500: 3d20 6f74 6865 722e 6b6d 696e 2061 6e64  = other.kmin and
+00001510: 2073 656c 662e 6b6d 6178 203d 3d20 6f74   self.kmax == ot
+00001520: 6865 722e 6b6d 6178 2061 6e64 0a20 2020  her.kmax and.   
+00001530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001540: 2073 656c 662e 6368 6563 6b61 7474 7269   self.checkattri
+00001550: 6275 7465 203d 3d20 6f74 6865 722e 6368  bute == other.ch
+00001560: 6563 6b61 7474 7269 6275 7465 290a 0a20  eckattribute).. 
+00001570: 2020 2020 2020 2064 6566 205f 5f6e 655f         def __ne_
+00001580: 5f28 7365 6c66 2c20 6f74 6865 7229 3a0a  _(self, other):.
+00001590: 2020 2020 2020 2020 2020 2020 7265 7475              retu
+000015a0: 726e 206e 6f74 2073 656c 662e 5f5f 6571  rn not self.__eq
+000015b0: 5f5f 286f 7468 6572 290a 2020 2020 7265  __(other).    re
+000015c0: 7475 726e 2049 6e74 6572 7661 6c0a 0a0a  turn Interval...
+000015d0: 4070 7974 6573 742e 6669 7874 7572 650a  @pytest.fixture.
+000015e0: 6465 6620 7175 6164 7261 7475 7265 5f69  def quadrature_i
+000015f0: 6e74 6572 7661 6c28 293a 0a20 2020 2072  nterval():.    r
+00001600: 6574 7572 6e20 6d61 6e79 626f 6479 2e49  eturn manybody.I
+00001610: 6e74 6572 7661 6c28 6c65 6164 3d30 2c20  nterval(lead=0, 
+00001620: 6261 6e64 3d30 2c20 6b6d 696e 3d30 2c20  band=0, kmin=0, 
+00001630: 6b6d 6178 3d6e 702e 7069 202f 2032 290a  kmax=np.pi / 2).
+00001640: 0a0a 5641 4c49 445f 4348 454d 4943 414c  ..VALID_CHEMICAL
+00001650: 5f50 4f54 454e 5449 414c 5320 3d20 5b2d  _POTENTIALS = [-
+00001660: 666c 6f61 7428 2269 6e66 2229 2c20 2d31  float("inf"), -1
+00001670: 2e2c 202d 312c 2030 2c20 302e 2c20 312c  ., -1, 0, 0., 1,
+00001680: 2031 2e2c 2066 6c6f 6174 2822 696e 6622   1., float("inf"
+00001690: 295d 0a56 414c 4944 5f54 454d 5045 5241  )].VALID_TEMPERA
+000016a0: 5455 5245 5320 3d20 5b30 2c20 302e 2c20  TURES = [0, 0., 
+000016b0: 312c 2031 2e2c 2066 6c6f 6174 2822 696e  1, 1., float("in
+000016c0: 6622 295d 0a56 414c 4944 5f45 4e45 5247  f")].VALID_ENERG
+000016d0: 595f 4355 544f 4646 5320 3d20 5b2d 666c  Y_CUTOFFS = [-fl
+000016e0: 6f61 7428 2269 6e66 2229 2c20 2d31 2e2c  oat("inf"), -1.,
+000016f0: 202d 312c 2030 2c20 302e 2c20 312c 2031   -1, 0, 0., 1, 1
+00001700: 2e2c 2066 6c6f 6174 2822 696e 6622 295d  ., float("inf")]
+00001710: 0a0a 5641 4c49 445f 5155 4144 5241 5455  ..VALID_QUADRATU
+00001720: 5245 5320 3d20 5b22 6761 7573 736c 6567  RES = ["gaussleg
+00001730: 656e 6472 6522 2c20 226b 726f 6e72 6f64  endre", "kronrod
+00001740: 225d 0a56 414c 4944 5f49 4e54 4547 5241  "].VALID_INTEGRA
+00001750: 5449 4f4e 5f56 4152 4941 424c 4553 203d  TION_VARIABLES =
+00001760: 205b 2265 6e65 7267 7922 2c20 226d 6f6d   ["energy", "mom
+00001770: 656e 7475 6d22 5d0a 0a0a 6465 6620 756e  entum"]...def un
+00001780: 6b6e 6f77 6e5f 6469 7374 7269 6275 7469  known_distributi
+00001790: 6f6e 5f66 756e 6374 696f 6e28 6368 656d  on_function(chem
+000017a0: 6963 616c 5f70 6f74 656e 7469 616c 2c20  ical_potential, 
+000017b0: 7465 6d70 6572 6174 7572 652c 2065 6e65  temperature, ene
+000017c0: 7267 7929 3a0a 2020 2020 2222 2261 6e20  rgy):.    """an 
+000017d0: 6172 6269 7472 6172 7920 6469 7374 7269  arbitrary distri
+000017e0: 6275 7469 6f6e 2066 756e 6374 696f 6e20  bution function 
+000017f0: 2868 6572 6520 7468 6520 6665 726d 6920  (here the fermi 
+00001800: 6675 6e63 7469 6f6e 2922 2222 0a20 2020  function)""".   
+00001810: 2072 6574 7572 6e20 3120 2f20 286e 702e   return 1 / (np.
+00001820: 6578 7028 2865 6e65 7267 7920 2d20 6368  exp((energy - ch
+00001830: 656d 6963 616c 5f70 6f74 656e 7469 616c  emical_potential
+00001840: 2920 2f20 7465 6d70 6572 6174 7572 6529  ) / temperature)
+00001850: 202d 2031 290a 0a0a 6465 6620 7465 7374   - 1)...def test
+00001860: 5f6c 6561 645f 6f63 6375 7061 7469 6f6e  _lead_occupation
+00001870: 5f64 6566 6175 6c74 2829 3a0a 2020 2020  _default():.    
+00001880: 6f63 6375 7061 7469 6f6e 203d 206d 616e  occupation = man
+00001890: 7962 6f64 792e 6c65 6164 5f6f 6363 7570  ybody.lead_occup
+000018a0: 6174 696f 6e28 290a 2020 2020 6173 7365  ation().    asse
+000018b0: 7274 2063 616c 6c61 626c 6528 6f63 6375  rt callable(occu
+000018c0: 7061 7469 6f6e 2e64 6973 7472 6962 7574  pation.distribut
+000018d0: 696f 6e29 0a20 2020 2061 7373 6572 7420  ion).    assert 
+000018e0: 6f63 6375 7061 7469 6f6e 2e64 6973 7472  occupation.distr
+000018f0: 6962 7574 696f 6e28 2d31 2920 3d3d 2031  ibution(-1) == 1
+00001900: 0a20 2020 2061 7373 6572 7420 6f63 6375  .    assert occu
+00001910: 7061 7469 6f6e 2e64 6973 7472 6962 7574  pation.distribut
+00001920: 696f 6e28 3129 203d 3d20 300a 2020 2020  ion(1) == 0.    
+00001930: 6173 7365 7274 206c 656e 286f 6363 7570  assert len(occup
+00001940: 6174 696f 6e2e 656e 6572 6779 5f72 616e  ation.energy_ran
+00001950: 6765 2920 3d3d 2031 0a20 2020 2065 6d69  ge) == 1.    emi
+00001960: 6e2c 2065 6d61 7820 3d20 6f63 6375 7061  n, emax = occupa
+00001970: 7469 6f6e 2e65 6e65 7267 795f 7261 6e67  tion.energy_rang
+00001980: 655b 305d 0a20 2020 2061 7373 6572 7420  e[0].    assert 
+00001990: 656d 696e 2069 7320 4e6f 6e65 0a20 2020  emin is None.   
+000019a0: 2061 7373 6572 7420 656d 6178 203d 3d20   assert emax == 
+000019b0: 300a 2020 2020 6173 7365 7274 206f 6363  0.    assert occ
+000019c0: 7570 6174 696f 6e2e 6261 6e64 7320 6973  upation.bands is
+000019d0: 204e 6f6e 650a 0a0a 6465 6620 6d6f 6465   None...def mode
+000019e0: 6c5f 7461 736b 7328 293a 0a0a 2020 2020  l_tasks():..    
+000019f0: 2320 7765 2074 616b 6520 6120 7369 6d70  # we take a simp
+00001a00: 6c65 2073 7065 6374 7275 6d20 7769 7468  le spectrum with
+00001a10: 206f 6e6c 7920 7477 6f20 6261 6e64 732e   only two bands.
+00001a20: 0a20 2020 2023 2069 7420 6861 7320 7468  .    # it has th
+00001a30: 6520 6469 7370 6572 7369 6f6e 2045 5f6e  e dispersion E_n
+00001a40: 286b 292c 2077 6865 7265 206e 2069 7320  (k), where n is 
+00001a50: 7468 6520 6261 6e64 2069 6e64 6578 2061  the band index a
+00001a60: 6e64 206b 2074 6865 206d 6f6d 656e 7475  nd k the momentu
+00001a70: 6d3a 0a20 2020 2023 2045 5f30 286b 2920  m:.    # E_0(k) 
+00001a80: 3d20 2d20 2832 2063 6f73 286b 2920 2b20  = - (2 cos(k) + 
+00001a90: 3129 0a20 2020 2023 2045 5f31 286b 2920  1).    # E_1(k) 
+00001aa0: 3d20 2d20 2832 2063 6f73 286b 2920 2d20  = - (2 cos(k) - 
+00001ab0: 3129 0a0a 2020 2020 6465 6620 656e 6572  1)..    def ener
+00001ac0: 6779 5f66 756e 6328 6d6f 6d65 6e74 756d  gy_func(momentum
+00001ad0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00001ae0: 6e20 2d20 2832 202a 206e 702e 636f 7328  n - (2 * np.cos(
+00001af0: 6d6f 6d65 6e74 756d 2920 2b20 3129 0a0a  momentum) + 1)..
+00001b00: 2020 2020 6465 6620 7665 6c6f 6369 7479      def velocity
+00001b10: 5f66 756e 6328 6d6f 6d65 6e74 756d 293a  _func(momentum):
+00001b20: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001b30: 3220 2a20 6e70 2e73 696e 286d 6f6d 656e  2 * np.sin(momen
+00001b40: 7475 6d29 0a0a 2020 2020 6465 6620 6469  tum)..    def di
+00001b50: 7374 7269 6275 7469 6f6e 5f66 756e 6328  stribution_func(
+00001b60: 656e 6572 6779 293a 0a20 2020 2020 2020  energy):.       
+00001b70: 2072 6574 7572 6e20 3120 2f20 286e 702e   return 1 / (np.
+00001b80: 6578 7028 2865 6e65 7267 7920 2d20 3129  exp((energy - 1)
+00001b90: 202f 2030 2e35 2920 2d20 3129 0a0a 2020   / 0.5) - 1)..  
+00001ba0: 2020 696e 7465 7276 616c 5f31 203d 206d    interval_1 = m
+00001bb0: 616e 7962 6f64 792e 496e 7465 7276 616c  anybody.Interval
+00001bc0: 286c 6561 643d 302c 2062 616e 643d 302c  (lead=0, band=0,
+00001bd0: 206b 6d69 6e3d 302c 206b 6d61 783d 6e70   kmin=0, kmax=np
+00001be0: 2e70 6920 2f20 322c 0a20 2020 2020 2020  .pi / 2,.       
+00001bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001c00: 2020 2020 2020 2020 2020 2020 696e 7465              inte
+00001c10: 6772 6174 696f 6e5f 7661 7269 6162 6c65  gration_variable
+00001c20: 3d27 6d6f 6d65 6e74 756d 272c 206f 7264  ='momentum', ord
+00001c30: 6572 3d34 2c0a 2020 2020 2020 2020 2020  er=4,.          
+00001c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001c50: 2020 2020 2020 2020 2071 7561 6472 6174           quadrat
+00001c60: 7572 653d 2767 6175 7373 6c65 6765 6e64  ure='gausslegend
+00001c70: 7265 2729 0a0a 2020 2020 2320 6761 7573  re')..    # gaus
+00001c80: 7320 6c65 6765 6e64 7265 2061 6273 6369  s legendre absci
+00001c90: 7373 6173 2062 6574 7765 656e 206b 6d69  ssas between kmi
+00001ca0: 6e20 3d20 3020 616e 6420 6b6d 6178 203d  n = 0 and kmax =
+00001cb0: 2070 692f 320a 2020 2020 6d6f 6d65 6e74   pi/2.    moment
+00001cc0: 6120 3d20 5b30 2e31 3039 3036 3332 392c  a = [0.10906329,
+00001cd0: 2030 2e35 3138 3337 3736 382c 2031 2e30   0.51837768, 1.0
+00001ce0: 3532 3431 3836 352c 2031 2e34 3631 3733  5241865, 1.46173
+00001cf0: 3330 345d 0a20 2020 2077 6569 6768 7473  304].    weights
+00001d00: 5f31 203d 205b 302e 3237 3332 3034 3536  _1 = [0.27320456
+00001d10: 2c20 302e 3531 3231 3933 3631 2c20 302e  , 0.51219361, 0.
+00001d20: 3531 3231 3933 3631 2c20 302e 3237 3332  51219361, 0.2732
+00001d30: 3034 3536 5d0a 0a20 2020 2069 6e74 6572  0456]..    inter
+00001d40: 7661 6c5f 3220 3d20 6d61 6e79 626f 6479  val_2 = manybody
+00001d50: 2e49 6e74 6572 7661 6c28 6c65 6164 3d30  .Interval(lead=0
+00001d60: 2c20 6261 6e64 3d30 2c20 6b6d 696e 3d30  , band=0, kmin=0
+00001d70: 2c20 6b6d 6178 3d6e 702e 7069 202f 2032  , kmax=np.pi / 2
+00001d80: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+00001d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001da0: 2020 2020 2069 6e74 6567 7261 7469 6f6e       integration
+00001db0: 5f76 6172 6961 626c 653d 2765 6e65 7267  _variable='energ
+00001dc0: 7927 2c20 6f72 6465 723d 342c 0a20 2020  y', order=4,.   
+00001dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001df0: 7175 6164 7261 7475 7265 3d27 6761 7573  quadrature='gaus
+00001e00: 736c 6567 656e 6472 6527 290a 0a20 2020  slegendre')..   
+00001e10: 2023 2067 6175 7373 206c 6567 656e 6472   # gauss legendr
+00001e20: 6520 6162 7363 6973 7361 7320 6265 7477  e abscissas betw
+00001e30: 6565 6e20 455f 3028 6b6d 696e 2920 3d20  een E_0(kmin) = 
+00001e40: 2d33 2061 6e64 2045 5f30 286b 6d61 7829  -3 and E_0(kmax)
+00001e50: 203d 202d 310a 2020 2020 656e 6572 6769   = -1.    energi
+00001e60: 6573 203d 205b 2d32 2e38 3631 3133 3633  es = [-2.8611363
+00001e70: 312c 202d 322e 3333 3939 3831 3034 2c20  1, -2.33998104, 
+00001e80: 2d31 2e36 3630 3031 3839 362c 202d 312e  -1.66001896, -1.
+00001e90: 3133 3838 3633 3639 5d0a 2020 2020 7765  13886369].    we
+00001ea0: 6967 6874 735f 3220 3d20 5b30 2e33 3437  ights_2 = [0.347
+00001eb0: 3835 3438 352c 2030 2e36 3532 3134 3531  85485, 0.6521451
+00001ec0: 352c 2030 2e36 3532 3134 3531 352c 2030  5, 0.65214515, 0
+00001ed0: 2e33 3437 3835 3438 355d 0a0a 2020 2020  .34785485]..    
+00001ee0: 7661 7269 6162 6c65 7320 3d20 2827 656e  variables = ('en
+00001ef0: 6572 6779 5f66 756e 632c 2076 656c 6f63  ergy_func, veloc
+00001f00: 6974 795f 6675 6e63 2c20 6469 7374 7269  ity_func, distri
+00001f10: 6275 7469 6f6e 5f66 756e 632c 270a 2020  bution_func,'.  
+00001f20: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+00001f30: 696e 7465 7276 616c 2c20 7765 6967 6874  interval, weight
+00001f40: 732c 2078 2c20 785f 7479 7065 2729 0a20  s, x, x_type'). 
+00001f50: 2020 206d 6f64 656c 203d 205b 5d0a 2020     model = [].  
+00001f60: 2020 6d6f 6465 6c2e 6170 7065 6e64 2828    model.append((
+00001f70: 656e 6572 6779 5f66 756e 632c 2076 656c  energy_func, vel
+00001f80: 6f63 6974 795f 6675 6e63 2c20 6469 7374  ocity_func, dist
+00001f90: 7269 6275 7469 6f6e 5f66 756e 632c 0a20  ribution_func,. 
+00001fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001fb0: 2069 6e74 6572 7661 6c5f 312c 2077 6569   interval_1, wei
+00001fc0: 6768 7473 5f31 2c20 6d6f 6d65 6e74 612c  ghts_1, momenta,
+00001fd0: 2027 6d6f 6d65 6e74 756d 2729 290a 2020   'momentum')).  
+00001fe0: 2020 6d6f 6465 6c2e 6170 7065 6e64 2828    model.append((
+00001ff0: 656e 6572 6779 5f66 756e 632c 2076 656c  energy_func, vel
+00002000: 6f63 6974 795f 6675 6e63 2c20 6469 7374  ocity_func, dist
+00002010: 7269 6275 7469 6f6e 5f66 756e 632c 0a20  ribution_func,. 
+00002020: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00002030: 2069 6e74 6572 7661 6c5f 322c 2077 6569   interval_2, wei
+00002040: 6768 7473 5f32 2c20 656e 6572 6769 6573  ghts_2, energies
+00002050: 2c20 2765 6e65 7267 7927 2929 0a0a 2020  , 'energy'))..  
+00002060: 2020 7265 7475 726e 2070 7974 6573 742e    return pytest.
+00002070: 6d61 726b 2e70 6172 616d 6574 7269 7a65  mark.parametrize
+00002080: 2876 6172 6961 626c 6573 2c20 6d6f 6465  (variables, mode
+00002090: 6c29 0a0a 0a40 7079 7465 7374 2e6d 6172  l)...@pytest.mar
+000020a0: 6b2e 7061 7261 6d65 7472 697a 6528 2763  k.parametrize('c
+000020b0: 6865 6d69 6361 6c5f 706f 7465 6e74 6961  hemical_potentia
+000020c0: 6c27 2c20 5641 4c49 445f 4348 454d 4943  l', VALID_CHEMIC
+000020d0: 414c 5f50 4f54 454e 5449 414c 5329 0a64  AL_POTENTIALS).d
+000020e0: 6566 2074 6573 745f 6c65 6164 5f6f 6363  ef test_lead_occ
+000020f0: 7570 6174 696f 6e5f 7661 7279 5f63 6865  upation_vary_che
+00002100: 6d69 6361 6c5f 706f 7465 6e74 6961 6c28  mical_potential(
+00002110: 6368 656d 6963 616c 5f70 6f74 656e 7469  chemical_potenti
+00002120: 616c 293a 0a20 2020 2023 207a 6572 6f20  al):.    # zero 
+00002130: 7465 6d70 6572 6174 7572 652c 2066 6572  temperature, fer
+00002140: 6d69 2d64 6972 6163 2064 6973 7472 6962  mi-dirac distrib
+00002150: 7574 696f 6e0a 2020 2020 6f63 6375 7061  ution.    occupa
+00002160: 7469 6f6e 203d 206d 616e 7962 6f64 792e  tion = manybody.
+00002170: 6c65 6164 5f6f 6363 7570 6174 696f 6e28  lead_occupation(
+00002180: 6368 656d 6963 616c 5f70 6f74 656e 7469  chemical_potenti
+00002190: 616c 3d63 6865 6d69 6361 6c5f 706f 7465  al=chemical_pote
+000021a0: 6e74 6961 6c29 0a20 2020 2061 7373 6572  ntial).    asser
+000021b0: 7420 6c65 6e28 6f63 6375 7061 7469 6f6e  t len(occupation
+000021c0: 2e65 6e65 7267 795f 7261 6e67 6529 203d  .energy_range) =
+000021d0: 3d20 310a 2020 2020 656d 696e 2c20 656d  = 1.    emin, em
+000021e0: 6178 203d 206f 6363 7570 6174 696f 6e2e  ax = occupation.
+000021f0: 656e 6572 6779 5f72 616e 6765 5b30 5d0a  energy_range[0].
+00002200: 2020 2020 6173 7365 7274 2065 6d69 6e20      assert emin 
+00002210: 6973 204e 6f6e 650a 2020 2020 6173 7365  is None.    asse
+00002220: 7274 2065 6d61 7820 6973 2063 6865 6d69  rt emax is chemi
+00002230: 6361 6c5f 706f 7465 6e74 6961 6c0a 0a20  cal_potential.. 
+00002240: 2020 2023 2066 696e 6974 6520 7465 6d70     # finite temp
+00002250: 6572 6174 7572 652c 2066 6572 6d69 2d64  erature, fermi-d
+00002260: 6972 6163 2064 6973 7472 6962 7574 696f  irac distributio
+00002270: 6e0a 2020 2020 6f63 6375 7061 7469 6f6e  n.    occupation
+00002280: 203d 206d 616e 7962 6f64 792e 6c65 6164   = manybody.lead
+00002290: 5f6f 6363 7570 6174 696f 6e28 6368 656d  _occupation(chem
+000022a0: 6963 616c 5f70 6f74 656e 7469 616c 3d63  ical_potential=c
+000022b0: 6865 6d69 6361 6c5f 706f 7465 6e74 6961  hemical_potentia
+000022c0: 6c2c 2074 656d 7065 7261 7475 7265 3d31  l, temperature=1
+000022d0: 290a 2020 2020 6566 6665 6374 6976 655f  ).    effective_
+000022e0: 656d 6178 203d 2063 6865 6d69 6361 6c5f  emax = chemical_
+000022f0: 706f 7465 6e74 6961 6c20 2b20 6d61 6e79  potential + many
+00002300: 626f 6479 2e5f 6665 726d 695f 6675 6e63  body._fermi_func
+00002310: 7469 6f6e 5f62 656c 6f77 5f65 7073 696c  tion_below_epsil
+00002320: 6f6e 2874 656d 7065 7261 7475 7265 3d31  on(temperature=1
+00002330: 290a 2020 2020 6173 7365 7274 206c 656e  ).    assert len
+00002340: 286f 6363 7570 6174 696f 6e2e 656e 6572  (occupation.ener
+00002350: 6779 5f72 616e 6765 2920 3d3d 2031 0a20  gy_range) == 1. 
+00002360: 2020 2065 6d69 6e2c 2065 6d61 7820 3d20     emin, emax = 
+00002370: 6f63 6375 7061 7469 6f6e 2e65 6e65 7267  occupation.energ
+00002380: 795f 7261 6e67 655b 305d 0a20 2020 2061  y_range[0].    a
+00002390: 7373 6572 7420 656d 696e 2069 7320 4e6f  ssert emin is No
+000023a0: 6e65 0a20 2020 2061 7373 6572 7420 656d  ne.    assert em
+000023b0: 6178 203d 3d20 6566 6665 6374 6976 655f  ax == effective_
+000023c0: 656d 6178 0a0a 0a40 7079 7465 7374 2e6d  emax...@pytest.m
+000023d0: 6172 6b2e 7061 7261 6d65 7472 697a 6528  ark.parametrize(
+000023e0: 2774 656d 7065 7261 7475 7265 272c 2056  'temperature', V
+000023f0: 414c 4944 5f54 454d 5045 5241 5455 5245  ALID_TEMPERATURE
+00002400: 5329 0a64 6566 2074 6573 745f 6c65 6164  S).def test_lead
+00002410: 5f6f 6363 7570 6174 696f 6e5f 7661 7279  _occupation_vary
+00002420: 5f74 656d 7065 7261 7475 7265 2874 656d  _temperature(tem
+00002430: 7065 7261 7475 7265 293a 0a20 2020 2023  perature):.    #
+00002440: 2054 4f44 4f3a 206e 6f20 676f 6f64 2074   TODO: no good t
+00002450: 6573 7420 666f 7220 7072 6562 696e 6420  est for prebind 
+00002460: 7465 6d70 6572 6174 7572 6520 7661 6c75  temperature valu
+00002470: 6520 6174 2074 6865 206d 6f6d 656e 740a  e at the moment.
+00002480: 0a20 2020 2023 2066 6572 6d69 2d64 6972  .    # fermi-dir
+00002490: 6163 2064 6973 7472 6962 7574 696f 6e0a  ac distribution.
+000024a0: 2020 2020 6f63 6375 7061 7469 6f6e 203d      occupation =
+000024b0: 206d 616e 7962 6f64 792e 6c65 6164 5f6f   manybody.lead_o
+000024c0: 6363 7570 6174 696f 6e28 7465 6d70 6572  ccupation(temper
+000024d0: 6174 7572 653d 7465 6d70 6572 6174 7572  ature=temperatur
+000024e0: 6529 0a20 2020 2061 7373 6572 7420 6c65  e).    assert le
+000024f0: 6e28 6f63 6375 7061 7469 6f6e 2e65 6e65  n(occupation.ene
+00002500: 7267 795f 7261 6e67 6529 203d 3d20 310a  rgy_range) == 1.
+00002510: 2020 2020 656d 696e 2c20 656d 6178 203d      emin, emax =
+00002520: 206f 6363 7570 6174 696f 6e2e 656e 6572   occupation.ener
+00002530: 6779 5f72 616e 6765 5b30 5d0a 2020 2020  gy_range[0].    
+00002540: 6966 2074 656d 7065 7261 7475 7265 203e  if temperature >
+00002550: 2030 3a0a 2020 2020 2020 2020 2320 544f   0:.        # TO
+00002560: 444f 3a20 6368 6563 6b0a 2020 2020 2020  DO: check.      
+00002570: 2020 6173 7365 7274 2065 6d61 7820 3d3d    assert emax ==
+00002580: 206d 616e 7962 6f64 792e 5f66 6572 6d69   manybody._fermi
+00002590: 5f66 756e 6374 696f 6e5f 6265 6c6f 775f  _function_below_
+000025a0: 6570 7369 6c6f 6e28 7465 6d70 6572 6174  epsilon(temperat
+000025b0: 7572 653d 7465 6d70 6572 6174 7572 6529  ure=temperature)
+000025c0: 0a20 2020 2065 6c73 653a 0a20 2020 2020  .    else:.     
+000025d0: 2020 2061 7373 6572 7420 656d 6178 203d     assert emax =
+000025e0: 3d20 300a 2020 2020 6173 7365 7274 2065  = 0.    assert e
+000025f0: 6d69 6e20 6973 204e 6f6e 650a 2020 2020  min is None.    
+00002600: 6173 7365 7274 2063 616c 6c61 626c 6528  assert callable(
+00002610: 6f63 6375 7061 7469 6f6e 2e64 6973 7472  occupation.distr
+00002620: 6962 7574 696f 6e29 0a0a 0a64 6566 2074  ibution)...def t
+00002630: 6573 745f 6c65 6164 5f6f 6363 7570 6174  est_lead_occupat
+00002640: 696f 6e5f 6665 726d 695f 6469 7261 6374  ion_fermi_diract
+00002650: 5f7a 6572 6f5f 7465 6d70 6572 6174 7572  _zero_temperatur
+00002660: 6528 293a 0a20 2020 2023 2063 6865 636b  e():.    # check
+00002670: 2064 6566 6175 6c74 2076 616c 7565 732c   default values,
+00002680: 2066 696e 6974 6520 7465 6d70 6572 6174   finite temperat
+00002690: 7572 650a 2020 2020 6d75 203d 2032 0a20  ure.    mu = 2. 
+000026a0: 2020 2065 7073 696c 6f6e 203d 2031 452d     epsilon = 1E-
+000026b0: 3620 2023 2073 6f6d 6520 736d 616c 6c20  6  # some small 
+000026c0: 6e75 6d62 6572 0a20 2020 206f 6363 7570  number.    occup
+000026d0: 6174 696f 6e20 3d20 6d61 6e79 626f 6479  ation = manybody
+000026e0: 2e6c 6561 645f 6f63 6375 7061 7469 6f6e  .lead_occupation
+000026f0: 2863 6865 6d69 6361 6c5f 706f 7465 6e74  (chemical_potent
+00002700: 6961 6c3d 6d75 290a 2020 2020 5f65 6d69  ial=mu).    _emi
+00002710: 6e2c 205f 656d 6178 203d 206f 6363 7570  n, _emax = occup
+00002720: 6174 696f 6e2e 656e 6572 6779 5f72 616e  ation.energy_ran
+00002730: 6765 5b30 5d0a 2020 2020 6173 7365 7274  ge[0].    assert
+00002740: 206f 6363 7570 6174 696f 6e2e 6469 7374   occupation.dist
+00002750: 7269 6275 7469 6f6e 2865 6e65 7267 793d  ribution(energy=
+00002760: 6d75 202d 2065 7073 696c 6f6e 2920 3d3d  mu - epsilon) ==
+00002770: 2031 0a20 2020 2061 7373 6572 7420 6f63   1.    assert oc
+00002780: 6375 7061 7469 6f6e 2e64 6973 7472 6962  cupation.distrib
+00002790: 7574 696f 6e28 656e 6572 6779 3d6d 7520  ution(energy=mu 
+000027a0: 2b20 6570 7369 6c6f 6e29 203d 3d20 300a  + epsilon) == 0.
+000027b0: 2020 2020 6173 7365 7274 205f 656d 696e      assert _emin
+000027c0: 2069 7320 4e6f 6e65 0a20 2020 2061 7373   is None.    ass
+000027d0: 6572 7420 5f65 6d61 7820 3d3d 206d 750a  ert _emax == mu.
+000027e0: 2020 2020 6173 7365 7274 206f 6363 7570      assert occup
+000027f0: 6174 696f 6e2e 6261 6e64 7320 6973 204e  ation.bands is N
+00002800: 6f6e 650a 0a0a 6465 6620 7465 7374 5f6c  one...def test_l
+00002810: 6561 645f 6f63 6375 7061 7469 6f6e 5f66  ead_occupation_f
+00002820: 6572 6d69 5f64 6972 6163 745f 6669 6e69  ermi_diract_fini
+00002830: 7465 5f74 656d 7065 7261 7475 7265 2829  te_temperature()
+00002840: 3a0a 2020 2020 2320 6368 6563 6b20 6465  :.    # check de
+00002850: 6661 756c 7420 7661 6c75 6573 2c20 6669  fault values, fi
+00002860: 6e69 7465 2074 656d 7065 7261 7475 7265  nite temperature
+00002870: 0a20 2020 2064 6566 2066 6572 6d69 5f66  .    def fermi_f
+00002880: 756e 6374 696f 6e28 6368 656d 6963 616c  unction(chemical
+00002890: 5f70 6f74 656e 7469 616c 2c20 7465 6d70  _potential, temp
+000028a0: 6572 6174 7572 652c 2065 6e65 7267 7929  erature, energy)
+000028b0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+000028c0: 2031 202f 2028 6e70 2e65 7870 2828 656e   1 / (np.exp((en
+000028d0: 6572 6779 202d 2063 6865 6d69 6361 6c5f  ergy - chemical_
+000028e0: 706f 7465 6e74 6961 6c29 202f 2074 656d  potential) / tem
+000028f0: 7065 7261 7475 7265 2920 2b20 3129 0a0a  perature) + 1)..
+00002900: 2020 2020 6d75 203d 2032 0a20 2020 2074      mu = 2.    t
+00002910: 656d 7020 3d20 330a 2020 2020 6f63 6375  emp = 3.    occu
+00002920: 7061 7469 6f6e 203d 206d 616e 7962 6f64  pation = manybod
+00002930: 792e 6c65 6164 5f6f 6363 7570 6174 696f  y.lead_occupatio
+00002940: 6e28 6368 656d 6963 616c 5f70 6f74 656e  n(chemical_poten
+00002950: 7469 616c 3d6d 752c 2074 656d 7065 7261  tial=mu, tempera
+00002960: 7475 7265 3d74 656d 7029 0a20 2020 205f  ture=temp).    _
+00002970: 656d 696e 2c20 5f65 6d61 7820 3d20 6f63  emin, _emax = oc
+00002980: 6375 7061 7469 6f6e 2e65 6e65 7267 795f  cupation.energy_
+00002990: 7261 6e67 655b 305d 0a20 2020 2061 7373  range[0].    ass
+000029a0: 6572 7420 6f63 6375 7061 7469 6f6e 2e64  ert occupation.d
+000029b0: 6973 7472 6962 7574 696f 6e28 656e 6572  istribution(ener
+000029c0: 6779 3d31 2920 3d3d 2066 6572 6d69 5f66  gy=1) == fermi_f
+000029d0: 756e 6374 696f 6e28 6d75 2c20 7465 6d70  unction(mu, temp
+000029e0: 2c20 656e 6572 6779 3d31 290a 2020 2020  , energy=1).    
+000029f0: 6173 7365 7274 206f 6363 7570 6174 696f  assert occupatio
+00002a00: 6e2e 6469 7374 7269 6275 7469 6f6e 2865  n.distribution(e
+00002a10: 6e65 7267 793d 3329 203d 3d20 6665 726d  nergy=3) == ferm
+00002a20: 695f 6675 6e63 7469 6f6e 286d 752c 2074  i_function(mu, t
+00002a30: 656d 702c 2065 6e65 7267 793d 3329 0a20  emp, energy=3). 
+00002a40: 2020 2061 7373 6572 7420 5f65 6d69 6e20     assert _emin 
+00002a50: 6973 204e 6f6e 650a 2020 2020 6173 7365  is None.    asse
+00002a60: 7274 205f 656d 6178 203d 3d20 6d75 202b  rt _emax == mu +
+00002a70: 206d 616e 7962 6f64 792e 5f66 6572 6d69   manybody._fermi
+00002a80: 5f66 756e 6374 696f 6e5f 6265 6c6f 775f  _function_below_
+00002a90: 6570 7369 6c6f 6e28 7465 6d70 6572 6174  epsilon(temperat
+00002aa0: 7572 653d 7465 6d70 290a 2020 2020 6173  ure=temp).    as
+00002ab0: 7365 7274 206f 6363 7570 6174 696f 6e2e  sert occupation.
+00002ac0: 6261 6e64 7320 6973 204e 6f6e 650a 0a0a  bands is None...
+00002ad0: 6465 6620 7465 7374 5f6c 6561 645f 6f63  def test_lead_oc
+00002ae0: 6375 7061 7469 6f6e 5f62 616e 645f 7365  cupation_band_se
+00002af0: 6c65 6374 696f 6e28 293a 0a20 2020 2023  lection():.    #
+00002b00: 2063 6865 636b 2062 616e 6420 7365 6c65   check band sele
+00002b10: 6374 696f 6e0a 2020 2020 6f63 6375 7061  ction.    occupa
+00002b20: 7469 6f6e 203d 206d 616e 7962 6f64 792e  tion = manybody.
+00002b30: 6c65 6164 5f6f 6363 7570 6174 696f 6e28  lead_occupation(
+00002b40: 6261 6e64 733d 3329 0a20 2020 2061 7373  bands=3).    ass
+00002b50: 6572 7420 6f63 6375 7061 7469 6f6e 2e62  ert occupation.b
+00002b60: 616e 6473 203d 3d20 5b33 5d0a 2020 2020  ands == [3].    
+00002b70: 6f63 6375 7061 7469 6f6e 203d 206d 616e  occupation = man
+00002b80: 7962 6f64 792e 6c65 6164 5f6f 6363 7570  ybody.lead_occup
+00002b90: 6174 696f 6e28 6261 6e64 733d 5b33 5d29  ation(bands=[3])
+00002ba0: 0a20 2020 2061 7373 6572 7420 6f63 6375  .    assert occu
+00002bb0: 7061 7469 6f6e 2e62 616e 6473 203d 3d20  pation.bands == 
+00002bc0: 5b33 5d0a 2020 2020 2320 6261 6e64 7320  [3].    # bands 
+00002bd0: 616c 7761 7973 2073 6f72 7465 6420 616e  always sorted an
+00002be0: 6420 7769 7468 6f75 7420 6475 626c 6963  d without dublic
+00002bf0: 6174 6573 0a20 2020 206f 6363 7570 6174  ates.    occupat
+00002c00: 696f 6e20 3d20 6d61 6e79 626f 6479 2e6c  ion = manybody.l
+00002c10: 6561 645f 6f63 6375 7061 7469 6f6e 2862  ead_occupation(b
+00002c20: 616e 6473 3d5b 332c 2032 2c20 352c 2035  ands=[3, 2, 5, 5
+00002c30: 2c20 2d31 5d29 0a20 2020 2061 7373 6572  , -1]).    asser
+00002c40: 7420 6f63 6375 7061 7469 6f6e 2e62 616e  t occupation.ban
+00002c50: 6473 203d 3d20 5b2d 312c 2032 2c20 332c  ds == [-1, 2, 3,
+00002c60: 2035 5d0a 0a0a 6465 6620 7465 7374 5f6c   5]...def test_l
+00002c70: 6561 645f 6f63 6375 7061 7469 6f6e 5f6f  ead_occupation_o
+00002c80: 776e 5f64 6174 6174 7970 6528 293a 0a20  wn_datatype():. 
+00002c90: 2020 2063 6c61 7373 204d 794f 6363 7570     class MyOccup
+00002ca0: 6174 696f 6e3a 0a20 2020 2020 2020 2064  ation:.        d
+00002cb0: 6566 205f 5f69 6e69 745f 5f28 7365 6c66  ef __init__(self
+00002cc0: 2c20 6469 7374 7269 6275 7469 6f6e 2c20  , distribution, 
+00002cd0: 656e 6572 6779 5f72 616e 6765 2c20 6261  energy_range, ba
+00002ce0: 6e64 732c 206d 756c 7469 7661 7269 6174  nds, multivariat
+00002cf0: 6529 3a0a 2020 2020 2020 2020 2020 2020  e):.            
+00002d00: 7365 6c66 2e64 6973 7472 6962 7574 696f  self.distributio
+00002d10: 6e20 3d20 6469 7374 7269 6275 7469 6f6e  n = distribution
+00002d20: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00002d30: 662e 6261 6e64 7320 3d20 6261 6e64 730a  f.bands = bands.
+00002d40: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00002d50: 2e65 6e65 7267 795f 7261 6e67 6520 3d20  .energy_range = 
+00002d60: 656e 6572 6779 5f72 616e 6765 0a20 2020  energy_range.   
+00002d70: 2020 2020 2020 2020 2073 656c 662e 6d75           self.mu
+00002d80: 6c74 6976 6172 6961 7465 203d 206d 756c  ltivariate = mul
+00002d90: 7469 7661 7269 6174 650a 2020 2020 2020  tivariate.      
+00002da0: 2020 2020 2020 7365 6c66 2e73 6f6d 6566        self.somef
+00002db0: 6965 6c64 203d 2034 320a 2020 2020 6f63  ield = 42.    oc
+00002dc0: 6375 7061 7469 6f6e 203d 206d 616e 7962  cupation = manyb
+00002dd0: 6f64 792e 6c65 6164 5f6f 6363 7570 6174  ody.lead_occupat
+00002de0: 696f 6e28 6f63 6375 7061 7469 6f6e 5f74  ion(occupation_t
+00002df0: 7970 653d 4d79 4f63 6375 7061 7469 6f6e  ype=MyOccupation
+00002e00: 290a 2020 2020 6173 7365 7274 2063 616c  ).    assert cal
+00002e10: 6c61 626c 6528 6f63 6375 7061 7469 6f6e  lable(occupation
+00002e20: 2e64 6973 7472 6962 7574 696f 6e29 0a20  .distribution). 
+00002e30: 2020 2061 7373 6572 7420 6f63 6375 7061     assert occupa
+00002e40: 7469 6f6e 2e62 616e 6473 2069 7320 4e6f  tion.bands is No
+00002e50: 6e65 0a20 2020 2061 7373 6572 7420 6f63  ne.    assert oc
+00002e60: 6375 7061 7469 6f6e 2e65 6e65 7267 795f  cupation.energy_
+00002e70: 7261 6e67 6520 3d3d 205b 284e 6f6e 652c  range == [(None,
+00002e80: 2030 295d 0a20 2020 2061 7373 6572 7420   0)].    assert 
+00002e90: 6f63 6375 7061 7469 6f6e 2e6d 756c 7469  occupation.multi
+00002ea0: 7661 7269 6174 6520 6973 2046 616c 7365  variate is False
+00002eb0: 0a20 2020 2061 7373 6572 7420 6f63 6375  .    assert occu
+00002ec0: 7061 7469 6f6e 2e73 6f6d 6566 6965 6c64  pation.somefield
+00002ed0: 203d 3d20 3432 0a0a 0a64 6566 2074 6573   == 42...def tes
+00002ee0: 745f 6c65 6164 5f6f 6363 7570 6174 696f  t_lead_occupatio
+00002ef0: 6e5f 7261 6973 6573 2829 3a0a 2020 2020  n_raises():.    
+00002f00: 2320 6e65 6761 7469 7665 2074 656d 7065  # negative tempe
+00002f10: 7261 7475 7265 0a20 2020 2072 6169 7365  rature.    raise
+00002f20: 7328 5661 6c75 6545 7272 6f72 2c20 6d61  s(ValueError, ma
+00002f30: 6e79 626f 6479 2e6c 6561 645f 6f63 6375  nybody.lead_occu
+00002f40: 7061 7469 6f6e 2c20 7465 6d70 6572 6174  pation, temperat
+00002f50: 7572 653d 2d31 290a 2020 2020 2320 6e6f  ure=-1).    # no
+00002f60: 7420 7265 616c 206e 756d 6265 7273 0a20  t real numbers. 
+00002f70: 2020 2072 6169 7365 7328 5479 7065 4572     raises(TypeEr
+00002f80: 726f 722c 206d 616e 7962 6f64 792e 6c65  ror, manybody.le
+00002f90: 6164 5f6f 6363 7570 6174 696f 6e2c 2063  ad_occupation, c
+00002fa0: 6865 6d69 6361 6c5f 706f 7465 6e74 6961  hemical_potentia
+00002fb0: 6c3d 3120 2b20 316a 290a 2020 2020 7261  l=1 + 1j).    ra
+00002fc0: 6973 6573 2854 7970 6545 7272 6f72 2c20  ises(TypeError, 
+00002fd0: 6d61 6e79 626f 6479 2e6c 6561 645f 6f63  manybody.lead_oc
+00002fe0: 6375 7061 7469 6f6e 2c20 7465 6d70 6572  cupation, temper
+00002ff0: 6174 7572 653d 3120 2b20 316a 290a 0a0a  ature=1 + 1j)...
+00003000: 6465 6620 7465 7374 5f6d 616b 655f 696e  def test_make_in
+00003010: 7465 7276 616c 735f 6465 6661 756c 7428  tervals_default(
+00003020: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
+00003030: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
+00003040: 6174 696f 6e29 3a0a 2020 2020 696e 7465  ation):.    inte
+00003050: 7276 616c 7320 3d20 6d61 6e79 626f 6479  rvals = manybody
+00003060: 2e63 616c 635f 696e 7465 7276 616c 7328  .calc_intervals(
+00003070: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
+00003080: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
+00003090: 6174 696f 6e29 0a0a 2020 2020 2320 6368  ation)..    # ch
+000030a0: 6563 6b20 616c 6c20 7479 7065 7320 6f66  eck all types of
+000030b0: 2074 6865 2072 6574 7572 6e65 6420 656c   the returned el
+000030c0: 656d 656e 7473 0a20 2020 2061 7373 6572  ements.    asser
+000030d0: 7420 6973 696e 7374 616e 6365 2869 6e74  t isinstance(int
+000030e0: 6572 7661 6c73 2c20 6c69 7374 290a 2020  ervals, list).  
+000030f0: 2020 6173 7365 7274 206c 656e 2869 6e74    assert len(int
+00003100: 6572 7661 6c73 2920 3d3d 2074 776f 5f62  ervals) == two_b
+00003110: 616e 645f 7370 6563 7472 756d 2e6e 6261  and_spectrum.nba
+00003120: 6e64 730a 2020 2020 666f 7220 696e 7465  nds.    for inte
+00003130: 7276 616c 2069 6e20 696e 7465 7276 616c  rval in interval
+00003140: 733a 0a20 2020 2020 2020 2061 7373 6572  s:.        asser
+00003150: 7420 6973 696e 7374 616e 6365 2869 6e74  t isinstance(int
+00003160: 6572 7661 6c2c 206d 616e 7962 6f64 792e  erval, manybody.
+00003170: 496e 7465 7276 616c 290a 2020 2020 2020  Interval).      
+00003180: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00003190: 6e63 6528 696e 7465 7276 616c 2e6c 6561  nce(interval.lea
+000031a0: 642c 2069 6e74 290a 2020 2020 2020 2020  d, int).        
+000031b0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+000031c0: 6528 696e 7465 7276 616c 2e62 616e 642c  e(interval.band,
+000031d0: 2069 6e74 290a 2020 2020 2020 2020 6173   int).        as
+000031e0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+000031f0: 696e 7465 7276 616c 2e6b 6d69 6e2c 2066  interval.kmin, f
+00003200: 6c6f 6174 290a 2020 2020 2020 2020 6173  loat).        as
+00003210: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00003220: 696e 7465 7276 616c 2e6b 6d61 782c 2066  interval.kmax, f
+00003230: 6c6f 6174 290a 2020 2020 2020 2020 6173  loat).        as
+00003240: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00003250: 696e 7465 7276 616c 2e6f 7264 6572 2c20  interval.order, 
+00003260: 696e 7429 0a20 2020 2020 2020 2061 7373  int).        ass
+00003270: 6572 7420 6973 696e 7374 616e 6365 2869  ert isinstance(i
+00003280: 6e74 6572 7661 6c2e 696e 7465 6772 6174  nterval.integrat
+00003290: 696f 6e5f 7661 7269 6162 6c65 2c20 7374  ion_variable, st
+000032a0: 7229 0a20 2020 2020 2020 2061 7373 6572  r).        asser
+000032b0: 7420 6973 696e 7374 616e 6365 2869 6e74  t isinstance(int
+000032c0: 6572 7661 6c2e 7175 6164 7261 7475 7265  erval.quadrature
+000032d0: 2c20 7374 7229 0a0a 2020 2020 2320 6368  , str)..    # ch
+000032e0: 6563 6b20 6578 706c 6963 6974 2072 6574  eck explicit ret
+000032f0: 7572 6e65 6420 7661 6c75 6573 0a20 2020  urned values.   
+00003300: 2023 2069 6e74 6572 7661 6c73 2066 6f72   # intervals for
+00003310: 2061 6c6c 2062 616e 6473 206f 6620 7468   all bands of th
+00003320: 6520 7370 6563 7472 756d 0a20 2020 2023  e spectrum.    #
+00003330: 2069 6e74 6572 7661 6c73 2063 6f6e 7461   intervals conta
+00003340: 696e 7320 7468 6520 6d6f 6d65 6e74 756d  ins the momentum
+00003350: 2028 6b29 2069 6e74 6572 7661 6c73 2077   (k) intervals w
+00003360: 6865 7265 2064 2045 5f6e 202f 2064 6b20  here d E_n / dk 
+00003370: 3e20 300a 2020 2020 2320 6672 6f6d 2061  > 0.    # from a
+00003380: 626f 7665 2064 6973 7065 7273 696f 6e20  bove dispersion 
+00003390: 666f 6c6c 6f77 7320 7468 6174 2074 6869  follows that thi
+000033a0: 7320 6973 2074 6865 2063 6173 6520 666f  s is the case fo
+000033b0: 7220 6b20 696e 205b 302c 2070 695d 0a20  r k in [0, pi]. 
+000033c0: 2020 2066 6f72 2069 2c20 696e 7465 7276     for i, interv
+000033d0: 616c 2069 6e20 656e 756d 6572 6174 6528  al in enumerate(
+000033e0: 696e 7465 7276 616c 7329 3a0a 2020 2020  intervals):.    
+000033f0: 2020 2020 6173 7365 7274 2069 6e74 6572      assert inter
+00003400: 7661 6c2e 6c65 6164 203d 3d20 3020 2023  val.lead == 0  #
+00003410: 206f 6e6c 7920 6f6e 6520 6c65 6164 0a20   only one lead. 
+00003420: 2020 2020 2020 2061 7373 6572 7420 696e         assert in
+00003430: 7465 7276 616c 2e62 616e 6420 3d3d 2069  terval.band == i
+00003440: 0a20 2020 2020 2020 2061 7373 6572 745f  .        assert_
+00003450: 616c 6d6f 7374 5f65 7175 616c 2869 6e74  almost_equal(int
+00003460: 6572 7661 6c2e 6b6d 696e 2c20 3029 0a20  erval.kmin, 0). 
+00003470: 2020 2020 2020 2061 7373 6572 745f 616c         assert_al
+00003480: 6d6f 7374 5f65 7175 616c 2869 6e74 6572  most_equal(inter
+00003490: 7661 6c2e 6b6d 6178 2c20 6e70 2e70 6929  val.kmax, np.pi)
+000034a0: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+000034b0: 696e 7465 7276 616c 2e6f 7264 6572 203d  interval.order =
+000034c0: 3d20 3130 0a20 2020 2020 2020 2061 7373  = 10.        ass
+000034d0: 6572 7420 696e 7465 7276 616c 2e69 6e74  ert interval.int
+000034e0: 6567 7261 7469 6f6e 5f76 6172 6961 626c  egration_variabl
+000034f0: 6520 3d3d 2027 6d6f 6d65 6e74 756d 270a  e == 'momentum'.
+00003500: 2020 2020 2020 2020 6173 7365 7274 2069          assert i
+00003510: 6e74 6572 7661 6c2e 7175 6164 7261 7475  nterval.quadratu
+00003520: 7265 203d 3d20 276b 726f 6e72 6f64 270a  re == 'kronrod'.
+00003530: 0a0a 6465 6620 7465 7374 5f6d 616b 655f  ..def test_make_
+00003540: 696e 7465 7276 616c 735f 7769 7468 5f75  intervals_with_u
+00003550: 6e6f 6363 7570 6965 645f 6c65 6164 7328  noccupied_leads(
+00003560: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
+00003570: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
+00003580: 6174 696f 6e29 3a0a 2020 2020 2320 6368  ation):.    # ch
+00003590: 6563 6b20 7468 6174 2069 6e74 6572 7661  eck that interva
+000035a0: 6c73 2077 6974 6820 6164 6469 7469 6f6e  ls with addition
+000035b0: 616c 2075 6e6f 6363 7570 6965 6420 6c65  al unoccupied le
+000035c0: 6164 7320 6973 2073 696d 696c 6172 0a20  ads is similar. 
+000035d0: 2020 2069 6e74 6572 7661 6c73 203d 206d     intervals = m
+000035e0: 616e 7962 6f64 792e 6361 6c63 5f69 6e74  anybody.calc_int
+000035f0: 6572 7661 6c73 2874 776f 5f62 616e 645f  ervals(two_band_
+00003600: 7370 6563 7472 756d 2c20 756e 6966 6f72  spectrum, unifor
+00003610: 6d5f 6f63 6375 7061 7469 6f6e 290a 0a20  m_occupation).. 
+00003620: 2020 2066 6f72 206e 625f 6c65 6164 7320     for nb_leads 
+00003630: 696e 2072 616e 6765 2831 2c20 3529 3a0a  in range(1, 5):.
+00003640: 2020 2020 2020 2020 7370 6563 7472 6120          spectra 
+00003650: 3d20 5b74 776f 5f62 616e 645f 7370 6563  = [two_band_spec
+00003660: 7472 756d 5d20 2a20 6e62 5f6c 6561 6473  trum] * nb_leads
+00003670: 0a20 2020 2020 2020 206f 6363 7570 6174  .        occupat
+00003680: 696f 6e73 203d 205b 756e 6966 6f72 6d5f  ions = [uniform_
+00003690: 6f63 6375 7061 7469 6f6e 5d20 2b20 5b4e  occupation] + [N
+000036a0: 6f6e 655d 202a 2028 6e62 5f6c 6561 6473  one] * (nb_leads
+000036b0: 202d 2031 290a 2020 2020 2020 2020 696e   - 1).        in
+000036c0: 7465 7276 616c 735f 756e 6f63 6320 3d20  tervals_unocc = 
+000036d0: 6d61 6e79 626f 6479 2e63 616c 635f 696e  manybody.calc_in
+000036e0: 7465 7276 616c 7328 7370 6563 7472 612c  tervals(spectra,
+000036f0: 206f 6363 7570 6174 696f 6e73 290a 2020   occupations).  
+00003700: 2020 2020 2020 6173 7365 7274 2069 6e74        assert int
+00003710: 6572 7661 6c73 5f75 6e6f 6363 203d 3d20  ervals_unocc == 
+00003720: 696e 7465 7276 616c 730a 0a0a 6465 6620  intervals...def 
+00003730: 7465 7374 5f6d 616b 655f 696e 7465 7276  test_make_interv
+00003740: 616c 735f 6c65 6164 5f69 6e64 6578 2874  als_lead_index(t
+00003750: 776f 5f62 616e 645f 7370 6563 7472 756d  wo_band_spectrum
+00003760: 2c20 756e 6966 6f72 6d5f 6f63 6375 7061  , uniform_occupa
+00003770: 7469 6f6e 293a 0a20 2020 2023 2063 6865  tion):.    # che
+00003780: 636b 2074 6861 7420 7468 6520 706f 7369  ck that the posi
+00003790: 7469 6f6e 206f 6620 7468 6520 6f63 6375  tion of the occu
+000037a0: 7061 7469 6f6e 2064 6574 6572 6d69 6e65  pation determine
+000037b0: 7320 7468 6520 6c65 6164 2069 6e64 6578  s the lead index
+000037c0: 0a20 2020 2074 6f74 616c 5f6e 625f 6c65  .    total_nb_le
+000037d0: 6164 7320 3d20 350a 2020 2020 666f 7220  ads = 5.    for 
+000037e0: 6920 696e 2072 616e 6765 2830 2c20 746f  i in range(0, to
+000037f0: 7461 6c5f 6e62 5f6c 6561 6473 293a 0a20  tal_nb_leads):. 
+00003800: 2020 2020 2020 2073 7065 6374 7261 203d         spectra =
+00003810: 205b 7477 6f5f 6261 6e64 5f73 7065 6374   [two_band_spect
+00003820: 7275 6d5d 202a 2074 6f74 616c 5f6e 625f  rum] * total_nb_
+00003830: 6c65 6164 730a 2020 2020 2020 2020 6f63  leads.        oc
+00003840: 6375 7061 7469 6f6e 7320 3d20 5b4e 6f6e  cupations = [Non
+00003850: 655d 202a 2069 202b 205b 756e 6966 6f72  e] * i + [unifor
+00003860: 6d5f 6f63 6375 7061 7469 6f6e 5d20 2b20  m_occupation] + 
+00003870: 5b4e 6f6e 655d 202a 2028 746f 7461 6c5f  [None] * (total_
+00003880: 6e62 5f6c 6561 6473 202d 2069 202d 2031  nb_leads - i - 1
+00003890: 290a 2020 2020 2020 2020 696e 7465 7276  ).        interv
+000038a0: 616c 7320 3d20 6d61 6e79 626f 6479 2e63  als = manybody.c
+000038b0: 616c 635f 696e 7465 7276 616c 7328 7370  alc_intervals(sp
+000038c0: 6563 7472 612c 206f 6363 7570 6174 696f  ectra, occupatio
+000038d0: 6e73 290a 2020 2020 2020 2020 666f 7220  ns).        for 
+000038e0: 696e 7465 7276 616c 2069 6e20 696e 7465  interval in inte
+000038f0: 7276 616c 733a 0a20 2020 2020 2020 2020  rvals:.         
+00003900: 2020 2061 7373 6572 7420 696e 7465 7276     assert interv
+00003910: 616c 2e6c 6561 6420 3d3d 2069 0a0a 0a64  al.lead == i...d
+00003920: 6566 2074 6573 745f 6d61 6b65 5f69 6e74  ef test_make_int
+00003930: 6572 7661 6c73 5f77 6974 685f 656e 6572  ervals_with_ener
+00003940: 6779 5f63 6f6e 7374 7261 696e 7428 7477  gy_constraint(tw
+00003950: 6f5f 6261 6e64 5f73 7065 6374 7275 6d2c  o_band_spectrum,
+00003960: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
+00003970: 696f 6e29 3a0a 0a20 2020 2023 2073 656c  ion):..    # sel
+00003980: 6563 7420 6f6e 6c79 2062 616e 6473 2069  ect only bands i
+00003990: 6e20 656e 6572 6779 2072 616e 6765 2065  n energy range e
+000039a0: 6d69 6e20 3c20 455f 6e28 6b29 203c 2065  min < E_n(k) < e
+000039b0: 6d61 780a 2020 2020 2320 696e 7465 7276  max.    # interv
+000039c0: 616c 7320 636f 6e74 6169 6e73 2074 6865  als contains the
+000039d0: 206d 6f6d 656e 7475 6d20 286b 2920 696e   momentum (k) in
+000039e0: 7465 7276 616c 7320 7768 6572 6520 6420  tervals where d 
+000039f0: 455f 6e20 2f20 646b 203e 2030 0a20 2020  E_n / dk > 0.   
+00003a00: 2023 2077 6974 6820 7468 6520 6164 6469   # with the addi
+00003a10: 7469 6f6e 616c 2063 6f6e 7374 7261 696e  tional constrain
+00003a20: 7420 656d 696e 203c 2045 5f6e 286b 2920  t emin < E_n(k) 
+00003a30: 3c20 656d 6178 0a20 2020 2075 6e69 666f  < emax.    unifo
+00003a40: 726d 5f6f 6363 7570 6174 696f 6e2e 656e  rm_occupation.en
+00003a50: 6572 6779 5f72 616e 6765 203d 205b 282d  ergy_range = [(-
+00003a60: 312c 2031 295d 0a20 2020 2069 6e74 6572  1, 1)].    inter
+00003a70: 7661 6c73 203d 206d 616e 7962 6f64 792e  vals = manybody.
+00003a80: 6361 6c63 5f69 6e74 6572 7661 6c73 2874  calc_intervals(t
+00003a90: 776f 5f62 616e 645f 7370 6563 7472 756d  wo_band_spectrum
+00003aa0: 2c20 756e 6966 6f72 6d5f 6f63 6375 7061  , uniform_occupa
+00003ab0: 7469 6f6e 290a 0a20 2020 2061 7373 6572  tion)..    asser
+00003ac0: 7420 6c65 6e28 696e 7465 7276 616c 7329  t len(intervals)
+00003ad0: 203d 3d20 7477 6f5f 6261 6e64 5f73 7065   == two_band_spe
+00003ae0: 6374 7275 6d2e 6e62 616e 6473 0a20 2020  ctrum.nbands.   
+00003af0: 2066 6f72 2069 2c20 696e 7465 7276 616c   for i, interval
+00003b00: 2069 6e20 656e 756d 6572 6174 6528 696e   in enumerate(in
+00003b10: 7465 7276 616c 7329 3a0a 2020 2020 2020  tervals):.      
+00003b20: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00003b30: 6e63 6528 696e 7465 7276 616c 2c20 6d61  nce(interval, ma
+00003b40: 6e79 626f 6479 2e49 6e74 6572 7661 6c29  nybody.Interval)
+00003b50: 0a20 2020 2020 2020 2061 7373 6572 7420  .        assert 
+00003b60: 696e 7465 7276 616c 2e6c 6561 6420 3d3d  interval.lead ==
+00003b70: 2030 2020 2320 6f6e 6c79 206f 6e65 206c   0  # only one l
+00003b80: 6561 640a 2020 2020 2020 2020 6173 7365  ead.        asse
+00003b90: 7274 2069 6e74 6572 7661 6c2e 6261 6e64  rt interval.band
+00003ba0: 203d 3d20 690a 2020 2020 2020 2020 6966   == i.        if
+00003bb0: 2069 6e74 6572 7661 6c2e 6261 6e64 203d   interval.band =
+00003bc0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+00003bd0: 2061 7373 6572 745f 616c 6d6f 7374 5f65   assert_almost_e
+00003be0: 7175 616c 2869 6e74 6572 7661 6c2e 6b6d  qual(interval.km
+00003bf0: 696e 2c20 302e 3520 2a20 6e70 2e70 6929  in, 0.5 * np.pi)
+00003c00: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+00003c10: 6572 745f 616c 6d6f 7374 5f65 7175 616c  ert_almost_equal
+00003c20: 2869 6e74 6572 7661 6c2e 6b6d 6178 2c20  (interval.kmax, 
+00003c30: 6e70 2e70 6929 0a20 2020 2020 2020 2065  np.pi).        e
+00003c40: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00003c50: 2061 7373 6572 745f 616c 6d6f 7374 5f65   assert_almost_e
+00003c60: 7175 616c 2869 6e74 6572 7661 6c2e 6b6d  qual(interval.km
+00003c70: 696e 2c20 3029 0a20 2020 2020 2020 2020  in, 0).         
+00003c80: 2020 2061 7373 6572 745f 616c 6d6f 7374     assert_almost
+00003c90: 5f65 7175 616c 2869 6e74 6572 7661 6c2e  _equal(interval.
+00003ca0: 6b6d 6178 2c20 302e 3520 2a20 6e70 2e70  kmax, 0.5 * np.p
+00003cb0: 6929 0a0a 0a64 6566 2074 6573 745f 6d61  i)...def test_ma
+00003cc0: 6b65 5f69 6e74 6572 7661 6c73 5f77 6974  ke_intervals_wit
+00003cd0: 685f 656e 6572 6779 5f61 6e64 5f62 616e  h_energy_and_ban
+00003ce0: 645f 636f 6e73 7472 6169 6e74 2874 776f  d_constraint(two
+00003cf0: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
+00003d00: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
+00003d10: 6f6e 293a 0a0a 2020 2020 2320 7365 6c65  on):..    # sele
+00003d20: 6374 206f 6e6c 7920 6261 6e64 7320 696e  ct only bands in
+00003d30: 2065 6e65 7267 7920 7261 6e67 6520 616e   energy range an
+00003d40: 6420 7461 6b65 206f 6e6c 7920 6c6f 7765  d take only lowe
+00003d50: 7374 2062 616e 6420 7769 7468 2069 6e64  st band with ind
+00003d60: 6578 2030 0a20 2020 2023 2069 6e74 6572  ex 0.    # inter
+00003d70: 7661 6c73 2063 6f6e 7461 696e 7320 7468  vals contains th
+00003d80: 6520 6d6f 6d65 6e74 756d 2028 6b29 2069  e momentum (k) i
+00003d90: 6e74 6572 7661 6c73 2077 6865 7265 2064  ntervals where d
+00003da0: 2045 5f30 202f 2064 6b20 3e20 300a 2020   E_0 / dk > 0.  
+00003db0: 2020 2320 7769 7468 2074 6865 2061 6464    # with the add
+00003dc0: 6974 696f 6e61 6c20 636f 6e73 7472 6169  itional constrai
+00003dd0: 6e74 2065 6d69 6e20 3c20 455f 3028 6b29  nt emin < E_0(k)
+00003de0: 203c 2065 6d61 780a 2020 2020 2320 286e   < emax.    # (n
+00003df0: 6f74 6520 7468 6174 2077 6520 6861 7665  ote that we have
+00003e00: 2073 6574 206e 2074 6f20 3029 0a20 2020   set n to 0).   
+00003e10: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
+00003e20: 696f 6e2e 656e 6572 6779 5f72 616e 6765  ion.energy_range
+00003e30: 203d 205b 282d 312c 2031 295d 0a20 2020   = [(-1, 1)].   
+00003e40: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
+00003e50: 696f 6e2e 6261 6e64 7320 3d20 5b30 5d0a  ion.bands = [0].
+00003e60: 2020 2020 696e 7465 7276 616c 7320 3d20      intervals = 
+00003e70: 6d61 6e79 626f 6479 2e63 616c 635f 696e  manybody.calc_in
+00003e80: 7465 7276 616c 7328 7477 6f5f 6261 6e64  tervals(two_band
+00003e90: 5f73 7065 6374 7275 6d2c 2075 6e69 666f  _spectrum, unifo
+00003ea0: 726d 5f6f 6363 7570 6174 696f 6e29 0a0a  rm_occupation)..
+00003eb0: 2020 2020 6173 7365 7274 206c 656e 2869      assert len(i
+00003ec0: 6e74 6572 7661 6c73 2920 3d3d 2031 0a20  ntervals) == 1. 
+00003ed0: 2020 2066 6f72 2069 2c20 696e 7465 7276     for i, interv
+00003ee0: 616c 2069 6e20 656e 756d 6572 6174 6528  al in enumerate(
+00003ef0: 696e 7465 7276 616c 7329 3a0a 2020 2020  intervals):.    
+00003f00: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+00003f10: 7461 6e63 6528 696e 7465 7276 616c 2c20  tance(interval, 
+00003f20: 6d61 6e79 626f 6479 2e49 6e74 6572 7661  manybody.Interva
+00003f30: 6c29 0a20 2020 2020 2020 2061 7373 6572  l).        asser
+00003f40: 7420 696e 7465 7276 616c 2e6c 6561 6420  t interval.lead 
+00003f50: 3d3d 2030 2020 2320 6f6e 6c79 206f 6e65  == 0  # only one
+00003f60: 206c 6561 640a 2020 2020 2020 2020 6173   lead.        as
+00003f70: 7365 7274 2069 6e74 6572 7661 6c2e 6261  sert interval.ba
+00003f80: 6e64 203d 3d20 690a 2020 2020 2020 2020  nd == i.        
+00003f90: 6173 7365 7274 5f61 6c6d 6f73 745f 6571  assert_almost_eq
+00003fa0: 7561 6c28 696e 7465 7276 616c 2e6b 6d69  ual(interval.kmi
+00003fb0: 6e2c 2030 2e35 202a 206e 702e 7069 290a  n, 0.5 * np.pi).
+00003fc0: 2020 2020 2020 2020 6173 7365 7274 5f61          assert_a
+00003fd0: 6c6d 6f73 745f 6571 7561 6c28 696e 7465  lmost_equal(inte
+00003fe0: 7276 616c 2e6b 6d61 782c 206e 702e 7069  rval.kmax, np.pi
+00003ff0: 290a 0a0a 6465 6620 7465 7374 5f6d 616b  )...def test_mak
+00004000: 655f 696e 7465 7276 616c 735f 7768 6963  e_intervals_whic
+00004010: 685f 6172 655f 656d 7074 7928 7477 6f5f  h_are_empty(two_
+00004020: 6261 6e64 5f73 7065 6374 7275 6d2c 2075  band_spectrum, u
+00004030: 6e69 666f 726d 5f6f 6363 7570 6174 696f  niform_occupatio
+00004040: 6e29 3a0a 2020 2020 2320 6361 7365 2077  n):.    # case w
+00004050: 6865 7265 206e 6f20 696e 7465 7276 616c  here no interval
+00004060: 7320 6172 6520 666f 756e 640a 2020 2020  s are found.    
+00004070: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
+00004080: 6f6e 2e65 6e65 7267 795f 7261 6e67 6520  on.energy_range 
+00004090: 3d20 5b28 352c 2036 295d 0a20 2020 2069  = [(5, 6)].    i
+000040a0: 6e74 6572 7661 6c73 203d 206d 616e 7962  ntervals = manyb
+000040b0: 6f64 792e 6361 6c63 5f69 6e74 6572 7661  ody.calc_interva
+000040c0: 6c73 2874 776f 5f62 616e 645f 7370 6563  ls(two_band_spec
+000040d0: 7472 756d 2c20 756e 6966 6f72 6d5f 6f63  trum, uniform_oc
+000040e0: 6375 7061 7469 6f6e 290a 2020 2020 6173  cupation).    as
+000040f0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00004100: 696e 7465 7276 616c 732c 206c 6973 7429  intervals, list)
+00004110: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
+00004120: 696e 7465 7276 616c 7329 203d 3d20 300a  intervals) == 0.
+00004130: 0a0a 6465 6620 7465 7374 5f6d 616b 655f  ..def test_make_
+00004140: 696e 7465 7276 616c 735f 7769 7468 5f74  intervals_with_t
+00004150: 776f 5f73 696d 696c 6172 5f6f 6363 7570  wo_similar_occup
+00004160: 6965 645f 6c65 6164 7328 7477 6f5f 6261  ied_leads(two_ba
+00004170: 6e64 5f73 7065 6374 7275 6d2c 2075 6e69  nd_spectrum, uni
+00004180: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
+00004190: 3a0a 2020 2020 2320 7477 6f20 6c65 6164  :.    # two lead
+000041a0: 7320 7769 7468 2065 7175 616c 206f 6363  s with equal occ
+000041b0: 7570 6174 696f 6e0a 2020 2020 6e75 6d5f  upation.    num_
+000041c0: 6c65 6164 7320 3d20 320a 2020 2020 696e  leads = 2.    in
+000041d0: 7465 7276 616c 7320 3d20 6d61 6e79 626f  tervals = manybo
+000041e0: 6479 2e63 616c 635f 696e 7465 7276 616c  dy.calc_interval
+000041f0: 7328 5b74 776f 5f62 616e 645f 7370 6563  s([two_band_spec
+00004200: 7472 756d 5d20 2a20 6e75 6d5f 6c65 6164  trum] * num_lead
+00004210: 732c 2075 6e69 666f 726d 5f6f 6363 7570  s, uniform_occup
+00004220: 6174 696f 6e29 0a20 2020 2061 7373 6572  ation).    asser
+00004230: 7420 6c65 6e28 696e 7465 7276 616c 7329  t len(intervals)
+00004240: 203d 3d20 7477 6f5f 6261 6e64 5f73 7065   == two_band_spe
+00004250: 6374 7275 6d2e 6e62 616e 6473 202a 206e  ctrum.nbands * n
+00004260: 756d 5f6c 6561 6473 0a20 2020 2066 6f72  um_leads.    for
+00004270: 2069 2c20 696e 7465 7276 616c 2069 6e20   i, interval in 
+00004280: 656e 756d 6572 6174 6528 696e 7465 7276  enumerate(interv
+00004290: 616c 7329 3a0a 2020 2020 2020 2020 6173  als):.        as
+000042a0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+000042b0: 696e 7465 7276 616c 2c20 6d61 6e79 626f  interval, manybo
+000042c0: 6479 2e49 6e74 6572 7661 6c29 0a20 2020  dy.Interval).   
+000042d0: 2020 2020 2061 7373 6572 7420 696e 7465       assert inte
+000042e0: 7276 616c 2e6c 6561 6420 696e 2072 616e  rval.lead in ran
+000042f0: 6765 286e 756d 5f6c 6561 6473 290a 2020  ge(num_leads).  
+00004300: 2020 2020 2020 6173 7365 7274 5f61 6c6d        assert_alm
+00004310: 6f73 745f 6571 7561 6c28 696e 7465 7276  ost_equal(interv
+00004320: 616c 2e6b 6d69 6e2c 2030 290a 2020 2020  al.kmin, 0).    
+00004330: 2020 2020 6173 7365 7274 5f61 6c6d 6f73      assert_almos
+00004340: 745f 6571 7561 6c28 696e 7465 7276 616c  t_equal(interval
+00004350: 2e6b 6d61 782c 206e 702e 7069 290a 0a0a  .kmax, np.pi)...
+00004360: 6465 6620 7465 7374 5f6d 616b 655f 696e  def test_make_in
+00004370: 7465 7276 616c 735f 7769 7468 5f74 776f  tervals_with_two
+00004380: 5f64 6966 6665 7265 6e74 6c79 5f6f 6363  _differently_occ
+00004390: 7570 6965 645f 6c65 6164 7328 7477 6f5f  upied_leads(two_
+000043a0: 6261 6e64 5f73 7065 6374 7275 6d2c 2075  band_spectrum, u
+000043b0: 6e69 666f 726d 5f6f 6363 7570 6174 696f  niform_occupatio
+000043c0: 6e29 3a0a 2020 2020 2320 7477 6f20 6c65  n):.    # two le
+000043d0: 6164 7320 7769 7468 2064 6966 6665 7265  ads with differe
+000043e0: 6e74 206f 6363 7570 6174 696f 6e73 0a20  nt occupations. 
+000043f0: 2020 206e 756d 5f6c 6561 6473 203d 2032     num_leads = 2
+00004400: 0a20 2020 206f 6363 7570 6174 696f 6e5f  .    occupation_
+00004410: 3120 3d20 636f 7079 2e64 6565 7063 6f70  1 = copy.deepcop
+00004420: 7928 756e 6966 6f72 6d5f 6f63 6375 7061  y(uniform_occupa
+00004430: 7469 6f6e 290a 2020 2020 6f63 6375 7061  tion).    occupa
+00004440: 7469 6f6e 5f31 2e62 616e 6473 203d 205b  tion_1.bands = [
+00004450: 305d 0a20 2020 206f 6363 7570 6174 696f  0].    occupatio
+00004460: 6e5f 3220 3d20 636f 7079 2e64 6565 7063  n_2 = copy.deepc
+00004470: 6f70 7928 756e 6966 6f72 6d5f 6f63 6375  opy(uniform_occu
+00004480: 7061 7469 6f6e 290a 2020 2020 6f63 6375  pation).    occu
+00004490: 7061 7469 6f6e 5f32 2e65 6e65 7267 795f  pation_2.energy_
+000044a0: 7261 6e67 6520 3d20 5b28 2d31 2c20 3129  range = [(-1, 1)
+000044b0: 5d0a 2020 2020 6f63 6375 7061 7469 6f6e  ].    occupation
+000044c0: 5f32 2e62 616e 6473 203d 205b 305d 0a20  _2.bands = [0]. 
+000044d0: 2020 2069 6e74 6572 7661 6c73 203d 206d     intervals = m
+000044e0: 616e 7962 6f64 792e 6361 6c63 5f69 6e74  anybody.calc_int
+000044f0: 6572 7661 6c73 285b 7477 6f5f 6261 6e64  ervals([two_band
+00004500: 5f73 7065 6374 7275 6d5d 202a 206e 756d  _spectrum] * num
+00004510: 5f6c 6561 6473 2c20 5b6f 6363 7570 6174  _leads, [occupat
+00004520: 696f 6e5f 312c 206f 6363 7570 6174 696f  ion_1, occupatio
+00004530: 6e5f 325d 290a 2020 2020 6173 7365 7274  n_2]).    assert
+00004540: 206c 656e 2869 6e74 6572 7661 6c73 2920   len(intervals) 
+00004550: 3d3d 206e 756d 5f6c 6561 6473 2020 2320  == num_leads  # 
+00004560: 6f6e 6c79 206f 6e65 2062 616e 6420 7065  only one band pe
+00004570: 7220 6c65 6164 0a20 2020 2066 6f72 2069  r lead.    for i
+00004580: 2c20 696e 7465 7276 616c 2069 6e20 656e  , interval in en
+00004590: 756d 6572 6174 6528 696e 7465 7276 616c  umerate(interval
+000045a0: 7329 3a0a 2020 2020 2020 2020 6173 7365  s):.        asse
+000045b0: 7274 2069 7369 6e73 7461 6e63 6528 696e  rt isinstance(in
+000045c0: 7465 7276 616c 2c20 6d61 6e79 626f 6479  terval, manybody
+000045d0: 2e49 6e74 6572 7661 6c29 0a20 2020 2020  .Interval).     
+000045e0: 2020 2069 6620 696e 7465 7276 616c 2e6c     if interval.l
+000045f0: 6561 6420 3d3d 2030 3a0a 2020 2020 2020  ead == 0:.      
+00004600: 2020 2020 2020 6173 7365 7274 5f61 6c6d        assert_alm
+00004610: 6f73 745f 6571 7561 6c28 696e 7465 7276  ost_equal(interv
+00004620: 616c 2e6b 6d69 6e2c 2030 290a 2020 2020  al.kmin, 0).    
+00004630: 2020 2020 2020 2020 6173 7365 7274 5f61          assert_a
+00004640: 6c6d 6f73 745f 6571 7561 6c28 696e 7465  lmost_equal(inte
+00004650: 7276 616c 2e6b 6d61 782c 206e 702e 7069  rval.kmax, np.pi
+00004660: 290a 2020 2020 2020 2020 656c 6966 2069  ).        elif i
+00004670: 6e74 6572 7661 6c2e 6c65 6164 203d 3d20  nterval.lead == 
+00004680: 313a 0a20 2020 2020 2020 2020 2020 2061  1:.            a
+00004690: 7373 6572 745f 616c 6d6f 7374 5f65 7175  ssert_almost_equ
+000046a0: 616c 2869 6e74 6572 7661 6c2e 6b6d 696e  al(interval.kmin
+000046b0: 2c20 302e 3520 2a20 6e70 2e70 6929 0a20  , 0.5 * np.pi). 
+000046c0: 2020 2020 2020 2020 2020 2061 7373 6572             asser
+000046d0: 745f 616c 6d6f 7374 5f65 7175 616c 2869  t_almost_equal(i
+000046e0: 6e74 6572 7661 6c2e 6b6d 6178 2c20 6e70  nterval.kmax, np
+000046f0: 2e70 6929 0a0a 0a64 6566 2074 6573 745f  .pi)...def test_
+00004700: 6d61 6b65 5f69 6e74 6572 7661 6c73 5f69  make_intervals_i
+00004710: 6e74 6572 6661 6365 2874 776f 5f62 616e  nterface(two_ban
+00004720: 645f 7370 6563 7472 756d 2c20 756e 6966  d_spectrum, unif
+00004730: 6f72 6d5f 6f63 6375 7061 7469 6f6e 293a  orm_occupation):
+00004740: 0a20 2020 2023 2063 6865 636b 2066 6f72  .    # check for
+00004750: 2072 6f62 7573 746e 6573 7320 6f66 2069   robustness of i
+00004760: 6e74 6572 6661 6374 2066 6f72 2073 6571  nterfact for seq
+00004770: 7565 6e63 6573 2069 6e70 7574 0a20 2020  uences input.   
+00004780: 2069 6e74 6572 7661 6c73 5f31 203d 206d   intervals_1 = m
+00004790: 616e 7962 6f64 792e 6361 6c63 5f69 6e74  anybody.calc_int
+000047a0: 6572 7661 6c73 2874 776f 5f62 616e 645f  ervals(two_band_
+000047b0: 7370 6563 7472 756d 2c20 756e 6966 6f72  spectrum, unifor
+000047c0: 6d5f 6f63 6375 7061 7469 6f6e 290a 2020  m_occupation).  
+000047d0: 2020 696e 7465 7276 616c 735f 3220 3d20    intervals_2 = 
+000047e0: 6d61 6e79 626f 6479 2e63 616c 635f 696e  manybody.calc_in
+000047f0: 7465 7276 616c 7328 5b74 776f 5f62 616e  tervals([two_ban
+00004800: 645f 7370 6563 7472 756d 5d2c 2075 6e69  d_spectrum], uni
+00004810: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
+00004820: 0a20 2020 2069 6e74 6572 7661 6c73 5f33  .    intervals_3
+00004830: 203d 206d 616e 7962 6f64 792e 6361 6c63   = manybody.calc
+00004840: 5f69 6e74 6572 7661 6c73 2874 776f 5f62  _intervals(two_b
+00004850: 616e 645f 7370 6563 7472 756d 2c20 5b75  and_spectrum, [u
+00004860: 6e69 666f 726d 5f6f 6363 7570 6174 696f  niform_occupatio
+00004870: 6e5d 290a 2020 2020 696e 7465 7276 616c  n]).    interval
+00004880: 735f 3420 3d20 6d61 6e79 626f 6479 2e63  s_4 = manybody.c
+00004890: 616c 635f 696e 7465 7276 616c 7328 5b74  alc_intervals([t
+000048a0: 776f 5f62 616e 645f 7370 6563 7472 756d  wo_band_spectrum
+000048b0: 5d2c 205b 756e 6966 6f72 6d5f 6f63 6375  ], [uniform_occu
+000048c0: 7061 7469 6f6e 5d29 0a20 2020 2061 7373  pation]).    ass
+000048d0: 6572 7420 696e 7465 7276 616c 735f 3120  ert intervals_1 
+000048e0: 3d3d 2069 6e74 6572 7661 6c73 5f32 203d  == intervals_2 =
+000048f0: 3d20 696e 7465 7276 616c 735f 3320 3d3d  = intervals_3 ==
+00004900: 2069 6e74 6572 7661 6c73 5f34 0a20 2020   intervals_4.   
+00004910: 2069 6e74 6572 7661 6c73 5f31 203d 206d   intervals_1 = m
+00004920: 616e 7962 6f64 792e 6361 6c63 5f69 6e74  anybody.calc_int
+00004930: 6572 7661 6c73 285b 7477 6f5f 6261 6e64  ervals([two_band
+00004940: 5f73 7065 6374 7275 6d5d 202a 2032 2c20  _spectrum] * 2, 
+00004950: 5b75 6e69 666f 726d 5f6f 6363 7570 6174  [uniform_occupat
+00004960: 696f 6e5d 202a 2032 290a 2020 2020 696e  ion] * 2).    in
+00004970: 7465 7276 616c 735f 3220 3d20 6d61 6e79  tervals_2 = many
+00004980: 626f 6479 2e63 616c 635f 696e 7465 7276  body.calc_interv
+00004990: 616c 7328 2874 776f 5f62 616e 645f 7370  als((two_band_sp
+000049a0: 6563 7472 756d 2c20 7477 6f5f 6261 6e64  ectrum, two_band
+000049b0: 5f73 7065 6374 7275 6d29 2c20 756e 6966  _spectrum), unif
+000049c0: 6f72 6d5f 6f63 6375 7061 7469 6f6e 290a  orm_occupation).
+000049d0: 2020 2020 6173 7365 7274 2069 6e74 6572      assert inter
+000049e0: 7661 6c73 5f31 203d 3d20 696e 7465 7276  vals_1 == interv
+000049f0: 616c 735f 3220 2023 206f 6e6c 7920 7472  als_2  # only tr
+00004a00: 7565 2069 6e20 6571 7561 6c20 6f63 6375  ue in equal occu
+00004a10: 7061 7469 6f6e 0a0a 0a64 6566 2074 6573  pation...def tes
+00004a20: 745f 6d61 6b65 5f69 6e74 6572 7661 6c73  t_make_intervals
+00004a30: 5f62 616e 645f 696e 6465 785f 6f75 745f  _band_index_out_
+00004a40: 6f66 5f72 616e 6765 2874 776f 5f62 616e  of_range(two_ban
+00004a50: 645f 7370 6563 7472 756d 2c20 756e 6966  d_spectrum, unif
+00004a60: 6f72 6d5f 6f63 6375 7061 7469 6f6e 293a  orm_occupation):
+00004a70: 0a20 2020 2075 6e69 666f 726d 5f6f 6363  .    uniform_occ
+00004a80: 7570 6174 696f 6e2e 6261 6e64 7320 3d20  upation.bands = 
+00004a90: 5b74 776f 5f62 616e 645f 7370 6563 7472  [two_band_spectr
+00004aa0: 756d 2e6e 6261 6e64 735d 0a20 2020 2072  um.nbands].    r
+00004ab0: 6169 7365 7328 4173 7365 7274 696f 6e45  aises(AssertionE
+00004ac0: 7272 6f72 2c20 6d61 6e79 626f 6479 2e63  rror, manybody.c
+00004ad0: 616c 635f 696e 7465 7276 616c 732c 2074  alc_intervals, t
+00004ae0: 776f 5f62 616e 645f 7370 6563 7472 756d  wo_band_spectrum
+00004af0: 2c20 756e 6966 6f72 6d5f 6f63 6375 7061  , uniform_occupa
+00004b00: 7469 6f6e 290a 0a0a 6465 6620 7465 7374  tion)...def test
+00004b10: 5f6d 616b 655f 696e 7465 7276 616c 735f  _make_intervals_
+00004b20: 6261 6e64 5f69 6e64 6578 5f6e 6f74 5f69  band_index_not_i
+00004b30: 6e74 6567 6572 2874 776f 5f62 616e 645f  nteger(two_band_
+00004b40: 7370 6563 7472 756d 2c20 756e 6966 6f72  spectrum, unifor
+00004b50: 6d5f 6f63 6375 7061 7469 6f6e 293a 0a20  m_occupation):. 
+00004b60: 2020 2075 6e69 666f 726d 5f6f 6363 7570     uniform_occup
+00004b70: 6174 696f 6e2e 6261 6e64 7320 3d20 5b30  ation.bands = [0
+00004b80: 2e5d 0a20 2020 2072 6169 7365 7328 4173  .].    raises(As
+00004b90: 7365 7274 696f 6e45 7272 6f72 2c20 6d61  sertionError, ma
+00004ba0: 6e79 626f 6479 2e63 616c 635f 696e 7465  nybody.calc_inte
+00004bb0: 7276 616c 732c 2074 776f 5f62 616e 645f  rvals, two_band_
+00004bc0: 7370 6563 7472 756d 2c20 756e 6966 6f72  spectrum, unifor
+00004bd0: 6d5f 6f63 6375 7061 7469 6f6e 290a 0a0a  m_occupation)...
+00004be0: 6465 6620 7465 7374 5f6d 616b 655f 696e  def test_make_in
+00004bf0: 7465 7276 616c 735f 656e 6572 6769 6573  tervals_energies
+00004c00: 5f69 6e74 6572 6368 616e 6765 6428 7477  _interchanged(tw
+00004c10: 6f5f 6261 6e64 5f73 7065 6374 7275 6d2c  o_band_spectrum,
+00004c20: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
+00004c30: 696f 6e29 3a0a 2020 2020 756e 6966 6f72  ion):.    unifor
+00004c40: 6d5f 6f63 6375 7061 7469 6f6e 2e65 6e65  m_occupation.ene
+00004c50: 7267 795f 7261 6e67 6520 3d20 5b28 312c  rgy_range = [(1,
+00004c60: 2030 295d 0a20 2020 2072 6169 7365 7328   0)].    raises(
+00004c70: 4173 7365 7274 696f 6e45 7272 6f72 2c20  AssertionError, 
+00004c80: 6d61 6e79 626f 6479 2e63 616c 635f 696e  manybody.calc_in
+00004c90: 7465 7276 616c 732c 2074 776f 5f62 616e  tervals, two_ban
+00004ca0: 645f 7370 6563 7472 756d 2c20 756e 6966  d_spectrum, unif
+00004cb0: 6f72 6d5f 6f63 6375 7061 7469 6f6e 290a  orm_occupation).
+00004cc0: 0a0a 6465 6620 7465 7374 5f6d 616b 655f  ..def test_make_
+00004cd0: 696e 7465 7276 616c 735f 656d 696e 5f6e  intervals_emin_n
+00004ce0: 6f74 5f72 6561 6c28 7477 6f5f 6261 6e64  ot_real(two_band
+00004cf0: 5f73 7065 6374 7275 6d2c 2075 6e69 666f  _spectrum, unifo
+00004d00: 726d 5f6f 6363 7570 6174 696f 6e29 3a0a  rm_occupation):.
+00004d10: 2020 2020 756e 6966 6f72 6d5f 6f63 6375      uniform_occu
+00004d20: 7061 7469 6f6e 2e65 6e65 7267 795f 7261  pation.energy_ra
+00004d30: 6e67 6520 3d20 5b28 3120 2b20 316a 2c20  nge = [(1 + 1j, 
+00004d40: 4e6f 6e65 295d 0a20 2020 2023 2074 6f64  None)].    # tod
+00004d50: 6f0a 2020 2020 2320 7261 6973 6573 2854  o.    # raises(T
+00004d60: 7970 6545 7272 6f72 2c20 6d61 6e79 626f  ypeError, manybo
+00004d70: 6479 2e63 616c 635f 696e 7465 7276 616c  dy.calc_interval
+00004d80: 732c 2074 776f 5f62 616e 645f 7370 6563  s, two_band_spec
+00004d90: 7472 756d 2c20 756e 6966 6f72 6d5f 6f63  trum, uniform_oc
+00004da0: 6375 7061 7469 6f6e 290a 0a0a 6465 6620  cupation)...def 
+00004db0: 7465 7374 5f6d 616b 655f 696e 7465 7276  test_make_interv
+00004dc0: 616c 735f 656d 6178 5f6e 6f74 5f72 6561  als_emax_not_rea
+00004dd0: 6c28 7477 6f5f 6261 6e64 5f73 7065 6374  l(two_band_spect
+00004de0: 7275 6d2c 2075 6e69 666f 726d 5f6f 6363  rum, uniform_occ
+00004df0: 7570 6174 696f 6e29 3a0a 2020 2020 756e  upation):.    un
+00004e00: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
+00004e10: 2e65 6e65 7267 795f 7261 6e67 6520 3d20  .energy_range = 
+00004e20: 5b28 4e6f 6e65 2c20 3120 2b20 316a 295d  [(None, 1 + 1j)]
+00004e30: 0a20 2020 2023 2074 6f64 6f0a 2020 2020  .    # todo.    
+00004e40: 2320 7261 6973 6573 2854 7970 6545 7272  # raises(TypeErr
+00004e50: 6f72 2c20 6d61 6e79 626f 6479 2e63 616c  or, manybody.cal
+00004e60: 635f 696e 7465 7276 616c 732c 2074 776f  c_intervals, two
+00004e70: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
+00004e80: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
+00004e90: 6f6e 290a 0a0a 6465 6620 7465 7374 5f6d  on)...def test_m
+00004ea0: 616b 655f 696e 7465 7276 616c 735f 696e  ake_intervals_in
+00004eb0: 636f 6e73 6974 656e 745f 696e 7075 7428  consitent_input(
+00004ec0: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
+00004ed0: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
+00004ee0: 6174 696f 6e29 3a0a 2020 2020 2320 696e  ation):.    # in
+00004ef0: 686f 6d6f 6765 6e65 6f75 7320 6f63 6375  homogeneous occu
+00004f00: 7061 7469 6f6e 2c20 7468 6174 2064 6f65  pation, that doe
+00004f10: 7320 6e6f 7420 6669 7420 7468 6520 6e75  s not fit the nu
+00004f20: 6d62 6572 206f 6620 6c65 6164 730a 2020  mber of leads.  
+00004f30: 2020 7261 6973 6573 2856 616c 7565 4572    raises(ValueEr
+00004f40: 726f 722c 206d 616e 7962 6f64 792e 6361  ror, manybody.ca
+00004f50: 6c63 5f69 6e74 6572 7661 6c73 2c20 7477  lc_intervals, tw
+00004f60: 6f5f 6261 6e64 5f73 7065 6374 7275 6d2c  o_band_spectrum,
+00004f70: 205b 756e 6966 6f72 6d5f 6f63 6375 7061   [uniform_occupa
+00004f80: 7469 6f6e 5d20 2a20 3229 0a20 2020 2072  tion] * 2).    r
+00004f90: 6169 7365 7328 5661 6c75 6545 7272 6f72  aises(ValueError
+00004fa0: 2c20 6d61 6e79 626f 6479 2e63 616c 635f  , manybody.calc_
+00004fb0: 696e 7465 7276 616c 732c 205b 7477 6f5f  intervals, [two_
+00004fc0: 6261 6e64 5f73 7065 6374 7275 6d5d 2c20  band_spectrum], 
+00004fd0: 5b75 6e69 666f 726d 5f6f 6363 7570 6174  [uniform_occupat
+00004fe0: 696f 6e5d 202a 2032 290a 2020 2020 7261  ion] * 2).    ra
+00004ff0: 6973 6573 2856 616c 7565 4572 726f 722c  ises(ValueError,
+00005000: 206d 616e 7962 6f64 792e 6361 6c63 5f69   manybody.calc_i
+00005010: 6e74 6572 7661 6c73 2c20 5b74 776f 5f62  ntervals, [two_b
+00005020: 616e 645f 7370 6563 7472 756d 5d20 2a20  and_spectrum] * 
+00005030: 332c 205b 756e 6966 6f72 6d5f 6f63 6375  3, [uniform_occu
+00005040: 7061 7469 6f6e 5d20 2a20 3229 0a0a 0a64  pation] * 2)...d
+00005050: 6566 2074 6573 745f 6d61 6b65 5f69 6e74  ef test_make_int
+00005060: 6572 7661 6c73 5f6d 6973 7369 6e67 5f65  ervals_missing_e
+00005070: 6e65 7267 795f 7261 6e67 655f 6174 7472  nergy_range_attr
+00005080: 6962 7574 6528 7477 6f5f 6261 6e64 5f73  ibute(two_band_s
+00005090: 7065 6374 7275 6d2c 2075 6e69 666f 726d  pectrum, uniform
+000050a0: 5f6f 6363 7570 6174 696f 6e29 3a0a 2020  _occupation):.  
+000050b0: 2020 6465 6c20 756e 6966 6f72 6d5f 6f63    del uniform_oc
+000050c0: 6375 7061 7469 6f6e 2e65 6e65 7267 795f  cupation.energy_
+000050d0: 7261 6e67 650a 2020 2020 7261 6973 6573  range.    raises
+000050e0: 2841 7474 7269 6275 7465 4572 726f 722c  (AttributeError,
+000050f0: 206d 616e 7962 6f64 792e 6361 6c63 5f69   manybody.calc_i
+00005100: 6e74 6572 7661 6c73 2c20 7477 6f5f 6261  ntervals, two_ba
+00005110: 6e64 5f73 7065 6374 7275 6d2c 2075 6e69  nd_spectrum, uni
+00005120: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
+00005130: 0a0a 0a64 6566 2074 6573 745f 6d61 6b65  ...def test_make
+00005140: 5f69 6e74 6572 7661 6c73 5f6d 6973 7369  _intervals_missi
+00005150: 6e67 5f62 616e 6473 5f61 7474 7269 6275  ng_bands_attribu
+00005160: 7465 2874 776f 5f62 616e 645f 7370 6563  te(two_band_spec
+00005170: 7472 756d 2c20 756e 6966 6f72 6d5f 6f63  trum, uniform_oc
+00005180: 6375 7061 7469 6f6e 293a 0a20 2020 2064  cupation):.    d
+00005190: 656c 2075 6e69 666f 726d 5f6f 6363 7570  el uniform_occup
+000051a0: 6174 696f 6e2e 6261 6e64 730a 2020 2020  ation.bands.    
+000051b0: 7261 6973 6573 2841 7474 7269 6275 7465  raises(Attribute
+000051c0: 4572 726f 722c 206d 616e 7962 6f64 792e  Error, manybody.
+000051d0: 6361 6c63 5f69 6e74 6572 7661 6c73 2c20  calc_intervals, 
+000051e0: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
+000051f0: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
+00005200: 6174 696f 6e29 0a0a 0a64 6566 2074 6573  ation)...def tes
+00005210: 745f 6d61 6b65 5f69 6e74 6572 7661 6c73  t_make_intervals
+00005220: 5f6d 6973 7369 6e67 5f64 6973 7472 6962  _missing_distrib
+00005230: 7574 696f 6e5f 6174 7472 6962 7574 6528  ution_attribute(
+00005240: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
+00005250: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
+00005260: 6174 696f 6e29 3a0a 2020 2020 6465 6c20  ation):.    del 
+00005270: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
+00005280: 6f6e 2e64 6973 7472 6962 7574 696f 6e0a  on.distribution.
+00005290: 2020 2020 2320 746f 646f 0a23 2020 2020      # todo.#    
+000052a0: 7261 6973 6573 2841 7474 7269 6275 7465  raises(Attribute
+000052b0: 4572 726f 722c 206d 616e 7962 6f64 792e  Error, manybody.
+000052c0: 6361 6c63 5f69 6e74 6572 7661 6c73 2c20  calc_intervals, 
+000052d0: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
+000052e0: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
+000052f0: 6174 696f 6e29 0a0a 0a64 6566 2074 6573  ation)...def tes
+00005300: 745f 7370 6c69 745f 696e 7465 7276 616c  t_split_interval
+00005310: 5f69 6e74 6f5f 7477 6f28 5369 6d70 6c65  _into_two(Simple
+00005320: 496e 7465 7276 616c 293a 0a0a 2020 2020  Interval):..    
+00005330: 6e69 6e74 203d 2031 2020 2320 6e75 6d62  nint = 1  # numb
+00005340: 6572 206f 6620 7265 7475 726e 6564 2069  er of returned i
+00005350: 6e74 6572 7661 6c73 0a20 2020 2069 6e74  ntervals.    int
+00005360: 6572 7661 6c73 203d 206d 616e 7962 6f64  ervals = manybod
+00005370: 792e 5f73 706c 6974 5f69 6e74 6572 7661  y._split_interva
+00005380: 6c28 696e 7465 7276 616c 3d53 696d 706c  l(interval=Simpl
+00005390: 6549 6e74 6572 7661 6c28 6b6d 696e 3d30  eInterval(kmin=0
+000053a0: 2c20 6b6d 6178 3d31 292c 0a20 2020 2020  , kmax=1),.     
+000053b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000053c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000053d0: 2020 2020 6e75 6d62 6572 5f73 7562 696e      number_subin
+000053e0: 7465 7276 616c 733d 6e69 6e74 290a 2020  tervals=nint).  
+000053f0: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00005400: 6e63 6528 696e 7465 7276 616c 732c 206c  nce(intervals, l
+00005410: 6973 7429 0a20 2020 2061 7373 6572 7420  ist).    assert 
+00005420: 6c65 6e28 696e 7465 7276 616c 7329 203d  len(intervals) =
+00005430: 3d20 6e69 6e74 0a20 2020 2061 7373 6572  = nint.    asser
+00005440: 7420 696e 7465 7276 616c 7320 3d3d 205b  t intervals == [
+00005450: 5369 6d70 6c65 496e 7465 7276 616c 286b  SimpleInterval(k
+00005460: 6d69 6e3d 302c 206b 6d61 783d 3129 5d0a  min=0, kmax=1)].
+00005470: 0a0a 6465 6620 7465 7374 5f73 706c 6974  ..def test_split
+00005480: 5f69 6e74 6572 7661 6c5f 696e 746f 5f74  _interval_into_t
+00005490: 6872 6565 2853 696d 706c 6549 6e74 6572  hree(SimpleInter
+000054a0: 7661 6c29 3a0a 0a20 2020 206e 696e 7420  val):..    nint 
+000054b0: 3d20 3220 2023 206e 756d 6265 7220 6f66  = 2  # number of
+000054c0: 2072 6574 7572 6e65 6420 696e 7465 7276   returned interv
+000054d0: 616c 730a 2020 2020 696e 7465 7276 616c  als.    interval
+000054e0: 7320 3d20 6d61 6e79 626f 6479 2e5f 7370  s = manybody._sp
+000054f0: 6c69 745f 696e 7465 7276 616c 2869 6e74  lit_interval(int
+00005500: 6572 7661 6c3d 5369 6d70 6c65 496e 7465  erval=SimpleInte
+00005510: 7276 616c 286b 6d69 6e3d 302c 206b 6d61  rval(kmin=0, kma
+00005520: 783d 3129 2c0a 2020 2020 2020 2020 2020  x=1),.          
+00005530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005540: 2020 2020 2020 2020 2020 2020 2020 206e                 n
+00005550: 756d 6265 725f 7375 6269 6e74 6572 7661  umber_subinterva
+00005560: 6c73 3d6e 696e 7429 0a20 2020 2061 7373  ls=nint).    ass
+00005570: 6572 7420 6973 696e 7374 616e 6365 2869  ert isinstance(i
+00005580: 6e74 6572 7661 6c73 2c20 6c69 7374 290a  ntervals, list).
+00005590: 2020 2020 6173 7365 7274 206c 656e 2869      assert len(i
+000055a0: 6e74 6572 7661 6c73 2920 3d3d 206e 696e  ntervals) == nin
+000055b0: 740a 2020 2020 6173 7365 7274 2069 6e74  t.    assert int
+000055c0: 6572 7661 6c73 203d 3d20 5b53 696d 706c  ervals == [Simpl
+000055d0: 6549 6e74 6572 7661 6c28 6b6d 696e 3d30  eInterval(kmin=0
+000055e0: 2c20 6b6d 6178 3d30 2e35 292c 0a20 2020  , kmax=0.5),.   
+000055f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005600: 2020 2020 2020 5369 6d70 6c65 496e 7465        SimpleInte
+00005610: 7276 616c 286b 6d69 6e3d 302e 352c 206b  rval(kmin=0.5, k
+00005620: 6d61 783d 3129 5d0a 0a0a 6465 6620 7465  max=1)]...def te
+00005630: 7374 5f73 706c 6974 5f69 6e74 6572 7661  st_split_interva
+00005640: 6c5f 7772 6f6e 675f 696e 7075 7428 5369  l_wrong_input(Si
+00005650: 6d70 6c65 496e 7465 7276 616c 293a 0a20  mpleInterval):. 
+00005660: 2020 2072 6169 7365 7328 5661 6c75 6545     raises(ValueE
+00005670: 7272 6f72 2c20 6d61 6e79 626f 6479 2e5f  rror, manybody._
+00005680: 7370 6c69 745f 696e 7465 7276 616c 2c20  split_interval, 
+00005690: 5369 6d70 6c65 496e 7465 7276 616c 286b  SimpleInterval(k
+000056a0: 6d69 6e3d 302c 206b 6d61 783d 3129 2c20  min=0, kmax=1), 
+000056b0: 6e75 6d62 6572 5f73 7562 696e 7465 7276  number_subinterv
+000056c0: 616c 733d 3029 0a20 2020 2072 6169 7365  als=0).    raise
+000056d0: 7328 4173 7365 7274 696f 6e45 7272 6f72  s(AssertionError
+000056e0: 2c20 6d61 6e79 626f 6479 2e5f 7370 6c69  , manybody._spli
+000056f0: 745f 696e 7465 7276 616c 2c20 5369 6d70  t_interval, Simp
+00005700: 6c65 496e 7465 7276 616c 286b 6d69 6e3d  leInterval(kmin=
+00005710: 302c 206b 6d61 783d 3129 2c20 6e75 6d62  0, kmax=1), numb
+00005720: 6572 5f73 7562 696e 7465 7276 616c 733d  er_subintervals=
+00005730: 312e 290a 0a0a 6465 6620 7465 7374 5f73  1.)...def test_s
+00005740: 706c 6974 5f69 6e74 6572 7661 6c5f 6b6d  plit_interval_km
+00005750: 696e 5f61 7474 7269 6275 7465 5f6d 6973  in_attribute_mis
+00005760: 7369 6e67 2853 696d 706c 6549 6e74 6572  sing(SimpleInter
+00005770: 7661 6c29 3a0a 2020 2020 696e 7465 7276  val):.    interv
+00005780: 616c 203d 2053 696d 706c 6549 6e74 6572  al = SimpleInter
+00005790: 7661 6c28 302c 2031 290a 2020 2020 6465  val(0, 1).    de
+000057a0: 6c20 696e 7465 7276 616c 2e6b 6d69 6e0a  l interval.kmin.
+000057b0: 2020 2020 7261 6973 6573 2841 7474 7269      raises(Attri
+000057c0: 6275 7465 4572 726f 722c 206d 616e 7962  buteError, manyb
+000057d0: 6f64 792e 5f73 706c 6974 5f69 6e74 6572  ody._split_inter
+000057e0: 7661 6c2c 2069 6e74 6572 7661 6c2c 2032  val, interval, 2
+000057f0: 290a 0a0a 6465 6620 7465 7374 5f73 706c  )...def test_spl
+00005800: 6974 5f69 6e74 6572 7661 6c5f 6b6d 6178  it_interval_kmax
+00005810: 5f61 7474 7269 6275 7465 5f6d 6973 7369  _attribute_missi
+00005820: 6e67 2853 696d 706c 6549 6e74 6572 7661  ng(SimpleInterva
+00005830: 6c29 3a0a 2020 2020 696e 7465 7276 616c  l):.    interval
+00005840: 203d 2053 696d 706c 6549 6e74 6572 7661   = SimpleInterva
+00005850: 6c28 302c 2031 290a 2020 2020 6465 6c20  l(0, 1).    del 
+00005860: 696e 7465 7276 616c 2e6b 6d61 780a 2020  interval.kmax.  
+00005870: 2020 7261 6973 6573 2841 7474 7269 6275    raises(Attribu
+00005880: 7465 4572 726f 722c 206d 616e 7962 6f64  teError, manybod
+00005890: 792e 5f73 706c 6974 5f69 6e74 6572 7661  y._split_interva
+000058a0: 6c2c 2069 6e74 6572 7661 6c2c 2032 290a  l, interval, 2).
+000058b0: 0a0a 6465 6620 7465 7374 5f73 706c 6974  ..def test_split
+000058c0: 5f69 6e74 6572 7661 6c73 5f6e 6f5f 7370  _intervals_no_sp
+000058d0: 6c69 7428 5369 6d70 6c65 496e 7465 7276  lit(SimpleInterv
+000058e0: 616c 293a 0a20 2020 206e 696e 7420 3d20  al):.    nint = 
+000058f0: 3120 2023 206e 756d 6265 7220 6f66 2072  1  # number of r
+00005900: 6574 7572 6e65 6420 696e 7465 7276 616c  eturned interval
+00005910: 7320 7065 7220 696e 7075 7420 696e 7465  s per input inte
+00005920: 7276 616c 0a20 2020 2069 6e70 7574 5f69  rval.    input_i
+00005930: 6e74 6572 7661 6c73 203d 205b 5369 6d70  ntervals = [Simp
+00005940: 6c65 496e 7465 7276 616c 286b 6d69 6e3d  leInterval(kmin=
+00005950: 302c 206b 6d61 783d 3129 2c20 5369 6d70  0, kmax=1), Simp
+00005960: 6c65 496e 7465 7276 616c 286b 6d69 6e3d  leInterval(kmin=
+00005970: 2d34 2e30 2c20 6b6d 6178 3d32 295d 0a20  -4.0, kmax=2)]. 
+00005980: 2020 2069 6e74 6572 7661 6c73 203d 206d     intervals = m
+00005990: 616e 7962 6f64 792e 7370 6c69 745f 696e  anybody.split_in
+000059a0: 7465 7276 616c 7328 696e 7075 745f 696e  tervals(input_in
+000059b0: 7465 7276 616c 732c 206e 756d 6265 725f  tervals, number_
+000059c0: 7375 6269 6e74 6572 7661 6c73 3d6e 696e  subintervals=nin
+000059d0: 7429 0a20 2020 2061 7373 6572 7420 6973  t).    assert is
+000059e0: 696e 7374 616e 6365 2869 6e74 6572 7661  instance(interva
+000059f0: 6c73 2c20 6c69 7374 290a 2020 2020 6173  ls, list).    as
+00005a00: 7365 7274 206c 656e 2869 6e74 6572 7661  sert len(interva
+00005a10: 6c73 2920 3d3d 206e 696e 7420 2a20 6c65  ls) == nint * le
+00005a20: 6e28 696e 7075 745f 696e 7465 7276 616c  n(input_interval
+00005a30: 7329 0a20 2020 2061 7373 6572 7420 696e  s).    assert in
+00005a40: 7465 7276 616c 7320 3d3d 205b 5369 6d70  tervals == [Simp
+00005a50: 6c65 496e 7465 7276 616c 286b 6d69 6e3d  leInterval(kmin=
+00005a60: 302c 206b 6d61 783d 3129 2c20 5369 6d70  0, kmax=1), Simp
+00005a70: 6c65 496e 7465 7276 616c 286b 6d69 6e3d  leInterval(kmin=
+00005a80: 2d34 2e30 2c20 6b6d 6178 3d32 295d 0a0a  -4.0, kmax=2)]..
+00005a90: 0a64 6566 2074 6573 745f 7370 6c69 745f  .def test_split_
+00005aa0: 696e 7465 7276 616c 735f 696e 746f 5f74  intervals_into_t
+00005ab0: 776f 2853 696d 706c 6549 6e74 6572 7661  wo(SimpleInterva
+00005ac0: 6c29 3a0a 2020 2020 6e69 6e74 203d 2032  l):.    nint = 2
+00005ad0: 2020 2320 6e75 6d62 6572 206f 6620 7265    # number of re
+00005ae0: 7475 726e 6564 2069 6e74 6572 7661 6c73  turned intervals
+00005af0: 2070 6572 2069 6e70 7574 2069 6e74 6572   per input inter
+00005b00: 7661 6c0a 2020 2020 696e 7075 745f 696e  val.    input_in
+00005b10: 7465 7276 616c 7320 3d20 5b53 696d 706c  tervals = [Simpl
+00005b20: 6549 6e74 6572 7661 6c28 6b6d 696e 3d30  eInterval(kmin=0
+00005b30: 2c20 6b6d 6178 3d31 292c 2053 696d 706c  , kmax=1), Simpl
+00005b40: 6549 6e74 6572 7661 6c28 6b6d 696e 3d2d  eInterval(kmin=-
+00005b50: 342e 302c 206b 6d61 783d 3229 5d0a 2020  4.0, kmax=2)].  
+00005b60: 2020 696e 7465 7276 616c 7320 3d20 6d61    intervals = ma
+00005b70: 6e79 626f 6479 2e73 706c 6974 5f69 6e74  nybody.split_int
+00005b80: 6572 7661 6c73 2869 6e70 7574 5f69 6e74  ervals(input_int
+00005b90: 6572 7661 6c73 2c20 6e75 6d62 6572 5f73  ervals, number_s
+00005ba0: 7562 696e 7465 7276 616c 733d 6e69 6e74  ubintervals=nint
+00005bb0: 290a 2020 2020 6173 7365 7274 2069 7369  ).    assert isi
+00005bc0: 6e73 7461 6e63 6528 696e 7465 7276 616c  nstance(interval
+00005bd0: 732c 206c 6973 7429 0a20 2020 2061 7373  s, list).    ass
+00005be0: 6572 7420 6c65 6e28 696e 7465 7276 616c  ert len(interval
+00005bf0: 7329 203d 3d20 6e69 6e74 202a 206c 656e  s) == nint * len
+00005c00: 2869 6e70 7574 5f69 6e74 6572 7661 6c73  (input_intervals
+00005c10: 290a 2020 2020 6173 7365 7274 2069 6e74  ).    assert int
+00005c20: 6572 7661 6c73 203d 3d20 5b53 696d 706c  ervals == [Simpl
+00005c30: 6549 6e74 6572 7661 6c28 6b6d 696e 3d30  eInterval(kmin=0
+00005c40: 2c20 6b6d 6178 3d30 2e35 292c 2053 696d  , kmax=0.5), Sim
+00005c50: 706c 6549 6e74 6572 7661 6c28 6b6d 696e  pleInterval(kmin
+00005c60: 3d30 2e35 2c20 6b6d 6178 3d31 292c 0a20  =0.5, kmax=1),. 
+00005c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00005c80: 2020 2020 2020 2020 5369 6d70 6c65 496e          SimpleIn
+00005c90: 7465 7276 616c 286b 6d69 6e3d 2d34 2e30  terval(kmin=-4.0
+00005ca0: 2c20 6b6d 6178 3d2d 312e 3029 2c20 5369  , kmax=-1.0), Si
+00005cb0: 6d70 6c65 496e 7465 7276 616c 286b 6d69  mpleInterval(kmi
+00005cc0: 6e3d 2d31 2e30 2c20 6b6d 6178 3d32 295d  n=-1.0, kmax=2)]
+00005cd0: 0a0a 0a64 6566 2074 6573 745f 7370 6c69  ...def test_spli
+00005ce0: 745f 696e 7465 7276 616c 735f 7772 6f6e  t_intervals_wron
+00005cf0: 675f 696e 7075 7428 5369 6d70 6c65 496e  g_input(SimpleIn
+00005d00: 7465 7276 616c 293a 0a20 2020 2069 6e70  terval):.    inp
+00005d10: 7574 5f69 6e74 6572 7661 6c73 203d 205b  ut_intervals = [
+00005d20: 5369 6d70 6c65 496e 7465 7276 616c 286b  SimpleInterval(k
+00005d30: 6d69 6e3d 302c 206b 6d61 783d 3129 5d0a  min=0, kmax=1)].
+00005d40: 2020 2020 7261 6973 6573 2856 616c 7565      raises(Value
+00005d50: 4572 726f 722c 206d 616e 7962 6f64 792e  Error, manybody.
+00005d60: 7370 6c69 745f 696e 7465 7276 616c 732c  split_intervals,
+00005d70: 2069 6e70 7574 5f69 6e74 6572 7661 6c73   input_intervals
+00005d80: 2c20 6e75 6d62 6572 5f73 7562 696e 7465  , number_subinte
+00005d90: 7276 616c 733d 3029 0a20 2020 2072 6169  rvals=0).    rai
+00005da0: 7365 7328 4173 7365 7274 696f 6e45 7272  ses(AssertionErr
+00005db0: 6f72 2c20 6d61 6e79 626f 6479 2e73 706c  or, manybody.spl
+00005dc0: 6974 5f69 6e74 6572 7661 6c73 2c20 696e  it_intervals, in
+00005dd0: 7075 745f 696e 7465 7276 616c 732c 206e  put_intervals, n
+00005de0: 756d 6265 725f 7375 6269 6e74 6572 7661  umber_subinterva
+00005df0: 6c73 3d31 2e29 0a20 2020 2023 2069 6e74  ls=1.).    # int
+00005e00: 6572 7661 6c20 6e6f 7420 6120 6c69 7374  erval not a list
+00005e10: 0a20 2020 2069 6e70 7574 5f69 6e74 6572  .    input_inter
+00005e20: 7661 6c73 203d 2053 696d 706c 6549 6e74  vals = SimpleInt
+00005e30: 6572 7661 6c28 6b6d 696e 3d30 2c20 6b6d  erval(kmin=0, km
+00005e40: 6178 3d31 290a 2020 2020 7261 6973 6573  ax=1).    raises
+00005e50: 2854 7970 6545 7272 6f72 2c20 6d61 6e79  (TypeError, many
+00005e60: 626f 6479 2e73 706c 6974 5f69 6e74 6572  body.split_inter
+00005e70: 7661 6c73 2c20 696e 7075 745f 696e 7465  vals, input_inte
+00005e80: 7276 616c 732c 206e 756d 6265 725f 7375  rvals, number_su
+00005e90: 6269 6e74 6572 7661 6c73 3d32 290a 0a0a  bintervals=2)...
+00005ea0: 6465 6620 7465 7374 5f61 7474 7269 6275  def test_attribu
+00005eb0: 7465 735f 7369 6d69 6c61 7228 293a 0a0a  tes_similar():..
+00005ec0: 2020 2020 2320 7573 6520 7468 6520 6d61      # use the ma
+00005ed0: 6e79 626f 6479 2069 6e74 6572 7661 6c20  nybody interval 
+00005ee0: 636c 6173 7320 746f 2074 6573 7420 666f  class to test fo
+00005ef0: 7220 7369 6d69 6c61 7269 7479 0a20 2020  r similarity.   
+00005f00: 2069 6e74 3020 3d20 6d61 6e79 626f 6479   int0 = manybody
+00005f10: 2e49 6e74 6572 7661 6c28 6c65 6164 3d30  .Interval(lead=0
+00005f20: 2c20 6261 6e64 3d31 2c20 6b6d 696e 3d30  , band=1, kmin=0
+00005f30: 2c20 6b6d 6178 3d31 2e29 0a20 2020 2069  , kmax=1.).    i
+00005f40: 6e74 3120 3d20 6d61 6e79 626f 6479 2e49  nt1 = manybody.I
+00005f50: 6e74 6572 7661 6c28 6c65 6164 3d31 2c20  nterval(lead=1, 
+00005f60: 6261 6e64 3d31 2c20 6b6d 696e 3d31 452d  band=1, kmin=1E-
+00005f70: 3132 2c20 6b6d 6178 3d31 2e29 0a0a 2020  12, kmax=1.)..  
+00005f80: 2020 2320 6368 6563 6b20 7479 7065 0a20    # check type. 
+00005f90: 2020 2072 6573 203d 206d 616e 7962 6f64     res = manybod
+00005fa0: 792e 5f61 7474 7269 6275 7465 735f 7369  y._attributes_si
+00005fb0: 6d69 6c61 7228 696e 7430 2c20 696e 7431  milar(int0, int1
+00005fc0: 2c20 5b27 6261 6e64 272c 2027 6b6d 696e  , ['band', 'kmin
+00005fd0: 272c 2027 6b6d 6178 275d 290a 2020 2020  ', 'kmax']).    
+00005fe0: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00005ff0: 6528 7265 732c 2062 6f6f 6c29 0a0a 2020  e(res, bool)..  
+00006000: 2020 2320 636f 6d70 6172 6520 666c 6f61    # compare floa
+00006010: 7420 6174 7472 6962 7574 6573 0a20 2020  t attributes.   
+00006020: 2061 7373 6572 7420 6d61 6e79 626f 6479   assert manybody
+00006030: 2e5f 6174 7472 6962 7574 6573 5f73 696d  ._attributes_sim
+00006040: 696c 6172 2869 6e74 302c 2069 6e74 312c  ilar(int0, int1,
+00006050: 205b 2762 616e 6427 2c20 276b 6d69 6e27   ['band', 'kmin'
+00006060: 2c20 276b 6d61 7827 5d29 0a20 2020 2061  , 'kmax']).    a
+00006070: 7373 6572 7420 6e6f 7420 6d61 6e79 626f  ssert not manybo
+00006080: 6479 2e5f 6174 7472 6962 7574 6573 5f73  dy._attributes_s
+00006090: 696d 696c 6172 2869 6e74 302c 2069 6e74  imilar(int0, int
+000060a0: 312c 205b 2762 616e 6427 2c20 276b 6d69  1, ['band', 'kmi
+000060b0: 6e27 2c20 276b 6d61 7827 5d2c 0a20 2020  n', 'kmax'],.   
+000060c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000060e0: 2020 2020 2020 2020 2072 746f 6c3d 302c           rtol=0,
+000060f0: 2061 746f 6c3d 3145 2d31 3529 0a0a 2020   atol=1E-15)..  
+00006100: 2020 2320 636f 6d70 6172 6520 696e 7465    # compare inte
+00006110: 6765 7220 6174 7472 6962 7574 6573 0a20  ger attributes. 
+00006120: 2020 2061 7373 6572 7420 6e6f 7420 6d61     assert not ma
+00006130: 6e79 626f 6479 2e5f 6174 7472 6962 7574  nybody._attribut
+00006140: 6573 5f73 696d 696c 6172 2869 6e74 302c  es_similar(int0,
+00006150: 2069 6e74 312c 205b 276c 6561 6427 2c20   int1, ['lead', 
+00006160: 2762 616e 6427 2c20 276b 6d69 6e27 2c20  'band', 'kmin', 
+00006170: 276b 6d61 7827 5d29 0a0a 2020 2020 2320  'kmax'])..    # 
+00006180: 636f 6d70 6172 6520 6e6f 6e65 7869 7374  compare nonexist
+00006190: 696e 6720 6174 7472 6962 7574 6573 0a20  ing attributes. 
+000061a0: 2020 2061 7373 6572 7420 6d61 6e79 626f     assert manybo
+000061b0: 6479 2e5f 6174 7472 6962 7574 6573 5f73  dy._attributes_s
+000061c0: 696d 696c 6172 2869 6e74 302c 2069 6e74  imilar(int0, int
+000061d0: 312c 205b 2762 6c61 275d 290a 0a20 2020  1, ['bla'])..   
+000061e0: 2023 2063 6f6d 7061 7265 2065 7869 7374   # compare exist
+000061f0: 696e 6720 616e 6420 6e6f 6e65 7869 7374  ing and nonexist
+00006200: 696e 6720 6174 7472 6962 7574 6573 0a20  ing attributes. 
+00006210: 2020 2069 6e74 3220 3d20 6d61 6e79 626f     int2 = manybo
+00006220: 6479 2e49 6e74 6572 7661 6c28 6c65 6164  dy.Interval(lead
+00006230: 3d31 2c20 6261 6e64 3d31 2c20 6b6d 696e  =1, band=1, kmin
+00006240: 3d31 452d 3132 2c20 6b6d 6178 3d31 2e29  =1E-12, kmax=1.)
+00006250: 0a20 2020 2069 6e74 322e 626c 6120 3d20  .    int2.bla = 
+00006260: 3432 0a20 2020 2061 7373 6572 7420 6e6f  42.    assert no
+00006270: 7420 6d61 6e79 626f 6479 2e5f 6174 7472  t manybody._attr
+00006280: 6962 7574 6573 5f73 696d 696c 6172 2869  ibutes_similar(i
+00006290: 6e74 302c 2069 6e74 322c 205b 2762 6c61  nt0, int2, ['bla
+000062a0: 275d 290a 0a20 2020 2023 2063 6f6d 7061  '])..    # compa
+000062b0: 7265 2066 6c6f 6174 2061 6e64 206e 756d  re float and num
+000062c0: 7079 2061 7474 7269 6275 7465 730a 2020  py attributes.  
+000062d0: 2020 696e 7433 203d 206d 616e 7962 6f64    int3 = manybod
+000062e0: 792e 496e 7465 7276 616c 286c 6561 643d  y.Interval(lead=
+000062f0: 302c 2062 616e 643d 312c 206b 6d69 6e3d  0, band=1, kmin=
+00006300: 6e70 2e61 7272 6179 285b 302e 5d29 2c20  np.array([0.]), 
+00006310: 6b6d 6178 3d31 2e29 0a20 2020 2061 7373  kmax=1.).    ass
+00006320: 6572 7420 6d61 6e79 626f 6479 2e5f 6174  ert manybody._at
+00006330: 7472 6962 7574 6573 5f73 696d 696c 6172  tributes_similar
+00006340: 2869 6e74 312c 2069 6e74 332c 205b 2762  (int1, int3, ['b
+00006350: 616e 6427 2c20 276b 6d69 6e27 2c20 276b  and', 'kmin', 'k
+00006360: 6d61 7827 5d29 0a20 2020 2061 7373 6572  max']).    asser
+00006370: 7420 6e6f 7420 6d61 6e79 626f 6479 2e5f  t not manybody._
+00006380: 6174 7472 6962 7574 6573 5f73 696d 696c  attributes_simil
+00006390: 6172 2869 6e74 312c 2069 6e74 332c 205b  ar(int1, int3, [
+000063a0: 2762 616e 6427 2c20 276b 6d69 6e27 2c20  'band', 'kmin', 
+000063b0: 276b 6d61 7827 5d2c 0a20 2020 2020 2020  'kmax'],.       
+000063c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000063e0: 2020 2020 2072 746f 6c3d 302c 2061 746f       rtol=0, ato
+000063f0: 6c3d 3145 2d31 3529 0a0a 2020 2020 2320  l=1E-15)..    # 
+00006400: 636f 6d70 6172 6520 6e75 6d70 7920 6174  compare numpy at
+00006410: 7472 6962 7574 6573 0a20 2020 2069 6e74  tributes.    int
+00006420: 3420 3d20 6d61 6e79 626f 6479 2e49 6e74  4 = manybody.Int
+00006430: 6572 7661 6c28 6c65 6164 3d30 2c20 6261  erval(lead=0, ba
+00006440: 6e64 3d31 2c20 6b6d 696e 3d6e 702e 6172  nd=1, kmin=np.ar
+00006450: 7261 7928 5b31 452d 3132 5d29 2c20 6b6d  ray([1E-12]), km
+00006460: 6178 3d31 2e29 0a20 2020 2061 7373 6572  ax=1.).    asser
+00006470: 7420 6d61 6e79 626f 6479 2e5f 6174 7472  t manybody._attr
+00006480: 6962 7574 6573 5f73 696d 696c 6172 2869  ibutes_similar(i
+00006490: 6e74 332c 2069 6e74 342c 205b 2762 616e  nt3, int4, ['ban
+000064a0: 6427 2c20 276b 6d69 6e27 2c20 276b 6d61  d', 'kmin', 'kma
+000064b0: 7827 5d29 0a20 2020 2061 7373 6572 7420  x']).    assert 
+000064c0: 6e6f 7420 6d61 6e79 626f 6479 2e5f 6174  not manybody._at
+000064d0: 7472 6962 7574 6573 5f73 696d 696c 6172  tributes_similar
+000064e0: 2869 6e74 332c 2069 6e74 342c 205b 2762  (int3, int4, ['b
+000064f0: 616e 6427 2c20 276b 6d69 6e27 2c20 276b  and', 'kmin', 'k
+00006500: 6d61 7827 5d2c 0a20 2020 2020 2020 2020  max'],.         
+00006510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006520: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00006530: 2020 2072 746f 6c3d 302c 2061 746f 6c3d     rtol=0, atol=
+00006540: 3145 2d31 3529 0a0a 2020 2020 2320 636f  1E-15)..    # co
+00006550: 6d70 6172 6520 6e75 6d70 7920 6174 7472  mpare numpy attr
+00006560: 6962 7574 6573 2077 6974 6820 6469 6666  ibutes with diff
+00006570: 6572 656e 7420 7369 7a65 730a 2020 2020  erent sizes.    
+00006580: 696e 7435 203d 206d 616e 7962 6f64 792e  int5 = manybody.
+00006590: 496e 7465 7276 616c 286c 6561 643d 302c  Interval(lead=0,
+000065a0: 2062 616e 643d 312c 206b 6d69 6e3d 6e70   band=1, kmin=np
+000065b0: 2e61 7272 6179 285b 302c 2031 452d 3132  .array([0, 1E-12
+000065c0: 5d29 2c20 6b6d 6178 3d31 2e29 0a20 2020  ]), kmax=1.).   
+000065d0: 2061 7373 6572 7420 6d61 6e79 626f 6479   assert manybody
+000065e0: 2e5f 6174 7472 6962 7574 6573 5f73 696d  ._attributes_sim
+000065f0: 696c 6172 2869 6e74 342c 2069 6e74 352c  ilar(int4, int5,
+00006600: 205b 2762 616e 6427 2c20 276b 6d69 6e27   ['band', 'kmin'
+00006610: 2c20 276b 6d61 7827 5d29 0a0a 0a64 6566  , 'kmax'])...def
+00006620: 2074 6573 745f 636f 6d62 696e 655f 696e   test_combine_in
+00006630: 7465 7276 616c 7328 293a 0a0a 2020 2020  tervals():..    
+00006640: 696e 7430 203d 206d 616e 7962 6f64 792e  int0 = manybody.
+00006650: 496e 7465 7276 616c 286c 6561 643d 332c  Interval(lead=3,
+00006660: 2062 616e 643d 312c 206b 6d69 6e3d 302c   band=1, kmin=0,
+00006670: 206b 6d61 783d 312e 290a 2020 2020 696e   kmax=1.).    in
+00006680: 7431 203d 206d 616e 7962 6f64 792e 496e  t1 = manybody.In
+00006690: 7465 7276 616c 286c 6561 643d 352c 2062  terval(lead=5, b
+000066a0: 616e 643d 312c 206b 6d69 6e3d 3145 2d31  and=1, kmin=1E-1
+000066b0: 322c 206b 6d61 783d 312e 290a 2020 2020  2, kmax=1.).    
+000066c0: 696e 7432 203d 206d 616e 7962 6f64 792e  int2 = manybody.
+000066d0: 496e 7465 7276 616c 286c 6561 643d 362c  Interval(lead=6,
+000066e0: 2062 616e 643d 312c 206b 6d69 6e3d 3145   band=1, kmin=1E
+000066f0: 2d31 322c 206b 6d61 783d 312e 290a 2020  -12, kmax=1.).  
+00006700: 2020 696e 7433 203d 206d 616e 7962 6f64    int3 = manybod
+00006710: 792e 496e 7465 7276 616c 286c 6561 643d  y.Interval(lead=
+00006720: 372c 2062 616e 643d 312c 206b 6d69 6e3d  7, band=1, kmin=
+00006730: 302e 312c 206b 6d61 783d 312e 290a 2020  0.1, kmax=1.).  
+00006740: 2020 696e 7434 203d 206d 616e 7962 6f64    int4 = manybod
+00006750: 792e 496e 7465 7276 616c 286c 6561 643d  y.Interval(lead=
+00006760: 2831 2c20 3229 2c20 6261 6e64 3d31 2c20  (1, 2), band=1, 
+00006770: 6b6d 696e 3d30 2c20 6b6d 6178 3d31 2e29  kmin=0, kmax=1.)
+00006780: 0a0a 2020 2020 2320 636f 6d62 696e 6520  ..    # combine 
+00006790: 7477 6f20 696e 7465 7276 616c 730a 2020  two intervals.  
+000067a0: 2020 636f 6d62 696e 6564 203d 206d 616e    combined = man
+000067b0: 7962 6f64 792e 636f 6d62 696e 655f 696e  ybody.combine_in
+000067c0: 7465 7276 616c 7328 5b69 6e74 302c 2069  tervals([int0, i
+000067d0: 6e74 315d 290a 2020 2020 6173 7365 7274  nt1]).    assert
+000067e0: 2069 7369 6e73 7461 6e63 6528 636f 6d62   isinstance(comb
+000067f0: 696e 6564 2c20 6c69 7374 290a 2020 2020  ined, list).    
+00006800: 6173 7365 7274 206c 656e 2863 6f6d 6269  assert len(combi
+00006810: 6e65 6429 203d 3d20 310a 2020 2020 6173  ned) == 1.    as
+00006820: 7365 7274 2063 6f6d 6269 6e65 645b 305d  sert combined[0]
+00006830: 2e6c 6561 6420 3d3d 2028 332c 2035 290a  .lead == (3, 5).
+00006840: 2020 2020 6173 7365 7274 2063 6f6d 6269      assert combi
+00006850: 6e65 645b 305d 2e62 616e 6420 3d3d 2069  ned[0].band == i
+00006860: 6e74 302e 6261 6e64 0a20 2020 2061 7373  nt0.band.    ass
+00006870: 6572 7420 636f 6d62 696e 6564 5b30 5d2e  ert combined[0].
+00006880: 6b6d 696e 203d 3d20 696e 7430 2e6b 6d69  kmin == int0.kmi
+00006890: 6e0a 2020 2020 6173 7365 7274 2063 6f6d  n.    assert com
+000068a0: 6269 6e65 645b 305d 2e6b 6d61 7820 3d3d  bined[0].kmax ==
+000068b0: 2069 6e74 302e 6b6d 6178 0a20 2020 2061   int0.kmax.    a
+000068c0: 7373 6572 7420 696e 7430 2e6c 6561 6420  ssert int0.lead 
+000068d0: 3d3d 2033 0a20 2020 2061 7373 6572 7420  == 3.    assert 
+000068e0: 696e 7431 2e6c 6561 6420 3d3d 2035 0a0a  int1.lead == 5..
+000068f0: 2020 2020 2320 646f 206e 6f74 2063 6f6d      # do not com
+00006900: 6269 6e65 2069 6e74 6572 7661 6c73 0a20  bine intervals. 
+00006910: 2020 2063 6f6d 6269 6e65 6420 3d20 6d61     combined = ma
+00006920: 6e79 626f 6479 2e63 6f6d 6269 6e65 5f69  nybody.combine_i
+00006930: 6e74 6572 7661 6c73 285b 696e 7430 2c20  ntervals([int0, 
+00006940: 696e 7433 5d29 0a20 2020 2061 7373 6572  int3]).    asser
+00006950: 7420 6973 696e 7374 616e 6365 2863 6f6d  t isinstance(com
+00006960: 6269 6e65 642c 206c 6973 7429 0a20 2020  bined, list).   
+00006970: 2061 7373 6572 7420 6c65 6e28 636f 6d62   assert len(comb
+00006980: 696e 6564 2920 3d3d 2032 0a20 2020 2061  ined) == 2.    a
+00006990: 7373 6572 7420 636f 6d62 696e 6564 5b30  ssert combined[0
+000069a0: 5d2e 6c65 6164 203d 3d20 330a 2020 2020  ].lead == 3.    
+000069b0: 6173 7365 7274 2063 6f6d 6269 6e65 645b  assert combined[
+000069c0: 315d 2e6c 6561 6420 3d3d 2037 0a0a 2020  1].lead == 7..  
+000069d0: 2020 2320 636f 6d62 696e 6520 616e 2069    # combine an i
+000069e0: 6e74 6572 7661 6c20 7769 7468 206c 6561  nterval with lea
+000069f0: 6420 696e 7465 6765 7220 616e 6420 6c65  d integer and le
+00006a00: 6164 2074 7570 6c65 0a20 2020 2063 6f6d  ad tuple.    com
+00006a10: 6269 6e65 6420 3d20 6d61 6e79 626f 6479  bined = manybody
+00006a20: 2e63 6f6d 6269 6e65 5f69 6e74 6572 7661  .combine_interva
+00006a30: 6c73 285b 696e 7430 2c20 696e 7434 5d29  ls([int0, int4])
+00006a40: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
+00006a50: 636f 6d62 696e 6564 2920 3d3d 2031 0a20  combined) == 1. 
+00006a60: 2020 2061 7373 6572 7420 636f 6d62 696e     assert combin
+00006a70: 6564 5b30 5d2e 6c65 6164 203d 3d20 2831  ed[0].lead == (1
+00006a80: 2c20 322c 2033 290a 0a20 2020 2023 2063  , 2, 3)..    # c
+00006a90: 6f6d 6269 6e65 206f 6e20 616e 2065 6d70  ombine on an emp
+00006aa0: 7479 206c 6973 740a 2020 2020 636f 6d62  ty list.    comb
+00006ab0: 696e 6564 203d 206d 616e 7962 6f64 792e  ined = manybody.
+00006ac0: 636f 6d62 696e 655f 696e 7465 7276 616c  combine_interval
+00006ad0: 7328 5b5d 290a 2020 2020 6173 7365 7274  s([]).    assert
+00006ae0: 2069 7369 6e73 7461 6e63 6528 636f 6d62   isinstance(comb
+00006af0: 696e 6564 2c20 6c69 7374 290a 2020 2020  ined, list).    
+00006b00: 6173 7365 7274 206c 656e 2863 6f6d 6269  assert len(combi
+00006b10: 6e65 6429 203d 3d20 300a 0a20 2020 2023  ned) == 0..    #
+00006b20: 2063 6f6d 6269 6e65 206f 6e20 6120 6c69   combine on a li
+00006b30: 7374 2077 6974 6820 6f6e 6c79 206f 6e65  st with only one
+00006b40: 2069 6e74 6572 7661 6c0a 2020 2020 636f   interval.    co
+00006b50: 6d62 696e 6564 203d 206d 616e 7962 6f64  mbined = manybod
+00006b60: 792e 636f 6d62 696e 655f 696e 7465 7276  y.combine_interv
+00006b70: 616c 7328 5b69 6e74 305d 290a 2020 2020  als([int0]).    
+00006b80: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00006b90: 6528 636f 6d62 696e 6564 2c20 6c69 7374  e(combined, list
+00006ba0: 290a 2020 2020 6173 7365 7274 206c 656e  ).    assert len
+00006bb0: 2863 6f6d 6269 6e65 6429 203d 3d20 310a  (combined) == 1.
+00006bc0: 2020 2020 6173 7365 7274 2063 6f6d 6269      assert combi
+00006bd0: 6e65 645b 305d 2e6c 6561 6420 3d3d 2033  ned[0].lead == 3
+00006be0: 0a0a 2020 2020 2320 636f 6d62 696e 6520  ..    # combine 
+00006bf0: 7468 7265 6520 696e 7465 7276 616c 730a  three intervals.
+00006c00: 2020 2020 636f 6d62 696e 6564 203d 206d      combined = m
+00006c10: 616e 7962 6f64 792e 636f 6d62 696e 655f  anybody.combine_
+00006c20: 696e 7465 7276 616c 7328 5b69 6e74 302c  intervals([int0,
+00006c30: 2069 6e74 312c 2069 6e74 325d 290a 2020   int1, int2]).  
+00006c40: 2020 6173 7365 7274 2069 7369 6e73 7461    assert isinsta
+00006c50: 6e63 6528 636f 6d62 696e 6564 2c20 6c69  nce(combined, li
+00006c60: 7374 290a 2020 2020 6173 7365 7274 206c  st).    assert l
+00006c70: 656e 2863 6f6d 6269 6e65 6429 203d 3d20  en(combined) == 
+00006c80: 310a 2020 2020 6173 7365 7274 2063 6f6d  1.    assert com
+00006c90: 6269 6e65 645b 305d 2e6c 6561 6420 3d3d  bined[0].lead ==
+00006ca0: 2028 332c 2035 2c20 3629 0a0a 2020 2020   (3, 5, 6)..    
+00006cb0: 2320 636f 6d62 696e 6520 7477 6f20 6f75  # combine two ou
+00006cc0: 7420 6f66 2074 6872 6565 2069 6e74 6572  t of three inter
+00006cd0: 7661 6c73 0a20 2020 2063 6f6d 6269 6e65  vals.    combine
+00006ce0: 6420 3d20 6d61 6e79 626f 6479 2e63 6f6d  d = manybody.com
+00006cf0: 6269 6e65 5f69 6e74 6572 7661 6c73 285b  bine_intervals([
+00006d00: 696e 7430 2c20 696e 7431 2c20 696e 7433  int0, int1, int3
+00006d10: 5d29 0a20 2020 2061 7373 6572 7420 6c65  ]).    assert le
+00006d20: 6e28 636f 6d62 696e 6564 2920 3d3d 2032  n(combined) == 2
+00006d30: 0a20 2020 2061 7373 6572 7420 636f 6d62  .    assert comb
+00006d40: 696e 6564 5b30 5d2e 6c65 6164 203d 3d20  ined[0].lead == 
+00006d50: 2833 2c20 3529 0a20 2020 2061 7373 6572  (3, 5).    asser
+00006d60: 7420 636f 6d62 696e 6564 5b31 5d2e 6c65  t combined[1].le
+00006d70: 6164 203d 3d20 370a 0a20 2020 2063 6f6d  ad == 7..    com
+00006d80: 6269 6e65 6420 3d20 6d61 6e79 626f 6479  bined = manybody
+00006d90: 2e63 6f6d 6269 6e65 5f69 6e74 6572 7661  .combine_interva
+00006da0: 6c73 285b 696e 7433 2c20 696e 7431 2c20  ls([int3, int1, 
+00006db0: 696e 7430 5d29 0a20 2020 2061 7373 6572  int0]).    asser
+00006dc0: 7420 6c65 6e28 636f 6d62 696e 6564 2920  t len(combined) 
+00006dd0: 3d3d 2032 0a20 2020 2061 7373 6572 7420  == 2.    assert 
+00006de0: 636f 6d62 696e 6564 5b30 5d2e 6c65 6164  combined[0].lead
+00006df0: 203d 3d20 370a 2020 2020 6173 7365 7274   == 7.    assert
+00006e00: 2063 6f6d 6269 6e65 645b 315d 2e6c 6561   combined[1].lea
+00006e10: 6420 3d3d 2028 332c 2035 290a 0a20 2020  d == (3, 5)..   
+00006e20: 2063 6f6d 6269 6e65 6420 3d20 6d61 6e79   combined = many
+00006e30: 626f 6479 2e63 6f6d 6269 6e65 5f69 6e74  body.combine_int
+00006e40: 6572 7661 6c73 285b 696e 7431 2c20 696e  ervals([int1, in
+00006e50: 7433 2c20 696e 7430 5d29 0a20 2020 2061  t3, int0]).    a
+00006e60: 7373 6572 7420 6c65 6e28 636f 6d62 696e  ssert len(combin
+00006e70: 6564 2920 3d3d 2032 0a20 2020 2061 7373  ed) == 2.    ass
+00006e80: 6572 7420 636f 6d62 696e 6564 5b30 5d2e  ert combined[0].
+00006e90: 6c65 6164 203d 3d20 2833 2c20 3529 0a20  lead == (3, 5). 
+00006ea0: 2020 2061 7373 6572 7420 636f 6d62 696e     assert combin
+00006eb0: 6564 5b31 5d2e 6c65 6164 203d 3d20 370a  ed[1].lead == 7.
+00006ec0: 0a20 2020 2023 2069 6e70 7574 206c 6973  .    # input lis
+00006ed0: 7420 6861 7320 736f 6d65 2065 6c65 6d65  t has some eleme
+00006ee0: 6e74 7320 7769 7468 6f75 7420 6c65 6164  nts without lead
+00006ef0: 2061 7474 7269 6275 7465 0a20 2020 2023   attribute.    #
+00006f00: 2069 6620 626c 6120 6973 2074 6865 206c   if bla is the l
+00006f10: 6173 7420 6172 6775 656d 656e 742c 206e  ast arguement, n
+00006f20: 6f74 6869 6e67 2077 696c 6c20 6265 2063  othing will be c
+00006f30: 6f6d 6269 6e65 640a 2020 2020 7769 7468  ombined.    with
+00006f40: 2070 7974 6573 742e 7261 6973 6573 2841   pytest.raises(A
+00006f50: 7474 7269 6275 7465 4572 726f 7229 2061  ttributeError) a
+00006f60: 7320 6578 633a 0a20 2020 2020 2020 206d  s exc:.        m
+00006f70: 616e 7962 6f64 792e 636f 6d62 696e 655f  anybody.combine_
+00006f80: 696e 7465 7276 616c 7328 5b27 626c 6127  intervals(['bla'
+00006f90: 2c20 696e 7430 5d29 0a20 2020 2061 7373  , int0]).    ass
+00006fa0: 6572 7420 2761 7474 7269 6275 7465 2022  ert 'attribute "
+00006fb0: 6c65 6164 2220 6d69 7373 696e 6720 696e  lead" missing in
+00006fc0: 2069 6e74 6572 7661 6c27 2069 6e20 7374   interval' in st
+00006fd0: 7228 6578 632e 7661 6c75 6529 0a0a 2020  r(exc.value)..  
+00006fe0: 2020 7769 7468 2070 7974 6573 742e 7261    with pytest.ra
+00006ff0: 6973 6573 2841 7474 7269 6275 7465 4572  ises(AttributeEr
+00007000: 726f 7229 2061 7320 6578 633a 0a20 2020  ror) as exc:.   
+00007010: 2020 2020 206d 616e 7962 6f64 792e 636f       manybody.co
+00007020: 6d62 696e 655f 696e 7465 7276 616c 7328  mbine_intervals(
+00007030: 5b69 6e74 302c 2027 626c 6127 2c20 696e  [int0, 'bla', in
+00007040: 7431 5d29 0a20 2020 2061 7373 6572 7420  t1]).    assert 
+00007050: 2761 7474 7269 6275 7465 2022 6c65 6164  'attribute "lead
+00007060: 2220 6d69 7373 696e 6720 696e 2069 6e74  " missing in int
+00007070: 6572 7661 6c27 2069 6e20 7374 7228 6578  erval' in str(ex
+00007080: 632e 7661 6c75 6529 0a0a 0a64 6566 2074  c.value)...def t
+00007090: 6573 745f 6361 6c63 5f6d 6f64 6573 5f61  est_calc_modes_a
+000070a0: 6e64 5f77 6569 6768 7473 2874 776f 5f62  nd_weights(two_b
+000070b0: 616e 645f 7370 6563 7472 756d 2c20 7175  and_spectrum, qu
+000070c0: 6164 7261 7475 7265 5f69 6e74 6572 7661  adrature_interva
+000070d0: 6c29 3a0a 0a20 2020 2023 2063 6865 636b  l):..    # check
+000070e0: 2061 6c6c 2074 7970 6573 206f 6620 7468   all types of th
+000070f0: 6520 7265 7475 726e 6564 2065 6c65 6d65  e returned eleme
+00007100: 6e74 730a 2020 2020 6465 6620 6469 7374  nts.    def dist
+00007110: 7269 6275 7469 6f6e 2865 6e65 7267 7929  ribution(energy)
+00007120: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
+00007130: 206e 702e 6f6e 6573 286c 656e 2865 6e65   np.ones(len(ene
+00007140: 7267 7929 290a 0a20 2020 2071 7561 6472  rgy))..    quadr
+00007150: 6174 7572 655f 696e 7465 7276 616c 2e71  ature_interval.q
+00007160: 7561 6472 6174 7572 6520 3d20 2767 6175  uadrature = 'gau
+00007170: 7373 6c65 6765 6e64 7265 270a 0a20 2020  sslegendre'..   
+00007180: 2074 6d70 203d 206d 616e 7962 6f64 792e   tmp = manybody.
+00007190: 5f63 616c 635f 6d6f 6465 735f 616e 645f  _calc_modes_and_
+000071a0: 7765 6967 6874 7328 7175 6164 7261 7475  weights(quadratu
+000071b0: 7265 5f69 6e74 6572 7661 6c2c 2064 6973  re_interval, dis
+000071c0: 7472 6962 7574 696f 6e2c 2074 776f 5f62  tribution, two_b
+000071d0: 616e 645f 7370 6563 7472 756d 290a 2020  and_spectrum).  
+000071e0: 2020 6d6f 6465 732c 2065 6e65 7267 6965    modes, energie
+000071f0: 732c 206d 6f6d 656e 7461 2c20 7765 6967  s, momenta, weig
+00007200: 6874 732c 206d 6174 685f 7765 6967 6874  hts, math_weight
+00007210: 732c 2070 6879 735f 7765 6967 6874 7320  s, phys_weights 
+00007220: 3d20 746d 700a 0a20 2020 206f 7264 6572  = tmp..    order
+00007230: 203d 2071 7561 6472 6174 7572 655f 696e   = quadrature_in
+00007240: 7465 7276 616c 2e6f 7264 6572 0a0a 2020  terval.order..  
+00007250: 2020 2320 7465 7374 2073 6861 7065 7320    # test shapes 
+00007260: 6f66 2074 6865 2072 6574 7572 6e20 656c  of the return el
+00007270: 656d 656e 7473 0a0a 2020 2020 6173 7365  ements..    asse
+00007280: 7274 2069 7369 6e73 7461 6e63 6528 6d6f  rt isinstance(mo
+00007290: 6465 732c 206e 702e 6e64 6172 7261 7929  des, np.ndarray)
+000072a0: 0a20 2020 2061 7373 6572 7420 6973 696e  .    assert isin
+000072b0: 7374 616e 6365 2865 6e65 7267 6965 732c  stance(energies,
+000072c0: 206e 702e 6e64 6172 7261 7929 0a20 2020   np.ndarray).   
+000072d0: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+000072e0: 6365 286d 6f6d 656e 7461 2c20 6e70 2e6e  ce(momenta, np.n
+000072f0: 6461 7272 6179 290a 2020 2020 6173 7365  darray).    asse
+00007300: 7274 2069 7369 6e73 7461 6e63 6528 7765  rt isinstance(we
+00007310: 6967 6874 732c 206e 702e 6e64 6172 7261  ights, np.ndarra
+00007320: 7929 0a20 2020 2061 7373 6572 7420 6973  y).    assert is
+00007330: 696e 7374 616e 6365 286d 6174 685f 7765  instance(math_we
+00007340: 6967 6874 732c 206e 702e 6e64 6172 7261  ights, np.ndarra
+00007350: 7929 0a20 2020 2061 7373 6572 7420 6973  y).    assert is
+00007360: 696e 7374 616e 6365 2870 6879 735f 7765  instance(phys_we
+00007370: 6967 6874 732c 206e 702e 6e64 6172 7261  ights, np.ndarra
+00007380: 7929 0a0a 2020 2020 6173 7365 7274 206d  y)..    assert m
+00007390: 6f64 6573 2e73 6861 7065 203d 3d20 286f  odes.shape == (o
+000073a0: 7264 6572 2c29 0a20 2020 2061 7373 6572  rder,).    asser
+000073b0: 7420 656e 6572 6769 6573 2e73 6861 7065  t energies.shape
+000073c0: 203d 3d20 286f 7264 6572 2c29 0a20 2020   == (order,).   
+000073d0: 2061 7373 6572 7420 6d6f 6d65 6e74 612e   assert momenta.
+000073e0: 7368 6170 6520 3d3d 2028 6f72 6465 722c  shape == (order,
+000073f0: 290a 2020 2020 6173 7365 7274 2070 6879  ).    assert phy
+00007400: 735f 7765 6967 6874 732e 7368 6170 6520  s_weights.shape 
+00007410: 3d3d 2028 6f72 6465 722c 290a 0a20 2020  == (order,)..   
+00007420: 2061 7373 6572 7420 7765 6967 6874 732e   assert weights.
+00007430: 7368 6170 6520 3d3d 2028 6f72 6465 722c  shape == (order,
+00007440: 290a 2020 2020 6173 7365 7274 206d 6174  ).    assert mat
+00007450: 685f 7765 6967 6874 732e 7368 6170 6520  h_weights.shape 
+00007460: 3d3d 2028 6f72 6465 722c 290a 0a20 2020  == (order,)..   
+00007470: 2071 7561 6472 6174 7572 655f 696e 7465   quadrature_inte
+00007480: 7276 616c 2e71 7561 6472 6174 7572 6520  rval.quadrature 
+00007490: 3d20 276b 726f 6e72 6f64 270a 0a20 2020  = 'kronrod'..   
+000074a0: 2074 6d70 203d 206d 616e 7962 6f64 792e   tmp = manybody.
+000074b0: 5f63 616c 635f 6d6f 6465 735f 616e 645f  _calc_modes_and_
+000074c0: 7765 6967 6874 7328 7175 6164 7261 7475  weights(quadratu
+000074d0: 7265 5f69 6e74 6572 7661 6c2c 2064 6973  re_interval, dis
+000074e0: 7472 6962 7574 696f 6e2c 2074 776f 5f62  tribution, two_b
+000074f0: 616e 645f 7370 6563 7472 756d 290a 2020  and_spectrum).  
+00007500: 2020 6d6f 6465 732c 2065 6e65 7267 6965    modes, energie
+00007510: 732c 206d 6f6d 656e 7461 2c20 7765 6967  s, momenta, weig
+00007520: 6874 732c 206d 6174 685f 7765 6967 6874  hts, math_weight
+00007530: 732c 2070 6879 735f 7765 6967 6874 7320  s, phys_weights 
+00007540: 3d20 746d 700a 0a20 2020 2023 2074 6573  = tmp..    # tes
+00007550: 7420 7368 6170 6573 206f 6620 7468 6520  t shapes of the 
+00007560: 7265 7475 726e 2065 6c65 6d65 6e74 730a  return elements.
+00007570: 0a20 2020 2061 7373 6572 7420 6973 696e  .    assert isin
+00007580: 7374 616e 6365 286d 6f64 6573 2c20 6e70  stance(modes, np
+00007590: 2e6e 6461 7272 6179 290a 2020 2020 6173  .ndarray).    as
+000075a0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+000075b0: 656e 6572 6769 6573 2c20 6e70 2e6e 6461  energies, np.nda
+000075c0: 7272 6179 290a 2020 2020 6173 7365 7274  rray).    assert
+000075d0: 2069 7369 6e73 7461 6e63 6528 6d6f 6d65   isinstance(mome
+000075e0: 6e74 612c 206e 702e 6e64 6172 7261 7929  nta, np.ndarray)
+000075f0: 0a20 2020 2061 7373 6572 7420 6973 696e  .    assert isin
+00007600: 7374 616e 6365 2877 6569 6768 7473 2c20  stance(weights, 
+00007610: 6e70 2e6e 6461 7272 6179 290a 2020 2020  np.ndarray).    
+00007620: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00007630: 6528 6d61 7468 5f77 6569 6768 7473 2c20  e(math_weights, 
+00007640: 6e70 2e6e 6461 7272 6179 290a 2020 2020  np.ndarray).    
+00007650: 6173 7365 7274 2069 7369 6e73 7461 6e63  assert isinstanc
+00007660: 6528 7068 7973 5f77 6569 6768 7473 2c20  e(phys_weights, 
+00007670: 6e70 2e6e 6461 7272 6179 290a 0a20 2020  np.ndarray)..   
+00007680: 2061 7373 6572 7420 6d6f 6465 732e 7368   assert modes.sh
+00007690: 6170 6520 3d3d 2028 3220 2a20 6f72 6465  ape == (2 * orde
+000076a0: 7220 2b20 312c 290a 2020 2020 6173 7365  r + 1,).    asse
+000076b0: 7274 2065 6e65 7267 6965 732e 7368 6170  rt energies.shap
+000076c0: 6520 3d3d 2028 3220 2a20 6f72 6465 7220  e == (2 * order 
+000076d0: 2b20 312c 290a 2020 2020 6173 7365 7274  + 1,).    assert
+000076e0: 206d 6f6d 656e 7461 2e73 6861 7065 203d   momenta.shape =
+000076f0: 3d20 2832 202a 206f 7264 6572 202b 2031  = (2 * order + 1
+00007700: 2c29 0a20 2020 2061 7373 6572 7420 7068  ,).    assert ph
+00007710: 7973 5f77 6569 6768 7473 2e73 6861 7065  ys_weights.shape
+00007720: 203d 3d20 2832 202a 206f 7264 6572 202b   == (2 * order +
+00007730: 2031 2c29 0a0a 2020 2020 6173 7365 7274   1,)..    assert
+00007740: 2077 6569 6768 7473 2e73 6861 7065 203d   weights.shape =
+00007750: 3d20 2832 202a 206f 7264 6572 202b 2031  = (2 * order + 1
+00007760: 2c20 3229 0a20 2020 2061 7373 6572 7420  , 2).    assert 
+00007770: 6d61 7468 5f77 6569 6768 7473 2e73 6861  math_weights.sha
+00007780: 7065 203d 3d20 2832 202a 206f 7264 6572  pe == (2 * order
+00007790: 202b 2031 2c20 3229 0a0a 2020 2020 2320   + 1, 2)..    # 
+000077a0: 6e6f 2076 6563 746f 7220 6675 6e63 7469  no vector functi
+000077b0: 6f6e 2064 6973 7472 6962 7574 696f 6e0a  on distribution.
+000077c0: 0a20 2020 2064 6566 2066 6572 6d69 5f64  .    def fermi_d
+000077d0: 6972 6163 5f64 6973 7472 6962 7574 696f  irac_distributio
+000077e0: 6e28 656e 6572 6779 293a 0a20 2020 2020  n(energy):.     
+000077f0: 2020 2022 2222 4665 726d 6920 6469 7261     """Fermi dira
+00007800: 6374 2064 6973 7472 6962 7574 696f 6e20  ct distribution 
+00007810: 6675 6e63 7469 6f6e 2222 220a 2020 2020  function""".    
+00007820: 2020 2020 7265 7475 726e 2031 2e20 2f20      return 1. / 
+00007830: 2831 202b 2065 7870 2828 656e 6572 6779  (1 + exp((energy
+00007840: 202d 2030 2e35 2920 2f20 302e 3129 290a   - 0.5) / 0.1)).
+00007850: 2020 2020 6469 7374 7269 6275 7469 6f6e      distribution
+00007860: 203d 2066 6572 6d69 5f64 6972 6163 5f64   = fermi_dirac_d
+00007870: 6973 7472 6962 7574 696f 6e0a 2020 2020  istribution.    
+00007880: 746d 7020 3d20 6d61 6e79 626f 6479 2e5f  tmp = manybody._
+00007890: 6361 6c63 5f6d 6f64 6573 5f61 6e64 5f77  calc_modes_and_w
+000078a0: 6569 6768 7473 2871 7561 6472 6174 7572  eights(quadratur
+000078b0: 655f 696e 7465 7276 616c 2c20 6469 7374  e_interval, dist
+000078c0: 7269 6275 7469 6f6e 2c20 7477 6f5f 6261  ribution, two_ba
+000078d0: 6e64 5f73 7065 6374 7275 6d29 0a0a 0a40  nd_spectrum)...@
+000078e0: 6d6f 6465 6c5f 7461 736b 7328 290a 6465  model_tasks().de
+000078f0: 6620 7465 7374 5f63 616c 635f 7461 736b  f test_calc_task
+00007900: 735f 7661 6c75 6573 2874 776f 5f62 616e  s_values(two_ban
+00007910: 645f 7370 6563 7472 756d 2c20 756e 6966  d_spectrum, unif
+00007920: 6f72 6d5f 6f63 6375 7061 7469 6f6e 2c20  orm_occupation, 
+00007930: 656e 6572 6779 5f66 756e 632c 0a20 2020  energy_func,.   
+00007940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007950: 2020 2020 2020 2020 7665 6c6f 6369 7479          velocity
+00007960: 5f66 756e 632c 2064 6973 7472 6962 7574  _func, distribut
+00007970: 696f 6e5f 6675 6e63 2c0a 2020 2020 2020  ion_func,.      
+00007980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007990: 2020 2020 2069 6e74 6572 7661 6c2c 2077       interval, w
+000079a0: 6569 6768 7473 2c20 782c 2078 5f74 7970  eights, x, x_typ
+000079b0: 6529 3a0a 0a20 2020 2075 6e69 666f 726d  e):..    uniform
+000079c0: 5f6f 6363 7570 6174 696f 6e2e 6469 7374  _occupation.dist
+000079d0: 7269 6275 7469 6f6e 203d 2064 6973 7472  ribution = distr
+000079e0: 6962 7574 696f 6e5f 6675 6e63 0a0a 2020  ibution_func..  
+000079f0: 2020 7461 736b 7320 3d20 6d61 6e79 626f    tasks = manybo
+00007a00: 6479 2e63 616c 635f 7461 736b 7328 696e  dy.calc_tasks(in
+00007a10: 7465 7276 616c 2c20 7477 6f5f 6261 6e64  terval, two_band
+00007a20: 5f73 7065 6374 7275 6d2c 2075 6e69 666f  _spectrum, unifo
+00007a30: 726d 5f6f 6363 7570 6174 696f 6e29 0a0a  rm_occupation)..
+00007a40: 2020 2020 6966 2078 5f74 7970 6520 3d3d      if x_type ==
+00007a50: 2027 6d6f 6d65 6e74 756d 273a 0a20 2020   'momentum':.   
+00007a60: 2020 2020 2066 6f72 2069 2c20 6b20 696e       for i, k in
+00007a70: 2065 6e75 6d65 7261 7465 2878 293a 0a20   enumerate(x):. 
+00007a80: 2020 2020 2020 2020 2020 2065 6e65 7267             energ
+00007a90: 7920 3d20 656e 6572 6779 5f66 756e 6328  y = energy_func(
+00007aa0: 6b29 0a20 2020 2020 2020 2020 2020 2077  k).            w
+00007ab0: 6569 6768 7420 3d20 6469 7374 7269 6275  eight = distribu
+00007ac0: 7469 6f6e 5f66 756e 6328 656e 6572 6779  tion_func(energy
+00007ad0: 2920 2a20 7665 6c6f 6369 7479 5f66 756e  ) * velocity_fun
+00007ae0: 6328 6b29 202a 2077 6569 6768 7473 5b69  c(k) * weights[i
+00007af0: 5d20 2f20 2832 202a 206e 702e 7069 290a  ] / (2 * np.pi).
+00007b00: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00007b10: 7274 5f61 6c6d 6f73 745f 6571 7561 6c28  rt_almost_equal(
+00007b20: 656e 6572 6779 2c20 7461 736b 735b 695d  energy, tasks[i]
+00007b30: 2e65 6e65 7267 7929 0a20 2020 2020 2020  .energy).       
+00007b40: 2020 2020 2061 7373 6572 745f 616c 6d6f       assert_almo
+00007b50: 7374 5f65 7175 616c 2877 6569 6768 742c  st_equal(weight,
+00007b60: 2074 6173 6b73 5b69 5d2e 7765 6967 6874   tasks[i].weight
+00007b70: 290a 2020 2020 656c 6966 2078 5f74 7970  ).    elif x_typ
+00007b80: 6520 3d3d 2027 656e 6572 6779 273a 0a20  e == 'energy':. 
+00007b90: 2020 2020 2020 2066 6f72 2069 2c20 656e         for i, en
+00007ba0: 6572 6779 2069 6e20 656e 756d 6572 6174  ergy in enumerat
+00007bb0: 6528 7829 3a0a 2020 2020 2020 2020 2020  e(x):.          
+00007bc0: 2020 7765 6967 6874 203d 2064 6973 7472    weight = distr
+00007bd0: 6962 7574 696f 6e5f 6675 6e63 2865 6e65  ibution_func(ene
+00007be0: 7267 7929 202a 2077 6569 6768 7473 5b69  rgy) * weights[i
+00007bf0: 5d20 2f20 2832 202a 206e 702e 7069 290a  ] / (2 * np.pi).
+00007c00: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00007c10: 7274 5f61 6c6d 6f73 745f 6571 7561 6c28  rt_almost_equal(
+00007c20: 656e 6572 6779 2c20 7461 736b 735b 695d  energy, tasks[i]
+00007c30: 2e65 6e65 7267 7929 0a20 2020 2020 2020  .energy).       
+00007c40: 2020 2020 2061 7373 6572 745f 616c 6d6f       assert_almo
+00007c50: 7374 5f65 7175 616c 2877 6569 6768 742c  st_equal(weight,
+00007c60: 2074 6173 6b73 5b69 5d2e 7765 6967 6874   tasks[i].weight
+00007c70: 290a 2020 2020 656c 7365 3a0a 2020 2020  ).    else:.    
+00007c80: 2020 2020 7261 6973 6520 4e6f 7449 6d70      raise NotImp
+00007c90: 6c65 6d65 6e74 6564 4572 726f 7228 2774  lementedError('t
+00007ca0: 7970 653d 7b7d 2075 6e6b 6e6f 776e 272e  ype={} unknown'.
+00007cb0: 666f 726d 6174 2878 5f74 7970 6529 290a  format(x_type)).
+00007cc0: 0a0a 6465 6620 7465 7374 5f63 616c 635f  ..def test_calc_
+00007cd0: 7461 736b 735f 6465 6661 756c 7428 7477  tasks_default(tw
+00007ce0: 6f5f 6261 6e64 5f73 7065 6374 7275 6d2c  o_band_spectrum,
+00007cf0: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
+00007d00: 696f 6e2c 2071 7561 6472 6174 7572 655f  ion, quadrature_
+00007d10: 696e 7465 7276 616c 293a 0a0a 2020 2020  interval):..    
+00007d20: 2320 6368 6563 6b20 616c 6c20 7479 7065  # check all type
+00007d30: 7320 6f66 2074 6865 2072 6574 7572 6e65  s of the returne
+00007d40: 6420 656c 656d 656e 7473 0a20 2020 2074  d elements.    t
+00007d50: 6173 6b73 203d 206d 616e 7962 6f64 792e  asks = manybody.
+00007d60: 6361 6c63 5f74 6173 6b73 2871 7561 6472  calc_tasks(quadr
+00007d70: 6174 7572 655f 696e 7465 7276 616c 2c20  ature_interval, 
+00007d80: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
+00007d90: 6d2c 2075 6e69 666f 726d 5f6f 6363 7570  m, uniform_occup
+00007da0: 6174 696f 6e29 0a0a 2020 2020 6173 7365  ation)..    asse
+00007db0: 7274 2069 7369 6e73 7461 6e63 6528 7461  rt isinstance(ta
+00007dc0: 736b 732c 2064 6963 7429 0a20 2020 2061  sks, dict).    a
+00007dd0: 7373 6572 7420 6c65 6e28 7461 736b 7329  ssert len(tasks)
+00007de0: 203d 3d20 7175 6164 7261 7475 7265 5f69   == quadrature_i
+00007df0: 6e74 6572 7661 6c2e 6f72 6465 7220 2a20  nterval.order * 
+00007e00: 3220 2b20 310a 2020 2020 666f 7220 692c  2 + 1.    for i,
+00007e10: 2028 6b65 792c 2076 616c 7565 2920 696e   (key, value) in
+00007e20: 2065 6e75 6d65 7261 7465 2874 6173 6b73   enumerate(tasks
+00007e30: 2e69 7465 6d73 2829 293a 0a0a 2020 2020  .items()):..    
+00007e40: 2020 2020 6173 7365 7274 206b 6579 203d      assert key =
+00007e50: 3d20 690a 2020 2020 2020 2020 6173 7365  = i.        asse
+00007e60: 7274 2069 7369 6e73 7461 6e63 6528 7661  rt isinstance(va
+00007e70: 6c75 652e 6c65 6164 2c20 696e 7429 0a20  lue.lead, int). 
+00007e80: 2020 2020 2020 2023 2061 7373 6572 7420         # assert 
+00007e90: 6973 696e 7374 616e 6365 2876 616c 7565  isinstance(value
+00007ea0: 2e6d 6f64 652c 2069 6e74 2920 2320 736f  .mode, int) # so
+00007eb0: 6d65 206e 756d 7079 206e 756d 6265 722c  me numpy number,
+00007ec0: 2054 4f44 4f0a 2020 2020 2020 2020 6173   TODO.        as
+00007ed0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00007ee0: 7661 6c75 652e 656e 6572 6779 2c20 666c  value.energy, fl
+00007ef0: 6f61 7429 0a20 2020 2020 2020 2023 2061  oat).        # a
+00007f00: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00007f10: 2876 616c 7565 2e77 6569 6768 742c 2066  (value.weight, f
+00007f20: 6c6f 6174 2920 2320 666f 7220 6761 7573  loat) # for gaus
+00007f30: 736c 6567 656e 6472 650a 2020 2020 2020  slegendre.      
+00007f40: 2020 2320 6173 7365 7274 2069 7369 6e73    # assert isins
+00007f50: 7461 6e63 6528 7661 6c75 652e 7765 6967  tance(value.weig
+00007f60: 6874 2c20 6e70 2e6e 6461 7272 6179 2920  ht, np.ndarray) 
+00007f70: 2320 666f 7220 6b72 6f6e 726f 640a 2020  # for kronrod.  
+00007f80: 2020 2020 2020 2320 544f 444f 2c20 6d61        # TODO, ma
+00007f90: 6b65 2077 6569 6768 7420 7479 7065 2073  ke weight type s
+00007fa0: 696d 696c 6172 0a0a 0a64 6566 2074 6573  imilar...def tes
+00007fb0: 745f 6361 6c63 5f74 6173 6b73 5f77 6974  t_calc_tasks_wit
+00007fc0: 685f 666c 6174 5f62 616e 6428 666c 6174  h_flat_band(flat
+00007fd0: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
+00007fe0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
+00007ff0: 6f6e 293a 0a0a 2020 2020 2320 7468 6973  on):..    # this
+00008000: 2069 7320 7468 6520 696e 7465 7276 616c   is the interval
+00008010: 2077 6974 6820 7468 6520 666c 6174 2062   with the flat b
+00008020: 616e 6420 2876 656c 6f63 6974 7920 7a65  and (velocity ze
+00008030: 726f 290a 2020 2020 696e 7465 7276 616c  ro).    interval
+00008040: 203d 206d 616e 7962 6f64 792e 496e 7465   = manybody.Inte
+00008050: 7276 616c 286c 6561 643d 302c 2062 616e  rval(lead=0, ban
+00008060: 643d 312c 206b 6d69 6e3d 2d6e 702e 7069  d=1, kmin=-np.pi
+00008070: 2c20 6b6d 6178 3d6e 702e 7069 290a 0a20  , kmax=np.pi).. 
+00008080: 2020 2023 2063 6865 636b 2074 6861 7420     # check that 
+00008090: 6e6f 2074 6173 6b73 2061 7265 2063 616c  no tasks are cal
+000080a0: 6375 6c61 7465 6420 6173 2077 6569 6768  culated as weigh
+000080b0: 7473 2061 7265 207a 6572 6f0a 2020 2020  ts are zero.    
+000080c0: 7461 736b 7320 3d20 6d61 6e79 626f 6479  tasks = manybody
+000080d0: 2e63 616c 635f 7461 736b 7328 696e 7465  .calc_tasks(inte
+000080e0: 7276 616c 2c20 666c 6174 5f62 616e 645f  rval, flat_band_
+000080f0: 7370 6563 7472 756d 2c20 756e 6966 6f72  spectrum, unifor
+00008100: 6d5f 6f63 6375 7061 7469 6f6e 290a 0a20  m_occupation).. 
+00008110: 2020 2061 7373 6572 7420 6c65 6e28 7461     assert len(ta
+00008120: 736b 7329 203d 3d20 300a 0a20 2020 2023  sks) == 0..    #
+00008130: 2063 6865 636b 2074 6861 7420 7765 2063   check that we c
+00008140: 616e 2074 756e 6520 7468 6520 746f 6c65  an tune the tole
+00008150: 7261 6e63 6520 746f 2067 6574 2061 6c6c  rance to get all
+00008160: 2074 6173 6b73 2061 6761 696e 0a20 2020   tasks again.   
+00008170: 2074 6173 6b73 203d 206d 616e 7962 6f64   tasks = manybod
+00008180: 792e 6361 6c63 5f74 6173 6b73 2869 6e74  y.calc_tasks(int
+00008190: 6572 7661 6c2c 2066 6c61 745f 6261 6e64  erval, flat_band
+000081a0: 5f73 7065 6374 7275 6d2c 2075 6e69 666f  _spectrum, unifo
+000081b0: 726d 5f6f 6363 7570 6174 696f 6e2c 2074  rm_occupation, t
+000081c0: 6f6c 3d31 452d 3330 290a 0a20 2020 2061  ol=1E-30)..    a
+000081d0: 7373 6572 7420 6c65 6e28 7461 736b 7329  ssert len(tasks)
+000081e0: 203d 3d20 3220 2a20 696e 7465 7276 616c   == 2 * interval
+000081f0: 2e6f 7264 6572 202b 2031 0a0a 0a64 6566  .order + 1...def
+00008200: 2074 6573 745f 6361 6c63 5f74 6173 6b73   test_calc_tasks
+00008210: 5f6b 6579 7328 7477 6f5f 6261 6e64 5f73  _keys(two_band_s
+00008220: 7065 6374 7275 6d2c 2075 6e69 666f 726d  pectrum, uniform
+00008230: 5f6f 6363 7570 6174 696f 6e2c 2071 7561  _occupation, qua
+00008240: 6472 6174 7572 655f 696e 7465 7276 616c  drature_interval
+00008250: 293a 0a0a 2020 2020 7461 736b 7320 3d20  ):..    tasks = 
+00008260: 6d61 6e79 626f 6479 2e63 616c 635f 7461  manybody.calc_ta
+00008270: 736b 7328 7175 6164 7261 7475 7265 5f69  sks(quadrature_i
+00008280: 6e74 6572 7661 6c2c 2074 776f 5f62 616e  nterval, two_ban
+00008290: 645f 7370 6563 7472 756d 2c20 756e 6966  d_spectrum, unif
+000082a0: 6f72 6d5f 6f63 6375 7061 7469 6f6e 2c20  orm_occupation, 
+000082b0: 6b65 7973 3d69 7465 7274 6f6f 6c73 2e63  keys=itertools.c
+000082c0: 6f75 6e74 2835 2929 0a0a 2020 2020 666f  ount(5))..    fo
+000082d0: 7220 692c 2028 6b65 792c 2074 6173 6b29  r i, (key, task)
+000082e0: 2069 6e20 656e 756d 6572 6174 6528 7461   in enumerate(ta
+000082f0: 736b 732e 6974 656d 7328 2929 3a0a 2020  sks.items()):.  
+00008300: 2020 2020 2020 6173 7365 7274 206b 6579        assert key
+00008310: 203d 3d20 6920 2b20 3520 2023 2061 6c6c   == i + 5  # all
+00008320: 206b 6579 7320 7368 6966 7465 6420 6279   keys shifted by
+00008330: 206f 6666 7365 740a 0a0a 6465 6620 7465   offset...def te
+00008340: 7374 5f63 616c 635f 7461 736b 735f 6c65  st_calc_tasks_le
+00008350: 6164 5f69 6e64 6578 2874 776f 5f62 616e  ad_index(two_ban
+00008360: 645f 7370 6563 7472 756d 2c20 756e 6966  d_spectrum, unif
+00008370: 6f72 6d5f 6f63 6375 7061 7469 6f6e 2c20  orm_occupation, 
+00008380: 7175 6164 7261 7475 7265 5f69 6e74 6572  quadrature_inter
+00008390: 7661 6c29 3a0a 0a20 2020 2071 7561 6472  val):..    quadr
+000083a0: 6174 7572 655f 696e 7465 7276 616c 2e6c  ature_interval.l
+000083b0: 6561 6420 3d20 300a 2020 2020 7461 736b  ead = 0.    task
+000083c0: 7320 3d20 6d61 6e79 626f 6479 2e63 616c  s = manybody.cal
+000083d0: 635f 7461 736b 7328 7175 6164 7261 7475  c_tasks(quadratu
+000083e0: 7265 5f69 6e74 6572 7661 6c2c 2074 776f  re_interval, two
+000083f0: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
+00008400: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
+00008410: 6f6e 290a 0a20 2020 2066 6f72 2069 2c20  on)..    for i, 
+00008420: 286b 6579 2c20 7461 736b 2920 696e 2065  (key, task) in e
+00008430: 6e75 6d65 7261 7465 2874 6173 6b73 2e69  numerate(tasks.i
+00008440: 7465 6d73 2829 293a 0a20 2020 2020 2020  tems()):.       
+00008450: 2061 7373 6572 7420 6973 696e 7374 616e   assert isinstan
+00008460: 6365 2874 6173 6b2e 6c65 6164 2c20 696e  ce(task.lead, in
+00008470: 7429 0a20 2020 2020 2020 2061 7373 6572  t).        asser
+00008480: 7420 7461 736b 2e6c 6561 6420 3d3d 2030  t task.lead == 0
+00008490: 0a0a 0a64 6566 2074 6573 745f 6361 6c63  ...def test_calc
+000084a0: 5f74 6173 6b73 5f6c 6561 645f 696e 6465  _tasks_lead_inde
+000084b0: 785f 7475 706c 6528 7477 6f5f 6261 6e64  x_tuple(two_band
+000084c0: 5f73 7065 6374 7275 6d2c 2075 6e69 666f  _spectrum, unifo
+000084d0: 726d 5f6f 6363 7570 6174 696f 6e29 3a0a  rm_occupation):.
+000084e0: 0a20 2020 2023 2063 616c 6375 6c61 7465  .    # calculate
+000084f0: 2074 6173 6b73 2077 6974 6820 6120 7365   tasks with a se
+00008500: 7175 656e 6365 206f 6620 696e 7465 7276  quence of interv
+00008510: 616c 730a 2020 2020 696e 7465 7230 203d  als.    inter0 =
+00008520: 206d 616e 7962 6f64 792e 496e 7465 7276   manybody.Interv
+00008530: 616c 286c 6561 643d 302c 2062 616e 643d  al(lead=0, band=
+00008540: 302c 206b 6d69 6e3d 302c 206b 6d61 783d  0, kmin=0, kmax=
+00008550: 6e70 2e70 6920 2f20 3229 0a20 2020 2069  np.pi / 2).    i
+00008560: 6e74 6572 3120 3d20 6d61 6e79 626f 6479  nter1 = manybody
+00008570: 2e49 6e74 6572 7661 6c28 6c65 6164 3d31  .Interval(lead=1
+00008580: 2c20 6261 6e64 3d30 2c20 6b6d 696e 3d30  , band=0, kmin=0
+00008590: 2c20 6b6d 6178 3d6e 702e 7069 202f 2032  , kmax=np.pi / 2
+000085a0: 290a 2020 2020 696e 7465 7276 616c 735f  ).    intervals_
+000085b0: 7365 7020 3d20 5b69 6e74 6572 302c 2069  sep = [inter0, i
+000085c0: 6e74 6572 315d 0a20 2020 2073 7065 6374  nter1].    spect
+000085d0: 7261 203d 205b 7477 6f5f 6261 6e64 5f73  ra = [two_band_s
+000085e0: 7065 6374 7275 6d2c 2074 776f 5f62 616e  pectrum, two_ban
+000085f0: 645f 7370 6563 7472 756d 5d0a 0a20 2020  d_spectrum]..   
+00008600: 2074 6173 6b73 5f73 6570 203d 206d 616e   tasks_sep = man
+00008610: 7962 6f64 792e 6361 6c63 5f74 6173 6b73  ybody.calc_tasks
+00008620: 2869 6e74 6572 7661 6c73 5f73 6570 2c20  (intervals_sep, 
+00008630: 7370 6563 7472 612c 2075 6e69 666f 726d  spectra, uniform
+00008640: 5f6f 6363 7570 6174 696f 6e29 0a0a 2020  _occupation)..  
+00008650: 2020 2320 6361 6c63 756c 6174 6520 7461    # calculate ta
+00008660: 736b 7320 7769 7468 206f 6e6c 7920 6f6e  sks with only on
+00008670: 6520 696e 7465 7276 616c 2069 6e63 6c75  e interval inclu
+00008680: 6469 6e67 2062 6f74 6820 6c65 6164 730a  ding both leads.
+00008690: 2020 2020 696e 7465 7276 616c 735f 6772      intervals_gr
+000086a0: 7020 3d20 6d61 6e79 626f 6479 2e49 6e74  p = manybody.Int
+000086b0: 6572 7661 6c28 6c65 6164 3d28 302c 2031  erval(lead=(0, 1
+000086c0: 292c 2062 616e 643d 302c 206b 6d69 6e3d  ), band=0, kmin=
+000086d0: 302c 206b 6d61 783d 6e70 2e70 6920 2f20  0, kmax=np.pi / 
+000086e0: 3229 0a20 2020 2074 6173 6b73 5f67 7270  2).    tasks_grp
+000086f0: 203d 206d 616e 7962 6f64 792e 6361 6c63   = manybody.calc
+00008700: 5f74 6173 6b73 2869 6e74 6572 7661 6c73  _tasks(intervals
+00008710: 5f67 7270 2c20 7370 6563 7472 612c 2075  _grp, spectra, u
+00008720: 6e69 666f 726d 5f6f 6363 7570 6174 696f  niform_occupatio
+00008730: 6e29 0a0a 2020 2020 6173 7365 7274 206c  n)..    assert l
+00008740: 656e 2874 6173 6b73 5f73 6570 2920 3d3d  en(tasks_sep) ==
+00008750: 206c 656e 2874 6173 6b73 5f67 7270 290a   len(tasks_grp).
+00008760: 2020 2020 666f 7220 6b65 792c 2076 616c      for key, val
+00008770: 7565 2069 6e20 7461 736b 735f 7365 702e  ue in tasks_sep.
+00008780: 6974 656d 7328 293a 0a20 2020 2020 2020  items():.       
+00008790: 2061 7373 6572 7420 7461 736b 735f 6772   assert tasks_gr
+000087a0: 705b 6b65 795d 2e6c 6561 6420 3d3d 2076  p[key].lead == v
+000087b0: 616c 7565 2e6c 6561 640a 2020 2020 2020  alue.lead.      
+000087c0: 2020 6173 7365 7274 2074 6173 6b73 5f67    assert tasks_g
+000087d0: 7270 5b6b 6579 5d2e 6d6f 6465 203d 3d20  rp[key].mode == 
+000087e0: 7661 6c75 652e 6d6f 6465 0a20 2020 2020  value.mode.     
+000087f0: 2020 2061 7373 6572 745f 616c 6d6f 7374     assert_almost
+00008800: 5f65 7175 616c 2874 6173 6b73 5f67 7270  _equal(tasks_grp
+00008810: 5b6b 6579 5d2e 656e 6572 6779 2c20 7661  [key].energy, va
+00008820: 6c75 652e 656e 6572 6779 290a 2020 2020  lue.energy).    
+00008830: 2020 2020 6173 7365 7274 5f61 6c6d 6f73      assert_almos
+00008840: 745f 6571 7561 6c28 7461 736b 735f 6772  t_equal(tasks_gr
+00008850: 705b 6b65 795d 2e6d 6f6d 656e 7475 6d2c  p[key].momentum,
+00008860: 2076 616c 7565 2e6d 6f6d 656e 7475 6d29   value.momentum)
+00008870: 0a20 2020 2020 2020 2061 7373 6572 745f  .        assert_
+00008880: 6172 7261 795f 616c 6d6f 7374 5f65 7175  array_almost_equ
+00008890: 616c 2874 6173 6b73 5f67 7270 5b6b 6579  al(tasks_grp[key
+000088a0: 5d2e 7765 6967 6874 2c20 7661 6c75 652e  ].weight, value.
+000088b0: 7765 6967 6874 290a 2020 2020 2020 2020  weight).        
+000088c0: 6173 7365 7274 5f61 7272 6179 5f61 6c6d  assert_array_alm
+000088d0: 6f73 745f 6571 7561 6c28 7461 736b 735f  ost_equal(tasks_
+000088e0: 6772 705b 6b65 795d 2e6d 6174 685f 7765  grp[key].math_we
+000088f0: 6967 6874 2c20 7661 6c75 652e 6d61 7468  ight, value.math
+00008900: 5f77 6569 6768 7429 0a20 2020 2020 2020  _weight).       
+00008910: 2061 7373 6572 745f 6172 7261 795f 616c   assert_array_al
+00008920: 6d6f 7374 5f65 7175 616c 2874 6173 6b73  most_equal(tasks
+00008930: 5f67 7270 5b6b 6579 5d2e 7068 7973 5f77  _grp[key].phys_w
+00008940: 6569 6768 742c 2076 616c 7565 2e70 6879  eight, value.phy
+00008950: 735f 7765 6967 6874 290a 0a0a 6465 6620  s_weight)...def 
+00008960: 7465 7374 5f63 616c 635f 7461 736b 735f  test_calc_tasks_
+00008970: 6261 6e64 5f69 6e64 6578 2874 776f 5f62  band_index(two_b
+00008980: 616e 645f 7370 6563 7472 756d 2c20 756e  and_spectrum, un
+00008990: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
+000089a0: 2c20 7175 6164 7261 7475 7265 5f69 6e74  , quadrature_int
+000089b0: 6572 7661 6c29 3a0a 0a20 2020 2066 6f72  erval):..    for
+000089c0: 2062 616e 6420 696e 2072 616e 6765 2874   band in range(t
+000089d0: 776f 5f62 616e 645f 7370 6563 7472 756d  wo_band_spectrum
+000089e0: 2e6e 6261 6e64 7329 3a0a 2020 2020 2020  .nbands):.      
+000089f0: 2020 7175 6164 7261 7475 7265 5f69 6e74    quadrature_int
+00008a00: 6572 7661 6c2e 6261 6e64 203d 2062 616e  erval.band = ban
+00008a10: 640a 2020 2020 2020 2020 7461 736b 7320  d.        tasks 
+00008a20: 3d20 6d61 6e79 626f 6479 2e63 616c 635f  = manybody.calc_
+00008a30: 7461 736b 7328 7175 6164 7261 7475 7265  tasks(quadrature
+00008a40: 5f69 6e74 6572 7661 6c2c 2074 776f 5f62  _interval, two_b
+00008a50: 616e 645f 7370 6563 7472 756d 2c20 756e  and_spectrum, un
+00008a60: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
+00008a70: 290a 2020 2020 2020 2020 6173 7365 7274  ).        assert
+00008a80: 2069 7369 6e73 7461 6e63 6528 7461 736b   isinstance(task
+00008a90: 732c 2064 6963 7429 0a20 2020 2023 206e  s, dict).    # n
+00008aa0: 6f20 7370 6563 6966 6963 2074 6573 7420  o specific test 
+00008ab0: 736f 2066 6172 2c20 6173 206f 6e6c 7920  so far, as only 
+00008ac0: 6e75 6d65 7269 6361 6c20 7661 6c75 6573  numerical values
+00008ad0: 2063 6861 6e67 650a 0a0a 4070 7974 6573   change...@pytes
+00008ae0: 742e 6d61 726b 2e70 6172 616d 6574 7269  t.mark.parametri
+00008af0: 7a65 2827 7175 6164 7261 7475 7265 272c  ze('quadrature',
+00008b00: 2056 414c 4944 5f51 5541 4452 4154 5552   VALID_QUADRATUR
+00008b10: 4553 290a 6465 6620 7465 7374 5f63 616c  ES).def test_cal
+00008b20: 635f 7461 736b 735f 7175 6164 7261 7475  c_tasks_quadratu
+00008b30: 7265 2874 776f 5f62 616e 645f 7370 6563  re(two_band_spec
+00008b40: 7472 756d 2c20 756e 6966 6f72 6d5f 6f63  trum, uniform_oc
+00008b50: 6375 7061 7469 6f6e 2c20 7175 6164 7261  cupation, quadra
+00008b60: 7475 7265 5f69 6e74 6572 7661 6c2c 2071  ture_interval, q
+00008b70: 7561 6472 6174 7572 6529 3a0a 0a20 2020  uadrature):..   
+00008b80: 2071 7561 6472 6174 7572 655f 696e 7465   quadrature_inte
+00008b90: 7276 616c 2e71 7561 6472 6174 7572 6520  rval.quadrature 
+00008ba0: 3d20 7175 6164 7261 7475 7265 0a20 2020  = quadrature.   
+00008bb0: 2074 6173 6b73 203d 206d 616e 7962 6f64   tasks = manybod
+00008bc0: 792e 6361 6c63 5f74 6173 6b73 2871 7561  y.calc_tasks(qua
+00008bd0: 6472 6174 7572 655f 696e 7465 7276 616c  drature_interval
+00008be0: 2c20 7477 6f5f 6261 6e64 5f73 7065 6374  , two_band_spect
+00008bf0: 7275 6d2c 2075 6e69 666f 726d 5f6f 6363  rum, uniform_occ
+00008c00: 7570 6174 696f 6e29 0a0a 2020 2020 2320  upation)..    # 
+00008c10: 746f 646f 3a20 6d61 6b65 2077 6569 6768  todo: make weigh
+00008c20: 7420 7479 7065 2073 696d 696c 6172 2028  t type similar (
+00008c30: 6e75 6d70 7920 6172 7261 7929 0a20 2020  numpy array).   
+00008c40: 2069 6620 7175 6164 7261 7475 7265 203d   if quadrature =
+00008c50: 3d20 2767 6175 7373 6c65 6765 6e64 7265  = 'gausslegendre
+00008c60: 273a 0a20 2020 2020 2020 2061 7373 6572  ':.        asser
+00008c70: 7420 6c65 6e28 7461 736b 7329 203d 3d20  t len(tasks) == 
+00008c80: 7175 6164 7261 7475 7265 5f69 6e74 6572  quadrature_inter
+00008c90: 7661 6c2e 6f72 6465 720a 2020 2020 2020  val.order.      
+00008ca0: 2020 666f 7220 692c 2028 6b65 792c 2074    for i, (key, t
+00008cb0: 6173 6b29 2069 6e20 656e 756d 6572 6174  ask) in enumerat
+00008cc0: 6528 7461 736b 732e 6974 656d 7328 2929  e(tasks.items())
+00008cd0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+00008ce0: 7365 7274 2069 7369 6e73 7461 6e63 6528  sert isinstance(
+00008cf0: 7461 736b 2e6c 6561 642c 2069 6e74 290a  task.lead, int).
+00008d00: 2020 2020 2020 2020 2020 2020 6173 7365              asse
+00008d10: 7274 2069 7369 6e73 7461 6e63 6528 7461  rt isinstance(ta
+00008d20: 736b 2e77 6569 6768 742c 2066 6c6f 6174  sk.weight, float
+00008d30: 290a 2020 2020 656c 6966 2071 7561 6472  ).    elif quadr
+00008d40: 6174 7572 6520 3d3d 2027 6b72 6f6e 726f  ature == 'kronro
+00008d50: 6427 3a0a 2020 2020 2020 2020 6173 7365  d':.        asse
+00008d60: 7274 206c 656e 2874 6173 6b73 2920 3d3d  rt len(tasks) ==
+00008d70: 2032 202a 2071 7561 6472 6174 7572 655f   2 * quadrature_
+00008d80: 696e 7465 7276 616c 2e6f 7264 6572 202b  interval.order +
+00008d90: 2031 0a20 2020 2020 2020 2066 6f72 2069   1.        for i
+00008da0: 2c20 286b 6579 2c20 7461 736b 2920 696e  , (key, task) in
+00008db0: 2065 6e75 6d65 7261 7465 2874 6173 6b73   enumerate(tasks
+00008dc0: 2e69 7465 6d73 2829 293a 0a20 2020 2020  .items()):.     
+00008dd0: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+00008de0: 696e 7374 616e 6365 2874 6173 6b2e 6c65  instance(task.le
+00008df0: 6164 2c20 696e 7429 0a20 2020 2020 2020  ad, int).       
+00008e00: 2020 2020 2061 7373 6572 7420 6973 696e       assert isin
+00008e10: 7374 616e 6365 2874 6173 6b2e 7765 6967  stance(task.weig
+00008e20: 6874 2c20 6e70 2e6e 6461 7272 6179 290a  ht, np.ndarray).
+00008e30: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00008e40: 2020 7261 6973 6520 4e6f 7449 6d70 6c65    raise NotImple
+00008e50: 6d65 6e74 6564 4572 726f 7228 2771 7561  mentedError('qua
+00008e60: 6472 6174 7572 653d 7b7d 2075 6e6b 6e6f  drature={} unkno
+00008e70: 776e 272e 666f 726d 6174 2871 7561 6472  wn'.format(quadr
+00008e80: 6174 7572 6529 290a 0a0a 6465 6620 7465  ature))...def te
+00008e90: 7374 5f63 616c 635f 7461 736b 735f 6174  st_calc_tasks_at
+00008ea0: 7472 6962 7574 655f 636f 7079 2874 776f  tribute_copy(two
+00008eb0: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
+00008ec0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
+00008ed0: 6f6e 2c20 7175 6164 7261 7475 7265 5f69  on, quadrature_i
+00008ee0: 6e74 6572 7661 6c29 3a0a 0a20 2020 2063  nterval):..    c
+00008ef0: 6c61 7373 204d 7954 6173 6b3a 0a20 2020  lass MyTask:.   
+00008f00: 2020 2020 2064 6566 205f 5f69 6e69 745f       def __init_
+00008f10: 5f28 7365 6c66 2c20 7765 6967 6874 2c20  _(self, weight, 
+00008f20: 7068 7973 5f77 6569 6768 742c 206d 6174  phys_weight, mat
+00008f30: 685f 7765 6967 6874 2c20 656e 6572 6779  h_weight, energy
+00008f40: 2c20 6d6f 6d65 6e74 756d 2c20 6d6f 6465  , momentum, mode
+00008f50: 2c20 6c65 6164 293a 0a20 2020 2020 2020  , lead):.       
+00008f60: 2020 2020 2073 656c 662e 7765 6967 6874       self.weight
+00008f70: 203d 2077 6569 6768 740a 2020 2020 2020   = weight.      
+00008f80: 2020 2020 2020 7365 6c66 2e70 6879 735f        self.phys_
+00008f90: 7765 6967 6874 203d 2070 6879 735f 7765  weight = phys_we
+00008fa0: 6967 6874 0a20 2020 2020 2020 2020 2020  ight.           
+00008fb0: 2073 656c 662e 6d61 7468 5f77 6569 6768   self.math_weigh
+00008fc0: 7420 3d20 6d61 7468 5f77 6569 6768 740a  t = math_weight.
+00008fd0: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00008fe0: 2e65 6e65 7267 7920 3d20 656e 6572 6779  .energy = energy
+00008ff0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00009000: 662e 6d6f 6d65 6e74 756d 203d 206d 6f6d  f.momentum = mom
+00009010: 656e 7475 6d0a 2020 2020 2020 2020 2020  entum.          
+00009020: 2020 7365 6c66 2e6d 6f64 6520 3d20 6d6f    self.mode = mo
+00009030: 6465 0a20 2020 2020 2020 2020 2020 2073  de.            s
+00009040: 656c 662e 6c65 6164 203d 206c 6561 640a  elf.lead = lead.
+00009050: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00009060: 2e63 6865 636b 6174 7472 6962 7574 6520  .checkattribute 
+00009070: 3d20 2763 6865 636b 5f74 6173 6b27 2020  = 'check_task'  
+00009080: 2320 6475 6d6d 7920 6174 7472 6962 7574  # dummy attribut
+00009090: 6520 746f 2063 6865 636b 2069 6620 6974  e to check if it
+000090a0: 2069 7320 636f 7069 6564 0a0a 2020 2020   is copied..    
+000090b0: 7461 736b 7320 3d20 6d61 6e79 626f 6479  tasks = manybody
+000090c0: 2e63 616c 635f 7461 736b 7328 7175 6164  .calc_tasks(quad
+000090d0: 7261 7475 7265 5f69 6e74 6572 7661 6c2c  rature_interval,
+000090e0: 2074 776f 5f62 616e 645f 7370 6563 7472   two_band_spectr
+000090f0: 756d 2c20 756e 6966 6f72 6d5f 6f63 6375  um, uniform_occu
+00009100: 7061 7469 6f6e 2c20 7461 736b 5f74 7970  pation, task_typ
+00009110: 653d 4d79 5461 736b 290a 0a20 2020 2066  e=MyTask)..    f
+00009120: 6f72 2069 2c20 286b 6579 2c20 7461 736b  or i, (key, task
+00009130: 2920 696e 2065 6e75 6d65 7261 7465 2874  ) in enumerate(t
+00009140: 6173 6b73 2e69 7465 6d73 2829 293a 0a20  asks.items()):. 
+00009150: 2020 2020 2020 2061 7373 6572 7420 7461         assert ta
+00009160: 736b 2e63 6865 636b 6174 7472 6962 7574  sk.checkattribut
+00009170: 6520 3d3d 2027 6368 6563 6b5f 7461 736b  e == 'check_task
+00009180: 270a 0a0a 4070 7974 6573 742e 6d61 726b  '...@pytest.mark
+00009190: 2e70 6172 616d 6574 7269 7a65 2827 696e  .parametrize('in
+000091a0: 7465 6772 6174 696f 6e5f 7661 7269 6162  tegration_variab
+000091b0: 6c65 272c 2056 414c 4944 5f49 4e54 4547  le', VALID_INTEG
+000091c0: 5241 5449 4f4e 5f56 4152 4941 424c 4553  RATION_VARIABLES
+000091d0: 290a 6465 6620 7465 7374 5f63 616c 635f  ).def test_calc_
+000091e0: 7461 736b 735f 696e 7465 6772 6174 696f  tasks_integratio
+000091f0: 6e5f 7661 7269 6162 6c65 2874 776f 5f62  n_variable(two_b
+00009200: 616e 645f 7370 6563 7472 756d 2c20 756e  and_spectrum, un
+00009210: 6966 6f72 6d5f 6f63 6375 7061 7469 6f6e  iform_occupation
+00009220: 2c20 7175 6164 7261 7475 7265 5f69 6e74  , quadrature_int
+00009230: 6572 7661 6c2c 2069 6e74 6567 7261 7469  erval, integrati
+00009240: 6f6e 5f76 6172 6961 626c 6529 3a0a 0a20  on_variable):.. 
+00009250: 2020 2071 7561 6472 6174 7572 655f 696e     quadrature_in
+00009260: 7465 7276 616c 2e69 6e74 6567 7261 7469  terval.integrati
+00009270: 6f6e 5f76 6172 6961 626c 6520 3d20 696e  on_variable = in
+00009280: 7465 6772 6174 696f 6e5f 7661 7269 6162  tegration_variab
+00009290: 6c65 0a20 2020 2074 6173 6b73 203d 206d  le.    tasks = m
+000092a0: 616e 7962 6f64 792e 6361 6c63 5f74 6173  anybody.calc_tas
+000092b0: 6b73 2871 7561 6472 6174 7572 655f 696e  ks(quadrature_in
+000092c0: 7465 7276 616c 2c20 7477 6f5f 6261 6e64  terval, two_band
+000092d0: 5f73 7065 6374 7275 6d2c 2075 6e69 666f  _spectrum, unifo
+000092e0: 726d 5f6f 6363 7570 6174 696f 6e29 0a20  rm_occupation). 
+000092f0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+00009300: 616e 6365 2874 6173 6b73 2c20 6469 6374  ance(tasks, dict
+00009310: 290a 2020 2020 2320 6e6f 2073 7065 6369  ).    # no speci
+00009320: 6669 6320 7465 7374 2073 6f20 6661 722c  fic test so far,
+00009330: 2061 7320 6f6e 6c79 206e 756d 6572 6963   as only numeric
+00009340: 616c 2076 616c 7565 7320 6368 616e 6765  al values change
+00009350: 0a0a 0a64 6566 2074 6573 745f 6361 6c63  ...def test_calc
+00009360: 5f74 6173 6b73 5f6c 6561 645f 696e 6465  _tasks_lead_inde
+00009370: 785f 6f75 745f 6f66 5f72 616e 6765 2871  x_out_of_range(q
+00009380: 7561 6472 6174 7572 655f 696e 7465 7276  uadrature_interv
+00009390: 616c 2c20 7477 6f5f 6261 6e64 5f73 7065  al, two_band_spe
+000093a0: 6374 7275 6d2c 0a20 2020 2020 2020 2020  ctrum,.         
+000093b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000093c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000093d0: 2020 2075 6e69 666f 726d 5f6f 6363 7570     uniform_occup
+000093e0: 6174 696f 6e29 3a0a 2020 2020 7175 6164  ation):.    quad
+000093f0: 7261 7475 7265 5f69 6e74 6572 7661 6c2e  rature_interval.
+00009400: 6c65 6164 203d 2031 0a20 2020 2072 6169  lead = 1.    rai
+00009410: 7365 7328 496e 6465 7845 7272 6f72 2c20  ses(IndexError, 
+00009420: 6d61 6e79 626f 6479 2e63 616c 635f 7461  manybody.calc_ta
+00009430: 736b 732c 2071 7561 6472 6174 7572 655f  sks, quadrature_
+00009440: 696e 7465 7276 616c 2c20 7477 6f5f 6261  interval, two_ba
+00009450: 6e64 5f73 7065 6374 7275 6d2c 2075 6e69  nd_spectrum, uni
+00009460: 666f 726d 5f6f 6363 7570 6174 696f 6e29  form_occupation)
+00009470: 0a0a 0a64 6566 2074 6573 745f 6361 6c63  ...def test_calc
+00009480: 5f74 6173 6b73 5f62 616e 645f 696e 6465  _tasks_band_inde
+00009490: 785f 6f75 745f 6f66 5f72 616e 6765 2871  x_out_of_range(q
+000094a0: 7561 6472 6174 7572 655f 696e 7465 7276  uadrature_interv
+000094b0: 616c 2c20 7477 6f5f 6261 6e64 5f73 7065  al, two_band_spe
+000094c0: 6374 7275 6d2c 0a20 2020 2020 2020 2020  ctrum,.         
+000094d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000094f0: 2020 2075 6e69 666f 726d 5f6f 6363 7570     uniform_occup
+00009500: 6174 696f 6e29 3a0a 2020 2020 7175 6164  ation):.    quad
+00009510: 7261 7475 7265 5f69 6e74 6572 7661 6c2e  rature_interval.
+00009520: 6261 6e64 203d 2032 0a20 2020 2072 6169  band = 2.    rai
+00009530: 7365 7328 4173 7365 7274 696f 6e45 7272  ses(AssertionErr
+00009540: 6f72 2c20 6d61 6e79 626f 6479 2e63 616c  or, manybody.cal
+00009550: 635f 7461 736b 732c 2071 7561 6472 6174  c_tasks, quadrat
+00009560: 7572 655f 696e 7465 7276 616c 2c20 7477  ure_interval, tw
+00009570: 6f5f 6261 6e64 5f73 7065 6374 7275 6d2c  o_band_spectrum,
+00009580: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
+00009590: 696f 6e29 0a0a 0a64 6566 2074 6573 745f  ion)...def test_
+000095a0: 6361 6c63 5f74 6173 6b73 5f6b 6d69 6e5f  calc_tasks_kmin_
+000095b0: 6b6d 6178 5f69 6e74 6572 6368 616e 6765  kmax_interchange
+000095c0: 6428 7175 6164 7261 7475 7265 5f69 6e74  d(quadrature_int
+000095d0: 6572 7661 6c2c 2074 776f 5f62 616e 645f  erval, two_band_
+000095e0: 7370 6563 7472 756d 2c0a 2020 2020 2020  spectrum,.      
+000095f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009600: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009610: 2020 2020 2075 6e69 666f 726d 5f6f 6363       uniform_occ
+00009620: 7570 6174 696f 6e29 3a0a 2020 2020 7175  upation):.    qu
+00009630: 6164 7261 7475 7265 5f69 6e74 6572 7661  adrature_interva
+00009640: 6c2e 6b6d 696e 203d 2031 0a20 2020 2071  l.kmin = 1.    q
+00009650: 7561 6472 6174 7572 655f 696e 7465 7276  uadrature_interv
+00009660: 616c 2e6b 6d61 7820 3d20 300a 2020 2020  al.kmax = 0.    
+00009670: 7261 6973 6573 2856 616c 7565 4572 726f  raises(ValueErro
+00009680: 722c 206d 616e 7962 6f64 792e 6361 6c63  r, manybody.calc
+00009690: 5f74 6173 6b73 2c20 7175 6164 7261 7475  _tasks, quadratu
+000096a0: 7265 5f69 6e74 6572 7661 6c2c 2074 776f  re_interval, two
+000096b0: 5f62 616e 645f 7370 6563 7472 756d 2c20  _band_spectrum, 
+000096c0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
+000096d0: 6f6e 290a 0a0a 6465 6620 7465 7374 5f63  on)...def test_c
+000096e0: 616c 635f 7461 736b 735f 6f72 6465 725f  alc_tasks_order_
+000096f0: 6f75 745f 6f66 5f72 616e 6765 2871 7561  out_of_range(qua
+00009700: 6472 6174 7572 655f 696e 7465 7276 616c  drature_interval
+00009710: 2c20 7477 6f5f 6261 6e64 5f73 7065 6374  , two_band_spect
+00009720: 7275 6d2c 0a20 2020 2020 2020 2020 2020  rum,.           
+00009730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009740: 2020 2020 2020 2020 2020 2020 756e 6966              unif
+00009750: 6f72 6d5f 6f63 6375 7061 7469 6f6e 293a  orm_occupation):
+00009760: 0a20 2020 2071 7561 6472 6174 7572 655f  .    quadrature_
+00009770: 696e 7465 7276 616c 2e6f 7264 6572 203d  interval.order =
+00009780: 2030 0a20 2020 2072 6169 7365 7328 5661   0.    raises(Va
+00009790: 6c75 6545 7272 6f72 2c20 6d61 6e79 626f  lueError, manybo
+000097a0: 6479 2e63 616c 635f 7461 736b 732c 2071  dy.calc_tasks, q
+000097b0: 7561 6472 6174 7572 655f 696e 7465 7276  uadrature_interv
+000097c0: 616c 2c20 7477 6f5f 6261 6e64 5f73 7065  al, two_band_spe
+000097d0: 6374 7275 6d2c 2075 6e69 666f 726d 5f6f  ctrum, uniform_o
+000097e0: 6363 7570 6174 696f 6e29 0a0a 0a64 6566  ccupation)...def
+000097f0: 2074 6573 745f 6361 6c63 5f74 6173 6b73   test_calc_tasks
+00009800: 5f6e 6f6e 6578 6973 7469 6e67 5f71 7561  _nonexisting_qua
+00009810: 6472 6174 7572 6528 7175 6164 7261 7475  drature(quadratu
+00009820: 7265 5f69 6e74 6572 7661 6c2c 2074 776f  re_interval, two
+00009830: 5f62 616e 645f 7370 6563 7472 756d 2c0a  _band_spectrum,.
+00009840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009850: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009860: 2020 2020 2020 2020 2020 2075 6e69 666f             unifo
+00009870: 726d 5f6f 6363 7570 6174 696f 6e29 3a0a  rm_occupation):.
+00009880: 2020 2020 7175 6164 7261 7475 7265 5f69      quadrature_i
+00009890: 6e74 6572 7661 6c2e 7175 6164 7261 7475  nterval.quadratu
+000098a0: 7265 203d 2027 626c 6127 0a20 2020 2072  re = 'bla'.    r
+000098b0: 6169 7365 7328 4e6f 7449 6d70 6c65 6d65  aises(NotImpleme
+000098c0: 6e74 6564 4572 726f 722c 206d 616e 7962  ntedError, manyb
+000098d0: 6f64 792e 6361 6c63 5f74 6173 6b73 2c20  ody.calc_tasks, 
+000098e0: 7175 6164 7261 7475 7265 5f69 6e74 6572  quadrature_inter
+000098f0: 7661 6c2c 2074 776f 5f62 616e 645f 7370  val, two_band_sp
+00009900: 6563 7472 756d 2c20 756e 6966 6f72 6d5f  ectrum, uniform_
+00009910: 6f63 6375 7061 7469 6f6e 290a 0a0a 6465  occupation)...de
+00009920: 6620 7465 7374 5f63 616c 635f 7461 736b  f test_calc_task
+00009930: 735f 6e6f 6e65 7869 7374 696e 675f 696e  s_nonexisting_in
+00009940: 7465 6772 6174 696f 6e5f 7661 7269 6162  tegration_variab
+00009950: 6c65 2871 7561 6472 6174 7572 655f 696e  le(quadrature_in
+00009960: 7465 7276 616c 2c20 7477 6f5f 6261 6e64  terval, two_band
+00009970: 5f73 7065 6374 7275 6d2c 0a20 2020 2020  _spectrum,.     
+00009980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009990: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000099b0: 756e 6966 6f72 6d5f 6f63 6375 7061 7469  uniform_occupati
+000099c0: 6f6e 293a 0a20 2020 2071 7561 6472 6174  on):.    quadrat
+000099d0: 7572 655f 696e 7465 7276 616c 2e69 6e74  ure_interval.int
+000099e0: 6567 7261 7469 6f6e 5f76 6172 6961 626c  egration_variabl
+000099f0: 6520 3d20 2762 6c61 270a 2020 2020 7261  e = 'bla'.    ra
+00009a00: 6973 6573 284e 6f74 496d 706c 656d 656e  ises(NotImplemen
+00009a10: 7465 6445 7272 6f72 2c20 6d61 6e79 626f  tedError, manybo
+00009a20: 6479 2e63 616c 635f 7461 736b 732c 2071  dy.calc_tasks, q
+00009a30: 7561 6472 6174 7572 655f 696e 7465 7276  uadrature_interv
+00009a40: 616c 2c20 7477 6f5f 6261 6e64 5f73 7065  al, two_band_spe
+00009a50: 6374 7275 6d2c 2075 6e69 666f 726d 5f6f  ctrum, uniform_o
+00009a60: 6363 7570 6174 696f 6e29 0a0a 0a64 6566  ccupation)...def
+00009a70: 2074 6573 745f 6361 6c63 5f74 6173 6b73   test_calc_tasks
+00009a80: 5f64 6973 7472 6962 7574 696f 6e5f 6e6f  _distribution_no
+00009a90: 745f 6361 6c6c 6162 6c65 2871 7561 6472  t_callable(quadr
+00009aa0: 6174 7572 655f 696e 7465 7276 616c 2c20  ature_interval, 
+00009ab0: 7477 6f5f 6261 6e64 5f73 7065 6374 7275  two_band_spectru
+00009ac0: 6d2c 0a20 2020 2020 2020 2020 2020 2020  m,.             
+00009ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009af0: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
+00009b00: 696f 6e29 3a0a 2020 2020 756e 6966 6f72  ion):.    unifor
+00009b10: 6d5f 6f63 6375 7061 7469 6f6e 2e64 6973  m_occupation.dis
+00009b20: 7472 6962 7574 696f 6e20 3d20 310a 2020  tribution = 1.  
+00009b30: 2020 7261 6973 6573 2854 7970 6545 7272    raises(TypeErr
+00009b40: 6f72 2c20 6d61 6e79 626f 6479 2e63 616c  or, manybody.cal
+00009b50: 635f 7461 736b 732c 2071 7561 6472 6174  c_tasks, quadrat
+00009b60: 7572 655f 696e 7465 7276 616c 2c20 7477  ure_interval, tw
+00009b70: 6f5f 6261 6e64 5f73 7065 6374 7275 6d2c  o_band_spectrum,
+00009b80: 2075 6e69 666f 726d 5f6f 6363 7570 6174   uniform_occupat
+00009b90: 696f 6e29 0a0a 0a40 7079 7465 7374 2e6d  ion)...@pytest.m
+00009ba0: 6172 6b2e 696e 7465 6774 6573 7420 2023  ark.integtest  #
+00009bb0: 206d 6172 6b65 7220 666f 7220 696e 7465   marker for inte
+00009bc0: 6772 6174 696f 6e20 7465 7374 730a 6465  gration tests.de
+00009bd0: 6620 7465 7374 5f63 616c 635f 696e 6974  f test_calc_init
+00009be0: 6961 6c5f 7374 6174 6528 293a 0a0a 2020  ial_state():..  
+00009bf0: 2020 2320 2d2d 2d2d 2063 6865 636b 2069    # ---- check i
+00009c00: 6e69 7469 616c 2073 7461 7465 0a20 2020  nitial state.   
+00009c10: 2063 6865 6d69 6361 6c5f 706f 7465 6e74   chemical_potent
+00009c20: 6961 6c20 3d20 330a 2020 2020 746d 6178  ial = 3.    tmax
+00009c30: 203d 2035 3030 0a20 2020 2070 6172 616d   = 500.    param
+00009c40: 7320 3d20 7b27 7627 3a20 302e 312c 2027  s = {'v': 0.1, '
+00009c50: 7430 273a 2030 2c20 2741 273a 2030 2e30  t0': 0, 'A': 0.0
+00009c60: 3031 3537 2c20 2773 6967 6d61 273a 2032  0157, 'sigma': 2
+00009c70: 347d 0a20 2020 2073 7973 7420 3d20 6d61  4}.    syst = ma
+00009c80: 6b65 5f73 7973 7465 6d28 292e 6669 6e61  ke_system().fina
+00009c90: 6c69 7a65 6428 290a 2020 2020 6f63 6375  lized().    occu
+00009ca0: 7061 7469 6f6e 203d 206d 616e 7962 6f64  pation = manybod
+00009cb0: 792e 6c65 6164 5f6f 6363 7570 6174 696f  y.lead_occupatio
+00009cc0: 6e28 6368 656d 6963 616c 5f70 6f74 656e  n(chemical_poten
+00009cd0: 7469 616c 290a 2020 2020 7370 6563 7472  tial).    spectr
+00009ce0: 756d 203d 206b 7761 6e74 7370 6563 7472  um = kwantspectr
+00009cf0: 756d 2e73 7065 6374 7261 2873 7973 742e  um.spectra(syst.
+00009d00: 6c65 6164 7329 0a20 2020 2069 6e74 6572  leads).    inter
+00009d10: 7661 6c73 203d 206d 616e 7962 6f64 792e  vals = manybody.
+00009d20: 6361 6c63 5f69 6e74 6572 7661 6c73 2873  calc_intervals(s
+00009d30: 7065 6374 7275 6d2c 206f 6363 7570 6174  pectrum, occupat
+00009d40: 696f 6e29 0a20 2020 2069 6e74 6572 7661  ion).    interva
+00009d50: 6c73 5b30 5d2e 6f72 6465 7220 3d20 3130  ls[0].order = 10
+00009d60: 0a20 2020 2069 6e74 6572 7661 6c73 5b31  .    intervals[1
+00009d70: 5d2e 6f72 6465 7220 3d20 380a 2020 2020  ].order = 8.    
+00009d80: 666f 7220 696e 7465 7276 616c 2069 6e20  for interval in 
+00009d90: 696e 7465 7276 616c 733a 2020 2320 7573  intervals:  # us
+00009da0: 6520 7369 6d70 6c65 2071 7561 6472 6174  e simple quadrat
+00009db0: 7572 650a 2020 2020 2020 2020 696e 7465  ure.        inte
+00009dc0: 7276 616c 2e71 7561 6472 6174 7572 6520  rval.quadrature 
+00009dd0: 3d20 2767 6175 7373 6c65 6765 6e64 7265  = 'gausslegendre
+00009de0: 270a 2020 2020 7461 736b 7320 3d20 6d61  '.    tasks = ma
+00009df0: 6e79 626f 6479 2e63 616c 635f 7461 736b  nybody.calc_task
+00009e00: 7328 696e 7465 7276 616c 732c 2073 7065  s(intervals, spe
+00009e10: 6374 7275 6d2c 206f 6363 7570 6174 696f  ctrum, occupatio
+00009e20: 6e29 0a20 2020 2062 6f75 6e64 6172 6965  n).    boundarie
+00009e30: 7320 3d20 6c65 6164 732e 6175 746f 6d61  s = leads.automa
+00009e40: 7469 635f 626f 756e 6461 7279 2873 7065  tic_boundary(spe
+00009e50: 6374 7275 6d2c 2074 6d61 7829 0a20 2020  ctrum, tmax).   
+00009e60: 2070 7369 5f69 6e69 7420 3d20 6d61 6e79   psi_init = many
+00009e70: 626f 6479 2e63 616c 635f 696e 6974 6961  body.calc_initia
+00009e80: 6c5f 7374 6174 6528 7379 7374 2c20 7461  l_state(syst, ta
+00009e90: 736b 732c 2062 6f75 6e64 6172 6965 732c  sks, boundaries,
+00009ea0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ec0: 2020 2020 2020 2020 2020 2020 7061 7261              para
+00009ed0: 6d73 3d70 6172 616d 7329 0a0a 2020 2020  ms=params)..    
+00009ee0: 2320 6368 6563 6b20 616c 6c20 7479 7065  # check all type
+00009ef0: 7320 6f66 2074 6865 2072 6574 7572 6e65  s of the returne
+00009f00: 6420 656c 656d 656e 7473 0a20 2020 2061  d elements.    a
+00009f10: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+00009f20: 2870 7369 5f69 6e69 742c 2064 6963 7429  (psi_init, dict)
+00009f30: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
+00009f40: 7073 695f 696e 6974 2920 3d3d 2069 6e74  psi_init) == int
+00009f50: 6572 7661 6c73 5b30 5d2e 6f72 6465 7220  ervals[0].order 
+00009f60: 2b20 696e 7465 7276 616c 735b 315d 2e6f  + intervals[1].o
+00009f70: 7264 6572 0a20 2020 2066 6f72 2069 2c20  rder.    for i, 
+00009f80: 286b 6579 2c20 7661 6c75 6529 2069 6e20  (key, value) in 
+00009f90: 656e 756d 6572 6174 6528 7073 695f 696e  enumerate(psi_in
+00009fa0: 6974 2e69 7465 6d73 2829 293a 0a20 2020  it.items()):.   
+00009fb0: 2020 2020 2061 7373 6572 7420 6920 3d3d       assert i ==
+00009fc0: 206b 6579 0a20 2020 2020 2020 2061 7373   key.        ass
+00009fd0: 6572 7420 6973 696e 7374 616e 6365 2876  ert isinstance(v
+00009fe0: 616c 7565 2c20 6f6e 6562 6f64 792e 5761  alue, onebody.Wa
+00009ff0: 7665 4675 6e63 7469 6f6e 290a 0a0a 4070  veFunction)...@p
+0000a000: 7974 6573 742e 6d61 726b 2e69 6e74 6567  ytest.mark.integ
+0000a010: 7465 7374 0a64 6566 2074 6573 745f 6361  test.def test_ca
+0000a020: 6c63 5f69 6e69 7469 616c 5f73 7461 7465  lc_initial_state
+0000a030: 5f77 6974 685f 6b77 616e 745f 6661 696c  _with_kwant_fail
+0000a040: 696e 6728 293a 0a0a 2020 2020 7379 7374  ing():..    syst
+0000a050: 203d 206d 616b 655f 7379 7374 656d 2829   = make_system()
+0000a060: 2e66 696e 616c 697a 6564 2829 0a20 2020  .finalized().   
+0000a070: 206f 6363 7570 6174 696f 6e20 3d20 6d61   occupation = ma
+0000a080: 6e79 626f 6479 2e6c 6561 645f 6f63 6375  nybody.lead_occu
+0000a090: 7061 7469 6f6e 2863 6865 6d69 6361 6c5f  pation(chemical_
+0000a0a0: 706f 7465 6e74 6961 6c3d 3329 0a20 2020  potential=3).   
+0000a0b0: 2073 7065 6374 7275 6d20 3d20 6b77 616e   spectrum = kwan
+0000a0c0: 7473 7065 6374 7275 6d2e 7370 6563 7472  tspectrum.spectr
+0000a0d0: 6128 7379 7374 2e6c 6561 6473 290a 2020  a(syst.leads).  
+0000a0e0: 2020 696e 7465 7276 616c 7320 3d20 6d61    intervals = ma
+0000a0f0: 6e79 626f 6479 2e63 616c 635f 696e 7465  nybody.calc_inte
+0000a100: 7276 616c 7328 7370 6563 7472 756d 2c20  rvals(spectrum, 
+0000a110: 6f63 6375 7061 7469 6f6e 290a 2020 2020  occupation).    
+0000a120: 7461 736b 7320 3d20 6d61 6e79 626f 6479  tasks = manybody
+0000a130: 2e63 616c 635f 7461 736b 7328 696e 7465  .calc_tasks(inte
+0000a140: 7276 616c 732c 2073 7065 6374 7275 6d2c  rvals, spectrum,
+0000a150: 206f 6363 7570 6174 696f 6e29 0a20 2020   occupation).   
+0000a160: 2062 6f75 6e64 6172 6965 7320 3d20 5b6c   boundaries = [l
+0000a170: 6561 6473 2e53 696d 706c 6542 6f75 6e64  eads.SimpleBound
+0000a180: 6172 7928 6e75 6d5f 6275 6666 6572 5f63  ary(num_buffer_c
+0000a190: 656c 6c73 3d32 295d 202a 206c 656e 2873  ells=2)] * len(s
+0000a1a0: 7973 742e 6c65 6164 7329 0a20 2020 2070  yst.leads).    p
+0000a1b0: 6172 616d 7320 3d20 7b27 7627 3a20 302e  arams = {'v': 0.
+0000a1c0: 312c 2027 7430 273a 2030 2c20 2741 273a  1, 't0': 0, 'A':
+0000a1d0: 2030 2e30 3031 3537 2c20 2773 6967 6d61   0.00157, 'sigma
+0000a1e0: 273a 2032 347d 0a0a 2020 2020 636c 6173  ': 24}..    clas
+0000a1f0: 7320 5363 6174 7465 7269 6e67 5374 6174  s ScatteringStat
+0000a200: 6573 5261 6973 653a 0a20 2020 2020 2020  esRaise:.       
+0000a210: 2022 2222 7261 6973 6520 7769 7468 2061   """raise with a
+0000a220: 2072 756e 7469 6d65 2065 7272 6f72 2222   runtime error""
+0000a230: 220a 2020 2020 2020 2020 6465 6620 5f5f  ".        def __
+0000a240: 696e 6974 5f5f 2873 656c 662c 202a 6172  init__(self, *ar
+0000a250: 6773 2c20 7761 7665 6675 6e63 7469 6f6e  gs, wavefunction
+0000a260: 5f74 7970 653d 6f6e 6562 6f64 792e 5761  _type=onebody.Wa
+0000a270: 7665 4675 6e63 7469 6f6e 2e66 726f 6d5f  veFunction.from_
+0000a280: 6b77 616e 742c 202a 2a6b 7761 7267 7329  kwant, **kwargs)
+0000a290: 3a0a 2020 2020 2020 2020 2020 2020 7261  :.            ra
+0000a2a0: 6973 6520 5275 6e74 696d 6545 7272 6f72  ise RuntimeError
+0000a2b0: 2829 0a0a 2020 2020 2320 7765 206a 7573  ()..    # we jus
+0000a2c0: 7420 6d6f 636b 2074 6861 7420 7374 6174  t mock that stat
+0000a2d0: 6520 6361 6c63 756c 6174 696f 6e20 6661  e calculation fa
+0000a2e0: 696c 730a 2020 2020 7769 7468 2070 7974  ils.    with pyt
+0000a2f0: 6573 742e 7261 6973 6573 2852 756e 7469  est.raises(Runti
+0000a300: 6d65 4572 726f 7229 2061 7320 6578 633a  meError) as exc:
+0000a310: 0a20 2020 2020 2020 206d 616e 7962 6f64  .        manybod
+0000a320: 792e 6361 6c63 5f69 6e69 7469 616c 5f73  y.calc_initial_s
+0000a330: 7461 7465 2873 7973 742c 2074 6173 6b73  tate(syst, tasks
+0000a340: 2c20 626f 756e 6461 7269 6573 2c20 7061  , boundaries, pa
+0000a350: 7261 6d73 3d70 6172 616d 732c 0a20 2020  rams=params,.   
+0000a360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a370: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a380: 2073 6361 7474 6572 696e 675f 7374 6174   scattering_stat
+0000a390: 655f 7479 7065 3d53 6361 7474 6572 696e  e_type=Scatterin
+0000a3a0: 6753 7461 7465 7352 6169 7365 290a 2020  gStatesRaise).  
+0000a3b0: 2020 2320 7765 2064 6f20 6e6f 7420 6368    # we do not ch
+0000a3c0: 6563 6b20 666f 7220 7468 6520 6578 6163  eck for the exac
+0000a3d0: 7420 656e 6572 6779 2076 616c 7565 2061  t energy value a
+0000a3e0: 7320 7468 6973 2063 616e 2063 6861 6e67  s this can chang
+0000a3f0: 650a 2020 2020 6173 7365 7274 2027 7363  e.    assert 'sc
+0000a400: 6174 7465 7269 6e67 2073 7461 7465 2063  attering state c
+0000a410: 616c 6375 6c61 7469 6f6e 2066 6169 6c65  alculation faile
+0000a420: 6420 666f 7220 656e 6572 6779 3d27 2069  d for energy=' i
+0000a430: 6e20 7374 7228 6578 632e 7661 6c75 6529  n str(exc.value)
+0000a440: 0a0a 0a40 7079 7465 7374 2e6d 6172 6b2e  ...@pytest.mark.
+0000a450: 696e 7465 6774 6573 7420 2023 206d 6172  integtest  # mar
+0000a460: 6b65 7220 666f 7220 696e 7465 6772 6174  ker for integrat
+0000a470: 696f 6e20 7465 7374 730a 6465 6620 7465  ion tests.def te
+0000a480: 7374 5f6d 616e 7962 6f64 795f 7761 7665  st_manybody_wave
+0000a490: 6675 6e63 7469 6f6e 2829 3a0a 2020 2020  function():.    
+0000a4a0: 7379 7374 203d 206d 616b 655f 7379 7374  syst = make_syst
+0000a4b0: 656d 2829 2e66 696e 616c 697a 6564 2829  em().finalized()
+0000a4c0: 0a0a 2020 2020 6465 6e73 6974 795f 6f70  ..    density_op
+0000a4d0: 6572 6174 6f72 203d 206b 7761 6e74 2e6f  erator = kwant.o
+0000a4e0: 7065 7261 746f 722e 4465 6e73 6974 7928  perator.Density(
+0000a4f0: 7379 7374 2920 2023 2061 7272 6179 0a20  syst)  # array. 
+0000a500: 2020 2073 756d 5f64 656e 7369 7479 5f6f     sum_density_o
+0000a510: 7065 7261 746f 7220 3d20 6b77 616e 742e  perator = kwant.
+0000a520: 6f70 6572 6174 6f72 2e44 656e 7369 7479  operator.Density
+0000a530: 2873 7973 742c 2073 756d 3d54 7275 6529  (syst, sum=True)
+0000a540: 2020 2320 6f6e 6c79 206f 6e65 2065 6c65    # only one ele
+0000a550: 6d65 6e74 2069 6e20 6172 7261 790a 0a20  ment in array.. 
+0000a560: 2020 2063 6865 6d69 6361 6c5f 706f 7465     chemical_pote
+0000a570: 6e74 6961 6c20 3d20 330a 2020 2020 746d  ntial = 3.    tm
+0000a580: 6178 203d 2035 3030 0a20 2020 2074 696d  ax = 500.    tim
+0000a590: 6520 3d20 350a 2020 2020 7061 7261 6d73  e = 5.    params
+0000a5a0: 203d 207b 2776 273a 2030 2e31 2c20 2774   = {'v': 0.1, 't
+0000a5b0: 3027 3a20 302c 2027 4127 3a20 302e 3030  0': 0, 'A': 0.00
+0000a5c0: 3135 372c 2027 7369 676d 6127 3a20 3234  157, 'sigma': 24
+0000a5d0: 7d0a 0a20 2020 206f 6363 7570 6174 696f  }..    occupatio
+0000a5e0: 6e20 3d20 6d61 6e79 626f 6479 2e6c 6561  n = manybody.lea
+0000a5f0: 645f 6f63 6375 7061 7469 6f6e 2863 6865  d_occupation(che
+0000a600: 6d69 6361 6c5f 706f 7465 6e74 6961 6c29  mical_potential)
+0000a610: 0a20 2020 2073 7065 6374 7275 6d20 3d20  .    spectrum = 
+0000a620: 6b77 616e 7473 7065 6374 7275 6d2e 7370  kwantspectrum.sp
+0000a630: 6563 7472 6128 7379 7374 2e6c 6561 6473  ectra(syst.leads
+0000a640: 290a 2020 2020 696e 7465 7276 616c 7320  ).    intervals 
+0000a650: 3d20 6d61 6e79 626f 6479 2e63 616c 635f  = manybody.calc_
+0000a660: 696e 7465 7276 616c 7328 7370 6563 7472  intervals(spectr
+0000a670: 756d 2c20 6f63 6375 7061 7469 6f6e 290a  um, occupation).
+0000a680: 2020 2020 666f 7220 696e 7465 7276 616c      for interval
+0000a690: 2069 6e20 696e 7465 7276 616c 733a 2020   in intervals:  
+0000a6a0: 2320 7573 6520 7369 6d70 6c65 2071 7561  # use simple qua
+0000a6b0: 6472 6174 7572 650a 2020 2020 2020 2020  drature.        
+0000a6c0: 696e 7465 7276 616c 2e71 7561 6472 6174  interval.quadrat
+0000a6d0: 7572 6520 3d20 2767 6175 7373 6c65 6765  ure = 'gausslege
+0000a6e0: 6e64 7265 270a 2020 2020 7461 736b 7320  ndre'.    tasks 
+0000a6f0: 3d20 6d61 6e79 626f 6479 2e63 616c 635f  = manybody.calc_
+0000a700: 7461 736b 7328 696e 7465 7276 616c 732c  tasks(intervals,
+0000a710: 2073 7065 6374 7275 6d2c 206f 6363 7570   spectrum, occup
+0000a720: 6174 696f 6e29 0a20 2020 2062 6f75 6e64  ation).    bound
+0000a730: 6172 6965 7320 3d20 6c65 6164 732e 6175  aries = leads.au
+0000a740: 746f 6d61 7469 635f 626f 756e 6461 7279  tomatic_boundary
+0000a750: 2873 7065 6374 7275 6d2c 2074 6d61 7829  (spectrum, tmax)
+0000a760: 0a20 2020 2070 7369 5f69 6e69 7420 3d20  .    psi_init = 
+0000a770: 6d61 6e79 626f 6479 2e63 616c 635f 696e  manybody.calc_in
+0000a780: 6974 6961 6c5f 7374 6174 6528 7379 7374  itial_state(syst
+0000a790: 2c20 7461 736b 732c 2062 6f75 6e64 6172  , tasks, boundar
+0000a7a0: 6965 732c 2070 6172 616d 733d 7061 7261  ies, params=para
+0000a7b0: 6d73 290a 0a20 2020 2073 7461 7465 203d  ms)..    state =
+0000a7c0: 206d 616e 7962 6f64 792e 5761 7665 4675   manybody.WaveFu
+0000a7d0: 6e63 7469 6f6e 2870 7369 5f69 6e69 742c  nction(psi_init,
+0000a7e0: 2074 6173 6b73 290a 2020 2020 7374 6174   tasks).    stat
+0000a7f0: 652e 6576 6f6c 7665 2874 696d 6529 0a20  e.evolve(time). 
+0000a800: 2020 2061 7373 6572 7420 7374 6174 652e     assert state.
+0000a810: 7469 6d65 203d 3d20 7469 6d65 0a20 2020  time == time.   
+0000a820: 2066 6f72 205f 2c20 7073 6920 696e 2073   for _, psi in s
+0000a830: 7461 7465 2e70 7369 2e5f 6461 7461 2e69  tate.psi._data.i
+0000a840: 7465 6d73 2829 3a0a 2020 2020 2020 2020  tems():.        
+0000a850: 6173 7365 7274 2070 7369 2e74 696d 6520  assert psi.time 
+0000a860: 3d3d 2074 696d 650a 2020 2020 2020 2020  == time.        
+0000a870: 6173 7365 7274 2070 7369 2e70 6172 616d  assert psi.param
+0000a880: 7320 3d3d 207b 2776 273a 2030 2e31 2c20  s == {'v': 0.1, 
+0000a890: 2774 3027 3a20 302c 2027 4127 3a20 302e  't0': 0, 'A': 0.
+0000a8a0: 3030 3135 372c 2027 7369 676d 6127 3a20  00157, 'sigma': 
+0000a8b0: 3234 7d0a 0a20 2020 2023 2063 6865 636b  24}..    # check
+0000a8c0: 2072 6574 7572 6e20 7479 7065 2c20 7765   return type, we
+0000a8d0: 2065 7870 6563 7420 616e 2061 7272 6179   expect an array
+0000a8e0: 2072 756e 6e69 6e67 206f 7665 7220 616c   running over al
+0000a8f0: 6c20 7369 7465 7320 6f72 206a 7573 7420  l sites or just 
+0000a900: 6120 7369 6e67 6c65 206e 756d 6265 720a  a single number.
+0000a910: 2020 2020 6465 6e73 6974 7920 3d20 7374      density = st
+0000a920: 6174 652e 6576 616c 7561 7465 2864 656e  ate.evaluate(den
+0000a930: 7369 7479 5f6f 7065 7261 746f 7229 0a20  sity_operator). 
+0000a940: 2020 2073 756d 5f64 656e 7369 7479 203d     sum_density =
+0000a950: 2073 7461 7465 2e65 7661 6c75 6174 6528   state.evaluate(
+0000a960: 7375 6d5f 6465 6e73 6974 795f 6f70 6572  sum_density_oper
+0000a970: 6174 6f72 290a 2020 2020 6173 7365 7274  ator).    assert
+0000a980: 2069 7369 6e73 7461 6e63 6528 6465 6e73   isinstance(dens
+0000a990: 6974 792c 206e 702e 6e64 6172 7261 7929  ity, np.ndarray)
+0000a9a0: 0a20 2020 2061 7373 6572 7420 6465 6e73  .    assert dens
+0000a9b0: 6974 792e 7368 6170 6520 3d3d 2028 6c65  ity.shape == (le
+0000a9c0: 6e28 7379 7374 2e73 6974 6573 292c 2029  n(syst.sites), )
+0000a9d0: 0a20 2020 2061 7373 6572 7420 6973 696e  .    assert isin
+0000a9e0: 7374 616e 6365 2873 756d 5f64 656e 7369  stance(sum_densi
+0000a9f0: 7479 2c20 6e70 2e6e 6461 7272 6179 290a  ty, np.ndarray).
+0000aa00: 2020 2020 6173 7365 7274 2073 756d 5f64      assert sum_d
+0000aa10: 656e 7369 7479 2e73 6861 7065 203d 3d20  ensity.shape == 
+0000aa20: 2829 0a0a 2020 2020 2320 6368 6563 6b20  ()..    # check 
+0000aa30: 7468 6174 2065 7870 6563 7461 7469 6f6e  that expectation
+0000aa40: 2076 616c 7565 2066 6f72 206f 6e65 626f   value for onebo
+0000aa50: 6479 2f6d 616e 7962 6f64 7920 7761 7665  dy/manybody wave
+0000aa60: 6675 6e63 7469 6f6e 2061 7265 2073 696d  function are sim
+0000aa70: 696c 6172 0a20 2020 206f 6e65 626f 6479  ilar.    onebody
+0000aa80: 5f64 656e 7369 7479 203d 2073 7461 7465  _density = state
+0000aa90: 2e67 6574 5f6f 6e65 626f 6479 5f73 7461  .get_onebody_sta
+0000aaa0: 7465 286b 6579 3d30 292e 6576 616c 7561  te(key=0).evalua
+0000aab0: 7465 2864 656e 7369 7479 5f6f 7065 7261  te(density_opera
+0000aac0: 746f 7229 0a20 2020 206f 6e65 626f 6479  tor).    onebody
+0000aad0: 5f73 756d 5f64 656e 7369 7479 203d 2073  _sum_density = s
+0000aae0: 7461 7465 2e67 6574 5f6f 6e65 626f 6479  tate.get_onebody
+0000aaf0: 5f73 7461 7465 286b 6579 3d30 292e 6576  _state(key=0).ev
+0000ab00: 616c 7561 7465 2873 756d 5f64 656e 7369  aluate(sum_densi
+0000ab10: 7479 5f6f 7065 7261 746f 7229 0a0a 2020  ty_operator)..  
+0000ab20: 2020 6173 7365 7274 2064 656e 7369 7479    assert density
+0000ab30: 2e73 6861 7065 203d 3d20 6f6e 6562 6f64  .shape == onebod
+0000ab40: 795f 6465 6e73 6974 792e 7368 6170 650a  y_density.shape.
+0000ab50: 2020 2020 6173 7365 7274 2073 756d 5f64      assert sum_d
+0000ab60: 656e 7369 7479 2e73 6861 7065 203d 3d20  ensity.shape == 
+0000ab70: 6f6e 6562 6f64 795f 7375 6d5f 6465 6e73  onebody_sum_dens
+0000ab80: 6974 792e 7368 6170 650a 0a20 2020 2023  ity.shape..    #
+0000ab90: 2054 4f44 4f3a 2063 6865 636b 2071 7561   TODO: check qua
+0000aba0: 6472 6174 7572 6520 616c 736f 2066 6f72  drature also for
+0000abb0: 206b 726f 6e72 6f64 206c 696b 6520 7275   kronrod like ru
+0000abc0: 6c65 730a 0a20 2020 2023 2067 6574 2061  les..    # get a
+0000abd0: 6c6c 206b 6579 730a 2020 2020 6b65 7973  ll keys.    keys
+0000abe0: 203d 2073 7461 7465 2e67 6574 5f6b 6579   = state.get_key
+0000abf0: 7328 290a 2020 2020 6173 7365 7274 2069  s().    assert i
+0000ac00: 7369 6e73 7461 6e63 6528 6b65 7973 2c20  sinstance(keys, 
+0000ac10: 6c69 7374 290a 2020 2020 6173 7365 7274  list).    assert
+0000ac20: 206c 656e 286b 6579 7329 203d 3d20 6c65   len(keys) == le
+0000ac30: 6e28 7461 736b 7329 0a20 2020 2061 7373  n(tasks).    ass
+0000ac40: 6572 7420 6e70 2e61 7272 6179 285b 6973  ert np.array([is
+0000ac50: 696e 7374 616e 6365 2878 2c20 696e 7429  instance(x, int)
+0000ac60: 2066 6f72 2078 2069 6e20 6b65 7973 5d29   for x in keys])
+0000ac70: 2e61 6c6c 2829 0a0a 2020 2020 2320 6765  .all()..    # ge
+0000ac80: 7420 6120 6e65 7720 6672 6565 206b 6579  t a new free key
+0000ac90: 0a20 2020 206b 6579 203d 2073 7461 7465  .    key = state
+0000aca0: 2e67 6574 5f66 7265 655f 6b65 7928 290a  .get_free_key().
+0000acb0: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0000acc0: 7461 6e63 6528 6b65 792c 2069 6e74 290a  tance(key, int).
+0000acd0: 2020 2020 6173 7365 7274 206b 6579 206e      assert key n
+0000ace0: 6f74 2069 6e20 7374 6174 652e 6765 745f  ot in state.get_
+0000acf0: 6b65 7973 2829 0a0a 2020 2020 2320 6164  keys()..    # ad
+0000ad00: 6420 6120 6e65 7720 6f6e 6562 6f64 7920  d a new onebody 
+0000ad10: 7374 6174 650a 2020 2020 636c 6173 7320  state.    class 
+0000ad20: 5461 736b 3a0a 2020 2020 2020 2020 7765  Task:.        we
+0000ad30: 6967 6874 203d 2030 2e35 0a20 2020 2074  ight = 0.5.    t
+0000ad40: 6173 6b20 3d20 5461 736b 2829 0a20 2020  ask = Task().   
+0000ad50: 2070 7369 203d 206f 6e65 626f 6479 2e53   psi = onebody.S
+0000ad60: 6361 7474 6572 696e 6753 7461 7465 7328  catteringStates(
+0000ad70: 7379 7374 2c20 6c65 6164 3d30 2c20 656e  syst, lead=0, en
+0000ad80: 6572 6779 3d32 2e34 2c20 746d 6178 3d74  ergy=2.4, tmax=t
+0000ad90: 6d61 782c 2070 6172 616d 733d 7061 7261  max, params=para
+0000ada0: 6d73 295b 305d 0a20 2020 2023 2070 7269  ms)[0].    # pri
+0000adb0: 6e74 286c 656e 2874 6173 6b73 2929 0a20  nt(len(tasks)). 
+0000adc0: 2020 2023 2070 7269 6e74 286c 656e 2873     # print(len(s
+0000add0: 7461 7465 2e67 6574 5f6b 6579 7328 2929  tate.get_keys())
+0000ade0: 290a 2020 2020 6e65 775f 6b65 7920 3d20  ).    new_key = 
+0000adf0: 7374 6174 652e 6164 645f 6f6e 6562 6f64  state.add_onebod
+0000ae00: 795f 7374 6174 6528 7374 6174 653d 7073  y_state(state=ps
+0000ae10: 692c 2074 6173 6b3d 7461 736b 290a 2020  i, task=task).  
+0000ae20: 2020 2320 7072 696e 7428 6c65 6e28 7461    # print(len(ta
+0000ae30: 736b 7329 290a 2020 2020 2320 7072 696e  sks)).    # prin
+0000ae40: 7428 6c65 6e28 7374 6174 652e 6765 745f  t(len(state.get_
+0000ae50: 6b65 7973 2829 2929 2023 2074 6865 7265  keys())) # there
+0000ae60: 2069 7320 6120 7072 6f62 6c65 6d20 7769   is a problem wi
+0000ae70: 7468 2074 6865 206c 656e 6774 6820 6f66  th the length of
+0000ae80: 2074 6173 6b73 0a20 2020 2023 2054 4f44   tasks.    # TOD
+0000ae90: 4f3a 2073 686f 756c 6420 7765 206d 616b  O: should we mak
+0000aea0: 6520 6120 6465 6570 2063 6f70 7920 6f66  e a deep copy of
+0000aeb0: 2074 6865 2074 6173 6b73 2064 6963 740a   the tasks dict.
+0000aec0: 0a20 2020 2023 2061 6464 2073 6576 6572  .    # add sever
+0000aed0: 616c 2073 7461 7465 7320 6173 2061 2064  al states as a d
+0000aee0: 6963 740a 2020 2020 6e65 775f 7461 736b  ict.    new_task
+0000aef0: 7320 3d20 6d61 6e79 626f 6479 2e63 616c  s = manybody.cal
+0000af00: 635f 7461 736b 7328 696e 7465 7276 616c  c_tasks(interval
+0000af10: 732c 2073 7065 6374 7275 6d2c 206f 6363  s, spectrum, occ
+0000af20: 7570 6174 696f 6e2c 206b 6579 733d 6974  upation, keys=it
+0000af30: 6572 746f 6f6c 732e 636f 756e 7428 3530  ertools.count(50
+0000af40: 2929 0a20 2020 206e 6577 5f70 7369 203d  )).    new_psi =
+0000af50: 206d 616e 7962 6f64 792e 6361 6c63 5f69   manybody.calc_i
+0000af60: 6e69 7469 616c 5f73 7461 7465 2873 7973  nitial_state(sys
+0000af70: 742c 206e 6577 5f74 6173 6b73 2c20 626f  t, new_tasks, bo
+0000af80: 756e 6461 7269 6573 2c20 7061 7261 6d73  undaries, params
+0000af90: 3d70 6172 616d 7329 0a20 2020 206f 6c64  =params).    old
+0000afa0: 5f6b 6579 7320 3d20 7374 6174 652e 6765  _keys = state.ge
+0000afb0: 745f 6b65 7973 2829 0a20 2020 2073 7461  t_keys().    sta
+0000afc0: 7465 2e61 6464 5f64 6973 7472 6962 7574  te.add_distribut
+0000afd0: 6564 5f6f 6e65 626f 6479 5f73 7461 7465  ed_onebody_state
+0000afe0: 7328 7374 6174 6573 3d6e 6577 5f70 7369  s(states=new_psi
+0000aff0: 2c20 7461 736b 733d 6e65 775f 7461 736b  , tasks=new_task
+0000b000: 7329 0a20 2020 2061 7373 6572 7420 6c65  s).    assert le
+0000b010: 6e28 7374 6174 652e 6765 745f 6b65 7973  n(state.get_keys
+0000b020: 2829 2920 3d3d 206c 656e 286f 6c64 5f6b  ()) == len(old_k
+0000b030: 6579 7329 202b 206c 656e 286e 6577 5f74  eys) + len(new_t
+0000b040: 6173 6b73 290a 2020 2020 2320 544f 444f  asks).    # TODO
+0000b050: 3a20 6d61 7962 6520 7468 726f 7720 616e  : maybe throw an
+0000b060: 2065 7272 6f72 2069 6620 6b65 7973 2061   error if keys a
+0000b070: 6c72 6561 6479 2070 7265 7365 6e74 2c20  lready present, 
+0000b080: 6f72 2061 7420 6c65 6173 7420 7769 7468  or at least with
+0000b090: 2066 6c61 670a 0a20 2020 2023 2061 6464   flag..    # add
+0000b0a0: 2061 2073 7461 7465 2077 6974 6820 7573   a state with us
+0000b0b0: 6572 2070 726f 7669 6465 6420 6b65 790a  er provided key.
+0000b0c0: 2020 2020 6d79 5f6e 6577 5f6b 6579 203d      my_new_key =
+0000b0d0: 2038 300a 2020 2020 6e65 775f 6b65 7920   80.    new_key 
+0000b0e0: 3d20 7374 6174 652e 6164 645f 6f6e 6562  = state.add_oneb
+0000b0f0: 6f64 795f 7374 6174 6528 7374 6174 653d  ody_state(state=
+0000b100: 7073 692c 2074 6173 6b3d 7461 736b 2c20  psi, task=task, 
+0000b110: 6b65 793d 6d79 5f6e 6577 5f6b 6579 290a  key=my_new_key).
+0000b120: 2020 2020 6173 7365 7274 206e 6577 5f6b      assert new_k
+0000b130: 6579 203d 3d20 6d79 5f6e 6577 5f6b 6579  ey == my_new_key
+0000b140: 0a20 2020 2023 2074 7279 2074 6f20 6164  .    # try to ad
+0000b150: 6420 7477 6963 6520 7769 7468 2074 6865  d twice with the
+0000b160: 2073 616d 6520 6b65 790a 2020 2020 7261   same key.    ra
+0000b170: 6973 6573 2856 616c 7565 4572 726f 722c  ises(ValueError,
+0000b180: 2073 7461 7465 2e61 6464 5f6f 6e65 626f   state.add_onebo
+0000b190: 6479 5f73 7461 7465 2c20 7374 6174 653d  dy_state, state=
+0000b1a0: 7073 692c 2074 6173 6b3d 7461 736b 2c20  psi, task=task, 
+0000b1b0: 6b65 793d 6d79 5f6e 6577 5f6b 6579 290a  key=my_new_key).
+0000b1c0: 0a20 2020 2023 2072 6574 7269 6576 6520  .    # retrieve 
+0000b1d0: 6120 6f6e 6562 6f64 7920 7374 6174 650a  a onebody state.
+0000b1e0: 2020 2020 6b65 7920 3d20 310a 2020 2020      key = 1.    
+0000b1f0: 7073 695f 7265 7472 6965 7665 6420 3d20  psi_retrieved = 
+0000b200: 7374 6174 652e 6765 745f 6f6e 6562 6f64  state.get_onebod
+0000b210: 795f 7374 6174 6528 6b65 793d 6b65 7929  y_state(key=key)
+0000b220: 0a20 2020 2061 7373 6572 7420 6973 696e  .    assert isin
+0000b230: 7374 616e 6365 2870 7369 5f72 6574 7269  stance(psi_retri
+0000b240: 6576 6564 2c20 6f6e 6562 6f64 792e 5761  eved, onebody.Wa
+0000b250: 7665 4675 6e63 7469 6f6e 290a 2020 2020  veFunction).    
+0000b260: 6173 7365 7274 2070 7369 5f72 6574 7269  assert psi_retri
+0000b270: 6576 6564 2e65 6e65 7267 7920 3d3d 2074  eved.energy == t
+0000b280: 6173 6b73 5b6b 6579 5d2e 656e 6572 6779  asks[key].energy
+0000b290: 0a20 2020 2023 2074 7279 2074 6f20 6765  .    # try to ge
+0000b2a0: 7420 6120 7374 6174 6520 7468 6174 2064  t a state that d
+0000b2b0: 6f65 7320 6e6f 7420 6578 6973 740a 2020  oes not exist.  
+0000b2c0: 2020 6e65 775f 6b65 7920 3d20 7374 6174    new_key = stat
+0000b2d0: 652e 6765 745f 6672 6565 5f6b 6579 2829  e.get_free_key()
+0000b2e0: 0a20 2020 2072 6169 7365 7328 5661 6c75  .    raises(Valu
+0000b2f0: 6545 7272 6f72 2c20 7374 6174 652e 6765  eError, state.ge
+0000b300: 745f 6f6e 6562 6f64 795f 7374 6174 652c  t_onebody_state,
+0000b310: 206b 6579 3d6e 6577 5f6b 6579 290a 0a20   key=new_key).. 
+0000b320: 2020 2023 2064 656c 6574 6520 6120 6f6e     # delete a on
+0000b330: 6562 6f64 7920 7374 6174 650a 2020 2020  ebody state.    
+0000b340: 6b65 7920 3d20 340a 2020 2020 6b65 7973  key = 4.    keys
+0000b350: 203d 2073 7461 7465 2e67 6574 5f6b 6579   = state.get_key
+0000b360: 7328 290a 2020 2020 6173 7365 7274 206b  s().    assert k
+0000b370: 6579 2069 6e20 6b65 7973 0a20 2020 2073  ey in keys.    s
+0000b380: 7461 7465 2e64 656c 6574 655f 6f6e 6562  tate.delete_oneb
+0000b390: 6f64 795f 7374 6174 6528 6b65 793d 6b65  ody_state(key=ke
+0000b3a0: 7929 0a20 2020 2061 7373 6572 7420 6b65  y).    assert ke
+0000b3b0: 7920 6e6f 7420 696e 2073 7461 7465 2e67  y not in state.g
+0000b3c0: 6574 5f6b 6579 7328 290a 2020 2020 7261  et_keys().    ra
+0000b3d0: 6973 6573 2856 616c 7565 4572 726f 722c  ises(ValueError,
+0000b3e0: 2073 7461 7465 2e64 656c 6574 655f 6f6e   state.delete_on
+0000b3f0: 6562 6f64 795f 7374 6174 652c 206b 6579  ebody_state, key
+0000b400: 2920 2023 2054 4f44 4f3a 2073 686f 756c  )  # TODO: shoul
+0000b410: 6420 7765 2072 6169 7365 2061 206b 6579  d we raise a key
+0000b420: 2065 7272 6f72 2068 6572 653f 0a20 2020   error here?.   
+0000b430: 2061 7373 6572 7420 6c65 6e28 7374 6174   assert len(stat
+0000b440: 652e 6765 745f 6b65 7973 2829 2920 3d3d  e.get_keys()) ==
+0000b450: 206c 656e 286b 6579 7329 202d 2031 0a0a   len(keys) - 1..
+0000b460: 2020 2020 2320 6576 616c 7561 7465 2061      # evaluate a
+0000b470: 6e20 6f70 6572 6174 6f72 206f 6e6c 7920  n operator only 
+0000b480: 6f6e 2061 2073 7562 7365 7420 6f66 2077  on a subset of w
+0000b490: 6176 6566 756e 6374 696f 6e73 0a20 2020  avefunctions.   
+0000b4a0: 2073 7461 7465 2e65 766f 6c76 6528 7469   state.evolve(ti
+0000b4b0: 6d65 3d31 3029 0a20 2020 2064 656e 7369  me=10).    densi
+0000b4c0: 7479 203d 2073 7461 7465 2e65 7661 6c75  ty = state.evalu
+0000b4d0: 6174 6528 6465 6e73 6974 795f 6f70 6572  ate(density_oper
+0000b4e0: 6174 6f72 290a 2020 2020 6576 656e 5f6b  ator).    even_k
+0000b4f0: 6579 7320 3d20 5b6b 6579 2066 6f72 206b  eys = [key for k
+0000b500: 6579 2069 6e20 7374 6174 652e 6765 745f  ey in state.get_
+0000b510: 6b65 7973 2829 2069 6620 6e6f 7420 6b65  keys() if not ke
+0000b520: 7920 2520 325d 0a20 2020 206f 6464 5f6b  y % 2].    odd_k
+0000b530: 6579 7320 3d20 5b6b 6579 2066 6f72 206b  eys = [key for k
+0000b540: 6579 2069 6e20 7374 6174 652e 6765 745f  ey in state.get_
+0000b550: 6b65 7973 2829 2069 6620 6b65 7920 2520  keys() if key % 
+0000b560: 325d 0a0a 2020 2020 6465 6e73 5f65 7665  2]..    dens_eve
+0000b570: 6e20 3d20 7374 6174 652e 5f63 616c 635f  n = state._calc_
+0000b580: 6578 7065 6374 6174 696f 6e5f 7661 6c75  expectation_valu
+0000b590: 6528 6465 6e73 6974 795f 6f70 6572 6174  e(density_operat
+0000b5a0: 6f72 2c20 6b65 7973 3d65 7665 6e5f 6b65  or, keys=even_ke
+0000b5b0: 7973 290a 2020 2020 6465 6e73 5f6f 6464  ys).    dens_odd
+0000b5c0: 203d 2073 7461 7465 2e5f 6361 6c63 5f65   = state._calc_e
+0000b5d0: 7870 6563 7461 7469 6f6e 5f76 616c 7565  xpectation_value
+0000b5e0: 2864 656e 7369 7479 5f6f 7065 7261 746f  (density_operato
+0000b5f0: 722c 206b 6579 733d 6f64 645f 6b65 7973  r, keys=odd_keys
+0000b600: 290a 2020 2020 6465 6e73 203d 2073 7461  ).    dens = sta
+0000b610: 7465 2e5f 6361 6c63 5f65 7870 6563 7461  te._calc_expecta
+0000b620: 7469 6f6e 5f76 616c 7565 2864 656e 7369  tion_value(densi
+0000b630: 7479 5f6f 7065 7261 746f 7229 0a20 2020  ty_operator).   
+0000b640: 2061 7373 6572 745f 6172 7261 795f 616c   assert_array_al
+0000b650: 6d6f 7374 5f65 7175 616c 2864 656e 735f  most_equal(dens_
+0000b660: 6576 656e 202b 2064 656e 735f 6f64 642c  even + dens_odd,
+0000b670: 2064 656e 7329 0a20 2020 2061 7373 6572   dens).    asser
+0000b680: 745f 6172 7261 795f 616c 6d6f 7374 5f65  t_array_almost_e
+0000b690: 7175 616c 2864 656e 732c 2064 656e 7369  qual(dens, densi
+0000b6a0: 7479 290a 0a20 2020 2023 2067 6574 2074  ty)..    # get t
+0000b6b0: 6865 2073 6861 7065 206f 6620 7468 6520  he shape of the 
+0000b6c0: 7765 6967 6874 696e 6720 6661 6374 6f72  weighting factor
+0000b6d0: 0a20 2020 2061 7373 6572 7420 7374 6174  .    assert stat
+0000b6e0: 652e 7765 6967 6874 5f73 6861 7065 2829  e.weight_shape()
+0000b6f0: 203d 3d20 7461 736b 735b 305d 2e77 6569   == tasks[0].wei
+0000b700: 6768 742e 7368 6170 650a 0a20 2020 2023  ght.shape..    #
+0000b710: 2063 6865 636b 2063 6f6e 7369 7374 656e   check consisten
+0000b720: 6379 0a20 2020 2061 7373 6572 7420 7374  cy.    assert st
+0000b730: 6174 652e 5f63 6865 636b 5f63 6f6e 7369  ate._check_consi
+0000b740: 7374 656e 6379 2829 0a20 2020 2064 656c  stency().    del
+0000b750: 2073 7461 7465 2e74 6173 6b73 5b35 5d20   state.tasks[5] 
+0000b760: 2023 206d 616b 6520 7374 6174 6520 696e   # make state in
+0000b770: 636f 6e73 6973 7465 6e74 0a20 2020 2061  consistent.    a
+0000b780: 7373 6572 7420 7374 6174 652e 5f63 6865  ssert state._che
+0000b790: 636b 5f63 6f6e 7369 7374 656e 6379 2829  ck_consistency()
+0000b7a0: 2069 7320 4661 6c73 650a 0a20 2020 2023   is False..    #
+0000b7b0: 2063 6865 636b 2077 6176 6566 756e 6374   check wavefunct
+0000b7c0: 696f 6e20 7769 7468 2074 6865 2067 6175  ion with the gau
+0000b7d0: 7373 2d6b 726f 6e72 6f64 2071 7561 6472  ss-kronrod quadr
+0000b7e0: 6174 7572 650a 2020 2020 666f 7220 696e  ature.    for in
+0000b7f0: 7465 7276 616c 2069 6e20 696e 7465 7276  terval in interv
+0000b800: 616c 733a 0a20 2020 2020 2020 2069 6e74  als:.        int
+0000b810: 6572 7661 6c2e 7175 6164 7261 7475 7265  erval.quadrature
+0000b820: 203d 2027 6b72 6f6e 726f 6427 0a20 2020   = 'kronrod'.   
+0000b830: 2074 6173 6b73 203d 206d 616e 7962 6f64   tasks = manybod
+0000b840: 792e 6361 6c63 5f74 6173 6b73 2869 6e74  y.calc_tasks(int
+0000b850: 6572 7661 6c73 2c20 7370 6563 7472 756d  ervals, spectrum
+0000b860: 2c20 6f63 6375 7061 7469 6f6e 290a 2020  , occupation).  
+0000b870: 2020 626f 756e 6461 7269 6573 203d 206c    boundaries = l
+0000b880: 6561 6473 2e61 7574 6f6d 6174 6963 5f62  eads.automatic_b
+0000b890: 6f75 6e64 6172 7928 7370 6563 7472 756d  oundary(spectrum
+0000b8a0: 2c20 746d 6178 290a 2020 2020 7073 695f  , tmax).    psi_
+0000b8b0: 696e 6974 203d 206d 616e 7962 6f64 792e  init = manybody.
+0000b8c0: 6361 6c63 5f69 6e69 7469 616c 5f73 7461  calc_initial_sta
+0000b8d0: 7465 2873 7973 742c 2074 6173 6b73 2c20  te(syst, tasks, 
+0000b8e0: 626f 756e 6461 7269 6573 2c0a 2020 2020  boundaries,.    
+0000b8f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b910: 2020 2020 2020 2070 6172 616d 733d 7061         params=pa
+0000b920: 7261 6d73 290a 0a20 2020 2073 7461 7465  rams)..    state
+0000b930: 203d 206d 616e 7962 6f64 792e 5761 7665   = manybody.Wave
+0000b940: 4675 6e63 7469 6f6e 2870 7369 5f69 6e69  Function(psi_ini
+0000b950: 742c 2074 6173 6b73 290a 2020 2020 7374  t, tasks).    st
+0000b960: 6174 652e 6576 6f6c 7665 2874 696d 6529  ate.evolve(time)
+0000b970: 0a0a 2020 2020 2320 6368 6563 6b20 7265  ..    # check re
+0000b980: 7475 726e 2074 7970 652c 2077 6520 6578  turn type, we ex
+0000b990: 7065 6374 2061 6e20 6172 7261 7920 7275  pect an array ru
+0000b9a0: 6e6e 696e 6720 6f76 6572 2061 6c6c 2073  nning over all s
+0000b9b0: 6974 6573 206f 7220 6a75 7374 2061 2073  ites or just a s
+0000b9c0: 696e 676c 6520 6e75 6d62 6572 0a20 2020  ingle number.   
+0000b9d0: 2064 656e 7369 7479 203d 2073 7461 7465   density = state
+0000b9e0: 2e65 7661 6c75 6174 6528 6465 6e73 6974  .evaluate(densit
+0000b9f0: 795f 6f70 6572 6174 6f72 290a 2020 2020  y_operator).    
+0000ba00: 7375 6d5f 6465 6e73 6974 7920 3d20 7374  sum_density = st
+0000ba10: 6174 652e 6576 616c 7561 7465 2873 756d  ate.evaluate(sum
+0000ba20: 5f64 656e 7369 7479 5f6f 7065 7261 746f  _density_operato
+0000ba30: 7229 0a0a 2020 2020 6173 7365 7274 2069  r)..    assert i
+0000ba40: 7369 6e73 7461 6e63 6528 6465 6e73 6974  sinstance(densit
+0000ba50: 792c 206e 702e 6e64 6172 7261 7929 0a20  y, np.ndarray). 
+0000ba60: 2020 2061 7373 6572 7420 6465 6e73 6974     assert densit
+0000ba70: 792e 7368 6170 6520 3d3d 2028 322c 206c  y.shape == (2, l
+0000ba80: 656e 2873 7973 742e 7369 7465 7329 290a  en(syst.sites)).
+0000ba90: 2020 2020 6173 7365 7274 2069 7369 6e73      assert isins
+0000baa0: 7461 6e63 6528 7375 6d5f 6465 6e73 6974  tance(sum_densit
+0000bab0: 792c 206e 702e 6e64 6172 7261 7929 0a20  y, np.ndarray). 
+0000bac0: 2020 2061 7373 6572 7420 7375 6d5f 6465     assert sum_de
+0000bad0: 6e73 6974 792e 7368 6170 6520 3d3d 2028  nsity.shape == (
+0000bae0: 322c 290a 0a20 2020 2023 2063 6865 636b  2,)..    # check
+0000baf0: 2074 6861 7420 6966 2077 6520 6164 6420   that if we add 
+0000bb00: 6120 7374 6174 6520 7769 7468 2061 2077  a state with a w
+0000bb10: 6569 6768 7420 7368 6170 6520 6d69 736d  eight shape mism
+0000bb20: 6174 6368 2c20 7468 6174 2069 7420 6372  atch, that it cr
+0000bb30: 6173 6865 730a 2020 2020 2320 544f 444f  ashes.    # TODO
+0000bb40: 3a20 7468 6973 2073 686f 756c 6420 6661  : this should fa
+0000bb50: 696c 2c20 6d61 7962 6520 6f6e 6520 7368  il, maybe one sh
+0000bb60: 6f75 6c64 2067 6976 6520 6120 636c 6561  ould give a clea
+0000bb70: 7220 6572 726f 7220 6d65 7373 6167 6520  r error message 
+0000bb80: 616e 6420 6368 6563 6b20 666f 7220 7468  and check for th
+0000bb90: 6174 2063 6173 650a 2020 2020 636c 6173  at case.    clas
+0000bba0: 7320 5461 736b 3a0a 2020 2020 2020 2020  s Task:.        
+0000bbb0: 7765 6967 6874 203d 2030 2e35 2020 2320  weight = 0.5  # 
+0000bbc0: 6e6f 7420 636f 6d70 6174 6962 6c65 2074  not compatible t
+0000bbd0: 6f20 6b72 6f6e 726f 6420 7765 6967 6874  o kronrod weight
+0000bbe0: 2061 7272 6179 0a20 2020 2074 6173 6b20   array.    task 
+0000bbf0: 3d20 5461 736b 2829 0a20 2020 2070 7369  = Task().    psi
+0000bc00: 203d 206f 6e65 626f 6479 2e53 6361 7474   = onebody.Scatt
+0000bc10: 6572 696e 6753 7461 7465 7328 7379 7374  eringStates(syst
+0000bc20: 2c20 6c65 6164 3d30 2c20 656e 6572 6779  , lead=0, energy
+0000bc30: 3d32 2e34 2c20 746d 6178 3d74 6d61 782c  =2.4, tmax=tmax,
+0000bc40: 2070 6172 616d 733d 7061 7261 6d73 295b   params=params)[
+0000bc50: 305d 0a20 2020 206e 6577 5f6b 6579 203d  0].    new_key =
+0000bc60: 2073 7461 7465 2e61 6464 5f6f 6e65 626f   state.add_onebo
+0000bc70: 6479 5f73 7461 7465 2873 7461 7465 3d70  dy_state(state=p
+0000bc80: 7369 2c20 7461 736b 3d74 6173 6b29 0a20  si, task=task). 
+0000bc90: 2020 2064 656e 7369 7479 203d 2073 7461     density = sta
+0000bca0: 7465 2e65 7661 6c75 6174 6528 6465 6e73  te.evaluate(dens
+0000bcb0: 6974 795f 6f70 6572 6174 6f72 290a 0a0a  ity_operator)...
+0000bcc0: 4070 7974 6573 742e 6d61 726b 2e69 6e74  @pytest.mark.int
+0000bcd0: 6567 7465 7374 0a64 6566 2074 6573 745f  egtest.def test_
+0000bce0: 6d61 6e79 626f 6479 5f6e 6f72 6d61 6c69  manybody_normali
+0000bcf0: 7a61 7469 6f6e 2829 3a0a 0a20 2020 2023  zation():..    #
+0000bd00: 2069 6e74 6567 7261 7469 6e67 206f 7665   integrating ove
+0000bd10: 7220 616c 6c20 656e 6572 6769 6573 2061  r all energies a
+0000bd20: 6e64 206c 6561 6473 2c20 7468 6520 6465  nd leads, the de
+0000bd30: 6e73 6974 790a 2020 2020 2320 7368 6f75  nsity.    # shou
+0000bd40: 6c64 2062 6520 3120 6f6e 2061 6c6c 2073  ld be 1 on all s
+0000bd50: 6974 6573 2061 6e64 2066 6f72 2061 6c6c  ites and for all
+0000bd60: 2074 696d 6573 0a0a 2020 2020 7379 7374   times..    syst
+0000bd70: 203d 206d 616b 655f 7379 7374 656d 2857   = make_system(W
+0000bd80: 3d33 292e 6669 6e61 6c69 7a65 6428 290a  =3).finalized().
+0000bd90: 2020 2020 6465 6e73 6974 795f 6f70 6572      density_oper
+0000bda0: 6174 6f72 203d 206b 7761 6e74 2e6f 7065  ator = kwant.ope
+0000bdb0: 7261 746f 722e 4465 6e73 6974 7928 7379  rator.Density(sy
+0000bdc0: 7374 290a 0a20 2020 2063 6865 6d69 6361  st)..    chemica
+0000bdd0: 6c5f 706f 7465 6e74 6961 6c20 3d20 3130  l_potential = 10
+0000bde0: 3020 2023 2073 6f6d 6520 7661 6c75 6520  0  # some value 
+0000bdf0: 6c61 7267 6572 2074 6861 6e20 616e 7920  larger than any 
+0000be00: 6261 6e64 2065 6e65 7267 790a 2020 2020  band energy.    
+0000be10: 746d 6178 203d 2031 300a 2020 2020 7061  tmax = 10.    pa
+0000be20: 7261 6d73 203d 207b 2776 273a 2030 2e30  rams = {'v': 0.0
+0000be30: 3030 312c 2027 7430 273a 2030 2c20 2741  001, 't0': 0, 'A
+0000be40: 273a 2030 2e30 3031 3537 2c20 2773 6967  ': 0.00157, 'sig
+0000be50: 6d61 273a 2032 347d 0a0a 2020 2020 6f63  ma': 24}..    oc
+0000be60: 6375 7061 7469 6f6e 203d 206d 616e 7962  cupation = manyb
+0000be70: 6f64 792e 6c65 6164 5f6f 6363 7570 6174  ody.lead_occupat
+0000be80: 696f 6e28 6368 656d 6963 616c 5f70 6f74  ion(chemical_pot
+0000be90: 656e 7469 616c 290a 0a20 2020 2073 7065  ential)..    spe
+0000bea0: 6374 7275 6d20 3d20 6b77 616e 7473 7065  ctrum = kwantspe
+0000beb0: 6374 7275 6d2e 7370 6563 7472 6128 7379  ctrum.spectra(sy
+0000bec0: 7374 2e6c 6561 6473 290a 2020 2020 696e  st.leads).    in
+0000bed0: 7465 7276 616c 7320 3d20 6d61 6e79 626f  tervals = manybo
+0000bee0: 6479 2e63 616c 635f 696e 7465 7276 616c  dy.calc_interval
+0000bef0: 7328 7370 6563 7472 756d 2c20 6f63 6375  s(spectrum, occu
+0000bf00: 7061 7469 6f6e 290a 2020 2020 7461 736b  pation).    task
+0000bf10: 7320 3d20 6d61 6e79 626f 6479 2e63 616c  s = manybody.cal
+0000bf20: 635f 7461 736b 7328 696e 7465 7276 616c  c_tasks(interval
+0000bf30: 732c 2073 7065 6374 7275 6d2c 206f 6363  s, spectrum, occ
+0000bf40: 7570 6174 696f 6e29 0a20 2020 2062 6f75  upation).    bou
+0000bf50: 6e64 6172 6965 7320 3d20 6c65 6164 732e  ndaries = leads.
+0000bf60: 6175 746f 6d61 7469 635f 626f 756e 6461  automatic_bounda
+0000bf70: 7279 2873 7065 6374 7275 6d2c 2074 6d61  ry(spectrum, tma
+0000bf80: 7829 0a20 2020 2070 7369 5f69 6e69 7420  x).    psi_init 
+0000bf90: 3d20 6d61 6e79 626f 6479 2e63 616c 635f  = manybody.calc_
+0000bfa0: 696e 6974 6961 6c5f 7374 6174 6528 7379  initial_state(sy
+0000bfb0: 7374 2c20 7461 736b 732c 2062 6f75 6e64  st, tasks, bound
+0000bfc0: 6172 6965 732c 2070 6172 616d 733d 7061  aries, params=pa
+0000bfd0: 7261 6d73 290a 2020 2020 7766 203d 206d  rams).    wf = m
+0000bfe0: 616e 7962 6f64 792e 5761 7665 4675 6e63  anybody.WaveFunc
+0000bff0: 7469 6f6e 2870 7369 5f69 6e69 742c 2074  tion(psi_init, t
+0000c000: 6173 6b73 290a 0a20 2020 2066 6f72 2074  asks)..    for t
+0000c010: 696d 6520 696e 205b 302c 2035 2c20 3130  ime in [0, 5, 10
+0000c020: 5d3a 0a20 2020 2020 2020 2077 662e 6576  ]:.        wf.ev
+0000c030: 6f6c 7665 2874 696d 6529 0a20 2020 2020  olve(time).     
+0000c040: 2020 2064 656e 7369 7479 203d 2077 662e     density = wf.
+0000c050: 6576 616c 7561 7465 2864 656e 7369 7479  evaluate(density
+0000c060: 5f6f 7065 7261 746f 7229 0a20 2020 2020  _operator).     
+0000c070: 2020 2061 7373 6572 745f 6172 7261 795f     assert_array_
+0000c080: 616c 6d6f 7374 5f65 7175 616c 2864 656e  almost_equal(den
+0000c090: 7369 7479 2c20 312c 2064 6563 696d 616c  sity, 1, decimal
+0000c0a0: 3d32 290a 0a0a 4070 7974 6573 742e 6d61  =2)...@pytest.ma
+0000c0b0: 726b 2e69 6e74 6567 7465 7374 0a64 6566  rk.integtest.def
+0000c0c0: 2074 6573 745f 7369 6d70 6c65 5f6d 616e   test_simple_man
+0000c0d0: 7962 6f64 795f 7265 6772 6573 7369 6f6e  ybody_regression
+0000c0e0: 2829 3a0a 0a20 2020 2023 2061 2073 696d  ():..    # a sim
+0000c0f0: 706c 6520 7265 6772 6573 7369 6f6e 2074  ple regression t
+0000c100: 6573 7420 746f 206d 616b 6520 7375 7265  est to make sure
+0000c110: 2074 6861 7420 7468 6520 7265 7375 6c74   that the result
+0000c120: 2064 6f65 7320 6e6f 7420 6368 616e 6765   does not change
+0000c130: 0a20 2020 2023 206f 7665 7220 7468 6520  .    # over the 
+0000c140: 7469 6d65 0a0a 2020 2020 7379 7374 203d  time..    syst =
+0000c150: 206d 616b 655f 7379 7374 656d 2857 3d33   make_system(W=3
+0000c160: 292e 6669 6e61 6c69 7a65 6428 290a 2020  ).finalized().  
+0000c170: 2020 6465 6e73 6974 795f 6f70 6572 6174    density_operat
+0000c180: 6f72 203d 206b 7761 6e74 2e6f 7065 7261  or = kwant.opera
+0000c190: 746f 722e 4465 6e73 6974 7928 7379 7374  tor.Density(syst
+0000c1a0: 2c20 7375 6d3d 5472 7565 290a 0a20 2020  , sum=True)..   
+0000c1b0: 2063 6865 6d69 6361 6c5f 706f 7465 6e74   chemical_potent
+0000c1c0: 6961 6c20 3d20 350a 2020 2020 746d 6178  ial = 5.    tmax
+0000c1d0: 203d 2032 300a 2020 2020 7061 7261 6d73   = 20.    params
+0000c1e0: 203d 207b 2776 273a 2030 2e31 2c20 2774   = {'v': 0.1, 't
+0000c1f0: 3027 3a20 302c 2027 4127 3a20 302e 3135  0': 0, 'A': 0.15
+0000c200: 372c 2027 7369 676d 6127 3a20 3234 7d0a  7, 'sigma': 24}.
+0000c210: 0a20 2020 206f 6363 7570 6174 696f 6e20  .    occupation 
+0000c220: 3d20 6d61 6e79 626f 6479 2e6c 6561 645f  = manybody.lead_
+0000c230: 6f63 6375 7061 7469 6f6e 2863 6865 6d69  occupation(chemi
+0000c240: 6361 6c5f 706f 7465 6e74 6961 6c29 0a0a  cal_potential)..
+0000c250: 2020 2020 7370 6563 7472 756d 203d 206b      spectrum = k
+0000c260: 7761 6e74 7370 6563 7472 756d 2e73 7065  wantspectrum.spe
+0000c270: 6374 7261 2873 7973 742e 6c65 6164 7329  ctra(syst.leads)
+0000c280: 0a20 2020 2069 6e74 6572 7661 6c73 203d  .    intervals =
+0000c290: 206d 616e 7962 6f64 792e 6361 6c63 5f69   manybody.calc_i
+0000c2a0: 6e74 6572 7661 6c73 2873 7065 6374 7275  ntervals(spectru
+0000c2b0: 6d2c 206f 6363 7570 6174 696f 6e29 0a20  m, occupation). 
+0000c2c0: 2020 2074 6173 6b73 203d 206d 616e 7962     tasks = manyb
+0000c2d0: 6f64 792e 6361 6c63 5f74 6173 6b73 2869  ody.calc_tasks(i
+0000c2e0: 6e74 6572 7661 6c73 2c20 7370 6563 7472  ntervals, spectr
+0000c2f0: 756d 2c20 6f63 6375 7061 7469 6f6e 290a  um, occupation).
+0000c300: 2020 2020 626f 756e 6461 7269 6573 203d      boundaries =
+0000c310: 206c 6561 6473 2e61 7574 6f6d 6174 6963   leads.automatic
+0000c320: 5f62 6f75 6e64 6172 7928 7370 6563 7472  _boundary(spectr
+0000c330: 756d 2c20 746d 6178 290a 2020 2020 7073  um, tmax).    ps
+0000c340: 695f 696e 6974 203d 206d 616e 7962 6f64  i_init = manybod
+0000c350: 792e 6361 6c63 5f69 6e69 7469 616c 5f73  y.calc_initial_s
+0000c360: 7461 7465 2873 7973 742c 2074 6173 6b73  tate(syst, tasks
+0000c370: 2c20 626f 756e 6461 7269 6573 2c20 7061  , boundaries, pa
+0000c380: 7261 6d73 3d70 6172 616d 7329 0a20 2020  rams=params).   
+0000c390: 2077 6620 3d20 6d61 6e79 626f 6479 2e57   wf = manybody.W
+0000c3a0: 6176 6546 756e 6374 696f 6e28 7073 695f  aveFunction(psi_
+0000c3b0: 696e 6974 2c20 7461 736b 7329 0a0a 2020  init, tasks)..  
+0000c3c0: 2020 7265 665f 6465 6e73 6974 6965 7320    ref_densities 
+0000c3d0: 3d20 5b35 332e 3332 3030 3637 3739 3036  = [53.3200677906
+0000c3e0: 3238 3436 342c 2032 342e 3236 3735 3636  28464, 24.267566
+0000c3f0: 3632 3533 3238 3833 362c 2038 312e 3138  625328836, 81.18
+0000c400: 3437 3239 3634 3931 3333 325d 0a20 2020  47296491332].   
+0000c410: 2066 6f72 2069 2c20 7469 6d65 2069 6e20   for i, time in 
+0000c420: 656e 756d 6572 6174 6528 5b30 2c20 3130  enumerate([0, 10
+0000c430: 2c20 3230 5d29 3a0a 2020 2020 2020 2020  , 20]):.        
+0000c440: 7766 2e65 766f 6c76 6528 7469 6d65 290a  wf.evolve(time).
+0000c450: 2020 2020 2020 2020 6465 6e73 6974 7920          density 
+0000c460: 3d20 7766 2e65 7661 6c75 6174 6528 6465  = wf.evaluate(de
+0000c470: 6e73 6974 795f 6f70 6572 6174 6f72 295b  nsity_operator)[
+0000c480: 315d 0a20 2020 2020 2020 2061 7373 6572  1].        asser
+0000c490: 745f 616c 6d6f 7374 5f65 7175 616c 2864  t_almost_equal(d
+0000c4a0: 656e 7369 7479 2c20 7265 665f 6465 6e73  ensity, ref_dens
+0000c4b0: 6974 6965 735b 695d 2c20 6465 6369 6d61  ities[i], decima
+0000c4c0: 6c3d 3329 0a0a 0a23 202d 2d2d 2d20 6368  l=3)...# ---- ch
+0000c4d0: 6563 6b20 7374 6174 650a 4070 7974 6573  eck state.@pytes
+0000c4e0: 742e 6d61 726b 2e69 6e74 6567 7465 7374  t.mark.integtest
+0000c4f0: 2020 2320 6d61 726b 6572 2066 6f72 2069    # marker for i
+0000c500: 6e74 6567 7261 7469 6f6e 2074 6573 7473  ntegration tests
+0000c510: 0a64 6566 2074 6573 745f 6d61 6e79 626f  .def test_manybo
+0000c520: 6479 5f73 7461 7465 2829 3a0a 0a20 2020  dy_state():..   
+0000c530: 2073 7973 7420 3d20 6d61 6b65 5f73 7973   syst = make_sys
+0000c540: 7465 6d28 292e 6669 6e61 6c69 7a65 6428  tem().finalized(
+0000c550: 290a 2020 2020 6465 6e73 6974 795f 6f70  ).    density_op
+0000c560: 6572 6174 6f72 203d 206b 7761 6e74 2e6f  erator = kwant.o
+0000c570: 7065 7261 746f 722e 4465 6e73 6974 7928  perator.Density(
+0000c580: 7379 7374 290a 0a20 2020 2063 6865 6d69  syst)..    chemi
+0000c590: 6361 6c5f 706f 7465 6e74 6961 6c20 3d20  cal_potential = 
+0000c5a0: 330a 2020 2020 746d 6178 203d 2035 3030  3.    tmax = 500
+0000c5b0: 0a20 2020 2074 696d 6520 3d20 350a 2020  .    time = 5.  
+0000c5c0: 2020 7061 7261 6d73 203d 207b 2776 273a    params = {'v':
+0000c5d0: 2030 2e30 3030 312c 2027 7430 273a 2030   0.0001, 't0': 0
+0000c5e0: 2c20 2741 273a 2030 2e30 3031 3537 2c20  , 'A': 0.00157, 
+0000c5f0: 2773 6967 6d61 273a 2032 347d 0a0a 2020  'sigma': 24}..  
+0000c600: 2020 6f63 6375 7061 7469 6f6e 203d 206d    occupation = m
+0000c610: 616e 7962 6f64 792e 6c65 6164 5f6f 6363  anybody.lead_occ
+0000c620: 7570 6174 696f 6e28 6368 656d 6963 616c  upation(chemical
+0000c630: 5f70 6f74 656e 7469 616c 290a 0a20 2020  _potential)..   
+0000c640: 2023 2072 6566 6572 656e 6365 2072 6573   # reference res
+0000c650: 756c 7420 7769 7468 2074 6865 206d 616e  ult with the man
+0000c660: 7962 6f64 7920 7761 7665 6675 6e63 7469  ybody wavefuncti
+0000c670: 6f6e 0a20 2020 2073 7065 6374 7275 6d20  on.    spectrum 
+0000c680: 3d20 6b77 616e 7473 7065 6374 7275 6d2e  = kwantspectrum.
+0000c690: 7370 6563 7472 6128 7379 7374 2e6c 6561  spectra(syst.lea
+0000c6a0: 6473 290a 2020 2020 696e 7465 7276 616c  ds).    interval
+0000c6b0: 7320 3d20 6d61 6e79 626f 6479 2e63 616c  s = manybody.cal
+0000c6c0: 635f 696e 7465 7276 616c 7328 7370 6563  c_intervals(spec
+0000c6d0: 7472 756d 2c20 6f63 6375 7061 7469 6f6e  trum, occupation
+0000c6e0: 290a 2020 2020 7461 736b 7320 3d20 6d61  ).    tasks = ma
+0000c6f0: 6e79 626f 6479 2e63 616c 635f 7461 736b  nybody.calc_task
+0000c700: 7328 696e 7465 7276 616c 732c 2073 7065  s(intervals, spe
+0000c710: 6374 7275 6d2c 206f 6363 7570 6174 696f  ctrum, occupatio
+0000c720: 6e29 0a20 2020 2062 6f75 6e64 6172 6965  n).    boundarie
+0000c730: 7320 3d20 6c65 6164 732e 6175 746f 6d61  s = leads.automa
+0000c740: 7469 635f 626f 756e 6461 7279 2873 7065  tic_boundary(spe
+0000c750: 6374 7275 6d2c 2074 6d61 7829 0a20 2020  ctrum, tmax).   
+0000c760: 2070 7369 5f69 6e69 7420 3d20 6d61 6e79   psi_init = many
+0000c770: 626f 6479 2e63 616c 635f 696e 6974 6961  body.calc_initia
+0000c780: 6c5f 7374 6174 6528 7379 7374 2c20 7461  l_state(syst, ta
+0000c790: 736b 732c 2062 6f75 6e64 6172 6965 732c  sks, boundaries,
+0000c7a0: 2070 6172 616d 733d 7061 7261 6d73 290a   params=params).
+0000c7b0: 2020 2020 7766 203d 206d 616e 7962 6f64      wf = manybod
+0000c7c0: 792e 5761 7665 4675 6e63 7469 6f6e 2870  y.WaveFunction(p
+0000c7d0: 7369 5f69 6e69 742c 2074 6173 6b73 290a  si_init, tasks).
+0000c7e0: 2020 2020 7766 2e65 766f 6c76 6528 7469      wf.evolve(ti
+0000c7f0: 6d65 290a 2020 2020 6465 6e73 6974 795f  me).    density_
+0000c800: 7766 203d 2077 662e 6576 616c 7561 7465  wf = wf.evaluate
+0000c810: 2864 656e 7369 7479 5f6f 7065 7261 746f  (density_operato
+0000c820: 7229 5b31 5d0a 0a20 2020 2023 206d 616e  r)[1]..    # man
+0000c830: 7962 6f64 7920 7374 6174 650a 2020 2020  ybody state.    
+0000c840: 7374 6174 6520 3d20 6d61 6e79 626f 6479  state = manybody
+0000c850: 2e53 7461 7465 2873 7973 742c 2074 6d61  .State(syst, tma
+0000c860: 782c 206f 6363 7570 6174 696f 6e2c 2070  x, occupation, p
+0000c870: 6172 616d 733d 7061 7261 6d73 2c20 7265  arams=params, re
+0000c880: 6669 6e65 3d46 616c 7365 290a 0a20 2020  fine=False)..   
+0000c890: 2073 7461 7465 2e65 766f 6c76 6528 7469   state.evolve(ti
+0000c8a0: 6d65 290a 2020 2020 6173 7365 7274 2073  me).    assert s
+0000c8b0: 7461 7465 2e74 696d 6520 3d3d 2074 696d  tate.time == tim
+0000c8c0: 650a 2020 2020 2320 7468 6520 6d61 6e79  e.    # the many
+0000c8d0: 626f 6479 2073 7461 7465 2068 6173 206e  body state has n
+0000c8e0: 6f20 7075 626c 6963 2070 6172 616d 7320  o public params 
+0000c8f0: 7374 6f72 6564 2c20 6f6e 6c79 2065 6163  stored, only eac
+0000c900: 6820 6f6e 6562 6f64 7920 7374 6174 650a  h onebody state.
+0000c910: 2020 2020 2320 6861 7320 6120 7075 626c      # has a publ
+0000c920: 6963 2070 6172 616d 7320 6469 6374 696f  ic params dictio
+0000c930: 6e61 7279 0a20 2020 2066 6f72 205f 2c20  nary.    for _, 
+0000c940: 7073 6920 696e 2073 7461 7465 2e6d 616e  psi in state.man
+0000c950: 7962 6f64 795f 7761 7665 6675 6e63 7469  ybody_wavefuncti
+0000c960: 6f6e 2e70 7369 2e5f 6461 7461 2e69 7465  on.psi._data.ite
+0000c970: 6d73 2829 3a0a 2020 2020 2020 2020 6173  ms():.        as
+0000c980: 7365 7274 2070 7369 2e74 696d 6520 3d3d  sert psi.time ==
+0000c990: 2074 696d 650a 2020 2020 2020 2020 6173   time.        as
+0000c9a0: 7365 7274 2070 7369 2e70 6172 616d 7320  sert psi.params 
+0000c9b0: 3d3d 207b 2776 273a 2030 2e30 3030 312c  == {'v': 0.0001,
+0000c9c0: 2027 7430 273a 2030 2c20 2741 273a 2030   't0': 0, 'A': 0
+0000c9d0: 2e30 3031 3537 2c20 2773 6967 6d61 273a  .00157, 'sigma':
+0000c9e0: 2032 347d 0a0a 2020 2020 2320 6368 6563   24}..    # chec
+0000c9f0: 6b20 7468 6174 2072 6573 756c 7420 6973  k that result is
+0000ca00: 2073 696d 696c 6172 2074 6f20 7265 6665   similar to refe
+0000ca10: 7265 6e63 6520 7265 7375 6c74 0a20 2020  rence result.   
+0000ca20: 2064 656e 7369 7479 203d 2073 7461 7465   density = state
+0000ca30: 2e65 7661 6c75 6174 6528 6465 6e73 6974  .evaluate(densit
+0000ca40: 795f 6f70 6572 6174 6f72 290a 2020 2020  y_operator).    
+0000ca50: 6173 7365 7274 5f61 7272 6179 5f61 6c6d  assert_array_alm
+0000ca60: 6f73 745f 6571 7561 6c28 6465 6e73 6974  ost_equal(densit
+0000ca70: 792c 2064 656e 7369 7479 5f77 6629 0a0a  y, density_wf)..
+0000ca80: 2020 2020 2320 2d2d 2074 6573 7420 6765      # -- test ge
+0000ca90: 745f 696e 7465 7276 616c 730a 2020 2020  t_intervals.    
+0000caa0: 696e 7465 7276 616c 7320 3d20 7374 6174  intervals = stat
+0000cab0: 652e 6765 745f 696e 7465 7276 616c 7328  e.get_intervals(
+0000cac0: 290a 2020 2020 6173 7365 7274 2069 7369  ).    assert isi
+0000cad0: 6e73 7461 6e63 6528 696e 7465 7276 616c  nstance(interval
+0000cae0: 732c 206c 6973 7429 0a20 2020 2061 7373  s, list).    ass
+0000caf0: 6572 7420 6e70 2e61 7272 6179 285b 6973  ert np.array([is
+0000cb00: 696e 7374 616e 6365 2878 2c20 6d61 6e79  instance(x, many
+0000cb10: 626f 6479 2e49 6e74 6572 7661 6c29 2066  body.Interval) f
+0000cb20: 6f72 2078 2069 6e20 696e 7465 7276 616c  or x in interval
+0000cb30: 735d 292e 616c 6c28 290a 0a20 2020 2023  s]).all()..    #
+0000cb40: 202d 2d20 7465 7374 2065 7374 696d 6174   -- test estimat
+0000cb50: 655f 6572 726f 720a 2020 2020 6572 726f  e_error.    erro
+0000cb60: 725f 7065 725f 696e 7465 7276 616c 203d  r_per_interval =
+0000cb70: 2073 7461 7465 2e65 7374 696d 6174 655f   state.estimate_
+0000cb80: 6572 726f 7228 696e 7465 7276 616c 733d  error(intervals=
+0000cb90: 696e 7465 7276 616c 7329 0a20 2020 2061  intervals).    a
+0000cba0: 7373 6572 7420 6973 696e 7374 616e 6365  ssert isinstance
+0000cbb0: 2865 7272 6f72 5f70 6572 5f69 6e74 6572  (error_per_inter
+0000cbc0: 7661 6c2c 206e 702e 6e64 6172 7261 7929  val, np.ndarray)
+0000cbd0: 0a20 2020 2061 7373 6572 7420 6c65 6e28  .    assert len(
+0000cbe0: 6572 726f 725f 7065 725f 696e 7465 7276  error_per_interv
+0000cbf0: 616c 2920 3d3d 206c 656e 2869 6e74 6572  al) == len(inter
+0000cc00: 7661 6c73 290a 2020 2020 6173 7365 7274  vals).    assert
+0000cc10: 206e 702e 6172 7261 7928 5b69 7369 6e73   np.array([isins
+0000cc20: 7461 6e63 6528 782c 2066 6c6f 6174 2920  tance(x, float) 
+0000cc30: 666f 7220 7820 696e 2065 7272 6f72 5f70  for x in error_p
+0000cc40: 6572 5f69 6e74 6572 7661 6c5d 292e 616c  er_interval]).al
+0000cc50: 6c28 290a 0a20 2020 2065 7272 5f73 756d  l()..    err_sum
+0000cc60: 203d 2030 0a20 2020 2066 6f72 2069 2c20   = 0.    for i, 
+0000cc70: 696e 7465 7276 616c 2069 6e20 656e 756d  interval in enum
+0000cc80: 6572 6174 6528 696e 7465 7276 616c 7329  erate(intervals)
+0000cc90: 3a0a 2020 2020 2020 2020 6572 726f 7220  :.        error 
+0000cca0: 3d20 7374 6174 652e 6573 7469 6d61 7465  = state.estimate
+0000ccb0: 5f65 7272 6f72 2869 6e74 6572 7661 6c73  _error(intervals
+0000ccc0: 3d69 6e74 6572 7661 6c29 0a20 2020 2020  =interval).     
+0000ccd0: 2020 2061 7373 6572 7420 6973 696e 7374     assert isinst
+0000cce0: 616e 6365 2865 7272 6f72 2c20 666c 6f61  ance(error, floa
+0000ccf0: 7429 0a20 2020 2020 2020 2061 7373 6572  t).        asser
+0000cd00: 7420 6572 726f 7220 3d3d 2065 7272 6f72  t error == error
+0000cd10: 5f70 6572 5f69 6e74 6572 7661 6c5b 695d  _per_interval[i]
+0000cd20: 0a20 2020 2020 2020 2065 7272 5f73 756d  .        err_sum
+0000cd30: 202b 3d20 7374 6174 652e 6573 7469 6d61   += state.estima
+0000cd40: 7465 5f65 7272 6f72 2869 6e74 6572 7661  te_error(interva
+0000cd50: 6c73 3d69 6e74 6572 7661 6c2c 2066 756c  ls=interval, ful
+0000cd60: 6c5f 6f75 7470 7574 3d54 7275 6529 0a20  l_output=True). 
+0000cd70: 2020 2020 2020 2061 7373 6572 7420 6973         assert is
+0000cd80: 696e 7374 616e 6365 2865 7272 5f73 756d  instance(err_sum
+0000cd90: 2c20 6e70 2e6e 6461 7272 6179 290a 0a20  , np.ndarray).. 
+0000cda0: 2020 2023 2074 6865 2074 6f74 616c 2065     # the total e
+0000cdb0: 7272 6f72 2069 7320 4e4f 5420 7468 6520  rror is NOT the 
+0000cdc0: 7375 6d20 6f66 2069 6e74 6572 7661 6c20  sum of interval 
+0000cdd0: 6572 726f 7273 2028 7472 6961 6e67 6c65  errors (triangle
+0000cde0: 2069 6e65 7175 616c 6974 7929 0a20 2020   inequality).   
+0000cdf0: 2074 6f74 616c 5f65 7272 6f72 203d 2073   total_error = s
+0000ce00: 7461 7465 2e65 7374 696d 6174 655f 6572  tate.estimate_er
+0000ce10: 726f 7228 290a 2020 2020 6173 7365 7274  ror().    assert
+0000ce20: 206e 702e 616c 6c63 6c6f 7365 2874 6f74   np.allclose(tot
+0000ce30: 616c 5f65 7272 6f72 2c20 6e70 2e6d 6178  al_error, np.max
+0000ce40: 2865 7272 5f73 756d 2929 0a0a 2020 2020  (err_sum))..    
+0000ce50: 2320 2d2d 2075 6e6b 6e6f 776e 2069 6e74  # -- unknown int
+0000ce60: 6572 7661 6c20 7368 6f75 6c64 2072 6169  erval should rai
+0000ce70: 7365 2061 6e20 6572 726f 720a 2020 2020  se an error.    
+0000ce80: 696e 7465 7276 616c 203d 2069 6e74 6572  interval = inter
+0000ce90: 7661 6c73 5b30 5d0a 2020 2020 696e 7465  vals[0].    inte
+0000cea0: 7276 616c 2e6b 6d69 6e20 2b3d 2030 2e35  rval.kmin += 0.5
+0000ceb0: 202a 2028 696e 7465 7276 616c 2e6b 6d61   * (interval.kma
+0000cec0: 7820 2d20 696e 7465 7276 616c 2e6b 6d69  x - interval.kmi
+0000ced0: 6e29 0a20 2020 2072 6169 7365 7328 4b65  n).    raises(Ke
+0000cee0: 7945 7272 6f72 2c20 7374 6174 652e 6573  yError, state.es
+0000cef0: 7469 6d61 7465 5f65 7272 6f72 2c20 696e  timate_error, in
+0000cf00: 7465 7276 616c 733d 696e 7465 7276 616c  tervals=interval
+0000cf10: 290a 0a20 2020 2023 202d 2d20 7465 7374  )..    # -- test
+0000cf20: 2072 6566 696e 655f 696e 7465 7276 616c   refine_interval
+0000cf30: 730a 2020 2020 2320 2d2d 2074 6573 7420  s.    # -- test 
+0000cf40: 7469 6d65 2062 6566 6f72 6520 7265 6669  time before refi
+0000cf50: 6e69 6e67 2074 6865 2069 6e74 6572 7661  ning the interva
+0000cf60: 6c73 0a20 2020 2066 6f72 206b 6579 2069  ls.    for key i
+0000cf70: 6e20 7374 6174 652e 6d61 6e79 626f 6479  n state.manybody
+0000cf80: 5f77 6176 6566 756e 6374 696f 6e2e 6765  _wavefunction.ge
+0000cf90: 745f 6b65 7973 2829 3a0a 2020 2020 2020  t_keys():.      
+0000cfa0: 2020 7073 6920 3d20 7374 6174 652e 6d61    psi = state.ma
+0000cfb0: 6e79 626f 6479 5f77 6176 6566 756e 6374  nybody_wavefunct
+0000cfc0: 696f 6e2e 6765 745f 6f6e 6562 6f64 795f  ion.get_onebody_
+0000cfd0: 7374 6174 6528 6b65 7929 0a20 2020 2020  state(key).     
+0000cfe0: 2020 2061 7373 6572 7420 7073 692e 7469     assert psi.ti
+0000cff0: 6d65 203d 3d20 7374 6174 652e 7469 6d65  me == state.time
+0000d000: 0a20 2020 2023 202d 2d20 7265 6669 6e65  .    # -- refine
+0000d010: 5f69 6e74 6572 7661 6c73 0a20 2020 2065  _intervals.    e
+0000d020: 7272 6f72 5f62 6566 6f72 6520 3d20 7374  rror_before = st
+0000d030: 6174 652e 6573 7469 6d61 7465 5f65 7272  ate.estimate_err
+0000d040: 6f72 2829 0a20 2020 2073 7461 7465 2e72  or().    state.r
+0000d050: 6566 696e 655f 696e 7465 7276 616c 7328  efine_intervals(
+0000d060: 6174 6f6c 3d31 452d 332c 2072 746f 6c3d  atol=1E-3, rtol=
+0000d070: 3145 2d33 290a 2020 2020 6572 726f 725f  1E-3).    error_
+0000d080: 6166 7465 7220 3d20 7374 6174 652e 6573  after = state.es
+0000d090: 7469 6d61 7465 5f65 7272 6f72 2829 0a20  timate_error(). 
+0000d0a0: 2020 2061 7373 6572 7420 6572 726f 725f     assert error_
+0000d0b0: 6166 7465 7220 3c20 6572 726f 725f 6265  after < error_be
+0000d0c0: 666f 7265 0a20 2020 2023 202d 2d20 7465  fore.    # -- te
+0000d0d0: 7374 2074 696d 6520 6166 7465 7220 7265  st time after re
+0000d0e0: 6669 6e69 6e67 2074 6865 2069 6e74 6572  fining the inter
+0000d0f0: 7661 6c73 0a20 2020 2066 6f72 206b 6579  vals.    for key
+0000d100: 2069 6e20 7374 6174 652e 6d61 6e79 626f   in state.manybo
+0000d110: 6479 5f77 6176 6566 756e 6374 696f 6e2e  dy_wavefunction.
+0000d120: 6765 745f 6b65 7973 2829 3a0a 2020 2020  get_keys():.    
+0000d130: 2020 2020 7073 6920 3d20 7374 6174 652e      psi = state.
+0000d140: 6d61 6e79 626f 6479 5f77 6176 6566 756e  manybody_wavefun
+0000d150: 6374 696f 6e2e 6765 745f 6f6e 6562 6f64  ction.get_onebod
+0000d160: 795f 7374 6174 6528 6b65 7929 0a20 2020  y_state(key).   
+0000d170: 2020 2020 2061 7373 6572 7420 7073 692e       assert psi.
+0000d180: 7469 6d65 203d 3d20 7374 6174 652e 7469  time == state.ti
+0000d190: 6d65 0a0a 2020 2020 2320 6164 6420 626f  me..    # add bo
+0000d1a0: 756e 6473 7461 7465 732e 0a20 2020 2023  undstates..    #
+0000d1b0: 2065 6d75 6c61 7465 2074 6865 2062 6f75   emulate the bou
+0000d1c0: 6e64 7374 6174 6573 2062 7920 736f 6d65  ndstates by some
+0000d1d0: 2061 7262 6974 7261 7279 206f 6e65 626f   arbitrary onebo
+0000d1e0: 6479 2073 7461 7465 730a 2020 2020 2320  dy states.    # 
+0000d1f0: 6173 2074 6865 2062 6f75 6e64 7374 6174  as the boundstat
+0000d200: 6573 2068 6176 6520 7a65 726f 2077 6569  es have zero wei
+0000d210: 6768 742c 2074 6865 2072 6573 756c 7420  ght, the result 
+0000d220: 6d75 7374 2062 6520 696e 6465 6e74 6963  must be indentic
+0000d230: 616c 0a20 2020 2023 2074 6f20 7468 6520  al.    # to the 
+0000d240: 7265 7375 6c74 2077 6974 686f 7574 2062  result without b
+0000d250: 6f75 6e64 7374 6174 6573 0a20 2020 2064  oundstates.    d
+0000d260: 6566 206d 616b 655f 7073 6928 656e 6572  ef make_psi(ener
+0000d270: 6779 293a 0a20 2020 2020 2020 2072 6574  gy):.        ret
+0000d280: 7572 6e20 6f6e 6562 6f64 792e 5363 6174  urn onebody.Scat
+0000d290: 7465 7269 6e67 5374 6174 6573 2873 7973  teringStates(sys
+0000d2a0: 742c 206c 6561 643d 302c 2065 6e65 7267  t, lead=0, energ
+0000d2b0: 793d 656e 6572 6779 2c0a 2020 2020 2020  y=energy,.      
+0000d2c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d2e0: 2020 746d 6178 3d74 6d61 782c 2070 6172    tmax=tmax, par
+0000d2f0: 616d 733d 7061 7261 6d73 295b 305d 0a20  ams=params)[0]. 
+0000d300: 2020 2062 6f75 6e64 7374 6174 655f 7461     boundstate_ta
+0000d310: 736b 7320 3d20 7b27 6231 273a 206f 6e65  sks = {'b1': one
+0000d320: 626f 6479 2e54 6173 6b28 7765 6967 6874  body.Task(weight
+0000d330: 3d30 2c20 656e 6572 6779 3d32 2e31 2c20  =0, energy=2.1, 
+0000d340: 6c65 6164 3d4e 6f6e 652c 206d 6f64 653d  lead=None, mode=
+0000d350: 4e6f 6e65 292c 0a20 2020 2020 2020 2020  None),.         
+0000d360: 2020 2020 2020 2020 2020 2020 2020 2027                 '
+0000d370: 6232 273a 206f 6e65 626f 6479 2e54 6173  b2': onebody.Tas
+0000d380: 6b28 7765 6967 6874 3d30 2c20 656e 6572  k(weight=0, ener
+0000d390: 6779 3d32 2e33 2c20 6c65 6164 3d4e 6f6e  gy=2.3, lead=Non
+0000d3a0: 652c 206d 6f64 653d 4e6f 6e65 297d 0a20  e, mode=None)}. 
+0000d3b0: 2020 2062 6f75 6e64 7374 6174 655f 7073     boundstate_ps
+0000d3c0: 6920 3d20 7b6b 6579 3a20 6d61 6b65 5f70  i = {key: make_p
+0000d3d0: 7369 2874 6173 6b2e 656e 6572 6779 2920  si(task.energy) 
+0000d3e0: 666f 7220 6b65 792c 2074 6173 6b20 696e  for key, task in
+0000d3f0: 2062 6f75 6e64 7374 6174 655f 7461 736b   boundstate_task
+0000d400: 732e 6974 656d 7328 297d 0a0a 2020 2020  s.items()}..    
+0000d410: 2320 2d2d 2063 6865 636b 2074 6861 7420  # -- check that 
+0000d420: 6164 6469 6e67 2062 6f75 6e64 7374 6174  adding boundstat
+0000d430: 6573 2064 6f20 6e6f 7420 6368 616e 6765  es do not change
+0000d440: 2065 7272 6f72 2c20 696e 7465 7276 616c   error, interval
+0000d450: 7320 616e 6420 6f62 7365 7276 6162 6c65  s and observable
+0000d460: 0a20 2020 2069 6e74 6572 7661 6c73 5f62  .    intervals_b
+0000d470: 6566 6f72 6520 3d20 7374 6174 652e 6765  efore = state.ge
+0000d480: 745f 696e 7465 7276 616c 7328 290a 2020  t_intervals().  
+0000d490: 2020 6572 726f 725f 7065 725f 696e 7465    error_per_inte
+0000d4a0: 7276 616c 5f62 6566 6f72 6520 3d20 7374  rval_before = st
+0000d4b0: 6174 652e 6573 7469 6d61 7465 5f65 7272  ate.estimate_err
+0000d4c0: 6f72 2869 6e74 6572 7661 6c73 3d69 6e74  or(intervals=int
+0000d4d0: 6572 7661 6c73 5f62 6566 6f72 6529 0a20  ervals_before). 
+0000d4e0: 2020 2074 6f74 616c 5f65 7272 6f72 5f62     total_error_b
+0000d4f0: 6566 6f72 6520 3d20 7374 6174 652e 6573  efore = state.es
+0000d500: 7469 6d61 7465 5f65 7272 6f72 2829 0a20  timate_error(). 
+0000d510: 2020 2064 656e 7369 7479 5f62 6566 6f72     density_befor
+0000d520: 6520 3d20 7374 6174 652e 6576 616c 7561  e = state.evalua
+0000d530: 7465 2864 656e 7369 7479 5f6f 7065 7261  te(density_opera
+0000d540: 746f 7229 0a20 2020 206b 6579 735f 6265  tor).    keys_be
+0000d550: 666f 7265 203d 2073 7461 7465 2e6d 616e  fore = state.man
+0000d560: 7962 6f64 795f 7761 7665 6675 6e63 7469  ybody_wavefuncti
+0000d570: 6f6e 2e67 6574 5f6b 6579 7328 290a 0a20  on.get_keys().. 
+0000d580: 2020 2073 7461 7465 2e5f 6164 645f 626f     state._add_bo
+0000d590: 756e 6473 7461 7465 7328 626f 756e 6473  undstates(bounds
+0000d5a0: 7461 7465 5f70 7369 2c20 626f 756e 6473  tate_psi, bounds
+0000d5b0: 7461 7465 5f74 6173 6b73 290a 0a20 2020  tate_tasks)..   
+0000d5c0: 2069 6e74 6572 7661 6c73 5f61 6674 6572   intervals_after
+0000d5d0: 203d 2073 7461 7465 2e67 6574 5f69 6e74   = state.get_int
+0000d5e0: 6572 7661 6c73 2829 0a20 2020 2065 7272  ervals().    err
+0000d5f0: 6f72 5f70 6572 5f69 6e74 6572 7661 6c5f  or_per_interval_
+0000d600: 6166 7465 7220 3d20 7374 6174 652e 6573  after = state.es
+0000d610: 7469 6d61 7465 5f65 7272 6f72 2869 6e74  timate_error(int
+0000d620: 6572 7661 6c73 3d69 6e74 6572 7661 6c73  ervals=intervals
+0000d630: 5f61 6674 6572 290a 2020 2020 746f 7461  _after).    tota
+0000d640: 6c5f 6572 726f 725f 6166 7465 7220 3d20  l_error_after = 
+0000d650: 7374 6174 652e 6573 7469 6d61 7465 5f65  state.estimate_e
+0000d660: 7272 6f72 2829 0a20 2020 2064 656e 7369  rror().    densi
+0000d670: 7479 5f61 6674 6572 203d 2073 7461 7465  ty_after = state
+0000d680: 2e65 7661 6c75 6174 6528 6465 6e73 6974  .evaluate(densit
+0000d690: 795f 6f70 6572 6174 6f72 290a 2020 2020  y_operator).    
+0000d6a0: 6b65 7973 5f61 6674 6572 203d 2073 7461  keys_after = sta
+0000d6b0: 7465 2e6d 616e 7962 6f64 795f 7761 7665  te.manybody_wave
+0000d6c0: 6675 6e63 7469 6f6e 2e67 6574 5f6b 6579  function.get_key
+0000d6d0: 7328 290a 0a20 2020 2066 6f72 2069 6e74  s()..    for int
+0000d6e0: 6572 7661 6c5f 6265 666f 7265 2c20 696e  erval_before, in
+0000d6f0: 7465 7276 616c 5f61 6674 6572 2069 6e20  terval_after in 
+0000d700: 7a69 7028 696e 7465 7276 616c 735f 6265  zip(intervals_be
+0000d710: 666f 7265 2c20 696e 7465 7276 616c 735f  fore, intervals_
+0000d720: 6166 7465 7229 3a0a 2020 2020 2020 2020  after):.        
+0000d730: 6173 7365 7274 2069 6e74 6572 7661 6c5f  assert interval_
+0000d740: 6265 666f 7265 203d 3d20 696e 7465 7276  before == interv
+0000d750: 616c 5f61 6674 6572 0a20 2020 2061 7373  al_after.    ass
+0000d760: 6572 7420 746f 7461 6c5f 6572 726f 725f  ert total_error_
+0000d770: 6265 666f 7265 203d 3d20 746f 7461 6c5f  before == total_
+0000d780: 6572 726f 725f 6166 7465 720a 2020 2020  error_after.    
+0000d790: 6173 7365 7274 5f61 7272 6179 5f61 6c6d  assert_array_alm
+0000d7a0: 6f73 745f 6571 7561 6c28 6572 726f 725f  ost_equal(error_
+0000d7b0: 7065 725f 696e 7465 7276 616c 5f62 6566  per_interval_bef
+0000d7c0: 6f72 652c 2065 7272 6f72 5f70 6572 5f69  ore, error_per_i
+0000d7d0: 6e74 6572 7661 6c5f 6166 7465 7229 0a20  nterval_after). 
+0000d7e0: 2020 2061 7373 6572 745f 6172 7261 795f     assert_array_
+0000d7f0: 616c 6d6f 7374 5f65 7175 616c 2864 656e  almost_equal(den
+0000d800: 7369 7479 5f62 6566 6f72 652c 2064 656e  sity_before, den
+0000d810: 7369 7479 5f61 6674 6572 290a 0a20 2020  sity_after)..   
+0000d820: 2061 7373 6572 7420 6b65 7973 5f62 6566   assert keys_bef
+0000d830: 6f72 6520 2b20 6c69 7374 2862 6f75 6e64  ore + list(bound
+0000d840: 7374 6174 655f 7461 736b 732e 6b65 7973  state_tasks.keys
+0000d850: 2829 2920 3d3d 206b 6579 735f 6166 7465  ()) == keys_afte
+0000d860: 720a 0a20 2020 2023 202d 2d20 6368 6563  r..    # -- chec
+0000d870: 6b20 7468 6174 2074 6865 2073 7461 7465  k that the state
+0000d880: 2063 616e 2073 7469 6c6c 2062 6520 6576   can still be ev
+0000d890: 6f6c 7665 6420 616e 6420 6769 7665 7320  olved and gives 
+0000d8a0: 7468 6520 7361 6d65 2072 6573 756c 7420  the same result 
+0000d8b0: 6173 2077 6176 6566 756e 6374 696f 6e0a  as wavefunction.
+0000d8c0: 2020 2020 7469 6d65 202b 3d20 350a 2020      time += 5.  
+0000d8d0: 2020 7374 6174 652e 6576 6f6c 7665 2874    state.evolve(t
+0000d8e0: 696d 6529 0a20 2020 2064 656e 7369 7479  ime).    density
+0000d8f0: 203d 2073 7461 7465 2e65 7661 6c75 6174   = state.evaluat
+0000d900: 6528 6465 6e73 6974 795f 6f70 6572 6174  e(density_operat
+0000d910: 6f72 290a 0a20 2020 2077 662e 6576 6f6c  or)..    wf.evol
+0000d920: 7665 2874 696d 6529 0a20 2020 2064 656e  ve(time).    den
+0000d930: 7369 7479 5f77 6620 3d20 7374 6174 652e  sity_wf = state.
+0000d940: 6576 616c 7561 7465 2864 656e 7369 7479  evaluate(density
+0000d950: 5f6f 7065 7261 746f 7229 0a0a 2020 2020  _operator)..    
+0000d960: 6173 7365 7274 5f61 7272 6179 5f61 6c6d  assert_array_alm
+0000d970: 6f73 745f 6571 7561 6c28 6465 6e73 6974  ost_equal(densit
+0000d980: 792c 2064 656e 7369 7479 5f77 6629 0a0a  y, density_wf)..
+0000d990: 2020 2020 2320 2d2d 2063 6865 636b 2074      # -- check t
+0000d9a0: 6861 7420 7265 6669 6e65 5f69 6e74 6572  hat refine_inter
+0000d9b0: 7661 6c73 2073 7469 6c6c 2077 6f72 6b73  vals still works
+0000d9c0: 0a20 2020 2065 7272 6f72 5f62 6566 6f72  .    error_befor
+0000d9d0: 6520 3d20 7374 6174 652e 6573 7469 6d61  e = state.estima
+0000d9e0: 7465 5f65 7272 6f72 2829 0a20 2020 2073  te_error().    s
+0000d9f0: 7461 7465 2e72 6566 696e 655f 696e 7465  tate.refine_inte
+0000da00: 7276 616c 7328 6174 6f6c 3d31 452d 342c  rvals(atol=1E-4,
+0000da10: 2072 746f 6c3d 3145 2d34 290a 2020 2020   rtol=1E-4).    
+0000da20: 6572 726f 725f 6166 7465 7220 3d20 7374  error_after = st
+0000da30: 6174 652e 6573 7469 6d61 7465 5f65 7272  ate.estimate_err
+0000da40: 6f72 2829 0a20 2020 2061 7373 6572 7420  or().    assert 
+0000da50: 6572 726f 725f 6166 7465 7220 3c20 6572  error_after < er
+0000da60: 726f 725f 6265 666f 7265 0a0a 2020 2020  ror_before..    
+0000da70: 2320 2d2d 2063 6865 636b 2074 6f20 6164  # -- check to ad
+0000da80: 6420 7573 6572 2067 6976 656e 2069 6e74  d user given int
+0000da90: 6572 7661 6c73 2c20 7072 6563 616c 6375  ervals, precalcu
+0000daa0: 6c61 7465 0a20 2020 204d 6f64 496e 7465  late.    ModInte
+0000dab0: 7276 616c 203d 2066 756e 6374 6f6f 6c73  rval = functools
+0000dac0: 2e70 6172 7469 616c 286d 616e 7962 6f64  .partial(manybod
+0000dad0: 792e 496e 7465 7276 616c 2c20 6f72 6465  y.Interval, orde
+0000dae0: 723d 332c 2069 6e74 6567 7261 7469 6f6e  r=3, integration
+0000daf0: 5f76 6172 6961 626c 653d 2765 6e65 7267  _variable='energ
+0000db00: 7927 290a 2020 2020 696e 7465 7276 616c  y').    interval
+0000db10: 7320 3d20 6d61 6e79 626f 6479 2e63 616c  s = manybody.cal
+0000db20: 635f 696e 7465 7276 616c 7328 7370 6563  c_intervals(spec
+0000db30: 7472 756d 2c20 6f63 6375 7061 7469 6f6e  trum, occupation
+0000db40: 2c20 696e 7465 7276 616c 5f74 7970 653d  , interval_type=
+0000db50: 4d6f 6449 6e74 6572 7661 6c29 0a20 2020  ModInterval).   
+0000db60: 2073 7461 7465 203d 206d 616e 7962 6f64   state = manybod
+0000db70: 792e 5374 6174 6528 7379 7374 2c20 746d  y.State(syst, tm
+0000db80: 6178 2c20 6f63 6375 7061 7469 6f6e 2c20  ax, occupation, 
+0000db90: 7061 7261 6d73 3d70 6172 616d 732c 2069  params=params, i
+0000dba0: 6e74 6572 7661 6c73 3d69 6e74 6572 7661  ntervals=interva
+0000dbb0: 6c73 2c20 7265 6669 6e65 3d46 616c 7365  ls, refine=False
+0000dbc0: 290a 2020 2020 696e 7465 7276 616c 7320  ).    intervals 
+0000dbd0: 3d20 7374 6174 652e 6765 745f 696e 7465  = state.get_inte
+0000dbe0: 7276 616c 7328 290a 2020 2020 666f 7220  rvals().    for 
+0000dbf0: 696e 7465 7276 616c 2069 6e20 696e 7465  interval in inte
+0000dc00: 7276 616c 733a 0a20 2020 2020 2020 2061  rvals:.        a
+0000dc10: 7373 6572 7420 696e 7465 7276 616c 2e6f  ssert interval.o
+0000dc20: 7264 6572 203d 3d20 330a 2020 2020 2020  rder == 3.      
+0000dc30: 2020 6173 7365 7274 2069 6e74 6572 7661    assert interva
+0000dc40: 6c2e 696e 7465 6772 6174 696f 6e5f 7661  l.integration_va
+0000dc50: 7269 6162 6c65 203d 3d20 2765 6e65 7267  riable == 'energ
+0000dc60: 7927 0a0a 2020 2020 2320 2d2d 2063 6865  y'..    # -- che
+0000dc70: 636b 2074 6f20 6164 6420 7573 6572 2067  ck to add user g
+0000dc80: 6976 656e 2069 6e74 6572 7661 6c73 2c20  iven intervals, 
+0000dc90: 6e65 7720 6465 6661 756c 740a 2020 2020  new default.    
+0000dca0: 4d6f 6449 6e74 6572 7661 6c20 3d20 6675  ModInterval = fu
+0000dcb0: 6e63 746f 6f6c 732e 7061 7274 6961 6c28  nctools.partial(
+0000dcc0: 6d61 6e79 626f 6479 2e49 6e74 6572 7661  manybody.Interva
+0000dcd0: 6c2c 206f 7264 6572 3d33 2c20 696e 7465  l, order=3, inte
+0000dce0: 6772 6174 696f 6e5f 7661 7269 6162 6c65  gration_variable
+0000dcf0: 3d27 656e 6572 6779 2729 0a20 2020 2073  ='energy').    s
+0000dd00: 7461 7465 203d 206d 616e 7962 6f64 792e  tate = manybody.
+0000dd10: 5374 6174 6528 7379 7374 2c20 746d 6178  State(syst, tmax
+0000dd20: 2c20 6f63 6375 7061 7469 6f6e 2c20 7061  , occupation, pa
+0000dd30: 7261 6d73 3d70 6172 616d 732c 2069 6e74  rams=params, int
+0000dd40: 6572 7661 6c73 3d4d 6f64 496e 7465 7276  ervals=ModInterv
+0000dd50: 616c 2c20 7265 6669 6e65 3d46 616c 7365  al, refine=False
+0000dd60: 290a 2020 2020 696e 7465 7276 616c 7320  ).    intervals 
+0000dd70: 3d20 7374 6174 652e 6765 745f 696e 7465  = state.get_inte
+0000dd80: 7276 616c 7328 290a 2020 2020 666f 7220  rvals().    for 
+0000dd90: 696e 7465 7276 616c 2069 6e20 696e 7465  interval in inte
+0000dda0: 7276 616c 733a 0a20 2020 2020 2020 2061  rvals:.        a
+0000ddb0: 7373 6572 7420 696e 7465 7276 616c 2e6f  ssert interval.o
+0000ddc0: 7264 6572 203d 3d20 330a 2020 2020 2020  rder == 3.      
+0000ddd0: 2020 6173 7365 7274 2069 6e74 6572 7661    assert interva
+0000dde0: 6c2e 696e 7465 6772 6174 696f 6e5f 7661  l.integration_va
+0000ddf0: 7269 6162 6c65 203d 3d20 2765 6e65 7267  riable == 'energ
+0000de00: 7927 0a0a 2020 2020 2320 2d2d 2063 6865  y'..    # -- che
+0000de10: 636b 2073 7461 7465 2077 6974 6820 6465  ck state with de
+0000de20: 6661 756c 7420 6f63 6375 7061 7469 6f6e  fault occupation
+0000de30: 0a20 2020 206f 6363 7570 6174 696f 6e5f  .    occupation_
+0000de40: 6d75 5f30 203d 206d 616e 7962 6f64 792e  mu_0 = manybody.
+0000de50: 6c65 6164 5f6f 6363 7570 6174 696f 6e28  lead_occupation(
+0000de60: 6368 656d 6963 616c 5f70 6f74 656e 7469  chemical_potenti
+0000de70: 616c 3d30 290a 2020 2020 7374 6174 655f  al=0).    state_
+0000de80: 6d75 5f30 203d 206d 616e 7962 6f64 792e  mu_0 = manybody.
+0000de90: 5374 6174 6528 7379 7374 2c20 746d 6178  State(syst, tmax
+0000dea0: 2c20 6f63 6375 7061 7469 6f6e 5f6d 755f  , occupation_mu_
+0000deb0: 302c 2070 6172 616d 733d 7061 7261 6d73  0, params=params
+0000dec0: 2c20 7265 6669 6e65 3d46 616c 7365 290a  , refine=False).
+0000ded0: 2020 2020 7374 6174 655f 6465 6661 756c      state_defaul
+0000dee0: 7420 3d20 6d61 6e79 626f 6479 2e53 7461  t = manybody.Sta
+0000def0: 7465 2873 7973 742c 2074 6d61 783d 746d  te(syst, tmax=tm
+0000df00: 6178 2c20 7061 7261 6d73 3d70 6172 616d  ax, params=param
+0000df10: 732c 2072 6566 696e 653d 4661 6c73 6529  s, refine=False)
+0000df20: 0a20 2020 2061 7373 6572 7420 7374 6174  .    assert stat
+0000df30: 655f 6d75 5f30 2e6f 6363 7570 6174 696f  e_mu_0.occupatio
+0000df40: 6e73 5b30 5d2e 656e 6572 6779 5f72 616e  ns[0].energy_ran
+0000df50: 6765 203d 3d20 7374 6174 655f 6465 6661  ge == state_defa
+0000df60: 756c 742e 6f63 6375 7061 7469 6f6e 735b  ult.occupations[
+0000df70: 305d 2e65 6e65 7267 795f 7261 6e67 650a  0].energy_range.
+0000df80: 0a20 2020 2023 2074 6573 7420 666f 7220  .    # test for 
+0000df90: 6d69 7373 696e 6720 696e 7075 740a 2020  missing input.  
+0000dfa0: 2020 7261 6973 6573 2856 616c 7565 4572    raises(ValueEr
+0000dfb0: 726f 722c 206d 616e 7962 6f64 792e 5374  ror, manybody.St
+0000dfc0: 6174 652c 2073 7973 743d 7379 7374 2c20  ate, syst=syst, 
+0000dfd0: 7061 7261 6d73 3d70 6172 616d 7329 0a20  params=params). 
+0000dfe0: 2020 2023 2074 6573 7420 666f 7220 7379     # test for sy
+0000dff0: 7374 656d 206e 6f74 2066 696e 616c 697a  stem not finaliz
+0000e000: 6564 0a20 2020 2072 6169 7365 7328 5479  ed.    raises(Ty
+0000e010: 7065 4572 726f 722c 206d 616e 7962 6f64  peError, manybod
+0000e020: 792e 5374 6174 652c 2073 7973 743d 6d61  y.State, syst=ma
+0000e030: 6b65 5f73 7973 7465 6d28 292c 2074 6d61  ke_system(), tma
+0000e040: 783d 352c 2070 6172 616d 733d 7061 7261  x=5, params=para
+0000e050: 6d73 290a 2020 2020 2320 7465 7374 2066  ms).    # test f
+0000e060: 6f72 206d 7574 7561 6c20 6578 636c 7573  or mutual exclus
+0000e070: 6976 6520 6172 6775 6d65 6e74 730a 2020  ive arguments.  
+0000e080: 2020 7261 6973 6573 2856 616c 7565 4572    raises(ValueEr
+0000e090: 726f 722c 206d 616e 7962 6f64 792e 5374  ror, manybody.St
+0000e0a0: 6174 652c 2073 7973 742c 2074 6d61 782c  ate, syst, tmax,
+0000e0b0: 2062 6f75 6e64 6172 6965 733d 626f 756e   boundaries=boun
+0000e0c0: 6461 7269 6573 2c20 7061 7261 6d73 3d70  daries, params=p
+0000e0d0: 6172 616d 7329 0a0a 2020 2020 7061 7261  arams)..    para
+0000e0e0: 6d73 5f77 6974 685f 7469 6d65 203d 207b  ms_with_time = {
+0000e0f0: 2776 273a 2030 2e31 2c20 2774 3027 3a20  'v': 0.1, 't0': 
+0000e100: 302c 2027 4127 3a20 302e 3030 3135 372c  0, 'A': 0.00157,
+0000e110: 2027 7369 676d 6127 3a20 3234 2c20 2774   'sigma': 24, 't
+0000e120: 696d 6527 3a20 307d 0a20 2020 2077 6974  ime': 0}.    wit
+0000e130: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
+0000e140: 4b65 7945 7272 6f72 2920 6173 2065 7863  KeyError) as exc
+0000e150: 3a0a 2020 2020 2020 2020 6d61 6e79 626f  :.        manybo
+0000e160: 6479 2e53 7461 7465 2873 7973 742c 2074  dy.State(syst, t
+0000e170: 6d61 782c 2070 6172 616d 733d 7061 7261  max, params=para
+0000e180: 6d73 5f77 6974 685f 7469 6d65 290a 2020  ms_with_time).  
+0000e190: 2020 6572 726f 725f 7374 7269 6e67 203d    error_string =
+0000e1a0: 2073 7472 2865 7863 2e76 616c 7565 292e   str(exc.value).
+0000e1b0: 7374 7269 7028 275c 2227 2920 2023 2072  strip('\"')  # r
+0000e1c0: 656d 6f76 6520 6574 7261 2071 756f 7465  emove etra quote
+0000e1d0: 730a 2020 2020 6173 7365 7274 2065 7272  s.    assert err
+0000e1e0: 6f72 5f73 7472 696e 6720 3d3d 2022 2770  or_string == "'p
+0000e1f0: 6172 616d 7327 206d 7573 7420 6e6f 7420  arams' must not 
+0000e200: 636f 6e74 6169 6e20 7469 6d65 220a 0a20  contain time".. 
+0000e210: 2020 2023 2054 4f44 4f2c 2063 6865 636b     # TODO, check
+0000e220: 2067 656e 6572 616c 2070 6172 616d 6574   general paramet
+0000e230: 6572 2068 616e 646c 696e 6720 696e 206d  er handling in m
+0000e240: 616e 7962 6f64 792e 5374 6174 650a 2020  anybody.State.  
+0000e250: 2020 2320 6e6f 2070 6172 616d 7320 7061    # no params pa
+0000e260: 7373 6564 2061 7420 616c 6c0a 2020 2020  ssed at all.    
+0000e270: 2320 7769 7468 2070 7974 6573 742e 7261  # with pytest.ra
+0000e280: 6973 6573 2854 7970 6545 7272 6f72 2920  ises(TypeError) 
+0000e290: 6173 2065 7863 3a0a 2020 2020 2320 6d61  as exc:.    # ma
+0000e2a0: 6e79 626f 6479 2e53 7461 7465 2873 7973  nybody.State(sys
+0000e2b0: 742c 2074 6d61 7829 0a20 2020 2023 2061  t, tmax).    # a
+0000e2c0: 7373 6572 7420 7374 7228 6578 632e 7661  ssert str(exc.va
+0000e2d0: 6c75 6529 203d 3d20 2753 7973 7465 6d20  lue) == 'System 
+0000e2e0: 6973 206d 6973 7369 6e67 2072 6571 7569  is missing requi
+0000e2f0: 7265 6420 6172 6775 6d65 6e74 733a 2022  red arguments: "
+0000e300: 7622 270a 0a20 2020 2023 2070 6172 616d  v"'..    # param
+0000e310: 735f 7769 7468 6f75 745f 7369 676d 6120  s_without_sigma 
+0000e320: 3d20 7b27 7627 3a20 302e 312c 2027 7430  = {'v': 0.1, 't0
+0000e330: 273a 2030 2c20 2741 273a 302e 3030 3135  ': 0, 'A':0.0015
+0000e340: 377d 0a20 2020 2023 2077 6974 6820 7079  7}.    # with py
+0000e350: 7465 7374 2e72 6169 7365 7328 5479 7065  test.raises(Type
+0000e360: 4572 726f 7229 2061 7320 6578 633a 0a20  Error) as exc:. 
+0000e370: 2020 2023 2020 2020 6d61 6e79 626f 6479     #    manybody
+0000e380: 2e53 7461 7465 2873 7973 742c 2074 6d61  .State(syst, tma
+0000e390: 782c 2070 6172 616d 733d 7061 7261 6d73  x, params=params
+0000e3a0: 5f77 6974 686f 7574 5f73 6967 6d61 290a  _without_sigma).
+0000e3b0: 2020 2020 2320 6173 7365 7274 2073 7472      # assert str
+0000e3c0: 2865 7863 2e76 616c 7565 2920 3d3d 2027  (exc.value) == '
+0000e3d0: 5379 7374 656d 2069 7320 6d69 7373 696e  System is missin
+0000e3e0: 6720 7265 7175 6972 6564 2061 7267 756d  g required argum
+0000e3f0: 656e 7473 3a20 2273 6967 6d61 2227 0a0a  ents: "sigma"'..
+0000e400: 0a40 7079 7465 7374 2e6d 6172 6b2e 696e  .@pytest.mark.in
+0000e410: 7465 6774 6573 7420 2023 206d 6172 6b65  tegtest  # marke
+0000e420: 7220 666f 7220 696e 7465 6772 6174 696f  r for integratio
+0000e430: 6e20 7465 7374 730a 6465 6620 7465 7374  n tests.def test
+0000e440: 5f6d 616e 7962 6f64 795f 7374 6174 655f  _manybody_state_
+0000e450: 696e 6974 6961 6c5f 7265 6669 6e65 2829  initial_refine()
+0000e460: 3a0a 0a20 2020 2073 7973 7420 3d20 6d61  :..    syst = ma
+0000e470: 6b65 5f73 7973 7465 6d28 292e 6669 6e61  ke_system().fina
+0000e480: 6c69 7a65 6428 290a 0a20 2020 2074 6d61  lized()..    tma
+0000e490: 7820 3d20 3530 300a 2020 2020 7061 7261  x = 500.    para
+0000e4a0: 6d73 203d 207b 2776 273a 2030 2e30 3030  ms = {'v': 0.000
+0000e4b0: 312c 2027 7430 273a 2030 2c20 2741 273a  1, 't0': 0, 'A':
+0000e4c0: 2030 2e30 3031 3537 2c20 2773 6967 6d61   0.00157, 'sigma
+0000e4d0: 273a 2032 347d 0a0a 2020 2020 6f63 6375  ': 24}..    occu
+0000e4e0: 7061 7469 6f6e 203d 206d 616e 7962 6f64  pation = manybod
+0000e4f0: 792e 6c65 6164 5f6f 6363 7570 6174 696f  y.lead_occupatio
+0000e500: 6e28 6368 656d 6963 616c 5f70 6f74 656e  n(chemical_poten
+0000e510: 7469 616c 3d33 290a 0a20 2020 2073 7461  tial=3)..    sta
+0000e520: 7465 203d 206d 616e 7962 6f64 792e 5374  te = manybody.St
+0000e530: 6174 6528 7379 7374 2c20 746d 6178 2c20  ate(syst, tmax, 
+0000e540: 6f63 6375 7061 7469 6f6e 2c20 7061 7261  occupation, para
+0000e550: 6d73 3d70 6172 616d 732c 2072 6566 696e  ms=params, refin
+0000e560: 653d 4661 6c73 6529 0a20 2020 2069 6e74  e=False).    int
+0000e570: 6572 7661 6c73 203d 2073 7461 7465 2e67  ervals = state.g
+0000e580: 6574 5f69 6e74 6572 7661 6c73 2829 0a20  et_intervals(). 
+0000e590: 2020 2061 7373 6572 7420 6c65 6e28 696e     assert len(in
+0000e5a0: 7465 7276 616c 7329 203d 3d20 320a 0a20  tervals) == 2.. 
+0000e5b0: 2020 2073 7461 7465 203d 206d 616e 7962     state = manyb
+0000e5c0: 6f64 792e 5374 6174 6528 7379 7374 2c20  ody.State(syst, 
+0000e5d0: 746d 6178 2c20 6f63 6375 7061 7469 6f6e  tmax, occupation
+0000e5e0: 2c20 7061 7261 6d73 3d70 6172 616d 7329  , params=params)
+0000e5f0: 0a20 2020 2069 6e74 6572 7661 6c73 203d  .    intervals =
+0000e600: 2073 7461 7465 2e67 6574 5f69 6e74 6572   state.get_inter
+0000e610: 7661 6c73 2829 0a20 2020 2061 7373 6572  vals().    asser
+0000e620: 7420 6c65 6e28 696e 7465 7276 616c 7329  t len(intervals)
+0000e630: 203d 3d20 3133 0a0a 0a40 7079 7465 7374   == 13...@pytest
+0000e640: 2e6d 6172 6b2e 696e 7465 6774 6573 7420  .mark.integtest 
+0000e650: 2023 206d 6172 6b65 7220 666f 7220 696e   # marker for in
+0000e660: 7465 6772 6174 696f 6e20 7465 7374 730a  tegration tests.
+0000e670: 6465 6620 7465 7374 5f6d 616e 7962 6f64  def test_manybod
+0000e680: 795f 7374 6174 655f 7265 6669 6e65 5f6e  y_state_refine_n
+0000e690: 6f6e 5f6b 726f 6e72 6f64 2829 3a0a 0a20  on_kronrod():.. 
+0000e6a0: 2020 2023 2074 6573 7420 7468 6174 2072     # test that r
+0000e6b0: 6566 696e 656d 656e 7420 6163 7473 206f  efinement acts o
+0000e6c0: 6e6c 7920 6f6e 2074 6865 2067 6175 7373  nly on the gauss
+0000e6d0: 2d6b 726f 6e72 6f64 2069 6e74 6572 7661  -kronrod interva
+0000e6e0: 6c73 0a20 2020 2023 2061 6e64 2074 6861  ls.    # and tha
+0000e6f0: 7420 6164 6469 7469 6f6e 616c 206f 7468  t additional oth
+0000e700: 6572 2069 6e74 6572 7661 6c73 2028 6865  er intervals (he
+0000e710: 7265 2067 6175 7373 2d6c 6567 656e 6472  re gauss-legendr
+0000e720: 6520 696e 2074 6865 2065 7861 6d70 6c65  e in the example
+0000e730: 290a 2020 2020 2320 6172 6520 6e6f 7420  ).    # are not 
+0000e740: 746f 7563 6865 6420 6279 2072 6566 696e  touched by refin
+0000e750: 655f 696e 7465 7276 616c 7328 290a 0a20  e_intervals().. 
+0000e760: 2020 2073 7973 7420 3d20 6d61 6b65 5f73     syst = make_s
+0000e770: 7973 7465 6d28 292e 6669 6e61 6c69 7a65  ystem().finalize
+0000e780: 6428 290a 0a20 2020 2074 6d61 7820 3d20  d()..    tmax = 
+0000e790: 3530 300a 2020 2020 7061 7261 6d73 203d  500.    params =
+0000e7a0: 207b 2776 273a 2030 2e30 3030 312c 2027   {'v': 0.0001, '
+0000e7b0: 7430 273a 2030 2c20 2741 273a 2030 2e30  t0': 0, 'A': 0.0
+0000e7c0: 3031 3537 2c20 2773 6967 6d61 273a 2032  0157, 'sigma': 2
+0000e7d0: 347d 0a0a 2020 2020 6f63 6375 7061 7469  4}..    occupati
+0000e7e0: 6f6e 203d 206d 616e 7962 6f64 792e 6c65  on = manybody.le
+0000e7f0: 6164 5f6f 6363 7570 6174 696f 6e28 6368  ad_occupation(ch
+0000e800: 656d 6963 616c 5f70 6f74 656e 7469 616c  emical_potential
+0000e810: 3d33 290a 0a20 2020 2073 7461 7465 203d  =3)..    state =
+0000e820: 206d 616e 7962 6f64 792e 5374 6174 6528   manybody.State(
+0000e830: 7379 7374 2c20 746d 6178 2c20 6f63 6375  syst, tmax, occu
+0000e840: 7061 7469 6f6e 2c20 7061 7261 6d73 3d70  pation, params=p
+0000e850: 6172 616d 732c 2072 6566 696e 653d 4661  arams, refine=Fa
+0000e860: 6c73 6529 0a20 2020 2069 6e74 6572 7661  lse).    interva
+0000e870: 6c73 203d 2073 7461 7465 2e67 6574 5f69  ls = state.get_i
+0000e880: 6e74 6572 7661 6c73 2829 0a20 2020 2061  ntervals().    a
+0000e890: 7373 6572 7420 6c65 6e28 696e 7465 7276  ssert len(interv
+0000e8a0: 616c 7329 203d 3d20 320a 0a20 2020 2066  als) == 2..    f
+0000e8b0: 6f72 2069 6e74 6572 7661 6c20 696e 2069  or interval in i
+0000e8c0: 6e74 6572 7661 6c73 3a0a 2020 2020 2020  ntervals:.      
+0000e8d0: 2020 696e 7465 7276 616c 2e71 7561 6472    interval.quadr
+0000e8e0: 6174 7572 6520 3d20 2767 6175 7373 6c65  ature = 'gaussle
+0000e8f0: 6765 6e64 7265 270a 2020 2020 2020 2020  gendre'.        
+0000e900: 7374 6174 652e 5f61 6464 5f69 6e74 6572  state._add_inter
+0000e910: 7661 6c28 696e 7465 7276 616c 290a 0a20  val(interval).. 
+0000e920: 2020 2069 6e74 6572 7661 6c73 203d 2073     intervals = s
+0000e930: 7461 7465 2e67 6574 5f69 6e74 6572 7661  tate.get_interva
+0000e940: 6c73 2829 0a20 2020 2061 7373 6572 7420  ls().    assert 
+0000e950: 6c65 6e28 696e 7465 7276 616c 7329 203d  len(intervals) =
+0000e960: 3d20 3420 2023 2032 202b 2032 2069 6e74  = 4  # 2 + 2 int
+0000e970: 6572 7661 6c73 0a0a 2020 2020 7374 6174  ervals..    stat
+0000e980: 652e 7265 6669 6e65 5f69 6e74 6572 7661  e.refine_interva
+0000e990: 6c73 2829 0a20 2020 2069 6e74 6572 7661  ls().    interva
+0000e9a0: 6c73 203d 2073 7461 7465 2e67 6574 5f69  ls = state.get_i
+0000e9b0: 6e74 6572 7661 6c73 2829 0a20 2020 2061  ntervals().    a
+0000e9c0: 7373 6572 7420 6c65 6e28 696e 7465 7276  ssert len(interv
+0000e9d0: 616c 7329 203d 3d20 3135 2020 2320 3133  als) == 15  # 13
+0000e9e0: 202b 2032 2069 6e74 6572 7661 6c73 0a0a   + 2 intervals..
+0000e9f0: 0a40 7079 7465 7374 2e6d 6172 6b2e 696e  .@pytest.mark.in
+0000ea00: 7465 6774 6573 740a 6465 6620 7465 7374  tegtest.def test
+0000ea10: 5f73 7461 7465 5f65 7374 696d 6174 655f  _state_estimate_
+0000ea20: 6572 726f 7228 293a 0a0a 2020 2020 7379  error():..    sy
+0000ea30: 7374 203d 206d 616b 655f 7379 7374 656d  st = make_system
+0000ea40: 2829 2e66 696e 616c 697a 6564 2829 0a20  ().finalized(). 
+0000ea50: 2020 2064 656e 7369 7479 5f73 756d 203d     density_sum =
+0000ea60: 206b 7761 6e74 2e6f 7065 7261 746f 722e   kwant.operator.
+0000ea70: 4465 6e73 6974 7928 7379 7374 2c20 7375  Density(syst, su
+0000ea80: 6d3d 5472 7565 290a 2020 2020 6465 6e73  m=True).    dens
+0000ea90: 6974 795f 6f70 6572 6174 6f72 203d 206b  ity_operator = k
+0000eaa0: 7761 6e74 2e6f 7065 7261 746f 722e 4465  want.operator.De
+0000eab0: 6e73 6974 7928 7379 7374 290a 2020 2020  nsity(syst).    
+0000eac0: 6375 7272 656e 745f 6f70 6572 6174 6f72  current_operator
+0000ead0: 203d 206b 7761 6e74 2e6f 7065 7261 746f   = kwant.operato
+0000eae0: 722e 4375 7272 656e 7428 7379 7374 290a  r.Current(syst).
+0000eaf0: 0a20 2020 2063 6865 6d69 6361 6c5f 706f  .    chemical_po
+0000eb00: 7465 6e74 6961 6c20 3d20 330a 2020 2020  tential = 3.    
+0000eb10: 746d 6178 203d 2035 3030 0a20 2020 2070  tmax = 500.    p
+0000eb20: 6172 616d 7320 3d20 7b27 7627 3a20 302e  arams = {'v': 0.
+0000eb30: 3030 3031 2c20 2774 3027 3a20 302c 2027  0001, 't0': 0, '
+0000eb40: 4127 3a20 302e 3030 3135 372c 2027 7369  A': 0.00157, 'si
+0000eb50: 676d 6127 3a20 3234 7d0a 0a20 2020 206f  gma': 24}..    o
+0000eb60: 6363 7570 6174 696f 6e20 3d20 6d61 6e79  ccupation = many
+0000eb70: 626f 6479 2e6c 6561 645f 6f63 6375 7061  body.lead_occupa
+0000eb80: 7469 6f6e 2863 6865 6d69 6361 6c5f 706f  tion(chemical_po
+0000eb90: 7465 6e74 6961 6c29 0a20 2020 2073 7461  tential).    sta
+0000eba0: 7465 203d 206d 616e 7962 6f64 792e 5374  te = manybody.St
+0000ebb0: 6174 6528 7379 7374 2c20 746d 6178 2c20  ate(syst, tmax, 
+0000ebc0: 6f63 6375 7061 7469 6f6e 2c20 7061 7261  occupation, para
+0000ebd0: 6d73 3d70 6172 616d 732c 2072 6566 696e  ms=params, refin
+0000ebe0: 653d 4661 6c73 6529 0a0a 2020 2020 7368  e=False)..    sh
+0000ebf0: 6170 655f 6465 6e73 6974 795f 7375 6d20  ape_density_sum 
+0000ec00: 3d20 7374 6174 652e 6576 616c 7561 7465  = state.evaluate
+0000ec10: 2864 656e 7369 7479 5f73 756d 292e 7368  (density_sum).sh
+0000ec20: 6170 650a 2020 2020 7368 6170 655f 6465  ape.    shape_de
+0000ec30: 6e73 6974 7920 3d20 7374 6174 652e 6576  nsity = state.ev
+0000ec40: 616c 7561 7465 2864 656e 7369 7479 5f6f  aluate(density_o
+0000ec50: 7065 7261 746f 7229 2e73 6861 7065 0a20  perator).shape. 
+0000ec60: 2020 2073 6861 7065 5f63 7572 7265 6e74     shape_current
+0000ec70: 203d 2073 7461 7465 2e65 7661 6c75 6174   = state.evaluat
+0000ec80: 6528 6375 7272 656e 745f 6f70 6572 6174  e(current_operat
+0000ec90: 6f72 292e 7368 6170 650a 0a20 2020 2061  or).shape..    a
+0000eca0: 7373 6572 7420 7368 6170 655f 6465 6e73  ssert shape_dens
+0000ecb0: 6974 795f 7375 6d20 3d3d 2028 290a 2020  ity_sum == ().  
+0000ecc0: 2020 6173 7365 7274 2073 6861 7065 5f64    assert shape_d
+0000ecd0: 656e 7369 7479 5f73 756d 2021 3d20 7368  ensity_sum != sh
+0000ece0: 6170 655f 6465 6e73 6974 7920 2023 206d  ape_density  # m
+0000ecf0: 616b 6520 7375 7265 2074 6f20 6d65 6173  ake sure to meas
+0000ed00: 7572 6520 6e6f 7420 7468 6520 7361 6d65  ure not the same
+0000ed10: 0a20 2020 2061 7373 6572 7420 7368 6170  .    assert shap
+0000ed20: 655f 6465 6e73 6974 795f 7375 6d20 213d  e_density_sum !=
+0000ed30: 2073 6861 7065 5f63 7572 7265 6e74 2020   shape_current  
+0000ed40: 2320 6d61 6b65 2073 7572 6520 746f 206d  # make sure to m
+0000ed50: 6561 7375 7265 206e 6f74 2074 6865 2073  easure not the s
+0000ed60: 616d 650a 2020 2020 6173 7365 7274 2073  ame.    assert s
+0000ed70: 6861 7065 5f64 656e 7369 7479 2021 3d20  hape_density != 
+0000ed80: 7368 6170 655f 6375 7272 656e 7420 2023  shape_current  #
+0000ed90: 206d 616b 6520 7375 7265 2074 6f20 6d65   make sure to me
+0000eda0: 6173 7572 6520 6e6f 7420 7468 6520 7361  asure not the sa
+0000edb0: 6d65 0a0a 2020 2020 696e 7465 7276 616c  me..    interval
+0000edc0: 7320 3d20 7374 6174 652e 6765 745f 696e  s = state.get_in
+0000edd0: 7465 7276 616c 7328 290a 0a20 2020 2023  tervals()..    #
+0000ede0: 202d 2d2d 2064 656e 7369 7479 2069 7320   --- density is 
+0000edf0: 7468 6520 6465 6661 756c 7420 6f70 6572  the default oper
+0000ee00: 6174 6f72 2074 6f20 6d65 6173 7572 6520  ator to measure 
+0000ee10: 7468 6520 6572 726f 720a 0a20 2020 2023  the error..    #
+0000ee20: 206d 6178 696d 756d 2065 7272 6f72 2c20   maximum error, 
+0000ee30: 7375 6d6d 6564 206f 7665 7220 616c 6c20  summed over all 
+0000ee40: 696e 7465 7276 616c 730a 2020 2020 6572  intervals.    er
+0000ee50: 726f 7273 203d 2073 7461 7465 2e65 7374  rors = state.est
+0000ee60: 696d 6174 655f 6572 726f 7228 290a 2020  imate_error().  
+0000ee70: 2020 6173 7365 7274 2065 7272 6f72 732e    assert errors.
+0000ee80: 7368 6170 6520 3d3d 2028 290a 0a20 2020  shape == ()..   
+0000ee90: 2023 2065 7272 6f72 206f 7665 7220 6172   # error over ar
+0000eea0: 7261 792c 2073 756d 6d65 6420 6f76 6572  ray, summed over
+0000eeb0: 2061 6c6c 2069 6e74 6572 7661 6c73 0a20   all intervals. 
+0000eec0: 2020 2065 7272 6f72 7320 3d20 7374 6174     errors = stat
+0000eed0: 652e 6573 7469 6d61 7465 5f65 7272 6f72  e.estimate_error
+0000eee0: 2866 756c 6c5f 6f75 7470 7574 3d54 7275  (full_output=Tru
+0000eef0: 6529 0a20 2020 2061 7373 6572 7420 6572  e).    assert er
+0000ef00: 726f 7273 2e73 6861 7065 203d 3d20 7368  rors.shape == sh
+0000ef10: 6170 655f 6465 6e73 6974 790a 0a20 2020  ape_density..   
+0000ef20: 2023 206d 6178 696d 756d 2065 7272 6f72   # maximum error
+0000ef30: 2070 6572 2069 6e74 6572 7661 6c0a 2020   per interval.  
+0000ef40: 2020 6572 726f 7273 203d 2073 7461 7465    errors = state
+0000ef50: 2e65 7374 696d 6174 655f 6572 726f 7228  .estimate_error(
+0000ef60: 696e 7465 7276 616c 733d 696e 7465 7276  intervals=interv
+0000ef70: 616c 7329 0a20 2020 2061 7373 6572 7420  als).    assert 
+0000ef80: 6572 726f 7273 2e73 6861 7065 203d 3d20  errors.shape == 
+0000ef90: 286c 656e 2869 6e74 6572 7661 6c73 292c  (len(intervals),
+0000efa0: 290a 0a20 2020 2023 2065 7272 6f72 206f  )..    # error o
+0000efb0: 7665 7220 6172 7261 7920 7065 7220 696e  ver array per in
+0000efc0: 7465 7276 616c 0a20 2020 2065 7272 6f72  terval.    error
+0000efd0: 7320 3d20 7374 6174 652e 6573 7469 6d61  s = state.estima
+0000efe0: 7465 5f65 7272 6f72 2869 6e74 6572 7661  te_error(interva
+0000eff0: 6c73 3d69 6e74 6572 7661 6c73 2c20 6675  ls=intervals, fu
+0000f000: 6c6c 5f6f 7574 7075 743d 5472 7565 290a  ll_output=True).
+0000f010: 2020 2020 6173 7365 7274 2065 7272 6f72      assert error
+0000f020: 732e 7368 6170 6520 3d3d 2028 6c65 6e28  s.shape == (len(
+0000f030: 696e 7465 7276 616c 7329 2c29 202b 2073  intervals),) + s
+0000f040: 6861 7065 5f64 656e 7369 7479 0a0a 2020  hape_density..  
+0000f050: 2020 2320 6d61 7869 6d75 6d20 6572 726f    # maximum erro
+0000f060: 7220 6f66 2061 2073 696e 676c 6520 696e  r of a single in
+0000f070: 7465 7276 616c 0a20 2020 2065 7272 6f72  terval.    error
+0000f080: 7320 3d20 7374 6174 652e 6573 7469 6d61  s = state.estima
+0000f090: 7465 5f65 7272 6f72 2869 6e74 6572 7661  te_error(interva
+0000f0a0: 6c73 3d69 6e74 6572 7661 6c73 5b30 5d29  ls=intervals[0])
+0000f0b0: 0a20 2020 2061 7373 6572 7420 6572 726f  .    assert erro
+0000f0c0: 7273 2e73 6861 7065 203d 3d20 2829 0a0a  rs.shape == ()..
+0000f0d0: 2020 2020 2320 6572 726f 7220 6f76 6572      # error over
+0000f0e0: 2061 7272 6179 206f 6620 6120 7369 6e67   array of a sing
+0000f0f0: 6c65 2069 6e74 6572 7661 6c0a 2020 2020  le interval.    
+0000f100: 6572 726f 7273 203d 2073 7461 7465 2e65  errors = state.e
+0000f110: 7374 696d 6174 655f 6572 726f 7228 696e  stimate_error(in
+0000f120: 7465 7276 616c 733d 696e 7465 7276 616c  tervals=interval
+0000f130: 735b 305d 2c20 6675 6c6c 5f6f 7574 7075  s[0], full_outpu
+0000f140: 743d 5472 7565 290a 2020 2020 6173 7365  t=True).    asse
+0000f150: 7274 2065 7272 6f72 732e 7368 6170 6520  rt errors.shape 
+0000f160: 3d3d 2073 6861 7065 5f64 656e 7369 7479  == shape_density
+0000f170: 0a0a 2020 2020 2320 2d2d 2d20 6d65 6173  ..    # --- meas
+0000f180: 7572 6520 7468 6520 6572 726f 7220 7769  ure the error wi
+0000f190: 7468 2074 6865 2063 7572 7265 6e74 206f  th the current o
+0000f1a0: 7065 7261 746f 720a 0a20 2020 2023 206d  perator..    # m
+0000f1b0: 6178 696d 756d 2065 7272 6f72 2c20 7375  aximum error, su
+0000f1c0: 6d6d 6564 206f 7665 7220 616c 6c20 696e  mmed over all in
+0000f1d0: 7465 7276 616c 730a 2020 2020 6572 726f  tervals.    erro
+0000f1e0: 7273 203d 2073 7461 7465 2e65 7374 696d  rs = state.estim
+0000f1f0: 6174 655f 6572 726f 7228 6572 726f 725f  ate_error(error_
+0000f200: 6f70 3d63 7572 7265 6e74 5f6f 7065 7261  op=current_opera
+0000f210: 746f 7229 0a20 2020 2061 7373 6572 7420  tor).    assert 
+0000f220: 6572 726f 7273 2e73 6861 7065 203d 3d20  errors.shape == 
+0000f230: 2829 0a0a 2020 2020 2320 6572 726f 7220  ()..    # error 
+0000f240: 6f76 6572 2061 7272 6179 2c20 7375 6d6d  over array, summ
+0000f250: 6564 206f 7665 7220 616c 6c20 696e 7465  ed over all inte
+0000f260: 7276 616c 730a 2020 2020 6572 726f 7273  rvals.    errors
+0000f270: 203d 2073 7461 7465 2e65 7374 696d 6174   = state.estimat
+0000f280: 655f 6572 726f 7228 6572 726f 725f 6f70  e_error(error_op
+0000f290: 3d63 7572 7265 6e74 5f6f 7065 7261 746f  =current_operato
+0000f2a0: 722c 2066 756c 6c5f 6f75 7470 7574 3d54  r, full_output=T
+0000f2b0: 7275 6529 0a20 2020 2061 7373 6572 7420  rue).    assert 
+0000f2c0: 6572 726f 7273 2e73 6861 7065 203d 3d20  errors.shape == 
+0000f2d0: 7368 6170 655f 6375 7272 656e 740a 0a20  shape_current.. 
+0000f2e0: 2020 2023 206d 6178 696d 756d 2065 7272     # maximum err
+0000f2f0: 6f72 2070 6572 2069 6e74 6572 7661 6c0a  or per interval.
+0000f300: 2020 2020 6572 726f 7273 203d 2073 7461      errors = sta
+0000f310: 7465 2e65 7374 696d 6174 655f 6572 726f  te.estimate_erro
+0000f320: 7228 6572 726f 725f 6f70 3d63 7572 7265  r(error_op=curre
+0000f330: 6e74 5f6f 7065 7261 746f 722c 2069 6e74  nt_operator, int
+0000f340: 6572 7661 6c73 3d69 6e74 6572 7661 6c73  ervals=intervals
+0000f350: 290a 2020 2020 6173 7365 7274 2065 7272  ).    assert err
+0000f360: 6f72 732e 7368 6170 6520 3d3d 2028 6c65  ors.shape == (le
+0000f370: 6e28 696e 7465 7276 616c 7329 2c29 0a0a  n(intervals),)..
+0000f380: 2020 2020 2320 6572 726f 7220 6f76 6572      # error over
+0000f390: 2061 7272 6179 2070 6572 2069 6e74 6572   array per inter
+0000f3a0: 7661 6c0a 2020 2020 6572 726f 7273 203d  val.    errors =
+0000f3b0: 2073 7461 7465 2e65 7374 696d 6174 655f   state.estimate_
+0000f3c0: 6572 726f 7228 6572 726f 725f 6f70 3d63  error(error_op=c
+0000f3d0: 7572 7265 6e74 5f6f 7065 7261 746f 722c  urrent_operator,
+0000f3e0: 2069 6e74 6572 7661 6c73 3d69 6e74 6572   intervals=inter
+0000f3f0: 7661 6c73 2c20 6675 6c6c 5f6f 7574 7075  vals, full_outpu
+0000f400: 743d 5472 7565 290a 2020 2020 6173 7365  t=True).    asse
+0000f410: 7274 2065 7272 6f72 732e 7368 6170 6520  rt errors.shape 
+0000f420: 3d3d 2028 6c65 6e28 696e 7465 7276 616c  == (len(interval
+0000f430: 7329 2c29 202b 2073 6861 7065 5f63 7572  s),) + shape_cur
+0000f440: 7265 6e74 0a0a 2020 2020 2320 2d2d 2061  rent..    # -- a
+0000f450: 6e20 6f70 6572 6174 6f72 2077 6974 6820  n operator with 
+0000f460: 6120 7363 616c 6172 206f 7574 7075 740a  a scalar output.
+0000f470: 0a20 2020 2023 206d 6178 696d 756d 2065  .    # maximum e
+0000f480: 7272 6f72 2c20 7375 6d6d 6564 206f 7665  rror, summed ove
+0000f490: 7220 616c 6c20 696e 7465 7276 616c 730a  r all intervals.
+0000f4a0: 2020 2020 6572 726f 7273 203d 2073 7461      errors = sta
+0000f4b0: 7465 2e65 7374 696d 6174 655f 6572 726f  te.estimate_erro
+0000f4c0: 7228 6572 726f 725f 6f70 3d64 656e 7369  r(error_op=densi
+0000f4d0: 7479 5f73 756d 290a 2020 2020 6173 7365  ty_sum).    asse
+0000f4e0: 7274 2065 7272 6f72 732e 7368 6170 6520  rt errors.shape 
+0000f4f0: 3d3d 2028 290a 0a20 2020 2023 2065 7272  == ()..    # err
+0000f500: 6f72 206f 7665 7220 6172 7261 792c 2073  or over array, s
+0000f510: 756d 6d65 6420 6f76 6572 2061 6c6c 2069  ummed over all i
+0000f520: 6e74 6572 7661 6c73 0a20 2020 2065 7272  ntervals.    err
+0000f530: 6f72 7320 3d20 7374 6174 652e 6573 7469  ors = state.esti
+0000f540: 6d61 7465 5f65 7272 6f72 2865 7272 6f72  mate_error(error
+0000f550: 5f6f 703d 6465 6e73 6974 795f 7375 6d2c  _op=density_sum,
+0000f560: 2066 756c 6c5f 6f75 7470 7574 3d54 7275   full_output=Tru
+0000f570: 6529 0a20 2020 2061 7373 6572 7420 6572  e).    assert er
+0000f580: 726f 7273 2e73 6861 7065 203d 3d20 7368  rors.shape == sh
+0000f590: 6170 655f 6465 6e73 6974 795f 7375 6d0a  ape_density_sum.
+0000f5a0: 0a20 2020 2023 206d 6178 696d 756d 2065  .    # maximum e
+0000f5b0: 7272 6f72 2070 6572 2069 6e74 6572 7661  rror per interva
+0000f5c0: 6c0a 2020 2020 6572 726f 7273 203d 2073  l.    errors = s
+0000f5d0: 7461 7465 2e65 7374 696d 6174 655f 6572  tate.estimate_er
+0000f5e0: 726f 7228 6572 726f 725f 6f70 3d64 656e  ror(error_op=den
+0000f5f0: 7369 7479 5f73 756d 2c20 696e 7465 7276  sity_sum, interv
+0000f600: 616c 733d 696e 7465 7276 616c 7329 0a20  als=intervals). 
+0000f610: 2020 2061 7373 6572 7420 6572 726f 7273     assert errors
+0000f620: 2e73 6861 7065 203d 3d20 286c 656e 2869  .shape == (len(i
+0000f630: 6e74 6572 7661 6c73 292c 290a 0a20 2020  ntervals),)..   
+0000f640: 2023 2065 7272 6f72 206f 7665 7220 6172   # error over ar
+0000f650: 7261 7920 7065 7220 696e 7465 7276 616c  ray per interval
+0000f660: 0a20 2020 2065 7272 6f72 7320 3d20 7374  .    errors = st
+0000f670: 6174 652e 6573 7469 6d61 7465 5f65 7272  ate.estimate_err
+0000f680: 6f72 2865 7272 6f72 5f6f 703d 6465 6e73  or(error_op=dens
+0000f690: 6974 795f 7375 6d2c 2069 6e74 6572 7661  ity_sum, interva
+0000f6a0: 6c73 3d69 6e74 6572 7661 6c73 2c20 6675  ls=intervals, fu
+0000f6b0: 6c6c 5f6f 7574 7075 743d 5472 7565 290a  ll_output=True).
+0000f6c0: 2020 2020 6173 7365 7274 2065 7272 6f72      assert error
+0000f6d0: 732e 7368 6170 6520 3d3d 2028 6c65 6e28  s.shape == (len(
+0000f6e0: 696e 7465 7276 616c 7329 2c29 202b 2073  intervals),) + s
+0000f6f0: 6861 7065 5f64 656e 7369 7479 5f73 756d  hape_density_sum
+0000f700: 0a0a 2020 2020 2320 2d2d 2d20 7365 7420  ..    # --- set 
+0000f710: 6375 7272 656e 7420 6f70 6572 6174 6f72  current operator
+0000f720: 2061 7320 6465 6661 756c 7420 6672 6f6d   as default from
+0000f730: 2074 6865 2062 6567 696e 6e69 6e67 0a0a   the beginning..
+0000f740: 2020 2020 7374 6174 6520 3d20 6d61 6e79      state = many
+0000f750: 626f 6479 2e53 7461 7465 2873 7973 742c  body.State(syst,
+0000f760: 2074 6d61 782c 206f 6363 7570 6174 696f   tmax, occupatio
+0000f770: 6e2c 2070 6172 616d 733d 7061 7261 6d73  n, params=params
+0000f780: 2c0a 2020 2020 2020 2020 2020 2020 2020  ,.              
+0000f790: 2020 2020 2020 2020 2020 2020 2065 7272               err
+0000f7a0: 6f72 5f6f 703d 6375 7272 656e 745f 6f70  or_op=current_op
+0000f7b0: 6572 6174 6f72 2c20 7265 6669 6e65 3d46  erator, refine=F
+0000f7c0: 616c 7365 290a 0a20 2020 2065 7272 6f72  alse)..    error
+0000f7d0: 7320 3d20 7374 6174 652e 6573 7469 6d61  s = state.estima
+0000f7e0: 7465 5f65 7272 6f72 2829 0a20 2020 2061  te_error().    a
+0000f7f0: 7373 6572 7420 6572 726f 7273 2e73 6861  ssert errors.sha
+0000f800: 7065 203d 3d20 2829 0a0a 2020 2020 2320  pe == ()..    # 
+0000f810: 6572 726f 7220 6f76 6572 2061 7272 6179  error over array
+0000f820: 2c20 7375 6d6d 6564 206f 7665 7220 616c  , summed over al
+0000f830: 6c20 696e 7465 7276 616c 730a 2020 2020  l intervals.    
+0000f840: 6572 726f 7273 203d 2073 7461 7465 2e65  errors = state.e
+0000f850: 7374 696d 6174 655f 6572 726f 7228 6675  stimate_error(fu
+0000f860: 6c6c 5f6f 7574 7075 743d 5472 7565 290a  ll_output=True).
+0000f870: 2020 2020 6173 7365 7274 2065 7272 6f72      assert error
+0000f880: 732e 7368 6170 6520 3d3d 2073 6861 7065  s.shape == shape
+0000f890: 5f63 7572 7265 6e74 0a0a 2020 2020 2320  _current..    # 
+0000f8a0: 6d61 7869 6d75 6d20 6572 726f 7220 7065  maximum error pe
+0000f8b0: 7220 696e 7465 7276 616c 0a20 2020 2065  r interval.    e
+0000f8c0: 7272 6f72 7320 3d20 7374 6174 652e 6573  rrors = state.es
+0000f8d0: 7469 6d61 7465 5f65 7272 6f72 2869 6e74  timate_error(int
+0000f8e0: 6572 7661 6c73 3d69 6e74 6572 7661 6c73  ervals=intervals
+0000f8f0: 290a 2020 2020 6173 7365 7274 2065 7272  ).    assert err
+0000f900: 6f72 732e 7368 6170 6520 3d3d 2028 6c65  ors.shape == (le
+0000f910: 6e28 696e 7465 7276 616c 7329 2c29 0a0a  n(intervals),)..
+0000f920: 2020 2020 2320 6572 726f 7220 6f76 6572      # error over
+0000f930: 2061 7272 6179 2070 6572 2069 6e74 6572   array per inter
+0000f940: 7661 6c0a 2020 2020 6572 726f 7273 203d  val.    errors =
+0000f950: 2073 7461 7465 2e65 7374 696d 6174 655f   state.estimate_
+0000f960: 6572 726f 7228 696e 7465 7276 616c 733d  error(intervals=
+0000f970: 696e 7465 7276 616c 732c 2066 756c 6c5f  intervals, full_
+0000f980: 6f75 7470 7574 3d54 7275 6529 0a20 2020  output=True).   
+0000f990: 2061 7373 6572 7420 6572 726f 7273 2e73   assert errors.s
+0000f9a0: 6861 7065 203d 3d20 286c 656e 2869 6e74  hape == (len(int
+0000f9b0: 6572 7661 6c73 292c 2920 2b20 7368 6170  ervals),) + shap
+0000f9c0: 655f 6375 7272 656e 740a 0a0a 4070 7974  e_current...@pyt
+0000f9d0: 6573 742e 6d61 726b 2e69 6e74 6567 7465  est.mark.integte
+0000f9e0: 7374 2020 2320 6d61 726b 6572 2066 6f72  st  # marker for
+0000f9f0: 2069 6e74 6567 7261 7469 6f6e 2074 6573   integration tes
+0000fa00: 7473 0a64 6566 2074 6573 745f 6d61 6e79  ts.def test_many
+0000fa10: 626f 6479 5f73 7461 7465 5f65 7374 696d  body_state_estim
+0000fa20: 6174 655f 6572 726f 725f 6e6f 6e5f 6b72  ate_error_non_kr
+0000fa30: 6f6e 726f 6428 293a 0a0a 2020 2020 7379  onrod():..    sy
+0000fa40: 7374 203d 206d 616b 655f 7379 7374 656d  st = make_system
+0000fa50: 2829 2e66 696e 616c 697a 6564 2829 0a0a  ().finalized()..
+0000fa60: 2020 2020 746d 6178 203d 2035 3030 0a20      tmax = 500. 
+0000fa70: 2020 2070 6172 616d 7320 3d20 7b27 7627     params = {'v'
+0000fa80: 3a20 302e 3030 3031 2c20 2774 3027 3a20  : 0.0001, 't0': 
+0000fa90: 302c 2027 4127 3a20 302e 3030 3135 372c  0, 'A': 0.00157,
+0000faa0: 2027 7369 676d 6127 3a20 3234 7d0a 0a20   'sigma': 24}.. 
+0000fab0: 2020 206f 6363 7570 6174 696f 6e20 3d20     occupation = 
+0000fac0: 6d61 6e79 626f 6479 2e6c 6561 645f 6f63  manybody.lead_oc
+0000fad0: 6375 7061 7469 6f6e 2863 6865 6d69 6361  cupation(chemica
+0000fae0: 6c5f 706f 7465 6e74 6961 6c3d 3329 0a0a  l_potential=3)..
+0000faf0: 2020 2020 7374 6174 6520 3d20 6d61 6e79      state = many
+0000fb00: 626f 6479 2e53 7461 7465 2873 7973 742c  body.State(syst,
+0000fb10: 2074 6d61 782c 206f 6363 7570 6174 696f   tmax, occupatio
+0000fb20: 6e2c 2070 6172 616d 733d 7061 7261 6d73  n, params=params
+0000fb30: 2c20 7265 6669 6e65 3d46 616c 7365 290a  , refine=False).
+0000fb40: 2020 2020 696e 7465 7276 616c 7320 3d20      intervals = 
+0000fb50: 7374 6174 652e 6765 745f 696e 7465 7276  state.get_interv
+0000fb60: 616c 7328 290a 2020 2020 6761 7573 735f  als().    gauss_
+0000fb70: 696e 7465 7276 616c 203d 2069 6e74 6572  interval = inter
+0000fb80: 7661 6c73 5b30 5d0a 2020 2020 6761 7573  vals[0].    gaus
+0000fb90: 735f 696e 7465 7276 616c 2e71 7561 6472  s_interval.quadr
+0000fba0: 6174 7572 6520 3d20 2767 6175 7373 6c65  ature = 'gaussle
+0000fbb0: 6765 6e64 7265 270a 0a20 2020 2077 6974  gendre'..    wit
+0000fbc0: 6820 7079 7465 7374 2e72 6169 7365 7328  h pytest.raises(
+0000fbd0: 5661 6c75 6545 7272 6f72 2920 6173 2065  ValueError) as e
+0000fbe0: 7863 3a0a 2020 2020 2020 2020 7374 6174  xc:.        stat
+0000fbf0: 652e 6573 7469 6d61 7465 5f65 7272 6f72  e.estimate_error
+0000fc00: 2869 6e74 6572 7661 6c73 3d67 6175 7373  (intervals=gauss
+0000fc10: 5f69 6e74 6572 7661 6c29 0a20 2020 2061  _interval).    a
+0000fc20: 7373 6572 7420 7374 7228 6578 632e 7661  ssert str(exc.va
+0000fc30: 6c75 6529 2069 6e20 2271 7561 6470 6163  lue) in "quadpac
+0000fc40: 6b20 6572 726f 7220 6573 7469 6d61 7465  k error estimate
+0000fc50: 2077 6f72 6b73 206f 6e6c 7920 6f6e 2047   works only on G
+0000fc60: 6175 7373 2d4b 726f 6e72 6f64 2071 7561  auss-Kronrod qua
+0000fc70: 6472 6174 7572 6520 696e 7465 7276 616c  drature interval
+0000fc80: 7322 0a0a 0a40 7079 7465 7374 2e6d 6172  s"...@pytest.mar
+0000fc90: 6b2e 696e 7465 6774 6573 7420 2023 206d  k.integtest  # m
+0000fca0: 6172 6b65 7220 666f 7220 696e 7465 6772  arker for integr
+0000fcb0: 6174 696f 6e20 7465 7374 730a 6465 6620  ation tests.def 
+0000fcc0: 7465 7374 5f74 696d 655f 6e61 6d65 5f61  test_time_name_a
+0000fcd0: 6e64 5f73 7461 7274 5f64 6566 6175 6c74  nd_start_default
+0000fce0: 5f63 6861 6e67 655f 6d61 6e79 626f 6479  _change_manybody
+0000fcf0: 5f73 7461 7465 2829 3a0a 0a20 2020 204e  _state():..    N
+0000fd00: 203d 2033 0a20 2020 206c 6174 203d 206b   = 3.    lat = k
+0000fd10: 7761 6e74 2e6c 6174 7469 6365 2e73 7175  want.lattice.squ
+0000fd20: 6172 6528 6e6f 7262 733d 3229 0a20 2020  are(norbs=2).   
+0000fd30: 2049 3020 3d20 7461 2e69 6465 6e74 6974   I0 = ta.identit
+0000fd40: 7928 3229 0a20 2020 2053 5a20 3d20 7461  y(2).    SZ = ta
+0000fd50: 2e61 7272 6179 285b 5b31 2c20 305d 2c20  .array([[1, 0], 
+0000fd60: 5b30 2c20 2d31 5d5d 290a 2020 2020 756e  [0, -1]]).    un
+0000fd70: 6966 6f72 6d20 3d20 6b77 616e 742e 6469  iform = kwant.di
+0000fd80: 6765 7374 2e75 6e69 666f 726d 0a0a 2020  gest.uniform..  
+0000fd90: 2020 746d 6178 203d 2031 3030 0a20 2020    tmax = 100.   
+0000fda0: 2070 6172 616d 7320 3d20 7b27 7361 6c74   params = {'salt
+0000fdb0: 273a 2027 3127 7d0a 2020 2020 6f63 6375  ': '1'}.    occu
+0000fdc0: 7061 7469 6f6e 203d 206d 616e 7962 6f64  pation = manybod
+0000fdd0: 792e 6c65 6164 5f6f 6363 7570 6174 696f  y.lead_occupatio
+0000fde0: 6e28 6368 656d 6963 616c 5f70 6f74 656e  n(chemical_poten
+0000fdf0: 7469 616c 3d31 290a 0a20 2020 2064 6566  tial=1)..    def
+0000fe00: 206d 616b 655f 7369 6d70 6c65 5f6c 6561   make_simple_lea
+0000fe10: 6428 6c61 742c 204e 293a 0a20 2020 2020  d(lat, N):.     
+0000fe20: 2020 2049 3020 3d20 7461 2e69 6465 6e74     I0 = ta.ident
+0000fe30: 6974 7928 6c61 742e 6e6f 7262 7329 0a20  ity(lat.norbs). 
+0000fe40: 2020 2020 2020 2073 7973 7420 3d20 6b77         syst = kw
+0000fe50: 616e 742e 4275 696c 6465 7228 6b77 616e  ant.Builder(kwan
+0000fe60: 742e 5472 616e 736c 6174 696f 6e61 6c53  t.TranslationalS
+0000fe70: 796d 6d65 7472 7928 282d 312c 2030 2929  ymmetry((-1, 0))
+0000fe80: 290a 2020 2020 2020 2020 7379 7374 5b28  ).        syst[(
+0000fe90: 6c61 7428 302c 206a 2920 666f 7220 6a20  lat(0, j) for j 
+0000fea0: 696e 2072 616e 6765 284e 2929 5d20 3d20  in range(N))] = 
+0000feb0: 3420 2a20 4930 0a20 2020 2020 2020 2073  4 * I0.        s
+0000fec0: 7973 745b 6c61 742e 6e65 6967 6862 6f72  yst[lat.neighbor
+0000fed0: 7328 295d 203d 202d 3120 2a20 4930 0a20  s()] = -1 * I0. 
+0000fee0: 2020 2020 2020 2072 6574 7572 6e20 7379         return sy
+0000fef0: 7374 0a0a 2020 2020 6465 6620 7464 5f6f  st..    def td_o
+0000ff00: 6e73 6974 655f 7469 6d65 2873 6974 652c  nsite_time(site,
+0000ff10: 2074 696d 652c 2073 616c 7429 3a0a 2020   time, salt):.  
+0000ff20: 2020 2020 2020 7374 6174 6963 5f70 6172        static_par
+0000ff30: 7420 3d20 2834 202b 2075 6e69 666f 726d  t = (4 + uniform
+0000ff40: 2873 6974 652e 7461 672c 2073 616c 743d  (site.tag, salt=
+0000ff50: 7361 6c74 2929 202a 2049 300a 2020 2020  salt)) * I0.    
+0000ff60: 2020 2020 7464 5f70 6172 7420 3d20 535a      td_part = SZ
+0000ff70: 202a 2073 696e 2874 696d 6529 0a20 2020   * sin(time).   
+0000ff80: 2020 2020 2072 6574 7572 6e20 7374 6174       return stat
+0000ff90: 6963 5f70 6172 7420 2b20 7464 5f70 6172  ic_part + td_par
+0000ffa0: 740a 0a20 2020 2064 6566 2070 6869 5f74  t..    def phi_t
+0000ffb0: 696d 6528 7469 6d65 2c20 7361 6c74 293a  ime(time, salt):
+0000ffc0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000ffd0: 2831 202d 2063 6f73 2874 696d 6529 2920  (1 - cos(time)) 
+0000ffe0: 2a20 7461 2e61 7272 6179 285b 312c 202d  * ta.array([1, -
+0000fff0: 315d 2920 2023 2064 6961 676f 6e61 6c20  1])  # diagonal 
+00010000: 7061 7274 0a0a 2020 2020 7a65 6974 5f6f  part..    zeit_o
+00010010: 6666 7365 7420 3d20 3432 2020 2320 7468  ffset = 42  # th
+00010020: 6520 696e 6974 6961 6c20 7469 6d65 0a0a  e initial time..
+00010030: 2020 2020 6465 6620 7464 5f6f 6e73 6974      def td_onsit
+00010040: 655f 7a65 6974 2873 6974 652c 207a 6569  e_zeit(site, zei
+00010050: 742c 2073 616c 7429 3a0a 2020 2020 2020  t, salt):.      
+00010060: 2020 7469 6d65 203d 207a 6569 7420 2d20    time = zeit - 
+00010070: 7a65 6974 5f6f 6666 7365 740a 2020 2020  zeit_offset.    
+00010080: 2020 2020 7374 6174 6963 5f70 6172 7420      static_part 
+00010090: 3d20 2834 202b 2075 6e69 666f 726d 2873  = (4 + uniform(s
+000100a0: 6974 652e 7461 672c 2073 616c 743d 7361  ite.tag, salt=sa
+000100b0: 6c74 2929 202a 2049 300a 2020 2020 2020  lt)) * I0.      
+000100c0: 2020 7464 5f70 6172 7420 3d20 535a 202a    td_part = SZ *
+000100d0: 2073 696e 2874 696d 6529 0a20 2020 2020   sin(time).     
+000100e0: 2020 2072 6574 7572 6e20 7374 6174 6963     return static
+000100f0: 5f70 6172 7420 2b20 7464 5f70 6172 740a  _part + td_part.
+00010100: 0a20 2020 2064 6566 2070 6869 5f7a 6569  .    def phi_zei
+00010110: 7428 7a65 6974 2c20 7361 6c74 293a 0a20  t(zeit, salt):. 
+00010120: 2020 2020 2020 2074 696d 6520 3d20 7a65         time = ze
+00010130: 6974 202d 207a 6569 745f 6f66 6673 6574  it - zeit_offset
+00010140: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00010150: 2831 202d 2063 6f73 2874 696d 6529 2920  (1 - cos(time)) 
+00010160: 2a20 7461 2e61 7272 6179 285b 312c 202d  * ta.array([1, -
+00010170: 315d 2920 2023 2064 6961 676f 6e61 6c20  1])  # diagonal 
+00010180: 7061 7274 0a0a 2020 2020 2320 7465 7374  part..    # test
+00010190: 2077 6865 6e20 6164 6469 6e67 2074 696d   when adding tim
+000101a0: 652d 6465 7065 6e64 656e 7420 766f 6c74  e-dependent volt
+000101b0: 6167 6520 6576 6572 7977 6865 7265 0a20  age everywhere. 
+000101c0: 2020 2073 7973 7420 3d20 6d61 6b65 5f74     syst = make_t
+000101d0: 645f 7379 7374 656d 5f77 6974 685f 6c65  d_system_with_le
+000101e0: 6164 7328 6c61 742c 204e 2c20 6d61 6b65  ads(lat, N, make
+000101f0: 5f73 696d 706c 655f 6c65 6164 2c20 7464  _simple_lead, td
+00010200: 5f6f 6e73 6974 655f 7469 6d65 290a 2020  _onsite_time).  
+00010210: 2020 6c65 6164 732e 6164 645f 766f 6c74    leads.add_volt
+00010220: 6167 6528 7379 7374 2c20 302c 2070 6869  age(syst, 0, phi
+00010230: 5f74 696d 6529 0a20 2020 206c 6561 6473  _time).    leads
+00010240: 2e61 6464 5f76 6f6c 7461 6765 2873 7973  .add_voltage(sys
+00010250: 742c 2031 2c20 7068 695f 7469 6d65 290a  t, 1, phi_time).
+00010260: 2020 2020 6673 7973 745f 7469 6d65 203d      fsyst_time =
+00010270: 2073 7973 742e 6669 6e61 6c69 7a65 6428   syst.finalized(
+00010280: 290a 0a20 2020 2073 7973 7420 3d20 6d61  )..    syst = ma
+00010290: 6b65 5f74 645f 7379 7374 656d 5f77 6974  ke_td_system_wit
+000102a0: 685f 6c65 6164 7328 6c61 742c 204e 2c20  h_leads(lat, N, 
+000102b0: 6d61 6b65 5f73 696d 706c 655f 6c65 6164  make_simple_lead
+000102c0: 2c20 7464 5f6f 6e73 6974 655f 7a65 6974  , td_onsite_zeit
+000102d0: 290a 2020 2020 6c65 6164 732e 6164 645f  ).    leads.add_
+000102e0: 766f 6c74 6167 6528 7379 7374 2c20 302c  voltage(syst, 0,
+000102f0: 2070 6869 5f7a 6569 7429 0a20 2020 206c   phi_zeit).    l
+00010300: 6561 6473 2e61 6464 5f76 6f6c 7461 6765  eads.add_voltage
+00010310: 2873 7973 742c 2031 2c20 7068 695f 7a65  (syst, 1, phi_ze
+00010320: 6974 290a 2020 2020 6673 7973 745f 7a65  it).    fsyst_ze
+00010330: 6974 203d 2073 7973 742e 6669 6e61 6c69  it = syst.finali
+00010340: 7a65 6428 290a 0a20 2020 2064 656e 7369  zed()..    densi
+00010350: 7479 5f6f 7065 7261 746f 725f 7469 6d65  ty_operator_time
+00010360: 203d 206b 7761 6e74 2e6f 7065 7261 746f   = kwant.operato
+00010370: 722e 4465 6e73 6974 7928 6673 7973 745f  r.Density(fsyst_
+00010380: 7469 6d65 290a 2020 2020 6465 6e73 6974  time).    densit
+00010390: 795f 6f70 6572 6174 6f72 5f7a 6569 7420  y_operator_zeit 
+000103a0: 3d20 6b77 616e 742e 6f70 6572 6174 6f72  = kwant.operator
+000103b0: 2e44 656e 7369 7479 2866 7379 7374 5f7a  .Density(fsyst_z
+000103c0: 6569 7429 0a0a 2020 2020 2320 6465 6661  eit)..    # defa
+000103d0: 756c 740a 2020 2020 7374 6174 655f 7469  ult.    state_ti
+000103e0: 6d65 203d 206d 616e 7962 6f64 792e 5374  me = manybody.St
+000103f0: 6174 6528 6673 7973 745f 7469 6d65 2c20  ate(fsyst_time, 
+00010400: 746d 6178 2c20 6f63 6375 7061 7469 6f6e  tmax, occupation
+00010410: 2c20 7061 7261 6d73 3d70 6172 616d 732c  , params=params,
+00010420: 2072 6566 696e 653d 4661 6c73 6529 0a0a   refine=False)..
+00010430: 2020 2020 2320 6465 6661 756c 7420 6368      # default ch
+00010440: 616e 6765 640a 2020 2020 5761 7665 4675  anged.    WaveFu
+00010450: 6e63 7469 6f6e 5f7a 6569 7420 3d20 6675  nction_zeit = fu
+00010460: 6e63 746f 6f6c 732e 7061 7274 6961 6c28  nctools.partial(
+00010470: 6f6e 6562 6f64 792e 5761 7665 4675 6e63  onebody.WaveFunc
+00010480: 7469 6f6e 2e66 726f 6d5f 6b77 616e 742c  tion.from_kwant,
+00010490: 2074 696d 655f 6e61 6d65 3d27 7a65 6974   time_name='zeit
+000104a0: 272c 0a20 2020 2020 2020 2020 2020 2020  ',.             
+000104b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000104c0: 2020 2020 2020 2020 2020 2020 2074 696d               tim
+000104d0: 655f 7374 6172 743d 7a65 6974 5f6f 6666  e_start=zeit_off
+000104e0: 7365 7429 0a20 2020 2073 6361 7474 6572  set).    scatter
+000104f0: 696e 675f 7374 6174 655f 7a65 6974 203d  ing_state_zeit =
+00010500: 2066 756e 6374 6f6f 6c73 2e70 6172 7469   functools.parti
+00010510: 616c 286f 6e65 626f 6479 2e53 6361 7474  al(onebody.Scatt
+00010520: 6572 696e 6753 7461 7465 732c 0a20 2020  eringStates,.   
+00010530: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010550: 2020 2020 2020 2020 2020 2077 6176 6566             wavef
+00010560: 756e 6374 696f 6e5f 7479 7065 3d57 6176  unction_type=Wav
+00010570: 6546 756e 6374 696f 6e5f 7a65 6974 290a  eFunction_zeit).
+00010580: 2020 2020 7374 6174 655f 7a65 6974 203d      state_zeit =
+00010590: 206d 616e 7962 6f64 792e 5374 6174 6528   manybody.State(
+000105a0: 6673 7973 745f 7a65 6974 2c20 746d 6178  fsyst_zeit, tmax
+000105b0: 2c20 6f63 6375 7061 7469 6f6e 2c20 7061  , occupation, pa
+000105c0: 7261 6d73 3d70 6172 616d 732c 0a20 2020  rams=params,.   
+000105d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000105e0: 2020 2020 2020 2020 2020 2020 2073 6361               sca
+000105f0: 7474 6572 696e 675f 7374 6174 655f 7479  ttering_state_ty
+00010600: 7065 3d73 6361 7474 6572 696e 675f 7374  pe=scattering_st
+00010610: 6174 655f 7a65 6974 2c20 7265 6669 6e65  ate_zeit, refine
+00010620: 3d46 616c 7365 290a 0a20 2020 2066 6f72  =False)..    for
+00010630: 2074 696d 6520 696e 2028 302e 2c20 312e   time in (0., 1.
+00010640: 2c20 352e 293a 0a0a 2020 2020 2020 2020  , 5.):..        
+00010650: 7374 6174 655f 7469 6d65 2e65 766f 6c76  state_time.evolv
+00010660: 6528 7469 6d65 290a 2020 2020 2020 2020  e(time).        
+00010670: 7374 6174 655f 7a65 6974 2e65 766f 6c76  state_zeit.evolv
+00010680: 6528 7469 6d65 202b 207a 6569 745f 6f66  e(time + zeit_of
+00010690: 6673 6574 290a 0a20 2020 2020 2020 2066  fset)..        f
+000106a0: 6f72 205f 2c20 7073 6920 696e 2073 7461  or _, psi in sta
+000106b0: 7465 5f74 696d 652e 6d61 6e79 626f 6479  te_time.manybody
+000106c0: 5f77 6176 6566 756e 6374 696f 6e2e 7073  _wavefunction.ps
+000106d0: 692e 5f64 6174 612e 6974 656d 7328 293a  i._data.items():
+000106e0: 0a20 2020 2020 2020 2020 2020 2061 7373  .            ass
+000106f0: 6572 7420 7073 692e 7469 6d65 203d 3d20  ert psi.time == 
+00010700: 7469 6d65 0a20 2020 2020 2020 2020 2020  time.           
+00010710: 2061 7373 6572 7420 7073 692e 7469 6d65   assert psi.time
+00010720: 5f73 7461 7274 203d 3d20 300a 2020 2020  _start == 0.    
+00010730: 2020 2020 2020 2020 6173 7365 7274 2070          assert p
+00010740: 7369 2e74 696d 655f 6e61 6d65 203d 3d20  si.time_name == 
+00010750: 2774 696d 6527 0a0a 2020 2020 2020 2020  'time'..        
+00010760: 666f 7220 5f2c 2070 7369 2069 6e20 7374  for _, psi in st
+00010770: 6174 655f 7a65 6974 2e6d 616e 7962 6f64  ate_zeit.manybod
+00010780: 795f 7761 7665 6675 6e63 7469 6f6e 2e70  y_wavefunction.p
+00010790: 7369 2e5f 6461 7461 2e69 7465 6d73 2829  si._data.items()
+000107a0: 3a0a 2020 2020 2020 2020 2020 2020 6173  :.            as
+000107b0: 7365 7274 2070 7369 2e74 696d 6520 3d3d  sert psi.time ==
+000107c0: 2074 696d 6520 2b20 7a65 6974 5f6f 6666   time + zeit_off
+000107d0: 7365 740a 2020 2020 2020 2020 2020 2020  set.            
+000107e0: 6173 7365 7274 2070 7369 2e74 696d 655f  assert psi.time_
+000107f0: 7374 6172 7420 3d3d 207a 6569 745f 6f66  start == zeit_of
+00010800: 6673 6574 0a20 2020 2020 2020 2020 2020  fset.           
+00010810: 2061 7373 6572 7420 7073 692e 7469 6d65   assert psi.time
+00010820: 5f6e 616d 6520 3d3d 2027 7a65 6974 270a  _name == 'zeit'.
+00010830: 0a20 2020 2020 2020 2023 2063 6865 636b  .        # check
+00010840: 2074 6861 7420 7265 7375 6c74 2069 7320   that result is 
+00010850: 7369 6d69 6c61 7220 746f 2064 6566 6175  similar to defau
+00010860: 6c74 2072 6573 756c 740a 2020 2020 2020  lt result.      
+00010870: 2020 6465 6e73 6974 795f 7469 6d65 203d    density_time =
+00010880: 2073 7461 7465 5f74 696d 652e 6576 616c   state_time.eval
+00010890: 7561 7465 2864 656e 7369 7479 5f6f 7065  uate(density_ope
+000108a0: 7261 746f 725f 7469 6d65 290a 2020 2020  rator_time).    
+000108b0: 2020 2020 6465 6e73 6974 795f 7a65 6974      density_zeit
+000108c0: 203d 2073 7461 7465 5f74 696d 652e 6576   = state_time.ev
+000108d0: 616c 7561 7465 2864 656e 7369 7479 5f6f  aluate(density_o
+000108e0: 7065 7261 746f 725f 7a65 6974 290a 2020  perator_zeit).  
+000108f0: 2020 2020 2020 6173 7365 7274 5f61 7272        assert_arr
+00010900: 6179 5f61 6c6d 6f73 745f 6571 7561 6c28  ay_almost_equal(
+00010910: 6465 6e73 6974 795f 7469 6d65 2c20 6465  density_time, de
+00010920: 6e73 6974 795f 7a65 6974 290a 0a20 2020  nsity_zeit)..   
+00010930: 2066 6f72 2074 3020 696e 205b 3120 2b20   for t0 in [1 + 
+00010940: 316a 2c20 2761 272c 204e 6f6e 652c 202d  1j, 'a', None, -
+00010950: 666c 6f61 7428 2769 6e66 2729 2c20 666c  float('inf'), fl
+00010960: 6f61 7428 2769 6e66 2729 5d3a 0a20 2020  oat('inf')]:.   
+00010970: 2020 2020 2057 6176 6546 756e 6374 696f       WaveFunctio
+00010980: 6e5f 7a65 6974 203d 2066 756e 6374 6f6f  n_zeit = functoo
+00010990: 6c73 2e70 6172 7469 616c 286f 6e65 626f  ls.partial(onebo
+000109a0: 6479 2e57 6176 6546 756e 6374 696f 6e2e  dy.WaveFunction.
+000109b0: 6672 6f6d 5f6b 7761 6e74 2c20 7469 6d65  from_kwant, time
+000109c0: 5f6e 616d 653d 277a 6569 7427 2c0a 2020  _name='zeit',.  
+000109d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109f0: 2020 2020 2020 2020 2020 2020 7469 6d65              time
+00010a00: 5f73 7461 7274 3d74 3029 0a20 2020 2020  _start=t0).     
+00010a10: 2020 2073 6361 7474 6572 696e 675f 7374     scattering_st
+00010a20: 6174 655f 7a65 6974 203d 2066 756e 6374  ate_zeit = funct
+00010a30: 6f6f 6c73 2e70 6172 7469 616c 286f 6e65  ools.partial(one
+00010a40: 626f 6479 2e53 6361 7474 6572 696e 6753  body.ScatteringS
+00010a50: 7461 7465 732c 0a20 2020 2020 2020 2020  tates,.         
+00010a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010a80: 2020 2020 2020 2020 2077 6176 6566 756e           wavefun
+00010a90: 6374 696f 6e5f 7479 7065 3d57 6176 6546  ction_type=WaveF
+00010aa0: 756e 6374 696f 6e5f 7a65 6974 290a 2020  unction_zeit).  
+00010ab0: 2020 2020 2020 7769 7468 2070 7974 6573        with pytes
+00010ac0: 742e 7261 6973 6573 2854 7970 6545 7272  t.raises(TypeErr
+00010ad0: 6f72 2920 6173 2065 7863 3a0a 2020 2020  or) as exc:.    
+00010ae0: 2020 2020 2020 2020 6d61 6e79 626f 6479          manybody
+00010af0: 2e53 7461 7465 2866 7379 7374 5f7a 6569  .State(fsyst_zei
+00010b00: 742c 2074 6d61 782c 206f 6363 7570 6174  t, tmax, occupat
+00010b10: 696f 6e2c 2070 6172 616d 733d 7061 7261  ion, params=para
+00010b20: 6d73 2c0a 2020 2020 2020 2020 2020 2020  ms,.            
+00010b30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00010b40: 6361 7474 6572 696e 675f 7374 6174 655f  cattering_state_
+00010b50: 7479 7065 3d73 6361 7474 6572 696e 675f  type=scattering_
+00010b60: 7374 6174 655f 7a65 6974 2c20 7265 6669  state_zeit, refi
+00010b70: 6e65 3d46 616c 7365 290a 2020 2020 2020  ne=False).      
+00010b80: 2020 6173 7365 7274 2073 7472 2865 7863    assert str(exc
+00010b90: 2e76 616c 7565 2920 3d3d 2022 7469 6d65  .value) == "time
+00010ba0: 206d 7573 7420 6265 2061 2066 696e 6974   must be a finit
+00010bb0: 6520 7265 616c 206e 756d 6265 7222 0a0a  e real number"..
+00010bc0: 0a40 7079 7465 7374 2e6d 6172 6b2e 696e  .@pytest.mark.in
+00010bd0: 7465 6774 6573 740a 6465 6620 7465 7374  tegtest.def test
+00010be0: 5f65 7661 6c75 6174 655f 696e 7465 6772  _evaluate_integr
+00010bf0: 616e 6428 293a 0a0a 2020 2020 7379 7374  and():..    syst
+00010c00: 203d 206d 616b 655f 7379 7374 656d 2829   = make_system()
+00010c10: 2e66 696e 616c 697a 6564 2829 0a20 2020  .finalized().   
+00010c20: 2064 656e 7369 7479 5f6f 7065 7261 746f   density_operato
+00010c30: 7220 3d20 6b77 616e 742e 6f70 6572 6174  r = kwant.operat
+00010c40: 6f72 2e44 656e 7369 7479 2873 7973 7429  or.Density(syst)
+00010c50: 0a0a 2020 2020 746d 6178 203d 2031 300a  ..    tmax = 10.
+00010c60: 2020 2020 7469 6d65 203d 2031 2020 2320      time = 1  # 
+00010c70: 7469 6d65 7374 6570 2077 6520 6c69 6b65  timestep we like
+00010c80: 2074 6f20 6576 616c 7561 7465 2074 6865   to evaluate the
+00010c90: 2069 6e74 6567 7261 6e64 0a20 2020 2070   integrand.    p
+00010ca0: 6172 616d 7320 3d20 7b27 7627 3a20 302e  arams = {'v': 0.
+00010cb0: 3030 3031 2c20 2774 3027 3a20 302c 2027  0001, 't0': 0, '
+00010cc0: 4127 3a20 302e 3030 3135 372c 2027 7369  A': 0.00157, 'si
+00010cd0: 676d 6127 3a20 3234 7d0a 0a20 2020 206f  gma': 24}..    o
+00010ce0: 6363 7570 6174 696f 6e20 3d20 6d61 6e79  ccupation = many
+00010cf0: 626f 6479 2e6c 6561 645f 6f63 6375 7061  body.lead_occupa
+00010d00: 7469 6f6e 2863 6865 6d69 6361 6c5f 706f  tion(chemical_po
+00010d10: 7465 6e74 6961 6c3d 3329 0a20 2020 2073  tential=3).    s
+00010d20: 7461 7465 203d 206d 616e 7962 6f64 792e  tate = manybody.
+00010d30: 5374 6174 6528 7379 7374 2c20 746d 6178  State(syst, tmax
+00010d40: 2c20 6f63 6375 7061 7469 6f6e 2c20 7061  , occupation, pa
+00010d50: 7261 6d73 3d70 6172 616d 732c 2072 6566  rams=params, ref
+00010d60: 696e 653d 4661 6c73 6529 0a20 2020 2073  ine=False).    s
+00010d70: 7461 7465 2e65 766f 6c76 6528 7469 6d65  tate.evolve(time
+00010d80: 290a 0a20 2020 2023 2063 616c 6375 6c61  )..    # calcula
+00010d90: 7465 2074 6865 2069 6e74 6567 7261 6e64  te the integrand
+00010da0: 206f 6e20 616e 2069 6e74 6567 7261 6c20   on an integral 
+00010db0: 7769 7468 2074 6865 2073 7461 7465 0a20  with the state. 
+00010dc0: 2020 2069 6e74 6572 7661 6c20 3d20 6d61     interval = ma
+00010dd0: 6e79 626f 6479 2e49 6e74 6572 7661 6c28  nybody.Interval(
+00010de0: 6c65 6164 3d30 2c20 6261 6e64 3d30 2c20  lead=0, band=0, 
+00010df0: 6b6d 696e 3d30 2e30 322c 206b 6d61 783d  kmin=0.02, kmax=
+00010e00: 302e 3129 0a20 2020 2073 7461 7465 2e5f  0.1).    state._
+00010e10: 6164 645f 696e 7465 7276 616c 2869 6e74  add_interval(int
+00010e20: 6572 7661 6c29 0a20 2020 2064 656e 7369  erval).    densi
+00010e30: 7479 5f73 6861 7065 203d 2073 7461 7465  ty_shape = state
+00010e40: 2e65 7661 6c75 6174 6528 6465 6e73 6974  .evaluate(densit
+00010e50: 795f 6f70 6572 6174 6f72 292e 7368 6170  y_operator).shap
+00010e60: 650a 2020 2020 6162 6369 7373 612c 2069  e.    abcissa, i
+00010e70: 6e74 6567 7261 6e64 203d 2073 7461 7465  ntegrand = state
+00010e80: 2e63 616c 635f 696e 7465 6772 616e 6428  .calc_integrand(
+00010e90: 6465 6e73 6974 795f 6f70 6572 6174 6f72  density_operator
+00010ea0: 2c20 696e 7465 7276 616c 290a 0a20 2020  , interval)..   
+00010eb0: 2023 2074 6573 7420 7479 7065 2061 6e64   # test type and
+00010ec0: 2073 6861 7065 0a20 2020 2061 7373 6572   shape.    asser
+00010ed0: 7420 6973 696e 7374 616e 6365 2861 6263  t isinstance(abc
+00010ee0: 6973 7361 2c20 6e70 2e6e 6461 7272 6179  issa, np.ndarray
+00010ef0: 290a 2020 2020 6173 7365 7274 2069 7369  ).    assert isi
+00010f00: 6e73 7461 6e63 6528 696e 7465 6772 616e  nstance(integran
+00010f10: 642c 206e 702e 6e64 6172 7261 7929 0a20  d, np.ndarray). 
+00010f20: 2020 2061 7373 6572 7420 6162 6369 7373     assert abciss
+00010f30: 612e 7368 6170 6520 3d3d 2028 3220 2a20  a.shape == (2 * 
+00010f40: 696e 7465 7276 616c 2e6f 7264 6572 202b  interval.order +
+00010f50: 2031 2c29 0a20 2020 2061 7373 6572 7420   1,).    assert 
+00010f60: 696e 7465 6772 616e 642e 7368 6170 6520  integrand.shape 
+00010f70: 3d3d 2028 3220 2a20 696e 7465 7276 616c  == (2 * interval
+00010f80: 2e6f 7264 6572 202b 2031 2c29 202b 2064  .order + 1,) + d
+00010f90: 656e 7369 7479 5f73 6861 7065 0a0a 2020  ensity_shape..  
+00010fa0: 2020 2320 6576 616c 7561 7465 2074 6865    # evaluate the
+00010fb0: 2069 6e74 6567 7261 6e64 2077 6974 6820   integrand with 
+00010fc0: 7468 6520 7365 7061 7261 7465 2064 6562  the separate deb
+00010fd0: 7567 2072 6f75 7469 6e65 206f 6e20 616c  ug routine on al
+00010fe0: 6c20 6162 6369 7373 6120 706f 696e 740a  l abcissa point.
+00010ff0: 2020 2020 2320 616e 6420 6368 6563 6b20      # and check 
+00011000: 6966 2077 6520 6f62 7461 696e 2069 6465  if we obtain ide
+00011010: 6e74 6963 616c 2072 6573 756c 7473 0a20  ntical results. 
+00011020: 2020 206d 616e 7962 6f64 795f 696e 7465     manybody_inte
+00011030: 6772 616e 6420 3d20 6d61 6e79 626f 6479  grand = manybody
+00011040: 2e4d 616e 7962 6f64 7949 6e74 6567 7261  .ManybodyIntegra
+00011050: 6e64 2873 7973 742c 2069 6e74 6572 7661  nd(syst, interva
+00011060: 6c2c 2064 656e 7369 7479 5f6f 7065 7261  l, density_opera
+00011070: 746f 722c 0a20 2020 2020 2020 2020 2020  tor,.           
+00011080: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00011090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000110a0: 2020 2020 2020 2020 2074 696d 653d 7469           time=ti
+000110b0: 6d65 2c20 7061 7261 6d73 3d70 6172 616d  me, params=param
+000110c0: 7329 0a20 2020 2069 6e74 6567 203d 206e  s).    integ = n
+000110d0: 702e 6172 7261 7928 5b6d 616e 7962 6f64  p.array([manybod
+000110e0: 795f 696e 7465 6772 616e 642e 6675 6e63  y_integrand.func
+000110f0: 286b 2920 666f 7220 6b20 696e 2061 6263  (k) for k in abc
+00011100: 6973 7361 5d29 0a0a 2020 2020 6173 7365  issa])..    asse
+00011110: 7274 206d 616e 7962 6f64 795f 696e 7465  rt manybody_inte
+00011120: 6772 616e 642e 6675 6e63 2830 2e30 3529  grand.func(0.05)
+00011130: 2e73 6861 7065 203d 3d20 6465 6e73 6974  .shape == densit
+00011140: 795f 7368 6170 650a 2020 2020 6173 7365  y_shape.    asse
+00011150: 7274 5f61 7272 6179 5f61 6c6d 6f73 745f  rt_array_almost_
+00011160: 6571 7561 6c28 696e 7465 672c 2069 6e74  equal(integ, int
+00011170: 6567 7261 6e64 290a 0a0a 6465 6620 7465  egrand)...def te
+00011180: 7374 5f63 616c 635f 656e 6572 6779 5f63  st_calc_energy_c
+00011190: 7574 6f66 6673 2829 3a0a 0a20 2020 2063  utoffs():..    c
+000111a0: 6c61 7373 204f 6363 7570 6174 696f 6e3a  lass Occupation:
+000111b0: 0a20 2020 2020 2020 2064 6566 205f 5f69  .        def __i
+000111c0: 6e69 745f 5f28 7365 6c66 2c20 656e 6572  nit__(self, ener
+000111d0: 6779 5f72 616e 6765 293a 0a20 2020 2020  gy_range):.     
+000111e0: 2020 2020 2020 2073 656c 662e 656e 6572         self.ener
+000111f0: 6779 5f72 616e 6765 203d 2065 6e65 7267  gy_range = energ
+00011200: 795f 7261 6e67 650a 2020 2020 2020 2020  y_range.        
+00011210: 2020 2020 7365 6c66 2e6d 756c 7469 7661      self.multiva
+00011220: 7269 6174 6520 3d20 4661 6c73 650a 0a20  riate = False.. 
+00011230: 2020 2023 202d 2d2d 2d2d 206a 7573 7420     # ----- just 
+00011240: 6f6e 6520 6c65 6164 0a0a 2020 2020 6f63  one lead..    oc
+00011250: 6375 7061 7469 6f6e 203d 204f 6363 7570  cupation = Occup
+00011260: 6174 696f 6e28 656e 6572 6779 5f72 616e  ation(energy_ran
+00011270: 6765 3d5b 282d 352c 2031 292c 2028 322c  ge=[(-5, 1), (2,
+00011280: 2033 295d 290a 2020 2020 656d 696e 2c20   3)]).    emin, 
+00011290: 656d 6178 203d 206d 616e 7962 6f64 792e  emax = manybody.
+000112a0: 6361 6c63 5f65 6e65 7267 795f 6375 746f  calc_energy_cuto
+000112b0: 6666 7328 6f63 6375 7061 7469 6f6e 290a  ffs(occupation).
+000112c0: 0a20 2020 2061 7373 6572 7420 656d 696e  .    assert emin
+000112d0: 203d 3d20 2d35 0a20 2020 2061 7373 6572   == -5.    asser
+000112e0: 7420 656d 6178 203d 3d20 330a 0a20 2020  t emax == 3..   
+000112f0: 206f 6363 7570 6174 696f 6e20 3d20 4f63   occupation = Oc
+00011300: 6375 7061 7469 6f6e 2865 6e65 7267 795f  cupation(energy_
+00011310: 7261 6e67 653d 5b28 4e6f 6e65 2c20 3129  range=[(None, 1)
+00011320: 2c20 2832 2c20 3329 5d29 0a20 2020 2065  , (2, 3)]).    e
+00011330: 6d69 6e2c 2065 6d61 7820 3d20 6d61 6e79  min, emax = many
+00011340: 626f 6479 2e63 616c 635f 656e 6572 6779  body.calc_energy
+00011350: 5f63 7574 6f66 6673 286f 6363 7570 6174  _cutoffs(occupat
+00011360: 696f 6e29 0a0a 2020 2020 6173 7365 7274  ion)..    assert
+00011370: 2065 6d69 6e20 6973 204e 6f6e 650a 2020   emin is None.  
+00011380: 2020 6173 7365 7274 2065 6d61 7820 3d3d    assert emax ==
+00011390: 2033 0a0a 2020 2020 6f63 6375 7061 7469   3..    occupati
+000113a0: 6f6e 203d 204f 6363 7570 6174 696f 6e28  on = Occupation(
+000113b0: 656e 6572 6779 5f72 616e 6765 3d5b 282d  energy_range=[(-
+000113c0: 352c 2031 292c 2028 322c 204e 6f6e 6529  5, 1), (2, None)
+000113d0: 5d29 0a20 2020 2065 6d69 6e2c 2065 6d61  ]).    emin, ema
+000113e0: 7820 3d20 6d61 6e79 626f 6479 2e63 616c  x = manybody.cal
+000113f0: 635f 656e 6572 6779 5f63 7574 6f66 6673  c_energy_cutoffs
+00011400: 286f 6363 7570 6174 696f 6e29 0a0a 2020  (occupation)..  
+00011410: 2020 6173 7365 7274 2065 6d69 6e20 3d3d    assert emin ==
+00011420: 202d 350a 2020 2020 6173 7365 7274 2065   -5.    assert e
+00011430: 6d61 7820 6973 204e 6f6e 650a 0a20 2020  max is None..   
+00011440: 206f 6363 7570 6174 696f 6e20 3d20 4f63   occupation = Oc
+00011450: 6375 7061 7469 6f6e 2865 6e65 7267 795f  cupation(energy_
+00011460: 7261 6e67 653d 5b28 4e6f 6e65 2c20 3129  range=[(None, 1)
+00011470: 2c20 2832 2c20 4e6f 6e65 295d 290a 2020  , (2, None)]).  
+00011480: 2020 656d 696e 2c20 656d 6178 203d 206d    emin, emax = m
+00011490: 616e 7962 6f64 792e 6361 6c63 5f65 6e65  anybody.calc_ene
+000114a0: 7267 795f 6375 746f 6666 7328 6f63 6375  rgy_cutoffs(occu
+000114b0: 7061 7469 6f6e 290a 0a20 2020 2061 7373  pation)..    ass
+000114c0: 6572 7420 656d 696e 2069 7320 4e6f 6e65  ert emin is None
+000114d0: 0a20 2020 2061 7373 6572 7420 656d 6178  .    assert emax
+000114e0: 2069 7320 4e6f 6e65 0a0a 2020 2020 2320   is None..    # 
+000114f0: 2d2d 2d2d 2d20 7365 7665 7261 6c20 6c65  ----- several le
+00011500: 6164 730a 0a20 2020 206f 6363 7570 3120  ads..    occup1 
+00011510: 3d20 4f63 6375 7061 7469 6f6e 2865 6e65  = Occupation(ene
+00011520: 7267 795f 7261 6e67 653d 5b28 2d35 2c20  rgy_range=[(-5, 
+00011530: 3129 5d29 0a20 2020 206f 6363 7570 3220  1)]).    occup2 
+00011540: 3d20 4f63 6375 7061 7469 6f6e 2865 6e65  = Occupation(ene
+00011550: 7267 795f 7261 6e67 653d 5b28 2d34 2c20  rgy_range=[(-4, 
+00011560: 312e 3529 2c20 2832 2c20 3329 5d29 0a20  1.5), (2, 3)]). 
+00011570: 2020 2065 6d69 6e2c 2065 6d61 7820 3d20     emin, emax = 
+00011580: 6d61 6e79 626f 6479 2e63 616c 635f 656e  manybody.calc_en
+00011590: 6572 6779 5f63 7574 6f66 6673 285b 6f63  ergy_cutoffs([oc
+000115a0: 6375 7031 2c20 6f63 6375 7032 5d29 0a0a  cup1, occup2])..
+000115b0: 2020 2020 6173 7365 7274 2065 6d69 6e20      assert emin 
+000115c0: 3d3d 202d 350a 2020 2020 6173 7365 7274  == -5.    assert
+000115d0: 2065 6d61 7820 3d3d 2033 0a0a 2020 2020   emax == 3..    
+000115e0: 6f63 6375 7031 203d 204f 6363 7570 6174  occup1 = Occupat
+000115f0: 696f 6e28 656e 6572 6779 5f72 616e 6765  ion(energy_range
+00011600: 3d5b 282d 352c 204e 6f6e 6529 5d29 0a20  =[(-5, None)]). 
+00011610: 2020 206f 6363 7570 3220 3d20 4f63 6375     occup2 = Occu
+00011620: 7061 7469 6f6e 2865 6e65 7267 795f 7261  pation(energy_ra
+00011630: 6e67 653d 5b28 4e6f 6e65 2c20 312e 3529  nge=[(None, 1.5)
+00011640: 2c20 2832 2c20 3329 5d29 0a20 2020 2065  , (2, 3)]).    e
+00011650: 6d69 6e2c 2065 6d61 7820 3d20 6d61 6e79  min, emax = many
+00011660: 626f 6479 2e63 616c 635f 656e 6572 6779  body.calc_energy
+00011670: 5f63 7574 6f66 6673 285b 6f63 6375 7031  _cutoffs([occup1
+00011680: 2c20 6f63 6375 7032 5d29 0a0a 2020 2020  , occup2])..    
+00011690: 6173 7365 7274 2065 6d69 6e20 6973 204e  assert emin is N
+000116a0: 6f6e 650a 2020 2020 6173 7365 7274 2065  one.    assert e
+000116b0: 6d61 7820 6973 204e 6f6e 650a 0a20 2020  max is None..   
+000116c0: 2023 202d 2d2d 2d2d 2073 6576 6572 616c   # ----- several
+000116d0: 206c 6561 6473 2c20 6f6e 6520 6c65 6164   leads, one lead
+000116e0: 206e 6f74 206f 6363 7570 6965 640a 0a20   not occupied.. 
+000116f0: 2020 206f 6363 7570 3120 3d20 4f63 6375     occup1 = Occu
+00011700: 7061 7469 6f6e 2865 6e65 7267 795f 7261  pation(energy_ra
+00011710: 6e67 653d 5b28 2d35 2c20 3129 5d29 0a20  nge=[(-5, 1)]). 
+00011720: 2020 206f 6363 7570 3220 3d20 4f63 6375     occup2 = Occu
+00011730: 7061 7469 6f6e 2865 6e65 7267 795f 7261  pation(energy_ra
+00011740: 6e67 653d 5b28 2d34 2c20 312e 3529 2c20  nge=[(-4, 1.5), 
+00011750: 2832 2c20 3329 5d29 0a0a 2020 2020 656d  (2, 3)])..    em
+00011760: 696e 2c20 656d 6178 203d 206d 616e 7962  in, emax = manyb
+00011770: 6f64 792e 6361 6c63 5f65 6e65 7267 795f  ody.calc_energy_
+00011780: 6375 746f 6666 7328 5b6f 6363 7570 312c  cutoffs([occup1,
+00011790: 206f 6363 7570 322c 204e 6f6e 655d 290a   occup2, None]).
+000117a0: 0a20 2020 2061 7373 6572 7420 656d 696e  .    assert emin
+000117b0: 203d 3d20 2d35 0a20 2020 2061 7373 6572   == -5.    asser
+000117c0: 7420 656d 6178 203d 3d20 330a 0a20 2020  t emax == 3..   
+000117d0: 2023 202d 2d2d 2d2d 206e 6f20 6c65 6164   # ----- no lead
+000117e0: 2069 7320 6f63 6375 7069 6564 0a20 2020   is occupied.   
+000117f0: 2065 6d69 6e2c 2065 6d61 7820 3d20 6d61   emin, emax = ma
+00011800: 6e79 626f 6479 2e63 616c 635f 656e 6572  nybody.calc_ener
+00011810: 6779 5f63 7574 6f66 6673 284e 6f6e 6529  gy_cutoffs(None)
+00011820: 0a0a 2020 2020 6173 7365 7274 2065 6d69  ..    assert emi
+00011830: 6e20 6973 204e 6f6e 650a 2020 2020 6173  n is None.    as
+00011840: 7365 7274 2065 6d61 7820 6973 204e 6f6e  sert emax is Non
+00011850: 650a 0a0a 6465 6620 7465 7374 5f62 6f75  e...def test_bou
+00011860: 6e64 7374 6174 6573 5f70 7265 7365 6e74  ndstates_present
+00011870: 2829 3a0a 0a20 2020 2073 7973 7420 3d20  ():..    syst = 
+00011880: 6d61 6b65 5f73 7973 7465 6d5f 7769 7468  make_system_with
+00011890: 5f62 6f75 6e64 7374 6174 6528 563d 3029  _boundstate(V=0)
+000118a0: 2e66 696e 616c 697a 6564 2829 0a20 2020  .finalized().   
+000118b0: 2061 7373 6572 7420 6e6f 7420 6d61 6e79   assert not many
+000118c0: 626f 6479 2e62 6f75 6e64 7374 6174 6573  body.boundstates
+000118d0: 5f70 7265 7365 6e74 2873 7973 7429 0a0a  _present(syst)..
+000118e0: 2020 2020 7379 7374 203d 206d 616b 655f      syst = make_
+000118f0: 7379 7374 656d 5f77 6974 685f 626f 756e  system_with_boun
+00011900: 6473 7461 7465 2856 3d2d 3529 2e66 696e  dstate(V=-5).fin
+00011910: 616c 697a 6564 2829 0a20 2020 2061 7373  alized().    ass
+00011920: 6572 7420 6d61 6e79 626f 6479 2e62 6f75  ert manybody.bou
+00011930: 6e64 7374 6174 6573 5f70 7265 7365 6e74  ndstates_present
+00011940: 2873 7973 7429 0a0a 0a40 7079 7465 7374  (syst)...@pytest
+00011950: 2e6d 6172 6b2e 696e 7465 6774 6573 7420  .mark.integtest 
+00011960: 2023 206d 6172 6b65 7220 666f 7220 696e   # marker for in
+00011970: 7465 6772 6174 696f 6e20 7465 7374 730a  tegration tests.
+00011980: 6465 6620 7465 7374 5f61 6464 5f62 6f75  def test_add_bou
+00011990: 6e64 7374 6174 6528 293a 0a0a 2020 2020  ndstate():..    
+000119a0: 7379 7374 203d 206d 616b 655f 7379 7374  syst = make_syst
+000119b0: 656d 5f77 6974 685f 626f 756e 6473 7461  em_with_boundsta
+000119c0: 7465 2856 3d2d 3529 2e66 696e 616c 697a  te(V=-5).finaliz
+000119d0: 6564 2829 0a0a 2020 2020 6861 6d69 6c74  ed()..    hamilt
+000119e0: 6f6e 6961 6e20 3d20 7379 7374 2e68 616d  onian = syst.ham
+000119f0: 696c 746f 6e69 616e 5f73 7562 6d61 7472  iltonian_submatr
+00011a00: 6978 2829 0a20 2020 2065 6967 656e 7661  ix().    eigenva
+00011a10: 6c75 6573 2c20 6569 6765 6e76 6563 746f  lues, eigenvecto
+00011a20: 7273 203d 206e 702e 6c69 6e61 6c67 2e65  rs = np.linalg.e
+00011a30: 6967 6828 6861 6d69 6c74 6f6e 6961 6e29  igh(hamiltonian)
+00011a40: 0a0a 2020 2020 6273 5f65 6e65 7267 7920  ..    bs_energy 
+00011a50: 3d20 6569 6765 6e76 616c 7565 735b 305d  = eigenvalues[0]
+00011a60: 0a20 2020 2070 7369 5f62 7320 3d20 6569  .    psi_bs = ei
+00011a70: 6765 6e76 6563 746f 7273 5b3a 2c20 305d  genvectors[:, 0]
+00011a80: 0a0a 2020 2020 6f63 6375 7061 7469 6f6e  ..    occupation
+00011a90: 7320 3d20 6d61 6e79 626f 6479 2e6c 6561  s = manybody.lea
+00011aa0: 645f 6f63 6375 7061 7469 6f6e 2863 6865  d_occupation(che
+00011ab0: 6d69 6361 6c5f 706f 7465 6e74 6961 6c3d  mical_potential=
+00011ac0: 3429 0a20 2020 2064 656e 7369 7479 5f6f  4).    density_o
+00011ad0: 7065 7261 746f 7220 3d20 6b77 616e 742e  perator = kwant.
+00011ae0: 6f70 6572 6174 6f72 2e44 656e 7369 7479  operator.Density
+00011af0: 2873 7973 7429 0a0a 2020 2020 7374 6174  (syst)..    stat
+00011b00: 6520 3d20 6d61 6e79 626f 6479 2e53 7461  e = manybody.Sta
+00011b10: 7465 2873 7973 742c 2074 6d61 783d 312c  te(syst, tmax=1,
+00011b20: 206f 6363 7570 6174 696f 6e73 3d6f 6363   occupations=occ
+00011b30: 7570 6174 696f 6e73 290a 2020 2020 7374  upations).    st
+00011b40: 6174 652e 6164 645f 626f 756e 6473 7461  ate.add_boundsta
+00011b50: 7465 2870 7369 5f62 732c 2062 735f 656e  te(psi_bs, bs_en
+00011b60: 6572 6779 290a 2020 2020 6465 6e73 6974  ergy).    densit
+00011b70: 7920 3d20 7374 6174 652e 6576 616c 7561  y = state.evalua
+00011b80: 7465 2864 656e 7369 7479 5f6f 7065 7261  te(density_opera
+00011b90: 746f 722c 2072 6f6f 743d 4e6f 6e65 290a  tor, root=None).
+00011ba0: 2020 2020 6173 7365 7274 5f61 7272 6179      assert_array
+00011bb0: 5f61 6c6d 6f73 745f 6571 7561 6c28 6465  _almost_equal(de
+00011bc0: 6e73 6974 792c 2031 2c20 6465 6369 6d61  nsity, 1, decima
+00011bd0: 6c3d 3429 0a0a 0a40 7079 7465 7374 2e6d  l=4)...@pytest.m
+00011be0: 6172 6b2e 696e 7465 6774 6573 7420 2023  ark.integtest  #
+00011bf0: 206d 6172 6b65 7220 666f 7220 696e 7465   marker for inte
+00011c00: 6772 6174 696f 6e20 7465 7374 730a 6465  gration tests.de
+00011c10: 6620 7465 7374 5f73 696e 676c 655f 7370  f test_single_sp
+00011c20: 696e 5f72 6f74 6174 696e 675f 6261 7369  in_rotating_basi
+00011c30: 7328 293a 0a20 2020 2023 2074 6573 7420  s():.    # test 
+00011c40: 6167 6169 6e73 7420 616e 616c 7974 6963  against analytic
+00011c50: 6120 7265 7375 6c74 2066 6f72 2061 2073  a result for a s
+00011c60: 696e 676c 6520 7370 696e 3a0a 2020 2020  ingle spin:.    
+00011c70: 2320 536f 6e2d 4873 6965 6e20 4368 656e  # Son-Hsien Chen
+00011c80: 2c20 4368 696e 672d 5261 7920 4368 616e  , Ching-Ray Chan
+00011c90: 672c 204a 6f68 6e20 512e 2058 6961 6f2c  g, John Q. Xiao,
+00011ca0: 2061 6e64 2042 7261 6e69 736c 6176 204b   and Branislav K
+00011cb0: 2e20 4e69 6b6f 6c69 c487 2c20 0a20 2020  . Nikoli.., .   
+00011cc0: 2023 2053 7069 6e20 616e 6420 6368 6172   # Spin and char
+00011cd0: 6765 2070 756d 7069 6e67 2069 6e20 6d61  ge pumping in ma
+00011ce0: 676e 6574 6963 2074 756e 6e65 6c20 6a75  gnetic tunnel ju
+00011cf0: 6e63 7469 6f6e 7320 7769 7468 2070 7265  nctions with pre
+00011d00: 6365 7373 696e 6720 6d61 676e 6574 697a  cessing magnetiz
+00011d10: 6174 696f 6e3a 200a 2020 2020 2320 4120  ation: .    # A 
+00011d20: 6e6f 6e65 7175 696c 6962 7269 756d 2047  nonequilibrium G
+00011d30: 7265 656e 2066 756e 6374 696f 6e20 6170  reen function ap
+00011d40: 7072 6f61 6368 2c20 5068 7973 2e20 5265  proach, Phys. Re
+00011d50: 762e 2042 2037 392c 2030 3534 3432 3420  v. B 79, 054424 
+00011d60: 2832 3030 3929 2e0a 2020 2020 2320 2449  (2009)..    # $I
+00011d70: 5e7a 203d 205c 6672 6163 7b32 2065 7d7b  ^z = \frac{2 e}{
+00011d80: 5c68 6261 727d 204a 5e7b 535f 7a7d 242c  \hbar} J^{S_z}$,
+00011d90: 2061 6e64 2024 4a5e 7b53 5f7a 7d24 2069   and $J^{S_z}$ i
+00011da0: 7320 7468 6520 6578 7072 6573 7369 6f6e  s the expression
+00011db0: 2066 726f 6d20 4571 2e20 2831 3329 3a0a   from Eq. (13):.
+00011dc0: 0a20 2020 2064 6566 2073 6967 6d61 2865  .    def sigma(e
+00011dd0: 6629 3a0a 2020 2020 2020 2020 7371 7274  f):.        sqrt
+00011de0: 6172 6720 3d20 6566 2a2a 3220 2d20 340a  arg = ef**2 - 4.
+00011df0: 2020 2020 2020 2020 6966 2073 7172 7461          if sqrta
+00011e00: 7267 203c 2030 3a0a 2020 2020 2020 2020  rg < 0:.        
+00011e10: 2020 2020 7371 7274 203d 2031 6a20 2a20      sqrt = 1j * 
+00011e20: 6e70 2e73 7172 7428 2d73 7172 7461 7267  np.sqrt(-sqrtarg
+00011e30: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+00011e40: 2020 2020 2020 2020 2020 2020 2073 7172               sqr
+00011e50: 7420 3d20 6e70 2e73 7172 7428 7371 7274  t = np.sqrt(sqrt
+00011e60: 6172 6729 2020 2020 2020 200a 2020 2020  arg)       .    
+00011e70: 2020 2020 7265 7475 726e 2065 6620 2d20      return ef - 
+00011e80: 7371 7274 202f 2032 0a0a 2020 2020 6465  sqrt / 2..    de
+00011e90: 6620 7266 756e 6328 7369 676d 612c 204a  f rfunc(sigma, J
+00011ea0: 293a 0a20 2020 2020 2020 2072 6574 7572  ):.        retur
+00011eb0: 6e20 2834 202a 2073 6967 6d61 2a2a 3220  n (4 * sigma**2 
+00011ec0: 2d20 4a2a 2a32 2920 2a20 7369 676d 612a  - J**2) * sigma*
+00011ed0: 2a32 202f 2034 202d 2032 202a 2073 6967  *2 / 4 - 2 * sig
+00011ee0: 6d61 2a2a 3220 2b20 310a 0a20 2020 2064  ma**2 + 1..    d
+00011ef0: 6566 206a 7a28 4a2c 206f 6d65 6761 2c20  ef jz(J, omega, 
+00011f00: 7468 6574 612c 2065 6629 3a20 2023 2049  theta, ef):  # I
+00011f10: 5e7a 0a20 2020 2020 2020 2073 6967 203d  ^z.        sig =
+00011f20: 2073 6967 6d61 2865 6629 0a20 2020 2020   sigma(ef).     
+00011f30: 2020 2072 203d 2072 6675 6e63 2873 6967     r = rfunc(sig
+00011f40: 2c20 4a29 0a20 2020 2020 2020 2072 6574  , J).        ret
+00011f50: 7572 6e20 6f6d 6567 6120 2a20 6e70 2e73  urn omega * np.s
+00011f60: 696e 2874 6865 7461 292a 2a32 202a 204a  in(theta)**2 * J
+00011f70: 2a2a 3220 2a20 2873 6967 2e69 6d61 6729  **2 * (sig.imag)
+00011f80: 2a2a 3220 2f20 286e 702e 7069 202a 206e  **2 / (np.pi * n
+00011f90: 702e 6162 7328 7229 2a2a 3229 202a 2028  p.abs(r)**2) * (
+00011fa0: 3120 2b20 6e70 2e61 6273 2873 6967 292a  1 + np.abs(sig)*
+00011fb0: 2a32 290a 0a20 2020 2023 2070 6172 616d  *2)..    # param
+00011fc0: 6574 6572 730a 2020 2020 6120 3d20 3120  eters.    a = 1 
+00011fd0: 2320 6c61 7474 6963 6520 636f 6e73 7461  # lattice consta
+00011fe0: 6e74 0a20 2020 2077 203d 2030 2e30 3120  nt.    w = 0.01 
+00011ff0: 2320 4672 6571 7565 6e63 7920 6f66 206f  # Frequency of o
+00012000: 7363 696c 6c61 7469 6f6e 2069 6e20 756e  scillation in un
+00012010: 6974 7320 6f66 2067 616d 6d61 2f68 6261  its of gamma/hba
+00012020: 720a 2020 2020 4a20 3d20 302e 3120 2320  r.    J = 0.1 # 
+00012030: 436f 7570 6c69 6e67 2062 6574 7765 656e  Coupling between
+00012040: 2065 6c65 6374 726f 6e73 2061 6e64 206d   electrons and m
+00012050: 6167 6e65 7469 6320 6d6f 6d65 6e74 2069  agnetic moment i
+00012060: 6e20 756e 6974 7320 6f66 2067 616d 6d61  n units of gamma
+00012070: 0a20 2020 2074 6865 7461 203d 206e 702e  .    theta = np.
+00012080: 7069 202f 2034 2023 2043 6f6e 6520 616e  pi / 4 # Cone an
+00012090: 676c 6520 6f66 2074 6865 206d 6167 6e65  gle of the magne
+000120a0: 7469 6320 6d6f 6d65 6e74 730a 2020 2020  tic moments.    
+000120b0: 4566 203d 2030 2e30 2023 2046 6572 6d69  Ef = 0.0 # Fermi
+000120c0: 2065 6e65 7267 7920 696e 2075 6e69 7473   energy in units
+000120d0: 206f 6620 6761 6d6d 610a 0a20 2020 2073   of gamma..    s
+000120e0: 7973 742c 206c 6174 203d 206d 616b 655f  yst, lat = make_
+000120f0: 7369 6e67 6c65 5f73 7069 6e5f 726f 7461  single_spin_rota
+00012100: 7469 6e67 5f62 6173 6973 2861 2c20 4a2c  ting_basis(a, J,
+00012110: 2077 2c20 7468 6574 6129 0a20 2020 2073   w, theta).    s
+00012120: 7973 7420 3d20 7379 7374 2e66 696e 616c  yst = syst.final
+00012130: 697a 6564 2829 0a0a 2020 2020 6f63 6375  ized()..    occu
+00012140: 7061 7469 6f6e 7320 3d20 6d61 6e79 626f  pations = manybo
+00012150: 6479 2e6c 6561 645f 6f63 6375 7061 7469  dy.lead_occupati
+00012160: 6f6e 2863 6865 6d69 6361 6c5f 706f 7465  on(chemical_pote
+00012170: 6e74 6961 6c3d 5b45 662d 772f 322c 2045  ntial=[Ef-w/2, E
+00012180: 662b 772f 325d 290a 0a20 2020 2023 206f  f+w/2])..    # o
+00012190: 7065 7261 746f 7220 746f 206d 6561 7375  perator to measu
+000121a0: 7265 2074 6865 2063 7572 7265 6e74 2049  re the current I
+000121b0: 5e7a 2066 726f 6d20 7468 6520 7379 7374  ^z from the syst
+000121c0: 656d 2074 6f20 7468 6520 6c65 6674 206c  em to the left l
+000121d0: 6561 6420 2866 726f 6d20 7369 7465 2030  ead (from site 0
+000121e0: 2074 6f20 7369 7465 202d 3129 0a20 2020   to site -1).   
+000121f0: 2073 6967 6d61 5f7a 203d 2074 612e 6172   sigma_z = ta.ar
+00012200: 7261 7928 5b5b 312c 305d 2c20 5b30 2c20  ray([[1,0], [0, 
+00012210: 2d31 5d5d 290a 2020 2020 697a 5f6f 7065  -1]]).    iz_ope
+00012220: 7261 746f 7220 3d20 6b77 616e 742e 6f70  rator = kwant.op
+00012230: 6572 6174 6f72 2e43 7572 7265 6e74 2873  erator.Current(s
+00012240: 7973 742c 2073 6967 6d61 5f7a 2c20 7768  yst, sigma_z, wh
+00012250: 6572 653d 5b28 6c61 7428 2d31 2c20 3029  ere=[(lat(-1, 0)
+00012260: 2c20 6c61 7428 302c 2030 2929 5d29 0a0a  , lat(0, 0))])..
+00012270: 2020 2020 746d 6178 203d 2031 2020 2320      tmax = 1  # 
+00012280: 6e6f 2074 696d 6520 6576 6f6c 7574 696f  no time evolutio
+00012290: 6e20 6e65 6564 6564 0a20 2020 2073 7461  n needed.    sta
+000122a0: 7465 203d 206d 616e 7962 6f64 792e 5374  te = manybody.St
+000122b0: 6174 6528 7379 7374 2c20 746d 6178 2c20  ate(syst, tmax, 
+000122c0: 6f63 6375 7061 7469 6f6e 7329 0a0a 2020  occupations)..  
+000122d0: 2020 6375 7272 656e 745f 7a20 3d20 7374    current_z = st
+000122e0: 6174 652e 6576 616c 7561 7465 2869 7a5f  ate.evaluate(iz_
+000122f0: 6f70 6572 6174 6f72 290a 2020 2020 6375  operator).    cu
+00012300: 7272 656e 745f 7265 6620 3d20 6a7a 284a  rrent_ref = jz(J
+00012310: 2c20 772c 2074 6865 7461 2c20 4566 290a  , w, theta, Ef).
+00012320: 0a20 2020 2061 7373 6572 745f 616c 6d6f  .    assert_almo
+00012330: 7374 5f65 7175 616c 2863 7572 7265 6e74  st_equal(current
+00012340: 5f7a 2c20 6375 7272 656e 745f 7265 662c  _z, current_ref,
+00012350: 2064 6563 696d 616c 3d38 290a             decimal=8).
```

### Comparing `tkwant-1.0.1/tkwant/tests/test_mpi.py` & `tkwant-1.1.0rc2/tkwant/tests/test_mpi.py`

 * *Files 3% similar despite different names*

```diff
@@ -1,32 +1,35 @@
 # -*- coding: utf-8 -*-
-# Copyright 2016-2020 tkwant authors.
+# Copyright 2016-2023 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 """Test module for routines using MPI"""
 
 import pytest
 from pytest import raises
 import cmath
 import numpy as np
 import kwant
 from numpy.testing import assert_array_almost_equal
 from scipy.special import erf
 import warnings
+import functools
 
 
 from . import mpi_testdriver
 from .. import onebody, manybody, system, leads, integration, mpi
 import kwantspectrum
 
+
 pytestmark = pytest.mark.mpitest  # module level marker for mpi tests
 num_processes = 4
 
 
 def make_simple_lead(W=3):
     lat = kwant.lattice.square(a=1, norbs=1)
     sym = kwant.TranslationalSymmetry((-1, 0))
@@ -73,56 +76,32 @@
     # Attach the left lead and its reversed copy.
     syst.attach_lead(lead)
     syst.attach_lead(lead.reversed())
 
     return syst
 
 
-class ManybodyIntegrand:
+def make_system_with_boundstate(V, L=20, a=1):  # boundstate present for V < 0
 
-    def __init__(self, syst, interval, operator, time=0, params=None, element=None):
-        """Diagnostic routine to evaluate the integrand in the manybody integral"""
+    lat = kwant.lattice.square(a=a, norbs=1)
+    syst = kwant.Builder()
 
-        tparams = system.add_time_to_params(params, time_name='time',
-                                            time=0, check_numeric_type=True)
+    # central system
+    syst[(lat(i, 0) for i in range(-L, L))] = 0
+    syst[lat(0, 0)] = V
+    syst[lat.neighbors()] = -1
 
-        spectra = kwantspectrum.spectra(syst.leads, params=tparams)
-        self.boundaries = leads.automatic_boundary(spectra, tmax=time)
-
-        self.syst = syst
-        self.band = interval.band
-        self.lead = interval.lead
-        self.time = time
-        self.operator = operator
-        self.params = params
-        self.spectrum = spectra[self.lead]
-        self.element = element
-
-    def _f(self, k):
-        """integrand (momentum integration) for the manybody expectation value
-        at zero temperature"""
-        energy = self.spectrum(k, band=self.band)
-        velocity = self.spectrum(k, band=self.band, derivative_order=1)
-        mode = self.spectrum.momentum_to_scattering_mode(k, self.band)
-
-        psi = onebody.ScatteringStates(self.syst, energy=energy, lead=self.lead,
-                                       params=self.params,
-                                       boundaries=self.boundaries)[mode]
-
-        psi.evolve(self.time)
-
-        result = velocity * psi.evaluate(self.operator) / (2 * np.pi)
-        if result.shape == (1,):  # if result is an array with only one element
-            result = result[0]
-        if self.element is None:
-            return result
-        return result[self.element]
+    # leads
+    lead = kwant.Builder(kwant.TranslationalSymmetry((-a, 0)))
+    lead[lat(0, 0)] = 0
+    lead[lat.neighbors()] = -1
+    syst.attach_lead(lead)
+    syst.attach_lead(lead.reversed())
 
-    def func(self, k):
-        return np.array([self._f(xi) for xi in k])
+    return syst
 
 
 def quadpack_error_per_interval(func, order, ai, bi):
 
     def calc_ik(x, w, kronrod):
         integrand = np.abs(func(x) - kronrod / (bi - ai))
         return np.sum(w * integrand, axis=1)[1]
@@ -357,14 +336,20 @@
     distributed_dict.delete(key=5)
     assert set(distributed_dict.keys()) == set(['a', 'b', 'c', 24])
     raises(ValueError, distributed_dict.delete, key=non_present_key)
 
     # get data
     element = distributed_dict.data(key='a')
     assert element == 7
+    for to_rank in range(size):
+        element = distributed_dict.data(key='a', to_rank=to_rank)
+        if rank == to_rank:
+            assert element == 7
+        else:
+            assert element is None
     raises(ValueError, distributed_dict.data, key=non_present_key)
 
     # get local data
     local_data = distributed_dict.local_data()
     element_inside = [value == local_data[key] for key, value in data.items()]
     assert np.array(element_inside).all()
 
@@ -461,19 +446,24 @@
         density_ref = sum([psi.evaluate(density_operator)
                            for psi in psis_ref])
 
         # compute the same density with a MPI distributed wavefunction
         class MyTask:
             weight = np.array([1])
 
+        # TODO: remove when reduce method is implemented into kernel
+        onebody_wavefunction_type = functools.partial(onebody.WaveFunction.from_kwant,
+                                                      kernel_type=onebody.kernels.Scipy)
+
         psi_init = {}
         for i, energy in enumerate(energies):
             if rank == i % size:
                 psi_init[i] = onebody.ScatteringStates(syst, energy=energy,
-                                                       lead=0, tmax=50, params=params)[0]
+                                                       lead=0, tmax=50, params=params,
+                                                       wavefunction_type=onebody_wavefunction_type)[0]
         tasks = {i: MyTask() for i in range(len(energies))}
 
         # compare the densities for consistency
         wavefunction = manybody.WaveFunction(psi_init, tasks)
         wavefunction.evolve(time)
         density = wavefunction.evaluate(density_operator)
         if rank == 0:  # evaluate returns only on rank 0
@@ -490,15 +480,15 @@
             density = wavefunction._calc_expectation_value(density_operator, keys=keys)
             density_ref = sum([psis_ref[key].evaluate(density_operator) for key in keys])
             if rank == 0:  # _calc_expectation_value returns only on rank 0
                 assert_array_almost_equal(density, density_ref)
 
         # --------------------- test get onebody state-----------------------
         for key in range(len(energies)):
-            psi = wavefunction.get_onebody_state(key)
+            psi = wavefunction.get_onebody_state(key, root=None)
             psi_ref = psis_ref[key]
             assert np.allclose(psi.psi(), psi_ref.psi())
 
         # --------------------- test to add onebody state---------------------
         new_energy = 2.37423  # some arbitray number where one open mode exists
         new_state = onebody.ScatteringStates(syst, energy=new_energy, lead=0, tmax=50, params=params)[0]
 
@@ -644,18 +634,18 @@
 
     error_array = state._error_estimate_quadpack(interval=interval,
                                                  error_op=density_operator_array)
 
     assert np.allclose(error, error_array[element])
 
     # compare the error to the quadpack reference implementation
-    integrand = ManybodyIntegrand(syst, interval=interval, time=time, params=params,
-                                  operator=density_operator)
+    integrand = manybody.ManybodyIntegrand(syst, interval=interval, time=time, params=params,
+                                           operator=density_operator)
 
-    reference_error = quadpack_error_per_interval(integrand.func, interval.order,
+    reference_error = quadpack_error_per_interval(integrand.vecfunc, interval.order,
                                                   interval.kmin, interval.kmax)
 
     assert np.allclose(error, reference_error)
 
 
 @mpi_testdriver.wrap(num_processes)
 def test_quadpack_adaptive_refinement_of_manybody_state():
@@ -696,15 +686,15 @@
 
     # this operator has an array like output, on all sites the value is similar to
     # the density operator
     density_operator_array = make_operator(density_operator_array)
 
     time = 5
     tmax = time
-    params = {'v': 0.0001}
+    params = {'v': 0.001}
     occupation = manybody.lead_occupation(chemical_potential=3)
 
     state = manybody.State(syst, tmax, occupation, params=params, refine=False)
     state.evolve(time)
 
     density = state.evaluate(density_operator, root=None)
     density_array = state.evaluate(density_operator_array, root=None)
@@ -715,29 +705,29 @@
     for dens in density_array:
         assert np.allclose(dens, density)
 
     # estimate the error at a given time in the first interval for a given element
     interval = state.get_intervals()[0]
 
     # ----- a simple quadpack reference implementation
-    integrand = ManybodyIntegrand(syst, interval=interval, time=time, params=params,
-                                  operator=density_operator)
+    integrand = manybody.ManybodyIntegrand(syst, interval=interval, time=time, params=params,
+                                           operator=density_operator)
 
-    tmp = quadpack_qag(integrand.func, interval.kmin, interval.kmax,
+    tmp = quadpack_qag(integrand.vecfunc, interval.kmin, interval.kmax,
                        order=interval.order, atol=1.0e-3, rtol=1.0e-3)
 
     result_ref, errors_ref, max_error_per_interval_ref, intervals_ref = tmp
 
     # ----- test for an operator with an array output
     tmp = state.refine_intervals(error_op=density_operator_array, intervals=interval,
                                  atol=1.0e-3, rtol=1.0e-3)
     error_sum, intervals, errors = tmp
 
     # check the return types
-    assert isinstance(error_sum, np.float)
+    assert isinstance(error_sum, float)
     assert isinstance(intervals, list)
     assert isinstance(errors, np.ndarray)
     assert len(intervals) == len(errors)
     for inter in intervals:
         assert isinstance(inter, manybody.Interval)
     assert errors.shape == (len(intervals), ) + shape_density_array
     max_error = 0
@@ -756,20 +746,21 @@
     for err, err_ref in zip(errors, errors_ref):
         assert np.allclose(err[0], err_ref, atol=1e-6)
 
     # ----- test for an operator with a single scalar output
 
     # set up a new state, as the old one has refined intervals
     state = manybody.State(syst, tmax, occupation, params=params, refine=False)
+    state.evolve(time)
     tmp = state.refine_intervals(error_op=density_operator, intervals=interval,
                                  atol=1.0e-3, rtol=1.0e-3)
     error_sum, intervals, errors = tmp
 
     # check the return types
-    assert isinstance(error_sum, np.float)
+    assert isinstance(error_sum, float)
     assert isinstance(intervals, list)
     assert isinstance(errors, np.ndarray)
     assert len(intervals) == len(errors)
     for inter in intervals:
         assert isinstance(inter, manybody.Interval)
     assert errors.shape == (len(intervals), ) + shape_density
     assert np.allclose(error_sum, np.sum(errors))
@@ -815,40 +806,64 @@
                                                        mpi.round_robin,
                                                        comm)
 
     boundstate_psi = {key: make_psi(task.energy) for key, task
                       in boundstate_tasks_distributed.items()}
 
     # test simply that we can evolve and evaluate the state
-    state.add_boundstates(boundstate_psi, boundstate_tasks)
+    state._add_boundstates(boundstate_psi, boundstate_tasks)
     state.evolve(time)
     state.evaluate(density_operator)
 
     # test for error if key are alread occupied
     with pytest.raises(KeyError) as exc:
-        state.add_boundstates(boundstate_psi, boundstate_tasks)
+        state._add_boundstates(boundstate_psi, boundstate_tasks)
     error_string = str(exc.value)
     message = 'boundstate key=100 already present in solver.'
     assert message in error_string
 
     # test if the input dict is not distributed
     boundstate_tasks = {102: onebody.Task(weight=0.2, energy=2.1, lead=None, mode=None),
                         103: onebody.Task(weight=0.3, energy=2.3, lead=None, mode=None)}
     boundstate_psi = {key: make_psi(task.energy) for key, task
                       in boundstate_tasks.items()}
-    raises(AssertionError, state.add_boundstates, boundstate_psi, boundstate_tasks)
+    raises(AssertionError, state._add_boundstates, boundstate_psi, boundstate_tasks)
 
     # test if the keys do not match in both input dicts
     boundstate_tasks_distributed = mpi.distribute_dict(boundstate_tasks,
                                                        mpi.round_robin,
                                                        comm)
     boundstate_psi = {key: make_psi(task.energy) for key, task
                       in boundstate_tasks_distributed.items()}
     del boundstate_tasks[103]
-    raises(AssertionError, state.add_boundstates, boundstate_psi, boundstate_tasks)
+    raises(AssertionError, state._add_boundstates, boundstate_psi, boundstate_tasks)
+
+
+@mpi_testdriver.wrap(num_processes)
+def test_add_boundstate_mpi():
+
+    syst = make_system_with_boundstate(V=0).finalized()
+    assert not manybody.boundstates_present(syst)
+
+    syst = make_system_with_boundstate(V=-5).finalized()
+    assert manybody.boundstates_present(syst)
+
+    hamiltonian = syst.hamiltonian_submatrix()
+    eigenvalues, eigenvectors = np.linalg.eigh(hamiltonian)
+
+    bs_energy = eigenvalues[0]
+    psi_bs = eigenvectors[:, 0]
+
+    occupations = manybody.lead_occupation(chemical_potential=4)
+    density_operator = kwant.operator.Density(syst)
+
+    state = manybody.State(syst, tmax=1, occupations=occupations)
+    state.add_boundstate(psi_bs, bs_energy)
+    density = state.evaluate(density_operator, root=None)
+    assert_array_almost_equal(density, 1, decimal=4)
 
 
 @mpi_testdriver.wrap(num_processes)
 def test_get_rank():
 
     rank = mpi.get_rank()
     comm = mpi.get_communicator()
```

### Comparing `tkwant-1.0.1/tkwant/tests/test_system.py` & `tkwant-1.1.0rc2/tkwant/tests/test_system.py`

 * *Files 8% similar despite different names*

```diff
@@ -1,23 +1,24 @@
 # -*- coding: utf-8 -*-
 # Copyright 2016 tkwant authors.
 #
 # This file is part of tkwant.  It is subject to the license terms in the file
 # LICENSE.rst found in the top-level directory of this distribution and at
-# http://kwant-project.org/license.  A list of tkwant authors can be found in
+# https://tkwant.kwant-project.org/doc/stable/pre/license.html.
+# A list of tkwant authors can be found in
 # the file AUTHORS.rst at the top-level directory of this distribution and at
-# http://kwant-project.org/authors.
+# https://tkwant.kwant-project.org/doc/stable/pre/authors.html.
 
 """Test module for `tkwant.system`"""
 
 import numpy as np
 import kwant
 import pytest
 
-from .. import system, leads
+from .. import system, leads, onebody
 from .common import (make_chain, make_simple_lead, make_complex_lead,
                      make_system_with_leads, check_boundary_hamiltonian)
 
 
 def test_orbital_slices():
 
     def check(fsyst):
@@ -50,21 +51,21 @@
     degree = 6
     # construct
     syst = make_system_with_leads(kwant.lattice.square(norbs=1),
                                   lead_maker)
     fsyst = syst.finalized()
     boundaries = [leads.SimpleBoundary(10),
                   leads.MonomialAbsorbingBoundary(ncells, strength, degree)]
-    Hext = system.hamiltonian_with_boundaries(fsyst, boundaries, params={})
+    Hext = onebody.make_extended_system(fsyst, onebody.solvers.default, boundaries)
 
     # test shapes
     norbs_central = len(fsyst.sites)
     norbs_leads = [lead.cell_size * ncells for lead in fsyst.leads]
-    assert Hext.hamiltonian.shape[0] == Hext.hamiltonian.shape[1]
-    assert Hext.hamiltonian.shape[0] == norbs_central + sum(norbs_leads)
+    assert Hext.H0.shape[0] == Hext.H0.shape[1]
+    assert Hext.H0.shape[0] == norbs_central + sum(norbs_leads)
 
     # test absorbing regions and coupling
 
     def absorbing(i):
         n = degree
         return -1j * np.eye(norbs) * ((n + 1) * strength *
                                       i**n / ncells**(n + 1))
@@ -78,53 +79,44 @@
         V_dag = V.conjugate().transpose()
         if isinstance(bdy, leads.MonomialAbsorbingBoundary):
             def onsite(i):
                 return lead.cell_hamiltonian() + absorbing(i)
         else:
             def onsite(i):
                 return lead.cell_hamiltonian()
-        check_boundary_hamiltonian(Hext.hamiltonian[slc, slc],
+        check_boundary_hamiltonian(Hext.H0[slc, slc],
                                    norbs, norbs_iface, onsite, lambda i: V)
 
         # test coupling -- uses fact that norbs=1
         for i, iface_site in enumerate(lead_interface):
             bdy_iface = slice(slc.start, slc.start + norbs)
             iface_slice = slice(iface_site, iface_site + 1)
-            assert np.allclose(Hext.hamiltonian[bdy_iface, iface_slice].todense(),
+            assert np.allclose(Hext.H0[bdy_iface, iface_slice].todense(),
                                V[:, i:(i + 1)])
-            assert np.allclose(Hext.hamiltonian[iface_slice, bdy_iface].todense(),
+            assert np.allclose(Hext.H0[iface_slice, bdy_iface].todense(),
                                V_dag[i:(i + 1), :])
 
-    # test is_valid and should_continue
-    psi_test = np.empty(Hext.hamiltonian.shape[0], dtype=complex)
-    assert Hext.solution_is_valid(psi_test)  # should always return True
-    vmax = np.linalg.norm(fsyst.leads[0].inter_cell_hopping(), ord=2)
-    tmax = ncells / (2 * vmax)
-    eps = 1E-8
-    assert Hext.time_is_valid(tmax - eps)
-    assert not Hext.time_is_valid(tmax + eps)
-
 
 @pytest.mark.parametrize('lead_maker', [make_simple_lead])
 def test_hamiltonian_with_boundaries_exceptions(lead_maker):
 
     # construct
     syst = make_system_with_leads(kwant.lattice.square(norbs=1), lead_maker)
     fsyst = syst.finalized()
 
     # too less boundary conditions
     boundaries = [leads.SimpleBoundary(10)]
     with pytest.raises(ValueError) as exc:
-        system.hamiltonian_with_boundaries(fsyst, boundaries, params={})
+        onebody.make_extended_system(fsyst, onebody.solvers.default, boundaries)
     assert 'Number of leads= 2 does not match the number of boundaries provided= 1' in str(exc.value)
 
     # too many boundary conditions
     boundaries = [leads.SimpleBoundary(10)] * 3
     with pytest.raises(ValueError) as exc:
-        system.hamiltonian_with_boundaries(fsyst, boundaries, params={})
+        onebody.make_extended_system(fsyst, onebody.solvers.default, boundaries)
     assert 'Number of leads= 2 does not match the number of boundaries provided= 3' in str(exc.value)
 
 
 def test_is_time_dependent_function():
     def time_dependent(zeit):
         pass
     not_a_function = 'time'
```

### Comparing `tkwant-1.0.1/tkwant.egg-info/PKG-INFO` & `tkwant-1.1.0rc2/PKG-INFO`

 * *Files 25% similar despite different names*

```diff
@@ -1,31 +1,31 @@
 Metadata-Version: 1.1
 Name: tkwant
-Version: 1.0.1
+Version: 1.1.0rc2
 Summary: Package for time-dependent quantum transport simulations
 Home-page: https://tkwant.kwant-project.org/
 Author: tkwant authors
 Author-email: tkwant-authors@kwant-project.org
 License: BSD
 Description: Tkwant is a python package to simulate time-dependent quantum dynamics of
         mesoscopic systems. It is the time-dependent generalization of the
-        `Kwant <http://kwant-project.org>`_ package and distributed under `2-clause BSD license  <https://kwant-project.org/extensions/tkwant/pre/license>`_.
-        Tkwant is developed by the following `authors  <https://kwant-project.org/extensions/tkwant/pre/authors>`_.
+        `Kwant <https://kwant-project.org>`_ package and distributed under `2-clause BSD license  <https://tkwant.kwant-project.org/doc/stable/pre/license.html>`_.
+        Tkwant is developed by the following `authors  <https://tkwant.kwant-project.org/doc/stable/pre/authors.html>`_.
         
         - Website: https://tkwant.kwant-project.org
         
         
         Installation
         ------------
         
         Installation from source
         ~~~~~~~~~~~~~~~~~~~~~~~~
         
         Tkwant can currently only installed from its source.
-        Please visit the `installation instructions <https://kwant-project.org/extensions/tkwant/pre/installation>`_.
+        Please visit the `installation instructions <https://tkwant.kwant-project.org/doc/stable/pre/installation.html>`_.
         
         
         Development
         -----------
         
         Source code
         ~~~~~~~~~~~
@@ -48,15 +48,15 @@
             pytest --integtest
         
         Tests involving MPI can be run by the command::
         
             pytest --mpitest
         
         The test suite needs the Python packages ``pytest`` to be installed and tkwant compiled.
-        Please visit the `installation instructions <https://kwant-project.org/extensions/tkwant/pre/installation>`_.
+        Please visit the `installation instructions <https://tkwant.kwant-project.org/doc/stable/pre/installation.html>`_.
         Additional pep8 compliance checks can be activated with::
         
             pytest --flake8
         
         when the optional `pytest-flake8 <https://pypi.org/project/pytest-flake8/>`_
         package is installed.
         
@@ -69,15 +69,15 @@
         
             make html
         
         
         The generated html documentation can be browsed
         by opening the file ``doc/build/html/index.html`` with a web browser.
         To build the documentation, additional Python packages need to be installed.
-        Please visit the `installation instructions <https://kwant-project.org/extensions/tkwant/pre/installation>`_.
+        Please visit the `installation instructions <https://tkwant.kwant-project.org/doc/stable/pre/installation.html>`_.
         
         Contribution
         ~~~~~~~~~~~~
         Contributions and feedback to tkwant are always welcome.
         We also appreciate if you have suggestions for the documentation or find new bugs.
         If you like to contribute new features,
         feel free do discuss your ideas on the mailing list before opening a merge request.
@@ -86,45 +86,43 @@
         See the `Contribution <https://kwant-project.org/contribute>`_
         section of kwant for coding style and general advice.
         
         Authors
         ~~~~~~~
         
         Tkwant is developed by the following
-        `authors  <https://kwant-project.org/extensions/tkwant/pre/authors>`_.
+        `authors  <https://tkwant.kwant-project.org/doc/stable/pre/authors.html>`_.
         
         License
         ~~~~~~~
         Tkwant is distributed under
-        `2-clause BSD license <https://kwant-project.org/extensions/tkwant/pre/license>`_.
+        `2-clause BSD license <https://tkwant.kwant-project.org/doc/stable/pre/license.html>`_.
         The license can be also found in file ``LICENSE.rst`` in the project repository.
         
         Help and Support
         ----------------
         
         Documentation
         ~~~~~~~~~~~~~
         
         The official user and developer documentation is found under:
         
-        - Documentation: https://kwant-project.org/extensions/tkwant
+        - stable: https://tkwant.kwant-project.org/doc/stable
+        - development (master branch): https://tkwant.kwant-project.org/doc/dev
         
         Communication
         ~~~~~~~~~~~~~
         
         The kwant-discuss mailing list is the main communication channel for
         questions and discussions around tkwant. Searching and using the mailing list
         is explained in section
         `mailing list <https://kwant-project.org/community#mailing-list>`_.
         
         - Mailing list: kwant-discuss@kwant-project.org
         
-        In addition, the `authors  <https://kwant-project.org/extensions/tkwant/pre/authors>`_
-        can be reached by email.
-        
         
         Reporting bugs
         ~~~~~~~~~~~~~~
         
         If you encounter a problem that seems to be a bug of tkwant, you can open a ticket
         with the issue tracker.
         
@@ -140,15 +138,17 @@
         Citation
         ~~~~~~~~
         
         If you have used tkwant for work that has lead to a scientific publication,
         we would appreciate if you cite the publication which introduces tkwant:
         
         T. Kloss, J. Weston, B. Gaury, B. Rossignol, C. Groth and X. Waintal,
-        Tkwant: a software package for time-dependent quantum transport.
+        `Tkwant: a software package for time-dependent quantum transport <https://doi.org/10.1088/1367-2630/abddf7>`_
+        New J. Phys. **23**, 023025 (2021),
+        `arXiv:2009.03132 [cond-mat.mes-hall]. <https://arxiv.org/abs/2009.03132>`_
 Platform: Unix
 Platform: Linux
 Platform: Mac OS-X
 Platform: Windows
 Classifier: Development Status :: 5 - Production/Stable
 Classifier: Intended Audience :: Science/Research
 Classifier: Programming Language :: Python :: 3 :: Only
```

